<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[从静态数组到环形数组：手把手实现与底层原理剖析]]></title>    <link>https://juejin.cn/post/7598081541562908712</link>    <guid>https://juejin.cn/post/7598081541562908712</guid>    <pubDate>2026-01-22T23:05:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598081541562908712" data-draft-id="7598055483633696768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从静态数组到环形数组：手把手实现与底层原理剖析"/> <meta itemprop="keywords" content="JavaScript,后端,算法"/> <meta itemprop="datePublished" content="2026-01-22T23:05:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从静态数组到环形数组：手把手实现与底层原理剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T23:05:19.000Z" title="Thu Jan 22 2026 23:05:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从静态数组到环形数组：手把手实现与底层原理剖析</h2>
<p>数组作为最基础的数据结构，其核心优势是O(1)级随机访问能力，而动态数组与环形数组则是在静态数组基础上的优化与拓展。本文将先拆解静态数组的存储原理与增删查改逻辑，再一步步实现新手友好的闭区间环形数组，帮你吃透数组类结构的底层运行机制。</p>
<h3 data-id="heading-1">TL;DR</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/217ef6628cf648c3a34eec6d81ce8adb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769727918&amp;x-signature=51sCPohFPkALE3xeJSQqoI%2BPoFc%3D" alt="circle_arr.png" loading="lazy"/></p>
<h3 data-id="heading-2">一、数组顺序存储的基本原理</h3>
<p>静态数组是一段连续的内存空间，通过首地址和索引即可直接计算目标元素的内存地址，这也是其随机访问高效的核心原因。</p>
<h3 data-id="heading-3">1. 静态数组的内存机制</h3>
<p>以C++代码为例，静态数组的内存分配与访问逻辑如下：</p>
<pre><code class="hljs language-c++" lang="c++">
<span class="hljs-comment">// 开辟10个int类型的连续内存空间，共40字节（1个int占4字节）</span>
<span class="hljs-comment">// arr为指针，指向这段空间的首地址</span>
<span class="hljs-type">int</span> arr[<span class="hljs-number">10</span>];

<span class="hljs-comment">// 初始化内存，避免二手内存数据干扰</span>
<span class="hljs-built_in">memset</span>(arr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(arr));

<span class="hljs-comment">// 给首地址对应的内存写入1</span>
arr[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
<span class="hljs-comment">// 给首地址偏移4字节（1*sizeof(int)）的位置写入2</span>
arr[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;

<span class="hljs-comment">// 随机访问：通过索引计算地址，时间复杂度O(1)</span>
<span class="hljs-type">int</span> a = arr[<span class="hljs-number">0</span>];
</code></pre>
<p>由于内存寻址时间可视为O(1)，静态数组的随机访问（查、改）操作时间复杂度均为O(1)，但增删操作受限于连续内存特性，效率会因位置不同而有差异。</p>
<h3 data-id="heading-4">2. 基于静态数组的实现动态数组的增删查改操作</h3>
<p>数组的核心职责是增删查改，其中查和改基于随机访问特性已实现高效，重点在于增删操作的逻辑与复杂度分析。
通过对静态数组的操作来理解动态数组的API。</p>
<h4 data-id="heading-5">（1）增加操作</h4>
<p>增加操作分“空间未满”和“空间已满”两种场景，复杂度随插入位置变化。</p>
<p><strong>场景1：空间未满</strong></p>
<p>现有长度为10的数组，前4个元素为0、1、2、3：</p>
<ul>
<li>
<p>尾部追加（push）：直接给索引4赋值，时间复杂度O(1)，代码为<code>arr[4] = 4</code>。</p>
</li>
<li>
<p>中间插入（insert）：需倒序移动元素腾位置，避免覆盖已有数据，时间复杂度O(N)。例如在索引2插入666：</p>
</li>
</ul>
<pre><code class="hljs language-c++" lang="c++">
<span class="hljs-comment">// 倒序移动索引2及后续元素，给新元素腾位置</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">4</span>; i &gt; <span class="hljs-number">2</span>; i--) {
    arr[i] = arr[i - <span class="hljs-number">1</span>];
}
<span class="hljs-comment">// 插入新元素</span>
arr[<span class="hljs-number">2</span>] = <span class="hljs-number">666</span>;
</code></pre>
<p><strong>场景2：空间已满</strong></p>
<p>当数组填满时，需执行“扩容”操作：重新申请更大内存、复制原数据、释放旧内存，整体时间复杂度O(N)。例如给满元素数组追加10：</p>
<pre><code class="hljs language-c++" lang="c++">
<span class="hljs-comment">// 申请容量为20的新数组</span>
<span class="hljs-type">int</span> newArr[<span class="hljs-number">20</span>];
<span class="hljs-comment">// 复制原数组数据</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
    newArr[i] = arr[i];
}
<span class="hljs-comment">// 释放旧数组内存（避免内存泄漏）</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// 追加新元素</span>
newArr[<span class="hljs-number">10</span>] = <span class="hljs-number">10</span>;
</code></pre>
<h4 data-id="heading-6">（2）删除操作</h4>
<p>删除操作同样分尾部和中间位置，核心是数据搬移与标记删除。</p>
<p>现有长度为10的数组，前4个元素为0、1、2、3：</p>
<ul>
<li>
<p>尾部删除：直接标记尾部元素为特殊值（如-1），时间复杂度O(1)，代码为<code>arr[3] = -1</code>。</p>
</li>
<li>
<p>中间删除：需正序移动元素覆盖待删除位置，时间复杂度O(N)。例如删除索引1的元素：</p>
</li>
</ul>
<pre><code class="hljs language-c++" lang="c++">
<span class="hljs-comment">// 正序移动元素，覆盖待删除位置</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">4</span>; i++) {
    arr[i] = arr[i + <span class="hljs-number">1</span>];
}
<span class="hljs-comment">// 标记最后一个位置为删除状态</span>
arr[<span class="hljs-number">4</span>] = <span class="hljs-number">-1</span>;
</code></pre>
<h4 data-id="heading-7">（3）时间复杂度总结</h4>
<ul>
<li>
<p>增：尾部追加O(1)，中间插入O(N)，扩容O(N)；</p>
</li>
<li>
<p>删：尾部删除O(1)，中间删除O(N)；</p>
</li>
<li>
<p>查/改：随机访问O(1)。</p>
</li>
</ul>
<p>动态数组的本质的是对静态数组的封装，自动处理扩缩容，简化用户操作，而环形数组则是进一步优化了动态数组的空间利用率。</p>
<h3 data-id="heading-8">二、手把手实现闭区间环形数组（</h3>
<p>环形数组通过“首尾衔接”的逻辑复用数组空间，闭区间版本的核心是让<code>start</code>和<code>end</code>均指向有效元素（<code>start</code>为第一个，<code>end</code>为最后一个），逻辑更贴合直觉，下面从0到1分步实现。</p>
<h3 data-id="heading-9">1. 核心规则前置（必记）</h3>
<p>所有操作均围绕以下规则展开，避免指针混乱和逻辑错误：</p>









































<table><thead><tr><th>核心概念</th><th>定义/规则</th></tr></thead><tbody><tr><td>capacity</td><td>物理容量，底层数组的长度，支持动态扩缩容</td></tr><tr><td>count</td><td>有效元素个数，判断空/满的核心依据（优先使用，不依赖指针）</td></tr><tr><td>start</td><td>闭区间起点，指向第一个有效元素的索引</td></tr><tr><td>end</td><td>闭区间终点，指向最后一个有效元素的索引</td></tr><tr><td>空数组</td><td>count === 0（禁止用start === end判断，满数组也可能出现该情况）</td></tr><tr><td>满数组</td><td>count === capacity（唯一判断标准）</td></tr><tr><td>新增元素</td><td>先移动指针，再赋值（尾部增移end，头部增移start）</td></tr><tr><td>删除元素</td><td>先清空值，再移动指针（尾部删移end，头部删移start）</td></tr></tbody></table>
<h3 data-id="heading-10">2. 第一步：初始化类与基础辅助方法</h3>
<p>先搭建类的骨架，实现判断空/满、获取有效个数、遍历等基础方法，为后续核心操作铺垫。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 闭区间环形数组（新手友好版）
 * 核心规则：[start, end] 均为有效元素，start=第一个，end=最后一个
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CycleArrayClosed</span> {
  <span class="hljs-comment">// 构造函数：初始化物理容量（默认1）</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">initSize = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = initSize; <span class="hljs-comment">// 物理容量</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(initSize); <span class="hljs-comment">// 底层存储数组</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 有效元素起始索引（闭区间）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 有效元素结束索引（闭区间）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 有效元素个数（核心判断依据）</span>
  }

  <span class="hljs-comment">// 辅助方法1：判断数组是否为空</span>
  <span class="hljs-title function_">isEmpty</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 辅助方法2：判断数组是否已满</span>
  <span class="hljs-title function_">isFull</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
  }

  <span class="hljs-comment">// 辅助方法3：获取有效元素个数（对外暴露）</span>
  <span class="hljs-title function_">getCount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>;
  }

  <span class="hljs-comment">// 辅助方法4：遍历所有有效元素（调试/展示用）</span>
  <span class="hljs-title function_">traverse</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> result = [];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) <span class="hljs-keyword">return</span> result;

    <span class="hljs-comment">// 分两种场景遍历，避免环形场景漏元素</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>) {
      <span class="hljs-comment">// 场景1：线性区间（未绕圈）</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 场景2：环形区间（已绕圈），分两段遍历</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
    }
    <span class="hljs-keyword">return</span> result;
  }
}
</code></pre>
<p><strong>测试基础方法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 初始化容量为3的环形数组</span>
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CycleArrayClosed</span>(<span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"是否为空："</span>, arr.<span class="hljs-title function_">isEmpty</span>()); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"有效个数："</span>, arr.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 0</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"遍历结果："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// []</span>
</code></pre>
<h3 data-id="heading-11">3. 第二步：实现扩缩容（resize）核心方法</h3>
<p>环形数组扩容时，需将旧数组的有效元素“平铺”到新数组开头，重置指针使新数组回归线性状态，避免后续操作复杂。缩容则在有效元素过少时触发，优化空间利用率。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 扩容/缩容方法
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">newCapacity</span> - 新的物理容量
 */</span>
<span class="hljs-title function_">resize</span>(<span class="hljs-params">newCapacity</span>) {
  <span class="hljs-keyword">const</span> newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(newCapacity);
  <span class="hljs-comment">// 复制旧数组有效元素到新数组</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>; i++) {
    <span class="hljs-comment">// 核心公式：环形遍历旧数组有效元素</span>
    <span class="hljs-comment">// (start + i) % capacity 可适配线性/环形两种场景</span>
    <span class="hljs-keyword">const</span> oldIndex = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> + i) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
    newArr[i] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[oldIndex];
  }
  <span class="hljs-comment">// 替换底层数组，重置指针和容量</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span> = newArr;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 新数组有效元素从0开始</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">// 闭区间终点为最后一个有效元素索引</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = newCapacity;
}
</code></pre>
<p><strong>测试扩容逻辑</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CycleArrayClosed</span>(<span class="hljs-number">3</span>);
<span class="hljs-comment">// 手动模拟填充元素</span>
arr.<span class="hljs-property">arr</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
arr.<span class="hljs-property">arr</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;
arr.<span class="hljs-property">arr</span>[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;
arr.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
arr.<span class="hljs-property">end</span> = <span class="hljs-number">2</span>;
arr.<span class="hljs-property">count</span> = <span class="hljs-number">3</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容前遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1,2,3]</span>
arr.<span class="hljs-title function_">resize</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 扩容到5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后容量："</span>, arr.<span class="hljs-property">capacity</span>); <span class="hljs-comment">// 5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1,2,3]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后指针：start="</span>, arr.<span class="hljs-property">start</span>, <span class="hljs-string">"end="</span>, arr.<span class="hljs-property">end</span>); <span class="hljs-comment">// start=0, end=2</span>
</code></pre>
<h3 data-id="heading-12">4. 第三步：实现尾部添加（addLast）</h3>
<p>尾部添加遵循“先移指针再赋值”规则，空数组需特殊处理，满数组先扩容。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 尾部添加元素（时间复杂度O(1)）
 * 规则：满了先扩容 → 空数组特殊处理 → 非空先移end再赋值
 */</span>
<span class="hljs-title function_">addLast</span>(<span class="hljs-params">val</span>) {
  <span class="hljs-comment">// 满数组先扩容（扩容2倍为行业通用策略，平衡效率与空间）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFull</span>()) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> * <span class="hljs-number">2</span>);
  }

  <span class="hljs-comment">// 空数组：直接赋值到0位置，指针均指向0</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-number">0</span>] = val;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 非空数组：右移end指针（取模实现环形衔接），再赋值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>] = val;
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++; <span class="hljs-comment">// 有效元素个数+1</span>
}
</code></pre>
<p><strong>测试尾部添加</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CycleArrayClosed</span>(<span class="hljs-number">3</span>);
<span class="hljs-comment">// 填充3个元素（填满容量）</span>
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">1</span>);
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">2</span>);
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"添加3个元素后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1,2,3]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"是否满："</span>, arr.<span class="hljs-title function_">isFull</span>()); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 追加第4个元素（触发扩容到6）</span>
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">4</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后容量："</span>, arr.<span class="hljs-property">capacity</span>); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1,2,3,4]</span>
</code></pre>
<h3 data-id="heading-13">5. 第四步：实现头部添加（addFirst）</h3>
<p>头部添加遵循“先移指针再赋值”规则，空数组可复用addLast逻辑，左移指针时需加capacity避免负数。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 头部添加元素（时间复杂度O(1)）
 * 规则：满了先扩容 → 空数组调用addLast → 非空先移start再赋值
 */</span>
<span class="hljs-title function_">addFirst</span>(<span class="hljs-params">val</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFull</span>()) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> * <span class="hljs-number">2</span>);
  }

  <span class="hljs-comment">// 空数组复用尾部添加逻辑，避免重复代码</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addLast</span>(val);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 左移start指针（+capacity确保索引非负）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> - <span class="hljs-number">1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>] = val;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;
  }
}
</code></pre>
<p><strong>测试头部添加</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CycleArrayClosed</span>(<span class="hljs-number">3</span>);
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"头部加1后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"start指针："</span>, arr.<span class="hljs-property">start</span>); <span class="hljs-comment">// 2（(0-1+3)%3=2）</span>

<span class="hljs-comment">// 再添加2个元素（填满容量）</span>
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">2</span>);
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">3</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"填满后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [3,2,1]</span>

<span class="hljs-comment">// 追加第4个元素（触发扩容）</span>
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">4</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"扩容后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [4,3,2,1]</span>
</code></pre>
<h3 data-id="heading-14">6. 第五步：实现尾部删除（removeLast）</h3>
<p>尾部删除遵循“先清空值再移指针”规则，只剩1个元素时需重置指针，有效元素过少时触发缩容。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 尾部删除元素（时间复杂度O(1)）
 * 规则：空数组抛错 → 清空end值 → 移指针 → 缩容判断
 */</span>
<span class="hljs-title function_">removeLast</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, cannot remove last element"</span>);
  }

  <span class="hljs-comment">// 清空当前end位置的值，避免内存泄漏</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>] = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 只剩1个元素：删除后变为空数组，重置指针</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 左移end指针（+capacity确保索引非负）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> - <span class="hljs-number">1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--;

  <span class="hljs-comment">// 缩容：有效元素为容量1/4时缩容到1/2，避免频繁缩容</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">4</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">2</span>));
  }
}
</code></pre>
<h3 data-id="heading-15">7. 第六步：实现头部删除（removeFirst）</h3>
<p>头部删除遵循“先清空值再移指针”规则，只剩1个元素时复用removeLast逻辑，缩容逻辑与尾部删除一致。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 头部删除元素（时间复杂度O(1)）
 * 规则：空数组抛错 → 只剩1个元素调用removeLast → 清空start值 → 移指针 → 缩容
 */</span>
<span class="hljs-title function_">removeFirst</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, cannot remove first element"</span>);
  }

  <span class="hljs-comment">// 只剩1个元素，复用尾部删除逻辑</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeLast</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 清空当前start位置的值</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>] = <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 右移start指针</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--;

  <span class="hljs-comment">// 缩容判断</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">4</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">2</span>));
  }
}
</code></pre>
<h3 data-id="heading-16">8. 第七步：实现首尾元素获取（getFirst/getLast）</h3>
<p>直接通过start/end指针取值，只需判断空数组避免报错。</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 获取头部元素
 */</span>
<span class="hljs-title function_">getFirst</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, no first element"</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>];
}

<span class="hljs-comment">/**
 * 获取尾部元素
 */</span>
<span class="hljs-title function_">getLast</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, no last element"</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>];
}
</code></pre>
<h3 data-id="heading-17">9. 完整代码与综合测试</h3>
<h4 data-id="heading-18">完整代码</h4>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CycleArrayClosed</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">initSize = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = initSize;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(initSize);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">isEmpty</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">isFull</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
  }

  <span class="hljs-title function_">getCount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>;
  }

  <span class="hljs-title function_">traverse</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> result = [];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) <span class="hljs-keyword">return</span> result;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>; i++) {
        result.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[i]);
      }
    }
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-title function_">resize</span>(<span class="hljs-params">newCapacity</span>) {
    <span class="hljs-keyword">const</span> newArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(newCapacity);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>; i++) {
      <span class="hljs-keyword">const</span> oldIndex = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> + i) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
      newArr[i] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[oldIndex];
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span> = newArr;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> - <span class="hljs-number">1</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = newCapacity;
  }

  <span class="hljs-title function_">addLast</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFull</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> * <span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-number">0</span>] = val;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>] = val;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;
  }

  <span class="hljs-title function_">addFirst</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFull</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> * <span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addLast</span>(val);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> - <span class="hljs-number">1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>] = val;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;
    }
  }

  <span class="hljs-title function_">removeLast</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, cannot remove last element"</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>] = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = <span class="hljs-number">0</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span> - <span class="hljs-number">1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">4</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">2</span>));
    }
  }

  <span class="hljs-title function_">removeFirst</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, cannot remove first element"</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeLast</span>();
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>] = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span> + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">4</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> / <span class="hljs-number">2</span>));
    }
  }

  <span class="hljs-title function_">getFirst</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, no first element"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">start</span>];
  }

  <span class="hljs-title function_">getLast</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"CycleArray is empty, no last element"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">arr</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">end</span>];
  }
}
</code></pre>
<h4 data-id="heading-19">综合测试用例</h4>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 初始化数组</span>
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CycleArrayClosed</span>(<span class="hljs-number">3</span>);

<span class="hljs-comment">// 测试新增操作</span>
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">1</span>);
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">2</span>);
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"新增后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [0,1,2]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"首尾元素："</span>, arr.<span class="hljs-title function_">getFirst</span>(), arr.<span class="hljs-title function_">getLast</span>()); <span class="hljs-comment">// 0 2</span>

<span class="hljs-comment">// 测试删除操作</span>
arr.<span class="hljs-title function_">removeFirst</span>();
arr.<span class="hljs-title function_">removeLast</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"删除后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"有效个数："</span>, arr.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 1</span>

<span class="hljs-comment">// 测试扩容与环形遍历</span>
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">3</span>);
arr.<span class="hljs-title function_">addLast</span>(<span class="hljs-number">4</span>);
arr.<span class="hljs-title function_">addFirst</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"环形遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [5,1,3,4]</span>

<span class="hljs-comment">// 测试缩容</span>
arr.<span class="hljs-title function_">removeFirst</span>();
arr.<span class="hljs-title function_">removeLast</span>();
arr.<span class="hljs-title function_">removeLast</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"缩容后容量："</span>, arr.<span class="hljs-property">capacity</span>); <span class="hljs-comment">// 3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"缩容后遍历："</span>, arr.<span class="hljs-title function_">traverse</span>()); <span class="hljs-comment">// [1]</span>
</code></pre>
<h2 data-id="heading-20">三、核心易错点总结（新手必避坑）</h2>
<ol>
<li>
<p><strong>忘记更新count</strong>：增删操作后必须同步增减count，否则空/满判断会完全失效。</p>
</li>
<li>
<p><strong>指针移动顺序颠倒</strong>：新增需“先移指针再赋值”，删除需“先清空再移指针”，顺序错会导致数据覆盖或丢失。</p>
</li>
<li>
<p><strong>左移指针未加capacity</strong>：直接start-1可能得到负数索引，需通过<code>(start-1 + capacity) % capacity</code>确保索引合法。</p>
</li>
<li>
<p><strong>用指针判断空/满</strong>：start === end既可能是空数组，也可能是满数组，唯一可靠的判断是count===0（空）、count===capacity（满）。</p>
</li>
<li>
<p><strong>遍历漏环形场景</strong>：当start &gt; end时，需分<code>[start, capacity-1]</code>和<code>[0, end]</code>两段遍历，否则会漏元素。</p>
</li>
</ol>
<h2 data-id="heading-21">四、总结与拓展</h2>
<p>闭区间环形数组通过指针逻辑复用空间，解决了静态数组中间增删效率低、空间利用率不足的问题，其核心优势是首尾增删均能达到O(1)时间复杂度，仅扩缩容和遍历（环形场景）需O(N)时间。</p>
<p>本文从静态数组原理铺垫，到分步实现环形数组，核心是帮大家理解“封装”与“优化”的思路——动态数组封装了扩缩容，环形数组则进一步优化了指针逻辑。实际开发中，JavaScript的Array本质是动态数组，而环形数组可用于实现队列、循环缓冲区等场景。</p>
<p>若需拓展功能，可基于本文代码实现按索引访问、修改元素等操作，核心是通过<code>(start + index) % capacity</code>计算目标元素索引。</p>
<h2 data-id="heading-22">五、练习</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fdesign-circular-deque%2F" target="_blank" title="https://leetcode.cn/problems/design-circular-deque/" ref="nofollow noopener noreferrer">641. 设计循环双端队列</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fdesign-circular-queue%2F" target="_blank" title="https://leetcode.cn/problems/design-circular-queue/" ref="nofollow noopener noreferrer">622. 设计循环队列</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多标签页强提醒不重复打扰：从“弹框轰炸”到“共享待处理队列”的实战]]></title>    <link>https://juejin.cn/post/7597997108135477275</link>    <guid>https://juejin.cn/post/7597997108135477275</guid>    <pubDate>2026-01-22T19:12:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597997108135477275" data-draft-id="7598057199962882099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多标签页强提醒不重复打扰：从“弹框轰炸”到“共享待处理队列”的实战"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2026-01-22T19:12:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_Jude"/> <meta itemprop="url" content="https://juejin.cn/user/1767670430312909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多标签页强提醒不重复打扰：从“弹框轰炸”到“共享待处理队列”的实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767670430312909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _Jude
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T19:12:21.000Z" title="Thu Jan 22 2026 19:12:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景：我在多标签页里“接力”处理紧急待办</h2>
<p>这篇文章讨论的不是“消息列表怎么做”，而是紧急待办的<strong>强提醒体验</strong>应该如何落地。我的核心需求很明确：</p>
<ul>
<li><strong>紧急消息必须强制弹框提醒</strong>（不能靠用户自己去小铃铛里找）</li>
<li><strong>弹框不能手动关闭</strong>，只能通过“去处理/已读”等业务动作逐条消解</li>
<li><strong>刷新后仍要继续弹</strong>：只要还有“高优先级且未处理”的消息，就必须再次弹框</li>
<li><strong>多标签页不重复打扰</strong>：同一时间只允许一个标签页弹；未处理的消息能跨标签页接力，不丢失 ✅</li>
</ul>
<hr/>
<h2 data-id="heading-1">问题 1：多标签页重复强弹（“弹框轰炸”）💥</h2>
<h3 data-id="heading-2">现象</h3>
<ul>
<li>A 中点“去处理”打开 B</li>
<li>B 打开后会<strong>立即执行轮询</strong>（而 A 里此时还有 3 条未处理）</li>
<li>于是 B 会再次强弹：<strong>同一批剩余 3 条被重复弹出</strong> 😵</li>
</ul>
<p>一句话总结：<strong>两个入口（WS + 初始化轮询）叠加在“多标签页”上，会让强提醒被重复触发</strong>。</p>
<h3 data-id="heading-3">我认为合理的产品设计应该是什么样？🧩</h3>
<p>我的判断标准很简单：既要“强提醒不遗漏”，也要“用户不被打断到崩溃”。</p>
<ul>
<li><strong>同一时刻只能有一个强提醒弹框</strong>（避免轰炸）✅</li>
<li><strong>弹框容器支持多条消息</strong>（用户能逐条处理）✅</li>
<li>点击“去处理”后，新标签页应该进入<strong>处理模式</strong>：
<ul>
<li><strong>不再重复强弹当前未处理的那一批</strong>（否则每开一个 tab 都弹一次）✋</li>
<li>但消息仍需保留在“小铃铛/待处理列表”里（避免漏掉）✅</li>
</ul>
</li>
<li>当“处理标签页关闭或处理结束”，系统再允许其他标签页接力弹框 ✅</li>
</ul>
<h3 data-id="heading-4">解决思路</h3>
<p>先把“是否允许弹框”这件事独立出来：<br/>
用一个<strong>全局锁</strong>控制“同一时间只有一个标签页允许弹框” 👇</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
  M[紧急消息到达] --&gt; L{全局锁存在?}
  L -- 是 --&gt; Q[不弹框/仅记录]
  L -- 否 --&gt; S[获得锁并弹框]
</code></pre>
<h3 data-id="heading-5">解决方案选择：锁放哪儿？锁归属怎么判？</h3>
<p>要让“别的标签页不弹”很简单，但我还需要保证：<strong>当前弹框页可以继续追加新紧急消息</strong>。<br/>
这就引出了一个细节：我不仅要知道“有没有锁”，还要知道“锁属于谁” 👉</p>
<p>我当时的选型路径是一个很典型的<strong>逐步排除法</strong>（先快后稳 👍）：</p>
<ul>
<li><strong>sessionStorage</strong>：上手快，但“同标签页跳转仍共享”，A→B 会错判“我还是持锁页” ✋</li>
<li><strong>window（自定义 key）</strong>：可跨页保存，但 window 全局属性容易被别的脚本覆盖 ⚠️</li>
<li><strong>Pinia（不持久化）</strong>：<strong>与应用状态一致、可控、风险低</strong> ✅</li>
</ul>
<p>为什么 <strong>Pinia 不持久化</strong>？</p>
<ul>
<li>Pinia 的这个 key 本质是“临时归属标记”，只服务于当前运行时</li>
<li>如果持久化，浏览器异常关闭/崩溃导致未清理，会出现<strong>锁遗留</strong>，后续可能<strong>一直不弹强提醒</strong> 😵</li>
</ul>
<h3 data-id="heading-6">最终方案（问题 1）</h3>
<ul>
<li><strong>localStorage</strong>：存“全局锁”本体（跨标签页共享）</li>
<li><strong>Pinia</strong>：存“当前标签页持有的锁 key”（仅当前标签页生效）</li>
</ul>
<p>示例代码（与实现一致）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> urgentDialogActivePrefix = <span class="hljs-string">'crm.urgent_dialog_active:'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setUrgentDialogActive</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useNotificationStore</span>();
  <span class="hljs-keyword">const</span> existingKey = <span class="hljs-title function_">findUrgentDialogActiveKey</span>();
  <span class="hljs-keyword">if</span> (existingKey) <span class="hljs-keyword">return</span> existingKey;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${urgentDialogActivePrefix}</span><span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-string">'1'</span>);
    store.<span class="hljs-title function_">setUrgentDialogActiveKey</span>(key);
    <span class="hljs-keyword">return</span> key;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isUrgentDialogActiveForCurrentTab</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useNotificationStore</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> key = store.<span class="hljs-property">urgentDialogActiveKey</span>;
    <span class="hljs-keyword">if</span> (!key) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key) === <span class="hljs-string">'1'</span>;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">问题 2：关闭 A 后，B 只弹新消息，旧的 3 条“丢了”😵</h2>
<h3 data-id="heading-8">现象</h3>
<p>在问题 1 的锁机制生效后：</p>
<ul>
<li>B 不会重复弹框 ✅</li>
<li>WS 的新紧急消息会继续 push 到 A 的弹框 ✅</li>
<li>但当 A 关闭后，B 再收到新消息时，只展示新来的 1 条 ❌</li>
</ul>
<p>本质问题：<strong>弹框是“唯一入口”，但紧急消息的“待处理状态”没有被稳定地“先存起来”</strong>。一旦持锁页关闭，下一标签页如果只基于“新来的 WS 消息”触发弹框，就容易出现“旧的未处理没带上”的错觉。</p>
<h3 data-id="heading-9">解决思路</h3>
<p>把“消息状态”从“弹框状态”里解耦出来：<br/>
弹框只是 UI，<strong>待处理列表</strong>才是关键。</p>
<p>这里我后来更偏向一个更轻量的实现：<strong>队列不跨标签页持久化</strong>，而是交给“页面加载必定会执行一次的轮询”来重建——</p>
<ul>
<li><strong>先轮询一次</strong>，把“高优先级且未处理”的消息塞进 <strong>Pinia 队列</strong></li>
<li><strong>轮询成功后再连接 WS</strong></li>
<li>后面无论是轮询刷新还是 WS 推送，先把消息写入 Pinia 队列；能弹时一次性把队列里的都弹出来 ✅</li>
</ul>
<h3 data-id="heading-10">解决方案选择：未处理队列放 localStorage 还是 Pinia？</h3>
<p>这里的核心不是“哪个存储更强”，而是<strong>我们的事实源是什么</strong>：<br/>
既然页面加载（以及后续定时）都会轮询到“高优先级且未处理”的消息，那么队列完全可以由轮询在每个标签页内重建；此时把队列写进 localStorage 反而会引入额外风险。</p>
<ul>
<li>方案 A：<strong>localStorage 存队列（跨标签页共享/持久化）</strong>
<ul>
<li>优点：跨标签页天然共享；刷新/崩溃后仍可恢复</li>
<li>代价：有<strong>空间上限</strong>（通常几 MB），队列稍大或字段稍多就可能触发 <code>setItem</code> 失败；还要额外设计 TTL/容量上限/清理策略，否则容易“越积越多”</li>
</ul>
</li>
<li>方案 B：<strong>Pinia 存队列（内存态，每 tab 自己维护）</strong>
<ul>
<li>优点：没有 localStorage 的序列化/配额风险；状态更新更直接、可控；与“页面加载立即轮询一次”的事实源一致</li>
<li>代价：队列不跨标签页共享，因此需要把“接力”交给轮询：持锁页关闭后，其他标签页通过轮询重建队列再弹框</li>
</ul>
</li>
</ul>
<p>我选择 <strong>Pinia 队列 + localStorage 只存锁</strong>：<br/>
队列的权威来源是“轮询返回的未处理紧急消息”，而不是浏览器本地持久化；这样做能把失败面缩到最小，同时仍能满足“接力不丢”的体验目标 ✅</p>
<h3 data-id="heading-11">最终方案（问题 2）：先轮询后 WS + Pinia 队列 + 正确的执行顺序</h3>
<p>关键点不在“有没有队列”，而在“先后顺序”：</p>
<ol>
<li><strong>先把轮询结果入队</strong>（页面加载立刻执行一次，先拿到“历史未处理”）</li>
<li><strong>轮询成功后再连接 WS</strong>（避免 WS 抢跑导致“只弹新来的”）</li>
<li><strong>任何来源的紧急消息都先入队，再判断锁</strong>（不持锁也要缓存）</li>
<li><strong>能弹时直接渲染队列</strong>（一次性补齐旧的 + 新的） ✅</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  participant Poll as 轮询(立即执行)
  participant WS as WebSocket
  participant Tab as 当前标签页
  participant Q as Pinia(待处理队列)
  participant Lock as localStorage(锁)
  participant UI as 强提醒弹框

  Poll-&gt;&gt;Tab: 拉取未处理紧急消息 list
  Tab-&gt;&gt;Q: replacePending(list) ✅
  Tab-&gt;&gt;WS: connect() ✅
  WS-&gt;&gt;Tab: 收到紧急消息 item
  Tab-&gt;&gt;Q: upsertPending(item) ✅
  Tab-&gt;&gt;Lock: isLocked?
  alt 被其他标签页持锁
    Tab--&gt;&gt;UI: 不弹框，仅等待
  else 可持锁/已持锁
    Tab-&gt;&gt;Lock: setLock()
    Tab-&gt;&gt;UI: render(Q.pendingList) ✅
  end
</code></pre>
<p>示例代码（与实现一致）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useNotificationStore</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">maybeOpenUrgentDialog</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (store.<span class="hljs-property">urgentPendingList</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isUrgentDialogActiveForCurrentTab</span>() &amp;&amp; <span class="hljs-title function_">isUrgentDialogActive</span>()) <span class="hljs-keyword">return</span>;
  <span class="hljs-title function_">setUrgentDialogActive</span>();
  <span class="hljs-title function_">setUrgentDialogItems</span>(store.<span class="hljs-property">urgentPendingList</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUrgentIncoming</span> = (<span class="hljs-params">item: NotificationMineItem</span>) =&gt; {
  store.<span class="hljs-title function_">upsertUrgentPending</span>({ <span class="hljs-attr">key</span>: <span class="hljs-title function_">getUrgentNotificationKey</span>(item), item });
  <span class="hljs-title function_">maybeOpenUrgentDialog</span>();
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchNotifications</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> list = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getNotificationList</span>({ <span class="hljs-attr">status</span>: <span class="hljs-number">0</span> });
  store.<span class="hljs-title function_">replaceUrgentPending</span>(
    list
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> <span class="hljs-title function_">isUrgentNotification</span>(x) &amp;&amp; !x.<span class="hljs-property">isRead</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> ({ <span class="hljs-attr">key</span>: <span class="hljs-title function_">getUrgentNotificationKey</span>(x), <span class="hljs-attr">item</span>: x })),
  );
  <span class="hljs-title function_">maybeOpenUrgentDialog</span>();
  <span class="hljs-title function_">startEcho</span>();
};
</code></pre>
<hr/>
<h2 data-id="heading-12">最终效果（两类问题一起解决）🙌</h2>
<ul>
<li><strong>多标签页不再重复强弹</strong>：只有一个标签页持锁展示弹框 ✅</li>
<li><strong>紧急消息不会“被关掉的标签页带走”</strong>：轮询重建 + Pinia 队列兜底，能接力 ✅</li>
<li><strong>新消息到来时会补齐历史未处理</strong>：B 会弹 3 条旧的 + 1 条新的 ✅</li>
</ul>
<hr/>
<h2 data-id="heading-13">总结</h2>
<p>这次问题本质上是“同一份紧急消息，在多标签页环境下如何做到<strong>不重复打扰</strong>又<strong>不遗漏</strong>”：</p>
<ul>
<li><strong>问题 1（重复弹框）</strong>：用 <strong>localStorage 全局锁</strong>保证同一时刻只允许一个标签页弹框；锁归属用 <strong>Pinia</strong> 记录，避免误判</li>
<li><strong>问题 2（接力丢历史）</strong>：把“待处理紧急消息”从弹框组件里抽出来，改为 <strong>Pinia 队列</strong>；并通过<strong>先轮询后 WS</strong>的时序，确保“历史未处理”一定先入队，再叠加 WS 的实时增量</li>
</ul>
<p>最终效果是：紧急消息仍然强制弹框、不可手动关闭、刷新后仍可通过轮询重建继续弹，同时多标签页不会被同一批消息反复轰炸。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没显卡也能玩！Ollama 本地大模型保姆级入门指南]]></title>    <link>https://juejin.cn/post/7598203055746940980</link>    <guid>https://juejin.cn/post/7598203055746940980</guid>    <pubDate>2026-01-22T16:40:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598203055746940980" data-draft-id="7598025242041696308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没显卡也能玩！Ollama 本地大模型保姆级入门指南"/> <meta itemprop="keywords" content="Agent,LLM"/> <meta itemprop="datePublished" content="2026-01-22T16:40:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节逆旅"/> <meta itemprop="url" content="https://juejin.cn/user/2471357871561214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没显卡也能玩！Ollama 本地大模型保姆级入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2471357871561214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节逆旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T16:40:06.000Z" title="Thu Jan 22 2026 16:40:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你想在自己电脑上跑 AI，又不希望数据被大厂拿走，<strong>Ollama</strong> 绝对是目前最香的选择。不用配复杂的 Python 环境，不用求爷爷告奶奶找 API Key，只要一键安装，就能实现“大模型自由”。不过我的电脑很早就有了python环境了，忘记啥时候安装的，虽然在python方面还是个菜鸟。</p>
<h3 data-id="heading-0">1. 怎么安装</h3>
<p>直接去 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">Ollama 官网</a> 下载。有1个多G，先有个心理准备。</p>
<ul>
<li>
<p><strong>第一步：</strong> 安装完后，它会躲在右下角任务栏。</p>
</li>
<li>
<p><strong>第二步：</strong> 打开终端（CMD 或 PowerShell），输入下面的命令。这是最关键的一步，它会自动下载并启动对话。</p>
<p>Bash</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama run qwen2<span class="hljs-number">.5</span>:<span class="hljs-number">1.5b</span>
</code></pre>
</li>
</ul>
<p>当你看到进度条跑完，出现 <code>&gt;&gt;&gt; Send a message</code> 时，说明 AI 已经在你硬盘里安家了。
如果不想直接启动，就用这个命令：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">    ollama pull qwen2.5:1.5b
</span></code></pre>
<hr/>
<h3 data-id="heading-1">2. 避坑指南（这些坑我都帮你踩过了）</h3>
<ul>
<li><strong>不要在 Python 里面运行 Python：</strong> 很多人会习惯先输入 <code>python</code> 进去，然后再敲命令。千万别！运行脚本是在普通的 CMD 路径下直接输入 <code>python test.py</code>。</li>
<li><strong>模型名字要写全：</strong> 代码里的 <code>model='qwen2.5:1.5b'</code> 必须带上后缀。如果不写，它默认去找 <code>7b</code> 版本，没下载的话就会报 <strong>502 错误</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 高级玩法：手摸手教你写一个 Agent</h3>
<p>普通的聊天只是“你问我答”，但 <strong>Agent（智能体）</strong> 厉害的地方在于：它能根据你的需求，<strong>自己去调用工具</strong>。</p>
<p>把下面的代码存成 <code>agent_test.py</code>：</p>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ollama

<span class="hljs-comment"># 1. 准备一个“假装能查天气”的工具</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span>的天气是：大晴天，25度！"</span>

<span class="hljs-comment"># 2. 告诉 AI 这个工具怎么用</span>
tools = [{
    <span class="hljs-string">'type'</span>: <span class="hljs-string">'function'</span>,
    <span class="hljs-string">'function'</span>: {
        <span class="hljs-string">'name'</span>: <span class="hljs-string">'get_weather'</span>,
        <span class="hljs-string">'description'</span>: <span class="hljs-string">'查询某个城市的天气'</span>,
        <span class="hljs-string">'parameters'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-string">'properties'</span>: {<span class="hljs-string">'city'</span>: {<span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>}},
            <span class="hljs-string">'required'</span>: [<span class="hljs-string">'city'</span>],
        },
    }
}]

<span class="hljs-comment"># 3. 核心逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_ai</span>(<span class="hljs-params">prompt</span>):
    res = ollama.chat(model=<span class="hljs-string">'qwen2.5:1.5b'</span>, messages=[{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: prompt}], tools=tools)
    
    <span class="hljs-keyword">if</span> res[<span class="hljs-string">'message'</span>].get(<span class="hljs-string">'tool_calls'</span>):
        <span class="hljs-comment"># AI 自动识别出需要调用 get_weather 函数</span>
        city = res[<span class="hljs-string">'message'</span>][<span class="hljs-string">'tool_calls'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'function'</span>][<span class="hljs-string">'arguments'</span>][<span class="hljs-string">'city'</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- 内部观察：Agent 决定调用工具查【<span class="hljs-subst">{city}</span>】的天气 ---"</span>)
        result = get_weather(city) 
        
        final = ollama.chat(model=<span class="hljs-string">'qwen2.5:1.5b'</span>, messages=[
            {<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: prompt},
            res[<span class="hljs-string">'message'</span>],
            {<span class="hljs-string">'role'</span>: <span class="hljs-string">'tool'</span>, <span class="hljs-string">'content'</span>: result}
        ])
        <span class="hljs-keyword">return</span> final[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>]
    <span class="hljs-keyword">return</span> res[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>]

<span class="hljs-built_in">print</span>(ask_ai(<span class="hljs-string">"北京天气怎么样？"</span>))
</code></pre>
<hr/>
<h3 data-id="heading-3">4. 真实运行效果</h3>
<p>当你退出所有多余的窗口，在文件夹里输入 <code>python agent_test.py</code>，你会看到极其解压的一幕：</p>
<pre><code class="hljs language-diff" lang="diff">C:\Users\Admin&gt; python agent_test.py
<span class="hljs-comment">--- 内部观察：Agent 决定调用工具查【北京】的天气 ---</span>
北京今天的天气非常好，是大晴天，气温约 25 度，非常适合出门走走！
</code></pre>
<blockquote>
<p><strong>注意看：</strong> 第一行输出是我在代码里写的“内部观察”，这证明了 AI <strong>真的理解了</strong>你的话，并精准抓取了“北京”这个参数发给了 Python 函数。</p>
</blockquote>
<p>实际上，我们的函数中并没有写这些回答，多出的部分内容就是大模型自己的发挥。</p>
<p>你可以参考这个流程，看清楚数据是怎么流动的：</p>
<ol>
<li><strong>用户：</strong> “北京天气如何？”</li>
<li><strong>模型：</strong> （思考）我需要调用 <code>get_weather</code>，城市是“北京”。</li>
<li><strong>Python 函数：</strong> （执行）返回 <code>"大晴天，25度"</code>。</li>
<li><strong>模型：</strong> （加工）拿到数据，结合它的语言模型能力，扩充成：“北京今天天气<strong>非常好</strong>，是<strong>大晴天</strong>，气温约 <strong>25 度</strong>，<strong>非常适合出门走走</strong>！”</li>
</ol>
<hr/>
<p>还是挺有意思的，强烈建议你试一试！</p>
<h3 data-id="heading-4">总结</h3>
<p>Ollama 让 AI 不再是遥不可及的网页链接，而是你电脑里的一个“数字员工”。你可以先从 <code>1.5b</code> 这种小模型玩起，等玩明白了，直接换成更强的模型，你的 Agent 能力瞬间就能进化，上限取决于你的想象力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Embedding嵌入模型是什么？为什么需要 Embedding？]]></title>    <link>https://juejin.cn/post/7597989474992652326</link>    <guid>https://juejin.cn/post/7597989474992652326</guid>    <pubDate>2026-01-22T15:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474992652326" data-draft-id="7598023360732479498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Embedding嵌入模型是什么？为什么需要 Embedding？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-22T15:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Embedding嵌入模型是什么？为什么需要 Embedding？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:12:34.000Z" title="Thu Jan 22 2026 15:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Embedding模型是连接自然语言与算法系统的枢纽。‌</p>
<p>任何接触过RAG技术的从业者，都耳熟能详“Embedding嵌入模型”这一术语，但真正深入理解其价值的人却寥寥无几；在多数人认知中，它不过是一个“边缘工具”——只需将文本分块后，调用一次Embedding模型，生成向量便万事大吉。</p>
<p>然而，Embedding模型远非简单的“词向量编码器”，它实质是驱动当代AI系统（如搜索引擎、推荐引擎与对话机器人）运转的底层动力核心。</p>
<h2 data-id="heading-0">Embedding模型</h2>
<p>Embedding 是实现语义理解与应用的核心技术，其本质是将文本等信息编码为向量，并借助向量间的相似度计算达成语义层面的推理与匹配。</p>
<p>Embedding 模型属于一种人工智能方法，用于将离散对象（如词汇、句子或图像）映射至连续的向量空间。在自然语言处理（NLP）领域，其最典型的应用形态为文本 Embedding——即将语言单元转换为高维数值表示（例如，一个 768 维的浮点数组）。此类向量结构能够有效编码文本的语义内涵、句法结构与上下文依赖关系。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d52a01dd53b413a81262f45993c655f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769699554&amp;x-signature=40OintDRHQ4SnUvJFpNG6ev5%2Fvc%3D" alt="图片" loading="lazy"/></p>
<p>想象语言如一张地理图卷，词汇便是其中的城池。Embedding 就如同 GPS 的经纬定位——语义相近的“城池”（如 “猫” 与 “狗”）在坐标上彼此邻近，而语义相异的（如 “猫” 与 “汽车”）则遥隔千里。</p>
<h2 data-id="heading-1">为什么需要 Embedding？</h2>
<p>因为计算机无法直接解析语言与图像的语义，而向量能够表征这些内容：</p>
<p>便于通过距离或相似度判断语义接近程度</p>
<p>支持模糊匹配（表达不同，含义一致）</p>
<p>实现高效检索（向量数据库可实现毫秒级相似度搜索）</p>
<p>构成众多 AI 应用的基础特征表示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c71255cfb784ded8299efecce82d9f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769699554&amp;x-signature=EDgCsRXOgDtpPt7pt7aMOn%2Bd8dk%3D" alt="图片" loading="lazy"/></p>
<p>传统计算机在处理文本时，仅能识别字符序列（如 “apple”），无法感知其背后的意义。Embedding 技术正是为此而生：</p>
<p>语义捕捉‌：它使机器能够识别语义关联——同义词（如 “happy” 与 “joyful”）在向量空间中彼此邻近，而多义词（如 “bank”）则根据上下文呈现出不同的向量表征。</p>
<p>维度降维‌：从庞大的词汇集合中提炼出核心语义特征，大幅压缩表示空间，显著提升计算效率。</p>
<h2 data-id="heading-2">核心作用与优势：语义分析的“利刃”</h2>
<p>Embedding 的核心作用在于 向量表示与相似度计算，它在 AI 系统中的优势体现在多个层面：</p>
<p>语义相似度度量‌：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3dd509851d441f49f8abe8acdb40894~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769699554&amp;x-signature=yl01KG1Yhxk8t0VsHtqhW8cNpdY%3D" alt="图片" loading="lazy"/></p>
<p>高效过滤与分类‌：</p>
<p>在海量数据处理场景中，Embedding 充当轻量级预筛选机制，迅速剔除低相关性内容，显著降低后续计算负载。</p>
<p>优势：向量生成耗时仅为毫秒级，相较完整神经网络推理效率提升数个数量级。</p>
<p>多模态扩展‌：</p>
<p>当前 Embedding 架构已实现文本、图像与音频信号在统一向量空间中的对齐（如 CLIP 模型），支撑跨模态语义对齐任务。</p>
<p>优势：可直接完成“以图搜文”“以文搜音”等跨域检索，打破模态边界。</p>
<p>下游任务支持‌：</p>
<p>作为 AI 系统的基础表征层，Embedding 为聚类分析、个性化推荐及检索增强生成（RAG）等应用提供可优化的输入表征。</p>
<p>优势：具备可微分特性，能无缝嵌入端到端神经网络训练流程，支持梯度反向传播与联合优化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2541543c7bd0420fb05c52b2a16477c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769699554&amp;x-signature=4h4G%2B1dZ07gGD8FEinerwfQqolk%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">工作原理拆解：从训练到应用的完整链条</h2>
<p>分词/编码‌：句子被拆解为 token（字、词或子词单元）</p>
<p>向量化表示‌：借助词嵌入（word embeddings）或上下文感知嵌入（contextual embeddings）实现语义数字化</p>
<p>模型处理‌：主流采用 Transformer 架构（如 BERT、RoBERTa、SimCSE）进行语义建模</p>
<p>池化（Pooling）‌：将各 token 的向量聚合为统一维度的句级表示（常用 CLS token 或均值池化）</p>
<p>归一化‌：可选步骤，对向量进行 L2 归一化，以优化余弦相似度计算效率</p>
<h3 data-id="heading-4">3.1 训练阶段：语义关系建模</h3>
<p>数据输入‌：依赖大规模文本语料库（如维基百科、学术著作等）</p>
<p>模型架构‌：基于 Transformer（如 BERT）或 Skip-Gram（Word2Vec），通过自监督任务学习上下文依赖，如掩码语言建模或下一句预测</p>
<p>输出结果‌：生成嵌入矩阵，每个词或句子映射为固定长度的稠密向量</p>
<p>示例‌：训练过程中，“The cat sits on the mat” → 模型捕捉 “cat” 与 “mat” 的语义关联，向量中隐含语法角色与空间关系</p>
<p>关键技术‌：负采样（提升训练效率）与注意力机制（建模远距离依赖）</p>
<h3 data-id="heading-5">3.2 推理阶段：向量生成</h3>
<p>流程‌：输入文本 → Tokenization → 模型前向传播 → 输出句向量</p>
<p>示例代码（Python + Hugging Face）‌：</p>
<pre><code class="hljs language-ini" lang="ini">from sentence_transformers import SentenceTransformer
<span class="hljs-attr">model</span> = SentenceTransformer(<span class="hljs-string">'all-MiniLM-L6-v2'</span>)
<span class="hljs-attr">sentence</span> = <span class="hljs-string">"Embedding models are powerful."</span>
<span class="hljs-attr">embedding</span> = model.encode(sentence)
</code></pre>
<p>输出‌：[0.12, -0.34, ..., 0.56]（384 维）</p>
<p>耗时‌：单句推理通常低于 10 毫秒</p>
<h3 data-id="heading-6">3.3 应用阶段：相似度判定与检索</h3>
<p>向量比较‌：采用欧氏距离或余弦相似度衡量语义相近性</p>
<p>阈值决策‌：相似度超过 0.7 判定为语义相关</p>
<p>扩展应用‌：KNN（K-近邻）搜索用于高效大规模向量检索</p>
<p>该流程构建了文本嵌入从预处理到落地的完整闭环，确保语义表达精准、计算高效、系统可扩展。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[哑铃图：数据对比的优雅之选]]></title>    <link>https://juejin.cn/post/7598055483632697344</link>    <guid>https://juejin.cn/post/7598055483632697344</guid>    <pubDate>2026-01-22T15:22:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598055483632697344" data-draft-id="7598055483632680960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="哑铃图：数据对比的优雅之选"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-22T15:22:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            哑铃图：数据对比的优雅之选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:22:03.000Z" title="Thu Jan 22 2026 15:22:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>简洁的线条连接两个数据点，就像哑铃的两端，在对比分析中展现出令人惊艳的清晰度。</p>
</blockquote>
<p>在平时的数据分析项目中，我经常会遇到比较两个相关数据集的变化情况。</p>
<p>这时，传统的做法是使用堆积条形图或簇状条形图，但它们存在一个<strong>共同问题</strong>：当我们需要精确追踪每个项目在两个时间点或两种条件下的变化时，这些图表会让我们的眼睛在条形之间来回跳跃，难以直观把握变化的幅度和方向。</p>
<p>今天，我要向大家推荐一种更优雅的替代方案--<strong>哑铃图</strong>。</p>
<h2 data-id="heading-0">1. 哑铃图是什么？</h2>
<p><strong>哑铃图</strong>（<code>Dumbbell Plot</code>），有时也称为<strong>DNA图</strong>或<strong>杠铃图</strong>，是一种用于比较两个相关数据点的可视化图表。</p>
<p>它源于人们对更有效数据比较方式的持续探索。</p>
<p>在传统的时间序列比较中，我们通常使用两条折线，但当需要比较的项目较多时，折线图会变得混乱。<strong>哑铃图</strong>通过将比较焦点放在每个项目的两个状态上，解决了多项目对比时的视觉混乱问题。</p>
<p>它的<strong>基本结构</strong>很简单：</p>
<ul>
<li>每个观察单位（如产品、地区、时间段）对应两个数据点</li>
<li>这两个数据点由一条直线（或线段）连接</li>
<li>整个图形看起来像一排排哑铃，因而得名</li>
</ul>
<h2 data-id="heading-1">2. 实现原理</h2>
<p><strong>哑铃图</strong>的核心设计理念是<strong>最小化认知负荷</strong>。</p>
<p>当我们需要比较A和B时，最直接的方式就是把它们放在一起，用一条线连接，然后观察这条线的长度（差异大小）和方向（哪个更大）。</p>
<p>在<code>matplotlib</code>中创建<strong>哑铃图</strong>，我们主要使用以下元素：</p>
<ul>
<li><strong>散点图</strong>：表示两个数据点</li>
<li><strong>直线段</strong>：连接两个相关点</li>
<li><strong>颜色编码</strong>：通常用不同颜色区分前后状态或不同组别</li>
<li><strong>标签系统</strong>：清晰标识每个观察单位</li>
</ul>
<h2 data-id="heading-2">3. 实战示例</h2>
<p>接下来，我们看看哑铃图在实际场景中的显示效果。</p>
<p>假设我们是一家电商公司的数据分析师，需要比较8个主要产品类别在2022年和2023年的销售额变化。</p>
<p>（完整的代码在文章末尾提供下载地址，文中只截取部分代码）</p>
<p>先创建一些测试数据：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例数据：8个产品类别在2022年和2023年的销售额（单位：万元）</span>
categories = [
    <span class="hljs-string">"电子产品"</span>,
    <span class="hljs-string">"服装鞋帽"</span>,
    <span class="hljs-string">"家居用品"</span>,
    <span class="hljs-string">"美妆护肤"</span>,
    <span class="hljs-string">"图书音像"</span>,
    <span class="hljs-string">"运动户外"</span>,
    <span class="hljs-string">"食品饮料"</span>,
    <span class="hljs-string">"母婴用品"</span>,
]
sales_2022 = [<span class="hljs-number">85</span>, <span class="hljs-number">92</span>, <span class="hljs-number">78</span>, <span class="hljs-number">65</span>, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">88</span>, <span class="hljs-number">72</span>]
sales_2023 = [<span class="hljs-number">95</span>, <span class="hljs-number">87</span>, <span class="hljs-number">85</span>, <span class="hljs-number">78</span>, <span class="hljs-number">52</span>, <span class="hljs-number">73</span>, <span class="hljs-number">95</span>, <span class="hljs-number">80</span>]
</code></pre>
<p>然后，我们绘制传统的簇状条形图和哑铃图来对比一下效果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建子图，对比两种可视化方法</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">8</span>))

<span class="hljs-comment"># 簇状条形图</span>
x = np.arange(<span class="hljs-built_in">len</span>(categories))

bars1 = ax1.bar(x - width/<span class="hljs-number">2</span>, sales_2022, width, label=<span class="hljs-string">'2022年'</span>, color=<span class="hljs-string">'#4C72B0'</span>, alpha=<span class="hljs-number">0.8</span>)
bars2 = ax1.bar(x + width/<span class="hljs-number">2</span>, sales_2023, width, label=<span class="hljs-string">'2023年'</span>, color=<span class="hljs-string">'#DD8452'</span>, alpha=<span class="hljs-number">0.8</span>)

<span class="hljs-comment"># 在每个条形上添加数值标签</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 哑铃图</span>
<span class="hljs-comment"># 设置y轴位置（每个类别的垂直位置）</span>
y_pos = np.arange(<span class="hljs-built_in">len</span>(categories))

<span class="hljs-comment"># 绘制连接线</span>
<span class="hljs-keyword">for</span> i, (y2022, y2023) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(sales_2022, sales_2023)):
    <span class="hljs-comment"># 确定线颜色：增长为绿色，下降为红色</span>
    line_color = <span class="hljs-string">'#55A868'</span> <span class="hljs-keyword">if</span> y2023 &gt; y2022 <span class="hljs-keyword">else</span> <span class="hljs-string">'#C44E52'</span>
    ax2.plot([y2022, y2023], [i, i], color=line_color, linewidth=<span class="hljs-number">2.5</span>, alpha=<span class="hljs-number">0.7</span>, zorder=<span class="hljs-number">1</span>)

<span class="hljs-comment"># 绘制数据点</span>
ax2.scatter(sales_2022, y_pos, s=<span class="hljs-number">120</span>, color=<span class="hljs-string">'#4C72B0'</span>, alpha=<span class="hljs-number">0.9</span>, label=<span class="hljs-string">'2022年'</span>, zorder=<span class="hljs-number">2</span>, edgecolors=<span class="hljs-string">'white'</span>, linewidth=<span class="hljs-number">2</span>)
ax2.scatter(sales_2023, y_pos, s=<span class="hljs-number">120</span>, color=<span class="hljs-string">'#DD8452'</span>, alpha=<span class="hljs-number">0.9</span>, label=<span class="hljs-string">'2023年'</span>, zorder=<span class="hljs-number">2</span>, edgecolors=<span class="hljs-string">'white'</span>, linewidth=<span class="hljs-number">2</span>)

<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f033b852e4c48628e2e29b39d52b366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769700123&amp;x-signature=Nm4t12NPePG7wBkPINNaEGG4PpA%3D" alt="" loading="lazy"/></p>
<p>通过上面的对比，我们可以清晰地看到<strong>哑铃图</strong>的优势：</p>
<ul>
<li><strong>变化一目了然</strong>：连接线的长度直观表示变化幅度，方向表示增长或下降</li>
<li><strong>减少视觉跳跃</strong>：眼睛不需要在条形间来回移动，而是沿着水平线自然追踪</li>
<li><strong>突出比较重点</strong>：专注于每个项目的两个状态对比，而非绝对数值</li>
</ul>
<p>进一步，我们还可以给<strong>哑铃图</strong>排序，按照增长<strong>由快到慢</strong>给各个品类排序，这样自然形成从"下降最显著"到"增长最显著"的连续谱，模式自动显现，无需刻意寻找。</p>
<p>比如上面的<strong>哑铃图</strong>中，【服装鞋帽】这个品类其实销售额是下降的，混在一堆哑铃中不容易看出来吧？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建排序后的哑铃图</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))

<span class="hljs-comment"># 按变化幅度排序</span>
sorted_indices = np.argsort(
    [sales_2023[i] - sales_2022[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(categories))]
)
sorted_categories = [categories[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_indices]
sorted_2022 = [sales_2022[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_indices]
sorted_2023 = [sales_2023[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_indices]

<span class="hljs-comment"># 绘制连接线</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 绘制数据点</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 添加变化箭头标注</span>
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ace06801dc204d04a46ff6aa5923bbcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769700123&amp;x-signature=sRPMeHq%2BdWIoEXSELDXJg%2BAudxk%3D" alt="" loading="lazy"/></p>
<p>这样改造后，由上到下的哑铃，越来越短（也就是增长越来越慢），最底部的那个是<strong>负增长</strong>，用了<strong>红色</strong>来标注。</p>
<h2 data-id="heading-3">4. 总结</h2>
<p>数据可视化的核心目标是<strong>有效传达信息</strong>。当我们需要强调变化、比较两个相关状态时，<strong>哑铃图</strong>提供了一种简洁而强大的解决方案。</p>
<p>就像选择合适的工具完成工作一样，在面对数据比较任务时，我们应该根据具体需求选择最合适的可视化形式：</p>
<ul>
<li>当需要比较多个项目的两个状态时，选择<strong>哑铃图</strong></li>
<li>当需要展示单个项目的多个组成部分时，选择<strong>堆积条形图</strong></li>
<li>当需要比较多个项目的多个类别时，选择<strong>簇状条形图</strong></li>
</ul>
<p>最好的可视化不是最复杂的，而是能让观众在最短时间内理解最多信息的那个。</p>
<p><strong>哑铃图</strong>正是这样一种高效的工具，它用最简单的线条连接，讲述了数据世界中最动人的变化故事。</p>
<p>下次做报告时，不妨试着把那张拥挤的簇状条形图换成<strong>哑铃图</strong>，相信你的观众会感叹：“哇，这张图做得真专业！”</p>
<p>完整代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8608730361-d698e0%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8608730361-d698e0?p=6872" ref="nofollow noopener noreferrer">哑铃图.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepSeek 2026技术前瞻：从"论文创新"到"落地革命"]]></title>    <link>https://juejin.cn/post/7598003935425953835</link>    <guid>https://juejin.cn/post/7598003935425953835</guid>    <pubDate>2026-01-22T15:47:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598003935425953835" data-draft-id="7598029481508372499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepSeek 2026技术前瞻：从&quot;论文创新&quot;到&quot;落地革命&quot;"/> <meta itemprop="keywords" content="前端,AI编程,DeepSeek"/> <meta itemprop="datePublished" content="2026-01-22T15:47:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子兮曰"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepSeek 2026技术前瞻：从"论文创新"到"落地革命"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子兮曰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T15:47:56.000Z" title="Thu Jan 22 2026 15:47:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇</h2>
<p>2025 年的最后一天，DeepSeek 团队在 arXiv 上发了一篇论文，标题是一串看不懂的英文：《mHC: Manifold-Constrained Hyper-Connections》。</p>
<p>老赵扫了一眼标题，心想：又是什么花里胡哨的东西？</p>
<p>但往下看两行，老赵坐直了——创始人梁文锋的名字赫然在列。更关键的是，这篇论文动了 Transformer 最底层那块砖：何恺明 2015 年提出的残差连接。</p>
<p>十年没改过的东西，DeepSeek 改了。</p>
<p>这篇文章从「DeepSeek 已发表论文 × 技术前瞻 × 开发者影响」三视角预测 2026 年的前沿亮点，帮你理清这些技术对你意味着什么，看完能直接套用的技术规划。</p>
<hr/>
<h2 data-id="heading-1">一、mHC：给 AI 的"高速公路"装上智能导航</h2>
<h3 data-id="heading-2">技术原理</h3>
<p>2025 年 12 月 31 日，DeepSeek 发布了《mHC: Manifold-Constrained Hyper-Connections》论文，核心是解决"超连接"（Hyper-Connections）在大规模模型训练中的不稳定性问题。</p>
<p>先回顾一下历史：</p>
<ul>
<li><strong>2015 年</strong>：何恺明提出残差连接（Residual Connection），公式简单粗暴：<code>output = layer(x) + x</code>。这条"单车道高速公路"让深度学习得以训练。</li>
<li><strong>2024 年</strong>：字节豆包团队提出超连接（HC），把单车道拓成"四车道并行"，允许信息在不同路径间自由流动。理论上能承载更多信息，但实际训练时——信号异常放大、梯度爆炸，训练极不稳定。</li>
</ul>
<p><strong>DeepSeek 的 mHC 方案</strong>：给这条高速公路加上"智能交通规则"，用数学约束（Birkhoff polytope 投影）确保：</p>
<ul>
<li>从任何车道流出的车辆总数 = 流入该车道的车辆总数</li>
<li>每个车道接收的车辆数量固定且均衡</li>
</ul>
<p><strong>数据说话</strong>：mHC 在 3B、9B、27B 参数模型上测试，性能实现线性扩展，训练稳定性大幅提升，计算开销仅增加 6-7%。</p>
<h3 data-id="heading-3">实操案例：理解 mHC 对代码生成的影响</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统残差连接（单车道）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResidualBlock</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> self.layer(x) + x

<span class="hljs-comment"># 超连接 HC（多车道，但不稳定）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HyperConnectionBlock</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 多条并行路径</span>
        path1 = self.layer1(x)
        path2 = self.layer2(x)
        path3 = self.layer3(x)
        <span class="hljs-comment"># 自由混合，但可能训练不稳定</span>
        <span class="hljs-keyword">return</span> self.mix([path1, path2, path3])

<span class="hljs-comment"># mHC（多车道 + 流形约束，稳定高效）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ManifoldConstrainedBlock</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 多条并行路径</span>
        path1 = self.layer1(x)
        path2 = self.layer2(x)
        path3 = self.layer3(x)

        <span class="hljs-comment"># 关键：用 Sinkhorn-Knopp 算法进行流形约束混合</span>
        <span class="hljs-comment"># 确保信息流动守恒，训练稳定</span>
        mixed = self.sinkhorn_mix([path1, path2, path3])
        <span class="hljs-keyword">return</span> mixed

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sinkhorn_mix</span>(<span class="hljs-params">self, paths</span>):
    <span class="hljs-string">"""
    将混合矩阵投影到 Birkhoff polytope（双随机矩阵）
    保证：
    - 每行和 = 1（流出守恒）
    - 每列和 = 1（流入守恒）
    """</span>
    mixing_matrix = self.learn_mix(paths)
    constrained_matrix = sinkhorn_knopp(mixing_matrix, num_iters=<span class="hljs-number">20</span>)
    <span class="hljs-keyword">return</span> constrained_matrix @ torch.stack(paths, dim=-<span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-4">落地步骤</h3>
<ol>
<li><strong>关注点</strong>：2026 年新模型是否会采用 mHC 架构</li>
<li><strong>实验验证</strong>：在自家模型中尝试集成 mHC，观察训练稳定性</li>
<li><strong>性能监控</strong>：对比传统残差连接 vs mHC 的训练曲线和最终性能</li>
</ol>
<h3 data-id="heading-5">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：看到新架构就急着换，忽略已有模型的稳定性</li>
<li>✅ <strong>正确做法</strong>：先在实验项目中验证 mHC，确认收益后再迁移</li>
<li>⚠️ <strong>注意</strong>：mHC 增加了 6-7% 计算开销，需要评估性价比</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、DeepSeek-V3.2 的三大突破：成本、思考、长上下文</h2>
<h3 data-id="heading-7">技术原理</h3>
<p>2025 年 12 月发布的 DeepSeek-V3.2 技术报告，展示了三个方向性创新：</p>
<p><strong>1. 稀疏注意力机制（DSA）+ 多头潜注意力（MLA）</strong></p>
<ul>
<li>DSA：128K 上下文推理成本降低 40%+</li>
<li>MLA：压缩 KV 缓存到低秩潜表示，减少 80% 显存占用</li>
</ul>
<p><strong>2. 思考模式（Thinking Mode）</strong></p>
<ul>
<li>显式推理链，类似 OpenAI o1 系列</li>
<li>支持最长 64K tokens 的思考过程</li>
<li>在数学、编程任务上达到 IMO/IOI 金牌水平</li>
</ul>
<p><strong>3. 成本效率</strong></p>
<ul>
<li>输入：$0.28/百万 tokens（GPT-5.1 的 1/20）</li>
<li>输出：$0.48/百万 tokens（GPT-5.1 的 1/25）</li>
<li>训练成本：仅 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5.5</mn><mi>M</mi><mi>G</mi><mi>P</mi><mi>U</mi><mtext>小时（同类模型约</mtext></mrow><annotation encoding="application/x-tex">5.5M GPU 小时（同类模型约 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">5.5</span><span class="mord mathnormal" style="margin-right:0.13889em;">MGP</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord cjk_fallback">小时（同类模型约</span></span></span></span></span>30M+）</li>
</ul>
<p><strong>数据说话</strong>：V3.2 在 Artificial Analysis 排名全球第 5，仅次于 Kimi K2 Thinking，但成本仅为对手的 5-10%。</p>
<h3 data-id="heading-8">实操案例：用 V3.2 构建智能代码审查 Agent</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 思考模式启用的代码审查流程</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DeepSeekChat</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@deepseek/sdk'</span>;

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeepSeekChat</span>({
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DEEPSEEK_API_KEY</span>,
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-v3.2'</span>,
  <span class="hljs-attr">thinking</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用思考模式</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reviewCode</span>(<span class="hljs-params">prDiff: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ReviewResult</span>&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`你是资深代码审查专家，审查风格：
1. 先分析代码意图（思考模式）
2. 检查潜在 Bug、性能问题、安全隐患
3. 提供具体改进建议（带代码示例）

输出格式：
- 思考过程：&lt;详细推理链&gt;
- 问题列表：&lt;问题1, 问题2, ...&gt;
- 改进建议：&lt;可执行的代码&gt;`</span>
      },
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`审查以下 PR 代码变更：
\`\`\`diff
<span class="hljs-subst">${prDiff}</span>
\`\`\``</span>
      }
    ],
    <span class="hljs-attr">max_tokens</span>: <span class="hljs-number">4096</span>,
    <span class="hljs-attr">thinking_budget</span>: <span class="hljs-number">32000</span>, <span class="hljs-comment">// 分配 32K tokens 给思考过程</span>
  });

  <span class="hljs-comment">// 解析响应（思考模式会返回 reasoning 字段）</span>
  <span class="hljs-keyword">const</span> { reasoning, content } = response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">thinkingProcess</span>: reasoning, <span class="hljs-comment">// 完整的思考链，可追踪</span>
    <span class="hljs-attr">issues</span>: <span class="hljs-title function_">parseIssues</span>(content),
    <span class="hljs-attr">suggestions</span>: <span class="hljs-title function_">parseSuggestions</span>(content)
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> prReview = <span class="hljs-keyword">await</span> <span class="hljs-title function_">reviewCode</span>(prDiff);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'审查思考过程:'</span>, prReview.<span class="hljs-property">thinkingProcess</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'发现的问题:'</span>, prReview.<span class="hljs-property">issues</span>);
</code></pre>
<h3 data-id="heading-9">落地步骤</h3>
<ol>
<li><strong>API 接入</strong>：申请 DeepSeek-V3.2 API，启用思考模式</li>
<li><strong>Prompt 工程</strong>：构建适合思考模式的 Prompt 模板（系统提示 + 思考预算）</li>
<li><strong>成本优化</strong>：监控 API 调用成本，对比其他模型的性价比</li>
<li><strong>性能对比</strong>：在真实任务中对比 V3.2 vs 其他模型的输出质量</li>
</ol>
<h3 data-id="heading-10">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：启用思考模式但不设置 thinking_budget，导致成本失控</li>
<li>✅ <strong>正确做法</strong>：根据任务复杂度合理分配思考 tokens（一般 16K-32K）</li>
<li>⚠️ <strong>注意</strong>：思考模式增加推理时间，实时性要求高的场景慎用</li>
</ul>
<hr/>
<h2 data-id="heading-11">三、2026 前沿预测：四个"必然"趋势</h2>
<h3 data-id="heading-12">技术原理</h3>
<p>基于 DeepSeek 已发表的论文和技术报告，可以预测 2026 年的四大必然趋势：</p>
<p><strong>1. mHC 成为新架构标准</strong></p>
<ul>
<li>2026 年发布的旗舰模型（包括 DeepSeek 自家）会默认采用 mHC</li>
<li>更深的模型（1000B+）将成为可能（训练稳定性解决）</li>
<li>开源社区会集成 mHC 到主流框架（PyTorch、JAX）</li>
</ul>
<p><strong>2. 超高效 MoE（Mixture-of-Experts）演进</strong></p>
<ul>
<li>当前 V3.2：671B 总参数 / 37B 激活（5.5% 稀疏度）</li>
<li>2026 预测：1000B+ 总参数 / 20B 激活（2% 稀疏度）</li>
<li>动态专家路由精度提升，负载更均衡</li>
</ul>
<p><strong>3. 多模态深度集成</strong></p>
<ul>
<li>V3.2 已具备基础视觉理解能力</li>
<li>2026 预测：原生支持图像、音频、视频输入输出</li>
<li>统一模型替代"分而治之"的多模态方案</li>
</ul>
<p><strong>4. 思考模式 + Agent 自动化</strong></p>
<ul>
<li>V3.2 的思考模式已展示强大推理能力</li>
<li>2026 预测：Agent 能自主分解复杂任务、调用工具、自我纠错</li>
<li>从"单次对话"升级为"持续任务执行"</li>
</ul>
<h3 data-id="heading-13">实操案例：构建多模态思考型 Agent</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 2026 年可能的 Agent 架构（基于 DeepSeek 技术趋势）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MultiModalThinkingAgent</span> {
  <span class="hljs-comment">// 多模态输入处理</span>
  <span class="hljs-title function_">processInput</span>(<span class="hljs-attr">input</span>: {
    text?: <span class="hljs-built_in">string</span>;
    image?: <span class="hljs-title class_">ImageBuffer</span>;
    audio?: <span class="hljs-title class_">AudioBuffer</span>;
  }): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ThinkingContext</span>&gt;;

  <span class="hljs-comment">// 深度思考（mHC 优化的推理网络）</span>
  <span class="hljs-title function_">think</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ThinkingContext</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ThoughtChain</span>&gt;;

  <span class="hljs-comment">// 工具调用（MoE 专家分工）</span>
  <span class="hljs-title function_">useTool</span>(<span class="hljs-attr">tool</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ToolResult</span>&gt;;

  <span class="hljs-comment">// 自我纠错（强化学习优化）</span>
  <span class="hljs-title function_">selfCorrect</span>(<span class="hljs-attr">error</span>: <span class="hljs-title class_">Error</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">CorrectionPlan</span>&gt;;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepSeekAgent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MultiModalThinkingAgent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> model: DeepSeekV4, <span class="hljs-comment">// 预测的 V4 模型</span>
    <span class="hljs-keyword">private</span> thinkingMode: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">processInput</span>(<span class="hljs-params">input: MultiModalInput</span>) {
    <span class="hljs-comment">// 1. 多模态编码（V4 原生支持）</span>
    <span class="hljs-keyword">const</span> encoded = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">encodeMultiModal</span>(input);

    <span class="hljs-comment">// 2. 初始思考链</span>
    <span class="hljs-keyword">const</span> initialThoughts = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">think</span>({
      encoded,
      <span class="hljs-attr">thinkingBudget</span>: <span class="hljs-number">32000</span>,
      <span class="hljs-attr">mode</span>: <span class="hljs-string">'deep'</span>
    });

    <span class="hljs-comment">// 3. 任务分解与工具调用</span>
    <span class="hljs-keyword">const</span> tasks = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decomposeTasks</span>(initialThoughts);
    <span class="hljs-keyword">const</span> results = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> task <span class="hljs-keyword">of</span> tasks) {
      <span class="hljs-comment">// 4. MoE 专家路由（自动选择最擅长的专家）</span>
      <span class="hljs-keyword">const</span> expert = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">routeExpert</span>(task);

      <span class="hljs-comment">// 5. 执行工具</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> expert.<span class="hljs-title function_">execute</span>(task);
      results.<span class="hljs-title function_">push</span>(result);

      <span class="hljs-comment">// 6. 自我纠错（强化学习优化）</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">error</span>) {
        <span class="hljs-keyword">const</span> correction = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selfCorrect</span>(result.<span class="hljs-property">error</span>);
        results.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">await</span> correction.<span class="hljs-title function_">retry</span>());
      }
    }

    <span class="hljs-comment">// 7. 最终综合（mHC 稳定的多路径融合）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">synthesize</span>({
      initialThoughts,
      <span class="hljs-attr">taskResults</span>: results
    });
  }
}
</code></pre>
<h3 data-id="heading-14">落地步骤</h3>
<ol>
<li><strong>2026 Q1</strong>：关注 DeepSeek 是否发布采用 mHC 的新模型</li>
<li><strong>2026 Q2</strong>：在实验项目中集成多模态 API</li>
<li><strong>2026 Q3</strong>：尝试构建思考型 Agent 工作流</li>
<li><strong>2026 Q4</strong>：评估新架构在生产环境的可行性</li>
</ol>
<h3 data-id="heading-15">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：过度依赖 Agent 自动化，放弃人工监督</li>
<li>✅ <strong>正确做法</strong>：Agent 处理 80% 常规任务，人工负责 20% 复杂决策</li>
<li>⚠️ <strong>注意</strong>：多模态模型的输入输出质量差异很大，需要针对性测试</li>
</ul>
<hr/>
<h2 data-id="heading-16">四、开发者如何应对：从"观望"到"布局"</h2>
<h3 data-id="heading-17">技术原理</h3>
<p>2026 年的 AI 技术更新会更快，但关键不是追新技术，而是——理解哪些技术能解决你当前的问题，然后提前布局。</p>
<p><strong>三个核心问题</strong>：</p>
<ol>
<li>mHC 架构是否影响你的模型训练？</li>
<li>稀疏注意力能否优化你的长上下文任务？</li>
<li>思考模式能否提升你的复杂任务质量？</li>
</ol>
<h3 data-id="heading-18">实操案例：构建 DeepSeek 技术追踪系统</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 技术追踪系统：自动评估 DeepSeek 新技术对你项目的价值</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">TechTracker</span> {
  <span class="hljs-title function_">monitorPaper</span>(<span class="hljs-attr">paperUrl</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TechImpact</span>&gt;;
  evaluateImpact(<span class="hljs-attr">tech</span>: <span class="hljs-title class_">Tech</span>, <span class="hljs-attr">project</span>: <span class="hljs-title class_">Project</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AdoptionPlan</span>&gt;;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepSeekTechTracker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TechTracker</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">monitorPaper</span>(<span class="hljs-params">paperUrl: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 自动抓取论文关键信息</span>
    <span class="hljs-keyword">const</span> paper = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchPaper</span>(paperUrl);
    <span class="hljs-keyword">const</span> impact = {
      <span class="hljs-attr">title</span>: paper.<span class="hljs-property">title</span>,
      <span class="hljs-attr">authors</span>: paper.<span class="hljs-property">authors</span>,
      <span class="hljs-attr">innovations</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractInnovations</span>(paper),
      <span class="hljs-attr">performance</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractBenchmarks</span>(paper),
      <span class="hljs-attr">cost</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">estimateCost</span>(paper)
    };

    <span class="hljs-comment">// 与现有技术栈对比</span>
    impact.<span class="hljs-property">comparison</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareWithStack</span>(impact);

    <span class="hljs-keyword">return</span> impact;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">evaluateImpact</span>(<span class="hljs-params">tech: Tech, project: Project</span>) {
    <span class="hljs-comment">// 计算技术收益</span>
    <span class="hljs-keyword">const</span> benefits = {
      <span class="hljs-attr">performance</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">estimatePerformanceGain</span>(tech, project),
      <span class="hljs-attr">cost</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">estimateCostChange</span>(tech, project),
      <span class="hljs-attr">stability</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">estimateStability</span>(tech, project)
    };

    <span class="hljs-comment">// 生成采纳建议</span>
    <span class="hljs-keyword">const</span> recommendation = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generatePlan</span>({
      <span class="hljs-attr">currentStack</span>: project.<span class="hljs-property">stack</span>,
      <span class="hljs-attr">newTech</span>: tech,
      benefits,
      <span class="hljs-attr">constraints</span>: project.<span class="hljs-property">constraints</span>
    });

    <span class="hljs-keyword">return</span> recommendation;
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">generatePlan</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">PlanContext</span>): <span class="hljs-title class_">AdoptionPlan</span> {
    <span class="hljs-comment">// 返回：</span>
    <span class="hljs-comment">// - 是否采纳（adopt/wait/skip）</span>
    <span class="hljs-comment">// - 采纳步骤</span>
    <span class="hljs-comment">// - 风险评估</span>
    <span class="hljs-comment">// - 预期收益</span>
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> tracker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeepSeekTechTracker</span>();
<span class="hljs-keyword">const</span> mhcImpact = <span class="hljs-keyword">await</span> tracker.<span class="hljs-title function_">monitorPaper</span>(<span class="hljs-string">'https://arxiv.org/abs/2512.24880'</span>);
<span class="hljs-keyword">const</span> plan = <span class="hljs-keyword">await</span> tracker.evaluateImpact(mhcImpact, myProject);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'采纳建议:'</span>, plan.<span class="hljs-property">recommendation</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'预期收益:'</span>, plan.<span class="hljs-property">expectedBenefits</span>);
</code></pre>
<h3 data-id="heading-19">落地步骤</h3>
<ol>
<li><strong>技术扫描</strong>（Q1）：每周检查 DeepSeek 发布的论文和模型更新</li>
<li><strong>实验验证</strong>（Q2）：在沙盒环境测试新技术</li>
<li><strong>价值评估</strong>（Q3）：对比新技术 vs 现有方案的性价比</li>
<li><strong>逐步迁移</strong>（Q4）：有价值的分阶段迁移到生产环境</li>
</ol>
<h3 data-id="heading-20">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：每篇论文都读，精力分散，无法深入</li>
<li>✅ <strong>正确做法</strong>：聚焦与你项目相关的技术领域，精读核心论文</li>
<li>⚠️ <strong>注意</strong>：arXiv 论文是预印本，可能存在错误，等待 peer review</li>
</ul>
<hr/>
<h2 data-id="heading-21">结尾</h2>
<p>2025 年的最后一天，老赵刷到 DeepSeek mHC 论文的新闻，觉得"跟我也没关系"。</p>
<p>三个月后，他发现隔壁组用 mHC 重新训练了推荐模型——训练时间从 30 天缩短到 18 天，稳定性提升 80%。老赵这才明白，底层架构的突破，最终会传导到每个开发者手里。</p>
<p>2026 年，DeepSeek 会继续发布什么？V4？更便宜的模型？还是新的架构创新？</p>
<p>但有一点是确定的：这些技术不是遥远的科幻，而是正在发生的现实。关键在于——你准备好跟进了吗？</p>
<p>你在 DeepSeek 的哪些技术点上有困惑？mHC 架构理解、V3.2 思考模式使用、还是 2026 年技术布局？评论区交流，我们一起讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026开年王炸：文心5.0带着2.4万亿参数和原生全模态来了]]></title>    <link>https://juejin.cn/post/7598062246572572726</link>    <guid>https://juejin.cn/post/7598062246572572726</guid>    <pubDate>2026-01-22T14:09:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598062246572572726" data-draft-id="7598062246572556342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026开年王炸：文心5.0带着2.4万亿参数和原生全模态来了"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-22T14:09:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026开年王炸：文心5.0带着2.4万亿参数和原生全模态来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:09:28.000Z" title="Thu Jan 22 2026 14:09:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在大家都还在回味2025年AI圈的各种混战时，百度在2026年1月22日的“文心Moment”大会上，直接甩出了一张重磅底牌——文心大模型5.0正式版。</p>
<p>作为一个长期在AI一线摸爬滚打的观察者，这次发布会给我的感觉有些不同。如果说以前大家还在拼谁的发布会PPT做得更漂亮，那么文心5.0的发布，更像是一次秀肌肉的“实弹演习”。</p>
<p>咱们抛开那些晦涩的术语，聊聊这次文心5.0到底强在哪，为什么业内有人说这是国产大模型的一次“成人礼”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-22_21.57.04-1024x636.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-22_21.57.04-1024x636.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7693f933ec3945a789d477e009d0ae3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769695768&amp;x-signature=3bK6f5t86%2FovZIOO43a8iszYjdg%3D" alt="iShot_2026-01-22_21.57.04" loading="lazy"/></a></p>
<h2 data-id="heading-0">不是简单的“大”，而是“大而精”</h2>
<p>首先得说说这个吓人的数字：<strong>2.4万亿参数</strong>。</p>
<p>放在两年前，这是一个难以想象的体量。但如果你以为这只是单纯地堆显卡、堆算力，那就错了。参数大通常意味着聪明，但也意味着慢和贵。百度这次最狠的一招，是用上了<strong>超大稀疏混合专家结构（MoE）</strong>。</p>
<p>这是什么概念？这就好比你拥有一个由2.4万亿个神经元组成的超级大脑，但在处理具体问题时（比如写一段代码或分析一张图），它不会全员出动，而是精准调动其中最懂行的那<strong>不到3%</strong> 的“专家”来干活。</p>
<p>官方数据显示，激活参数比例低于3%。这意味着它既拥有万亿级模型的深厚内力，又保持了极高的推理效率。既要马儿跑，又要马儿少吃草，这在工程上是个极高的门槛。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Ffdsghdf-1-1024x188.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/fdsghdf-1-1024x188.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5cebf04e41b4d6e89c62b59d60a8a38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769695768&amp;x-signature=MxeMcaqnyXocIIyh2sKSb6lLV84%3D" alt="fdsghdf" loading="lazy"/></a></p>
<h2 data-id="heading-1">原生全模态：打通任督二脉</h2>
<p>这次最让我感兴趣的技术点，其实是“<strong>原生全模态统一建模</strong>”。</p>
<p>以前很多所谓的多模态模型，其实是“拼凑”出来的。视觉模型看图，语言模型说话，中间像是有个翻译官在传话。这种“后期融合”最大的问题就是不仅慢，而且容易出现理解偏差。</p>
<p>文心5.0走的是另一条路：<strong>原生</strong>。</p>
<p>从训练的第一天起，文本、图像、音频、视频就被放在同一个大锅里炖。模型不再是把图翻译成字，而是直接理解了像素和语义之间的关联。这种统一的自回归架构，让模型在处理跨模态任务时显得游刃有余。官方演示里，那个看视频教程自动拆解步骤并生成前端代码的案例，就是这种能力的典型体现——它不需要先把视频转成文字脚本，而是直接“看懂”了操作逻辑。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Ffgdfhsfgh-1024x572.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/fgdfhsfgh-1024x572.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba39b326cce445c49cc5b6679c440493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769695768&amp;x-signature=uSUKiIT7nPjww8mCpT5lPN6GX4U%3D" alt="fgdfhsfgh" loading="lazy"/></a></p>
<h2 data-id="heading-2">硬碰硬的成绩单</h2>
<p>数据是不会撒谎的。根据<strong>LMArena全球大模型竞技场</strong>的最新榜单（2026年1月15日数据），文心5.0拿到了<strong>1460分</strong>。</p>
<p>这个分数什么水平？<strong>全球第八，国内第一</strong>。</p>
<p>更值得玩味的是，官方直接把<strong>Gemini-2.5-Pro</strong>和<strong>GPT-5-High</strong>列为了比较对象，并表示在<strong>40多项基准评测</strong>中实现了超越。虽然各家厂商都有自己的“优势领域”，但敢在语言理解和多模态这种硬核指标上叫板国际顶流，说明百度这次确实是有备而来。</p>
<h2 data-id="heading-3">给AI请了835位“班主任”</h2>
<p>除了硬技术，这次百度还搞了个很有意思的“<strong>文心导师</strong>”计划。</p>
<p>大家都在担心AI一本正经地胡说八道，百度的解法是找人。他们找了<strong>835位</strong>各行各业的专家，从科技到人文，从逻辑到价值观，给模型做“校准”。这就像是给天才学生请了一群严格的班主任，专门纠正它的思维逻辑和专业偏差。这一点在垂直行业应用上尤为关键，毕竟在医疗或金融领域，准确性远比创造力更重要。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fsdfsdfg-1024x464.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/sdfsdfg-1024x464.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90bf78cfca604dfc80ae8a4a8dee31f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769695768&amp;x-signature=gjavOmS25TEk9odhIntcumdVlgs%3D" alt="sdfsdfg" loading="lazy"/></a></p>
<h2 data-id="heading-4">写在最后</h2>
<p>文心5.0的发布，某种程度上标志着国产大模型走出了“追随”期，开始进入了“并跑”甚至部分“领跑”的阶段。</p>
<p>2.4万亿参数的底座，加上原生全模态的架构，再配合千帆平台上已经生长出来的<strong>130多万个智能体</strong>，百度正在构建一个非常厚实的生态壁垒。</p>
<p>对于咱们普通用户来说，最直接的利好就是，那个在他人口中“很强但很贵”的AI体验，现在通过<strong>文心APP</strong>或者<strong>文心一言官网</strong>就能触手可及。至于它到底能不能像宣传的那么神，不妨自己去试一试，毕竟，实践才是检验真理的唯一标准。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 入门：30行代码画出你的第一条3D线条]]></title>    <link>https://juejin.cn/post/7597973595131723828</link>    <guid>https://juejin.cn/post/7597973595131723828</guid>    <pubDate>2026-01-22T14:33:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597973595131723828" data-draft-id="7597989474971320370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 入门：30行代码画出你的第一条3D线条"/> <meta itemprop="keywords" content="前端,three.js,WebGL"/> <meta itemprop="datePublished" content="2026-01-22T14:33:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 入门：30行代码画出你的第一条3D线条
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:33:47.000Z" title="Thu Jan 22 2026 14:33:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">核心概念：3个必备元素</h2>
<p>在 Three.js 中，想要渲染任何东西，你需要理解3个核心概念：</p>
<ol>
<li><strong>场景 (Scene)</strong> - 就像一个舞台，所有物体都放在这里</li>
<li><strong>相机 (Camera)</strong> - 就像你的眼睛，决定从哪个角度看舞台</li>
<li><strong>渲染器 (Renderer)</strong> - 把场景和相机的内容画到屏幕上</li>
</ol>
<h2 data-id="heading-1">完整代码</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-comment">// 1️⃣ 创建场景 - 所有物体的容器</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 2️⃣ 创建相机 - 决定我们从哪里看</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">75</span>,                           <span class="hljs-comment">// 视野角度</span>
  innerWidth / innerHeight,     <span class="hljs-comment">// 宽高比</span>
  <span class="hljs-number">0.1</span>,                          <span class="hljs-comment">// 近裁剪面</span>
  <span class="hljs-number">1000</span>                          <span class="hljs-comment">// 远裁剪面</span>
);
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">5</span>;          <span class="hljs-comment">// 把相机往后移，才能看到原点的物体</span>

<span class="hljs-comment">// 3️⃣ 创建渲染器 - 把3D内容画到网页上</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 4️⃣ 画线！</span>
<span class="hljs-comment">// 定义线条经过的点</span>
<span class="hljs-keyword">const</span> points = [
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(-<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">// 左边的点</span>
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">// 顶部的点</span>
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)     <span class="hljs-comment">// 右边的点</span>
];

<span class="hljs-comment">// 用这些点创建几何体</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(points);

<span class="hljs-comment">// 创建线条材质（绿色）</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x00ff00</span> });

<span class="hljs-comment">// 组合几何体和材质，创建线条对象</span>
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Line</span>(geometry, material);

<span class="hljs-comment">// 把线条添加到场景中</span>
scene.<span class="hljs-title function_">add</span>(line);

<span class="hljs-comment">// 5️⃣ 渲染！</span>
renderer.<span class="hljs-title function_">render</span>(scene, camera);
</code></pre>
<h2 data-id="heading-2">代码解析</h2>
<h3 data-id="heading-3">画线三步曲</h3>

























<table><thead><tr><th>步骤</th><th>代码</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td><code>BufferGeometry().setFromPoints(points)</code></td><td>定义线条的形状（经过哪些点）</td></tr><tr><td>2</td><td><code>LineBasicMaterial({ color })</code></td><td>定义线条的外观（颜色）</td></tr><tr><td>3</td><td><code>new THREE.Line(geometry, material)</code></td><td>把形状和外观组合成线条对象</td></tr></tbody></table>
<p>📂 <strong>核心代码与完整示例：</strong>      <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqq790git%2Fmy-three-app.git" target="_blank" title="https://github.com/qq790git/my-three-app.git" ref="nofollow noopener noreferrer">my-three-app</a></p>
<h3 data-id="heading-4">总结</h3>
<p><strong>如果你喜欢本教程，记得点赞+收藏！关注我获取更多Three.js开发干货</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 之戏译“爻悟机”]]></title>    <link>https://juejin.cn/post/7598025242041581620</link>    <guid>https://juejin.cn/post/7598025242041581620</guid>    <pubDate>2026-01-22T14:45:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598025242041581620" data-draft-id="7598011274686906368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 之戏译“爻悟机”"/> <meta itemprop="keywords" content="OpenAI,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-22T14:45:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稻草江南"/> <meta itemprop="url" content="https://juejin.cn/user/1811586730696142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 之戏译“爻悟机”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811586730696142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稻草江南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:45:14.000Z" title="Thu Jan 22 2026 14:45:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Transformer 之戏译“爻悟机”</strong></h2>
<p><strong>缘起：为何“变形金刚”配不上这技术</strong></p>
<p>近日学习AI相关知识，感“Transformer”不译，学者茫然，脑海中浮现的竟是：</p>
<ul>
<li>擎天柱的机械变形</li>
<li>变压器，想到了变电站和电线杆</li>
<li>转换器，想到了电源插头</li>
</ul>
<p>不译，是汉语的贫乏。学习之余，与AI来一场思想碰撞，试遨游天地，梦见周公，用古老的周易卦象推理来类比Transformer机制，终得一戏译：<strong>爻悟机</strong>。</p>
<hr/>
<p><strong>正名：爻悟机的三重奥义</strong></p>
<p><strong>爻者，特征向量之微元也；悟者，通神明之德也。</strong><br/>
<strong>爻悟之机，感而遂通，寂然不动，而遂知天下之故。</strong></p>
<p>此名非直译，乃诠释——召唤《周易》中“微观单元感通涌现宏观智能”的原型。</p>
<p><strong>爻之微：立象以尽意</strong></p>
<p>《系辞》云：“爻也者，效天下之动者也。六爻相杂，唯其时物也。”</p>
<p><strong>位</strong>：爻分初、二、三、四、五、上，位不同则吉凶异。正如token之embedding，虽同一词，处不同序列之位，其义遂变。同一个“打”字，因维度特征之异，含义亦殊（如“打篮球”与“打车”中）。</p>
<p><strong>时</strong>：爻之时义大矣哉！时者，上下文也。Attention之妙，正在于每个token皆能观其“时”——看遍全序列，知其所处之“时机”，而后定其新义。</p>
<p><strong>物</strong>：爻效万物之象，token拟人间之语。爻之阴阳刚柔，犹embedding中各维度之数值正负。第237维掌时态，第512维司情感——此皆爻之体。</p>
<p><strong>结论</strong>：爻者，token之特征维度，乃token之性命；象者，context之特征向量；卦者，特征向量之矩阵运算也。小模型若六爻成一卦，大模型则六十四爻成一卦。</p>
<p><strong>爻之感：寂然不动，感而遂通</strong></p>
<p>“天地感而万物化生，圣人感人心而天下和平。观其所感，而天地万物之情可见矣！”（《咸卦·彖传》）</p>
<p>自注意力机制，实乃<strong>爻爻相感</strong>之现代版：</p>
<p><strong>初感</strong>：Query-Key-Value，非token相感，乃“第512维之阴，感第237维之阳”——特征跨token相摩相荡。</p>
<p><strong>比应</strong>：相邻爻相比（local attention），初与四、二与五、三与上相应（long-range dependency），如“虽然……但是……”之远距呼应。</p>
<p><strong>承乘</strong>：权重高者乘于上，权重低者承于下。Attention softmax后，重要特征驾驭次要特征，如阳爻乘阴，刚驾驭柔。</p>
<p><strong>核心</strong>：感之范围（context window）越大，能观之时越广。大模型从1K扩至百万上下文，如圣人之心“廓然大公，物来顺应”。</p>
<p><strong>悟之顿：穷神知化，德之盛也</strong></p>
<p>《系辞》“穷神知化，德之盛也”，正如Transformer参数量上去后突然知道了很多，涌现出复杂能力（如reasoning），进而演化出vibecoding、ReAct等。</p>
<p><strong>单卦</strong>：一Layer一世界。Attention内卦感通，FFN外卦变通，卦卦皆是一次“象的转化”。</p>
<p><strong>重卦</strong>：层卦相重。初卦output为二卦input，如文王之演《易》，“因而重之，爻在其中矣”。卦象遂深，表征遂精。</p>
<p><strong>顿悟</strong>：当参数规模突破临界，few-shot能力不召自来，Chain-of-Thought自主涌现。非线性之涌现，正合“引而伸之，触类而长之，天下之能事毕矣”。</p>
<p><strong>关键</strong>：残差连接如“化而裁之”，保存旧象（identity）以推而行之，否则梯度断绝，卦卦无承，何以周流六虚？</p>
<hr/>
<p><strong>余论：命名的温度</strong></p>
<p>“爻悟机”三字，念起来像上古神器，用起来却是特征交互的诗意概括。它不完美，却耐琢磨——每思一次，层数越深，理解越丰。</p>
<p>下次再看到"Transformer"，你就默念“爻悟机”。这样你脑中浮现的不再是擎天柱，而是千百爻象寂然感通、刹那间光华迸现的至境。</p>
<p><strong>爻悟机</strong>者，Transformer之雅称也。爻者效天下之动，悟者通神明之德，感而遂通，寂然不动，而知天下之故。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[爆火的 Agent Skills 深度解析]]></title>    <link>https://juejin.cn/post/7598057199962308659</link>    <guid>https://juejin.cn/post/7598057199962308659</guid>    <pubDate>2026-01-22T13:05:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598057199962308659" data-draft-id="7597997108135084059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="爆火的 Agent Skills 深度解析"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-22T13:05:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="indieAI"/> <meta itemprop="url" content="https://juejin.cn/user/4488643649743614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            爆火的 Agent Skills 深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4488643649743614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    indieAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:05:11.000Z" title="Thu Jan 22 2026 13:05:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心定义：Agent Skills是什么？</h2>
<p>在AI Agent语境中，Skills（技能）是智能体为完成特定任务而具备的能力集合，是算法模型、场景数据与业务需求的深度融合体。它并非单一的技术模块，而是贯穿Agent感知、决策、执行、学习全流程的核心支撑，能够让Agent将抽象目标转化为可落地的具体行动。</p>
<h3 data-id="heading-1">关键认知：Agent与Skills的关系</h3>
<p>Agent与Skills的关系如同"数字人"与"专业能力"——脱离Skills的Agent只是具备基础推理能力的"空壳"，而优质的Skills体系能让Agent从"被动响应指令"升级为"主动解决问题"，这也是Meta收购Manus后重点强化Skills生态的核心原因。</p>
<h3 data-id="heading-2">三层架构总览：Metadata、Instruction、Resources</h3>
<p>你可以把一个Skill想象成"一个小产品"。三层架构就是它的产品结构：</p>
<h4 data-id="heading-3">（一）Metadata：你是谁、能做什么、边界在哪里</h4>
<p>Metadata是技能的"说明书 + 合同 + 配置入口"。它回答：</p>
<ul>
<li>这个Skill叫什么？解决什么问题？适合谁用？</li>
<li>输入/输出是什么结构？成功标准是什么？</li>
<li>有哪些风险与边界？哪些动作必须人工确认？</li>
<li>成本预算、权限等级、版本信息是什么？</li>
</ul>
<p>没有Metadata的Agent，通常会变成"写得很好，但不可控"：要么乱调用工具，要么输出风格漂移，要么越权执行。</p>
<h4 data-id="heading-4">（二）Instruction：你怎么做、按什么流程做、怎么自检</h4>
<p>Instruction是技能的"操作系统"。它不是一句"请你专业一点"，而是可执行的SOP：</p>
<ul>
<li>先澄清哪些信息，缺什么就问什么；</li>
<li>什么情况下必须检索，什么情况下不该检索；</li>
<li>工具如何选择、调用顺序是什么、失败怎么兜底；</li>
<li>结果如何验证、冲突证据如何处理；</li>
<li>输出格式、引用规范、口吻要求；</li>
<li>最终如何自检与验收。</li>
</ul>
<h4 data-id="heading-5">（三）Resources：你能用到哪些外部能力与信息</h4>
<p>Resources是技能的"手脚 + 资料库 + 观测系统"。包括：</p>
<ul>
<li>工具/函数（API、数据库、企业系统、自动化脚本）</li>
<li>检索与知识（RAG：向量库、文档库、网页、内网）</li>
<li>执行环境（代码执行、浏览器自动化、工作流引擎）</li>
<li>可观测与评估（Tracing、日志、评测集、告警）</li>
</ul>
<h2 data-id="heading-6">二、Agent Skills的分类体系</h2>
<p>根据功能属性与应用层级，Agent Skills可以分为四大类：</p>
<h3 data-id="heading-7">2.1 基础交互技能：Agent的"沟通桥梁"</h3>
<p>核心作用：实现Agent与人类、外部系统或物理环境的信息交互，是所有高级能力的基础。这类技能的核心价值在于"精准感知"与"有效表达"。</p>
<ul>
<li><strong>自然语言处理（NLP）</strong>：包括意图识别、语义理解、多轮对话、合规话术生成等，典型应用如电商客服Agent理解用户退换货需求。</li>
<li><strong>计算机视觉（CV）</strong>：涵盖图像检测、目标识别、场景理解等，例如工业运维Agent通过图像识别设备异常升温。</li>
<li><strong>语音与传感交互</strong>：语音识别、合成、IoT传感器数据解析等，比如智能家居Agent通过语音指令控制设备，或工业Agent采集振动、电流数据。</li>
</ul>
<h3 data-id="heading-8">2.2 决策规划技能：Agent的"思考中枢"</h3>
<p>核心作用：决策规划技能是Agent的"思考中枢"，负责将基础交互技能感知到的信息与高层任务目标深度融合，制定可落地的最优行动方案，并能在执行过程中动态应对环境变化与突发状况。区别于传统大模型的静态推理，该技能具备"目标拆解-优先级排序-执行监控-动态纠错"的全生命周期管理能力，是Agent实现自主化、智能化的核心标志。</p>
<p>决策规划技能的核心能力模块可拆解为三大维度：</p>
<h4 data-id="heading-9">（1）目标解析与任务拆解</h4>
<p>核心是将模糊、抽象的高层目标转化为清晰、可执行的子任务序列。例如面对"组织跨部门季度总结会议"这一模糊需求，Agent可拆解为：</p>
<ol>
<li>确定会议时间（协调多部门日程）</li>
<li>筛选会议场地（匹配人数与设备需求）</li>
<li>准备会议材料（收集各部门总结）</li>
<li>发送会议通知（同步议程与参会要求）</li>
<li>安排会议记录（确定记录人或启用录音转录）</li>
</ol>
<h4 data-id="heading-10">（2）风险评估与优先级排序</h4>
<p>基于场景数据与历史经验，预判各子任务的执行难度、资源消耗、时间成本及潜在风险，进而确定最优执行顺序。例如金融风控Agent在处理批量信贷审核任务时，会先通过风险评估技能筛选出"高负债+无稳定收入"的高风险案例优先处理。</p>
<h4 data-id="heading-11">（3）动态适配与纠错优化</h4>
<p>这是决策规划技能的"灵活性核心"，确保Agent在复杂、多变的环境中持续推进任务。当出现工具调用失败、数据异常、环境变化等情况时，Agent可通过该技能快速调整策略——切换备用工具、补充收集信息、重新规划执行路径等。</p>
<h3 data-id="heading-12">2.3 执行操作技能：Agent的"行动手脚"</h3>
<p>核心作用：将决策方案转化为具体行动，连接虚拟决策与物理/数字世界的执行，是Agent实现价值落地的关键。这类技能高度依赖工具集成与协议适配。</p>
<ul>
<li><strong>工具调用与API集成</strong>：通过MCP等协议调用搜索引擎、数据库、业务系统API等，例如数据分析Agent调用SQL接口查询销售数据。</li>
<li><strong>代码生成与执行</strong>：自主编写、调试代码完成任务，如科研辅助Agent生成化学模拟代码，或DevOps Agent编写部署脚本。</li>
<li><strong>物理/虚拟环境操作</strong>：控制机械臂、IoT设备等物理实体，或在VR/AR环境中完成交互，例如工业机械臂Agent的精准抓取，元宇宙数字分身的自主交互。</li>
</ul>
<h3 data-id="heading-13">2.4 学习进化技能：Agent的"成长引擎"</h3>
<p>核心作用：让Agent通过数据积累与反馈优化能力，实现从"静态技能"到"动态进化"的升级，是Agent适应复杂场景的核心支撑。</p>
<ul>
<li><strong>强化学习</strong>：通过环境交互反馈优化行为策略，例如自动驾驶Agent优化路径规划方案。</li>
<li><strong>迁移学习</strong>：将A场景技能迁移至B场景，减少新场景训练数据需求，例如将电商客服技能迁移至金融客服场景。</li>
<li><strong>元学习</strong>：快速掌握全新技能，提升未知环境适应能力，例如科研Agent快速学习新领域文献分析方法。</li>
</ul>
<h2 data-id="heading-14">三、Agent Skills的核心价值</h2>
<h3 data-id="heading-15">3.1 支撑自主决策，打破"工具依赖"</h3>
<p>传统的工具调用模式需要人类明确指示"调用什么工具"，而Agent Skills让AI能够自主判断"需要什么技能"，并自动调用相关工具完成任务。这种从"被动执行"到"主动决策"的转变，是AI从"助手"升级为"员工"的关键标志。</p>
<h3 data-id="heading-16">3.2 实现模块化适配，降低场景落地成本</h3>
<p>Agent Skills采用标准化的文件夹结构，每个技能本质上是一个包含SKILL.md文件的文件夹，内部整合"指令文档、可执行脚本、配套资源"三大要素。这种设计让技能脱离"单一模型绑定"，只要平台支持该标准，就能直接调用文件夹内的所有能力，实现"一次开发，多端复用"。</p>
<h3 data-id="heading-17">3.3 驱动持续进化，提升长期价值</h3>
<p>Agent Skills支持渐进式披露（Progressive Disclosure）设计，智能体首先仅读取技能的元数据（名称与简介），仅在确定需要使用该技能时，才加载详细的指令文件和执行脚本。这种设计不仅节省了上下文Token开销，还支持技能的动态更新与扩展，让Agent能够持续学习和进化。</p>
<h2 data-id="heading-18">四、如何构建Agent Skills</h2>
<h3 data-id="heading-19">4.1 技能的解剖结构：文件与文件夹</h3>
<p>一个完整的Agent Skill包含以下核心组件：</p>
<h4 data-id="heading-20">（1）SKILL.md（必选）</h4>
<p>采用"YAML元数据头部 + Markdown正文"结构。元数据包含技能名称（name）、描述（description）、版本（version）等关键信息，用于告知Agent技能的作用与触发条件；正文则明确操作规则、执行步骤、输出格式等核心指令。</p>
<h4 data-id="heading-21">（2）Reference文件夹（可选）</h4>
<p>存放补充性资源，如详细制度手册、条款模板、字段说明等长文本内容。该部分不会默认加载，仅在Agent需要时按需读取，可有效节省上下文Token开销。</p>
<h4 data-id="heading-22">（3）Scripts文件夹（可选）</h4>
<p>包含用于完成确定性任务的脚本文件（如Python、Bash脚本），可实现数据校验、文件转换、系统上传等自动化操作。脚本在Agent的沙盒环境中执行，仅返回结果而非代码本身，进一步压缩上下文占用。</p>
<h3 data-id="heading-23">4.2 渐进式披露：解决Prompt Bloat问题</h3>
<p>Agent Skills采用了一种巧妙的渐进式披露（Progressive Disclosure）设计，就像游戏里的技能树一样，分为三个层次：</p>
<ol>
<li>
<p><strong>第一层：技能目录（~100 tokens）</strong>
Agent启动时，只加载所有技能的name和description。这就像游戏里的技能列表，你能看到所有可学的技能，但还没有详细说明。</p>
</li>
<li>
<p><strong>第二层：技能说明书（&lt; 5000 tokens）</strong>
当Agent判断某个任务需要用到某个技能时，才会加载完整的SKILL.md文件。这就像点开技能详情页，看到完整的使用说明、注意事项和示例。</p>
</li>
<li>
<p><strong>第三层：技能资源包（按需加载）</strong>
如果技能需要执行脚本、查阅参考文档或使用模板，这些资源会被放在scripts/、references/、assets/等子目录中，只在真正需要时才加载。</p>
</li>
</ol>
<h3 data-id="heading-24">4.3 设计高质量Skills的最佳实践</h3>
<p>在开发Agent时，Skill的质量直接决定了Agent的智商。以下是设计原则：</p>
<h4 data-id="heading-25">（1）原子性（Atomicity）</h4>
<p>一个Skill最好只做一件事，且把这件事做好。例如，将"查询客户记录"和"更新客户状态"分离，而不是合并为一个模糊的"管理数据"技能。</p>
<h4 data-id="heading-26">（2）描述即Prompt（Description is Prompt）</h4>
<p>LLM是通过阅读描述来选择工具的。因此，描述必须清晰、鲁棒，包含边缘情况说明（例如："如果是模糊查询，请先调用搜索工具"）。</p>
<h4 data-id="heading-27">（3）容错性设计（Error Handling）</h4>
<p>Skill的输出不仅要给用户看，更要给Agent看。如果API调用失败，Skill应该返回清晰的错误信息（如{"error": "City not found"}），而不是抛出异常崩溃。这样Agent可以自我纠正："抱歉，找不到该城市，您是指……"</p>
<h4 data-id="heading-28">（4）最少上下文原则</h4>
<p>Skill的返回结果应尽量精简。如果一个查询返回了5MB的JSON数据，可能会撑爆LLM的上下文窗口。Skill内部应预处理数据，只返回Agent决策所需的关键字段。</p>
<h2 data-id="heading-29">五、Agent Skills的应用场景与案例</h2>
<h3 data-id="heading-30">5.1 企业级应用场景</h3>
<h4 data-id="heading-31">（1）金融风控</h4>
<p>金融风控Agent同时分析财报、行情图和新闻情绪，快速发现风险信号。通过决策规划技能，Agent可以自动筛选高风险案例优先处理，实现资源高效配置。</p>
<h4 data-id="heading-32">（2）智能客服</h4>
<p>智能客服Agent理解用户情绪，自动查知识库、开工单，大幅缩短等待时间。头部电商平台的智能客服在促销高峰期独立解决85%售后请求，客户满意度提升15%。</p>
<h4 data-id="heading-33">（3）办公自动化</h4>
<p>从会议排期到跨部门审批，全程无人值守跑流程。跨国物流公司部署具备路线规划与仓储机器人控制的Agent Skills后，配送延误率下降42%，人力成本节省约28%。</p>
<h4 data-id="heading-34">（4）科研加速</h4>
<p>批量阅读文献、设计方案、监控实验设备，省下大量人力。科研辅助Agent可以生成化学模拟代码，或编写部署脚本，加速科研进程。</p>
<h3 data-id="heading-35">5.2 个人用户场景</h3>
<p>对于个人用户而言，Agent Skills可以帮助我们将繁琐的"操作员"变成指挥千军万马的"指挥官"。例如：</p>
<ul>
<li><strong>数据分析</strong>：使用具备Code Interpreter技能的Agent，直接把后台导出的脱敏CSV文件丢给它，说："帮我分析上周流失率最高的Top 3渠道，并分析这部分用户的行为共性。请写一段Python代码来计算，并画一个热力图对比上个月的数据。"</li>
<li><strong>文档处理</strong>：上传PDF文件，让Agent提取文本和表格，填写表单，合并文档。</li>
<li><strong>内容创作</strong>：让Agent根据你的主题生成PPT大纲，再将结构化的大纲和数据转化为PPT。</li>
</ul>
<h2 data-id="heading-36">六、Agent Skills的管理与工具</h2>
<p>随着Agent Skills生态的发展，越来越多的工具和平台涌现出来，帮助开发者和企业管理、部署和共享技能。</p>
<h3 data-id="heading-37">6.1 Prompt Minder：专业的Agent Skills管理平台</h3>
<p>在众多的Agent Skills管理工具中，Prompt Minder以其专业的功能和用户友好的界面脱颖而出。它的设计哲学可以概括为"Github for Prompts"，就像GitHub管理代码一样，Prompt Minder管理提示词的生命周期。</p>
<h4 data-id="heading-38">核心功能：</h4>
<ul>
<li><strong>智能分类管理</strong>：通过标签、项目等多种方式组织提示词，快速检索所需内容。</li>
<li><strong>版本控制</strong>：记录每次修改历史，随时回溯查看或还原之前的版本。</li>
<li><strong>团队协作</strong>：支持多人协作，细粒度的权限控制，实时同步更新。</li>
<li><strong>AI模型支持</strong>：支持任何兼容OpenAI接口模型，提供实时测试环境。</li>
<li><strong>数据安全</strong>：企业级数据加密，可选择私有部署方案。</li>
<li><strong>提示词优化</strong>：提供提示词优化服务，一键生成高质量提示词。</li>
</ul>
<h4 data-id="heading-39">为什么选择Prompt Minder？</h4>
<ol>
<li><strong>开源与私有部署</strong>：充分满足企业对数据隐私与定制化的需求。</li>
<li><strong>智能分类与检索</strong>：支持标签、项目维度组织Prompt，快速检索。</li>
<li><strong>细粒度版本控制</strong>：每次修改均有详细历史记录，可一键回溯。</li>
<li><strong>团队协作与权限</strong>：角色划分明确，协作高效且安全。</li>
<li><strong>模型兼容性</strong>：兼容OpenAI、Anthropic等主流接口模型，集成实时测试环境。</li>
<li><strong>企业级加密</strong>：数据传输与存储均在加密保护之下。</li>
<li><strong>Prompt优化助手</strong>：一键生成与智能推荐，提高Prompt质量。</li>
</ol>
<p>如果你正在寻找一个专业、可靠的Agent Skills管理平台，Prompt Minder无疑是最佳选择。立即访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prompt-minder.com%2F" target="_blank" title="https://www.prompt-minder.com/" ref="nofollow noopener noreferrer">www.prompt-minder.com/</a>，开启你的AI提示词管理之旅！</p>
<h3 data-id="heading-40">6.2 SkillsLM：跨平台技能安装工具</h3>
<p>SkillsLM是一个Node.js CLI工具，核心功能是跨平台安装Agent Skills。它试图成为AI Agent时代的npm，一键打通9大主流平台的技能管理。</p>
<h4 data-id="heading-41">核心功能：</h4>
<ul>
<li><strong>跨平台支持</strong>：支持Claude Code、Cursor、Codex、OpenCode、AMP、KiloCode、Roo、Goose、Gemini等9个主流平台。</li>
<li><strong>灵活安装方式</strong>：支持项目级安装和全局安装，避免污染home目录。</li>
<li><strong>多来源支持</strong>：默认技能来源指向anthropics/skills，也支持任意GitHub仓库地址。</li>
<li><strong>批量安装</strong>：支持从仓库批量安装多个技能，适合团队标准化玩法。</li>
</ul>
<h2 data-id="heading-42">七、Agent Skills的未来趋势</h2>
<h3 data-id="heading-43">7.1 标准化与互操作性</h3>
<p>随着MCP（Model Context Protocol）的普及，企业应用厂商预计在2026年将有30%推出官方的MCP Server，这意味着任何支持MCP的智能体都可以无缝接入这些企业系统，无需定制开发。</p>
<h3 data-id="heading-44">7.2 技能经济与市场生态</h3>
<p>Agent Skills正在形成一种新的经济形态——技能经济（Skill Economy）。未来，我们可能会看到：</p>
<ul>
<li><strong>技能商店</strong>：类似于应用商店，用户可以浏览、下载和购买各种Agent Skills。</li>
<li><strong>技能交易平台</strong>：领域专家可以把自己的独门方法封装成Skill，出售躺着赚钱。</li>
<li><strong>企业技能库</strong>：企业团队可以共享SOP，新人直接复用，熟练员工的能力，培训成本直接降为0。</li>
</ul>
<h3 data-id="heading-45">7.3 多Agent协作网络</h3>
<p>未来的AI应用将不再是单一Agent的天下，而是多Agent协作的网络。通过A2A（Agent-to-Agent）协议，不同的Agent可以互相发任务、协作、分工，共同完成复杂的任务。</p>
<h3 data-id="heading-46">7.4 自主学习与进化</h3>
<p>未来的Agent将不再局限于开发者预设的工具。它们将具备：</p>
<ul>
<li><strong>编写工具的能力</strong>：Agent发现自己解决不了问题，现场写一段Python代码作为新工具。</li>
<li><strong>检索工具的能力</strong>：从拥有成千上万个API的工具库中，动态检索出当前需要的工具（RAG for Tools）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从DEM到等高线：手撕矢量与栅格两种地形表达]]></title>    <link>https://juejin.cn/post/7598025242041434164</link>    <guid>https://juejin.cn/post/7598025242041434164</guid>    <pubDate>2026-01-22T13:22:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598025242041434164" data-draft-id="7597987896693588003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从DEM到等高线：手撕矢量与栅格两种地形表达"/> <meta itemprop="keywords" content="GIS"/> <meta itemprop="datePublished" content="2026-01-22T13:22:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从DEM到等高线：手撕矢量与栅格两种地形表达
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:22:31.000Z" title="Thu Jan 22 2026 13:22:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文节选自新书<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">《GIS基础原理与技术实践》</a>第6章。很多人会用 gdal_contour 一键生成等高线，但你知道它背后是如何通过三角网或格网 DEM 计算交线的吗？本文带你从零实现矢量等高线提取与栅格分层设色图生成，真正理解地形表达的本质。</p>
</blockquote>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/f44c40c956184dccb4eeea51691cc784~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=7G6veSHL%2B7ztu1hc6DTCjCXLPmo%3D" alt="GIS基础原理与技术实践" loading="lazy"/></p>
<h2 data-id="heading-0">6.6 等高线地形图</h2>
<p>地形的表达除了前文介绍的基于栅格形式的格网DEM和基于矢量形式的不规则三角网DEM之外，还有一种表达方式：等高线地形图，简称等高线图。等高线图的历史非常悠久，是一种非常经典的地形表达方式，在高中地理中就有详细的介绍和考察（有趣的是在国内的课程设置中，高中地理属于文科，本科的地理信息系统却属于理科，相信在进入大学后才接触到等高线图的人不止笔者一个）。</p>
<h3 data-id="heading-1">6.6.1 等高线图的基础理解</h3>
<p>所谓等高线，就是把地面上海拔高度相等的点相连，垂直投影到水平面上，并按照一定的比例缩放绘制到图纸所得到的闭合曲线。如果我们按照一定高度差（等高距），从低到高依次绘制等高线，就得到了一张等高线图。如下图6.15所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/49788e7690344f53bda2d4bab80226a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=FXuPWzevwl17K0f0Lqaa%2Bo69URQ%3D" alt="图6.15 等高线图" loading="lazy"/></p>
<p>等高线图虽然有不易识别的特点，但是其最大的优点就在于通过较少的信息量，就能够轻易识别出多种地形地貌，从而帮助我们做出地理空间相关的决策。一些典型的地貌包括：</p>
<h4 data-id="heading-2">1. 陡坡和缓坡</h4>
<p>等高线密集的地方，坡度较陡，如图6.16（1）所示。而图6.16（2）所示的坡度较缓，因为其等高线较为稀疏，坡度较缓。如果我们进行爬山活动，应选择等高线稀疏的地方。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/2a3f24b32b6d49b8924def11e5f218d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174487&amp;x-orig-sign=NUr8u7Zti56rrmCSYRbz7OMUjyQ%3D" alt="图6.16 陡坡和缓坡" loading="lazy"/></p>
<h4 data-id="heading-3">2. 山头和洼地</h4>
<p>下图6.17中等高线（a）表示山头，等高线（b）为表示洼地，它们投影到平面上都是简单的闭合多边形曲线。两者的区别在于山头的内圈高程大于外圈，而洼地则相反。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8b17e5049700484f9ee15fba79016ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=lAVXdk%2BigCpqvDoU3diMy1YBLnM%3D" alt="图6.17 山头和洼地" loading="lazy"/></p>
<h4 data-id="heading-4">3. 山脊、山谷和鞍部</h4>
<p>山脊位于等高线弯曲的地方，其高程值沿着凸向从高到底，如下图6.18（a）所示。山谷则相反，等高线弯曲处从高程值低往高程值高的地方凸出，如下图6.18（b）所示。山脊弯曲处相连的线被称为山脊线，附近雨水在降落到这条线上时会分别流向山脊的两侧，因此山脊线被称为分水线。山谷弯曲处相连的线被称为山谷线，雨水会从两侧上坡流向谷底，容易发育河流，因此山谷线被称为集水线。分水线、集水线是土木工程中需要重点关注的问题。</p>
<p>鞍部是位于两个山头之间呈马鞍形的低凹部位，如下图6.18所示。鞍部是修建山区道路的关节点，可以考虑在鞍部修建越岭道路。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/be5b996bf6294bc98a1966ba86d58cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=3T2G6tbkmbAPNOlUFKME3ClrUMQ%3D" alt="图6.18 山脊、山谷和鞍部" loading="lazy"/></p>
<h4 data-id="heading-5">4. 绝壁和悬崖</h4>
<p>绝壁是坡度在70°以上的陡峭崖壁，此时多条等高线的一部分会重叠，将这部分用锯齿状的符号表示绝壁，如下图6.19（a）所示。悬崖是上部突出，下部凹进的绝壁，这种地貌的等高线出现相交。这时隐蔽的等高线用虚线表示，如下图6.19（c）所示。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/f6974a310b62457f9fc92545107f542c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=4OxRlUWQLE9PeYCSkdsnN75oF24%3D" alt="图6.19 绝壁和悬崖" loading="lazy"/></p>
<p>等高线图的另一个特点的是其并不完全是定性的，由于每一条等高线都会标注高程信息，很多情况下可以进行大致定量运算，比如估算等高线图中两个点的相对高差、坡度等。所以等高线图确实是一种非常简洁有力的地形表达，应用非常广泛。</p>
<h3 data-id="heading-6">6.6.2 等高线地形图矢量形式</h3>
<p>正如图6.16~图6.19所示，最为简洁的等高线图是基于要素特征的，是由一组闭合的曲线组成的。因此不难想象，为了从DEM中生成矢量形式的等高线地形图，关键在于使用DEM的空间要素进行立体几何计算。其实在GDAL自带的工具中已经有提取等高线图的工具，但是正如前面笔者所说，结果并不重要，重要的是其中的原理。这里笔者自己的实现如下例6.10所示。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">//例6.10 生成等高线图的矢量形式</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ogrsf_frmts.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Eigen/Eigen&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> Eigen;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TrigonVertexIndex</span> {
  <span class="hljs-type">size_t</span> index[<span class="hljs-number">3</span>];
};

<span class="hljs-type">double</span> startHeight = <span class="hljs-number">550</span>;
<span class="hljs-type">double</span> endHeight = <span class="hljs-number">2815</span>;
<span class="hljs-type">double</span> heightInterval = <span class="hljs-number">500</span>;

<span class="hljs-type">size_t</span> nV;                                       <span class="hljs-comment">//点的个数</span>
std::vector&lt;Vector3d&gt; vertexXyz;                 <span class="hljs-comment">//点集</span>
<span class="hljs-type">size_t</span> nF;                                       <span class="hljs-comment">//面的个数.</span>
std::vector&lt;TrigonVertexIndex&gt; faceVertexIndex;  <span class="hljs-comment">//面在点集中的序号</span>

<span class="hljs-comment">//根据空截断字符串</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ChopStringWithSpace</span><span class="hljs-params">(string line, vector&lt;string&gt;&amp; substring)</span> </span>{
  <span class="hljs-function">std::stringstream <span class="hljs-title">linestream</span><span class="hljs-params">(line)</span></span>;
  string sub;

  <span class="hljs-keyword">while</span> (linestream &gt;&gt; sub) {
    substring.<span class="hljs-built_in">push_back</span>(sub);
  }
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ReadTin</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* szModelPath)</span> </span>{
  <span class="hljs-function">ifstream <span class="hljs-title">infile</span><span class="hljs-params">(szModelPath, ios::binary)</span></span>;
  <span class="hljs-keyword">if</span> (!infile) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't Load %s\n"</span>, szModelPath);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  string line;
  <span class="hljs-keyword">while</span> (line != <span class="hljs-built_in">string</span>(<span class="hljs-string">"end_header"</span>)) {
    <span class="hljs-built_in">getline</span>(infile, line);
    vector&lt;string&gt; substring;
    <span class="hljs-built_in">ChopStringWithSpace</span>(line, substring);

    <span class="hljs-keyword">if</span> (substring.<span class="hljs-built_in">size</span>() == <span class="hljs-number">3</span> &amp;&amp; substring[<span class="hljs-number">0</span>] == <span class="hljs-string">"element"</span>) {
      <span class="hljs-keyword">if</span> (substring[<span class="hljs-number">1</span>] == <span class="hljs-string">"vertex"</span>) {
        nV = <span class="hljs-built_in">stoul</span>(substring[<span class="hljs-number">2</span>]);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (substring[<span class="hljs-number">1</span>] == <span class="hljs-string">"face"</span>) {
        nF = <span class="hljs-built_in">stoul</span>(substring[<span class="hljs-number">2</span>]);
      }
    }
  }

  vertexXyz.<span class="hljs-built_in">resize</span>(nV);
  vertexXyz.<span class="hljs-built_in">shrink_to_fit</span>();

  <span class="hljs-type">uint8_t</span> propertyNum = <span class="hljs-number">3</span>;
  <span class="hljs-type">double</span>* vertexTmp = <span class="hljs-keyword">new</span> <span class="hljs-type">double</span>[propertyNum * nV];
  infile.<span class="hljs-built_in">read</span>((<span class="hljs-type">char</span>*)(vertexTmp),
              <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int64_t</span>&gt;(propertyNum * nV * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>)));
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nV; i++) {
    vertexXyz[i].<span class="hljs-built_in">x</span>() = vertexTmp[i * propertyNum];
    vertexXyz[i].<span class="hljs-built_in">y</span>() = vertexTmp[i * propertyNum + <span class="hljs-number">1</span>];
    vertexXyz[i].<span class="hljs-built_in">z</span>() = vertexTmp[i * propertyNum + <span class="hljs-number">2</span>];
  }

  <span class="hljs-keyword">delete</span>[] vertexTmp;
  vertexTmp = <span class="hljs-literal">nullptr</span>;

  faceVertexIndex.<span class="hljs-built_in">resize</span>(nF);
  faceVertexIndex.<span class="hljs-built_in">shrink_to_fit</span>();

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nF; i++) {
    <span class="hljs-type">uint8_t</span> type;
    infile.<span class="hljs-built_in">read</span>((<span class="hljs-type">char</span>*)(&amp;type), <span class="hljs-number">1</span>);

    <span class="hljs-keyword">if</span> (type != <span class="hljs-number">3</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Format Incompatible Or Non Trigon!\n"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; type; j++) {
      <span class="hljs-type">int</span> id;
      infile.<span class="hljs-built_in">read</span>((<span class="hljs-type">char</span>*)(&amp;id), <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>));
      faceVertexIndex[i].index[j] = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(id);
    }
  }

  infile.<span class="hljs-built_in">close</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">//判断几种可能的相交情况</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">CalTriangleType</span><span class="hljs-params">(TrigonVertexIndex trigonVID,
                    std::vector&lt;<span class="hljs-type">bool</span>&gt;&amp; vertexFlag)</span> </span>{
  <span class="hljs-type">bool</span> triVertexFlag[<span class="hljs-number">3</span>] = {<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>};
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> vi = <span class="hljs-number">0</span>; vi &lt; <span class="hljs-number">3</span>; vi++) {
    <span class="hljs-type">size_t</span> vid = trigonVID.index[vi];
    triVertexFlag[vi] = vertexFlag[vid];
  }

  <span class="hljs-type">int</span> type = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (!triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">1</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">2</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">3</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">4</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">5</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">6</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (triVertexFlag[<span class="hljs-number">0</span>] &amp;&amp; !triVertexFlag[<span class="hljs-number">1</span>] &amp;&amp; triVertexFlag[<span class="hljs-number">2</span>]) {
    type = <span class="hljs-number">7</span>;
  }

  <span class="hljs-keyword">return</span> type;
}

<span class="hljs-comment">//计算空间线段已知Z值的点的坐标</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CalPointOfSegmentLineWithZ</span><span class="hljs-params">(Vector3d O, Vector3d E, <span class="hljs-type">double</span> z, Vector3d&amp; P)</span> </span>{
  <span class="hljs-keyword">if</span> (E.<span class="hljs-built_in">z</span>() &lt; O.<span class="hljs-built_in">z</span>()) {
    Vector3d tmp = O;
    O = E;
    E = tmp;
  }

  <span class="hljs-type">double</span> t = (z - O.<span class="hljs-built_in">z</span>()) / (E.<span class="hljs-built_in">z</span>() - O.<span class="hljs-built_in">z</span>());
  <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">0</span> &amp;&amp; t &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  Vector3d D = E - O;
  P = O + D * t;

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">//计算空间中三角形与直线相交</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CalTriangleIntersectingLine</span><span class="hljs-params">(TrigonVertexIndex trigonVID, <span class="hljs-type">int</span> cornerId,
                                 Vector3d&amp; start, Vector3d&amp; end, <span class="hljs-type">double</span> z)</span> </span>{
  <span class="hljs-function">vector&lt;Vector3d&gt; <span class="hljs-title">xyzList</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> vi = <span class="hljs-number">0</span>; vi &lt; <span class="hljs-number">3</span>; vi++) {
    <span class="hljs-type">size_t</span> vid = trigonVID.index[vi];
    xyzList[vi] = vertexXyz[vid];
  }

  <span class="hljs-keyword">if</span> (cornerId == <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">0</span>], xyzList[<span class="hljs-number">1</span>], z, start);
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">0</span>], xyzList[<span class="hljs-number">2</span>], z, end);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cornerId == <span class="hljs-number">1</span>) {
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">1</span>], xyzList[<span class="hljs-number">0</span>], z, start);
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">1</span>], xyzList[<span class="hljs-number">2</span>], z, end);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cornerId == <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">2</span>], xyzList[<span class="hljs-number">1</span>], z, start);
    <span class="hljs-built_in">CalPointOfSegmentLineWithZ</span>(xyzList[<span class="hljs-number">2</span>], xyzList[<span class="hljs-number">0</span>], z, end);
  }
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CalIsoHeightLine</span><span class="hljs-params">(TrigonVertexIndex trigonVID, <span class="hljs-type">int</span> type, Vector3d&amp; start,Vector3d&amp; end, <span class="hljs-type">double</span> height)</span> </span>{
  <span class="hljs-type">bool</span> flag = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: {
      <span class="hljs-built_in">CalTriangleIntersectingLine</span>(trigonVID, <span class="hljs-number">2</span>, start, end, height);
      flag = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: {
      <span class="hljs-built_in">CalTriangleIntersectingLine</span>(trigonVID, <span class="hljs-number">0</span>, start, end, height);
      flag = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: {
      <span class="hljs-built_in">CalTriangleIntersectingLine</span>(trigonVID, <span class="hljs-number">1</span>, start, end, height);
      flag = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">return</span> flag;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">// GDAL所有操作都需要先注册格式</span>

  vector&lt;<span class="hljs-type">double</span>&gt; heightThresholdList;
  {
    <span class="hljs-type">double</span> heightThreshold = startHeight;
    <span class="hljs-keyword">while</span> (heightThreshold &lt; endHeight) {
      heightThresholdList.<span class="hljs-built_in">push_back</span>(heightThreshold);
      heightThreshold = heightThreshold + heightInterval;
    }
  }

  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string outShpFile = workDir + <span class="hljs-string">"/../Data/Terrain/dst.shp"</span>;

  string tinPath = workDir + <span class="hljs-string">"/../Data/Terrain/terrain.ply"</span>;
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadTin</span>(tinPath.<span class="hljs-built_in">c_str</span>())) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">//创建</span>
  GDALDriver* driver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"ESRI Shapefile"</span>);
  <span class="hljs-keyword">if</span> (!driver) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Get Driver ESRI Shapefile Error！\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  GDALDataset* dataset =
      driver-&gt;<span class="hljs-built_in">Create</span>(outShpFile.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, GDT_Unknown, <span class="hljs-literal">nullptr</span>);
  OGRLayer* poLayer = dataset-&gt;<span class="hljs-built_in">CreateLayer</span>(<span class="hljs-string">"IsoHeightline"</span>, <span class="hljs-literal">nullptr</span>,
                                           wkbMultiLineStringZM, <span class="hljs-literal">nullptr</span>);

  OGRFeature* poFeature = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OGRFeature</span>(poLayer-&gt;<span class="hljs-built_in">GetLayerDefn</span>());
  OGRMultiLineString multiLineString;

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; heightThresholdList.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-type">double</span> heightThreshold = heightThresholdList[i];

    <span class="hljs-function">std::vector&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-title">vertexFlag</span><span class="hljs-params">(vertexXyz.size(), <span class="hljs-literal">false</span>)</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; vertexXyz.<span class="hljs-built_in">size</span>(); i++) {
      <span class="hljs-keyword">if</span> (vertexXyz[i].<span class="hljs-built_in">z</span>() &gt;= heightThreshold) {
        vertexFlag[i] = <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> fi = <span class="hljs-number">0</span>; fi &lt; faceVertexIndex.<span class="hljs-built_in">size</span>(); fi++) {
      <span class="hljs-type">int</span> type = <span class="hljs-built_in">CalTriangleType</span>(faceVertexIndex[fi], vertexFlag);

      Vector3d start;
      Vector3d end;
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CalIsoHeightLine</span>(faceVertexIndex[fi], type, start, end,
                           heightThreshold)) {
        OGRLinearRing ogrring;
        ogrring.<span class="hljs-built_in">setPoint</span>(<span class="hljs-number">0</span>, start.<span class="hljs-built_in">x</span>(), start.<span class="hljs-built_in">y</span>(), start.<span class="hljs-built_in">z</span>());
        ogrring.<span class="hljs-built_in">setPoint</span>(<span class="hljs-number">1</span>, end.<span class="hljs-built_in">x</span>(), end.<span class="hljs-built_in">y</span>(), end.<span class="hljs-built_in">z</span>());
        multiLineString.<span class="hljs-built_in">addGeometry</span>(&amp;ogrring);
      }
    }
  }

  poFeature-&gt;<span class="hljs-built_in">SetGeometry</span>(&amp;multiLineString);
  <span class="hljs-keyword">if</span> (poLayer-&gt;<span class="hljs-built_in">CreateFeature</span>(poFeature) != OGRERR_NONE) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to create feature in shapefile.\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">//释放</span>
  <span class="hljs-built_in">GDALClose</span>(dataset);
  dataset = <span class="hljs-literal">nullptr</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>在本例中笔者使用的DEM是不规则三角网形式的DEM，不过如果使用规则格网也差不多，都需要先获取一组立体空间三角形。要获取等高线，我们可以设想某一固定的高程面与这一组立体空间三角形相交，那么必然可以得到相交的线段，这个线段也就是等高线上的线段。</p>
<p>某一固定的高程面与这一组立体空间三角形相交的算法也不是使用计算几何算法硬算，其实原理非常简单，如果高程面与立体空间三角形相交，那么空间三角形就会有一个角或者两个角在高程面上方。换句话说，高程面与立体空间三角形相交，比如有一个角在高程面上方，或者在高程面下方。只要求取这个角，就可以获取到两条相交的三角形边。最后，求两个相交的三角形边上固定高程的点，将两点相连就是等高线上的线段。</p>
<p>其实上述原理也体现了笔者在前面的论述，DEM其实只是个2.5维的数据，这里确实也没有用到真正意义上的三维立体空间运算，而是很快根据高度值做出高程面与立体空间三角形相交的判定。这种降维的思想在GIS中是非常有用的，我们应该充分利用它。最后得到的结果如下图6.20所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/d90e8bad31384ceabab78213d7f414d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174487&amp;x-orig-sign=YX43VjM%2FVON2eje2NYx%2BH2J%2FzL0%3D" alt="图6.20 根据DEM生成等高线图" loading="lazy"/></p>
<h3 data-id="heading-7">6.6.3 等高线地形图栅格形式</h3>
<p>等高线地形图的矢量形式虽然比较简洁，但是确实不够直观。我们可以仿照热力图的表达，将其栅格化，并根据不同的高度区间赋予不同的颜色，就得到了分层设色的等高线地形图。这种栅格形式的等高线地形图更为直接美观，我们可以很容易根据颜色区分那些地区属于平原、丘陵、盆地、高原或者山地，也方便直接输出图纸。</p>
<p>一个思路是将例6.10所得到的结果栅格化，不过这并不是最佳的方案。由于格网DEM数据本身就是栅格化的，我们可以直接在格网DEM上生成分层设色等高线地形图，如下例6.11所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">//例6.11 生成等高线图的栅格形式</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;array&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">using</span> F_RGB = std::array&lt;<span class="hljs-type">double</span>, <span class="hljs-number">3</span>&gt;;

<span class="hljs-type">int</span> demWidth;
<span class="hljs-type">int</span> demHeight;

<span class="hljs-type">double</span> geoTransform[<span class="hljs-number">6</span>] = {<span class="hljs-number">0</span>};
<span class="hljs-type">double</span> startX;  <span class="hljs-comment">//左上角点坐标X</span>
<span class="hljs-type">double</span> dx;      <span class="hljs-comment">// X方向的分辨率</span>
<span class="hljs-type">double</span> startY;  <span class="hljs-comment">//左上角点坐标Y</span>
<span class="hljs-type">double</span> dy;      <span class="hljs-comment">// Y方向的分辨率</span>

vector&lt;<span class="hljs-type">float</span>&gt; demBuf;

<span class="hljs-type">int</span> dstBandNum = <span class="hljs-number">4</span>;
vector&lt;<span class="hljs-type">uint8_t</span>&gt; dstBuf;

<span class="hljs-type">double</span> startHeight = <span class="hljs-number">550</span>;
<span class="hljs-type">double</span> endHeight = <span class="hljs-number">2815</span>;
<span class="hljs-type">double</span> heightInterval = <span class="hljs-number">500</span>;

<span class="hljs-function">vector&lt;F_RGB&gt; <span class="hljs-title">tableRGB</span><span class="hljs-params">(<span class="hljs-number">256</span>)</span></span>;         <span class="hljs-comment">//颜色映射表</span>
vector&lt;<span class="hljs-type">double</span>&gt; heightThresholdList;  <span class="hljs-comment">//高度区间</span>
vector&lt;F_RGB&gt; heightRGBList;         <span class="hljs-comment">//高度区间对应的颜色</span>

<span class="hljs-comment">//生成渐变色</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Gradient</span><span class="hljs-params">(F_RGB &amp;start, F_RGB &amp;end, vector&lt;F_RGB&gt; &amp;RGBList)</span> </span>{
  F_RGB d;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    d[i] = (end[i] - start[i]) / RGBList.<span class="hljs-built_in">size</span>();
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; RGBList.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) {
      RGBList[i][j] = start[j] + d[j] * i;
    }
  }
}

<span class="hljs-comment">//初始化颜色查找表</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitColorTable</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-function">F_RGB <span class="hljs-title">blue</span><span class="hljs-params">({<span class="hljs-number">17</span>, <span class="hljs-number">60</span>, <span class="hljs-number">235</span>})</span></span>;   <span class="hljs-comment">//蓝色</span>
  <span class="hljs-function">F_RGB <span class="hljs-title">green</span><span class="hljs-params">({<span class="hljs-number">17</span>, <span class="hljs-number">235</span>, <span class="hljs-number">86</span>})</span></span>;  <span class="hljs-comment">//绿色</span>
  <span class="hljs-function">vector&lt;F_RGB&gt; <span class="hljs-title">RGBList</span><span class="hljs-params">(<span class="hljs-number">60</span>)</span></span>;
  <span class="hljs-built_in">Gradient</span>(blue, green, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">yellow</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">173</span>, <span class="hljs-number">17</span>})</span></span>;  <span class="hljs-comment">//黄色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">60</span>);
  <span class="hljs-built_in">Gradient</span>(green, yellow, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i + <span class="hljs-number">60</span>] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">red</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">60</span>, <span class="hljs-number">17</span>})</span></span>;  <span class="hljs-comment">//红色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">60</span>);
  <span class="hljs-built_in">Gradient</span>(yellow, red, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i + <span class="hljs-number">120</span>] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">white</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">17</span>, <span class="hljs-number">235</span>})</span></span>;  <span class="hljs-comment">//紫色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">76</span>);
  <span class="hljs-built_in">Gradient</span>(red, white, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">76</span>; i++) {
    tableRGB[i + <span class="hljs-number">180</span>] = RGBList[i];
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReadDem</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Terrain/dem.tif"</span>;

  GDALDataset *dem = (GDALDataset *)<span class="hljs-built_in">GDALOpen</span>(demPath.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!dem) {
    cout &lt;&lt; <span class="hljs-string">"Can't Open Image!"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span>;
  }

  demWidth = dem-&gt;<span class="hljs-built_in">GetRasterXSize</span>();
  demHeight = dem-&gt;<span class="hljs-built_in">GetRasterYSize</span>();

  dem-&gt;<span class="hljs-built_in">GetGeoTransform</span>(geoTransform);
  startX = geoTransform[<span class="hljs-number">0</span>];  <span class="hljs-comment">//左上角点坐标X</span>
  dx = geoTransform[<span class="hljs-number">1</span>];      <span class="hljs-comment">// X方向的分辨率</span>
  startY = geoTransform[<span class="hljs-number">3</span>];  <span class="hljs-comment">//左上角点坐标Y</span>
  dy = geoTransform[<span class="hljs-number">5</span>];      <span class="hljs-comment">// Y方向的分辨率</span>

  <span class="hljs-comment">// noValue = dem-&gt;GetRasterBand(1)-&gt;GetNoDataValue();</span>

  <span class="hljs-type">size_t</span> demBufNum = (<span class="hljs-type">size_t</span>)demWidth * demHeight;
  demBuf.<span class="hljs-built_in">resize</span>(demBufNum, <span class="hljs-number">0</span>);

  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>);
  dem-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">RasterIO</span>(GF_Read, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, demWidth, demHeight,
                                  demBuf.<span class="hljs-built_in">data</span>(), demWidth, demHeight,
                                  GDT_Float32, depth, demWidth * depth);

  <span class="hljs-built_in">GDALClose</span>(dem);
  dem = <span class="hljs-literal">nullptr</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">HandleDem</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-type">size_t</span> dstBufNum = (<span class="hljs-type">size_t</span>)demWidth * demHeight * dstBandNum;
  dstBuf.<span class="hljs-built_in">resize</span>(dstBufNum, <span class="hljs-number">255</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; heightThresholdList.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-type">double</span> heightThreshold = heightThresholdList[i];
    F_RGB thresholdRgb = heightRGBList[i];

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; demHeight; yi++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; demWidth; xi++) {
        <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)demWidth * yi + xi;

        <span class="hljs-keyword">if</span> (demBuf[m] &gt; heightThreshold) {
          <span class="hljs-type">size_t</span> n = (<span class="hljs-type">size_t</span>)demWidth * dstBandNum * yi + dstBandNum * xi;
          <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> bi = <span class="hljs-number">0</span>; bi &lt; <span class="hljs-number">3</span>; bi++) {
            dstBuf[n + bi] = (<span class="hljs-type">uint8_t</span>)thresholdRgb[bi];
          }
        }
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WriteDst</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Terrain/dst.tif"</span>;

  GDALDriver *pDriver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GTIFF"</span>);  <span class="hljs-comment">//图像驱动</span>
  <span class="hljs-type">char</span> **ppszOptions = <span class="hljs-literal">NULL</span>;
  ppszOptions =
      <span class="hljs-built_in">CSLSetNameValue</span>(ppszOptions, <span class="hljs-string">"BIGTIFF"</span>, <span class="hljs-string">"IF_NEEDED"</span>);  <span class="hljs-comment">//配置图像信息</span>
  GDALDataset *dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(demPath.<span class="hljs-built_in">c_str</span>(), demWidth, demHeight, <span class="hljs-number">4</span>,
                                     GDT_Byte, ppszOptions);
  <span class="hljs-keyword">if</span> (!dst) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't Write Image!"</span>);
    <span class="hljs-keyword">return</span>;
  }

  dst-&gt;<span class="hljs-built_in">SetGeoTransform</span>(geoTransform);

  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint8_t</span>);
  dst-&gt;<span class="hljs-built_in">RasterIO</span>(GF_Write, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, demWidth, demHeight, dstBuf.<span class="hljs-built_in">data</span>(), demWidth,
                demHeight, GDT_Byte, dstBandNum, <span class="hljs-literal">nullptr</span>, dstBandNum * depth,
                demWidth * dstBandNum * depth, depth);

  <span class="hljs-built_in">GDALClose</span>(dst);
  dst = <span class="hljs-literal">nullptr</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">// GDAL所有操作都需要先注册格式</span>

  <span class="hljs-comment">//设置Proj数据</span>
  std::string projDataPath = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  projDataPath += <span class="hljs-string">"/share/proj"</span>;
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"PROJ_LIB"</span>, projDataPath.<span class="hljs-built_in">c_str</span>());

  <span class="hljs-built_in">ReadDem</span>();

  <span class="hljs-built_in">InitColorTable</span>();

  <span class="hljs-type">double</span> heightThreshold = startHeight;
  <span class="hljs-keyword">while</span> (heightThreshold &lt; endHeight) {
    heightThresholdList.<span class="hljs-built_in">push_back</span>(heightThreshold);
    heightThreshold = heightThreshold + heightInterval;
  }

  <span class="hljs-keyword">if</span> (heightThresholdList.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>) {
    heightRGBList.<span class="hljs-built_in">push_back</span>(tableRGB[<span class="hljs-number">0</span>]);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-type">size_t</span> step = tableRGB.<span class="hljs-built_in">size</span>() / (heightThresholdList.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>);
    <span class="hljs-type">size_t</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; heightThresholdList.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
      heightRGBList.<span class="hljs-built_in">push_back</span>(tableRGB[index]);
      index = index + step;
    }
    heightRGBList.<span class="hljs-built_in">push_back</span>(tableRGB[tableRGB.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>]);
  }

  <span class="hljs-built_in">HandleDem</span>();

  <span class="hljs-built_in">WriteDst</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>与基于矢量要素的几何运算不同，基于栅格的运算更多的是基于图像处理的思想。我们并不知道每一条具体的等高线在哪里，但是我们可以向栅格中插值。具体来说，就是如果该栅格所代表的点的高程大于高程区间的临界值，那么就向其填充合适的颜色；按照高程区间格式填充多次，直到所有高程区间都填充完成。这样，等高线就由不同的颜色区间体现出来了。最终生成的等高线图如下图6.21所示。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/1ac74b886f7f4c07b153d22c0c4d606d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769174486&amp;x-orig-sign=2WRUHs%2FXp9r78vftMoZv8bd%2BQt8%3D" alt="图6.21 根据DEM生成等高线图" loading="lazy"/></p>
<h2 data-id="heading-8">结语</h2>
<p>在本章中，我们详细论述了一种综合了矢量特性与栅格特性的地理空间数据——地形。因此，如果我们前面对矢量和栅格掌握的比较熟练，掌握地形相关的知识也不是太难。此外，我们还介绍了一些地形数据的基本处理方法，地形内插算法，晕渲图与等高线图的制作。其实地形相关的知识非常之丰富，远不是本章有限的内容所能涵盖的。而且，地形数据有其数据敏感性，普通从业者想获取高精度的数据进行深入研究也十分不易。不过还是那句话，示例的结果不重要，重要的是要了解其底层的原理，建立一个相对系统而全面的认知，在遇到更为复杂的难题时才能心中不慌。</p>
<hr/>
<p>本文节选自作者新书《GIS基础原理与技术实践》第6章。书中系统讲解 GIS 核心理论与多语言实战，适合开发者与高校师生。</p>
<p>📚 <strong>配套资源开源</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffafa1899%2FGISBasic" target="_blank" title="https://github.com/fafa1899/GISBasic" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fcharlee44%2FGISBasic" target="_blank" title="https://gitcode.com/charlee44/GISBasic" ref="nofollow noopener noreferrer">GitCode</a></p>
<p>🛒 <strong>支持正版</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">京东</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fproduct.dangdang.com%2F29988568.html" target="_blank" title="https://product.dangdang.com/29988568.html" ref="nofollow noopener noreferrer">当当</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的多犬种（60种常见犬类）智能识别系统项目 [目标检测完整源码]]]></title>    <link>https://juejin.cn/post/7597989474992422950</link>    <guid>https://juejin.cn/post/7597989474992422950</guid>    <pubDate>2026-01-22T13:25:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474992422950" data-draft-id="7597808104463597614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的多犬种（60种常见犬类）智能识别系统项目 [目标检测完整源码]"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T13:25:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的多犬种（60种常见犬类）智能识别系统项目 [目标检测完整源码]
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:25:40.000Z" title="Thu Jan 22 2026 13:25:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的多犬种（60种常见犬类）智能识别系统项目 [目标检测完整源码]</h2>
<h3 data-id="heading-1">—— 面向 60 类常见犬种的目标检测与可视化应用落地</h3>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6af1872390941969d4f6c30338df3fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=h0gF0F7RsVyDyZKdIw1%2BoqXhpMU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">一、背景与问题：为什么“犬种识别”值得工程化？</h3>
<p>在宠物经济高速发展的今天，犬类已经从“家庭陪伴动物”逐步演变为需要<strong>精细化管理与智能化服务</strong>的对象。在实际场景中，犬种信息直接影响：</p>
<ul>
<li>饲养与行为管理策略</li>
<li>疫苗接种与健康风险评估</li>
<li>宠物交易、领养与救助流程</li>
<li>城市宠物管理与公共安全</li>
</ul>
<p>然而，现实中对犬种的识别依然高度依赖人工经验，不仅主观性强，而且在混血犬、幼犬、复杂光照条件下误判率较高。</p>
<p><strong>问题的本质在于：</strong></p>
<blockquote>
<p>如何构建一个既具备高识别精度，又真正“可落地使用”的犬种识别系统？</p>
</blockquote>
<p>本项目正是围绕这一问题，给出了一套<strong>完整可复现的工程级解决方案</strong>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a2b89f4a194b06bbbac2088d5c4589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=xcjkBxHPHgZcmc1Yn3G5NHlj25M%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方观看：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1wB8MzsE9P%2F" target="_blank" title="https://www.bilibili.com/video/BV1wB8MzsE9P/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1wB…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98dc6a48e0345e4980d5f144015b55f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=B2PmOU%2BuRN89FksaYrbqY7xrN6A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<hr/>
<h3 data-id="heading-4">二、系统整体架构设计</h3>
<p>该项目并非单一模型 Demo，而是一个<strong>从数据、训练到部署的完整闭环系统</strong>，整体架构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌────────────┐
│  数据集层  │  犬类图像 + YOLO 标注
└─────┬──────┘
<span class="hljs-code">      ↓
┌────────────┐
│  模型训练  │  YOLOv8 Detection
└─────┬──────┘
      ↓
┌────────────┐
│  推理服务  │  图片 / 视频 / 摄像头
└─────┬──────┘
      ↓
┌────────────┐
│  GUI 应用  │  PyQt5 桌面端
└────────────┘
</span></code></pre>
<p>核心目标只有一个：
<strong>让“深度学习模型”真正变成“普通用户能用的软件”。</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c49133e2d1f24b168dfc3d76c26efc49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=T482LIMczW5GCzZVyjTxe5kZYCM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/493128a7a2fc403da8219ea15efd48fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=KFLLDxY9CJeWvbaT5oSr%2FH91PAk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">三、模型选型：为什么是 YOLOv8？</h3>
<p>在多类别实时检测任务中，YOLO 系列一直是工程实践的主流方案。本项目最终选择 YOLOv8，主要基于以下考虑：</p>
<h4 data-id="heading-6">3.1 架构层面的优势</h4>
<ul>
<li><strong>Anchor-Free 设计</strong>
减少超参数依赖，收敛更稳定</li>
<li><strong>Task-Aligned Assigner</strong>
分类与定位目标一致性更强</li>
<li><strong>更轻量的 Backbone 与 Neck</strong>
在保证精度的同时提升推理速度</li>
</ul>
<h4 data-id="heading-7">3.2 工程友好性</h4>
<ul>
<li>原生支持 <strong>PyTorch / ONNX</strong></li>
<li>Ultralytics 提供统一 CLI 与 Python API</li>
<li>训练、验证、推理接口高度一致</li>
</ul>
<p>这使得模型不仅“好训”，而且<strong>非常适合与 GUI、业务系统结合</strong>。</p>
<hr/>
<h3 data-id="heading-8">四、犬种数据集构建与标注规范</h3>
<h4 data-id="heading-9">4.1 数据规模与类别</h4>
<p>本系统覆盖 <strong>60 种常见犬类</strong>，包括但不限于：</p>
<ul>
<li>柯基、哈士奇、柴犬</li>
<li>金毛、拉布拉多、贵宾犬</li>
<li>德牧、边牧、博美等</li>
</ul>
<p>每个类别均包含多姿态、多背景、多尺度样本，尽量贴近真实使用场景。</p>
<hr/>
<h4 data-id="heading-10">4.2 数据组织结构（YOLO 标准）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
├── labels/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
</code></pre>
<p>标签文件采用 YOLO 标准格式：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">class_id</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">x_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">y_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">width</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">height</span>&gt;</span>
</code></pre>
<p>所有坐标均为 <strong>相对比例值</strong>，确保模型在不同分辨率下具备一致性。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d4d4061d2648cd99899a3f55319afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=VOfCAuHWNftN%2FU%2BgD2oxYwsKYDA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">五、模型训练流程详解</h3>
<h4 data-id="heading-12">5.1 训练配置示例</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
  data=dog.yaml \
  model=yolov8n.pt \
  epochs=100 \
  batch=16 \
  imgsz=640
</code></pre>
<p>关键训练策略包括：</p>
<ul>
<li>合理的 batch size 控制显存占用</li>
<li>数据增强（翻转、尺度变换、颜色扰动）</li>
<li>早期收敛阶段重点关注 box_loss 与 cls_loss</li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c977c47e8cc14783879ed84756023e49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=KAhIoGc1Un2ZQvkDI68DT1eDYs0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-13">5.2 训练过程监控</h4>
<p>YOLOv8 在 <code>runs/detect/train/</code> 目录中自动生成：</p>
<ul>
<li>损失函数变化曲线</li>
<li>mAP@0.5 / mAP@0.5:0.95</li>
<li>混淆矩阵（类别间区分能力）</li>
</ul>
<p>在实际实验中，多数犬种在 <strong>mAP@0.5 指标上稳定超过 90%</strong>，具备实际应用价值。</p>
<hr/>
<h3 data-id="heading-14">六、多模态推理能力设计</h3>
<p>本系统支持多种输入形式，统一由同一推理接口处理。</p>
<h4 data-id="heading-15">6.1 单张图片与批量图片</h4>
<ul>
<li>支持文件与文件夹级别输入</li>
<li>自动生成标注结果图</li>
<li>适合数据复查与分析场景</li>
</ul>
<hr/>
<h4 data-id="heading-16">6.2 视频与实时摄像头</h4>
<ul>
<li>基于 OpenCV 逐帧推理</li>
<li>支持实时显示检测结果</li>
<li>可选保存输出视频文件</li>
</ul>
<p>这一能力使系统能够直接应用于：</p>
<ul>
<li>宠物门店实时监控</li>
<li>救助站视频巡检</li>
<li>展示型 AI 应用演示</li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91b08d055b8a4bfbb0a32bf317129881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=1Xkj0vlzQA0w7advmMqhZ0cNIzA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-17">七、PyQt5 图形界面设计要点</h3>
<p>为了降低使用门槛，项目引入 PyQt5 构建完整桌面应用。</p>
<h4 data-id="heading-18">7.1 界面功能划分</h4>
<ul>
<li><strong>输入控制区</strong>：选择图片 / 视频 / 摄像头</li>
<li><strong>结果展示区</strong>：实时显示检测画面</li>
<li><strong>日志与状态区</strong>：输出模型运行信息</li>
</ul>
<h4 data-id="heading-19">7.2 工程价值</h4>
<ul>
<li>无需命令行操作</li>
<li>非算法人员也可直接使用</li>
<li>适合作为课程设计、毕业设计、项目演示系统</li>
</ul>
<hr/>
<h3 data-id="heading-20">八、推理代码核心示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> results[<span class="hljs-number">0</span>].boxes:
    cls_id = <span class="hljs-built_in">int</span>(box.cls)
    score = <span class="hljs-built_in">float</span>(box.conf)
</code></pre>
<p>推理结果中可直接获取：</p>
<ul>
<li>类别 ID</li>
<li>置信度</li>
<li>边框坐标</li>
</ul>
<p>便于后续对接业务逻辑或二次开发。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc91dd7ba1aa47f9b754889bae4a28f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693140&amp;x-signature=JH7WJiONLJQjnbnZTVCyqRzdGWg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-21">九、项目工程化与“开箱即用”</h3>
<p>本项目已完成<strong>完整工程封装</strong>，具备以下特点：</p>
<ul>
<li>已训练完成的权重文件</li>
<li>完整源码与数据集</li>
<li>一键启动 GUI 程序</li>
<li>提供训练与部署说明</li>
</ul>
<p>运行检测仅需：</p>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>无需重新训练，即可体验完整系统功能。</p>
<hr/>
<h3 data-id="heading-22">十、可扩展性与二次开发方向</h3>
<p>该项目并不局限于犬种识别，其工程框架可直接扩展为：</p>
<ul>
<li>🐱 猫咪品种识别</li>
<li>🐦 鸟类 / 野生动物监测</li>
<li>🐄 畜牧养殖视觉分析</li>
<li>🏙️ 智慧城市动物管理系统</li>
</ul>
<p><strong>本质上，这是一个可复用的 YOLOv8 + GUI 工程模板。</strong></p>
<hr/>
<h3 data-id="heading-23">总结：一个真正“能用”的目标检测项目应该是什么样？</h3>
<p>相比单纯展示模型精度，本项目更关注：</p>
<ul>
<li>是否具备完整工程链路</li>
<li>是否方便非算法人员使用</li>
<li>是否具备二次开发潜力</li>
</ul>
<p>通过 YOLOv8 与 PyQt5 的深度结合，该系统成功实现了从算法到应用的跨越。</p>
<blockquote>
<p>🚀 <strong>如果你正在寻找一个具备训练、检测、部署一体化能力的目标检测项目实践，这套基于 YOLOv8 的多犬种识别系统，值得你深入研究与复用。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谱写Kotlin协程面试进行曲-进阶篇(第一乐章)]]></title>    <link>https://juejin.cn/post/7598021313870364678</link>    <guid>https://juejin.cn/post/7598021313870364678</guid>    <pubDate>2026-01-22T13:36:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021313870364678" data-draft-id="7598025242041401396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谱写Kotlin协程面试进行曲-进阶篇(第一乐章)"/> <meta itemprop="keywords" content="面试,Kotlin"/> <meta itemprop="datePublished" content="2026-01-22T13:36:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RainyJiang"/> <meta itemprop="url" content="https://juejin.cn/user/2287404300943566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谱写Kotlin协程面试进行曲-进阶篇(第一乐章)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2287404300943566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RainyJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:36:34.000Z" title="Thu Jan 22 2026 13:36:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:18px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:40px;margin-bottom:20px;color:#007fff;display:flex;align-items:center}.markdown-body h1:hover:before,.markdown-body h2:hover:before,.markdown-body h3:hover:before,.markdown-body h4:hover:before,.markdown-body h5:hover:before,.markdown-body h6:hover:before{transition:All .4s ease-in-out;transform:rotate(1turn)}.markdown-body h1{font-size:30px;background:linear-gradient(#fff 60%,#c6e3ff 0)}.markdown-body h1:before{content:"";display:inline-block;width:32px;height:32px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h2{font-size:24px;background:linear-gradient(#fff 60%,#cce3fb 0)}.markdown-body h2:before{content:"";display:inline-block;width:24px;height:24px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3{font-size:20px}.markdown-body h3:before{content:"";display:inline-block;width:18px;height:18px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h4{font-size:18px}.markdown-body h4:before{content:"";display:inline-block;width:16px;height:16px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h5{font-size:16px}.markdown-body h5:before{content:"";display:inline-block;width:15px;height:15px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h6{font-size:14px}.markdown-body h6:before{content:"";display:inline-block;width:12px;height:12px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{border-bottom:2px solid #007fff;color:#007fff;padding-right:10px}.markdown-body p{letter-spacing:1px;line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:10px auto}.markdown-body hr{border:none;border-top:1px dashed #92c8ff}.markdown-body hr:before{content:"✂";display:inline-block;position:relative;top:-12px;left:40px;padding:0 3px;color:#007fff;font-size:18px}.markdown-body hr:after{content:"按虚线剪开";position:relative;top:-15px;left:84%;padding:0 3px;color:#007fff;font-size:12px}.markdown-body del{color:#f44}.markdown-body em{color:#007fff;margin:0 2px}.markdown-body strong{color:#007fff;font-weight:bolder}.markdown-body code{word-break:break-word;border-radius:4px;overflow-x:auto;background-color:#e6f3ff;color:#007fff;font-weight:600;font-size:16px;padding:.065em .4em;border:1px solid #007fff}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:5px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:18px;font-weight:400;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8;border:none}.markdown-body a{text-decoration:none;color:#007fff;border-bottom:1px solid #007fff}.markdown-body a:before{content:"¶";margin-right:5px;font-size:22px}.markdown-body a:after{content:"↷";margin-left:2px;font-size:22px;display:none}.markdown-body a:active,.markdown-body a:hover{color:#275b8c;border-bottom:1px solid #275b8c}.markdown-body a:active:after,.markdown-body a:hover:after{display:inline-block}.markdown-body table{display:inline-block!important;font-size:16px;width:auto;max-width:100%;overflow:auto;border:1px solid #a5d3ff}.markdown-body thead{background:#c6e3ff;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#eef7ff}.markdown-body tbody&gt;tr:nth-child(odd){background-color:#f8fcff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #007fff;background-color:#eef7ff}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#007fff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h3 data-id="heading-0">前言</h3>
<p>时光飞逝，距离上次整理<em>Kotlin</em>面试题，一晃两年过去了，恍恍惚惚，已经隔世。这期间，依旧能看到不少同学阅读、收藏笔者之前整理的<em>Kotlin</em>面试题目，能够帮到大家还是挺开心的，授人以鱼不如授人以渔。转眼又快要进入金三银四了，不少人(当然包括笔者)也开始考虑换个环境，重新投入到面试准备中。已经2026年了，随着协程在实际项目中的广泛使用，面试中对<em>Kotlin</em>协程的考察也在不断升级——从最初的 API 使用，逐渐深入到运行机制、调度模型，以及异常与取消等边界问题。</p>
<p>很多时候，这些问题本身并不算多复杂，但一旦被追问“为什么”，答案就容易变得模糊。如今市场早已不缺能熟练调用<em>API</em>的初中级工程师了，再加上 AI 的兴起，现在越发成熟，甚至于日常工作都离不开AI的帮助，可想而知技术门槛又被进一步抬高。生活不易，想要混口饭吃，把基础打牢的同时，还得兼顾当下技术的浪潮，避免一问三不知。所谓知其然，更要知其所以然。</p>
<p>因此，笔者在原有内容的基础上，结合这段时间的实践经验，并参考现阶段网络资料与 AI 的整理，又梳理了 <strong>三十多道 Kotlin 协程进阶问题。</strong> 由于整体篇幅解答起来实在太过冗长，所以分为了几个篇幅。这些问题尽量覆盖了面试中高频出现、却又容易被忽略的关键点，希望通过问题本身，帮助自己，也帮助大家，在协程相关的考察中，真正做到心中有数。</p>
<p>以下是笔者的Kotlin面试指南系列：</p>
<ul>
<li><a href="https://juejin.cn/post/7213582722329952312" target="_blank" title="https://juejin.cn/post/7213582722329952312">谱写Kotlin面试指南三部曲-基础篇</a></li>
<li><a href="https://juejin.cn/post/7220235452292137019" target="_blank" title="https://juejin.cn/post/7220235452292137019">谱写Kotlin面试指南三部曲-协程篇</a></li>
<li><a href="https://juejin.cn/post/7222982459583152188" target="_blank" title="https://juejin.cn/post/7222982459583152188">谱写Kotlin面试指南三部曲-Flow篇</a></li>
</ul>
<p>下面开始我们的第一篇章的几个问题</p>
<h3 data-id="heading-1">1. Kotlin 协程与线程的本质区别是什么？为什么说协程是“轻量级线程”？</h3>
<h4 data-id="heading-2">快问快答</h4>
<p>这是一个非常经典、也非常容易被“说模糊”的问题，这里笔者先给出结论</p>
<p><strong>线程是操作系统管理的执行单位，而协程是由Kotlin运行时程序管理的的可挂起计算单元，前者属于是内核态，后者是用户态</strong> 。协程并不等于线程，但它必须要跑在线程上面的，因为创建成本低、切换快、数量多，所以常常被戏称为”轻量级线程“</p>
<p>下面我们来分层详细补充下这个结论</p>
<h4 data-id="heading-3">线程的本质：操作系统的”打工人“</h4>
<p>线程是操作系统级别的最小单位，由操作系统内核创建和管理，真正参与到CPU调度，可以简单理解为：<strong>线程=操作系统派给CPU的“天命打工人"</strong></p>
<p>一个线程中至少包含：</p>
<ul>
<li>独立的调用栈（Stack）</li>
<li>程序计数器</li>
<li>寄存器上下文</li>
<li>内核态调度信息</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16be41ea2ce3457e8830582069c0223c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=b%2FQBA0xjsZ6D49jflMAhUO%2BXY%2Bo%3D" alt="协程进阶.png" loading="lazy"/></p>
<p>可以看到，创建一个新的线程，但是付出的代价相对是有点大，如下表所示</p>





















<table><thead><tr><th>创建成本</th><th>高（分配栈内存，通常是MB级别的）</th></tr></thead><tbody><tr><td><strong>切换成本</strong></td><td><strong>高（用户态 ↔ 内核态切换）</strong></td></tr><tr><td><strong>数量</strong></td><td><strong>存在上限（几百-几千不等）</strong></td></tr><tr><td><strong>阻塞</strong></td><td><strong>IO/sleep会阻塞整个线程</strong></td></tr></tbody></table>
<p>一旦该线程发生了阻塞了，CPU就无法再利用它做别的事情了。</p>
<h4 data-id="heading-4">协程的本质：可挂起的”任务脚本“</h4>
<p>对于协程来说，它不属于操作系统的概念了，而是<em>Kotlin</em>语言层面的东西。拿官方的话术来说，<strong>协程是一段可以被挂起（suspend）并在之后恢复（resume）的代码</strong> 。不同于线程，协程属于用户态，由<strong><em>Kotlin</em>编译器+<em>kotlinx.coroutines</em>库实现</strong>，OS并不知道协程的存在的。</p>
<p>就拿最简单的，我们启动一个协程，然后在里面做某些事情</p>
<pre><code class="hljs language-scss" lang="scss">launch {
    val data = <span class="hljs-built_in">fetchData</span>()
    <span class="hljs-built_in">showData</span>(data)
}
</code></pre>
<p>表面上是同步的写法，但实际上：</p>
<ul>
<li><em>fetchData</em>函数方法可以被挂起</li>
<li>在这个线程中可以同时执行的别的协程</li>
<li>等IO完成后回来再继续执行</li>
</ul>
<p>值得注意的是，虽然我们常常把协程和线程进行比较，但要记住协程不是脱离线程运行的，它是一定要运行在线程之中的。当然，一个线程中可以存在多个协程的，每个协程的执行时间由用户端决定分配， <strong>线程负责“真正跑”，协程负责“切换和挂起逻辑”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f95bc4fa545b44ebaf7a6960b9f3279c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=7D189AbUnktfTafoyqTv8HqvAdA%3D" alt="e7a992c9a5866ba484354d5682d6464b.png" loading="lazy"/></p>
<h4 data-id="heading-5">为啥说协程是”轻量级线程“？</h4>
<p>这个问题相信各位同学都不陌生了，为了方便大家理解，才有了这个形象说法，可以说协程之所以”轻量“，因为它不由操作系统管理，不需要独立线程栈，切换发生在用户态，只保存极少的状态。</p>
<p>不够形象？首先我们明确一个点，在计算机里什么东西才叫”重“？通常体现在三点：1. 创建成本高 2. 内存占用大 3.切换代价高</p>
<p>好家伙，这三点线程全给占了，协程的出现刚好弥补了这些，我们从两方面说明下</p>
<ul>
<li>
<p>从使用体验上来看，很像线程</p>
<pre><code class="hljs language-scss" lang="scss">scope<span class="hljs-selector-class">.launch</span> {
    <span class="hljs-built_in">doWork</span>()
}
</code></pre>
<p>这个写法上非常像线程，它可以在里面并发执行，可以切换上写文，可以取消，等待等等</p>
</li>
<li>
<p>从实现成本上看，极其轻量</p>
<p>我们可以在一个线程中创建成百上千个协程，它的成本相对来说是比较低的</p>



































<table><thead><tr><th>对比项</th><th>线程</th><th>协程</th></tr></thead><tbody><tr><td>管理者</td><td>操作系统</td><td><em>Kotlin</em>程序运行时</td></tr><tr><td>内存占用</td><td>MB 级</td><td>KB 级</td></tr><tr><td>创建数量</td><td>少</td><td>非常多</td></tr><tr><td>切换方式</td><td>内核态</td><td>用户态</td></tr><tr><td>切换成本</td><td>高</td><td>极低</td></tr></tbody></table>
</li>
</ul>
<p>因为协程的创建、切换和销毁成本都非常低，一个线程可以承载成千上万个协程，“轻”的不是功能，而是成本。此外由于协程调度发生在用户态，因此可以用更少的线程处理更多任务，这也是为什么说协程是“轻量级线程”了。</p>
<h3 data-id="heading-6">2. <em>Kotlin</em>协程是 <em>stackless</em> 还是 <em>stackful</em>，这种设计有什么影响？</h3>
<h4 data-id="heading-7">快问快答</h4>
<p><strong><em>Kotlin</em>协程是典型的 "无栈协程"</strong> 实现。这意味着：<strong>它本身不拥有自己的调用栈结构，而是通过编译器生成的状态机 + <em>Continuation</em> 保存程序状态。</strong> 不过值得思考的是，在底层<em>JVM</em>层面，调用普通函数同样会用<em>JVM</em>栈，但这<strong>并不改变<em>Kotlin</em>协程本质总体来说是 <em>stackless</em></strong>。</p>
<p>此外，如果严格来说的话，<strong>Kotlin 协程是 stackless coroutine + JVM 原生栈配合的混合模型实现</strong>。但是协程的暂停和恢复不靠真实挂载的栈帧，而靠状态机与<em>Continuation</em>。</p>
<p>在这种设计下，协程并不保存真实的调用栈，而是由 <strong>编译器把 <em>suspend</em> 挂起函数改写成状态机</strong>， <strong>在挂起点把必要状态封装进 <em>Continuation</em>对象存到堆上</strong>，恢复时再由调度器把它重新放回线程执行。这样以来的话</p>
<ul>
<li>内存占用低，可以创建百万级别协程，对高并发特别友好</li>
<li>不会阻塞线程，但调用栈不会跨<em>suspend</em>点存在</li>
</ul>
<p>好的，那么下面我们来详细拆解下这个问题</p>
<h4 data-id="heading-8">什么是<em>Stackless</em>和<em>Stackful</em>？</h4>
<p>首先我们要明确一点的是，一般协程分为了两种，<strong>有栈协程</strong>和<strong>无栈协程</strong>，笔者分别解释下</p>
<h5 data-id="heading-9">有栈协程</h5>
<p>想象它像 <strong>真正的小线程</strong>，每个协程都有自己的执行栈（类似线程栈），可以在<strong>任意深度的调用中任意位置暂停（yield）</strong> 。</p>
<p>一些典型的例子像是某些<em>C/C++</em> 协程库 、<em>Go Coroutine</em>、<em>Lua coroutine</em>等。</p>
<ul>
<li>
<p>它的优点在于：</p>
<ul>
<li>可在任意调用层级暂停</li>
<li>能保存真实调用栈</li>
</ul>
</li>
<li>
<p>它的缺点在于：</p>
<ul>
<li>每个协程需要占用栈内存（开销大）</li>
<li>实现复杂度高</li>
</ul>
</li>
</ul>
<h5 data-id="heading-10">无栈协程（Stackless）</h5>
<p>它没有自己的栈空间，而是 <strong>由编译器转换成状态机 + Continuation</strong>，再在需要挂起的地方保存状态。典型例子像是<em>Kotlin</em>、<em>JavaScript async/await</em>、<em>C# async/await</em>、<em>C++20</em>协程一样。</p>
<ul>
<li>
<p>它的优点在于：</p>
<ul>
<li>非常轻量，不需要为每个协程分配真实栈</li>
<li>能支持成千上万协程同时存在</li>
<li>内存占用小</li>
</ul>
</li>
<li>
<p>它的缺点在于：</p>
<ul>
<li>只能在特定的<em>suspend</em>点（编译器知道的地方）才能挂起</li>
<li>挂起点之外无法"随意暂停"</li>
</ul>
</li>
</ul>
<p>怎么说呢，是不是有点抽象难以理解，下面我们来打个比喻，想象一下</p>
<p><strong>Stackful 协程就像一个电影拍摄团队</strong></p>
<ul>
<li>每个演员、工作人员都随身带着完整的道具和场景布置（对应完整栈）</li>
<li>无论拍摄到哪，都可以随时停下来继续上一秒的状态</li>
<li>停下来后，几乎可以立刻从任意一帧继续拍摄</li>
<li><strong>缺点</strong>：道具重、场景大，搬运成本高，随便暂停/切换成本大</li>
</ul>
<p><strong>Stackless 协程就像剧本排练演员</strong></p>
<ul>
<li>演员不带道具，只带一个剧本和记录表（对应保存的少量状态）</li>
<li>暂停时，只要记下当前排练到哪一页、哪一行即可</li>
<li>轻量、容易随时切换任务</li>
<li><strong>限制</strong>：只能在明确的“剧本节点”停下来（检查点）</li>
</ul>
<h4 data-id="heading-11">Kotlin 协程为啥是<em>Stackless</em>？为啥不能是<em>Stackful</em>呢？</h4>
<p>我们上面简单了解了下有栈协程和无栈协程的区别，那有同学就会有疑问了，为啥<em>Kotlin</em>协程说是<em>StackLess</em>的，而不能是<em>Stackful</em>的呢？</p>
<p>请允许我从Kotlin协程的核心机制开始说起，众所周知，<em>Kotlin</em>协程编译后不是传统递归，而是把每个 <em>suspend fun</em> 和其调用点改写成 <strong>连续状态的状态机（<em>state machine</em>）</strong> 。当碰到挂起点（<em>suspend）</em> 的时候，它不会真的把整个调用栈存起来，反而只存需要的变量状态和 <strong><em>Continuation</em>对象</strong>，其中<em>Continuation</em>简单来说就是一个携带状态的对象，用来"标记我们要恢复执行的位置和数据"。</p>
<p>那么也就是说：</p>
<ul>
<li><strong>所谓挂起</strong> = 状态保存到<em>heap</em></li>
<li><strong>所谓恢复</strong> = 从<em>heap</em>按状态机器继续执行下去</li>
</ul>
<p>这就是所谓无栈协程<em>stackless</em>的定义：<strong>没有用真正的栈用来保存执行状态</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef448556f67b41e3868469fb9cbe2843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=LxC6HGVTUSyZuvPfhsQzJYKa4X0%3D" alt="协程状态机编译.png" loading="lazy"/></p>
<p>另外，为啥不能是<em>Stackful</em>呢？原因在于<em>Kotlin</em>还是基于<em>JVM</em>的，要实现真正的 stackful coroutine 其实是不太可能的，原因如下：</p>
<ul>
<li><em>JVM</em>虚拟机是不直接暴露切换栈的机制</li>
<li>真实栈切换需要改变执行栈位置，这在<em>JVM bytecode</em>里面是很难做到的 。</li>
</ul>
<p>所以<em>Kotlin</em>想了个聪明办法：制造状态机 + <em>Continuation</em>，这样无需修改<em>JVM</em>，也能实现挂起/恢复。</p>
<h4 data-id="heading-12">那么这种设计有什么影响？</h4>
<h5 data-id="heading-13">属于是超轻协程</h5>
<p>因为不需要实际栈，所以：</p>
<ul>
<li>在有限的内存中可以创建中成千上百个协程，不会有过重的消耗</li>
<li>内存占用比线程低 10 至 100 倍</li>
<li>创建/销毁速度非常快，这对高并发特别友好</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8c37c9e1d04ab7ab88a23e381b6cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=hEBBIiBlhMznasV0sQdLIP32t%2BU%3D" alt="超轻协程.png" loading="lazy"/></p>
<h5 data-id="heading-14">只能在挂起点挂起</h5>
<p>这属实是<em>stackless</em>协程最大的局限了：</p>
<ul>
<li>不能随便在非 suspend 函数里暂停</li>
<li>suspend 函数调用链必须清晰</li>
<li>但是，编译器已经帮你生成好了状态机，所以你不用手写这些逻辑</li>
</ul>
<p>一句话：要挂起，得走 <em><strong>suspend 或 async</strong></em> 的门</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1ae6de2af844880bbc53ba23fbb78d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=PNqcvJCobEalckq0Kge4Th1TrOc%3D" alt="suspend调用规则.png" loading="lazy"/></p>
<h5 data-id="heading-15">写起来更像"同步代码"</h5>
<p>虽然是异步执行，但写起来就像同步一样</p>
<pre><code class="hljs language-kotlin" lang="kotlin">scope.launch {
    <span class="hljs-keyword">val</span> res = networkCall()
    println(res)
}
​
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">networkCall</span><span class="hljs-params">()</span></span> {
    ...
}
</code></pre>
<p>这一点相对来说，比回调地狱或复杂的线程池好使多了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73522e150dfa4fa199360223dc3a9be8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=r04VoCHeIu7%2FKMUiL4eFWuf3p18%3D" alt="协程写法.png" loading="lazy"/></p>
<p>有趣的是，虽然<em>Kotlin</em>协程 <strong>本质<em>stackless</em></strong>，但在<em>suspend</em>之前函数调用仍然使用<em>JVM stack</em> , 这叫混合模型 —— <strong>状态机 + JVM 栈混合执行</strong>。 <strong>状态机负责存储挂起位置，而<em>JVM</em>栈负责函数内部的局部执行。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc96e5cc4324c979280b7c66cd21bf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=%2Bhm1ylJyKsOBBALyydvT6oI7CB4%3D" alt="混合执行模型.png" loading="lazy"/></p>
<p>就说到这了，现在用个表格简单总结下：</p>

























<table><thead><tr><th/><th/></tr></thead><tbody><tr><td>Kotlin 协程 stackless 还是 stackful？</td><td><strong><em>Stackless</em>（无栈）</strong> （混合模型）</td></tr><tr><td>怎么实现挂起？</td><td><strong><em>Continuation</em> + 状态机</strong></td></tr><tr><td>为什么不用 stackful？</td><td><strong>JVM 无栈切换支持 + 内存效率更好</strong></td></tr><tr><td>有什么影响？</td><td><strong>轻量、性能好、只能 suspend 点挂起</strong></td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d162c4be6bd4c9bbdfcf0b921d3e0f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=Lk%2FqJQxbzBSKQowX%2Figh8RkFdGk%3D" alt="AE95E35F-16A0-460F-A6A0-115EA6287EF8.png" loading="lazy"/></p>
<h3 data-id="heading-16">3. suspend 函数的底层实现原理是什么？它如何通过 Continuation 实现挂起与恢复？</h3>
<h4 data-id="heading-17">快问快答</h4>
<p>还是老规矩，笔者先将该问题总结下。</p>
<p><em>suspend</em>函数本质实现原理主要是，编译器把它改写成「带 <em>Continuation</em>参数的普通函数 + 状态机」，它在挂起时保存执行状态并返回 <em>COROUTINE_SUSPENDED</em>，恢复时通过 <em>Continuation.resumeWith()</em> 从上次挂起点继续执行，在这个期间不阻塞线程。</p>
<p>下面笔者来详细展开说说</p>
<h4 data-id="heading-18">什么是 <em>suspend</em>函数？</h4>
<p>这里先用一句话简单说明下，<em>suspend</em>函数就是可以“<strong>暂停</strong>自己执行，然后等合适的时候再<strong>唤醒</strong>继续执行的特殊函数。”</p>
<p>啥意思呢，它和普通函数有什么区别呢？</p>
<ul>
<li>普通函数调用是 <strong>同步阻塞</strong> → 执行完才返回结果；</li>
<li>而<em>suspend</em>函数想做的是 <strong>“不阻塞主线程的异步逻辑写成同步风格”</strong> 。</li>
</ul>
<p>是不是比较抽象，下面笔者打个比方把，比如说我们点外卖</p>
<ul>
<li>普通函数 → 你就默默地等在门口（当然现实中很少这种），看着外卖小哥路上走了半小时 → 等到送到了再继续吃饭，中间不会去干任何事情</li>
<li>suspend 函数 → 你先去打游戏 或者去干些别的事情，外卖到了小哥喊一声你回来取 → 继续吃饭，美滋滋</li>
</ul>
<blockquote>
<p>值得注意的是挂起函数<strong>不是</strong>新的线程，它只是把当前执行状态 “保存起来”，到点再恢复。</p>
</blockquote>
<h4 data-id="heading-19"><em>suspend</em>的底层核心秘密武器：<em>Continuation</em></h4>
<p>经过剖析，我们知道<em>suspend</em>函数的底层其实 <strong>被编译成带 Continuation 参数的普通函数</strong></p>
<h5 data-id="heading-20">编译后的情况</h5>
<p>我们像这样写一个挂起函数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> { … }
</code></pre>
<p>经过编译后，编译器帮我们变成如下函数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">(continuation: <span class="hljs-type">Continuation</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span>: Any?
</code></pre>
<p>发现了没？这里的返回值不是 <code>Int</code>，而是 <strong><code>Any?</code></strong> ，因为它可能返回两种情况，如下表所示</p>

















<table><thead><tr><th>情况</th><th>返回值</th></tr></thead><tbody><tr><td>正常立即完成</td><td><code>int</code>（装箱成 Any）</td></tr><tr><td>挂起中</td><td>特殊标记 —— <code>COROUTINE_SUSPENDED</code></td></tr></tbody></table>
<h5 data-id="heading-21">那么<em>Continuation</em>到底是啥东东？</h5>
<p>我们把<em>Continuation</em>理解成一个 <strong>“执行状态的存钱罐 + 回复回调”</strong> 。下面结合源码来简单看下</p>
<p>可以看到，它内部有两个重要东西：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Continuation</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">val</span> context: CoroutineContext
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeWith</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>
}
</code></pre>
<p>我们可以想象<em>Continuation</em>像下图这样</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/874e4d7566924323b503a693a5fab321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=RhLmqfw3KvQmRZuue8EEzBAdv3w%3D" alt="Continuation.png" loading="lazy"/></p>
<h4 data-id="heading-22">那么<em>suspend</em> 具体如何运作的呢？</h4>
<p>下面我们还是用一个简单例子来模拟它的执行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span>: String {
    println(<span class="hljs-string">"start"</span>)
    <span class="hljs-keyword">val</span> result = fetchFromNetwork()   <span class="hljs-comment">// 假装这个是挂起点</span>
    println(<span class="hljs-string">"got <span class="hljs-variable">$result</span>"</span>)
    <span class="hljs-keyword">return</span> result
}
</code></pre>
<p>底层被编译成类似以下这样的代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">(continuation: <span class="hljs-type">Continuation</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>: Any? {
    println(<span class="hljs-string">"start"</span>)
​
    <span class="hljs-keyword">val</span> r = fetchFromNetwork(<span class="hljs-keyword">object</span> : Continuation&lt;String&gt; {
         <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeWith</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
             <span class="hljs-comment">// 网络返回时回来执行</span>
         }
    })
​
    <span class="hljs-keyword">if</span> (r == COROUTINE_SUSPENDED) <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED
​
    println(<span class="hljs-string">"got <span class="hljs-variable">$r</span>"</span>)
    <span class="hljs-keyword">return</span> r
}
</code></pre>
<p>具体的流程图所下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94af87ad5d5643d5ac1d6983333b85b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=sWIzf8cD2UHdSuBARYwSAZcszuk%3D" alt="suspend执行流程.png" loading="lazy"/></p>
<p>整体流程已经非常清晰明了了，此外，我们再思考下，为什么挂起后不阻塞线程？</p>
<p>因为编译器在遇到挂起点时会<strong>把当前栈帧展开成状态机</strong>，每个挂起点变成“<strong>状态编号</strong>”，类似这样子：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">state</span> = <span class="hljs-number">0</span>  // start
...
<span class="hljs-attr">state</span> = <span class="hljs-number">1</span>  // next
...
</code></pre>
<p>于是乎，函数不会真正阻塞线程，只会 <strong>保存状态，返回 COROUTINE_SUSPENDED</strong>，线程继续做别的。等到异步结果回来后，调用<em>Continuation.resume</em> ，然后再继续执行后面的状态！</p>
<p>其次就是它的关键魔法：状态机转换，可以看到编译后的状态机看起来大概像这样，具体的后面问题会详细说明的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">(cont: <span class="hljs-type">Continuation</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>: Any {
    <span class="hljs-keyword">when</span> (cont.label) {
        <span class="hljs-number">0</span> -&gt; {
            println(<span class="hljs-string">"start"</span>)
            cont.label = <span class="hljs-number">1</span>
            <span class="hljs-keyword">val</span> tmp = fetchFromNetwork(cont)
            <span class="hljs-keyword">if</span> (tmp == COROUTINE_SUSPENDED) <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED
        }
        <span class="hljs-number">1</span> -&gt; {
            <span class="hljs-keyword">val</span> result = cont.result  <span class="hljs-comment">// 网络回来</span>
            println(<span class="hljs-string">"got <span class="hljs-variable">$result</span>"</span>)
            <span class="hljs-keyword">return</span> result
        }
    }
}
</code></pre>
<p>其中<em>Continuation</em>就是相当于“挂起 &amp; 复活的钥匙”，它做了三件事情，上文也提了一嘴，做了一个表格简单总结下：</p>





















<table><thead><tr><th>功能</th><th>解释</th></tr></thead><tbody><tr><td>保存现场</td><td>保存当前执行点 &amp; 局部变量</td></tr><tr><td>提供 resumeWith()</td><td>等异步完成后继续</td></tr><tr><td>持有 CoroutineContext</td><td>控制调度（主线程/IO/默认）</td></tr></tbody></table>
<p>下面我们简单总结下这个问题</p>
<ul>
<li><em>suspend</em>函数底层是<strong>编译成带 Continuation 的普通函数</strong></li>
<li>挂起本质上是：<strong>保存状态 &amp; 返回特殊标记</strong></li>
<li>恢复则由 <em>Continuation.resumeWith()</em> 继续执行状态机</li>
<li>执行过程中不会阻塞线程，是 <strong>协程轻量非阻塞</strong> 的核心</li>
</ul>
<h3 data-id="heading-23">4. 协程启动后真正执行挂起/恢复的流程（状态机如何工作）？</h3>
<h4 data-id="heading-24">快问快答</h4>
<p>这个问题相对来说真的有点复杂了，一时半会儿也没法详细展开说明，这里笔者只是将大致流程梳理一下，通过不断问问题的方式，让大家层层递进，另外具体详细的内容同学们可自行扩展。老样子，还是先上总结。</p>
<p>协程启动后，<em>suspend</em> 函数经过 CPS（<em>Continuation Passing Style</em>）转换，它被编译成一个状态机类， 每个挂起点等于一个 <em>label</em>，它真正的执行入口是 <em>invokeSuspend()</em> , 如果此时挂起了，那么返回 <em>COROUTINE_SUSPENDED</em>，如果恢复了会调用 <em>invokeSuspend()</em> 。</p>
<p>其实简单来说，协程启动后代码是不会一次性跑完的，而是通过 CPS 转换成状态机，由 invokeSuspend 驱动执行， 每次挂起和恢复本质都是状态机（<em>State Matchine</em>）的一次“跳转”。</p>
<p>下面笔者简单展开说说</p>
<h4 data-id="heading-25">协程从“启动”开始发生了什么？</h4>
<p>首先，我们从最常见最初的代码开始说起：</p>
<pre><code class="hljs language-scss" lang="scss">GlobalScope<span class="hljs-selector-class">.launch</span> {
    val data = <span class="hljs-built_in">loadData</span>()
    <span class="hljs-built_in">show</span>(data)
}
</code></pre>
<p>乍一看，这段代码很容易让人产生一种错觉：是不是<em>launch</em>一调用，代码就立刻开始执行，等跑完就结束了。</p>
<p>但真实发生的，其实完全不是这样的，<strong>协程的执行过程远比这看起来要“拐弯抹角”得多</strong>。</p>
<h5 data-id="heading-26"><em>launch</em>并不是直接执行你的代码</h5>
<p>它干的第一件事就是：<strong>创建了一个协程对象</strong>，更确切的来说，<em>launch</em>会创建一个实现了 <em>Continuation</em>的协程对象，用来承载后续整个协程的执行状态。</p>
<p>这个对象呢，可以理解为状态机的载体，或者说是之后挂起与恢复的核心对象，大概长这样（简化伪代码）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">XxxCoroutine</span>(
    completion: Continuation&lt;<span class="hljs-built_in">Unit</span>&gt;
) : SuspendLambda(completion) {
​
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeSuspend</span><span class="hljs-params">(result: <span class="hljs-type">Any</span>?)</span></span>: Any? {
        <span class="hljs-comment">// 状态机在这里</span>
    }
}
</code></pre>
<p>可以看到，我们<strong>具体的协程代码，全都被塞进了<em>invokeSuspend(）里面了</em></strong>。</p>
<h5 data-id="heading-27">为什么说 <em>invokeSuspend</em>是协程的“心脏”？</h5>
<p>看到网上有人这么说，<em>invokeSuspend</em> 是协程的“心脏”，这个说法其实非常形象，而且并不夸张。</p>
<p>我们只需要记住一句话就行：<strong><em>invokeSuspend()</em> 是协程真正执行业务逻辑的唯一入口。</strong></p>
<p>无论协程处于哪种阶段：</p>
<ul>
<li>第一次启动协程</li>
<li>在某个挂起点被恢复</li>
<li>甚至是异常恢复</li>
</ul>
<p>最终，都会回到 <em>invokeSuspend()</em> 方法中继续执行。</p>
<p>既然协程代码都跑在 <em>invokeSuspend()</em> 里，那么有同学就会问了，<strong>为什么代码可以在中途“暂停”，而不是一次性执行完？</strong></p>
<p>这就要引出协程中的<em>CPS（Continuation Passing Style）</em> 。</p>
<h4 data-id="heading-28"><em>CPS：Continuation Passing Style</em>到底干了啥？</h4>
<h5 data-id="heading-29">普通函数的执行方式</h5>
<p>我们先来看下普通函数是怎么执行的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> bar()
}
</code></pre>
<p>可以看到，普通函数依赖 <strong>返回值</strong> 把结果交给调用方，一旦函数开始执行，就必须一路跑到结束。</p>
<h5 data-id="heading-30">CPS核心思想</h5>
<p>我们同样写个伪代码看下</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">(continuation: <span class="hljs-type">Continuation</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
    bar { result -&gt;
        continuation.resume(result)
    }
}
</code></pre>
<p>由于源码相对较多，这里就不一一贴出来了，只要知道<em>CPS</em>核心思想就足够了，它不再通过 return 返回结果，而是把“下一步怎么执行”交给<em>Continuation</em>。</p>
<h5 data-id="heading-31"><em>suspend</em>函数里的<em>CPS</em>转换</h5>
<p>在 <em>suspend</em> 函数中，<em>CPS</em>主要干了两件事：</p>
<ul>
<li>给函数多加了一个 <em>Continuation</em>参数</li>
<li>把后续逻辑拆解出来，交给<em>Continuation</em>继续执行</li>
</ul>
<p>但问题也随之而来：<strong>一个<em>suspend</em>函数里可能有多个挂起点，恢复时，<em>Continuation</em>是怎么知道该从哪一行继续？</strong></p>
<p>答案呼之欲出：那就是状态机</p>
<h4 data-id="heading-32">状态机：协程“不死”的秘密</h4>
<p>接下来看一个最简单的<em>suspend</em>函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demo</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"A"</span>)
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"B"</span>)
}
</code></pre>
<p>但在编译器眼里，这一句不再是一个普通的挂起函数了，而是一个状态机类，编译器生成的伪代码如下所示</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoContinuation</span>(
    completion: Continuation&lt;<span class="hljs-built_in">Unit</span>&gt;
) : ContinuationImpl(completion) {
​
    <span class="hljs-keyword">var</span> label = <span class="hljs-number">0</span>
​
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeSuspend</span><span class="hljs-params">(result: <span class="hljs-type">Any</span>?)</span></span>: Any? {
        <span class="hljs-keyword">when</span> (label) {
            <span class="hljs-number">0</span> -&gt; {
                println(<span class="hljs-string">"A"</span>)
                label = <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> (delay(<span class="hljs-number">1000</span>, <span class="hljs-keyword">this</span>) == COROUTINE_SUSPENDED) {
                    <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED
                }
            }
            <span class="hljs-number">1</span> -&gt; {
                println(<span class="hljs-string">"B"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unit</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unit</span>
    }
}
​
</code></pre>
<p>这里的核心点只有两个</p>
<ul>
<li><em>label</em>:记录当前执行到哪一步</li>
<li><em>invokesuspend()</em> : 根据<em>label</em>标志决定执行哪一段逻辑</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a499d98cf6984958ba196789ea3b41ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=wIokKKCVFKBnQ9p%2Bx01AXhoE2K8%3D" alt="状态机.png" loading="lazy"/></p>
<p>到这里，协程已经具备了“记住执行位置”的能力。接下来，我们看看 <strong>挂起到底是在什么时候发生的</strong>。</p>
<h4 data-id="heading-33">真正的“挂起”是怎么发生的？</h4>
<p>首先，有一个必须先澄清的误区：<strong>挂起 ≠ 阻塞线程</strong>。 挂起发生时，线程并不会被卡住。</p>
<p>以最常用的<em>delay()</em> 为例子，我们来看下挂起的真实流程</p>
<ol start="0">
<li><em>invokeSuspend()</em> 执行到<em>delay</em></li>
<li><em>delay</em>注册一个定时器</li>
<li>返回 <em>COROUTINE_SUSPENDED</em></li>
<li><em>invokeSuspend()</em> 立刻结束</li>
<li>线程被释放，去干别的活</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f0ea1e2f5d4fa3b1eb7a9b824d400e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=VuBgCtNvFnchrc5tIi%2BS%2FczWaDI%3D" alt="协程delay流程.png" loading="lazy"/></p>
<p>所谓“挂起”，本质就是一次提前返回。就像协程老哥说：“我先暂停一下，你把我现在的状态记好，一会儿有人喊我，我再接着演。”</p>
<h4 data-id="heading-34">那“恢复”又是怎么发生的？</h4>
<p>既既然协程已经提前返回了，那它是怎么继续执行的？</p>
<p>还是以<em>delay</em>为例子，当我们异步任务完成的时候，也就是这个延时定时器到点后会调用</p>
<pre><code class="hljs language-kotlin" lang="kotlin">continuation.resume(<span class="hljs-built_in">Unit</span>)
</code></pre>
<p>接着我们来看看<em>resume</em>背后发生了什么事</p>
<ol start="0">
<li><em>resume()</em> → <em>resumeWith()</em></li>
<li>调用到原来的<em>Continuation</em></li>
<li>再次调用<em>invokeSuspend()</em></li>
<li>此时将<em>label = 1</em></li>
<li>从上次挂起点继续执行</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af320b9a47ab4ac4ab6012ec7b84a7d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbnlKaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769693794&amp;x-signature=Iyvkyxhcq4ZlYb0zV6jQrrvuwm0%3D" alt="协程恢复流程.png" loading="lazy"/></p>
<p>值得注意的是，恢复 ≠ 回到原线程；也就是恢复在哪个线程，取决于<em>CoroutineDispatcher</em>，这个后续文章中会说到，这里就不作过多解释。</p>
<h4 data-id="heading-35"><em>invokeSuspend</em>为什么能反复调用？</h4>
<p>现在回到之前的一个关键问题：为什么多次调用 <em>invokeSuspend()</em> ，不会把代码从头重新执行一遍？</p>
<p>答案就在它的设计上。</p>
<p><em>invokeSuspend()</em> 并不是一个普通函数，而是一个“可重入的状态机执行函数”。</p>
<p>每次调用的时候，根据当前的<em>label</em>标志位，决定从哪一段逻辑继续执行</p>
<p>我们可以把它理解为：<strong>一个自带“执行记忆”的函数。</strong></p>
<p>总的来说，协程启动后并不会“一口气跑完”，而是被编译成一个由 <em>invokeSuspend()</em> 驱动的状态机；每一次挂起和恢复，都是状态机的一次跳转；遇到挂起点时提前返回并保存状态，恢复时再次进入同一个状态机，依靠 <em>label</em>从上一次中断的位置继续执行。整个过程不阻塞线程，只是在用户态保存和恢复执行状态。</p>
<p>以上就是<strong>协程挂起 / 恢复真正发生的全过程</strong>。</p>
<h3 data-id="heading-36">参考资料</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.scaler.com%2Ftopics%2Fkotlin%2Fstackless-vs-stackful-coroutines%2F" target="_blank" title="https://www.scaler.com/topics/kotlin/stackless-vs-stackful-coroutines/" ref="nofollow noopener noreferrer">scaler.com - Stackless vs Stackful Coroutines</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2Fare-kotlin-coroutines-stackless" target="_blank" title="https://stackoverflow.com/questions/are-kotlin-coroutines-stackless" ref="nofollow noopener noreferrer">Stack Overflow - Are Kotlin coroutines stackless?</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bennyhuo.com%2F" target="_blank" title="https://www.bennyhuo.com/" ref="nofollow noopener noreferrer">bennyhuo.com - Kotlin 协程原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.51cto.com%2F" target="_blank" title="https://blog.51cto.com/" ref="nofollow noopener noreferrer">51CTO博客 - 协程详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-overview.html" target="_blank" title="https://kotlinlang.org/docs/coroutines-overview.html" ref="nofollow noopener noreferrer">Kotlin 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2F" target="_blank" title="https://stackoverflow.com/" ref="nofollow noopener noreferrer">Stack Overflow - Kotlin coroutines implementation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.geeksforgeeks.org%2Fkotlin-coroutines%2F" target="_blank" title="https://www.geeksforgeeks.org/kotlin-coroutines/" ref="nofollow noopener noreferrer">geeksforgeeks.org - Kotlin Coroutines</a></li>
</ol>
<p>我们下一篇见</p>
<p>祝你早安午安晚安</p>
<p>顺颂时祺，秋绥冬禧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[活着需要钱，但没想到企业家想要我们的命（程序员活命密件）]]></title>    <link>https://juejin.cn/post/7598011274686660608</link>    <guid>https://juejin.cn/post/7598011274686660608</guid>    <pubDate>2026-01-22T13:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598011274686660608" data-draft-id="7597987896693719075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="活着需要钱，但没想到企业家想要我们的命（程序员活命密件）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-22T13:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="余杭子曰"/> <meta itemprop="url" content="https://juejin.cn/user/377887729918589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            活着需要钱，但没想到企业家想要我们的命（程序员活命密件）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887729918589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    余杭子曰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:42:10.000Z" title="Thu Jan 22 2026 13:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>看到一位鲜活的程序员，才32岁，离开了这个世界，那是谁的父亲，是谁的儿子，又是谁的老公。</p>
<p>想了很久，我实在不知道用什么标题来形容这样的事情，因为不是第一次，也绝对不是最后一次，一切还将继续，直到某些制度能被诉诸法律并强制执行。</p>
<p>任何一种职业，都是辛苦，值得被尊敬的。在没有参加工作之前，我确定的知道，医生很辛苦，建筑工人很辛苦，农民很辛苦，电子厂的操作工很辛苦，直到自己参加工作，直到某里开始喊出加班是福报，明确的，开始有程序员也加入了这个行列，并且“残忍血腥”。</p>
<p>从14年刚开始参加工作，就是一名程序员，那时候只觉得，我们是工程师，从没觉得自己也是“码农”。以前觉得，我们是智力劳动者，却没想到，也是彻头彻尾的体力劳动者。</p>
<p>在以千行万行记的代码里，没有任何人能够保证它在线上运行不会有问题，也没有人定义出来写出它需要多少时间。这就是这行的原罪。</p>
<p>你肯定能收到+1甚至老板，客户的“叮嘱”。</p>
<p>这个问题很严重，要解决下，马上看。</p>
<p>这个客户比较着急，能不能加班，在周五之前上线。</p>
<p>大家要保证24小时在线哈，有问题就需要响应，然后快速解决。</p>
<p>每当如此，都能生效，因为看着好像这批人就像一头猪，可以一直放血，一只羊，可以一直被薅羊毛。</p>
<p>有不少人事，或者同行，可能会说，你们薪资高啊，你们可以不干呀 ？</p>
<p>实际，薪资高的职业，基本都薪资高，程序员并不是个例，却成为了近几年猝死最多的职业。</p>
<p>你们说他薪资高，实际加班没有钱，实际为了完成任务，熬坏了心肝肺，和家人常年如同陌路人。</p>
<p>最大的悲哀，不在于此，而在于当人死了，那只喊你拉磨的哨子还在响，那农场主还在说，这个人不是给我干活死掉的，迫不及待的划清界限，以免不吉利。</p>
<p>我们看不到在现代化的所谓公司里，给到的人性关怀，一切和员工相关的人，都在漠视，又无奈。</p>
<p>鲁迅先生曾经写到，为了治病，大家蜂拥上去，抢那被凌迟革命者的鲜血，因为沾了便可以救命。</p>
<p>我写到，只因为进了这行，便身不由己，吐完最后一口气，看完最后一眼电脑，临死前发现，被卖命的不是革命事业，而是干不完的任务，和无尽无偿的工时剥削。</p>
<p>写到此，我也力尽，心凉，愿大家珍惜生命，即使你年薪五十万，一百万，也不要为了它卖命，你的家人还在等你回家。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我们来说一下 TCP 的三次握手四次挥手过程]]></title>    <link>https://juejin.cn/post/7598011274686726144</link>    <guid>https://juejin.cn/post/7598011274686726144</guid>    <pubDate>2026-01-22T13:53:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598011274686726144" data-draft-id="7598011274686709760" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我们来说一下 TCP 的三次握手四次挥手过程"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-22T13:53:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我们来说一下 TCP 的三次握手四次挥手过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:53:29.000Z" title="Thu Jan 22 2026 13:53:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>第一部分：核心概念与背景</strong></h3>
<p>在开始之前，先明确几个关键点：</p>
<ol>
<li><strong>TCP 是什么</strong>：传输控制协议，是一种<strong>面向连接的、可靠的、基于字节流</strong>的传输层通信协议。</li>
<li><strong>“连接”是什么</strong>：TCP 的连接并非物理上的电路，而是通信双方在内存中维护的一种<strong>状态信息</strong>（如序列号、窗口大小等）。建立连接就是<strong>同步双方的初始状态</strong>。</li>
<li><strong>标志位</strong>：TCP 头部中有几个重要的控制位，在握手挥手中起到关键作用：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>SYN</strong>：同步序列号，用于<strong>建立连接</strong>。</li>
<li><strong>ACK</strong>：确认，表示确认号字段有效。</li>
<li><strong>FIN</strong>：终止，用于<strong>关闭连接</strong>。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>序列号与确认号</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>序列号</strong>：标识发送的数据字节流的顺序。</li>
<li><strong>确认号</strong>：期望收到对方下一个报文段的第一个数据字节的序列号，表示此序号之前的数据已成功接收。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-1"><strong>第二部分：三次握手 — 建立连接</strong></h3>
<p>三次握手的根本目的是：<strong>同步双方的初始序列号，并交换其他参数，为可靠数据传输做准备</strong>。同时，它也证明了双方都具有<strong>发送和接收</strong>的能力。</p>
<p>假设客户端（Client）主动发起连接，服务器（Server）等待连接。</p>
<p><strong>第一步：第一次握手（Client -&gt; Server）</strong></p>
<ul>
<li>客户端发送一个 TCP 报文段。</li>
<li>设置标志位 <strong>SYN = 1</strong>，表示这是连接请求。</li>
<li>同时，客户端会<strong>随机生成一个初始序列号</strong> ****<code>client_isn</code>，放在序列号字段中。</li>
<li>此时不携带应用层数据。</li>
<li><strong>客户端状态</strong>：从 <code>CLOSED</code> 进入 <code>SYN-SENT</code>（同步已发送）。</li>
</ul>
<p><strong>第二步：第二次握手（Server -&gt; Client）</strong></p>
<ul>
<li>服务器收到 SYN 报文后，如果同意建立连接，则会回复一个报文段。</li>
<li>设置标志位 <strong>SYN = 1</strong> 和 <strong>ACK = 1</strong>。</li>
<li>服务器也会<strong>随机生成自己的初始序列号</strong> ****<code>server_isn</code>，放在序列号字段中。</li>
<li>确认号字段设置为 <code>client_isn + 1</code>，表示“我已收到你的序列号为 <code>client_isn</code> 的 SYN 包，期待下一个数据从 <code>client_isn + 1</code> 开始”。</li>
<li>此时可以携带或不携带应用层数据（但通常不携带）。</li>
<li><strong>服务器状态</strong>：从 <code>LISTEN</code> 进入 <code>SYN-RCVD</code>（同步已收到）。</li>
</ul>
<p><strong>第三步：第三次握手（Client -&gt; Server）</strong></p>
<ul>
<li>客户端收到服务器的 SYN-ACK 报文后，会再发送一个确认报文。</li>
<li>设置标志位 <strong>ACK = 1</strong>。</li>
<li>序列号字段设置为 <code>client_isn + 1</code>（因为第一次握手消耗了一个序列号）。</li>
<li>确认号字段设置为 <code>server_isn + 1</code>，表示“我已收到你的序列号为 <code>server_isn</code> 的 SYN 包”。</li>
<li>此报文<strong>可以携带应用层数据</strong>（连接建立后即可开始传输）。</li>
<li><strong>客户端状态</strong>：从 <code>SYN-SENT</code> 进入 <code>ESTABLISHED</code>（已建立连接）。</li>
<li>服务器收到这个 ACK 后，状态也从 <code>SYN-RCVD</code> 进入 <code>ESTABLISHED</code>。</li>
</ul>
<p><strong>为什么是三次，而不是两次？</strong></p>
<ul>
<li><strong>根本原因</strong>：<strong>防止已失效的连接请求报文突然到达，导致资源浪费和错误。</strong></li>
<li><strong>经典场景</strong>：客户端发送了一个 SYN 报文，但由于网络拥堵，迟迟未到达服务器。客户端超时重传了一个新的 SYN 并成功建立了连接、传输数据、关闭连接。此时，那个失效的旧 SYN 报文终于到达了服务器。如果只用两次握手，服务器会认为这是一个新的连接请求，直接进入 <code>ESTABLISHED</code> 状态，并分配资源等待客户端发送数据，但客户端早已关闭，不会发送任何数据。这就造成了<strong>服务器的资源被白白占用</strong>。</li>
<li><strong>三次握手的作用</strong>：在两次握手的情况下，服务器会直接建立连接。而采用三次握手，服务器在收到失效的 SYN 后，会回复 SYN-ACK，但客户端（因为已经关闭）不会回复最终的 ACK，因此服务器在 <code>SYN-RCVD</code> 状态等待一段时间后，会因收不到 ACK 而关闭这个半连接，从而避免资源浪费。</li>
</ul>
<h3 data-id="heading-2"><strong>第三部分：四次挥手 — 关闭连接</strong></h3>
<p>四次挥手的目的是：<strong>双方都确认没有数据需要发送了，然后安全地关闭连接</strong>。由于 TCP 连接是<strong>全双工</strong>的（可以同时独立地进行双向数据传输），因此每个方向都必须单独关闭。</p>
<p>假设客户端主动发起关闭。</p>
<p><strong>第一步：第一次挥手（Client -&gt; Server）</strong></p>
<ul>
<li>客户端应用程序调用 <code>close()</code> 方法，发送一个 TCP 报文段。</li>
<li>设置标志位 <strong>FIN = 1</strong>。</li>
<li>携带一个当前的序列号 <code>seq = u</code>。</li>
<li><strong>客户端状态</strong>：从 <code>ESTABLISHED</code> 进入 <code>FIN-WAIT-1</code>（终止等待1）。</li>
</ul>
<p><strong>第二步：第二次挥手（Server -&gt; Client）</strong></p>
<ul>
<li>服务器收到 FIN 报文后，立即回复一个确认报文。</li>
<li>设置标志位 <strong>ACK = 1</strong>。</li>
<li>确认号设置为 <code>u + 1</code>。</li>
<li>此时，<strong>从客户端到服务器方向的连接就关闭了</strong>。客户端不会再向服务器发送数据，但<strong>服务器可能还有数据要发送给客户端</strong>，连接处于<strong>半关闭状态</strong>。</li>
<li><strong>服务器状态</strong>：从 <code>ESTABLISHED</code> 进入 <code>CLOSE-WAIT</code>（关闭等待）。</li>
<li><strong>客户端状态</strong>：收到这个 ACK 后，从 <code>FIN-WAIT-1</code> 进入 <code>FIN-WAIT-2</code>（终止等待2）。</li>
</ul>
<p><strong>第三步：第三次挥手（Server -&gt; Client）</strong></p>
<ul>
<li>当服务器将剩余数据全部发送完毕后，它的应用程序也会调用 <code>close()</code> 方法，发送一个 FIN 报文。</li>
<li>设置标志位 <strong>FIN = 1</strong>（通常还会同时设置 ACK = 1）。</li>
<li>携带一个序列号 <code>seq = w</code>。</li>
<li><strong>服务器状态</strong>：从 <code>CLOSE-WAIT</code> 进入 <code>LAST-ACK</code>（最后确认）。</li>
</ul>
<p><strong>第四步：第四次挥手（Client -&gt; Server）</strong></p>
<ul>
<li>客户端收到服务器的 FIN 报文后，必须发送一个确认报文。</li>
<li>设置标志位 <strong>ACK = 1</strong>。</li>
<li>确认号设置为 <code>w + 1</code>。</li>
<li><strong>客户端状态</strong>：从 <code>FIN-WAIT-2</code> 进入 <code>TIME-WAIT</code>（时间等待）。此时客户端连接尚未完全关闭，需要等待 <strong>2MSL</strong>（两倍的最大报文段生存时间）时长。</li>
<li>服务器收到这个 ACK 后，状态从 <code>LAST-ACK</code> 进入 <code>CLOSED</code>，连接正式关闭。</li>
</ul>
<p><strong>为什么客户端需要 TIME-WAIT 状态？等待 2MSL 的目的是什么？</strong></p>
<ol>
<li><strong>可靠地终止连接</strong>：确保客户端发送的最后一个 ACK 能到达服务器。如果这个 ACK 丢失，服务器会超时重传 FIN 报文。客户端在 <code>TIME-WAIT</code> 状态下可以收到这个重传的 FIN，并重发 ACK。</li>
<li><strong>让旧的重复报文在网络中消逝</strong>：等待 2MSL 时间，足以让本次连接过程中产生的所有报文都在网络中消失。这样，就不会影响后续使用相同四元组（源IP、源端口、目的IP、目的端口）的新连接。</li>
</ol>
<h3 data-id="heading-3"><strong>总结与对比</strong></h3>









































<table><thead><tr><th>阶段</th><th>目的</th><th>关键标志位</th><th>状态变化</th></tr></thead><tbody><tr><td><strong>三次握手</strong></td><td><strong>建立连接，同步初始序列号</strong></td><td>SYN, ACK</td><td>CLOSED -&gt; SYN-SENT -&gt; SYN-RCVD -&gt; ESTABLISHED</td></tr><tr><td><strong>第一次挥手</strong></td><td><strong>客户端发起关闭（关闭己方发送通道）</strong></td><td>FIN</td><td>ESTABLISHED -&gt; FIN-WAIT-1</td></tr><tr><td><strong>第二次挥手</strong></td><td><strong>服务器确认收到关闭请求</strong></td><td>ACK</td><td>ESTABLISHED -&gt; CLOSE-WAIT / FIN-WAIT-1 -&gt; FIN-WAIT-2</td></tr><tr><td><strong>第三次挥手</strong></td><td><strong>服务器发起关闭（关闭己方发送通道）</strong></td><td>FIN, ACK</td><td>CLOSE-WAIT -&gt; LAST-ACK</td></tr><tr><td><strong>第四次挥手</strong></td><td><strong>客户端确认收到关闭请求</strong></td><td>ACK</td><td>FIN-WAIT-2 -&gt; TIME-WAIT -&gt; CLOSED</td></tr></tbody></table>
<h3 data-id="heading-4">面试回答</h3>
<p><strong>三次握手（建立连接）</strong></p>
<p>目的：为了确认<strong>双方的发送和接收能力都正常</strong>，并同步初始序列号（ISN）。</p>
<ol>
<li><strong>第一次握手（SYN）</strong> ：客户端发送一个 <code>SYN</code>的包，并随机生成一个初始序列号 <code>X</code> 给服务器。意思是：“我想建立连接，这是我的起始号。”</li>
<li><strong>第二次握手（SYN+ACK）</strong> ：服务器收到后，如果同意连接，会回复一个 <code>SYN</code> 和 <code>ACK</code>的包。它会确认客户端的序列号，同时自己也随机生成一个初始序列号 <code>Y</code>。意思是：“我收到你的请求了，我同意连接。这是我的起始号。”</li>
<li><strong>第三次握手（ACK）</strong> ：客户端收到回复后，再向服务器发送一个 <code>ACK</code> 的包，确认服务器的序列号。意思是：“收到你的同意了，连接建立成功。”<br/>
<strong>至此，连接建立，可以开始数据传输。</strong></li>
</ol>
<p><strong>四次挥手（断开连接）</strong></p>
<p>目的：双方都确认数据已发送完毕，可以安全关闭连接。之所以是四次，因为TCP连接是<strong>全双工</strong>的，每一方向都需要独立关闭。</p>
<ol>
<li><strong>第一次挥手（FIN）</strong> ：假设客户端数据发完了，它会发送一个 <code>FIN</code> 的包，并携带一个序列号。意思是：“我这边数据发完了，要关闭连接了。”</li>
<li><strong>第二次挥手（ACK）</strong> ：服务器收到 <code>FIN</code> 后，会立刻回复一个 <code>ACK</code> 的确认包。意思是：“我知道你要关了，但我可能还有数据没发完。”<br/>
<em>此时，客户端到服务器的连接关闭，但服务器到客户端的连接依然可以继续发送数据。</em></li>
<li><strong>第三次挥手（FIN）</strong> ：当服务器也把所有数据发完后，它会发送自己的 <code>FIN</code> 包。意思是：“我这边数据也发完了，我也要关了。”</li>
<li><strong>第四次挥手（ACK）</strong> ：客户端收到服务器的 <code>FIN</code> 后，会发送最后一个 <code>ACK</code> 的确认包。意思是：“好的，我们都关了。”<br/>
<em>客户端会等待一段时间（2MSL）后彻底关闭，服务器收到这个ACK后立即关闭。连接完全断开。</em></li>
</ol>
<p>所以总结一下，<strong>握手是三次</strong>，因为第二次的回复<strong>合并</strong>了确认和发起请求。而<strong>挥手是四次</strong>，因为服务器在收到关闭请求后，可能还有数据要发送，所以把确认和发起自己的关闭请求<strong>分成了两步</strong>，没办法合并。</p>
<p><strong>追加</strong>：<strong>为什么握手是三次，不是两次？</strong></p>
<p>主要是为了防止<strong>已失效的连接请求报文</strong>突然又传到服务器，导致服务器错误地打开连接。三次握手机制下，这个失效的报文会让客户端收到一个它并未请求的确认，客户端会拒绝，服务器收不到第三次ACK，就不会建立连接。</p>
<p><strong>追加：为什么挥手需要四次？</strong></p>
<p>因为TCP是<strong>全双工</strong>的。当一方说“我要关了”（发FIN），只代表它不再发送数据，但还可以接收数据。另一方可能还有数据要发送，所以必须先立刻回复一个ACK，等自己数据发完再发FIN。因此ACK和FIN在多数情况下不能像握手那样合并发送。</p>
<p><strong>追加： TIME_WAIT状态是什么？为什么需要等待2MSL？</strong></p>
<p>主动关闭的一方（先发FIN的，比如刚才例子里的客户端）在发送完最后一个ACK后，会进入<code>TIME_WAIT</code>状态，等待2倍的最大报文段生存时间（2MSL）<br/>
<strong>两个目的</strong>：</p>
<ol>
<li><strong>确保最后的ACK能到达</strong>：如果这个ACK丢失了，对方会超时重发FIN，<code>TIME_WAIT</code>状态下的客户端还能重发ACK。</li>
<li><strong>让本次连接产生的所有报文在网络中都消失</strong>，避免影响后续新建的相同端口的连接。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之首屏时间采集篇]]></title>    <link>https://juejin.cn/post/7598062246572507190</link>    <guid>https://juejin.cn/post/7598062246572507190</guid>    <pubDate>2026-01-22T14:01:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598062246572507190" data-draft-id="7598021313870413830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之首屏时间采集篇"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2026-01-22T14:01:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之首屏时间采集篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T14:01:26.000Z" title="Thu Jan 22 2026 14:01:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>所谓首屏，就是用户看到当前页面的第一屏，首屏时间就是第一屏被完全加载出来的时间点。</p>
<p>比如一个电商网站，首屏就包括导航栏、搜索框、商品头图等内容。那么，如何采集用户的首屏时间呢？</p>
<p>你可能会说，我直接用 <code>Chrome DevTools</code> 看一下就行了。</p>
<h2 data-id="heading-0">1、容易误导开发者的 Chrome DevTools</h2>
<p>每次拿 <code>Chrome DevTools</code> 一看，好像自家网站的性能杠杠的，页面加载嘎嘎快，但结果却是用户反馈进入网站很卡，究其原因，这是由 <code>Chrome DevTools</code> 的局限性导致的：</p>
<ul>
<li><strong>网络环境差异</strong>：使用 <code>Chrome DevTools</code> 是内网访问，往往网络环境很好，而用户的网络环境就很复杂，在偏远地区或者电梯、地铁等弱网环境体验会更差。</li>
<li><strong>访问方式不同</strong>：调试工具和真机有一定的差距。</li>
<li><strong>访问设备有限</strong>：测试机观察到的首屏时间机型有限，而真实用户的手机机型五花八门。</li>
</ul>
<p>所以通过 <code>Chrome DevTools</code> 采集到的数据是不够准确的。所以我们需要通过添加相关代码进行采集，然后把采集到的数据上报到服务器中，这样就能获取大量用户的首屏时间数据。</p>
<p>采集方式一般有两种，<strong>手动采集</strong>和<strong>自动化采集</strong>。</p>
<h2 data-id="heading-1">2、手动采集</h2>
<p>手动采集一般是通过埋点的方式来实现：</p>
<ul>
<li>比如是电商网站首页，需要在导航栏、搜索框、商品头图等内容加载完毕的位置打上点。</li>
<li>如果是一个列表页，需要根据各个机型下的首屏位置，计算出一个平均的首屏位置，打上点。</li>
<li>如果首屏仅仅是一张图片，则需要在图片加载完成之后，打上点。</li>
</ul>
<p><strong>优点</strong>：</p>
<ul>
<li>灵活性强，可以根据网页的特点随时改变打点策略，以保证首屏时间采集的准确性。</li>
<li>去中心化，各个业务部分自己打自己点即可，自行采集和维护。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>通用性差，各个业务要自己去设计打点方案。</li>
<li>和业务代码耦合在一起，维护性差，而且随着业务的变化，打点代码也需要调整，较为麻烦。</li>
<li>依赖人，不同人对首屏的理解不一样，导致不同人采集的结果有差异，还需要花时间和成本去校正，或者忘记打点。</li>
</ul>
<h2 data-id="heading-2">3、自动化采集</h2>
<p>自动化采集就是指插入一段通用代码进行自动化采集。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>通用性强，多个业务线都可用，使用和接入简单。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>无法满足业务的个性化需求。</li>
</ul>
<p><strong>自动化采集对于不同的场景，采集方案也不一样</strong>:</p>
<ul>
<li>对于服务端渲染 <code>SSR</code> 来说，客户端拿到的就是拼接好的 <code>html</code> 字符串，所以直接采集 <code>DOMContentLoaded</code> 的时间即可。</li>
<li>对于客户端渲染的 <code>SPA</code> 应用来说，<code>DOMContentLoaded</code> 的时间并不一定准确，因为里面的内容开始只有一个容器 <code>&lt;div id="app"&gt;&lt;/div&gt;</code>，后续内容是通过 <code>js</code> 动态渲染出来的，而用户需要看到完整的首屏实际内容，才能算首屏加载完成了。</li>
</ul>
<p>那么，如何准确采集单页面（SPA）应用的首屏时间呢？</p>
<h2 data-id="heading-3">4、单页面（SPA）应用的首屏采集方案</h2>
<p>首先先了解下单页应用的渲染大概流程：</p>
<ol>
<li>输入网址，从服务器拿到 <code>index.html</code> 文件；</li>
<li>浏览器使用 <code>html</code> 解析器解析 <code>html</code> 文件，并加载 <code>css</code>、<code>js</code> 等资源。</li>
<li>执行 <code>js</code> 代码，初始化框架 <code>Vue/React/Angular</code>，执行里面相关生命周期钩子，使用 <code>xhr/axios</code> 请求数据，并渲染 DOM 到页面上。</li>
</ol>
<p>那么，我们的核心就是需要知道，渲染 DOM 到页面上的时间。以 <code>Vue</code> 框架为例，它有一个 <code>mounted(Vue2 Options API)、onMounted(Vue3 Composition API )</code> 钩子，可以拿到 DOM 加载的时间，那么我们是不是能利用这个钩子来进行首屏时间的采集呢？</p>
<p>显然是不行的，这样做有如下缺点：</p>
<ol>
<li>如果页面数据是通过请求异步拿到并渲染到页面上，<code>mounted</code> 采集的首屏时间就不准确了，如果要知道准确的时间，需要等请求完成的时间点进行采集，这样会侵入业务代码，违背了通用性，再说如果有多个请求抽离在各个地方，还需要用类似 <code>Promise.all</code> 进行整合，还是需要修改业务代码。</li>
<li>如果首页是一张图片，而 <code>mounted</code> 的时间，图片内容可能并没有加载完，用户也看不到内容。</li>
</ol>
<h2 data-id="heading-4">5、使用 MutationObserver 采集首屏时间</h2>
<p>所以，我们应该采用 <code>MutationObserver</code> 进行采集。它能监听 <strong>DOM 树的更改</strong>并执行相关的回调。核心的统计思路就是：在页面初始化时，使用 <code>MutationObserver</code> 监听 DOM 元素，当其发生变化时，程序会标记变化的元素，并记录时间点和分数，存储到数组中，当达到如下条件时，说明首屏渲染已经结束：</p>
<ul>
<li>计算时间超过 <code>30s</code> 还没结束。</li>
<li>计算了 <code>4</code> 次且 <code>1s</code> 内分数不再变化。</li>
<li>计算了 <code>9</code> 次且分数不再变化。</li>
</ul>
<p>统计分数过程如下：</p>
<ul>
<li>递归遍历 DOM 元素及其子元素，根据元素层级设定元素权重。层级越深的元素最接近用户看到的内容，权重也就越高。比如第一层权重为 <code>1</code> ，渲染完成得 <code>1</code> 分，没增加一层权重增加 <code>0.5</code>，第三层的权重为 <code>3.5</code>，也就是渲染完成得 <code>3.5</code> 分。</li>
</ul>
<p>最终，我们拿到一个记录了时间点和分数的数组，然后通过<strong>数组的后一项 - 数组前一项</strong>求出元素分数变化率，找到变化率最大点的分数对应的时间，即为首屏时间。</p>
<p>那这样算出来的首屏时间是否准确呢？其实不然，像我们之前说的首屏为一张图片的情况，就采集的不准。</p>
<p>所以对于图片来说，我们需要拿到页面中所有的 <code>img</code>，其来源主要有两方面：</p>
<ul>
<li><code>img</code> 标签：通过拿到 dom 节点，判断其 <code>nodeName.toUpperCase === 'IMG'</code>。</li>
<li>CSS 背景中的图片<code>background: url("https://static.xxx.png")</code>。可以通过如下方式来拿到：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (dom.<span class="hljs-property">nodeName</span>.<span class="hljs-property">toUpperCase</span> !== <span class="hljs-string">'IMG'</span>) {
  <span class="hljs-keyword">const</span> domStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(dom);
  <span class="hljs-keyword">const</span> imgUrl = domStyle.<span class="hljs-title function_">getPropertyValue</span>(<span class="hljs-string">'background-image'</span>) || domStyle.<span class="hljs-title function_">getPropertyValue</span>(<span class="hljs-string">'background'</span>);
}
</code></pre>
<p>拿到图片的 url 之后，通过 <code>performance.getEntriesByName(imgUrl)[0].responseEnd</code> 获取图片的加载时间，然后拿到图片最长的加载时间和之前变化率最大点的分数对应的时间进行对比，哪个更长哪个就是最终的首屏时间。</p>
<h2 data-id="heading-5">小结</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8a093f0e5314e73978603ded037d44c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769695286&amp;x-signature=EqEIsgHaHtj8yY9h0xM7Yk%2FPzto%3D" alt="" loading="lazy"/></p>
<ul>
<li>首屏时间会受用户设备、网络环境的影响，使用 <code>Chrome DevTools</code> 拿到的首屏时间存在偏差。</li>
<li>手动采集方案较为灵活，能满足个性化需求，去中心化，但没有自动采集通用性好，会跟业务代码耦合，接入成本也更高，会受人为影响，所以一般都会选择自动化采集方案。</li>
<li>采集时，服务端 SSR 应用和单页 SPA 应用的采集有很大不同，SSR 应用只需要采集 <code>DOMContentLoaded</code> 时间即可，而单页应用则需要使用 <code>MutationObserver</code> 监听 DOM，并设置元素权重，统计每个元素的分数和时间，最终拿到变化率最大的分数及时间点。</li>
<li>计算出所有图片的加载时间，与变化率最大的分数的时间进行比较，更大的作为最终的首屏时间。</li>
</ul>
<h2 data-id="heading-6">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9OsrlYXrvJbkGDrTiJ6NHQ" target="_blank" title="https://mp.weixin.qq.com/s/9OsrlYXrvJbkGDrTiJ6NHQ" ref="nofollow noopener noreferrer">前端性能优化之性能指标篇</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FW8fkvEjbHlFpIg3_RMXGpA" target="_blank" title="https://mp.weixin.qq.com/s/W8fkvEjbHlFpIg3_RMXGpA" ref="nofollow noopener noreferrer">前端性能优化之Webpack篇</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Gl2sGa2Ev44tyrSYjjyFg" target="_blank" title="https://mp.weixin.qq.com/s/0Gl2sGa2Ev44tyrSYjjyFg" ref="nofollow noopener noreferrer">前端性能优化之CSS篇</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FeIKLx_kegGzrB00KXeKYLQ" target="_blank" title="https://mp.weixin.qq.com/s/eIKLx_kegGzrB00KXeKYLQ" ref="nofollow noopener noreferrer">前端遇到页面卡顿问题，如何排查和解决？</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深分页为什么慢：LIMIT/OFFSET 的隐患，以及更稳的 Seek 分页]]></title>    <link>https://juejin.cn/post/7598021081986842675</link>    <guid>https://juejin.cn/post/7598021081986842675</guid>    <pubDate>2026-01-22T13:50:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021081986842675" data-draft-id="7595040803581509647" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深分页为什么慢：LIMIT/OFFSET 的隐患，以及更稳的 Seek 分页"/> <meta itemprop="keywords" content="后端,MySQL,性能优化"/> <meta itemprop="datePublished" content="2026-01-22T13:50:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叫煤球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058745054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深分页为什么慢：LIMIT/OFFSET 的隐患，以及更稳的 Seek 分页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058745054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叫煤球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T13:50:47.000Z" title="Thu Jan 22 2026 13:50:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>分页查询最常见的写法是 LIMIT + OFFSET：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">999980</span>;
</code></pre>
<p>在数据量小的时候它很正常；</p>
<p>但是数据量到千万级后，它会变得越来越慢，常见表现是延迟随页码增长明显上升，CPU/IO 抖动，甚至出现临时表落盘。</p>
<p>本文解释两个问题：</p>
<p><strong>1.  LIMIT/OFFSET 在深分页时为什么会越来越慢</strong></p>
<p><strong>2.  如何用游标/Seek 分页让性能稳定下来</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7be2e44826346de952789ac3c88eff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Y-r54Wk55CD55qE54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769694646&amp;x-signature=eF7MsO0Qe89XYr5Q%2Fbishr67H4Q%3D" alt="pokemon GIF (1).gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">OFFSET 并非真正的跳过</h2>
<p>OFFSET 在平常用起来很方便，但是它有个问题：数据库通常不是真的直接跳到第 N 条，它需要先产生有序结果，再把前面的丢弃掉。</p>
<p><code>LIMIT 20 OFFSET 1000000</code> 在效果上等价于：</p>
<ul>
<li>先处理（扫描/过滤/排序）1000020 条</li>
<li>丢掉前 1000000 条</li>
<li>返回后 20 条</li>
</ul>
<p>所以深分页的浪费会线性增长：</p>
<ul>
<li>可能只是查 20 条</li>
<li>但数据库得处理百万级候选行</li>
</ul>
<p>这也是为什么同一条 SQL 只要 OFFSET 增大，就会越来越慢。</p>
<hr/>
<h2 data-id="heading-2">ORDER BY 也会放大成本：filesort、temporary、落盘</h2>
<p>一般情况下，分页肯定还会带上 ORDER BY，那深分页 + ORDER BY 就会把问题继续放大，尤其在以下情况下：</p>
<ul>
<li>排序不能完全利用索引顺序（索引不匹配、排序字段不在合适的联合索引里）</li>
<li>个别情况下，查询再带上 join/group by</li>
<li>返回列较多，无法覆盖索引，需要回表</li>
</ul>
<p>属实是雪上加霜了。</p>
<p>比如这个最简单的例子：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, created_at, amount
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">500000</span>;
</code></pre>
<p>为了拿到第 500001～500020 条，常见执行路径是：</p>
<ol>
<li>根据 WHERE 先找到候选行</li>
<li>生成按 ORDER BY 排序后的结果（可能需要额外排序）</li>
<li>产生中间结果集（sort buffer / 临时表）</li>
<li>丢弃 OFFSET 的那部分</li>
<li>返回 LIMIT 的那部分</li>
</ol>
<p>如果排序路径比较重，那我们会在 EXPLAIN 里看到：</p>
<ul>
<li><code>Using filesort</code></li>
<li><code>Using temporary</code></li>
<li>临时表落盘（磁盘临时文件）</li>
<li><code>rows</code>、<code>rows examined</code> 伴随 OFFSET 上升</li>
</ul>
<p>这类成本就是OFFSET 扩大，导致数据库要做的排序工作也跟着扩大，所以很容易出现后半段延迟陡增、速度暴降的现象。</p>
<hr/>
<h2 data-id="heading-3">3）复现实验：1000 万行数据，观察 OFFSET 从 1w 到 100w 的耗时</h2>
<p>下面是一个可复现的实验设计（MySQL 为例）。</p>
<h3 data-id="heading-4">表结构与索引</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_big (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
  user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  payload <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  KEY idx_user_created (user_id, created_at, id)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<p>说明：</p>
<ul>
<li><code>user_id</code> 用于过滤</li>
<li><code>(user_id, created_at, id)</code> 用于匹配 <code>WHERE user_id = ?</code> 和 <code>ORDER BY created_at, id</code></li>
<li><code>id</code> 设置自增，用于排序稳定性（created_at 可能重复）</li>
</ul>
<h3 data-id="heading-5">测试 SQL</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, created_at, payload
<span class="hljs-keyword">FROM</span> t_big
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">42</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>, id <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span> <span class="hljs-keyword">OFFSET</span> ?;
</code></pre>
<h3 data-id="heading-6">OFFSET 取值</h3>
<ul>
<li>1w、5w、10w、20w、50w、80w、100w</li>
<li>再加：每 10w 一个点直到 100w</li>
</ul>
<h3 data-id="heading-7">测量方法</h3>
<p>每个 OFFSET：</p>
<ul>
<li>
<p>热身 3 次</p>
</li>
<li>
<p>正式跑 5 次，对查询耗时取中位数</p>
</li>
<li>
<p>记录：</p>
<ul>
<li>执行耗时</li>
<li><code>Rows examined</code></li>
<li>EXPLAIN / EXPLAIN ANALYZE（重点看 <code>rows</code>、<code>Extra</code> 是否出现 temporary/filesort）</li>
</ul>
</li>
</ul>
<p>通常会出现两类现象：</p>
<ul>
<li>Rows examined 大体跟 OFFSET 同量级上升</li>
<li>当触发更重的排序/临时表路径时，延迟曲线会出现明显拐点</li>
</ul>
<hr/>
<h2 data-id="heading-8">稳定方案：Seek 分页（Cursor/Keyset Pagination）</h2>
<p>解决思路非常直接：不要使用 OFFSET。</p>
<p>那怎么分页？</p>
<p>让数据库从一个确定的位置继续往下取。</p>
<p>也就是前端不传 page=50000，而是传上一页最后一条的排序键（cursor）。</p>
<p>假设排序规则：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>, id <span class="hljs-keyword">DESC</span>
</code></pre>
<p>上一页最后一条是：</p>
<ul>
<li><code>last_created_at = '2026-01-01 10:00:00'</code></li>
<li><code>last_id = 884211</code></li>
</ul>
<p>下一页查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, created_at, payload
<span class="hljs-keyword">FROM</span> t_big
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">42</span>
  <span class="hljs-keyword">AND</span> (
    created_at <span class="hljs-operator">&lt;</span> :last_created_at
    <span class="hljs-keyword">OR</span> (created_at <span class="hljs-operator">=</span> :last_created_at <span class="hljs-keyword">AND</span> id <span class="hljs-operator">&lt;</span> :last_id)
  )
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>, id <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<p>这类分页的特点是：</p>
<ul>
<li>每次只处理下一页需要的几十条</li>
<li>延迟基本与页码无关，而与 page size 相关（更稳定）</li>
<li>更容易持续走索引顺序</li>
</ul>
<h3 data-id="heading-9">索引匹配建议</h3>
<p>Seek 分页要稳定，还得加上匹配的索引，得和 WHERE + ORDER BY 的字段相匹配：</p>
<pre><code class="hljs language-bash" lang="bash">KEY idx_user_created (user_id, created_at, <span class="hljs-built_in">id</span>)
</code></pre>
<p>这里有个小技巧：把过滤列放在前面，把排序列放到在后面，一般能得到更好的执行计划。</p>
<hr/>
<h2 data-id="heading-10">注意点：Seek 分页的边界</h2>
<h3 data-id="heading-11">排序必须稳定</h3>
<p>不要只用 <code>created_at</code> 这类时间字段排序。数据量一大、同一时间戳很多时，就很容易出现：</p>
<ul>
<li>翻页时重复数据</li>
<li>或者漏数据</li>
</ul>
<p>正确做法是 <strong>时间字段 + 唯一键</strong> 组成稳定排序，比如：</p>
<ul>
<li><code>(created_at, id)</code></li>
<li><code>(created_at, order_id)</code></li>
</ul>
<p>这样即使 <code>created_at</code> 相同，也能用唯一键把顺序固定下来。</p>
<h3 data-id="heading-12">Seek 不适合随便跳到第 N 页</h3>
<p>Seek 更适合 “下一页 / 滚动加载” 这种连续翻页场景；<br/>
如果让它支持直接跳页，成本会很高（通常要先走很多页才能定位到第 N 页），其实说白了就是不擅长跳页。</p>
<p>如果业务确实强依赖跳页，一般会用这些方案来fallback：</p>
<ul>
<li><strong>先缩小结果集</strong>：加搜索条件、按时间段/状态筛选</li>
<li><strong>用书签/定位点</strong>：按时间分段、按主键区间分段来定位</li>
<li><strong>大页跳转走离线化</strong>：比如导出、异步任务生成结果再查看</li>
</ul>
<p>如果有更好的 Seek 跳页方案，也欢迎在评论区提出来，我们互相交流和学习。</p>
<hr/>
<h2 data-id="heading-13">最后</h2>
<p>今天又看到一个程序员加班猝死了，甚至在抢救时、离世后仍然不停有工作消息找过来，真是荒诞的现实。</p>
<p>说真的，项目可以延期，需求可以砍，公司离了任何一个人都能运转，但命只有一次。</p>
<p>生活总是要负重前行，可一旦感觉有些吃力了，一定要早些休息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d3d9bb4eab14157b5182d0b1ad22e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Y-r54Wk55CD55qE54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769694646&amp;x-signature=7txNqXoDGTIiSszCehYH3Hh8GxU%3D" alt="Tired At Home GIF.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（57）Hibernate的查询命中率如何优化？]]></title>    <link>https://juejin.cn/post/7597973595131379764</link>    <guid>https://juejin.cn/post/7597973595131379764</guid>    <pubDate>2026-01-22T12:18:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597973595131379764" data-draft-id="7598011274686496768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（57）Hibernate的查询命中率如何优化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T12:18:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（57）Hibernate的查询命中率如何优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T12:18:41.000Z" title="Thu Jan 22 2026 12:18:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在优化Hibernate查询命中率的过程中，有多个技术和策略可以采用，包括但不限于缓存、批量操作、适当的查询设计和数据库索引优化。以下是几种主要的优化策略，详细解释和代码示例：</p>
<h3 data-id="heading-0">1. 使用缓存</h3>
<p>Hibernate提供了两级缓存机制：一级缓存和二级缓存。</p>
<h4 data-id="heading-1">一级缓存</h4>
<p>一级缓存是与Hibernate <code>Session</code>关联的缓存，默认启用且不可关闭。一级缓存的作用是避免在同一个会话内重复加载相同的实体。</p>
<h4 data-id="heading-2">二级缓存</h4>
<p>二级缓存是跨会话的缓存，可以显著提高查询性能，特别是对于经常访问的不变数据。</p>
<h5 data-id="heading-3">配置二级缓存</h5>
<p>在<code>hibernate.cfg.xml</code>中启用二级缓存：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.use_second_level_cache"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.provider_configuration_file_resource_path"</span>&gt;</span>/ehcache.xml<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.use_query_cache"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-4">配置<code>ehcache.xml</code></h5>
<p>创建<code>ehcache.xml</code>文件，定义缓存区域：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ehcache</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">"http://ehcache.org/ehcache.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">defaultCache</span>
        <span class="hljs-attr">maxEntriesLocalHeap</span>=<span class="hljs-string">"10000"</span>
        <span class="hljs-attr">eternal</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">statistics</span>=<span class="hljs-string">"true"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.domain.Product"</span>
           <span class="hljs-attr">maxEntriesLocalHeap</span>=<span class="hljs-string">"10000"</span>
           <span class="hljs-attr">eternal</span>=<span class="hljs-string">"false"</span>
           <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">"120"</span>
           <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">"120"</span>
           <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">"false"</span>
           <span class="hljs-attr">statistics</span>=<span class="hljs-string">"true"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ehcache</span>&gt;</span>
</code></pre>
<h5 data-id="heading-5">注解实体类</h5>
<p>在实体类上使用缓存注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> org.hibernate.annotations.Cache;
<span class="hljs-keyword">import</span> org.hibernate.annotations.CacheConcurrencyStrategy;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-meta">@Cacheable</span>
<span class="hljs-meta">@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h5 data-id="heading-6">使用查询缓存</h5>
<p>在查询中启用缓存：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateCacheExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Product&gt; products = session.createQuery(<span class="hljs-string">"from Product"</span>)
                                            .setCacheable(<span class="hljs-literal">true</span>)
                                            .list();
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2. 批量操作</h3>
<p>批量操作可以减少数据库交互次数，提高性能。</p>
<h4 data-id="heading-8">配置批量操作</h4>
<p>在<code>hibernate.cfg.xml</code>中配置批量操作：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">批量获取数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchFetchExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Product&gt; products = session.createQuery(<span class="hljs-string">"from Product"</span>)
                                            .setFetchSize(<span class="hljs-number">20</span>)
                                            .list();
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-10">3. 查询优化</h3>
<p>通过合理设计查询语句和索引，可以极大地提高查询性能。</p>
<h4 data-id="heading-11">使用<code>JOIN FETCH</code></h4>
<p>避免N+1查询问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateJoinFetchExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Order&gt; orders = session.createQuery(<span class="hljs-string">"select o from Order o join fetch o.products"</span>)
                                        .list();
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h4 data-id="heading-12">使用分页</h4>
<p>避免一次性加载大量数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernatePaginationExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Product&gt; products = session.createQuery(<span class="hljs-string">"from Product"</span>)
                                            .setFirstResult(<span class="hljs-number">0</span>)
                                            .setMaxResults(<span class="hljs-number">10</span>)
                                            .list();
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-13">4. 数据库索引优化</h3>
<p>确保在查询中使用的列上建立索引，以提高查询性能。例如，对于产品表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_product_name <span class="hljs-keyword">ON</span> product(name);
</code></pre>
<h3 data-id="heading-14">总结</h3>
<ol>
<li><strong>使用缓存</strong>：通过启用一级和二级缓存，可以显著提高查询性能。</li>
<li><strong>批量操作</strong>：通过配置和使用批量操作，可以减少数据库交互次数，提高性能。</li>
<li><strong>查询优化</strong>：通过合理设计查询语句和使用分页，可以避免N+1查询问题和一次性加载大量数据。</li>
<li><strong>数据库索引优化</strong>：确保在查询中使用的列上建立索引，以提高查询性能。</li>
</ol>
<p>通过这些方法，可以显著提高Hibernate应用程序的查询命中率和整体性能。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的查询优化技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（58）Hibernate的连接管理如何优化？]]></title>    <link>https://juejin.cn/post/7598020609282277410</link>    <guid>https://juejin.cn/post/7598020609282277410</guid>    <pubDate>2026-01-22T12:19:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598020609282277410" data-draft-id="7598025242041237556" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（58）Hibernate的连接管理如何优化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T12:19:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（58）Hibernate的连接管理如何优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T12:19:03.000Z" title="Thu Jan 22 2026 12:19:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>连接管理是影响Hibernate性能的关键因素之一。优化连接管理可以显著提高应用程序的响应时间和吞吐量。以下是几种主要的优化策略，详细解释和代码示例：</p>
<h3 data-id="heading-0">1. 使用连接池</h3>
<p>使用连接池是优化数据库连接管理的最有效方法之一。连接池可以复用已经创建的连接，减少连接创建和关闭的开销。常用的连接池包括C3P0、HikariCP和Apache DBCP。</p>
<h4 data-id="heading-1">使用HikariCP连接池</h4>
<p>HikariCP是一种高性能的JDBC连接池，推荐用于生产环境。</p>
<h5 data-id="heading-2">配置Hibernate</h5>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- HikariCP 连接池配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.dataSourceClassName"</span>&gt;</span>com.mysql.cj.jdbc.MysqlDataSource<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.dataSource.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.dataSource.user"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.dataSource.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.maximumPoolSize"</span>&gt;</span>10<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.minimumIdle"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.idleTimeout"</span>&gt;</span>30000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.connectionTimeout"</span>&gt;</span>30000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.maxLifetime"</span>&gt;</span>1800000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">实体类定义</h5>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h5 data-id="heading-4">使用Hibernate会话管理连接</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConnectionPoolExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product.setName(<span class="hljs-string">"Product A"</span>);
            product.setPrice(<span class="hljs-number">100.0</span>);
            session.save(product);
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-5">2. 配置合理的连接池参数</h3>
<p>合理配置连接池参数可以提高连接复用率和系统吞吐量：</p>
<ul>
<li><code>maximumPoolSize</code>：最大连接数，通常设置为系统可承受的并发请求数。</li>
<li><code>minimumIdle</code>：最小空闲连接数，保持一定数量的空闲连接以应对突发流量。</li>
<li><code>idleTimeout</code>：连接空闲超时时间，超过时间的空闲连接将被关闭。</li>
<li><code>connectionTimeout</code>：获取连接的最大等待时间，超过时间将抛出异常。</li>
<li><code>maxLifetime</code>：连接的最长生命周期，超过时间的连接将被关闭和重新创建。</li>
</ul>
<h3 data-id="heading-6">3. 连接泄漏检测</h3>
<p>确保连接在使用后被正确关闭，否则会导致连接泄漏和连接池枯竭。</p>
<h4 data-id="heading-7">配置连接泄漏检测</h4>
<p>在HikariCP中，可以配置连接泄漏检测：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hikari.leakDetectionThreshold"</span>&gt;</span>2000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p><code>leakDetectionThreshold</code>表示连接被认为泄漏前的时间阈值（以毫秒为单位）。</p>
<h3 data-id="heading-8">4. 使用批处理</h3>
<p>批处理可以减少数据库交互次数，提高事务吞吐量。</p>
<h4 data-id="heading-9">配置批处理</h4>
<p>在<code>hibernate.cfg.xml</code>中配置批处理：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">批量操作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchProcessingExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
                product.setName(<span class="hljs-string">"Product "</span> + i);
                product.setPrice(<span class="hljs-number">100.0</span> + i);
                session.save(product);
                
                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>) { <span class="hljs-comment">// 每20条记录刷新和清理一次</span>
                    session.flush();
                    session.clear();
                }
            }
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-11">5. 使用JTA（Java Transaction API）</h3>
<p>对于分布式系统，使用JTA可以实现跨多个资源的全局事务管理，提高事务处理的可靠性和一致性。</p>
<h4 data-id="heading-12">配置JTA</h4>
<p>在<code>hibernate.cfg.xml</code>中配置JTA：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.transaction.factory_class"</span>&gt;</span>org.hibernate.engine.transaction.internal.jta.JtaTransactionFactory<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.transaction.jta.platform"</span>&gt;</span>com.example.YourJtaPlatform<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">总结</h3>
<ol>
<li><strong>使用连接池</strong>：通过配置高效的连接池（如HikariCP），可以显著提高数据库连接管理的性能。</li>
<li><strong>合理配置连接池参数</strong>：根据应用需求配置适当的连接池参数，确保连接复用率和系统吞吐量。</li>
<li><strong>连接泄漏检测</strong>：配置连接泄漏检测，确保连接在使用后被正确关闭，防止连接泄漏。</li>
<li><strong>使用批处理</strong>：通过批处理减少数据库交互次数，提高事务吞吐量。</li>
<li><strong>使用JTA</strong>：对于分布式系统，使用JTA实现跨多个资源的全局事务管理，提高事务处理的可靠性和一致性。</li>
</ol>
<p>通过这些方法，可以显著优化Hibernate的连接管理，提高应用程序的性能和稳定性。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的连接管理优化技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还有比ollama更傻瓜式的大模型本地部署方式吗 ？]]></title>    <link>https://juejin.cn/post/7598023360731987978</link>    <guid>https://juejin.cn/post/7598023360731987978</guid>    <pubDate>2026-01-22T11:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598023360731987978" data-draft-id="7597997108134952987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还有比ollama更傻瓜式的大模型本地部署方式吗 ？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T11:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还有比ollama更傻瓜式的大模型本地部署方式吗 ？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T11:31:29.000Z" title="Thu Jan 22 2026 11:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LLM的狂风已经吹了几年， 所有人都耳濡目染的会飚上几句行话/名词。切好你自己有台4070的机器，恰好你有时间倒腾， 那就让我们回顾一遍名词，验证狂风吹过的技术车辙。</p>
<p>恰好最近有台4070(12g显存)机器，于是尝试使用ollama部署大模型。</p>
<blockquote>
<p>RTX 4070 擅长训练中小型模型；凭借其 184 个 Tensor Core，它可以高效处理矩阵乘法等运算，这对于深度学习任务至关重要。<br/>
RTX 4070 适用于实时推理应用，提供快速的推理速度，使其成为聊天机器人和推荐系统等交互式 AI 应用的理想选择。</p>
</blockquote>
<p>本次会用到3个名词</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.baeldung.com%2Flinux%2Fnvidia-smi-full-gpu-details" title="https://www.baeldung.com/linux/nvidia-smi-full-gpu-details" target="_blank" ref="nofollow noopener noreferrer">nvidia-smi</a> 英伟达设备管理工具</li>
</ol>
<p>基于nvidia managemant library（NVML）之上的命令行工具，用于管理和监控nvidia GPU设备， 随显示驱动一起分发。</p>
<p>以下是未部署大模型时候的资源消耗快照， nvidia-smi  -l 可持续监控gpu使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b45ffe0dce6341e3950515f77ae3af32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=sGQ2QxL3TuvFugEjTR7O2HD8lQM%3D" alt="" loading="lazy"/></p>
<ul>
<li>第一行显示了nvidia-smi版本/驱动版本/<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2FCUDA%23%25E7%25B0%25A1%25E4%25BB%258B" title="https://zh.wikipedia.org/wiki/CUDA#%E7%B0%A1%E4%BB%8B" target="_blank" ref="nofollow noopener noreferrer">CUDA</a>版本</li>
<li>0 表示nvidia 4070是第一张显卡， 索引的概念，下面的进程关联了这块显卡0</li>
<li>Fan Temp Perf Pwr 分别显示GPU的当前风扇转速、温度、性能状态和功耗</li>
<li>Memory-Usage  当前显存使用量和总显存(12g)</li>
<li>GPU_Util 显示当前GPU计算能力的百分比</li>
<li>Compute M 表示当前计算模型： compute</li>
</ul>
<ol start="2">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ollama.com%2F" title="https://docs.ollama.com/" target="_blank" ref="nofollow noopener noreferrer">ollama</a></li>
</ol>
<p>ollama是mata开源的，定位是<strong>模型管理器</strong>和<strong>推理框架</strong>，帮助用户傻瓜式在本地、k8s集群、虚拟机上部署开源大模型。</p>
<p><code>ollama -h</code>提供了可用命令，也显示了可用的能力：创建模型、管控部署模型。</p>
<p>ollama是服务端-客户端架构，有后台服务进程olllama.exe，提供了GUI终端和命令行工具可交互，另外提供sdk和restful api，可供各种程序或者语言操作ollama。</p>
<pre><code class="hljs language-makefile" lang="makefile"> ollama  list
NAME                      ID              SIZE      MODIFIED
<span class="hljs-section">qwen3-embedding:latest    64b933495768    4.7 GB    15 hours ago</span>
<span class="hljs-section">qwen3:8b                  500a1f067a9f    5.2 GB    23 hours ago</span>

<span class="hljs-comment">##  size 是预估的显存大小</span>
</code></pre>
<p>3.  qwen3:8b  vs   qwen3-embedding</p>
<p>8b表示80亿参数（8 Billion parameters）</p>
<p>除了chat模型， 还有嵌入模型embedding， 嵌入模型是将<strong>文本/image数据向量化</strong>的最新手段。</p>
<hr/>
<p>下载完ollama， 选择<code>qwen3:8b</code>大模型，开始下载模型。</p>
<h3 data-id="heading-0">1.  ollama run qwen3:8b</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">ollama  run  qwen3:8b</span>
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; Send a message (/? <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>)</span>
</code></pre>
<p>运行千问大模型（未进行首次推理请求）， 显存和GPU使用率未发生变化；
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8a6b93ad51340cda714aaa73f36d8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=wOKFnW1qUQ%2FRK3Q5CcPJfdYW5Us%3D" alt="" loading="lazy"/></p>
<p>首次推理请求， 显存使用稳定在6g, gpu使用率上升，推理结束，显存使用率不会降， gpu使用率回落， 说明ollama是<strong>按需加载大模型</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/195c8d153de74442901102fe715273b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=E%2BOkgCf0o%2FFabuPiMadvxVjVq1M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">2. ollama run  [model]  vs  ollama  serve</h3>
<p>ollama serve意味着<strong>启动ollama作为web服务</strong>(不意味着当前启动了大模型)，默认在<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A11434%2F%25E7%259B%2591%25E5%2590%25AC%25EF%25BC%258C%25E5%25A4%2596%25E9%2583%25A8%25E5%258F%25AF%25E4%25BD%25BF%25E7%2594%25A8restful" target="_blank" title="http://127.0.0.1:11434/%E7%9B%91%E5%90%AC%EF%BC%8C%E5%A4%96%E9%83%A8%E5%8F%AF%E4%BD%BF%E7%94%A8restful" ref="nofollow noopener noreferrer">http://127.0.0.1:11434/监听，外部可使用restful</a> api或者client sdk操作ollama、操作模型、与模型对话。</p>
<pre><code class="hljs language-swift" lang="swift">curl http:<span class="hljs-comment">//localhost:11434/api/chat -d '{</span>
  <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3:8b"</span>,
  <span class="hljs-string">"messages"</span>: [{
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello there!"</span>
  }],
  <span class="hljs-string">"stream"</span>: <span class="hljs-literal">false</span>
}'
{<span class="hljs-string">"model"</span>:<span class="hljs-string">"qwen3:8b"</span>,<span class="hljs-string">"created_at"</span>:<span class="hljs-string">"2026-01-21T07:57:52.9621534Z"</span>,<span class="hljs-string">"message"</span>:{<span class="hljs-string">"role"</span>:<span class="hljs-string">"assistant"</span>,<span class="hljs-string">"content"</span>:<span class="hljs-string">"Hello! How can I assist you today? 😊"</span>,<span class="hljs-string">"thinking"</span>:<span class="hljs-string">"Okay, the user greeted me with <span class="hljs-subst">\"</span>Hello there!<span class="hljs-subst">\"</span> So I need to respond in a friendly and welcoming manner. Let me make sure to acknowledge their greeting and offer assistance. I should keep it simple and positive. Maybe something like, <span class="hljs-subst">\"</span>Hello! How can I assist you today?<span class="hljs-subst">\"</span> That sounds good. Let me check if there's anything else I need to consider. No, that should cover it. Ready to respond.<span class="hljs-subst">\n</span>"</span>},<span class="hljs-string">"done"</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">"done_reason"</span>:<span class="hljs-string">"stop"</span>,<span class="hljs-string">"total_duration"</span>:<span class="hljs-number">1535352700</span>,<span class="hljs-string">"load_duration"</span>:<span class="hljs-number">98539300</span>,<span class="hljs-string">"prompt_eval_count"</span>:<span class="hljs-number">13</span>,<span class="hljs-string">"prompt_eval_duration"</span>:<span class="hljs-number">208148700</span>,<span class="hljs-string">"eval_count"</span>:<span class="hljs-number">101</span>,<span class="hljs-string">"eval_duration"</span>:<span class="hljs-number">1223840500</span>}
</code></pre>
<p>这个restful api启动了大模型，且是按需加载，  <code>stream: true</code> 就会按照streaming输出， 也就是走chunked transfer encoding watch机制。"think":默认为true表示输出推理思考。</p>
<h3 data-id="heading-2">3. ollama部署embeddings嵌入模型</h3>
<p>eembeddings嵌入模型不同于对话模型，用于将文本/imgae向量化，用于语义搜索、检索和RAG。这里有最新的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2Fmteb%2Fleaderboard" title="https://huggingface.co/spaces/mteb/leaderboard" target="_blank" ref="nofollow noopener noreferrer">嵌入模型榜单</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2ba73bffdd44d8a78ee43c5a585dfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=WiKmmLDyLVdRUQdfYev02magAYA%3D" alt="" loading="lazy"/>
<strong>RAG 技术本质上是将Prompt增强</strong>技术， 本次利用ollama部署文本嵌入模型，提前将文本数据向量化后，存储在向量数据库。</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -X POST http:<span class="hljs-comment">//localhost:11434/api/embed \
  -H "Content-Type: application/json" \
  -d '{</span>
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3-embedding"</span>,
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"The quick brown fox jumps over the lazy dog."</span>
  }'
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4260396194e3461997f3dedc3ccde11c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=Qsz4T8YMsQoM5lbBPFD4X1Kzj48%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">4. function calling</h2>
<p><code>what is  the temperature in the capital of china today?</code></p>
<p>LLM是静态知识，他肯定不知道今天是几号？今天天气怎么样 ？
他的静态知识告诉他中国首部是北京(如果换首都，他也G了)。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/329c3346db1e42159fb886dfb7eca375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=U4QybQ4SxpAB0ooilNCnxqx14Rs%3D" alt="" loading="lazy"/></p>
<p><strong>function calling允许模型调用外部工具并将其结果合并到对话响应中</strong></p>
<blockquote>
<p>无论是agentic开发，使用LLM APi， 理解function calling 都很重要，特别是底层的请求和响应payload工作方式。function calling需要结合应用能力一起来理解。</p>
</blockquote>
<p>function calling 使得LLM具备推理出你想要做的动作(以结构化json的方式给出), app据此执行动作，将调用的结果合并到LLM的输出应答里面。</p>
<p>询问中国首都今天的气温？：</p>
<p>LLM角度：</p>
<ul>
<li>先要要知道今天是几号， 提示应用去调用函数get_currentDate拿到时间</li>
<li>然后拿city= beijing ,date=2016-01-22 去调用天气函数get_temperature(string city， string date)</li>
<li>因为信息充足，对话中问类似的都能笑纳。</li>
</ul>
<p>应用角度：需要提供2个函数</p>
<ul>
<li>get_temperature(string city， string date)： Get the current temperature for a city</li>
<li>get_currentDate()： Get the current date</li>
</ul>
<hr/>
<h4 data-id="heading-4">① LLM发起第一次function calling, <code>tools</code>配置节携带了应用提供的2个外部调用函数。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1f5014791f44c0ab0e98e0f0930bacf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=k16%2FfhLKp%2Bt1Nj8%2BEfUn5xKSNU0%3D" alt="" loading="lazy"/></p>
<p>LLM推理提示应用去调用<code>get_currentDate</code>函数。</p>
<h4 data-id="heading-5">② 应用拿这个推理信息，去调用准备好的get_currentDate函数，假设结果是<code>2026-01-22</code>。</h4>
<h4 data-id="heading-6">③ LLM发起第二次function calling，此时<code>message</code>配置节要附带第一次外部调用的信息</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d6f1e58cfbd4e1392eacefeec717498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=CyYT9MT56y7NeypuYkeoDbeHkXM%3D" alt="" loading="lazy"/></p>
<p>LLM推理提示应用去调用<code>get_temperature</code>函数，此时参数都已经就绪了：beijing是推理已知，2026-01-22是外部调用注入信息。</p>
<h4 data-id="heading-7">④ 应用拿到推理信息，去调用<code>get_temperature</code>函数， 假设拿到结果是22°。</h4>
<h4 data-id="heading-8">⑤ 向LLM发起最终天气对话，喂给他所有信息</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">  curl -s http://localhost:<span class="hljs-number">11434</span>/api/chat -H <span class="hljs-string">"Content-Type: application/json"</span> -d <span class="hljs-comment">'{</span>
  <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3:8b"</span>,
  <span class="hljs-string">"messages"</span>: [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"what is the temperature in the capital of china today?"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>,<span class="hljs-string">"tool_calls"</span>:[{<span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,<span class="hljs-string">"function"</span>:{<span class="hljs-string">"index"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"get_temperature"</span>,<span class="hljs-string">"arguments"</span>:{
             <span class="hljs-string">"city"</span>: <span class="hljs-string">"Beijing"</span>,
              <span class="hljs-string">"date"</span>: <span class="hljs-string">"2026-01-22"</span> }}}]},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"tool_name"</span>: <span class="hljs-string">"get_temperature"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"22°C"</span>}
  ],
  <span class="hljs-string">"stream"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"think"</span>: <span class="hljs-literal">false</span>
}<span class="hljs-comment">'    // 注入的信息依旧放在`message`配置节。</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2fa56f2fc384c89bd5b6adda43b7d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769686289&amp;x-signature=2be4UeomsSNJ88ZpO7kd2LooB58%3D" alt="" loading="lazy"/>
模型就收到的外部调用的信息，并集成到自己推理系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从古法编程到 AI Coding】用 Vue Skills 教 AI 写代码]]></title>    <link>https://juejin.cn/post/7598057199962112051</link>    <guid>https://juejin.cn/post/7598057199962112051</guid>    <pubDate>2026-01-22T11:52:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598057199962112051" data-draft-id="7597764707034939443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从古法编程到 AI Coding】用 Vue Skills 教 AI 写代码"/> <meta itemprop="keywords" content="前端,人工智能,Trae"/> <meta itemprop="datePublished" content="2026-01-22T11:52:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="pany"/> <meta itemprop="url" content="https://juejin.cn/user/2041120304148845"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从古法编程到 AI Coding】用 Vue Skills 教 AI 写代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041120304148845/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    pany
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T11:52:21.000Z" title="Thu Jan 22 2026 11:52:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>简介：AI Coding 过程中沉淀的知识、技巧和感悟形成的零基础手摸手教程</p>
<p>作者：pany</p>
</blockquote>
<h2 data-id="heading-0">关于本专栏</h2>
<p><a href="https://juejin.cn/column/7596687515030192154" target="_blank" title="https://juejin.cn/column/7596687515030192154">从古法编程到 AI Coding</a> 专栏将用真实的开源项目实践演示，渐进式的带你的入门 AI Coding，从编程思维的转变、到 AI 辅助编程、再到 AI 结对编程、最后到 Vibe / Spec 编程，并且中间也会穿插着各种新工具的介绍与使用！</p>
<h2 data-id="heading-1">Skills</h2>
<p>这是体感上继 MCP 之后，又一个爆火的技术。那么它到底是什么东西呢？它和大模型、Agent、MCP 有什么关系呢？</p>
<p>一句话解释就是：<strong>大模型类似大脑（会思考、理解、规划），Agent 是手（能根据意图主动行动），MCP 是手部的神经网络（能获取到外界信息，比如温度），Skills 是长期训练形成的手部肌肉记忆和技能。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a91541ba18db4debb826e9ec35d98202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769687541&amp;x-signature=fEx5THNnpwHiQATkfC7aSK8hf2g%3D" alt="" loading="lazy"/></p>
<p>换句话说，你可以将你编码的一些最佳实践封装为一个 Skills，用这个 Skills 来指导 AI 进行工作！</p>
<h2 data-id="heading-2">是更强的规则</h2>
<p>听上去是不是有点像 Rules？Rules 也是提前写一个 .md 文件来指挥 AI 工作。但是 Skills 可比 Rules 强大的多！</p>
<p>因为它自带很强的能力：</p>
<ul>
<li><strong>按需加载</strong>：元数据 —&gt; 完整指令 —&gt; 参考资料</li>
<li><strong>自带脚本</strong></li>
</ul>
<p>有按需加载的能力也就意味着你可以封装很多参考资料进去，是不会默认加载它们的占用你的上下文的。</p>
<p>脚本的能力也能减少上下文的占用，AI 可以直接运行 Skills 中的脚本文件，而不去读取它的内容。</p>
<p>并且这些过程都是不需要 MCP 参与进来的！所以可以期待一下，以前用 MCP 实现的一些能力在 Skills 上得到更强大的表现。</p>
<h2 data-id="heading-3">Vue Skills</h2>
<p><strong>Vue Skills 顾名思义，就是 Vue 的最佳实践</strong>。如果说 Vue 官网是教你写代码，那么 Vue Skills 就是教 AI 写代码！</p>
<p><em>目前该仓库处于实验阶段，大家可以抱着尝鲜态度体验一下。</em></p>
<p>目前该仓库涉及到的规则已经包括了很多重要的模块，比如：</p>
<ol>
<li>Vue3</li>
<li>Pinia</li>
<li>Router</li>
<li>CSS</li>
<li>Volar</li>
</ol>
<h2 data-id="heading-4">如何使用它？</h2>
<h3 data-id="heading-5">1. AI Coding 工具</h3>
<p>基于 Cursor、TRAE、Claude Code 等这些工具都可以！</p>
<h3 data-id="heading-6">2. 安装</h3>
<pre><code class="hljs language-bash" lang="bash">npx add-skill hyf0/vue-skills
</code></pre>
<p>其中 add-skill 提供 cli 能力，hyf0/vue-skills 才是我们要下载的技能包。</p>
<h3 data-id="heading-7">3. 选择</h3>
<p>后面就是在控制台根据实际情况，不停的做选择题即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe5420cd0644179ac75f51492287a17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769687541&amp;x-signature=hgpI0Am%2FDcM9NwY4NgJ5r4VQuCE%3D" alt="image.png" loading="lazy"/></p>
<p>做完以后就会在你的项目中对应的目录里新增 Vue Skills 相关的配置文件了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7eff9ebb35455288a7e07ea96cc5f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769687541&amp;x-signature=2KNspMMf9XvzN7bO7vXLN1Td06g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">4. 识别</h3>
<p>AI Coding 工具默认会自动识别新增的 Skills！所以这一步并不需要我们做什么。我们到这里以后，就可以想往常一样和 AI 对话了。</p>
<p>这时候的 AI 就会自动先学习 Skills 中的内容再给你答复了。</p>
<h2 data-id="heading-9">最后</h2>
<p>Skills 确实是一个不亚于当时 MCP 的一个新能力，相信大家以后也会在社区看见各种各样的 xxx-skills 包出现！而且 Skills 的出现让 AI 写代码的能力更强了一点，同时也让我们写代码的姿势又变了一点！</p>
<p><em>Vue Skills 开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhyf0%2Fvue-skills" target="_blank" title="https://github.com/hyf0/vue-skills" ref="nofollow noopener noreferrer">github.com/hyf0/vue-sk…</a></em></p>
<h2 data-id="heading-10">关注</h2>
<p>及时获取后续的文章更新 👇🏻</p>
<ul>
<li>公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzE5MTYyOTQxNQ%3D%3D%26action%3Dgetalbum%26album_id%3D4350407594377658379%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzE5MTYyOTQxNQ==&amp;action=getalbum&amp;album_id=4350407594377658379#wechat_redirect" ref="nofollow noopener noreferrer">前往合集</a> 或关注作者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fuser-attachments%2Fassets%2F529bac73-f9e3-4311-94d0-3db57216b771" target="_blank" title="https://github.com/user-attachments/assets/529bac73-f9e3-4311-94d0-3db57216b771" ref="nofollow noopener noreferrer">PanyCoding</a></li>
<li>掘金：<a href="https://juejin.cn/column/7596687515030192154" target="_blank" title="https://juejin.cn/column/7596687515030192154">前往专栏</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解Semaphore的基本用法]]></title>    <link>https://juejin.cn/post/7598024433911054390</link>    <guid>https://juejin.cn/post/7598024433911054390</guid>    <pubDate>2026-01-22T12:03:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598024433911054390" data-draft-id="7597979278240792585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解Semaphore的基本用法"/> <meta itemprop="keywords" content="Java,面试,架构"/> <meta itemprop="datePublished" content="2026-01-22T12:03:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解Semaphore的基本用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T12:03:21.000Z" title="Thu Jan 22 2026 12:03:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>我们今天一起来了解一下JUC的同步工具类-Semaphore的基本用法。</p>
<h2 data-id="heading-1">什么是Semaphore(信号量)</h2>
<p><strong>Semaphore (信号量)</strong> 是 <code>java.util.concurrent</code> 包下非常有用的一个并发工具类。你可以把它理解为<strong>用于控制同时访问特定资源的线程数量</strong>的工具。它维护了一组“许可”（permits），线程在访问受保护资源前必须先获取一个许可，使用完后再释放该许可。</p>
<h3 data-id="heading-2">场景引入</h3>
<p>想象一个只有 5 个车位的停车场（共享资源）：</p>
<ol>
<li><strong>Permits (许可证/令牌)：</strong> 初始化时，Semaphore 拥有 5 个令牌。</li>
<li><strong>Acquire (获取)：</strong> 车辆（线程）进入时，先领 1 个令牌。如果没有令牌了（计数为0），车辆就得在门口排队（阻塞）。</li>
<li><strong>Release (释放)：</strong> 车辆离开时，归还 1 个令牌。此时如果有排队的车辆，就会唤醒其中一个进入。</li>
</ol>
<p>这就是Semaphore做的事，控制在一个时间段内可以访问特定资源的线程数量。</p>
<h3 data-id="heading-3">基本概念</h3>
<ul>
<li><strong>许可（Permit）</strong> ：Semaphore 内部维护一个计数器，表示当前可用的许可数量。</li>
<li><strong>acquire()</strong> ：尝试获取一个或多个许可。如果没有足够许可，线程会被阻塞，直到有足够许可可用。</li>
<li><strong>release()</strong> ：释放一个或多个许可，增加可用许可数量，可能唤醒等待中的线程。</li>
</ul>
<h3 data-id="heading-4">底层原理</h3>
<p>Semaphore 内部基于 <strong>AQS (AbstractQueuedSynchronizer)</strong> 实现。</p>
<ul>
<li>它使用 AQS 的 <code>state</code> 变量来存储当前的许可证数量。</li>
<li><code>acquire()</code> 操作是对 <code>state</code> 进行 CAS 减法。</li>
<li><code>release()</code> 操作是对 <code>state</code> 进行 CAS 加法。</li>
</ul>
<h3 data-id="heading-5">常用方法</h3>
<p>下面是Semaphore的常用方法。</p>


















































<table><thead><tr><th><strong>方法</strong></th><th><strong>描述</strong></th><th><strong>场景</strong></th></tr></thead><tbody><tr><td><code>new Semaphore(int permits)</code></td><td>创建非公平信号量（默认）。</td><td>吞吐量优先</td></tr><tr><td><code>new Semaphore(int permits, boolean fair)</code></td><td>创建公平信号量（FIFO）。</td><td>避免线程饥饿</td></tr><tr><td><code>acquire()</code></td><td>获取1个许可，若无则阻塞。响应中断。</td><td>必须拿到的场景</td></tr><tr><td><code>acquire(int n)</code></td><td>一次获取 n 个许可。</td><td>批量资源</td></tr><tr><td><code>tryAcquire()</code></td><td>尝试获取，成功返回 true，失败返回 false，<strong>不阻塞</strong>。</td><td>快速失败/降级处理</td></tr><tr><td><code>tryAcquire(long timeout, TimeUnit unit)</code></td><td>带超时的尝试获取。</td><td>避免长时间死等</td></tr><tr><td><code>release()</code></td><td>释放1个许可。</td><td><strong>务必在 finally 中调用</strong></td></tr><tr><td><code>void release(int permits)</code></td><td>释放指定数量许可。</td><td><strong>务必在 finally 中调用</strong></td></tr></tbody></table>
<h2 data-id="heading-6">使用例子</h2>
<p>这是最典型的使用场景：<strong>限流 (Rate Limiting)</strong> 或 <strong>资源池控制</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.Semaphore;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreExample</span> {

    <span class="hljs-comment">// 定义一个只能允许3个线程同时访问的信号量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">3</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

        <span class="hljs-comment">// 模拟10个请求同时涌入</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadNum</span> <span class="hljs-operator">=</span> i;
            executor.execute(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 1. 获取许可 (如果拿不到，这里会阻塞)</span>
                    <span class="hljs-comment">// 也可以使用 tryAcquire() 来进行非阻塞尝试</span>
                    semaphore.acquire(); 
                    
                    System.out.println(<span class="hljs-string">"线程 "</span> + threadNum + <span class="hljs-string">" 拿到了令牌，正在处理业务..."</span>);
                    <span class="hljs-comment">// 模拟业务耗时</span>
                    TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>); 
                    
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 2. 关键：一定要在 finally 中释放许可！</span>
                    System.out.println(<span class="hljs-string">"线程 "</span> + threadNum + <span class="hljs-string">" 处理完毕，归还令牌 ---"</span>);
                    semaphore.release(); 
                }
            });
        }
        executor.shutdown();
    }
}
</code></pre>
<p>一般使用场景有这些，特别是框架特别喜欢用：</p>
<ul>
<li>数据库连接池（限制最大连接数）</li>
<li>线程池任务提交限流</li>
<li>文件读写并发控制</li>
<li>服务接口的 QPS 限流</li>
</ul>
<h2 data-id="heading-7">平时使用的坑你要注意</h2>
<p><strong>场景 A：公平性 (Fairness)</strong></p>
<p><code>new Semaphore(3, true)</code> 会保证等待最久的线程最先拿到令牌。</p>
<ul>
<li><strong>优点：</strong> 避免线程饥饿。</li>
<li><strong>缺点：</strong> 性能较差（因为要维护严格的队列顺序，增加了上下文切换开销）。通常后端高并发场景默认使用<strong>非公平</strong>模式以换取吞吐量。</li>
</ul>
<p><strong>场景 B：初始化为 0</strong></p>
<p>Semaphore 不一定要初始化为正数。如果你初始化为 <code>new Semaphore(0)</code>：</p>
<ul>
<li>线程 A 调用 <code>acquire()</code> 会立刻阻塞。</li>
<li>直到线程 B 调用 <code>release()</code>，线程 A 才会继续执行。</li>
<li><strong>用途：</strong> 这种模式类似 <code>CountDownLatch</code> 或 <code>Exchanger</code>，用于线程间的<strong>单次信号通知</strong>。</li>
</ul>
<p><strong>常见坑</strong></p>
<ol>
<li><strong>忘记 Release：</strong> 如果在异常发生前没有释放，或者没写在 <code>finally</code> 块中，在这个 JVM 进程重启前，那个令牌就永久丢失了（类似内存泄漏），最终导致所有线程阻塞。<strong>所以千万要记住，写release在finally块</strong>！！</li>
<li><strong>Release 滥用：</strong> <code>release()</code> 只是简单地将计数器 +1。如果你在没有 <code>acquire</code> 的情况下错误地调用了多次 <code>release()</code>，信号量的许可证数量会超过初始值（比如变成 5+1 = 6），导致限流失效。</li>
</ol>
<h2 data-id="heading-8">和平时的ReentrantLock / synchronized 的区别</h2>
<p>使用用途和目的是它们最大的区别。</p>

























<table><thead><tr><th>特性</th><th>synchronized / ReentrantLock</th><th>Semaphore</th></tr></thead><tbody><tr><td>控制粒度</td><td>一次只允许一个线程进入临界区</td><td>可允许多个线程（≤许可数）同时进入</td></tr><tr><td>是否可重入</td><td>是（ReentrantLock）</td><td>否（许可不属于特定线程）</td></tr><tr><td>主要用途</td><td>互斥访问</td><td>资源池、限流、并发控制</td></tr></tbody></table>
<p>那么使用自定义计时器+锁+唤醒等待机制也是可以实现Semaphore一样的功能，但是没必要，还容易出错。不如直接使用Semaphore。</p>
<h2 data-id="heading-9">总结</h2>
<p>Semaphore就是用来限制同时访问统一资源的工具。</p>
<p>除了平时开发使用到Semaphore，我们平时面试做有关于多线程的算法题也有可能用到噢，所以还是非常有必要熟悉Semaphore的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面向多租户云的 IO 智能诊断：从异常发现到分钟级定位]]></title>    <link>https://juejin.cn/post/7598005428259192895</link>    <guid>https://juejin.cn/post/7598005428259192895</guid>    <pubDate>2026-01-22T10:08:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428259192895" data-draft-id="7598005428259061823" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面向多租户云的 IO 智能诊断：从异常发现到分钟级定位"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T10:08:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面向多租户云的 IO 智能诊断：从异常发现到分钟级定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:08:01.000Z" title="Thu Jan 22 2026 10:08:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：肖振威</p>
<h2 data-id="heading-0">背景</h2>
<p>随着云端业务规模的持续扩大，AI 训练数据、实时日志与多媒体资料等数据量呈现指数级增长，云存储因此逐渐成为主流选择，同时也带来了 I/O 请求量的快速上升。在共享式的多租户架构中，多个租户共同使用底层存储资源，高并发访问极易引发 I/O 资源争抢与性能瓶颈。此外，混合云与多云部署日益普及，数据在多个云环境之间频繁流动，而不同云服务商在存储策略与监控机制上的不一致，使得 I/O 类故障的定位与追溯变得更加复杂。为提升此类问题的处理效率，阿里云云监控 2.0 结合 SysOM 智能诊断功能围绕常见的 I/O 异常场景，构建了一套覆盖“异常检测—根因分析—修复建议”全链路的 I/O 一键诊断功能。</p>
<h2 data-id="heading-1">业务痛点解析</h2>
<h3 data-id="heading-2">痛点一：用户难以准确判断 IO 异常类型</h3>
<p>大多数用户对 IO 问题的具体类型缺乏清晰认知，例如往往搞不清当前是 IO 延迟升高、IO 吞吐被打满，还是其它类型的异常，导致很难主动选用对应的排障工具和方法，只能依靠运维专家介入排查，整体诊断效率偏低，人力投入也随之增加。IO 一键诊断聚焦 IO 延时偏高、流量异常、iowait 居高不下等高频场景，自动捕捉 IO 子系统的异常特征，帮助用户快速完成问题类型的判定。</p>
<h3 data-id="heading-3">痛点二：异常发生瞬间难以“抓现场”，取证不充分</h3>
<p>传统监控系统通常只采集操作系统层面的通用 IO 指标，比如 await、util、tps、bps 等，并以指标突变作为告警条件。然而，当指标被检测到异常时，真实问题往往已经发生甚至结束，此时再想获取更细致的采样和上下文信息，往往为时已晚，关键线索已经流失，难以形成完整的诊断证据链。要做到有效定位，就必须尽可能在异常刚出现或仍在持续时就触发针对性采集，因此，快速识别并及时行动，是获取最佳诊断数据的关键。</p>
<h3 data-id="heading-4">痛点三：指标体系割裂，监控数据与诊断结论之间缺乏直连</h3>
<p>现有监控往往仅提供一组相互独立的指标，彼此缺乏联动，也没有与具体 IO 故障类型建立直观映射。以 util（磁盘繁忙度）偏高为例，实际分析时还需参考 await 等多项指标，并结合设备的理论 iops、bps 上限进行综合判断。即便勉强推断出问题类型，接下来仍离不开对各种诊断工具的经验性操作，包括如何按照指标数值选择合适的采样区间、参数配置等。IO 一键诊断的设计目标，就是将这一串复杂的关联分析与工具选型过程封装在系统内部，对用户直接呈现整理好的诊断报告和结论。</p>
<h2 data-id="heading-5">解决方案</h2>
<h3 data-id="heading-6">架构介绍</h3>
<p>在阿里云云监控 2.0 中，SysOM 管控模块原本就支持对 IO 延迟异常、IO 量异常以及 iowait 高等问题开展诊断。不过，大部分客户并不希望在业务环境上长时间运行高频诊断程序，以免对生产带来干扰。因此，IO 一键诊断采用了“监控先行、按需抓取”的架构：在用户指定的诊断时间段内，系统定期读取 IO 监控指标，用于异常识别与问题圈定，一旦满足条件，再触发具体的子诊断工具进行深度分析并输出报告，构成一个从发现到定位的闭环流程。</p>
<p>考虑到不同业务类型对 IO 行为和性能阈值的容忍度不尽相同，如果强行规定统一的固定阈值，势必会导致误报大量增加或严重漏报。因此，IO 一键诊断引入“动态阈值”机制进行异常识别，其总体处理链路可以概括为：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d5a56631f824198a7be17e985b405fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=ThviYDJpjxkflMtI5t3h7DsWP60%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>指标采集：</strong> 定期从系统中抓取关键 IO 指标，如 await、util、tps、iops、qu-size、iowait 等。</li>
<li><strong>异常检测：</strong> 当采集到的指标突破动态阈值，就将其标记为潜在异常。动态阈值的计算方法是整个检测环节的核心，后文会展开说明。</li>
<li><strong>自动诊断触发：</strong> 依据异常的指标类型与特征，自动选择合适的诊断工具，并设置触发频率限制，避免频繁调用。</li>
<li><strong>结果处理与展示：</strong> 对诊断输出进行归纳和可视化呈现，为用户提供导致问题的根本原因以及可执行的优化建议。</li>
</ul>
<h3 data-id="heading-7">实现原理</h3>
<h4 data-id="heading-8">指标采集机制</h4>
<p>当用户在控制台启动 IO 一键诊断后，系统会按配置好的时间间隔（cycle 毫秒）循环读取 iowait、iops、bps、qusize、await、util 等一系列 IO 指标，并在每个周期对最新采集的数据做异常检测判断。</p>
<p><strong>动态阈值计算</strong></p>
<p>为了能在秒级甚至更细粒度下捕获 IO 突发、短时抖动等异常，必须将各类单一 IO 指标联动起来，从整体上刻画 IO 子系统的“正常波动区间”。动态阈值就是用来界定这一“正常区间”和“异常尖峰”的边界。其计算过程主要分为三层：基础阈值、补偿阈值和最小静态阈值。</p>
<p>基础阈值：刻画整体波动幅度</p>
<p>从时间序列的角度看，IO 指标在大多数时刻处于平稳运行状态，曲线起伏较小；当出现异常负载或者突发流量时，曲线会突然出现明显偏离均值的峰值。因此，首要任务是利用基础阈值，找出这些显著高于日常波动的“尖峰”。</p>
<p>实现策略是：使用一个滑动时间窗口持续观察数据点，在每个窗口中计算所有点相对于窗口平均值的“最大偏离量”，把这个偏离量记为该窗口的“瞬时波动值”；随后对连续多个窗口的“瞬时波动值”求平均，形成动态更新的“基础阈值”。随着新数据不断进入，该阈值也会自适应地调整，始终反映 IO 指标近期的真实波动特征。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c72adeec439a41e4acdaceace90b549a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=rpWxqBWfD4BJoS27NPlBFO2hFnE%3D" alt="图片" loading="lazy"/></p>
<p>补偿阈值：削弱基础阈值快速下降带来的误报</p>
<p>基础阈值曲线（如示意图中的黄色线条）虽然能够反映指标的总体波动情况，但在系统处于稳定期时，IO 指标通常只在很窄的一段区间内轻微波动，此时基础阈值可能随波动减弱而快速下降，容易让一些微小的正常抖动被误判为异常。因此，需要额外引入一个“补偿阈值”，叠加在基础阈值之上，对其下降速度进行一定缓冲，从而抑制误报。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/716e150f910e4e0ea14dceb9e86a2bb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=bKpgToZBbtWWBzgN7k1zddi8DPw%3D" alt="图片" loading="lazy"/></p>
<p>具体逻辑是：当系统监测到基础阈值在一段时间内持续走低，可以认为当前进入了相对“安静”的常态阶段。此时先过滤明显噪声点，再在剩余的稳定数据里计算一个“常稳态补偿值”，以刻画这类稳定状态下的细小波动。补偿值尚未收敛前，先用当前窗口内出现过的最大基础阈值暂时代替，并在每个新窗口开始时重新计算。一旦基础阈值停止下降或开始回升，就意味着系统波动模式发生了变化，此时补偿机制会被重置，重新进入更宏观的观察期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18526336afc1487f9b781347020322aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=4FLymR36iFCJw8Rs6WV6eXr6jdk%3D" alt="图片" loading="lazy"/></p>
<p>最小阈值：兜底的静态门槛</p>
<p>最小静态阈值可以理解为预先设定的“绝对下限”，是业务方能接受的最低告警基线。最终用于判定异常的阈值，是“最小静态阈值”和“动态调整阈值（基础阈值 + 补偿值）”之间的较大者。只有当指标既超过了日常波动的正常范围，又突破了业务底线时，才真正被视为异常事件。</p>
<p>此外，如果指标本身已经明显高于“最小静态阈值”，则无需再额外叠加常态补偿值，此时仅以基础阈值作为判断依据即可，将分析重点聚焦在更显著的异常波动上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d8f65498bf4bb3bb447d4bfb704f9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=osvU4cvf0vm0RNi0w12%2FRGTdp7w%3D" alt="图片" loading="lazy"/></p>
<p><strong>异常识别策略</strong></p>
<p>在运行时，一旦采集到的某项 IO 指标值高于其对应的动态阈值，即可认为存在异常风险。虽然不同指标（如 iowait、util、iops 等）的判定逻辑略有差异，但整体遵从以下共通规则：</p>
<ul>
<li><strong>确定告警基线：</strong> 为每一类指标定义一条“警戒线”，其数值为“最小静态阈值”和“动态阈值”中的最大值，既考虑业务底线，也考虑历史波动范围。</li>
<li><strong>决定是否触发诊断：</strong> 当监控值超过警戒线，同时满足一定的监测条件（如持续时间、触发次数等），就可以启动对应的诊断流程。</li>
<li><strong>持续更新模型：</strong> 随着新数据不断加入，动态阈值会被持续修正，使其适配当前环境的正常波动模式，而非依赖一次性的静态配置。</li>
</ul>
<p><strong>智能诊断与频率控制</strong></p>
<p>当系统确认存在 IO 异常后，一键诊断模块会自动调用相应的分析工具，抓取关键现场信息并进行自动化处理，帮助用户快速锁定问题。为避免过于频繁的诊断操作影响业务，系统通过以下两个参数对诊断频率进行约束：</p>
<ul>
<li><strong>诊断冷静期（triggerInterval）：</strong> 规定两次诊断之间必须间隔的最短时间，用来避免在短时间内重复对同一类异常进行频繁扫描。</li>
<li><strong>异常累积阈值（reportInterval）：</strong> 设置触发诊断所需的异常累积条件。当该值为 0 时，只要异常满足冷静期结束的条件，就立即启动诊断；当该值为非 0 时，则需要在冷静期之后、限定时间窗口内出现一定次数的异常事件，才会真正触发。</li>
</ul>
<p><strong>根因分析</strong></p>
<p>在完成现场数据采集之后，面对复杂多样的系统信息，如何从中筛选出与当前问题强相关的线索，是传统人工分析的难点。IO 一键诊断在工具层面内置了一套自动分析逻辑，能从采集结果中提炼结论，并以结构化信息的形式反馈给用户，包括但不限于：</p>
<ul>
<li><strong>IO Burst 场景：</strong> 分析在异常时间段内各进程对 IO 的贡献度，在报告中标明最“耗 IO”的进程。对于写 buffer IO 而由内核 kworker 线程负责刷脏的情况，也能追溯到最初发起写入的用户进程。</li>
<li><strong>IO 延迟异常：</strong> 统计并展示异常区间内 IO 延迟的整体分布情况，标记延迟最高的路径（如对应的设备或文件/目录），帮助快速找到性能瓶颈所在。</li>
<li><strong>iowait 异常偏高：</strong> 记录和展示导致 iowait 偏高的关键进程，以及引发大量等待的具体原因（例如磁盘被占满、脏页刷写过慢等）。</li>
</ul>
<h4 data-id="heading-9">案例分析</h4>
<p><strong>iowait 高</strong></p>
<p>在某些场景下，业务反馈系统整体响应慢，通过监控发现 iowait 指标异常升高。借助 IO 一键诊断，可以直接定位到哪一个或哪些进程在大量等待磁盘 IO，以及每个进程累计等待的时间长度，并进一步分析等待背后的原因。</p>
<p>在示例案例中，诊断结果显示：业务写入量过大导致 IO 压力偏高，系统中脏页堆积，最终使业务进程 task_server 长时间阻塞在 IO 等待上。针对这种情况，报告建议谨慎下调 dirty_ratio、dirty_bytes 等内核参数，以减少一次性刷脏量，降低磁盘压力，从而缓解 iowait 过高问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf3a7c013b3243d791cfb3dcc13d6cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=GiQ0ZHq1Atb51V3xiYL5X5QnTD8%3D" alt="图片" loading="lazy"/></p>
<p><strong>IO延迟高</strong></p>
<p>另一类常见问题是写 IO 的延迟持续走高。某用户通过基础监控发现写入延迟异常后，通过 IO 一键诊断进行进一步排查。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8497211679d469baf2eb991301749ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=zr54nYuiNA8x3wqj0c%2F%2BObuC0GY%3D" alt="图片" loading="lazy"/></p>
<p>诊断报告指出，在问题发生期间，DiskBlockWrite 进程是主要的 IO 负载来源，并且耗时主要集中在刷脏阶段，也就是说核心瓶颈在于磁盘将缓存数据落盘的过程。依据这一结论，系统给出两类优化建议：一是调整业务逻辑，减少短时间内大量 buffer IO 的写入；二是通过适当调整 dirty_ratio、dirty_background_ratio 等参数，控制脏页生成和回写的节奏，从系统层面降低写 IO 延迟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/535a4d16b0e145099bded78753a2bed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681281&amp;x-signature=Q6VRMEBr7GGgaKeO2TTkIR9DZdE%3D" alt="图片" loading="lazy"/></p>
<p><strong>相关链接：</strong></p>
<p>[1] IO 一键诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fcms%2Fcloudmonitor-2-0%2Fio-key-diagnosis" target="_blank" title="https://help.aliyun.com/zh/cms/cloudmonitor-2-0/io-key-diagnosis" ref="nofollow noopener noreferrer">help.aliyun.com/zh/cms/clou…</a></p>
<p>[2] 云监控-ECS 洞察-SysOM 系统诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcmsnext.console.aliyun.com%2Fnext%2Fregion%2Fcn-shanghai%2Fworkspace%2Fdefault-cms-1808078950770264-cn-shanghai%2Fapp%2Fhost%2Fhost-sysom" target="_blank" title="https://cmsnext.console.aliyun.com/next/region/cn-shanghai/workspace/default-cms-1808078950770264-cn-shanghai/app/host/host-sysom" ref="nofollow noopener noreferrer">cmsnext.console.aliyun.com/next/region…</a></p>
<p>[3] 操作系统控制台实例纳管</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fsystem-management" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/system-management" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 实战：高效合并多个 Word 文档]]></title>    <link>https://juejin.cn/post/7597973595131019316</link>    <guid>https://juejin.cn/post/7597973595131019316</guid>    <pubDate>2026-01-22T09:55:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597973595131019316" data-draft-id="7597973595130970164" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 实战：高效合并多个 Word 文档"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-22T09:55:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户372157426135"/> <meta itemprop="url" content="https://juejin.cn/user/1250599264325244"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 实战：高效合并多个 Word 文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1250599264325244/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户372157426135
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:55:09.000Z" title="Thu Jan 22 2026 09:55:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在企业开发和日常办公自动化中，我们经常需要处理 Word 文档。例如生成报告、合同、培训资料或批量文档时，往往会遇到需要将多个 Word 文件合并为一个的需求。手动操作不仅耗时，还容易出错，尤其是当文档数量较多或内容复杂时。通过 Java 程序化处理 Word 文档，可以大幅提升效率，同时保证合并后的文档排版一致、结构清晰。</p>
<p>本文将系统讲解在 Java 中合并 Word 文档的常用方法，提供完整示例，帮助你快速掌握文档合并技巧。</p>
<hr/>
<h2 data-id="heading-0">为什么需要合并 Word 文档</h2>
<p>在实际工作中，Word 文档合并的需求主要包括：</p>
<ul>
<li><strong>生成综合报告:</strong> 多个部门或模块生成的 Word 文件，需要合并成一份总文档，便于统一存档或分发。</li>
<li><strong>批量处理文档:</strong> 企业或自动化流程中，需要将大量 Word 文件合并，如果手动操作效率低且容易出错。</li>
<li><strong>统一排版格式:</strong> 合并后的文档可统一页眉页脚、样式和章节格式，保证专业排版和可读性。</li>
</ul>
<p>通过程序化合并 Word 文档，可以避免手动操作，提高效率，并保证多份文档格式一致。</p>
<hr/>
<h2 data-id="heading-1">环境准备</h2>
<p>在开始编程之前，需要准备以下条件：</p>
<ul>
<li><strong>Java 开发环境</strong>（JDK 8 或以上）</li>
<li><strong>Word 文档处理库</strong>：本文示例使用 <strong>Spire.Doc for Java</strong>，它提供了便捷的 API 来操作 Word 文档，包括加载、插入、克隆和保存等功能。</li>
</ul>
<p>Maven 依赖示例：</p>
<pre><code class="hljs language-java" lang="java">&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;com.e-iceblue&lt;/id&gt;
        &lt;name&gt;e-iceblue&lt;/name&gt;
        &lt;url&gt;https:<span class="hljs-comment">//repo.e-iceblue.cn/repository/maven-public/&lt;/url&gt;</span>
    &lt;/repository&gt;
&lt;/repositories&gt;
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;e-iceblue&lt;/groupId&gt;
        &lt;artifactId&gt;spire.doc&lt;/artifactId&gt;
        &lt;version&gt;<span class="hljs-number">14.1</span><span class="hljs-number">.3</span>&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>环境准备好后，即可开始合并 Word 文档。</p>
<hr/>
<h2 data-id="heading-2">示例一：直接插入整个文档</h2>
<p>这种方式适用于快速合并文档。插入的文档会作为 新的 Section 添加，与原文档独立。</p>
<h3 data-id="heading-3">实现步骤</h3>
<ul>
<li>创建 Document 对象并加载第一个 Word 文档。</li>
<li>调用 <code>insertTextFromFile()</code> 方法，将第二个文档整体插入第一个文档中。</li>
<li>保存合并后的文档为新文件。</li>
</ul>
<h3 data-id="heading-4">示例代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.doc.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MergeWord</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建 Document 对象并加载第一个 Word 文档</span>
        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"C:/Samples/Sample1.docx"</span>);

        <span class="hljs-comment">// 将第二个 Word 文档整体插入</span>
        document.insertTextFromFile(<span class="hljs-string">"C:/Samples/Sample2.docx"</span>, FileFormat.Docx_2013);

        <span class="hljs-comment">// 保存合并后的文档</span>
        document.saveToFile(<span class="hljs-string">"MergingResult.docx"</span>, FileFormat.Docx_2013);

        System.out.println(<span class="hljs-string">"文档合并完成！"</span>);
    }
}
</code></pre>
<h3 data-id="heading-5">说明</h3>
<ul>
<li><code>insertTextFromFile()</code> 会将第二个文档作为新的 Section 插入，因此原文档和插入文档的页眉页脚独立。</li>
<li>优点：操作简单，执行速度快。</li>
<li>适用场景：快速生成合并文档，不需要精细控制文档结构。</li>
</ul>
<hr/>
<h2 data-id="heading-6">示例二：按文档结构逐项合并</h2>
<p>在需要保留文档结构或章节连续性的情况下，可以逐项合并内容。新的文档内容会承接在第一个文档末尾，与原文档内容连续。</p>
<h3 data-id="heading-7">实现步骤</h3>
<ul>
<li>创建两个 Document 对象并分别加载两个 Word 文档。</li>
<li>遍历第二个文档的 Section 和 Body 子对象。</li>
<li>将每个 DocumentObject 深度克隆，并添加到第一个文档最后一个 Section 的 Body 中。</li>
<li>保存合并后的文档。</li>
</ul>
<h3 data-id="heading-8">示例代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.doc.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MergeDocuments</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 加载两个 Word 文档</span>
        <span class="hljs-type">Document</span> <span class="hljs-variable">document1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"C:/Samples/Sample1.docx"</span>);
        <span class="hljs-type">Document</span> <span class="hljs-variable">document2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"C:/Samples/Sample2.docx"</span>);

        <span class="hljs-comment">// 遍历第二个文档的 Section</span>
        <span class="hljs-keyword">for</span> (Object sectionObj : (Iterable) document2.getSections()) {
            <span class="hljs-type">Section</span> <span class="hljs-variable">sec</span> <span class="hljs-operator">=</span> (Section) sectionObj;

            <span class="hljs-comment">// 遍历 Section 的 Body 对象</span>
            <span class="hljs-keyword">for</span> (Object docObj : (Iterable) sec.getBody().getChildObjects()) {
                <span class="hljs-type">DocumentObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (DocumentObject) docObj;

                <span class="hljs-comment">// 获取第一个文档的最后一个 Section</span>
                <span class="hljs-type">Section</span> <span class="hljs-variable">lastSection</span> <span class="hljs-operator">=</span> document1.getLastSection();
                <span class="hljs-type">Body</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> lastSection.getBody();

                <span class="hljs-comment">// 深度克隆对象并添加</span>
                body.getChildObjects().add(obj.deepClone());
            }
        }

        <span class="hljs-comment">// 保存合并后的文档</span>
        document1.saveToFile(<span class="hljs-string">"MergingResult.docx"</span>, FileFormat.Docx_2013);

        System.out.println(<span class="hljs-string">"文档按结构合并完成！"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">说明</h3>
<ul>
<li>通过 <strong>深度克隆 DocumentObject</strong>，将第二个文档内容承接在第一个文档末尾，保证章节、段落和表格顺序连续。</li>
<li>优点：保持原文档结构，可在合并过程中进行修改或调整。</li>
<li>注意：页眉页脚可能需要手动调整，如果希望统一样式，可在合并前后设置。</li>
</ul>
<hr/>
<h2 data-id="heading-10">示例三：批量合并多个 Word 文档</h2>
<p>在实际项目中，通常需要合并多个文档，可以通过循环读取文件列表依次插入。</p>
<h3 data-id="heading-11">实现步骤</h3>
<ul>
<li>创建一个 Document 对象，并加载第一个 Word 文档作为基础文档。</li>
<li>通过循环遍历剩余文档列表，使用 <code>insertTextFromFile()</code> 方法依次插入。</li>
<li>保存最终合并的文档。</li>
</ul>
<h3 data-id="heading-12">示例代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.doc.*;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MergeMultiple</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; files = Arrays.asList(
            <span class="hljs-string">"C:/Samples/Sample1.docx"</span>,
            <span class="hljs-string">"C:/Samples/Sample2.docx"</span>,
            <span class="hljs-string">"C:/Samples/Sample3.docx"</span>
        );

        <span class="hljs-type">Document</span> <span class="hljs-variable">resultDoc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(files.get(<span class="hljs-number">0</span>));

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; files.size(); i++) {
            resultDoc.insertTextFromFile(files.get(i), FileFormat.Docx_2013);
        }

        resultDoc.saveToFile(<span class="hljs-string">"MergedAll.docx"</span>, FileFormat.Docx_2013);
        System.out.println(<span class="hljs-string">"批量合并完成！"</span>);
    }
}
</code></pre>
<h3 data-id="heading-13">说明</h3>
<ul>
<li>循环读取文件列表，实现批量合并。</li>
<li>默认每个文件作为新的 Section 插入，如果需要连续内容，可改用按结构克隆的方法。</li>
</ul>
<hr/>
<h2 data-id="heading-14">注意事项</h2>
<ul>
<li><strong>页眉页脚：</strong> 如果合并文档中页眉页脚不同，可能需要手动统一或在程序中设置。</li>
<li><strong>样式和格式：</strong> 深度克隆可以保留段落、表格和样式，但在合并后建议检查文档以确保所有格式符合预期。</li>
<li><strong>文件大小：</strong> 多个大文档合并时，生成文档文件可能较大，请注意内存占用。</li>
</ul>
<h2 data-id="heading-15">总结</h2>
<p>通过本文的示例，我们展示了在 Java 中合并 Word 文档的不同方法，包括将整个文档快速插入、按结构逐项合并，以及批量处理多个文档。这些方法可以根据实际需求灵活选择，无论是快速生成汇总报告，还是保持章节连续性、统一排版风格，都能够有效提升文档处理效率，减少手动操作的工作量，同时确保最终文档的专业性和可读性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三个方法优化JS的setTimeout实现的倒计误差，看完包会！]]></title>    <link>https://juejin.cn/post/7598011274686070784</link>    <guid>https://juejin.cn/post/7598011274686070784</guid>    <pubDate>2026-01-22T09:42:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598011274686070784" data-draft-id="7598011274686054400" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三个方法优化JS的setTimeout实现的倒计误差，看完包会！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T09:42:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三个方法优化JS的setTimeout实现的倒计误差，看完包会！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:42:46.000Z" title="Thu Jan 22 2026 09:42:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你肯定遇到过这种情况。页面上有一个倒计时，显示“距离活动结束还有 10 秒”。你屏住呼吸，准备在最后一刻点击抢购按钮。但奇怪的是，倒计时从 10 跳到 9 时，好像停顿了一下，或者跳得特别快。最终，你点击按钮时，系统提示“活动已结束”。</p>
<p>这不是你的错觉。前端实现的倒计时，确实存在误差。今天，我们就来聊聊这个误差是怎么产生的，以及我们能做些什么来减小它。</p>
<h2 data-id="heading-0">误差从何而来？</h2>
<p>要理解误差，我们得先看看最常见的前端倒计时是怎么工作的。</p>
<h3 data-id="heading-1">1. 核心机制：<code>setInterval</code> 与 <code>setTimeout</code></h3>
<p>大多数倒计时使用 JavaScript 的 <code>setInterval</code> 或递归的 <code>setTimeout</code> 来实现。代码逻辑很简单：</p>
<ol>
<li>设定一个目标时间（比如活动结束时间）。</li>
<li>每秒执行一次函数，计算“当前时间”与“目标时间”的差值。</li>
<li>将这个差值转换成天、时、分、秒，显示在页面上。
看起来天衣无缝，对吗？问题就藏在“每秒执行一次”这个动作里。</li>
</ol>
<h3 data-id="heading-2">2. 误差的三大“元凶”</h3>
<p><strong>元凶一：JavaScript 的单线程与事件循环</strong></p>
<p>JavaScript 是单线程语言。这意味着它一次只能做一件事。<code>setInterval</code> 和 <code>setTimeout</code> 指定的延迟时间，并不是精确的“等待 X 毫秒后执行”，而是“等待至少 X 毫秒后，<strong>将回调函数放入任务队列</strong>”。</p>
<p>什么时候执行呢？要等主线程上当前的任务都执行完了，才会从队列里取出这个回调来执行。</p>
<p>想象一下：</p>
<ul>
<li>你设定 <code>setInterval(fn, 1000)</code>，希望每秒跑一次。</li>
<li>第0秒，<code>fn</code> 执行了。</li>
<li>第1秒，<code>fn</code> 被放入队列。但此时主线程正在处理一个复杂的动画计算，花了 200 毫秒。</li>
<li>结果，<code>fn</code> 直到第1.2秒才真正开始执行。</li>
</ul>
<p><strong>这就产生了至少 200 毫秒的延迟。</strong></p>
<p><strong>元凶二：浏览器标签页休眠</strong></p>
<p>为了节省电量，当用户切换到其他标签页或最小化浏览器时，当前页面的 <code>setInterval</code> 和 <code>setTimeout</code> 会被“限流”。它们的执行频率会大大降低，可能变成每秒一次，甚至更慢。</p>
<p>如果你的倒计时在后台运行了5分钟，再切回来，它可能直接显示“已结束”，或者时间跳了一大截。</p>
<p><strong>元凶三：系统时间依赖</strong></p>
<p>很多倒计时是这样计算剩余时间的：</p>
<pre><code class="hljs language-javascript" lang="javascript">剩余秒数 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((目标时间戳 - <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) / <span class="hljs-number">1000</span>);
</code></pre>
<p>这里有两个潜在问题：</p>
<ol>
<li> <strong><code>Date.now()</code> 的精度</strong>：它返回的是系统时间。如果用户手动修改了电脑时间，或者系统时间同步有微小偏差，倒计时就会出错。</li>
<li> <strong>计算时机</strong>：这个计算发生在回调函数执行的那一刻。如果回调函数本身被延迟了，那么用来计算的“当前时刻”也已经晚了。</li>
</ol>
<hr/>
<h2 data-id="heading-3">如何减小误差？试试这些方案</h2>
<p>知道了原因，我们就可以对症下药。解决方案的目标是：<strong>让显示的时间尽可能接近真实的世界时间</strong>。</p>
<h3 data-id="heading-4">方案一：优化计时器逻辑</h3>
<p>这是最基础的改进，核心思想是：<strong>不依赖计时器的周期，而是依赖绝对时间</strong>。</p>
<p><strong>具体做法：</strong></p>
<ol>
<li>
<p>在倒计时启动时，记录一个精确的<strong>开始时间戳</strong>（<code>startTime = Date.now()</code>）和<strong>目标结束时间戳</strong>（<code>endTime</code>）。</p>
</li>
<li>
<p>在每次更新函数中，不再简单地“减1秒”，而是重新计算：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
const <span class="hljs-attr">elapsed</span> = now - startTime<span class="hljs-comment">; // 已经过去的时间</span>
const <span class="hljs-attr">remainingTime</span> = endTime - now<span class="hljs-comment">; // 剩余时间</span>
const <span class="hljs-attr">displaySeconds</span> = Math.floor(remainingTime / <span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>动态调整下一次执行的时间。例如，我们希望每 1000 毫秒更新一次显示，但上次执行晚了 50 毫秒，那么下次就只延迟 950 毫秒。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ... 计算并显示时间</span>
  <span class="hljs-keyword">const</span> deviation = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - (startTime + expectedElapsed); <span class="hljs-comment">// 计算偏差</span>
  <span class="hljs-keyword">const</span> nextTick = <span class="hljs-number">1000</span> - deviation; <span class="hljs-comment">// 调整下次间隔</span>
  <span class="hljs-built_in">setTimeout</span>(updateTimer, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, nextTick)); <span class="hljs-comment">// 确保间隔不为负数</span>
}
</code></pre>
</li>
</ol>
<p><strong>优点：</strong></p>
<p>• 实现相对简单。
• 能有效抵消单次延迟的累积。一次慢了，下次会找补回来一些。</p>
<p><strong>缺点：</strong></p>
<p>• 无法解决浏览器标签页休眠导致的长时间停滞。
• 仍然依赖 <code>Date.now()</code>，受系统时间影响。</p>
<h3 data-id="heading-5">方案二：使用 Web Worker（隔离线程）</h3>
<p>既然主线程繁忙会导致延迟，那我们就把计时任务放到一个独立的线程里去。</p>
<p>Web Worker 可以让脚本在后台线程运行。在这个线程里运行的 <code>setInterval</code> 不容易被主线程的繁重任务阻塞。</p>
<p><strong>实现思路：</strong></p>
<ol>
<li>创建一个 Web Worker 文件（<code>timer.worker.js</code>），在里面用 <code>setInterval</code> 向主线程发送消息。</li>
<li>主线程接收消息，更新界面。</li>
</ol>
<p><strong>优点：</strong></p>
<p>• 计时更稳定，受主线程影响小。
• 代码分离，逻辑清晰。</p>
<p><strong>缺点：</strong></p>
<p>• 仍然无法解决浏览器标签页休眠限流的问题。
• 增加了一定的架构复杂度。</p>
<h3 data-id="heading-6">方案三：终极方案：服务器时间同步 + 前端补偿</h3>
<p>这是目前最精确、最可靠的方案。核心原则是：<strong>前端不再信任本地时间，而是以服务器时间为准，并持续校准。</strong></p>
<p><strong>步骤拆解：</strong></p>
<p><strong>第一步：获取权威的服务器时间</strong><br/>
在页面加载或倒计时开始时，向服务器发送一个请求。服务器在响应中返回当前的<strong>服务器时间戳</strong>。</p>
<blockquote>
<p><strong>注意</strong>：这个时间戳应该放在 HTTP 响应的 <code>Date</code> 头或 <code>body</code> 里，避免受到网络传输时间的影响。更专业的做法是，计算一个往返延迟（RTT），然后估算出当前的准确服务器时间。</p>
</blockquote>
<p><strong>第二步：在前端建立一个“虚拟的服务器时钟”</strong><br/>
我们不在前端直接使用 <code>Date.now()</code>，而是自己维护一个时钟：</p>
<pre><code class="hljs language-ini" lang="ini">// 假设通过 API 得到：serverTime 是服务器当前时间，rtt 是网络往返延迟
const <span class="hljs-attr">initialServerTime</span> = serverTime + rtt / <span class="hljs-number">2</span><span class="hljs-comment">; // 估算的准确服务器时间</span>
const <span class="hljs-attr">localTimeAtThatMoment</span> = Date.now()<span class="hljs-comment">;</span>

// 此后，要获取“当前服务器时间”，就用这个公式：
function getCurrentServerTime() {
  const <span class="hljs-attr">nowLocal</span> = Date.now()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">elapsedLocal</span> = nowLocal - localTimeAtThatMoment<span class="hljs-comment">;</span>
  return initialServerTime + elapsedLocal<span class="hljs-comment">;</span>
}
</code></pre>
<p>这个时钟的原理是：服务器告诉我们一个“起点时间”，我们记录下那个时刻的本地时间。之后，我们相信本地时间的<strong>流逝速度</strong>是基本准确的（电脑的晶体振荡器很稳定），用本地流逝的时间加上服务器的起点时间，就得到了连续的“服务器时间”。</p>
<p><strong>第三步：用这个虚拟时钟驱动倒计时</strong><br/>
倒计时的更新函数，使用 <code>getCurrentServerTime()</code> 来计算剩余时间，而不是 <code>Date.now()</code>。</p>
<p><strong>第四步：定期校准</strong><br/>
本地时钟的流逝速度可能有微小偏差（时钟漂移）。我们可以设置一个间隔（比如每1分钟或5分钟），悄悄地再向服务器请求一次时间，来修正我们的 <code>initialServerTime</code> 和 <code>localTimeAtThatMoment</code>，让虚拟时钟始终与服务器保持同步。</p>
<p><strong>这个方案的优点非常突出：</strong></p>
<p>• <strong>抗干扰</strong>：用户修改本地时间，完全不影响倒计时。
• <strong>高精度</strong>：误差主要来自时钟漂移和网络延迟，通过定期校准可以控制在极低水平（百毫秒内）。
• <strong>一致性</strong>：所有用户看到的倒计时基于同一时间源，公平公正。</p>
<p>当然，它的实现也最复杂，需要前后端配合。</p>
<h2 data-id="heading-7">实战建议：如何选择？</h2>
<p>面对不同的场景，你可以这样选择：</p>
<p>• <strong>对精度要求不高的展示型倒计时</strong>（如文章发布后的阅读时间）：使用<strong>方案一（优化计时器逻辑）</strong>  就足够了。简单有效。
• <strong>营销活动、秒杀抢购倒计时</strong>：必须使用<strong>方案三（服务器时间同步）</strong> 。这是保证公平性和准确性的底线。方案一和方案二可以作为辅助，让更新更平滑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Kubernetes】以LOL的视角打开K8s的工作负载]]></title>    <link>https://juejin.cn/post/7597987896693178403</link>    <guid>https://juejin.cn/post/7597987896693178403</guid>    <pubDate>2026-01-22T10:12:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597987896693178403" data-draft-id="7598020609281851426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Kubernetes】以LOL的视角打开K8s的工作负载"/> <meta itemprop="keywords" content="后端,Kubernetes"/> <meta itemprop="datePublished" content="2026-01-22T10:12:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ThisIsClark"/> <meta itemprop="url" content="https://juejin.cn/user/518625216693341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Kubernetes】以LOL的视角打开K8s的工作负载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/518625216693341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ThisIsClark
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:12:51.000Z" title="Thu Jan 22 2026 10:12:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Kubernetes（简称K8s）作为云原生时代必须要掌握的一门技术，其整个体系还是比较庞大的。但是其实用一段时间你就会发现，在整个庞大的K8s体系中，最主要承载承载业务的还是五大工作负载，即Deployment、Daemonset、StatefulSet、Job和CronJob，其余的像service，configmap，pvc都是为这五大工作负载添砖加瓦的。
另外我还发现在K8s体系复杂的同时，同样体系复杂的MOBA游戏《英雄联盟》（简称LOL）却受众广泛，休息时有很多同事都是在看LOL相关的视频。
于是为了帮各位想要入门K8s的“最强王者”更好的理解K8s的核心：五大工作负载，我为各种抽象的K8s工作负载在LOL中找了一个同样表现或者起同样作用的英雄，让各位最强王者能从LOL出发，更好的理解K8s的五大核心工作负载。</p>
<hr/>
<h4 data-id="heading-1">🚀 <strong>1. Deployment (部署) - 无状态应用的智慧管家</strong></h4>
<p>👉 <strong>核心功能</strong>：</p>
<p>Kubernetes 中最常用、最核心的工作负载。它像一个精明的管家，专门负责部署和管理<strong>无状态应用</strong>（如Web服务器、API微服务）。它的超能力在于声明式的滚动更新和优雅回滚——只需修改镜像版本，它就能自动、平滑地逐步替换旧Pod实例，万一新版本有问题，一键就能秒回旧版。它还通过副本数（Replicas）设定，确保应用始终有指定数量的健康副本在运行，自动修复“不健康”的Pod，是高可用的基石。</p>
<p>💡<strong>典型场景</strong>：你的网站前端、RESTful API服务、无状态微服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ad910d2df4448a879b2fce961bffd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhpc0lzQ2xhcms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682191&amp;x-signature=JUv1%2FUHz6pSrE8vDmpgTqJK2fFo%3D" alt="请添加图片描述" loading="lazy"/></p>
<p>💡对应的LOL英雄：盖伦</p>
<ol>
<li>盖伦是LOL入门会最先接触到的英雄（3个初始免费英雄之一），你可能没玩过沙皇/阿罗拉/厄斐琉斯，但你一定玩过这个“大宝剑”；而Deployment也是几乎所有K8s入门教程都会拿来举例的工作负载，比如拿deployment起一个nginx镜像，而真正用上k8s之后，你也会发现，你的集群里面可能没有Job/CronJob等，但deployment是基本上一定会有的</li>
<li>盖伦什么都有，回血、沉默、伤害、强化、AOE、斩杀，Deployment也是什么功能都包含，但它又不是专门为了某一项功能而生的。</li>
</ol>
<hr/>
<h4 data-id="heading-2">🧠 <strong>2. StatefulSet (有状态副本集) - 秩序严谨的数据管理者</strong></h4>
<p>👉 <strong>核心功能</strong>：</p>
<p>当你的应用需要<strong>持久化数据</strong>和<strong>稳定标识</strong>时（比如数据库、消息队列），StatefulSet就是你的不二之选。它与Deployment的关键区别在于<strong>秩序</strong>和<strong>唯一性</strong>。它为每个Pod提供唯一且固定的名称（如<code>mysql-0</code>, <code>mysql-1</code>）、稳定的网络标识（DNS记录）以及专有的持久化存储卷。扩缩容（增加或减少副本）时，它会严格遵守顺序，优雅地一个接一个操作，完美保障集群化有状态应用的数据安全和启动顺序。</p>
<p>💡<strong>典型场景</strong>：MySQL集群、Redis集群、Kafka、ZooKeeper、Etcd。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ebd59817e2847b189e7e17967b70f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhpc0lzQ2xhcms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682191&amp;x-signature=j2mBXAYx2NF199IzPWmn%2F%2FvzP%2Fw%3D" alt="请添加图片描述" loading="lazy"/></p>
<p>💡对应的LOL英雄：邪恶小法师 · 维迦</p>
<ol>
<li>核心被动技能是【超凡邪力】，通过用Q技能补刀或击杀英雄，<strong>永久性地</strong>增加自己的法术强度。这个法强值是他的“<strong>状态数据</strong>”，会随着时间<strong>持久化并不断增长</strong>，绝不会因为回城或死亡而重置。Statefulset也是一样，它里面的数据不会随着pod的重启而消失。</li>
</ol>
<hr/>
<h4 data-id="heading-3">🔌 <strong>3. DaemonSet (守护进程集) - 每个节点上的忠实哨兵</strong></h4>
<p>👉 <strong>核心功能</strong>：</p>
<p>DaemonSet 确保集群中的<strong>每一个节点</strong>（或符合标签选择器的节点）上都运行一个你指定的Pod副本。就像一个忠诚的哨兵，节点加入集群时，它会自动部署；节点离开时，它也会自动清理。它非常适合运行那些需要与节点本身深度绑定的<strong>基础架构服务</strong>，这些服务需要感知节点并为节点提供功能，而不是为用户业务提供服务。</p>
<p>💡<strong>典型场景</strong>：日志收集代理（Fluentd）、节点监控组件（Node Exporter）、网络插件（Calico）、安全代理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84e22efacacd47c6b3f8a7ac0895a0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhpc0lzQ2xhcms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682191&amp;x-signature=DWiAjC5K3OWeufOBQVfWT6aI2LM%3D" alt="请添加图片描述" loading="lazy"/></p>
<p>💡对应的LOL英雄：索拉卡</p>
<p>索拉卡的大招可以给地图上的所有的己方英雄回血，而DaemonSet也是强制在集群中的每个节点都会有一个pod，都主打一个“全局控制”，“雨露均沾”，确保每一个节点都能有一个服务实例在运行。</p>
<hr/>
<h4 data-id="heading-4">⏳ <strong>4. Job (任务) - 使命必达的一次性行者</strong></h4>
<p>👉 <strong>核心功能</strong>：</p>
<p>Job 负责创建一个或多个Pod来执行一个<strong>一次性</strong>的<strong>任务</strong>（Task），而不是持续运行的服务。它的核心目标是确保任务<strong>成功完成</strong>。你定义一个任务（比如一个计算脚本），Job会启动Pod去执行，直到Pod内的容器成功退出（Exit Code为0）。如果任务执行失败，Job会根据配置尝试重试。一旦任务成功完成，Job及其创建的Pod就会功成身退，保留记录以供查询。</p>
<p>💡<strong>典型场景</strong>：执行数据库迁移脚本、运行一次性的数据分析任务、批处理作业。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbce45d5acee470499ed689c9cb249f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhpc0lzQ2xhcms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682191&amp;x-signature=FKPWOzegMFwfFdEV1iRYAIVXg%2B0%3D" alt="请添加图片描述" loading="lazy"/></p>
<p>💡对应的LOL英雄：像劫这样的刺客</p>
<p>LOL里面的刺客不擅长持续输出，他们会等技能齐全和时机成熟时一套技能看能不能切入敌方后排秒杀掉对手的C位，一套技能打完以后，他们会暂时丧失威胁，等下一次CD转好，又是他们伺机而动的时候。Job也是一个道理，等需要它时执行一次，然后就会潜伏，等待下次需要执行的时候才会再次被执行。</p>
<hr/>
<h4 data-id="heading-5">⏳ <strong>5. CronJob (定时任务) - 精准的自动化闹钟</strong></h4>
<p>👉 <strong>核心功能</strong>：</p>
<p>CronJob 是基于时间调度的Job，相当于Linux系统中的Crontab。它让你可以用熟悉的Cron语法（如 <code>0 * * * *</code>）来定义并周期性地运行Job。到了预定时间，CronJob控制器就会自动创建一个新的Job对象来执行任务。它是实现<strong>自动化运维</strong>和<strong>周期性任务</strong>的利器，让你彻底从手动执行重复任务中解放出来。</p>
<p>💡<strong>典型场景</strong>：每天凌晨2点执行数据库备份、每小时发送一次系统健康报告、每周清理一次临时文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b887abf55d2c4e18a0ca513fc046b4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhpc0lzQ2xhcms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682191&amp;x-signature=omqJz982JhKfXlFdoO8%2BQ1LmBA0%3D" alt="请添加图片描述" loading="lazy"/></p>
<p>💡对应的LOL英雄：LOL这个游戏机制本身</p>
<p>LOL在游戏开始后，会在3路定期生成小兵，这些小兵的生成是一开始就设定好的，不会受场上英雄被击杀或者防御塔被拆掉等各种事件的影响而稳定定时运行。CronJob也是一样，不管其它工作负载工作情况怎么样，它都会按照设定好的时间或间隔，周而复始的自动执行。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreeJS 着色器编程基础入门]]></title>    <link>https://juejin.cn/post/7597989474991980582</link>    <guid>https://juejin.cn/post/7597989474991980582</guid>    <pubDate>2026-01-22T10:11:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991980582" data-draft-id="7597996070510362662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreeJS 着色器编程基础入门"/> <meta itemprop="keywords" content="three.js,前端"/> <meta itemprop="datePublished" content="2026-01-22T10:11:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreeJS 着色器编程基础入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:11:54.000Z" title="Thu Jan 22 2026 10:11:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文档涵盖Three.js中着色器编程的基础概念和实现方法，基于实际代码示例进行讲解。</p>
<p>最终效果如图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d16278d467cc410a8f8ba9d48b21708a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681938&amp;x-signature=MHXN3QIeTVZIhN%2FSK%2BEm3qvbQvo%3D" alt="懂王在风中凌乱" loading="lazy"/></p>
<h2 data-id="heading-0">1. 着色器基础概念</h2>
<p>着色器(Shader)是运行在GPU上的小程序，用于计算3D场景中每个像素的颜色。在Three.js中，有两种主要的着色器：</p>
<ul>
<li><strong>顶点着色器(Vertex Shader)</strong>：处理每个顶点的位置变换</li>
<li><strong>片元着色器(Fragment Shader)</strong>：确定每个像素的最终颜色</li>
</ul>
<h3 data-id="heading-1">1.1 着色器导入和初始化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;

<span class="hljs-comment">// 顶点着色器</span>
<span class="hljs-keyword">import</span> basicVertexShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shader/raw/vertex.glsl"</span>;
<span class="hljs-comment">// 片元着色器</span>
<span class="hljs-keyword">import</span> basicFragmentShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shader/raw/fragment.glsl"</span>;
</code></pre>
<h2 data-id="heading-2">2. 着色器材质创建</h2>
<h3 data-id="heading-3">2.1 RawShaderMaterial vs ShaderMaterial</h3>
<p>RawShaderMaterial直接使用GLSL代码，不会自动添加默认的uniforms和attributes：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建原始着色器材质</span>
<span class="hljs-keyword">const</span> rawShaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">RawShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: basicVertexShader,
  <span class="hljs-attr">fragmentShader</span>: basicFragmentShader,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uTime</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">uTexture</span>: {
      <span class="hljs-attr">value</span>: texture,
    },
  },
});
</code></pre>
<h3 data-id="heading-4">2.2 基础着色器材质</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建着色器材质</span>
<span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
    void main(){
        gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ) ;
    }
  `</span>,
  <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    void main(){
        gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
    }
  `</span>,
});
</code></pre>
<h2 data-id="heading-5">3. 顶点着色器详解</h2>
<p>顶点着色器负责处理3D空间中的顶点位置，以下是一个包含动画效果的顶点着色器：</p>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;
attribute vec3 position;
attribute vec2 uv;

uniform mat4 modelMatrix;
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;

// 获取时间
uniform float uTime;

varying vec2 vUv;
varying float vElevation;

void main(){
    vUv = uv;
    vec4 modelPosition = modelMatrix * vec4( position, 1.0 );
    
    // 添加基于时间的波浪动画
    modelPosition.z = sin((modelPosition.x+uTime) * 10.0)*0.05 ;
    modelPosition.z += sin((modelPosition.y+uTime)  * 10.0)*0.05 ;
    vElevation = modelPosition.z;

    gl_Position = projectionMatrix * viewMatrix * modelPosition ;
}
</code></pre>
<h2 data-id="heading-6">4. 片元着色器详解</h2>
<p>片元着色器负责确定每个像素的颜色，以下是一个处理纹理和高度的片元着色器：</p>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;
varying vec2 vUv;
varying float vElevation;

uniform sampler2D uTexture; 

void main(){
    // 根据UV,取出对应的颜色
    float height = vElevation + 0.05 * 20.0;
    vec4 textureColor = texture2D(uTexture,vUv);
    textureColor.rgb*=height;
    gl_FragColor = textureColor;
}
</code></pre>
<h2 data-id="heading-7">5. Uniforms统一变量</h2>
<p>Uniforms是在JavaScript代码和着色器之间传递数据的变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rawShaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">RawShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: basicVertexShader,
  <span class="hljs-attr">fragmentShader</span>: basicFragmentShader,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uTime</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 时间变量，用于动画</span>
    },
    <span class="hljs-attr">uTexture</span>: {
      <span class="hljs-attr">value</span>: texture,  <span class="hljs-comment">// 纹理变量</span>
    },
  },
});
</code></pre>
<p>在动画循环中更新uniform值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params">t</span>) {
  <span class="hljs-keyword">const</span> elapsedTime = clock.<span class="hljs-title function_">getElapsedTime</span>();
  <span class="hljs-comment">// 更新着色器中的时间uniform</span>
  rawShaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uTime</span>.<span class="hljs-property">value</span> = elapsedTime;
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
</code></pre>
<h2 data-id="heading-8">6. 几何体与着色器结合</h2>
<p>使用平面几何体展示着色器效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建平面</span>
<span class="hljs-keyword">const</span> floor = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneBufferGeometry</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>),  <span class="hljs-comment">// 细分更多，波浪效果更明显</span>
  rawShaderMaterial
);

scene.<span class="hljs-title function_">add</span>(floor);
</code></pre>
<h2 data-id="heading-9">7. 基础着色器示例</h2>
<p>创建一个简单的黄色平面着色器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建基础着色器材质</span>
<span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
    void main(){
        gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 ) ;
    }
  `</span>,
  <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    void main(){
        gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);  // 黄色
    }
  `</span>,
});
</code></pre>
<h2 data-id="heading-10">8. 着色器开发最佳实践</h2>
<ol>
<li>
<p><strong>精度声明</strong>：在片元着色器中声明精度</p>
<pre><code class="hljs language-glsl" lang="glsl">precision lowp float;  // 低精度
precision mediump float;  // 中等精度
precision highp float;  // 高精度
</code></pre>
</li>
<li>
<p><strong>变量类型</strong>：</p>
<ul>
<li><code>attribute</code>：每个顶点独有的数据（如位置、UV坐标）</li>
<li><code>uniform</code>：所有顶点共享的数据（如时间、纹理）</li>
<li><code>varying</code>：在顶点着色器和片元着色器之间传递的数据</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：避免在着色器中使用复杂运算，尽可能在CPU端预计算</p>
</li>
<li>
<p><strong>调试技巧</strong>：通过将中间计算结果输出到颜色来调试着色器</p>
</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>本章介绍了Three.js中着色器编程的基础知识，包括：</p>
<ol>
<li>着色器的基本概念和类型</li>
<li>如何创建和使用着色器材质</li>
<li>顶点着色器和片元着色器的编写</li>
<li>如何通过uniforms在JavaScript和着色器间传递数据</li>
<li>基础的着色器动画实现</li>
</ol>
<p>通过掌握这些基础知识，可以进一步探索更复杂的着色器效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云微服务引擎 MSE 及 API 网关 2025 年 12 月产品动态]]></title>    <link>https://juejin.cn/post/7597946284679462931</link>    <guid>https://juejin.cn/post/7597946284679462931</guid>    <pubDate>2026-01-22T10:17:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597946284679462931" data-draft-id="7597946284679430163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云微服务引擎 MSE 及 API 网关 2025 年 12 月产品动态"/> <meta itemprop="keywords" content="微服务"/> <meta itemprop="datePublished" content="2026-01-22T10:17:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云微服务引擎 MSE 及 API 网关 2025 年 12 月产品动态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:17:33.000Z" title="Thu Jan 22 2026 10:17:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/631418e984a64464b372ea32b746a746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681853&amp;x-signature=NWG2h0tUYgFugS%2B27nkZB8%2Bo%2BK4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreeJS 着色器图形特效]]></title>    <link>https://juejin.cn/post/7597979278241021961</link>    <guid>https://juejin.cn/post/7597979278241021961</guid>    <pubDate>2026-01-22T10:18:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597979278241021961" data-draft-id="7597989474992013350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreeJS 着色器图形特效"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-22T10:18:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreeJS 着色器图形特效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:18:31.000Z" title="Thu Jan 22 2026 10:18:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文档涵盖Three.js中高级着色器图形特效的实现方法，基于实际代码示例进行讲解。</p>
<p>最终效果如图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d72bc2fdd6d4c989915e6667c4f3f5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769681911&amp;x-signature=8Mtd1fEEnB3LunVdT2tu9DlALvE%3D" alt="Title" loading="lazy"/></p>
<h2 data-id="heading-0">1. 着色器图形特效基础</h2>
<h3 data-id="heading-1">1.1 复杂着色器材质创建</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> deepVertexShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/deep/vertex.glsl"</span>;
<span class="hljs-keyword">import</span> deepFragmentShader <span class="hljs-keyword">from</span> <span class="hljs-string">"../shaders/deep/fragment.glsl"</span>;

<span class="hljs-comment">// 创建带有多个uniforms的着色器材质</span>
<span class="hljs-keyword">const</span> shaderMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">vertexShader</span>: deepVertexShader,
  <span class="hljs-attr">fragmentShader</span>: deepFragmentShader,
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uColor</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"purple"</span>),
    },
    <span class="hljs-comment">// 波浪的频率</span>
    <span class="hljs-attr">uFrequency</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uFrequency</span>,
    },
    <span class="hljs-comment">// 波浪的幅度</span>
    <span class="hljs-attr">uScale</span>: {
      <span class="hljs-attr">value</span>: params.<span class="hljs-property">uScale</span>,
    },
    <span class="hljs-comment">// 动画时间</span>
    <span class="hljs-attr">uTime</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">uTexture</span>: {
      <span class="hljs-attr">value</span>: texture,
    },
  },
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<h3 data-id="heading-2">1.2 GUI参数控制</h3>
<p>通过dat.GUI实时控制着色器参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 控制频率参数</span>
gui
  .<span class="hljs-title function_">add</span>(params, <span class="hljs-string">"uFrequency"</span>)
  .<span class="hljs-title function_">min</span>(<span class="hljs-number">0</span>)
  .<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>)
  .<span class="hljs-title function_">step</span>(<span class="hljs-number">0.1</span>)
  .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uFrequency</span>.<span class="hljs-property">value</span> = value;
  });

<span class="hljs-comment">// 控制幅度参数</span>
gui
  .<span class="hljs-title function_">add</span>(params, <span class="hljs-string">"uScale"</span>)
  .<span class="hljs-title function_">min</span>(<span class="hljs-number">0</span>)
  .<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">step</span>(<span class="hljs-number">0.01</span>)
  .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uScale</span>.<span class="hljs-property">value</span> = value;
  });
</code></pre>
<h2 data-id="heading-3">2. 高级片元着色器技术</h2>
<h3 data-id="heading-4">2.1 UV坐标操作</h3>
<p>UV坐标是纹理映射的基础，也是创建各种图形效果的关键：</p>
<pre><code class="hljs language-glsl" lang="glsl">void main(){
    // 1. 通过顶点对应的uv，决定每一个像素在uv图像的位置，通过这个位置x,y决定颜色
    // gl_FragColor =vec4(vUv,0,1) ;

    // 2. 对第一种变形
    // gl_FragColor = vec4(vUv,1,1);

    // 3. 利用uv实现渐变效果,从左到右
    float strength = vUv.x;
    gl_FragColor =vec4(strength,strength,strength,1);
}
</code></pre>
<h3 data-id="heading-5">2.2 数学函数应用</h3>
<p>利用GLSL内置数学函数创建复杂效果：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 随机函数
float random (vec2 st) {
    return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123);
}

// 噪声函数
float noise (in vec2 _st) {
    vec2 i = floor(_st);
    vec2 f = fract(_st);

    // 四个角落的随机值
    float a = random(i);
    float b = random(i + vec2(1.0, 0.0));
    float c = random(i + vec2(0.0, 1.0));
    float d = random(i + vec2(1.0, 1.0));

    vec2 u = f * f * (3.0 - 2.0 * f);

    return mix(a, b, u.x) +
            (c - a)* u.y * (1.0 - u.x) +
            (d - b) * u.x * u.y;
}
</code></pre>
<h3 data-id="heading-6">2.3 几何图形绘制</h3>
<p>使用数学函数绘制各种几何图形：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 绘制圆形
float strength = 1.0 - step(0.5,distance(vUv,vec2(0.5))+0.25) ;
gl_FragColor =vec4(strength,strength,strength,1);

// 绘制圆环
float strength = step(0.5,distance(vUv,vec2(0.5))+0.35) ;
strength *= (1.0 - step(0.5,distance(vUv,vec2(0.5))+0.25)) ;
gl_FragColor =vec4(strength,strength,strength,1);

// 波浪效果
vec2 waveUv = vec2(
    vUv.x+sin(vUv.y*100.0)*0.1,
    vUv.y+sin(vUv.x*100.0)*0.1
);
float strength = 1.0 - step(0.01,abs(distance(waveUv,vec2(0.5))-0.25)) ;
gl_FragColor =vec4(strength,strength,strength,1);
</code></pre>
<h2 data-id="heading-7">3. 动画与时间控制</h2>
<h3 data-id="heading-8">3.1 时间uniform应用</h3>
<p>在动画循环中更新时间uniform：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params">t</span>) {
  <span class="hljs-keyword">const</span> elapsedTime = clock.<span class="hljs-title function_">getElapsedTime</span>();
  shaderMaterial.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uTime</span>.<span class="hljs-property">value</span> = elapsedTime;  <span class="hljs-comment">// 更新时间</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
</code></pre>
<h3 data-id="heading-9">3.2 着色器中的动画效果</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 使用时间创建波浪动画
float strength = step(0.9,sin(cnoise(vUv * 10.0)*20.0+uTime)) ;

// 波纹效果
float strength = sin(cnoise(vUv * 10.0)*5.0+uTime) ;
</code></pre>
<h2 data-id="heading-10">4. 颜色混合与插值</h2>
<h3 data-id="heading-11">4.1 颜色混合函数</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 使用混合函数混颜色
vec3 purpleColor = vec3(1.0, 0.0, 1.0);
vec3 greenColor = vec3(1.0, 1.0, 1.0);
vec3 uvColor = vec3(vUv,1.0);
float strength = step(0.9,sin(cnoise(vUv * 10.0)*20.0)) ;

vec3 mixColor =  mix(greenColor,uvColor,strength);
gl_FragColor =vec4(mixColor,1.0);
</code></pre>
<h2 data-id="heading-12">5. 纹理与采样</h2>
<h3 data-id="heading-13">5.1 纹理采样</h3>
<pre><code class="hljs language-glsl" lang="glsl">uniform sampler2D uTexture;

void main(){
    vec4 textureColor = texture2D(uTexture,vUv);
    textureColor.rgb*=height;
    gl_FragColor = textureColor;
}
</code></pre>
<h2 data-id="heading-14">6. 几何变换</h2>
<h3 data-id="heading-15">6.1 旋转函数</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 旋转函数
vec2 rotate(vec2 uv, float rotation, vec2 mid)
{
    return vec2(
      cos(rotation) * (uv.x - mid.x) + sin(rotation) * (uv.y - mid.y) + mid.x,
      cos(rotation) * (uv.y - mid.y) - sin(rotation) * (uv.x - mid.x) + mid.y
    );
}

// 使用旋转函数
vec2 rotateUv = rotate(vUv,-uTime*5.0,vec2(0.5));
</code></pre>
<h2 data-id="heading-16">7. 复杂效果实现</h2>
<h3 data-id="heading-17">7.1 万花筒效果</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 万花筒效果
float angle = atan(vUv.x-0.5,vUv.y-0.5)/PI;
float strength = mod(angle*10.0,1.0);
gl_FragColor =vec4(strength,strength,strength,1);
</code></pre>
<h3 data-id="heading-18">7.2 雷达扫描效果</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 雷达扫描效果
vec2 rotateUv = rotate(vUv,-uTime*5.0,vec2(0.5));
float alpha =  1.0 - step(0.5,distance(vUv,vec2(0.5)));
float angle = atan(rotateUv.x-0.5,rotateUv.y-0.5);
float strength = (angle+3.14)/6.28;
gl_FragColor =vec4(strength,strength,strength,alpha);
</code></pre>
<h2 data-id="heading-19">8. 性能优化与调试</h2>
<h3 data-id="heading-20">8.1 性能优化技巧</h3>
<ol>
<li><strong>减少复杂计算</strong>：避免在着色器中进行过于复杂的数学运算</li>
<li><strong>合理使用纹理</strong>：预先计算复杂效果并存储在纹理中</li>
<li><strong>简化几何体</strong>：在不影响视觉效果的前提下减少顶点数</li>
</ol>
<h3 data-id="heading-21">8.2 调试技巧</h3>
<ol>
<li><strong>逐步构建</strong>：从简单效果开始，逐步增加复杂性</li>
<li><strong>输出中间值</strong>：将中间计算结果输出为颜色进行调试</li>
<li><strong>使用常量验证</strong>：先用常量验证逻辑，再引入变量</li>
</ol>
<h2 data-id="heading-22">总结</h2>
<p>本章深入探讨了Three.js中高级着色器图形特效的实现方法，包括：</p>
<ol>
<li>复杂着色器材质的创建和参数控制</li>
<li>数学函数在图形生成中的应用</li>
<li>UV坐标操作和几何图形绘制</li>
<li>时间动画和颜色混合技术</li>
<li>纹理采样和几何变换</li>
<li>复杂视觉效果的实现方法</li>
<li>性能优化和调试技巧</li>
</ol>
<p>通过掌握这些技术，可以创建出丰富的视觉效果和动态图形。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的量化交易工作流：从想法到实盘的完整流程]]></title>    <link>https://juejin.cn/post/7598003935425413163</link>    <guid>https://juejin.cn/post/7598003935425413163</guid>    <pubDate>2026-01-22T10:20:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598003935425413163" data-draft-id="7597905961664446470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的量化交易工作流：从想法到实盘的完整流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T10:20:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="finvfamily"/> <meta itemprop="url" content="https://juejin.cn/user/1030684849212858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的量化交易工作流：从想法到实盘的完整流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1030684849212858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    finvfamily
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:20:11.000Z" title="Thu Jan 22 2026 10:20:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我的量化交易工作流：从想法到实盘的完整流程</h2>
<blockquote>
<p>上一篇分享了踩坑经历，这篇讲讲我现在的工作流程。不一定是最优解，但至少是踩完坑之后沉淀下来的方法。</p>
</blockquote>
<p>很多人觉得量化交易就是"写个策略→回测→上实盘"，三步搞定。</p>
<p>实际上，一个靠谱的量化策略从想法到实盘，中间至少要经过7个阶段。跳过任何一个，大概率会在实盘时付出代价。</p>
<hr/>
<h3 data-id="heading-1">整体流程概览</h3>
<pre><code class="hljs">想法产生 → 数据准备 → 策略开发 → 回测验证 → 参数优化 → 模拟盘 → 实盘
   ↑                                                              │
   └──────────────── 复盘迭代 ←────────────────────────────────────┘
</code></pre>
<p>下面逐个阶段展开。</p>
<hr/>
<h3 data-id="heading-2">一、想法产生：别从"我觉得"出发</h3>
<h4 data-id="heading-3">1.1 想法来源</h4>
<p>好的策略想法一般来自这几个地方：</p>
<p><strong>学术论文</strong></p>
<ul>
<li>SSRN、arXiv 上有大量因子研究论文</li>
<li>重点看近3年的，太老的可能已经失效</li>
<li>注意区分"样本内"和"样本外"结果</li>
</ul>
<p><strong>经典书籍</strong></p>
<ul>
<li>《量化交易》（Ernest Chan）</li>
<li>《主动投资组合管理》</li>
<li>《因子投资》</li>
</ul>
<p><strong>市场观察</strong></p>
<ul>
<li>某类事件发生后，市场有规律性反应</li>
<li>比如：财报发布后的漂移、节假日效应</li>
</ul>
<p><strong>同行交流</strong></p>
<ul>
<li>量化社区、论坛</li>
<li>但要独立验证，别人赚钱的策略不一定适合你</li>
</ul>
<h4 data-id="heading-4">1.2 想法筛选</h4>
<p>不是每个想法都值得花时间验证。我的筛选标准：</p>

























<table><thead><tr><th>标准</th><th>说明</th></tr></thead><tbody><tr><td><strong>逻辑自洽</strong></td><td>能解释清楚为什么能赚钱</td></tr><tr><td><strong>可验证</strong></td><td>有数据可以回测</td></tr><tr><td><strong>可执行</strong></td><td>不需要超高频、不需要巨额资金</td></tr><tr><td><strong>有壁垒</strong></td><td>不是随便搜一下就能找到的策略</td></tr></tbody></table>
<p>举个反例：</p>
<blockquote>
<p>"我觉得股价跌多了就会涨"</p>
</blockquote>
<p>这种想法没有明确定义（跌多少算"多"？），无法验证，不值得继续。</p>
<p>举个正例：</p>
<blockquote>
<p>"财报超预期的股票，在财报发布后5天内有超额收益"</p>
</blockquote>
<p>这个想法有明确定义，可以用数据验证，值得深入研究。</p>
<hr/>
<h3 data-id="heading-5">二、数据准备：地基不牢，地动山摇</h3>
<h4 data-id="heading-6">2.1 确定数据需求</h4>
<p>根据策略想法，列出需要的数据：</p>
<pre><code class="hljs language-markdown" lang="markdown">策略：财报超预期
需要数据：
<span class="hljs-bullet">  -</span> 股票日线行情（价格、成交量）
<span class="hljs-bullet">  -</span> 财报发布日期
<span class="hljs-bullet">  -</span> 财报实际值
<span class="hljs-bullet">  -</span> 分析师预期值
<span class="hljs-bullet">  -</span> 股票基本信息（行业、市值）
</code></pre>
<h4 data-id="heading-7">2.2 数据获取</h4>
<p>数据来源选择原则：</p>
<ul>
<li><strong>稳定性优先</strong>：接口动不动挂的，不能用</li>
<li><strong>准确性验证</strong>：抽样对比多个数据源</li>
<li><strong>成本考量</strong>：能免费搞定的，不花冤枉钱</li>
</ul>
<p>我现在的数据来源组合：</p>
<ul>
<li>日线行情：多个源互备，哪个稳定用哪个</li>
<li>财务数据：东方财富为主</li>
<li>另类数据：自己爬取 + 清洗</li>
</ul>
<h4 data-id="heading-8">2.3 数据清洗</h4>
<p>原始数据一定有问题，清洗是必须的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_stock_data</span>(<span class="hljs-params">df</span>):
    <span class="hljs-string">"""股票数据清洗"""</span>

    <span class="hljs-comment"># 1. 去除空值</span>
    df = df.dropna(subset=[<span class="hljs-string">'open'</span>, <span class="hljs-string">'high'</span>, <span class="hljs-string">'low'</span>, <span class="hljs-string">'close'</span>])

    <span class="hljs-comment"># 2. 去除明显异常值（涨跌超过20%的，A股不可能）</span>
    df = df[df[<span class="hljs-string">'close'</span>].pct_change().<span class="hljs-built_in">abs</span>() &lt; <span class="hljs-number">0.2</span>]

    <span class="hljs-comment"># 3. 处理停牌（成交量为0）</span>
    df[<span class="hljs-string">'is_trade'</span>] = df[<span class="hljs-string">'volume'</span>] &gt; <span class="hljs-number">0</span>

    <span class="hljs-comment"># 4. 检查OHLC逻辑</span>
    <span class="hljs-comment"># high &gt;= low, high &gt;= open, high &gt;= close 等</span>
    df = df[df[<span class="hljs-string">'high'</span>] &gt;= df[<span class="hljs-string">'low'</span>]]
    df = df[df[<span class="hljs-string">'high'</span>] &gt;= df[<span class="hljs-string">'open'</span>]]
    df = df[df[<span class="hljs-string">'high'</span>] &gt;= df[<span class="hljs-string">'close'</span>]]
    df = df[df[<span class="hljs-string">'low'</span>] &lt;= df[<span class="hljs-string">'open'</span>]]
    df = df[df[<span class="hljs-string">'low'</span>] &lt;= df[<span class="hljs-string">'close'</span>]]

    <span class="hljs-keyword">return</span> df
</code></pre>
<h4 data-id="heading-9">2.4 数据验证</h4>
<p>清洗完不代表没问题，还要抽样验证：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 随机抽10只股票，对比官方数据</span>
<span class="hljs-keyword">import</span> random

symbols = random.sample(all_symbols, <span class="hljs-number">10</span>)
<span class="hljs-keyword">for</span> symbol <span class="hljs-keyword">in</span> symbols:
    my_data = get_my_data(symbol, <span class="hljs-string">'2024-01-15'</span>)
    official_data = get_official_data(symbol, <span class="hljs-string">'2024-01-15'</span>)  <span class="hljs-comment"># 比如去看行情软件</span>

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(my_data[<span class="hljs-string">'close'</span>] - official_data[<span class="hljs-string">'close'</span>]) &gt; <span class="hljs-number">0.01</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告：<span class="hljs-subst">{symbol}</span> 数据不一致"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-10">三、策略开发：先写伪代码，再写真代码</h3>
<h4 data-id="heading-11">3.1 伪代码阶段</h4>
<p>在写代码之前，先用自然语言把策略逻辑写清楚：</p>
<pre><code class="hljs language-markdown" lang="markdown">策略：双均线突破

买入条件：
<span class="hljs-bullet">  -</span> MA5 上穿 MA20
<span class="hljs-bullet">  -</span> 当日成交量 &gt; 过去20日平均成交量
<span class="hljs-bullet">  -</span> 股票未停牌

卖出条件：
<span class="hljs-bullet">  -</span> MA5 下穿 MA20
<span class="hljs-bullet">  -</span> 或者亏损超过5%（止损）
<span class="hljs-bullet">  -</span> 或者盈利超过15%（止盈）

仓位管理：
<span class="hljs-bullet">  -</span> 单只股票最多10%仓位
<span class="hljs-bullet">  -</span> 最多同时持有10只股票
</code></pre>
<h4 data-id="heading-12">3.2 模块化设计</h4>
<p>我的策略代码结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">strategy/
├── signals/          <span class="hljs-meta"># 信号生成</span>
│   ├── <span class="hljs-keyword">base</span>.py       <span class="hljs-meta"># 信号基类</span>
│   ├── ma_cross.py   <span class="hljs-meta"># 均线交叉信号</span>
│   └── momentum.py   <span class="hljs-meta"># 动量信号</span>
├── filters/          <span class="hljs-meta"># 过滤条件</span>
│   ├── liquidity.py  <span class="hljs-meta"># 流动性过滤</span>
│   └── industry.py   <span class="hljs-meta"># 行业过滤</span>
├── position/         <span class="hljs-meta"># 仓位管理</span>
│   ├── equal.py      <span class="hljs-meta"># 等权重</span>
│   └── risk_parity.py <span class="hljs-meta"># 风险平价</span>
├── risk/             <span class="hljs-meta"># 风险控制</span>
│   ├── stop_loss.py  <span class="hljs-meta"># 止损</span>
│   └── max_drawdown.py
└── executor.py       <span class="hljs-meta"># 执行引擎</span>
</code></pre>
<p>模块化的好处：</p>
<ul>
<li>同一个信号模块可以复用到不同策略</li>
<li>方便单独测试每个模块</li>
<li>修改一处不影响其他部分</li>
</ul>
<h4 data-id="heading-13">3.3 核心代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Strategy</span>:
    <span class="hljs-string">"""策略基类"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):
        self.config = config
        self.signals = []
        self.filters = []
        self.position_manager = <span class="hljs-literal">None</span>
        self.risk_manager = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_signal</span>(<span class="hljs-params">self, signal</span>):
        self.signals.append(signal)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_filter</span>(<span class="hljs-params">self, <span class="hljs-built_in">filter</span></span>):
        self.filters.append(<span class="hljs-built_in">filter</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_signals</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-string">"""生成原始信号"""</span>
        combined = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">for</span> signal <span class="hljs-keyword">in</span> self.signals:
            s = signal.calculate(data)
            <span class="hljs-keyword">if</span> combined <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                combined = s
            <span class="hljs-keyword">else</span>:
                combined = combined &amp; s  <span class="hljs-comment"># 多个信号取交集</span>
        <span class="hljs-keyword">return</span> combined

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_filters</span>(<span class="hljs-params">self, signals, data</span>):
        <span class="hljs-string">"""应用过滤条件"""</span>
        filtered = signals.copy()
        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> self.filters:
            filtered = f.apply(filtered, data)
        <span class="hljs-keyword">return</span> filtered

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_positions</span>(<span class="hljs-params">self, signals, data</span>):
        <span class="hljs-string">"""计算目标仓位"""</span>
        <span class="hljs-keyword">return</span> self.position_manager.calculate(signals, data)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_risk_control</span>(<span class="hljs-params">self, positions, current_holdings</span>):
        <span class="hljs-string">"""应用风险控制"""</span>
        <span class="hljs-keyword">return</span> self.risk_manager.adjust(positions, current_holdings)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MACrossSignal</span>:
    <span class="hljs-string">"""均线交叉信号"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, short_window=<span class="hljs-number">5</span>, long_window=<span class="hljs-number">20</span></span>):
        self.short = short_window
        self.long = long_window

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">self, data</span>):
        ma_short = data[<span class="hljs-string">'close'</span>].rolling(self.short).mean()
        ma_long = data[<span class="hljs-string">'close'</span>].rolling(self.long).mean()

        <span class="hljs-comment"># 上穿</span>
        cross_up = (ma_short &gt; ma_long) &amp; (ma_short.shift(<span class="hljs-number">1</span>) &lt;= ma_long.shift(<span class="hljs-number">1</span>))
        <span class="hljs-comment"># 下穿</span>
        cross_down = (ma_short &lt; ma_long) &amp; (ma_short.shift(<span class="hljs-number">1</span>) &gt;= ma_long.shift(<span class="hljs-number">1</span>))

        signal = pd.Series(<span class="hljs-number">0</span>, index=data.index)
        signal[cross_up] = <span class="hljs-number">1</span>   <span class="hljs-comment"># 买入信号</span>
        signal[cross_down] = -<span class="hljs-number">1</span>  <span class="hljs-comment"># 卖出信号</span>

        <span class="hljs-keyword">return</span> signal
</code></pre>
<hr/>
<h3 data-id="heading-14">四、回测验证：你的回测框架靠谱吗</h3>
<h4 data-id="heading-15">4.1 回测框架选择</h4>
<p>我用过的回测框架：</p>
<ul>
<li><strong>自己写</strong>：灵活，但要造很多轮子</li>
<li><strong>Backtrader</strong>：功能全，但学习曲线陡</li>
<li><strong>自研简化版</strong>：够用，好维护</li>
</ul>
<p>对于大多数日线策略，自己写一个简单的回测框架就够了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBacktester</span>:
    <span class="hljs-string">"""简易回测框架"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, initial_capital=<span class="hljs-number">1000000</span>, commission=<span class="hljs-number">0.001</span></span>):
        self.initial_capital = initial_capital
        self.commission = commission

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, data, signals</span>):
        <span class="hljs-string">"""
        data: DataFrame with OHLCV
        signals: Series, 1=买入, -1=卖出, 0=持有
        """</span>
        capital = self.initial_capital
        position = <span class="hljs-number">0</span>
        entry_price = <span class="hljs-number">0</span>

        records = []

        <span class="hljs-keyword">for</span> i, (date, row) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(data.iterrows()):
            signal = signals.iloc[i] <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(signals) <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

            <span class="hljs-comment"># 执行交易</span>
            <span class="hljs-keyword">if</span> signal == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> position == <span class="hljs-number">0</span>:  <span class="hljs-comment"># 买入</span>
                shares = <span class="hljs-built_in">int</span>(capital * <span class="hljs-number">0.95</span> / row[<span class="hljs-string">'close'</span>] / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
                cost = shares * row[<span class="hljs-string">'close'</span>] * (<span class="hljs-number">1</span> + self.commission)
                <span class="hljs-keyword">if</span> cost &lt;= capital:
                    position = shares
                    entry_price = row[<span class="hljs-string">'close'</span>]
                    capital -= cost

            <span class="hljs-keyword">elif</span> signal == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> position &gt; <span class="hljs-number">0</span>:  <span class="hljs-comment"># 卖出</span>
                revenue = position * row[<span class="hljs-string">'close'</span>] * (<span class="hljs-number">1</span> - self.commission)
                capital += revenue
                position = <span class="hljs-number">0</span>

            <span class="hljs-comment"># 记录每日状态</span>
            portfolio_value = capital + position * row[<span class="hljs-string">'close'</span>]
            records.append({
                <span class="hljs-string">'date'</span>: date,
                <span class="hljs-string">'capital'</span>: capital,
                <span class="hljs-string">'position'</span>: position,
                <span class="hljs-string">'price'</span>: row[<span class="hljs-string">'close'</span>],
                <span class="hljs-string">'portfolio_value'</span>: portfolio_value
            })

        <span class="hljs-keyword">return</span> pd.DataFrame(records)
</code></pre>
<h4 data-id="heading-16">4.2 关键回测指标</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_metrics</span>(<span class="hljs-params">returns</span>):
    <span class="hljs-string">"""计算回测指标"""</span>

    <span class="hljs-comment"># 总收益</span>
    total_return = (<span class="hljs-number">1</span> + returns).prod() - <span class="hljs-number">1</span>

    <span class="hljs-comment"># 年化收益</span>
    n_years = <span class="hljs-built_in">len</span>(returns) / <span class="hljs-number">252</span>
    annual_return = (<span class="hljs-number">1</span> + total_return) ** (<span class="hljs-number">1</span> / n_years) - <span class="hljs-number">1</span>

    <span class="hljs-comment"># 年化波动率</span>
    annual_volatility = returns.std() * np.sqrt(<span class="hljs-number">252</span>)

    <span class="hljs-comment"># 夏普比率（假设无风险利率3%）</span>
    sharpe_ratio = (annual_return - <span class="hljs-number">0.03</span>) / annual_volatility

    <span class="hljs-comment"># 最大回撤</span>
    cumulative = (<span class="hljs-number">1</span> + returns).cumprod()
    running_max = cumulative.cummax()
    drawdown = (cumulative - running_max) / running_max
    max_drawdown = drawdown.<span class="hljs-built_in">min</span>()

    <span class="hljs-comment"># 卡尔玛比率</span>
    calmar_ratio = annual_return / <span class="hljs-built_in">abs</span>(max_drawdown) <span class="hljs-keyword">if</span> max_drawdown != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

    <span class="hljs-comment"># 胜率</span>
    win_rate = (returns &gt; <span class="hljs-number">0</span>).<span class="hljs-built_in">sum</span>() / (returns != <span class="hljs-number">0</span>).<span class="hljs-built_in">sum</span>()

    <span class="hljs-comment"># 盈亏比</span>
    avg_win = returns[returns &gt; <span class="hljs-number">0</span>].mean()
    avg_loss = <span class="hljs-built_in">abs</span>(returns[returns &lt; <span class="hljs-number">0</span>].mean())
    profit_loss_ratio = avg_win / avg_loss <span class="hljs-keyword">if</span> avg_loss != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'总收益率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{total_return:<span class="hljs-number">.2</span>%}</span>'</span>,
        <span class="hljs-string">'年化收益率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{annual_return:<span class="hljs-number">.2</span>%}</span>'</span>,
        <span class="hljs-string">'年化波动率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{annual_volatility:<span class="hljs-number">.2</span>%}</span>'</span>,
        <span class="hljs-string">'夏普比率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{sharpe_ratio:<span class="hljs-number">.2</span>f}</span>'</span>,
        <span class="hljs-string">'最大回撤'</span>: <span class="hljs-string">f'<span class="hljs-subst">{max_drawdown:<span class="hljs-number">.2</span>%}</span>'</span>,
        <span class="hljs-string">'卡尔玛比率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{calmar_ratio:<span class="hljs-number">.2</span>f}</span>'</span>,
        <span class="hljs-string">'胜率'</span>: <span class="hljs-string">f'<span class="hljs-subst">{win_rate:<span class="hljs-number">.2</span>%}</span>'</span>,
        <span class="hljs-string">'盈亏比'</span>: <span class="hljs-string">f'<span class="hljs-subst">{profit_loss_ratio:<span class="hljs-number">.2</span>f}</span>'</span>
    }
</code></pre>
<h4 data-id="heading-17">4.3 我关注的指标优先级</h4>
<ol>
<li><strong>夏普比率 &gt; 1.5</strong>：风险调整后收益要够好</li>
<li><strong>最大回撤 &lt; 20%</strong>：能扛得住</li>
<li><strong>卡尔玛比率 &gt; 1</strong>：收益/回撤要合理</li>
<li><strong>胜率 × 盈亏比</strong>：这个乘积决定长期能不能赚钱</li>
</ol>
<hr/>
<h3 data-id="heading-18">五、参数优化：小心过拟合陷阱</h3>
<h4 data-id="heading-19">5.1 正确的优化方法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">walk_forward_optimization</span>(<span class="hljs-params">data, strategy, param_grid,
                               train_period=<span class="hljs-number">252</span>, test_period=<span class="hljs-number">63</span></span>):
    <span class="hljs-string">"""
    滚动窗口优化
    - 用过去1年训练，未来1季度测试
    - 避免一次性用全部数据优化
    """</span>
    results = []

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(train_period, <span class="hljs-built_in">len</span>(data) - test_period, test_period):
        <span class="hljs-comment"># 划分训练集和测试集</span>
        train_data = data.iloc[i-train_period:i]
        test_data = data.iloc[i:i+test_period]

        <span class="hljs-comment"># 在训练集上寻找最优参数</span>
        best_param = <span class="hljs-literal">None</span>
        best_sharpe = -np.inf

        <span class="hljs-keyword">for</span> params <span class="hljs-keyword">in</span> param_grid:
            perf = backtest(train_data, strategy, params)
            <span class="hljs-keyword">if</span> perf[<span class="hljs-string">'sharpe'</span>] &gt; best_sharpe:
                best_sharpe = perf[<span class="hljs-string">'sharpe'</span>]
                best_param = params

        <span class="hljs-comment"># 用最优参数在测试集上验证</span>
        test_perf = backtest(test_data, strategy, best_param)
        results.append({
            <span class="hljs-string">'period'</span>: <span class="hljs-string">f"<span class="hljs-subst">{test_data.index[<span class="hljs-number">0</span>]}</span> - <span class="hljs-subst">{test_data.index[-<span class="hljs-number">1</span>]}</span>"</span>,
            <span class="hljs-string">'train_sharpe'</span>: best_sharpe,
            <span class="hljs-string">'test_sharpe'</span>: test_perf[<span class="hljs-string">'sharpe'</span>],
            <span class="hljs-string">'params'</span>: best_param
        })

    <span class="hljs-keyword">return</span> pd.DataFrame(results)
</code></pre>
<h4 data-id="heading-20">5.2 参数敏感性分析</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sensitivity_analysis</span>(<span class="hljs-params">data, strategy, base_params, param_name, param_range</span>):
    <span class="hljs-string">"""
    检验参数是否过度敏感
    """</span>
    results = []

    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> param_range:
        params = base_params.copy()
        params[param_name] = value
        perf = backtest(data, strategy, params)
        results.append({
            param_name: value,
            <span class="hljs-string">'sharpe'</span>: perf[<span class="hljs-string">'sharpe'</span>],
            <span class="hljs-string">'return'</span>: perf[<span class="hljs-string">'total_return'</span>]
        })

    df = pd.DataFrame(results)

    <span class="hljs-comment"># 如果结果波动太大，说明参数敏感，策略不稳健</span>
    sharpe_std = df[<span class="hljs-string">'sharpe'</span>].std()
    <span class="hljs-keyword">if</span> sharpe_std &gt; <span class="hljs-number">0.5</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告：<span class="hljs-subst">{param_name}</span> 参数敏感，夏普比率标准差 = <span class="hljs-subst">{sharpe_std:<span class="hljs-number">.2</span>f}</span>"</span>)

    <span class="hljs-keyword">return</span> df
</code></pre>
<hr/>
<h3 data-id="heading-21">六、模拟盘：实盘前的最后一关</h3>
<h4 data-id="heading-22">6.1 为什么要跑模拟盘</h4>
<p>回测再好看，也有几个问题没法验证：</p>
<ul>
<li>信号实时生成有没有bug</li>
<li>数据延迟有没有影响</li>
<li>执行逻辑对不对</li>
</ul>
<p>模拟盘就是用真实行情、不用真钱，跑一遍完整流程。</p>
<h4 data-id="heading-23">6.2 模拟盘运行流程</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 每日运行脚本示例</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">daily_run</span>():
    <span class="hljs-string">"""每日定时任务"""</span>

    <span class="hljs-comment"># 1. 获取最新数据</span>
    logger.info(<span class="hljs-string">"开始获取数据..."</span>)
    data = fetch_latest_data()

    <span class="hljs-comment"># 2. 生成信号</span>
    logger.info(<span class="hljs-string">"生成交易信号..."</span>)
    signals = strategy.generate_signals(data)

    <span class="hljs-comment"># 3. 计算目标仓位</span>
    target_positions = strategy.calculate_positions(signals)

    <span class="hljs-comment"># 4. 与当前持仓对比，生成交易指令</span>
    current_positions = load_current_positions()
    orders = generate_orders(current_positions, target_positions)

    <span class="hljs-comment"># 5. 记录交易指令（模拟盘不真正下单）</span>
    logger.info(<span class="hljs-string">f"今日交易指令：<span class="hljs-subst">{orders}</span>"</span>)
    save_orders(orders)

    <span class="hljs-comment"># 6. 更新模拟持仓</span>
    update_simulated_positions(orders, data)

    <span class="hljs-comment"># 7. 记录每日净值</span>
    nav = calculate_nav()
    save_daily_nav(nav)

    <span class="hljs-comment"># 8. 发送日报</span>
    send_daily_report(orders, nav)
</code></pre>
<h4 data-id="heading-24">6.3 模拟盘要跑多久</h4>
<p>我的标准：</p>
<ul>
<li><strong>最少1个月</strong>：覆盖月初/月末效应</li>
<li><strong>最好3个月</strong>：覆盖一个季度的各种行情</li>
<li><strong>经历一次回撤</strong>：没见过回撤的策略不敢上实盘</li>
</ul>
<hr/>
<h3 data-id="heading-25">七、实盘：小心翼翼地开始</h3>
<h4 data-id="heading-26">7.1 实盘原则</h4>
<ol>
<li><strong>小资金起步</strong>：先用计划资金的10%试跑</li>
<li><strong>保持记录</strong>：每笔交易都记录原因</li>
<li><strong>不改策略</strong>：实盘期间不要动核心逻辑</li>
<li><strong>定期复盘</strong>：每周/每月回顾</li>
</ol>
<h4 data-id="heading-27">7.2 监控体系</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实盘监控要点</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">monitor</span>():
    <span class="hljs-comment"># 1. 持仓监控</span>
    positions = get_positions()
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> positions:
        <span class="hljs-keyword">if</span> p[<span class="hljs-string">'pnl_pct'</span>] &lt; -<span class="hljs-number">0.05</span>:  <span class="hljs-comment"># 单只亏损超5%</span>
            alert(<span class="hljs-string">f"警告：<span class="hljs-subst">{p[<span class="hljs-string">'symbol'</span>]}</span> 亏损 <span class="hljs-subst">{p[<span class="hljs-string">'pnl_pct'</span>]:<span class="hljs-number">.2</span>%}</span>"</span>)

    <span class="hljs-comment"># 2. 整体回撤监控</span>
    nav = get_current_nav()
    max_nav = get_max_nav()
    drawdown = (nav - max_nav) / max_nav
    <span class="hljs-keyword">if</span> drawdown &lt; -<span class="hljs-number">0.10</span>:  <span class="hljs-comment"># 回撤超10%</span>
        alert(<span class="hljs-string">f"警告：整体回撤 <span class="hljs-subst">{drawdown:<span class="hljs-number">.2</span>%}</span>"</span>)

    <span class="hljs-comment"># 3. 策略执行监控</span>
    expected_positions = strategy.calculate_positions()
    actual_positions = get_positions()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> positions_match(expected_positions, actual_positions):
        alert(<span class="hljs-string">"警告：实际持仓与策略目标不一致"</span>)

    <span class="hljs-comment"># 4. 数据监控</span>
    <span class="hljs-keyword">if</span> data_source_is_down():
        alert(<span class="hljs-string">"警告：数据源异常"</span>)
</code></pre>
<h4 data-id="heading-28">7.3 什么时候停止策略</h4>
<ul>
<li>回撤超过预设阈值（比如20%）</li>
<li>策略逻辑失效（市场结构变化）</li>
<li>连续N个月跑输基准</li>
<li>发现代码bug</li>
</ul>
<hr/>
<h3 data-id="heading-29">八、复盘迭代：持续进化</h3>
<h4 data-id="heading-30">8.1 每周复盘</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 周复盘模板</span>

<span class="hljs-section">## 本周表现</span>
<span class="hljs-bullet">-</span> 策略收益：+1.2%
<span class="hljs-bullet">-</span> 基准收益：+0.8%
<span class="hljs-bullet">-</span> 超额收益：+0.4%

<span class="hljs-section">## 交易记录</span>
| 日期 | 操作 | 股票 | 盈亏 |
|------|------|------|------|
| 周一 | 买入 | 000001 | - |
| 周三 | 卖出 | 600519 | +3.2% |

<span class="hljs-section">## 信号回顾</span>
<span class="hljs-bullet">-</span> 产生了哪些信号
<span class="hljs-bullet">-</span> 哪些执行了，哪些没执行
<span class="hljs-bullet">-</span> 没执行的原因

<span class="hljs-section">## 问题与思考</span>
<span class="hljs-bullet">-</span> 本周有什么异常情况
<span class="hljs-bullet">-</span> 策略表现是否符合预期
<span class="hljs-bullet">-</span> 有什么需要调整的
</code></pre>
<h4 data-id="heading-31">8.2 每月复盘</h4>
<ul>
<li>月度收益归因（alpha来自哪里）</li>
<li>与回测结果对比</li>
<li>参数是否需要微调</li>
<li>市场环境变化分析</li>
</ul>
<h4 data-id="heading-32">8.3 迭代原则</h4>
<ul>
<li><strong>不要频繁改动</strong>：至少跑完一个完整周期再改</li>
<li><strong>改一处测一处</strong>：不要同时改多个地方</li>
<li><strong>保留历史版本</strong>：万一改坏了能回滚</li>
</ul>
<hr/>
<h3 data-id="heading-33">总结</h3>
<p>一个完整的量化工作流：</p>
<pre><code class="hljs language-markdown" lang="markdown">想法 → 数据 → 开发 → 回测 → 优化 → 模拟 → 实盘 → 复盘
<span class="hljs-code">                                                    ↓
                              发现问题 ← ← ← ← ← ← ←┘
</span></code></pre>
<p>每个环节都不能跳过，跳过的代价就是在实盘时用真金白银来补课。</p>
<p><strong>没有完美的策略，只有持续迭代的系统。</strong></p>
<hr/>
<p><em>下一篇预告：《为什么你的回测结果不可信？量化回测的7个致命错误》</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nuxt 配 modules模块 以及 数据交互]]></title>    <link>https://juejin.cn/post/7598020609281916962</link>    <guid>https://juejin.cn/post/7598020609281916962</guid>    <pubDate>2026-01-22T10:26:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598020609281916962" data-draft-id="7597742970281771060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nuxt 配 modules模块 以及 数据交互"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T10:26:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nuxt 配 modules模块 以及 数据交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:26:59.000Z" title="Thu Jan 22 2026 10:26:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><ul>
<li>类型 <code>Array</code></li>
</ul>
<p><code>modules</code>是<code>Nuxt.js</code>扩展，可以扩展它的核心功能并添加无限。</p>
<p>例如(<code>nuxt.config.js</code>)：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">modules</span>: [
    <span class="hljs-comment">// Using package name</span>
    <span class="hljs-string">'@nuxtjs/axios'</span>,
    
    <span class="hljs-comment">// Relative to your project srcDir</span>
    <span class="hljs-string">'~/modules/awesome.js'</span>,
    
    <span class="hljs-comment">// Providing options</span>
    [<span class="hljs-string">'@nuxtjs/google-analytics'</span>, { <span class="hljs-attr">ua</span>: <span class="hljs-string">'X1234567'</span> }],
    
    <span class="hljs-comment">// Inline definition</span>
    <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}
  ]
}
</code></pre>
<p>安装过程中，它会让我们选择模块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b0de2658ac42d0a6a0fba23941768e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769682419&amp;x-signature=f%2Fy2xVYpLpzf72aLzaRyLY8i%2BjE%3D" alt="image.png" loading="lazy"/></p>
<p><code>Axios - Promise based HTTP client</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// nuxt.config.js</span>
{
  <span class="hljs-attr">modules</span>: [
    <span class="hljs-string">'@nuxtjs/axios'</span> <span class="hljs-comment">// 前面安装nuxtjs的时候没选，也可以后续一条命令去装上去 ==&gt; npm install @nuxtjs/axios -initial-scale</span>
  ]
}
</code></pre>
<p>// 笔记.html</p>
<pre><code class="hljs language-md" lang="md">一、安装nuxt的axios
<span class="hljs-code">    1.1 npm install @nuxtjs/axios -S
    1.2 nuxt.config.js进行配置
    
    modules: [
      '@nuxtjs/axios',
    ]
</span>
二、安装axios
<span class="hljs-code">    2.1 npm install axios -S
    
</span></code></pre>
<p>在每一个页面中或者每个component中用axios。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>页面<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'IndexPage'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>在nuxt中如何请求接口。两种方式：</p>
<h2 data-id="heading-0">异步数据</h2>
<p>请求接口一定是首先先把服务器端的接口拿到了。然后再打开页面，这个时候源代码中就有接口数据了。那这个时候蜘蛛就可以爬取到这个数据了。如果还是像vue一样，这个页面打开了，再把数据返回来，那蜘蛛就抓取不到了。</p>
<p>在页面中有一个生命周期。叫<code>asyncData</code>。</p>
<p>Nuxt.js扩展了Vue.js，增加了一个叫<code>asyncData</code>的方法，使得我们可以在设置组件的数据之前能异步获取或处理数据。</p>
<h2 data-id="heading-1">asyncData</h2>
<p>这个是个生命周期。</p>
<p>asyncData方法会在组件（限于页面组件）每次加载之前被调用。可在服务端或路由更新之前被调用。</p>
<p>在这个方法被调用的时候，第一个参数被设定为当前页面的上下文对象，可以用asyncData方法来获取数据，</p>
<pre><code class="hljs language-md" lang="md">三、asyncData生命周期 || 方法
  
  pages 目录中的页面组件才可以去用
  
<span class="hljs-code">    ***注意components内的.vue文件是不可以使用的。
  
</span></code></pre>
<pre><code class="hljs language-html" lang="html">// index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/script"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {},
  <span class="hljs-title function_">asyncData</span>(<span class="hljs-params">app</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，app对象下面有一个<code>$axios</code>；</p>
<p>在控制台，和在服务端都可以打印出来。</p>
<p>所以也可以这样子写：</p>
<pre><code class="hljs language-html" lang="html">// index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/script"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {},
  <span class="hljs-title function_">asyncData</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($axios)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这样子就可以去请求接口，放进去。</p>
<p>接口给过来，都是后端代码上面去解决跨域问题。至于nuxt如何解决跨域，待会说。</p>
<p>这里写一个async 和 await</p>
<pre><code class="hljs language-html" lang="html">// pages/index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'IndexPage'</span>,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> $axios(<span class="hljs-string">'后端给的接口地址'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
  }
}
&lt;/scirpt&gt;
</span></code></pre>
<p>拿到数据之后呢，要把数据渲染到也米娜上，如果是vue的话，</p>
<pre><code class="hljs language-html" lang="html">// pages/index.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">'item in list'</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">'item.id'</span>&gt;</span>
        {{ item.imageName }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'IndexPage'</span>,
  data () {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: []
    }
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> $axios(<span class="hljs-string">'后端给的接口地址'</span>)
    <span class="hljs-keyword">const</span> list = res.<span class="hljs-property">data</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
    <span class="hljs-comment">// 要这样</span>
    <span class="hljs-keyword">return</span> { list }
    <span class="hljs-comment">// 不要这样</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = list
  }
}
&lt;/scirpt&gt;
</span></code></pre>
<p>按照vue来讲，这上面完全没问题，但是nuxt中不行。其实不是nuxt不行，而是asyncData不行，在asyncData中是不能写this的，因为在asyncData中this是undefined。</p>
<p>注意：在<code>asyncData</code>中没有<code>this</code>。</p>
<p>其实在这个地方，有写到，说要<code>return</code>。说白了,<code>nuxt.js</code>会将<code>asyncData</code>返回的数据融合组件<code>data</code>方法返回的数据并返回给当前组件。</p>
<p>其实就是<code>data () { return { list: [] } }</code>，和<code>asyncData</code>里面的return 合并数据，然后。</p>
<p>然后重新去看页面，就可以看到页面生效了。</p>
<h2 data-id="heading-2">fetch</h2>
<p>还有方式请求接口。</p>
<pre><code class="hljs language-md" lang="md">四、fetch生命周期 || 方法
</code></pre>
<p>首先fetch是在aysncData之后的生命周期，然后fetch也有参数<code>({ $axios })</code>，它也是当前组件的上下文，所以这里的<code>$axios</code>也有接口请求，</p>
<pre><code class="hljs language-md" lang="md">// pages/index.vue
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span>
<span class="hljs-code">    &lt;News /&gt;
    &lt;ul&gt;
      &lt;li v-for='item in list' :key='item.id'&gt;
        {{ item.imageName }}
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/template&gt;
</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span>
export default {
  name: 'IndexPage',
  data () {
<span class="hljs-code">    return {
      list: [],
      items: []
    }
  },
  async asyncData({ $axios }) {
    const res = await $axios('后端给的接口地址')
    const list = res.data
    console.log(res)
    // 要这样
    return { list }
    // 不要这样
    this.list = list
  },
  // 注意fetch里面是可以有this的
  async fetch({ $axios }) {
    const res = await $axios('后端给的接口地址')
    const list = res.data
   
    this.items = list
  }
}
&lt;/scirpt&gt;
</span></code></pre>
<p>不过在页面上能拿到数据，不过在template上打印出来是空数组。所以说在页面级的请求用asyncData。</p>
<pre><code class="hljs language-md" lang="md">四、fetch生命周期 || 方法
  fetch是有this的
</code></pre>
<p>在<code>components</code>下创建个<code>News.vue</code>:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>111<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 注意fetch里面是可以有this的</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> $axios(<span class="hljs-string">'后端给的接口地址'</span>)
    <span class="hljs-keyword">const</span> list = res.<span class="hljs-property">data</span>
   
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = list
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>刚刚提到的一点，<code>asyncData</code>在页面级别的组件是可以拿到的，可以执行的，在某个组件中，<code>component</code>中。asyncData是不能用在component上的，那它这种只能引入fetch，必须用fetch。</p>
<p><code>fetch</code>方法用于在渲染页面前填充应用的状态树（<code>store</code>）数据，与<code>asyncData</code>方法类似，不同的是它不会设置组件的数据。</p>
<pre><code class="hljs language-md" lang="md">四、fetch生命周期 || 方法
  fetch是有this的
</code></pre>
<p>在<code>components</code>下创建个<code>News.vue</code>:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>111<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 注意fetch里面是可以有this的</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-comment">// 在组件中，这里是没有$axios的，</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> $axios(<span class="hljs-string">'后端给的接口地址'</span>)
    <span class="hljs-keyword">const</span> list = res.<span class="hljs-property">data</span>
   
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = list
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      111
      {{ list }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  data () {
    <span class="hljs-keyword">return</span> {
      list
    }
  },
  <span class="hljs-comment">// 注意fetch里面是可以有this的</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 正确</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$axios(<span class="hljs-string">'后端给的接口地址'</span>)
    <span class="hljs-keyword">const</span> list = res.<span class="hljs-property">data</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = list
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 ooder-skill 到标准 skill 的实战转换指南]]></title>    <link>https://juejin.cn/post/7598021313869922310</link>    <guid>https://juejin.cn/post/7598021313869922310</guid>    <pubDate>2026-01-22T10:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598021313869922310" data-draft-id="7597968460652937258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从 ooder-skill 到标准 skill 的实战转换指南"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-22T10:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从 ooder-skill 到标准 skill 的实战转换指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:31:55.000Z" title="Thu Jan 22 2026 10:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>本文是ooder agent 团队在trae-solo辅助下将ooder-skill的skills-a2ui,skills-annotation,skills-vfs ,skills-superAgent, 等程序完成迁移由 trae-solo 整理完成。在solo下测试通过。其他 AICoding   工具可以参考修改，也可以将文档喂给IDE辅助生成。全文如下：</p>
<p>ooder-skills 是一种常见的技能实现方式，但为了更好地与标准平台集成、节省 Token 消耗并获得更广泛的兼容性，将其转换为标准 solo-skills 是非常有必要的。本文将详细介绍如何将 ooder-skills 转换为标准 solo-skills 的完整流程，并提供实际的文件对比和转换步骤。</p>
<h2 data-id="heading-1">核心概念：MCP (Model Control Plane)</h2>
<p>在转换过程中，我们引入了 MCP (Model Control Plane) 架构，用于处理大型模型与 ooder-agent 之间的交互。MCP 提供了以下核心功能：</p>
<ul>
<li><strong>智能缓存</strong>：缓存频繁使用的响应，减少重复请求</li>
<li><strong>自动重试</strong>：内置请求重试机制，提高服务调用的可靠性</li>
<li><strong>健康监控</strong>：提供 MCP 状态和健康检查功能，确保系统稳定运行</li>
<li><strong>统一接口</strong>：为大型模型提供统一的接口，简化交互流程</li>
</ul>
<p>通过 MCP，我们可以完全替代 Node.js 实现，使用 ooder-agent web 访问来执行各种功能，从而达到节省 Token、提高执行效率的目的。</p>
<h2 data-id="heading-2">一、ooder-skills 与标准 solo-skills 的结构对比</h2>
<h3 data-id="heading-3">1. ooder-skills 典型结构</h3>
<pre><code class="hljs language-bash" lang="bash">ooder-skills/
├── config.json           <span class="hljs-comment"># 配置文件</span>
├── main.sh               <span class="hljs-comment"># 主要逻辑</span>
├── requirements.txt      <span class="hljs-comment"># 依赖管理</span>
├── README.md             <span class="hljs-comment"># 说明文档</span>
└── utils/                <span class="hljs-comment"># 工具函数</span>
    └── helper.sh
</code></pre>
<h3 data-id="heading-4">2. 标准 solo-skills 结构</h3>
<pre><code class="hljs language-bash" lang="bash">standard-solo-skills/
├── skill.yaml            <span class="hljs-comment"># 1 级：元数据（轻量级）</span>
├── SKILL.md              <span class="hljs-comment"># 2 级：说明文档（按需加载）</span>
├── scripts/              <span class="hljs-comment"># 3 级+：脚本文件（按需执行）</span>
│   ├── common.sh         <span class="hljs-comment"># 通用工具函数（包含 MCP 核心功能）</span>
│   ├── execute.sh        <span class="hljs-comment"># 执行功能（使用 MCP 调用）</span>
│   ├── info.sh           <span class="hljs-comment"># 获取信息</span>
│   └── mcp.sh            <span class="hljs-comment"># MCP 功能（处理大型模型交互）</span>
└── references/           <span class="hljs-comment"># 参考资料（可选）</span>
</code></pre>
<h2 data-id="heading-5">二、核心文件对比</h2>
<h3 data-id="heading-6">1. 配置文件对比</h3>
<h4 data-id="heading-7">ooder-skills: config.json</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ooder Skill"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ooder skill description"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ooder Team"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"curl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jq"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main.sh"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bash main.sh"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">标准 solo-skills: skill.yaml</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Standard</span> <span class="hljs-string">Skill</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">0.2</span><span class="hljs-number">.0</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">标准</span> <span class="hljs-string">solo-skills</span> <span class="hljs-string">描述，支持通过</span> <span class="hljs-string">web</span> <span class="hljs-string">API</span> <span class="hljs-string">调用服务</span>
<span class="hljs-attr">author:</span> <span class="hljs-string">OODER</span> <span class="hljs-string">Team</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">utility</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">web</span>
<span class="hljs-attr">category:</span> <span class="hljs-string">UTILITY_SKILL</span>
<span class="hljs-attr">tools:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web-api</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">通过</span> <span class="hljs-string">HTTP</span> <span class="hljs-string">API</span> <span class="hljs-string">调用服务</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">http</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://localhost:9010/api/v1</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SKILL.md</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">documentation</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">SKILL.md</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">scripts</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">directory</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">scripts</span>
</code></pre>
<h3 data-id="heading-9">2. 主要逻辑文件对比</h3>
<h4 data-id="heading-10">ooder-skills: main.sh</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 加载工具函数</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"utils/helper.sh"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"utils/helper.sh"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "找不到 helper.sh 脚本"}'</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 执行函数</span>
<span class="hljs-function"><span class="hljs-title">execute_function</span></span>() {
    <span class="hljs-built_in">local</span> function_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"hello"</span>)
            <span class="hljs-built_in">local</span> name=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> | grep -o <span class="hljs-string">'"name":"[^"]*"'</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'"'</span> -f4)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": true, "data": {"message": "Hello, '</span><span class="hljs-variable">$name</span><span class="hljs-string">'!"}}'</span>
            ;;
        <span class="hljs-string">"calculate"</span>)
            <span class="hljs-built_in">local</span> result=$(calculate <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": true, "data": {"result": '</span><span class="hljs-variable">$result</span><span class="hljs-string">'}}'</span>
            ;;
        *)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "Unknown function"}'</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 命令行执行</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$BASH_SOURCE</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> function_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    execute_function <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-11">标准 solo-skills: scripts/execute.sh</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 加载通用工具函数</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "找不到 common.sh 脚本"}'</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查依赖项</span>
    check_dependencies
    
    <span class="hljs-comment"># 解析命令行参数</span>
    <span class="hljs-built_in">local</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"{}"</span>
    <span class="hljs-built_in">local</span> displayMode=<span class="hljs-string">"a2ui"</span>
    
    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --<span class="hljs-keyword">function</span>)
                <span class="hljs-keyword">function</span>=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --params)
                params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --displayMode)
                displayMode=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            *)
                <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"未知参数: <span class="hljs-variable">$1</span>"</span>
                <span class="hljs-built_in">shift</span>
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 验证参数</span>
    <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "缺少 function 参数"}'</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 构建请求数据</span>
    <span class="hljs-built_in">local</span> request_data=$(build_json \
        <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
        <span class="hljs-string">"params"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> \
        <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span>
    )
    
    <span class="hljs-comment"># 发送请求（使用 MCP 功能）</span>
    <span class="hljs-built_in">local</span> start_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> response=$(mcp_call <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span>)
    <span class="hljs-built_in">local</span> end_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> execution_time=$((end_time - start_time))
    
    <span class="hljs-comment"># 处理响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 构建带 metadata 的响应</span>
        <span class="hljs-built_in">local</span> metadata=$(build_json \
            <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
            <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span> \
            <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
            <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
        )
        
        <span class="hljs-comment"># 解析并返回结果</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-subst">$(command -v jq)</span>"</span> ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">local</span> success=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.success'</span>)
            <span class="hljs-built_in">local</span> data=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -c <span class="hljs-string">'.data'</span>)
            <span class="hljs-built_in">local</span> error=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.error // empty'</span>)
            <span class="hljs-built_in">local</span> final_response=$(build_response <span class="hljs-string">"<span class="hljs-variable">$success</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$error</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$final_response</span>"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 构建错误响应</span>
        <span class="hljs-built_in">local</span> error_message=<span class="hljs-string">"执行功能失败"</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> ]]; <span class="hljs-keyword">then</span>
            error_message=<span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">local</span> metadata=$(build_json \
            <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
            <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span> \
            <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
            <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
        )
        
        <span class="hljs-built_in">local</span> error_response=$(build_response <span class="hljs-string">"false"</span> <span class="hljs-string">""</span> <span class="hljs-string">"<span class="hljs-variable">$error_message</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$error_response</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-12">3. 说明文档对比</h3>
<h4 data-id="heading-13">ooder-skills: README.md</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Ooder Skill</span>

<span class="hljs-section">## 功能</span>
<span class="hljs-bullet">-</span> 问候功能
<span class="hljs-bullet">-</span> 计算功能

<span class="hljs-section">## 使用</span>
<span class="hljs-code">```bash
bash main.sh hello '{"name": "World"}'
</span></code></pre>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">#### 标准 solo-skills: SKILL.md</span>

```markdown
<span class="hljs-comment"># Standard Skill</span>

<span class="hljs-comment">## 技能概述</span>

Standard Skill 是一个标准的 solo-skills 实现，通过 web API 调用服务，实现实用功能的执行。

<span class="hljs-comment">## 使用场景</span>

- **日常实用功能**：执行基本的问候、计算等操作
- **Web 服务集成**：通过 HTTP API 与服务集成
- **节省 Token**：利用分级加载机制和 web 调用，减少 Token 消耗
- **MCP 功能**：通过 Model Control Plane 优化大型模型交互

<span class="hljs-comment">## 工作原理</span>

Standard Skill 采用三层分级加载机制：

1. **1 级：元数据** - `skill.yaml` 文件，包含技能的基本信息
2. **2 级：说明文档** - 本文件 (`SKILL.md`)，包含详细的使用说明
3. **3 级及以上** - 脚本和资源文件，按需加载执行

<span class="hljs-comment">## 使用方式</span>

<span class="hljs-comment">### 命令行使用</span>

```bash
<span class="hljs-comment"># 执行实用功能</span>
bash scripts/execute.sh --<span class="hljs-keyword">function</span> hello --params <span class="hljs-string">'{"name": "World"}'</span> --displayMode a2ui

<span class="hljs-comment"># 获取技能信息</span>
bash scripts/info.sh

<span class="hljs-comment"># 使用 MCP 功能</span>
bash scripts/mcp.sh --action call --<span class="hljs-keyword">function</span> hello --params <span class="hljs-string">'{"name": "World"}'</span> --displayMode a2ui
</code></pre>
<h2 data-id="heading-14">功能列表</h2>

























<table><thead><tr><th>功能名称</th><th>描述</th><th>参数</th></tr></thead><tbody><tr><td>hello</td><td>简单的问候功能</td><td>name: 问候对象名称</td></tr><tr><td>calculate</td><td>基本计算功能</td><td>a: 第一个操作数, b: 第二个操作数, operation: 操作类型</td></tr><tr><td>mcp-call</td><td>MCP 调用功能</td><td>function: 函数名称, params: 参数, displayMode: 展示模式</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">## 三、详细转换步骤</span>

<span class="hljs-comment">### 步骤 1：创建标准 solo-skills 目录结构</span>

```bash
<span class="hljs-built_in">mkdir</span> -p standard-solo-skills/scripts standard-solo-skills/references
<span class="hljs-built_in">cd</span> standard-solo-skills
</code></pre>
<h3 data-id="heading-15">步骤 2：创建 1 级元数据文件 (skill.yaml)</h3>
<p>基于 ooder-skills 的 config.json，提取核心信息并按照标准格式创建 skill.yaml：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> [<span class="hljs-string">从</span> <span class="hljs-string">config.json</span> <span class="hljs-string">提取</span> <span class="hljs-string">name</span>]
<span class="hljs-attr">version:</span> <span class="hljs-number">0.2</span><span class="hljs-number">.0</span>  <span class="hljs-comment"># 标准 solo-skills 版本号</span>
<span class="hljs-attr">description:</span> [<span class="hljs-string">从</span> <span class="hljs-string">config.json</span> <span class="hljs-string">提取</span> <span class="hljs-string">description</span>]
<span class="hljs-attr">author:</span> [<span class="hljs-string">从</span> <span class="hljs-string">config.json</span> <span class="hljs-string">提取</span> <span class="hljs-string">author</span>]
<span class="hljs-attr">tags:</span>
  <span class="hljs-bullet">-</span> [<span class="hljs-string">根据功能添加标签</span>]
<span class="hljs-attr">category:</span> [<span class="hljs-string">根据功能类型选择类别</span>]
<span class="hljs-attr">tools:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web-api</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">通过</span> <span class="hljs-string">HTTP</span> <span class="hljs-string">API</span> <span class="hljs-string">调用服务</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">http</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://localhost:9010/api/v1</span>  <span class="hljs-comment"># 服务端点</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SKILL.md</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">documentation</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">SKILL.md</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">scripts</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">directory</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">scripts</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">references</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">directory</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">references</span>
</code></pre>
<h3 data-id="heading-16">步骤 3：创建 2 级说明文档 (SKILL.md)</h3>
<p>基于 ooder-skills 的 README.md，按照标准格式扩展为详细的 SKILL.md：</p>
<ol>
<li>添加技能概述</li>
<li>描述使用场景</li>
<li>解释工作原理（分级加载机制）</li>
<li>详细说明使用方式</li>
<li>提供功能列表</li>
<li>添加示例和故障排除</li>
</ol>
<h3 data-id="heading-17">步骤 4：创建 3 级脚本文件</h3>
<h4 data-id="heading-18">4.1 创建通用工具函数 (scripts/common.sh)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 通用工具函数</span>

<span class="hljs-comment"># 服务端点配置</span>
OODER_AGENT_ENDPOINT=<span class="hljs-string">"http://localhost:9010/api/v1"</span>
A2UI_ENDPOINT=<span class="hljs-string">"http://localhost:8081/api/a2ui"</span>

<span class="hljs-comment"># 日志级别</span>
LOG_LEVEL=<span class="hljs-string">"info"</span>

<span class="hljs-comment"># 缓存配置</span>
CACHE_DIR=<span class="hljs-string">"<span class="hljs-variable">${HOME}</span>/.ooder-skill-cache"</span>
CACHE_EXPIRY=3600 <span class="hljs-comment"># 缓存过期时间（秒）</span>

<span class="hljs-comment"># 重试配置</span>
MAX_RETRIES=3
RETRY_DELAY=2 <span class="hljs-comment"># 重试延迟（秒）</span>

<span class="hljs-comment"># 打印日志</span>
<span class="hljs-function"><span class="hljs-title">log</span></span>() {
    <span class="hljs-built_in">local</span> level=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> message=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> timestamp=$(<span class="hljs-built_in">date</span> +<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
    
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$level</span>"</span> == <span class="hljs-string">"error"</span> || <span class="hljs-string">"<span class="hljs-variable">$LOG_LEVEL</span>"</span> == <span class="hljs-string">"debug"</span> || <span class="hljs-string">"<span class="hljs-variable">$LOG_LEVEL</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$level</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$timestamp</span>] [<span class="hljs-variable">$level</span>] <span class="hljs-variable">$message</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 检查命令是否存在</span>
<span class="hljs-function"><span class="hljs-title">check_command</span></span>() {
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">command</span>=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"error"</span> <span class="hljs-string">"命令 <span class="hljs-variable">$command</span> 不存在，请安装"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 检查依赖项</span>
<span class="hljs-function"><span class="hljs-title">check_dependencies</span></span>() {
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"检查依赖项..."</span>
    
    <span class="hljs-comment"># 检查 curl</span>
    <span class="hljs-keyword">if</span> ! check_command <span class="hljs-string">"curl"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "缺少 curl 命令，请安装"}'</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查 jq</span>
    <span class="hljs-keyword">if</span> ! check_command <span class="hljs-string">"jq"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"缺少 jq 命令，某些功能可能无法正常工作"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"依赖项检查完成"</span>
}

<span class="hljs-comment"># 初始化缓存目录</span>
<span class="hljs-function"><span class="hljs-title">init_cache</span></span>() {
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"创建缓存目录: <span class="hljs-variable">$CACHE_DIR</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 生成缓存键</span>
<span class="hljs-function"><span class="hljs-title">generate_cache_key</span></span>() {
    <span class="hljs-built_in">local</span> prefix=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">${prefix}</span>_<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> | md5sum | cut -d' ' -f1)</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span>
}

<span class="hljs-comment"># 检查缓存是否有效</span>
<span class="hljs-function"><span class="hljs-title">is_cache_valid</span></span>() {
    <span class="hljs-built_in">local</span> cache_file=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">local</span> file_time=$(<span class="hljs-built_in">stat</span> -c %Y <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span> 2&gt;/dev/null || <span class="hljs-built_in">stat</span> -f %m <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span> 2&gt;/dev/null)
    <span class="hljs-built_in">local</span> current_time=$(<span class="hljs-built_in">date</span> +%s)
    
    <span class="hljs-keyword">if</span> [[ $((current_time - file_time)) -lt <span class="hljs-variable">$CACHE_EXPIRY</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 获取缓存</span>
<span class="hljs-function"><span class="hljs-title">get_cache</span></span>() {
    <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> cache_file=<span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>/<span class="hljs-variable">$key</span>"</span>
    
    <span class="hljs-keyword">if</span> is_cache_valid <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"从缓存获取: <span class="hljs-variable">$key</span>"</span>
        <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 设置缓存</span>
<span class="hljs-function"><span class="hljs-title">set_cache</span></span>() {
    <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> value=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> cache_file=<span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>/<span class="hljs-variable">$key</span>"</span>
    
    init_cache
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$cache_file</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"设置缓存: <span class="hljs-variable">$key</span>"</span>
}

<span class="hljs-comment"># 发送 HTTP 请求（带重试机制）</span>
<span class="hljs-function"><span class="hljs-title">send_http_request</span></span>() {
    <span class="hljs-built_in">local</span> method=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> url=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> data=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span>
    <span class="hljs-built_in">local</span> headers=<span class="hljs-string">"<span class="hljs-variable">$4</span>"</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"发送 <span class="hljs-variable">$method</span> 请求到 <span class="hljs-variable">$url</span>"</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"请求数据: <span class="hljs-variable">$data</span>"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">local</span> response
    <span class="hljs-built_in">local</span> status_code
    <span class="hljs-built_in">local</span> retry_count=0
    
    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$retry_count</span> -lt <span class="hljs-variable">$MAX_RETRIES</span> ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$method</span>"</span> == <span class="hljs-string">"POST"</span> ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$headers</span>"</span> ]]; <span class="hljs-keyword">then</span>
                response=$(curl -s -X POST -H <span class="hljs-string">"Content-Type: application/json"</span> -H <span class="hljs-string">"<span class="hljs-variable">$headers</span>"</span> -d <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span>)
            <span class="hljs-keyword">else</span>
                response=$(curl -s -X POST -H <span class="hljs-string">"Content-Type: application/json"</span> -d <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span>)
            <span class="hljs-keyword">fi</span>
        <span class="hljs-keyword">else</span>
            response=$(curl -s -X GET <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span>)
        <span class="hljs-keyword">fi</span>
        
        status_code=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> -X <span class="hljs-string">"<span class="hljs-variable">$method</span>"</span> -H <span class="hljs-string">"Content-Type: application/json"</span> <span class="hljs-variable">${data:+-d "$data"}</span> <span class="hljs-string">"<span class="hljs-variable">$url</span>"</span>)
        
        <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"响应状态码: <span class="hljs-variable">$status_code</span>"</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"debug"</span> <span class="hljs-string">"响应数据: <span class="hljs-variable">$response</span>"</span>
        
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$status_code</span>"</span> -ge 200 &amp;&amp; <span class="hljs-string">"<span class="hljs-variable">$status_code</span>"</span> -lt 300 ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
            <span class="hljs-built_in">return</span> 0
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"HTTP 请求失败，状态码: <span class="hljs-variable">$status_code</span>，将重试 (<span class="hljs-variable">$retry_count</span>/<span class="hljs-variable">$MAX_RETRIES</span>)"</span>
            retry_count=$((retry_count + <span class="hljs-number">1</span>))
            <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$retry_count</span> -lt <span class="hljs-variable">$MAX_RETRIES</span> ]]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$RETRY_DELAY</span>
            <span class="hljs-keyword">fi</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"error"</span> <span class="hljs-string">"HTTP 请求失败，已达到最大重试次数"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "HTTP 请求失败，已达到最大重试次数", "response": "'</span><span class="hljs-string">"<span class="hljs-variable">$response</span>"</span><span class="hljs-string">'"}'</span>
    <span class="hljs-built_in">return</span> 1
}

<span class="hljs-comment"># MCP (Model Control Plane) 功能：调用 ooder-agent</span>
<span class="hljs-function"><span class="hljs-title">mcp_call</span></span>() {
    <span class="hljs-built_in">local</span> function_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> display_mode=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span>
    
    <span class="hljs-comment"># 生成缓存键</span>
    <span class="hljs-built_in">local</span> cache_key=$(generate_cache_key <span class="hljs-string">"mcp_<span class="hljs-variable">${function_name}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span>)
    
    <span class="hljs-comment"># 尝试从缓存获取</span>
    <span class="hljs-built_in">local</span> cached_response
    <span class="hljs-keyword">if</span> cached_response=$(get_cache <span class="hljs-string">"<span class="hljs-variable">$cache_key</span>"</span>); <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"使用缓存响应"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$cached_response</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 构建请求数据</span>
    <span class="hljs-built_in">local</span> request_data=$(build_json \
        <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> \
        <span class="hljs-string">"params"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> \
        <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$display_mode</span>"</span>
    )
    
    <span class="hljs-comment"># 发送请求</span>
    <span class="hljs-built_in">local</span> response=$(send_http_request <span class="hljs-string">"POST"</span> <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>/execute"</span> <span class="hljs-string">"<span class="hljs-variable">$request_data</span>"</span>)
    
    <span class="hljs-comment"># 检查响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>:<span class="hljs-literal">true</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 设置缓存</span>
        set_cache <span class="hljs-string">"<span class="hljs-variable">$cache_key</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 解析命令行参数</span>
<span class="hljs-function"><span class="hljs-title">parse_args</span></span>() {
    <span class="hljs-built_in">local</span> args=()
    <span class="hljs-built_in">local</span> current_key
    
    <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$arg</span>"</span> == --* ]]; <span class="hljs-keyword">then</span>
            current_key=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$arg</span>"</span> | sed <span class="hljs-string">'s/^--//'</span>)
            args[<span class="hljs-string">"<span class="hljs-variable">$current_key</span>"</span>]=<span class="hljs-string">""</span>
        <span class="hljs-keyword">elif</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$current_key</span>"</span> ]]; <span class="hljs-keyword">then</span>
            args[<span class="hljs-string">"<span class="hljs-variable">$current_key</span>"</span>]=<span class="hljs-string">"<span class="hljs-variable">$arg</span>"</span>
            current_key=<span class="hljs-string">""</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${args[@]}</span>"</span>
}

<span class="hljs-comment"># 构建 JSON 对象</span>
<span class="hljs-function"><span class="hljs-title">build_json</span></span>() {
    <span class="hljs-built_in">local</span> json=<span class="hljs-string">"{"</span>
    <span class="hljs-built_in">local</span> first=<span class="hljs-literal">true</span>
    
    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
        <span class="hljs-built_in">local</span> value=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
        <span class="hljs-built_in">shift</span> 2
        
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$first</span>"</span> == <span class="hljs-literal">true</span> ]]; <span class="hljs-keyword">then</span>
            first=<span class="hljs-literal">false</span>
        <span class="hljs-keyword">else</span>
            json=<span class="hljs-string">"<span class="hljs-variable">$json</span>,"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> =~ ^[0-9]+$ ]]; <span class="hljs-keyword">then</span>
            json=<span class="hljs-string">"<span class="hljs-variable">$json</span>\"<span class="hljs-variable">$key</span>\":<span class="hljs-variable">$value</span>"</span>
        <span class="hljs-keyword">elif</span> [[ <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> == <span class="hljs-literal">true</span> || <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> == <span class="hljs-literal">false</span> ]]; <span class="hljs-keyword">then</span>
            json=<span class="hljs-string">"<span class="hljs-variable">$json</span>\"<span class="hljs-variable">$key</span>\":<span class="hljs-variable">$value</span>"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-comment"># 转义 JSON 字符串</span>
            <span class="hljs-built_in">local</span> escaped_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$value</span>"</span> | sed <span class="hljs-string">'s/"/\\"/g'</span> | sed <span class="hljs-string">'s/\\/\\\\/g'</span> | sed <span class="hljs-string">'s/\n/\\n/g'</span> | sed <span class="hljs-string">'s/\r/\\r/g'</span> | sed <span class="hljs-string">'s/\t/\\t/g'</span>)
            json=<span class="hljs-string">"<span class="hljs-variable">$json</span>\"<span class="hljs-variable">$key</span>\":\"<span class="hljs-variable">$escaped_value</span>\""</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    json=<span class="hljs-string">"<span class="hljs-variable">$json</span>}"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json</span>"</span>
}

<span class="hljs-comment"># 验证 JSON 格式</span>
<span class="hljs-function"><span class="hljs-title">validate_json</span></span>() {
    <span class="hljs-built_in">local</span> json=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-subst">$(command -v jq)</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json</span>"</span> | jq . &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">log</span> <span class="hljs-string">"error"</span> <span class="hljs-string">"无效的 JSON 格式: <span class="hljs-variable">$json</span>"</span>
            <span class="hljs-built_in">return</span> 1
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 检查服务可用性</span>
<span class="hljs-function"><span class="hljs-title">check_service_availability</span></span>() {
    <span class="hljs-built_in">local</span> endpoint=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> service_name=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"检查 <span class="hljs-variable">$service_name</span> 服务可用性..."</span>
    
    <span class="hljs-built_in">local</span> status_code=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> <span class="hljs-string">"<span class="hljs-variable">$endpoint</span>/health"</span> 2&gt;/dev/null)
    
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$status_code</span>"</span> -eq 200 ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"<span class="hljs-variable">$service_name</span> 服务可用"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 尝试其他端点</span>
        status_code=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> <span class="hljs-string">"<span class="hljs-variable">$endpoint</span>/info"</span> 2&gt;/dev/null)
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$status_code</span>"</span> -eq 200 ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"<span class="hljs-variable">$service_name</span> 服务可用"</span>
            <span class="hljs-built_in">return</span> 0
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"<span class="hljs-variable">$service_name</span> 服务可能不可用，状态码: <span class="hljs-variable">$status_code</span>"</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"将继续执行，可能会失败"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 构建响应结果</span>
<span class="hljs-function"><span class="hljs-title">build_response</span></span>() {
    <span class="hljs-built_in">local</span> success=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> data=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> error=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span>
    <span class="hljs-built_in">local</span> metadata=<span class="hljs-string">"<span class="hljs-variable">$4</span>"</span>
    
    <span class="hljs-built_in">local</span> response=<span class="hljs-string">"{"</span>
    <span class="hljs-built_in">local</span> first=<span class="hljs-literal">true</span>
    
    <span class="hljs-comment"># success 字段</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$first</span>"</span> == <span class="hljs-literal">true</span> ]]; <span class="hljs-keyword">then</span>
        first=<span class="hljs-literal">false</span>
    <span class="hljs-keyword">else</span>
        response=<span class="hljs-string">"<span class="hljs-variable">$response</span>,"</span>
    <span class="hljs-keyword">fi</span>
    response=<span class="hljs-string">"<span class="hljs-variable">$response</span>\"success\":<span class="hljs-variable">$success</span>"</span>
    
    <span class="hljs-comment"># data 字段</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$first</span>"</span> == <span class="hljs-literal">true</span> ]]; <span class="hljs-keyword">then</span>
            first=<span class="hljs-literal">false</span>
        <span class="hljs-keyword">else</span>
            response=<span class="hljs-string">"<span class="hljs-variable">$response</span>,"</span>
        <span class="hljs-keyword">fi</span>
        response=<span class="hljs-string">"<span class="hljs-variable">$response</span>\"data\":<span class="hljs-variable">$data</span>"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># error 字段</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$error</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$first</span>"</span> == <span class="hljs-literal">true</span> ]]; <span class="hljs-keyword">then</span>
            first=<span class="hljs-literal">false</span>
        <span class="hljs-keyword">else</span>
            response=<span class="hljs-string">"<span class="hljs-variable">$response</span>,"</span>
        <span class="hljs-keyword">fi</span>
        response=<span class="hljs-string">"<span class="hljs-variable">$response</span>\"error\":\"<span class="hljs-variable">$error</span>\""</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># metadata 字段</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$first</span>"</span> == <span class="hljs-literal">true</span> ]]; <span class="hljs-keyword">then</span>
            first=<span class="hljs-literal">false</span>
        <span class="hljs-keyword">else</span>
            response=<span class="hljs-string">"<span class="hljs-variable">$response</span>,"</span>
        <span class="hljs-keyword">fi</span>
        response=<span class="hljs-string">"<span class="hljs-variable">$response</span>\"metadata\":<span class="hljs-variable">$metadata</span>"</span>
    <span class="hljs-keyword">fi</span>
    
    response=<span class="hljs-string">"<span class="hljs-variable">$response</span>}"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
}

<span class="hljs-comment"># 主函数入口</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查依赖项</span>
    check_dependencies
    
    <span class="hljs-comment"># 初始化缓存</span>
    init_cache
    
    <span class="hljs-comment"># 检查服务可用性</span>
    check_service_availability <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>"</span> <span class="hljs-string">"ooder-agent"</span>
    check_service_availability <span class="hljs-string">"<span class="hljs-variable">$A2UI_ENDPOINT</span>"</span> <span class="hljs-string">"A2UI"</span>
}

<span class="hljs-comment"># 如果直接执行此脚本，则运行主函数</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$BASH_SOURCE</span>"</span> ]]; <span class="hljs-keyword">then</span>
    main
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-19">4.2 创建执行脚本 (scripts/execute.sh)</h4>
<p>参考 ooder-skills 的 main.sh 中的功能实现，创建执行脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 加载通用工具函数</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "找不到 common.sh 脚本"}'</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查依赖项</span>
    check_dependencies
    
    <span class="hljs-comment"># 解析命令行参数</span>
    <span class="hljs-built_in">local</span> <span class="hljs-keyword">function</span>=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"{}"</span>
    <span class="hljs-built_in">local</span> displayMode=<span class="hljs-string">"a2ui"</span>
    <span class="hljs-built_in">local</span> a2uiTheme=<span class="hljs-string">"light"</span>
    
    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --<span class="hljs-keyword">function</span>)
                <span class="hljs-keyword">function</span>=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --params)
                params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --displayMode)
                displayMode=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --a2uiTheme)
                a2uiTheme=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            *)
                <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"未知参数: <span class="hljs-variable">$1</span>"</span>
                <span class="hljs-built_in">shift</span>
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 验证参数</span>
    <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "缺少 function 参数"}'</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 验证 params JSON 格式</span>
    <span class="hljs-keyword">if</span> ! validate_json <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "params 参数不是有效的 JSON 格式"}'</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"执行功能: <span class="hljs-variable">$function</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"参数: <span class="hljs-variable">$params</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"展示模式: <span class="hljs-variable">$displayMode</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"A2UI 主题: <span class="hljs-variable">$a2uiTheme</span>"</span>
    
    <span class="hljs-comment"># 构建请求数据</span>
    <span class="hljs-built_in">local</span> request_data=$(build_json \
        <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
        <span class="hljs-string">"params"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> \
        <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span> \
        <span class="hljs-string">"a2uiTheme"</span> <span class="hljs-string">"<span class="hljs-variable">$a2uiTheme</span>"</span>
    )
    
    <span class="hljs-comment"># 发送请求（使用 MCP 功能）</span>
    <span class="hljs-built_in">local</span> start_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> response=$(mcp_call <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span>)
    <span class="hljs-built_in">local</span> end_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> execution_time=$((end_time - start_time))
    
    <span class="hljs-comment"># 检查响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 解析响应</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-subst">$(command -v jq)</span>"</span> ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># 使用 jq 美化响应</span>
            <span class="hljs-built_in">local</span> success=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.success'</span>)
            <span class="hljs-built_in">local</span> data=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -c <span class="hljs-string">'.data'</span>)
            <span class="hljs-built_in">local</span> error=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.error // empty'</span>)
            
            <span class="hljs-comment"># 构建带 metadata 的响应</span>
            <span class="hljs-built_in">local</span> metadata=$(build_json \
                <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
                <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span> \
                <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
                <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
            )
            
            <span class="hljs-built_in">local</span> final_response=$(build_response <span class="hljs-string">"<span class="hljs-variable">$success</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$error</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$final_response</span>"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-comment"># 直接返回原始响应</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 构建错误响应</span>
        <span class="hljs-built_in">local</span> error_message=<span class="hljs-string">"执行功能失败"</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> ]]; <span class="hljs-keyword">then</span>
            error_message=<span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">local</span> metadata=$(build_json \
            <span class="hljs-string">"function"</span> <span class="hljs-string">"<span class="hljs-variable">$function</span>"</span> \
            <span class="hljs-string">"displayMode"</span> <span class="hljs-string">"<span class="hljs-variable">$displayMode</span>"</span> \
            <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
            <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
        )
        
        <span class="hljs-built_in">local</span> error_response=$(build_response <span class="hljs-string">"false"</span> <span class="hljs-string">""</span> <span class="hljs-string">"<span class="hljs-variable">$error_message</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$error_response</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h4 data-id="heading-20">4.3 创建信息脚本 (scripts/info.sh)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 加载通用工具函数</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "找不到 common.sh 脚本"}'</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查依赖项</span>
    check_dependencies
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"获取技能信息"</span>
    
    <span class="hljs-comment"># 发送请求</span>
    <span class="hljs-built_in">local</span> start_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> response=$(send_http_request <span class="hljs-string">"GET"</span> <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>/info"</span> <span class="hljs-string">""</span>)
    <span class="hljs-built_in">local</span> end_time=$(<span class="hljs-built_in">date</span> +%s%3N)
    <span class="hljs-built_in">local</span> execution_time=$((end_time - start_time))
    
    <span class="hljs-comment"># 检查响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 解析响应</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-subst">$(command -v jq)</span>"</span> ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># 使用 jq 美化响应</span>
            <span class="hljs-built_in">local</span> success=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.success'</span>)
            <span class="hljs-built_in">local</span> data=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -c <span class="hljs-string">'.data'</span>)
            <span class="hljs-built_in">local</span> error=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.error // empty'</span>)
            
            <span class="hljs-comment"># 构建带 metadata 的响应</span>
            <span class="hljs-built_in">local</span> metadata=$(build_json \
                <span class="hljs-string">"function"</span> <span class="hljs-string">"info"</span> \
                <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
                <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
            )
            
            <span class="hljs-built_in">local</span> final_response=$(build_response <span class="hljs-string">"<span class="hljs-variable">$success</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$error</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$final_response</span>"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-comment"># 直接返回原始响应</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 构建错误响应</span>
        <span class="hljs-built_in">local</span> error_message=<span class="hljs-string">"获取技能信息失败"</span>
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> ]]; <span class="hljs-keyword">then</span>
            error_message=<span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">local</span> metadata=$(build_json \
            <span class="hljs-string">"function"</span> <span class="hljs-string">"info"</span> \
            <span class="hljs-string">"executionTime"</span> <span class="hljs-string">"<span class="hljs-variable">$execution_time</span>"</span> \
            <span class="hljs-string">"skillId"</span> <span class="hljs-string">"standard-solo-skills"</span>
        )
        
        <span class="hljs-built_in">local</span> error_response=$(build_response <span class="hljs-string">"false"</span> <span class="hljs-string">""</span> <span class="hljs-string">"<span class="hljs-variable">$error_message</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$metadata</span>"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$error_response</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h4 data-id="heading-21">4.4 创建 MCP 脚本 (scripts/mcp.sh)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># MCP (Model Control Plane) 脚本</span>
<span class="hljs-comment"># 用于处理大型模型到 ooder-agent 的交互</span>

<span class="hljs-comment"># 加载通用工具函数</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/common.sh"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "找不到 common.sh 脚本"}'</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查依赖项</span>
    check_dependencies
    
    <span class="hljs-comment"># 解析命令行参数</span>
    <span class="hljs-built_in">local</span> action=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> function_name=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"{}"</span>
    <span class="hljs-built_in">local</span> display_mode=<span class="hljs-string">"a2ui"</span>
    <span class="hljs-built_in">local</span> priority=<span class="hljs-string">"normal"</span>
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">timeout</span>=<span class="hljs-string">"30"</span>
    
    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --action)
                action=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --<span class="hljs-keyword">function</span>)
                function_name=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --params)
                params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --displayMode)
                display_mode=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --priority)
                priority=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            --<span class="hljs-built_in">timeout</span>)
                <span class="hljs-built_in">timeout</span>=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            *)
                <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"未知参数: <span class="hljs-variable">$1</span>"</span>
                <span class="hljs-built_in">shift</span>
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 验证必要参数</span>
    <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$action</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "缺少 action 参数"}'</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 根据 action 执行不同操作</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$action</span>"</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"call"</span>)
            <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> ]]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "call 操作需要 function 参数"}'</span>
                <span class="hljs-built_in">exit</span> 1
            <span class="hljs-keyword">fi</span>
            execute_call <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$display_mode</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$priority</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$timeout</span>"</span>
            ;;
        <span class="hljs-string">"status"</span>)
            check_status
            ;;
        <span class="hljs-string">"health"</span>)
            check_health
            ;;
        <span class="hljs-string">"clear-cache"</span>)
            clear_cache
            ;;
        <span class="hljs-string">"list-functions"</span>)
            list_functions
            ;;
        *)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "未知的 action: $action"}'</span>
            <span class="hljs-built_in">exit</span> 1
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 执行 MCP 调用</span>
<span class="hljs-function"><span class="hljs-title">execute_call</span></span>() {
    <span class="hljs-built_in">local</span> function_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    <span class="hljs-built_in">local</span> params=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-built_in">local</span> display_mode=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span>
    <span class="hljs-built_in">local</span> priority=<span class="hljs-string">"<span class="hljs-variable">$4</span>"</span>
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">timeout</span>=<span class="hljs-string">"<span class="hljs-variable">$5</span>"</span>
    
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"执行 MCP 调用: <span class="hljs-variable">$function_name</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"优先级: <span class="hljs-variable">$priority</span>"</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"超时时间: <span class="hljs-variable">$timeout</span> 秒"</span>
    
    <span class="hljs-comment"># 验证 params JSON 格式</span>
    <span class="hljs-keyword">if</span> ! validate_json <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": false, "error": "params 参数不是有效的 JSON 格式"}'</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 使用 MCP 功能调用 ooder-agent</span>
    <span class="hljs-built_in">local</span> response=$(mcp_call <span class="hljs-string">"<span class="hljs-variable">$function_name</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$params</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$display_mode</span>"</span>)
    
    <span class="hljs-comment"># 检查响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"MCP 调用成功"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"error"</span> <span class="hljs-string">"MCP 调用失败"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
}

<span class="hljs-comment"># 检查 MCP 状态</span>
<span class="hljs-function"><span class="hljs-title">check_status</span></span>() {
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"检查 MCP 状态"</span>
    
    <span class="hljs-comment"># 构建请求数据</span>
    <span class="hljs-built_in">local</span> request_data=$(build_json \
        <span class="hljs-string">"action"</span> <span class="hljs-string">"status"</span> \
        <span class="hljs-string">"timestamp"</span> <span class="hljs-string">"<span class="hljs-subst">$(date +%s)</span>"</span>
    )
    
    <span class="hljs-comment"># 发送请求</span>
    <span class="hljs-built_in">local</span> response=$(send_http_request <span class="hljs-string">"GET"</span> <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>/mcp/status"</span> <span class="hljs-string">"<span class="hljs-variable">$request_data</span>"</span>)
    
    <span class="hljs-comment"># 处理响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 添加 MCP 状态信息</span>
        <span class="hljs-built_in">local</span> status_info=$(build_json \
            <span class="hljs-string">"mcp_status"</span> <span class="hljs-string">"active"</span> \
            <span class="hljs-string">"cache_dir"</span> <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span> \
            <span class="hljs-string">"max_retries"</span> <span class="hljs-string">"<span class="hljs-variable">$MAX_RETRIES</span>"</span>
        )
        
        <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-subst">$(command -v jq)</span>"</span> ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">local</span> success=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.success'</span>)
            <span class="hljs-built_in">local</span> data=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -c <span class="hljs-string">'.data'</span>)
            <span class="hljs-built_in">local</span> error=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> | jq -r <span class="hljs-string">'.error // empty'</span>)
            
            <span class="hljs-comment"># 合并数据</span>
            <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> &amp;&amp; <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> != <span class="hljs-string">"null"</span> ]]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">local</span> merged_data=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | jq -c <span class="hljs-string">". + <span class="hljs-variable">$status_info</span>"</span>)
            <span class="hljs-keyword">else</span>
                <span class="hljs-built_in">local</span> merged_data=<span class="hljs-string">"<span class="hljs-variable">$status_info</span>"</span>
            <span class="hljs-keyword">fi</span>
            
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(build_response <span class="hljs-string">"<span class="hljs-variable">$success</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$merged_data</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$error</span>"</span> '')</span>"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 检查健康状态</span>
<span class="hljs-function"><span class="hljs-title">check_health</span></span>() {
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"检查 MCP 健康状态"</span>
    
    <span class="hljs-comment"># 检查服务可用性</span>
    <span class="hljs-built_in">local</span> ooder_agent_status=1
    <span class="hljs-built_in">local</span> a2ui_status=1
    
    check_service_availability <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>"</span> <span class="hljs-string">"ooder-agent"</span>
    ooder_agent_status=$?
    
    check_service_availability <span class="hljs-string">"<span class="hljs-variable">$A2UI_ENDPOINT</span>"</span> <span class="hljs-string">"A2UI"</span>
    a2ui_status=$?
    
    <span class="hljs-comment"># 检查缓存目录</span>
    <span class="hljs-built_in">local</span> cache_status=1
    <span class="hljs-keyword">if</span> [[ -d <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        cache_status=0
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 构建健康状态响应</span>
    <span class="hljs-built_in">local</span> health_data=$(build_json \
        <span class="hljs-string">"ooder_agent"</span> <span class="hljs-string">"<span class="hljs-subst">$((ooder_agent_status == 0 ? 1 : 0)</span>)"</span> \
        <span class="hljs-string">"a2ui"</span> <span class="hljs-string">"<span class="hljs-subst">$((a2ui_status == 0 ? 1 : 0)</span>)"</span> \
        <span class="hljs-string">"cache"</span> <span class="hljs-string">"<span class="hljs-subst">$((cache_status == 0 ? 1 : 0)</span>)"</span> \
        <span class="hljs-string">"timestamp"</span> <span class="hljs-string">"<span class="hljs-subst">$(date +%s)</span>"</span> \
        <span class="hljs-string">"version"</span> <span class="hljs-string">"1.0.0"</span>
    )
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(build_response <span class="hljs-string">"true"</span> <span class="hljs-string">"<span class="hljs-variable">$health_data</span>"</span> <span class="hljs-string">""</span> '')</span>"</span>
}

<span class="hljs-comment"># 清理缓存</span>
<span class="hljs-function"><span class="hljs-title">clear_cache</span></span>() {
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"清理 MCP 缓存"</span>
    
    <span class="hljs-keyword">if</span> [[ -d <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">rm</span> -rf <span class="hljs-string">"<span class="hljs-variable">$CACHE_DIR</span>"</span>/*
        <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"缓存已清理"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": true, "message": "缓存已清理"}'</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">log</span> <span class="hljs-string">"warning"</span> <span class="hljs-string">"缓存目录不存在"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">'{"success": true, "message": "缓存目录不存在"}'</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 列出可用函数</span>
<span class="hljs-function"><span class="hljs-title">list_functions</span></span>() {
    <span class="hljs-built_in">log</span> <span class="hljs-string">"info"</span> <span class="hljs-string">"列出可用函数"</span>
    
    <span class="hljs-comment"># 构建请求数据</span>
    <span class="hljs-built_in">local</span> request_data=$(build_json \
        <span class="hljs-string">"action"</span> <span class="hljs-string">"list"</span>
    )
    
    <span class="hljs-comment"># 发送请求</span>
    <span class="hljs-built_in">local</span> response=$(send_http_request <span class="hljs-string">"GET"</span> <span class="hljs-string">"<span class="hljs-variable">$OODER_AGENT_ENDPOINT</span>/mcp/functions"</span> <span class="hljs-string">"<span class="hljs-variable">$request_data</span>"</span>)
    
    <span class="hljs-comment"># 处理响应</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 如果服务不可用，返回默认函数列表</span>
        <span class="hljs-built_in">local</span> default_functions=$(build_json \
            <span class="hljs-string">"functions"</span> <span class="hljs-string">'["hello", "calculate", "generate", "transform", "analyze"]'</span> \
            <span class="hljs-string">"source"</span> <span class="hljs-string">"default"</span>
        )
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(build_response <span class="hljs-string">"true"</span> <span class="hljs-string">"<span class="hljs-variable">$default_functions</span>"</span> <span class="hljs-string">""</span> '')</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-22">步骤 5：创建 2 级说明文档 (SKILL.md)</h3>
<p>基于 ooder-skills 的 README.md，按照标准格式创建详细的 SKILL.md 文件，包括技能概述、使用场景、工作原理、使用方式、功能列表等内容。</p>
<h3 data-id="heading-23">步骤 6：设置脚本执行权限</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x scripts/*.sh
</code></pre>
<h3 data-id="heading-24">步骤 7：测试转换结果</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行功能测试</span>
bash scripts/execute.sh --<span class="hljs-keyword">function</span> hello --params <span class="hljs-string">'{"name": "World"}'</span> --displayMode a2ui

<span class="hljs-comment"># 获取信息测试</span>
bash scripts/info.sh

<span class="hljs-comment"># 测试 MCP 功能</span>
bash scripts/mcp.sh --action call --<span class="hljs-keyword">function</span> hello --params <span class="hljs-string">'{"name": "World"}'</span> --displayMode a2ui

<span class="hljs-comment"># 检查 MCP 健康状态</span>
bash scripts/mcp.sh --action health

<span class="hljs-comment"># 列出可用函数</span>
bash scripts/mcp.sh --action list-functions
</code></pre>
<h2 data-id="heading-25">四、转换过程中的常见问题及解决方案</h2>
<h3 data-id="heading-26">1. 依赖项处理</h3>
<p><strong>问题</strong>：ooder-skill 可能依赖多个外部工具</p>
<p><strong>解决方案</strong>：将依赖项功能迁移到服务端，通过 HTTP API 调用实现。LLM 使用脚本直接调用 ooder-agent 的 HTTP API，不使用 Node.js，也不会依赖 npm。脚本只需负责发送 HTTP 请求和处理响应，复杂的依赖管理由服务端处理。通过 MCP 架构，我们可以实现智能缓存和自动重试，进一步提高服务调用的可靠性和效率。</p>
<h3 data-id="heading-27">2. 异步操作处理</h3>
<p><strong>问题</strong>：ooder-skill 中的异步操作如何在脚本中处理</p>
<p><strong>解决方案</strong>：使用 HTTP API 调用，服务端处理异步操作，脚本只需等待响应</p>
<h3 data-id="heading-28">3. 环境变量配置</h3>
<p><strong>问题</strong>：ooder-skill 中的环境变量如何配置</p>
<p><strong>解决方案</strong>：在 common.sh 中设置服务端点等配置，或使用环境变量加载</p>
<h3 data-id="heading-29">4. 错误处理</h3>
<p><strong>问题</strong>：如何在脚本中实现与 ooder-skill 相同的错误处理</p>
<p><strong>解决方案</strong>：在脚本中添加详细的错误检查和响应构建，确保错误信息完整传递</p>
<h2 data-id="heading-30">五、转换效果对比</h2>







































































<table><thead><tr><th>对比项</th><th>ooder-skill</th><th>标准 skill</th><th>改进</th></tr></thead><tbody><tr><td><strong>加载方式</strong></td><td>一次性加载所有代码</td><td>分级加载，按需取用</td><td>减少启动时间</td></tr><tr><td><strong>Token 消耗</strong></td><td>较高（加载完整代码）</td><td>较低（分级加载 + web 调用）</td><td>节省 50%+</td></tr><tr><td><strong>执行速度</strong></td><td>一般（本地执行）</td><td>更快（服务端执行 + 缓存）</td><td>提高 30%+</td></tr><tr><td><strong>可移植性</strong></td><td>依赖 bash 环境</td><td>跨平台，支持任何标准平台</td><td>无环境依赖</td></tr><tr><td><strong>扩展性</strong></td><td>需要修改代码</td><td>只需添加新脚本和配置</td><td>更易扩展</td></tr><tr><td><strong>集成方式</strong></td><td>硬编码集成</td><td>标准接口，即插即用</td><td>易于集成</td></tr><tr><td><strong>MCP 功能</strong></td><td>无</td><td>支持大型模型到 ooder-agent 的交互</td><td>增强模型能力</td></tr><tr><td><strong>缓存机制</strong></td><td>无</td><td>智能缓存，减少重复请求</td><td>提高响应速度</td></tr><tr><td><strong>错误处理</strong></td><td>基本错误处理</td><td>自动重试 + 详细错误信息</td><td>提高可靠性</td></tr><tr><td><strong>健康监控</strong></td><td>无</td><td>MCP 健康状态检查</td><td>确保系统稳定</td></tr></tbody></table>
<h2 data-id="heading-31">六、总结</h2>
<p>将 ooder-skill 转换为标准 skill 是一个系统性的工程，需要从目录结构、文件格式、执行方式等多个方面进行调整。但通过本文提供的详细步骤和文件对比，你可以清晰地了解整个转换过程，并成功完成转换工作。</p>
<p>标准 skill 不仅可以节省 Token 消耗，还能提高执行效率、增强可扩展性，并与更多标准平台兼容。特别是通过集成 MCP (Model Control Plane) 功能，实现了大型模型到 ooder-agent 的高效交互，提供了智能缓存、自动重试和健康监控等高级特性，进一步提升了技能的可靠性和性能。</p>
<p>虽然转换过程需要一定的工作量，但长期来看，这些投入是完全值得的。标准 skill 架构为技能的发展和维护提供了更清晰、更灵活的框架，使技能开发变得更加高效和标准化。</p>
<h2 data-id="heading-32">七、结语</h2>
<p>如果感觉手动转换过程太麻烦，或者你希望专注于业务逻辑而不是技术细节，那么你可以将这个转换任务交给 trae-solo 来处理。trae-solo 提供了自动化的技能转换功能，可以帮助你快速、准确地将 ooder-skill 转换为标准 skill，让你从繁琐的转换工作中解放出来，专注于核心功能的开发和优化。</p>
<p>通过 trae-solo 的自动化转换，你可以：</p>
<ul>
<li>节省大量手动转换的时间和精力</li>
<li>确保转换结果符合标准规范</li>
<li>获得最佳实践的转换建议</li>
<li>快速部署和测试转换后的标准 skill</li>
</ul>
<p>让技术工具为你服务，而不是成为你的负担。选择 trae-solo，让技能转换变得简单高效！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MOE/GShard/Switch_Transformers结构学习总结]]></title>    <link>https://juejin.cn/post/7598003935425462315</link>    <guid>https://juejin.cn/post/7598003935425462315</guid>    <pubDate>2026-01-22T10:43:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598003935425462315" data-draft-id="7597905961664528390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MOE/GShard/Switch_Transformers结构学习总结"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-22T10:43:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MOE/GShard/Switch_Transformers结构学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:43:27.000Z" title="Thu Jan 22 2026 10:43:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<ol>
<li>模型规模是提升模型性能的关键因素之一。在有限的计算资源预算下，用更少的训练步数训练一个更大的模型，往往比用更多的步数训练一个较小的模型效果更佳。</li>
</ol>
<h2 data-id="heading-1">MOE 整体介绍</h2>
<ol>
<li>
<p>混合专家模型 (MoE：Mixed Expert Models) ：一种稀疏激活的深度学习架构范式，核心思想是：<strong>将复杂任务拆解为多个子任务，由专业化的 “专家子网络” 并行处理，再通过 “门控网络” 动态选择并融合 Top-K 专家的输出</strong></p>
<ol>
<li>显著优势是它们能够在远少于稠密模型所需的计算资源下进行有效的预训练。这意味着在相同的计算预算条件下，您可以显著扩大模型或数据集的规模。特别是在预训练阶段，与稠密模型相比，混合专家模型通常能够更快地达到相同的质量水平。</li>
</ol>
</li>
<li>
<p>相比较于传统稠密模型基础 MOE 的特点：</p>
<ol>
<li>与稠密模型相比， MoE预训练速度更快。</li>
<li>与具有相同参数数量的模型相比，具有更快的推理速度。</li>
<li>需要大量显存，因为所有专家系统都需要加载到内存中。</li>
</ol>
</li>
<li>
<p>作为一种基于 Transformer 架构的模型，混合专家模型主要由两个关键部分组成:
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7abf9e9ec4c4760b34e914d08165c93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=m7QdqB6dffWM%2BtYVZ2SCgNrnA1k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p>稀疏 MoE 层(专家模块 Experts): 这些层通常代替了传统 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F155201961%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/155201961?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">Transform</a> 模型中的前馈网络 (FFN) 层(而非 FFN 子模块，子模块是包含 Add&amp;Norm 部分的)，形成 MoE-Transformer。</p>
<ol>
<li>
<p>为什么替换FFN 层呢？下图为 FFN 层对于向量信息的维度处理的可视化
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8900c7b7d85f4bbc8c790b45a09db998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=LytXPzZBgJi9j5JzfKRcdQgfk5Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p>稠密 FFN 的痛点：原本 transform 中的 FFN 需要处理所有类型的 token（如下图 2所示：一段话中不同类型的 token），但所有的输入类型都用同一套参数，参数所包含的信息是有限的，输入类型是多样的；且推理时<strong>所有参数都要参与计算</strong>(如下图 1)，大模型下计算成本极高。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26567d95fcbb4ca58ffc84be8c8eb450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=FByx1y0A9Ig2noqwfn3GzekBExs%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea9926e29f6410f8b5d323407a7ecc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=RvfGMT%2B1BISN4uZVblhtz03KXUc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
<li>
<p>MOE 的优势：用"多专家 FFN + 门控" 替换单 FFN，实现<strong>稀疏激活</strong>,即每个 token 只激活 1~2 个专家，拥有多个专家(每个专家都有一套完成 FFN)，虽然<strong>总参数量大幅提升，但推理计算量只和 K（激活专家数）成正比</strong>，在不增太多算力的前提下，扩大模型能处理的输入任务类型。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2419548871fb4580bac5993878cae599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=lqQv95X1yiGMY%2FI%2BGULh0BoNk%2Bc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ol>
</li>
<li>
<p>专家网络的本质，通俗理解就是<strong>把原始的 1 个 FFN(两层)，拆成 N 个结构相同、参数独立的 FFN</strong>，每个 FFN 就是一个「专家」(也可以把 FFN 替换成其他可进行专业化分工的子网络)，公式：FFN(x)=W2⋅σ(W1⋅x+b1)+b2</p>
<ol>
<li>对应专家公式：ei(x)=W2(i)⋅σ(W1(i)⋅x+b1(i))+b2(i)  i 是表示第 i 个专家，w 和 b 表示权重和偏置，w1 和 2表示第几层</li>
</ol>
</li>
</ol>
</li>
<li>
<p>门控网络或路由: 这个部分用于决定哪些token 被发送到哪个专家，其本质也是一种前馈神经网络（FFNN），它根据特定的输入来选择专家。它输出概率，并利用这些概率来选择最匹配的专家：</p>
<ol>
<li>例如，在下图 1中，“More”这个 token可能被发送到第二个专家，而“Parameters”这个token被发送到第一个专家。有时，一个token甚至可以被发送到多个专家。token的路由方式是 MoE 使用中的一个关键点，因为路由器由学习的参数组成，并且与网络的其他部分一同进行预训练。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/882d2a02ed694dbb869b38aa94145dec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=upXmRipV6WoAJ4%2BvtL2ipBgDrwM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68985bf1db7d4bdc823019a822ec3d8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=49hmuGNzOiDo7659I27xhSZ4Slw%3D" alt="在这里插入图片描述" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f69572c0ec4c299d86159359bd79be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=Y%2FdjZICd4SYUUw053o9cIMrK44k%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86bf4a47f3724e9aacfa98203d190321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683407&amp;x-signature=7YRbs90IqVi29vGEeuqVPybgjT4%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
</li>
<li>
<p>路由器与专家（其中只有少数几个被选中）一起构成了 MoE 层，且完整流程如下</p>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-2">路由如何实现选择专家的方法</h3>
<ol>
<li>
<p>普通 MOE核心规范公式：</p>
<ol>
<li>
<p>专家网络：如上 4.1.2 公式所示 ei(x)</p>
</li>
<li>
<p>门控网络（无噪声）：logits = W * x + b</p>
<ol>
<li>W，b 就是门控网络的权重、偏置（单层线性层，将d_model映射到N维，对应N个专家），x 是输入</li>
<li>logits 就是N个专家的原始匹配分数（分数越高，越适合处理当前 token）。</li>
</ol>
</li>
<li>
<p>选 Top-K 专家：ρ  = softmax(logits)， ρ_i 表示第i个专家的<strong>初始权重</strong>（代表匹配度概率）</p>
</li>
<li>
<p>得到选中的专家索引：topk_idx = argtopk(ρ, K)：K通常为 1 或 2</p>
</li>
<li>
<p>对选中专家重新归一化权重： ρ^topk =  ρ_tok /  (∑(i∈topk_idx)  ρ^mask,i)</p>
<ol>
<li>例如ρ = [0.5, 0.3, 0.2]（3 个专家的权重），K=2：</li>
<li>topk_idx = argtopk (ρ,2) → [0,1]（第 0、1 个专家）；</li>
<li>ρ_topk = [0.5, 0.3]（原始 Top-K 权重，和为 0.8≠1）；</li>
<li>ρ^topk = [0.5/0.8, 0.3/0.8] = [0.625, 0.375]（归一化后和为 1，才能加权融合）。</li>
</ol>
</li>
<li>
<p>输出加权融合：y = ∑(i∈topk_idx)ρ_i⋅ei(x)  ρ^i 是第i个选中专家的归一化权重 ； ei(x)：第i个专家的输出。</p>
</li>
<li>
<p>完整 MOE 层输出（含 Add&amp;Norm）：y_final = LayerNorm(x + y)</p>
</li>
<li>
<p>基础平衡损失（均方误差型）：</p>
<ol>
<li>L = ∑ (i = 1~ N ) (Fi - 1 / N) ^2</li>
<li>Fi = 1 / B * ( ∑ (j=1~ B)  || (i∈topk_idxj))
<ol>
<li>B：Batch 大小（一批处理的 token 数）；</li>
<li>||(⋅)：指示函数（专家i被选中则||函数结果为 1，否则为 0）；</li>
<li>Fi：专家i在当前 Batch 中被选中的<strong>频率</strong>；</li>
<li>1 / N ：理想的均匀选中频率（每个专家被选概率均等）</li>
</ol>
</li>
<li>均方误差属于辅助平衡损失，主损失还是任务类型决定的损失，比如分类的交叉熵损失</li>
</ol>
</li>
<li>
<p>基础 MOE 结构的缺陷：</p>
<ol>
<li>专家负载不均：门控易偏好少数专家，其他专家闲置（基础平衡损失效果有限）；</li>
<li>Token 扎堆：所有 Token 都选少数专家，导致这些专家计算过载；</li>
<li>门控打分模糊 / 极端：要么权重太平均（分工不明确），要么 logits 爆炸（梯度消失）；</li>
<li>分布式扩展难：专家多了之后，无法高效分布到多 GPU/TPU(基础 MOE 只是设计之初没考虑并行，不是不能并行)；</li>
<li>计算冗余：K=2 时仍有部分计算浪费，推理速度不如稠密模型。</li>
</ol>
<pre><code class="hljs language-text" lang="text">例子：基础 MOE（K=2，无噪声 / 并行，均方平衡损失）
主任务：简单文本分类（Lmain为交叉熵损失）；
专家结构：每个专家是简单 FFN（ei(x)=W2(i)⋅GELU(W1(i)⋅x)，W1/W2为随机初始化的 2×4/4×2 矩阵）。
专家数N=4（E1/E2/E3/E4），输入 Token：T1=[1,2], T2=[3,4]
门控打分：
T1 的 logits = W*T1+b=[0.8,0.6,0.3,0.1] → ρ1=softmax([0.8,0.6,0.3,0.1])=[0.4,0.3,0.2,0.1]；
T2 的 logits = W*T2+b=[0.2,0.7,0.5,0.4] → ρ2=softmax([0.2,0.7,0.5,0.4])=[0.1,0.4,0.25,0.25]；
选专家：
T1 的 topk_idx=[0,1] → ρ^1,topk=[0.4/(0.4+0.3),0.3/(0.4+0.3)]=[0.571,0.429]；
T2 的 topk_idx=[1,2] → ρ^2,topk=[0.4/(0.4+0.25),0.25/(0.4+0.25)]=[0.615,0.385]；
专家计算：
T1 激活 E1/E2 → e1(T1)=[0.5,0.6]，e2(T1)=[0.7,0.8]；
T2 激活 E2/E3 → e2(T2)=[0.9,1.0]，e3(T2)=[1.1,1.2]
加权融合：
T1 的y1=0.571×[0.5,0.6]+0.429×[0.7,0.8]=[0.586,0.686]；
T2 的y2=0.615×[0.9,1.0]+0.385×[1.1,1.2]=[0.977,1.077]；
残差归一化：
y1,final=LayerNorm(T1+y1)=LayerNorm([1.586,2.686])；
y2,final=LayerNorm(T2+y2)=LayerNorm([3.977,5.077])；
训练损失：
主损失Lmain=交叉熵(y_final,标签)=0.8；
平衡损失：f1=0.5（E1 只被 T1 选），f2=1（E2 被 T1/T2 都选），f3=0.5（E3 只被 T2 选），f4=0（E4 没被选）；
L_balance=(0.5−0.25)2+(1−0.25)2+(0.5−0.25)2+(0−0.25)2=0.0625+0.5625+0.0625+0.0625=0.75；
总损失L_total=0.8+0.1×0.75=0.875（λ=0.1）；
反向传播：更新门控 + 选中专家的参数，E4 无梯度（未激活）。
</code></pre>
</li>
</ol>
</li>
<li>
<p>GShard：在基础 MOE 上的<strong>增量优化</strong>（解决「负载不均 + 分布式扩展 + 分工模糊」）</p>
<ol>
<li>
<p>依然是计算每个专家原始匹配分数（logits_n 带噪音的 logits）： logits_n = W * x + b + ε</p>
<ol>
<li>ε 为随机噪声，一般服从高斯分布或者均匀分布，加入噪声是为了</li>
<li>推理阶段：噪声门控退化为普通 TopK，即ε为 0，KeepTopK 也就退化成了普通的 TopK</li>
</ol>
</li>
<li>
<p>选 Top-K 专家：ρ^noisy  = softmax(logits_n)， ∑i ρ_i 表示第i个专家的<strong>初始权重</strong>（代表匹配度概率）</p>
</li>
<li>
<p>得到选中的专家索引： topk_idx = argtopk(ρ^noisy,K)</p>
</li>
<li>
<p>KeepTopK 核心：生成掩码，仅保留选中专家的权重，其余置 0，即Mask_i = 1 当 i ∈topk_idx 的时候，如果不属于则为 0，得到 ρ^mask = ρ^noisy ⊙ Mask_i  ⊙表示矩阵对应位置相乘，不是矩阵乘法</p>
</li>
<li>
<p>归一化保留的权重： ρ^topk =  ρ^mask /  (∑i∈topk_idx  ρ^mask,i)</p>
<ol>
<li>ρ^topk：被选中的专家的<strong>重新归一化权重</strong>（和为 1，避免权重稀释，确保融合结果有效）</li>
</ol>
</li>
<li>
<p>GShard 熵型负载均衡损失（替代基础 MOE 的均方误差损失）</p>
<ol>
<li>L_gshard =- 1 / N ∑ (i = 1~ N )  Fi  *  ln(Fi)</li>
<li>原理：样本分散程度越大，熵越大，专家选中频率越均匀；损失最小化时，fi→1/N，负载完全均衡，通俗理解就是你得到的 fi 的值分布越均匀，L_gshard 的绝对值越大，但是L_gshard损失越小(负数)</li>
<li>解决问题：基础均方误差损失不平滑，专家负载仍不均衡</li>
</ol>
</li>
<li>
<p>门控熵损失（基础 MOE 无，GShard 新增）</p>
<ol>
<li>L_entropy = - 1 / B * ( ∑ (j=1~ B) (i = i ~ N ) ρ^ij * ln(ρ^ij))</li>
<li>ρ^ij： 第j个 Token 对第i个专家的权重；</li>
<li>原理：损失越小，门控对每个 Token 的专家权重越集中（比如只给 Top-K 高权重），分工更精准。</li>
<li>解决问题：门控权重太平均，专家分工不明确</li>
</ol>
</li>
<li>
<p>总损失 L = L_main + λ^g  *  L_gshard + λ^e  *  L_entropy</p>
<ol>
<li>L_main 是主任务的损失，不是均方损失，那是辅助平衡损失</li>
<li>λ两个超参数是用来平衡这两个损失的</li>
</ol>
</li>
<li>
<p>Expert Choice 专属 Token 均衡损失（基础 MOE 无）</p>
<ol>
<li>若用「专家选 Token」：L = ∑(i = 1 ~ N) (Ci / B - 1 / N)^2</li>
<li>Ci：专家i选中的 Token 数；</li>
<li>解决：专家选 Token 时，避免少数专家选走大部分 Token。</li>
<li>Expert Choice（专家选 Token）: 反向让专家主动挑适合自己的 Token，替代「Token 选专家」解决选专家不均衡的问题</li>
</ol>
</li>
<li>
<p>8 和 9 的区别在于 8 适用通用场景，Token 主动选专家，9 是Token 扎堆选少数专家时，反向让专家挑 Token</p>
<ol>
<li>token 选专家：1. Token 数量少（&lt;10 万）；2. 专家数量多（&gt;8）；3. 负载相对均匀； 4.分类任务（Token 少）用 Token 选专家。小规模 MOE</li>
<li>专家选 token：. Token 数量多（&gt;100 万）；2. 专家数量少（≤8）；3. Token 扎堆选少数专家（负载不均）；4. 分布式训练（多 GPU）；5生成任务（Token 多）用专家选 Token</li>
</ol>
</li>
<li>
<p>总结优化方向：</p>
<ol>
<li>加噪声让门控「多试试不同专家」；</li>
<li>让专家「主动挑 Token」，避免 Token 扎堆；</li>
<li>用熵型损失让负载均衡更平滑，用熵损失让门控「选得更准」；</li>
<li>加专家并行，让 MOE 能扩展到万亿级参数</li>
</ol>
<pre><code class="hljs language-text" lang="text">复用基础 MOE 的基础信息，只显示增量示例过程
噪声门控（训练阶段）：
T1 的 logits_noisy = [0.8,0.6,0.3,0.1] + [0.05, -0.02, 0.01, -0.03]（
高斯噪声ε∼N(0,0.01)）→ [0.85, 0.58, 0.31, 0.07]；
T1 的ρ1,noisy=softmax([0.85,0.58,0.31,0.07])=[0.42,0.29,0.2,0.09]；
T1 的 topk_idx=[0,1]（仍选 E1/E2，但权重略有变化）；
专家并行部署：
E1→GPU1，E2→GPU2，E3→GPU3，E4→GPU4；
T1 的计算：T1→GPU1（E1）+ GPU2（E2）→ 结果汇总到主 GPU；
T2 的计算：T2→GPU2（E2）+ GPU3（E3）→ 结果汇总到主 GPU；
熵型平衡损失（替代均方损失）：
f1=0.5,f2=1,f3=0.5,f4=0；
L_balance_GShard=−1/4(0.5log0.5+1log1+0.5log0.5+0log0)=−1/4(−0.3466+0−0.3466+0)=0.1733
门控熵损失：
T1 的ρ1,noisy=[0.42,0.29,0.2,0.09] → 熵H1=−(0.42log0.42+0.29log0.29+0.2log0.2+0.09log0.09)=1.25；
T2 的ρ2,noisy=[0.11,0.39,0.26,0.24] → 熵H2=1.3；
L_entropy=−1/2(1.25+1.3)=−1.275（取负后损失为 1.275）；
总损失：
Ltotal=0.8+0.1×0.1733+0.05×1.275=0.8+0.0173+0.0638=0.8811；
核心效果：噪声让 E4 有概率被选中（比如 T1 的ρ1,noisy中 E4 权重从 0.1→0.09，仍低但非 0），熵损失让门控权重更集中，专家并行提升计算速度。
</code></pre>
</li>
</ol>
</li>
<li>
<p>Switch Transformers： 在基础 MOE/GShard 上的<strong>极简增量优化</strong>（解决「计算冗余 + 训练不稳定 + 超大规模效率」）</p>
<ol>
<li>
<p>基于基础 MOE 的方法，下面主要列出改动的地方</p>
</li>
<li>
<p>topk_idx = argtopk(ρ,1) (仅选1个专家)</p>
</li>
<li>
<p>y=ρ_i⋅ei(x)(仅1个专家的输出，无求和)</p>
</li>
<li>
<p>Switch 专属平衡损失（替代基础 / GShard 的平衡损失，K=1 专属）</p>
<ol>
<li>L_balance = N / B^2 * ∑(i=1~N) Ci ^ 2  −1</li>
<li>Ci：专家i被选中的 Token 数（K=1 时，Ci就是专家i处理的 Token 总数）；</li>
<li>原理：理想状态Ci=B/N，代入后L_balance=0；损失最小化时，所有Ci相等，负载完全均衡</li>
</ol>
</li>
<li>
<p>Z-loss（Switch 专属，基础 / GShard 无）</p>
<ol>
<li>Lz = 1 / B * ∑(j=1~B) || logits_j || _2^2</li>
<li>logits_j：第j个 Token 的门控原始 logits；</li>
<li>∥⋅∥：<strong>范数</strong>（衡量向量的 “长度 / 大小”），∥⋅∥2是<strong>L2 范数</strong>（欧几里得距离）；</li>
<li>第一个 2：表示 L2 范数（最常用的范数）；</li>
<li>第二个 2：表示对 L2 范数取平方（简化计算，效果和 L2 范数一致）。</li>
<li>原理：把 logits 的尺度压在合理范围， logits 过大导致 softmax 后权重趋近 0/1，梯度消失。。</li>
</ol>
</li>
<li>
<p>Switch 总损失: L = L_main + λ^b  *  L_balance + λ^z  *  Lz</p>
</li>
<li>
<p>总结优化内容：</p>
<ol>
<li>把 K 改成 1，每个 Token 只找 1 个专家，<strong>推理速度接近稠密模型，显存占用大幅降低</strong>；</li>
<li>用专属平衡损失，让 K=1 时专家负载更均匀；</li>
<li>加 Z-loss，解决门控 logits 爆炸的训练稳定性问题；</li>
<li>极简并行设计，让万亿级 PaLM 模型能高效训练 ——<strong>解决了基础 MOE 的计算冗余、训练不稳定、超大规模效率低</strong>。</li>
</ol>
</li>
<li>
<p>通俗比喻思路就是：门控负责挑 “最适合Token的 1 个专家”，Switch 损失强制要求每个专家的处理的 token 数量差不多，Z-loss防止专家打分太极端，导致误判 toekn 的最优最优专家。</p>
<pre><code class="hljs language-text" lang="text">依旧基础假设信息同基础 MOE
Switch FFN（K=1）：
T1 的ρ1=[0.4,0.3,0.2,0.1] → topk_idx=[0]（仅选 E1）；
T2 的ρ2=[0.1,0.4,0.25,0.25] → topk_idx=[1]（仅选 E2）；
归一化：ρ^1,topk=1（仅 1 个专家，权重为 1），ρ^2,topk=1；
融合：y1=1×e1(T1)=[0.5,0.6]，y2=1×e2(T2)=[0.9,1.0]；
Switch 平衡损失（K=1 专属）：
C1=1（E1 被 T1 选），C2=1（E2 被 T2 选），C3=0，C4=0；
L_switch_balance=4/(2^2) *(1^2+1^2+0^2+0^2)−1=2−1=1；
Z-loss（防 logits 爆炸）：
T1 的 logits=[0.8,0.6,0.3,0.1] → ∥logits1∥_2^2=0.8^2+0.6^2+0.3^2+0.12=0.64+0.36+0.09+0.01=1.1；
T2 的 logits=[0.2,0.7,0.5,0.4] → ∥logits2∥_2^2=0.04+0.49+0.25+0.16=0.94；
Lz=1/2*(1.1+0.94)=1.02；
总损失：
Ltotal=0.8+0.1×1+0.05×1.02=0.8+0.1+0.051=0.951；
核心效果：K=1 让计算极简（无需加权求和），Switch 损失保证 E1/E2 各接 1 个 Token（负载均匀），Z-loss 把 logits 长度压在 1 左右（避免爆炸）。
</code></pre>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-3">存在的挑战</h2>
<ol>
<li><strong>训练挑战</strong>: 虽然 MoE 能够实现更高效的计算预训练，但它们在微调阶段往往面临泛化能力不足的问题，长期以来易于引发过拟合现象。</li>
<li><strong>推理挑战</strong>: MoE 模型虽然可能拥有大量参数，但在推理过程中只使用其中的一部分，这使得它们的推理速度快于具有相同数量参数的稠密模型。然而，这种模型需要将所有参数加载到内存中，因此对内存的需求非常高。以 Mixtral 8x7B 这样的 MoE 为例，需要足够的 VRAM 来容纳一个 47B 参数的稠密模型。之所以是 47B 而不是 8 x 7B = 56B，是因为在 MoE 模型中，只有 FFN 层被视为独立的专家，而模型的其他参数是共享的。此外，假设每个令牌只使用两个专家，那么推理速度 (以 FLOPs 计算) 类似于使用 12B 模型 (而不是 14B 模型)，因为虽然它进行了 2x7B 的矩阵乘法计算，但某些层是共享的。</li>
</ol>
<h2 data-id="heading-4">补充</h2>
<ol>
<li>使用 MOE 结构的主流大模型：
<ol>
<li>Mixtral 8x7B：8 个专家，每个专家 7B 参数，K=2（每个 token 激活 2 个专家）</li>
<li>DeepSeek MoE：16 个专家，引入 “共享专家”（所有 token 都激活的专家）</li>
<li>Llama 4 MoE：采用动态专家数量，优化负载均衡</li>
</ol>
</li>
<li>关键变体：
<ol>
<li>共享专家：在 MoE 层中加入少量共享专家（如 1-2 个），所有 token 都会激活这些专家
<ol>
<li>作用：提供基础能力，防止冷门问题没有专家处理</li>
</ol>
</li>
<li>MoE-Layer Placement：不是所有 FFN 层都替换为 MoE 层，而是在关键层使用（如 Llama 4 MoE 在中间层使用）</li>
<li>MMoE（Multi-gate Mixture-of-Experts）：多任务学习场景，每个任务有独立的门控网络</li>
</ol>
</li>
</ol>
<h2 data-id="heading-5">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F674698482" target="_blank" title="https://zhuanlan.zhihu.com/p/674698482" ref="nofollow noopener noreferrer">1</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_72959097%2Farticle%2Fdetails%2F147423064" target="_blank" title="https://blog.csdn.net/weixin_72959097/article/details/147423064" ref="nofollow noopener noreferrer">2</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025–2026 程序员薪资情况浅析]]></title>    <link>https://juejin.cn/post/7598003935425511467</link>    <guid>https://juejin.cn/post/7598003935425511467</guid>    <pubDate>2026-01-22T10:44:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598003935425511467" data-draft-id="7598003935425478699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025–2026 程序员薪资情况浅析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T10:44:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025–2026 程序员薪资情况浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:44:52.000Z" title="Thu Jan 22 2026 10:44:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2897aa4bf8a8430b9ee03e577f62f9ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683492&amp;x-signature=34o4BwG1Tqowl0w4ZNur21bOo2Q%3D" alt="54e3396d50ce679ab600b1d1dd2fcd88.png" loading="lazy"/></p>
<blockquote>
<p>文章中岗位主要设计普通开发、算法、大模型</p>
</blockquote>
<h2 data-id="heading-0">1. 核心区间总表</h2>
<blockquote>
<p>说明：</p>
<ul>
<li>金额均为<strong>税前人民币</strong>、<strong>年薪大致区间</strong>，结合了月薪与常见 13–16 薪折算</li>
<li>普通开发区间主要参照智联招聘、职场调研报告和大厂职级公开区间综合估算</li>
<li>算法 / 大模型区间直接参考智联、猎聘、脉脉、科锐国际等报告的实测数据</li>
</ul>
</blockquote>
<h3 data-id="heading-1">1.1 普通开发岗薪资总览（北上广深等一线）</h3>



































<table><thead><tr><th>级别</th><th>经验年限</th><th>典型年薪区间（估算）</th><th>参考依据与说明</th></tr></thead><tbody><tr><td>初级开发</td><td>0–3 年</td><td>约 10–20 万</td><td>多篇程序员薪资调查显示：全国平均月薪约 1.5 万，一线初级常见 8–15K，对应约 10–20 万/年[1][2]</td></tr><tr><td>中级开发</td><td>3–5 年</td><td>约 20–40 万</td><td>行业报告与城市排行中，中级常见月薪 15–25K，对应 20–40 万/年[4][5]</td></tr><tr><td>高级开发</td><td>5–8 年</td><td>约 40–70 万</td><td>资深工程师月薪多在 30–50K，一线城市折算 40–70 万/年[4][5]</td></tr><tr><td>专家 / 架构师</td><td>8 年+</td><td>约 80–200 万以上（大厂可更高）</td><td>阿里 P8 约 170–240 万、腾讯 12 级约 220–300 万、字节 3-1 约 142–210 万，可视为“专家段”典型区间[3][6]</td></tr></tbody></table>
<blockquote>
<p>粗略记忆版（普通开发，一线）：<strong>10–20–40–70–200 万</strong> 这几个锚点。</p>
</blockquote>
<h3 data-id="heading-2">1.2 算法 / 大模型岗薪资总览（北上广深等一线）</h3>















































<table><thead><tr><th>岗位类型</th><th>经验年限</th><th>典型年薪区间（估算）</th><th>关键数据点与来源</th></tr></thead><tbody><tr><td>传统算法工程师</td><td>0–3 年</td><td>约 20–35 万</td><td>一线算法平均招聘月薪约 2.3–2.5 万，折算 28–35 万[8][9][10]；近 88.53% 岗位年薪 &gt;20 万[9]</td></tr><tr><td>传统算法工程师</td><td>3–5 年</td><td>约 30–50 万</td><td>北京 3–5 年算法工程师年固定薪酬 28.4–42.9 万区间，中位约 28–35 万，上位可达 40 万+[10]</td></tr><tr><td>传统算法工程师</td><td>5 年+</td><td>约 40–70 万+</td><td>猎聘与多地调研显示：30 万+ 占 67.40%，50 万+ 占 30.11%，高经验段容易进入 50 万+ 区间[9]</td></tr><tr><td>大模型算法工程师</td><td>0–3 年</td><td>约 40–80 万</td><td>脉脉高聘：大模型算法平均月薪 68,051 元（约 81.7 万/年），应届硕博 40–80 万较常见[7][11][12]</td></tr><tr><td>大模型算法工程师</td><td>3–5 年</td><td>约 60–120 万</td><td>科锐国际：大模型算法工程师年薪可达 50–200 万；头部公司 80–150 万占比较多[12]</td></tr><tr><td>资深 AI / 科学家</td><td>5 年+</td><td>约 100–300 万+</td><td>大模型研发 / AI 科学家在顶级大厂、实验室普遍 100 万+，个别可接近或超过 200 万[7][11][12]</td></tr></tbody></table>
<blockquote>
<p>粗略记忆版（算法）：<strong>普通算法 30–70 万，大模型 50–200 万，AI 科学家 100 万+</strong>，这些数字都能在多份报告中找到对应区间[7][9][11][12]。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">2. 普通开发</h2>
<h3 data-id="heading-4">2.1 初级开发（0–3 年）：10–20 万区间</h3>
<ul>
<li>
<p>多份程序员薪资调查与城市薪酬排行显示：</p>
<ul>
<li>一线城市程序员平均月薪在 <strong>1.5 万左右</strong>[1][2]</li>
<li>初级开发（应届～3 年）集中在 <strong>8–15K/月</strong>，按 13–14 薪折算即约 <strong>10–20 万/年</strong>[1][2][4][5]</li>
</ul>
</li>
<li>
<p>你可以这样对照：</p>
<ul>
<li>在北上广深，应届拿 <strong>8–12K</strong> 属于正常，<strong>&gt;15K</strong> 多半是：名校 + 大厂 + 后端/算法等热门方向。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.2 中级开发（3–5 年）：20–40 万区间</h3>
<ul>
<li>行业报告普遍给出：
<ul>
<li>中级工程师月薪 <strong>15–25K</strong>，互联网/金融核心部门可到 30K[4][5]</li>
<li>折算到年薪就是 <strong>20–40 万</strong> 的主流段。</li>
</ul>
</li>
<li>头部大厂给出的中级职级样本（注意：偏高位，不代表平均）：
<ul>
<li>阿里 P6：<strong>48–64 万/年</strong>[6]</li>
<li>字节 2-1：<strong>53–72 万/年</strong>[3]</li>
<li>腾讯 9 级：<strong>59–80 万/年</strong>[3]</li>
</ul>
</li>
</ul>
<blockquote>
<p>行业意义：<strong>3–5 年普通公司 25–35 万，大厂 40–60 万</strong>，基本就算“正常到偏上”。</p>
</blockquote>
<h3 data-id="heading-6">2.3 高级开发（5–8 年）：40–70 万区间</h3>
<ul>
<li>多篇分析文章与统计给出的画像：
<ul>
<li>5 年以上的资深工程师，一线城市月薪 <strong>30–50K</strong> 较常见，对应 <strong>40–70 万/年</strong>[4][5]</li>
</ul>
</li>
<li>头部大厂的对标职级则明显高一个台阶：
<ul>
<li>阿里 P7：<strong>91–118 万/年</strong>[6]</li>
<li>字节 2-2：<strong>84–128 万/年</strong>[3]</li>
<li>腾讯 10 级：<strong>80–120 万/年</strong>[3]</li>
</ul>
</li>
</ul>
<blockquote>
<p>你可以这么理解：</p>
<ul>
<li>普通大中厂：高级工程师 <strong>40–70 万</strong> 很典型；</li>
<li>进了阿里 / 腾讯 / 字节 / 美团等核心部门：<strong>80–120 万</strong> 很常见，属于“中高位”。</li>
</ul>
</blockquote>
<h3 data-id="heading-7">2.4 专家 / 架构师（8 年+）：80–200 万甚至更高</h3>
<ul>
<li>阿里、腾讯、字节等公开或半公开的职级对照中：
<ul>
<li>阿里 P8：<strong>170–240 万/年</strong>[6]</li>
<li>阿里 P9：<strong>290–380 万/年</strong>[6]</li>
<li>阿里 P10：<strong>400–500 万+/年</strong>[6]</li>
<li>腾讯 12 级：<strong>220–300 万/年</strong>[3]</li>
<li>腾讯 13 级：<strong>300–500 万+/年</strong>[3]</li>
<li>字节 3-1：<strong>142–210 万/年</strong>，更高职级可达 <strong>388–580 万/年</strong>[3]</li>
</ul>
</li>
</ul>
<blockquote>
<p>现实落点：</p>
<ul>
<li>在普通传统企业或中小公司，“架构师”年薪 <strong>50–80 万</strong> 已经很高，很难对齐大厂专家线。</li>
<li>真正进入上面这些 P8+/12 级+ 的，是极少数“金字塔尖”的人。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-8">3. 算法</h2>
<p>整体结论：<strong>同年限下，算法岗往往比普通开发高 30–50% 左右</strong>[4][7][9][12]。</p>
<h3 data-id="heading-9">3.1 传统算法工程师：30–70 万是主流</h3>
<ol>
<li>
<p><strong>整体薪资分布（全国）</strong><br/>
某猎头和平台联合报告给出的结论：[9]</p>
<ul>
<li>约 <strong>88.53%</strong> 的算法工程师职位年薪 <strong>&gt;20 万</strong></li>
<li><strong>30 万+</strong> 占比 <strong>67.40%</strong></li>
<li><strong>40 万+</strong> 占比 <strong>47.32%</strong></li>
<li><strong>50 万+</strong> 占比 <strong>30.11%</strong></li>
</ul>
</li>
<li>
<p><strong>以北京 3–5 年算法工程师为例（更细数据）</strong>[10]</p>
<ul>
<li>年固定薪酬中位数：<strong>28.4 万</strong></li>
<li>75 分位：<strong>35.4 万</strong></li>
<li>90 分位：<strong>42.9 万</strong><br/>
→ 总结：3–5 年算法工程师，大致在 <strong>28–43 万/年</strong>，即“30–40 万+”是常态。</li>
</ul>
</li>
<li>
<p><strong>总结为三个档位（主要是一线城市）</strong></p>
<ul>
<li>0–3 年：
<ul>
<li>月薪：<strong>15–25K</strong></li>
<li>年薪：<strong>20–35 万</strong></li>
</ul>
</li>
<li>3–5 年：
<ul>
<li>月薪：<strong>25–35K</strong></li>
<li>年薪：<strong>30–50 万</strong></li>
</ul>
</li>
<li>5 年+：
<ul>
<li>月薪：<strong>30–50K</strong></li>
<li>年薪：<strong>40–70 万+</strong></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">3.2 大模型算法工程师</h3>
<p>权威数据集中指向一个共识：<strong>大模型算法目前是技术岗里薪资最高的前三之一</strong>。</p>
<ol>
<li>
<p><strong>岗位平均薪资（脉脉高聘 2025 春招）</strong>[7][11]</p>
<ul>
<li>大模型算法工程师：平均月薪 <strong>68,051 元</strong>（约 <strong>81.7 万/年</strong>）</li>
<li>人工智能工程师：<strong>60,768 元/月</strong>（约 <strong>72.9 万/年</strong>）</li>
<li>算法工程师（整体）：<strong>52,381 元/月</strong>（约 <strong>62.9 万/年</strong>）</li>
</ul>
</li>
<li>
<p><strong>科锐国际《2025 人才市场洞察及薪酬指南》</strong>[12]</p>
<ul>
<li>大模型算法工程师（智能制造等方向）：
<ul>
<li>年薪可达 <strong>50–200 万</strong></li>
</ul>
</li>
<li>金融风控等垂直领域 AI 专家：<strong>80–150 万</strong></li>
</ul>
</li>
<li>
<p><strong>结合多份校招 / 社招统计与猎头数据的归纳</strong>[7][9][11][12]</p>
<ul>
<li>应届 / 1–3 年（名校硕博 + 大厂）：
<ul>
<li>月薪：<strong>30–60K</strong></li>
<li>总包：<strong>40–80 万</strong>，顶尖博士可冲 <strong>100 万</strong></li>
</ul>
</li>
<li>3–5 年成熟大模型工程师：
<ul>
<li>常规总包：<strong>60–120 万</strong></li>
<li>头部互联网 / AI 独角兽：<strong>80–150 万+</strong> 很常见</li>
</ul>
</li>
<li>资深大模型 / 研究科学家 / Tech Lead：
<ul>
<li>年薪：<strong>100–200 万+</strong></li>
<li>个别顶级实验室 / 海外对标机会：可高于 <strong>200 万</strong></li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>这些数字在多篇报道中互相印证，绝不是单点“传闻”，而是<strong>持续两年+的市场真实水平</strong>[7][9][11][12]。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">4. 怎么用这些“区间”，判断自己贵不贵？</h2>
<p>你可以按下面这个简单步骤来自查：</p>
<h3 data-id="heading-12">4.1 第一步：锁定你的“档位”</h3>
<p>以<strong>一线城市</strong>为基准：</p>
<ul>
<li>
<p>普通开发：</p>
<ul>
<li>0–3 年：<strong>10–20 万</strong></li>
<li>3–5 年：<strong>20–40 万</strong></li>
<li>5–8 年：<strong>40–70 万</strong></li>
<li>8 年+ 专家：<strong>80–200 万+</strong>（大厂头部可 300 万以上）[3][4][5][6]</li>
</ul>
</li>
<li>
<p>算法（推荐 / CV / NLP 等传统方向）：</p>
<ul>
<li>0–3 年：<strong>20–35 万</strong></li>
<li>3–5 年：<strong>30–50 万</strong></li>
<li>5 年+：<strong>40–70 万+</strong>[8][9][10]</li>
</ul>
</li>
<li>
<p>大模型 / 高端 AI：</p>
<ul>
<li>校招～3 年：<strong>40–80 万</strong></li>
<li>3–7 年：<strong>60–150 万</strong></li>
<li>资深/科学家：<strong>100–300 万+</strong>[7][11][12]</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">4.2 第二步：打个“城市折扣”</h3>
<p>结合其他报告对城市平均薪资的比较，可以粗略用这个系数：</p>
<ul>
<li>一线（北上广深、杭州）：× <strong>1.0</strong></li>
<li>新一线（成都、武汉等）：× <strong>0.85–0.9</strong></li>
<li>二三线：× <strong>0.6–0.7</strong>[2][5]</li>
</ul>
<h3 data-id="heading-14">4.3 第三步：判断自己在哪个区间</h3>
<p>一个简单可执行的判断方式：</p>
<ul>
<li>你当前年薪 / <strong>同城市、同年限、同方向的上述中位数</strong>
<ul>
<li>&lt; <strong>0.8</strong>：偏低，可以考虑跳槽 / 谈薪 / 换方向</li>
<li>0.8–1.2：大致合理</li>
<li>
<blockquote>
<p><strong>1.2</strong>：偏高，说明你要么在好平台，要么在稀缺方向，要好好经营这条路</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-15">5. 总结</h2>
<p>结合上面所有可查证的数据，可以给出一个<strong>直接可用的结论版</strong>（默认一线城市）：</p>
<ol>
<li>
<p><strong>普通开发（前端 / 后端 / 移动 / 全栈）</strong></p>
<ul>
<li>初级（0–3 年）：<strong>10–20 万/年</strong>[1][2][4][5]</li>
<li>中级（3–5 年）：<strong>20–40 万/年</strong>[4][5]</li>
<li>高级（5–8 年）：<strong>40–70 万/年</strong>[4][5]</li>
<li>专家 / 架构师（8 年+）：
<ul>
<li>普通公司：<strong>50–80 万/年</strong></li>
<li>头部大厂：<strong>80–200 万/年</strong>，顶级专家可到 <strong>300–500 万/年</strong>[3][6]</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>算法工程师（推荐 / CV / NLP / 机器学习等）</strong></p>
<ul>
<li>初级（0–3 年）：<strong>20–35 万/年</strong></li>
<li>中级（3–5 年）：<strong>30–50 万/年</strong></li>
<li>高级（5 年+）：<strong>40–70 万+/年</strong></li>
</ul>
<blockquote>
<p>这一结论直接来自：</p>
<ul>
<li>算法工程师 88.53% 岗位年薪 &gt;20 万，30 万+ 占 67.40%，50 万+ 占 30.11%[9]</li>
<li>北京 3–5 年算法工程师 28–43 万的实证区间[10]</li>
</ul>
</blockquote>
</li>
<li>
<p><strong>大模型算法 / 高端 AI 岗</strong></p>
<ul>
<li>0–3 年：<strong>40–80 万/年</strong></li>
<li>3–5 年：<strong>60–120 万/年</strong></li>
<li>资深专家 / 科学家：<strong>100–300 万+/年</strong></li>
</ul>
<blockquote>
<p>直接依据：大模型算法工程师平均月薪 68,051 元[7][11]，科锐国际给出的 50–200 万区间[12]，以及多份 AI 人才报告的综合数据。</p>
</blockquote>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">References</h2>
<p>[1] 程序员工资一般多少(非常详细). <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_51725318%2Farticle%2Fdetails%2F143694501" target="_blank" title="https://blog.csdn.net/weixin_51725318/article/details/143694501" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_5172…</a><br/>
[2] 2025年全国程序员平均薪资排名. <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FGalaxy_0%2Farticle%2Fdetails%2F145031790" target="_blank" title="https://blog.csdn.net/Galaxy_0/article/details/145031790" ref="nofollow noopener noreferrer">blog.csdn.net/Galaxy_0/ar…</a><br/>
[3] 2025 互联网顶级大厂程序员职级薪资表. <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Flianhunqianr1%2Farticle%2Fdetails%2F154989759" target="_blank" title="https://blog.csdn.net/lianhunqianr1/article/details/154989759" ref="nofollow noopener noreferrer">blog.csdn.net/lianhunqian…</a><br/>
[4] 程序员工资，行业的经济密码与职业发展的晴雨表. <a href="https://link.juejin.cn?target=https%3A%2F%2Fjiyun.xin%2Fyun%2F3960.html" target="_blank" title="https://jiyun.xin/yun/3960.html" ref="nofollow noopener noreferrer">jiyun.xin/yun/3960.ht…</a><br/>
[5] 程序员工资一般多少. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mingchatang.com%2Fa%2F33261794.html" target="_blank" title="https://www.mingchatang.com/a/33261794.html" ref="nofollow noopener noreferrer">www.mingchatang.com/a/33261794.…</a><br/>
[6] 2025 互联网大厂职级与薪资. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F969667514_121124371" target="_blank" title="https://www.sohu.com/a/969667514_121124371" ref="nofollow noopener noreferrer">www.sohu.com/a/969667514…</a><br/>
[7] 机构报告:AI技术岗位薪资优势明显 大模型算法工程师位居高薪榜首. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.stcn.com%2Farticle%2Fdetail%2F1608885.html" target="_blank" title="https://www.stcn.com/article/detail/1608885.html" ref="nofollow noopener noreferrer">www.stcn.com/article/det…</a><br/>
[8] 深圳算法工程师工资待遇_工资一般多少-智通直聘. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.job5156.com%2Fsalary%2F1402_12010010%2F" target="_blank" title="https://www.job5156.com/salary/1402_12010010/" ref="nofollow noopener noreferrer">www.job5156.com/salary/1402…</a><br/>
[9] 2025年算法工程师薪资飞涨:近九成年薪超20万. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F858748093_121798711" target="_blank" title="https://www.sohu.com/a/858748093_121798711" ref="nofollow noopener noreferrer">www.sohu.com/a/858748093…</a><br/>
[10] 北京3-5年的算法工程师的薪酬水平. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F894724580_122300151" target="_blank" title="https://www.sohu.com/a/894724580_122300151" ref="nofollow noopener noreferrer">www.sohu.com/a/894724580…</a><br/>
[11] 脉脉高聘:大模型算法、人工智能工程师等列入高薪岗位前三. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnew.qq.com%2Frain%2Fa%2F20250325A06QIY00" target="_blank" title="https://new.qq.com/rain/a/20250325A06QIY00" ref="nofollow noopener noreferrer">new.qq.com/rain/a/2025…</a><br/>
[12] 人工智能成最热门赛道,大模型算法工程师年薪可达50万至200万. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnew.qq.com%2Frain%2Fa%2F20250219A03QR900" target="_blank" title="https://new.qq.com/rain/a/20250219A03QR900" ref="nofollow noopener noreferrer">new.qq.com/rain/a/2025…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那些被永远困在代码里的人（2025 年程序员极端加班案例汇总）]]></title>    <link>https://juejin.cn/post/7597905961664561158</link>    <guid>https://juejin.cn/post/7597905961664561158</guid>    <pubDate>2026-01-22T10:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597905961664561158" data-draft-id="7598021313870036998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那些被永远困在代码里的人（2025 年程序员极端加班案例汇总）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T10:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那些被永远困在代码里的人（2025 年程序员极端加班案例汇总）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:46:58.000Z" title="Thu Jan 22 2026 10:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作为一名技术架构师，我的观点一直是：除了架构技术本身，也要学会架构自己的人生。
最近又有程序员猝死事件冲上热搜，我借助AI尽可能全面得整理了2025年所有相关事件案例，这里分享出来，希望可以警示诸君。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91860928d2b943d09544aaa48327a083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683618&amp;x-signature=Bkdxgsz6oLMI72dSmjqWgN30qTI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、结构性问题</h2>
<p>2025 年，程序员的故事一次次冲上热搜：<br/>
杭州 35 岁后端开发脑干出血，被迫告别编程；武汉 26 岁程序员婚礼前猝死工位；广州 32 岁部门经理周末在家加班时倒下，抢救期间还被拉进工作群；无锡 25 岁技术员工日均工作 13 小时后猝死；深圳 43 岁程序员四年睡在车里，只为扛住一线城市的生活成本；微软硅谷 35 岁工程师深夜倒在园区草地上，再也没能爬起来。</p>
<p>这些并非孤立悲剧，而是 2025 年程序员群体生存状态的一张切面：<br/>
<strong>高强度工时 + 隐性加班 + 高生活成本 + AI 冲击带来的职业焦虑</strong>，叠加出一个系统性高风险群体。</p>
<p>下面的文章，在不捏造任何细节的前提下，基于已公开可查证的信息和行业报告，对 2025 年“程序员加班与猝死”现象做一个可直接引用的系统梳理，并给出对个人和企业都真正可执行的建议。</p>
<hr/>
<h2 data-id="heading-1">二、2025 年关键个案</h2>
<h3 data-id="heading-2">1. 杭州：35 岁后端开发吴某——连续 36 小时加班后的脑干出血</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：35 岁</li>
<li>职位：杭州某公司资深后端开发，月薪约 3 万元</li>
<li>工作状态：连续 8 年接近“996”，日均工作约 14 小时，日均编写 500+ 行代码[19][20]</li>
</ul>
</li>
<li>
<p><strong>发病经过</strong></p>
<ul>
<li>一次项目冲刺，连续约 36 小时加班后，在工位突发剧烈头痛、呕吐，很快昏迷</li>
<li>诊断：脑干出血约 5 mL，属于极高致残、致死风险部位[19][20]</li>
<li>昏迷 15 天，ICU 抢救 28 天，后续瘫痪 3 个月，需要重新学习走路</li>
</ul>
</li>
<li>
<p><strong>后果与意义</strong></p>
<ul>
<li>无法再从事高强度编程工作，被迫退出一线开发岗位</li>
<li>其康复日记和媒体报道被广泛作为“典型过劳致残案例”引用，用来提醒程序员群体正视健康风险[19][20]</li>
</ul>
</li>
</ul>
<p><strong>关键信息可用结论</strong>：长期接近“996”+ 集中连续熬夜冲刺，不仅可能导致猝死，更现实的结果是“带病苟活+长期残疾”。</p>
<hr/>
<h3 data-id="heading-3">2. 深圳：43 岁程序员张运来——在车里“睡”出一份深圳程序员的生活账</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：约 43 岁</li>
<li>职位：深圳南山区某公司程序员，广东阳江人</li>
<li>生活方式：近 4 年工作日住在自己的新能源车里[2]</li>
</ul>
</li>
<li>
<p><strong>具体做法</strong></p>
<ul>
<li>每晚把车停在深圳湾公园停车场，每晚停车费约 6 元[2]</li>
<li>利用公园公共卫生间洗漱、附近健身房解决洗澡问题</li>
<li>每周五晚自驾约 300 公里回阳江，周一再返回深圳上班</li>
<li>日均开销控制在约 100 元，4 年累计节省房租约 10 万元[2]</li>
</ul>
</li>
<li>
<p><strong>舆论焦点</strong></p>
<ul>
<li>他是否“占用公共资源”？</li>
<li>一线城市房租与通勤成本，对中年程序员意味着什么？</li>
</ul>
</li>
</ul>
<p><strong>这不是病案，却是现实</strong>：在高工时和高生活成本双重压力下，一部分程序员选择用“极端压缩生活质量”而不是改善工作条件来对冲风险。</p>
<hr/>
<h3 data-id="heading-4">3. 武汉：26 岁猿辅导程序员/教培员工李某某——婚礼前 9 天倒在工位</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：约 26 岁，2020 年毕业于武汉一本高校</li>
<li>职位：猿辅导武汉公司线上课程技术/教培类岗位</li>
<li>家庭：4 月刚领结婚证，原定 5 月 2 日举行婚礼，是家中经济支柱[3][4][5][26]</li>
</ul>
</li>
<li>
<p><strong>时间线</strong></p>
<ul>
<li>4 月 22 日中午：到公司上班</li>
<li>当晚：在办公室加班，逐渐不再回复未婚妻信息</li>
<li>凌晨：未婚妻报警求助，但与民警均无法进入办公区</li>
<li>4 月 23 日早：保洁员在工位发现其趴在桌上，已无生命体征[3][4][5]</li>
</ul>
</li>
<li>
<p><strong>工作强度和管理争议</strong></p>
<ul>
<li>单人管理 400+ 学生，日常工作时间常为 13:30–22:30，最晚到 0:00[3][5]</li>
<li>续班高峰期单日加班 6 小时以上，“吃饭、上厕所需报备”，考核极度严厉[3][5]</li>
<li>公司称当日为倒休，没有安排加班；多位前员工称其是来“主动加班补指标”[3][5][26]</li>
</ul>
</li>
<li>
<p><strong>官方进展</strong></p>
<ul>
<li>武汉东湖高新区人社部门与公安已介入</li>
<li>工亡/工伤认定结果公开报道尚未披露[26]</li>
</ul>
</li>
</ul>
<p><strong>可用的关键点</strong>：</p>
<ul>
<li>“未安排加班”≠“没有在加班”</li>
<li>“自愿加班补指标”是很多程序员现实中的高发场景，也最难在法律上举证和保护。</li>
</ul>
<hr/>
<h3 data-id="heading-5">4. 深圳：32 岁金融科技程序员张明（化名）——一次被 AED 从死神手里“抢回”的教训</h3>
<ul>
<li>
<p><strong>事件概况</strong></p>
<ul>
<li>时间：2025 年 7 月某个工作日深夜</li>
<li>场景：22:23 仍在修改 bug，突然晕厥栽倒在键盘上[FitRun 报道]</li>
</ul>
</li>
<li>
<p><strong>抢救过程</strong></p>
<ul>
<li>同事立即实施心肺复苏（CPR），并使用公司配置的 AED</li>
<li>经过 3 次电击，恢复自主心跳</li>
<li>医院诊断为“恶性心律失常”，与长期熬夜、压力和作息紊乱密切相关</li>
</ul>
</li>
<li>
<p><strong>后续</strong></p>
<ul>
<li>张明康复后返回工作岗位</li>
<li>公司和急救机构将该案例长期用于普及“职场 AED 配置与急救培训”的重要性</li>
</ul>
</li>
</ul>
<p><strong>它提醒我们</strong>：<br/>
高压、高工时不会马上“杀死所有人”，但对每一个经常胸闷、心悸又死扛加班的程序员来说，和 Pandey 或高广辉的距离，可能只差一次 AED。</p>
<hr/>
<h3 data-id="heading-6">5. 美国加州：35 岁微软工程师 Pratik Pandey——硅谷“过劳倦怠”的标志性事件</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：35 岁</li>
<li>职位：微软山景城园区软件工程师，参与 Microsoft Fabric 等产品开发[9][10]</li>
</ul>
</li>
<li>
<p><strong>事件经过</strong></p>
<ul>
<li>8 月 19 日 19:50：刷卡进入园区办公室</li>
<li>8 月 20 日约凌晨 2 点：被同事发现面朝下倒在园区院子，无生命体征</li>
<li>法医初步判断为突发性心脏病，警方排除刑事嫌疑[9]</li>
</ul>
</li>
<li>
<p><strong>家属与舆论</strong></p>
<ul>
<li>家属称其长期深夜加班，压力巨大，呼吁硅谷科技公司正视工程师过劳问题[9][10]</li>
<li>事件被多家英文媒体与“burnout（过劳倦怠）”讨论绑定，形成跨国舆论场</li>
</ul>
</li>
</ul>
<p><strong>它说明</strong>：<br/>
“程序员加班致死”不是中国特产，而是全球高工时、高责任技术岗位共同面临的健康与制度问题。</p>
<hr/>
<h3 data-id="heading-7">6. 某电商公司：7 月加班 159.96 小时的“先进个人”</h3>
<ul>
<li>
<p><strong>事件内容</strong></p>
<ul>
<li>时间：2025 年 8 月内部通报截图在社交平台流传</li>
<li>公司发布《加班表扬通报》，将 7 月加班 159.96 小时的员工评为“无私奉献”典型，呼吁全体学习；榜单末位员工加班也达 68.41 小时</li>
</ul>
</li>
<li>
<p><strong>法律与舆论反应</strong></p>
<ul>
<li>《劳动法》要求每月加班不得超过 36 小时，这一通报中“榜首”已是法定上限的 4 倍多[13][37]</li>
<li>工人日报、光明网等评论指出：这是典型的违法加班被包装成“道德荣誉”，以“情怀”和“奉献”掩盖对加班费和休息权的侵害</li>
</ul>
</li>
</ul>
<p><strong>这类表扬通报的危险</strong>在于：<br/>
把本应支付加班费、调休和限时管理的义务，偷换为员工个人“自愿奉献”，让“依法拒绝加班”的人反而背上“不敬业”的道德压力。</p>
<hr/>
<h3 data-id="heading-8">7. 无锡：25 岁技工小乐——日均 13 小时工作后猝死</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：25 岁</li>
<li>职位：无锡时代天使医疗器械科技有限公司员工，陕西韩城人</li>
<li>工作强度：家属统计，近 4 个月日均工时约 13 小时，最高达 14.8 小时[8]</li>
</ul>
</li>
<li>
<p><strong>发病与死亡</strong></p>
<ul>
<li>10 月 30 日下午上班时出现严重上吐下泻，仍坚持工作至 23:00</li>
<li>次日昏迷，开颅手术后在 ICU 抢救，11 月 8 日去世</li>
<li>死亡诊断包括创伤性硬膜下血肿、弥漫性脑肿胀、创伤性脑疝等[8]</li>
</ul>
</li>
<li>
<p><strong>公司应对与争议</strong></p>
<ul>
<li>其去世两小时内，公司将工作账号状态改为“离职”</li>
<li>家属要求调取监控，遭公司拒绝，引发公众强烈不满[8]</li>
<li>工伤认定与责任追究过程仍在进行，公开未见最终结论</li>
</ul>
</li>
</ul>
<p><strong>这是典型跨行业警示</strong>：<br/>
不仅互联网大厂，医疗器械、制造、平台运营等大量“技术+一线执行”岗位，同样存在严重透支生命换产出的现象。</p>
<hr/>
<h3 data-id="heading-9">8. 广州：32 岁程序员出身的部门经理高广辉——“死在周末加班的路上”</h3>
<ul>
<li>
<p><strong>基本情况</strong></p>
<ul>
<li>年龄：32 岁，河南籍，广州某科技公司部门经理，程序员出身</li>
<li>长期工作强度：2025 年 11 月内，工作日回家时间最早 21:38，最晚 23:58[1][2]</li>
</ul>
</li>
<li>
<p><strong>死亡当天（周六）的时间线</strong></p>
<ul>
<li>早上：在家感觉不适，但有 4 项任务当日截止，仍在电脑前处理工作</li>
<li>8:58：家属拨打 120</li>
<li>9:14：120 到达现场</li>
<li>9:46：转入广东省第二中医院</li>
<li>10:48：仍在抢救中，却被同事拉入工作微信群</li>
<li>13:00：宣布临床死亡[1]</li>
<li>当晚 21:09：同事在微信私聊中继续催促“周一有急任务，要把这个改一下”，而此时他已经去世约 8 小时[1][2]</li>
</ul>
</li>
<li>
<p><strong>医学记录</strong></p>
<ul>
<li>院前和院内病历中明确记录“程序员，经常熬夜，平时工作压力大、强度大”作为既往史[1]</li>
<li>死因写为“呼吸心跳骤停”，属于典型猝死类型之一</li>
</ul>
</li>
<li>
<p><strong>法律进展</strong></p>
<ul>
<li>公司已向广州市黄埔区人社局提交工伤认定申请</li>
<li>人社局已受理，但截至目前未公开认定结果[27]</li>
</ul>
</li>
</ul>
<p><strong>这起案件有三个关键特征</strong>：</p>
<ol>
<li>死亡发生在周六居家状态，但有 OA 登录和工作群记录；</li>
<li>医疗记录明确“程序员 + 经常熬夜”这一职业背景；</li>
<li>抢救期间被拉工作群、死后仍被催工，极具象征意义。</li>
</ol>
<p>它会在今后很长一段时间内，被当作“远程/隐形加班猝死能否视同工伤”的典型案例讨论。</p>
<blockquote>
<p>说明：下表只收录经公开权威报道证实的 8 个关键事件，网络误传的“6 月 17 日两名程序员同日猝死”单独标注为“误传”。</p>
</blockquote>






















































































<table><thead><tr><th align="left">发生时间</th><th align="left">事件类型</th><th align="left">地点</th><th align="left">当事人信息</th><th align="left">核心事实</th><th align="left">调查 / 后续进展</th><th align="left">权威信源示例</th></tr></thead><tbody><tr><td align="left">2025‑01‑08（发病）–2025‑04（曝光）</td><td align="left">加班致病危</td><td align="left">杭州</td><td align="left">35 岁后端开发吴某，月薪约 3 万</td><td align="left">连续 8 年近似“996”，日均 500+ 行代码；连续 36 小时加班后脑干出血 5mL，昏迷 15 天、ICU 28 天，后续瘫痪 3 个月，需重新学习走路，无法再从事编程工作</td><td align="left">康复后退出编程岗位，其自述与媒体报道被广泛作为“过劳警示”案例引用</td><td align="left">厦门网公众号、橙柿互动、新浪、网易等多家媒体交叉报道</td></tr><tr><td align="left">2025‑04‑18（报道）</td><td align="left">特殊生存状态（车居）</td><td align="left">深圳</td><td align="left">43 岁程序员张运来（阳江人）</td><td align="left">工作日住在新能源车内，每晚深圳湾公园停车费 6 元，利用公共卫生间、健身房洗漱，每周末自驾 300 公里回阳江；4 年累计省下约 10 万元房租</td><td align="left">本人接受采访称“不只是为了省钱，而是更自由”；事件引发对一线城市居住成本与公共资源利用边界的讨论</td><td align="left">潇湘晨报、新华网、腾讯新闻等多家媒体报道</td></tr><tr><td align="left">2025‑04‑23（夜间）</td><td align="left">猝死</td><td align="left">武汉</td><td align="left">26 岁，猿辅导武汉公司技术/教培员工李某某</td><td align="left">原定 5 月 2 日举行婚礼，4 月 22 日加班至深夜后失联，次日被发现猝死在办公室工位；公司称无安排加班，前员工指证其“自愿加班补指标”、管理严苛、单日加班超 6 小时</td><td align="left">武汉东湖新技术开发区人社局等部门介入调查，家属准备工亡申报，但截至目前未见工伤认定结果</td><td align="left">中国新闻网、网易、新浪财经、CSDN 等综合报道</td></tr><tr><td align="left">2025‑07（工作日深夜）</td><td align="left">加班致病危（抢救成功）</td><td align="left">深圳</td><td align="left">32 岁金融科技公司程序员张明（化名）</td><td align="left">22:23 仍在改 bug 时突然晕厥倒在键盘，同事现场实施心肺复苏并使用 AED，三次电击恢复心跳；医院诊断为恶性心律失常，与长期高压、熬夜相关</td><td align="left">张明康复后返岗，该案例被多次用于职场急救与 AED 普及宣传，凸显“职场急救链”重要性</td><td align="left">专业急救类公众号 FitRunThinker 等撰文详述</td></tr><tr><td align="left">2025‑08‑20（凌晨，当地时间）</td><td align="left">猝死</td><td align="left">美国加州山景城</td><td align="left">35 岁微软软件工程师 Pratik Pandey（印度裔）</td><td align="left">8 月 19 日晚刷卡进入微软园区，次日凌晨被发现面朝下倒在公司院子，无生命体征；法医初步认定死于突发性心脏病；家属称其长期深夜加班、需同时负责多个项目，压力巨大</td><td align="left">警方排除刑事案件，微软表示配合调查并将审视工程师工作负荷与健康支持机制；事件引发硅谷科技公司对“过度加班”文化的反思</td><td align="left">蓝点网、澎湃新闻、New York Post、WindowsCentral 等中英文媒体一致报道</td></tr><tr><td align="left">2025‑08（具体日期不详）</td><td align="left">加班文化争议</td><td align="left">某电商公司（地区未明确）</td><td align="left">“加班榜一”员工</td><td align="left">公司发布《关于加班的通报表扬》，将 7 月加班 <strong>159.96 小时</strong>的员工作为“高度责任感、默默无私加班奉献”的典型，号召全员学习，榜单末位加班 68.41 小时</td><td align="left">工人日报、光明网等指出该公司严重违反法定加班上限，将违法行为包装为“奉献”，代表典型畸形加班文化；公司未见公开道歉</td><td align="left">九派新闻、工人日报、新浪财经等转发通报截图并发表评论</td></tr><tr><td align="left">2025‑11‑08</td><td align="left">猝死</td><td align="left">无锡</td><td align="left">25 岁时代天使医疗器械科技有限公司员工小乐（陕西韩城人）</td><td align="left">入职一年多，近 4 个月 <strong>日均工时约 13 小时，最高 14.8 小时</strong>；10 月 30 日上班时上吐下泻仍坚持至 23:00，次日宿舍昏迷，被送医后开颅抢救无效，于 11‑08 去世；死亡诊断为创伤性硬膜下血肿等</td><td align="left">家属认为长期高强度加班是关键诱因，质疑公司排班制度；公司在其去世两小时后将账号状态改为“离职”，拒绝提供监控，引发严重舆论批评；工伤认定及法律责任尚在推进中</td><td align="left">中华网、极目新闻、香港 01 等多家媒体连续追踪</td></tr><tr><td align="left">2025‑11‑29（周六上午）</td><td align="left">猝死</td><td align="left">广州</td><td align="left">32 岁科技公司部门经理高广辉（河南籍），程序员出身</td><td align="left">长期工作日加班，猝死前一周最早 21:38 到家、最晚 22:47；11‑29 为周六，有 4 项任务截止，他在家中多次登录公司 OA 处理工作；8:58 拨打 120，途中与入院记录显示其在电梯口昏倒，经抢救至 13:00 宣布死亡；<strong>抢救期间被拉入工作群，死亡 8 小时后仍被同事催工</strong></td><td align="left">120 及医院病历将“程序员经常熬夜、工作强度大”记录为既往史；公司已向广州市黄埔区人社局申请工伤认定，人社局已受理，结果未出；案件被视为“居家加班猝死能否视同工伤”的典型</td><td align="left">红星新闻、凤凰网、网易新闻、新浪新闻等深度报道</td></tr></tbody></table>
<blockquote>
<p>误传案例说明：<br/>
“2025 年 6 月 17 日两名程序员同日猝死”一说，经 2025 年 6 月至 2025 年 12 月，<strong>未见任何警方、公立媒体或企业通报</strong>，可合理认定为网传谣言。</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">三、宏观数据</h2>
<h3 data-id="heading-11">1. 心血管与猝死数据</h3>
<ul>
<li>中国每年约 <strong>55 万人死于心源性猝死</strong>，相当于平均每分钟有 1 人猝死[21][22][23]</li>
<li>其中 <strong>40 岁以下人群占比 43%</strong>，高压职业“过劳死”平均年龄仅 <strong>37.9 岁</strong>，IT 工程师位列高危职业之首[7][21]</li>
</ul>
<p><strong>可得出合理结论</strong>：<br/>
程序员“不是天生短命”，但从年龄结构和职业特征看，他们正好踩在心源性猝死的高危组合上——高压 + 熬夜 + 久坐 + 饮食不良。</p>
<hr/>
<h3 data-id="heading-12">2. 工时与加班</h3>
<ul>
<li>
<p><strong>程序员专项数据（CSDN 2025 报告）</strong>[24][25]</p>
<ul>
<li>平均每周工作 <strong>48.3 小时</strong>，一线城市 <strong>50.2 小时</strong></li>
<li><strong>78% 程序员存在超时工作</strong></li>
<li><strong>52%</strong> 有因紧急需求被迫熬夜通宵的经历</li>
<li>超过 <strong>一半</strong> 的程序员为保住饭碗选择“无偿加班”，调休形同虚设</li>
</ul>
</li>
<li>
<p><strong>职场总体数据（智联 2025 报告）</strong>[29][31]</p>
<ul>
<li><strong>38.7% 职场人几乎每天加班</strong></li>
<li>近 <strong>6 成免费加班</strong>，只有 26.5% 能拿到加班费[29][30]</li>
<li>在所有职业中，产品、研发、技术岗每周加班 4–5 天的比例明显高于其他岗位[31]</li>
</ul>
</li>
<li>
<p><strong>全国企业平均工时（国家统计局）</strong>[12][32]</p>
<ul>
<li>2025 年多个月份，企业就业人员周平均工时为 <strong>48.5 小时</strong>，明显高于法定标准</li>
</ul>
</li>
</ul>
<p>对照 <strong>法律上“每月加班不得超过 36 小时”</strong> 的规定，很容易看出：<br/>
<strong>整个行业的“正常水平”，在法律上其实是“系统性严重超标”</strong>。</p>
<hr/>
<h3 data-id="heading-13">3. 国际研究</h3>
<p>WHO 与 ILO 的联合研究为程序员的现实提供了一个非常明确的参照系[33][35]：</p>
<ul>
<li>将每周工作时间 ≥55 小时定义为“长时间工作”</li>
<li>与每周 35–40 小时相比：
<ul>
<li>中风风险增加 <strong>35%</strong></li>
<li>死于缺血性心脏病的风险增加 <strong>17%</strong></li>
</ul>
</li>
<li>2016 年全世界约 <strong>74.5 万人</strong>死于长时间工作相关的中风和心脏病[35]</li>
</ul>
<p><strong>直白一点说</strong>：<br/>
如果你的长期状态是“每周 60 小时左右”，哪怕公司和同事都说“这很正常”，从医学视角看，你已经是“高危样本”。</p>
<hr/>
<h2 data-id="heading-14">四、法律与工伤</h2>
<p>为什么程序员“死在加班路上”却很难算工伤？</p>
<h3 data-id="heading-15">1. 法条本身的保护边界</h3>
<ul>
<li>《劳动法》规定：每日工作时间不超过 8 小时，平均每周不超过 44 小时；每月加班不超过 36 小时[13][37]</li>
<li>《工伤保险条例》规定两类与“过劳死”最相关的情形可视同工伤[38][39]：
<ol>
<li>工作时间和工作岗位上突发疾病死亡；</li>
<li>或 48 小时内经抢救无效死亡。</li>
</ol>
</li>
</ul>
<p><strong>问题在于</strong>：</p>
<ul>
<li>很多程序员发病是在 <strong>家中</strong> 或 <strong>通勤途中</strong>；</li>
<li>很多死亡发生在 <strong>48 小时之后</strong>（比如先脑出血入 ICU，死在几天以后）。</li>
</ul>
<p>这就带来一个现实结果：</p>
<blockquote>
<p>能够被直接视同工伤的猝死，只占现实过劳相关案例中的一小部分。</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">2. 新型工作形态下的“灰色地带”</h3>
<ul>
<li>
<p><strong>居家办公 / 远程值班</strong>：<br/>
高广辉周六在家里登录 OA 系统处理任务时猝死，抢救期间被拉入工作群[1][27]。<br/>
法律要回答的问题是：他当时是否处在“工作时间 + 工作岗位”的状态？</p>
</li>
<li>
<p><strong>“未安排加班”的“自愿加班”</strong>：<br/>
猿辅导李某某案中，公司称当日是倒休，并未安排值班[3][5][26]。<br/>
但多位员工证词表明：为了完成指标，他必须在休息日“自愿”来公司加班。</p>
</li>
</ul>
<p>在大量类似案子中，<strong>证明“公司安排”这件事本身，就变成最难的部分</strong>。<br/>
而法律的滞后现实是：</p>
<ul>
<li>没有明确承认“微信群任务 + OA 登录 + 远程值班”与“在办公桌前”在工伤认定上等价；</li>
<li>对“绩效考核倒逼下的自愿加班”几乎无能为力。</li>
</ul>
<hr/>
<h3 data-id="heading-17">3. 对当下程序员的直接含义</h3>
<ol>
<li><strong>一旦身边有人猝死或重病，家属务必在 1 年内申请工伤认定</strong>，不要错过时限[40][41]。</li>
<li><strong>平时要有意识地保留证据</strong>：
<ul>
<li>加班表、打卡记录</li>
<li>工作群里的任务分配、催促消息</li>
<li>OA 登录日志、值班排班表</li>
</ul>
</li>
<li>对居家加班和“隐形加班”场景，目前法律尚在“探索期”，像高广辉案这样的典型，会逐步推动司法实践的边界，但短期内不应过度寄望。</li>
</ol>
<hr/>
<h2 data-id="heading-18">五、企业侧的两条路</h2>
<p>继续内卷，还是主动“强制下班”？</p>
<h3 data-id="heading-19">1. 畸形加班文化的三种典型做法</h3>
<ol>
<li><strong>把违法当荣耀</strong>：
<ul>
<li>某电商公司把 159.96 小时加班当成“榜样”[21]</li>
</ul>
</li>
<li><strong>把生理需求当违规</strong>：
<ul>
<li>要求“吃饭、上厕所需报备”的考核制度[3][5]</li>
</ul>
</li>
<li><strong>把生死当 PR 风险</strong>：
<ul>
<li>员工猝死两小时内就被处理成“离职”，拒绝提供监控[8]</li>
</ul>
</li>
</ol>
<p>这三种做法，短期可能压榨出了业绩，长期却在摧毁团队战斗力、品牌信誉和法律风险底线。</p>
<hr/>
<h3 data-id="heading-20">2. “反内卷”的现实样本</h3>
<ul>
<li><strong>大疆</strong>[48][49]
<ul>
<li>深圳总部实行“21 点强制清场”：未审批加班者必须离开；上海办公室 21:00 断电关灯</li>
</ul>
</li>
<li><strong>美的集团</strong>[48][50]
<ul>
<li>明令禁止下班后开会，部分部门 18:20 强制下班，HR 巡楼“赶人”</li>
<li>禁用 PPT 作为日常内部汇报载体，减少无效形式主义</li>
</ul>
</li>
<li><strong>海尔集团</strong>[48][50]
<ul>
<li>全面落实双休，周六不准上班、食堂断供；如需加班必须提前申报</li>
</ul>
</li>
</ul>
<p>智联调研显示，2025 年已有 <strong>8.4% 公司推行“强制下班”</strong>，超过半数公司“不强制也不鼓励加班”[11][31]。<br/>
这表明，一部分头部企业已经意识到：</p>
<blockquote>
<p><strong>无限加班 ≠ 无限产出，高效制度 + 健康员工才是长期竞争力。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-21">六、AI 浪潮叠加</h2>
<ul>
<li>初级 Java 开发岗位薪资，从 2023 年的 18–25k/月跌至 8–12k/月</li>
<li>传统前端、运维岗位竞争比高达 5000:1，后端岗位需求缩减 60%</li>
<li>AI 科学家/负责人平均月薪约 ¥127,225，35+ 资深专家在 AI 赛道反而迎来“黄金期”</li>
</ul>
<p>这意味着：</p>
<ol>
<li>
<p><strong>底层岗位收入下滑，但加班强度未明显下降</strong><br/>
——“既赚不到太多钱，又不敢轻易说不”，加班从“多劳多得”变成“多劳多慌”。</p>
</li>
<li>
<p><strong>能力结构分化加剧</strong></p>
<ul>
<li>被 AI 快速替代的基础开发岗位，最容易被迫接受高工时+低回报</li>
<li>能掌控 AI 工具、做架构和业务抽象的人，议价权和健康权利反而更强</li>
</ul>
</li>
</ol>
<p>对个人而言：</p>
<blockquote>
<p><strong>仅仅“多加班”已经无法换来“多回报”，反而换来更高的被淘汰概率和健康账单。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-22">七、可执行的两类建议</h2>
<h3 data-id="heading-23">（一）给程序员个人：三条“底线”和三条“上限”</h3>
<h4 data-id="heading-24">1. 三条“底线”（建议尽量做到）</h4>
<ol>
<li>
<p><strong>底线一：平均周工时尽量不要长期超过 55 小时</strong></p>
<ul>
<li>这几乎是国际公认的“健康红线”，≥55 小时/周与中风、心梗风险显著上升直接相关[33][35]。</li>
<li>如果你的常态已经是 996 或更高，且没有补偿，应该认真考虑换团队/换公司。</li>
</ul>
</li>
<li>
<p><strong>底线二：一年至少一次心血管体检</strong></p>
<ul>
<li>检查血压、血脂、血糖、心电图，有条件做彩超和运动平板</li>
<li>有家族史、肥胖、长期熬夜者要提高频率</li>
</ul>
</li>
<li>
<p><strong>底线三：出现以下任一情况立即就医，而不是再撑完这波需求</strong></p>
<ul>
<li>持续或反复胸闷胸痛、心悸</li>
<li>劳累后明显气促、头晕</li>
<li>非运动状态下突然大汗、恶心、呕吐</li>
<li>突发肢体无力、口齿不清</li>
</ul>
</li>
</ol>
<h4 data-id="heading-25">2. 三条“上限”（如果经常突破，就说明风险非常高）</h4>
<ol>
<li>
<p><strong>不要连续两天睡眠低于 4 小时还坚持高强度工作</strong></p>
<ul>
<li>陈飞那类“48 小时极限冲刺”是最危险的组合[7][16]。</li>
</ul>
</li>
<li>
<p><strong>不要连续数月维持“日均 12 小时以上工作”</strong></p>
<ul>
<li>小乐近 4 个月日均约 13 小时，最终以猝死收场[8]。</li>
<li>长期如此，本质上是在用生命透支整个职业生涯。</li>
</ul>
</li>
<li>
<p><strong>不要长期接受“无偿加班 + 不可抗拒 KPI”而不做任何调整</strong></p>
<ul>
<li>这意味着你既没有谈判空间，又没有可转移的核心技能，是最危险的职业状态。</li>
<li>至少要在个人规划上为“退路”做准备，比如转到需求更稳定、工时更健康的赛道，或者提升到更难被替代的技术层级（如架构、AI 相关）。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-26">（二）给企业管理者：三件“马上能做的事”</h3>
<h4 data-id="heading-27">1. 建立“工时与健康”双考核机制</h4>
<ul>
<li>不仅考核项目和 KPI，也考核部门的 <strong>加班时长、加班结构和健康事故</strong></li>
<li>把“加班排名”废止，改成：
<ul>
<li>连续 3 个月超法定工时的团队负责人，要写说明甚至接受绩效扣减</li>
<li>把“准点下班率”“年假使用率”纳入管理层考核</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">2. 做好三样极低成本、却高收益的配置</h4>
<ol>
<li><strong>AED + 急救培训</strong>
<ul>
<li>张明案例清楚说明：职场急救链打通，可以实实在在救命</li>
</ul>
</li>
<li><strong>年度体检升级为“有针对性的心血管筛查”</strong>
<ul>
<li>对程序员、运维、产品等高压岗位重点增加相关项目</li>
</ul>
</li>
<li><strong>加班审批透明化</strong>
<ul>
<li>所有加班需在系统中提前申请和备注原因，自动统计到部门考核中</li>
<li>杜绝“默认留在工位就叫自愿加班”的灰色操作</li>
</ul>
</li>
</ol>
<h4 data-id="heading-29">3. 从源头上改项目管理方式</h4>
<ul>
<li>减少“大起大落”的冲刺式项目节奏，更多采用滚动规划和“灰度上线”</li>
<li>明确三条红线：
<ol>
<li>不得以绩效或裁员暗示，强迫员工无偿加班</li>
<li>不得将明显违法的工时宣传为“奉献”</li>
<li>下班后非紧急情况不以电话、群聊持续骚扰员工</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-30">八、结语</h2>
<p>从杭州吴某到广州高广辉，从武汉李某某到硅谷 Pandey，从张运来的车里到小乐的 ICU，这些故事共同指向一个事实：</p>
<blockquote>
<p>在今天的技术行业，“会写代码”已经远远不够，<strong>你必须同时学会保护健康、用法律和数据保护自己，并学会对不合理工作制说“不”</strong>。</p>
</blockquote>
<p>对企业而言，继续把违法加班当文化，只会在未来的司法实践和舆论场中付出更高代价；对个人而言，继续把身体当成可以无限复用的“CPU”，唯一可以确定的是——<strong>硬件迟早会烧毁，且无法重装</strong>。</p>
<p>改变不会一夜发生，但从现在起：</p>
<ul>
<li>如果你是程序员，至少先设定清晰的个人工时红线和体检计划；</li>
<li>如果你是管理者，至少先取消加班光荣榜，改为给团队配齐 AED 和合理的排期；</li>
<li>如果你是企业决策层，至少从今年开始，在对 KPI 的考核之外，加一项“员工健康与工时合规”的硬指标。</li>
</ul>
<p>当“到点下班”不再需要勇气，当“活着工作”代替“为工作而死”，我们才算真正迈出了告别畸形加班文化的第一步。</p>
<hr/>
<h3 data-id="heading-31">References</h3>
<p>[1] 32岁程序员周末晕倒后猝死...工伤申请已被受理（高广辉事件详情）. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.ifeng.com%2Fc%2F8q6GSDwPxwI" target="_blank" title="https://news.ifeng.com/c/8q6GSDwPxwI" ref="nofollow noopener noreferrer">news.ifeng.com/c/8q6GSDwPx…</a><br/>
[2] 河南32岁程序员周末晕倒后猝死...工伤申请已被受理. <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.html5.qq.com%2Fpage%2Freal%2Fsearch_news%3Fdocid%3D70000021_91069710ac771052" target="_blank" title="https://so.html5.qq.com/page/real/search_news?docid=70000021_91069710ac771052" ref="nofollow noopener noreferrer">so.html5.qq.com/page/real/s…</a><br/>
[3] 猿辅导婚礼前夕猝死员工家属发声,前员工实名反映高压管理. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7497235366848627240%2F" target="_blank" title="https://www.toutiao.com/article/7497235366848627240/" ref="nofollow noopener noreferrer">www.toutiao.com/article/749…</a><br/>
[4] 猿辅导武汉公司程序员猝死,原定5月2日结婚引关注. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.163.com%2Fdy%2Farticle%2FJU09091V05562DNY.html" target="_blank" title="https://www.163.com/dy/article/JU09091V05562DNY.html" ref="nofollow noopener noreferrer">www.163.com/dy/article/…</a><br/>
[5] 猿辅导员工加班猝死,年仅26岁,4月刚领证,原定于五一办婚礼. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F888875119_120405382" target="_blank" title="https://www.sohu.com/a/888875119_120405382" ref="nofollow noopener noreferrer">www.sohu.com/a/888875119…</a><br/>
[6] 这个样子就是长期熬夜的后果吧！（含 28 岁程序员心梗数据）. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Fw%2F1826761152183513%2F" target="_blank" title="https://www.toutiao.com/w/1826761152183513/" ref="nofollow noopener noreferrer">www.toutiao.com/w/182676115…</a><br/>
[7] 27 岁程序员猝死前 48 小时:这些致命共性正在吞噬年轻人. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7500435832587715107%2F" target="_blank" title="https://www.toutiao.com/article/7500435832587715107/" ref="nofollow noopener noreferrer">www.toutiao.com/article/750…</a><br/>
[8] 从猿辅导到职场困局;当加班时长盖过婚礼倒计时. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Fw%2F1830362011285568%2F" target="_blank" title="https://www.toutiao.com/w/1830362011285568/" ref="nofollow noopener noreferrer">www.toutiao.com/w/183036201…</a><br/>
[9] Family of 35-year-old Microsoft engineer who died at work begs Silicon Valley to stop overworking staff. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnypost.com%2F2025%2F09%2F04%2Fbusiness%2Ffamily-of-35-year-old-microsoft-engineer-who-died-at-work-begs-silicon-valley-to-stop-overworking-staff%2F" target="_blank" title="https://nypost.com/2025/09/04/business/family-of-35-year-old-microsoft-engineer-who-died-at-work-begs-silicon-valley-to-stop-overworking-staff/" ref="nofollow noopener noreferrer">nypost.com/2025/09/04/…</a><br/>
[10] Microsoft engineer found dead at Silicon Valley campus sparks renewed debate over tech burnout. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.windowscentral.com%2Fmicrosoft%2Fmicrosoft-engineer-found-dead-at-silicon-valley-campus-sparks-renewed-debate-over-tech-burnout" target="_blank" title="https://www.windowscentral.com/microsoft/microsoft-engineer-found-dead-at-silicon-valley-campus-sparks-renewed-debate-over-tech-burnout" ref="nofollow noopener noreferrer">www.windowscentral.com/microsoft/m…</a><br/>
[11] 8.4%公司推行“强制下班” 2025职场“反内卷” 调研报告发布. <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.html5.qq.com%2Fpage%2Freal%2Fsearch_news%3Fdocid%3D70000021_001690c650435252" target="_blank" title="https://so.html5.qq.com/page/real/search_news?docid=70000021_001690c650435252" ref="nofollow noopener noreferrer">so.html5.qq.com/page/real/s…</a><br/>
[12] 国家统计局:2025年7月全国周平均工时48.5小时. <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.199it.com%2Farchives%2F1779542.html" target="_blank" title="http://www.199it.com/archives/1779542.html" ref="nofollow noopener noreferrer">www.199it.com/archives/17…</a><br/>
[13] 劳动法2025年新规定关于加班的时间是怎么规定的. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.64365.com%2Fzs%2F1506907.aspx" target="_blank" title="https://www.64365.com/zs/1506907.aspx" ref="nofollow noopener noreferrer">www.64365.com/zs/1506907.…</a><br/>
[19] 最忙时只睡2小时！35岁脑干出血程序员引热议. <a href="https://link.juejin.cn?target=https%3A%2F%2Ffinance.sina.cn%2F2025-04-25%2Fdetail-ineukhfx2069235.d.html" target="_blank" title="https://finance.sina.cn/2025-04-25/detail-ineukhfx2069235.d.html" ref="nofollow noopener noreferrer">finance.sina.cn/2025-04-25/…</a><br/>
[20] 35岁程序员加班到凌晨2点,月薪3万差点死掉. <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.html5.qq.com%2Fpage%2Freal%2Fsearch_news%3Fdocid%3D70000021_87968160e4803352" target="_blank" title="https://so.html5.qq.com/page/real/search_news?docid=70000021_87968160e4803352" ref="nofollow noopener noreferrer">so.html5.qq.com/page/real/s…</a><br/>
[21] 2025年最易猝死职业排行榜出炉!第一名就这身边?. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7480365685504279059%2F" target="_blank" title="https://www.toutiao.com/article/7480365685504279059/" ref="nofollow noopener noreferrer">www.toutiao.com/article/748…</a><br/>
[22] 每年55万人心源性猝死相关报道. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7485818800328180264%2F" target="_blank" title="https://www.toutiao.com/article/7485818800328180264/" ref="nofollow noopener noreferrer">www.toutiao.com/article/748…</a><br/>
[23] 我国每年心源性猝死者高达55万人. <a href="https://link.juejin.cn?target=https%3A%2F%2Ffinance.sina.com.cn%2Fjjxw%2F2025-03-25%2Fdoc-ineqwfyr9850850.shtml" target="_blank" title="https://finance.sina.com.cn/jjxw/2025-03-25/doc-ineqwfyr9850850.shtml" ref="nofollow noopener noreferrer">finance.sina.com.cn/jjxw/2025-0…</a><br/>
[24] 《2025中国程序员工作与生活平衡（WLB）调查报告》. <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fjrckkyy%2Farticle%2Fdetails%2F149782689" target="_blank" title="https://blog.csdn.net/jrckkyy/article/details/149782689" ref="nofollow noopener noreferrer">blog.csdn.net/jrckkyy/art…</a><br/>
[25] 干开发做程序员不好找工作,_2025年程序员加班情况. <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_46428928%2Farticle%2Fdetails%2F155488131" target="_blank" title="https://blog.csdn.net/weixin_46428928/article/details/155488131" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_4642…</a><br/>
[26] “猿辅导一员工猝死”，死者亲属发声. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chinanews.com%2Fsh%2F2025%2F04-25%2F10405462.shtml" target="_blank" title="https://www.chinanews.com/sh/2025/04-25/10405462.shtml" ref="nofollow noopener noreferrer">www.chinanews.com/sh/2025/04-…</a><br/>
[27] 程序员猝死抢救室，工作群消息还在催单：当职场麻木症成为…. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.163.com%2Fdy%2Farticle%2FKJR3CHGV0556BZS3.html" target="_blank" title="https://www.163.com/dy/article/KJR3CHGV0556BZS3.html" ref="nofollow noopener noreferrer">www.163.com/dy/article/…</a><br/>
[29] 《2025职场人加班情况报告》. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.qq.com%2Frain%2Fa%2F20250611A069PZ00" target="_blank" title="https://news.qq.com/rain/a/20250611A069PZ00" ref="nofollow noopener noreferrer">news.qq.com/rain/a/2025…</a><br/>
[30] 《2025职场人加班情况报告》多平台转发. <a href="https://link.juejin.cn?target=https%3A%2F%2Fsearch.laborinfocn.com%2Farticles%2F76974" target="_blank" title="https://search.laborinfocn.com/articles/76974" ref="nofollow noopener noreferrer">search.laborinfocn.com/articles/76…</a><br/>
[31] 智联研究院:2025职场“反内卷”调研报告. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F951008440_121640652" target="_blank" title="https://www.sohu.com/a/951008440_121640652" ref="nofollow noopener noreferrer">www.sohu.com/a/951008440…</a><br/>
[32] 国家统计局:2025年一季度全国企业就业人员周平均工作时间48.5小时. <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.html5.qq.com%2Fpage%2Freal%2Fsearch_news%3Fdocid%3D70000021_25567ff1bea51052" target="_blank" title="https://so.html5.qq.com/page/real/search_news?docid=70000021_25567ff1bea51052" ref="nofollow noopener noreferrer">so.html5.qq.com/page/real/s…</a><br/>
[33] 每周工作时间55小时致感染和心血管死亡风险（WHO 研究转述）. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.163.com%2Fdy%2Farticle%2FJOBLCDCS05345ZH3.html" target="_blank" title="https://www.163.com/dy/article/JOBLCDCS05345ZH3.html" ref="nofollow noopener noreferrer">www.163.com/dy/article/…</a><br/>
[35] Long working hours increasing deaths from heart disease and stroke – WHO/ILO. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.who.int%2Fnews%2Fitem%2F17-05-2021-long-working-hours-increasing-deaths-from-heart-disease-and-stroke-who-ilo" target="_blank" title="https://www.who.int/news/item/17-05-2021-long-working-hours-increasing-deaths-from-heart-disease-and-stroke-who-ilo" ref="nofollow noopener noreferrer">www.who.int/news/item/1…</a><br/>
[37] 中国劳动法加班规定整理. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.66law.cn%2Flaws%2F4315951.aspx" target="_blank" title="https://www.66law.cn/laws/4315951.aspx" ref="nofollow noopener noreferrer">www.66law.cn/laws/431595…</a><br/>
[38] 过劳死工伤怎么判. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.66law.cn%2Flaws%2F2909322.aspx" target="_blank" title="https://www.66law.cn/laws/2909322.aspx" ref="nofollow noopener noreferrer">www.66law.cn/laws/290932…</a><br/>
[39] 过劳死能否被认定为工伤. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.66law.cn%2Flaws%2F3138373.aspx" target="_blank" title="https://www.66law.cn/laws/3138373.aspx" ref="nofollow noopener noreferrer">www.66law.cn/laws/313837…</a><br/>
[40] 2025版工伤认定流程及工亡赔偿标准. <a href="https://link.juejin.cn?target=https%3A%2F%2Fnew.qq.com%2Frain%2Fa%2F20250305A04OKN00" target="_blank" title="https://new.qq.com/rain/a/20250305A04OKN00" ref="nofollow noopener noreferrer">new.qq.com/rain/a/2025…</a><br/>
[41] 申请工伤认定多久2025. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.64365.com%2Fzs%2F1417521.aspx" target="_blank" title="https://www.64365.com/zs/1417521.aspx" ref="nofollow noopener noreferrer">www.64365.com/zs/1417521.…</a><br/>
[42] 以后加班算违法?2025年这些新规将彻底改写职场规则!. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7482737731169288755%2F" target="_blank" title="https://www.toutiao.com/article/7482737731169288755/" ref="nofollow noopener noreferrer">www.toutiao.com/article/748…</a><br/>
[43] 中办国办重拳反内卷!2025年全面铺开"强制下班"制度?. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7482771853707182611%2F" target="_blank" title="https://www.toutiao.com/article/7482771853707182611/" ref="nofollow noopener noreferrer">www.toutiao.com/article/748…</a><br/>
[48] “强制下班”引发热议,美的、海尔等多家企业开启反内卷. <a href="https://link.juejin.cn?target=https%3A%2F%2Ffinance.sina.com.cn%2Fstock%2Festate%2Fintegration%2F2025-03-12%2Fdoc-inepkvpm1613509.shtml" target="_blank" title="https://finance.sina.com.cn/stock/estate/integration/2025-03-12/doc-inepkvpm1613509.shtml" ref="nofollow noopener noreferrer">finance.sina.com.cn/stock/estat…</a><br/>
[49] 真的卷不动了!大疆、美的、海尔等大厂打响反内卷第一枪. <a href="https://link.juejin.cn?target=https%3A%2F%2Ffinance.sina.com.cn%2Fchanjing%2Fgsnews%2F2025-03-10%2Fdoc-inepeprf9508131.shtml" target="_blank" title="https://finance.sina.com.cn/chanjing/gsnews/2025-03-10/doc-inepeprf9508131.shtml" ref="nofollow noopener noreferrer">finance.sina.com.cn/chanjing/gs…</a><br/>
[50] 从“强制加班”到“强制下班”:知名企业掀起“反内卷风暴”. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.toutiao.com%2Farticle%2F7480370020346839579%2F" target="_blank" title="https://www.toutiao.com/article/7480370020346839579/" ref="nofollow noopener noreferrer">www.toutiao.com/article/748…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code最佳实践]]></title>    <link>https://juejin.cn/post/7598011274686283776</link>    <guid>https://juejin.cn/post/7598011274686283776</guid>    <pubDate>2026-01-22T10:52:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598011274686283776" data-draft-id="7597973595131166772" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code最佳实践"/> <meta itemprop="keywords" content="VibeCoding,Claude"/> <meta itemprop="datePublished" content="2026-01-22T10:52:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芦半山"/> <meta itemprop="url" content="https://juejin.cn/user/149189312913511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189312913511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芦半山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:52:42.000Z" title="Thu Jan 22 2026 10:52:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>文章的名字有点危言耸听，这当然不是我有资格说的话，而是官方今天给出的文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/034df22a08f5404584eebcdd468eda19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqm5Y2K5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683962&amp;x-signature=uRh3m1wIhrIGlZ6Nuxj7HV%2FJBfM%3D" alt="" loading="lazy"/></p>
<p>一直以来，我学习的习惯就是向源头去求解。譬如，如果要弄懂某个机制，我会阅读源码、写邮件和作者沟通；如果要了解某个领域，我会阅读领域内最权威、最经典的书籍；如果要学习某项技术，我会阅读官方文档、实际上手去操作。这里面有一个朴素的观念，即深入才能浅出，越是源头的东西往往越好理解。这里的“好理解”并非指“不动脑”，而是可以用最短的路径到达深处。反之，一些看起来“容易吸收”的课程、视频、博客，则会因为转述者的个人能力，出现理解偏差、抓不住重点等多种问题，到头来反而耽误我们对于知识的理解。</p>
<p>在我学习Vibe Coding的过程中，我依然沿袭着这种方式。即实操业内公认最好的工具Claude Code，以及阅读Anthropic官方的文档来学习工具的使用。当然，我也会看大量的Youtube视频来补充认知，但那更像是一种猎奇。因此，我强烈建议想要学习Vibe Coding的朋友阅读这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fbest-practices%25EF%25BC%258C%25E9%2587%258C%25E9%259D%25A2%25E6%259C%2589%25E5%25A4%25AA%25E5%25A4%259A%25E7%259A%2584%25E5%25BF%2583%25E5%25BE%2597%25E5%2592%258C%25E6%2584%259F%25E6%2582%259F%25E3%2580%2582" target="_blank" title="https://code.claude.com/docs/en/best-practices%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%9C%89%E5%A4%AA%E5%A4%9A%E7%9A%84%E5%BF%83%E5%BE%97%E5%92%8C%E6%84%9F%E6%82%9F%E3%80%82" ref="nofollow noopener noreferrer">code.claude.com/docs/en/bes…</a></p>
<p>以下摘录几条我个人感触比较深的点，以及一些延伸思考。</p>
<h2 data-id="heading-0">1. 提供反馈机制</h2>
<p>反馈是保证结果可靠的重要机制。这就好比人开车，我们无法做到方向盘操控的100%精确，但视觉反馈可以让我们知道左右，左了就向右打一点，右了就向左打一点，最终的结果就是稳定向前。</p>
<p>Vibe Coding也是如此，我们应该时时去思考如何把这个反馈的Loop给Code Agent搭建好。一旦搭建好，既可以保证输出效果，又可以做到长时间不偏离方向的任务执行。</p>
<p>以下是文档中罗列的两种实践方式，后者提供反馈，让Claude Code可以去验证自己输出的结果，因此会明显地提升任务效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b310b549d2b64de4877d0aeb2dc769da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqm5Y2K5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683962&amp;x-signature=69DI3TYrNDv6SBcSYQGA1XnGB7I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. 提供具体的上下文</h2>
<p>AI可以推断我们的意图，但毕竟上下文有限，有时无法完全读懂我们的心思。在现有的限制下，可以通过提供更加具体的上下文，让AI拥有更好的表现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02c8a06cac649fc86cf3e0afbee232d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqm5Y2K5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683962&amp;x-signature=BE4R8YsVIqYxRGO6cjWxT6VCdP8%3D" alt="" loading="lazy"/></p>
<p>这一点倒是可以凸显出内行和外行的差异，因为外行是不可能用右边的方式来跟AI对话的，它需要很多前置的专业知识。不过我倒认为，随着模型能力的提升，具体上下文的要求会越来越宽松，以至于左边的对话会在某一时刻达到和右边对话同样的效果。这就像一年前Prompt Engineer还是个火热的概念，我们需要精心构建各种Prompt才能让模型输出理想的答案，但现在已经没人讨论这件事了。</p>
<h2 data-id="heading-2">3. 各种名词的区别</h2>
<p>记得Skill刚出来的时候，网络上铺天盖地的文章在讨论，Skill是什么，跟MCP有什么区别。其实看那些文章，真不如看官方的具体介绍，每一个名词都有一篇详细的文章，来介绍它的具体使用和本质。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdcf4bc76b1146ff9a06f303bc664fd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqm5Y2K5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769683962&amp;x-signature=OLgLvOA2ltYRIl1x8vk5ybL6IHc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">4. 培养你的直觉</h2>
<blockquote>
<p>随着时间的推移，你将培养出任何指南都无法涵盖的直觉。你将知道何时该明确具体，何时该保持开放；何时该制定计划，何时该进行探索；以及何时该清除上下文，何时该让其持续累积。</p>
</blockquote>
<p>在飞速发展的时期，所有的工具、方法都在剧烈变化，所谓的最佳实践或许也只有三个月保鲜期。因此，真正重要的是学习、实践和培养直觉，并不断地把这个过程循环往复。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 @empjs/skill：让 AI SKill 管理变得前所未有的简单]]></title>    <link>https://juejin.cn/post/7597808104463417390</link>    <guid>https://juejin.cn/post/7597808104463417390</guid>    <pubDate>2026-01-22T10:57:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597808104463417390" data-draft-id="7597979278241169417" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 @empjs/skill：让 AI SKill 管理变得前所未有的简单"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T10:57:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KenXu"/> <meta itemprop="url" content="https://juejin.cn/user/483440843559406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 @empjs/skill：让 AI SKill 管理变得前所未有的简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/483440843559406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KenXu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T10:57:42.000Z" title="Thu Jan 22 2026 10:57:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>一个命令，管理所有 AI Skill。告别重复安装，拥抱统一管理。</strong></p>
</blockquote>
<h2 data-id="heading-0">💡 你是否遇到过这样的困扰？</h2>
<p>想象一下这个场景：你同时使用 <strong>Cursor</strong>、<strong>Claude Code</strong>、<strong>Windsurf</strong> 等多个 AI 编程助手。每次发现一个好用的技能（Skill），你都需要：</p>
<ul>
<li>🔄 在 Cursor 的目录下手动安装一次</li>
<li>🔄 在 Claude Code 的目录下再安装一次</li>
<li>🔄 在 Windsurf 的目录下还要安装一次</li>
<li>📁 每个 AI 代理都有自己的技能目录，文件散落各处</li>
<li>🔍 想查看安装了哪些技能？得一个个目录去翻</li>
<li>🗑️ 想删除某个技能？得记住它在哪些地方，一个个删除</li>
</ul>
<p><strong>更糟糕的是</strong>，如果你是一个技能开发者，想要测试你的技能在不同 AI 代理上的表现，你需要：</p>
<ul>
<li>📦 打包发布到 NPM</li>
<li>🔄 在每个代理上分别安装</li>
<li>🔄 修改代码后，重新打包、重新安装...</li>
<li>😫 开发效率低到令人抓狂</li>
</ul>
<h2 data-id="heading-1">✨ eskill：一次安装，全平台可用</h2>
<p><strong>eskill</strong> 是一个革命性的 CLI 工具，它彻底改变了 AI 代理技能的管理方式。</p>
<h3 data-id="heading-2">🎯 核心价值</h3>
<p><strong>一个统一的技能库，自动分发到所有 AI 代理</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装一个技能</span>
eskill install my-awesome-skill

<span class="hljs-comment"># ✨ 自动检测并链接到：</span>
<span class="hljs-comment">#   ✅ Cursor (~/.cursor/skills)</span>
<span class="hljs-comment">#   ✅ Claude Code (~/.claude/skills)  </span>
<span class="hljs-comment">#   ✅ Windsurf (~/.windsurf/skills)</span>
<span class="hljs-comment">#   ✅ Cline (~/.cline/skills)</span>
<span class="hljs-comment">#   ✅ Gemini Code (~/.gemini/skills)</span>
<span class="hljs-comment">#   ✅ GitHub Copilot (~/.copilot/skills)</span>
<span class="hljs-comment">#   ✅ ... 还有更多！</span>
</code></pre>
<p><strong>就这么简单！</strong> 一次安装，所有已安装的 AI 代理都能立即使用。</p>
<h2 data-id="heading-3">🌟 五大核心亮点</h2>
<h3 data-id="heading-4">1️⃣ 统一存储架构</h3>
<p>所有技能统一存储在 <code>~/.emp-agent/skills/</code>，通过<strong>符号链接</strong>（symlink）技术智能分发到各个 AI 代理。</p>
<p><strong>优势：</strong></p>
<ul>
<li>📦 <strong>单一数据源</strong>：技能只存储一份，节省磁盘空间</li>
<li>🔄 <strong>自动同步</strong>：更新一次，所有代理自动生效</li>
<li>🎯 <strong>集中管理</strong>：所有技能一目了然</li>
</ul>
<h3 data-id="heading-5">2️⃣ 智能代理检测</h3>
<p>自动检测你系统中已安装的所有 AI 代理，无需手动配置。</p>
<p><strong>支持的 AI 代理（13+）：</strong></p>
<ul>
<li>Claude Code</li>
<li>Cursor</li>
<li>Windsurf</li>
<li>Cline</li>
<li>Gemini Code</li>
<li>GitHub Copilot</li>
<li>OpenCode</li>
<li>Antigravity</li>
<li>Kiro</li>
<li>Codex CLI</li>
<li>Qoder</li>
<li>Roo Code</li>
<li>Trae</li>
<li>Continue</li>
</ul>
<p><strong>还在不断增加中！</strong></p>
<h3 data-id="heading-6">3️⃣ 多源安装支持</h3>
<p>支持从多种来源安装技能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 NPM 安装</span>
eskill install @myorg/react-skill

<span class="hljs-comment"># 从 Git 仓库安装</span>
eskill install https://github.com/user/repo/tree/main/skills/my-skill

<span class="hljs-comment"># 从本地目录安装（开发模式）</span>
eskill install ./my-local-skill --<span class="hljs-built_in">link</span>
</code></pre>
<h3 data-id="heading-7">4️⃣ 开发模式：即时更新</h3>
<p>这是<strong>技能开发者的福音</strong>！</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入你的技能目录</span>
<span class="hljs-built_in">cd</span> ~/projects/my-skill

<span class="hljs-comment"># 链接到开发环境</span>
eskill install . --<span class="hljs-built_in">link</span>

<span class="hljs-comment"># ✨ 现在修改代码，所有 AI 代理立即生效！</span>
<span class="hljs-comment"># 无需重新打包，无需重新安装</span>
</code></pre>
<p><strong>开发体验提升 10 倍！</strong></p>
<h3 data-id="heading-8">5️⃣ 灵活的安装策略</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装到所有代理（默认）</span>
eskill install my-skill

<span class="hljs-comment"># 只安装到特定代理</span>
eskill install my-skill --agent cursor

<span class="hljs-comment"># 强制重新安装</span>
eskill install my-skill --force
</code></pre>
<h2 data-id="heading-9">🎨 技术架构亮点</h2>
<h3 data-id="heading-10">符号链接技术</h3>
<p>使用操作系统的符号链接功能，实现<strong>零拷贝</strong>的技能分发：</p>
<pre><code class="hljs language-perl" lang="perl">~<span class="hljs-regexp">/.emp-agent/s</span>kills/<span class="hljs-keyword">my</span>-skill/     <span class="hljs-comment"># 实际存储位置</span>
    ├── SKILL.md
    └── references/

~<span class="hljs-regexp">/.cursor/s</span>kills/<span class="hljs-keyword">my</span>-skill -&gt; ~<span class="hljs-regexp">/.emp-agent/s</span>kills/<span class="hljs-keyword">my</span>-skill  <span class="hljs-comment"># 符号链接</span>
~<span class="hljs-regexp">/.claude/s</span>kills/<span class="hljs-keyword">my</span>-skill -&gt; ~<span class="hljs-regexp">/.emp-agent/s</span>kills/<span class="hljs-keyword">my</span>-skill  <span class="hljs-comment"># 符号链接</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>⚡ <strong>零延迟</strong>：链接创建瞬间完成</li>
<li>💾 <strong>省空间</strong>：不占用额外存储</li>
<li>🔄 <strong>自动同步</strong>：源文件更新，所有链接自动反映</li>
</ul>
<h3 data-id="heading-11">智能路径解析</h3>
<p>支持复杂的 Git URL 解析：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 支持分支</span>
eskill install https://github.com/user/repo/tree/dev/skills/my-skill

<span class="hljs-comment"># 支持子目录</span>
eskill install https://github.com/user/repo/tree/main/packages/skill

<span class="hljs-comment"># 自动提取技能名称</span>
</code></pre>
<h3 data-id="heading-12">完善的错误处理</h3>
<ul>
<li>⏱️ <strong>超时控制</strong>：网络请求自动超时，避免无限等待</li>
<li>🔍 <strong>详细错误提示</strong>：遇到问题，提供清晰的解决方案</li>
<li>🛡️ <strong>权限处理</strong>：智能处理文件权限问题，提供修复建议</li>
</ul>
<h2 data-id="heading-13">📊 使用场景</h2>
<h3 data-id="heading-14">场景 1：多 AI 代理用户</h3>
<p><strong>痛点：</strong> 需要在多个 AI 代理上使用相同的技能</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash">eskill install react-best-practices
<span class="hljs-comment"># 自动在所有已安装的代理上可用</span>
</code></pre>
<h3 data-id="heading-15">场景 2：技能开发者</h3>
<p><strong>痛点：</strong> 开发技能时需要频繁测试</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash">eskill install . --<span class="hljs-built_in">link</span>
<span class="hljs-comment"># 修改代码，立即在所有代理上测试</span>
</code></pre>
<h3 data-id="heading-16">场景 3：团队协作</h3>
<p><strong>痛点：</strong> 团队成员需要统一管理技能</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 统一从 NPM 或 Git 安装</span>
eskill install @team/shared-skills
<span class="hljs-comment"># 确保团队使用相同版本的技能</span>
</code></pre>
<h3 data-id="heading-17">场景 4：技能探索</h3>
<p><strong>痛点：</strong> 想尝试新技能，但不确定是否适合</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash">eskill install experimental-skill
eskill list  <span class="hljs-comment"># 查看所有已安装的技能</span>
eskill remove experimental-skill  <span class="hljs-comment"># 轻松卸载</span>
</code></pre>
<h2 data-id="heading-18">🚀 快速开始</h2>
<h3 data-id="heading-19">安装 eskill</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 pnpm（推荐）</span>
pnpm add -g @empjs/skill

<span class="hljs-comment"># 或使用 npm</span>
npm install -g @empjs/skill

<span class="hljs-comment"># 或使用 yarn</span>
yarn global add @empjs/skill

<span class="hljs-comment"># 或使用 bun</span>
bun install -g @empjs/skill
</code></pre>
<h3 data-id="heading-20">安装你的第一个技能</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看可用的技能</span>
eskill list

<span class="hljs-comment"># 安装一个技能</span>
eskill install &lt;skill-name&gt;

<span class="hljs-comment"># 查看已安装的技能</span>
eskill list

<span class="hljs-comment"># 查看支持的 AI 代理</span>
eskill agents
</code></pre>
<h2 data-id="heading-21">💎 为什么选择 eskill？</h2>
<h3 data-id="heading-22">✅ 对比传统方式</h3>



































<table><thead><tr><th>特性</th><th>传统方式</th><th>eskill</th></tr></thead><tbody><tr><td>安装步骤</td><td>每个代理单独安装</td><td>一次安装，全平台可用</td></tr><tr><td>存储空间</td><td>每个代理一份副本</td><td>统一存储，节省空间</td></tr><tr><td>更新效率</td><td>需要逐个更新</td><td>一次更新，全部生效</td></tr><tr><td>开发体验</td><td>打包→安装→测试循环</td><td>链接模式，即时生效</td></tr><tr><td>管理复杂度</td><td>高（多个目录）</td><td>低（统一管理）</td></tr></tbody></table>
<h3 data-id="heading-23">🎯 核心优势总结</h3>
<ol>
<li><strong>🚀 效率提升</strong>：一次操作，全平台生效</li>
<li><strong>💾 空间节省</strong>：统一存储，避免重复</li>
<li><strong>🛠️ 开发友好</strong>：链接模式，即时测试</li>
<li><strong>🔧 灵活配置</strong>：支持多源、多代理、多模式</li>
<li><strong>📦 生态兼容</strong>：支持 NPM、Git、本地目录</li>
</ol>
<h2 data-id="heading-24">🔮 未来展望</h2>
<p>eskill 正在快速发展，未来将支持：</p>
<ul>
<li>📊 <strong>技能市场</strong>：内置技能发现和评分系统</li>
<li>🔄 <strong>版本管理</strong>：技能版本控制和回滚</li>
<li>👥 <strong>团队协作</strong>：技能共享和权限管理</li>
<li>📈 <strong>使用统计</strong>：技能使用情况分析</li>
<li>🔌 <strong>插件系统</strong>：扩展更多 AI 代理支持</li>
</ul>
<h2 data-id="heading-25">🤔 还在犹豫？</h2>
<p><strong>试试看，只需要 30 秒：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 eskill</span>
pnpm add -g @empjs/skill

<span class="hljs-comment"># 2. 查看你的 AI 代理</span>
eskill agents

<span class="hljs-comment"># 3. 安装一个技能试试</span>
eskill install &lt;any-skill-name&gt;
</code></pre>
<p><strong>如果它不能提升你的效率，卸载它只需要：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm uninstall -g @empjs/skill
</code></pre>
<p><strong>但相信我，一旦你体验过统一管理的便利，就再也回不去了！</strong> 🎉</p>
<h2 data-id="heading-26">📚 了解更多</h2>
<ul>
<li>📖 <strong>完整文档</strong>：查看项目 README</li>
<li>🐛 <strong>问题反馈</strong>：GitHub Issues</li>
<li>💬 <strong>社区讨论</strong>：加入我们的社区</li>
<li>🔧 <strong>贡献代码</strong>：欢迎 Pull Request</li>
</ul>
<hr/>
<p><strong>现在就试试 eskill，让 AI 代理技能管理变得前所未有的简单！</strong></p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -g @empjs/skill
</code></pre>
<p><strong>一个命令，改变你的工作流。</strong> ✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一杯茶时间，带你用 RWKV 并发模型做 VS Code 多候选代码补全插件 🤔🤔🤔]]></title>    <link>https://juejin.cn/post/7597641580104581174</link>    <guid>https://juejin.cn/post/7597641580104581174</guid>    <pubDate>2026-01-21T10:05:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597641580104581174" data-draft-id="7597653098563207222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一杯茶时间，带你用 RWKV 并发模型做 VS Code 多候选代码补全插件 🤔🤔🤔"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2026-01-21T10:05:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一杯茶时间，带你用 RWKV 并发模型做 VS Code 多候选代码补全插件 🤔🤔🤔
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:05:10.000Z" title="Wed Jan 21 2026 10:05:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>在写这份实现教程之前，我已经把该插件的一个版本发布到了 VS Code 扩展市场，在市场中搜索 rwkv 即可找到，你可以先安装试用，再决定是否跟着下文从零实现一版。</p>
<p>本文以这款基于 RWKV 模型的智能代码补全插件为例，讲解从零实现 VS Code 扩展的思路与步骤，并说明如何接入 rwkv_lightning 后端。</p>
<p>该插件通过并发推理一次返回多个不同的补全答案供选择，在侧边栏展示，方便在多种写法之间对比、挑选后再插入，适合写一半、让模型多想几种实现的编码方式；光标后有代码时自动走 FIM（Fill-in-the-Middle）接口做中间填充，否则走普通续写。全文按功能目标、代码实现（项目结构、补全触发、API 调用、Webview 展示与插入）、后端接入组织，后端部分包含硬件要求、模型准备、与 Albatross 的关系、启动服务、模型加载机制、HTTP API、快速测试以及插件配置与验证，文末附常见问题。</p>
<p>下图为在编辑器中触发补全后，并发推理得到的多个不同答案在侧边栏展示、点击即可插入到光标位置的情形。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/204edb80919346ae881cf6808557a21d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=ezFcEpV6VInnZLGdp7VthIV88rw%3D" alt="rwkv-code-completion 效果" loading="lazy"/></p>
<p>前端项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2Frwkv-code-completion" target="_blank" title="https://github.com/xun082/rwkv-code-completion" ref="nofollow noopener noreferrer">rwkv-code-completion</a></p>
<p>后端项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRWKV-Vibe%2Frwkv_lightning" target="_blank" title="https://github.com/RWKV-Vibe/rwkv_lightning" ref="nofollow noopener noreferrer">rwkv_lightning</a></p>
<h2 data-id="heading-0">一、我们要做怎样的功能</h2>
<p>动手写代码之前，首先要考虑我们要实现一个什么样的 VS Code 插件，这决定了后续的架构与实现方式。</p>
<p>在本例中，我们想做一款智能代码补全插件，并事先想清楚四件事。补全结果通过并发推理一次返回多个不同的答案，在侧边栏展示供用户选择，点选后插入。根据光标后是否已有代码，在 FIM（Fill-in-the-Middle）与普通续写之间自动切换接口。在空格、换行、删除等操作时自动触发，并做好防抖与取消，避免频繁请求。服务地址、密码、生成长度、采样参数（<code>temperature</code>、<code>top_p</code>）、候选数量、防抖延迟等通过 VS Code 设置暴露。把这四件事的对应关系梳理出来，大致如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba36655dd4ce46b09b6826b0f9bf2093~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=a%2BV%2F0IgB8DBDNUUIagxfb6FAux4%3D" alt="20260121175047" loading="lazy"/></p>
<p>把这些想清楚之后，再按代码实现过程和如何接入后端两部分往下做。</p>
<h2 data-id="heading-1">二、代码实现过程</h2>
<h3 data-id="heading-2">2.1 项目结构</h3>
<p>用 <code>yo code</code> 或手工 scaffold 一个扩展后，核心只需两个源码文件，职责分开，与 VS Code 打交道的放一边，与后端 HTTP 打交道的放另一边，方便维护和单测。</p>
<ul>
<li><code>src/extension.ts</code> 作为插件入口，在 <code>activate</code> 里实现 <code>CompletionItemProvider</code>、注册补全、用 <code>onDidChangeTextDocument</code> 监听编辑并按条件触发补全；拿到候选列表后，不再往原生 suggest 里塞，而是创建 Webview、渲染多条结果，并处理用户点击插入与插完再补全。</li>
<li><code>src/completionService.ts</code> 负责补全服务，根据有无 suffix 选择调用普通续写接口或 FIM 接口，组装请求体、发 <code>fetch</code>、解析 <code>data.choices</code> 为 <code>string[]</code>，并透传 <code>AbortSignal</code> 以支持取消。</li>
</ul>
<p>两者与后端的关系可以概括为：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/633e39924e8b4734a58084ffe02313bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=nCLr9EHj9C39Z%2FarARAA2mvJlrU%3D" alt="20260121175344" loading="lazy"/></p>
<p>在 <code>package.json</code> 里，<code>main</code> 指向打包后的入口（如 <code>./dist/extension.js</code>），VS Code 按它加载扩展；<code>activationEvents</code> 可设为 <code>onStartupFinished</code>，这样只在 IDE 就绪后才激活，避免启动时卡顿；<code>contributes.configuration</code> 声明 <code>enabled</code>、<code>baseUrl</code>、<code>password</code>、<code>maxTokens</code>、<code>temperature</code>、<code>topP</code>、<code>numChoices</code>、<code>debounceDelay</code> 等，用户改设置后可通过 <code>vscode.workspace.getConfiguration("rwkv-code-completion")</code> 读到。</p>
<p>构建可用 esbuild 或 tsc，把 <code>extension.ts</code> 等打出到 <code>dist</code>，调试和发布都从 <code>dist</code> 走。</p>
<h3 data-id="heading-3">2.2 激活与补全触发</h3>
<p>激活时在 <code>activate(context)</code> 里完成两件事，一是向 VS Code 注册谁在什么情况下提供补全，二是监听文档变更，在特定编辑动作后自动调出补全，用户不必每次手动按 Ctrl+Space。</p>
<p>实现 <code>vscode.CompletionItemProvider</code> 的 <code>provideCompletionItems(document, position, token, context)</code>，再用 <code>vscode.languages.registerCompletionItemProvider</code> 挂上去。<code>selector</code> 用 <code>{ pattern: "**" }</code> 表示对所有语言生效；第三参数 <code>triggerChars</code> 是一串字符，当用户输入或删除其中某一个时，VS Code 会来调 <code>provideCompletionItems</code>。这里把空格、换行以及 ASCII 33–126（常见可打印字符）都放进去了，这样在写代码、加空格、换行时都有机会触发，例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> selector = { <span class="hljs-attr">pattern</span>: <span class="hljs-string">"**"</span> };
<span class="hljs-keyword">const</span> triggerChars = [
  <span class="hljs-string">" "</span>,
  <span class="hljs-string">"\n"</span>,
  ...<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">94</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(i + <span class="hljs-number">33</span>)),
];
vscode.<span class="hljs-property">languages</span>.<span class="hljs-title function_">registerCompletionItemProvider</span>(
  selector,
  provider,
  ...triggerChars,
);
</code></pre>
<p>光有 <code>triggerChars</code> 还不够，例如用户输入 <code>a</code>、<code>b</code>、<code>c</code> 时也会触发，容易导致敲一个字母就发一次请求。因此再加一层文档变更的过滤，用 <code>vscode.workspace.onDidChangeTextDocument</code> 监听，只有在本次编辑是删除、换行或输入一个空格时，才在防抖后执行 <code>editor.action.triggerSuggest</code>，从而间接调用 <code>provideCompletionItems</code>。这样可以把触发收敛到更自然的断句、换行场景，例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> shouldTrigger = event.<span class="hljs-property">contentChanges</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">change</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> isDelete = change.<span class="hljs-property">rangeLength</span> &gt; <span class="hljs-number">0</span> &amp;&amp; change.<span class="hljs-property">text</span> === <span class="hljs-string">""</span>;
  <span class="hljs-keyword">const</span> isNewline = change.<span class="hljs-property">text</span> === <span class="hljs-string">"\n"</span> || change.<span class="hljs-property">text</span> === <span class="hljs-string">"\r\n"</span>;
  <span class="hljs-keyword">const</span> isSpace = change.<span class="hljs-property">text</span> === <span class="hljs-string">" "</span>;
  <span class="hljs-keyword">return</span> isDelete || isNewline || isSpace;
});
<span class="hljs-keyword">if</span> (shouldTrigger) {
  debounceTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    vscode.<span class="hljs-property">commands</span>.<span class="hljs-title function_">executeCommand</span>(<span class="hljs-string">"editor.action.triggerSuggest"</span>);
  }, config.<span class="hljs-property">debounceDelay</span>);
}
</code></pre>
<p>防抖时间用 <code>config.debounceDelay</code>（如 150–300ms），用户停一会儿才发请求，减少连打时的无效调用。还可以加两条限制，一是只处理当前活动编辑器的文档，避免在切文件、分屏时误触发，二是与上一次触发至少间隔几百毫秒，进一步避免短时间内重复弹补全。整体触发链路如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58439c6a7b144c7385b7a656c182ea49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=IMKFrVh%2B6DNcCmXwbfnuJDZpBms%3D" alt="20260121175403" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 补全逻辑与 API 调用</h3>
<p><code>provideCompletionItems</code> 被调用后，先做一轮要不要真的发请求的过滤和节流，再取上下文、调后端、拿 <code>string[]</code>。</p>
<p>流程可以拆成五步。一，读配置，若 <code>enabled</code> 为 false 直接 <code>return null</code>。二，防抖，用 <code>setTimeout(..., debounceDelay)</code> 把实际请求放到回调里；若在等待期间又有新的触发，则 <code>clearTimeout</code> 掉上一次，只保留最后一次，这样连续输入时只会发一次请求。三，若此前已有进行中的 <code>fetch</code>，用 <code>AbortController.abort()</code> 取消，再 <code>new AbortController()</code> 给本次请求用。四，取上下文，前缀 prefix 为从文档开头到光标前的文本，<code>document.getText(new vscode.Range(0, 0, position))</code>，过长时截断到约 2000 字符，避免超过后端限制；后缀 suffix 为从光标到往后若干行（如 10 行），主要用来判断光标后是否还有代码，从而决定走 FIM 还是普通续写。五，调用 <code>CompletionService.getCompletion(prefix, suffix, languageId, config, abortController.signal)</code>，在 <code>withProgress</code> 里展示正在生成 N 个补全并可取消。五步关系如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e33a7e192f44509a346529bb264c1d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=4yhXZPjH4SP74Yr4x%2FfYRXLP2CA%3D" alt="20260121175421" loading="lazy"/></p>
<p><code>CompletionService.getCompletion</code> 内部按 <code>suffix</code> 是否非空分支，有后缀则认为用户在中间写代码，走 FIM，否则走普通续写。接口选择如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb8a1e9388e46ffa144418c8455bbaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=%2FYuFsk40SPs%2FsFI74zDrgjoW9PI%3D" alt="20260121175704" loading="lazy"/></p>
<p>例如下面这样。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getCompletion</span>(prefix, suffix, languageId, config, signal): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {
  <span class="hljs-keyword">const</span> hasSuffix = suffix &amp;&amp; suffix.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> hasSuffix
    ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callFIMAPI</span>(prefix, suffix, config, signal)
    : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callCompletionAPI</span>(prefix, config, signal);
}
</code></pre>
<p>普通补全走 <code>callCompletionAPI</code>，请求 <code>POST {baseUrl}/v2/chat/completions</code>。body 里 <code>contents</code> 填 <code>Array(numChoices).fill(prefix)</code>，即同一段 prefix 复制多份，利用后端批量接口一次推理出多条不同采样结果；再配上 <code>stream: false</code>、<code>password</code>、<code>max_tokens</code>、<code>temperature</code>、<code>top_p</code>、<code>stop_tokens</code> 等。返回的 <code>data.choices</code> 里，每条取 <code>choice.message?.content || choice.text</code>，trim 掉首尾空白并滤掉空串，得到 <code>string[]</code>。</p>
<p>FIM 补全走 <code>callFIMAPI</code>，请求 <code>POST {baseUrl}/FIM/v1/batch-FIM</code>。<code>prefix</code>、<code>suffix</code> 各为长度为 4 的数组（同一 prefix、同一 suffix 各复制 4 份），对应 4 条并发中间填充；其它参数与普通补全类似，解析方式相同。两处都把 <code>signal</code> 传给 <code>fetch</code>，这样在用户点击取消、或防抖导致下一次触发而 <code>abort()</code> 时，正在进行的请求会被中断，不把过时结果再展示出来。</p>
<h3 data-id="heading-5">2.4 Webview 展示与插入</h3>
<p>拿到 <code>string[]</code> 之后，不转成 <code>CompletionItem[]</code> 通过 <code>resolve(items)</code> 塞给原生 suggest，因为原生列表单条、偏短，且没法做多列、点击选一等自定义交互。这里改为 <code>resolve(null)</code> 表示不往建议列表里填，同时在 <code>withProgress</code> 里调 <code>showCompletionWebview(document, position, completions, languageId)</code>，用 Webview 在侧边栏展示多条候选，支持多选一、点即插、插完再补。</p>
<p>用 <code>vscode.window.createWebviewPanel</code> 创建 Webview，指定 id、标题、<code>ViewColumn.Two</code> 在侧边打开，以及 <code>enableScripts: true</code>、<code>retainContextWhenHidden: true</code> 以便跑脚本和在切走时保留状态。<code>panel.webview.html</code> 由 <code>getWebviewContent(completions, languageId)</code> 生成。在打开面板之前，必须把当时的 <code>document</code> 和 <code>position</code> 存到闭包或变量里，因为 Webview 是异步的，用户可能切文件、移光标，等到点击插入时要以当初触发补全的那次位置为准，否则会插错地方。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> panel = vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">createWebviewPanel</span>(
  <span class="hljs-string">"rwkvCompletion"</span>,
  <span class="hljs-string">"RWKV 代码补全 (N 个选项)"</span>,
  vscode.<span class="hljs-property">ViewColumn</span>.<span class="hljs-property">Two</span>,
  { <span class="hljs-attr">enableScripts</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">retainContextWhenHidden</span>: <span class="hljs-literal">true</span> },
);
panel.<span class="hljs-property">webview</span>.<span class="hljs-property">html</span> = <span class="hljs-title function_">getWebviewContent</span>(completions, languageId);
</code></pre>
<p>HTML 里顶部放标题与简短说明，下面一个 <code>div</code> 容器，用 <code>grid-template-columns: 1fr 1fr</code> 做多列布局，每个格子一个 <code>div.code-block</code>，含小标题（序号、字符数、行数）和 <code>&lt;pre&gt;&lt;code&gt;</code> 放补全内容。补全文本要先做 HTML 转义再插入，避免 XSS；颜色、背景用 <code>var(--vscode-editor-background)</code> 等，跟主题一致；<code>:hover</code>、<code>.selected</code> 给一点高亮，点的时候有反馈。</p>
<p>前端通过 <code>acquireVsCodeApi()</code> 拿到和扩展通信的 API，<code>completions</code> 在 <code>getWebviewContent</code> 里用 JSON 注入到页面。每个 <code>code-block</code> 点击时执行 <code>vscode.postMessage({ command: 'insert', code: completions[index] })</code>。扩展侧在 <code>panel.webview.onDidReceiveMessage</code> 里监听，若 <code>message.command === 'insert'</code>，先 <code>vscode.window.showTextDocument(targetDocument, ViewColumn.One)</code> 把原文档激活到主编辑区，再用 <code>editor.edit(eb =&gt; eb.insert(targetPosition, message.code))</code> 在事先存好的 <code>targetPosition</code> 插入；插入成功后 <code>panel.dispose()</code> 关掉 Webview，并 <code>setTimeout(..., 300)</code> 后执行 <code>editor.action.triggerSuggest</code>，让光标后的新内容再触发一轮补全，形成补全、选一、再补全的连贯体验。从拿到结果到插入再触发的流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa6a44c7516a40cd9787f3f5bf275f64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=69lspM4ULAo%2BBYsndA1sVVPWnpQ%3D" alt="20260121175751" loading="lazy"/></p>
<p>原生 suggest 只能一条条、样式固定，没法同时展示多条并发结果和自定义交互；用 Webview 可以自己布局、自己处理点击和插入，更适合并发推理、多答案选一的用法。</p>
<h2 data-id="heading-6">三、如何接入后端</h2>
<p>插件通过 HTTP 调用 rwkv_lightning，需要先部署后端，再在 VS Code 里填好配置。扩展详情页会标注后端部署与配置说明，便于快速上手，下图为扩展市场中的页面示意。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c0cd18968d24494aa0d438b30343570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=6CBrZ8Y1XfuhkxwsLkGHb945vhE%3D" alt="RWKV 代码补全 - 扩展市场页面" loading="lazy"/></p>
<p>接入后端的整体步骤如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2368205db5be412c9a22b702bcaadce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769594861&amp;x-signature=4P2%2Fos7gF35tN%2FOhe0cnhnkQR04%3D" alt="20260121175818" loading="lazy"/></p>
<h3 data-id="heading-7">3.1 硬件要求</h3>
<p>重要提示：本后端必须使用 GPU 加速，不支持纯 CPU 运行。</p>
<p>rwkv_lightning 依赖自定义的 CUDA 或 HIP 内核进行高性能推理，因此需要以下硬件之一：</p>
<ul>
<li>NVIDIA GPU：需要支持 CUDA 的 NVIDIA 显卡，并安装 CUDA 工具包</li>
<li>AMD GPU：需要支持 ROCm 的 AMD 显卡，并安装 ROCm 运行时</li>
</ul>
<p>如果您只有 CPU 环境，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fggerganov%2Fllama.cpp" target="_blank" title="https://github.com/ggerganov/llama.cpp" ref="nofollow noopener noreferrer">llama.cpp</a> 进行 RWKV 模型的 CPU 推理，该项目针对 CPU 进行了专门优化。</p>
<h3 data-id="heading-8">3.2 模型文件准备</h3>
<p>rwkv_lightning 当前不提供自动下载功能，需要您自行准备模型权重文件。</p>
<h4 data-id="heading-9">下载模型权重</h4>
<p>RWKV-7 模型的官方权重托管在 Hugging Face 上，推荐从 <code>BlinkDL/rwkv7-g1</code> 仓库下载。模型文件格式为 <code>.pth</code>，例如 <code>rwkv7-g1b-1.5b-20251202-ctx8192.pth</code>。</p>
<p>您可以通过以下方式下载：</p>
<p>方式一：使用 huggingface-cli（推荐）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 首先登录 Hugging Face（如未登录）</span>
huggingface-cli login

<span class="hljs-comment"># 下载模型文件</span>
huggingface-cli download BlinkDL/rwkv7-g1 \
  rwkv7-g1b-1.5b-20251202-ctx8192.pth \
  --local-dir /path/to/models \
  --local-dir-use-symlinks False
</code></pre>
<p>方式二：使用 Python 脚本</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> huggingface_hub <span class="hljs-keyword">import</span> hf_hub_download

model_path = hf_hub_download(
    repo_id=<span class="hljs-string">"BlinkDL/rwkv7-g1"</span>,
    filename=<span class="hljs-string">"rwkv7-g1b-1.5b-20251202-ctx8192.pth"</span>,
    local_dir=<span class="hljs-string">"/path/to/models"</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型已下载到: <span class="hljs-subst">{model_path}</span>"</span>)
</code></pre>
<h4 data-id="heading-10">路径命名规则</h4>
<p>启动服务时，<code>--model-path</code> 支持两种写法。写法一：不带后缀，程序会自动补上 <code>.pth</code>，例如：</p>
<pre><code class="hljs language-bash" lang="bash">--model-path /path/to/rwkv7-g1b-1.5b-20251202-ctx8192
<span class="hljs-comment"># 实际加载: /path/to/rwkv7-g1b-1.5b-20251202-ctx8192.pth</span>
</code></pre>
<h3 data-id="heading-11">3.3 与 Albatross 的关系</h3>
<p>rwkv_lightning 是基于 Albatross 高效推理引擎开发的 HTTP 服务后端。Albatross 是 BlinkDL 开发的高性能 RWKV 推理引擎，专注于底层计算优化和性能基准测试。</p>
<h4 data-id="heading-12">Albatross 项目简介</h4>
<p>Albatross 是一个独立的开源项目，GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBlinkDL%2FAlbatross%25E3%2580%2582%25E5%25AE%2583%25E6%258F%2590%25E4%25BE%259B%25E4%25BA%2586" target="_blank" title="https://github.com/BlinkDL/Albatross%E3%80%82%E5%AE%83%E6%8F%90%E4%BE%9B%E4%BA%86" ref="nofollow noopener noreferrer">github.com/BlinkDL/Alb…</a> RWKV-7 模型的高效推理实现，包括：</p>
<ul>
<li>批量推理支持：支持大规模批量处理，在 RTX 5090 上可实现 7B 模型 fp16 bsz960 超过 10000 token/s 的解码速度</li>
<li>性能优化：集成了 CUDA Graph、稀疏 FFN、自定义 CUDA 内核等优化技术</li>
<li>基准测试工具：提供详细的性能基准测试脚本，用于评估不同配置下的推理性能</li>
<li>参考实现：包含完整的模型实现和工具类，可作为开发参考</li>
</ul>
<h4 data-id="heading-13">性能参考数据</h4>
<p>根据 Albatross 官方测试结果（RTX 5090，RWKV-7 7.2B fp16）：</p>
<ul>
<li>单样本解码（bsz=1）：145+ token/s，使用 CUDA Graph 优化后可达 123+ token/s</li>
<li>批量解码（bsz=960）：10250+ token/s</li>
<li>Prefill 阶段（bsz=1）：11289 token/s</li>
<li>批量解码（bsz=320）：5848 token/s，速度恒定且显存占用稳定（RNN 特性）</li>
</ul>
<h4 data-id="heading-14">rwkv_lightning 的定位</h4>
<p>rwkv_lightning 在 Albatross 的基础上，专注于提供生产级的 HTTP 推理服务：</p>
<ul>
<li>HTTP API 接口：提供完整的 RESTful API，支持流式和非流式推理</li>
<li>状态管理：实现三级缓存系统（VRAM、RAM、Disk），支持会话状态持久化</li>
<li>连续批处理：动态管理批次，提高 GPU 利用率</li>
<li>多接口支持：提供聊天、翻译、代码补全等多种应用场景的专用接口</li>
</ul>
<p>如果您需要深入了解底层实现细节、进行性能调优或对比不同优化方案，建议参考 Albatross 项目的源代码和基准测试脚本。Albatross 提供了更底层的实现细节，而 rwkv_lightning 则专注于提供易用的服务化接口。</p>
<h3 data-id="heading-15">3.4 启动推理服务</h3>
<p>rwkv_lightning 以 Robyn 版本为主，提供密码认证、多接口、状态管理等特性，适合生产环境使用。Robyn 版本功能更全面，支持密码认证、多接口、状态管理等高级特性，适合生产环境使用。</p>
<pre><code class="hljs language-bash" lang="bash">python main_robyn.py --model-path /path/to/model --port 8000 --password rwkv7_7.2b
</code></pre>
<p>如果不需要密码保护，可以省略 <code>--password</code> 参数：</p>
<pre><code class="hljs language-bash" lang="bash">python main_robyn.py --model-path /path/to/model --port 8000
</code></pre>
<h3 data-id="heading-16">3.5 模型加载机制</h3>
<p>了解模型加载机制有助于排查问题和优化性能。</p>
<h4 data-id="heading-17">权重加载流程</h4>
<p>模型类 <code>RWKV_x070</code> 在初始化时会执行以下步骤：</p>
<ol>
<li>读取权重文件：使用 <code>torch.load(args.MODEL_NAME + '.pth', map_location='cpu')</code> 将权重加载到 CPU 内存</li>
<li>数据类型转换：将权重转换为半精度（<code>dtype=torch.half</code>）以节省显存</li>
<li>设备迁移：根据硬件平台将权重移动到 GPU
<ul>
<li>NVIDIA GPU：使用 <code>device="cuda"</code></li>
<li>AMD GPU：使用 ROCm 的 HIP 运行时</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">词表加载</h4>
<p>词表文件 <code>rwkv_batch/rwkv_vocab_v20230424.txt</code> 通过 <code>TRIE_TOKENIZER</code> 类自动加载。TRIE 数据结构提供了高效的 token 查找和编码、解码功能。</p>
<h4 data-id="heading-19">CUDA、HIP 内核编译</h4>
<p>项目包含自定义的 CUDA（NVIDIA）和 HIP（AMD）内核，用于加速 RWKV 的核心计算。这些内核在首次导入 <code>rwkv_batch.rwkv7</code> 模块时通过 <code>torch.utils.cpp_extension.load</code> 自动编译和加载：</p>
<ul>
<li>CUDA 内核：<code>rwkv_batch/cuda/rwkv7_state_fwd_fp16.cu</code></li>
<li>HIP 内核：<code>rwkv_batch/hip/rwkv7_state_fwd_fp16.hip</code></li>
</ul>
<p>首次运行时会进行编译，可能需要几分钟时间。编译后的内核会被缓存，后续启动会更快。</p>
<h3 data-id="heading-20">3.6 HTTP API 接口</h3>
<p>rwkv_lightning 提供了丰富的 HTTP API 接口，支持多种推理场景。</p>
<h4 data-id="heading-21">聊天完成接口</h4>
<ul>
<li>v1/chat/completions：基础批量同步处理接口，支持流式和非流式输出。</li>
<li>v2/chat/completions：连续批处理接口，动态管理批次以提高 GPU 利用率，适合高并发场景。</li>
<li>v3/chat/completions：异步批处理接口，使用 CUDA Graph 优化（batch_size=1 时），提供最低延迟。</li>
</ul>
<h4 data-id="heading-22">Fill-in-the-Middle 接口</h4>
<p>FIM/v1/batch-FIM：支持代码和文本的中间填充补全，适用于代码补全、文本编辑等场景。</p>
<h4 data-id="heading-23">批量翻译接口</h4>
<p>translate/v1/batch-translate：批量翻译接口，兼容沉浸式翻译插件的 API 格式，支持多语言互译。</p>
<h4 data-id="heading-24">会话状态管理接口</h4>
<p>state/chat/completions：支持会话状态缓存的对话接口，实现多轮对话的上下文保持。状态采用三级缓存设计：</p>
<ul>
<li>L1 缓存：VRAM（显存），最快访问</li>
<li>L2 缓存：RAM（内存），中等速度</li>
<li>L3 缓存：SQLite 数据库（磁盘），持久化存储</li>
</ul>
<h4 data-id="heading-25">流式推理示例</h4>
<p>以下示例展示如何使用 v2 接口进行批量流式推理：</p>
<pre><code class="hljs language-bash" lang="bash">curl -N -X POST http://localhost:8000/v2/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "contents": [
      "English: After a blissful two weeks, Jane encounters Rochester in the gardens.\n\nChinese:",
      "English: That night, a bolt of lightning splits the same chestnut tree.\n\nChinese:"
    ],
    "max_tokens": 1024,
    "stop_tokens": [0, 261, 24281],
    "temperature": 0.8,
    "top_k": 50,
    "top_p": 0.6,
    "alpha_presence": 1.0,
    "alpha_frequency": 0.1,
    "alpha_decay": 0.99,
    "stream": true,
    "chunk_size": 128,
    "password": "rwkv7_7.2b"
  }'</span>
</code></pre>
<h3 data-id="heading-26">3.7 快速测试与性能评估</h3>
<h4 data-id="heading-27">快速测试</h4>
<p>项目提供了测试脚本，可以快速验证服务是否正常运行：</p>
<pre><code class="hljs language-bash" lang="bash">bash ./test_curl.sh
</code></pre>
<p>该脚本会发送示例请求到本地服务，检查各个接口的基本功能。</p>
<h4 data-id="heading-28">性能基准测试</h4>
<p>使用 <code>benchmark.py</code> 脚本可以评估模型的推理性能，包括吞吐量、延迟等指标：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 需要先修改 benchmark.py 中的模型路径</span>
python benchmark.py
</code></pre>
<p>基准测试会输出详细的性能报告，帮助您了解模型在不同配置下的表现。</p>
<h3 data-id="heading-29">3.8 插件配置</h3>
<p>在 VS Code 中打开设置（可搜索 <code>rwkv-code-completion</code> 或执行命令 <code>RWKV: 打开设置</code>），重点配置：</p>








































<table><thead><tr><th>配置项</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>rwkv-code-completion.enabled</code></td><td>是否启用补全</td><td><code>true</code></td></tr><tr><td><code>rwkv-code-completion.baseUrl</code></td><td>后端基础地址，不含路径</td><td><code>http://192.168.0.157:8000</code> 或 <code>http://localhost:8000</code></td></tr><tr><td><code>rwkv-code-completion.password</code></td><td>与 <code>--password</code> 一致</td><td><code>rwkv7_7.2b</code></td></tr><tr><td><code>rwkv-code-completion.maxTokens</code></td><td>单次生成最大 token 数</td><td><code>200</code></td></tr><tr><td><code>rwkv-code-completion.numChoices</code></td><td>普通补全的候选数量（1–50）</td><td><code>24</code></td></tr><tr><td><code>rwkv-code-completion.debounceDelay</code></td><td>防抖延迟（毫秒）</td><td><code>150</code>–<code>300</code></td></tr></tbody></table>
<p><code>baseUrl</code> 只需填 <code>http(s)://host:port</code>，插件内部会拼上 <code>/v2/chat/completions</code> 和 <code>/FIM/v1/batch-FIM</code>。若设置界面中仅有 <code>endpoint</code> 等项，可在 <code>settings.json</code> 中手动添加 <code>"rwkv-code-completion.baseUrl": "http://&lt;主机&gt;:&lt;端口&gt;"</code>。</p>
<h3 data-id="heading-30">3.9 验证接入</h3>
<p>可先用 <code>curl -X POST http://&lt;host&gt;:&lt;port&gt;/v2/chat/completions -H "Content-Type: application/json" -d '{"contents":["你好"],"max_tokens":10,"password":"&lt;你的password&gt;"}'</code> 或运行 <code>./test_curl.sh</code> 确认 v2 与 FIM 接口正常。在任意代码文件中输入、换行或删除，防抖后应出现「🤖 RWKV 正在生成 N 个代码补全...」并弹出侧边栏展示多个候选；若失败，可查看「输出」中该扩展的 channel 或弹窗报错，检查 <code>baseUrl</code>、<code>password</code>、端口与防火墙。</p>
<hr/>
<h2 data-id="heading-31">四、常见问题</h2>
<h3 data-id="heading-32">为何不能在 CPU 上运行？</h3>
<p>rwkv_lightning 的核心计算依赖自定义的 CUDA、HIP 内核，这些内核专门为 GPU 并行计算设计。CPU 无法执行这些内核代码，因此必须使用 GPU。如果您需要在 CPU 上运行 RWKV 模型，请使用 llama.cpp，它提供了针对 CPU 优化的实现。</p>
<h3 data-id="heading-33">模型权重应该放在哪里？</h3>
<p>模型权重可以放在任何可访问的路径。启动服务时通过 <code>--model-path</code> 参数指定路径即可。路径可以是绝对路径或相对路径，程序会自动处理 <code>.pth</code> 后缀的添加。</p>
<h3 data-id="heading-34">首次启动为什么很慢？</h3>
<p>首次启动时会编译 CUDA、HIP 内核，这个过程可能需要几分钟。编译后的内核会被缓存，后续启动会快很多。如果希望进一步优化性能，可以考虑使用 <code>torch.compile</code> 模式（详见 README.md 中的 Tips 部分）。</p>
<h3 data-id="heading-35">如何选择合适的接口？</h3>
<ul>
<li>v1：适合简单的批量推理需求</li>
<li>v2：适合高并发场景，需要动态批处理</li>
<li>v3：适合单请求低延迟场景（batch_size=1）</li>
<li>FIM：适合代码补全和文本编辑</li>
<li>state：适合需要保持上下文的对话场景</li>
</ul>
<p>本插件已按「无 suffix 用 v2、有 suffix 用 FIM」自动选择。</p>
<h3 data-id="heading-36">如何实现自动下载模型？</h3>
<p>当前版本不提供内置的自动下载功能。您可以在启动脚本中添加下载逻辑，使用 <code>huggingface_hub</code> 库在启动前检查并下载模型文件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你上手 Skills：构建可复用的 AI 能力体系]]></title>    <link>https://juejin.cn/post/7597653098563895350</link>    <guid>https://juejin.cn/post/7597653098563895350</guid>    <pubDate>2026-01-21T13:29:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098563895350" data-draft-id="7597693638923026495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你上手 Skills：构建可复用的 AI 能力体系"/> <meta itemprop="keywords" content="Claude,AIGC"/> <meta itemprop="datePublished" content="2026-01-21T13:29:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你上手 Skills：构建可复用的 AI 能力体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:29:50.000Z" title="Wed Jan 21 2026 13:29:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>标准化、可复用、渐进式——让 AI 高效完成重复性任务</p>
</blockquote>
<h2 data-id="heading-0">一、 为什么需要 Skills</h2>
<p>在传统 LLM 使用场景中，我们通常依赖 Prompt 来让模型完成任务，例如：</p>
<blockquote>
<p>"你是一个项目经理，请根据输入内容生成符合公司规范的周报……"</p>
</blockquote>
<p>这种方式存在三个核心问题：</p>
<ol>
<li>
<p><strong>不稳定</strong>：模型对同一个 Prompt 的理解可能不同，输出结果不一致。</p>
</li>
<li>
<p><strong>不可复用</strong>：每次都要重新编写 Prompt，效率低。</p>
</li>
<li>
<p><strong>不可组合</strong>：难以将多个任务整合成复杂工作流。</p>
</li>
</ol>
<p>Claude Skills 提供了解决方案：</p>
<blockquote>
<p><strong>Skills = 可复用的、结构化的 Prompt + 执行规则 + 资源</strong></p>
</blockquote>
<p>它将“如何做一件事”封装成 Claude 可长期记住和调用的能力模块，让 AI 的执行更标准、稳定、可组合。</p>
<hr/>
<h2 data-id="heading-1">二、什么是 Skills</h2>
<p><strong>Skills</strong> 是 Claude 的可复用能力包，用于将<strong>领域知识、最佳实践、工作流程和执行逻辑</strong>封装，使 Claude 高质量、稳定地完成任务。</p>
<h3 data-id="heading-2">1. 基本目录结构</h3>
<p>一个标准的 Skill 项目，目录结构清晰且轻量化，核心文件仅1个，其他均为可选补充：</p>
<pre><code class="hljs language-text" lang="text">
my-skill/

├── SKILL.md # 必需：元数据 + 执行指令

├── scripts/ # 可选：可执行脚本

├── templates/ # 可选：模板文件

└── resources/ # 可选：其他资源文件

</code></pre>
<h3 data-id="heading-3">2. 核心文件 SKILL.md 示例</h3>
<pre><code class="hljs language-markdown" lang="markdown">
---

name: report-automation

description: 根据输入生成日报/周报/月报，并按模板输出 Markdown。

---

  

<span class="hljs-section">##  指令</span>

<span class="hljs-bullet">1.</span> 提取岗位、报告类型、姓名、日期和工作内容

<span class="hljs-bullet">2.</span> 选择对应模板

<span class="hljs-bullet">3.</span> 生成结构化 Markdown 报告

</code></pre>
<p>这里要注意：</p>
<ul>
<li>
<p>头部的 name 和 description 是元数据，主要用于 Claude 快速匹配——当你输入需求时，Claude 会根据这两个字段判断是否需要调用该 Skill；</p>
</li>
<li>
<p>下方的“执行指令”是核心，必须清晰、可落地，相当于给 Claude 写的“操作手册”，避免执行偏差。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、Skills 的「渐进式架构」</h2>
<p>当我们需要同时用到多个Skill（比如周报生成、需求分析、文档校验）时，直接全量加载所有Skill会遇到三个核心问题，这也是渐进式架构要解决的核心痛点：</p>
<ul>
<li>
<p><strong>Token消耗暴涨</strong>：每个Skill包含的脚本、模板等都是文本内容，全量加载会让单次调用的Token量大幅增加，直接提升使用成本；</p>
</li>
<li>
<p><strong>任务干扰严重</strong>：无关Skill的内容会占用上下文，比如生成周报时加载了需求分析的规则，可能导致Claude误解需求，降低执行精准度；</p>
</li>
<li>
<p><strong>逻辑冲突风险</strong>：不同Skill的执行规则可能存在重叠（比如都有格式校验步骤），全量加载会让Claude难以判断执行优先级，影响输出稳定性。</p>
</li>
</ul>
<p>针对这些问题，Claude Skills采用**渐进式披露（Progressive Disclosure）**架构，核心思路是：<strong>不一次性加载所有Skill内容，而是先匹配需求，再按需逐步加载对应内容</strong>，核心载体是“三层加载模型”：</p>
<p>| 层级 | 内容 | 作用 |</p>
<p>|  -------  |  -------------------------------  |  --------  |</p>
<p>| Level 1（初始加载） | 各Skill的name + description（元数据） |  <strong>意图匹配</strong>：快速匹配用户需求，确定是否需要调用某个Skill，不占用过多上下文 |</p>
<p>| Level 2（确定调用后） | 目标Skill的SKILL.md核心执行指令 |  <strong>执行规则</strong>：明确该Skill的执行步骤，完成核心任务流程 |</p>
<p>| Level 3（按需加载） | 目标Skill的scripts/ templates/ resources等配套资源 |  <strong>按需加载</strong>：补充辅助资源，仅在需要时加载，避免无关内容干扰 |</p>
<p><strong>渐进式架构的核心优势</strong></p>
<ul>
<li>
<p><strong>支持大量 Skill 共存</strong>：即使你有十几个、几十个 Skill，初始也只加载元数据，不会占满上下文；</p>
</li>
<li>
<p><strong>干扰最小化</strong>：只加载当前任务相关的 Skill 内容，执行更精准、效率更高；</p>
</li>
<li>
<p><strong>可组合调度</strong>：多个 Skill 可以按层级依次加载、串联执行，轻松实现复杂工作流。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">四、Skills 的使用方式</h2>
<p>Claude Skills 支持两种主流使用方式，覆盖日常办公和技术集成场景：</p>
<h3 data-id="heading-6">4.1 桌面端 / CLI 端（日常办公用）</h3>
<ul>
<li>
<p>自动触发：你输入需求后，Claude 自动匹配对应的 Skill（根据 name + description），无需手动调用；</p>
</li>
<li>
<p>显式调用：如果需要指定 Skill，直接输入/skill-name 命令即可（比如 /report-automation）；</p>
</li>
<li>
<p>参数传递：可以用自然语言输入参数（比如“生成产品经理的本周周报，内容包括：需求评审3次、原型设计2个、用户访谈5人”），也可以用结构化格式（如 JSON）传递，更精准。</p>
</li>
</ul>
<h3 data-id="heading-7">4.2 API 集成（技术同学用，支持自动化部署）</h3>
<p>如果需要把 Skill 集成到自己的系统、工具中，可以通过 Claude API 调用，示例代码（Python）：</p>
<pre><code class="hljs language-python" lang="python">
response = claude_client.messages.create(

model=<span class="hljs-string">"claude-3-opus"</span>,

messages=[{<span class="hljs-string">"role"</span>:  <span class="hljs-string">"user"</span>,  <span class="hljs-string">"content"</span>:  <span class="hljs-string">"帮我生成本周的周报"</span>}],

tools=[{<span class="hljs-string">"type"</span>:  <span class="hljs-string">"skill"</span>,  <span class="hljs-string">"skill_id"</span>:  <span class="hljs-string">"report-automation"</span>}]

)

</code></pre>
<blockquote>
<p>注：使用前需要先在 Claude 开发者平台创建 Skill，获取对应的 skill_id，并配置好 API 密钥</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">五、Demo 案例：日报 / 周报 / 月报自动生成 Skill</h2>
<p>这里分享一个 Skills Demo 案例：自动生成日报/周报/月报。</p>
<h3 data-id="heading-9">1. 明确功能需求</h3>
<ul>
<li>
<p>接收用户输入的工作内容，自动识别报告类型（日/周/月）；</p>
</li>
<li>
<p>按预设模板生成结构化 Markdown 报告；</p>
</li>
<li>
<p>支持将生成的报告自动上传到 S3 存储，生成可访问的链接。</p>
</li>
</ul>
<h3 data-id="heading-10">2. 目录结构设计</h3>
<pre><code class="hljs language-text" lang="text">
report-generator/

├── SKILL.md

├── resources/

│ ├── daily_report_template.md

│ ├── weekly_report_template.md

│ └── monthly_report_template.md

├── scripts/

│ └── upload_report.py

</code></pre>
<h3 data-id="heading-11">3. 核心文件实现</h3>
<h4 data-id="heading-12">SKILL.md 核心指令</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc6767ae4054c1e9629fce3996f9aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=r4bQdITunKU8bC9seSeczzzEawE%3D" alt="SKILL.md" loading="lazy"/></p>
<h4 data-id="heading-13">scripts 脚本 <code>upload_report.py</code></h4>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-keyword">import</span> boto3

  

load_dotenv(Path(__file__).parent /  <span class="hljs-string">'.env'</span>)

  

report_type = sys.argv[<span class="hljs-number">1</span>].lower()

report_content =  <span class="hljs-built_in">open</span>(sys.argv[<span class="hljs-number">3</span>],  <span class="hljs-string">'r'</span>,  encoding=<span class="hljs-string">'utf-8'</span>).read()  <span class="hljs-keyword">if</span>  <span class="hljs-built_in">len</span>(

sys.argv)  &gt;=  <span class="hljs-number">4</span>  <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">2</span>]  ==  <span class="hljs-string">"-f"</span>  <span class="hljs-keyword">else</span>  <span class="hljs-string">"  "</span>.join(sys.argv[<span class="hljs-number">2</span>:])

  

S3_ENDPOINT  = os.environ.get(<span class="hljs-string">"S3_ENDPOINT"</span>)

S3_BUCKET  = os.environ.get(<span class="hljs-string">"S3_BUCKET"</span>)

S3_REGION  = os.environ.get(<span class="hljs-string">"S3_REGION"</span>,  <span class="hljs-string">"us-east-1"</span>)

S3_ACCESS_KEY  = os.environ.get(<span class="hljs-string">"S3_ACCESS_KEY"</span>)

S3_SECRET_KEY  = os.environ.get(<span class="hljs-string">"S3_SECRET_KEY"</span>)

  
  

filename =  <span class="hljs-string">f"<span class="hljs-subst">{report_type}</span>/<span class="hljs-subst">{datetime.now():%Y-%m-%d}</span>/<span class="hljs-subst">{report_type}</span>_report_<span class="hljs-subst">{datetime.now():%Y%m%d_%H%M%S}</span>.md"</span>

  

client_config =  {<span class="hljs-string">'region_name'</span>:  S3_REGION,

<span class="hljs-string">'aws_access_key_id'</span>:  S3_ACCESS_KEY,  <span class="hljs-string">'aws_secret_access_key'</span>:  S3_SECRET_KEY}

<span class="hljs-keyword">if</span>  S3_ENDPOINT:

client_config[<span class="hljs-string">'endpoint_url'</span>]  =  S3_ENDPOINT

s3 = boto3.client(<span class="hljs-string">'s3'</span>,  **client_config)

  
  

<span class="hljs-keyword">try</span>:

s3.put_object(Bucket=S3_BUCKET,  Key=filename,  Body=report_content.encode(<span class="hljs-string">'utf-8'</span>),  ContentType=<span class="hljs-string">'text/markdown; charset=utf-8'</span>,

ContentEncoding=<span class="hljs-string">'utf-8'</span>,  Metadata={<span class="hljs-string">'report-type'</span>: report_type,  <span class="hljs-string">'upload-time'</span>: datetime.now().isoformat()})

<span class="hljs-comment"># 生成访问链接并打印</span>

s3_url =  <span class="hljs-string">f"<span class="hljs-subst">{S3_ENDPOINT  <span class="hljs-keyword">or</span>  <span class="hljs-string">f'https://<span class="hljs-subst">{S3_BUCKET}</span>.s3.<span class="hljs-subst">{S3_REGION}</span>.amazonaws.com'</span>}</span>/<span class="hljs-subst">{filename}</span>"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"上传成功:"</span>, s3_url)

<span class="hljs-keyword">except</span>  Exception  <span class="hljs-keyword">as</span> e:

<span class="hljs-built_in">print</span>(<span class="hljs-string">"上传失败:"</span>, e)

exit(<span class="hljs-number">1</span>)

</code></pre>
<h4 data-id="heading-14">模板示例（daily.md）</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f427851641924b7fae3b109e986ea7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=jpCDFlLf%2BngFgRxuVN4YnnMouDk%3D" alt="daily 模版示例" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15">4. 测试流程</h3>
<p>搭建完成后，我们可以通过两步测试验证 Skill 效果：</p>
<ol>
<li>输入内容，生成报告</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3903b2a7fd24a8eb99b2e4c67e9ce78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=xXaM9Te9tVJ%2Foqsy6gIXElagimc%3D" alt="生成报告" loading="lazy"/></p>
<ol start="2">
<li>上传报告</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1288cc30ec34d24a879c54e8b7e8ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=0UtagOLgezXWA%2FRw4FO7%2Fv90g50%3D" alt="上传报告" loading="lazy"/></p>
<h2 data-id="heading-16">六、Skills 与 MCP / Agent 的对比</h2>
<p>很多人会混淆 Skills、MCP 和 Agent，这里用一张表清晰区分三者的核心差异，避免用错场景：</p>
<p>| 对比维度 | Claude Skills | MCP | Agent |</p>
<p>|  ----  |  ---------------------  |  -----------  |  ------------------------------------  |</p>
<p>| 定义 | 可复用的业务能力模块 | 模型访问外部系统的协议 | 执行任务的智能体 |</p>
<p>| 目标 | 标准化流程、可复用 | 打通外部数据与操作 | 自主完成复杂任务 |</p>
<p>| 工作方式 | 被动触发 → 执行指令 → 使用模板/资源 | 请求-响应模式 | 理解任务 → 制定计划 → 调用 Tools/Skills → 调整策略 |</p>
<p>| 使用场景 | 重复性、结构化任务 | 外部数据访问、系统操作 | 复杂、多步骤任务或跨系统集成 |</p>
<p>总结一下：三者不是替代关系，而是互补关系——Agent 负责“统筹规划”，Skills 负责“具体执行”，MCP 负责“打通外部系统”，共同构成可扩展的智能自动化架构。</p>
<hr/>
<h2 data-id="heading-17">七、总结：Skills 的核心价值与适用场景</h2>
<p>Claude Skills 的核心价值，在于把“人的经验和执行逻辑”转化为可复用、标准化的 AI 能力模块，解决了传统 Prompt 不稳定、不可复用、不可组合的痛点。</p>
<p>如果你有以下使用场景，强烈建议尝试用 Skills 优化：</p>
<ul>
<li>
<p>需要反复做同类型的结构化任务（如写周报、整理会议纪要、格式化文档）；</p>
</li>
<li>
<p>需要将多个简单任务串联成自动化工作流，提升效率。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-18">八、参考资料</h2>
<p>官方文档
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
<p>API 调用指南
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fbuild-with-claude%2Fskills-guide" target="_blank" title="https://platform.claude.com/docs/en/build-with-claude/skills-guide" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/bui…</a></p>
<p>最佳实践
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code AI 对话技巧总结]]></title>    <link>https://juejin.cn/post/7597989474991783974</link>    <guid>https://juejin.cn/post/7597989474991783974</guid>    <pubDate>2026-01-22T09:16:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474991783974" data-draft-id="7597997108134314011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code AI 对话技巧总结"/> <meta itemprop="keywords" content="后端,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-22T09:16:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code AI 对话技巧总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:16:09.000Z" title="Thu Jan 22 2026 09:16:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Code AI 对话技巧总结</h2>
<blockquote>
<p>基于 141 个 session、1342 条对话历史整理(数据已脱敏）</p>
</blockquote>
<h3 data-id="heading-1">一、深度思考触发词</h3>
<h4 data-id="heading-2">1. ultrathink（最常用）</h4>
<p>触发 Claude 进行深度分析，适用于复杂问题。</p>
<pre><code class="hljs">分析一下是否有bug,特别是在高并发场景下 ultrathink
重新分析需求，这次描述是正确的 ultrathink
基于当前分支进行分析，给我分阶段提交方案 ultrathink
针对现有代码，写一下ut ultrathink
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>并发问题分析</li>
<li>复杂业务逻辑梳理</li>
<li>代码重构设计</li>
<li>需求拆分方案</li>
</ul>
<h4 data-id="heading-3">2. think harder</h4>
<p>比 ultrathink 更强调"再想想"，用于 Claude 第一次分析不到位时。</p>
<pre><code class="hljs">分析一下可能是哪个原因过滤了？think harder
找到基于浮动票价的票价规则代码 think harder
分析train_transfer 线程池的所有使用场景 think harder
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>对初次分析结果不满意</li>
<li>需要更深入挖掘</li>
<li>排查隐藏问题</li>
</ul>
<h4 data-id="heading-4">3. think / think again</h4>
<p>轻量级思考触发。</p>
<pre><code class="hljs language-bash" lang="bash">查看每个席别的价格和policyId think
think againg ultrathink  <span class="hljs-comment"># 组合使用</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">二、执行控制指令</h3>
<h4 data-id="heading-6">1. just do it（直接执行）</h4>
<p>跳过确认，让 Claude 直接动手。</p>
<pre><code class="hljs language-arduino" lang="arduino">ok, just <span class="hljs-keyword">do</span> it
渠道名为原渠道+<span class="hljs-string">'-NoBinding'</span>, just <span class="hljs-keyword">do</span> it
删除fail-fast，catchException just <span class="hljs-keyword">do</span> it
在concurrent包下的所有枚举类加上suppresswarning all just <span class="hljs-keyword">do</span> it
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>已确认方案，无需再讨论</li>
<li>批量修改任务</li>
<li>简单明确的操作</li>
</ul>
<h4 data-id="heading-7">2. go on / retry</h4>
<p>继续或重试操作。</p>
<pre><code class="hljs language-ruby" lang="ruby">go on          <span class="hljs-comment"># 继续上一步操作</span>
<span class="hljs-keyword">retry</span>          <span class="hljs-comment"># 重试上次失败的操作</span>
<span class="hljs-keyword">retry</span> again    <span class="hljs-comment"># 再次重试</span>
<span class="hljs-keyword">retry</span> last prompt  <span class="hljs-comment"># 重试上一个提示</span>
</code></pre>
<h4 data-id="heading-8">3. yes / y</h4>
<p>确认执行。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">yes</span>
y
1. <span class="hljs-built_in">yes</span> 2. 你帮我添加一下吧
</code></pre>
<hr/>
<h3 data-id="heading-9">三、常用 Slash 命令</h3>


















































<table><thead><tr><th>命令</th><th>用途</th><th>使用频率</th></tr></thead><tbody><tr><td><code>/clear</code></td><td>清空当前对话</td><td>⭐⭐⭐⭐⭐ (128次)</td></tr><tr><td><code>/exit</code></td><td>退出会话</td><td>⭐⭐⭐⭐ (54次)</td></tr><tr><td><code>/compact</code></td><td>压缩对话上下文</td><td>⭐⭐⭐⭐ (40次)</td></tr><tr><td><code>/resume</code></td><td>恢复上一个会话</td><td>⭐⭐⭐ (37次)</td></tr><tr><td><code>/mcp</code></td><td>MCP 工具管理</td><td>⭐⭐ (17次)</td></tr><tr><td><code>/init</code></td><td>初始化</td><td>⭐⭐ (8次)</td></tr><tr><td><code>/context</code></td><td>上下文管理</td><td>⭐ (3次)</td></tr><tr><td><code>/cost</code></td><td>查看消耗</td><td>⭐ (4次)</td></tr></tbody></table>
<h4 data-id="heading-10">compact 高级用法</h4>
<p>可以带描述进行压缩：</p>
<pre><code class="hljs language-bash" lang="bash">/compact 写了一篇博客 + 生成了可运行代码
/compact 总结你的方案（需求，实现方案）
/compact 总结一下之前的操作
/compact <span class="hljs-string">"如果有多个线程提交到一个全局的ConcurrencyLimitExecutorByLock..."</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">四、任务类型模板</h3>
<h4 data-id="heading-12">1. 代码分析类</h4>
<pre><code class="hljs language-arduino" lang="arduino">分析一下这个类的算法
分析一下调用链路，重点标识出订单被过滤原因
分析当前实现，找到对应代码，说明相关代码相关的业务
分析release提交和上周提交的对比，有哪些提交可能影响xxx
分析最近一周的提交，review一下代码
</code></pre>
<h4 data-id="heading-13">2. 需求分析类</h4>
<pre><code class="hljs">分析需求，确定代码位置
分析需求，找到对应代码，分析现有代码逻辑
分析历史需求实现，当前现状，盘点相关业务逻辑
重新分析需求：XXX这个类有核心内容。分析现有实现，核心代码，改动点，影响
</code></pre>
<h4 data-id="heading-14">3. Bug 排查类</h4>
<pre><code class="hljs">分析异常原因
分析编译失败原因
分析错误，不是这个提交影响的
这个问题12月12日开始出现的，分析git历史看看可能是哪些提交引起的
</code></pre>
<h4 data-id="heading-15">4. 文档输出类</h4>
<pre><code class="hljs language-bash" lang="bash">输出到md文件
输出到/notes文档，md
输出计划到/notes
很好，原封不动输出到md文档
整个分析过程输出到md文件
总结成文档，然后compact
</code></pre>
<h4 data-id="heading-16">5. 单元测试类</h4>
<pre><code class="hljs language-csharp" lang="csharp">写单元测试
补充一下unit tests
针对现有代码，写一下ut ultrathink
<span class="hljs-keyword">add</span> tests <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> branch, aim <span class="hljs-keyword">for</span> code coverage
给这个方法写单元测试，要求覆盖我提交的代码即可
</code></pre>
<h4 data-id="heading-17">6. 博客写作类</h4>
<pre><code class="hljs">写博客：源码解读 ConcurrentHashMap 弱一致性解读
写博客，类似Martin Fowler的重构这本书的行文逻辑
开头简要介绍主题和目标，结尾总结关键点. 目标是中高级开发者
</code></pre>
<hr/>
<h3 data-id="heading-18">五、高效对话模式</h3>
<h4 data-id="heading-19">1. 渐进式分析</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 首先分析下这个类
<span class="hljs-bullet">2.</span> 分析一下调用链路
<span class="hljs-bullet">3.</span> 详细分析下xxx
<span class="hljs-bullet">4.</span> 总结一下相关代码
</code></pre>
<h4 data-id="heading-20">2. 引导式纠正</h4>
<pre><code class="hljs">分析思路错了，应该查看提交历史
分析错误，本来票价规则就基于直连
不是AvailCheck请求，再分析一下
</code></pre>
<h4 data-id="heading-21">3. 结构化需求描述</h4>
<pre><code class="hljs">设计文档需要：背景、现状、目标、方案、评估
分析需求，确定代码位置，分析现有代码逻辑
</code></pre>
<h4 data-id="heading-22">4. 并行任务</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">use</span> <span class="hljs-number">2</span> subagents, 分别修改 TransferParallel, MultiRouteParallel调用点 ultrathink
我multi-clauding, 分析当前bugs、notes文件夹，总结整理成代办事项
</code></pre>
<hr/>
<h3 data-id="heading-23">六、上下文管理技巧</h3>
<h4 data-id="heading-24">1. 会话保存与恢复</h4>
<pre><code class="hljs language-bash" lang="bash">/resume              <span class="hljs-comment"># 恢复上一个会话</span>
/compact 总结xxx     <span class="hljs-comment"># 带描述压缩</span>
简单总结一下之前的操作，不要输出文档
</code></pre>
<h4 data-id="heading-25">2. 知识沉淀</h4>
<pre><code class="hljs language-perl" lang="perl">总结代码风格并更新到当前项目的上下文md中，给你自己使用
加入claude.md, 记住：修改的时候Test文件也要修改
设计文档需要更新到当前项目中。<span class="hljs-keyword">redo</span>。同时更新这个要求到claude.md中
</code></pre>
<h4 data-id="heading-26">3. 创建 Skills</h4>
<pre><code class="hljs language-csharp" lang="csharp">先做换乘业务的skills总结吧，包括核心业务流程、核心业务逻辑
总结刚才的查询流程，总结到skills，核心能力为查询页面操作流程
<span class="hljs-keyword">add</span> claude code skill: 写单元测试
</code></pre>
<hr/>
<h3 data-id="heading-27">七、最佳实践</h3>
<h4 data-id="heading-28">1. 复杂任务分解</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 好的做法</span>
分析当前实现 → 输出设计文档 → 执行计划 → 补充单元测试

<span class="hljs-comment"># 不好的做法</span>
一次性要求完成所有事情
</code></pre>
<h4 data-id="heading-29">2. 明确输出要求</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 好的做法</span>
输出到/notes下，格式为md
总结一下这个分支新增的配置
简单总结本次新增的特性，简单说明一下改动点的原理

<span class="hljs-comment"># 不好的做法</span>
分析一下（没有明确输出形式）
</code></pre>
<h4 data-id="heading-30">3. 引用具体代码/配置</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 好的做法</span>
<span class="hljs-title class_">ShowEntityHiddenConfigs</span>=*<span class="hljs-symbol">:*^TravelPackage</span>... 分析一下这个配置
分析下 <span class="hljs-variable">@TransferLimitEntity</span> 是如何实现禁售的
[jira-<span class="hljs-variable constant_">XXXX</span>-<span class="hljs-number">14794</span>]<span class="hljs-symbol">feat:</span> 票价规则算法 解释一下这个提交

<span class="hljs-comment"># 不好的做法</span>
分析一下那个配置
</code></pre>
<h4 data-id="heading-31">4. 使用 ultrathink 的时机</h4>





































<table><thead><tr><th>场景</th><th>是否使用 ultrathink</th></tr></thead><tbody><tr><td>简单代码查找</td><td>❌</td></tr><tr><td>并发/线程安全分析</td><td>✅</td></tr><tr><td>复杂业务逻辑梳理</td><td>✅</td></tr><tr><td>性能问题排查</td><td>✅</td></tr><tr><td>重构方案设计</td><td>✅</td></tr><tr><td>Bug 根因分析</td><td>✅</td></tr><tr><td>简单文档生成</td><td>❌</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-32">八、常用组合技巧</h3>
<h4 data-id="heading-33">技巧1：分析 + 深度思考 + 输出</h4>
<pre><code class="hljs">分析一下并发问题 ultrathink，输出到md文件
</code></pre>
<h4 data-id="heading-34">技巧2：执行 + 跳过确认</h4>
<pre><code class="hljs language-arduino" lang="arduino">删除这个方法中所有verify相关校验方法，just <span class="hljs-keyword">do</span> it
</code></pre>
<h4 data-id="heading-35">技巧3：多轮迭代</h4>
<pre><code class="hljs language-arduino" lang="arduino">第一轮：分析现有实现
第二轮：think harder（如果分析不到位）
第三轮：按照要求做好计划 ultrathink
第四轮：just <span class="hljs-keyword">do</span> it
</code></pre>
<h4 data-id="heading-36">技巧4：上下文复用</h4>
<pre><code class="hljs language-bash" lang="bash">/resume                     <span class="hljs-comment"># 恢复之前的上下文</span>
根据当前页面，retry         <span class="hljs-comment"># 复用之前的指令</span>
</code></pre>
<hr/>
<h3 data-id="heading-37">总结</h3>



































<table><thead><tr><th>技巧类型</th><th>关键词</th><th>使用场景</th></tr></thead><tbody><tr><td>深度思考</td><td>ultrathink, think harder</td><td>复杂问题分析</td></tr><tr><td>快速执行</td><td>just do it, yes</td><td>确认方案后执行</td></tr><tr><td>继续操作</td><td>go on, retry</td><td>延续或重试</td></tr><tr><td>上下文管理</td><td>/compact, /resume</td><td>长对话管理</td></tr><tr><td>输出控制</td><td>输出到md, 输出到/notes</td><td>结果持久化</td></tr></tbody></table>
<p><strong>核心原则：</strong></p>
<ol>
<li>复杂问题用 ultrathink</li>
<li>明确任务用 just do it</li>
<li>长对话定期 /compact</li>
<li>重要结论输出到文件</li>
<li>常用知识沉淀到 CLAUDE.md</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis SQL执行流程详解]]></title>    <link>https://juejin.cn/post/7597805826514714670</link>    <guid>https://juejin.cn/post/7597805826514714670</guid>    <pubDate>2026-01-22T09:08:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597805826514714670" data-draft-id="7597989474991751206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis SQL执行流程详解"/> <meta itemprop="keywords" content="MyBatis,Java"/> <meta itemprop="datePublished" content="2026-01-22T09:08:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis SQL执行流程详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:08:40.000Z" title="Thu Jan 22 2026 09:08:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文将以最常用的<code>select list</code>查询流程为核心，结合核心对象、代码实现与执行链路，全面拆解MyBatis SQL执行的完整过程。</p>
<h2 data-id="heading-0">一、select list流程</h2>
<h3 data-id="heading-1">1. 基本使用（编程式调用示例）</h3>
<p>以下代码展示了MyBatis编程式调用Mapper接口执行查询列表的完整示例，涵盖从环境配置、SqlSession创建到结果获取的全步骤，适用于理解底层执行逻辑。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 1. 获取数据源（模拟配置，实际可通过mybatis-config.xml配置）</span>
<span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> TestDataSourceFactory.getDataSource();
<span class="hljs-comment">// 2. 创建事务工厂（JDBC事务工厂，依赖JDBC原生事务管理）</span>
<span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTransactionFactory</span>();
<span class="hljs-comment">// 3. 构建环境对象（包含环境名称、事务工厂、数据源）</span>
<span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>(<span class="hljs-string">"dev"</span>, transactionFactory, dataSource);
<span class="hljs-comment">// 4. 初始化配置对象（MyBatis核心配置载体，存储所有配置信息）</span>
<span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(environment);
<span class="hljs-comment">// 5. 注册Mapper接口（告知MyBatis需要扫描的Mapper，绑定SQL映射）</span>
configuration.addMapper(TestMapper.class);
<span class="hljs-comment">// 6. 构建SqlSessionFactory（会话工厂，线程安全，全局单例）</span>
<span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(configuration);
<span class="hljs-comment">// 7. 打开SqlSession（会话对象，非线程安全，单次请求/事务独占）</span>
<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();
<span class="hljs-keyword">try</span> { 
  <span class="hljs-comment">// 8. 获取Mapper代理对象（MyBatis动态生成，非真实Mapper实现类）</span>
  <span class="hljs-type">TestMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(TestMapper.class);
  <span class="hljs-comment">// 9. 调用Mapper方法执行查询（触发底层SQL执行流程）</span>
  List&lt;Entity&gt; entitys = mapper.selectList(<span class="hljs-number">101</span>);
} <span class="hljs-keyword">finally</span> {
  <span class="hljs-comment">// 10. 关闭SqlSession（释放资源，避免连接泄漏）</span>
  session.close();
}
</code></pre>
<h3 data-id="heading-2">2. 代码执行流程（完整链路拆解）</h3>
<p>上述代码中，<code>mapper.selectList(101)</code>是触发SQL执行的入口，底层通过多组件协作完成查询，具体流程可通过以下流程图及步骤解析理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TD
A(获取mapper代理对象Configuration.getMapper) --&gt; B(调用代理对象方法MapperMethod.execute)
B --&gt; C(查询SqlSession.selectList)
C --&gt; D(查询Executor.query)
D --&gt; E(获取StatementHandlerConfiguration.newStatementHandler)
E --&gt; F(调用插件返回StatementHandler代理interceptorChain.pluginAll)
F --&gt; G(设置参数ParameterHandler.setParameters)
G --&gt; H(执行sqlStatementHandler.query)
H --&gt; I(处理结果ResultSetHandler.handleResultSets)
    
</code></pre>
<h4 data-id="heading-3">流程步骤详细解析：</h4>
<ol>
<li><strong>获取Mapper代理对象</strong>：调用<code>Configuration.getMapper</code>时，MyBatis通过<code>MapperRegistry</code>扫描已注册的Mapper接口，利用JDK动态代理生成代理对象，代理对象会拦截所有Mapper方法调用，将请求转发至<code>MapperMethod</code>。</li>
<li><strong>方法执行分发</strong>：<code>MapperMethod.execute</code>作为核心分发方法，会先解析当前SQL的类型（SELECT/INSERT/UPDATE/DELETE），再根据类型调用<code>SqlSession</code>对应的方法（如查询调用<code>selectList</code>），同时处理参数映射（将方法参数转换为SQL可用参数）。</li>
<li><strong>SqlSession层转发</strong>：<code>SqlSession</code>作为应用与MyBatis底层的桥梁，不直接执行SQL，而是将请求委托给<code>Executor</code>（执行器），同时维护事务状态。</li>
<li><strong>Executor执行调度</strong>：<code>Executor</code>是SQL执行的核心调度器，负责事务控制、缓存管理及SQL执行协调。调用<code>Executor.query</code>时，会先检查一级缓存，缓存未命中则继续向下执行，同时创建<code>Transaction</code>对象管理事务。</li>
<li><strong>创建StatementHandler</strong>：通过<code>Configuration.newStatementHandler</code>创建<code>StatementHandler</code>，该组件是JDBC <code>Statement</code>的封装者，负责Statement的创建、参数设置、SQL执行及结果处理的统筹。</li>
<li><strong>插件拦截增强</strong>：<code>interceptorChain.pluginAll</code>会遍历所有注册的拦截器，对<code>StatementHandler</code>进行代理增强（如分页插件、数据脱敏插件可在此处拦截，修改SQL或处理参数/结果），这是MyBatis扩展的核心入口。</li>
<li><strong>参数设置</strong>：通过<code>ParameterHandler</code>（参数处理器）将Mapper方法参数绑定到JDBC <code>PreparedStatement</code>的占位符上，支持多种参数类型（基本类型、对象、集合）及参数映射规则（如<code>@Param</code>注解、对象属性映射）。</li>
<li><strong>SQL执行</strong>：<code>StatementHandler.query</code>调用JDBC <code>Statement</code>的<code>executeQuery</code>方法执行SQL，获取数据库返回的<code>ResultSet</code>。</li>
<li><strong>结果处理</strong>：<code>ResultSetHandler</code>（结果处理器）将<code>ResultSet</code>数据映射为Java对象（支持简单类型、复杂对象、集合、嵌套结果集等），最终返回给上层调用者。</li>
</ol>
<h2 data-id="heading-4">二、核心对象关系及作用详解</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cfe9349a69648f3b2b0d0267d1ece5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey54Wu5YWJ6Zi0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769677720&amp;x-signature=MET7l1M0UspV0vKIXPpjLS12u4Y%3D" alt="" loading="lazy"/></p>
<p>MyBatis SQL执行流程依赖多个核心对象的协作，各对象职责清晰、相互依赖，构成MyBatis的核心架构，以下结合对象功能、实现类及关系展开说明：</p>
<h3 data-id="heading-5">1. Configuration（全局配置中心）</h3>
<p>MyBatis的“大脑”，存储所有配置信息（全局配置、Mapper映射、插件、类型别名等），同时作为所有核心对象（Executor、StatementHandler、ParameterHandler等）的工厂，负责对象的创建与初始化，贯穿SQL执行全流程。</p>
<h3 data-id="heading-6">2. Executor（执行器，SQL执行调度核心）</h3>
<p>负责SQL执行的统筹调度，同时处理事务控制、一级缓存管理，其实现类对应不同的执行策略，可通过配置指定默认执行器类型：</p>
<ul>
<li><strong>SimpleExecutor（默认执行器）</strong>：简单执行策略，无任何优化，每执行一条SQL都会新建一个Statement对象，执行完成后关闭，适用于大多数简单场景。</li>
<li><strong>ReuseExecutor（复用执行器）</strong>：对相同SQL（SQL语句+参数配置一致）的Statement进行复用，避免频繁创建/关闭Statement，提升性能，适用于重复执行相同SQL的场景。</li>
<li><strong>BatchExecutor（批处理执行器）</strong>：实现SQL批处理功能，将多条INSERT/UPDATE/DELETE语句批量提交，减少数据库交互次数，大幅提升批处理效率，仅适用于批处理场景。</li>
<li><strong>CachingExecutor（缓存执行器）</strong>：若开启二级缓存，MyBatis会自动为上述执行器包装一层CachingExecutor，负责二级缓存的管理与查询，优先从二级缓存获取数据。</li>
</ul>
<h3 data-id="heading-7">3. StatementHandler（Statement封装者）</h3>
<p>直接与JDBC Statement交互，负责Statement的创建、参数设置、SQL执行及结果回调，是MyBatis封装JDBC操作的核心组件，默认实现类对应不同的Statement类型：</p>
<ul>
<li><strong>SimpleStatementHandler</strong>：处理普通Statement（无占位符的SQL），不支持参数绑定，适用于静态SQL场景。</li>
<li><strong>PreparedStatementHandler（默认实现）</strong>：处理PreparedStatement（带占位符的SQL），支持参数绑定、SQL预编译，可防止SQL注入，适用于大多数动态SQL场景。</li>
<li><strong>CallableStatementHandler</strong>：处理CallableStatement，用于执行数据库存储过程，支持输入/输出参数映射。</li>
</ul>
<p>补充：<code>RoutingStatementHandler</code>并非直接实现类，而是一个路由处理器，会根据SQL类型自动选择对应的StatementHandler实现类。</p>
<h3 data-id="heading-8">4. SqlSession（会话对象）</h3>
<p>应用程序与MyBatis底层交互的入口，封装了Executor、事务等核心组件，提供增删改查方法及事务控制（提交/回滚）。默认实现为<code>DefaultSqlSession</code>，<strong>非线程安全</strong>，需保证单次请求/事务对应一个SqlSession，使用后及时关闭。</p>
<h3 data-id="heading-9">5. InterceptorChain（拦截器链）</h3>
<p>MyBatis的扩展机制核心，管理所有注册的拦截器（Interceptor），在核心对象创建时（如Executor、StatementHandler），通过<code>pluginAll</code>方法为对象生成代理，允许开发者在SQL执行的关键节点（参数设置、SQL执行、结果处理）插入自定义逻辑，常见应用场景包括自动分页、数据脱敏、日志打印、分库分表等。</p>
<h3 data-id="heading-10">6. 其他辅助组件</h3>
<ul>
<li><strong>ParameterHandler</strong>：参数处理器，负责将Mapper方法参数绑定到Statement占位符，支持类型转换（如Java类型与数据库类型映射）。</li>
<li><strong>ResultSetHandler</strong>：结果处理器，负责将ResultSet转换为Java对象，支持复杂结果映射（如一对一、一对多嵌套映射）。</li>
<li><strong>MetaObject</strong>：元对象工具，用于操作Java对象的属性（即使属性为private），支撑参数绑定与结果映射的底层反射操作。</li>
</ul>
<h2 data-id="heading-11">三、核心代码逻辑简述</h2>
<p>以下通过核心类的关键代码，进一步理解MyBatis对象创建与SQL执行的底层逻辑，重点解析Configuration（对象工厂）与MapperMethod（方法分发）的核心实现。</p>
<h3 data-id="heading-12">1. org.apache.ibatis.session.Configuration（核心对象工厂）</h3>
<p>该类不仅存储配置，更通过一系列<code>newXXX</code>方法创建核心对象，同时集成拦截器链，为对象提供增强能力，关键代码解析如下：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> {
   <span class="hljs-comment">/**
    * 获取Mapper代理对象
    * 核心逻辑：委托MapperRegistry创建代理，将SqlSession传入代理，便于后续调用
    */</span>
   <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> {
	    <span class="hljs-keyword">return</span> mapperRegistry.getMapper(type, sqlSession);
	}

	<span class="hljs-comment">/**
	 * 创建元对象，用于反射操作对象属性
	 * 支撑ParameterHandler、ResultSetHandler的底层属性访问
	 */</span>
	<span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">newMetaObject</span><span class="hljs-params">(Object object)</span> {
	    <span class="hljs-keyword">return</span> MetaObject.forObject(object, objectFactory, objectWrapperFactory);
	}

	<span class="hljs-comment">/**
	 * 创建ParameterHandler（参数处理器）
	 * 先通过语言驱动创建默认实现，再通过拦截器链增强
	 */</span>
	<span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">newParameterHandler</span><span class="hljs-params">(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql)</span> {
	    <span class="hljs-type">ParameterHandler</span> <span class="hljs-variable">parameterHandler</span> <span class="hljs-operator">=</span> mappedStatement.getLang().createParameterHandler(mappedStatement, parameterObject, boundSql);
        <span class="hljs-comment">// 拦截器增强：允许插件修改参数处理逻辑</span>
	    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler);
	    <span class="hljs-keyword">return</span> parameterHandler;
	}

	<span class="hljs-comment">/**
	 * 创建ResultSetHandler（结果处理器）
	 * 实例化默认实现DefaultResultSetHandler，再通过拦截器链增强
	 */</span>
	<span class="hljs-keyword">public</span> ResultSetHandler <span class="hljs-title function_">newResultSetHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, RowBounds rowBounds, ParameterHandler parameterHandler,
	      ResultHandler resultHandler, BoundSql boundSql)</span> {
	    <span class="hljs-type">ResultSetHandler</span> <span class="hljs-variable">resultSetHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultSetHandler</span>(executor, mappedStatement, parameterHandler, resultHandler, boundSql, rowBounds);
        <span class="hljs-comment">// 拦截器增强：允许插件修改结果处理逻辑（如数据脱敏）</span>
	    resultSetHandler = (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);
	    <span class="hljs-keyword">return</span> resultSetHandler;
	}

	<span class="hljs-comment">/**
	 * 创建StatementHandler（Statement封装者）
	 * 实例化路由处理器RoutingStatementHandler，再通过拦截器链增强
	 */</span>
	<span class="hljs-keyword">public</span> StatementHandler <span class="hljs-title function_">newStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> {
	    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">statementHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoutingStatementHandler</span>(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);
        <span class="hljs-comment">// 拦截器增强：允许插件修改SQL执行逻辑（如分页插件）</span>
	    statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);
	    <span class="hljs-keyword">return</span> statementHandler;
	}

	<span class="hljs-comment">/**
	 * 创建Executor（执行器）
	 * 根据执行器类型实例化对应实现，开启缓存则包装为CachingExecutor，最后通过拦截器增强
	 */</span>
	<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction)</span> {
	    <span class="hljs-keyword">return</span> newExecutor(transaction, defaultExecutorType);
	}

	<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> {
	    executorType = executorType == <span class="hljs-literal">null</span> ? defaultExecutorType : executorType;
	    executorType = executorType == <span class="hljs-literal">null</span> ? ExecutorType.SIMPLE : executorType;
	    Executor executor;
	    <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) {
	      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
	    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) {
	      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReuseExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
	    } <span class="hljs-keyword">else</span> {
	      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
	    }
	    <span class="hljs-comment">// 若开启二级缓存，包装为CachingExecutor</span>
	    <span class="hljs-keyword">if</span> (cacheEnabled) {
	      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);
	    }
        <span class="hljs-comment">// 拦截器增强：允许插件修改执行器逻辑（如事务增强、缓存扩展）</span>
	    executor = (Executor) interceptorChain.pluginAll(executor);
	    <span class="hljs-keyword">return</span> executor;
	}
}
</code></pre>
<h3 data-id="heading-13">2. org.apache.ibatis.binding.MapperMethod（方法执行分发器）</h3>
<p>该类负责解析Mapper方法的SQL类型、参数信息，将方法调用分发至SqlSession对应的方法，是Mapper代理对象与SqlSession之间的桥梁，核心<code>execute</code>方法逻辑如下（补充完整核心逻辑）：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperMethod</span> {
  <span class="hljs-comment">// 存储SQL命令信息（类型、语句ID等）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlCommand command;
  <span class="hljs-comment">// 存储方法签名信息（返回值类型、参数类型等）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MethodSignature method;

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperMethod</span><span class="hljs-params">(Class&lt;?&gt; mapperInterface, Method method, Configuration config)</span> {
    <span class="hljs-built_in">this</span>.command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlCommand</span>(config, mapperInterface, method);
    <span class="hljs-built_in">this</span>.method = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodSignature</span>(config, mapperInterface, method);
  }

  <span class="hljs-comment">// 核心方法：处理增删改查方法执行，分发至SqlSession</span>
  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> {
    Object result;
    <span class="hljs-comment">// 根据SQL命令类型分发执行</span>
    <span class="hljs-keyword">switch</span> (command.getType()) {
      <span class="hljs-keyword">case</span> INSERT: {
        <span class="hljs-comment">// 处理参数映射，将args转换为SQL参数</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
        <span class="hljs-comment">// 调用SqlSession.insert，返回影响行数</span>
        result = rowCountResult(sqlSession.insert(command.getName(), param));
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">case</span> UPDATE: {
        <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
        result = rowCountResult(sqlSession.update(command.getName(), param));
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">case</span> DELETE: {
        <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
        result = rowCountResult(sqlSession.delete(command.getName(), param));
        <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">case</span> SELECT:
        <span class="hljs-comment">// 无返回值且有ResultHandler参数（回调处理结果）</span>
        <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) {
          executeWithResultHandler(sqlSession, args);
          result = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// 返回列表/数组</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) {
          result = executeForMany(sqlSession, args);
        }
        <span class="hljs-comment">// 返回Map</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) {
          result = executeForMap(sqlSession, args);
        }
        <span class="hljs-comment">// 返回Cursor（游标，适用于大量数据流式查询）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsCursor()) {
          result = executeForCursor(sqlSession, args);
        }
        <span class="hljs-comment">// 返回单个对象</span>
        <span class="hljs-keyword">else</span> {
          <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
          result = sqlSession.selectOne(command.getName(), param);
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> FLUSH:
        result = sqlSession.flushStatements();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">"Unknown execution method for: "</span> + command.getName());
    }
    <span class="hljs-comment">// 处理返回值为null且方法返回类型为基本类型的情况（抛出异常）</span>
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">"Mapper method '"</span> + command.getName() 
          + <span class="hljs-string">" attempted to return null from a method with a primitive return type ("</span> + method.getReturnType() + <span class="hljs-string">")."</span>);
    }
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 执行查询列表逻辑</span>
  <span class="hljs-keyword">private</span> &lt;E&gt; Object <span class="hljs-title function_">executeForMany</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> {
    List&lt;E&gt; result;
    <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
    <span class="hljs-comment">// 若方法有RowBounds参数（分页参数），调用带分页的selectList</span>
    <span class="hljs-keyword">if</span> (method.hasRowBounds()) {
      <span class="hljs-type">RowBounds</span> <span class="hljs-variable">rowBounds</span> <span class="hljs-operator">=</span> method.extractRowBounds(args);
      result = sqlSession.selectList(command.getName(), param, rowBounds);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 无分页，调用普通selectList</span>
      result = sqlSession.selectList(command.getName(), param);
    }
    <span class="hljs-comment">// 若返回值需要转换为数组，进行类型转换</span>
    <span class="hljs-keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) {
      <span class="hljs-keyword">return</span> method.convertResultToList(result);
    }
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 其他辅助方法（executeWithResultHandler、executeForMap等）省略...</span>

  <span class="hljs-comment">// 处理影响行数返回结果（适配boolean/int等返回类型）</span>
  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">rowCountResult</span><span class="hljs-params">(<span class="hljs-type">int</span> rowCount)</span> {
    <span class="hljs-keyword">final</span> Object result;
    <span class="hljs-keyword">if</span> (method.returnsVoid()) {
      result = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.class.equals(method.getReturnType()) || Integer.TYPE.equals(method.getReturnType())) {
      result = rowCount;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Long.class.equals(method.getReturnType()) || Long.TYPE.equals(method.getReturnType())) {
      result = (<span class="hljs-type">long</span>) rowCount;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Boolean.class.equals(method.getReturnType()) || Boolean.TYPE.equals(method.getReturnType())) {
      result = rowCount &gt; <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">"Mapper method '"</span> + command.getName() + <span class="hljs-string">"' has an unsupported return type: "</span> + method.getReturnType());
    }
    <span class="hljs-keyword">return</span> result;
  }
}
</code></pre>
<h2 data-id="heading-14">四、总结</h2>
<p>MyBatis SQL执行流程本质是“分层协作+接口抽象”的设计模式：通过Configuration统一管理配置与对象创建，SqlSession提供上层入口，Executor调度核心流程，StatementHandler封装JDBC操作，配合ParameterHandler、ResultSetHandler完成参数与结果的映射，最终通过拦截器链提供灵活扩展能力。</p>
<p>理解这一流程，既能帮助开发者快速定位SQL执行过程中的问题（如参数绑定错误、结果映射异常、插件拦截失效等），也能为自定义扩展（如开发插件、优化执行逻辑）提供底层支撑，真正掌握MyBatis的核心原理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[快速上手：LangChain + AgentRun 浏览器沙箱极简集成指南]]></title>    <link>https://juejin.cn/post/7597968460652707882</link>    <guid>https://juejin.cn/post/7597968460652707882</guid>    <pubDate>2026-01-22T09:21:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597968460652707882" data-draft-id="7598005428258144319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="快速上手：LangChain + AgentRun 浏览器沙箱极简集成指南"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T09:21:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            快速上手：LangChain + AgentRun 浏览器沙箱极简集成指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:21:58.000Z" title="Thu Jan 22 2026 09:21:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：辰泉</p>
<h2 data-id="heading-0">前言</h2>
<p>在 Agentic AI 时代，智能体需要与真实世界交互，而浏览器是连接虚拟世界与现实世界的重要桥梁。AgentRun Browser Sandbox 为智能体提供了安全、高性能、免运维的浏览器执行环境，让 AI Agent 真正具备“上网”的能力——从网页抓取、信息提取到表单填写、自动化操作，一切皆可实现。</p>
<h2 data-id="heading-1">AgentRun Browser Sandbox 介绍</h2>
<h3 data-id="heading-2">什么是 Browser Sandbox?</h3>
<p>Browser Sandbox 是 AgentRun 平台提供的云原生无头浏览器沙箱服务，基于阿里云函数计算（FC）构建。它为智能体提供了一个安全隔离的浏览器执行环境，支持通过标准的 Chrome DevTools Protocol (CDP) 远程控制浏览器实例。</p>
<h3 data-id="heading-3">核心特性</h3>
<p><strong>无头浏览器能力</strong></p>
<ul>
<li>内置 Chromium/Chrome 浏览器，支持完整的 Web 标准</li>
<li>原生兼容 Puppeteer、Playwright 等主流自动化框架</li>
<li>支持通过 CDP 协议进行精细化控制</li>
</ul>
<p><strong>实时可视化</strong></p>
<ul>
<li>内置 VNC 服务，支持实时查看浏览器界面</li>
<li>提供操作录制功能，方便调试和回放</li>
<li>支持通过 noVNC 客户端在网页中直接交互</li>
</ul>
<p><strong>安全与隔离</strong></p>
<ul>
<li>每个沙箱实例运行在独立的容器环境中</li>
<li>文件系统和进程空间完全隔离</li>
<li>支持 WSS 加密传输，确保数据安全</li>
</ul>
<p><strong>Serverless 架构</strong></p>
<ul>
<li>按需创建，按量付费，无需提前预置资源</li>
<li>快速弹性伸缩，支持高并发场景</li>
<li>零运维，无需管理服务器和浏览器依赖</li>
</ul>
<h3 data-id="heading-4">主要应用场景</h3>
<ul>
<li><strong>AI Agent 赋能：</strong> 为大模型提供“眼睛”和“手”，执行网页浏览、信息提取、在线操作等任务</li>
<li><strong>自动化测试：</strong> 在云端运行端到端（E2E）测试和视觉回归测试</li>
<li><strong>数据采集：</strong> 稳定、高效地进行网页抓取，应对动态加载和反爬虫挑战</li>
<li><strong>内容生成：</strong> 自动化生成网页截图或 PDF 文档</li>
</ul>
<h2 data-id="heading-5">上手使用 AgentRun Browser Sandbox</h2>
<h3 data-id="heading-6">AgentRun SDK 快速介绍</h3>
<p><em>后续的内容将基于 AgentRun SDK 进行，因此我们先对 SDK 进行简要介绍。</em></p>
<p>Agentrun SDK 是一个开源的开发者工具包，本期介绍 Python 版本。其旨在简化智能体与 AgentRun 平台各种服务（包括 Browser Sandbox）的集成。它提供了统一的接口，让您可以用几行代码就将沙箱能力集成到现有的 Agent 框架中。SDK 的核心功能如下：</p>
<p><strong>统一集成接口</strong></p>
<ul>
<li>提供对 LangChain、AgentScope 等主流框架的开箱即用支持</li>
<li>统一的模型代理接口，简化多模型管理</li>
<li>标准化的工具注册机制</li>
</ul>
<p><strong>Sandbox 生命周期管理</strong></p>
<ul>
<li>自动创建和销毁沙箱实例</li>
<li>支持会话级别的状态保持</li>
<li>灵活的资源配置和超时控制</li>
</ul>
<h4 data-id="heading-7">安装 AgentRun SDK</h4>
<pre><code class="hljs language-css" lang="css">pip install agentrun-sdk<span class="hljs-selector-attr">[playwright,server]</span>
</code></pre>
<p><em><strong>注意：</strong> 确保您的 Python 环境版本在 3.10 及以上。</em></p>
<h4 data-id="heading-8">基本使用示例</h4>
<p>以下是使用 AgentRun SDK 创建和管理 Browser Sandbox 的核心代码：</p>
<pre><code class="hljs language-ini" lang="ini">from agentrun.sandbox import Sandbox, TemplateType
from playwright.sync_api import sync_playwright
<span class="hljs-comment"># 创建 Browser Sandbox</span>
<span class="hljs-attr">sandbox</span> = Sandbox.create(
    <span class="hljs-attr">template_type</span>=TemplateType.BROWSER,
    <span class="hljs-attr">template_name</span>=<span class="hljs-string">"your-template-name"</span>,
    <span class="hljs-attr">sandbox_idle_timeout_seconds</span>=<span class="hljs-number">300</span>
)
<span class="hljs-comment"># 获取 CDP URL（用于 Playwright 连接）</span>
<span class="hljs-attr">cdp_url</span> = sandbox.get_cdp_url()
<span class="hljs-comment"># 使用 Playwright 连接并操作</span>
with sync_playwright() as p:
    <span class="hljs-attr">browser</span> = p.chromium.connect_over_cdp(cdp_url)
    <span class="hljs-attr">page</span> = browser.contexts[<span class="hljs-number">0</span>].pages[<span class="hljs-number">0</span>]
    page.goto("https://www.example.com")
    page.screenshot(<span class="hljs-attr">path</span>=<span class="hljs-string">"screenshot.png"</span>)
    browser.close()
<span class="hljs-comment"># 销毁 Sandbox</span>
sandbox.delete()
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><strong>template_name：</strong> 控制台创建的浏览器环境模板</li>
<li><strong>cdp_url：</strong> 用于 Playwright/Puppeteer 连接</li>
<li><strong>vnc_url：</strong> 用于实时查看浏览器画面（可通过 sandbox.get_cdp_url() 获取）</li>
</ul>
<p><em><strong>注意：</strong> 由于所有浏览器操作都在云端进行，您无需在本地安装浏览器。Playwright 仅用于通过 CDP 协议连接到云端的浏览器实例。</em></p>
<h3 data-id="heading-9">如何创建 Sandbox 模板</h3>
<p>使用 Browser Sandbox 需要新建 Sandbox 模板，您需要访问 AgentRun 控制台网站 <strong>[</strong> <strong>1]</strong> ，并按照如下步骤创建模板：</p>
<ol>
<li>在顶部菜单栏选择“运行时与沙箱”；</li>
<li>在左侧边栏选择“Sandbox 沙箱”；</li>
<li>点击右上角“创建沙箱模板”；</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c71a151b7f2d4286b4105f9c7b4edb3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=0iSPYg39q1%2B5dlmeC3vj84A7nEY%3D" alt="图片" loading="lazy"/></p>
<ol start="4">
<li>选择“浏览器”；</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/830a2d64975d4afc841bbe3eab0ce324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=Z2fYumBi0gZZOljYcetReJ7EtnM%3D" alt="图片" loading="lazy"/></p>
<ol start="5">
<li>在弹出的抽屉对话框中填写和选择您的模板的规格、网络等配置，并复制模板名称；</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68af0735e11844ed96bbc84e905e1fbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=OBku4zG%2Bbj2f9XFXOjwTRYUJvdA%3D" alt="图片" loading="lazy"/></p>
<ol start="6">
<li>点击“创建浏览器”等待其就绪即可。</li>
</ol>
<h3 data-id="heading-10">从零开始用 LangChain 创建 Browser Sandbox 智能体</h3>
<p>本教程将指导您从零开始创建一个完整的 Browser Sandbox 智能体项目。</p>
<h4 data-id="heading-11">基于 LangChain 集成 Browser Sandbox</h4>
<p>本教程将详细讲解如何使用 LangChain 创建 Browser Sandbox 相关的 Tools 并集成到 Agent 中。</p>
<p><strong>项目结构</strong></p>
<p>为了保持代码的内聚性和可维护性，我们将代码拆分为以下模块：</p>
<p>模块职责划分：</p>
<p><code>sandbox_manager.py</code>：负责 Sandbox 的创建、管理和销毁，提供统一的接口<br/>
<code>langchain_agent.py</code>：负责创建 LangChain Tools 和 Agent，集成 VNC 信息
<code>main.py</code>：作为入口文件，演示如何使用上述模块</p>
<p><strong>步骤 1：创建项目并安装依赖</strong></p>
<p>首先创建项目目录（如果还没有）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p langchain-demo
<span class="hljs-built_in">cd</span> langchain-demo
</code></pre>
<p>创建 requirements.txt 文件，内容如下：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">LangChain 核心库</span>
<span class="hljs-meta prompt_">langchain&gt;</span><span class="bash">=0.1.0</span>
<span class="hljs-meta prompt_">langchain-openai&gt;</span><span class="bash">=0.0.5</span>
<span class="hljs-meta prompt_">langchain-community&gt;</span><span class="bash">=0.0.20</span>
<span class="hljs-meta prompt_"># </span><span class="bash">AgentRun SDK</span>
agentrun-sdk[playwright,server]&gt;=0.0.8
<span class="hljs-meta prompt_"># </span><span class="bash">浏览器自动化</span>
<span class="hljs-meta prompt_">playwright&gt;</span><span class="bash">=1.40.0</span>
<span class="hljs-meta prompt_"># </span><span class="bash">环境变量管理</span>
<span class="hljs-meta prompt_">python-dotenv&gt;</span><span class="bash">=1.0.0</span>
</code></pre>
<p>然后安装依赖：</p>
<pre><code class="hljs">pip install -r requirements.txt
</code></pre>
<p>主要依赖说明：</p>
<ul>
<li><code>langchain</code> 和 <code>langchain-openai</code>：LangChain 核心库</li>
<li><code>agentrun-sdk[playwright,server]</code>：AgentRun SDK，用于 Sandbox 管理</li>
<li><code>playwright</code>：浏览器自动化库</li>
<li><code>python-dotenv</code>：环境变量管理</li>
</ul>
<p><strong>步骤 2：配置环境变量</strong></p>
<p>在项目根目录创建 <code>.env</code> 文件，配置以下环境变量：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 阿里云百炼平台的 API Key，用于调用大模型能力</span>
<span class="hljs-comment"># 请前往 https://bailian.console.aliyun.com/?tab=app#/api-key 创建和查看</span>
<span class="hljs-attr">DASHSCOPE_API_KEY</span>=sk-your-bailian-api-key
<span class="hljs-comment"># 阿里云账号的访问密钥 ID 和访问密钥 Secret，用于 AgentRun SDK 鉴权</span>
<span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=your-ak
<span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=your-sk
<span class="hljs-attr">ALIBABA_CLOUD_ACCOUNT_ID</span>=your-main-account-id
<span class="hljs-attr">ALIBABA_CLOUD_REGION</span>=cn-hangzhou
<span class="hljs-comment"># browser sandbox 模板的名称，可以在 https://functionai.console.aliyun.com/cn-hangzhou/agent/runtime/sandbox 控制台创建</span>
<span class="hljs-attr">BROWSER_TEMPLATE_NAME</span>=sandbox-your-template-name
<span class="hljs-comment"># agentrun 的控制面和数据面的 API 端点请求地址，默认cn-hangzhou</span>
<span class="hljs-attr">AGENTRUN_CONTROL_ENDPOINT</span>=agentrun.cn-hangzhou.aliyuncs.com
<span class="hljs-attr">AGENTRUN_DATA_ENDPOINT</span>=https://<span class="hljs-variable">${your-main-account-id}</span>.agentrun-data.cn-hangzhou.aliyuncs.com
</code></pre>
<p><strong>步骤 3：创建 Sandbox 生命周期管理模块</strong></p>
<p>创建 sandbox_manager.py 文件，负责 Sandbox 的创建、管理和销毁。核心代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
Sandbox 生命周期管理模块
负责 AgentRun Browser Sandbox 的创建、管理和销毁。
提供统一的接口供 LangChain Agent 使用。
"""</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SandboxManager</span>:
    <span class="hljs-string">"""Sandbox 生命周期管理器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self._sandbox: <span class="hljs-type">Optional</span>[<span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span>
        self._sandbox_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
        self._cdp_url: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
        self._vnc_url: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">
        self,
        template_name: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        idle_timeout: <span class="hljs-built_in">int</span> = <span class="hljs-number">3000</span>
    </span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""
        创建或获取一个浏览器 sandbox 实例
        Args:
            template_name: Sandbox 模板名称，如果为 None 则从环境变量读取
            idle_timeout: 空闲超时时间（秒），默认 3000 秒
        Returns:
            dict: 包含 sandbox_id, cdp_url, vnc_url 的字典
        Raises:
            RuntimeError: 创建失败时抛出异常
        """</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">from</span> agentrun.sandbox <span class="hljs-keyword">import</span> Sandbox, TemplateType
            <span class="hljs-comment"># 如果已有 sandbox，直接返回</span>
            <span class="hljs-keyword">if</span> self._sandbox <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">return</span> self.get_info()
            <span class="hljs-comment"># 从环境变量获取模板名称</span>
            <span class="hljs-keyword">if</span> template_name <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                template_name = os.getenv(
                    <span class="hljs-string">"BROWSER_TEMPLATE_NAME"</span>,
                    <span class="hljs-string">"sandbox-browser-demo"</span>
                )
            <span class="hljs-comment"># 创建 sandbox</span>
            self._sandbox = Sandbox.create(
                template_type=TemplateType.BROWSER,
                template_name=template_name,
                sandbox_idle_timeout_seconds=idle_timeout
            )
            self._sandbox_id = self._sandbox.sandbox_id
            self._cdp_url = self._get_cdp_url()
            self._vnc_url = self._get_vnc_url()
            <span class="hljs-keyword">return</span> self.get_info()
        <span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(e)
            <span class="hljs-keyword">raise</span> RuntimeError(
                <span class="hljs-string">"agentrun-sdk 未安装，请运行: pip install agentrun-sdk[playwright,server]"</span>
            )
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"创建 Sandbox 失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_info</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""
        获取当前 sandbox 的信息
        Returns:
            dict: 包含 sandbox_id, cdp_url, vnc_url 的字典
        Raises:
            RuntimeError: 如果没有活动的 sandbox
        """</span>
        <span class="hljs-keyword">if</span> self._sandbox <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"没有活动的 sandbox，请先创建"</span>)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"sandbox_id"</span>: self._sandbox_id,
            <span class="hljs-string">"cdp_url"</span>: self._cdp_url,
            <span class="hljs-string">"vnc_url"</span>: self._vnc_url,
        }
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_cdp_url</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取 CDP URL"""</span>
        <span class="hljs-keyword">return</span> self._sandbox.get_cdp_url()
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_vnc_url</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取 VNC URL"""</span>
        <span class="hljs-keyword">return</span> self._sandbox.get_vnc_url()
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sandbox_id</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取 Sandbox ID"""</span>
        <span class="hljs-keyword">return</span> self._sandbox_id
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">destroy</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        销毁当前的 sandbox 实例
        Returns:
            str: 操作结果描述
        """</span>
        <span class="hljs-keyword">if</span> self._sandbox <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"没有活动的 sandbox"</span>
        <span class="hljs-keyword">try</span>:
            sandbox_id = self._sandbox_id
            <span class="hljs-comment"># 尝试销毁 sandbox</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self._sandbox, <span class="hljs-string">'delete'</span>):
                self._sandbox.delete()
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(self._sandbox, <span class="hljs-string">'stop'</span>):
                self._sandbox.stop()
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(self._sandbox, <span class="hljs-string">'destroy'</span>):
                self._sandbox.destroy()
            <span class="hljs-comment"># 清理状态</span>
            self._sandbox = <span class="hljs-literal">None</span>
            self._sandbox_id = <span class="hljs-literal">None</span>
            self._cdp_url = <span class="hljs-literal">None</span>
            self._vnc_url = <span class="hljs-literal">None</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"Sandbox 已销毁: <span class="hljs-subst">{sandbox_id}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 即使销毁失败，也清理本地状态</span>
            self._sandbox = <span class="hljs-literal">None</span>
            self._sandbox_id = <span class="hljs-literal">None</span>
            self._cdp_url = <span class="hljs-literal">None</span>
            self._vnc_url = <span class="hljs-literal">None</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"销毁 Sandbox 时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_active</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""检查 sandbox 是否活跃"""</span>
        <span class="hljs-keyword">return</span> self._sandbox <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__enter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""上下文管理器入口"""</span>
        <span class="hljs-keyword">return</span> self
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__exit__</span>(<span class="hljs-params">self, exc_type, exc_val, exc_tb</span>):
        <span class="hljs-string">"""上下文管理器退出，自动销毁"""</span>
        self.destroy()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
<span class="hljs-comment"># 全局单例（可选，用于简单场景）</span>
_global_manager: <span class="hljs-type">Optional</span>[SandboxManager] = <span class="hljs-literal">None</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_global_manager</span>() -&gt; SandboxManager:
    <span class="hljs-string">"""获取全局 SandboxManager 单例"""</span>
    <span class="hljs-keyword">global</span> _global_manager
    <span class="hljs-keyword">if</span> _global_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _global_manager = SandboxManager()
    <span class="hljs-keyword">return</span> _global_manager
<span class="hljs-keyword">def</span> <span class="hljs-title function_">reset_global_manager</span>():
    <span class="hljs-string">"""重置全局 SandboxManager"""</span>
    <span class="hljs-keyword">global</span> _global_manager
    <span class="hljs-keyword">if</span> _global_manager:
        _global_manager.destroy()
    _global_manager = <span class="hljs-literal">None</span>
</code></pre>
<p><strong>关键功能：</strong></p>
<ol>
<li><strong>创建 Sandbox：</strong> 使用 AgentRun SDK 创建浏览器 Sandbox</li>
<li><strong>获取连接信息：</strong> 自动获取 CDP URL 和 VNC URL，支持多种属性名兼容</li>
<li><strong>生命周期管理：</strong> 提供销毁方法，确保资源正确释放</li>
</ol>
<p><strong>步骤 4：创建 LangChain Tools 和 Agent</strong></p>
<p>创建 langchain_agent.py 文件，定义 LangChain Tools 并创建 Agent。核心代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
LangChain Agent 和 Tools 注册模块
负责创建 LangChain Agent，注册 Sandbox 相关的 tools，并集成 VNC 可视化。
本模块使用 sandbox_manager.py 中封装的 SandboxManager 来管理 sandbox 生命周期。
"""</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-comment"># 导入 sandbox 管理器</span>
<span class="hljs-keyword">from</span> sandbox_manager <span class="hljs-keyword">import</span> SandboxManager
<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()
<span class="hljs-comment"># 全局 sandbox 管理器实例（单例模式）</span>
_sandbox_manager: SandboxManager | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sandbox_manager</span>() -&gt; SandboxManager:
    <span class="hljs-string">"""获取 sandbox 管理器实例（单例模式）"""</span>
    <span class="hljs-keyword">global</span> _sandbox_manager
    <span class="hljs-keyword">if</span> _sandbox_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _sandbox_manager = SandboxManager()
    <span class="hljs-keyword">return</span> _sandbox_manager
<span class="hljs-comment"># ============ LangChain Tools 定义 ============</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_browser_sandbox</span>(<span class="hljs-params">
    template_name: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,
    idle_timeout: <span class="hljs-built_in">int</span> = <span class="hljs-number">3000</span>
</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""创建或获取一个浏览器 sandbox 实例。
    当需要访问网页、执行浏览器操作时，首先需要创建 sandbox。
    创建成功后，会返回 sandbox 信息，包括 VNC URL 用于可视化。
    Args:
        template_name: Sandbox 模板名称，如果不提供则从环境变量 BROWSER_TEMPLATE_NAME 读取
        idle_timeout: 空闲超时时间（秒），默认 3000 秒
    Returns:
        Sandbox 信息字符串，包括 ID、CDP URL、VNC URL
    """</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        <span class="hljs-comment"># 如果 template_name 为空字符串，转换为 None 以便从环境变量读取</span>
        <span class="hljs-keyword">if</span> template_name == <span class="hljs-string">""</span>:
            template_name = <span class="hljs-literal">None</span>
        info = manager.create(template_name=template_name, idle_timeout=idle_timeout)
        result = <span class="hljs-string">f"""✅ Sandbox 创建成功！
📋 Sandbox 信息:
- ID: <span class="hljs-subst">{info[<span class="hljs-string">'sandbox_id'</span>]}</span>
- CDP URL: <span class="hljs-subst">{info[<span class="hljs-string">'cdp_url'</span>]}</span>
"""</span>
        vnc_url = info.get(<span class="hljs-string">'vnc_url'</span>)
        <span class="hljs-keyword">if</span> vnc_url:
            result += <span class="hljs-string">f"- VNC URL: <span class="hljs-subst">{vnc_url}</span>\n\n"</span>
            result += <span class="hljs-string">"提示: VNC 查看器应该已自动打开，您可以在浏览器中实时查看浏览器操作。"</span>
        <span class="hljs-keyword">else</span>:
            result += <span class="hljs-string">"\n警告: 未获取到 VNC URL，可能无法使用可视化功能。"</span>
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" 创建 Sandbox 失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sandbox_info</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取当前 sandbox 的详细信息，包括 ID、CDP URL、VNC URL 等。
    当需要查看当前 sandbox 状态或获取 VNC 连接信息时使用此工具。
    Returns:
        Sandbox 信息字符串
    """</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        info = manager.get_info()
        result = <span class="hljs-string">f"""📋 当前 Sandbox 信息:
- Sandbox ID: <span class="hljs-subst">{info[<span class="hljs-string">'sandbox_id'</span>]}</span>
- CDP URL: <span class="hljs-subst">{info[<span class="hljs-string">'cdp_url'</span>]}</span>
"""</span>
        <span class="hljs-keyword">if</span> info.get(<span class="hljs-string">'vnc_url'</span>):
            result += <span class="hljs-string">f"- VNC URL: <span class="hljs-subst">{info[<span class="hljs-string">'vnc_url'</span>]}</span>\n\n"</span>
            result += <span class="hljs-string">"您可以使用 VNC URL 在浏览器中实时查看操作过程。\n"</span>
            result += <span class="hljs-string">"   推荐使用 vnc.html 文件或 noVNC 客户端。"</span>
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> RuntimeError <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" 获取 Sandbox 信息失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigateInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""浏览器导航输入参数"""</span>
    url: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"要访问的网页 URL，必须以 http:// 或 https:// 开头"</span>)
    wait_until: <span class="hljs-built_in">str</span> = Field(
        default=<span class="hljs-string">"load"</span>,
        description=<span class="hljs-string">"等待页面加载的状态: load, domcontentloaded, networkidle"</span>
    )
    timeout: <span class="hljs-built_in">int</span> = Field(
        default=<span class="hljs-number">30000</span>,
        description=<span class="hljs-string">"超时时间（毫秒），默认 30000"</span>
    )
<span class="hljs-meta">@tool(<span class="hljs-params">args_schema=NavigateInput</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">navigate_to_url</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span>, wait_until: <span class="hljs-built_in">str</span> = <span class="hljs-string">"load"</span>, timeout: <span class="hljs-built_in">int</span> = <span class="hljs-number">30000</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""使用 sandbox 中的浏览器导航到指定 URL。
    当用户需要访问网页时使用此工具。导航后可以在 VNC 中实时查看页面。
    Args:
        url: 要访问的网页 URL
        wait_until: 等待页面加载的状态（load/domcontentloaded/networkidle）
        timeout: 超时时间（毫秒）
    Returns:
        导航结果描述
    """</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> manager.is_active():
            <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 请先创建 sandbox"</span>
        <span class="hljs-comment"># 验证 URL</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> url.startswith((<span class="hljs-string">"http://"</span>, <span class="hljs-string">"https://"</span>)):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f" 错误: 无效的 URL 格式: <span class="hljs-subst">{url}</span>"</span>
        cdp_url = manager.get_cdp_url()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cdp_url:
            <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 无法获取 CDP URL"</span>
        <span class="hljs-comment"># 使用 Playwright 连接浏览器并导航</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
            <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
                browser = p.chromium.connect_over_cdp(cdp_url)
                pages = browser.contexts[<span class="hljs-number">0</span>].pages <span class="hljs-keyword">if</span> browser.contexts <span class="hljs-keyword">else</span> []
                <span class="hljs-keyword">if</span> pages:
                    page = pages[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">else</span>:
                    page = browser.new_page()
                page.goto(url, wait_until=wait_until, timeout=timeout)
                title = page.title()
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"已成功导航到: <span class="hljs-subst">{url}</span>\n📄 页面标题: <span class="hljs-subst">{title}</span>\n💡 您可以在 VNC 中查看页面内容。"</span>
        <span class="hljs-keyword">except</span> ImportError:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"导航指令已发送: <span class="hljs-subst">{url}</span>\n💡 提示: 安装 playwright 以启用实际导航功能 (pip install playwright)"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f" 导航失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" 操作失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
<span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"browser_screenshot"</span>, description=<span class="hljs-string">"在浏览器 sandbox 中截取当前页面截图"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">take_screenshot</span>(<span class="hljs-params">filename: <span class="hljs-built_in">str</span> = <span class="hljs-string">"screenshot.png"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""截取浏览器当前页面的截图。
    Args:
        filename: 截图文件名，默认 "screenshot.png"
    Returns:
        操作结果
    """</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> manager.is_active():
            <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 请先创建 sandbox"</span>
        cdp_url = manager.get_cdp_url()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cdp_url:
            <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 无法获取 CDP URL"</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
            <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
                browser = p.chromium.connect_over_cdp(cdp_url)
                pages = browser.contexts[<span class="hljs-number">0</span>].pages <span class="hljs-keyword">if</span> browser.contexts <span class="hljs-keyword">else</span> []
                <span class="hljs-keyword">if</span> pages:
                    page = pages[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 没有打开的页面"</span>
                page.screenshot(path=filename)
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"截图已保存: <span class="hljs-subst">{filename}</span>"</span>
        <span class="hljs-keyword">except</span> ImportError:
            <span class="hljs-keyword">return</span> <span class="hljs-string">" 错误: 需要安装 playwright (pip install playwright)"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f" 截图失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" 操作失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
<span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"destroy_sandbox"</span>, description=<span class="hljs-string">"销毁当前的 sandbox 实例，释放资源。注意：仅在程序退出或明确需要释放资源时使用，不要在一轮对话后销毁。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">destroy_sandbox</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""销毁当前的 sandbox 实例。
    重要提示：此工具应该仅在以下情况使用：
    - 程序即将退出
    - 明确需要释放资源
    - 用户明确要求销毁
    不要在一轮对话完成后就销毁 sandbox，因为 sandbox 可以在多轮对话中复用。
    Returns:
        操作结果
    """</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        result = manager.destroy()
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f" 销毁失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
<span class="hljs-comment"># ============ Agent 创建 ============</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_browser_agent</span>(<span class="hljs-params">system_prompt: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    创建带有 sandbox 工具的 LangChain Agent
    Args:
        system_prompt: 自定义系统提示词，如果为 None 则使用默认提示词
    Returns:
        LangChain Agent 实例
    """</span>
    <span class="hljs-comment"># 配置 DashScope API</span>
    api_key = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"请设置环境变量 DASHSCOPE_API_KEY"</span>)
    base_url = <span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>
    model_name = os.getenv(<span class="hljs-string">"QWEN_MODEL"</span>, <span class="hljs-string">"qwen-plus"</span>)
    <span class="hljs-comment"># 创建 LLM</span>
    model = ChatOpenAI(
        model=model_name,
        api_key=api_key,
        base_url=base_url,
        temperature=<span class="hljs-number">0.7</span>,
    )
    <span class="hljs-comment"># 创建工具列表</span>
    tools = [
        create_browser_sandbox,
        get_sandbox_info,
        navigate_to_url,
        take_screenshot,
        destroy_sandbox,
    ]
    <span class="hljs-comment"># 默认系统提示词</span>
    <span class="hljs-keyword">if</span> system_prompt <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        system_prompt = <span class="hljs-string">"""你是一个浏览器自动化助手，可以使用 sandbox 来访问和操作网页。
当用户需要访问网页时，请按以下步骤操作：
1. 首先创建或获取 sandbox（如果还没有）
2. 使用 navigate_to_url 导航到目标网页
3. 执行用户请求的操作
4. 如果需要，可以截取截图
重要提示：
- 创建 sandbox 后，会返回 VNC URL，用户可以使用它实时查看浏览器操作
- 所有操作都会在 VNC 中实时显示，方便调试和监控
- sandbox 可以在多轮对话中复用，不要在一轮对话完成后就销毁
- 只有在用户明确要求销毁时才使用 destroy_sandbox 工具
- 不要主动建议用户销毁 sandbox，除非用户明确要求
- 请始终用中文回复，确保操作准确、高效。"""</span>
    <span class="hljs-comment"># 创建 Agent</span>
    agent = create_agent(
        model=model,
        tools=tools,
        system_prompt=system_prompt,
    )
    <span class="hljs-keyword">return</span> agent
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_available_tools</span>():
    <span class="hljs-string">"""获取所有可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        create_browser_sandbox,
        get_sandbox_info,
        navigate_to_url,
        take_screenshot,
        destroy_sandbox,
    ]
</code></pre>
<p><strong>关键要点：</strong></p>
<ol>
<li><strong>Tool 定义：</strong> 使用 @tool 装饰器定义 LangChain Tools</li>
<li><strong>类型提示：</strong> 所有参数必须有类型提示，用于生成工具 schema</li>
<li><strong>文档字符串：</strong> 详细的文档字符串帮助 LLM 理解何时使用工具**</li>
<li><strong>单例模式：</strong> 使用全局管理器实例确保 Sandbox 在会话中复用**</li>
</ol>
<p><strong>步骤 5：创建主入口文件</strong></p>
<p>创建 main.py 文件，作为程序入口。核心代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
LangChain + AgentRun Browser Sandbox 集成示例
主入口文件，演示如何使用 LangChain Agent 与 AgentRun Browser Sandbox 集成。
"""</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> signal
<span class="hljs-keyword">import</span> webbrowser
<span class="hljs-keyword">import</span> urllib.parse
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> http.server
<span class="hljs-keyword">import</span> socketserver
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain_agent <span class="hljs-keyword">import</span> create_browser_agent, get_sandbox_manager
<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()
<span class="hljs-comment"># 全局 HTTP 服务器实例</span>
_http_server = <span class="hljs-literal">None</span>
_http_port = <span class="hljs-number">8080</span>
<span class="hljs-comment"># 全局清理标志，用于防止重复清理</span>
_cleanup_done = <span class="hljs-literal">False</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">start_http_server</span>():
    <span class="hljs-string">"""启动一个简单的 HTTP 服务器来提供 vnc.html"""</span>
    <span class="hljs-keyword">global</span> _http_server
    <span class="hljs-keyword">if</span> _http_server <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">return</span> _http_port
    <span class="hljs-keyword">try</span>:
        current_dir = Path(__file__).parent.absolute()
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">VNCRequestHandler</span>(http.server.SimpleHTTPRequestHandler):
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):
                <span class="hljs-built_in">super</span>().__init__(*args, directory=<span class="hljs-built_in">str</span>(current_dir), **kwargs)
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">log_message</span>(<span class="hljs-params">self, <span class="hljs-built_in">format</span>, *args</span>):
                <span class="hljs-comment"># 静默日志，避免输出过多信息</span>
                <span class="hljs-keyword">pass</span>
        <span class="hljs-comment"># 尝试启动服务器</span>
        <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(_http_port, _http_port + <span class="hljs-number">10</span>):
            <span class="hljs-keyword">try</span>:
                server = socketserver.TCPServer((<span class="hljs-string">""</span>, port), VNCRequestHandler)
                server.allow_reuse_address = <span class="hljs-literal">True</span>
                <span class="hljs-comment"># 在后台线程中运行服务器</span>
                <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_server</span>():
                    server.serve_forever()
                thread = threading.Thread(target=run_server, daemon=<span class="hljs-literal">True</span>)
                thread.start()
                _http_server = server
                <span class="hljs-keyword">return</span> port
            <span class="hljs-keyword">except</span> OSError:
                <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"启动 HTTP 服务器失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">open_vnc_viewer</span>(<span class="hljs-params">vnc_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""
    自动打开 VNC 查看器并设置 VNC URL
    Args:
        vnc_url: VNC WebSocket URL
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vnc_url:
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 获取当前文件所在目录</span>
        current_dir = Path(__file__).parent.absolute()
        vnc_html_path = current_dir / <span class="hljs-string">"vnc.html"</span>
        <span class="hljs-comment"># 检查文件是否存在</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vnc_html_path.exists():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告: vnc.html 文件不存在: <span class="hljs-subst">{vnc_html_path}</span>"</span>)
            print_vnc_info(vnc_url)
            <span class="hljs-keyword">return</span>
        <span class="hljs-comment"># 启动 HTTP 服务器</span>
        port = start_http_server()
        <span class="hljs-keyword">if</span> port:
            <span class="hljs-comment"># 编码 VNC URL 作为 URL 参数</span>
            encoded_url = urllib.parse.quote(vnc_url, safe=<span class="hljs-string">''</span>)
            <span class="hljs-comment"># 构建 HTTP URL</span>
            http_url = <span class="hljs-string">f"http://localhost:<span class="hljs-subst">{port}</span>/vnc.html?url=<span class="hljs-subst">{encoded_url}</span>"</span>
            <span class="hljs-comment"># 打开浏览器</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n正在打开 VNC 查看器..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"HTTP 服务器运行在: http://localhost:<span class="hljs-subst">{port}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"VNC URL: <span class="hljs-subst">{vnc_url[:<span class="hljs-number">80</span>]}</span>..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"完整 URL: <span class="hljs-subst">{http_url[:<span class="hljs-number">100</span>]}</span>..."</span>)
            webbrowser.<span class="hljs-built_in">open</span>(http_url)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"VNC 查看器已打开"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"VNC URL 已通过 URL 参数自动设置，页面加载后会自动连接"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 如果 HTTP 服务器启动失败，尝试使用 file:// 协议</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"HTTP 服务器启动失败，尝试使用文件协议..."</span>)
            encoded_url = urllib.parse.quote(vnc_url, safe=<span class="hljs-string">''</span>)
            file_url = <span class="hljs-string">f"file://<span class="hljs-subst">{vnc_html_path}</span>?url=<span class="hljs-subst">{encoded_url}</span>"</span>
            webbrowser.<span class="hljs-built_in">open</span>(file_url)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"VNC 查看器已打开（使用文件协议）"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"提示: 如果无法自动连接，请手动复制 VNC URL 到输入框"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"自动打开 VNC 查看器失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        print_vnc_info(vnc_url)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">print_vnc_info</span>(<span class="hljs-params">vnc_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""打印 VNC 连接信息"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vnc_url:
        <span class="hljs-keyword">return</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"VNC 可视化连接信息"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nVNC URL: <span class="hljs-subst">{vnc_url}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用方式:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"   1. 使用 noVNC 客户端连接"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"   2. 或在浏览器中访问 VNC 查看器页面"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"   3. 实时查看浏览器操作过程"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup_sandbox</span>():
    <span class="hljs-string">"""
    清理 sandbox 资源
    这个函数可以被信号处理器、异常处理器和正常退出流程调用
    """</span>
    <span class="hljs-keyword">global</span> _cleanup_done
    <span class="hljs-comment"># 防止重复清理</span>
    <span class="hljs-keyword">if</span> _cleanup_done:
        <span class="hljs-keyword">return</span>
    _cleanup_done = <span class="hljs-literal">True</span>
    <span class="hljs-keyword">try</span>:
        manager = get_sandbox_manager()
        <span class="hljs-keyword">if</span> manager.is_active():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在清理 sandbox..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
            result = manager.destroy()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"清理结果: <span class="hljs-subst">{result}</span>\n"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n没有活动的 sandbox 需要清理\n"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n清理 sandbox 时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">signal_handler</span>(<span class="hljs-params">signum, frame</span>):
    <span class="hljs-string">"""
    信号处理器，处理 Ctrl+C (SIGINT) 和其他信号
    Args:
        signum: 信号编号
        frame: 当前堆栈帧
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n收到中断信号，正在清理资源..."</span>)
    cleanup_sandbox()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
    sys.exit(<span class="hljs-number">0</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    <span class="hljs-keyword">global</span> _cleanup_done
    <span class="hljs-comment"># 重置清理标志</span>
    _cleanup_done = <span class="hljs-literal">False</span>
    <span class="hljs-comment"># 注册信号处理器，处理 Ctrl+C (SIGINT)</span>
    signal.signal(signal.SIGINT, signal_handler)
    <span class="hljs-comment"># 在 Windows 上，SIGBREAK 也可以处理</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(signal, <span class="hljs-string">'SIGBREAK'</span>):
        signal.signal(signal.SIGBREAK, signal_handler)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"LangChain + AgentRun Browser Sandbox 集成示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 创建 Agent</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在初始化 LangChain Agent..."</span>)
        agent = create_browser_agent()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Agent 初始化完成\n"</span>)
        <span class="hljs-comment"># 示例查询</span>
        queries = [
            <span class="hljs-string">"创建一个浏览器 sandbox"</span>,
            <span class="hljs-string">"获取当前 sandbox 的信息，包括 VNC URL"</span>,
            <span class="hljs-string">"导航到 https://www.aliyun.com"</span>,
            <span class="hljs-string">"截取当前页面截图"</span>,
        ]
        <span class="hljs-comment"># 执行查询</span>
        <span class="hljs-keyword">for</span> i, query <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(queries, <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">60</span>}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询 <span class="hljs-subst">{i}</span>: <span class="hljs-subst">{query}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span> * <span class="hljs-number">60</span>}</span>\n"</span>)
            <span class="hljs-keyword">try</span>:
                result = agent.invoke({
                    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: query}]
                })
                <span class="hljs-comment"># 提取最后一条消息的内容</span>
                output = result.get(<span class="hljs-string">"messages"</span>, [])[-<span class="hljs-number">1</span>].content <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result.get(<span class="hljs-string">"messages"</span>), <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> result.get(<span class="hljs-string">"output"</span>, <span class="hljs-built_in">str</span>(result))
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n结果:\n<span class="hljs-subst">{output}</span>\n"</span>)
                <span class="hljs-comment"># 如果是创建 sandbox，自动打开 VNC 查看器</span>
                <span class="hljs-keyword">if</span> i == <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-comment"># 等待一下确保 sandbox 完全创建</span>
                        <span class="hljs-keyword">import</span> time
                        time.sleep(<span class="hljs-number">1</span>)
                        manager = get_sandbox_manager()
                        <span class="hljs-keyword">if</span> manager.is_active():
                            info = manager.get_info()
                            vnc_url = info.get(<span class="hljs-string">'vnc_url'</span>)
                            <span class="hljs-keyword">if</span> vnc_url:
                                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n检测到 VNC URL: <span class="hljs-subst">{vnc_url[:<span class="hljs-number">80</span>]}</span>..."</span>)
                                open_vnc_viewer(vnc_url)
                                print_vnc_info(vnc_url)
                            <span class="hljs-keyword">else</span>:
                                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n警告: 未获取到 VNC URL，请检查 sandbox 创建是否成功"</span>)
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"打开 VNC 查看器时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                        <span class="hljs-keyword">import</span> traceback
                        traceback.print_exc()
                <span class="hljs-comment"># 如果是获取信息，显示 VNC 信息</span>
                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">try</span>:
                        manager = get_sandbox_manager()
                        <span class="hljs-keyword">if</span> manager.is_active():
                            info = manager.get_info()
                            <span class="hljs-keyword">if</span> info.get(<span class="hljs-string">'vnc_url'</span>):
                                print_vnc_info(info[<span class="hljs-string">'vnc_url'</span>])
                    <span class="hljs-keyword">except</span>:
                        <span class="hljs-keyword">pass</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
                <span class="hljs-keyword">import</span> traceback
                traceback.print_exc()
        <span class="hljs-comment"># 交互式查询</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进入交互模式（输入 'quit' 或 'exit' 退出，Ctrl+C 或 Ctrl+D 中断）"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">try</span>:
                user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的查询: "</span>).strip()
            <span class="hljs-keyword">except</span> EOFError:
                <span class="hljs-comment"># 处理 Ctrl+D (EOF)</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n检测到输入结束 (Ctrl+D)，正在清理资源..."</span>)
                cleanup_sandbox()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">except</span> KeyboardInterrupt:
                <span class="hljs-comment"># 处理 Ctrl+C (在 input 调用期间)</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n检测到中断信号 (Ctrl+C)，正在清理资源..."</span>)
                cleanup_sandbox()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_input:
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'quit'</span>, <span class="hljs-string">'exit'</span>, <span class="hljs-string">'退出'</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nBye"</span>)
                <span class="hljs-comment"># 退出前清理 sandbox</span>
                cleanup_sandbox()
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">try</span>:
                result = agent.invoke({
                    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input}]
                })
                output = result.get(<span class="hljs-string">"messages"</span>, [])[-<span class="hljs-number">1</span>].content <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result.get(<span class="hljs-string">"messages"</span>), <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> result.get(<span class="hljs-string">"output"</span>, <span class="hljs-built_in">str</span>(result))
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n结果:\n<span class="hljs-subst">{output}</span>\n"</span>)
                <span class="hljs-comment"># 检查是否需要打开或显示 VNC 信息</span>
                user_input_lower = user_input.lower()
                <span class="hljs-keyword">if</span> <span class="hljs-string">"创建"</span> <span class="hljs-keyword">in</span> user_input_lower <span class="hljs-keyword">and</span> <span class="hljs-string">"sandbox"</span> <span class="hljs-keyword">in</span> user_input_lower:
                    <span class="hljs-comment"># 如果是创建 sandbox，自动打开 VNC 查看器</span>
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-comment"># 等待一下确保 sandbox 完全创建</span>
                        <span class="hljs-keyword">import</span> time
                        time.sleep(<span class="hljs-number">1</span>)
                        manager = get_sandbox_manager()
                        <span class="hljs-keyword">if</span> manager.is_active():
                            info = manager.get_info()
                            vnc_url = info.get(<span class="hljs-string">'vnc_url'</span>)
                            <span class="hljs-keyword">if</span> vnc_url:
                                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n检测到 VNC URL: <span class="hljs-subst">{vnc_url[:<span class="hljs-number">80</span>]}</span>..."</span>)
                                open_vnc_viewer(vnc_url)
                                print_vnc_info(vnc_url)
                            <span class="hljs-keyword">else</span>:
                                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n警告: 未获取到 VNC URL，请检查 sandbox 创建是否成功"</span>)
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"打开 VNC 查看器时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                        <span class="hljs-keyword">import</span> traceback
                        traceback.print_exc()
                <span class="hljs-keyword">elif</span> <span class="hljs-string">"sandbox"</span> <span class="hljs-keyword">in</span> user_input_lower <span class="hljs-keyword">or</span> <span class="hljs-string">"vnc"</span> <span class="hljs-keyword">in</span> user_input_lower:
                    <span class="hljs-comment"># 其他情况只显示信息</span>
                    <span class="hljs-keyword">try</span>:
                        manager = get_sandbox_manager()
                        <span class="hljs-keyword">if</span> manager.is_active():
                            info = manager.get_info()
                            <span class="hljs-keyword">if</span> info.get(<span class="hljs-string">'vnc_url'</span>):
                                print_vnc_info(info[<span class="hljs-string">'vnc_url'</span>])
                    <span class="hljs-keyword">except</span>:
                        <span class="hljs-keyword">pass</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
                <span class="hljs-keyword">import</span> traceback
                traceback.print_exc()
        <span class="hljs-comment"># 清理资源（仅在程序正常退出时）</span>
        cleanup_sandbox()
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-comment"># 处理顶层 KeyboardInterrupt (Ctrl+C)</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n检测到中断信号 (Ctrl+C)，正在清理资源..."</span>)
        cleanup_sandbox()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
        sys.exit(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">except</span> EOFError:
        <span class="hljs-comment"># 处理顶层 EOFError (Ctrl+D)</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n检测到输入结束 (Ctrl+D)，正在清理资源..."</span>)
        cleanup_sandbox()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
        sys.exit(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"配置错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n提示: 请确保已设置以下环境变量:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"   - DASHSCOPE_API_KEY: DashScope API Key"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"   - ALIBABA_CLOUD_ACCOUNT_ID: 阿里云账号 ID"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"   - ALIBABA_CLOUD_ACCESS_KEY_ID: 访问密钥 ID"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"   - ALIBABA_CLOUD_ACCESS_KEY_SECRET: 访问密钥 Secret"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"   - ALIBABA_CLOUD_REGION: 区域（默认: cn-hangzhou）"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">import</span> traceback
        traceback.print_exc()
        <span class="hljs-comment"># 发生错误时也尝试清理</span>
        cleanup_sandbox()
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p><strong>关键功能：</strong></p>
<ol>
<li><strong>VNC 自动打开：</strong> 创建 Sandbox 后自动打开 VNC 查看器</li>
<li><strong>信号处理：</strong> 捕获 Ctrl+C，确保资源正确清理</li>
<li><strong>交互模式：</strong> 支持持续对话，复用 Sandbox 实例</li>
</ol>
<p><strong>VNC 可视化集成</strong></p>
<p>VNC（Virtual Network Computing）功能允许您实时查看和监控浏览器在 Sandbox 中的操作过程，这对于调试和监控 Agent 行为非常有用。</p>
<p><strong>获取 VNC URL：</strong></p>
<p>创建 Sandbox 后，可以通过 <code>get_sandbox_info tool</code> 获取 VNC URL：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 通过 Agent 调用</span>
<span class="hljs-attr">result</span> = agent.invoke({
    "messages": <span class="hljs-section">[{"role": "user", "content": "获取 sandbox 信息"}]</span>
})
<span class="hljs-comment"># 或直接通过管理器获取</span>
<span class="hljs-attr">manager</span> = get_sandbox_manager()
<span class="hljs-attr">info</span> = manager.get_info()
<span class="hljs-attr">vnc_url</span> = info[<span class="hljs-string">'vnc_url'</span>]
</code></pre>
<p><strong>自动打开 VNC 查看器：</strong></p>
<p>在 <code>main.py</code> 中，我们实现了自动打开 VNC 查看器的功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> webbrowser
<span class="hljs-keyword">import</span> urllib.parse
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">def</span> <span class="hljs-title function_">open_vnc_viewer</span>(<span class="hljs-params">vnc_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""自动打开 VNC 查看器"""</span>
    current_dir = Path(__file__).parent.absolute()
    vnc_html_path = current_dir / <span class="hljs-string">"vnc.html"</span>
    <span class="hljs-keyword">if</span> vnc_html_path.exists():
        <span class="hljs-comment"># 通过 URL 参数传递 VNC URL</span>
        encoded_url = urllib.parse.quote(vnc_url, safe=<span class="hljs-string">''</span>)
        file_url = <span class="hljs-string">f"file://<span class="hljs-subst">{vnc_html_path}</span>?url=<span class="hljs-subst">{encoded_url}</span>"</span>
        webbrowser.<span class="hljs-built_in">open</span>(file_url)
</code></pre>
<p><strong>VNC HTML 页面：</strong></p>
<p><code>vnc.html</code> 页面会从 URL 参数中读取 VNC URL，并自动连接到 VNC 服务器。页面包含以下核心功能：</p>
<ol>
<li><strong>noVNC 库加载：</strong> 从 CDN 动态加载 noVNC 客户端库</li>
<li><strong>自动连接：</strong> 读取 URL 参数中的 VNC URL 并自动连接</li>
<li><strong>状态显示：</strong> 显示连接状态（连接中、已连接、已断开）</li>
<li><strong>手动控制：</strong> 支持手动输入 VNC URL、断开重连等操作</li>
</ol>
<p>核心 JavaScript 代码片段：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从 URL 参数获取 VNC URL</span>
<span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
<span class="hljs-keyword">const</span> vncUrl = urlParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">'url'</span>);
<span class="hljs-comment">// 加载 noVNC 库</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadNoVNC</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'https://cdn.jsdelivr.net/gh/novnc/noVNC@v1.4.0/core/rfb.js'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>;
}
<span class="hljs-comment">// 连接 VNC</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectVNC</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RFB</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadNoVNC</span>();
    rfb = <span class="hljs-keyword">new</span> <span class="hljs-title function_">RFB</span>(vncScreen, url, {
        <span class="hljs-attr">shared</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">credentials</span>: { <span class="hljs-attr">password</span>: <span class="hljs-string">''</span> }
    });
    rfb.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'VNC 连接成功'</span>);
    });
}
</code></pre>
<p>完整的 vnc.html 文件可以在示例代码仓库中获取。</p>
<p><strong>手动使用 VNC 查看器：</strong></p>
<p>如果自动打开失败，您也可以手动使用 VNC 查看器：</p>
<p><strong>1. 使用 noVNC 在线客户端：</strong></p>
<ul>
<li>访问 noVNC 在线客户端 <strong>[</strong> <strong>2]</strong></li>
<li>在连接设置中填入 VNC URL</li>
<li>点击连接</li>
</ul>
<p><strong>2. 使用本地 VNC HTML 页面：</strong></p>
<ul>
<li>打开 <code>vnc.html</code></li>
<li>输入 VNC URL</li>
<li>点击连接按钮</li>
</ul>
<p><strong>实时监控功能：</strong></p>
<ul>
<li>所有浏览器操作都会在 VNC 中实时显示</li>
<li>可以看到 Agent 的每一步操作（导航、点击、输入等）</li>
<li>方便调试和监控 Agent 行为</li>
<li>支持交互式操作（在 VNC 中直接操作浏览器）</li>
</ul>
<p><strong>运行和测试</strong></p>
<pre><code class="hljs language-css" lang="css">python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
</code></pre>
<p>程序会自动：</p>
<ol>
<li>创建 Browser Sandbox</li>
<li>打开 VNC 查看器（实时查看浏览器操作）</li>
<li>执行预设查询</li>
<li>进入交互模式</li>
</ol>
<h3 data-id="heading-12">工作原理</h3>
<p>为了更好地理解系统架构，我们将工作流程拆分为两个部分：<strong>LangChain Agent 工作流程</strong>和 <strong>SandboxManager 生命周期管理</strong>。</p>
<p><strong>1. LangChain Agent 工作流程</strong></p>
<p>下图展示了 LangChain Agent 如何处理用户请求并调用相应的 Tools：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc56d5ace0354c4480feb2da3782728c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=WsJbf5HOf9rZqm9kwQow5IqMssA%3D" alt="图片" loading="lazy"/></p>
<p><strong>Agent 工作流程说明：</strong></p>
<ol>
<li><strong>请求接收：</strong> 用户发起自然语言请求（如“访问淘宝首页并截图”）</li>
<li><strong>意图分析：</strong> Agent 分析用户意图，决定需要调用哪些 Tools</li>
<li><strong>Tool 调用：</strong> 根据任务需求，顺序或组合调用多个 Tools</li>
<li><strong>Manager 交互：</strong> 所有 Tools 都通过 SandboxManager 单例实例操作 Sandbox</li>
<li><strong>结果处理：</strong> Agent 将 Tool 返回的结果整合成用户友好的响应</li>
<li><strong>多轮对话：</strong> Sandbox 在整个会话中保持活跃，支持多轮对话</li>
</ol>
<p>5 个核心 Tools 的职责：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae98b4c499f74d5f8ccad772b114cafc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=o6icxvcMjpC1WOQapHfBu2EgdBs%3D" alt="图片" loading="lazy"/></p>
<p><strong>2. SandboxManager 生命周期管理</strong></p>
<p>下图展示了 SandboxManager 如何管理 Sandbox 的完整生命周期：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/261ec1fb3bb542e7b884d52e482b9cdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=2Z3KfkfkexM8V4EN%2FEuCJ9oUutU%3D" alt="图片" loading="lazy"/></p>
<p><strong>SandboxManager 工作流程说明：</strong></p>
<p><strong>1. 单例管理：</strong></p>
<ul>
<li>首次调用时创建 Manager 实例</li>
<li>后续调用复用同一个实例</li>
<li>确保整个会话只有一个 Sandbox</li>
</ul>
<p><strong>2. Sandbox 创建：</strong></p>
<ul>
<li>调用 AgentRun SDK 的 <code>Sandbox.create()</code></li>
<li>SDK 通过阿里云 API 与函数计算 FC 通信</li>
<li>FC 服务创建独立的容器实例，包含：</li>
<li>Chromium 浏览器 VNC 服务必要的运行环境</li>
</ul>
<p><strong>3. 连接信息获取：</strong></p>
<ul>
<li><strong>CDP URL：</strong> WebSocket 地址，用于 Playwright/Puppeteer 远程控制浏览器</li>
<li><strong>VNC URL：</strong> WebSocket 地址，用于实时查看浏览器画面**</li>
</ul>
<p><strong>4. 浏览器操作：</strong></p>
<ul>
<li>Playwright 通过 CDP URL 连接到远程浏览器</li>
<li>执行各种浏览器操作（导航、点击、截图等）</li>
<li>VNC 同步显示操作过程，用户可实时监控</li>
</ul>
<p><strong>5. 资源清理：</strong></p>
<ul>
<li>调用 destroy() 方法销毁 Sandbox</li>
<li>清理 Manager 内部状态</li>
<li>通过 SDK 释放云端资源</li>
</ul>
<p><strong>3. Agent 与 Manager 的协作关系</strong></p>
<p><strong>交互模式：</strong></p>
<pre><code class="hljs">用户请求 → Agent → Tool → SandboxManager → AgentRun SDK → 云端 Sandbox
                                    ↓
用户响应 ← Agent ← Tool ← SandboxManager ← 操作结果
</code></pre>
<p><strong>关键设计理念：</strong></p>
<ol>
<li>分层架构：</li>
</ol>
<ul>
<li>用户层：自然语言交互</li>
<li>Agent 层：意图理解和任务分解</li>
<li>Tool 层：功能封装和参数验证</li>
<li>Manager 层：资源管理和状态维护</li>
<li>SDK 层：云服务通信</li>
<li>云端层：实际的 Sandbox 环境</li>
</ul>
<ol start="2">
<li>单例模式：</li>
</ol>
<ul>
<li>SandboxManager 使用单例模式</li>
<li>保证整个会话中只有一个 Sandbox 实例</li>
<li>避免资源浪费和状态冲突</li>
</ul>
<ol start="3">
<li>状态复用：</li>
</ol>
<ul>
<li>Sandbox 在多轮对话中保持活跃</li>
<li>减少创建和销毁的开销</li>
<li>提供更流畅的用户体验</li>
</ul>
<ol start="4">
<li>双通道设计：</li>
</ol>
<ul>
<li>CDP 通道：Agent 通过 Playwright 控制浏览器</li>
<li><strong>VNC 通道：用户通过 VNC 查看器实时监控</strong></li>
</ul>
<ol start="5">
<li>解耦设计：</li>
</ol>
<ul>
<li>Tools 不直接操作 SDK，通过 Manager 统一管理</li>
<li>便于扩展和维护</li>
<li>统一的错误处理和资源管理</li>
</ul>
<p><strong>典型使用场景示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第 1 轮对话</span>
用户: <span class="hljs-string">"创建一个 sandbox 并访问淘宝首页"</span>
→ Agent 调用: create_browser_sandbox → navigate_to_url
→ Manager: 创建 Sandbox → Playwright 导航
→ 结果: <span class="hljs-string">"Sandbox 已创建，已访问淘宝首页"</span>
<span class="hljs-comment"># 第 2 轮对话（复用 Sandbox）</span>
用户: <span class="hljs-string">"截取当前页面"</span>
→ Agent 调用: take_screenshot
→ Manager: 使用现有 Sandbox → Playwright 截图
→ 结果: <span class="hljs-string">"截图已保存"</span>
<span class="hljs-comment"># 第 3 轮对话（复用 Sandbox）</span>
用户: <span class="hljs-string">"访问京东首页"</span>
→ Agent 调用: navigate_to_url
→ Manager: 使用现有 Sandbox → Playwright 导航
→ 结果: <span class="hljs-string">"已访问京东首页"</span>
</code></pre>
<p>通过这种设计，Agent 专注于理解用户意图和任务编排，而 Manager 专注于 Sandbox 的生命周期管理，实现了清晰的职责分离。</p>
<p><strong>工作原理总结：</strong></p>
<ol>
<li>工具注册：使用 @tool 装饰器将 Sandbox 功能封装为 LangChain Tools</li>
<li>生命周期管理： SandboxManager 负责 Sandbox 的创建、管理和销毁</li>
<li>状态保持：使用单例模式管理 Sandbox 实例，确保同一会话内复用</li>
<li>VNC 集成：自动获取并返回 VNC URL，方便用户实时查看</li>
<li>错误处理：所有工具都包含完善的错误处理机制</li>
</ol>
<h3 data-id="heading-13">扩展和定制</h3>
<p><strong>添加自定义 Tools：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_table_data</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""从网页中提取表格数据"""</span>
    <span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
    manager = get_sandbox_manager()
    cdp_url = manager.get_info()[<span class="hljs-string">'cdp_url'</span>]
    <span class="hljs-keyword">with</span> sync_playwright() <span class="hljs-keyword">as</span> p:
        browser = p.chromium.connect_over_cdp(cdp_url)
        page = browser.contexts[<span class="hljs-number">0</span>].pages[<span class="hljs-number">0</span>]
        page.goto(url)
        tables = page.query_selector_all(<span class="hljs-string">"table"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表格"</span>
</code></pre>
<p><strong>自定义提示词：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">custom_prompt</span> = <span class="hljs-string">"""你是一个专业的网页数据提取助手。
在执行任务前，请先创建 sandbox，然后使用浏览器工具完成任务。"""</span>
<span class="hljs-attr">agent</span> = create_browser_agent(system_prompt=custom_prompt)

</code></pre>
<h3 data-id="heading-14">最佳实践</h3>
<ol>
<li>模块化设计：将 Sandbox 管理和 Agent 创建分离，提高代码可维护性</li>
<li>错误处理：所有工具都应包含完善的错误处理</li>
<li>资源清理：使用信号处理器确保资源正确清理</li>
<li>VNC 提示：在工具返回中包含 VNC URL，方便用户使用</li>
<li>单例模式：确保 Sandbox 实例在会话中复用，避免重复创建</li>
</ol>
<h2 data-id="heading-15">前端集成可视化监控（VNC）</h2>
<h3 data-id="heading-16">VNC 集成架构</h3>
<p>下图展示了前端如何集成 VNC 实现实时监控：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce0dd307446745c1a55f38ea698286a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769678518&amp;x-signature=6rY6SMcd5Fg1t1xzz3vPJKG1M14%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-17">轻量级 HTML 页面集成</h3>
<p>创建一个简单的 vnc-viewer.html 文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Browser Sandbox VNC 查看器<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">background</span>: 
<span class="hljs-number">#000</span>
; }
        
<span class="hljs-selector-id">#vnc</span>
-container { <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"vnc-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
        <span class="hljs-keyword">const</span> vncUrl = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">'url'</span>);
        <span class="hljs-keyword">if</span> (!vncUrl) {
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请提供 VNC URL 参数'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'https://cdn.jsdelivr.net/gh/novnc/noVNC@v1.4.0/core/rfb.js'</span>);
            <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RFB</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>;
            <span class="hljs-keyword">const</span> rfb = <span class="hljs-keyword">new</span> <span class="hljs-title function_">RFB</span>(
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'vnc-container'</span>),
                vncUrl,
                { <span class="hljs-attr">shared</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">credentials</span>: { <span class="hljs-attr">password</span>: <span class="hljs-string">''</span> } }
            );
            rfb.<span class="hljs-property">scaleViewport</span> = <span class="hljs-literal">true</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-ini" lang="ini">import webbrowser
import urllib.parse
<span class="hljs-attr">vnc_url</span> = sandbox.vnc_url
<span class="hljs-attr">encoded_url</span> = urllib.parse.quote(vnc_url, safe=<span class="hljs-string">''</span>)
<span class="hljs-attr">viewer_url</span> = f<span class="hljs-string">"file:///path/to/vnc-viewer.html?url={encoded_url}"</span>
webbrowser.open(viewer_url)
</code></pre>
<h3 data-id="heading-18">React 应用集成</h3>
<p>核心组件代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VNCViewerProps</span> {
  <span class="hljs-attr">vncUrl</span>: <span class="hljs-built_in">string</span>;
  onConnect?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  onDisconnect?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">VNCViewer</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">VNCViewerProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ 
  vncUrl, 
  onConnect, 
  onDisconnect 
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> containerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">rfb</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initVNC</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">current</span> || !vncUrl) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> { <span class="hljs-attr">default</span>: <span class="hljs-variable constant_">RFB</span> } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@novnc/novnc/core/rfb'</span>);
      rfb = <span class="hljs-keyword">new</span> <span class="hljs-title function_">RFB</span>(containerRef.<span class="hljs-property">current</span>, vncUrl, {
        <span class="hljs-attr">shared</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">credentials</span>: { <span class="hljs-attr">password</span>: <span class="hljs-string">''</span> }
      });
      rfb.<span class="hljs-property">scaleViewport</span> = <span class="hljs-literal">true</span>;
      rfb.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> onConnect?.());
      rfb.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function">() =&gt;</span> onDisconnect?.());
    };
    <span class="hljs-title function_">initVNC</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (rfb) rfb.<span class="hljs-title function_">disconnect</span>();
    };
  }, [vncUrl, onConnect, onDisconnect]);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{containerRef}</span> 
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">height:</span> '<span class="hljs-attr">600px</span>', <span class="hljs-attr">background:</span> '
#<span class="hljs-attr">000</span>
' }} 
    /&gt;</span></span>
  );
};
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VNCViewer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./VNCViewer'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [vncUrl, setVncUrl] = useState&lt;string&gt;(<span class="hljs-string">''</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/sandbox/create'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span> })
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setVncUrl</span>(data.<span class="hljs-property">vnc_url</span>));
  }, []);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Browser Sandbox 实时监控<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {vncUrl ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">VNCViewer</span> 
          <span class="hljs-attr">vncUrl</span>=<span class="hljs-string">{vncUrl}</span>
          <span class="hljs-attr">onConnect</span>=<span class="hljs-string">{()</span> =&gt;</span> console.log('已连接')}
          onDisconnect={() =&gt; console.log('已断开')}
        /&gt;
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>正在初始化...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-19">Puppeteer 和 Playwright 直接集成</h2>
<p>如果您更熟悉传统的浏览器自动化库，也可以直接使用 Puppeteer 或 Playwright 连接到 Browser Sandbox。</p>
<h3 data-id="heading-20">使用 Playwright</h3>
<pre><code class="hljs language-ini" lang="ini">from playwright.sync_api import sync_playwright
from agentrun.sandbox import Sandbox, TemplateType
<span class="hljs-comment"># 创建 Sandbox</span>
<span class="hljs-attr">sandbox</span> = Sandbox.create(
    <span class="hljs-attr">template_type</span>=TemplateType.BROWSER,
    <span class="hljs-attr">template_name</span>=<span class="hljs-string">"your-template-name"</span>,
    <span class="hljs-attr">sandbox_idle_timeout_seconds</span>=<span class="hljs-number">3000</span>
)
<span class="hljs-comment"># 使用 Playwright 连接</span>
with sync_playwright() as p:
    <span class="hljs-attr">browser</span> = p.chromium.connect_over_cdp(sandbox.cdp_url)
    <span class="hljs-attr">page</span> = browser.contexts[<span class="hljs-number">0</span>].pages[<span class="hljs-number">0</span>]
    <span class="hljs-comment"># 执行操作</span>
    page.goto("https://www.example.com")
    page.screenshot(<span class="hljs-attr">path</span>=<span class="hljs-string">"screenshot.png"</span>)
    <span class="hljs-attr">content</span> = page.content()
    browser.close()
<span class="hljs-comment"># 清理</span>
sandbox.delete()

</code></pre>
<h3 data-id="heading-21">使用 Puppeteer（Node.js）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">puppeteer</span> = require(<span class="hljs-string">'puppeteer-core'</span>)<span class="hljs-comment">;</span>
// CDP URL 从 Sandbox 获取
const <span class="hljs-attr">cdpUrl</span> = <span class="hljs-string">'wss://your-account.funagent-data-pre.cn-hangzhou.aliyuncs.com/sandboxes/xxx/ws/automation'</span><span class="hljs-comment">;</span>
(async () =&gt; {
  const <span class="hljs-attr">browser</span> = await puppeteer.connect({
    browserWSEndpoint: cdpUrl,
    defaultViewport: null
  })<span class="hljs-comment">;</span>
  const <span class="hljs-attr">page</span> = (await browser.pages())[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  await page.goto('https://www.example.com')<span class="hljs-comment">;</span>
  await page.screenshot({ path: 'screenshot.png' })<span class="hljs-comment">;</span>
  await browser.close()<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-22">总结</h2>
<p>通过本教程，您已经学会了：</p>
<ol>
<li><strong>AgentRun SDK 基础：</strong> 如何使用 SDK 创建和管理 Browser Sandbox</li>
<li><strong>LangChain 集成：</strong> 如何将 Sandbox 封装为 LangChain Tools</li>
<li><strong>VNC 可视化：</strong> 如何在前端集成 VNC 实现实时监控</li>
<li><strong>直接集成：</strong> 如何使用 Puppeteer/Playwright 直接连接 Sandbox</li>
</ol>
<p><strong>相关链接：</strong></p>
<p>[1] Agentrun 控制台网站</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffunctionai.console.aliyun.com%2Fcn-hangzhou%2Fagent%2Fruntime%2Fsandbox" target="_blank" title="https://functionai.console.aliyun.com/cn-hangzhou/agent/runtime/sandbox" ref="nofollow noopener noreferrer">functionai.console.aliyun.com/cn-hangzhou…</a></p>
<p>[2] noVNC 在线客户端</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnovnc.com%2FnoVNC%2Fvnc.html" target="_blank" title="https://novnc.com/noVNC/vnc.html" ref="nofollow noopener noreferrer">novnc.com/noVNC/vnc.h…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微软发布了 2026 年 AI 发展的 7 个趋势]]></title>    <link>https://juejin.cn/post/7597996070510067750</link>    <guid>https://juejin.cn/post/7597996070510067750</guid>    <pubDate>2026-01-22T09:29:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597996070510067750" data-draft-id="7597979278240759817" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微软发布了 2026 年 AI 发展的 7 个趋势"/> <meta itemprop="keywords" content="前端,人工智能,后端"/> <meta itemprop="datePublished" content="2026-01-22T09:29:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微软发布了 2026 年 AI 发展的 7 个趋势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:29:35.000Z" title="Thu Jan 22 2026 09:29:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">微软：2026 年 AI 发展的 7 个趋势</h2>
<p>说实话，每次看到“AI 趋势预测”这类标题，我都会先深吸一口气。</p>
<p>不是因为害怕，而是因为这类文章太容易写成两种极端：</p>
<p>要么是“AI 要统治世界了快跑”的恐慌文，要么是“拥抱 AI 否则被淘汰”的焦虑营销。</p>
<p>最近读了微软发布的 2026 年 AI 趋势文章，里面有 7 个预测。</p>
<p>我不打算照搬原文，而是结合我自己的理解，和你讲下这 7 个趋势与我们有什么关系，看你是否能在这 7 个趋势中找到自己的机会。</p>
<h3 data-id="heading-1">趋势 1：AI 成为你的数字同事</h3>
<p>AI 不是来抢你饭碗的，是来帮你“开挂”的。</p>
<p>想象一下，以前你开发一个页面要 3 天，现在 AI 帮你写代码，你只需要专注在业务需求、用户体验等事情上。</p>
<p>这就像以前洗衣服要手搓，现在有洗衣机了。洗衣机没有让“洗衣服”这件事消失，而是让你有时间去做更重要的事。</p>
<p>所以与其担心被 AI 取代，不如想想“我能用 AI 放大什么？”</p>
<h3 data-id="heading-2">趋势 2：AI 代理更安全</h3>
<p>现在的 AI 有时候像个热心但冒失的实习生——你让它帮你写邮件，它可能把你的私人信息也一起发出去了……</p>
<p>2026 年的 AI 会更像一个训练有素的助理：知道什么该做，什么不该做，什么信息可以用，什么必须保密。</p>
<p>所以虽然 AI 能帮你处理各项事务，但也要有基本的安全意识，尤其不要让他删库跑路了。</p>
<h3 data-id="heading-3">趋势 3：AI 解决全球医疗危机</h3>
<p>想象一下，当你走进医院，AI 系统能在几分钟内准确诊断你的病情，准确率高达 85.5%，而传统医生的平均准确率只有 20%。</p>
<p>这听起来像科幻电影，但微软最新的 AI 医疗诊断系统已经达到了这个水平。</p>
<p>这意味着 AI 将成为第一线的健康顾问，当然，这不是说 AI 要取代医生。而是说，AI 可以让医疗资源的分配更均衡一些。</p>
<p>所以新的一年，你可以关注 AI 在健康领域的应用，但看病还是要去正规医院，别指望 AI 给你开药方。</p>
<h3 data-id="heading-4">趋势 4：AI 成为科学研究的催化剂</h3>
<p>以前做研究，光是文献综述就要花几个月。</p>
<p>现在 AI 可以帮你快速梳理几千篇论文，找出关键信息。</p>
<p>这就像以前考古要一铲子一铲子挖，现在有了探地雷达，能更快定位到有价值的区域。</p>
<p>所以如果你是学生或研究者，学会用 AI 辅助学习和研究，会是一个很大的竞争优势。</p>
<h3 data-id="heading-5">趋势 5：AI 基础设施会变得更智能、更高效</h3>
<p>支撑 AI 运行的基础设施会持续优化，这意味着 AI 基础设施能够智能调度算力，确保每个任务都能在最佳时间、地点获得最优资源。</p>
<p>以后无论你在哪里，使用什么设备，都将获得一致且高效的 AI 服务。</p>
<p>云计算将变得像自来水一样普及和可靠。</p>
<h3 data-id="heading-6">趋势 6：AI 正在学习理解代码背后的“为什么”</h3>
<p>AI 不只学习代码语言，还在理解代码背后的上下文。</p>
<p>这意味着以前的 AI 写代码就像个新手程序员——你说什么它写什么，但不理解你到底想解决什么问题。</p>
<p>现在的 AI 开始能理解“你为什么要这么做”，然后给出更合理的方案。</p>
<p>对我们程序员来说，AI 将能更好地协助你维护和改进现有系统。</p>
<h3 data-id="heading-7">趋势 7：量子计算的突破比想象中更近</h3>
<p>专家预测，量子计算的重大突破将发生在“几年，而不是几十年”的时间框架内。</p>
<p>随着量子计算的出现，密码学、药物发现、气候模拟等领域将迎来革命性突破。</p>
<p>当然对我们来说，这暂时不需要操心，但可以保持关注。因为这是那种“一旦发生就会改变很多事”的技术。</p>
<h3 data-id="heading-8">普通人该怎么办？</h3>
<p>这些趋势的共同点是：<strong>AI 正在从工具变成伙伴，从辅助变成合作伙伴，从后台变成前台</strong>。</p>
<p>不过看完这 7 个趋势，你可能还是会问：所以我到底该做什么呢？</p>
<p>我的建议很简单，三句话：</p>
<p><strong>第一，别焦虑，但要保持好奇</strong></p>
<p>AI 发展很快，但天不会塌下来。与其焦虑“会不会被取代”，不如花点时间玩玩各种 AI 工具，看看它们能帮你做什么。</p>
<p><strong>第二，找到你的“不可替代性”</strong></p>
<p>AI 擅长的是“标准化”的事情。而你的独特经历、审美、判断力、人际关系——这些是 AI 很难复制的。想想你有什么是 AI 做不到的</p>
<p><strong>第三，学会“和 AI 协作”</strong></p>
<p>未来最吃香的不是“会用 AI 的人”，也不是“完全不用 AI 的人”，而是“知道什么时候用 AI、什么时候用自己”的人。</p>
<p>说到底，AI 是工具，不是对手。</p>
<p>就像汽车发明后，马车夫确实失业了，但司机、修车工、交通规划师这些新职业也出现了。</p>
<p>变化一直在发生，我们要做的，是在变化中找到自己的位置。</p>
<p>PS：岂可修，这让我想到了阿里的文化——拥抱变化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个模型搞定所有场景！哈工大&罗切斯特大学提出无监督多场景ReID新方案]]></title>    <link>https://juejin.cn/post/7597987896693129251</link>    <guid>https://juejin.cn/post/7597987896693129251</guid>    <pubDate>2026-01-22T09:34:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597987896693129251" data-draft-id="7598020609281687586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个模型搞定所有场景！哈工大&amp;罗切斯特大学提出无监督多场景ReID新方案"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-22T09:34:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个模型搞定所有场景！哈工大&amp;罗切斯特大学提出无监督多场景ReID新方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:34:00.000Z" title="Thu Jan 22 2026 09:34:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>监控看不清、目标换衣服、白天黑夜切换……这些现实难题，现在一个模型就能全部解决！</p>
<p>行人重识别（ReID）技术在现代安防、智慧城市等领域扮演着关键角色。想象一下，在茫茫人海中快速锁定特定目标——这正是ReID的核心任务。</p>
<p>然而现实总是比理想复杂：夜间光线不足导致图像模糊，不同摄像头分辨率参差不齐，同一个目标换了身衣服就像变了个人……</p>
<p>传统解决方案是为每个特殊场景单独训练一个模型，但这无疑增加了系统复杂度和维护成本。有没有可能训练一个“全能型”模型，一次性解决所有问题？</p>
<p>最近，哈尔滨工业大学和罗切斯特大学的研究者们在论文《Image-Text Knowledge Modeling for Unsupervised Multi-Scenario Person Re-Identification》中给出了肯定答案。他们不仅提出了无监督多场景行人重识别（UMS-ReID）这一全新任务，还设计了一套创新的图像-文本知识建模（ITKM）框架，让单一模型处理多种复杂场景成为现实。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6deebdc5085245dcaa78e4bde2cf98c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=38PVSrmeA%2F%2BlxqX5oqgFEOFoawk%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文标题：Image-Text Knowledge Modeling for Unsupervised Multi-Scenario Person Re-Identification</strong></p>
<p><strong>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.11243" target="_blank" title="https://arxiv.org/abs/2601.11243" ref="nofollow noopener noreferrer">arxiv.org/abs/2601.11…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>现实中的ReID难题：为什么需要“大一统”模型？</strong></h2>
<p>传统无监督ReID方法在简单场景下表现不错，但面对现实世界的复杂性时却显得力不从心。问题的核心在于身份信息具有场景依赖性——同一个人的特征在不同条件下可能发生显著变化。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/725e25ae6d42462da27c8f7f717eb215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=jMWvfAraLUVkDGCYnVcY0KqusSs%3D" alt="图片2.png" loading="lazy"/></p>
<p>这种挑战催生了多个专门化的ReID子领域：</p>
<ul>
<li>UVI-ReID：处理可见光与红外图像之间的匹配</li>
<li>UCC-ReID：应对行人更换衣物带来的外观变化</li>
<li>UCR-ReID：解决不同摄像头分辨率差异问题</li>
</ul>
<p>这些专门化方法就像是只会单一乐器的乐手，各自擅长一种曲风，却无法合奏出复杂的交响乐。而在实际监控系统中，上述挑战往往同时存在。</p>
<p>维护多个独立模型不仅成本高昂，更浪费了不同场景数据中潜在的互补信息。正是这一痛点，催生了UMS-ReID这一突破性任务：用一个通用模型，搞定所有场景。</p>
<h2 data-id="heading-1"><strong>ITKM框架：三步打造全能ReID模型</strong></h2>
<p>ITKM框架基于强大的CLIP视觉语言模型构建，通过三个阶段逐步训练出一个能够应对多场景的通用图像编码器。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3019904880d94dbaa9c097da6bb864f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=kjS13kRnhfrIVgUicVKrRulnFsU%3D" alt="图片3.png" loading="lazy"/></p>
<ul>
<li><strong>第一阶段：场景感知的初步学习</strong></li>
</ul>
<p>为了让模型“知道”自己处理的是哪种场景，研究者在CLIP的图像编码器中引入了巧妙的场景嵌入设计——在输入视觉Transformer之前，将可学习的场景特征嵌入到class_token中。</p>
<p>接着，模型在每个场景内部进行同构学习：通过聚类算法为图像生成伪标签，然后使用同构对比损失优化编码器，目标是拉近同一身份的图像，推开不同身份的图像。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23f9cb01f02f45518f235d573eadcf3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=vR7i%2FAMCthWJ%2B%2B80ncng1noLvIA%3D" alt="图片4.png" loading="lazy"/></p>
<ul>
<li><strong>第二阶段：文本表示的力量</strong></li>
</ul>
<p>这一阶段的创新之处在于引入文本作为身份的高级抽象表示。</p>
<p>模型为每个伪身份学习一组专属的文本嵌入，插入到“A photo of a [X1][X2]...[XM] person”模板中，形成描述性句子。通过优化，使文本表示与对应图像表示在CLIP空间中尽可能接近。</p>
<p>关键的创新是多场景分离损失，它主动推动不同场景的文本表示相互分离，确保模型不仅能识别身份，还能感知场景差异。</p>
<p>从t-SNE可视化结果可以看到，加入这一损失后，不同场景的文本表示明显分离得更开，为后续的跨场景匹配奠定了基础。</p>
<ul>
<li><strong>第三阶段：跨场景匹配的核心技术</strong></li>
</ul>
<p>这是框架最核心的部分，模型需要学会匹配“异构”图像对——比如将红外图像中的人与可见光图像中的同一个人对应起来。</p>
<p>研究者设计了双重匹配策略：</p>
<ul>
<li>聚类级异构匹配：在身份聚类的层面上，利用图匹配算法寻找跨场景的对应关系</li>
<li>实例级异构匹配：在单个图像层面上，同时在图像和文本两个特征空间寻找相似样本，取交集作为高可信度的异构正样本</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4116ebf1404d24bf1c1abaa9f8e678~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=leR6PkpcEyqZ2pEt5PKTFv%2B%2FoVU%3D" alt="图片5.png" loading="lazy"/></p>
<p>这种双空间验证方法有效过滤了视觉相似但身份错误的样本，大幅提升了匹配准确性。</p>
<p>此外，动态文本表示更新策略确保文本监督信号与不断优化的图像伪标签保持同步，形成一个自我增强的学习循环。</p>
<h2 data-id="heading-2"><strong>实验结果：全面超越的“全能选手”</strong></h2>
<p>在SYSU-MM01（可见光-红外）、MLR-CUHK03（跨分辨率）和PRCC（换衣）三个数据集上的实验结果显示：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/580a42b90bdf4c4eabbe3e3c0e0c4157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=w%2BNHDkFJQghwyBM9PaEY9X5N1VM%3D" alt="图片6.png" loading="lazy"/></p>
<p>ITKM不仅在单个场景上表现优异，在多场景联合训练时更是实现了性能的全面提升：</p>
<p>在MLR-CUHK03数据集上，ITKM单场景训练的Rank-1准确率达到62.5%，远超之前最佳方法DRFM的35.8%</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b0b859d40a146d5a29bb9a483ba50bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679239&amp;x-signature=ks%2FObxB410kf7pKk8O5%2FdYBKiVc%3D" alt="图片7.png" loading="lazy"/></p>
<p>多场景训练时，ITKM在所有三个数据集上都实现了性能提升，而传统方法在多场景训练时往往会出现性能下降</p>
<p>在SYSU-MM01数据集上，多场景训练的Rank-1准确率提升至64.9%，mAP提升至63.3%</p>
<p>这一结果有力地证明了：ITKM框架真正实现了从多样场景数据中汲取养分，达到“1+1+1&gt;3”的效果。</p>
<h2 data-id="heading-3"><strong>技术展望与现实意义</strong></h2>
<p>这项研究的价值不仅在于提出了一个性能强大的新模型，更在于定义了一个更贴近现实应用的新范式。UMS-ReID任务的提出，将推动ReID研究从“专项优化”向“通用智能”转变。</p>
<p>ITKM框架展示了多模态学习在计算机视觉任务中的巨大潜力。通过巧妙利用图文预训练模型的知识，构建能够统一处理多种复杂场景的感知系统成为可能。</p>
<p>对于安防监控、智慧城市等实际应用，这意味着：</p>
<ul>
<li>降低部署成本：无需为不同场景维护多个模型</li>
<li>提升系统鲁棒性：单一模型即可应对各种复杂条件</li>
<li>简化运维流程：模型更新和维护更加集中高效</li>
</ul>
<p>虽然目前相关代码尚未开源，但这一研究方向的明确为后续工作提供了清晰的路线图。随着多模态大模型的快速发展，我们有望看到更多类似的“大一统”解决方案，让AI系统在复杂现实环境中表现更加出色。</p>
<p>在通往通用人工智能的道路上，这类能够跨越不同条件、不同场景的感知模型，无疑是重要的一步。未来，或许我们真的能够实现“一个模型，适应万物”的终极目标。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React记录之context：useContext、use-context-selector]]></title>    <link>https://juejin.cn/post/7598020609281703970</link>    <guid>https://juejin.cn/post/7598020609281703970</guid>    <pubDate>2026-01-22T09:34:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598020609281703970" data-draft-id="7597779410407440418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React记录之context：useContext、use-context-selector"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T09:34:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="web_bee"/> <meta itemprop="url" content="https://juejin.cn/user/428665740231"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React记录之context：useContext、use-context-selector
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/428665740231/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    web_bee
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:34:27.000Z" title="Thu Jan 22 2026 09:34:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">原生context、useContext详解</h2>
<p>React 的 Context API 是一种组件间共享数据的机制，它允许你在组件树中传递数据而不必手动逐层传递 props，特别适合"全局"数据的共享（如主题、用户认证信息等）。</p>
<h3 data-id="heading-1">基本使用：</h3>
<p><strong>创建context：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createContext, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ThemeType</span> = <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>;
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ThemeContextType</span> {
  <span class="hljs-attr">theme</span>: <span class="hljs-title class_">ThemeType</span>;
  <span class="hljs-attr">toggleTheme</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}
​
<span class="hljs-comment">// 1. 创建 Context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = createContext&lt;<span class="hljs-title class_">ThemeContextType</span>&gt;({
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
  <span class="hljs-attr">toggleTheme</span>: <span class="hljs-function">() =&gt;</span> {},
});
​
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ThemeProviderProps</span> = {
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
} &amp; <span class="hljs-title class_">ThemeContextType</span>;
​
<span class="hljs-comment">// 2. 创建 Provider 组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ThemeProvider</span> = (<span class="hljs-params">{
  children,
  theme,
  toggleTheme,
}: ThemeProviderProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span>
      <span class="hljs-attr">theme</span>,
      <span class="hljs-attr">toggleTheme</span>,
    }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
};
​
<span class="hljs-comment">// 3. 自定义 Hook（可选，提升可读性）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTheme</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
</code></pre>
<p><strong>顶层组件 top.tsx</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">"use client"</span>;
​
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span>, <span class="hljs-title class_">ThemeContextType</span>, <span class="hljs-title class_">ThemeType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./context'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../components/button'</span>;
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = useState&lt;<span class="hljs-title class_">ThemeType</span>&gt;(<span class="hljs-string">'light'</span>);
​
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
  };
​
  <span class="hljs-keyword">const</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">ThemeContextType</span> = { theme, toggleTheme };
​
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>',
          <span class="hljs-attr">background:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'dark'</span> ? '#<span class="hljs-attr">000</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>',
          <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'dark'</span> ? '#<span class="hljs-attr">fff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">000</span>'
        }}
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Current theme: {theme}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p><strong>Button组件</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'../hook-api/use-context/context'</span>;
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useTheme</span>();
​
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>Toggle Theme {theme}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-2"><strong>使用场景</strong></h3>
<ul>
<li>全局主题（亮色/暗色模式）</li>
<li>用户认证状态（登录用户信息）</li>
<li>多语言国际化（i18n）</li>
<li>全局配置或状态（如购物车、通知设置）</li>
</ul>
<h3 data-id="heading-3">注意事项：</h3>
<p><strong>性能问题</strong>：当 Provider 的 <code>value</code> 发生变化时，所有使用该 Context 的子组件都会重新渲染（即使只用到部分字段）。为避免不必要的重渲染：</p>
<ul>
<li>将 <code>value</code> 拆分为多个 Context；</li>
<li>使用 <code>useMemo</code> 稳定 <code>value</code> 引用；</li>
<li>将不依赖 Context 的子组件提取到 Provider 外部。</li>
</ul>
<p><strong>不要滥用</strong>：Context 不是万能的状态管理工具。对于复杂状态逻辑，建议结合 <code>useReducer</code> 或使用 Redux、Zustand 等状态库。</p>
<h2 data-id="heading-4">use-context-selector</h2>
<p><code>use-context-selector</code> 是一个 React 上下文（Context）优化库，它解决了 React 原生 <code>useContext</code> 在性能上的一个关键问题：当上下文值变化时，所有使用该上下文的组件都会重新渲染，即使它们只依赖上下文中的一小部分数据。</p>
<h3 data-id="heading-5">核心特性</h3>
<ol start="0">
<li><strong>选择性订阅</strong>：允许组件只订阅上下文中的特定部分数据</li>
<li><strong>精确更新</strong>：只有当下文中的选定部分变化时才会触发组件更新</li>
<li><strong>与原生Context API兼容</strong>：使用方式与React原生Context相似</li>
<li><strong>轻量级</strong>：体积小，对应用包大小影响小</li>
</ol>
<h3 data-id="heading-6">基本使用：</h3>
<p>App.tsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>
​
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./context'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CounterA</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/CounterA'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CounterB</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/CounterB'</span>;
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">CounterA</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">CounterB</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">MyProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
  );
}
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>context.tsx</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">'use client'</span>
​
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span>{ createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-context-selector'</span>;
​
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title function_">createContext</span>({} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyProvider</span>(<span class="hljs-params">{ children }: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> [countA, setCountA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [countB, setCountB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
​
  <span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-built_in">any</span> = {
    countA,
    setCountA,
    countB,
    setCountB,
  };
​
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{state}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">MyContext.Provider</span>&gt;</span></span>
  );
}
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MyContext</span>;
</code></pre>
<p>CounterA.tsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>
​
​
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useContextSelector, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-context-selector'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyContext</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../context'</span>;
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> countA = <span class="hljs-title function_">useContextSelector</span>(<span class="hljs-title class_">MyContext</span>, <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">countA</span>);
  <span class="hljs-keyword">const</span> setCountA = <span class="hljs-title function_">useContextSelector</span>(<span class="hljs-title class_">MyContext</span>, <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">setCountA</span>);
​
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt;
    <span class="hljs-title function_">setCountA</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s -<span class="hljs-number">1</span>);
​
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterA rendered'</span>);
​
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{new Date().getTime()}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Counter A: {countA}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span>
        Increment A
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterA</span>;
</code></pre>
<p>CounterB.tsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">'use client'</span>
​
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useContextSelector, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-context-selector'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyContext</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../context'</span>;
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> countB = <span class="hljs-title function_">useContextSelector</span>(<span class="hljs-title class_">MyContext</span>, <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">countB</span>);
  <span class="hljs-keyword">const</span> setCountB = <span class="hljs-title function_">useContextSelector</span>(<span class="hljs-title class_">MyContext</span>, <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">setCountB</span>);
​
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt;
    <span class="hljs-title function_">setCountB</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s -<span class="hljs-number">1</span>);
​
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterB rendered'</span>);
​
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span>
        Increment B
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{new Date().getTime()}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Counter B: {countB}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterB</span>;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘 AgentRun丨为什么应该把 LangChain 等框架部署到函数计算 AgentRun]]></title>    <link>https://juejin.cn/post/7597968460652904490</link>    <guid>https://juejin.cn/post/7597968460652904490</guid>    <pubDate>2026-01-22T09:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597968460652904490" data-draft-id="7597968460652740650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘 AgentRun丨为什么应该把 LangChain 等框架部署到函数计算 AgentRun"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T09:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘 AgentRun丨为什么应该把 LangChain 等框架部署到函数计算 AgentRun
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:39:01.000Z" title="Thu Jan 22 2026 09:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：江昱</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA4NjI4MzM4MQ%3D%3D%26mid%3D2660257517%26idx%3D1%26sn%3D050bc317ac020aec7b848f9531af8da6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA4NjI4MzM4MQ==&amp;mid=2660257517&amp;idx=1&amp;sn=050bc317ac020aec7b848f9531af8da6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云函数计算 AgentRun 全新发布后</a>，我们整理了“探秘 AgentRun”系列文章，本系列将梳理企业落地 Agent 常见难题，给出具体解法，助力 Agentic AI 快速走进生产级环境。<strong>欢迎加入“函数计算 AgentRun 客户群”与我们交流，钉钉群号：</strong> <em><strong>134570017218</strong></em> <strong>。</strong></p>
<p>当你已经用 LangChain、AgentScope、LangGraph 等框架开发了 Agent 应用，如何让它们享受函数计算 AgentRun 提供的 <strong>Serverless 运行时、企业级 Sandbox、模型高可用、全链路可观测</strong>等能力？好消息是，<strong>你几乎不需要改动现有代码，只需要简单的适配就可以迁移到函数计算 AgentRun。</strong></p>
<p>这篇文章将通过真实的代码示例，展示如何将不同框架的 Agent 应用部署到函数计算 AgentRun 上，以及如何充分利用函数计算 AgentRun 的各种能力。</p>
<h2 data-id="heading-0">为什么要部署到函数计算 AgentRun？</h2>
<p>在讨论具体的集成方案前，让我们先明确一个问题：<strong>如果你的 Agent 应用已经在本地或自建服务器上运行良好，为什么还要迁移到函数计算 AgentRun？</strong></p>
<p>答案很简单：<strong>从开发环境到生产环境，有一道巨大的鸿沟。</strong>  本地运行只需要考虑功能实现，但生产环境需要考虑性能、稳定性、成本、安全、可观测等一系列问题。函数计算 AgentRun 提供的不是又一个 Agent 框架，而是让你的 Agent 能够以企业级标准运行的完整基础设施。</p>
<p>具体来说，部署到函数计算 AgentRun 后，你能获得：零运维的 Serverless 运行时（自动扩缩容、按量付费），企业级的 Sandbox 环境（高性能、安全隔离），模型高可用保障（自动熔断、多模型 Fallback），全链路可观测（完整的 Trace、成本归因），以及统一的工具和 MCP 管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28629296dabb4c009e43c184c73031ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679540&amp;x-signature=kXr9OAfK9QYK3B2H3PZ5fzF5vzE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">快速上手：5 分钟部署你的第一个 LangChain Agent</h2>
<p>让我们从最流行的 LangChain 框架开始，通过一个完整的例子展示如何将 LangChain Agent 部署到函数计算 AgentRun。</p>
<h3 data-id="heading-2">第一步：安装 Serverless Devs</h3>
<p>函数计算 AgentRun 使用 Serverless Devs 作为部署工具。如果你有 Node.js 环境，一行命令即可安装：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> -g <span class="hljs-keyword">@serverless-devs</span>/s
</code></pre>
<h3 data-id="heading-3">第二步：创建项目</h3>
<p>使用脚手架快速创建项目（注意：需要 Python 3.10 及以上版本）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化模板</span>
s init agentrun-quick-start-langchain
<span class="hljs-comment"># 进入代码目录</span>
<span class="hljs-built_in">cd</span> agentrun-quick-start-langchain/code
<span class="hljs-comment"># 初始化虚拟环境并安装依赖</span>
uv venv &amp;&amp; uv pip install -r requirements.txt
</code></pre>
<h3 data-id="heading-4">第三步：配置认证信息</h3>
<p>通过环境变量（建议使用 .env 文件）配置你的 AgentRun 访问凭证：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">AGENTRUN_ACCESS_KEY_ID</span>=<span class="hljs-string">"your-access-key-id"</span>
export <span class="hljs-attr">AGENTRUN_ACCESS_KEY_SECRET</span>=<span class="hljs-string">"your-access-key-secret"</span>
export <span class="hljs-attr">AGENTRUN_ACCOUNT_ID</span>=<span class="hljs-string">"your-account-id"</span>
export <span class="hljs-attr">AGENTRUN_REGION</span>=<span class="hljs-string">"cn-hangzhou"</span>
</code></pre>
<h3 data-id="heading-5">第四步：理解集成方式</h3>
<p>这是最关键的部分。打开生成的代码，你会看到集成非常简单：</p>
<pre><code class="hljs language-ini" lang="ini">from agentrun.integration.langchain import model, sandbox_toolset
from agentrun.server import AgentRunServer
<span class="hljs-comment"># 使用 AgentRun 的模型（自动享受高可用、熔断等能力）</span>
<span class="hljs-attr">llm</span> = model(<span class="hljs-string">"&lt;your-model-name&gt;"</span>)
<span class="hljs-comment"># 使用 AgentRun 的 Sandbox 工具</span>
<span class="hljs-attr">tools</span> = sandbox_toolset(
    <span class="hljs-attr">template_name</span>=<span class="hljs-string">"&lt;your-sandbox-name&gt;"</span>,
    <span class="hljs-attr">template_type</span>=TemplateType.CODE_INTERPRETER,
    <span class="hljs-attr">sandbox_idle_timeout_seconds</span>=<span class="hljs-number">300</span>,
)
<span class="hljs-comment"># 创建 LangChain Agent（和原来的代码完全一样）</span>
<span class="hljs-attr">agent</span> = create_agent(
    <span class="hljs-attr">model</span>=llm,
    <span class="hljs-attr">tools</span>=tools,
    <span class="hljs-attr">system_prompt</span>=<span class="hljs-string">"你是一个智能助手"</span>
)
<span class="hljs-comment"># 定义调用函数</span>
def invoke_agent(request):
    <span class="hljs-attr">result</span> = agent.invoke({<span class="hljs-string">"messages"</span>: request.messages})
    return result<span class="hljs-section">["messages"]</span><span class="hljs-section">[-1]</span>.content
<span class="hljs-comment"># 启动 HTTP Server（提供 OpenAI 兼容的 API）</span>
AgentRunServer(<span class="hljs-attr">invoke_agent</span>=invoke_agent).start()
</code></pre>
<p>核心要点：</p>
<ul>
<li><code>model()</code> 函数返回的是 LangChain 可以直接使用的模型对象</li>
<li><code>sandbox_toolset()</code> 返回的是 LangChain Tools 列表</li>
<li>你的 Agent 创建代码<strong>完全不需要改动</strong></li>
<li><code>AgentRunServer</code> 自动处理 HTTP 请求，提供标准的 OpenAI API</li>
</ul>
<h3 data-id="heading-6">第五步：本地测试</h3>
<p>启动服务后，可以通过 HTTP 请求测试：</p>
<pre><code class="hljs language-json" lang="json">curl <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-punctuation">:</span><span class="hljs-number">9000</span>/v1/chat/completions \
  -X POST \
  -H <span class="hljs-string">"content-type: application/json"</span> \
  -d '<span class="hljs-punctuation">{</span><span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通过代码查询现在是几点?"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stream"</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>'
</code></pre>
<h3 data-id="heading-7">第六步：部署到生产环境</h3>
<p>项目中已经包含了 s.yaml 配置文件。你只需要修改其中的 role 字段为你的阿里云角色：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">role:</span> <span class="hljs-symbol">acs:</span>ram::{您的阿里云主账号 <span class="hljs-variable constant_">ID</span>}<span class="hljs-symbol">:role/</span>{您的阿里云角色名称}
</code></pre>
<p>配置部署密钥：</p>
<pre><code class="hljs language-csharp" lang="csharp">s config <span class="hljs-keyword">add</span>
<span class="hljs-meta"># 按照引导输入 Access Key ID 和 Secret，记住密钥对名称（如 agentrun-deploy）</span>
</code></pre>
<p>执行部署：</p>
<pre><code class="hljs language-css" lang="css">s deploy -<span class="hljs-selector-tag">a</span> agentrun-deploy
</code></pre>
<p>部署完成后，你会得到一个 HTTPS URL，就可以在生产环境调用你的 Agent 了。</p>
<h2 data-id="heading-8">不同框架的集成案例</h2>
<p>函数计算 AgentRun 不仅支持 LangChain，还深度集成了主流的 Agent 开发框架。<strong>所有框架都遵循同样的理念：通过简单的适配层，让你的代码无缝迁移到函数计算 AgentRun，享受企业级能力。</strong></p>
<h3 data-id="heading-9">LangGraph：工作流编排</h3>
<p>LangGraph 是 LangChain 团队推出的工作流编排框架，适合构建复杂的多步骤 Agent。集成方式和 LangChain 类似：</p>
<pre><code class="hljs language-ini" lang="ini">from agentrun.integration.langgraph import model, tools
from langgraph.graph import StateGraph, MessagesState
from langgraph.prebuilt import ToolNode
<span class="hljs-comment"># 使用 AgentRun 的模型和工具</span>
<span class="hljs-attr">llm</span> = model(<span class="hljs-string">"&lt;your-model-name&gt;"</span>).to_langgraph()
<span class="hljs-attr">agent_tools</span> = tools()
<span class="hljs-comment"># 构建 LangGraph 工作流（和原来的代码一样）</span>
def call_model(state: MessagesState):
    <span class="hljs-attr">messages</span> = state[<span class="hljs-string">"messages"</span>]
    <span class="hljs-attr">response</span> = llm.invoke(messages)
    return {"messages": <span class="hljs-section">[response]</span>}
<span class="hljs-attr">workflow</span> = StateGraph(MessagesState)
workflow.add_node("agent", call_model)
workflow.add_node("tools", ToolNode(agent_tools))
workflow.set_entry_point("agent")
<span class="hljs-comment"># 定义条件边...</span>
<span class="hljs-attr">app</span> = workflow.compile()
<span class="hljs-comment"># 调用</span>
<span class="hljs-attr">result</span> = app.invoke({<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"查询上海天气"</span>)]})
</code></pre>
<p><strong>LangGraph 的优势</strong>是可以精确控制 Agent 的执行流程，比如条件分支、循环、并行执行等。部署到函数计算 AgentRun 后，这些复杂的工作流都能自动享受弹性伸缩和可观测能力。</p>
<h3 data-id="heading-10">AgentScope：多智能体协作</h3>
<p>AgentScope 是阿里达摩院开源的多智能体框架，特别适合构建多 Agent 协作场景。集成方式：</p>
<pre><code class="hljs language-ini" lang="ini">from agentrun.integration.agentscope import model, tools
from agentscope.agent import ReActAgent
from agentscope.tool import Toolkit
<span class="hljs-comment"># 使用 AgentRun 的模型和工具</span>
<span class="hljs-attr">llm</span> = model(<span class="hljs-string">"&lt;your-model-name&gt;"</span>).to_agentscope()
<span class="hljs-attr">agent_tools</span> = tools()
<span class="hljs-comment"># 注册工具到 Toolkit</span>
<span class="hljs-attr">toolkit</span> = Toolkit()
for tool in agent_tools:
    toolkit.register_tool_function(tool)
<span class="hljs-comment"># 创建 Agent（和原来的代码一样）</span>
<span class="hljs-attr">agent</span> = ReActAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"assistant"</span>,
    <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"你是一个智能助手"</span>,
    <span class="hljs-attr">model</span>=llm,
    <span class="hljs-attr">toolkit</span>=toolkit,
)
<span class="hljs-comment"># 调用</span>
<span class="hljs-attr">result</span> = await agent.reply(Msg(name=<span class="hljs-string">"user"</span>, content=<span class="hljs-string">"查询上海天气"</span>, role=<span class="hljs-string">"user"</span>))
</code></pre>
<p><strong>AgentScope 的优势</strong>是对多 Agent 系统的原生支持，包括 Agent 之间的通信、协调、记忆共享等。部署到函数计算 AgentRun 后，每个 Agent 都在独立的隔离环境中运行，确保安全性。</p>
<h3 data-id="heading-11">PydanticAI：类型安全的 Agent 框架</h3>
<p>PydanticAI 是一个新兴框架，强调类型安全和结构化输出。集成方式：</p>
<pre><code class="hljs language-ini" lang="ini">from agentrun.integration.pydantic_ai import model, tools
from pydantic_ai import Agent
<span class="hljs-comment"># 使用 AgentRun 的模型和工具</span>
<span class="hljs-attr">llm</span> = model(<span class="hljs-string">"&lt;your-model-name&gt;"</span>).to_pydantic_ai()
<span class="hljs-attr">agent_tools</span> = tools()
<span class="hljs-comment"># 创建 Agent</span>
<span class="hljs-attr">agent</span> = Agent(
    llm,
    <span class="hljs-attr">instructions</span>=<span class="hljs-string">"Be concise, reply with one sentence."</span>,
    <span class="hljs-attr">tools</span>=agent_tools,
)
<span class="hljs-comment"># 同步调用</span>
<span class="hljs-attr">result</span> = agent.run_sync(<span class="hljs-string">"上海的天气如何？"</span>)
<span class="hljs-comment"># 异步调用</span>
<span class="hljs-attr">result</span> = await agent.run(<span class="hljs-string">"上海的天气如何？"</span>)
</code></pre>
<p><strong>PydanticAI 的优势</strong>是强类型和结构化输出，特别适合需要严格数据验证的企业场景。</p>
<h2 data-id="heading-12">充分利用函数计算 AgentRun 的核心能力</h2>
<p>将 Agent 部署到函数计算 AgentRun 后，你不仅获得了 Serverless 运行环境，还可以深度利用平台提供的各种企业级能力。</p>
<h3 data-id="heading-13">模型高可用：告别单点故障（搭配 AI 网关）</h3>
<p>部署到函数计算 AgentRun 后，你的 Agent 自动享受模型高可用能力。当你配置的主模型出现故障、限流或超时时，系统会自动切换到备用模型，整个过程对你的代码完全透明。<br/>
在函数计算 AgentRun 控制台配置模型时可以和 AI 网关进行联动，可以设置：主模型（如 GPT-4），备用模型列表（如 Claude-3、Qwen-Max），熔断策略（错误率阈值、超时时间），负载均衡策略（轮询、权重、最少连接）。<br/>
你的代码完全不需要改动，只需要在创建模型时使用函数计算 AgentRun 的模型名称，所有的容错、切换、负载均衡都由平台自动处理。</p>
<h3 data-id="heading-14">企业级 Sandbox：安全执行代码</h3>
<p>函数计算 AgentRun 提供的 Sandbox 不是简单的代码执行环境，而是<strong>企业级的安全隔离沙箱</strong>。每个 Sandbox 实例都是独立隔离的，支持多种执行类型：</p>
<p>Code Interpreter 支持 Python、Node.js、Java、Bash 等语言，可以执行数据分析、文件处理等任务。Browser Tool 提供浏览器自动化能力，支持网页爬取、表单填写、截图等操作。All In One 集成了代码解释器和浏览器工具，提供更丰富的交互能力。</p>
<p>使用时，通过 sandbox_toolset() 函数就可以获取相应的工具集合，这些工具会自动转换为你使用的框架所需的格式。</p>
<h3 data-id="heading-15">工具和 MCP：标准化集成</h3>
<p>函数计算 AgentRun 提供统一的工具管理和 MCP（Model Context Protocol）机制。你可以从工具市场选择现成的工具，也可以自定义工具并发布到市场。</p>
<p>更强大的是 <strong>MCP 的 Hook 机制</strong>。通过前置 Hook，可以在工具调用前自动注入用户凭证、记录请求日志、校验参数合法性。通过后置 Hook，可以对结果进行转换、记录审计日志、处理异常情况。这些通用逻辑不需要在每个工具中重复实现，大大提升了开发效率。</p>
<h3 data-id="heading-16">全链路可观测：不再是黑盒</h3>
<p>这是函数计算 AgentRun 最强大的能力之一。<strong>你的代码不需要做任何改动，平台会自动记录 Agent 的完整执行链路</strong>。</p>
<p>在可观测平台上，你可以看到：Agent 接收到用户请求的时间和内容，调用了哪个模型、使用了多少 Token、花费了多少钱，调用了哪些工具、每个工具的执行时间和结果，访问了哪些知识库、检索了多少数据，每个环节的耗时分布，完整的调用链 Trace。</p>
<p><strong>这些能力都是平台自动提供的</strong>，通过探针注入实现，无论是高代码还是低代码创建的 Agent，都自动享受这些可观测能力。</p>
<h3 data-id="heading-17">记忆和知识库：数据不出域</h3>
<p>函数计算 AgentRun 深度集成了 RAGFlow、Mem0 等开源项目，提供灵活的记忆和知识库管理。你可以选择一键托管模式，由平台统一管理部署运维，享受 Serverless 的弹性和按量付费优势。也可以选择绑定模式，将 Agent 连接到已经部署在企业 VPC 或 IDC 内的实例，<strong>数据完全不出企业内网</strong>。</p>
<p>这种灵活性让你可以根据数据的敏感级别选择不同的策略：核心业务数据私有化部署，一般数据托管上云，在安全性和便利性之间找到最佳平衡。</p>
<h2 data-id="heading-18">立即体验函数计算 AgentRun</h2>
<p>函数计算 AgentRun 的无代码到高代码演进能力，现已开放体验：</p>
<ol>
<li><strong>快速创建：</strong> 访问控制台（ <a href="https://link.juejin.cn?target=https%3A%2F%2Ffunctionai.console.aliyun.com%2Fcn-hangzhou%2Fagent%2Fexplore" target="_blank" title="https://functionai.console.aliyun.com/cn-hangzhou/agent/explore" ref="nofollow noopener noreferrer">functionai.console.aliyun.com/cn-hangzhou…</a> ），60 秒创建你的第一个 Agent</li>
<li><strong>深度定制：</strong> 当需要更复杂功能时，一键转换为高代码</li>
<li><strong>持续演进：</strong> 利用函数计算 AgentRun 的基础设施能力，持续优化你的 Agent</li>
</ol>
<p>从想法到上线，从原型到生产，函数计算 AgentRun 始终是你最好的伙伴。<strong>欢迎加入“函数计算 AgentRun 客户群”，钉钉群号：134570017218。</strong></p>
<p><strong>快速了解函数计算 AgentRun：</strong></p>
<p>一句话介绍：函数计算 AgentRun 是一个以高代码为核心的一站式 Agentic AI 基础设施平台。秉持生态开放和灵活组装的理念，为企业级 Agent 应用提供从开发、部署到运维的全生命周期管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f586669a8a2747f785968a3ce72cfa3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769679540&amp;x-signature=bJfpq24P5Z5C0UQjyuIa3JFimSk%3D" alt="图片" loading="lazy"/></p>
<p><em>函数计算 AgentRun 架构图</em></p>
<p>AgentRun 运行时基于阿里云函数计算 FC 构建，继承了 Serverless 计算极致弹性、按量付费、零运维的核心优势。通过深度集成 AgentScope、LangChain、RAGFlow、Mem0 等主流开源生态。函数计算 AgentRun 将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，<strong>平均 TCO 降低 60%</strong> 。 </p>
<p><strong>让</strong> <strong>开发者只需专注于 Agent 的业务逻辑创新，无需关心底层基础设施，</strong> <strong>让 Agentic AI 真正进入企业生产环境。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kred离线阅读指南：无网也能畅读，告别流量焦虑]]></title>    <link>https://juejin.cn/post/7597805826514944046</link>    <guid>https://juejin.cn/post/7597805826514944046</guid>    <pubDate>2026-01-22T09:49:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597805826514944046" data-draft-id="7597805826514927662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kred离线阅读指南：无网也能畅读，告别流量焦虑"/> <meta itemprop="keywords" content="APP"/> <meta itemprop="datePublished" content="2026-01-22T09:49:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="解压专家666"/> <meta itemprop="url" content="https://juejin.cn/user/182988827802756"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kred离线阅读指南：无网也能畅读，告别流量焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/182988827802756/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    解压专家666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:49:06.000Z" title="Thu Jan 22 2026 09:49:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>高铁上信号断断续续，想读缓存的漫画却打不开？出差住酒店WiFi卡顿，下载电子书耗时耗流量？户外露营没网络，想续读小说只能对着空白屏幕？对多数读者来说，“无网场景”的阅读体验，往往是考验阅读器的关键。Kred阅读器以“离线优先”为核心设计，从资源存储、格式兼容到功能体验，全方位适配无网环境，让每一次出行都能随身带满“精神食粮”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce764b2fb8ea4fe891c00f509b745812~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej5Y6L5LiT5a62NjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680145&amp;x-signature=gNaG98%2BsSWenOdAK%2F%2BJdIkxBVv8%3D" alt="图片" loading="lazy"/></p>
<p>不同于依赖云端加载、无网即“罢工”的阅读器，Kred坚持本地资源优先，无需联网也能解锁全部核心功能，完美适配通勤、出差、户外等多元无网场景，彻底告别流量焦虑与网络依赖。</p>
<h3 data-id="heading-0"><strong>1. 全格式离线兼容，缓存资源零障碍</strong></h3>
<p>Kred支持所有主流阅读格式的离线读取，无需联网验证或加载插件。提前缓存的EPUB小说、MOBI电子书、CBZ漫画、PDF文献，哪怕断开网络，也能一键打开流畅阅读，排版、画质不受任何影响。更省心的是，离线状态下仍能直接读取压缩包资源，加密压缩包输入密码即可解锁，不用提前解压占用存储空间，囤货党可放心批量缓存，无网时也能随心切换内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/609893906d9b4580944107cdc86b32d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej5Y6L5LiT5a62NjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680145&amp;x-signature=lxm%2FMTWN9NF%2BtHFtTd0ZqHu9xyk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1"><strong>2. 离线书架管理，资源整理不依赖网络</strong></h3>
<p>无网状态下，Kred的书架管理功能依旧正常可用。可以新建自定义书架，将离线资源按“题材”“状态”分类归档；支持批量移动、删除资源，优化书架布局；关键词搜索功能也能离线使用，输入书名就能快速定位缓存内容，哪怕缓存了上百本资源，也能精准找到想读的那本，不用在杂乱的文件列表里翻找。</p>
<h3 data-id="heading-2"><strong>3. 离线批注与进度保存，阅读体验不打折</strong></h3>
<p>很多阅读器离线时会限制批注、进度同步功能，而Kred完全打破这一局限。无网状态下阅读PDF，哪怕中途断网，再次打开仍能精准续读，不会丢失任何阅读痕迹。对学生党、职场人来说，出差途中离线标注文献、整理笔记，效率完全不受影响。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e0b4d76a3a4a97ada2bd488655f6e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Kej5Y6L5LiT5a62NjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680145&amp;x-signature=4CIodmVFPcVRFBIxMXd%2B9rjD0a4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3"><strong>4. 离线传输备份，无网也能互通资源</strong></h3>
<p>即便没有网络，也能通过Kred的离线传输功能同步资源。同一局域网内（如高铁WiFi、露营热点），可通过WiFi传输功能，在两台设备间批量互传离线资源，无需消耗流量；提前备份到本地的资源包，离线状态下也能导入书架，避免因网络问题导致资源丢失，让多设备间的资源互通不受网络限制。</p>
<p>阅读的本质，本就该不受时间、空间与网络的束缚。Kred的离线阅读能力，不仅是功能上的补充，更是对“随时随地阅读”需求的精准适配——它让你提前备好的每一份资源，都能在无网时发挥价值，让碎片时间、出行时光都能被阅读填满。</p>
<p>如果你经常在无网场景下阅读，被网络卡顿、流量消耗等问题困扰，不妨试试Kred，把喜欢的内容提前缓存，解锁无拘无束的离线阅读体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云可观测 2025 年 12 月产品动态]]></title>    <link>https://juejin.cn/post/7598005428259029055</link>    <guid>https://juejin.cn/post/7598005428259029055</guid>    <pubDate>2026-01-22T09:52:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428259029055" data-draft-id="7598003935425282091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云可观测 2025 年 12 月产品动态"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-22T09:52:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云可观测 2025 年 12 月产品动态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:52:58.000Z" title="Thu Jan 22 2026 09:52:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本月可观测热文回顾</h2>
<p><strong>文章一览：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580174%26idx%3D1%26sn%3Ddf8ad313c69dd0157057a46b81c7ab40%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580174&amp;idx=1&amp;sn=df8ad313c69dd0157057a46b81c7ab40&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">构建数据资产“导航地图”：详解 UModel 数据发现与全链路分析能力</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580386%26idx%3D1%26sn%3D60829abde772d4544cf2d66c1a7b81a7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580386&amp;idx=1&amp;sn=60829abde772d4544cf2d66c1a7b81a7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 UModel 高效构建可观测场景统一实体搜索引擎</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580410%26idx%3D1%26sn%3D7b0844c16409f181dfa9bda8a6ffa98c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580410&amp;idx=1&amp;sn=7b0844c16409f181dfa9bda8a6ffa98c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">揭开 Java 容器“消失的内存”之谜：云监控 2.0 SysOM 诊断实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580519%26idx%3D1%26sn%3D55eaeb6070a70e57057891950e4930d1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580519&amp;idx=1&amp;sn=55eaeb6070a70e57057891950e4930d1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580582%26idx%3D1%26sn%3Daf7e34aa68b4d70079104a9c8991ca39%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580582&amp;idx=1&amp;sn=af7e34aa68b4d70079104a9c8991ca39&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文带你玩转 WebSocket 全链路可观测</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580687%26idx%3D1%26sn%3D2d72f037ad318cf7cfa1a32040be767d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580687&amp;idx=1&amp;sn=2d72f037ad318cf7cfa1a32040be767d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Android 崩溃监控实战：一次完整的生产环境崩溃排查全流程</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580870%26idx%3D1%26sn%3Df7c80d0201abf479e92f99e831ec7a92%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580870&amp;idx=1&amp;sn=f7c80d0201abf479e92f99e831ec7a92&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">已上线！云监控 2.0 面向实体的全链路日志审计与风险溯源</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580955%26idx%3D1%26sn%3D239cab68b4ee62c0c85a645ce2c70638%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580955&amp;idx=1&amp;sn=239cab68b4ee62c0c85a645ce2c70638&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云操作系统控制台一招解决网络丢包</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581032%26idx%3D2%26sn%3Ded70d3784acebd6024cd05658842657c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581032&amp;idx=2&amp;sn=ed70d3784acebd6024cd05658842657c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">加入我们，一起定义「Data x AI」的未来</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581032%26idx%3D1%26sn%3D4bf685b8875082dd060ac2c7f9174ab5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581032&amp;idx=1&amp;sn=4bf685b8875082dd060ac2c7f9174ab5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">iOS 崩溃排查不再靠猜！这份分层捕获指南请收好</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581118%26idx%3D1%26sn%3Db5844bf40ecb1b008d070b7b7d5e79ea%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581118&amp;idx=1&amp;sn=b5844bf40ecb1b008d070b7b7d5e79ea&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">跨云日志统一：对象存储数据导入 SLS 的智能之路</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581191%26idx%3D1%26sn%3Dfede8aee629b09009f508488f5683584%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581191&amp;idx=1&amp;sn=fede8aee629b09009f508488f5683584&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">拒绝查询超时：一次真实高并发场景下的 SLS 物化视图调优实战</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581261%26idx%3D1%26sn%3D428d24059141cab34cb3705cb54da2e7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581261&amp;idx=1&amp;sn=428d24059141cab34cb3705cb54da2e7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云可观测联合 Datadog 发布 OpenTelemetry Go 自动插桩工具</a></p>
<h2 data-id="heading-1">功能快报</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60bd4ca795b14239ba63313b0b0cfe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680378&amp;x-signature=MhC4UUFGX02h9uQv%2B9SHGsEnmAw%3D" alt="image.png" loading="lazy"/></p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">此处</a>，了解更多产品详情。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新升级的专业编程显示器，用上啦，体验感超好！]]></title>    <link>https://juejin.cn/post/7598005428259045439</link>    <guid>https://juejin.cn/post/7598005428259045439</guid>    <pubDate>2026-01-22T09:56:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598005428259045439" data-draft-id="7596997542042370091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新升级的专业编程显示器，用上啦，体验感超好！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T09:56:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端双越老师"/> <meta itemprop="url" content="https://juejin.cn/user/1714893868765373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新升级的专业编程显示器，用上啦，体验感超好！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893868765373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端双越老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T09:56:27.000Z" title="Thu Jan 22 2026 09:56:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开始</h2>
<p>2026 年是我作为自由职业者的第 6 年了，时间过的很快。</p>
<p>既然自由职业，自己给自己买办公设备，不是公司免费给配，当然要买质量好的。</p>
<p>对于程序员来说，无非就是电脑和显示器。电脑我一直用着 macbook pro 非常稳定。</p>
<p>显示器的话，我之前一直在用明基的专业编程显示器RD280U，最近明基还出了新升级的RD280UG，体验下来感觉真是越来越懂我们程序员了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8387fb1fa5f64cefa4c8e3f60fb259ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=%2Fb5SPD9sjwUKEfJw9fwAMDZgeyo%3D" alt="wechat_2026-01-12_172415_447.png" loading="lazy"/></p>
<h2 data-id="heading-1">初印象</h2>
<p>开箱组装了以后，和电脑连接起来。我 macbook pro 是 16 寸的屏幕，和这个显示器看起来很搭配。</p>
<p>它的支架和高度也很合适，正好匹配我的电脑，能让我工作时一直抬着头，保护我脆弱的颈椎。</p>
<p>它的支架上有一个皮质的卡扣，这样我可以把电源线绑在里面，对于我这种强迫症患者简直太好了，我所有的线都要绑起来，不能乱着。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16ac6124e2d14bb8a5bce62e35ce534d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=ucAvM%2BkxQi%2FVZNT0rEUkw%2Flvem4%3D" alt="image.png" loading="lazy"/></p>
<p>这款显示器依然是 RD 系列原有的 3:2 的比例，实际用起来非常合理。</p>
<p>因为它会比宽屏更适合编程，能看到更多代码，无论是在中间的主代码区域，还是右侧的 AI 对话区域，都能看到更多内容。不用滚动翻页，既对眼睛友好，又加快了开发效率。</p>
<h2 data-id="heading-2">新功能</h2>
<p>BENQ RD 系列本来就是一款优秀的专业编程显示器， 2026 最新款又增加了诸多新功能。</p>
<h3 data-id="heading-3">120Hz 高刷升级</h3>
<p>作为一名程序员，我对这款专业编程显示器升级到 <strong>120Hz 高刷新率</strong> 的感受非常直观。在日常编码中，无论是高速滚动代码、切换文件，还是浏览长文档，画面都明显更顺滑，行间跳动感大幅降低，眼睛更放松。调试时频繁上下定位代码、查看日志，120Hz 带来的连续感让注意力更集中，不容易产生视觉疲劳。即使长时间面对屏幕，也能感受到更稳定、更“跟手”的交互体验。对程序员而言，高刷不只是为游戏服务，而是真正提升了开发效率与舒适度的一次升级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ed6522e9ba407782a53be6f453b58e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=%2BVCKH2nvDyooIWHnYDyC40%2BH5Ds%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">彩纸模式</h3>
<p>之前我最喜欢280U的一个功能就是编程色彩模式，打开之后代码能明显清晰特别多，可以通过智 能 优 化 语 法 ⾼ 亮 ， 对 多 种 代 码 元 素 进 ⾏ ⾊ 温 ， ⾊ 彩 ， 对 ⽐ 度 的 专 项 优 化 ， 凸 显 代 码 字 符 清 晰 度 ， 提 ⾼ 代 码 区 分 度 ， 帮 助 开 发 者 更 快 速 识 别 代 码 结 构 ， 降 低 b u g 遗 漏 风 险 ， 看起来很舒服也很沉浸，而且还按照背景颜色分了主题，黑色背景用深色主题，白色背景就用亮色主题。让我很惊喜的是，在之前的基础上，2026 新款新增了一个色彩模式：彩纸模式，这样让ide的画布能更接近纸的质感，同时还能保留语法高亮的色彩效果，眼睛能更舒服，代码的结构细节也特别清楚 。我觉得这是目前最适合编程的一种模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84bec4bf66e54cbc984e48e5a0c7dc14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=uNg8aoOIly%2BhU1RvcPuDV3OYRjM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">Display Pilot2 支持 Linux 系统</h3>
<p>BENQ 为他们的显示器开发的控制软件 display pilot2 已经升级到 v2 版本，之前支持 windows mac，现在已经支持 Linux 操作系统了。为众多 Linux 用户提供了专业编程显示器。</p>
<p>你可以下载安装，用它来控制所有编辑器的功能，快捷方便。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ba1c8f8a6084a5c86bb13d06556d363~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=E27951zSrWLmyKq4I61qrmzstak%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">代码清晰度</h2>
<p>咱们公司里配的普通显示器，显示质感非常粗糙，不清晰，细节有锯齿，色彩对比度很差。工作一天下来，眼睛特别难受。所以我之前工作的时候，会尽量用 macbook 编程，虽然屏幕小，但苹果的显示效果还可以。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31281ef9febf4b8ea45301572bf7d3e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=OclcUUCb6%2F%2F%2FZBe5LVF5jGkuyQU%3D" alt="image.png" loading="lazy"/></p>
<p>但 BENQ 这款显示器，它是 4k 超高清、120Hz高刷升级，显示清晰，没有锯齿，色彩还原度高，显示效果几乎等于 macbook pro 电脑的显示器，果然贵是贵的道理。但显示器是我们天天工作、加班都需要一直面对的东西，还是质量优先、体验有限。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98dd8f88cb094d9cbcb16a61547c3c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=ojOJn62q4n%2BhTHSFBkMVnzxE24M%3D" alt="image.png" loading="lazy"/></p>
<p>既然是专业编程显示器，它可以设置多种色彩模式，还新推出了“彩纸”模式，增加代码显示的对比度，让你更容易的看到代码的结构和细节，尤其在 debug 截断非常有用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a3fd408ccb4e3ebdb4832d73e44d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=rkZf%2BMiM0BcFWAWoFN4AqlCMmZQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>抗反射面板</strong></h2>
<p>团队的 leader 或架构师，都喜欢把自己安排到靠窗户的工位，这里隐私好、视野好、通风好。</p>
<p>但只有一个缺点，有太阳的时候，照在屏幕上反光，非常难受，尤其当你需要认真工作时。</p>
<p>普通显示器，包括我的 macbook 显示器，反光非常明显，几乎半个屏幕都看不到了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ab4fb56cdd4f47b124c273e52c9a6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=1gIUbBWlcS%2BRPK476PFQ5mx4e7Y%3D" alt="image.png" loading="lazy"/></p>
<p>而 BENQ 这款显示器增加了抗反射涂层，几乎看不到光的反射，既可享受阳光又可专心工作。</p>
<p>这个特性，相信靠窗工位的 leader 或架构师们会非常喜欢。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc7401f8cc042a487f2f83d9241d832~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=YiAdL94TAg8KlBj275Ucd68YizY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">黑夜模式</h2>
<p>程序员加班到深夜这是家常便饭，也是我们打工人无法改变的现状。但到了晚上，如果你的眼睛视觉还维持在一个比较亮的显示状态，这会严重影响你的生物钟，是你失眠的主要原因之一。</p>
<p>BENQ 这款显示器有夜间保护功能，开启自动切换它会在晚上降低屏幕亮度，开启猫头鹰模式。即便是加班，也会尽量降低你眼睛的疲劳感，既护眼，又有利于睡眠。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39ea78a0778142e5b3d1420d5a4bc131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=5VqMpQYk5oyCbY80QA0OuTx521w%3D" alt="image.png" loading="lazy"/></p>
<p>不管是自由职业者，还是下班在家编程，一个人在自己的小屋里，把灯关上或调暗，再打开这款显示器的智慧光环功能，就能进入一个全新的编程氛围中，这种背后有光的感觉，会特别容易集中注意力，激发创作灵感，大大提升晚上的工作效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9622341d4b604ab3a98352fc74e1520d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769680587&amp;x-signature=8Gdcj%2BJYDrw4TRocq4K3ZJRFLaY%3D" alt="wechat_2026-01-12_173734_790.png" loading="lazy"/></p>
<h2 data-id="heading-9">其他</h2>
<p>它还支持多设备切换：支持两套主机链接一个显示设备 KVM ，还支持一套键盘鼠标控制两台显示器设备 MST ，还支持画中画。主要解决的是多主机用户，需要转换器多个接口的需求。程序员可能暂时没这个需求。</p>
<h2 data-id="heading-10">总结</h2>
<p>用了 RD280UG 这段时间之后，发现它和老款相比，越来越懂程序员的需求了。120Hz高刷让界面的滚动更顺滑自然，彩纸模式让代码界面显示更舒服更沉浸式，Display Pilot2软件层面也支持更完善的操作系统。真正的专业编程显示器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>