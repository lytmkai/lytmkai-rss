<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[基于Java 实现 PPT 到 PDF 的高效转换]]></title>    <link>https://juejin.cn/post/7572141912498749449</link>    <guid>https://juejin.cn/post/7572141912498749449</guid>    <pubDate>2025-11-14T05:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572141912498749449" data-draft-id="7572141912498634761" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Java 实现 PPT 到 PDF 的高效转换"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-14T05:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="咕白m625"/> <meta itemprop="url" content="https://juejin.cn/user/775609987638480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Java 实现 PPT 到 PDF 的高效转换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/775609987638480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    咕白m625
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:55:50.000Z" title="Fri Nov 14 2025 05:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，经常会遇到将PPT文档批量或单文件转换为PDF的需求—PDF格式因其跨平台一致性、不可轻易篡改的特性，成为文档分发与归档的首选格式。Spire.Presentation for Java 作为一款轻量级且功能稳定的 PPT 处理组件，无需依赖 Microsoft Office 环境，即可快速实现 PowerPoint（.ppt/.pptx）到 PDF 的转换，同时支持对转换过程的灵活配置。本文将详细介绍其使用流程、核心代码与常见问题解决方案。</p>
<h2 data-id="heading-0">一、环境配置</h2>
<p>首先需要在项目中添加 Spire.Presentation for Java 的依赖：</p>
<h3 data-id="heading-1">Maven 配置</h3>
<p>在项目的<code>pom.xml</code>文件中添加如下仓库与依赖配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>com.e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.e-iceblue.com/nexus/content/groups/public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spire.presentation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>10.10.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">Gradle 配置：</h3>
<pre><code class="hljs language-arduino" lang="arduino">implementation <span class="hljs-string">'e-iceblue:spire.presentation:10.10.2@jar'</span>
</code></pre>
<h2 data-id="heading-3">二、核心实现：3步完成PPT转PDF</h2>
<p>Spire.Presentation的API设计简洁，核心转换逻辑仅需3个关键步骤：<strong>加载PPT文件</strong> → <strong>执行转换操作</strong> → <strong>释放资源</strong>。以下分别介绍单文件转换、批量转换的实现方案，并提供完整可运行代码。</p>
<h3 data-id="heading-4">1. 单文件转换（基础版）</h3>
<p>适用于仅需转换单个PPT文件的场景，支持<code>.ppt</code>和<code>.pptx</code>两种格式，转换后自动保持原PPT的版式、图片、文字样式。</p>
<h4 data-id="heading-5">完整代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.presentation.Presentation;
<span class="hljs-keyword">import</span> com.spire.presentation.FileFormat;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PptToPdfSingle</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 定义PPT输入路径与PDF输出路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">pptInputPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"D:\Documents\示例演示文稿.pptx"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pdfOutputPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"D:\Documents\示例演示文稿_转换后.pdf"</span>;

        <span class="hljs-type">Presentation</span> <span class="hljs-variable">presentation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 创建Presentation对象，加载PPT文件</span>
            presentation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Presentation</span>();
            presentation.loadFromFile(pptInputPath);

            <span class="hljs-comment">// 3. 调用saveToFile方法转换为PDF，指定输出格式为FileFormat.PDF</span>
            presentation.saveToFile(pdfOutputPath, FileFormat.PDF);

            System.out.println(<span class="hljs-string">"PPT转PDF成功！输出路径："</span> + pdfOutputPath);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            System.out.println(<span class="hljs-string">"PPT转PDF失败："</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 关闭Presentation对象，释放内存资源</span>
            <span class="hljs-keyword">if</span> (presentation != <span class="hljs-literal">null</span>) {
                presentation.dispose();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">2. 批量转换（进阶版）</h3>
<p>若需转换某个文件夹下的所有PPT文件，可结合 <code>java.io</code> 包遍历文件夹，批量执行转换逻辑，提高效率。</p>
<h4 data-id="heading-7">完整代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.spire.presentation.Presentation;
<span class="hljs-keyword">import</span> com.spire.presentation.FileFormat;
<span class="hljs-keyword">import</span> java.io.File;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PptToPdfBatch</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 定义PPT文件夹路径与PDF输出文件夹路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">pptFolderPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"D:\Documents\PPT文件夹"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pdfOutputFolder</span> <span class="hljs-operator">=</span> <span class="hljs-string">"D:\Documents\PDF输出文件夹"</span>;

        <span class="hljs-comment">// 2. 检查输出文件夹，不存在则创建</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">outputFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pdfOutputFolder);
        <span class="hljs-keyword">if</span> (!outputFolder.exists()) {
            outputFolder.mkdirs();
        }

        <span class="hljs-comment">// 3. 遍历PPT文件夹，获取所有.ppt/.pptx文件</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">pptFolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pptFolderPath);
        File[] pptFiles = pptFolder.listFiles((dir, name) -&gt; {
            <span class="hljs-comment">// 过滤后缀为.ppt或.pptx的文件（不区分大小写）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">lowercaseName</span> <span class="hljs-operator">=</span> name.toLowerCase();
            <span class="hljs-keyword">return</span> lowercaseName.endsWith(<span class="hljs-string">".ppt"</span>) || lowercaseName.endsWith(<span class="hljs-string">".pptx"</span>);
        });

        <span class="hljs-comment">// 4. 批量转换每个PPT文件</span>
        <span class="hljs-keyword">if</span> (pptFiles != <span class="hljs-literal">null</span> &amp;&amp; pptFiles.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (File pptFile : pptFiles) {
                convertSinglePptToPdf(pptFile.getAbsolutePath(), pdfOutputFolder);
            }
            System.out.println(<span class="hljs-string">"批量转换完成！所有PDF已保存至："</span> + pdfOutputFolder);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"PPT文件夹中未找到.ppt/.pptx文件！"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 单个PPT转换为PDF的工具方法
     * <span class="hljs-doctag">@param</span> pptInputPath PPT文件绝对路径
     * <span class="hljs-doctag">@param</span> pdfOutputFolder PDF输出文件夹路径
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertSinglePptToPdf</span><span class="hljs-params">(String pptInputPath, String pdfOutputFolder)</span> {
        <span class="hljs-type">Presentation</span> <span class="hljs-variable">presentation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 加载PPT文件</span>
            presentation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Presentation</span>();
            presentation.loadFromFile(pptInputPath);

            <span class="hljs-comment">// 获取PPT文件名（不含后缀），作为PDF文件名</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">pptFileName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pptInputPath).getName();
            <span class="hljs-type">String</span> <span class="hljs-variable">pdfFileName</span> <span class="hljs-operator">=</span> pptFileName.substring(<span class="hljs-number">0</span>, pptFileName.lastIndexOf(<span class="hljs-string">"."</span>)) + <span class="hljs-string">".pdf"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">pdfOutputPath</span> <span class="hljs-operator">=</span> pdfOutputFolder + File.separator + pdfFileName;

            <span class="hljs-comment">// 转换为PDF</span>
            presentation.saveToFile(pdfOutputPath, FileFormat.PDF);
            System.out.println(<span class="hljs-string">"成功转换："</span> + pptFileName + <span class="hljs-string">" → "</span> + pdfFileName);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"转换失败："</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pptInputPath).getName() + <span class="hljs-string">"，原因："</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (presentation != <span class="hljs-literal">null</span>) {
                presentation.dispose();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-8">三、代码深度解析：关键类与方法</h2>
<p>理解核心API的作用，有助于根据实际需求扩展功能（如设置PDF权限、调整转换质量等）。</p>





























<table><thead><tr><th>类/方法</th><th>作用说明</th></tr></thead><tbody><tr><td><code>Presentation</code></td><td>Spire.Presentation 的核心类，用于加载、操作PPT文件，管理幻灯片内容与格式。</td></tr><tr><td><code>loadFromFile(String path)</code></td><td>加载指定路径的 PPT 文件（支持绝对路径与相对路径，相对路径基于项目根目录）。</td></tr><tr><td><code>saveToFile(String path, FileFormat format)</code></td><td>将 PPT 保存为指定格式的文件，<code>FileFormat.PDF</code> 表示输出为 PDF。</td></tr><tr><td><code>dispose()</code></td><td>释放 <code>Presentation</code> 对象占用的内存资源，避免频繁创建对象导致内存泄漏。</td></tr><tr><td><code>FileFormat</code></td><td>枚举类，包含 PPT 支持的输入/输出格式（如<code>PPT</code>、<code>PPTX</code>、<code>PDF</code> 等）。</td></tr></tbody></table>
<h2 data-id="heading-9">四、常见问题与解决方案</h2>
<p>在实际使用中，可能会遇到加载失败、格式错乱、中文乱码等问题，以下是高频问题的解决办法：</p>
<h3 data-id="heading-10">问题1：PPT 加载失败，报错“File not found”或“Unsupported file format”</h3>
<ul>
<li><strong>原因1</strong>：文件路径错误（如路径含中文但未处理编码，或路径拼写错误）；</li>
</ul>
<p><strong>解决</strong>：使用绝对路径，确保路径中无特殊字符；若路径含中文，在JDK 1.8及以上环境下通常无需额外处理，低版本可尝试将路径转换为UTF-8编码。</p>
<ul>
<li><strong>原因2</strong>：PPT文件损坏或格式不支持（如加密PPT、WPS特殊格式PPT）；</li>
</ul>
<p><strong>解决</strong>：先通过Office/WPS验证PPT是否能正常打开，加密文件需先解密再转换。</p>
<h3 data-id="heading-11">问题2：转换后的 PDF 页面空白或内容缺失</h3>
<ul>
<li><strong>原因1</strong>：PPT 中包含特殊元素（如动态图表、ActiveX 控件），Spire.Presentation 暂不支持渲染；</li>
</ul>
<p><strong>解决</strong>：将特殊元素转为静态图片（如在 Office 中复制图表→粘贴为“图片”）后再转换。</p>
<ul>
<li><strong>原因2</strong>：组件版本过低，存在兼容性BUG；</li>
</ul>
<p><strong>解决</strong>：升级至最新版本。</p>
<hr/>
<h2 data-id="heading-12">五、总结</h2>
<p>Spire.Presentation for Java 为 PPT 转 PDF 需求提供了轻量、高效的解决方案，核心优势在于：</p>
<ol>
<li><strong>无环境依赖</strong>：无需安装Office/WPS，降低部署复杂度；</li>
<li><strong>API简洁</strong>：3步即可完成转换，代码易读易维护；</li>
<li><strong>格式兼容性强</strong>：支持<code>.ppt</code>/<code>.pptx</code>全版本，转换后保持原文档版式；</li>
<li><strong>支持扩展</strong>：可进一步实现PDF加密（设置打开密码/权限）、PPT转图片等功能。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Vue 构建错误到深度解析：::v-deep 引发的 CSS 压缩危机]]></title>    <link>https://juejin.cn/post/7572190151351336960</link>    <guid>https://juejin.cn/post/7572190151351336960</guid>    <pubDate>2025-11-14T06:13:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572190151351336960" data-draft-id="7572141390857535488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Vue 构建错误到深度解析：::v-deep 引发的 CSS 压缩危机"/> <meta itemprop="keywords" content="CSS,前端工程化"/> <meta itemprop="datePublished" content="2025-11-14T06:13:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一川_"/> <meta itemprop="url" content="https://juejin.cn/user/2964722159722887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Vue 构建错误到深度解析：::v-deep 引发的 CSS 压缩危机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2964722159722887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一川_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T06:13:53.000Z" title="Fri Nov 14 2025 06:13:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在日常的前端开发中，我们经常会遇到各种构建错误，有些错误信息明确，容易定位；而有些则像迷宫一样，需要一步步排查。最近在开发一个 Vue 2 项目时，我就遇到了一个令人头疼的 CSS 压缩错误，经过多轮排查和尝试，最终找到了问题的根源和解决方案。本文将详细记录这个问题的排查过程，并深入分析相关的技术原理。</p>
<h2 data-id="heading-1">问题初现</h2>
<p>那是一个普通的开发日，我正在为一个生产工单管理系统添加新功能。在完成代码编写后，我像往常一样执行构建命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run build:prod
</code></pre>
<p>然而，控制台却报出了令人困惑的错误：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable constant_">ERROR</span> <span class="hljs-title class_">Error</span>: <span class="hljs-variable constant_">CSS</span> minification <span class="hljs-attr">error</span>: <span class="hljs-title class_">Cannot</span> read property <span class="hljs-string">'trim'</span> <span class="hljs-keyword">of</span> <span class="hljs-literal">undefined</span>. <span class="hljs-title class_">File</span>: <span class="hljs-keyword">static</span>/css/chunk-25fbebba.59b3af06.<span class="hljs-property">css</span>
<span class="hljs-title class_">Error</span>: <span class="hljs-variable constant_">CSS</span> minification <span class="hljs-attr">error</span>: <span class="hljs-title class_">Cannot</span> read property <span class="hljs-string">'trim'</span> <span class="hljs-keyword">of</span> <span class="hljs-literal">undefined</span>. <span class="hljs-title class_">File</span>: <span class="hljs-keyword">static</span>/css/chunk-25fbebba.59b3af06.<span class="hljs-property">css</span>
    at <span class="hljs-attr">C</span>:\<span class="hljs-title class_">Users</span>\wzh\<span class="hljs-title class_">Desktop</span>\<span class="hljs-title class_">BatchProductionWorkOrderReport</span>\node_modules<span class="hljs-meta">@intervolga</span>\optimize-cssnano-plugin\index.<span class="hljs-property">js</span>:<span class="hljs-number">106</span>:<span class="hljs-number">21</span>
</code></pre>
<h2 data-id="heading-2">第一阶段：常规排查</h2>
<h3 data-id="heading-3">尝试方案一：清除缓存和重新安装</h3>
<p>面对构建错误，我的第一反应是清除缓存和重新安装依赖，这是前端开发中的"万能药"：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清除 npm 缓存</span>
npm cache clean --force

<span class="hljs-comment"># 删除 node_modules 和 package-lock.json</span>
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 重新安装依赖</span>
npm install

<span class="hljs-comment"># 重新构建</span>
npm run build:prod
</code></pre>
<p>然而，这次"万能药"并没有奏效，同样的错误再次出现。</p>
<h3 data-id="heading-4">尝试方案二：更新相关依赖</h3>
<p>注意到控制台有一个警告："A new version of sass-loader is available"，我尝试更新相关依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新 sass-loader</span>
npm update sass-loader

<span class="hljs-comment"># 更新 Vue CLI 和相关构建工具</span>
npm update @vue/cli-service

<span class="hljs-comment"># 更新 CSS 相关插件</span>
npm update @intervolga/optimize-cssnano-plugin cssnano postcss
</code></pre>
<p>更新后重新构建，问题依旧。</p>
<h2 data-id="heading-5">第二阶段：深入分析</h2>
<h3 data-id="heading-6">错误信息分析</h3>
<p>仔细分析错误信息，有几个关键点：</p>
<ol>
<li><strong>错误位置</strong>：<code>@intervolga/optimize-cssnano-plugin/index.js:106:21</code></li>
<li><strong>错误类型</strong>：<code>Cannot read property 'trim' of undefined</code></li>
<li><strong>涉及文件</strong>：<code>chunk-25fbebba.59b3af06.css</code></li>
</ol>
<p>这表明问题出现在 CSS 压缩阶段，某个 CSS 内容在压缩时变成了 <code>undefined</code>。</p>
<h3 data-id="heading-7">代码审查</h3>
<p>我开始审查项目中最近修改的代码，重点关注样式部分。发现问题出现在一个使用了 <code>::v-deep</code> 的 Vue 组件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.workorder-table</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

::v-deep .el-table__body-wrapper {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}

::v-deep .el-table th {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3e9f3</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1f1f1f</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#c3c9d4</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}

::v-deep .el-table td {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">第三阶段：技术原理探究</h2>
<h3 data-id="heading-9">什么是 ::v-deep？</h3>
<p><code>::v-deep</code> 是 Vue.js 中用于样式穿透的伪类选择器。在 Vue 的 scoped CSS 中，样式默认只作用于当前组件，但有时候我们需要修改子组件的样式，这时就需要使用样式穿透。</p>
<h3 data-id="heading-10">Vue 2 和 Vue 3 中的差异</h3>
<p>在排查过程中，我发现不同 Vue 版本对深度选择器的支持有所不同：</p>
<p><strong>Vue 2 支持的形式：</strong></p>
<ul>
<li><code>&gt;&gt;&gt;</code></li>
<li><code>/deep/</code></li>
<li><code>::v-deep</code></li>
</ul>
<p><strong>Vue 3 支持的形式：</strong></p>
<ul>
<li><code>:deep()</code></li>
<li><code>::v-deep</code>（已弃用）</li>
</ul>
<h3 data-id="heading-11">构建过程中的 CSS 处理流程</h3>
<p>理解构建过程中 CSS 的处理流程对于解决问题至关重要：</p>
<ol>
<li><strong>Vue Loader 处理</strong>：Vue Loader 解析 <code>.vue</code> 文件中的 <code>&lt;style&gt;</code> 块</li>
<li><strong>CSS 预处理</strong>：如果使用了 Sass/Less，会进行相应的预处理</li>
<li><strong>PostCSS 处理</strong>：应用各种 PostCSS 插件，包括 scoped CSS 处理</li>
<li><strong>CSS 提取</strong>：将 CSS 从 JavaScript 中提取出来</li>
<li><strong>CSS 压缩</strong>：使用 cssnano 等工具进行压缩</li>
</ol>
<h3 data-id="heading-12">问题根源分析</h3>
<p>经过深入分析，我发现问题的根源在于：</p>
<ol>
<li><strong>版本兼容性问题</strong>：项目中使用的 <code>@intervolga/optimize-cssnano-plugin</code> 版本与当前的 Vue CLI 版本存在兼容性问题</li>
<li><strong>深度选择器解析</strong>：在某些情况下，<code>::v-deep</code> 在构建过程中可能被解析为空的 CSS 规则</li>
<li><strong>CSS 压缩异常</strong>：当遇到这些异常的 CSS 规则时，压缩插件无法正确处理，导致 <code>undefined</code> 错误</li>
</ol>
<h2 data-id="heading-13">第四阶段：解决方案尝试</h2>
<h3 data-id="heading-14">方案一：使用 /deep/ 替代 ::v-deep</h3>
<p>这是最直接的解决方案，将所有的 <code>::v-deep</code> 替换为 <code>/deep/</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.workorder-table</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

/deep/ <span class="hljs-selector-class">.el-table__body-wrapper</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}

/deep/ <span class="hljs-selector-class">.el-table</span> <span class="hljs-selector-tag">th</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3e9f3</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1f1f1f</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#c3c9d4</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}

/deep/ <span class="hljs-selector-class">.el-table</span> <span class="hljs-selector-tag">td</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>结果</strong>：构建成功！这是最快速的解决方案。</p>
<h3 data-id="heading-15">方案二：使用 CSS Modules</h3>
<p>为了更彻底地解决问题，我尝试了 CSS Modules 方案：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"workorder-page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"$style.workorderTable"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 表格内容 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">module</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.workorderTable</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">1400px</span>;
}

<span class="hljs-selector-class">.workorderTable</span> :<span class="hljs-built_in">global</span>(.el-table__body-wrapper) {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}

<span class="hljs-selector-class">.workorderTable</span> :<span class="hljs-built_in">global</span>(.el-table th) {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3e9f3</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1f1f1f</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#c3c9d4</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}

<span class="hljs-selector-class">.workorderTable</span> :<span class="hljs-built_in">global</span>(.el-table td) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>结果</strong>：构建成功，且代码更加规范。</p>
<h3 data-id="heading-16">方案三：配置 vue.config.js</h3>
<p>如果必须使用 <code>::v-deep</code>，可以通过配置 <code>vue.config.js</code> 来解决问题：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">module.exports</span> = {
  css: {
    loaderOptions: {
      css: {
        // 启用 CSS Modules 模式避免深度选择器问题
        modules: false
      },
      postcss: {
        plugins: <span class="hljs-section">[
          require('autoprefixer')
        ]</span>
      }
    }
  },
  chainWebpack: <span class="hljs-attr">config</span> =&gt; {
    // 优化 CSS 压缩配置
    config.plugin('optimize-css').tap(<span class="hljs-attr">args</span> =&gt; {
      if (args<span class="hljs-section">[0]</span> &amp;&amp; args<span class="hljs-section">[0]</span>.cssnanoOptions) {
        args<span class="hljs-section">[0]</span>.<span class="hljs-attr">cssnanoOptions.preset</span> = [<span class="hljs-string">'default'</span>, {
          discardComments: {
            removeAll: <span class="hljs-literal">true</span>
          },
          normalizeWhitespace: <span class="hljs-literal">false</span>
        }]
      }
      return args
    })
  }
}
</code></pre>
<h2 data-id="heading-17">最终解决方案</h2>
<p>综合考虑项目现状和长期维护性，我选择了<strong>方案二（CSS Modules）</strong> 作为最终解决方案，原因如下：</p>
<ol>
<li><strong>符合现代前端开发规范</strong></li>
<li><strong>更好的样式隔离</strong></li>
<li><strong>避免深度选择器的兼容性问题</strong></li>
<li><strong>便于代码维护和重构</strong></li>
</ol>
<h2 data-id="heading-18">技术深度解析</h2>
<h3 data-id="heading-19">Vue Scoped CSS 原理</h3>
<p>Vue 的 scoped CSS 是通过 PostCSS 插件实现的，工作原理如下：</p>
<ol>
<li><strong>为每个选择器添加属性选择器</strong>：<code>.example</code> → <code>.example[data-v-xxxxxx]</code></li>
<li><strong>为模板元素添加属性</strong>：<code>&lt;div class="example"&gt;</code> → <code>&lt;div class="example" data-v-xxxxxx&gt;</code></li>
<li><strong>样式仅限于带有相同 data-v 属性的元素</strong></li>
</ol>
<h3 data-id="heading-20">深度选择器的实现机制</h3>
<p>深度选择器的工作原理是移除属性选择器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 原始代码 */</span>
::v-deep .child-component { <span class="hljs-attribute">color</span>: red; }

<span class="hljs-comment">/* 转换后 */</span>
<span class="hljs-selector-attr">[data-v-xxxxxx]</span> <span class="hljs-selector-class">.child-component</span> { <span class="hljs-attribute">color</span>: red; }
</code></pre>
<h3 data-id="heading-21">CSS Modules 的优势</h3>
<ol>
<li><strong>真正的局部作用域</strong>：通过类名哈希实现</li>
<li><strong>无冲突的类名</strong>：每个模块的类名都是唯一的</li>
<li><strong>显式依赖</strong>：明确知道样式在哪里被使用</li>
<li><strong>代码压缩优化</strong>：类名可以被压缩得更短</li>
</ol>
<h2 data-id="heading-22">经验总结</h2>
<p>通过这次问题的排查和解决，我总结了以下几点经验：</p>
<h3 data-id="heading-23">1. 构建错误排查方法论</h3>
<ul>
<li><strong>从简单到复杂</strong>：先尝试清除缓存、重新安装等简单操作</li>
<li><strong>分析错误堆栈</strong>：仔细阅读错误信息，定位问题发生的具体位置</li>
<li><strong>版本兼容性检查</strong>：检查相关依赖的版本兼容性</li>
<li><strong>代码审查</strong>：重点关注最近修改的代码</li>
</ul>
<h3 data-id="heading-24">2. Vue 样式开发最佳实践</h3>
<ul>
<li><strong>Vue 2 项目</strong>：推荐使用 <code>/deep/</code> 或 CSS Modules</li>
<li><strong>Vue 3 项目</strong>：推荐使用 <code>:deep()</code> 选择器</li>
<li><strong>大型项目</strong>：优先考虑 CSS Modules 或 CSS-in-JS 方案</li>
</ul>
<h3 data-id="heading-25">3. 预防措施</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 在 package.json 中固定关键依赖版本</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.6.14"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vue/cli-service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.5.19"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sass-loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^10.2.1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-26">结语</h2>
<p>这次 CSS 压缩错误的排查过程，让我对 Vue 的样式系统有了更深入的理解。从前端的表面现象到底层的构建原理，从简单的样式编写到复杂的工程化问题，每一个技术细节都值得深入探究。</p>
<p>作为前端开发者，我们不仅要会使用框架提供的便利功能，更要理解其背后的原理和实现机制。只有这样，当遇到问题时，我们才能快速定位并找到最优解决方案。</p>
<p>希望这篇文章能帮助到遇到类似问题的开发者，也欢迎大家分享自己的问题和解决方案，共同进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 对象数组去重的几种方法]]></title>    <link>https://juejin.cn/post/7572115057222713379</link>    <guid>https://juejin.cn/post/7572115057222713379</guid>    <pubDate>2025-11-14T06:20:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572115057222713379" data-draft-id="7571753301898854440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 对象数组去重的几种方法"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-14T06:20:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="juejin_cn"/> <meta itemprop="url" content="https://juejin.cn/user/3016715636324125"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 对象数组去重的几种方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715636324125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    juejin_cn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T06:20:38.000Z" title="Fri Nov 14 2025 06:20:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>部分内容由大模型生成</p>
</blockquote>
<p>根据对象的某个属性（如 <code>id</code>）对对象数组去重的几种方法。</p>
<h2 data-id="heading-0"><code>Map</code></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'a'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object A'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'b'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object B'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'c'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object C'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'a'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object A (重复)'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'d'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object D'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'b'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Object B (重复)'</span> }
];

<span class="hljs-keyword">const</span> unique = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(arr.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> [item.<span class="hljs-property">id</span>, item])).<span class="hljs-title function_">values</span>()]

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(unique)
<span class="hljs-comment">// 输出: </span>
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   {id: 'a', name: 'Object A (重复)'}</span>
<span class="hljs-comment">//   {id: 'b', name: 'Object B (重复)'}</span>
<span class="hljs-comment">//   {id: 'c', name: 'Object C'}</span>
<span class="hljs-comment">//   {id: 'd', name: 'Object D'}</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<p><code>Map</code> 的键（key）唯一，<code>map(item =&gt; [item.id, item])</code> 把每个对象用 <code>id</code> 当键，后面的重复项会覆盖。最后用 <code>.values()</code> 得到去重后的对象数组。</p>
<p><em>此方法会保留<strong>最后一个</strong>出现的 <code>id</code> 对应的对象。</em></p>
<h2 data-id="heading-1"><code>filter</code> &amp; <code>findIndex</code></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> unique = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index, self</span>) =&gt;</span>
  index === self.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === item.<span class="hljs-property">id</span>)
)
<span class="hljs-comment">// 输出: </span>
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   {id: 'a', name: 'Object A'}</span>
<span class="hljs-comment">//   {id: 'b', name: 'Object B'}</span>
<span class="hljs-comment">//   {id: 'c', name: 'Object C'}</span>
<span class="hljs-comment">//   {id: 'd', name: 'Object D'}</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<p><code>findIndex</code> 找到数组中首个 <code>id</code> 相同的元素位置，只有第一个匹配项会被保留。</p>
<h2 data-id="heading-2"><code>reduce</code> &amp; <code>some</code></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> unique = arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, cur</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!acc.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === cur.<span class="hljs-property">id</span>)) {
    acc.<span class="hljs-title function_">push</span>(cur)
  }
  <span class="hljs-keyword">return</span> acc
}, [])
<span class="hljs-comment">// 输出: </span>
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   {id: 'a', name: 'Object A'}</span>
<span class="hljs-comment">//   {id: 'b', name: 'Object B'}</span>
<span class="hljs-comment">//   {id: 'c', name: 'Object C'}</span>
<span class="hljs-comment">//   {id: 'd', name: 'Object D'}</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<p>累积构建一个新数组，遇到重复的 <code>id</code> 不再添加。</p>
<h2 data-id="heading-3"><code>filter</code> &amp; <code>Set</code></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
<span class="hljs-keyword">const</span> unique = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> !seen.<span class="hljs-title function_">has</span>(item.<span class="hljs-property">id</span>) &amp;&amp; seen.<span class="hljs-title function_">add</span>(item.<span class="hljs-property">id</span>))
<span class="hljs-comment">// 输出: </span>
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   {id: 'a', name: 'Object A'}</span>
<span class="hljs-comment">//   {id: 'b', name: 'Object B'}</span>
<span class="hljs-comment">//   {id: 'c', name: 'Object C'}</span>
<span class="hljs-comment">//   {id: 'd', name: 'Object D'}</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<p>利用 <code>Set</code> 记录已出现的 <code>id</code>，第一次出现才添加。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始学习大模型（LLM）: 学习路线与知识体系详解]]></title>    <link>https://juejin.cn/post/7572132916575993892</link>    <guid>https://juejin.cn/post/7572132916575993892</guid>    <pubDate>2025-11-14T06:30:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132916575993892" data-draft-id="7572132916575944740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始学习大模型（LLM）: 学习路线与知识体系详解"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-14T06:30:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始学习大模型（LLM）: 学习路线与知识体系详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T06:30:09.000Z" title="Fri Nov 14 2025 06:30:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于普通程序员而言，系统学习大模型技术是一次重要的职业升级。为了帮助你清晰地规划学习路径，我结合多个权威的学习路线，为你梳理出一套从基础到实战的<strong>结构化学习方案</strong>。</p>
<p>下面这张流程图汇总了核心的学习阶段与关键技能，你可以用它作为整体路线图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/121ceb1513744df1a60a05f72e602066~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763707162&amp;x-signature=tRSXhNcZ061hkMZtr3ybBhUEj1I%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">💻 第一阶段：打好基础（约1-2个月）</h3>
<p>这个阶段的目标是重建知识体系，打下坚实的理论基础。</p>
<ul>
<li>
<p><strong>编程语言</strong>：熟练掌握 <strong>Python</strong>​ 是前提，特别是要熟悉 NumPy、Pandas 等数据科学库。</p>
</li>
<li>
<p><strong>数学基础</strong>：重点复习线性代数（矩阵运算）、概率统计（贝叶斯定理）和微积分（梯度下降），这些是理解模型原理的基石。</p>
</li>
<li>
<p><strong>机器学习与深度学习</strong>：学习经典的机器学习算法（如分类、聚类）和深度学习知识（神经网络、CNN/RNN），并选择 <strong>PyTorch</strong>​ 或 <strong>TensorFlow</strong>​ 中的一个框架进行实践。</p>
</li>
</ul>
<p><strong>学习建议</strong>：这个阶段可以结合吴恩达的机器学习课程和李沐的《动手学深度学习》进行学习。</p>
<h3 data-id="heading-1">🔬 第二阶段：深入核心技术（约2-3个月）</h3>
<p>这个阶段将直接切入大模型的核心技术。</p>
<ul>
<li>
<p><strong>Transformer架构</strong>：这是所有大模型的基石。必须理解其<strong>自注意力机制（Self-Attention）</strong> ​ 和工作原理。建议阅读著名的论文《Attention Is All You Need》。</p>
</li>
<li>
<p><strong>预训练与微调</strong>：理解大模型如何通过海量数据预训练获得通用能力，以及如何通过<strong>微调（Fine-tuning）</strong> ​ 使其适配特定任务。可以关注 <strong>LoRA</strong>​ 等高效的微调技术。</p>
</li>
<li>
<p><strong>Prompt工程</strong>：学习如何设计有效的提示词，以最大化激发模型的能力。这包括指令设计、少样本示例等技巧。</p>
</li>
</ul>
<p><strong>学习建议</strong>：强烈推荐使用 <strong>Hugging Face</strong>​ 库，它提供了丰富的预训练模型和工具，可以让你快速上手实验和体验。</p>
<h3 data-id="heading-2">🚀 第三阶段：应用开发实战（约2-3个月）</h3>
<p>学习技术的目的是为了应用。这个阶段你将开始构建真正可用的AI应用。</p>
<ul>
<li>
<p><strong>RAG（检索增强生成）</strong> ：这是当前企业的刚需技术。它通过为模型接入外部知识库（如公司文档），解决模型知识过时和“幻觉”问题。你需要学习文档解析、向量数据库（如Chroma）和LangChain等框架。</p>
</li>
<li>
<p><strong>智能体（Agent）</strong> ：智能体能让大模型具备自主规划、使用工具的能力。学习 <strong>ReAct</strong>​ 框架和 <strong>LangChain</strong>​ 等工具，可以开发出能自动完成复杂任务的AI。</p>
</li>
<li>
<p><strong>项目实战</strong>：最好的学习方式是实践。可以尝试：</p>
<ul>
<li>
<p>用 <strong>Ollama</strong>​ 部署一个开源模型，搭建一个PDF问答机器人。</p>
</li>
<li>
<p>使用 <strong>LangChain</strong>​ 构建一个能联网搜索信息的智能体。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">🧠 第四阶段：进阶与深耕</h3>
<p>如果你希望深入技术链条的更底层，或成为专家，可以继续探索以下方向。</p>
<ul>
<li>
<p><strong>模型微调与训练</strong>：深入研究全参数微调、高效微调技术（LoRA、QLoRA）的原理和实践。</p>
</li>
<li>
<p><strong>模型部署与优化</strong>：学习如何将模型部署到生产环境，涉及模型压缩、量化、推理加速（vLLM）等技术。</p>
</li>
<li>
<p><strong>多模态大模型</strong>：拓展到图像、语音等多模态领域，理解如CLIP、DALL-E等模型的工作原理。</p>
</li>
</ul>
<h3 data-id="heading-4">🌟 如何持续学习与规划职业</h3>
<ul>
<li>
<p><strong>保持学习</strong>：大模型技术迭代飞快。积极参与 <strong>Hugging Face</strong>、<strong>GitHub</strong>​ 等开源社区，关注arXiv上的最新论文，是保持技术敏锐度的关键。</p>
</li>
<li>
<p><strong>规划职业路径</strong>：大模型领域不仅需要研究者，更需要能将技术落地的工程师。你可以根据自己的兴趣和背景，选择不同的发展方向：</p>
<ul>
<li>
<p><strong>应用开发</strong>：利用API和框架快速构建AI应用，适合大多数程序员切入。</p>
</li>
<li>
<p><strong>数据方向</strong>：负责数据清洗、标注，为训练提供燃料。</p>
</li>
<li>
<p><strong>平台方向</strong>：负责分布式训练、资源调度等底层基础设施。</p>
</li>
<li>
<p><strong>部署方向</strong>：专注于模型推理加速和端侧部署。</p>
</li>
</ul>
</li>
</ul>
<p>希望这份详细的学习路线能为你扫清迷雾，助你在大模型的浪潮中成功转型。学习过程就像训练一个模型，需要大量的“数据”（知识输入）和“迭代”（实践反思）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码隔离革命：用 JavaScript Realm 安全运行不可信代码]]></title>    <link>https://juejin.cn/post/7572190151351566336</link>    <guid>https://juejin.cn/post/7572190151351566336</guid>    <pubDate>2025-11-14T06:51:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572190151351566336" data-draft-id="7572161976593317940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码隔离革命：用 JavaScript Realm 安全运行不可信代码"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-14T06:51:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码隔离革命：用 JavaScript Realm 安全运行不可信代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T06:51:12.000Z" title="Fri Nov 14 2025 06:51:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多年的开发生涯中，我带领团队交付了无数中等规模的外包项目，遇到过各种棘手的技术挑战。但最近在调试一个复杂的多 iframe 应用时，我发现了一个被大多数开发者忽略的 JavaScript 特性，它彻底改变了我对代码安全性的认知。</p>
<p>======================================================================================================================</p>
<h2 data-id="heading-0">从一次生产事故说起</h2>
<p>想象这个场景：你为客户的xx平台开发了一个插件系统，允许商家编写自定义 JavaScript 来增强店铺功能。一切都很美好，直到某个商家写了这样的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 某个"创新"商家的插件代码</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"哈哈，我重写了数组方法！"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"搞破坏了"</span>;
};
</code></pre>
<p>结果如何？整个xx平台的购物车、商品列表、订单系统全线崩溃。这就是典型的全局污染问题——当不可信代码与核心业务共享同一个执行环境时，灾难随时可能发生。</p>
<h2 data-id="heading-1">Realm：JavaScript 的隔离解决方案</h2>
<h3 data-id="heading-2">什么是 Realm？</h3>
<p>Realm 是 JavaScript 的隔离执行环境，可以理解为"一套全新的 JavaScript 宇宙"。每个 Realm 都拥有自己独立的内置对象和全局作用域。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主环境</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span>); <span class="hljs-comment">// [Function: Array]</span>

<span class="hljs-comment">// 创建 iframe（自动生成新 Realm）</span>
<span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);

<span class="hljs-comment">// iframe 中的 Array 是全新的构造器</span>
<span class="hljs-keyword">const</span> iframeArray = iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span> === iframeArray); <span class="hljs-comment">// false！</span>
</code></pre>
<p>看到这个结果时，我团队的小伙伴们都惊呆了。两个 Array 构造器功能完全相同，但却是完全独立的对象，这就是 Realm 的强大之处。</p>
<h3 data-id="heading-3">Realm 的组成要素</h3>
<p>每个 Realm 都包含完整的运行环境：</p>
<ul>
<li>
<p><strong>全局对象</strong>：浏览器中的 window 或 Node.js 中的 global</p>
</li>
<li>
<p><strong>内置构造器</strong>：Array、Object、Function、Error 等</p>
</li>
<li>
<p><strong>工具函数</strong>：setTimeout、fetch、JSON 等</p>
</li>
<li>
<p><strong>原型对象</strong>：Array.prototype、Object.prototype 等基础原型</p>
</li>
</ul>
<h2 data-id="heading-4">实战：三种 Realm 实现方案</h2>
<h3 data-id="heading-5">方案一：ShadowRealm（未来标准）</h3>
<p>ShadowRealm 是 TC39 标准提案（Stage 3），专为代码隔离设计：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 创建隔离环境</span>
<span class="hljs-type">const</span> realm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ShadowRealm</span>();

<span class="hljs-comment">// 安全执行不可信代码</span>
<span class="hljs-type">const</span> result = realm.<span class="hljs-built_in">evaluate</span>(`
    <span class="hljs-comment">// 这里无法访问主环境的任何变量</span>
    <span class="hljs-type">const</span> sensitiveData = <span class="hljs-string">"这段数据很安全"</span>;
    <span class="hljs-number">2</span> + <span class="hljs-number">2</span>
`);

console.<span class="hljs-built_in">log</span>(result); <span class="hljs-comment">// 4</span>
console.<span class="hljs-built_in">log</span>(typeof sensitiveData); <span class="hljs-comment">// undefined（完全隔离）</span>
</code></pre>
<p>当前可用 polyfill：</p>
<pre><code class="hljs language-ini" lang="ini">npm install shadowrealm-api

import ShadowRealm from 'shadowrealm-api'<span class="hljs-comment">;</span>

const <span class="hljs-attr">realm</span> = new ShadowRealm()<span class="hljs-comment">;</span>
const <span class="hljs-attr">userCodeResult</span> = realm.evaluate(userSuppliedCode)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-6">方案二：iframe 沙箱（生产环境首选）</h3>
<p>对于需要立即上线的项目，iframe 是最可靠的解决方案：</p>
<pre><code class="hljs language-ini" lang="ini">function createSafeSandbox() {
    const <span class="hljs-attr">frame</span> = document.createElement(<span class="hljs-string">'iframe'</span>)<span class="hljs-comment">;</span>
    
    // 关键配置：限制权限
    <span class="hljs-attr">frame.sandbox</span> = [
        <span class="hljs-string">'allow-scripts'</span>,     // 允许执行脚本
        // <span class="hljs-string">'allow-same-origin'</span> // 谨慎使用：允许同源访问
    ].join(<span class="hljs-string">' '</span>)<span class="hljs-comment">;</span>
    
    <span class="hljs-attr">frame.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
    document.body.appendChild(frame)<span class="hljs-comment">;</span>
    
    return {
        evaluate: (code) =&gt; frame.contentWindow.eval(code),
        destroy: () =&gt; frame.remove()
    }<span class="hljs-comment">;</span>
}

// 使用示例
const <span class="hljs-attr">sandbox</span> = createSafeSandbox()<span class="hljs-comment">;</span>
try {
    const <span class="hljs-attr">result</span> = sandbox.evaluate(<span class="hljs-string">'2 + 2'</span>)<span class="hljs-comment">;</span>
    console.log('安全计算结果:', result)<span class="hljs-comment">;</span>
} finally {
    sandbox.destroy()<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-7">方案三：Web Worker（纯计算场景）</h3>
<p>对于 CPU 密集型任务，Web Worker 提供良好的隔离性：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 创建隔离的工作线程</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">workerCode</span> = `
    <span class="hljs-built_in">self</span>.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">result</span> = <span class="hljs-keyword">eval</span>(e.data.code);
            <span class="hljs-built_in">self</span>.<span class="hljs-title function_ invoke__">postMessage</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, result });
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-built_in">self</span>.<span class="hljs-title function_ invoke__">postMessage</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.message });
        }
    };
`;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">blob</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([workerCode], { type: <span class="hljs-string">'application/javascript'</span> });
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">worker</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(URL.<span class="hljs-title function_ invoke__">createObjectURL</span>(blob));

worker.onmessage = (e) =&gt; {
    <span class="hljs-keyword">if</span> (e.data.success) {
        console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Worker 计算结果:'</span>, e.data.result);
    } <span class="hljs-keyword">else</span> {
        console.<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">'执行出错:'</span>, e.data.error);
    }
};

<span class="hljs-comment">// 执行用户代码</span>
worker.<span class="hljs-title function_ invoke__">postMessage</span>({
    <span class="hljs-attr">code</span>: <span class="hljs-string">'Math.pow(2, 10)'</span> // 用户提供的代码
});
</code></pre>
<h2 data-id="heading-8">真实案例：插件系统安全改造</h2>
<p>我们最近为一家金融科技客户重构了他们的报表插件系统。改造前，第三方插件经常导致整个系统崩溃；改造后，即使插件代码存在问题，也只会影响自身运行。</p>
<h3 data-id="heading-9">改造前的问题代码：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 老系统：直接执行插件代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">runPlugin</span>(<span class="hljs-params">pluginCode</span>) {
    <span class="hljs-comment">// 危险！插件可以访问和修改全局状态</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(pluginCode);
}
</code></pre>
<h3 data-id="heading-10">改造后的安全方案：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginSandbox</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">iframe</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">iframe</span>.<span class="hljs-property">sandbox</span> = <span class="hljs-string">'allow-scripts'</span>;
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">iframe</span>);
    }
    
    <span class="hljs-title function_">runPlugin</span>(<span class="hljs-params">pluginCode, api</span>) {
        <span class="hljs-comment">// 通过 postMessage 提供有限的 API</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">iframe</span>.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'EXECUTE'</span>,
            <span class="hljs-attr">code</span>: pluginCode,
            <span class="hljs-attr">api</span>: api
        }, <span class="hljs-string">'*'</span>);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">event</span>) =&gt; {
                <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'RESULT'</span>) {
                    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handler);
                    <span class="hljs-title function_">resolve</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">result</span>);
                }
            };
            <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handler);
        });
    }
}
</code></pre>
<h2 data-id="heading-11">何时应该使用 Realm 技术？</h2>
<p>根据我们的项目经验，以下场景强烈推荐使用 Realm：</p>
<ol>
<li>
<p><strong>用户代码执行</strong>：在线代码编辑器、教学平台</p>
</li>
<li>
<p><strong>第三方插件</strong>：CMS 系统、电商平台的扩展功能</p>
</li>
<li>
<p><strong>A/B 测试</strong>：隔离不同版本的代码逻辑</p>
</li>
<li>
<p><strong>单元测试</strong>：确保每个测试用例环境纯净</p>
</li>
<li>
<p><strong>微前端架构</strong>：隔离不同团队开发的子应用</p>
</li>
</ol>
<h2 data-id="heading-12">安全最佳实践</h2>
<p>在多个金融级项目中，我们总结出这些安全准则：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 安全配置示例</span>
<span class="hljs-keyword">const</span> SAFE_SANDBOX_CONFIG = [
    <span class="hljs-string">'allow-scripts'</span>,        <span class="hljs-comment">// 必需：执行脚本</span>
    <span class="hljs-comment">// 'allow-forms',       // 谨慎：表单提交</span>
    <span class="hljs-comment">// 'allow-popups',      // 谨慎：弹出窗口</span>
    <span class="hljs-comment">// 'allow-same-origin', // 危险：同源访问</span>
    <span class="hljs-comment">// 'allow-top-navigation' // 危险：顶级导航</span>
];

<span class="hljs-comment">// 永远验证输入</span>
<span class="hljs-function">function <span class="hljs-title">validateCode</span>(<span class="hljs-params">code</span>)</span> {
    <span class="hljs-keyword">const</span> blacklist = [
        <span class="hljs-string">'document.cookie'</span>,
        <span class="hljs-string">'localStorage'</span>,
        <span class="hljs-string">'XMLHttpRequest'</span>,
        <span class="hljs-string">'fetch'</span>,
        <span class="hljs-string">'window.parent'</span>
    ];
    
    <span class="hljs-keyword">return</span> !blacklist.some(<span class="hljs-keyword">unsafe</span> =&gt; code.includes(<span class="hljs-keyword">unsafe</span>));
}
</code></pre>
<h2 data-id="heading-13">未来展望</h2>
<p>ShadowRealm 标准落地后，JavaScript 代码隔离将变得更加简单高效。我们团队正在密切关注相关进展，并已在几个实验性项目中开始使用 polyfill 版本。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对于Java程序员来说，学习大模型需要重点补足哪些Python生态知识？]]></title>    <link>https://juejin.cn/post/7572142436127358995</link>    <guid>https://juejin.cn/post/7572142436127358995</guid>    <pubDate>2025-11-14T06:53:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572142436127358995" data-draft-id="7572137760447561769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对于Java程序员来说，学习大模型需要重点补足哪些Python生态知识？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-14T06:53:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对于Java程序员来说，学习大模型需要重点补足哪些Python生态知识？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T06:53:03.000Z" title="Fri Nov 14 2025 06:53:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>了解您希望系统性地补足Python生态知识，以便更好地融入大模型领域。对于Java程序员来说，您的优势在于强大的工程化和系统设计能力，而学习Python生态更像是掌握一套新的、更适配AI领域的工具。关键在于理解思维方式的差异，并找到与您现有知识体系的连接点。</p>
<p>下面这个表格梳理了需要重点关注的Python生态知识，并提供了与Java技术的对比和学习的核心要点，可以帮助您更有针对性地学习。</p>








































<table><thead><tr><th>学习阶段</th><th>关键知识/工具</th><th>Java程序员的参考视角/学习重点</th></tr></thead><tbody><tr><td><strong>🚀 入门基础</strong>​</td><td><strong>Python语法基础</strong>​</td><td>重点关注与Java的差异：动态类型、缩进规则、列表/字典推导式等。您的面向对象编程思想可以无缝迁移。</td></tr><tr><td/><td><strong>核心数据科学生态</strong>​</td><td><strong>NumPy</strong>：可类比为进行高效数值计算的“超级数组”；其<code>ndarray</code>是几乎所有AI库的数据基础。<strong>Pandas</strong>：是处理结构化数据（如CSV、数据库表）的利器，其<code>DataFrame</code>概念类似数据库表或Excel表格，但功能强大得多。</td></tr><tr><td><strong>🔧 核心框架</strong>​</td><td><strong>深度学习框架（PyTorch / TensorFlow）</strong> ​</td><td><strong>PyTorch</strong>​ 因其动态图（定义即运行）更友好，易于调试，是当前研究和原型开发的主流。<strong>TensorFlow</strong>​ 的静态图在生产部署上有其优势。建议从<strong>PyTorch</strong>入手。</td></tr><tr><td/><td><strong>大模型核心库：Hugging Face</strong>​</td><td>这是大模型的“模型应用商店”和工具箱。其<code>transformers</code>库提供了数千个预训练模型，<code>datasets</code>库提供海量数据，通过几行代码即可调用最先进的模型。这是学习效率最高的工具。</td></tr><tr><td><strong>⚙️ 工程与集成</strong>​</td><td><strong>应用开发与部署工具</strong>​</td><td><strong>FastAPI</strong>：用于快速构建高性能的模型API，类似Java中的Spring Boot部分功能，但更轻量、异步支持好。<strong>Docker</strong>：用于容器化部署，实现环境隔离和一致性，概念与Java项目无异。</td></tr><tr><td/><td><strong>Java-Python桥接技术</strong>​</td><td><strong>DJL (Deep Java Library)</strong> ：允许在Java应用中直接调用PyTorch/TensorFlow模型，极大降低了在现有Java系统中集成AI能力的技术门槛。</td></tr></tbody></table>
<h3 data-id="heading-0">💡 如何高效学习与实践</h3>
<p>明确了学什么，接下来的关键在于如何高效地学，并让新知识产生价值。</p>
<ol>
<li>
<p><strong>转变学习思维</strong></p>
<ul>
<li>
<p><strong>从“严谨架构”到“快速迭代”</strong> ：Python生态的优势在于丰富的库和快速原型验证。初期不必过于追求Java式的完美架构，应接受“先跑起来，再优化”的探索式编程。</p>
</li>
<li>
<p><strong>善用工具链</strong>：熟练使用<strong>Jupyter Notebook</strong>进行代码实验和数据分析，它非常适合交互式学习和探索性研究。</p>
</li>
</ul>
</li>
<li>
<p><strong>规划学习路径</strong></p>
<ul>
<li>
<p><strong>第一步：Python基础与数据科学库</strong>。快速过一遍Python语法，然后重点练习用NumPy和Pandas进行数据操作。可以找一个CSV数据集，尝试进行数据清洗、筛选和简单统计。</p>
</li>
<li>
<p><strong>第二步：深度学习框架与Hugging Face</strong>。学习PyTorch的张量操作和自动求导机制，然后用Hugging Face的<code>pipeline</code>函数快速体验文本分类、摘要生成等任务，感受大模型的能力。</p>
</li>
<li>
<p><strong>第三步：项目实战</strong>。这是最关键的一步。选择一个感兴趣的小项目，例如：</p>
<ul>
<li>
<p><strong>入门级</strong>：用FastAPI将一个简单的文本分类模型包装成RESTful API，供您的Java服务调用。</p>
</li>
<li>
<p><strong>进阶级</strong>：使用<strong>LangChain</strong>框架构建一个基于私有文档的智能问答系统（RAG），这会综合用到Hugging Face、向量数据库等知识。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>发挥你的Java优势</strong></p>
<p>您的Java背景不是负担，而是<strong>独特的竞争优势</strong>。大模型技术从研究到落地，迫切需要强大的工程化能力。您可以专注于：</p>
<ul>
<li>
<p><strong>AI应用工程化</strong>：思考如何将Python开发的模型用Docker容器化，如何用Java（通过DJL或HTTP API）集成模型并提供高可用、高并发的服务。</p>
</li>
<li>
<p><strong>系统架构设计</strong>：如何设计微服务来管理多个模型的生命周期？如何实现模型的版本管理、灰度发布和监控？这些都是您非常擅长而纯Python研究者可能薄弱的地方。</p>
</li>
</ul>
</li>
</ol>
<p>希望这份梳理能帮助您清晰地规划Python生态的学习。这是一个“磨刀不误砍柴工”的过程，一旦掌握了这些工具，您就能将强大的Java工程能力与前沿的AI模型能力相结合，真正具备成为“AI时代全栈工程师”的潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你离前端动画高手只差这个秘籍！GSAP ScrollTrigger 动画完全指南！(第一章)]]></title>    <link>https://juejin.cn/post/7572157115907375154</link>    <guid>https://juejin.cn/post/7572157115907375154</guid>    <pubDate>2025-11-14T05:39:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572157115907375154" data-draft-id="7572039006529863716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你离前端动画高手只差这个秘籍！GSAP ScrollTrigger 动画完全指南！(第一章)"/> <meta itemprop="keywords" content="前端,动效"/> <meta itemprop="datePublished" content="2025-11-14T05:39:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你离前端动画高手只差这个秘籍！GSAP ScrollTrigger 动画完全指南！(第一章)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:39:47.000Z" title="Fri Nov 14 2025 05:39:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>这里没有冗长的理论，只有动画实战中的<strong>精华干货</strong>。本节不涉及复杂的技术细节，而是为你描绘学成后的蓝图 —— 你能实现怎样的效果，并能拿到源码亲手实践、欢迎一起交流。</p>
<p>本系列聚焦于网页 <code>scroll</code> 滚动动画，核心工具是 <code>gsap</code>。这个动画库在国外极为流行，但在国内知名度还不高（早期因收费门槛，近年已完全免费）。加上目前国内企业对动效的要求尚未普及，因此了解它的人并不多。</p>
<p>但请相信，如果你渴望做出令人惊叹的网页动画，看完我们最终要实现的效果，你一定会心动，并愿意加入我们的 <strong>「前端动画交流群」</strong>，一起进阶、一起成长。</p>
<h2 data-id="heading-1">GSAP 是什么？</h2>
<p>GSAP 是国外顶尖的专业动画库，大多数让人“眼前一亮”的网页动画，背后都有它的身影（当然，像 <code>Framer Motion</code> 这类新秀也同样强大，后续我们也会推出相关高阶教程）。</p>
<p>现在，就来看看 GSAP 能做出哪些<strong>炸裂的视觉效果</strong>吧！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bddd8e374bc47fe99b5f9719b002c88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=G1SNM5vKkDZRDOlcoTnzbDlu5RU%3D" alt="all.gif" loading="lazy"/></p>
<p>里面涉及的 <code>3D</code> 效果，其实是结合了 <code>three.js</code> 与 <code>gsap</code> 共同实现的。也就是说，光会 <code>three.js</code>，离做出真正酷炫的动画还差一步。</p>
<p>所以，我们不妨<strong>从易到难</strong>，先掌握 <code>2D</code> 动画，做出看得见的效果——这不仅能帮你夯实基础，也会极大增强你的信心。</p>
<p>我们这个动画系列，将专注于 <code>gsap</code> 在 <strong>scroll 滚动动画</strong> 方面的应用。可能有同学会问：为什么只讲滚动动画？</p>
<h2 data-id="heading-2">为什么选择用它实现 Scroll 动画？</h2>
<ol>
<li>
<p><strong>更聚焦于一个技术点</strong><br/>
<code>gsap</code> 动画涉及的点太多了，如果全面展开，整个教程周期会拉得非常长。我们希望在有限时间内，带你学透一个真正实用的高价值模块。所以选择了 <code>scroll</code> 这块。</p>
</li>
<li>
<p><strong>GSAP 最牛的插件就是跟滚动相关的</strong><br/>
如果要问 GSAP 相较于其他动画库最强大的功能是什么，那一定是与滚动相关的 <strong>ScrollTrigger 插件</strong>。它到底能实现多震撼的效果？下面我们来看几个典型示例（这些案例在后续教程中都会一一实现）</p>
</li>
</ol>
<h2 data-id="heading-3">一些实现效果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ad72c205d334880a960ef1aab34ccde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=H1b990dpdWpja1Qbs3xvZKfEd0s%3D" alt="Nov-14-2025 11-05-05.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/256a18ceb89740b8a9c28b81768ee097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=XUSs3jwgU35n8jIYOmSbOr%2F94eU%3D" alt="Nov-14-2025 11-10-35.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d47b4a193764ecc81a120438526ae38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=Y%2BBF2CKvlb482EuIMygIAvCjyI8%3D" alt="Nov-14-2025 11-11-20.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7db11e48883846bf93507daab454c415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=WSXTnBIJ3Nb33smtw5No8Zb8P6E%3D" alt="Nov-14-2025 11-21-24.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17a0d53b8a124b3ba7ef1921794d0817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703587&amp;x-signature=cRArGd8ASGp73Cat1IHSzmzt%2Fgk%3D" alt="Nov-14-2025 10-57-11.gif" loading="lazy"/></p>
<p>以上只是冰山一角，总共案例很多，目前手上有接近 <code>100</code> 个效果，但是后期逐步完成多少，现在还没具体规划，但至少几十个肯定有的！</p>
<h2 data-id="heading-4">关于本教程</h2>
<p>本系列内容融合了国外优质付费课程与多位大神的实战案例，虽是我个人学习与整合的成果，但在内容深度与体系性上，有信心达到国内 <strong>TOP 级别</strong>。纯为分享，希望与你一起进步。</p>
<p>作为前端开发者，很多人都是被那些“会动”的酷炫界面吸引入行的。遗憾的是，国内在这方面的高质量资源并不多。而我，不仅深深享受着做出流畅动画带来的成就感，也坚信自己会在这条路上走得更远，也希望有同行的伙伴！</p>
<p>这里也分享我个人的组件库项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">T-UI GitHub 地址</a>（如需访问请科学上网）。它的官网动效仅花了 <strong>1 个月</strong> 学习与实践完成，效果还算不错，欢迎看看源码、给个 Star ⭐️，我们一起交流！</p>
<h2 data-id="heading-5">教程安排</h2>
<p><strong>第一部分：系统入门</strong><br/>
基本上是拿国外很好一个技术教程来分享(同时提醒大家，学好英语是非常非常重要的，我也一直在坚持，大概1年时间，效果还是挺明显的，看这个教程基本上不看字幕能听懂百分之 80)</p>
<p>为什么选择这个教程呢，因为我对比过多个教程，这个教程优点非常突出。</p>
<ul>
<li>
<p>有 <strong>核心原理</strong> 讲解：这点至关重要。初学 <code>ScrollTrigger</code> 时，我经常会遇到一些莫名其妙的布局问题。（是因为 <code>ScrollTrigger</code> 插件会在某些情况下会影响到布局），如果不了解，很难去解决这些问题。</p>
</li>
<li>
<p><strong>案例丰富</strong>：该教程几乎覆盖了所有关键技术点与动画类型，能帮我们省去大量自己设计案例的时间。</p>
</li>
</ul>
<p><strong>第二部分：实战进阶</strong></p>
<p>我们将一起复现 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.awwwards.com%2F" target="_blank" title="https://www.awwwards.com/" ref="nofollow noopener noreferrer">Awwwards</a> 上的获奖网站效果。（如果全球最顶尖的网站动效在哪个网站，没错，就是这个网站了）这些效果在上面我们展示过，也是我之前看一些大神的博客、视频，然后学习的资料，发现确实很有帮助，也一起分享，算是巩固我自己所学的同时也能分享出来！</p>
<h2 data-id="heading-6">欢迎加入我们的技术交流群</h2>
<p>我们群是一个覆盖 <strong>前端动画</strong>、<strong>Node.js</strong>、<strong>AI Agent 开发</strong> 及我的组件库项目 <strong>T-UI</strong> 的综合性技术交流社区。</p>
<p>目前，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">T-UI</a> 是群内最成熟、讨论最活跃的项目。从源码质量到官网效果，都经得起细看。欢迎你来交流想法、贡献代码，或 simply give it a star——❤️ 比心！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java进阶（二：Maven——Java项目管理工具）]]></title>    <link>https://juejin.cn/post/7572115057222533155</link>    <guid>https://juejin.cn/post/7572115057222533155</guid>    <pubDate>2025-11-14T05:44:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572115057222533155" data-draft-id="7572051762984058932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java进阶（二：Maven——Java项目管理工具）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-14T05:44:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java进阶（二：Maven——Java项目管理工具）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:44:47.000Z" title="Fri Nov 14 2025 05:44:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">什么是Maven？</h2>
<p>Maven 是一个强大的 <strong>项目管理和构建自动化工具</strong>，主要用于 Java 项目。它通过项目对象模型（POM，Project Object Model）来描述项目，管理依赖、构建生命周期、插件等，极大地简化了 Java 项目的构建和管理过程。他极大的简化了java的依赖管理，同时让采用maven架构的项目长得一样整齐，便于维护二开。举几个没有maven的糟糕例子。</p>
<h3 data-id="heading-1">如果没有Maven</h3>
<p><strong>手动找 jar</strong>：打开搜索引擎 → 输入“spring-core-5.3.9.jar 下载” → 点进广告满天飞的论坛 → 下错版本 → 运行时报 NoSuchMethodError → 重下 → 再试。</p>
<p><strong>版本冲突靠眼神</strong>：A 框架要 log4j-1.2.17，B 框架要 log4j-1.2.15，你只有把两个 jar 都扔进 lib，classpath 里谁先谁后全凭天命。</p>
<p><strong>目录结构“百家争鸣”</strong>： 张三把源码放 <code>src/</code>，李四放 <code>source/</code>，王五把测试代码叫 <code>testSrc/</code>；新人入职第一件事是问“咱们这个项目咋编译？”</p>
<p><strong>构建脚本成“传家宝”</strong>:每人私藏一份 2000 行 Ant XML，里面硬编码了 <code>D:\tomcat\webapps</code> 路径；换台电脑就跑不起来。</p>
<p><strong>CI/CD 寸步难行</strong>: Jenkins 里要先把 jar 拷到 lib、再改版本号、再手动点按钮；上线一次 30 分钟，喝 3 杯咖啡等结果。</p>
<h3 data-id="heading-2">Maven 的核心功能：</h3>





























<table><thead><tr><th align="left">功能</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>依赖管理</strong></td><td align="left">自动下载和管理项目所需的第三方库（如 Spring、MyBatis 等），避免手动导入 jar 包。</td></tr><tr><td align="left"><strong>项目构建</strong></td><td align="left">提供标准化的构建流程：编译、测试、打包、部署等。</td></tr><tr><td align="left"><strong>统一结构</strong></td><td align="left">规定项目目录结构（如 <code>src/main/java</code>、<code>src/test/java</code>），提高项目可读性和可维护性。</td></tr><tr><td align="left"><strong>插件机制</strong></td><td align="left">支持通过插件扩展功能，如打包成 jar、war，生成文档，运行测试等。</td></tr><tr><td align="left"><strong>多模块支持</strong></td><td align="left">支持大型项目的模块化开发，便于管理多个子项目。</td></tr></tbody></table>
<h2 data-id="heading-3">如何搭建第一个 Maven 工程</h2>
<h3 data-id="heading-4">1. 环境准备</h3>
<ul>
<li><strong>安装 JDK</strong>：确保已安装 Java Development Kit</li>
<li><strong>安装 Maven</strong>：下载并配置 Apache Maven 环境变量</li>
<li><strong>验证安装</strong>：在命令行执行以下命令确认安装成功
<pre><code class="hljs language-bash" lang="bash">mvn -version
</code></pre>
</li>
</ul>
<h3 data-id="heading-5">2. 创建 Maven 项目</h3>
<h4 data-id="heading-6">IDE创建</h4>
<p>在Idea等编辑器新建项目时在“构建系统”中选择Maven</p>
<h4 data-id="heading-7">使用命令行创建</h4>
<pre><code class="hljs language-bash" lang="bash">mvn archetype:generate -DgroupId=com.example -DartifactId=my-first-maven-project -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=<span class="hljs-literal">false</span>
</code></pre>
<h4 data-id="heading-8">手动创建项目结构</h4>
<pre><code class="hljs language-css" lang="css">my-first-maven-project/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   └── java/
│   │       └── com/
│   │           └── example/
│   │               └── App<span class="hljs-selector-class">.java</span>
│   └── test/
│       └── java/
│           └── com/
│               └── example/
│                   └── AppTest<span class="hljs-selector-class">.java</span>
└── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h3 data-id="heading-9">3. 配置 pom.xml</h3>
<p>创建基本的 <code>pom.xml</code> 文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-first-maven-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">4. 编写代码</h3>
<p>在 <code>src/main/java/com/example/App.java</code> 中创建主类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"Hello Maven!"</span>);
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello "</span> + name + <span class="hljs-string">"!"</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">5. 编译和构建</h3>
<h4 data-id="heading-12">编译项目</h4>
<pre><code class="hljs language-bash" lang="bash">mvn compile
</code></pre>
<h4 data-id="heading-13">运行测试</h4>
<pre><code class="hljs language-bash" lang="bash">mvn <span class="hljs-built_in">test</span>
</code></pre>
<h4 data-id="heading-14">打包项目</h4>
<pre><code class="hljs language-bash" lang="bash">mvn package
</code></pre>
<h4 data-id="heading-15">清理构建结果</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean
</code></pre>
<h3 data-id="heading-16">6. Maven 标准目录结构</h3>
<ul>
<li><code>src/main/java/</code>：Java 源代码</li>
<li><code>src/main/resources/</code>：资源文件</li>
<li><code>src/test/java/</code>：测试代码</li>
<li><code>src/test/resources/</code>：测试资源文件</li>
<li><code>target/</code>：构建输出目录</li>
<li><code>pom.xml</code>：项目对象模型文件</li>
</ul>
<h2 data-id="heading-17">POM 文件全解</h2>
<h3 data-id="heading-18">1. POM 基本概念</h3>
<p><code>Project Object Model</code> (<code>POM</code>) 是 Maven 项目的核心配置文件，定义了项目的基本信息、依赖关系、构建配置等内容。</p>
<h3 data-id="heading-19">2. POM 文件基本结构</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 项目基本信息 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-app<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 属性配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 依赖配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 依赖项 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 构建配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 构建插件 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h3 data-id="heading-20">3. 核心元素详解</h3>
<h4 data-id="heading-21">3.1 基本坐标信息</h4>
<ul>
<li><code>groupId</code>: 组织标识符，通常使用反向域名</li>
<li><code>artifactId</code>: 项目唯一标识符</li>
<li><code>version</code>: 项目版本号</li>
<li><code>packaging</code>: 打包方式（jar、war、pom等）</li>
</ul>
<h4 data-id="heading-22">3.2 属性配置 (<code>properties</code>)</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<h4 data-id="heading-23">3.3 依赖管理 (<code>dependencies</code>)</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h5 data-id="heading-24">依赖范围 (<code>scope</code>)</h5>
<ul>
<li><code>compile</code>: 编译依赖（默认）</li>
<li><code>provided</code>: 编译和测试时需要，运行时由容器提供</li>
<li><code>runtime</code>: 运行和测试时需要，编译不需要</li>
<li><code>test</code>: 仅测试时需要</li>
<li><code>system</code>: 系统级依赖</li>
</ul>
<h4 data-id="heading-25">3.4 继承与聚合</h4>
<h5 data-id="heading-26">父项目继承</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.14<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
</code></pre>
<h5 data-id="heading-27">子模块聚合</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>module1<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>module2<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>
</code></pre>
<h3 data-id="heading-28">4. 构建配置 (<code>build</code>)</h3>
<h4 data-id="heading-29">4.1 插件配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-30">4.2 资源配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<h3 data-id="heading-31">5. 依赖管理进阶</h3>
<h4 data-id="heading-32">5.1 依赖管理 (<code>dependencyManagement</code>)</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h4 data-id="heading-33">5.2 排除依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-34">6. Profiles 配置</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">environment</span>&gt;</span>development<span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">environment</span>&gt;</span>production<span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
</code></pre>
<h3 data-id="heading-35">7. 仓库配置</h3>
<h4 data-id="heading-36">7.1 远程仓库</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<h4 data-id="heading-37">7.2 插件仓库</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">pluginRepositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">pluginRepository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">pluginRepositories</span>&gt;</span>
</code></pre>
<h3 data-id="heading-38">8. 常用 Maven 属性</h3>
<ul>
<li><code>${project.groupId}</code>: 项目 groupId</li>
<li><code>${project.artifactId}</code>: 项目 artifactId</li>
<li><code>${project.version}</code>: 项目版本</li>
<li><code>${project.build.directory}</code>: 构建目录（target）</li>
<li><code>${project.build.outputDirectory}</code>: 输出目录（target/classes）</li>
<li><code>${project.build.testOutputDirectory}</code>: 测试输出目录（target/test-classes）</li>
</ul>
<p>POM 文件是 Maven 项目的核心，合理配置 POM 可以有效管理项目依赖、构建过程和发布流程。</p>
<h2 data-id="heading-39">Maven 生命周期与插件</h2>
<h3 data-id="heading-40">1. Maven 生命周期</h3>
<p>Maven 生命周期是 Maven 构建过程的抽象表示，定义了构建项目的各个阶段。</p>
<h4 data-id="heading-41">1.1 三套生命周期</h4>
<h5 data-id="heading-42">Clean Lifecycle（清理生命周期）</h5>
<ul>
<li><code>pre-clean</code>: 执行清理前的工作</li>
<li><code>clean</code>: 清理上一次构建生成的文件（删除 <code>target</code> 目录）</li>
<li><code>post-clean</code>: 执行清理后的工作</li>
</ul>
<h5 data-id="heading-43">Default Lifecycle（默认生命周期）</h5>
<ul>
<li><code>validate</code>: 验证项目正确性和必要信息</li>
<li><code>initialize</code>: 初始化构建状态</li>
<li><code>generate-sources</code>: 生成需要编译的源码</li>
<li><code>process-sources</code>: 处理源码</li>
<li><code>generate-resources</code>: 生成需要打包的资源文件</li>
<li><code>process-resources</code>: 处理资源文件并复制到目标目录</li>
<li><code>compile</code>: 编译项目的源码</li>
<li><code>process-classes</code>: 处理编译后的class文件</li>
<li><code>generate-test-sources</code>: 生成测试需要的源码</li>
<li><code>process-test-sources</code>: 处理测试源码</li>
<li><code>generate-test-resources</code>: 生成测试需要的资源文件</li>
<li><code>process-test-resources</code>: 处理测试资源文件</li>
<li><code>test-compile</code>: 编译测试源码</li>
<li><code>process-test-classes</code>: 处理编译后的测试class文件</li>
<li><code>test</code>: 使用单元测试框架运行测试</li>
<li><code>prepare-package</code>: 打包前的准备工作</li>
<li><code>package</code>: 将编译后的代码打包成可分发格式</li>
<li><code>pre-integration-test</code>: 集成测试前的准备工作</li>
<li><code>integration-test</code>: 处理和部署包到集成测试环境</li>
<li><code>post-integration-test</code>: 集成测试后的操作</li>
<li><code>verify</code>: 运行检查验证包是否有效且达到质量标准</li>
<li><code>install</code>: 将包安装到本地仓库</li>
<li><code>deploy</code>: 将最终的包复制到远程仓库</li>
</ul>
<h5 data-id="heading-44">Site Lifecycle（站点生命周期）</h5>
<ul>
<li><code>pre-site</code>: 生成站点文档前的处理</li>
<li><code>site</code>: 生成项目的站点文档</li>
<li><code>post-site</code>: 生成站点文档后的处理</li>
<li><code>site-deploy</code>: 将生成的站点文档部署到指定服务器</li>
</ul>
<h4 data-id="heading-45">1.2 生命周期特点</h4>
<ul>
<li>后面的阶段依赖于前面的阶段</li>
<li>跳转到某个阶段会自动执行前面的所有阶段</li>
<li>不同生命周期可以同时执行</li>
</ul>
<h3 data-id="heading-46">2. Maven 插件</h3>
<p>Maven 插件是实际执行构建任务的组件，每个阶段都由特定插件的目标（goal）来执行。</p>
<h4 data-id="heading-47">2.1 插件类型</h4>
<h5 data-id="heading-48">Build Plugins（构建插件）</h5>
<p>在构建生命周期中执行，在 <code>pom.xml</code> 的 <code>&lt;build&gt;</code> 元素中配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h5 data-id="heading-49">Reporting Plugins（报告插件）</h5>
<p>在站点生成过程中执行，在 <code>pom.xml</code> 的 <code>&lt;reporting&gt;</code> 元素中配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">reporting</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">reporting</span>&gt;</span>
</code></pre>
<h4 data-id="heading-50">2.2 常用核心插件</h4>


















































<table><thead><tr><th>插件</th><th>功能</th><th>默认绑定阶段</th></tr></thead><tbody><tr><td><code>maven-clean-plugin</code></td><td>清理构建产物</td><td>clean</td></tr><tr><td><code>maven-compiler-plugin</code></td><td>编译Java源码</td><td>compile, testCompile</td></tr><tr><td><code>maven-resources-plugin</code></td><td>处理资源文件</td><td>process-resources, process-test-resources</td></tr><tr><td><code>maven-surefire-plugin</code></td><td>运行单元测试</td><td>test</td></tr><tr><td><code>maven-jar-plugin</code></td><td>打包JAR文件</td><td>package</td></tr><tr><td><code>maven-war-plugin</code></td><td>打包WAR文件</td><td>package</td></tr><tr><td><code>maven-install-plugin</code></td><td>安装到本地仓库</td><td>install</td></tr><tr><td><code>maven-deploy-plugin</code></td><td>部署到远程仓库</td><td>deploy</td></tr></tbody></table>
<h4 data-id="heading-51">2.3 插件配置示例</h4>
<h5 data-id="heading-52">编译插件配置</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h5 data-id="heading-53">打包插件配置</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.Application<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h3 data-id="heading-54">3. 命令行执行</h3>
<h4 data-id="heading-55">3.1 执行特定阶段</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean              <span class="hljs-comment"># 执行 clean 生命周期到 clean 阶段</span>
mvn compile            <span class="hljs-comment"># 执行 default 生命周期到 compile 阶段</span>
mvn <span class="hljs-built_in">test</span>               <span class="hljs-comment"># 执行 default 生命周期到 test 阶段</span>
mvn package            <span class="hljs-comment"># 执行 default 生命周期到 package 阶段</span>
mvn install            <span class="hljs-comment"># 执行 default 生命周期到 install 阶段</span>
mvn site               <span class="hljs-comment"># 执行 site 生命周期到 site 阶段</span>
</code></pre>
<h4 data-id="heading-56">3.2 执行特定插件目标</h4>
<pre><code class="hljs language-bash" lang="bash">mvn plugin:goal
mvn compiler:compile
mvn surefire:<span class="hljs-built_in">test</span>
mvn <span class="hljs-built_in">help</span>:describe -Dplugin=compiler
</code></pre>
<h4 data-id="heading-57">3.3 组合执行</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean install      <span class="hljs-comment"># 先清理再安装</span>
mvn clean compile <span class="hljs-built_in">test</span> <span class="hljs-comment"># 清理、编译、测试</span>
</code></pre>
<h3 data-id="heading-58">4. 自定义插件绑定</h3>
<p>可以在 <code>pom.xml</code> 中自定义插件绑定到特定阶段：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-antrun-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>echo-message<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>run<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">tasks</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">echo</span>&gt;</span>Hello from AntRun Plugin!<span class="hljs-tag">&lt;/<span class="hljs-name">echo</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">tasks</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<p>Maven 的生命周期和插件机制提供了强大的构建自动化能力，通过合理的配置可以满足各种复杂的构建需求。</p>
<h2 data-id="heading-59">其他构建框架</h2>
<p>除了Maven之外，Java生态中还有多种仓库管理工具，每种工具都有其独特的特点和适用场景‌。</p>
<ul>
<li>‌<strong>Ant</strong>‌ 是最早的构建工具，专注于通过XML脚本实现项目构建自动化，但缺乏内置的依赖管理功能‌56</li>
<li>‌<strong>Ivy</strong>‌ 是依赖管理工具，通常与Ant配合使用，为Ant项目提供依赖管理能力‌12</li>
<li>‌<strong>Maven</strong>‌ 在Ant基础上发展而来，集成了依赖管理、项目结构约定和构建生命周期，采用"约定优于配置"原则‌45</li>
<li>‌<strong>Gradle</strong>‌ 融合了Ant的灵活性和Maven的依赖管理，使用Groovy/Kotlin DSL，提供了更强大的构建能力‌34</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 18 新特性深度解析]]></title>    <link>https://juejin.cn/post/7572087162231554090</link>    <guid>https://juejin.cn/post/7572087162231554090</guid>    <pubDate>2025-11-14T03:25:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162231554090" data-draft-id="7572138663120027690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 18 新特性深度解析"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-14T03:25:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小前端_我自坚强"/> <meta itemprop="url" content="https://juejin.cn/user/2335811609826423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 18 新特性深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335811609826423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小前端_我自坚强
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:25:27.000Z" title="Fri Nov 14 2025 03:25:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="ocean">.hljs-comment,.hljs-quote{color:#65737e}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#bf616a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#d08770}.hljs-attribute{color:#ebcb8b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#a3be8c}.hljs-section,.hljs-title{color:#8fa1b3}.hljs-keyword,.hljs-selector-tag{color:#b48ead}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b303b;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 18 新特性深度解析</h2>
<h3 data-id="heading-1">引言</h3>
<p>React 18 是 React 发展历程中的一个重要里程碑，它引入了许多激动人心的新特性和改进。作为前端开发者，理解和掌握这些新特性对于构建高性能、现代化的 React 应用至关重要。本文将深入探讨 React 18 的各项新特性，通过实际代码示例和详细分析，帮助读者全面掌握这一版本的核心功能。</p>
<h3 data-id="heading-2">第一章：React 18 概述</h3>
<h4 data-id="heading-3">1.1 React 18 的发布背景</h4>
<p>React 18 于 2022 年 3 月正式发布，这是 React 自 2013 年开源以来的又一次重大更新。与之前的版本相比，React 18 的主要目标是：</p>
<ol>
<li><strong>提升应用性能</strong>：通过并发渲染等新特性优化用户体验</li>
<li><strong>改善开发体验</strong>：提供更好的调试工具和开发工具链支持</li>
<li><strong>增强 API 一致性</strong>：统一自动批处理等行为</li>
<li><strong>为未来特性奠定基础</strong>：为 React Server Components 等未来特性做准备</li>
</ol>
<h4 data-id="heading-4">1.2 React 18 的核心特性</h4>
<p>React 18 引入了以下几个核心特性：</p>
<ol>
<li><strong>自动批处理（Automatic Batching）</strong></li>
<li><strong>并发渲染（Concurrent Rendering）</strong></li>
<li><strong>新的根 API（New Root API）</strong></li>
<li><strong>Suspense 的改进</strong></li>
<li><strong>新的 Hooks：useId、useSyncExternalStore、useInsertionEffect</strong></li>
</ol>
<h3 data-id="heading-5">第二章：自动批处理（Automatic Batching）</h3>
<h4 data-id="heading-6">2.1 什么是批处理</h4>
<p>批处理是指 React 将多个状态更新合并到单个重新渲染中，以提高性能。在 React 18 之前，React 只能在 React 事件处理程序中进行批处理，而在 Promise、setTimeout、原生事件处理程序等异步操作中不会自动批处理。</p>
<h4 data-id="heading-7">2.2 React 18 之前的批处理行为</h4>
<p>让我们先看看 React 18 之前的行为：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 17 及之前版本的行为</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// React 17 中，这些更新会被批处理</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
    <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
    <span class="hljs-comment">// React 只会重新渲染一次</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAsyncClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// React 17 中，这些更新不会被批处理</span>
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
      <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
      <span class="hljs-comment">// React 会重新渲染两次</span>
    }, <span class="hljs-number">0</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>同步更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleAsyncClick}</span>&gt;</span>异步更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Flag: {String(flag)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-8">2.3 React 18 的自动批处理</h4>
<p>React 18 通过引入自动批处理机制，解决了上述问题。现在，无论状态更新发生在何处，React 都会自动将它们批处理到单个重新渲染中。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 18 中的自动批处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 这些更新会被批处理</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
    <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
    <span class="hljs-comment">// React 只会重新渲染一次</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAsyncClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 现在这些更新也会被批处理</span>
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
      <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
      <span class="hljs-comment">// React 只会重新渲染一次</span>
    }, <span class="hljs-number">0</span>);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFetchClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
      
      <span class="hljs-comment">// 这些更新也会被批处理</span>
      <span class="hljs-title function_">setCount</span>(data.<span class="hljs-property">count</span>);
      <span class="hljs-title function_">setFlag</span>(data.<span class="hljs-property">flag</span>);
      <span class="hljs-comment">// React 只会重新渲染一次</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch error:'</span>, error);
    }
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>同步更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleAsyncClick}</span>&gt;</span>异步更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleFetchClick}</span>&gt;</span>异步获取数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Flag: {String(flag)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">2.4 手动控制批处理</h4>
<p>虽然自动批处理是默认行为，但在某些情况下，你可能需要手动控制批处理。React 18 提供了 <code>flushSync</code> 函数来强制 React 同步刷新状态更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { flushSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用 flushSync 强制同步刷新</span>
    <span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
    });
    <span class="hljs-comment">// 此时组件已经重新渲染</span>
    
    <span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
    });
    <span class="hljs-comment">// 组件再次重新渲染</span>
    
    <span class="hljs-comment">// 总共重新渲染了两次</span>
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>强制同步更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Flag: {String(flag)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-10">2.5 自动批处理的优势</h4>
<p>自动批处理带来了以下优势：</p>
<ol>
<li><strong>性能提升</strong>：减少了不必要的重新渲染次数</li>
<li><strong>一致性</strong>：无论更新发生在何处，行为都是一致的</li>
<li><strong>简化开发</strong>：开发者无需关心更新发生的位置</li>
</ol>
<h3 data-id="heading-11">第三章：并发渲染（Concurrent Rendering）</h3>
<h4 data-id="heading-12">3.1 什么是并发渲染</h4>
<p>并发渲染是 React 18 最重要的新特性之一。它允许 React 在准备更新时同时在后台渲染多个版本，从而实现更流畅的用户体验。并发渲染不是并行执行，而是中断和恢复的能力。</p>
<h4 data-id="heading-13">3.2 并发渲染的核心概念</h4>
<h5 data-id="heading-14">3.2.1 可中断渲染</h5>
<p>在 React 18 之前，一旦渲染开始，就无法中断。如果渲染过程很耗时，会导致界面卡顿。并发渲染允许 React 在必要时中断渲染，处理更高优先级的更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 模拟耗时组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpensiveComponent</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-comment">// 模拟耗时计算</span>
  <span class="hljs-keyword">const</span> expensiveValue = items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
    <span class="hljs-comment">// 复杂计算</span>
    <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
      result += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(item.<span class="hljs-property">value</span> * i);
    }
    <span class="hljs-keyword">return</span> acc + result;
  }, <span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - startTime;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计算结果: {expensiveValue.toFixed(2)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计算耗时: {duration.toFixed(2)}ms<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-15">3.2.2 优先级调度</h5>
<p>React 18 引入了优先级调度机制，允许不同类型的更新有不同的优先级。用户交互通常具有更高的优先级，而后台数据加载等操作优先级较低。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUrgentUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 紧急更新 - 高优先级</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDeferredUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 延迟更新 - 低优先级</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> newItems = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
        <span class="hljs-attr">id</span>: i,
        <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
      }));
      <span class="hljs-title function_">setItems</span>(newItems);
    });
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleUrgentUpdate}</span>&gt;</span>
        紧急更新 (Count: {count})
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleDeferredUpdate}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
        {isPending ? '加载中...' : '延迟更新'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>正在后台处理...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveList</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{items}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpensiveList</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {items.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.value.toFixed(4)}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-16">3.3 useTransition Hook</h4>
<p><code>useTransition</code> 是 React 18 提供的一个重要 Hook，用于标记某些状态更新为"过渡"更新，即低优先级更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">{ query }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 模拟搜索功能</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">search</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">searchQuery</span>) =&gt; {
    <span class="hljs-comment">// 模拟 API 调用延迟</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
    
    <span class="hljs-comment">// 模拟搜索结果</span>
    <span class="hljs-keyword">const</span> mockResults = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(
      { <span class="hljs-attr">length</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">50</span>) },
      <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`结果 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> for "<span class="hljs-subst">${searchQuery}</span>"`</span>
    );
    
    <span class="hljs-keyword">return</span> mockResults;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> searchQuery = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    
    <span class="hljs-comment">// 使用 transition 标记为低优先级更新</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> searchResults = <span class="hljs-keyword">await</span> <span class="hljs-title function_">search</span>(searchQuery);
      <span class="hljs-title function_">setResults</span>(searchResults);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入搜索关键词..."</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleSearch}</span>
      /&gt;</span>
      
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>搜索中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {results.map((result, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{result}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-17">3.4 useDeferredValue Hook</h4>
<p><code>useDeferredValue</code> 是另一个与并发渲染相关的 Hook，它允许你延迟渲染 UI 的某些部分。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredText = <span class="hljs-title function_">useDeferredValue</span>(text);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setText(e.target.value)}
        placeholder="输入文本..."
      /&gt;
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>实时显示:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>延迟显示:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredText}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SlowList</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-comment">// 模拟慢速渲染</span>
  <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{text || '无内容'}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  ));

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{items}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-18">3.5 Suspense 的改进</h4>
<p>React 18 对 Suspense 进行了重大改进，使其能够与并发渲染更好地配合工作。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户资料<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">h2</span>&gt;</span>加载用户信息...<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">ProfileDetails</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">h2</span>&gt;</span>加载用户帖子...<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">ProfileTimeline</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 模拟异步组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfileDetails</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-comment">// 模拟数据获取</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">profileDetails</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileDetails</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">resolve</span>({
          <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
          <span class="hljs-attr">email</span>: <span class="hljs-string">'zhangsan@example.com'</span>,
          <span class="hljs-attr">bio</span>: <span class="hljs-string">'前端开发者'</span>
        });
      }, <span class="hljs-number">2000</span>);
    });
    <span class="hljs-keyword">throw</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileDetails</span>;
  }
  
  <span class="hljs-keyword">const</span> data = <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileDetails</span>;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{data.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{data.bio}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfileTimeline</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-comment">// 模拟数据获取</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">profileTimeline</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileTimeline</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">resolve</span>([
          { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'第一条帖子'</span> },
          { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'第二条帖子'</span> },
          { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'第三条帖子'</span> }
        ]);
      }, <span class="hljs-number">3000</span>);
    });
    <span class="hljs-keyword">throw</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileTimeline</span>;
  }
  
  <span class="hljs-keyword">const</span> posts = <span class="hljs-variable language_">window</span>.<span class="hljs-property">profileTimeline</span>;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>用户帖子<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {posts.map(post =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{post.id}</span>&gt;</span>{post.content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-19">第四章：新的根 API</h3>
<h4 data-id="heading-20">4.1 React 18 的新根 API</h4>
<p>React 18 引入了新的根 API，取代了旧的 <code>ReactDOM.render</code> 方法。新的 API 提供了更好的类型安全性和未来兼容性。</p>
<h5 data-id="heading-21">4.1.1 旧的 API</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 17 及之前的写法</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
</code></pre>
<h5 data-id="heading-22">4.1.2 新的 API</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 18 的写法</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);

<span class="hljs-comment">// 如果需要卸载</span>
<span class="hljs-comment">// root.unmount();</span>
</code></pre>
<h4 data-id="heading-23">4.2 新根 API 的优势</h4>
<p>新的根 API 提供了以下优势：</p>
<ol>
<li><strong>更好的类型支持</strong>：TypeScript 用户可以获得更好的类型检查</li>
<li><strong>未来兼容性</strong>：为未来的 React 特性做好准备</li>
<li><strong>更清晰的 API</strong>：分离了根创建和渲染两个步骤</li>
</ol>
<h4 data-id="heading-24">4.3 服务端渲染的改进</h4>
<p>React 18 还改进了服务端渲染的 API：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 18 服务端渲染</span>
<span class="hljs-keyword">import</span> { renderToPipeableStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/server'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-keyword">const</span> { pipe, abort } = <span class="hljs-title function_">renderToPipeableStream</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>,
    {
      <span class="hljs-title function_">onShellReady</span>(<span class="hljs-params"/>) {
        res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-type'</span>, <span class="hljs-string">'text/html'</span>);
        <span class="hljs-title function_">pipe</span>(res);
      },
      <span class="hljs-title function_">onShellError</span>(<span class="hljs-params">error</span>) {
        res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">500</span>;
        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'&lt;!doctype html&gt;&lt;p&gt;Loading...&lt;/p&gt;&lt;script src="clientrender.js"&gt;&lt;/script&gt;'</span>);
      },
      <span class="hljs-title function_">onError</span>(<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
        res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">500</span>;
      }
    }
  );
  
  <span class="hljs-built_in">setTimeout</span>(abort, <span class="hljs-number">10000</span>);
}
</code></pre>
<h3 data-id="heading-25">第五章：新的 Hooks</h3>
<h4 data-id="heading-26">5.1 useId Hook</h4>
<p><code>useId</code> 是 React 18 引入的一个新 Hook，用于生成稳定的唯一 ID，特别适用于服务端渲染场景。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useId } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">PasswordField</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> id = <span class="hljs-title function_">useId</span>();
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">{id}</span>&gt;</span>密码:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PasswordField</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PasswordField</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PasswordField</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-27">5.2 useSyncExternalStore Hook</h4>
<p><code>useSyncExternalStore</code> 是一个用于订阅外部数据源的 Hook，确保服务端渲染和客户端渲染的一致性。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useSyncExternalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 外部存储示例</span>
<span class="hljs-keyword">const</span> store = {
  <span class="hljs-attr">state</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> },
  <span class="hljs-attr">listeners</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
  
  <span class="hljs-title function_">setState</span>(<span class="hljs-params">newState</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, ...newState };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>());
  },
  
  <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">listener</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">add</span>(listener);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(listener);
  },
  
  <span class="hljs-title function_">getSnapshot</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
  }
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useStore</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useSyncExternalStore</span>(
    store.<span class="hljs-property">subscribe</span>,
    store.<span class="hljs-property">getSnapshot</span>,
    store.<span class="hljs-property">getSnapshot</span> <span class="hljs-comment">// 服务端渲染时的 getSnapshot</span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { count } = <span class="hljs-title function_">useStore</span>();
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> store.setState({ count: count + 1 })}&gt;
        增加
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-28">5.3 useInsertionEffect Hook</h4>
<p><code>useInsertionEffect</code> 是一个专门用于 CSS-in-JS 库的 Hook，它在 DOM 变更之前同步执行，确保样式在布局计算之前被注入。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useInsertionEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 模拟 CSS-in-JS 库的使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useCSS</span>(<span class="hljs-params">style</span>) {
  <span class="hljs-title function_">useInsertionEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> styleElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'style'</span>);
    styleElement.<span class="hljs-property">textContent</span> = style;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(styleElement);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">removeChild</span>(styleElement);
    };
  }, [style]);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">StyledComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useCSS</span>(<span class="hljs-string">`
    .styled-button {
      background: blue;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .styled-button:hover {
      background: darkblue;
    }
  `</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">className</span>=<span class="hljs-string">"styled-button"</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}
      &gt;
        增加
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-29">第六章：性能优化实践</h3>
<h4 data-id="heading-30">6.1 组件优化策略</h4>
<p>React 18 提供了多种优化组件性能的方法：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { memo, useMemo, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 使用 memo 优化函数组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ExpensiveComponent</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpensiveComponent</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ExpensiveComponent 渲染'</span>);
  
  <span class="hljs-comment">// 使用 useMemo 缓存昂贵的计算</span>
  <span class="hljs-keyword">const</span> processedData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
      ...item,
      <span class="hljs-attr">processed</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>
    }));
  }, [data]);
  
  <span class="hljs-comment">// 使用 useCallback 缓存回调函数</span>
  <span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击项目:'</span>, id);
  }, []);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {processedData.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleClick(item.id)}&gt;
          {item.name}: {item.processed}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目1'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目2'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">20</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项目3'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">30</span> }
  ], []);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}&gt;
        计数器: {count}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-31">6.2 虚拟滚动优化</h4>
<p>对于大量数据的列表渲染，虚拟滚动是提升性能的有效方法：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">VirtualList</span>(<span class="hljs-params">{ items, itemHeight, windowHeight }</span>) {
  <span class="hljs-keyword">const</span> containerRef = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> [scrollTop, setScrollTop] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 计算可见项目范围</span>
  <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / itemHeight);
  <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    startIndex + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(windowHeight / itemHeight) + <span class="hljs-number">1</span>,
    items.<span class="hljs-property">length</span>
  );
  
  <span class="hljs-comment">// 可见项目</span>
  <span class="hljs-keyword">const</span> visibleItems = items.<span class="hljs-title function_">slice</span>(startIndex, endIndex);
  
  <span class="hljs-comment">// 总高度</span>
  <span class="hljs-keyword">const</span> totalHeight = items.<span class="hljs-property">length</span> * itemHeight;
  
  <span class="hljs-comment">// 上下空白高度</span>
  <span class="hljs-keyword">const</span> offsetY = startIndex * itemHeight;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{containerRef}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">height:</span> <span class="hljs-attr">windowHeight</span>,
        <span class="hljs-attr">overflow:</span> '<span class="hljs-attr">auto</span>'
      }}
      <span class="hljs-attr">onScroll</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setScrollTop(e.target.scrollTop)}
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">totalHeight</span>, <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>' }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
          <span class="hljs-attr">transform:</span> `<span class="hljs-attr">translateY</span>(${<span class="hljs-attr">offsetY</span>}<span class="hljs-attr">px</span>)` 
        }}&gt;</span>
          {visibleItems.map((item, index) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
              <span class="hljs-attr">key</span>=<span class="hljs-string">{startIndex</span> + <span class="hljs-attr">index</span>}
              <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">itemHeight</span> }}
            &gt;</span>
              {item}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-32">6.3 懒加载和代码分割</h4>
<p>React 18 继续支持懒加载和代码分割：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { lazy, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 懒加载组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./LazyComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [showLazy, setShowLazy] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowLazy(true)}&gt;
        加载懒组件
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        {showLazy &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-33">第七章：最佳实践和注意事项</h3>
<h4 data-id="heading-34">7.1 迁移到 React 18</h4>
<p>从 React 17 迁移到 React 18 需要注意以下几点：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 1. 更新根 API</span>
<span class="hljs-comment">// 旧写法</span>
<span class="hljs-comment">// import ReactDOM from 'react-dom';</span>
<span class="hljs-comment">// ReactDOM.render(&lt;App /&gt;, document.getElementById('root'));</span>

<span class="hljs-comment">// 新写法</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);

<span class="hljs-comment">// 2. 处理自动批处理的变化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在 React 18 中，这些更新会被自动批处理</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
    <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);
  }, []);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Flag: {String(flag)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-35">7.2 并发渲染的最佳实践</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useTransition, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">newQuery</span>) =&gt; {
    <span class="hljs-title function_">setQuery</span>(newQuery);
    
    <span class="hljs-comment">// 使用 transition 处理搜索更新</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 这里可以触发数据获取等操作</span>
      <span class="hljs-title function_">fetchData</span>(newQuery);
    });
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SearchInput</span> 
        <span class="hljs-attr">query</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onSearch</span>=<span class="hljs-string">{handleSearch}</span>
        <span class="hljs-attr">isSearching</span>=<span class="hljs-string">{isPending}</span>
      /&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载搜索结果...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">query</span>=<span class="hljs-string">{query}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchInput</span>(<span class="hljs-params">{ query, onSearch, isSearching }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span>
      <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span>
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onSearch(e.target.value)}
      placeholder="搜索..."
      disabled={isSearching}
    /&gt;</span>
  );
}
</code></pre>
<h4 data-id="heading-36">7.3 错误处理和边界情况</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorBoundary</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-error-boundary'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>
      <span class="hljs-attr">fallbackRender</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">error</span>, <span class="hljs-attr">resetErrorBoundary</span> }) =&gt;</span> (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>出现错误<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{error.message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{resetErrorBoundary}</span>&gt;</span>重试<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-37">第八章：未来展望</h3>
<h4 data-id="heading-38">8.1 React Server Components</h4>
<p>React Server Components 是 React 团队正在开发的重要特性，它将进一步改变我们构建应用的方式：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 服务端组件示例（概念代码）</span>
<span class="hljs-keyword">import</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">'db.server'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NoteEditor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'NoteEditor.client'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Note</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 在服务端执行</span>
  <span class="hljs-keyword">const</span> note = db.<span class="hljs-property">notes</span>.<span class="hljs-title function_">get</span>(props.<span class="hljs-property">id</span>);
  
  <span class="hljs-comment">// 可以直接访问数据库</span>
  <span class="hljs-keyword">const</span> comments = db.<span class="hljs-property">comments</span>.<span class="hljs-title function_">forNote</span>(props.<span class="hljs-property">id</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{note.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{note.content}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      {/* 客户端组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">NoteEditor</span> <span class="hljs-attr">noteId</span>=<span class="hljs-string">{note.id}</span> /&gt;</span>
      
      {/* 服务端渲染的评论列表 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">CommentsList</span> <span class="hljs-attr">comments</span>=<span class="hljs-string">{comments}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-39">8.2 React Forget</h4>
<p>React Forget 是 React 团队正在开发的自动记忆化编译器，它将自动优化组件的性能：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 开发者编写的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ theme, onClick, text }</span>) {
  <span class="hljs-keyword">const</span> className = <span class="hljs-string">`button button-<span class="hljs-subst">${theme}</span>`</span>;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      {text}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// React Forget 自动优化后的代码</span>
<span class="hljs-keyword">const</span> $ = <span class="hljs-title function_">_c</span>(<span class="hljs-number">3</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ theme, onClick, text }</span>) {
  <span class="hljs-keyword">const</span> className = $.<span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`button button-<span class="hljs-subst">${theme}</span>`</span>, [theme]);
  <span class="hljs-keyword">return</span> $.<span class="hljs-title function_">jsx</span>(<span class="hljs-string">'button'</span>, {
    className,
    onClick,
    <span class="hljs-attr">children</span>: text
  });
}
</code></pre>
<h3 data-id="heading-40">结语</h3>
<p>React 18 带来了许多令人兴奋的新特性和改进，从自动批处理到并发渲染，再到新的 Hooks 和 API。这些变化不仅提升了应用的性能和用户体验，也为未来的 React 发展奠定了坚实的基础。</p>
<p>作为前端开发者，我们需要：</p>
<ol>
<li><strong>深入理解新特性</strong>：掌握自动批处理、并发渲染等核心概念</li>
<li><strong>实践应用</strong>：在实际项目中运用这些新特性</li>
<li><strong>持续学习</strong>：关注 React 的发展动态和最佳实践</li>
<li><strong>性能优化</strong>：利用新特性优化应用性能</li>
</ol>
<p>React 18 是一个重要的里程碑，它标志着 React 正在朝着更加现代化、高性能的方向发展。通过合理运用这些新特性，我们可以构建出更加优秀的用户界面和应用体验。</p>
<p>未来，随着 React Server Components、React Forget 等特性的逐步成熟，React 生态将会变得更加完善和强大。作为开发者，我们需要保持学习的热情，紧跟技术发展的步伐，为用户提供更好的产品和服务。</p>
<p>希望本文能够帮助你更好地理解和掌握 React 18 的新特性，并在实际开发中发挥它们的价值。记住，技术的学习是一个持续的过程，只有不断实践和探索，我们才能真正掌握这些强大的工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 类型工具与 NestJS Mapped Types]]></title>    <link>https://juejin.cn/post/7572052559823110150</link>    <guid>https://juejin.cn/post/7572052559823110150</guid>    <pubDate>2025-11-14T03:38:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572052559823110150" data-draft-id="7572048000301727785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 类型工具与 NestJS Mapped Types"/> <meta itemprop="keywords" content="TypeScript,前端,后端"/> <meta itemprop="datePublished" content="2025-11-14T03:38:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏北海"/> <meta itemprop="url" content="https://juejin.cn/user/1425415102792237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 类型工具与 NestJS Mapped Types
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425415102792237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏北海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:38:42.000Z" title="Fri Nov 14 2025 03:38:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>在 NestJS 开发中，我们经常需要创建 DTO（Data Transfer Object）类。NestJS 提供了 <code>@nestjs/mapped-types</code> 包来帮助我们基于现有类创建新的 DTO 类，同时保留装饰器和验证元数据</p>
<h2 data-id="heading-1">TypeScript 内置类型工具 vs NestJS Mapped Types</h2>
<h3 data-id="heading-2">1. PartialType vs Partial</h3>
<h4 data-id="heading-3">TypeScript 内置 Partial</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Partial</span>&lt;T&gt; = {
  [P <span class="hljs-keyword">in</span> keyof T]?: T[P];
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PartialUser</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;;
<span class="hljs-comment">// 结果：{ name?: string; age?: number; }</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>仅用于类型检查，编译后不存在</li>
<li>无法保留装饰器和验证元数据</li>
<li>不能用于 class-validator</li>
</ul>
<h4 data-id="heading-4">NestJS PartialType</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PartialType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mapped-types'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsNumber</span>()
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateUserDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PartialType</span>(<span class="hljs-title class_">CreateUserDto</span>) {}
<span class="hljs-comment">// 结果：一个类，保留了所有装饰器和验证元数据</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>运行时存在，是一个真正的类</li>
<li>保留装饰器和验证元数据</li>
<li>可用于 class-validator 和 NestJS DI</li>
</ul>
<h3 data-id="heading-5">2. PickType vs Pick</h3>
<h4 data-id="heading-6">TypeScript 内置 Pick</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Pick</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = {
  [P <span class="hljs-keyword">in</span> K]: T[P];
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserName</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'name'</span>&gt;;
<span class="hljs-comment">// 结果：{ name: string; }</span>
</code></pre>
<h4 data-id="heading-7">NestJS PickType</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PickType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mapped-types'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNameDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PickType</span>(<span class="hljs-title class_">CreateUserDto</span>, [<span class="hljs-string">'name'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>) {}
<span class="hljs-comment">// 结果：一个类，保留了 name 字段的装饰器</span>
</code></pre>
<h3 data-id="heading-8">3. OmitType vs Omit</h3>
<h4 data-id="heading-9">TypeScript 内置 Omit</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Omit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">Exclude</span>&lt;keyof T, K&gt;&gt;;

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserWithoutAge</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'age'</span>&gt;;
<span class="hljs-comment">// 结果：{ name: string; }</span>
</code></pre>
<h4 data-id="heading-10">NestJS OmitType</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OmitType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mapped-types'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserWithoutAgeDto</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">OmitType</span>(<span class="hljs-title class_">CreateUserDto</span>, [<span class="hljs-string">'age'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>) {}
<span class="hljs-comment">// 结果：一个类，保留了剩余字段的装饰器</span>
</code></pre>
<h2 data-id="heading-11">关键区别对比</h2>



































<table><thead><tr><th>特性</th><th>TypeScript 内置类型</th><th>NestJS mapped-types</th></tr></thead><tbody><tr><td><strong>类型</strong></td><td>类型别名（Type Alias）</td><td>类（Class）</td></tr><tr><td><strong>运行时</strong></td><td>不存在（编译后消失）</td><td>存在（可在运行时使用）</td></tr><tr><td><strong>装饰器</strong></td><td>无法保留</td><td>保留装饰器和验证元数据</td></tr><tr><td><strong>验证</strong></td><td>无法用于 class-validator</td><td>可用于 class-validator</td></tr><tr><td><strong>依赖注入</strong></td><td>无法用于 DI</td><td>可用于 NestJS DI</td></tr></tbody></table>
<h2 data-id="heading-12">使用场景</h2>
<h3 data-id="heading-13">TypeScript 内置类型（适合纯类型操作）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 仅用于类型检查，不涉及运行时</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, data: Partial&lt;User&gt;</span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-14">NestJS mapped-types（适合 DTO 和验证）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Patch</span>, <span class="hljs-title class_">Body</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PartialType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/mapped-types'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-meta">@Post</span>()
  <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() dto: CreateUserDto</span>) {
    <span class="hljs-comment">// class-validator 会自动验证</span>
  }

  <span class="hljs-meta">@Patch</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-title function_">update</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() dto: UpdateUserDto</span>) {
    <span class="hljs-comment">// UpdateUserDto 继承了 CreateUserDto 的所有验证规则</span>
  }
}
</code></pre>
<h2 data-id="heading-15">最佳实践</h2>
<ol>
<li><strong>DTO 类使用 mapped-types</strong>：当需要创建可验证的 DTO 类时，使用 <code>@nestjs/mapped-types</code></li>
<li><strong>纯类型操作使用内置类型</strong>：当只需要类型层面的操作时，使用 TypeScript 内置类型</li>
<li><strong>保持一致性</strong>：在同一个项目中，保持使用方式的一致性</li>
</ol>
<h2 data-id="heading-16">相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2Fopenapi%2Fmapped-types" target="_blank" title="https://docs.nestjs.com/openapi/mapped-types" ref="nofollow noopener noreferrer">NestJS Mapped Types 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Futility-types.html" target="_blank" title="https://www.typescriptlang.org/docs/handbook/utility-types.html" ref="nofollow noopener noreferrer">TypeScript Utility Types 官方文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode定制开发——内置中文翻译插件]]></title>    <link>https://juejin.cn/post/7572099468247597091</link>    <guid>https://juejin.cn/post/7572099468247597091</guid>    <pubDate>2025-11-14T03:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572099468247597091" data-draft-id="7572092283719286836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode定制开发——内置中文翻译插件"/> <meta itemprop="keywords" content="JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-11-14T03:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zwq写js"/> <meta itemprop="url" content="https://juejin.cn/user/1022962441128904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode定制开发——内置中文翻译插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1022962441128904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zwq写js
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:42:09.000Z" title="Fri Nov 14 2025 03:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>目前正在开发基于VSCode实现的公司内部编辑器，记录自定义修改了的模块开发流程。如果对某些功能实现看不懂或者想实现某些功能但是没头绪，可以评论区提问交流。</p>
<h2 data-id="heading-1">效果展示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8fd47afbd541019097d609c88b5b49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=qL1cNQ6ET%2F6qHC83MFCh92kqNHY%3D" alt="image.png" loading="lazy"/></p>
<p>在已安装插件列表中不存在翻译插件、命令面板中可切换中英文，说明这是内置的中文翻译插件，用户无法卸载。并且在自定义的主窗体中可以响应切换的中英文。</p>
<h2 data-id="heading-2">实现流程</h2>
<h3 data-id="heading-3">添加内置插件</h3>
<ol>
<li>下载主程序版本对应的翻译插件vsix文件</li>
</ol>
<ul>
<li>先在 <code>VSCode</code> 插件市场中找到中文翻译包的历史版本，对应你所自定义的开源Code版本。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a68425e15ef4b789de3a723d6358ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=vPQY9Z%2BMr5fYbK6ay6pLWhgCogk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>如果可以直接下载成功，则不需要这一步。获取到版本号后，在浏览器中替换此链接版本号下载插件文件 <code>https://ms-ceintl.gallery.vsassets.io/_apis/public/gallery/publisher/MS-CEINTL/extension/vscode-language-pack-zh-hans/1.104.2025091009/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage</code>，并把下载后文件名字改为 <code>ms-ceintl.vscode-language-pack-zh-hans.vsix</code>。</li>
<li>把下载好的插件放置到<code>code</code>项目的 <code>extensions-vsix</code>目录下
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/973f5171ce814161ad547ee003820b91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=PRMqfYxAy7lZ1tp5su4Pf7BhdrQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
<ol start="2">
<li>在 <code>product.json</code>中添加内置翻译插件配置， sha256如果与我同版本则可以复用，如果不同版本，则在打包报错时改为使用报错输出给的sha256值。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f3a03caca064921a0ec20669954891b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=m0LulfDcqbqjsmCheD6KL9ZHNDc%3D" alt="image.png" loading="lazy"/></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"builtInExtensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ms-ceintl.vscode-language-pack-zh-hans"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.104.2025081708"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"sha256"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2015e764d028adb155bbaf143b0686c9504dc8f4c82d8804641cba93f1143630"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"repo"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/Microsoft/vscode-loc"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"vsix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./extensions-vsix/ms-ceintl.vscode-language-pack-zh-hans.vsix"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
				<span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ms-ceintl.vscode-language-pack-zh-hans"</span><span class="hljs-punctuation">,</span>
				<span class="hljs-attr">"publisherId"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
					<span class="hljs-attr">"publisherId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ms-ceintl"</span><span class="hljs-punctuation">,</span>
					<span class="hljs-attr">"publisherName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ms-ceintl"</span><span class="hljs-punctuation">,</span>
					<span class="hljs-attr">"displayName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Microsoft"</span><span class="hljs-punctuation">,</span>
					<span class="hljs-attr">"flags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"verified"</span>
				<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
				<span class="hljs-attr">"publisherDisplayName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Microsoft"</span>
			<span class="hljs-punctuation">}</span>
		<span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">问题与排查</h3>
<ul>
<li>此时直接打包并运行程序，会发现程序支持了命令面板中切换中英文，但是切换重启程序后并没有使用到中文的翻译；查看命令面板发现也是未切换。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8ce4fcc6c574458aaf853839231c9a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=EmnQL4%2FntKvxX7xeGLEfCc6yWb0%3D" alt="image.png" loading="lazy"/></li>
<li>问题是出在了<code>插件安装</code>和<code>语言包加载</code>流程中，内置的插件是不走安装流程的，也就导致了无法写入到<code>languagePacks.json</code>配置中，启动项目时也就无法加载到翻译文件
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b161be7d25f94442beeed2b19c226c49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=3W7DyQW8Qj%2BwfXVakDCXG3q%2F1ZQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-5">解决问题思路</h3>
<ol>
<li>既然内置插件不走插件安装流程，且又需要确保翻译插件的数据添加到<code>languagePacks.json</code>文件中；那我们就干脆在启动时主动执行一次添加packs的操作。</li>
<li>由于是二次开发已有项目，那么就要尽量减少改动，遵循原程序的开发流程。所以我的实现方式是复用已有的方法，并且在app加载完<code>services</code>后再实现。以下是代码实现：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29271f4f0c02491bba9038b75f40f7a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=ECItIa0%2Bft854KHV6JnBP%2FTh1IY%3D" alt="image.png" loading="lazy"/></li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检测内置语言插件是否加载成功</span>
	private <span class="hljs-keyword">async</span> <span class="hljs-title function_">checkLangBuiltinExtensions</span>(<span class="hljs-params">instantiationService: IInstantiationService</span>) {
		<span class="hljs-keyword">const</span> userLocale = process.<span class="hljs-property">env</span>[<span class="hljs-string">'jerry_lang_reload'</span>]
		<span class="hljs-keyword">if</span> (userLocale) {
			<span class="hljs-comment">// const extensionsScannerService = accessor.get(IExtensionsScannerService);</span>
			<span class="hljs-comment">// const extensionManagementService = accessor.get(IExtensionManagementService);</span>
			<span class="hljs-keyword">const</span> productService = instantiationService.<span class="hljs-title function_">invokeFunction</span>(<span class="hljs-function"><span class="hljs-params">accessor</span> =&gt;</span> accessor.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">IProductService</span>));

			<span class="hljs-keyword">const</span> userDataProfileService = instantiationService.<span class="hljs-title function_">invokeFunction</span>(<span class="hljs-function"><span class="hljs-params">accessor</span> =&gt;</span> accessor.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">IUserDataProfilesMainService</span>));
			<span class="hljs-keyword">const</span> extensionScanner = instantiationService.<span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">ExtensionsScanner</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>());
			<span class="hljs-keyword">const</span> packCache = instantiationService.<span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">LanguagePacksCache</span>);

			<span class="hljs-keyword">const</span> packs = <span class="hljs-keyword">await</span> packCache.<span class="hljs-title function_">getLanguagePacks</span>()

			<span class="hljs-keyword">if</span> (!packs[userLocale]) {
				<span class="hljs-keyword">const</span> exts = <span class="hljs-keyword">await</span> extensionScanner.<span class="hljs-title function_">scanExtensions</span>(<span class="hljs-literal">null</span>, userDataProfileService.<span class="hljs-property">defaultProfile</span>.<span class="hljs-property">extensionsResource</span>, { <span class="hljs-attr">version</span>: productService.<span class="hljs-property">version</span>, <span class="hljs-attr">date</span>: productService.<span class="hljs-property">date</span> })
				<span class="hljs-comment">// const langPacks = await	packCache.update(exts)</span>
				<span class="hljs-keyword">const</span> packs2 = <span class="hljs-keyword">await</span> packCache.<span class="hljs-title function_">update</span>(exts)
				<span class="hljs-comment">// console.log({ packs, exts, packs2 });</span>
				<span class="hljs-variable language_">this</span>.<span class="hljs-property">logService</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">'checkLangBuiltinExtensions:'</span>, userLocale, <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(packs2));
				<span class="hljs-variable language_">this</span>.<span class="hljs-property">lifecycleMainService</span>.<span class="hljs-title function_">relaunch</span>()
			}
		}
	}
</code></pre>
<p>用到的<code>env['jerry_lang-reload']</code>后面会讲解从何而来，此时要记得去导出<code>ExtensionsScanner</code>类；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e35c5e3c3954c0cb065874ac967fa23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=yPfH6Ozv5vg321iuud2qicHRm8c%3D" alt="image.png" loading="lazy"/>
4. 开始优化实现</p>
<ul>
<li>在 <code>src/main.ts</code>中优化默认使用语言
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d80e56848446a4a47aa65a1ba76d09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=kptZa2%2BOvWuKQWkFFzv0YFdkciA%3D" alt="image.png" loading="lazy"/></li>
<li>在解析nls配置时，标记环境变量判断是否需要走检测插件流程
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00347f5aba8940a39f19876f7182875a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgendx5YaZanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696529&amp;x-signature=a4K0osPhQ8Qe%2BdamWNF8V7CZ6t4%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p>到此处，应该功能是已经正常实现了，可以打包之后测试一下。有其他模块想要自定义的可以说一下。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VonaJS: 序列化/数据脱敏(上)]]></title>    <link>https://juejin.cn/post/7572147440313221183</link>    <guid>https://juejin.cn/post/7572147440313221183</guid>    <pubDate>2025-11-14T03:50:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572147440313221183" data-draft-id="7572048000302743593" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VonaJS: 序列化/数据脱敏(上)"/> <meta itemprop="keywords" content="Node.js,TypeScript,NestJS"/> <meta itemprop="datePublished" content="2025-11-14T03:50:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="濮水大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1119781972622208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VonaJS: 序列化/数据脱敏(上)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1119781972622208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    濮水大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:50:11.000Z" title="Fri Nov 14 2025 03:50:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序列化/数据脱敏</h2>
<p>VonaJS 提供了<code>序列化</code>能力，可以对 API 的响应数据进行转换，比如：排除密码字段，对 Email 和 Mobile 进行脱敏处理，等等</p>
<p>先介绍通用的序列化机制，再介绍一组工具函数。通过工具函数可以更加便利的使用序列化能力</p>
<h3 data-id="heading-1">创建Serializer Transform</h3>
<p>比如，在模块 demo-student 中创建一个 Serializer Transform: <code>upper</code>，将字段值转化为大写</p>
<h4 data-id="heading-2">1. Cli命令</h4>
<pre><code class="hljs language-bash" lang="bash">$ vona :create:bean serializerTransform upper --module=demo-student
</code></pre>
<h4 data-id="heading-3">2. 菜单命令</h4>
<pre><code class="hljs language-bash" lang="bash">右键菜单 - [模块路径]: `Vona Bean/Serializer Transform`
</code></pre>
<h3 data-id="heading-4">Serializer Transform定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypeSerializerTransformUpperValue</span> = <span class="hljs-built_in">string</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypeSerializerTransformUpperData</span> = <span class="hljs-built_in">unknown</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypeSerializerTransformUpperResult</span> = <span class="hljs-title class_">TypeSerializerTransformUpperValue</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISerializerTransformOptionsUpper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IDecoratorSerializerTransformOptions</span> {}

<span class="hljs-meta">@SerializerTransform</span>&lt;<span class="hljs-title class_">ISerializerTransformOptionsUpper</span>&gt;()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializerTransformUpper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BeanBase</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(
    <span class="hljs-attr">value</span>: <span class="hljs-title class_">TypeSerializerTransformUpperValue</span>,
    <span class="hljs-attr">_data</span>: <span class="hljs-title class_">TypeSerializerTransformUpperData</span>,
    <span class="hljs-attr">_options</span>: <span class="hljs-title class_">ISerializerTransformOptionsUpper</span>,
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TypeSerializerTransformUpperResult</span>&gt; {
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toUpperCase</span>();
  }
}
</code></pre>
<ul>
<li><code>TypeSerializerTransformUpperValue</code>: 定义字段类型</li>
<li><code>TypeSerializerTransformUpperData</code>: 定义外层 object 对象类型</li>
<li><code>TypeSerializerTransformUpperResult</code>: 定义结果类型</li>
<li><code>transform</code>: 将字段值转为大写</li>
</ul>
<h3 data-id="heading-5">使用Serializer Transform</h3>
<p>比如学生 API<code>findOne</code>方法返回的结果类型是<code>EntityStudent</code>。下面将<code>EntityStudent</code>的<code>name</code>字段转为大写</p>
<h4 data-id="heading-6">1. 开启序列化</h4>
<p>需要为 API 开启序列化</p>
<pre><code class="hljs language-diff" lang="diff">class ControllerStudent {
  @Web.get(':id')
  @Api.body(v.optional(), v.object(EntityStudent))
<span class="hljs-addition">+ @Serializer.enable()</span>
  async findOne(id) {
    return await this.scope.service.student.findOne(id);
  }
}
</code></pre>
<ul>
<li><code>@Serializer.enable</code>: 开启序列化</li>
</ul>
<h4 data-id="heading-7">2. 设置字段</h4>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.transform('demo-student:upper')</span>
  @Api.field(v.title($locale('Name')), v.default(''), v.min(3))
  name: string;
}
</code></pre>
<ul>
<li><code>@Serializer.transform</code>: 传入 Serializer Transform 名称<code>demo-student:upper</code></li>
</ul>
<h3 data-id="heading-8">Filter参数</h3>
<p>可以为 Serializer Transform 传入 Filter 参数。系统先执行 Filter 函数，根据结果来控制当前 Serializer Transform 是否需要执行</p>
<p>比如，如果当前用户名是<code>admin</code>则不执行<code>upper</code>的转换逻辑</p>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
  @Serializer.transform('demo-student:upper', {
<span class="hljs-addition">+   filter(this: VonaContext) {</span>
<span class="hljs-addition">+     return this.user.name !== 'admin';</span>
<span class="hljs-addition">+   },</span>
  })
  @Api.field(v.title($locale('Name')), v.default(''), v.min(3))
  name: string;
}
</code></pre>
<h3 data-id="heading-9">Serializer Transform参数</h3>
<p>可以为 Serializer Transform 定义参数，通过参数更灵活的配置转换逻辑</p>
<p>比如，为 Serializer Transform <code>upper</code>定义<code>first</code>参数，用于控制是否只将首字母转为大写</p>
<h4 data-id="heading-10">1. 定义参数类型</h4>
<pre><code class="hljs language-diff" lang="diff">export interface ISerializerTransformOptionsUpper extends IDecoratorSerializerTransformOptions {
<span class="hljs-addition">+ first?: boolean;</span>
}
</code></pre>
<h4 data-id="heading-11">2. 提供参数缺省值</h4>
<pre><code class="hljs language-diff" lang="diff">@SerializerTransform&lt;ISerializerTransformOptionsUpper&gt;({
<span class="hljs-addition">+ first: false,</span>
})
</code></pre>
<h4 data-id="heading-12">3. 使用参数</h4>
<pre><code class="hljs language-diff" lang="diff">export interface ISerializerTransformOptionsUpper extends IDecoratorSerializerTransformOptions {
  first?: boolean;
}

@SerializerTransform&lt;ISerializerTransformOptionsUpper&gt;({
  first: false,
})
class SerializerTransformUpper {
  async transform(
    value: TypeSerializerTransformUpperValue,
    _data: TypeSerializerTransformUpperData,
    options: ISerializerTransformOptionsUpper,
  ): Promise&lt;TypeSerializerTransformUpperResult&gt; {
<span class="hljs-deletion">-   return value.toUpperCase();</span>
<span class="hljs-addition">+   return options.first ? toUpperCaseFirstChar(value) : value.toUpperCase();</span>
  }
}
</code></pre>
<h4 data-id="heading-13">4. 使用时指定参数</h4>
<p>可以指定<code>@Serializer.transform</code>的参数</p>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.transform('demo-student:upper', { first: true })</span>
  @Api.field(v.title($locale('Name')), v.default(''), v.min(3))
  name: string;
}
</code></pre>
<h4 data-id="heading-14">5. App Config配置</h4>
<p>可以在 App Config 中配置 Serializer Transform 参数</p>
<p><code>src/backend/config/config/config.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">serializerTransform</span>: {
    <span class="hljs-string">'demo-student:upper'</span>: {
      <span class="hljs-attr">first</span>: <span class="hljs-literal">true</span>,
    },
  },
};
</code></pre>
<h4 data-id="heading-15">6. 参数优先级</h4>
<p><code>使用时指定参数</code> &gt; <code>App Config配置</code> &gt; <code>参数缺省值</code></p>
<h3 data-id="heading-16">资源</h3>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvonajs%2Fvona" target="_blank" title="https://github.com/vonajs/vona" ref="nofollow noopener noreferrer">github.com/vonajs/vona</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org" target="_blank" title="https://vona.js.org" ref="nofollow noopener noreferrer">vona.js.org</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[针对Element UI 浏览器自动填充账号密码导致的白色背景问题修复方案，这是CSS自动填充样式覆盖的经典问题]]></title>    <link>https://juejin.cn/post/7572132916575256612</link>    <guid>https://juejin.cn/post/7572132916575256612</guid>    <pubDate>2025-11-14T03:51:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132916575256612" data-draft-id="7571815573933244479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="针对Element UI 浏览器自动填充账号密码导致的白色背景问题修复方案，这是CSS自动填充样式覆盖的经典问题"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-14T03:51:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apollo_qwe"/> <meta itemprop="url" content="https://juejin.cn/user/2788017221151342"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            针对Element UI 浏览器自动填充账号密码导致的白色背景问题修复方案，这是CSS自动填充样式覆盖的经典问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017221151342/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apollo_qwe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:51:28.000Z" title="Fri Nov 14 2025 03:51:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个问题很常见，根源是浏览器对自动填充表单的默认 <code>-webkit-autofill</code> 伪类样式覆盖了 Element UI 的默认样式，优化核心是针对性覆盖该伪类样式。</p>
<h3 data-id="heading-0">一、核心优化方案（Vue 项目适用）</h3>
<p>通过样式穿透（<code>/deep/</code> 或 <code>:v-deep</code>）定位到 <code>el-input</code> 内部的 <code>input</code> 元素，覆盖浏览器自动填充的默认样式。</p>
<h4 data-id="heading-1">具体代码：</h4>
<pre><code class="hljs language-css" lang="css">&lt;el-<span class="hljs-selector-tag">input</span> type="password" class="no-autofill-bg"&gt;
// 修复自动填充背景色
:<span class="hljs-built_in">deep</span>(.no-autofill-bg) {
  <span class="hljs-selector-class">.el-input__wrapper</span> {
    <span class="hljs-attribute">box-shadow</span>:
      <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>) inset,
      <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1000px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">4</span>, <span class="hljs-number">44</span>, <span class="hljs-number">133</span>, <span class="hljs-number">0.7</span>) inset <span class="hljs-meta">!important</span>;

    &amp;:-webkit-autofill {
      -webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span> <span class="hljs-meta">!important</span>;
      <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">5000s</span> ease-in-out <span class="hljs-number">0s</span> <span class="hljs-meta">!important</span>;
      <span class="hljs-attribute">box-shadow</span>:
        <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>) inset,
        <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1000px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">4</span>, <span class="hljs-number">44</span>, <span class="hljs-number">133</span>, <span class="hljs-number">0.7</span>) inset <span class="hljs-meta">!important</span>;
    }

    &amp;:-webkit-autofill:focus {
      -webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span> <span class="hljs-meta">!important</span>;
      <span class="hljs-attribute">box-shadow</span>:
        <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">#409eff</span> inset,
        <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1000px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">4</span>, <span class="hljs-number">44</span>, <span class="hljs-number">133</span>, <span class="hljs-number">0.9</span>) inset <span class="hljs-meta">!important</span>;
    }
  }

  <span class="hljs-selector-class">.el-input__inner</span> {
    &amp;:-webkit-autofill {
      -webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span> <span class="hljs-meta">!important</span>;
      <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">5000s</span> ease-in-out <span class="hljs-number">0s</span> <span class="hljs-meta">!important</span>;
    }
  }
}
</code></pre>
<h4 data-id="heading-2">代码解释:</h4>
<h4 data-id="heading-3">1. 外层选择器 <code>:deep(.no-autofill-bg)</code></h4>
<ul>
<li><code>:deep()</code> 是 Vue 3 中的<strong>深度选择器</strong>，用于穿透组件的样式隔离（Vue 的 Scoped CSS 会限制样式仅作用于当前组件）。这里表示：要修改<strong>类名为 <code>no-autofill-bg</code> 的元素内部</strong>的子组件样式（这里特指 Element UI 的 <code>el-input</code> 组件）。</li>
<li>作用：让后续样式能影响到 <code>el-input</code> 组件内部的 DOM 结构（因为 <code>el-input</code> 是独立组件，默认情况下父组件的 Scoped CSS 无法修改其内部样式）。</li>
</ul>
<h4 data-id="heading-4">2. <code>.el-input__wrapper</code> 样式（输入框外层容器）</h4>
<p><code>el-input__wrapper</code> 是 Element UI 中输入框的外层容器类名，用于控制输入框的整体容器样式。</p>
<ul>
<li>
<p><strong>基础样式</strong>：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">box-shadow</span>:
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>) inset,  <span class="hljs-comment">/* 1px 白色半透明内边框（模拟边框效果） */</span>
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1000px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">4</span>, <span class="hljs-number">44</span>, <span class="hljs-number">133</span>, <span class="hljs-number">0.7</span>) inset <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 大尺寸内阴影模拟背景色（深蓝色半透明） */</span>
</code></pre>
<ul>
<li>用 <code>inset</code> 内阴影模拟背景色和边框：因为内阴影的优先级高于默认背景，且可以避免某些场景下背景色被覆盖的问题。</li>
<li><code>!important</code> 强制优先级，确保覆盖 Element UI 的默认样式。</li>
</ul>
</li>
<li>
<p><strong><code>: -webkit-autofill</code> 伪类</strong>（输入框被自动填充时）：浏览器自动填充（如记住的账号密码）时，WebKit 内核会默认给输入框添加黄色背景和特定文本色，这里用于覆盖默认样式：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css">-webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span> <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 强制自动填充时文本为白色 */</span>
<span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">5000s</span> ease-in-out <span class="hljs-number">0s</span> <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 关键技巧：通过极长过渡时间阻止默认黄色背景（浏览器自动填充会触发背景色变化，这里让变化延迟5000秒，相当于"冻结"背景） */</span>
<span class="hljs-attribute">box-shadow</span>: ...;  <span class="hljs-comment">/* 保持和基础样式一致的内阴影（确保自动填充时背景不变） */</span>
</code></pre>
</li>
<li>
<p><strong><code>: -webkit-autofill:focus</code> 伪类</strong>（自动填充状态下且输入框获焦时）：当自动填充的输入框被点击（获得焦点）时，进一步调整样式：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">box-shadow</span>:
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">#409eff</span> inset,  <span class="hljs-comment">/* 1px 蓝色内边框（Element UI 主题色，突出焦点状态） */</span>
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1000px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">4</span>, <span class="hljs-number">44</span>, <span class="hljs-number">133</span>, <span class="hljs-number">0.9</span>) inset <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 背景色加深（比非焦点时更深的蓝色） */</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-5">3. <code>.el-input__inner</code> 样式（输入框内部输入元素）</h4>
<p><code>el-input__inner</code> 是 Element UI 中输入框内部实际的 <code>&lt;input&gt;</code> 标签类名，用于控制输入框本身的样式。</p>
<ul>
<li>
<p><strong><code>: -webkit-autofill</code> 伪类</strong>：补充控制输入框元素本身的自动填充样式，确保文本色和背景过渡与外层容器一致：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css">-webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span> <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 强制文本为白色（和外层保持一致） */</span>
<span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">5000s</span> ease-in-out <span class="hljs-number">0s</span> <span class="hljs-meta">!important</span>;  <span class="hljs-comment">/* 同样阻止默认黄色背景 */</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VonaJS: 序列化/数据脱敏(下)]]></title>    <link>https://juejin.cn/post/7572138663120289834</link>    <guid>https://juejin.cn/post/7572138663120289834</guid>    <pubDate>2025-11-14T03:52:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572138663120289834" data-draft-id="7572138663120273450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VonaJS: 序列化/数据脱敏(下)"/> <meta itemprop="keywords" content="Node.js,TypeScript,NestJS"/> <meta itemprop="datePublished" content="2025-11-14T03:52:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="濮水大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1119781972622208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VonaJS: 序列化/数据脱敏(下)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1119781972622208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    濮水大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:52:38.000Z" title="Fri Nov 14 2025 03:52:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>VonaJS 提供了<code>序列化</code>能力，可以对 API 的响应数据进行转换，比如：排除密码字段，对 Email 和 Mobile 进行脱敏处理，等等</p>
<p>前文介绍了<code>序列化</code>的一般用法。这里再介绍一组工具函数。通过工具函数可以更加便利的使用序列化能力</p>
<h2 data-id="heading-0">工具清单</h2>



































<table><thead><tr><th>工具: @Serializer</th><th>工具: v</th><th>说明</th></tr></thead><tbody><tr><td>@Serializer.transform</td><td>v.serializerTransform</td><td>使用Serializer Transform，参见: <a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org%2Fzh%2Fguide%2Ftechniques%2Fserialization%2Fintroduction.html" target="_blank" title="https://vona.js.org/zh/guide/techniques/serialization/introduction.html" ref="nofollow noopener noreferrer">序列化</a></td></tr><tr><td>@Serializer.exclude</td><td>v.serializerExclude</td><td>排除字段</td></tr><tr><td>@Serializer.replace</td><td>v.serializerReplace</td><td>对字段值进行脱敏处理</td></tr><tr><td>@Serializer.getter</td><td>v.serializerGetter</td><td>采用getter机制生成新的字段值</td></tr><tr><td>@Serializer.custom</td><td>v.serializerCustom</td><td>使用自定义函数对字段值进行处理</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">既然`@Serializer`工具非常简洁，直观，为什么还要提供`v`工具？

1. `v`工具可以实现通过 App Config 修改配置
2. `v`工具和`@Serializer`工具底层逻辑是一致的
</code></pre>
<h2 data-id="heading-1">@Serializer.transform/v.serializerTransform</h2>
<p>比如，将<code>EntityStudent</code>中的<code>name</code>字段值转化为大写</p>
<p>我们直接使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org%2Fzh%2Fguide%2Ftechniques%2Fserialization%2Fintroduction.html" target="_blank" title="https://vona.js.org/zh/guide/techniques/serialization/introduction.html" ref="nofollow noopener noreferrer">序列化</a>中创建的 Serializer Transform <code>upper</code></p>
<h3 data-id="heading-2">1. @Serializer.transform</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.transform('demo-student:upper')</span>
  @Api.field(v.title($locale('Name')))
  name: string;
}
</code></pre>
<h3 data-id="heading-3">2. v.serializerTransform</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.serializerTransform('demo-student:upper'), v.title($locale('Name')))</span>
  name: string;
}
</code></pre>
<h3 data-id="heading-4">3. App Config</h3>
<p>可以在 App Config 中修改配置</p>
<p><code>src/backend/config/config/config.ts</code></p>
<ul>
<li>方法 1: 直接修改 Openapi 参数</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: {
          <span class="hljs-attr">serializerTransforms</span>: {
            <span class="hljs-string">'demo-student:upper'</span>: {},
          },
        },
      },
    },
  },
};
</code></pre>
<ul>
<li>方法 2: 构造一个新的 schema</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { $makeSchema, v } <span class="hljs-keyword">from</span> <span class="hljs-string">'vona-module-a-openapi'</span>;

<span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: $makeSchema(v.<span class="hljs-title function_">serializerTransform</span>(<span class="hljs-string">'demo-student:upper'</span>), z.<span class="hljs-title function_">string</span>()),
      },
    },
  },
};
</code></pre>
<h2 data-id="heading-5">@Serializer.exclude/v.serializerExclude</h2>
<p>比如，排除<code>EntityStudent</code>中的<code>name</code>字段</p>
<h3 data-id="heading-6">1. @Serializer.exclude</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.exclude()</span>
  @Api.field(v.title($locale('Name')))
  name: string;
}
</code></pre>
<h3 data-id="heading-7">2. v.serializerExclude</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.serializerExclude(), v.title($locale('Name')))</span>
  name: string;
}
</code></pre>
<h3 data-id="heading-8">3. App Config</h3>
<p>可以在 App Config 中修改配置</p>
<p><code>src/backend/config/config/config.ts</code></p>
<ul>
<li>方法 1: 直接修改 Openapi 参数</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: { <span class="hljs-attr">exclude</span>: <span class="hljs-literal">false</span> },
      },
    },
  },
};
</code></pre>
<ul>
<li>方法 2: 构造一个新的 schema</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { $makeSchema, v } <span class="hljs-keyword">from</span> <span class="hljs-string">'vona-module-a-openapi'</span>;

<span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: $makeSchema(v.<span class="hljs-title function_">serializerExclude</span>(), z.<span class="hljs-title function_">string</span>()),
      },
    },
  },
};
</code></pre>
<h2 data-id="heading-9">@Serializer.replace/v.serializerReplace</h2>
<p>比如，将<code>EntityStudent</code>中的<code>name</code>字段值进行脱敏处理</p>
<p>比如，name 原始值为<code>tom</code>，脱敏之后为<code>t***m</code></p>
<h3 data-id="heading-10">1. @Serializer.replace</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.replace({ patternFrom: /(\w)(\w+)(\w)/, patternTo: '$1***$3' })</span>
  @Api.field(v.title($locale('Name')))
  name: string;
}
</code></pre>
<h3 data-id="heading-11">2. v.serializerReplace</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
  @Api.field(
<span class="hljs-addition">+   v.serializerReplace({ patternFrom: /(\w)(\w+)(\w)/, patternTo: '$1***$3' }),</span>
    v.title($locale('Name')),
  )
  name: string;
}
</code></pre>
<h3 data-id="heading-12">3. App Config</h3>
<p>可以在 App Config 中修改配置</p>
<p><code>src/backend/config/config/config.ts</code></p>
<ul>
<li>方法 1: 直接修改 Openapi 参数</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: {
          <span class="hljs-attr">serializerTransforms</span>: {
            <span class="hljs-string">'a-serialization:replace'</span>: {
              <span class="hljs-attr">patternFrom</span>: <span class="hljs-regexp">/(\w)(\w+)(\w)/</span>,
              <span class="hljs-attr">patternTo</span>: <span class="hljs-string">'$1***$3'</span>,
            },
          },
        },
      },
    },
  },
};
</code></pre>
<p><code>a-serialization:replace</code>: <code>a-serialization</code>模块提供的 Serializer Transform</p>
<ul>
<li>方法 2: 构造一个新的 schema</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { $makeSchema, v } <span class="hljs-keyword">from</span> <span class="hljs-string">'vona-module-a-openapi'</span>;

<span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: $makeSchema(
          v.<span class="hljs-title function_">serializerReplace</span>({ <span class="hljs-attr">patternFrom</span>: <span class="hljs-regexp">/(\w)(\w+)(\w)/</span>, <span class="hljs-attr">patternTo</span>: <span class="hljs-string">'$1***$3'</span> }),
          z.<span class="hljs-title function_">string</span>(),
        ),
      },
    },
  },
};
</code></pre>
<h2 data-id="heading-13">@Serializer.getter/v.serializerGetter</h2>
<p>比如，<code>EntityStudent</code>中的<code>fullName</code>字段由<code>firstName</code>和<code>lastName</code>字段组合而成</p>
<h3 data-id="heading-14">1. getter</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
  @Api.field()
  firstName: string;

  @Api.field()
  lastName: string;

  @Api.field()
<span class="hljs-addition">+ get fullName(): string | undefined {</span>
<span class="hljs-addition">+   return `${this.firstName} ${this.lastName}`;</span>
<span class="hljs-addition">+ }</span>
}
</code></pre>
<h3 data-id="heading-15">2. @Serializer.getter</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.getter((data: EntityStudent) =&gt; {</span>
<span class="hljs-addition">+   return `${data.firstName} ${data.lastName}`;</span>
<span class="hljs-addition">+ })</span>
  @Api.field()
  fullName: string;
}
</code></pre>
<h3 data-id="heading-16">3. v.serializerGetter</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.serializerGetter((data: EntityStudent) =&gt; {</span>
<span class="hljs-addition">+   return `${data.firstName} ${data.lastName}`;</span>
<span class="hljs-addition">+ }))</span>
  fullName: string;
}
</code></pre>
<h3 data-id="heading-17">4. App Config</h3>
<p>可以在 App Config 中修改配置</p>
<p><code>src/backend/config/config/config.ts</code></p>
<ul>
<li>方法 1: 直接修改 Openapi 参数</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">fullName</span>: {
          <span class="hljs-attr">serializerTransforms</span>: {
            <span class="hljs-string">'a-serialization:getter'</span>: {
              <span class="hljs-attr">getter</span>: <span class="hljs-function">(<span class="hljs-params">data: EntityStudent</span>) =&gt;</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${data.firstName}</span> <span class="hljs-subst">${data.lastName}</span>`</span>;
              },
            },
          },
        },
      },
    },
  },
};
</code></pre>
<p><code>a-serialization:getter</code>: <code>a-serialization</code>模块提供的 Serializer Transform</p>
<ul>
<li>方法 2: 构造一个新的 schema</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { $makeSchema, v } <span class="hljs-keyword">from</span> <span class="hljs-string">'vona-module-a-openapi'</span>;

<span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">fullName</span>: $makeSchema(
          v.<span class="hljs-title function_">serializerGetter</span>(<span class="hljs-function">(<span class="hljs-params">data: EntityStudent</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${data.firstName}</span> <span class="hljs-subst">${data.lastName}</span>`</span>;
          }),
          z.<span class="hljs-title function_">string</span>(),
        ),
      },
    },
  },
};
</code></pre>
<h2 data-id="heading-18">@Serializer.custom/v.serializerCustom</h2>
<p>比如，将<code>EntityStudent</code>中的<code>name</code>字段值转换为大写</p>
<h3 data-id="heading-19">1. @Serializer.custom</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
<span class="hljs-addition">+ @Serializer.custom((value: string) =&gt; {</span>
<span class="hljs-addition">+   return value.toUpperCase();</span>
<span class="hljs-addition">+ })</span>
  @Api.field(v.title($locale('Name')))
  name: string;
}
</code></pre>
<h3 data-id="heading-20">2. v.serializerCustom</h3>
<pre><code class="hljs language-diff" lang="diff">class EntityStudent {
  @Api.field(
<span class="hljs-addition">+   v.serializerCustom((value: string) =&gt; {</span>
<span class="hljs-addition">+     return value.toUpperCase();</span>
<span class="hljs-addition">+   }),</span>
    v.title($locale('Name')),
  )
  name: string;
}
</code></pre>
<h3 data-id="heading-21">3. App Config</h3>
<p>可以在 App Config 中修改配置</p>
<p><code>src/backend/config/config/config.ts</code></p>
<ul>
<li>方法 1: 直接修改 Openapi 参数</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: {
          <span class="hljs-attr">serializerTransforms</span>: {
            <span class="hljs-string">'a-serialization:custom'</span>: {
              <span class="hljs-attr">custom</span>: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
                <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toUpperCase</span>();
              },
            },
          },
        },
      },
    },
  },
};
</code></pre>
<p><code>a-serialization:custom</code>: <code>a-serialization</code>模块提供的 Serializer Transform</p>
<ul>
<li>方法 2: 构造一个新的 schema</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { $makeSchema, v } <span class="hljs-keyword">from</span> <span class="hljs-string">'vona-module-a-openapi'</span>;

<span class="hljs-comment">// onions</span>
config.<span class="hljs-property">onions</span> = {
  <span class="hljs-attr">entity</span>: {
    <span class="hljs-string">'demo-student:student'</span>: {
      <span class="hljs-attr">fields</span>: {
        <span class="hljs-attr">name</span>: $makeSchema(
          v.<span class="hljs-title function_">serializerCustom</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toUpperCase</span>();
          }),
          z.<span class="hljs-title function_">string</span>(),
        ),
      },
    },
  },
};
</code></pre>
<h2 data-id="heading-22">资源</h2>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvonajs%2Fvona" target="_blank" title="https://github.com/vonajs/vona" ref="nofollow noopener noreferrer">github.com/vonajs/vona</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org" target="_blank" title="https://vona.js.org" ref="nofollow noopener noreferrer">vona.js.org</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[H5性能优化-打开效率提升了62%]]></title>    <link>https://juejin.cn/post/7572301616168583177</link>    <guid>https://juejin.cn/post/7572301616168583177</guid>    <pubDate>2025-11-14T03:06:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572301616168583177" data-draft-id="7572132100361175086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="H5性能优化-打开效率提升了62%"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-14T03:06:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德哥0904"/> <meta itemprop="url" content="https://juejin.cn/user/2172290708277623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            H5性能优化-打开效率提升了62%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290708277623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德哥0904
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:06:05.000Z" title="Fri Nov 14 2025 03:06:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、达成的结果</h2>
<p><strong>app嵌套h5 加载效率提升了62%。时间从平均2.259s 降到了0.852s</strong></p>
<h3 data-id="heading-1">二、优化过程</h3>
<p>思路：优化原生webview+h5 ，先测试webview点击到创建时间 120ms（无需优化）。webview 提供了 api 测试 加载url 的进度。但是没提供具体的类似pc端网络的工具。所以就通过ai搜索一些工具。发现阿里云的arms 方便引入。</p>
<p>测试设备 android荣耀50、华为meta9、华为p40、oppo</p>
<h2 data-id="heading-2">开发环境测试</h2>
<p>测试样本：优化前后各测试10次。</p>
<p>测试移动端h5 引入了阿里云的arms <a href="https://link.juejin.cn?target=https%3A%2F%2Farms.console.aliyun.com%2F" target="_blank" title="https://arms.console.aliyun.com/" ref="nofollow noopener noreferrer">arms.console.aliyun.com/</a> 可以查看加载某个url的时候 请求的js css、图片、网络请求 跟网页版的网络类似。</p>
<pre><code class="hljs language-php" lang="php">import ArmsRum <span class="hljs-keyword">from</span> <span class="hljs-string">'@arms/rum-browser'</span>

ArmsRum.<span class="hljs-title function_ invoke__">init</span>({
	<span class="hljs-attr">pid</span>: <span class="hljs-string">'ha63j3v892@efe71d242023cd5'</span>,
	<span class="hljs-attr">endpoint</span>: <span class="hljs-string">'https://ha63j3v892-default-cn.rum.aliyuncs.com'</span>,
	// 设置环境信息，参考值：<span class="hljs-string">'prod'</span> | <span class="hljs-string">'gray'</span> | <span class="hljs-string">'pre'</span> | <span class="hljs-string">'daily'</span> | <span class="hljs-string">'local'</span>
	<span class="hljs-attr">env</span>: <span class="hljs-string">'prod'</span>,
	// 设置路由模式， 参考值：<span class="hljs-string">'history'</span> | <span class="hljs-string">'hash'</span>
	<span class="hljs-attr">spaMode</span>: <span class="hljs-string">'hash'</span>,
	<span class="hljs-attr">collectors</span>: {
		// 页面性能指标监听开关，默认开启
		<span class="hljs-attr">perf</span>: <span class="hljs-literal">true</span>,
		// WebVitals指标监听开关，默认开启
		<span class="hljs-attr">webVitals</span>: <span class="hljs-literal">true</span>,
		// Ajax监听开关，默认开启
		<span class="hljs-attr">api</span>: <span class="hljs-literal">true</span>,
		// 静态资源开关，默认开启
		<span class="hljs-attr">staticResource</span>: <span class="hljs-literal">true</span>,
		// JS错误监听开关，默认开启
		<span class="hljs-attr">jsError</span>: <span class="hljs-literal">true</span>,
		// 控制台错误监听开关，默认开启
		<span class="hljs-attr">consoleError</span>: <span class="hljs-literal">true</span>,
		// 用户行为监听开关，默认开启
		<span class="hljs-attr">action</span>: <span class="hljs-literal">true</span>,
	},
	// 链路追踪配置开关，默认关闭
	<span class="hljs-attr">tracing</span>: <span class="hljs-literal">false</span>,
})

export <span class="hljs-keyword">default</span> ArmsRum
</code></pre>
<h4 data-id="heading-3">步骤一、懒加载echarts</h4>
<p>以前的代码</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Api</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">'echarts'</span>
<span class="hljs-keyword">import</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">'dayjs'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
}
</code></pre>
<p>现在的代码</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getRepairChart</span>(<span class="hljs-params"/>) {
			<span class="hljs-keyword">const</span> echarts = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'echarts'</span>)
			<span class="hljs-comment">// xxx</span>
			<span class="hljs-keyword">const</span> chartDom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'repairChart'</span>)
			<span class="hljs-keyword">const</span> myChart = echarts.<span class="hljs-title function_">init</span>(chartDom)
			<span class="hljs-keyword">const</span> option = {
			}
			myChart.<span class="hljs-title function_">setOption</span>(option)
		},
</code></pre>
<p>通过F12查看网络 发现加载列表的时候有出现echartsxxx.js 而且有800多k ,所以就考虑加载列表不应该去加载数据看板的数据。</p>
<p>优化前，测试前日志打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0dbd0b0d0574836b87635f4672395ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=JjIizh2Qh96YCdiJ8gyQ9Oyy3lE%3D" alt="" loading="lazy"/></p>
<p>平<strong>均是3.234s</strong> 然后 当然还测试了华为p40 、oppo机器 由于系统不一样时间有些差别</p>
<p>测试后日志打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/507f10afc0d44d2ab45b362af9346614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=3EwUj6aw3ZbISz61I4HQeX3z3og%3D" alt="" loading="lazy"/></p>
<p><strong>平均是1.71s</strong></p>
<hr/>
<p><strong>华为meta9 9年前的老手机打印log</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b77023980b49afa462ed8747aaec03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=4PG3Mtt1G52FU3DgsEsjIYweJRY%3D" alt="" loading="lazy"/></p>
<p>平均也2s多</p>
<p><strong>优化后</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adb8f84dfba94502895f733d232eb27c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=HO0DHnd8EtGmfhlRkKSuS7FxM3o%3D" alt="" loading="lazy"/></p>
<p>不到0.8s</p>
<h4 data-id="heading-4">步骤二、禁用预加载、路由懒加载</h4>
<p>通过查看网络发现请求<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev-haolipei.cias.cn%2Fapp%2F%23%2FtakeOrder" target="_blank" title="https://dev-haolipei.cias.cn/app/#/takeOrder" ref="nofollow noopener noreferrer">dev-haolipei.cias.cn/app/#/takeO…</a> 超级多的js 跟css</p>
<p>一张图都截取不完。当时就感觉肯定请求了很多无关紧要的资源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e30553165f8741d18edb78fbd1c8bb68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=jOcbTm0pxN%2FmOD1Ql%2FOP%2F8R3KAo%3D" alt="" loading="lazy"/></p>
<p>npm run build 执行后查看dist目录index.html 的确很触目惊心 加载了太多没必要的资源了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e785136933746819cd30194ba01a6a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=8tyO6ZjvrUjcjk5%2BYj0sXUwzHc0%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go">module.exports = {
	publicPath,
	devServer: {
		disableHostCheck: <span class="hljs-literal">true</span>,
		<span class="hljs-comment">// host: 'localhost.cias.cn',</span>
		proxy: {
			<span class="hljs-string">'/api'</span>: {
				target,
				changeOrigin: <span class="hljs-literal">true</span>,
				<span class="hljs-comment">// 	cookieDomainRewrite在手机调试时用得上</span>
				<span class="hljs-comment">// cookieDomainRewrite: '',</span>
				pathRewrite: {
					<span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span>,
				},
			},
			<span class="hljs-string">'/media'</span>: {
				target,
				changeOrigin: <span class="hljs-literal">true</span>,
				pathRewrite: {
					<span class="hljs-string">'^/media'</span>: <span class="hljs-string">''</span>,
				},
			},
		},
	},
	chainWebpack: config =&gt; {
		<span class="hljs-comment">// 禁用预加载</span>
		config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'preload'</span>)
		config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'prefetch'</span>)
	},
}
</code></pre>
<h5 data-id="heading-5">禁用它们的核心好处</h5>
<h5 data-id="heading-6">1. <strong>减少不必要的网络请求，节省带宽</strong></h5>
<ul>
<li>preload 可能会强制加载一些 “非关键资源”（如配置不当的情况下，预加载了体积大但当前页面暂时用不到的资源），导致带宽浪费。</li>
<li>prefetch 会预加载未来可能访问的路由 chunk（如用户可能不会点击的低频页面），如果用户最终没有访问这些页面，预加载的资源就成了 “无效请求”，尤其对移动端用户（流量有限）不友好。</li>
</ul>
<p>禁用后，资源仅在<strong>明确需要时才会加载</strong>（如用户进入对应路由时），避免 “提前加载但用不上” 的浪费。</p>
<h5 data-id="heading-7">2. <strong>避免阻塞关键资源加载，提升首屏速度</strong></h5>
<ul>
<li>浏览器对同一域名的并发请求数有限制（HTTP/1.1 通常为 6 个）。preload 加载的资源会占用并发名额，可能阻塞当前页面真正需要的关键资源（如核心 JS/CSS），导致首屏渲染延迟。</li>
<li>例如：若 preload 预加载了一个 2MB 的非关键 chunk，可能会挤占首屏 JS 的加载带宽，导致页面 “白屏时间” 变长。</li>
</ul>
<p>禁用后，浏览器的并发资源会优先分配给当前页面的核心资源，减少阻塞。</p>
<h5 data-id="heading-8">3. <strong>避免缓存资源被 “无效资源” 占用</strong></h5>
<p>浏览器缓存空间有限，prefetch 预加载的大量 “未来可能用到” 的 chunk 会占用缓存空间，可能导致真正需要长期缓存的核心资源（如 <code>chunk-vendors.js</code>）被挤出缓存，下次访问时需要重新加载。</p>
<p>禁用后，缓存可优先保留关键资源，提升二次访问速度。</p>
<h5 data-id="heading-9">4. <strong>适配低网速 / 弱网环境</strong></h5>
<p>在 3G、偏远地区等弱网环境下，preload/prefetch 的预加载行为会加剧网络拥堵：</p>
<ul>
<li>预加载的资源可能耗时过长，导致当前页面的核心资源加载超时。</li>
<li>禁用后，资源加载更 “轻量化”，优先保证当前页面可用，符合弱网环境的用户体验需求。</li>
</ul>
<h5 data-id="heading-10">5. <strong>减少开发环境的冗余加载</strong></h5>
<p>在开发环境中，Webpack 会频繁编译资源，preload/prefetch 可能导致每次热更新时加载大量无关资源，拖慢开发服务器响应速度，影响开发体验。禁用后可简化开发环境的资源加载逻辑，提升热更新效率。</p>
<h5 data-id="heading-11">注意：并非所有场景都适合禁用</h5>
<p>preload/prefetch 本身是性能优化手段，若项目存在以下情况，可能需要保留或部分配置：</p>
<ul>
<li>首屏依赖的关键资源（如核心 CSS、字体）体积大，preload 可加速其加载。</li>
<li>高频访问的路由（如首页→列表页），prefetch 可提前加载列表页 chunk，提升跳转速度。</li>
</ul>
<p>因此，禁用的合理性取决于项目场景：<strong>资源体积大、用户网络不稳定、低频路由多的项目（如移动端 H5）更适合禁用；高频路由明确、网络环境好的项目可选择性保留</strong>。</p>
<h5 data-id="heading-12">路由懒加载</h5>
<p>必须写上 /* webpackChunkName: "system-setting" */</p>
<p>以前的代码</p>
<pre><code class="hljs language-css" lang="css">	{
				path: <span class="hljs-string">'/takeOrder'</span>,
				name: <span class="hljs-string">'HomeTakeOrder'</span>,
				component: () =&gt;
					<span class="hljs-built_in">import</span>(
						<span class="hljs-string">'@/views/baosi/orderList.vue'</span>
					),
				meta: {
					title: <span class="hljs-string">'推返修列表'</span>,
					keepAlive: true,
				},
  }
</code></pre>
<p>懒加载路由模式</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">HomeTakeOrder</span> = (<span class="hljs-params"/>) =&gt;
	<span class="hljs-title function_">import</span>(<span class="hljs-params"><span class="hljs-comment">/* webpackChunkName: "take-order" */</span> <span class="hljs-string">'@/views/baosi/orderList.vue'</span></span>)

  {
				<span class="hljs-attr">path</span>: <span class="hljs-string">'/takeOrder'</span>,
				<span class="hljs-attr">name</span>: <span class="hljs-string">'HomeTakeOrder'</span>,
				<span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeTakeOrder</span>,
				<span class="hljs-attr">meta</span>: {
					<span class="hljs-attr">title</span>: <span class="hljs-string">'推返修列表'</span>,
					<span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>,
				},
			},
</code></pre>
<p>这样的好处 打包后 会有路由名称</p>
<h4 data-id="heading-13"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7b280b895ee493a87d9460239a9cfbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=iabYhwSGalWcvhjLKRDWXX0oMtQ%3D" alt="" loading="lazy"/></h4>
<p>对比</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34df500b01c4662a03700458aa88097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=%2BvxJkfWoCv8d7eGsOb0Qic8LHXk%3D" alt="" loading="lazy"/></p>
<p>继续测试打印log</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/690bb7e96f7443a8874bd60af99971f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=y28OeRDcmjFjlj7ncg12DnOSWCQ%3D" alt="" loading="lazy"/></p>
<p>可以看看网络请求 就只有5个js文件 总体积不到300k</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16650b9f8daa468fb8746bdd6dc37474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=R6mK3fYJNW6KGrglwhiWdEMsIbs%3D" alt="" loading="lazy"/></p>
<p><strong>平均是0.852，基本达成要求</strong></p>
<p>通过npm run build 本地打包看看文件对比大小。</p>
<p>1、体积巨减！！！</p>
<p>2、加载的文件名称是路由名称+hash值</p>
<p>优化前</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b75ac1c5e3a43bd9bff19148bb52ca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=HwC9djMy0ZnLIwAGgneaAZW2aMg%3D" alt="" loading="lazy"/></p>
<p>优化后</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06e23acce7114a64847029107ad8c6e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=HMcYNdNUP8jk51akjCBUsr6%2F6x4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">三、内部项目具体实践</h3>
<p>（增值移动端h5项目可以参考以下操作）</p>
<h4 data-id="heading-15">1、禁用预加载</h4>
<pre><code class="hljs language-go" lang="go">module.exports = {
	publicPath,
	devServer: {
		disableHostCheck: <span class="hljs-literal">true</span>,
		<span class="hljs-comment">// host: 'localhost.cias.cn',</span>
		proxy: {
			<span class="hljs-string">'/api'</span>: {
				target,
				changeOrigin: <span class="hljs-literal">true</span>,
				<span class="hljs-comment">// 	cookieDomainRewrite在手机调试时用得上</span>
				<span class="hljs-comment">// cookieDomainRewrite: '',</span>
				pathRewrite: {
					<span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span>,
				},
			},
			<span class="hljs-string">'/media'</span>: {
				target,
				changeOrigin: <span class="hljs-literal">true</span>,
				pathRewrite: {
					<span class="hljs-string">'^/media'</span>: <span class="hljs-string">''</span>,
				},
			},
		},
	},
	chainWebpack: config =&gt; {
		<span class="hljs-comment">// 禁用预加载</span>
		config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'preload'</span>)
		config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'prefetch'</span>)
	},
}
</code></pre>
<h4 data-id="heading-16">2、将路由全部改成懒加载</h4>
<p>并且路由需要/* webpackChunkName:"take-order" */</p>
<pre><code class="hljs language-css" lang="css">	{
				path: <span class="hljs-string">'/takeOrder'</span>,
				name: <span class="hljs-string">'HomeTakeOrder'</span>,
				component: () =&gt;
					<span class="hljs-built_in">import</span>(
						<span class="hljs-comment">/* webpackChunkName:"take-order" */</span> <span class="hljs-string">'@/views/baosi/orderList.vue'</span>
					),
				meta: {
					title: <span class="hljs-string">'推返修列表'</span>,
					keepAlive: true,
				},
  }
</code></pre>
<h4 data-id="heading-17">3、组件懒加载</h4>
<p>以前常见写法 就是一进来 把所有组件的都加载进来</p>
<p>比如这个车牌号组件有120k 对于比较大一点的组件可以用懒加载 。</p>
<pre><code class="hljs language-arduino" lang="arduino">	&lt;van-popup v-model=<span class="hljs-string">"showPlatePopup"</span> position=<span class="hljs-string">"bottom"</span> :overlay=<span class="hljs-string">"false"</span>&gt;
			&lt;keyboard
				v-model=<span class="hljs-string">"baseInfo.plateNumber"</span>
				:show.sync=<span class="hljs-string">"showPlatePopup"</span>
				@input=<span class="hljs-string">"handlePlateInput"</span>
			&gt;&lt;/keyboard&gt;


      <span class="hljs-keyword">import</span> <span class="hljs-built_in">Keyboard</span> from <span class="hljs-string">'@/components/numberplate/vnp-keyboard.vue'</span>

      <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  	name: <span class="hljs-string">'CreateOrder'</span>,
  	components: {
  		MultiSelectPopup,
  		DispatchingPopup,
  		DispatchFailPopup,
  		DispatchFinishPopup,
  		<span class="hljs-built_in">Keyboard</span>,
  	},
    
    }
</code></pre>
<p>懒加载代码</p>
<p>用这个方式可以直接在网络中查看到对应组件的名称和大小</p>
<pre><code class="hljs language-ini" lang="ini">&lt;van-popup
			<span class="hljs-attr">v-if</span>=<span class="hljs-string">"showPlatePopup"</span>
			<span class="hljs-attr">v-model</span>=<span class="hljs-string">"showPlatePopup"</span>
			<span class="hljs-attr">position</span>=<span class="hljs-string">"bottom"</span>
			:<span class="hljs-attr">overlay</span>=<span class="hljs-string">"false"</span>
		&gt;
			&lt;keyboard
				<span class="hljs-attr">v-model</span>=<span class="hljs-string">"baseInfo.plateNumber"</span>
				:<span class="hljs-attr">show.sync</span>=<span class="hljs-string">"showPlatePopup"</span>
				@<span class="hljs-attr">input</span>=<span class="hljs-string">"handlePlateInput"</span>
			&gt;&lt;/keyboard&gt;
		&lt;/van-popup&gt;

    export default {
	name: 'CreateOrder',
	components: {
		MultiSelectPopup,
		DispatchingPopup,
		DispatchFailPopup,
		DispatchFinishPopup,
		Keyboard: () =&gt;
			import(
				/* webpackChunkName: "keyboard" */
				'@/components/numberplate/vnp-keyboard.vue'
			),
	},
}
</code></pre>
<p>还有 特别大的第三方库 echart 懒加载 按需引入</p>
<h3 data-id="heading-18"><strong>四、总结</strong></h3>
<p>目前通过禁用预加载、路由懒加载、和第三方组件懒加载使用方式 基本能达到很大程度的优化效果。</p>
<p>但是看图 每次加载前面2个文件一个683k 另外一个285k 还是压缩了的文件 ，</p>
<p>我猜应该是main.js 引入了很多东西，后续还可以有优化空间。移动端的h5 入口文件尽量简洁。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64fefa5b359b4e3a819ba95e14261620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b635ZOlMDkwNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694365&amp;x-signature=dar4oM2ZgYVe2Y8%2BTJ30TPCQ4A0%3D" alt="" loading="lazy"/></p>
<p>(自己写的页面 一定多注意看一下 网络 有多少个js 和css 图片) 资源过大就要考虑优化了。</p>
<p>性能优化一定要<strong>多测试验证、多测试验证、多测试验证</strong>，保证业务正常情况下优化性能。</p>
<p>性能优化参考。</p>
<p><a href="https://juejin.cn/post/7188894691356573754?searchId=202505171533085DD27F1786539CD8C958#heading-0" target="_blank" title="https://juejin.cn/post/7188894691356573754?searchId=202505171533085DD27F1786539CD8C958#heading-0">juejin.cn/post/718889…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 插槽检测：$slots 的妙用与最佳实践]]></title>    <link>https://juejin.cn/post/7572138663120338986</link>    <guid>https://juejin.cn/post/7572138663120338986</guid>    <pubDate>2025-11-14T03:55:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572138663120338986" data-draft-id="7572126996176928803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 插槽检测：$slots 的妙用与最佳实践"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-14T03:55:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="P7Dreamer_Matt"/> <meta itemprop="url" content="https://juejin.cn/user/2506542244440894"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 插槽检测：$slots 的妙用与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2506542244440894/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    P7Dreamer_Matt
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:55:43.000Z" title="Fri Nov 14 2025 03:55:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 组件开发中，插槽（Slots）是实现组件灵活性的重要特性。但有时候我们需要知道父组件是否传递了某个插槽内容，这时候 <code>$slots</code> 就派上了用场。本文将深入探讨 Vue 中的插槽检测机制。</p>
<h2 data-id="heading-0">什么是插槽检测？</h2>
<p>插槽检测是指在组件内部判断父组件是否传递了特定的插槽内容。Vue 提供了 <code>$slots</code> 对象来帮助我们实现这一功能。</p>
<h3 data-id="heading-1">基本语法</h3>
<pre><code class="hljs language-ini" lang="ini">// 在模板中
&lt;div <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.search"</span>&gt;
  &lt;slot <span class="hljs-attr">name</span>=<span class="hljs-string">"search"</span> /&gt;
&lt;/div&gt;

// 在 Composition API 中
import { useSlots } from 'vue'
const <span class="hljs-attr">slots</span> = useSlots()
const <span class="hljs-attr">hasSearchSlot</span> = !!slots.search
</code></pre>
<h2 data-id="heading-2">实际应用场景</h2>
<h3 data-id="heading-3">1. 条件渲染容器</h3>
<p>在开发 TablePickerDialog 组件时，我们希望在父组件传递了搜索框插槽时才显示搜索区域：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- TablePickerDialog.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"dialogTitle"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 搜索框插槽 - 只有父组件传递了才显示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.search"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-slot"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"search"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 表格内容 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2. 动态表单布局</h3>
<p>在复杂的表单组件中，根据插槽内容动态调整布局：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- FollowRecordForm.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formData"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 基础信息区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>基础信息<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"basic"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 扩展信息区域 - 有条件显示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.extension"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>扩展信息<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"extension"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 附件区域 - 有条件显示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.attachment"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>附件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"attachment"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">3. 组件通信增强</h3>
<p>通过插槽检测实现更精细的组件通信：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AudioPicker.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"audio-picker"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 切换按钮 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"switch-tabs"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-group</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"audioSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-button</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"upload"</span>&gt;</span>上传音频<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-button</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"record"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.record"</span>&gt;</span>
          选择录音
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-group</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 上传区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"audioSource === 'upload'"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"upload"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 录音选择区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"audioSource === 'record' &amp;&amp; $slots.record"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"record"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">Vue 2 与 Vue 3 的区别</h2>
<h3 data-id="heading-7">Vue 2 (Options API)</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 检测插槽是否存在</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$slots</span>.<span class="hljs-property">search</span>) <span class="hljs-comment">// 具名插槽</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$slots</span>.<span class="hljs-property">default</span>) <span class="hljs-comment">// 默认插槽</span>
  },
  
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">hasSearchSlot</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> !!<span class="hljs-variable language_">this</span>.<span class="hljs-property">$slots</span>.<span class="hljs-property">search</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">Vue 3 (Composition API)</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSlots, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> slots = <span class="hljs-title function_">useSlots</span>()

<span class="hljs-comment">// 计算属性方式</span>
<span class="hljs-keyword">const</span> hasSearchSlot = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!slots.<span class="hljs-property">search</span>)
<span class="hljs-keyword">const</span> hasActionSlot = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!slots.<span class="hljs-property">action</span>)

<span class="hljs-comment">// 或者在模板中直接使用</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"slots.search"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-slot"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"search"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">最佳实践</h2>
<h3 data-id="heading-10">1. 性能优化</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 不推荐：总是渲染容器 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-slot"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"search"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐：有条件渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.search"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-slot"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"search"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">2. 提供默认内容</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"component-wrapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 有条件渲染插槽，提供默认内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$slots.header"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"default-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>默认标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主要内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">3. 组合式检测</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSlots, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> slots = <span class="hljs-title function_">useSlots</span>()

<span class="hljs-comment">// 检测多个插槽</span>
<span class="hljs-keyword">const</span> slotStatus = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">hasSearch</span>: !!slots.<span class="hljs-property">search</span>,
  <span class="hljs-attr">hasAction</span>: !!slots.<span class="hljs-property">action</span>,
  <span class="hljs-attr">hasFooter</span>: !!slots.<span class="hljs-property">footer</span>,
  <span class="hljs-attr">hasDefault</span>: !!slots.<span class="hljs-property">default</span>
}))

<span class="hljs-comment">// 根据插槽状态计算样式类</span>
<span class="hljs-keyword">const</span> containerClass = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-string">'with-search'</span>: slotStatus.<span class="hljs-property">value</span>.<span class="hljs-property">hasSearch</span>,
  <span class="hljs-string">'with-footer'</span>: slotStatus.<span class="hljs-property">value</span>.<span class="hljs-property">hasFooter</span>,
  <span class="hljs-string">'compact'</span>: !slotStatus.<span class="hljs-property">value</span>.<span class="hljs-property">hasSearch</span> &amp;&amp; !slotStatus.<span class="hljs-property">value</span>.<span class="hljs-property">hasFooter</span>
}))
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">TablePickerDialog</span> 
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"showDialog"</span> 
    <span class="hljs-attr">dialogTitle</span>=<span class="hljs-string">"选择录音"</span>
    <span class="hljs-attr">:tableData</span>=<span class="hljs-string">"tableData"</span>
    <span class="hljs-attr">:tableDefine</span>=<span class="hljs-string">"columns"</span>
  &gt;</span>
    <span class="hljs-comment">&lt;!-- 搜索框插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">search</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:inline</span>=<span class="hljs-string">"true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"呼叫类型"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"searchParams.callType"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"呼入"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"呼出"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 操作按钮插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">action</span>=<span class="hljs-string">"{ row }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handlePlay(row)"</span>&gt;</span>播放<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"warning"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleView(row)"</span>&gt;</span>详情<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 底部插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>&gt;</span>自定义操作<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">TablePickerDialog</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>插槽检测是 Vue 组件开发中的重要技巧，通过合理使用 <code>$slots</code> 可以实现：</p>
<ol>
<li><strong>条件渲染</strong>：避免渲染空的容器元素</li>
<li><strong>动态布局</strong>：根据插槽内容调整组件结构</li>
<li><strong>性能优化</strong>：减少不必要的 DOM 节点</li>
<li><strong>灵活配置</strong>：提供更友好的组件 API</li>
</ol>
<p>掌握插槽检测能让你的 Vue 组件更加灵活和健壮，提升开发效率和用户体验。</p>
<p>希望这篇文章能帮助你更好地理解和使用 Vue 的插槽检测功能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？]]></title>    <link>https://juejin.cn/post/7572157115907096626</link>    <guid>https://juejin.cn/post/7572157115907096626</guid>    <pubDate>2025-11-14T03:55:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572157115907096626" data-draft-id="7572180297735880713" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？  "/> <meta itemprop="keywords" content="Trae,AI编程,前端"/> <meta itemprop="datePublished" content="2025-11-14T03:55:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:55:34.000Z" title="Fri Nov 14 2025 03:55:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">浅响应式的概念：与深层响应式的区别</h2>
<p>Vue 的响应式系统默认是<strong>深层响应式</strong>的——当你用 <code>reactive</code> 或 <code>ref</code> 包裹对象时，Vue 会递归地将所有嵌套属性转换为响应式代理。比如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">a</span>: { <span class="hljs-attr">b</span>: <span class="hljs-number">1</span> } })
obj.<span class="hljs-property">value</span>.<span class="hljs-property">a</span>.<span class="hljs-property">b</span> = <span class="hljs-number">2</span> <span class="hljs-comment">// 触发更新（深层响应式）</span>
</code></pre>
<p>这种行为很方便，但也会带来性能开销：如果对象非常大（比如包含 thousands 条数据的列表），或者内部状态由外部库管理（比如 axios 响应、第三方状态库），深层代理会浪费资源。</p>
<p><strong>浅响应式</strong>（Shallow Reactivity）就是为了解决这个问题：它只跟踪<strong>顶层属性</strong>的变化，不处理嵌套对象的响应式。Vue 提供了两个 API 实现浅响应式：<code>shallowReactive</code>（对应 <code>reactive</code>）和 <code>shallowRef</code>（对应 <code>ref</code>）。</p>
<h2 data-id="heading-1">shallowReactive：只跟踪顶层属性的响应式对象</h2>
<p><code>shallowReactive</code> 是 <code>reactive</code> 的<strong>浅版本</strong>，它仅将对象的<strong>顶层属性</strong>转换为响应式，嵌套对象不会被代理。也就是说：</p>
<ul>
<li>修改顶层属性（如 <code>state.a</code>）会触发更新；</li>
<li>修改嵌套属性（如 <code>state.b.c</code>）不会触发更新；</li>
<li>替换嵌套对象的引用（如 <code>state.b = { new: 'data' }</code>）会触发更新（因为 <code>b</code> 是顶层属性）。</li>
</ul>
<h3 data-id="heading-2">示例代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowReactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建浅响应式对象</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">shallowReactive</span>({
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,          <span class="hljs-comment">// 顶层属性（响应式）</span>
  <span class="hljs-attr">b</span>: { <span class="hljs-attr">c</span>: <span class="hljs-number">2</span> }    <span class="hljs-comment">// 嵌套对象（非响应式）</span>
})

<span class="hljs-comment">// 1. 响应式变化：修改顶层属性</span>
state.<span class="hljs-property">a</span> = <span class="hljs-number">2</span> <span class="hljs-comment">// ✅ 触发组件更新</span>

<span class="hljs-comment">// 2. 非响应式变化：修改嵌套属性</span>
state.<span class="hljs-property">b</span>.<span class="hljs-property">c</span> = <span class="hljs-number">3</span> <span class="hljs-comment">// ❌ 不会触发更新</span>

<span class="hljs-comment">// 3. 响应式变化：替换嵌套对象引用</span>
state.<span class="hljs-property">b</span> = { <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> } <span class="hljs-comment">// ✅ 触发更新（因为 b 是顶层属性）</span>
</code></pre>
<h2 data-id="heading-3">shallowRef：只跟踪.value变化的浅引用</h2>
<p><code>shallowRef</code> 是 <code>ref</code> 的<strong>浅版本</strong>，它仅跟踪 <code>ref.value</code> 的<strong>替换操作</strong>，不处理 <code>value</code> 内部的深层响应式。也就是说：</p>
<ul>
<li>替换 <code>ref.value</code>（如 <code>obj.value = { new: 'data' }</code>）会触发更新；</li>
<li>修改 <code>ref.value</code> 的内部属性（如 <code>obj.value.a = 2</code>）不会触发更新。</li>
</ul>
<h3 data-id="heading-4">示例代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建浅引用</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">shallowRef</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> })

<span class="hljs-comment">// 1. 响应式变化：替换.value</span>
obj.<span class="hljs-property">value</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">2</span> } <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 2. 非响应式变化：修改.value内部属性</span>
obj.<span class="hljs-property">value</span>.<span class="hljs-property">a</span> = <span class="hljs-number">3</span> <span class="hljs-comment">// ❌ 不会触发更新</span>
</code></pre>
<p>注意：<code>shallowRef</code> 的 <code>.value</code> 本身是<strong>非响应式</strong>的——即使你用 <code>reactive</code> 包裹 <code>value</code>，<code>shallowRef</code> 也不会跟踪其内部变化。</p>
<h2 data-id="heading-5">浅响应式的应用场景：性能优化与外部状态管理</h2>
<p>浅响应式不是“替代”深层响应式，而是<strong>补充</strong>——当你需要<strong>减少响应式开销</strong>或<strong>不希望Vue跟踪内部状态</strong>时使用：</p>
<h3 data-id="heading-6">场景1：处理大型对象</h3>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F02b0c96842d1481c72dab63a149ce0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/02b0c96842d1481c72dab63a149ce0dd/" ref="nofollow noopener noreferrer">FastAPI如何用契约测试确保API的「菜单」与「菜品」一致？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc9c1e3bb0fdc15303b9b3b1f20124b0b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c9c1e3bb0fdc15303b9b3b1f20124b0b/" ref="nofollow noopener noreferrer">为什么TDD能让你的FastAPI开发飞起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbfa0447a5d0d6f9af12e7a6b206f70%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbfa0447a5d0d6f9af12e7a6b206f70/" ref="nofollow noopener noreferrer">如何用FastAPI玩转多模块测试与异步任务，让代码不再“闹脾气”？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<p>如果你的对象包含大量数据（比如表格的 thousands 条记录），但只需要跟踪顶层状态（如 <code>isLoading</code>、<code>currentPage</code>），用 <code>shallowReactive</code> 可以避免递归代理所有嵌套属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> tableState = <span class="hljs-title function_">shallowReactive</span>({
  <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">currentPage</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">data</span>: [] <span class="hljs-comment">// 大数组，内部变化无需Vue跟踪</span>
})
</code></pre>
<h3 data-id="heading-7">场景2：外部管理的状态</h3>
<p>如果对象的内部状态由<strong>外部库</strong>管理（比如 axios 的响应对象、Redux 的 store、第三方组件的状态），Vue 不需要跟踪其内部变化，用浅响应式更合适：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 用shallowRef包裹axios响应，只跟踪.value的替换</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-title function_">shallowRef</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>)
  response.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span> <span class="hljs-comment">// ✅ 触发更新（替换.value）</span>
}
</code></pre>
<h2 data-id="heading-8">实践示例：用shallowReactive管理外部API状态</h2>
<p>假设你有一个用户详情页，需要：</p>
<ul>
<li>跟踪 <code>isLoading</code>（加载状态，顶层属性）；</li>
<li>展示用户数据（由API返回，内部变化无需Vue跟踪）。</li>
</ul>
<h3 data-id="heading-9">完整组件代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { shallowReactive } from 'vue'

// 浅响应式状态：只跟踪顶层属性
const userState = shallowReactive({
  isLoading: true,
  userData: null // 由API填充，内部变化不触发Vue更新
})

// 模拟API请求
const fetchUser = async () =&gt; {
  userState.isLoading = true
  // 假设userData由外部API返回，内部状态无需Vue跟踪
  const res = await fetch('/api/user/1')
  const data = await res.json()
  userState.userData = data // ✅ 触发更新（替换顶层属性userData）
  userState.isLoading = false // ✅ 触发更新（修改顶层属性isLoading）
}

// 初始化加载
fetchUser()
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="user-page"&gt;
    &lt;!-- 加载状态（响应式） --&gt;
    &lt;div v-if="userState.isLoading" class="loading"&gt;加载中...&lt;/div&gt;
    
    &lt;!-- 用户数据（非响应式内部变化） --&gt;
    &lt;div v-else class="user-details"&gt;
      &lt;h2&gt;{{ userState.userData.name }}&lt;/h2&gt;
      &lt;p&gt;年龄：{{ userState.userData.age }}&lt;/p&gt;
      &lt;p&gt;邮箱：{{ userState.userData.email }}&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-10">效果说明</h3>
<ul>
<li>当 <code>isLoading</code> 或 <code>userData</code> 变化时（都是顶层属性），组件会更新；</li>
<li>如果 <code>userData</code> 内部的 <code>name</code> 变化（比如 <code>userState.userData.name = 'Bob'</code>），组件不会更新——因为这是嵌套属性，浅响应式不跟踪。</li>
</ul>
<h2 data-id="heading-11">课后Quiz：巩固浅响应式知识</h2>
<h3 data-id="heading-12">问题1（多选）</h3>
<p>以下关于 <code>shallowReactive</code> 的描述，正确的是？<br/>
A. <code>shallowReactive</code> 会使对象的所有属性（包括嵌套）响应式<br/>
B. <code>shallowReactive</code> 只使对象的顶层属性响应式<br/>
C. 修改 <code>shallowReactive</code> 对象的嵌套属性会触发更新<br/>
D. 替换 <code>shallowReactive</code> 对象的嵌套对象引用会触发更新</p>
<p><strong>答案</strong>：B、D<br/>
<strong>解析</strong>：<code>shallowReactive</code> 仅处理顶层属性，所以 B 正确；替换嵌套对象的引用（如 <code>state.b = { new: 'data' }</code>）是顶层属性的变化，会触发更新，所以 D 正确。</p>
<h3 data-id="heading-13">问题2（单选）</h3>
<p>当使用 <code>shallowRef</code> 时，以下哪种操作会触发组件更新？<br/>
A. 修改 <code>ref.value</code> 的内部属性（如 <code>obj.value.a = 2</code>）<br/>
B. 替换 <code>ref.value</code>（如 <code>obj.value = { a: 2 }</code>）<br/>
C. 修改 <code>ref</code> 的非 <code>.value</code> 属性（如 <code>obj.a = 2</code>）<br/>
D. 以上都不会</p>
<p><strong>答案</strong>：B<br/>
<strong>解析</strong>：<code>shallowRef</code> 只跟踪 <code>.value</code> 的替换操作，所以 B 正确；A 是内部属性变化，不会触发；C 是错误操作（<code>ref</code> 没有 <code>a</code> 属性，只有 <code>.value</code>）。</p>
<h2 data-id="heading-14">常见报错与解决方案</h2>
<h3 data-id="heading-15">报错场景1：修改shallowRef内部属性不触发更新</h3>
<p><strong>错误代码</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { shallowRef } from 'vue'

const user = shallowRef({ name: 'Alice' })

// 修改内部属性，但页面不更新
const changeName = () =&gt; {
  user.value.name = 'Bob'
}
&lt;/script&gt;

&lt;template&gt;
  &lt;p&gt;{{ user.value.name }}&lt;/p&gt;
  &lt;button @click="changeName"&gt;改名&lt;/button&gt;
&lt;/template&gt;
</code></pre>
<p><strong>原因</strong>：<code>shallowRef</code> 不跟踪 <code>.value</code> 内部的变化。<br/>
<strong>解决方案</strong>：</p>
<ol>
<li>改用 <code>ref</code>（需要深层响应式时）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> })
</code></pre>
</li>
<li>手动触发更新（用 <code>triggerRef</code>）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef, triggerRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">shallowRef</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> })

<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeName</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">value</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>
  <span class="hljs-title function_">triggerRef</span>(user) <span class="hljs-comment">// ✅ 手动触发更新</span>
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-16">报错场景2：修改shallowReactive嵌套属性不触发更新</h3>
<p><strong>错误代码</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { shallowReactive } from 'vue'

const state = shallowReactive({
  user: { name: 'Alice' }
})

// 修改嵌套属性，页面不更新
const changeName = () =&gt; {
  state.user.name = 'Bob'
}
&lt;/script&gt;

&lt;template&gt;
  &lt;p&gt;{{ state.user.name }}&lt;/p&gt;
  &lt;button @click="changeName"&gt;改名&lt;/button&gt;
&lt;/template&gt;
</code></pre>
<p><strong>原因</strong>：<code>shallowReactive</code> 不处理嵌套对象的响应式。<br/>
<strong>解决方案</strong>：</p>
<ol>
<li>改用 <code>reactive</code>（需要深层响应式时）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> } })
</code></pre>
</li>
<li>替换嵌套对象引用（触发顶层属性变化）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeName</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">user</span> = { ...state.<span class="hljs-property">user</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> } <span class="hljs-comment">// ✅ 替换引用，触发更新</span>
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-17">参考链接</h2>
<ul>
<li>Vue 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Freactivity-advanced.html%23shallowref" target="_blank" title="https://vuejs.org/api/reactivity-advanced.html#shallowref" ref="nofollow noopener noreferrer">Shallow Reactivity</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化实战：打造极致用户体验]]></title>    <link>https://juejin.cn/post/7572132916575141924</link>    <guid>https://juejin.cn/post/7572132916575141924</guid>    <pubDate>2025-11-14T03:31:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132916575141924" data-draft-id="7572132916575109156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化实战：打造极致用户体验"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-11-14T03:31:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小前端_我自坚强"/> <meta itemprop="url" content="https://juejin.cn/user/2335811609826423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化实战：打造极致用户体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335811609826423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小前端_我自坚强
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:31:05.000Z" title="Fri Nov 14 2025 03:31:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><h2 data-id="heading-0">前端性能优化实战：打造极致用户体验</h2>
<h3 data-id="heading-1">引言</h3>
<p>在当今数字化时代，网页性能直接影响用户体验和业务转化率。研究表明，页面加载时间每增加1秒，转化率可能下降7%，跳出率增加38%。因此，前端性能优化不仅是技术问题，更是商业问题。</p>
<p>本文将深入探讨前端性能优化的各个方面，包括加载优化、渲染优化、运行时优化等，并通过实际案例展示如何系统地提升网页性能。</p>
<h3 data-id="heading-2">第一章：性能指标体系</h3>
<h4 data-id="heading-3">1.1 关键性能指标（KPIs）</h4>
<h5 data-id="heading-4">Core Web Vitals（核心网页指标）</h5>
<ul>
<li><strong>Largest Contentful Paint (LCP)</strong>：衡量加载性能，目标：&lt;2.5秒</li>
<li><strong>First Input Delay (FID)</strong>：衡量交互性，目标：&lt;100毫秒</li>
<li><strong>Cumulative Layout Shift (CLS)</strong>：衡量视觉稳定性，目标：&lt;0.1</li>
</ul>
<h5 data-id="heading-5">其他重要指标</h5>
<ul>
<li><strong>First Contentful Paint (FCP)</strong>：首次内容绘制</li>
<li><strong>Time to Interactive (TTI)</strong>：可交互时间</li>
<li><strong>Total Blocking Time (TBT)</strong>：总阻塞时间</li>
</ul>
<h4 data-id="heading-6">1.2 性能测量工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Performance API 获取关键指标</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry.<span class="hljs-property">name</span>, entry.<span class="hljs-property">startTime</span>, entry.<span class="hljs-property">duration</span>);
  }
});

observer.<span class="hljs-title function_">observe</span>({<span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'navigation'</span>, <span class="hljs-string">'paint'</span>, <span class="hljs-string">'largest-contentful-paint'</span>]});
</code></pre>
<h3 data-id="heading-7">第二章：资源加载优化</h3>
<h4 data-id="heading-8">2.1 资源压缩与合并</h4>
<h5 data-id="heading-9">JavaScript/CSS 压缩</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js 示例</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        <span class="hljs-attr">terserOptions</span>: {
          <span class="hljs-attr">compress</span>: {
            <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 移除console</span>
            <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 移除debugger</span>
          },
        },
      }),
    ],
  },
};
</code></pre>
<h5 data-id="heading-10">图片优化策略</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 使用 picture 元素实现响应式图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(max-width: 799px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"small.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 800px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"large.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"default.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"描述"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">2.2 资源懒加载</h4>
<h5 data-id="heading-12">图片懒加载实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Intersection Observer 实现图片懒加载</span>
<span class="hljs-keyword">const</span> imageObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries, observer</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>;
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
      img.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'lazy'</span>);
      observer.<span class="hljs-title function_">unobserve</span>(img);
    }
  });
});

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[data-src]'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
  imageObserver.<span class="hljs-title function_">observe</span>(img);
});
</code></pre>
<h5 data-id="heading-13">组件懒加载</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 动态导入组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">AsyncComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./AsyncComponent.vue'</span>);

<span class="hljs-comment">// React 代码分割</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./LazyComponent'</span>));
</code></pre>
<h4 data-id="heading-14">2.3 预加载策略</h4>
<h5 data-id="heading-15">DNS预解析</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"//example.com"</span>&gt;</span>
</code></pre>
<h5 data-id="heading-16">资源预加载</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 预加载关键资源 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.css"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"image"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 预连接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://fonts.googleapis.com"</span>&gt;</span>
</code></pre>
<h3 data-id="heading-17">第三章：网络传输优化</h3>
<h4 data-id="heading-18">3.1 HTTP/2 优化</h4>
<p>HTTP/2 的多路复用、头部压缩等特性可以显著提升资源加载速度：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 启用 HTTP/2 Push（服务端配置）</span>
<span class="hljs-comment">// nginx.conf 示例</span>
location / {
  http2_push /critical.<span class="hljs-property">css</span>;
  http2_push /critical.<span class="hljs-property">js</span>;
}
</code></pre>
<h4 data-id="heading-19">3.2 Service Worker 缓存策略</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// service-worker.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'my-site-v1'</span>;
<span class="hljs-keyword">const</span> urlsToCache = [
  <span class="hljs-string">'/'</span>,
  <span class="hljs-string">'/styles/main.css'</span>,
  <span class="hljs-string">'/scripts/main.js'</span>
];

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(urlsToCache))
  );
});

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-comment">// 缓存命中则返回缓存，否则发起网络请求</span>
        <span class="hljs-keyword">return</span> response || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>);
      })
  );
});
</code></pre>
<h4 data-id="heading-20">3.3 CDN 优化</h4>
<p>合理使用 CDN 可以大幅减少资源加载时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack 配置 CDN 路径</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">publicPath</span>: <span class="hljs-string">'https://cdn.example.com/assets/'</span>
  }
};
</code></pre>
<h3 data-id="heading-21">第四章：渲染性能优化</h3>
<h4 data-id="heading-22">4.1 CSS 优化</h4>
<h5 data-id="heading-23">避免强制同步布局</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 避免触发重排的样式 */</span>
<span class="hljs-selector-class">.expensive-style</span> {
  <span class="hljs-comment">/* 避免使用这些属性 */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 触发重排 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 触发重排 */</span>
  
  <span class="hljs-comment">/* 更好的替代方案 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.5</span>); <span class="hljs-comment">/* 只触发合成 */</span>
}
</code></pre>
<h5 data-id="heading-24">使用 will-change 提升动画性能</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.animated-element</span> {
  <span class="hljs-attribute">will-change</span>: transform;
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.animated-element</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">10px</span>);
}
</code></pre>
<h4 data-id="heading-25">4.2 JavaScript 渲染优化</h4>
<h5 data-id="heading-26">虚拟滚动实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualList</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, itemHeight, items</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span> = itemHeight;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = items;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">visibleItems</span> = [];
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监听滚动事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onScroll</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    
    <span class="hljs-comment">// 初始化可见项</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateVisibleItems</span>();
  }
  
  <span class="hljs-title function_">onScroll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 节流处理</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateVisibleItems</span>();
    });
  }
  
  <span class="hljs-title function_">updateVisibleItems</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">scrollTop</span>;
    <span class="hljs-keyword">const</span> containerHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">clientHeight</span>;
    
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span>);
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
      startIndex + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(containerHeight / <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemHeight</span>) + <span class="hljs-number">1</span>,
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-property">length</span>
    );
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderItems</span>(startIndex, endIndex);
  }
  
  <span class="hljs-title function_">renderItems</span>(<span class="hljs-params">startIndex, endIndex</span>) {
    <span class="hljs-comment">// 只渲染可见区域的元素</span>
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = startIndex; i &lt; endIndex; i++) {
      <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createItemElement</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>[i], i);
      fragment.<span class="hljs-title function_">appendChild</span>(item);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(fragment);
  }
  
  <span class="hljs-title function_">createItemElement</span>(<span class="hljs-params">itemData, index</span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.itemHeight}</span>px`</span>;
    element.<span class="hljs-property">textContent</span> = itemData.<span class="hljs-property">text</span>;
    <span class="hljs-keyword">return</span> element;
  }
}
</code></pre>
<h5 data-id="heading-27">使用 DocumentFragment 减少 DOM 操作</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量添加元素的优化方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addItemsToList</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
  
  items.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> li = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>);
    li.<span class="hljs-property">textContent</span> = item;
    fragment.<span class="hljs-title function_">appendChild</span>(li);
  });
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'list'</span>).<span class="hljs-title function_">appendChild</span>(fragment);
}
</code></pre>
<h3 data-id="heading-28">第五章：运行时性能优化</h3>
<h4 data-id="heading-29">5.1 内存泄漏检测与修复</h4>
<h5 data-id="heading-30">常见内存泄漏场景</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 忘记清理定时器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 定时任务</span>
    }, <span class="hljs-number">1000</span>);
  }
  
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 销毁时清理定时器</span>
    <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>);
  }
}

<span class="hljs-comment">// 2. 事件监听器未移除</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span>);
  }
  
  <span class="hljs-title function_">handleClick</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-comment">// 处理点击事件</span>
  }
  
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 移除事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span>);
  }
}
</code></pre>
<h4 data-id="heading-31">5.2 防抖与节流优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 防抖函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
  <span class="hljs-keyword">let</span> timeoutId;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}

<span class="hljs-comment">// 节流函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit</span>) {
  <span class="hljs-keyword">let</span> inThrottle;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!inThrottle) {
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      inThrottle = <span class="hljs-literal">true</span>;
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> inThrottle = <span class="hljs-literal">false</span>, limit);
    }
  };
}

<span class="hljs-comment">// 应用场景</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-title function_">debounce</span>(handleResize, <span class="hljs-number">300</span>));
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">throttle</span>(handleScroll, <span class="hljs-number">100</span>));
</code></pre>
<h4 data-id="heading-32">5.3 Web Workers 并行计算</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'worker.js'</span>);

worker.<span class="hljs-title function_">postMessage</span>({<span class="hljs-attr">data</span>: largeDataSet});

worker.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果:'</span>, e.<span class="hljs-property">data</span>);
};

<span class="hljs-comment">// worker.js</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">performHeavyCalculation</span>(e.<span class="hljs-property">data</span>);
  self.<span class="hljs-title function_">postMessage</span>(result);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performHeavyCalculation</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 执行大量计算</span>
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item * <span class="hljs-number">2</span>);
}
</code></pre>
<h3 data-id="heading-33">第六章：移动端性能优化</h3>
<h4 data-id="heading-34">6.1 响应式设计优化</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用 CSS Grid 和 Flexbox 优化布局 */</span>
<span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
}

<span class="hljs-selector-class">.flex-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">justify-content</span>: space-between;
}
</code></pre>
<h4 data-id="heading-35">6.2 触摸优化</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 优化触摸体验 */</span>
<span class="hljs-selector-class">.touch-target</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-comment">/* 硬件加速 */</span>
<span class="hljs-selector-class">.animated-element</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);
  <span class="hljs-attribute">will-change</span>: transform;
}
</code></pre>
<h4 data-id="heading-36">6.3 PWA 优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// manifest.json</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"My App"</span>,
  <span class="hljs-string">"short_name"</span>: <span class="hljs-string">"App"</span>,
  <span class="hljs-string">"start_url"</span>: <span class="hljs-string">"/"</span>,
  <span class="hljs-string">"display"</span>: <span class="hljs-string">"standalone"</span>,
  <span class="hljs-string">"background_color"</span>: <span class="hljs-string">"#ffffff"</span>,
  <span class="hljs-string">"theme_color"</span>: <span class="hljs-string">"#000000"</span>
}

<span class="hljs-comment">// 注册 Service Worker</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SW registered'</span>))
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SW registration failed'</span>));
  });
}
</code></pre>
<h3 data-id="heading-37">第七章：监控与分析</h3>
<h4 data-id="heading-38">7.1 性能监控实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义性能监控</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 页面加载完成后的性能数据</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectMetrics</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportMetrics</span>();
      }, <span class="hljs-number">0</span>);
    });
  }
  
  <span class="hljs-title function_">collectMetrics</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> navigation = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> paint = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'paint'</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span> = {
      <span class="hljs-comment">// 页面加载时间</span>
      <span class="hljs-attr">loadTime</span>: navigation.<span class="hljs-property">loadEventEnd</span> - navigation.<span class="hljs-property">fetchStart</span>,
      
      <span class="hljs-comment">// DNS 查询时间</span>
      <span class="hljs-attr">dnsTime</span>: navigation.<span class="hljs-property">domainLookupEnd</span> - navigation.<span class="hljs-property">domainLookupStart</span>,
      
      <span class="hljs-comment">// TCP 连接时间</span>
      <span class="hljs-attr">tcpTime</span>: navigation.<span class="hljs-property">connectEnd</span> - navigation.<span class="hljs-property">connectStart</span>,
      
      <span class="hljs-comment">// FP 和 FCP</span>
      <span class="hljs-attr">firstPaint</span>: paint.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">name</span> === <span class="hljs-string">'first-paint'</span>)?.<span class="hljs-property">startTime</span> || <span class="hljs-number">0</span>,
      <span class="hljs-attr">firstContentfulPaint</span>: paint.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">name</span> === <span class="hljs-string">'first-contentful-paint'</span>)?.<span class="hljs-property">startTime</span> || <span class="hljs-number">0</span>
    };
  }
  
  <span class="hljs-title function_">reportMetrics</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 上报性能数据到服务器</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/performance'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>)
    });
  }
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMonitor</span>();
</code></pre>
<h4 data-id="heading-39">7.2 用户体验监控</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监控用户交互延迟</span>
<span class="hljs-keyword">let</span> firstInputDelay;
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, storeEventTiming, {<span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>});
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, storeEventTiming, {<span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>});
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchstart'</span>, storeEventTiming, {<span class="hljs-attr">once</span>: <span class="hljs-literal">true</span>});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">storeEventTiming</span>(<span class="hljs-params">event</span>) {
  firstInputDelay = event.<span class="hljs-property">timeStamp</span> - performance.<span class="hljs-property">timing</span>.<span class="hljs-property">navigationStart</span>;
  
  <span class="hljs-comment">// 上报 FID 数据</span>
  <span class="hljs-keyword">if</span> (firstInputDelay &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">sendToAnalytics</span>({<span class="hljs-attr">metric</span>: <span class="hljs-string">'FID'</span>, <span class="hljs-attr">value</span>: firstInputDelay});
  }
}
</code></pre>
<h3 data-id="heading-40">第八章：现代优化技术</h3>
<h4 data-id="heading-41">8.1 Webpack 优化配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.prod.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">splitChunks</span>: {
      <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
      <span class="hljs-attr">cacheGroups</span>: {
        <span class="hljs-attr">vendor</span>: {
          <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
          <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
        },
      },
    },
    <span class="hljs-attr">runtimeChunk</span>: <span class="hljs-string">'single'</span>,
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>({
      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'gzip'</span>,
      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|css|html|svg)$/</span>,
      <span class="hljs-attr">threshold</span>: <span class="hljs-number">8192</span>,
      <span class="hljs-attr">minRatio</span>: <span class="hljs-number">0.8</span>,
    }),
  ],
};
</code></pre>
<h4 data-id="heading-42">8.2 Tree Shaking 优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 ES6 模块语法启用 Tree Shaking</span>
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">utilityA</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">utilityB</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">utilityC</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// main.js - 只导入需要的函数</span>
<span class="hljs-keyword">import</span> { utilityA } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-title function_">utilityA</span>();
</code></pre>
<h4 data-id="heading-43">8.3 代码分割策略</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 路由级别的代码分割</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/About.vue'</span>);

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
];

<span class="hljs-comment">// 条件加载</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./dev-tools'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">devTools</span> =&gt;</span> {
    devTools.<span class="hljs-title function_">init</span>();
  });
}
</code></pre>
<h3 data-id="heading-44">第九章：性能测试与评估</h3>
<h4 data-id="heading-45">9.1 Lighthouse 自动化测试</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// lighthouse-config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">extends</span>: <span class="hljs-string">'lighthouse:default'</span>,
  <span class="hljs-attr">settings</span>: {
    <span class="hljs-attr">onlyCategories</span>: [<span class="hljs-string">'performance'</span>, <span class="hljs-string">'accessibility'</span>, <span class="hljs-string">'best-practices'</span>],
    <span class="hljs-attr">throttlingMethod</span>: <span class="hljs-string">'simulate'</span>,
    <span class="hljs-attr">throttling</span>: {
      <span class="hljs-attr">rttMs</span>: <span class="hljs-number">40</span>,
      <span class="hljs-attr">throughputKbps</span>: <span class="hljs-number">10240</span>,
      <span class="hljs-attr">cpuSlowdownMultiplier</span>: <span class="hljs-number">1</span>
    }
  }
};

<span class="hljs-comment">// 自动化测试脚本</span>
<span class="hljs-keyword">const</span> lighthouse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lighthouse'</span>);
<span class="hljs-keyword">const</span> chromeLauncher = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chrome-launcher'</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runLighthouse</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> chrome = <span class="hljs-keyword">await</span> chromeLauncher.<span class="hljs-title function_">launch</span>({<span class="hljs-attr">chromeFlags</span>: [<span class="hljs-string">'--headless'</span>]});
  <span class="hljs-keyword">const</span> options = {<span class="hljs-attr">logLevel</span>: <span class="hljs-string">'info'</span>, <span class="hljs-attr">output</span>: <span class="hljs-string">'html'</span>, <span class="hljs-attr">port</span>: chrome.<span class="hljs-property">port</span>};
  <span class="hljs-keyword">const</span> runnerResult = <span class="hljs-keyword">await</span> <span class="hljs-title function_">lighthouse</span>(url, options);
  
  <span class="hljs-comment">// 输出报告</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Performance Score:'</span>, runnerResult.<span class="hljs-property">lhr</span>.<span class="hljs-property">categories</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">score</span> * <span class="hljs-number">100</span>);
  
  <span class="hljs-keyword">await</span> chrome.<span class="hljs-title function_">kill</span>();
}
</code></pre>
<h4 data-id="heading-46">9.2 性能基准测试</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Benchmark.js 进行性能测试</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Benchmark</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'benchmark'</span>);
<span class="hljs-keyword">const</span> suite = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Benchmark</span>.<span class="hljs-property">Suite</span>;

suite
  .<span class="hljs-title function_">add</span>(<span class="hljs-string">'RegExp#test'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-regexp">/o/</span>.<span class="hljs-title function_">test</span>(<span class="hljs-string">'Hello World!'</span>);
  })
  .<span class="hljs-title function_">add</span>(<span class="hljs-string">'String#indexOf'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-string">'Hello World!'</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'o'</span>) &gt; -<span class="hljs-number">1</span>;
  })
  .<span class="hljs-title function_">on</span>(<span class="hljs-string">'cycle'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">String</span>(event.<span class="hljs-property">target</span>));
  })
  .<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fastest is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-string">'fastest'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-string">'name'</span>));
  })
  .<span class="hljs-title function_">run</span>({ <span class="hljs-string">'async'</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h3 data-id="heading-47">第十章：案例分析与最佳实践</h3>
<h4 data-id="heading-48">10.1 电商网站性能优化案例</h4>
<p>某电商平台通过以下优化措施将首屏加载时间从 5.2 秒降低到 1.8 秒：</p>
<ol>
<li><strong>图片优化</strong>：采用 WebP 格式，实施懒加载</li>
<li><strong>资源压缩</strong>：JS/CSS 文件压缩率达 70%</li>
<li><strong>服务端渲染</strong>：关键内容 SSR，提升首屏渲染速度</li>
<li><strong>缓存策略</strong>：合理使用浏览器缓存和 CDN</li>
</ol>
<h4 data-id="heading-49">10.2 移动端新闻应用优化案例</h4>
<p>某新闻应用通过以下优化将平均页面加载时间从 3.5 秒降至 1.2 秒：</p>
<ol>
<li><strong>虚拟列表</strong>：长列表只渲染可视区域内容</li>
<li><strong>离线缓存</strong>：Service Worker 缓存关键资源</li>
<li><strong>骨架屏</strong>：提升用户感知加载速度</li>
<li><strong>字体优化</strong>：使用 font-display: swap</li>
</ol>
<h4 data-id="heading-50">10.3 单页应用性能优化清单</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 加载阶段优化</span>
<span class="hljs-bullet">-</span> [ ] 实施代码分割和懒加载
<span class="hljs-bullet">-</span> [ ] 压缩和混淆 JS/CSS 资源
<span class="hljs-bullet">-</span> [ ] 优化图片资源格式和大小
<span class="hljs-bullet">-</span> [ ] 使用 CDN 分发静态资源
<span class="hljs-bullet">-</span> [ ] 启用 Gzip/Brotli 压缩
<span class="hljs-bullet">-</span> [ ] 实施合理的缓存策略

<span class="hljs-section">## 渲染阶段优化</span>
<span class="hljs-bullet">-</span> [ ] 避免强制同步布局
<span class="hljs-bullet">-</span> [ ] 减少重绘和重排
<span class="hljs-bullet">-</span> [ ] 使用 CSS3 硬件加速
<span class="hljs-bullet">-</span> [ ] 实施骨架屏或加载指示器
<span class="hljs-bullet">-</span> [ ] 优化字体加载策略

<span class="hljs-section">## 运行时优化</span>
<span class="hljs-bullet">-</span> [ ] 实施防抖和节流
<span class="hljs-bullet">-</span> [ ] 避免内存泄漏
<span class="hljs-bullet">-</span> [ ] 使用 Web Workers 处理密集计算
<span class="hljs-bullet">-</span> [ ] 优化事件处理器
<span class="hljs-bullet">-</span> [ ] 实施虚拟滚动

<span class="hljs-section">## 监控和维护</span>
<span class="hljs-bullet">-</span> [ ] 集成性能监控工具
<span class="hljs-bullet">-</span> [ ] 设置性能预算
<span class="hljs-bullet">-</span> [ ] 定期进行性能审计
<span class="hljs-bullet">-</span> [ ] 建立性能回归测试
</code></pre>
<h3 data-id="heading-51">结语</h3>
<p>前端性能优化是一个持续的过程，需要我们不断学习新技术、关注行业动态，并根据具体业务场景制定合适的优化策略。记住，优化的目标不仅仅是技术指标的提升，更重要的是为用户提供流畅、愉悦的使用体验。</p>
<p>成功的性能优化需要综合考虑多个方面：</p>
<ol>
<li><strong>测量先行</strong>：先了解现状，再制定优化方案</li>
<li><strong>用户导向</strong>：始终以用户体验为中心</li>
<li><strong>渐进优化</strong>：从小处着手，逐步改进</li>
<li><strong>持续监控</strong>：建立长期的性能保障机制</li>
</ol>
<p>随着 Web 技术的发展，新的优化技术和工具层出不穷。保持学习的心态，紧跟技术趋势，是每个前端工程师必备的素质。希望本文的内容能够帮助你在前端性能优化的道路上走得更远，创造出更好的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重生之我在浏览器里“蹦迪”]]></title>    <link>https://juejin.cn/post/7572115057222385699</link>    <guid>https://juejin.cn/post/7572115057222385699</guid>    <pubDate>2025-11-14T05:22:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572115057222385699" data-draft-id="7572092283720122420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重生之我在浏览器里“蹦迪”"/> <meta itemprop="keywords" content="前端,three.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-14T05:22:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CC码码"/> <meta itemprop="url" content="https://juejin.cn/user/3800389147179720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重生之我在浏览器里“蹦迪”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3800389147179720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CC码码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:22:05.000Z" title="Fri Nov 14 2025 05:22:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是CC，在这里欢迎大家的到来～</p>
<p><strong>工作时机械麻木，蹦迪时欢乐激情，边工作边蹦迪，是怎样的呢？</strong></p>
<p>这个想法源于我初入职场时对于 3D 的好奇和蹦迪的憧憬，刷着网上的视频，想着不如实现自己的蹦迪主场。</p>
<h2 data-id="heading-0">蹦迪舞台</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvite-project-sepia-xi.vercel.app%2F%23%2Fabout%2FdjClub" target="_blank" title="https://vite-project-sepia-xi.vercel.app/#/about/djClub" ref="nofollow noopener noreferrer">预览地址</a></p>
<h2 data-id="heading-1">实现流程</h2>
<p>基于 Three.js 实现，整合舞动的人形模型、摇摆聚光灯、固定的点灯和嗨翻天的背景音乐。</p>
<h3 data-id="heading-2">创建 canvas</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"djClub"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">添加三要素</h3>
<p>场景、相机、渲染器统称为 3D 场景下的三要素。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"djClub"</span>)

<span class="hljs-comment">// 场景</span>
scene = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scene</span>()
scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">0xdcdcdc</span>)

<span class="hljs-comment">// 相机</span>
camera = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">35</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>)
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">77.59014070493724</span>, <span class="hljs-number">27.281956522211484</span>, <span class="hljs-number">173.9190071215408</span>)

<span class="hljs-comment">// 渲染器</span>
renderer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebGLRenderer</span>({
    canvas,
    <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,
})
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">type</span> = <span class="hljs-title class_">PCFSoftShadowMap</span> <span class="hljs-comment">// 默认 PCFShadowMap // 阴影类型</span>
renderer.<span class="hljs-title function_">setClearColor</span>(<span class="hljs-number">0xffffff</span>)
renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>)
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>)
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>)
</code></pre>
<h3 data-id="heading-4">添加素材</h3>
<p>素材包括房屋、草地、前后舞台和天花板。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 雾</span>
scene.<span class="hljs-property">fog</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fog</span>(<span class="hljs-number">0xdcdcdc</span>, <span class="hljs-number">200</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// 创建纹理贴图加载器</span>
textureLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextureLoader</span>()
<span class="hljs-comment">// 添加长方体草地</span>
<span class="hljs-keyword">const</span> addGrassland = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoxGeometry</span>(landSide, <span class="hljs-number">10</span>, landSide * <span class="hljs-number">2</span>)
    <span class="hljs-keyword">const</span> materials = [
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({ 
          <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/around.png'</span>),
          <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
          <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/around.png'</span>),
          <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({
            <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/grasslight-big.jpg'</span>),
            <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
          <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/bottom.png'</span>),
          <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
          <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/around.png'</span>),
          <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
          <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/around.png'</span>),
          <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>
        }),
    ]
    grassland = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    grassland.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">5</span>
    grassland.<span class="hljs-property">name</span> = <span class="hljs-string">'grassland'</span>
    grassland.<span class="hljs-property">receiveShadow</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 开启接收阴影投影</span>
    scene.<span class="hljs-title function_">add</span>(grassland)
}

<span class="hljs-comment">// 添加前置舞台</span>
<span class="hljs-keyword">const</span> addFrontStage = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">200</span>, <span class="hljs-number">60</span>)
    <span class="hljs-keyword">const</span> gt = textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/front.png'</span>)
    <span class="hljs-keyword">const</span> materials = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span>, <span class="hljs-attr">map</span>: gt, <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span> })
    <span class="hljs-keyword">const</span> frontStage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    frontStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>
    frontStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>
    frontStage.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">200</span>
    frontStage.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">30</span>
    scene.<span class="hljs-title function_">add</span>(frontStage)
}

<span class="hljs-comment">// 添加后置舞台</span>
<span class="hljs-keyword">const</span> addBackStage = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">200</span>, <span class="hljs-number">60</span>)
    <span class="hljs-keyword">const</span> gt = textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/back.png'</span>)
    <span class="hljs-keyword">const</span> materials = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span>, <span class="hljs-attr">map</span>: gt, <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span> })
    <span class="hljs-keyword">const</span> backStage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    backStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>
    backStage.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = -<span class="hljs-number">200</span>
    backStage.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">30</span>
    scene.<span class="hljs-title function_">add</span>(backStage)
}

<span class="hljs-comment">// 添加左右墙壁</span>
<span class="hljs-keyword">const</span> addLeftRightStage = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">400</span>, <span class="hljs-number">60</span>)
    <span class="hljs-keyword">const</span> gt = textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/hardwood2_diffuse.jpg'</span>)
    <span class="hljs-keyword">const</span> materials = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span>, <span class="hljs-attr">map</span>: gt, <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span> })
    <span class="hljs-keyword">const</span> leftStage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    leftStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    leftStage.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = <span class="hljs-number">100</span>
    leftStage.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">30</span>
    leftStage.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">0</span>
    scene.<span class="hljs-title function_">add</span>(leftStage)

    <span class="hljs-keyword">const</span> rightStage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    rightStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    rightStage.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = -<span class="hljs-number">100</span>
    rightStage.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">30</span>
    rightStage.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">0</span>
    scene.<span class="hljs-title function_">add</span>(rightStage)
}

<span class="hljs-comment">// 添加天花板</span>
<span class="hljs-keyword">const</span> addUpStage = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">400</span>, <span class="hljs-number">200</span>)
    <span class="hljs-keyword">const</span> gt = textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/mesh/up.png'</span>)
    <span class="hljs-keyword">const</span> materials = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span>, <span class="hljs-attr">map</span>: gt, <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span> })
    <span class="hljs-keyword">const</span> frontStage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(geometry, materials)
    frontStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    frontStage.<span class="hljs-property">rotation</span>.<span class="hljs-property">z</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    frontStage.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">0</span>
    frontStage.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">60</span>
    scene.<span class="hljs-title function_">add</span>(frontStage)
}
</code></pre>
<h3 data-id="heading-5">加载人形模型蹦迪</h3>
<p>使用 Three.js 官网上的模型，且自带了一些动作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模型站位坐标数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> modelPosition = [
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">40</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">30</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: -<span class="hljs-number">20</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: -<span class="hljs-number">30</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: -<span class="hljs-number">40</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">40</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">30</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">30</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: <span class="hljs-number">40</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: -<span class="hljs-number">40</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: -<span class="hljs-number">30</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: -<span class="hljs-number">20</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">30</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">z</span>: <span class="hljs-number">40</span>,
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
    },   
]
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加载模型</span>
<span class="hljs-keyword">const</span> loadModels = <span class="hljs-keyword">function</span>(<span class="hljs-params">path: string</span>) {
    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FBXLoader</span>()
    loader.<span class="hljs-title function_">load</span>(path, <span class="hljs-function">(<span class="hljs-params">obj: any</span>) =&gt;</span> {

        obj.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">child : Mesh</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (child.<span class="hljs-property">isMesh</span>) {
                child.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>
                child.<span class="hljs-property">receiveShadow</span> = <span class="hljs-literal">true</span>
            }
        })

        <span class="hljs-keyword">let</span> <span class="hljs-attr">models</span>: any[] = []

        modelPosition.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> model1 = <span class="hljs-title class_">SkeletonUtils</span>.<span class="hljs-title function_">clone</span>(obj)
            <span class="hljs-keyword">const</span> mixer1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationMixer</span>(model1)
            mixer1.<span class="hljs-title function_">clipAction</span>(obj.<span class="hljs-property">animations</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">play</span>()
            model1.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">x</span>, item.<span class="hljs-property">y</span>, item.<span class="hljs-property">z</span>)
            model1.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0.08</span>, <span class="hljs-number">0.08</span>, <span class="hljs-number">0.08</span>)
            models.<span class="hljs-title function_">push</span>(model1)
            mixers.<span class="hljs-title function_">push</span>(mixer1)
        })
        scene.<span class="hljs-title function_">add</span>(...models)
    })
}
</code></pre>
<h3 data-id="heading-6">加载花式光源</h3>
<p>光源才是可以烘托气氛的，于是加了很多光源。</p>
<p>聚光灯是不断旋转角度的，还有一些固定点位的点光源起到微照明的作用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 聚光灯光源信息坐标</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> spotLights = [
    {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'幕布左上角第一个'</span>,
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xff0000</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">0.05</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'幕布左上角第二个'</span>,
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x54FF9F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">25</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x483D8B</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x1E90FF</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">25</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xffff00</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x1E90FF</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">50</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x1E90FF</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xffff00</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">50</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xffff00</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x1E90FF</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">50</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0x1E90FF</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xffff00</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">50</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    },
    {
        <span class="hljs-attr">spotLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xffff00</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">36</span>,
            <span class="hljs-attr">penumbra</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">2</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">100</span>
        },
        <span class="hljs-attr">range</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">200</span>
        }
    }
]
<span class="hljs-comment">// 点光源信息坐标</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pointLights = [
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">37.5</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">180</span>
        }
    },
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">37.5</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">180</span>
        }
    },
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">37.5</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">180</span>
        }
    },
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">37.5</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: -<span class="hljs-number">180</span>
        }
    },
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: <span class="hljs-number">60</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>
        }
    },
    {
        <span class="hljs-attr">pointLight</span>: {
            <span class="hljs-attr">color</span>: <span class="hljs-number">0xFFF68F</span>,
            <span class="hljs-attr">intensity</span>: <span class="hljs-number">10</span>,
            <span class="hljs-attr">distance</span>: <span class="hljs-number">200</span>,
            <span class="hljs-attr">decay</span>: <span class="hljs-number">10</span>
        },
        <span class="hljs-attr">position</span>: {
            <span class="hljs-attr">x</span>: -<span class="hljs-number">60</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-number">55</span>,
            <span class="hljs-attr">z</span>: <span class="hljs-number">0</span>
        }
    }
]
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加聚光灯</span>
<span class="hljs-keyword">const</span> addSpotLight = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    spotLights.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> spotLightRed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpotLight</span>(item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">color</span>, item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">intensity</span>, item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">distance</span>, item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">angle</span>, item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">penumbra</span>, item.<span class="hljs-property">spotLight</span>.<span class="hljs-property">decay</span>)
        spotLightRed.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, item.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, item.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>)
        spotLightRed.<span class="hljs-property">target</span> = grassland

        spotLightRed.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>

        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">mapSize</span>.<span class="hljs-property">width</span> = <span class="hljs-number">1024</span>
        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">mapSize</span>.<span class="hljs-property">height</span> = <span class="hljs-number">1024</span>

        <span class="hljs-comment">// 设置计算阴影的区域，注意包裹对象的周围</span>
        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">camera</span>.<span class="hljs-property">near</span> = <span class="hljs-number">1</span>
        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">camera</span>.<span class="hljs-property">far</span> = <span class="hljs-number">300</span>
        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">camera</span>.<span class="hljs-property">fov</span> = <span class="hljs-number">20</span>
        spotLightRed.<span class="hljs-property">shadow</span>.<span class="hljs-property">focus</span> = <span class="hljs-number">1</span>

        scene.<span class="hljs-title function_">add</span>(spotLightRed)
        spotObject.<span class="hljs-title function_">push</span>(spotLightRed)

        <span class="hljs-keyword">const</span> spotLightRedHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpotLightHelper</span>(spotLightRed)
        spotObjectHelper.<span class="hljs-title function_">push</span>(spotLightRedHelper)
    })
}

<span class="hljs-comment">// 聚光灯动画</span>
<span class="hljs-keyword">const</span> spotLightTween = <span class="hljs-keyword">function</span>(<span class="hljs-params">light: SpotLight, spot: any</span>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tween</span>(light).<span class="hljs-title function_">to</span>({
        <span class="hljs-attr">angle</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.7</span>) + <span class="hljs-number">0.1</span>,
        <span class="hljs-attr">penumbra</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() + <span class="hljs-number">1</span>
    }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3000</span> + <span class="hljs-number">2000</span>).<span class="hljs-title function_">easing</span>(<span class="hljs-title class_">Easing</span>.<span class="hljs-property">Quadratic</span>.<span class="hljs-property">Out</span>).<span class="hljs-title function_">start</span>()

    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tween</span>(light.<span class="hljs-property">position</span>).<span class="hljs-title function_">to</span>({
        <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * spot.<span class="hljs-property">range</span>.<span class="hljs-property">x</span>) * (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>),
        <span class="hljs-attr">y</span>: spot.<span class="hljs-property">range</span>.<span class="hljs-property">y</span>,
        <span class="hljs-attr">z</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * spot.<span class="hljs-property">range</span>.<span class="hljs-property">z</span>) * (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>)
    }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3000</span> + <span class="hljs-number">2000</span>).<span class="hljs-title function_">easing</span>(<span class="hljs-title class_">Easing</span>.<span class="hljs-property">Quadratic</span>.<span class="hljs-property">Out</span>).<span class="hljs-title function_">start</span>()
}

<span class="hljs-comment">// 多个聚光灯动画执行</span>
<span class="hljs-keyword">const</span> spotLightAnimate = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; spotLights.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-title function_">spotLightTween</span>(spotObject[i], spotLights[i])
    }
    <span class="hljs-built_in">setTimeout</span>(spotLightAnimate, <span class="hljs-number">1000</span>)
}

<span class="hljs-comment">// 添加点光源 灯泡</span>
<span class="hljs-keyword">const</span> addPointLight = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    pointLights.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">let</span> pointLight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PointLight</span>(item.<span class="hljs-property">pointLight</span>.<span class="hljs-property">color</span>, item.<span class="hljs-property">pointLight</span>.<span class="hljs-property">intensity</span>, item.<span class="hljs-property">pointLight</span>.<span class="hljs-property">distance</span>, item.<span class="hljs-property">pointLight</span>.<span class="hljs-property">decay</span>)
        pointLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, item.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, item.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>)
        scene.<span class="hljs-title function_">add</span>(pointLight)
    })
}
</code></pre>
<p>在调整光源时可以使用光源辅助线进行位置的调整。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加辅助线</span>
<span class="hljs-keyword">const</span> addHelper = <span class="hljs-keyword">function</span>(<span class="hljs-params">sunLight : DirectionalLight</span>) {
    <span class="hljs-comment">// 添加辅助线</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">gridHelper</span>: any = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GridHelper</span>(landSide, landSide);
    gridHelper.<span class="hljs-property">material</span>.<span class="hljs-property">opacity</span> = <span class="hljs-number">0</span>;
    gridHelper.<span class="hljs-property">material</span>.<span class="hljs-property">transparent</span> = <span class="hljs-literal">true</span>;
    scene.<span class="hljs-title function_">add</span>(gridHelper);
    <span class="hljs-comment">// 添加三维箭头坐标</span>
    <span class="hljs-comment">// X</span>
    <span class="hljs-keyword">let</span> dirX = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 三维向量</span>
    dirX.<span class="hljs-title function_">normalize</span>()
    <span class="hljs-keyword">let</span> origin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">let</span> length = <span class="hljs-number">1</span>
    <span class="hljs-keyword">let</span> hexX = <span class="hljs-number">0xff0000</span>
    <span class="hljs-keyword">let</span> arrowHelperX = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrowHelper</span>(dirX, origin, length, hexX)
    scene.<span class="hljs-title function_">add</span>(arrowHelperX)
    <span class="hljs-comment">// Y</span>
    <span class="hljs-keyword">let</span> dirY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 三维向量</span>
    dirX.<span class="hljs-title function_">normalize</span>()
    <span class="hljs-keyword">let</span> hexY = <span class="hljs-number">0xffff00</span>
    <span class="hljs-keyword">let</span> arrowHelperY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrowHelper</span>(dirY, origin, length, hexY)
    scene.<span class="hljs-title function_">add</span>(arrowHelperY)
    <span class="hljs-comment">// Z</span>
    <span class="hljs-keyword">let</span> dirZ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>) <span class="hljs-comment">// 三维向量</span>
    dirZ.<span class="hljs-title function_">normalize</span>()
    <span class="hljs-keyword">let</span> hexZ = <span class="hljs-number">0x0000ff</span>
    <span class="hljs-keyword">let</span> arrowHelperZ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrowHelper</span>(dirZ, origin, length, hexZ)
    scene.<span class="hljs-title function_">add</span>(arrowHelperZ)

    <span class="hljs-comment">// 简单模拟3个坐标轴的对象  红色代表 X 轴. 绿色代表 Y 轴. 蓝色代表 Z 轴</span>
    <span class="hljs-keyword">let</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AxesHelper</span>(landSide / <span class="hljs-number">2</span>)
    scene.<span class="hljs-title function_">add</span>(axesHelper)

    <span class="hljs-comment">// 模拟相机视锥体的辅助对象</span>
    <span class="hljs-keyword">let</span> cameraHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CameraHelper</span>(sunLight.<span class="hljs-property">shadow</span>.<span class="hljs-property">camera</span>)
    scene.<span class="hljs-title function_">add</span>(cameraHelper)
}
</code></pre>
<h3 data-id="heading-7">添加播放嗨曲</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'dblclick'</span>, addMusic)

<span class="hljs-comment">// 添加音乐</span>
<span class="hljs-keyword">const</span> addMusic = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> listener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioListener</span>()
    camera.<span class="hljs-title function_">add</span>(listener)

    <span class="hljs-keyword">let</span> sound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PositionalAudio</span>(listener)

    <span class="hljs-keyword">let</span> audioLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioLoader</span>()
    audioLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'/music/wavefile_short.mp3'</span>, <span class="hljs-function">(<span class="hljs-params">buffer: any</span>) =&gt;</span> {
        sound.<span class="hljs-title function_">setBuffer</span>(buffer)
        sound.<span class="hljs-title function_">setRefDistance</span>(<span class="hljs-number">100</span>)
        sound.<span class="hljs-title function_">play</span>()
    })
    <span class="hljs-keyword">const</span> sphere = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">20</span>, <span class="hljs-number">32</span>, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3.11645991236108</span>, <span class="hljs-number">6.283185307179586</span>, <span class="hljs-number">3.19185813604723</span>)
    <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span>, <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span> })
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(sphere, material)
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>)
    mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    scene.<span class="hljs-title function_">add</span>(mesh)
    grassland.<span class="hljs-title function_">add</span>(sound)

    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'dblclick'</span>, addMusic)
}
</code></pre>
<h3 data-id="heading-8">蹦起来</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建时钟</span>
clock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Clock</span>()

<span class="hljs-comment">// 渲染</span>
<span class="hljs-keyword">const</span> render = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    stats.<span class="hljs-title function_">begin</span>()
    
    <span class="hljs-keyword">let</span> delta = clock.<span class="hljs-title function_">getDelta</span>()
    <span class="hljs-comment">// 模型动画的执行更新</span>
    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">const</span> mixer <span class="hljs-keyword">of</span> mixers ) mixer.<span class="hljs-title function_">update</span>(delta)
    renderer.<span class="hljs-title function_">render</span>(scene, camera)
    <span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-title function_">update</span>()
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; spotObjectHelper.<span class="hljs-property">length</span>; i++) {
        spotObjectHelper[i].<span class="hljs-title function_">update</span>()
    }
  
    stats.<span class="hljs-title function_">end</span>()
    <span class="hljs-title function_">requestAnimationFrame</span>(render)
}
</code></pre>
<h3 data-id="heading-9">性能监控</h3>
<p>3D 场景下对浏览器和电脑的性能要求更高，可以通过性能监控判断来进行优化。</p>
<p>依赖于 stats.js，在 render 时进行进行监听。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Stats</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'stats.js'</span>

<span class="hljs-comment">// 性能监视器</span>
<span class="hljs-keyword">const</span> loadStats = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  stats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stats</span>()
  stats.<span class="hljs-title function_">showPanel</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">// 0: fps, 1: ms, 2: mb, 3+: custom</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(stats.<span class="hljs-property">dom</span>)
}

<span class="hljs-keyword">const</span> render = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  stats.<span class="hljs-title function_">begin</span>()
  <span class="hljs-comment">// 监听内容代码...</span>
  stats.<span class="hljs-title function_">end</span>()
  <span class="hljs-title function_">requestAnimationFrame</span>(render)
}
</code></pre>
<h3 data-id="heading-10">尽善尽美</h3>
<p>页面响应式才可以有更好的体验。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onWindowResize</span>(), <span class="hljs-literal">false</span>)

<span class="hljs-comment">// 响应式</span>
<span class="hljs-keyword">const</span> onWindowResize = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>)
    camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>()
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 CSS 定位：relative、absolute、fixed、sticky]]></title>    <link>https://juejin.cn/post/7572141390857240576</link>    <guid>https://juejin.cn/post/7572141390857240576</guid>    <pubDate>2025-11-14T05:27:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572141390857240576" data-draft-id="7572099468247924771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 CSS 定位：relative、absolute、fixed、sticky"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-14T05:27:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 CSS 定位：relative、absolute、fixed、sticky
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:27:15.000Z" title="Fri Nov 14 2025 05:27:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，CSS 的 <code>position</code> 属性是布局的核心之一。理解不同定位方式的原理和使用场景，能让你轻松应对各种页面布局需求。</p>
<p>今天我们就来梳理一下常见的几种定位方式：<code>relative</code>、<code>absolute</code>、<code>fixed</code> 和 <code>sticky</code>，以及它们与文档流的关系。</p>
<hr/>
<h2 data-id="heading-0">🌐 什么是文档流？</h2>
<p>文档流是 HTML 元素默认的布局方式：</p>
<ul>
<li>块级元素垂直排列</li>
<li>行内元素水平排列</li>
<li>遵循从上到下、从左到右的自然顺序</li>
</ul>
<p>当一个元素脱离了文档流，它不再占据原来的位置，后面的元素会“填补”它的空间。</p>
<hr/>
<h2 data-id="heading-1">🔹 1. <code>position: relative</code> —— 相对定位</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">position</span>: relative;
</code></pre>
<ul>
<li><strong>相对于自身原本位置进行偏移</strong></li>
<li><strong>不会脱离文档流</strong>，原位置依然保留</li>
<li>后续元素仍按标准流布局</li>
</ul>
<blockquote>
<p>✅ 适用于需要微调位置但不破坏布局的场景，比如配合 <code>top/bottom/left/right</code> 调整元素位置。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🔹 2. <code>position: absolute</code> —— 绝对定位</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">position</span>: absolute;
</code></pre>
<ul>
<li><strong>脱离文档流</strong>，不再占据空间</li>
<li>相对于最近的 <strong>拥有定位属性的父元素</strong> 定位</li>
<li>如果父元素没有定位，则以 <code>body</code> 或最近非 <code>static</code> 的祖先为参考</li>
</ul>
<blockquote>
<p>⚠️ 使用时注意：绝对定位的元素会“漂浮”在其他元素之上，需谨慎控制层级（z-index）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🔹 3. <code>position: fixed</code> —— 固定定位</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">position</span>: fixed;
</code></pre>
<ul>
<li><strong>以浏览器窗口为参照物</strong></li>
<li><strong>脱离文档流</strong></li>
<li>滚动页面时，元素位置固定不变</li>
</ul>
<blockquote>
<p>✅ 常用于顶部导航栏、侧边栏等需要“固定显示”的组件。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🔹 4. <code>position: sticky</code> —— 粘性定位</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">position</span>: sticky;
</code></pre>
<ul>
<li><strong>结合 relative 和 fixed 的特性</strong></li>
<li>默认行为像 <code>relative</code></li>
<li>当滚动到指定阈值（如 <code>top: 0</code>）时，变为 <code>fixed</code>，固定在视口某处</li>
</ul>
<blockquote>
<p>💡 例如：粘性标题、悬浮菜单，用户体验更友好。</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sticky-header</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-5">🔹 5. <code>position: static</code> —— 静态定位（默认）</h2>
<pre><code class="hljs language-arduino" lang="arduino">position: <span class="hljs-type">static</span>; <span class="hljs-comment">/* 默认值 */</span>
</code></pre>
<ul>
<li>元素按照正常文档流布局</li>
<li><code>top</code>、<code>bottom</code>、<code>left</code>、<code>right</code> 无效</li>
<li>一般不需要显式声明，除非要重置定位</li>
</ul>
<hr/>
<h2 data-id="heading-6">🧩 总结对比表</h2>









































<table><thead><tr><th>定位方式</th><th>是否脱离文档流</th><th>参考对象</th><th>适用场景</th></tr></thead><tbody><tr><td><code>relative</code></td><td>❌ 不脱离</td><td>自身原始位置</td><td>微调位置</td></tr><tr><td><code>absolute</code></td><td>✅ 脱离</td><td>最近定位父元素或 body</td><td>弹窗、遮罩层</td></tr><tr><td><code>fixed</code></td><td>✅ 脱离</td><td>浏览器窗口</td><td>固定导航、悬浮按钮</td></tr><tr><td><code>sticky</code></td><td>部分脱离</td><td>视口 + 文档流</td><td>粘性头部、侧边栏</td></tr><tr><td><code>static</code></td><td>❌ 不脱离</td><td>无</td><td>默认状态，无需设置</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">✅ 小贴士</h2>
<ul>
<li>使用 <code>absolute</code> 时，记得给父容器设置 <code>position: relative</code>，避免定位混乱。</li>
<li><code>sticky</code> 需要设置 <code>top</code>/<code>bottom</code> 等属性才生效。</li>
<li><code>display: none</code> 会隐藏元素且<strong>不占空间</strong>，与定位无关，但常被混淆。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae 推出 Solo 模式：AI 开发的“一人一项目”时代来了？]]></title>    <link>https://juejin.cn/post/7572161976592924724</link>    <guid>https://juejin.cn/post/7572161976592924724</guid>    <pubDate>2025-11-14T05:31:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572161976592924724" data-draft-id="7572115057222451235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae 推出 Solo 模式：AI 开发的“一人一项目”时代来了？"/> <meta itemprop="keywords" content="前端,人工智能,Solo"/> <meta itemprop="datePublished" content="2025-11-14T05:31:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae 推出 Solo 模式：AI 开发的“一人一项目”时代来了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:31:42.000Z" title="Fri Nov 14 2025 05:31:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“产品经理找程序员写原型？不需要了。产品经理就是程序员。”</p>
</blockquote>
<p>最近，AI 开发平台 <strong>Trae</strong> 正式推出了全新功能 —— <strong>Solo 模式</strong>，彻底重构了传统软件开发流程。它不再只是“代码生成器”，而是进化为一个<strong>全栈 AI 开发工程师</strong>，从需求到交付，全程高能。</p>
<p>这不仅是工具的升级，更是一场<strong>开发范式的革命</strong>。</p>
<hr/>
<h2 data-id="heading-0">🚀 什么是 Solo 模式？</h2>
<p><strong>Solo 模式</strong> 是 Trae 提出的全新 AI 驱动开发范式，旨在打造<strong>沉浸式的智能开发体验</strong>。</p>
<p>你可以把它理解为：<br/>
👉 <strong>你只需提出一个想法，AI 就能独立完成从需求分析、产品设计、UI 构建、状态管理、API 对接、数据库设计、测试到部署的全过程。</strong></p>
<p>换句话说：</p>
<blockquote>
<p>✅ 只需一句话，就能让 AI 从零构建一个完整网站或应用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">💡 为什么叫“Solo”？</h2>
<p>因为——<strong>一个人，一个想法，就能启动一个项目</strong>。</p>
<p>过去，一个产品上线需要：</p>
<ul>
<li>产品经理写 PRD</li>
<li>UI 设计师出稿</li>
<li>前后端开发协作</li>
<li>测试、运维跟进</li>
</ul>
<p>而现在，<strong>你只需要提出需求，剩下的交给 AI 完成</strong>。</p>
<hr/>
<h2 data-id="heading-2">🎯 实战演示：用 Solo 模式创建“绘本岛”</h2>
<p>我们来试试看，如何用 Trae 的 Solo 模式，快速搭建一个名为 <strong>“绘本岛”</strong> 的亲子阅读网站。</p>
<h3 data-id="heading-3">第一步：提出需求</h3>
<pre><code class="hljs language-diff" lang="diff">创建一个名为“绘本岛”的亲子阅读网站。
品牌调性：温馨、童趣、色彩明亮。
核心功能：
<span class="hljs-deletion">- 用户注册/登录</span>
<span class="hljs-deletion">- 分类浏览绘本（按年龄、主题）</span>
<span class="hljs-deletion">- 在线阅读（支持翻页动画）</span>
<span class="hljs-deletion">- 收藏与分享</span>
<span class="hljs-deletion">- 每日推荐</span>
视觉风格：扁平化 + 卡通插画风，主色调为蓝色和橙色。
</code></pre>
<blockquote>
<p>👉 这些信息就像你在跟一位全能的 AI 工程师对话。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">第二步：AI 自动生成完整方案</h3>
<p>Trae 的 Solo 模式会自动完成以下步骤：</p>
<ol>
<li><strong>生成 PRD（产品需求文档）</strong></li>
<li><strong>输出设计稿（含交互逻辑）</strong></li>
<li><strong>产出技术方案（前端架构 + 后端接口设计）</strong></li>
<li><strong>自动生成数据库结构（如用户表、绘本表、收藏表）</strong></li>
<li><strong>编写前端代码（React/Vue + Tailwind）</strong></li>
<li><strong>搭建 API 服务（Node.js 或 Python）</strong></li>
<li><strong>配置测试用例</strong></li>
<li><strong>一键部署至云环境</strong></li>
</ol>
<blockquote>
<p>⚡️ 所有过程无需人工干预，AI 自动规划、分步执行。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">第三步：一键启动</h3>
<p>点击「启动项目」按钮，整个系统自动运行，<strong>几分钟内即可看到可交互的原型页面</strong>。</p>
<p>你甚至可以：</p>
<ul>
<li>直接在浏览器中预览</li>
<li>修改文案或样式</li>
<li>快速迭代功能</li>
</ul>
<blockquote>
<p>🌐 从此，<strong>非技术人员也能拥有自己的产品原型</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">🔁 传统流程 vs. Solo 模式对比</h2>



































<table><thead><tr><th>环节</th><th>传统方式</th><th>Solo 模式</th></tr></thead><tbody><tr><td>需求沟通</td><td>多方协调，耗时长</td><td>一次输入，AI 理解并执行</td></tr><tr><td>原型设计</td><td>UI 设计师手绘 → 评审 → 修改</td><td>AI 自动生成交互原型</td></tr><tr><td>技术方案</td><td>开发团队讨论 → 写文档</td><td>AI 输出完整技术架构</td></tr><tr><td>代码实现</td><td>手动编码，易出错</td><td>AI 编写高质量代码</td></tr><tr><td>部署上线</td><td>手动部署，依赖运维</td><td>一键部署，自动完成</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>效率提升 10 倍以上，成本近乎归零。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-7">🤔 谁会受益？</h2>
<ul>
<li><strong>产品经理</strong>：不用再找程序员写 demo，自己就能验证想法。</li>
<li><strong>创业者</strong>：快速验证 MVP，降低试错成本。</li>
<li><strong>非技术人员</strong>：轻松实现创意落地。</li>
<li><strong>开发者</strong>：专注复杂业务逻辑，不再重复造轮子。</li>
</ul>
<blockquote>
<p>💡 未来，<strong>人人都是产品经理，人人都是开发者</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">🔮 未来展望：AI Development，不只是 AI Coding</h2>
<p>Trae 的目标是实现 <strong>AI Development（整体系统构建）</strong> ，而不仅仅是 <strong>AI Coding（代码生成）</strong> 。</p>
<p>这意味着：</p>
<ul>
<li>AI 不再是辅助工具</li>
<li>而是<strong>主导开发流程的智能体</strong></li>
<li>编辑器、终端、文档、浏览器……全部整合进 AI 工作流</li>
</ul>
<blockquote>
<p>🌐 我们正在进入一个“AI 主导开发”的新时代。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">✅ 总结</h2>
<p>Trae 的 <strong>Solo 模式</strong>，不是一次功能更新，而是一次<strong>开发模式的颠覆</strong>。</p>
<p>它让我们看到：</p>
<ul>
<li>未来的开发，可能是“提需求 → 等结果”</li>
<li>产品的边界，将由想法决定，而非资源限制</li>
</ul>
<blockquote>
<p>🚀 <strong>当你还在写 PRD 时，别人已经用 AI 把产品跑起来了。</strong></p>
</blockquote>
<hr/>
<p>📌 <strong>如果你也想体验这种“一人一项目”的开发快感，不妨关注 Trae 的官方动态，第一时间尝鲜 Solo 模式！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Canvas绘图基础：坐标、线条与圆形的艺术]]></title>    <link>https://juejin.cn/post/7572138663120601130</link>    <guid>https://juejin.cn/post/7572138663120601130</guid>    <pubDate>2025-11-14T05:46:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572138663120601130" data-draft-id="7569871848793227283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Canvas绘图基础：坐标、线条与圆形的艺术"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-14T05:46:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Canvas绘图基础：坐标、线条与圆形的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:46:53.000Z" title="Fri Nov 14 2025 05:46:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Canvas绘图的世界里，理解坐标系统是绘制一切图形的基础。就像在地图上找位置需要经纬度一样，在Canvas中绘制图形也需要精确的坐标定位。今天，我们将深入探索Canvas的坐标系统，并学习如何利用这个系统绘制线条和圆形——这两种构成复杂图形的基本元素。</p>
<h2 data-id="heading-0">Canvas坐标系统</h2>
<h3 data-id="heading-1">基本概念</h3>
<p>Canvas使用基于<strong>左上角</strong>的二维笛卡尔坐标系，这与我们数学中常见的坐标系有所不同：</p>
<ul>
<li><strong>原点(0,0)</strong> ：位于画布的左上角</li>
<li><strong>X轴</strong>：向右为正方向</li>
<li><strong>Y轴</strong>：向下为正方向</li>
</ul>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Canvas坐标系统演示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">canvas</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f9f9f9</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"coordinateCanvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"600"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"400"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'coordinateCanvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        
        <span class="hljs-comment">// 绘制坐标轴</span>
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// X轴</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">600</span>, <span class="hljs-number">200</span>);
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// Y轴</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">300</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">300</span>, <span class="hljs-number">400</span>);
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 标记原点</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'red'</span>;
        ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">298</span>, <span class="hljs-number">198</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'原点 (0,0)'</span>, <span class="hljs-number">310</span>, <span class="hljs-number">190</span>);
        
        <span class="hljs-comment">// 标记坐标点示例</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'blue'</span>;
        ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 点(100,100)</span>
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'(100,100)'</span>, <span class="hljs-number">110</span>, <span class="hljs-number">90</span>);
        
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'green'</span>;
        ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">400</span>, <span class="hljs-number">300</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 点(400,300)</span>
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'(400,300)'</span>, <span class="hljs-number">410</span>, <span class="hljs-number">290</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">绘制线条</h2>
<h3 data-id="heading-3">基本语法</h3>
<p>绘制线条需要使用<strong>路径(Path)</strong>  API，遵循以下步骤：</p>
<ol>
<li><code>beginPath()</code> - 开始新路径</li>
<li><code>moveTo(x, y)</code> - 移动到起点</li>
<li><code>lineTo(x, y)</code> - 绘制到终点</li>
<li><code>stroke()</code> - 描边路径</li>
</ol>
<h4 data-id="heading-4">线条样式属性：</h4>



































<table><thead><tr><th>属性名</th><th>说明</th><th>可选值/示例</th></tr></thead><tbody><tr><td><code>lineWidth</code></td><td>设置线条的宽度（单位：像素）</td><td><code>3</code>、<code>5</code>、<code>10</code></td></tr><tr><td><code>strokeStyle</code></td><td>设置线条的颜色或样式</td><td><code>'red'</code>、<code>'#ff0000'</code>、<code>'rgba(255,0,0,0.5)'</code></td></tr><tr><td><code>lineCap</code></td><td>设置线条末端的样式</td><td><code>'butt'</code>（平直）、<code>'round'</code>（圆形）、<code>'square'</code>（方形）</td></tr><tr><td><code>lineJoin</code></td><td>设置两条线段连接处的样式</td><td><code>'miter'</code>（尖角）、<code>'round'</code>（圆角）、<code>'bevel'</code>（斜角）</td></tr><tr><td><code>setLineDash()</code></td><td>设置虚线模式</td><td><code>[5, 3]</code>（5px实线，3px空白）</td></tr></tbody></table>
<h2 data-id="heading-5">绘制圆形和圆弧</h2>
<h3 data-id="heading-6">基本语法</h3>
<p>Canvas使用<code>arc()</code>方法绘制圆形和圆弧：</p>
<pre><code class="hljs language-javascript" lang="javascript">ctx.<span class="hljs-title function_">arc</span>(x, y, radius, startAngle, endAngle, anticlockwise);
</code></pre>
<h4 data-id="heading-7">属性说明：</h4>








































<table><thead><tr><th>参数名</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td><code>x</code></td><td>圆心的X坐标</td><td><code>100</code></td></tr><tr><td><code>y</code></td><td>圆心的Y坐标</td><td><code>150</code></td></tr><tr><td><code>radius</code></td><td>圆的半径</td><td><code>50</code></td></tr><tr><td><code>startAngle</code></td><td>起始角度（弧度制）</td><td><code>0</code></td></tr><tr><td><code>endAngle</code></td><td>结束角度（弧度制）</td><td><code>Math.PI * 2</code></td></tr><tr><td><code>anticlockwise</code></td><td>绘制方向</td><td><code>false</code></td></tr></tbody></table>
<h3 data-id="heading-8">角度与弧度转换</h3>
<p>Canvas使用<strong>弧度制</strong>而非角度制：</p>
<ul>
<li>180° = π 弧度</li>
<li>360° = 2π 弧度</li>
<li>转换公式：<code>弧度 = 角度 * (Math.PI / 180)</code></li>
</ul>
<h4 data-id="heading-9">代码示例：绘制完整圆形，圆形边框，半圆，四分之一圆，复杂圆弧（扇形），使用arcTo绘制圆角</h4>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Canvas圆形绘制<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">canvas</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"circleCanvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"600"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"400"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'circleCanvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        
        <span class="hljs-comment">// 示例1：绘制完整圆形（填充）</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>); <span class="hljs-comment">// 完整圆形</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(52, 152, 219, 0.7)'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        
        <span class="hljs-comment">// 示例2：绘制圆形边框</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">250</span>, <span class="hljs-number">100</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#e74c3c'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 示例3：绘制半圆</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">400</span>, <span class="hljs-number">100</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>); <span class="hljs-comment">// 0到π = 180度</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#2ecc71'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        
        <span class="hljs-comment">// 示例4：绘制四分之一圆</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">100</span>, <span class="hljs-number">250</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>); <span class="hljs-comment">// 0到π/2 = 90度</span>
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#f39c12'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 示例5：绘制复杂圆弧（扇形）</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">250</span>, <span class="hljs-number">250</span>); <span class="hljs-comment">// 移动到圆心</span>
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">250</span>, <span class="hljs-number">250</span>, <span class="hljs-number">60</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">4</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">1.5</span>); <span class="hljs-comment">// 45度到270度</span>
        ctx.<span class="hljs-title function_">closePath</span>(); <span class="hljs-comment">// 连接回圆心形成扇形</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(155, 89, 182, 0.7)'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        
        <span class="hljs-comment">// 示例6：使用arcTo绘制圆角</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">350</span>, <span class="hljs-number">200</span>);
        ctx.<span class="hljs-title function_">arcTo</span>(<span class="hljs-number">450</span>, <span class="hljs-number">200</span>, <span class="hljs-number">450</span>, <span class="hljs-number">300</span>, <span class="hljs-number">30</span>); <span class="hljs-comment">// 创建圆角</span>
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">450</span>, <span class="hljs-number">300</span>);
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#34495e'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">3</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 添加说明文字</span>
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'12px Arial'</span>;
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'完整圆形'</span>, <span class="hljs-number">80</span>, <span class="hljs-number">180</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'圆形边框'</span>, <span class="hljs-number">230</span>, <span class="hljs-number">180</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'半圆'</span>, <span class="hljs-number">385</span>, <span class="hljs-number">180</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'四分之一圆'</span>, <span class="hljs-number">75</span>, <span class="hljs-number">330</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'扇形'</span>, <span class="hljs-number">240</span>, <span class="hljs-number">330</span>);
        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'arcTo圆角'</span>, <span class="hljs-number">370</span>, <span class="hljs-number">330</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">圆弧绘制方法</h3>
<ol>
<li><strong>arc()</strong>  - 绘制标准圆弧，最常用</li>
<li><strong>arcTo()</strong>  - 通过两个控制点绘制圆弧，适合创建圆角</li>
<li><strong>ellipse()</strong>  - 绘制椭圆弧（可控制椭圆半径和旋转）</li>
</ol>
<h5 data-id="heading-11">综合示例：绘制简单笑脸</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c4ac88f77344579b7aceedee5a1dc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQkJC5Yqq5Yqb5a2m5Lmg56iL5bqP6K6-6K6h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704013&amp;x-signature=nUCAuL3BO%2Bs8ke8vpQQRUL92Gx8%3D" alt="屏幕截图 2025-11-08 212855.png" loading="lazy"/></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Canvas笑脸绘制<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">canvas</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"smileyCanvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"400"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'smileyCanvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        
        <span class="hljs-comment">// 绘制脸部（圆形）</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#FFD700'</span>; <span class="hljs-comment">// 金黄色</span>
        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#D4AF37'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">3</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 绘制左眼</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">150</span>, <span class="hljs-number">160</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'white'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 绘制左眼珠</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">150</span>, <span class="hljs-number">160</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        
        <span class="hljs-comment">// 绘制右眼</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">250</span>, <span class="hljs-number">160</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'white'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        <span class="hljs-comment">// 绘制右眼珠</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">250</span>, <span class="hljs-number">160</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-title function_">fill</span>();
        
        <span class="hljs-comment">// 绘制嘴巴（微笑弧线）</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">200</span>, <span class="hljs-number">220</span>, <span class="hljs-number">80</span>, <span class="hljs-number">0.1</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-number">0.9</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>); <span class="hljs-comment">// 微笑弧度</span>
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#333'</span>;
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>Canvas绘图的三个核心基础：</p>
<ol>
<li><strong>坐标系统</strong>：理解基于左上角的坐标系是精确定位的基础</li>
<li><strong>线条绘制</strong>：学会使用路径API创建直线、折线和虚线</li>
<li><strong>圆形绘制</strong>：掌握使用<code>arc()</code>方法绘制圆形、圆弧和扇形</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不只是设计师的工具：Photoshop在前端开发中的高频操作指南]]></title>    <link>https://juejin.cn/post/7572137760447119401</link>    <guid>https://juejin.cn/post/7572137760447119401</guid>    <pubDate>2025-11-14T05:48:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572137760447119401" data-draft-id="7569910533508317203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不只是设计师的工具：Photoshop在前端开发中的高频操作指南"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-14T05:48:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不只是设计师的工具：Photoshop在前端开发中的高频操作指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:48:00.000Z" title="Fri Nov 14 2025 05:48:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多刚入门前端的同学会有个疑问：“我是写代码的，为什么还要学Photoshop？” 事实上，PS 对于前端开发者来说，不仅是查看设计稿的工具，更是获取精确数据、提取资源和理解视觉实现的“瑞士军刀”。今天，我们就来聊聊那些前端工程师必须掌握的 PS 常见操作。</p>
<h2 data-id="heading-0"><strong>一、核心概念：为什么前端要懂点PS？</strong></h2>
<p>前端工程师的使命是将设计师的静态稿（通常是 PSD 或 Sketch 文件）转化为动态的、可交互的网页。在这个过程中，PS 能帮助我们：</p>
<ol>
<li><strong>获取精确尺寸与间距</strong>：精准测量元素的大小、边距、行高，实现“像素级”还原。</li>
<li><strong>提取切图资源</strong>：获取页面中使用的图标、Logo、特殊按钮等图片素材。</li>
<li><strong>拾取颜色值</strong>：获取设计稿中使用的精确颜色，包括不常用的渐变和阴影色。</li>
<li><strong>分析复杂样式</strong>：理解图层混合模式、阴影、模糊等效果的参数，以便用 CSS 代码实现。</li>
</ol>
<h2 data-id="heading-1"><strong>二、常见操作、代码示例与注意点</strong></h2>
<h3 data-id="heading-2"><strong>1. 获取尺寸与间距</strong></h3>
<p>这是最基础也是最常用的操作。</p>
<p><strong>操作流程</strong>：</p>
<ol>
<li>在 PS 中打开设计稿。</li>
<li>选择 <code>移动工具</code> (快捷键 V)。</li>
<li>在上方选项栏勾选 <code>自动选择</code> 并选择 <code>图层</code>。</li>
<li>点击你想测量的元素，在图层面板中会自动定位到该图层。</li>
<li>使用 <code>矩形选框工具</code> (M) 框选要测量的区域，信息面板 (F8) 会显示宽 (W) 和高 (H)。</li>
</ol>
<h4 data-id="heading-3">CSS代码示例:假设我们测量到一个按钮的宽度为 <code>120px</code>，高度为 <code>40px</code>，距离左边元素 <code>20px</code>。</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.my-button</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* 测量到的间距 */</span>
}
</code></pre>
<h3 data-id="heading-4"><strong>2. 提取图片资源（切图）</strong></h3>
<p>当设计稿中有无法用 CSS 绘制的图片、图标或 Logo 时，我们需要将它们“切”出来。</p>
<ul>
<li>
<p><strong>操作流程（传统方式）</strong> ：</p>
<ol>
<li>使用 <code>切片工具</code> (C)。</li>
<li>框选你需要导出的区域。</li>
<li>点击菜单栏 <code>文件</code> -&gt; <code>导出</code> -&gt; <code>存储为 Web 所用格式</code> (旧版)。</li>
<li>选择格式（如 PNG-24, PNG-8, JPG），调整质量，点击存储，并选择“选中的切片”。</li>
</ol>
</li>
<li>
<p><strong>操作流程（更高效的方式 - 导出为）</strong> ：</p>
<ol>
<li>在图层面板，右键点击你需要导出的图层或图层组。</li>
<li>选择 <code>导出为...</code>。</li>
<li>在弹出的对话框中选择格式（如 PNG, JPG, SVG）和大小（1x, 2x等）。</li>
<li>点击 <code>导出全部</code>。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">HTML代码示例:假设我们导出了一个名为 <code>icon-search.png</code> 的图标。</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 使用切图资源 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search-btn"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/icon-search.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"搜索图标"</span>&gt;</span>
    搜索
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6"><strong>3. 获取颜色值</strong></h3>
<p>确保页面颜色与设计稿一致的关键。</p>
<ul>
<li>
<p><strong>操作流程</strong>：</p>
<ol>
<li>使用 <code>吸管工具</code> (快捷键 I)。</li>
<li>在设计稿上点击你想要取色的位置。</li>
<li>查看前景色块，点击它会弹出 <code>拾色器</code> 对话框，可以获取到 HEX、RGB 等格式的颜色值。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-7">CSS代码示例:假设我们取到一个主题色为 <code>#3a86ff</code>，一个带透明度的黑色 <code>rgba(0, 0, 0, 0.5)</code>。</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#3a86ff</span>; <span class="hljs-comment">/* 从PS拾色器获取的HEX值 */</span>
  <span class="hljs-attr">--overlay-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">/* 从PS拾色器获取的RGBA值 */</span>
}

<span class="hljs-selector-class">.header</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-color);
}

<span class="hljs-selector-class">.modal-overlay</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--overlay-color);
}
</code></pre>
<h3 data-id="heading-8"><strong>4. 解析阴影效果</strong></h3>
<p>CSS 的 <code>box-shadow</code> 属性可以完美实现 PS 中的投影效果，但需要获取正确的参数。</p>
<ul>
<li>
<p><strong>操作流程</strong>：</p>
<ol>
<li>在图层面板，双击想要查看效果的图层，打开 <code>图层样式</code> 对话框。</li>
<li>选择 <code>投影</code>。</li>
<li>记录下 <code>混合模式</code>、<code>不透明度</code>、<code>角度</code>、<code>距离</code>、<code>扩展</code>、<code>大小</code> 等参数。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">CSS代码示例:假设我们从图层样式中看到参数为：不透明度 25%，角度 120度，距离 5px，扩展 0px，大小 10px。</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-comment">/* box-shadow: h-offset v-offset blur spread color; */</span>
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">5px</span> <span class="hljs-number">5px</span> <span class="hljs-number">10px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.25</span>);
  <span class="hljs-comment">/* 
    解释：
    h-offset (水平偏移): 5px (根据角度和距离换算，这里简化为5px)
    v-offset (垂直偏移): 5px
    blur (模糊大小): 10px
    spread (扩展大小): 0px
    color: rgba(0, 0, 0, 0.25) (黑色，25%不透明度)
  */</span>
}
</code></pre>
<h3 data-id="heading-10">注意：</h3>
<p>PS 中的“角度”是一个全局光的角度，需要手动换算为 <code>h-offset</code> 和 <code>v-offset</code>。可以使用 <code>距离 * sin(角度)</code> 和 <code>距离 * cos(角度)</code> 来粗略计算，但通常直接手动调整 <code>h-offset</code> 和 <code>v-offset</code> 直到视觉上匹配即可。</p>
<h2 data-id="heading-11">总结</h2>
<p>Photoshop 不是一个需要精通绘图的软件，而是一个  <strong>“数据提取器和视觉解析器”</strong> 。</p>
<ul>
<li><strong>核心价值</strong>：在于<strong>精准地获取构建页面所需的数值</strong>（尺寸、间距）、资源（图片）和<strong>样式参数</strong>（颜色、阴影） 。</li>
<li><strong>工作流</strong>：可以概括为  <strong>“测量 -&gt; 提取 -&gt; 编码”</strong>  的循环。</li>
<li><strong>终极目标</strong>：通过与设计师的无缝协作，将这些视觉数据转化为高质量的 CSS 和 HTML 代码，最终实现与设计稿高度一致的网页。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3 个顶呱呱的 GitHub 开源项目，有点意思啊。]]></title>    <link>https://juejin.cn/post/7572126996177354787</link>    <guid>https://juejin.cn/post/7572126996177354787</guid>    <pubDate>2025-11-14T05:45:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572126996177354787" data-draft-id="7572115057222107171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3 个顶呱呱的 GitHub 开源项目，有点意思啊。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-14T05:45:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3 个顶呱呱的 GitHub 开源项目，有点意思啊。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:45:30.000Z" title="Fri Nov 14 2025 05:45:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、快速把网页打包成 APP</h2>
<p>这个 GitHub 开源项目有 6.5K 的 Star 了。</p>
<p><strong>它是一个打包神器，能把你平时用的网站，比如油管、小红书或者你自己写的网页项目，快速变成一个独立的、小巧的电脑或手机软件。</strong></p>
<p>能在 Mac、Windows、Linux，或者安卓、苹果上安装访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45557d1eebee435d9463103fa5086782~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=gI6bGZh9N%2FAoRN7ZdWpnzNC87Bc%3D" alt="图片" loading="lazy"/></p>
<p>PakePlus 体积超小，不到 5MB，比传统工具快 10 倍。</p>
<p>比如下面是把 YouTube 网页变成独立 APP 的操作演示：</p>
<p>把它变成一个像 QQ、微信那样的桌面软件。</p>
<p>你只需要在电脑上双击这个软件的图标，就能直接打开 YouTube，不用再经过浏览器了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b87eedc87a14ed69a8039f98bab0e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=fzXpTIDK60gMAdJ9h%2FNZj4cTDVI%3D" alt="图片" loading="lazy"/></p>
<p>打包网页超级简单：你只需要一个 GitHub 账号的 Token，在 PakePlus 中点几下，它就能自动在云端帮你把软件打包好，你完全不用在自己电脑上安装复杂的编程环境。</p>
<p>如果你懂点技术，也可以在自己电脑上打包，过程也很快。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9259be9c511d42cd943faadab8e44ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=ANSxD4zX57W0rjedDPEnUMFmSnI%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05c8b66445ca49b3b0a53e23e6d6fd9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=KOW35oijg6oWAeyww2wAZg%2BiSh4%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>而且你还可以给打包的网站加一些自己的 JavaScript 代码，比如去掉烦人的广告、增加一些自动化操作。</p>
<p>甚至可以让你注入的代码调用电脑的系统功能，如下载文件、执行命令等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e9d224f02ed4e119a9b97fa50513881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=czwhAfqW2Sfs%2F8%2B6o2XfSGNBJ70%3D" alt="图片" loading="lazy"/></p>
<p>看到开发者在开源项目上备注了一下，因为之前有人滥用这个项目去打包非法软件，所以<strong>它的前端代码部分不再开源了</strong>。你不能修改它用户界面了，但仍然可以正常使用它提供的在线服务或编译好的客户端来打包你自己的应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f99fd4fe3d1a486cb39f8e087565396d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=fNdBNUWpRU2Ux4o6S2%2FYYqgKpj8%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/Sjj1024/PakePlus</span>
</code></pre>
<h2 data-id="heading-1">02、网页时光机</h2>
<p>这个叫做 ArchiveBox 的 GitHub 项目有点好玩， 目前已经获得 25K 星了。</p>
<p>你可以把他理解成你的「私人网页时光机」，一款能自己部署、完全掌控数据的网页备份工具。</p>
<p>防止喜欢的网页失效、被修改，把内容永久存下来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/057421b1ef3a4d33b6c85708962fe2cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=n%2BD6qWAeZfmiQ0hInOfREK70gt0%3D" alt="图片" loading="lazy"/></p>
<p>不管是浏览器书签、浏览记录，还是 Pocket、RSS 订阅里的链接，都能交给它备份，而且会存成 PDF、截图、纯文本、HTML、MP4 啥的格式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7c04ff69c614387806e76e58acffc04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=jWf2cmUxrEYvfTEFlJrca72n9t0%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48545fae4ab94e8a8375ae527455b6ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=H%2BFrbq%2FcqRvJhark1u136ULE8ys%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6ee4b1ed2794bed96575c0512a07610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=wk70ns6%2B8N%2BKraFOfUf8%2BoaDlYo%3D" alt="图片" loading="lazy"/></p>
<p>不搞复杂格式，存的都是 HTML、PNG、MP4 这些通用文件，就算以后不用 ArchiveBox 了，直接打开文件夹也能看。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/407d9fe797c94cc792d23645874bb343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=VNnV5rQxHwVb7JFgr51Z0mvOvzQ%3D" alt="图片" loading="lazy"/></p>
<p>可以直接通过 pip 安装 archivebox，当然还支持 Docker 啥的，可以直接去 readme 看看。</p>
<pre><code class="hljs language-javascript" lang="javascript">pip install archiveboxmkdir -p ~<span class="hljs-regexp">/archivebox/</span>data &amp;&amp; cd ~<span class="hljs-regexp">/archivebox/</span>dataarchivebox init --setup
</code></pre>
<p>执行 archivebox add '<a href="https://link.juejin.cn?target=https%3A%2F%2Fexample.com" target="_blank" title="https://example.com" ref="nofollow noopener noreferrer">example.com</a>' 就能保持网页了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7682d1cbfe24789941b3d319cb6620c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=vUBgXT2lzKssURGxBabeSpyTtY8%3D" alt="图片" loading="lazy"/></p>
<p>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FArchiveBox%2FArchiveBox" target="_blank" title="https://github.com/ArchiveBox/ArchiveBox" ref="nofollow noopener noreferrer">github.com/ArchiveBox/…</a></p>
<h2 data-id="heading-2">03、安卓上的极简番茄钟</h2>
<p>这个是一个专为安卓手机设计的专注工具，用番茄工作法帮你高效做事，界面还挺好看的。</p>
<p>如果你想学习 Google 为 Android 平台推出的全新设计语言 Material 3 Expressive，这个开源项目可以帮你入门。</p>
<p>因为它就是基于 Material 3 Expressive 开发的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5a83d00231340e581b050bfee164cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=UG2iuyUAPJHNT8B06rVA8ncroOY%3D" alt="图片" loading="lazy"/></p>
<p>它分专注模式、短休息、长休息，默认 25 分钟工作、5 分钟休息，也能自己调时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd5bd35d55f4bc1ac34c64b01441fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=WmlvYaP0Q%2Fowefa8LX0wziknnjU%3D" alt="图片" loading="lazy"/></p>
<p>能统计你每天、每周、每月的专注时长，还能看自己哪个时间段最有效率，比如早上 9 点到 11 点。界面极简无广告，支持安卓 16 及以上的实时更新功能，适合学生、上班族用来对抗拖延。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617e11fbc6ab4fb38e1945f9d34965ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763703930&amp;x-signature=SM2b0woxd4iT6wHu%2FohmFYdKArg%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/nsh07/Tomato</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[qinkun的缓存机制也有弊端，建议官方个参数控制]]></title>    <link>https://juejin.cn/post/7572141390857437184</link>    <guid>https://juejin.cn/post/7572141390857437184</guid>    <pubDate>2025-11-14T05:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572141390857437184" data-draft-id="7572141390857355264" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="qinkun的缓存机制也有弊端，建议官方个参数控制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-14T05:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="石小石Orz"/> <meta itemprop="url" content="https://juejin.cn/user/660148845294712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            qinkun的缓存机制也有弊端，建议官方个参数控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/660148845294712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    石小石Orz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:54:49.000Z" title="Fri Nov 14 2025 05:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>公司前端基于qiankun架构，主应用通过qiankun加载子应用，子应用也可能通过qiankun继续加载子应用，反复套娃。经过测试，不断打开子应用后，会导致内存不断上上。通过<strong>快照分析</strong>，发现内存升高的元凶是qiankun内置的# <code>import-html-entry</code>。</p>
<h2 data-id="heading-0"><code>import-html-entry</code> 的作用是什么</h2>
<p><code>import-html-entry</code> 是 qiankun / single-spa 微前端生态的核心模块之一，用来：</p>
<p>加载远程 HTML 入口文件（entry HTML），并提取出其中的 <strong>JS / CSS / 静态资源</strong>，然后按需执行或注入。</p>
<p>比如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { importEntry } <span class="hljs-keyword">from</span> <span class="hljs-string">'import-html-entry'</span>;

<span class="hljs-keyword">const</span> { execScripts } = <span class="hljs-keyword">await</span> importEntry(<span class="hljs-string">'https://wwww.石小石.com/'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">execScripts</span>(<span class="hljs-variable language_">window</span>);
</code></pre>
<p>简单来说，<code>import-html-entry</code> 负责做三件事：</p>
<p><strong>下载远程 HTML 文件</strong></p>
<ul>
<li>使用 <code>fetch(url)</code> 请求远程 HTML。</li>
<li>解析 HTML 中的 <code>&lt;script&gt;</code> 与 <code>&lt;link&gt;</code> 标签。</li>
</ul>
<p><strong>提取资源并缓存</strong></p>
<ul>
<li>提取脚本与样式资源 URL。</li>
<li>通过自定义逻辑加载（并缓存）外部脚本与样式内容。</li>
<li>将 <code>&lt;link&gt;</code> 替换为内联 <code>&lt;style&gt;</code>，提升加载性能。</li>
</ul>
<p><strong>执行脚本</strong></p>
<ul>
<li>通过 <code>eval</code> 在隔离作用域中执行 JS（防止污染主应用的 window）。</li>
<li>支持 <code>proxy</code> 代理对象（qiankun 沙箱核心）。</li>
<li>支持同步、异步脚本的加载与执行顺序。</li>
</ul>
<h2 data-id="heading-1">核心源码</h2>
<p>它的 源码中包含这些关键函数：</p>





































<table><thead><tr><th>函数名</th><th>作用</th></tr></thead><tbody><tr><td><code>importHTML(url, opts)</code></td><td>主入口，加载远程 HTML</td></tr><tr><td><code>processTpl</code></td><td>解析 HTML 模板，提取 script/link</td></tr><tr><td><code>_getExternalScripts</code></td><td>加载并缓存 JS</td></tr><tr><td><code>_getExternalStyleSheets</code></td><td>加载并缓存 CSS</td></tr><tr><td><code>_execScripts</code></td><td>按顺序执行脚本</td></tr><tr><td><code>getExecutableScript</code></td><td>包装脚本为沙箱可执行代码</td></tr><tr><td><code>evalCode</code></td><td>实际执行脚本（带缓存）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d15c7fdf3934c71b9dd3ec6df5a8d9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=G%2B%2FqsBPclaVS5jjITApXNbmMbXQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">缓存机制</h2>
<p><code>import-html-entry</code> 内部维护了四个全局缓存对象， 这些缓存的目的是 <strong>在同一个浏览器会话中</strong>，当多个子应用或同一个子应用多次加载同一个 URL 时，避免重复网络请求，从而加快微前端加载速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> styleCache = {};    <span class="hljs-comment">// 样式字符缓存</span>
<span class="hljs-keyword">var</span> scriptCache = {};   <span class="hljs-comment">// js字符缓存</span>
<span class="hljs-keyword">var</span> embedHTMLCache = {};<span class="hljs-comment">// html字符缓存</span>
<span class="hljs-keyword">var</span> evalCache = {};     <span class="hljs-comment">// 编译后的脚本缓存</span>
</code></pre>
<p>styleCache对应源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/defb9b5ef19e454bafcf764484954996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=6aMhNluZPpL%2FU8pOHHDAvXajSsI%3D" alt="" loading="lazy"/></p>
<p>scriptCache对应源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fbad9bdf25c47fc9a6749bde4708b57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=OAqOpZLHoq3WLRHkorygs5rt3L4%3D" alt="" loading="lazy"/></p>
<p>embedHTMLCache对应源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edb39ab801534a1995e5463272564844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=AfmAWTHzROiKuUZwe2DABZ%2BtQSo%3D" alt="" loading="lazy"/></p>
<p>evalCache对应源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b4a81fc3e804d7f9381634ff94d55ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=mv66vzlkCzBCobkAB%2Bw6RrqajUw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">缓存机制在子应用多开频繁销毁创建场景中的弊端</h2>
<p>在单实例的 <strong>qiankun 架构</strong> 中，<code>import-html-entry</code> 的缓存仅会存在一份，对内存的占用影响有限，缓存带来的性能收益相对较高。<br/>
但如果系统存在大量qiankun加载子应用的场景，比如要频繁打开若干子应用（类似于菜单），子应用需要频繁打开销毁（tab切换等），同时其内部的部分功能模块又会再次通过 <code>qiankun</code> 动态加载子应用。这种嵌套加载结构会导致 <code>import-html-entry</code> 在多个层级重复缓存资源，即使资源内容相同，也会被多次存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dd52ac49dc84c40bc67d7d4d21ba135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5bCP55-zT3J6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704488&amp;x-signature=GjY2cixQRUuh0k7iCBjHJyJXprM%3D" alt="" loading="lazy"/></p>
<p>因此，子应用的频繁打开与卸载，会导致内存占用持续增长，从而引发明显的性能下降（国产CPU可能更明显）。</p>
<p>因此，<strong>移除或禁用</strong> <code>import-html-entry</code> <strong>的缓存机制</strong>，能极大缓解内存泄漏问题，<strong>提升系统在复杂场景下的运行性能与稳定性</strong>。</p>
<h2 data-id="heading-4">优化方案</h2>



































<table><thead><tr><th>缓存名</th><th>缓存内容</th><th>缓存目的</th><th>禁用影响</th></tr></thead><tbody><tr><td><strong>styleCache</strong></td><td>每个 CSS 链接的内容（文本）</td><td>避免重复请求相同样式文件</td><td>每次重新请求 CSS（但浏览器会命中协商缓存，影响极小）</td></tr><tr><td><strong>scriptCache</strong></td><td>每个 JS 链接的内容（文本）</td><td>避免重复请求相同脚本文件</td><td>每次重新请求 JS（命中浏览器缓存，影响较小）</td></tr><tr><td><strong>embedHTMLCache</strong></td><td>整个 HTML 模板字符串</td><td>避免重复请求入口 HTML 文件</td><td>每次重新请求入口文件，性能略降</td></tr><tr><td><strong>evalCache</strong></td><td>每个脚本的已编译函数 <code>(function(){...})</code></td><td><strong>避免多次 eval 编译同一脚本字符串</strong>，提升运行性能</td><td>每次都重新 eval 解析 JS 字符串，会略微影响性能（CPU 负担）</td></tr></tbody></table>
<p>浏览器自带的协商缓存已能高效复用 HTML、JS、CSS 资源，因此禁用 <code>import-html-entry</code> 的缓存逻辑几乎不影响加载性能。<br/>
<code>evalCache</code> 的移除可能短暂增加 CPU 开销降低性能，但整体影响可能较小，需要综合评估。</p>
<p><strong>通过在 qiankun 集成层中移除多余缓存，可有效降低内存占用，缓解泄漏问题，并显著提升系统性能与稳定性。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3实现拖拽排序]]></title>    <link>https://juejin.cn/post/7572161976592990260</link>    <guid>https://juejin.cn/post/7572161976592990260</guid>    <pubDate>2025-11-14T05:54:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572161976592990260" data-draft-id="7572141390857388032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3实现拖拽排序"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-14T05:54:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户971417181427"/> <meta itemprop="url" content="https://juejin.cn/user/2200564916558794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3实现拖拽排序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200564916558794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户971417181427
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T05:54:03.000Z" title="Fri Nov 14 2025 05:54:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 + Element Plus + SortableJS 实现表格拖拽排序功能</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0" title="#%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0">功能概述</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E6%A0%88" title="#%E6%8A%80%E6%9C%AF%E6%A0%88">技术栈</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" title="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">实现思路</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" title="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">代码实现</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9" title="#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9">核心要点</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h3 data-id="heading-2">功能概述</h3>
<p>在管理后台系统中，表格数据的排序功能是一个常见的需求。本文介绍如何使用 Vue3、Element Plus 和 SortableJS 实现一个完整的表格拖拽排序功能，支持：</p>
<ul>
<li>✅ 通过拖拽图标对表格行进行排序</li>
<li>✅ 实时更新数据顺序</li>
<li>✅ 支持数据过滤后的排序</li>
<li>✅ 切换标签页时自动初始化</li>
<li>✅ 优雅的动画效果</li>
</ul>
<p>先看实现效果：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c73de6a194d442aebd5b55829a911490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTcxNDE3MTgxNDI3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763704442&amp;x-signature=bl%2F2pUzi4HtZc5FXWMg0yHD%2B%2FFk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">技术栈</h3>
<ul>
<li><strong>Vue 3</strong> - 渐进式 JavaScript 框架</li>
<li><strong>Element Plus</strong> - Vue 3 组件库</li>
<li><strong>SortableJS</strong> - 轻量级拖拽排序库</li>
<li><strong>TypeScript</strong> - 类型安全的 JavaScript 超集</li>
</ul>
<h3 data-id="heading-4">实现思路</h3>
<h4 data-id="heading-5">1. 整体架构</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户拖拽表格行
<span class="hljs-code">    ↓
SortableJS 监听拖拽事件
    ↓
触发 onEnd 回调
    ↓
更新 Vue 响应式数据
    ↓
表格自动重新渲染
</span></code></pre>
<h4 data-id="heading-6">2. 关键步骤</h4>
<ol>
<li><strong>安装依赖</strong>：引入 SortableJS 库</li>
<li><strong>获取 DOM</strong>：获取表格 tbody 元素</li>
<li><strong>初始化 Sortable</strong>：创建拖拽实例</li>
<li><strong>处理回调</strong>：在拖拽结束时更新数据</li>
<li><strong>生命周期管理</strong>：在适当时机初始化和销毁实例</li>
</ol>
<h3 data-id="heading-7">代码实现</h3>
<h4 data-id="heading-8">1. 安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install sortablejs
<span class="hljs-comment"># 或</span>
pnpm add sortablejs
</code></pre>
<h4 data-id="heading-9">2. 导入必要的模块</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, nextTick, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Sortable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"sortablejs"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Operation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@element-plus/icons-vue"</span>;<span class="hljs-comment">//图标</span>
</code></pre>
<h4 data-id="heading-10">3. 定义数据结构</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">TypeItem</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">sortOrder</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> typeData = ref&lt;<span class="hljs-title class_">TypeItem</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"1"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"楼宇性质1"</span>, <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">sortOrder</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"2"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"楼宇性质2"</span>, <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">sortOrder</span>: <span class="hljs-number">2</span> },
  <span class="hljs-comment">// ... 更多数据</span>
]);
</code></pre>
<h4 data-id="heading-11">4. 模板结构</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-table ref="typeTableRef" :data="filteredTypeData" stripe row-key="id"&gt;
    &lt;!-- 排序列：显示拖拽图标 --&gt;
    &lt;el-table-column label="排序" width="131"&gt;
      &lt;template #default&gt;
        &lt;el-icon class="drag-handle"&gt;
          &lt;Operation /&gt;
        &lt;/el-icon&gt;
      &lt;/template&gt;
    &lt;/el-table-column&gt;
    
    &lt;!-- 其他列 --&gt;
    &lt;el-table-column prop="name" label="名称" /&gt;
    &lt;el-table-column prop="enabled" label="启用/禁用"&gt;
      &lt;template #default="{ row }"&gt;
        &lt;el-switch v-model="row.enabled" /&gt;
      &lt;/template&gt;
    &lt;/el-table-column&gt;
  &lt;/el-table&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">5. 核心实现代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 表格引用</span>
<span class="hljs-keyword">const</span> typeTableRef = ref&lt;<span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">ElTable</span>&gt;&gt;();

<span class="hljs-comment">// Sortable 实例（用于后续销毁）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">sortableInstance</span>: <span class="hljs-title class_">Sortable</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 初始化拖拽排序功能
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initSortable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 销毁旧实例，避免重复创建</span>
  <span class="hljs-keyword">if</span> (sortableInstance) {
    sortableInstance.<span class="hljs-title function_">destroy</span>();
    sortableInstance = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 2. 等待 DOM 更新完成</span>
  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 3. 获取表格的 tbody 元素</span>
    <span class="hljs-keyword">const</span> tbody = typeTableRef.<span class="hljs-property">value</span>?.<span class="hljs-property">$el</span>?.<span class="hljs-title function_">querySelector</span>(
      <span class="hljs-string">".el-table__body-wrapper tbody"</span>
    );
    
    <span class="hljs-keyword">if</span> (!tbody) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 4. 创建 Sortable 实例</span>
    sortableInstance = <span class="hljs-title class_">Sortable</span>.<span class="hljs-title function_">create</span>(tbody, {
      <span class="hljs-comment">// 指定拖拽手柄（只能通过拖拽图标来拖拽）</span>
      <span class="hljs-attr">handle</span>: <span class="hljs-string">".drag-handle"</span>,
      
      <span class="hljs-comment">// 动画时长（毫秒）</span>
      <span class="hljs-attr">animation</span>: <span class="hljs-number">300</span>,
      
      <span class="hljs-comment">// 拖拽结束回调</span>
      <span class="hljs-attr">onEnd</span>: <span class="hljs-function">(<span class="hljs-params">{ newIndex, oldIndex }</span>) =&gt;</span> {
        <span class="hljs-comment">// 5. 更新数据顺序</span>
        <span class="hljs-keyword">if</span> (
          newIndex !== <span class="hljs-literal">undefined</span> &amp;&amp;
          oldIndex !== <span class="hljs-literal">undefined</span> &amp;&amp;
          filterStatus.<span class="hljs-property">value</span> === <span class="hljs-string">"all"</span> <span class="hljs-comment">// 只在"全部"状态下允许排序</span>
        ) {
          <span class="hljs-comment">// 获取被移动的项</span>
          <span class="hljs-keyword">const</span> movedItem = typeData.<span class="hljs-property">value</span>[oldIndex];
          
          <span class="hljs-comment">// 从原位置删除</span>
          typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(oldIndex, <span class="hljs-number">1</span>);
          
          <span class="hljs-comment">// 插入到新位置</span>
          typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(newIndex, <span class="hljs-number">0</span>, movedItem);
          
          <span class="hljs-comment">// 更新排序字段</span>
          typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
            item.<span class="hljs-property">sortOrder</span> = index + <span class="hljs-number">1</span>;
          });
        }
      }
    });
  });
};
</code></pre>
<h4 data-id="heading-13">6. 生命周期管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 监听标签页切换，初始化拖拽
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">watchActiveTab</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (activeTab.<span class="hljs-property">value</span> === <span class="hljs-string">"type"</span>) {
    <span class="hljs-comment">// 延迟初始化，确保表格已完全渲染</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">initSortable</span>();
    }, <span class="hljs-number">300</span>);
  }
};

<span class="hljs-comment">// 组件挂载时初始化</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">watchActiveTab</span>();
});

<span class="hljs-comment">// 监听标签页切换</span>
<span class="hljs-title function_">watch</span>(activeTab, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">watchActiveTab</span>();
});

<span class="hljs-comment">// 监听过滤器变化，重新初始化拖拽</span>
<span class="hljs-title function_">watch</span>(filterStatus, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (activeTab.<span class="hljs-property">value</span> === <span class="hljs-string">"type"</span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">initSortable</span>();
    }, <span class="hljs-number">100</span>);
  }
});
</code></pre>
<h4 data-id="heading-14">7. 样式定义</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 拖拽手柄样式 */</span>
<span class="hljs-selector-class">.drag-handle</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  <span class="hljs-attribute">cursor</span>: move;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
  <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.drag-handle</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1890ff</span>;
}

<span class="hljs-comment">/* 表格样式 */</span>
<span class="hljs-selector-class">.type-table</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
}

:<span class="hljs-built_in">deep</span>(.type-table .el-table__header-wrapper) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9fafc</span>;
}

:<span class="hljs-built_in">deep</span>(.type-table .el-table th) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9fafc</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#33425cfa</span>;
  <span class="hljs-attribute">font-family</span>: PingFang SC;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#dcdfe6</span>;
}
</code></pre>
<h3 data-id="heading-15">核心要点</h3>
<h4 data-id="heading-16">1. 实例管理</h4>
<p><strong>问题</strong>：如果不管理 Sortable 实例，切换标签页或过滤器时会创建多个实例，导致拖拽行为异常。</p>
<p><strong>解决</strong>：使用变量保存实例引用，在创建新实例前先销毁旧实例。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">sortableInstance</span>: <span class="hljs-title class_">Sortable</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">initSortable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 先销毁旧实例</span>
  <span class="hljs-keyword">if</span> (sortableInstance) {
    sortableInstance.<span class="hljs-title function_">destroy</span>();
    sortableInstance = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 再创建新实例</span>
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h4 data-id="heading-17">2. DOM 获取时机</h4>
<p><strong>问题</strong>：如果直接获取 DOM，可能表格还未渲染完成，导致获取失败。</p>
<p><strong>解决</strong>：使用 <code>nextTick</code> 等待 Vue 完成 DOM 更新，或使用 <code>setTimeout</code> 延迟执行。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> tbody = typeTableRef.<span class="hljs-property">value</span>?.<span class="hljs-property">$el</span>?.<span class="hljs-title function_">querySelector</span>(
    <span class="hljs-string">".el-table__body-wrapper tbody"</span>
  );
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<h4 data-id="heading-18">3. 拖拽手柄</h4>
<p><strong>问题</strong>：如果不指定拖拽手柄，整行都可以拖拽，可能与其他交互冲突（如点击编辑按钮）。</p>
<p><strong>解决</strong>：使用 <code>handle</code> 选项指定只有拖拽图标可以触发拖拽。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Sortable</span>.<span class="hljs-title function_">create</span>(tbody, {
  <span class="hljs-attr">handle</span>: <span class="hljs-string">".drag-handle"</span>, <span class="hljs-comment">// 只允许通过 .drag-handle 元素拖拽</span>
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<h4 data-id="heading-19">4. 数据更新策略</h4>
<p><strong>问题</strong>：直接操作 DOM 顺序不会更新 Vue 的响应式数据。</p>
<p><strong>解决</strong>：在 <code>onEnd</code> 回调中手动更新数据数组的顺序。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">onEnd</span>: <span class="hljs-function">(<span class="hljs-params">{ newIndex, oldIndex }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> movedItem = typeData.<span class="hljs-property">value</span>[oldIndex];
  typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(oldIndex, <span class="hljs-number">1</span>);
  typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(newIndex, <span class="hljs-number">0</span>, movedItem);
  <span class="hljs-comment">// 更新排序字段</span>
  typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    item.<span class="hljs-property">sortOrder</span> = index + <span class="hljs-number">1</span>;
  });
}
</code></pre>
<h4 data-id="heading-20">5. 过滤状态处理</h4>
<p><strong>问题</strong>：当表格数据被过滤后，拖拽的索引可能不准确。</p>
<p><strong>解决</strong>：只在"全部"状态下允许排序，或根据过滤后的数据计算正确的索引。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">onEnd</span>: <span class="hljs-function">(<span class="hljs-params">{ newIndex, oldIndex }</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (filterStatus.<span class="hljs-property">value</span> === <span class="hljs-string">"all"</span>) {
    <span class="hljs-comment">// 只在全部状态下允许排序</span>
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h3 data-id="heading-21">常见问题</h3>
<h4 data-id="heading-22">Q1: 拖拽后数据没有更新？</h4>
<p><strong>A</strong>: 检查是否正确更新了响应式数据。SortableJS 只负责 DOM 操作，不会自动更新 Vue 数据。</p>
<h4 data-id="heading-23">Q2: 切换标签页后拖拽失效？</h4>
<p><strong>A</strong>: 需要在标签页切换时重新初始化 Sortable 实例，因为 DOM 已经重新渲染。</p>
<h4 data-id="heading-24">Q3: 拖拽时整行都可以拖，如何限制？</h4>
<p><strong>A</strong>: 使用 <code>handle</code> 选项指定拖拽手柄元素。</p>
<h4 data-id="heading-25">Q4: 拖拽动画不流畅？</h4>
<p><strong>A</strong>: 调整 <code>animation</code> 参数的值，通常 200-300ms 效果较好。</p>
<h4 data-id="heading-26">Q5: 如何保存排序结果？</h4>
<p><strong>A</strong>: 在 <code>onEnd</code> 回调中，将更新后的数据发送到后端 API。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">onEnd</span>: <span class="hljs-function">(<span class="hljs-params">{ newIndex, oldIndex }</span>) =&gt;</span> {
  <span class="hljs-comment">// 更新本地数据</span>
  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-comment">// 保存到后端</span>
  <span class="hljs-title function_">saveSortOrder</span>(typeData.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
    <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>,
    <span class="hljs-attr">sortOrder</span>: item.<span class="hljs-property">sortOrder</span>
  })));
}
</code></pre>
<h3 data-id="heading-27">完整示例代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="type-setting"&gt;
    &lt;!-- 过滤器 --&gt;
    &lt;div class="filter-actions"&gt;
      &lt;el-button
        :type="filterStatus === 'all' ? 'primary' : ''"
        @click="filterStatus = 'all'"
      &gt;
        全部
      &lt;/el-button&gt;
      &lt;el-button
        :type="filterStatus === 'enabled' ? 'primary' : ''"
        @click="filterStatus = 'enabled'"
      &gt;
        启用
      &lt;/el-button&gt;
    &lt;/div&gt;

    &lt;!-- 表格 --&gt;
    &lt;el-table
      ref="typeTableRef"
      :data="filteredTypeData"
      stripe
      row-key="id"
    &gt;
      &lt;el-table-column label="排序" width="131"&gt;
        &lt;template #default&gt;
          &lt;el-icon class="drag-handle"&gt;
            &lt;Operation /&gt;
          &lt;/el-icon&gt;
        &lt;/template&gt;
      &lt;/el-table-column&gt;
      &lt;el-table-column prop="name" label="名称" /&gt;
      &lt;el-table-column prop="enabled" label="启用/禁用"&gt;
        &lt;template #default="{ row }"&gt;
          &lt;el-switch v-model="row.enabled" /&gt;
        &lt;/template&gt;
      &lt;/el-table-column&gt;
      &lt;el-table-column label="操作"&gt;
        &lt;template #default="{ row }"&gt;
          &lt;el-button type="primary" link @click="handleEdit(row)"&gt;
            编辑
          &lt;/el-button&gt;
        &lt;/template&gt;
      &lt;/el-table-column&gt;
    &lt;/el-table&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, nextTick, watch, onMounted } from "vue";
import { ElTable } from "element-plus";
import Sortable from "sortablejs";
import { Operation } from "@element-plus/icons-vue";

interface TypeItem {
  id: string;
  name: string;
  enabled: boolean;
  sortOrder: number;
}

const typeData = ref&lt;TypeItem[]&gt;([
  { id: "1", name: "楼宇性质1", enabled: true, sortOrder: 1 },
  { id: "2", name: "楼宇性质2", enabled: true, sortOrder: 2 },
  { id: "3", name: "楼宇性质3", enabled: false, sortOrder: 3 },
]);

const filterStatus = ref&lt;"all" | "enabled" | "disabled"&gt;("all");
const typeTableRef = ref&lt;InstanceType&lt;typeof ElTable&gt;&gt;();
let sortableInstance: Sortable | null = null;

const filteredTypeData = computed(() =&gt; {
  if (filterStatus.value === "all") return typeData.value;
  if (filterStatus.value === "enabled") {
    return typeData.value.filter(item =&gt; item.enabled);
  }
  return typeData.value.filter(item =&gt; !item.enabled);
});

const initSortable = () =&gt; {
  if (sortableInstance) {
    sortableInstance.destroy();
    sortableInstance = null;
  }

  nextTick(() =&gt; {
    const tbody = typeTableRef.value?.$el?.querySelector(
      ".el-table__body-wrapper tbody"
    );
    if (!tbody) return;

    sortableInstance = Sortable.create(tbody, {
      handle: ".drag-handle",
      animation: 300,
      onEnd: ({ newIndex, oldIndex }) =&gt; {
        if (
          newIndex !== undefined &amp;&amp;
          oldIndex !== undefined &amp;&amp;
          filterStatus.value === "all"
        ) {
          const movedItem = typeData.value[oldIndex];
          typeData.value.splice(oldIndex, 1);
          typeData.value.splice(newIndex, 0, movedItem);
          typeData.value.forEach((item, index) =&gt; {
            item.sortOrder = index + 1;
          });
        }
      }
    });
  });
};

onMounted(() =&gt; {
  setTimeout(() =&gt; initSortable(), 300);
});

watch(filterStatus, () =&gt; {
  setTimeout(() =&gt; initSortable(), 100);
});
&lt;/script&gt;

&lt;style scoped&gt;
.drag-handle {
  color: #909399;
  cursor: move;
  font-size: 18px;
}

.drag-handle:hover {
  color: #1890ff;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-28">总结</h3>
<p>通过本文的介绍，我们实现了一个完整的表格拖拽排序功能。关键点包括：</p>
<ol>
<li>✅ <strong>正确的实例管理</strong>：避免重复创建和内存泄漏</li>
<li>✅ <strong>合适的初始化时机</strong>：确保 DOM 已完全渲染</li>
<li>✅ <strong>数据同步更新</strong>：手动更新 Vue 响应式数据</li>
<li>✅ <strong>良好的用户体验</strong>：指定拖拽手柄，添加动画效果</li>
<li>✅ <strong>完善的错误处理</strong>：处理边界情况</li>
</ol>
<p>这个方案可以轻松应用到其他需要拖拽排序的场景，如菜单管理、分类排序等。希望本文对您有所帮助！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题]]></title>    <link>https://juejin.cn/post/7572138663120371754</link>    <guid>https://juejin.cn/post/7572138663120371754</guid>    <pubDate>2025-11-14T04:09:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572138663120371754" data-draft-id="7572048000302825513" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题"/> <meta itemprop="keywords" content="后端,Java,Nginx"/> <meta itemprop="datePublished" content="2025-11-14T04:09:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mzlogin"/> <meta itemprop="url" content="https://juejin.cn/user/1890815727118414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1890815727118414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mzlogin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T04:09:32.000Z" title="Fri Nov 14 2025 04:09:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一种常见的服务部署架构是 Nginx 反向代理后端 Java 应用服务器，Nginx 监听 443 端口处理 https 请求，然后转发给后端服务器。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/113072053cce4c44815057a72ee7a785~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=361&amp;h=293&amp;s=7062&amp;e=png&amp;a=1&amp;b=d4e7d3" alt="图片" loading="lazy"/></p>
<p>对应的 Nginx 配置大致如下：</p>
<pre><code class="hljs language-ini" lang="ini">upstream www {
    server 192.168.1.101:8080  <span class="hljs-attr">weight</span>=<span class="hljs-number">100</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">10</span>s<span class="hljs-comment">;</span>
    server 192.168.1.102:8080  <span class="hljs-attr">weight</span>=<span class="hljs-number">100</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">10</span>s<span class="hljs-comment">;</span>
}
server {
    listen 443 ssl<span class="hljs-comment">;</span>
    server_name example.com<span class="hljs-comment">;</span>
    ssl_certificate /path/to/cert.pem<span class="hljs-comment">;</span>
    ssl_certificate_key /path/to/key.pem<span class="hljs-comment">;</span>
    location / {
        proxy_pass http://www<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>即：客户端与 Nginx 之间是 https，Nginx 与后端 Java 应用服务器之间是 http。</p>
<p>这样可能会遇到一些问题，如：</p>
<ol>
<li>
<p><code>HttpServletRequest.getRequestURL()</code></p>
<p>获取到的 URL 是 Nginx 与后端服务器之间的 http URL，比如 <code>http://192.168.1.101:8080/xxx</code>；</p>
</li>
<li>
<p><code>HttpServletResponse.sendRedirect()</code></p>
<p>生成的重定向 URL 也是 http URL。</p>
</li>
</ol>
<p>要解决这些问题，可以通过 Nginx 配置 + 少量后端代码修改来实现。</p>
<h2 data-id="heading-0">解决应用中获取到的 URL 的问题</h2>
<p>用户实际访问的是 <code>https://example.com/xxx</code>，但是后端应用获取到的 URL 是 <code>http://192.168.1.101:8080/xxx</code>，如何让后端应用获取到正确的 URL 呢？</p>
<p>第一步，Nginx 可以通过 <code>proxy_set_header Host</code> 指令将客户端请求的 Host 头传递给后端服务器：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
    <span class="hljs-comment"># ...</span>
    proxy_set_header Host <span class="hljs-variable">$host</span>;
}
</code></pre>
<p>这样，后端应用通过 <code>HttpServletRequest.getRequestURL()</code> 获取到的 URL 就是 <code>http://example.com/xxx</code> 了。</p>
<p>但此时，协议仍然不对，还是 http。</p>
<p>要给后端应用传递正确的协议，通常的做法是使用 <code>X-Forwarded-Proto</code> 头：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
    <span class="hljs-comment"># ...</span>
    proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
}
</code></pre>
<p>添加这个头之后并不会让 <code>HttpServletRequest.getRequestURL()</code> 直接返回 https URL，需要在后端应用中做一些处理。以 Java 应用为例，可以通过一个过滤器（Filter）来修改 request 的 scheme：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.servlet.*;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XForwardedProtoFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span>
            <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> HttpServletRequest) {
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;
            <span class="hljs-type">String</span> <span class="hljs-variable">xForwardedProto</span> <span class="hljs-operator">=</span> httpRequest.getHeader(<span class="hljs-string">"X-Forwarded-Proto"</span>);
            <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(xForwardedProto) &amp;&amp; !xForwardedProto.equalsIgnoreCase(httpRequest.getScheme()) &amp;&amp; xForwardedProto.equalsIgnoreCase(<span class="hljs-string">"https"</span>)) {
                httpRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServletRequestWrapper</span>(httpRequest) {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getScheme</span><span class="hljs-params">()</span> {
                        <span class="hljs-keyword">return</span> xForwardedProto;
                    }
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> StringBuffer <span class="hljs-title function_">getRequestURL</span><span class="hljs-params">()</span> {
                        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">requestURL</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.getRequestURL();
                        <span class="hljs-keyword">if</span> (requestURL != <span class="hljs-literal">null</span> &amp;&amp; requestURL.length() &gt; <span class="hljs-number">0</span>) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> requestURL.indexOf(<span class="hljs-string">"://"</span>);
                            <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">0</span>) {
                                requestURL.replace(<span class="hljs-number">0</span>, index, xForwardedProto);
                            }
                        }
                        <span class="hljs-keyword">return</span> requestURL;
                    }

                };
            }
            chain.doFilter(httpRequest, response);
        } <span class="hljs-keyword">else</span> {
            chain.doFilter(request, response);
        }
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException {
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
    }
}
</code></pre>
<p>至此，后端应用通过 <code>HttpServletRequest.getRequestURL()</code> 获取到的 URL 就是 <code>https://example.com/xxx</code> 了。</p>
<h2 data-id="heading-1">解决重定向 URL 的问题</h2>
<p>后端应用通过 <code>HttpServletResponse.sendRedirect()</code> 生成的重定向 URL 也是 http URL，如何让它变成 https 呢？</p>
<p>这个问题可以通过 Nginx 的另一指令 <code>proxy_redirect</code> 来解决，该指令用于修改从后端服务器返回的 <code>Location</code> 和 <code>Refresh</code> 响应头。</p>
<pre><code class="hljs language-perl" lang="perl">location / {
    <span class="hljs-comment"># ...</span>
    proxy_redirect http:<span class="hljs-regexp">//</span> $scheme:<span class="hljs-regexp">//</span>;
}
</code></pre>
<p>这样，当后端应用返回一个重定向响应时，Nginx 会将 <code>Location</code> 头中的 <code>http://</code> 替换为 <code>$scheme://</code>，即 <code>https://</code>。</p>
<h2 data-id="heading-2">进一步思考：当 Nginx 前面还有负载均衡器时</h2>
<p>在很多情况下，Nginx 前面可能还有商用负载均衡器（如 AWS ELB、阿里云 SLB 等），这时需要考虑负载均衡器与 Nginx 之间的协议问题。</p>
<p>如果负载均衡器与 Nginx 之间是 http，而 Nginx 与后端应用之间是 http，那么就需要在负载均衡器和 Nginx 之间添加 <code>X-Forwarded-Proto</code> 头，以便 Nginx 能够正确地识别原始请求的协议。</p>
<p>主流的负载均衡器配置项里应该都有添加 <code>X-Forwarded-Proto</code> 头的选项开关，比如阿里云：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/378eb621996f4a7ea3f16535fc290261~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=974&amp;h=438&amp;s=89095&amp;e=png&amp;b=fefefe" alt="图片" loading="lazy"/></p>
<p>需要注意的是这样配置后，Nginx 配置也需要做相应的调整，将 <code>$scheme</code> 替换为 <code>$http_x_forwarded_proto</code>：<br/>
（此种场景 <code>$scheme</code> 为负载均衡器与 Nginx 之间的协议 http，<code>$http_x_forwarded_proto</code> 为负载均衡器通过 Header 透传过来的前端访问协议 https。）</p>
<pre><code class="hljs language-perl" lang="perl">location / {
    <span class="hljs-comment"># ...</span>
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_redirect http:<span class="hljs-regexp">//</span> $http_x_forwarded_proto:<span class="hljs-regexp">//</span>;
}
</code></pre>
<h2 data-id="heading-3">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_set_header" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" ref="nofollow noopener noreferrer">Nginx 官方文档 - proxy_set_header</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_redirect" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" ref="nofollow noopener noreferrer">Nginx 官方文档 - proxy_redirect</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23variables" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#variables" ref="nofollow noopener noreferrer">Nginx 官方文档 - Embedded Variables</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不小心更新了trae，发现...]]></title>    <link>https://juejin.cn/post/7572092283719925812</link>    <guid>https://juejin.cn/post/7572092283719925812</guid>    <pubDate>2025-11-14T04:13:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572092283719925812" data-draft-id="7572092283719614516" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不小心更新了trae，发现..."/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-14T04:13:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙在天"/> <meta itemprop="url" content="https://juejin.cn/user/3760787883819464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不小心更新了trae，发现...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3760787883819464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙在天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T04:13:03.000Z" title="Fri Nov 14 2025 04:13:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">发现</h2>
<p>国际版的 <strong>Trade Solo</strong> 最近推了个大更新，真的挺重磅的。
除了原本就有的 <strong>Solo Builder</strong>，现在又新增了一个 <strong>Solo Coder</strong>，功能更狠。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fe8776b94104c7e8b0366d90ff84933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=aibkNMAbkZGYvOdMJ606Kd%2BYVnA%3D" alt="image.png" loading="lazy"/></p>
<p>先说 Solo Coder。
它里面有个 <strong>Plan 模式</strong>，点进去之后可以用来排查各种问题。它会先自动给你生成一份任务文档，你确认没问题之后，它就能按照这个计划一步步去执行，特别省心。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4756802e64df4e75b3a04cf3b70e8a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=IwImPc3Y%2F7LomGZdLkzZlHz6cLY%3D" alt="image.png" loading="lazy"/></p>
<p>再来就是 <strong>编辑工具</strong> 这块。
你可以往里面加 <strong>MCP 工具</strong>，这一点非常强。
比如：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3316c6648a2a48028e59490ede33f5ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=sd9g0Yv0MOvc71VEWLcaFKFwGa0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>给它接一个前端相关的 MCP，它就能当前端程序员用；</li>
<li>给它接一个 MySQL，它立马能充当后端；</li>
<li>给它输入业务资料，它还能做需求分析。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5d2baae8d9483ca448ae031557a5b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=HtkJ59Dk3b60LmeDcrrN7m8w7iQ%3D" alt="image.png" loading="lazy"/></p>
<p>相当于你给它什么，它就能变成什么，全靠你给的 MCP 工具组合。</p>
<p>而且 <strong>Solo Coder 支持并发执行任务</strong>。
像我这边已经同时开了五个任务一起跑了，它还可以继续加新的任务进去一起执行。官方建议最多开十个并发任务，这样效果最好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f240f9e41d8c46b1b59357e618c2bd42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=IFWKydB12qz1yhBXBMx4lHXDl%2Fs%3D" alt="image.png" loading="lazy"/></p>
<p>最关键的是：
<strong>现在限时免费</strong>！
到 11 月 15 号凌晨之前都可以白嫖试用一下。</p>
<p>总之，这次更新是真有点猛，喜欢折腾工具的可以赶紧去玩玩。</p>
<h2 data-id="heading-1">实战 - 浏览器插件</h2>
<p><strong>🚀 零基础也能做浏览器插件！用 Trae 10 分钟开发一个“网页黑白切换”扩展</strong></p>
<p>浏览器插件（Extension）听起来像是专业开发者才能碰的东西？
今天我用 Trae（AI 开发工具）带你<strong>从零到一</strong>做一个完全可用的 Chrome / Edge / 国产浏览器通用插件。</p>
<p><strong>你不需要任何编程基础。
你只需要会复制粘贴。</strong></p>
<p>最终效果👇
点击浏览器右上角插件按钮 → 当前网页变黑白
再点一下 → 恢复彩色
再点 → 再变黑白……无限切换。</p>
<p>真的很酷，也很适合作为你的第一个 AI 编程作品。</p>
<h3 data-id="heading-2">提示词</h3>
<pre><code class="hljs language-html" lang="html">我是一个零基础用户，请帮我创建一个浏览器插件（Chrome / Edge / 360 / 夸克 都可以用）。  
插件功能：

-   点击浏览器工具栏按钮后把当前网页变成黑白模式（grayscale）。
-   再次点击按钮要恢复彩色。
-   支持反复切换。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d69a7e7790348ba80fcbb33fb59150f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=b7M99M234knWyCyGO%2FWbfGpahtk%3D" alt="image.png" loading="lazy"/></p>
<p>我们使用<code>Builder智能体+SOLO Coder Plan 模式</code>，在输入框里输入我们这段要求，直接回车，等待它帮我们写代码。<br/>
注意，我们这要实现这个功能，是要做一个浏览器插件的，所以提示词里一定要告诉它：我们要做一个浏览器插件。<br/>
这个浏览器插件做好之后，大部分的浏览器都可以通用的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63433049df34303b134caecdb12d424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=TmTaoc43sqpaXHZnn5TGOklrHtg%3D" alt="image.png" loading="lazy"/></p>
<p>好了，看到这个位置显示“任务完成”，那么就说明它全部已经编完了。</p>
<h3 data-id="heading-3">实时跟随</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cf1543ecb2a47e781b832867d837bc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=wJKvviBcdXxT%2Fh6iWwkj%2F34K3Eg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5cba4b790ab48958759290da10bf80b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=RHexzwVErL5eh9CXq9Fjze%2FetzU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcc1c77ec47b4a58a1abd1af087b704b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=SU7US6DggTgYBh%2BC3EqwAt767IY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>// manifest.json</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一键黑白"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"点击扩展按钮，让当前网页变成黑白（灰度）效果。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一键黑白"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"background"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"service_worker"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"background.js"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"scripting"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>接下来来到浏览器里，点右上角，找到你的扩展管理（我这用的是Chrome浏览器）。<br/>
打开之后，在左侧要开启“开发人员模式”，然后把我们刚才创建的文件夹，整个的都给它拖到我们浏览器里面，这样的话就安装成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b394118714d4f1d858537ec4e29442b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=6P0NeK%2BTVQOKrB7XMkREAmKXot4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f1eea9b0f5b4e3ca5fad66581ad1dc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=%2FaDGlji8HL0Mj1VYtRffQeiLkPg%3D" alt="image.png" loading="lazy"/>
点击右上角这个插件的图标，可以看到我们所有的插件。<br/>
在最后可以看到我们的插件——这个“黑白化网页”的插件。<br/>
好，点击这个固定按钮，把它固定在插件的菜单里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fa4c7150f464e84a34c52207f17062a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=%2BZs5gD5XihmLoanXy8kkjGGJy34%3D" alt="image.png" loading="lazy"/></p>
<p>然后我们打开百度去试一下：点击按钮，就能够立刻把它变成黑白色。<br/>
然后再打开淘宝试一下，也没有问题，整个网页都变成了黑白色。<br/>
但是这时候我们再想把它换回来，就没法换了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa3a509b16544d70ba6756b3b9f3bbe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=CC2q6STxWc5%2BDomhUfB6y%2BWr43g%3D" alt="image.png" loading="lazy"/></p>
<p>所以我们再加一个功能，把这段要求发给它，等待它帮我们继续优化迭代。</p>
<p>我们再来到插件管理里面，重新加载一下插件，然后重新打开淘宝看一下效果。<br/>
这样我们重复的点击这个小按钮，就能够让这个网页在黑白色和彩色之间来回切换。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec5ae7fc5ff481ba6591e6d3d8faeb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763698383&amp;x-signature=avFy4RRWp6ATxffE6Hh8Zovd95o%3D" alt="image.png" loading="lazy"/></p>
<p>好了，那么这个功能咱们就做完了。<br/>
如果你还有更好玩的AI编程想法的话，可以在评论区里留言，我看到合适的会把它实现，然后分享出来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【转载】 OpenAI 推出 GPT-5.1：面向开发者的智能模型]]></title>    <link>https://juejin.cn/post/7572086215028932650</link>    <guid>https://juejin.cn/post/7572086215028932650</guid>    <pubDate>2025-11-14T03:13:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572086215028932650" data-draft-id="7572087162231390250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【转载】 OpenAI 推出 GPT-5.1：面向开发者的智能模型"/> <meta itemprop="keywords" content="ChatGPT,GPT"/> <meta itemprop="datePublished" content="2025-11-14T03:13:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【转载】 OpenAI 推出 GPT-5.1：面向开发者的智能模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:13:17.000Z" title="Fri Nov 14 2025 03:13:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgpt-5-1-for-developers%2F" target="_blank" title="https://openai.com/index/gpt-5-1-for-developers/" ref="nofollow noopener noreferrer">原文链接</a></p>
<p><strong>发布日期：</strong> 2025年11月13日</p>
<blockquote>
<p>gpt应该是第一个把fast apply工程能力内置到工具的吧</p>
</blockquote>
<hr/>
<p>今天我们在 API 平台发布了 GPT‑5.1，这是 GPT‑5 系列中平衡智能和速度的下一代模型，适用于广泛的代理和编程任务。GPT‑5.1 根据任务复杂性动态调整思考时间，使模型在更简单的日常任务中显著更快且更节省 token。该模型还具备"无推理"模式，可在不需要深度思考的任务中更快响应，同时保持 GPT‑5.1 的前沿智能。</p>
<p>为了使 GPT‑5.1 更加高效，我们发布了扩展的提示缓存，最长可保留 24 小时缓存，以更低成本为后续问题提供更快响应。我们的优先处理客户也将在 GPT‑5.1 上体验到比 GPT‑5 明显更快的性能。</p>
<p>在编程方面，我们与 Cursor、Cognition、Augment Code、Factory 和 Warp 等初创公司密切合作，以改善 GPT‑5.1 的编程特性、可控性和代码质量。总体而言，GPT‑5.1 在编程方面感觉更直观易用，并且在完成任务时提供更多面向用户的更新。</p>
<p>最后，我们为 GPT‑5.1 引入了两个新工具：一个用于更可靠编辑代码的 apply_patch 工具，以及一个让模型运行 shell 命令的 shell 工具。</p>
<p>GPT‑5.1 是 GPT‑5 系列的下一个进步，我们计划继续投资更智能、更强大的模型，以帮助开发者构建可靠的代理工作流程。</p>
<hr/>
<h2 data-id="heading-0">跨任务的高效推理</h2>
<h3 data-id="heading-1">自适应推理</h3>
<p>为了使 GPT‑5.1 更快，我们彻底改革了训练其思考的方式。在直接明了的任务中，GPT‑5.1 使用更少的 token 进行思考，实现更快捷的产品体验和更低的 token 费用。在需要额外思考的困难任务中，GPT‑5.1 保持坚持，探索选项并检查其工作，以最大化可靠性。</p>
<p>Balyasny Asset Management 表示，GPT‑5.1"在我们完整的动态评估套件中超越了 GPT‑4.1 和 GPT‑5，同时运行速度比 GPT‑5 快 2-3 倍"。他们还说，在他们工具繁重的推理任务中，GPT‑5.1"始终使用大约领先竞争对手一半的 token，同时达到相似或更好的质量"。同样，AI 保险 BPO Pace 也测试了该模型并表示他们的代理在 GPT‑5.1 上运行"速度快 50%，同时在我们的评估中超越了 GPT‑5 和其他领先模型的准确性"。</p>
<p>与 GPT‑5 相比，GPT‑5.1 更动态地调整其思考时间。在 ChatGPT 任务的代表性分布中，GPT‑5.1 在更容易的任务上快得多，即使在高的推理努力下也是如此。</p>
<p>例如，当被要求"显示列出全局安装包的 npm 命令"时，GPT‑5.1 在 2 秒内回答，而不是 10 秒。</p>
<p><strong>GPT-5 (Medium) 耗时 ~250 tokens (~10 秒)</strong></p>
<pre><code class="hljs language-css" lang="css">show an npm command <span class="hljs-selector-tag">to</span> list globally installed packages
npm list -g <span class="hljs-attr">--depth</span>=<span class="hljs-number">0</span>
</code></pre>
<p><strong>GPT-5.1 (Medium) 耗时 ~50 tokens (~2 秒)</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> an npm command <span class="hljs-keyword">to</span> list globally installed packages
You can list globally installed npm packages <span class="hljs-keyword">with</span>:
<span class="hljs-operator">-</span> Just package names: npm ls <span class="hljs-operator">-</span>g <span class="hljs-comment">--depth=0</span>
<span class="hljs-operator">-</span> Including their install paths: npm ls <span class="hljs-operator">-</span>g
The <span class="hljs-keyword">first</span> <span class="hljs-keyword">one</span> <span class="hljs-keyword">is</span> usually what you want.
</code></pre>
<h3 data-id="heading-2">新的"无推理"模式</h3>
<p>开发者现在可以通过将 reasoning_effort 设置为 'none' 来使用不带推理的 GPT‑5.1。这使得模型在延迟敏感的用例中表现为非推理模型，具有 GPT‑5.1 的高智能和高性能工具调用的额外优势。相对于具有'minimal'推理的 GPT‑5，具有无推理的 GPT‑5.1 在并行工具调用（本身提高了端到端任务完成速度）、编程任务、遵循指令和使用搜索工具方面表现更好——并在我们的 API 平台支持网络搜索。Sierra 分享说，GPT‑5.1 在"无推理"模式下的真实评估显示"与 GPT‑5 最小推理相比，低延迟工具调用性能提高了 20%"。</p>
<p>随着在 reasoning_effort 中引入 'none' 作为值，开发者现在对速度、成本和智能之间的平衡有了更大的灵活性和控制权。GPT‑5.1 默认为 'none'，这对于延迟敏感的工作负载是理想的。我们建议开发者为更复杂的任务选择 'low' 或 'medium'，在智能和可靠性比速度更重要时选择 'high'。</p>
<h3 data-id="heading-3">扩展的提示缓存</h3>
<p>扩展缓存通过允许提示在缓存中保持活跃长达 24 小时（而不是目前支持的几分钟）来提高推理效率。通过更长的保留窗口，更多的后续请求可以利用缓存上下文——从而降低延迟、减少成本，并为多轮对话、编程会话或知识检索工作流程等长时间运行的交互提供更流畅的性能。</p>
<p>提示缓存定价保持不变，缓存的输入 token 比未缓存的 token 便宜 90%，并且缓存写入或存储不收取额外费用。要在 GPT‑5.1 中使用扩展缓存，请在 Responses 或 Chat Completions API 上添加参数"prompt_cache_retention='24h'"。有关更多详细信息，请参阅提示缓存文档。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"prompt_cache_retention='24h'"</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">编程</h2>
<p>GPT‑5.1 在 GPT‑5 的编程能力基础上，具有更可控的编程特性、更少的过度思考、改进的代码质量、在工具调用序列期间更好的面向用户的更新消息（前言），以及更实用的前端设计——特别是在低推理努力下。</p>
<p>在简单的编程任务（如快速代码编辑）中，GPT‑5.1 的更快速度使来回迭代更容易。GPT‑5.1 在简单任务上的更快速度不会降低在困难任务上的性能。在 SWE-bench Verified 上，GPT‑5.1 的工作时间甚至比 GPT‑5 更长，达到 76.3%。</p>
<p>在 SWE-bench Verified 中，模型被给予一个代码仓库和问题描述，必须生成一个补丁来解决问题。标签表示推理努力。准确性在所有 500 个问题上平均。所有模型都使用了带有基于 JSON 的 apply_patch 工具的集成。</p>
<p>我们从一些编程公司那里获得了关于 GPT‑5.1 的早期反馈。以下是他们的印象：</p>
<ul>
<li><strong>Augment Code</strong> 称 GPT‑5.1"更加慎重，浪费的行动更少，推理更高效，任务专注度更好"，他们看到"更准确的变更、更平滑的 pull requests 以及跨多文件项目的更快迭代"。</li>
<li><strong>Cline</strong> 分享说，在他们的评估中，"GPT‑5.1 在我们的差异编辑基准上达到了 SOTA，提高了 7%，展示了在复杂编程任务中卓越的可靠性"。</li>
<li><strong>CodeRabbit</strong> 称 GPT‑5.1 是他们"PR 审阅的首选顶级模型"。</li>
<li><strong>Cognition</strong> 表示 GPT‑5.1"明显更善于理解你的要求并与你合作完成任务"。</li>
<li><strong>Factory</strong> 表示"GPT‑5.1 提供明显更快的响应，并根据任务调整其推理深度，减少过度思考并改善整体开发者体验"。</li>
<li><strong>Warp</strong> 正在将 GPT‑5.1 设为新用户的默认选择，表示它"建立在 GPT‑5 系列引入的令人印象深刻的智能增益基础上，同时是一个响应更快的模型"。</li>
</ul>
<blockquote>
<p>"GPT 5.1 不仅仅是另一个 LLM——它是真正具有代理性的，我测试过的最自然的自主模型。它像你一样写作，像你一样编程，毫不费力地遵循复杂指令，并在前端任务中表现出色，完美融入你现有的代码库。你可以在 Responses API 中真正释放它的全部潜力，我们很高兴在我们的 IDE 中提供它。"</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">GPT‑5.1 中的新工具</h2>
<p>我们为 GPT‑5.1 引入了两个新工具，以帮助开发者在 Responses API 中充分利用模型：一个自由的 apply_patch 工具，使代码编辑更可靠而无需 JSON 转义，以及一个 shell 工具，让模型编写命令在本地机器上运行。</p>
<h3 data-id="heading-6">Apply_patch 工具</h3>
<p>自由格式的 apply_patch 工具让 GPT‑5.1 使用结构化差异在代码库中创建、更新和删除文件。模型不是仅仅建议编辑，而是发出补丁操作，由应用程序应用并报告回，实现迭代、多步骤的代码编辑工作流程。</p>
<p>要在 Responses API 中使用 apply_patch 工具，请在 tools 数组中包含它，使用<code>"tools": [{"type": "apply_patch"}]</code>，并在输入中包含文件内容或给模型与文件系统交互的工具。模型将为创建、更新或删除文件生成 apply_patch_call 项目，其中包含你在文件系统上应用的差异。有关如何与 apply_patch 工具集成的更多信息，请查看我们的开发者文档。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"apply_patch"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<h3 data-id="heading-7">Shell 工具</h3>
<p>shell 工具允许模型通过受控的命令行界面与本地计算机交互。模型提出 shell 命令；开发者的集成执行它们并返回输出。这创建了一个简单的计划-执行循环，让模型可以检查系统、运行实用程序并收集数据，直到它们可以完成任务。</p>
<p>要在 Responses API 中使用 shell 工具，开发者可以在 tools 数组中包含它，使用<code>"tools": [{"type": "shell"}]</code>。API 将生成包含要执行的 shell 命令的"shell_call"项目。开发者在本地环境中执行命令，并在下一个 API 请求的"shell_call_output"项目中传回执行结果。在我们的开发者文档中了解更多信息。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"shell"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">定价和可用性</h2>
<p>GPT‑5.1 和 gpt-5.1-chat-latest 对 API 中所有付费层级的开发者可用。定价和速率限制与 GPT‑5 相同。我们还在 API 中发布了 gpt-5.1-codex 和 gpt-5.1-codex-mini。虽然 GPT‑5.1 在大多数编程任务上表现出色，但 gpt-5.1-codex 模型针对在 Codex 或类似 Codex 集成中的长时间运行、代理编程任务进行了优化。</p>
<p>开发者可以开始使用我们的 GPT‑5.1 开发者文档和模型提示指南进行构建。我们目前不打算在 API 中弃用 GPT‑5，如果我们决定这样做，将提前通知开发者。</p>
<hr/>
<h2 data-id="heading-9">下一步</h2>
<p>我们致力于迭代部署最强大、最可靠的模型用于真实的代理和编程工作——能够高效思考、快速迭代并处理复杂任务，同时让开发者保持流畅状态的模型。凭借自适应推理、更强的编程性能、更清晰的面向用户更新，以及像 apply_patch 和 shell 这样的新工具，GPT‑5.1 旨在帮助您以更少的摩擦进行构建。我们仍在继续大量投资于此：您可以期待在接下来的几周和几个月内出现更强大的代理和编程模型。</p>
<hr/>
<h2 data-id="heading-10">附录：模型评估</h2>























































<table><thead><tr><th>评估</th><th>GPT‑5.1 (high)</th><th>GPT‑5 (high)</th></tr></thead><tbody><tr><td>SWE-bench Verified (全部 500 个问题)</td><td>76.3%</td><td>72.8%</td></tr><tr><td>GPQA Diamond (无工具)</td><td>88.1%</td><td>85.7%</td></tr><tr><td>AIME 2025 (无工具)</td><td>94.0%</td><td>94.6%</td></tr><tr><td>FrontierMath (使用 Python 工具)</td><td>26.7%</td><td>26.3%</td></tr><tr><td>MMMU</td><td>85.4%</td><td>84.2%</td></tr><tr><td>Tau2-bench Airline</td><td>67.0%</td><td>62.6%</td></tr><tr><td>Tau2-bench Telecom*</td><td>95.6%</td><td>96.7%</td></tr><tr><td>Tau2-bench Retail</td><td>77.9%</td><td>81.1%</td></tr><tr><td>BrowseComp Long Context 128k</td><td>90.0%</td><td>90.0%</td></tr></tbody></table>
<ul>
<li>对于 Tau2-bench Telecom，我们给 GPT‑5.1 一个简短的、通用有用的提示来提高其性能。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19新特性实战：5个提升开发效率的技巧与避坑指南]]></title>    <link>https://juejin.cn/post/7572126996177092643</link>    <guid>https://juejin.cn/post/7572126996177092643</guid>    <pubDate>2025-11-14T04:17:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572126996177092643" data-draft-id="7572099468247728163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19新特性实战：5个提升开发效率的技巧与避坑指南"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-14T04:17:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19新特性实战：5个提升开发效率的技巧与避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T04:17:18.000Z" title="Fri Nov 14 2025 04:17:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 19新特性实战：5个提升开发效率的技巧与避坑指南</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 19的发布标志着前端开发领域的又一次重大进步。作为React生态系统的核心维护者，Meta团队在这一版本中引入了多项旨在提升开发者体验和性能优化的新特性。对于资深开发者而言，深入理解这些特性的技术原理并掌握其最佳实践，能够显著提高开发效率并避免常见陷阱。</p>
<p>本文将聚焦React 19中最具实用价值的五个新特性，通过代码示例、性能对比和实际应用场景分析，帮助开发者快速掌握这些技术升级。我们将从编译器优化、状态管理改进、服务端组件增强等维度展开讨论，同时指出在迁移过程中可能遇到的兼容性问题及其解决方案。</p>
<h2 data-id="heading-2">一、React Compiler的实战应用</h2>
<h3 data-id="heading-3">1.1 编译时优化原理</h3>
<p>React 19最大的变革是引入了实验性的React Compiler，它通过静态分析和代码转换自动优化组件渲染逻辑。与传统运行时优化不同，编译器能够在构建阶段完成以下工作：</p>
<ul>
<li>自动推导组件纯度（pureness）</li>
<li>识别稳定的依赖关系</li>
<li>生成更高效的diff算法指令</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Before compilation</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">List</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {items.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.text}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// After compilation (伪代码)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">_compiled_List</span>(<span class="hljs-params">props, context</span>) {
  <span class="hljs-keyword">const</span> $ = <span class="hljs-title function_">useMemoCache</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> { items } = props;
  
  <span class="hljs-keyword">let</span> $0;
  <span class="hljs-keyword">if</span> ($[<span class="hljs-number">0</span>] !== items) {
    $0 = (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {items.map(item =&gt; React.createElement('li', 
          { key: item.id }, 
          item.text))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    );
    $[<span class="hljs-number">0</span>] = items;
    $[<span class="hljs-number">1</span>] = $0;
  } <span class="hljs-keyword">else</span> {
    $0 = $[<span class="hljs-number">1</span>];
  }
  
  <span class="hljs-keyword">return</span> $0;
}
</code></pre>
<h3 data-id="heading-4">1.2 性能提升实测</h3>
<p>在我们的基准测试中（基于10000个列表项渲染）：</p>
<ul>
<li><strong>首次渲染</strong>：提速约15%</li>
<li><strong>更新渲染</strong>：最高可达40%的性能提升</li>
<li><strong>内存占用</strong>：减少约20%</li>
</ul>
<h3 data-id="heading-5">1.3 Migration Guide注意事项</h3>
<p>迁移现有项目时需特别注意：</p>
<ol>
<li>Strict Mode下验证组件行为</li>
<li>useEffect依赖数组需要显式声明</li>
<li>Class组件需要手动添加<code>UNSAFE_</code>前缀的遗留方法</li>
</ol>
<h2 data-id="heading-6">二、Actions API的革命性改进</h2>
<h3 data-id="heading-7">2.1 Form Handling增强</h3>
<p>新的Actions API将表单处理提升到了框架级别：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">formData</span>) {
  <span class="hljs-string">'use server'</span>;
  
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/submit'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: formData,
});
<span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderForm</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{submitForm}</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"product"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Order<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
);
}
</code></pre>
<p>关键优势：</p>
<ul>
<li><strong>自动pending状态管理</strong></li>
<li><strong>乐观更新支持</strong></li>
<li><strong>错误处理标准化</strong></li>
</ul>
<h3 data-id="heading-8">2.2 Web Components集成方案</h3>
<p>通过与Custom Elements API的深度整合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
<span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">this</span>);
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span></span>);
}
}

customElements.<span class="hljs-title function_">define</span>(<span class="hljs-string">'my-counter'</span>, <span class="hljs-title class_">MyCounter</span>);

<span class="hljs-comment">// React组件内直接使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Web Component Integration<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">my-counter</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<p>##三、Server Components生产环境最佳实践</p>
<p>###3.1 Streaming SSR优化策略
React19改进了流式渲染的水合机制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">{ id }</span>) {
<span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">query</span>(<span class="hljs-string">`SELECT * FROM products WHERE id = <span class="hljs-subst">${id}</span>`</span>);
<span class="hljs-keyword">const</span> reviewsPromise = <span class="hljs-title function_">fetchReviews</span>(id);

<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Layout</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ProductDetails</span> <span class="hljs-attr">product</span>=<span class="hljs-string">{product}</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ReviewsSkeleton</span> /&gt;</span>}&gt;
<span class="hljs-tag">&lt;<span class="hljs-name">Reviews</span> <span class="hljs-attr">reviewsPromise</span>=<span class="hljs-string">{reviewsPromise}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Layout</span>&gt;</span></span>
);
}
</code></pre>
<p>性能关键点：</p>

























<table><thead><tr><th>Scenario</th><th>TTI (ms)</th><th>LCP (ms)</th></tr></thead><tbody><tr><td>CSR</td><td>~1200</td><td>~1500</td></tr><tr><td>SSR</td><td>~800</td><td>~900</td></tr><tr><td>Streaming SSR</td><td>~400</td><td>~500</td></tr></tbody></table>
<p>###3.2 Bundle Size优化技巧
使用Server Components后典型应用的bundle变化：</p>
<ul>
<li><strong>主包体积减少</strong>：平均38%</li>
<li><strong>首屏JS加载时间缩短</strong>：最高达52%</li>
<li><strong>水合成本降低</strong>：约60%</li>
</ul>
<p>##四、状态管理新模式use(Context)</p>
<p>###4.1 Context Selector模式
新增的<code>use(Context, selector)</code>API解决了传统Context的性能问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> [name, status] = <span class="hljs-title function_">use</span>(<span class="hljs-title class_">UserContext</span>, <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> [
ctx.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>,
ctx.<span class="hljs-property">user</span>.<span class="hljs-property">status</span>,
]);

<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name} - {status}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<p>与传统方案的对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Old way - causes unnecessary re-renders</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>); <span class="hljs-comment">// Any context change triggers update</span>
  
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name} - {user.status}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  
);
}
</code></pre>
<p>###4.2 Concurrent Context更新
在新架构下Context更新具有以下特点：</p>
<ul>
<li><strong>可中断渲染</strong></li>
<li><strong>优先级调度</strong></li>
<li><strong>批量更新合并</strong></li>
</ul>
<p>##五、资源加载与缓存策略</p>
<p>###5.1 Document Metadata管理
新增<code>&lt;DocumentHead&gt;</code>组件简化SEO管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">BlogPost</span>(<span class="hljs-params">{ post }</span>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DocumentHead</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{post.title}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{post.excerpt}</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"canonical"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{post.url}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">DocumentHead</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">__html:</span> <span class="hljs-attr">post.content</span> }} /&gt;</span></span>  
);
}
</code></pre>
<p>###5.2 Image和Script组件增强</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Image</span>, <span class="hljs-title class_">Script</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">HeroBanner</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">Image</span> 
<span class="hljs-attr">src</span>=<span class="hljs-string">"/hero.jpg"</span>
<span class="hljs-attr">priority</span> // <span class="hljs-attr">Preload</span> <span class="hljs-attr">hint</span>  
<span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span>
<span class="hljs-attr">fetchPriority</span>=<span class="hljs-string">"high"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Script</span> 
<span class="hljs-attr">src</span>=<span class="hljs-string">"/analytics.js"</span> 
<span class="hljs-attr">strategy</span>=<span class="hljs-string">"afterInteractive"</span>
<span class="hljs-attr">onLoad</span>=<span class="hljs-string">{()</span> =&gt;</span><span class="javascript"> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Loaded'</span>)}
/&gt;
&lt;/div&gt;</span></span>  
);
}
</code></pre>
<p>新型资源加载特性对比表：</p>

























<table><thead><tr><th>Feature</th><th>Benefit</th><th>Use Case</th></tr></thead><tbody><tr><td>Priority Hints</td><td>Critical resource prioritization</td><td>Above-the-fold images</td></tr><tr><td>Fetch Priority</td><td>Better bandwidth utilization</td><td>Lazy-loaded content</td></tr><tr><td>Loading Roots</td><td>Granular loading control</td><td>Complex page sections</td></tr></tbody></table>
<p>##总结与升级建议</p>
<p>React19带来的不仅是API层面的改进，更是开发生态范式的转变。经过我们的实际项目验证：</p>
<p>1.<strong>渐进式迁移路径</strong>推荐从Actions API开始逐步采用新特性<br/>
2.<strong>性能监控策略</strong>应在升级前后建立完整指标对比体系<br/>
3.<strong>团队培训重点</strong>应放在编译器原理和新数据流模型上</p>
<p>特别提醒注意即将废弃的API:</p>
<ul>
<li><code>componentWillMount</code>等生命周期最终移除</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：JWT、Cookie、Session、Token有什么区别？]]></title>    <link>https://juejin.cn/post/7572301616184180782</link>    <guid>https://juejin.cn/post/7572301616184180782</guid>    <pubDate>2025-11-14T04:27:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572301616184180782" data-draft-id="7572301616184148014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：JWT、Cookie、Session、Token有什么区别？"/> <meta itemprop="keywords" content="前端,面试,设计模式"/> <meta itemprop="datePublished" content="2025-11-14T04:27:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：JWT、Cookie、Session、Token有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T04:27:04.000Z" title="Fri Nov 14 2025 04:27:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JWT、Cookie、Session、Token 是 Web 开发中常用的身份认证和状态管理技术，它们之间既有区别，也有联系</p>
<h3 data-id="heading-0">一、JWT（JSON Web Token）</h3>
<p><strong>JWT</strong> 是一种开放标准（RFC 7519），用于在网络应用之间安全地传输信息（通常是身份认证信息）。它是一个<strong>自包含的、可验证的、不可篡改的</strong>字符串，格式如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.Payload</span><span class="hljs-selector-class">.Signature</span>
</code></pre>
<h4 data-id="heading-1">三部分组成：</h4>
<ol>
<li><strong>Header（头部）</strong>：声明类型和签名算法（如 HS256）。</li>
<li><strong>Payload（载荷）</strong>：包含用户信息（如用户 ID、角色等）和元数据（如过期时间）。</li>
<li><strong>Signature（签名）</strong>：用密钥对 Header 和 Payload 签名，防止篡改。</li>
</ol>
<h4 data-id="heading-2">特点：</h4>
<ul>
<li>无需服务器存储（无状态）。</li>
<li>可跨域使用（常用于分布式系统、微服务）。</li>
<li>一旦签发，在过期前无法撤销（除非引入黑名单机制）。</li>
</ul>
<h3 data-id="heading-3">二、Cookie</h3>
<p><strong>Cookie</strong> 是浏览器存储的一小段文本信息，由服务器通过 HTTP 响应头 <code>Set-Cookie</code> 设置，浏览器在后续请求中自动携带。</p>
<h4 data-id="heading-4">特点：</h4>
<ul>
<li>自动携带（浏览器行为）。</li>
<li>可设置过期时间、作用域、HttpOnly、Secure 等属性。</li>
<li>容量小（约 4KB）。</li>
<li>可用于存储 Session ID 或 JWT。</li>
</ul>
<h3 data-id="heading-5">三、Session（会话）</h3>
<p><strong>Session</strong> 是服务器端维护的用户会话状态。通常流程如下：</p>
<ol>
<li>用户登录后，服务器创建一个 Session，生成一个唯一的 <strong>Session ID</strong>。</li>
<li>Session ID 通过 Cookie 返回给浏览器。</li>
<li>浏览器后续请求自动携带该 Cookie，服务器通过 Session ID 查找对应的用户状态。</li>
</ol>
<h4 data-id="heading-6">特点：</h4>
<ul>
<li>状态存储在服务器端（通常是内存、Redis、数据库）。</li>
<li>安全性较高（用户无法直接篡改）。</li>
<li>不适合分布式系统（需要共享 Session 存储）。</li>
</ul>
<h3 data-id="heading-7">四、Token（令牌）</h3>
<p><strong>Token</strong> 是一个广义概念，指用于身份验证的凭证。JWT 就是一种 Token。</p>
<h4 data-id="heading-8">常见 Token 类型：</h4>
<ul>
<li><strong>Access Token</strong>（访问令牌）：用于访问资源。</li>
<li><strong>Refresh Token</strong>（刷新令牌）：用于获取新的 Access Token。</li>
<li><strong>JWT</strong>：一种结构化的 Token。</li>
</ul>
<h3 data-id="heading-9">五、它们之间的关系与区别</h3>








































<table><thead><tr><th>名称</th><th>存储位置</th><th>状态管理</th><th>安全性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>JWT</strong></td><td>客户端</td><td>无状态</td><td>中</td><td>分布式系统、移动端、API 认证</td></tr><tr><td><strong>Cookie</strong></td><td>客户端</td><td>无状态</td><td>低</td><td>存储小量数据、自动携带</td></tr><tr><td><strong>Session</strong></td><td>服务器端</td><td>有状态</td><td>高</td><td>传统 Web 应用</td></tr><tr><td><strong>Token</strong></td><td>客户端</td><td>无状态</td><td>中</td><td>通用身份凭证（JWT 是其一）</td></tr></tbody></table>
<h3 data-id="heading-10">六、常见组合方式</h3>
<h4 data-id="heading-11">方式一：Session + Cookie（传统 Web）</h4>
<ul>
<li>登录后服务器创建 Session，Session ID 存 Cookie。</li>
<li>每次请求带 Cookie，服务器查 Session 验证身份。</li>
</ul>
<h4 data-id="heading-12">方式二：JWT + Header（前后端分离）</h4>
<ul>
<li>登录后服务器返回 JWT，前端存 localStorage 或 Cookie。</li>
<li>每次请求手动在 Header 中加 <code>Authorization: Bearer &lt;JWT&gt;</code>。</li>
</ul>
<h4 data-id="heading-13">方式三：JWT + Cookie（安全增强）</h4>
<ul>
<li>JWT 存 Cookie，设置 HttpOnly + Secure，防止 XSS。</li>
<li>浏览器自动携带，服务器解析 JWT 验证身份。</li>
</ul>
<h3 data-id="heading-14">七、总结</h3>
<ul>
<li><strong>JWT</strong> 是一种<strong>自包含的 Token</strong>，<strong>不依赖服务器存储</strong>。</li>
<li><strong>Cookie</strong> 是<strong>浏览器存储机制</strong>，可存 Session ID 或 JWT。</li>
<li><strong>Session</strong> 是<strong>服务器存储的用户状态</strong>，依赖 Cookie 传递 ID。</li>
<li><strong>Token</strong> 是<strong>身份凭证</strong>，JWT 是其中一种实现。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Databend SQL nom Parser 性能优化]]></title>    <link>https://juejin.cn/post/7572099468247629859</link>    <guid>https://juejin.cn/post/7572099468247629859</guid>    <pubDate>2025-11-14T03:46:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572099468247629859" data-draft-id="7571068689765859368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Databend SQL nom Parser 性能优化"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-14T03:46:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Databend"/> <meta itemprop="url" content="https://juejin.cn/user/4477651847485534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Databend SQL nom Parser 性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4477651847485534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Databend
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:46:19.000Z" title="Fri Nov 14 2025 03:46:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">nom 简介</h2>
<p>nom 是 Rust 生态中非常受欢迎的解析框架：性能优秀、组合灵活，并且能很好地利用 Rust 的类型系统。Databend 在 SQL 表达式和语句解析上大量使用 nom，开发体验不错，可读性也高。</p>
<p>不过，组合式 parser 容易在不经意间埋下性能隐患——尤其是当多个分支结构相似、再加上递归嵌套时，回溯成本会指数级膨胀。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">/// 一个简单的 parser：匹配 "foo" 或 "bar"</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo_or_bar</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> IResult&lt;&amp;<span class="hljs-type">str</span>, &amp;<span class="hljs-type">str</span>&gt; {
    <span class="hljs-title function_ invoke__">alt</span>((
        <span class="hljs-title function_ invoke__">tag</span>(<span class="hljs-string">"foo"</span>),
        <span class="hljs-title function_ invoke__">tag</span>(<span class="hljs-string">"bar"</span>),
    ))(input)
}
</code></pre>
<h2 data-id="heading-1">问题案例：function 嵌套拖慢解析</h2>
<p>一次用户反馈里，我们收到了一条解析 20 分钟都跑不完的 SQL。火焰图清楚地显示：函数解析反复尝试、层层回溯。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed580c8a64b84c06a6ad4a11637f19a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGF0YWJlbmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763696779&amp;x-signature=541M4V9NRlqAMOyVElSPlTWFdvw%3D" alt="1280X1280.JPEG" loading="lazy"/></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">select</span> json_object_insert(
           json_object_insert(
                   json_object_insert(
                           json_object_insert(
                                   json_object_insert(
                                           <span class="hljs-string">'{}'</span>::variant,
                                           <span class="hljs-string">'email_address'</span>, <span class="hljs-string">'gokul'</span>, <span class="hljs-literal">true</span>,
                                           <span class="hljs-string">'home_phone'</span>, <span class="hljs-number">12345</span>, <span class="hljs-literal">true</span>,
                                           <span class="hljs-string">'mobile_phone'</span>, <span class="hljs-number">345678</span>, <span class="hljs-literal">true</span>,
                                           <span class="hljs-string">'race_code'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-literal">true</span>
                                   ),
                                   <span class="hljs-string">'race_desc'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-literal">true</span>,
                                   <span class="hljs-string">'marital_status_code'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-literal">true</span>,
                                   <span class="hljs-string">'marital_status_desc'</span>, <span class="hljs-string">'yu'</span>, <span class="hljs-literal">true</span>,
                                   <span class="hljs-string">'prefix'</span>, <span class="hljs-string">'hj'</span>, <span class="hljs-literal">true</span>
                           ),
                           <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'g'</span>, <span class="hljs-literal">true</span>,
                           <span class="hljs-string">'last_name'</span>, <span class="hljs-string">'p'</span>, <span class="hljs-literal">true</span>,
                           <span class="hljs-string">'deceased_date'</span>, <span class="hljs-string">'2085-05-07'</span>, <span class="hljs-literal">true</span>,
                           <span class="hljs-string">'birth_date'</span>, <span class="hljs-string">'6789'</span>, <span class="hljs-literal">true</span>
                   ),
                   <span class="hljs-string">'middle_name'</span>, <span class="hljs-string">'89'</span>, <span class="hljs-literal">true</span>,
                   <span class="hljs-string">'middle_initial'</span>, <span class="hljs-string">'0789'</span>, <span class="hljs-literal">true</span>,
                   <span class="hljs-string">'gender_code'</span>, <span class="hljs-string">'56789'</span>, <span class="hljs-literal">true</span>,
                   <span class="hljs-string">'gender_desc'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-literal">true</span>
           ),
           <span class="hljs-string">'home_phone_line_type'</span>, <span class="hljs-string">'uyt'</span>, <span class="hljs-literal">true</span>,
           <span class="hljs-string">'mobile_phone_line_type'</span>, <span class="hljs-number">4</span>, <span class="hljs-literal">true</span>
   );
</code></pre>
<p>当时的函数解析写法大致如下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call</span> = <span class="hljs-title function_ invoke__">map</span>(
    rule! {
        #function_name
        ~ <span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">comma_separated_list0</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>
    },
    |(name, _, opt_distinct, opt_args, _)| ExprElement::FunctionCall { .. },
);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call_with_lambda</span> = <span class="hljs-title function_ invoke__">map</span>(
    rule! {
        #function_name
        ~ <span class="hljs-string">"("</span> ~ #<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>) ~ <span class="hljs-string">","</span> ~ #lambda_params ~ <span class="hljs-string">"-&gt;"</span> ~ #<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>) ~ <span class="hljs-string">")"</span>
    },
    |(name, _, arg, _, params, _, expr, _)| ExprElement::FunctionCall { .. },
);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call_with_window</span> = <span class="hljs-title function_ invoke__">map</span>(
    rule! {
        #function_name
        ~ <span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">comma_separated_list0</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>
        ~ #window_function
    },
    |(name, _, opt_distinct, opt_args, _, window)| ExprElement::FunctionCall { .. },
);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call_with_within_group_window</span> = <span class="hljs-title function_ invoke__">map</span>(
    rule! {
        #function_name
        ~ <span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">comma_separated_list0</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>
        ~ #within_group
        ~ #window_function?
    },
    |(name, _, opt_distinct, opt_args, _, order_by, window)| ExprElement::FunctionCall { .. },
);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call_with_params_window</span> = <span class="hljs-title function_ invoke__">map</span>(
    rule! {
        #function_name
        ~ <span class="hljs-string">"("</span> ~ #<span class="hljs-title function_ invoke__">comma_separated_list1</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>)) ~ <span class="hljs-string">")"</span>
        ~ <span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">comma_separated_list0</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>
        ~ #window_function?
    },
    |(name, _, params, _, _, opt_distinct, opt_args, _, window)| ExprElement::FunctionCall { .. },
);

rule! {
    #function_call_with_lambda : <span class="hljs-string">"`function(..., x -&gt; ...)`"</span>
    | #function_call_with_window : <span class="hljs-string">"`function(...) OVER ([ PARTITION BY &lt;expr&gt;, ... ] [ ORDER BY &lt;expr&gt;, ... ] [ &lt;window frame&gt; ])`"</span>
    | #function_call_with_within_group_window: <span class="hljs-string">"`function(...) [ WITHIN GROUP ( ORDER BY &lt;expr&gt;, ... ) ] OVER ([ PARTITION BY &lt;expr&gt;, ... ] [ ORDER BY &lt;expr&gt;, ... ] [ &lt;window frame&gt; ])`"</span>
    | #function_call_with_params_window : <span class="hljs-string">"`function(...)(...) OVER ([ PARTITION BY &lt;expr&gt;, ... ] [ ORDER BY &lt;expr&gt;, ... ] [ &lt;window frame&gt; ])`"</span>
    | #function_call : <span class="hljs-string">"`function(...)`"</span>
}
</code></pre>
<p>这段代码对阅读者非常友好，但也有两个特征：</p>
<ul>
<li>所有分支都以 <code>function(...)</code> 起手；</li>
<li>深度优先的 <code>alt</code> 每次匹配失败都会回溯到下一个分支。</li>
</ul>
<p>在上面这种五层嵌套、每层模式数量为 5 的场景里，最常见的 “纯函数调用” 分支放在最后，实际要尝试 <code>5^5 = 3125</code> 次才能命中。复杂度飙升到 <code>O(m^n)</code>，性能立刻崩掉。</p>
<h2 data-id="heading-2">优化方案一：折叠相似分支，避免指数级回溯</h2>
<p>问题根源是“结构高度相似 + 递归 + 深度优先回溯”。我们把多个分支折叠成一次解析，再根据匹配到的后缀来决定具体的函数类型，相当于把流程变成了“先整体匹配，再分类处理”的广度优先思路：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">function_call_body</span> = <span class="hljs-title function_ invoke__">map_res</span>(
    rule! {
        <span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>)? ~ <span class="hljs-string">","</span>? ~ (#lambda_params ~ <span class="hljs-string">"-&gt;"</span> ~ #<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ #<span class="hljs-title function_ invoke__">comma_separated_list1</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>
        ~ (<span class="hljs-string">"("</span> ~ DISTINCT? ~ #<span class="hljs-title function_ invoke__">comma_separated_list0</span>(<span class="hljs-title function_ invoke__">subexpr</span>(<span class="hljs-number">0</span>))? ~ <span class="hljs-string">")"</span>)?
        ~ #within_group?
        ~ #window_function?
    },
    |(
        _,
        opt_distinct_0,
        first_param,
        _,
        opt_lambda,
        params_0,
        _,
        params_1,
        order_by,
        window,
    )| {
        <span class="hljs-title function_ invoke__">match</span> (
            first_param,
            opt_lambda,
            opt_distinct_0,
            params_0,
            params_1,
            order_by,
            window,
        ) {
            (
                <span class="hljs-title function_ invoke__">Some</span>(first_param),
                <span class="hljs-title function_ invoke__">Some</span>((lambda_params, _, arg_1)),
                <span class="hljs-literal">None</span>,
                <span class="hljs-literal">None</span>,
                <span class="hljs-literal">None</span>,
                <span class="hljs-literal">None</span>,
                <span class="hljs-literal">None</span>,
            ) =&gt; <span class="hljs-title function_ invoke__">Ok</span>(FunctionCallSuffix::Lambda { .. }),
            (
                <span class="hljs-title function_ invoke__">Some</span>(first_param),
                <span class="hljs-literal">None</span>,
                <span class="hljs-literal">None</span>,
                params_0,
                <span class="hljs-title function_ invoke__">Some</span>((_, opt_distinct_1, params_1, _)),
                <span class="hljs-literal">None</span>,
                window,
            ) =&gt; <span class="hljs-title function_ invoke__">Ok</span>(FunctionCallSuffix::ParamsWindow { .. }),
            (first_param, <span class="hljs-literal">None</span>, opt_distinct, params, <span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">Some</span>(order_by), window) =&gt; {
                <span class="hljs-title function_ invoke__">Ok</span>(FunctionCallSuffix::WithInGroupWindow { .. })
            }
            (first_param, <span class="hljs-literal">None</span>, opt_distinct, params, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">Some</span>(window)) =&gt; {
                <span class="hljs-title function_ invoke__">Ok</span>(FunctionCallSuffix::Window { .. })
            }
            (first_param, <span class="hljs-literal">None</span>, opt_distinct, params, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>) =&gt; {
                <span class="hljs-title function_ invoke__">Ok</span>(FunctionCallSuffix::Simple { .. })
            }
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(nom::Err::<span class="hljs-title function_ invoke__">Error</span>(ErrorKind::<span class="hljs-title function_ invoke__">Other</span>(
                <span class="hljs-string">"Unsupported function format"</span>,
            ))),
        }
    },
);
</code></pre>
<p>一次解析完成所有结构匹配，再根据分支类型装配结果，直接消除了指数级回溯。该优化落地后，原先需要几十分钟的 SQL 如今只要几十毫秒。</p>
<h2 data-id="heading-3">优化方案二：高频 Token 解析直接 hard code</h2>
<p>function 回溯问题解决后，我们又在表达式解析上抓到了第二个热点：<code>Binary/Unary/Json Operator</code> 等简单 token 被频繁命中，而原先的实现是 <code>alt + value + rule!</code> 的组合。这个组合每次调用都要：</p>
<ul>
<li>构造闭包；</li>
<li>包装错误信息；</li>
<li>构建返回值；</li>
<li>再进入下一层 parser。</li>
</ul>
<p>对于几乎只包含单个 token 的场景，直接手写匹配会快得多。Databend 的 <code>expr</code> 有 49 个分支，热度非常高，把这些分支 hard code 掉收益极可观。以下是 <code>json_op</code> 替换前后的实现：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 原实现：alt + rule!</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">json_op</span>(i: Input) <span class="hljs-punctuation">-&gt;</span> IResult&lt;JsonOperator&gt; {
    <span class="hljs-title function_ invoke__">alt</span>((
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::Arrow, rule! { <span class="hljs-string">"-&gt;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::LongArrow, rule! { <span class="hljs-string">"-&gt;&gt;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::HashArrow, rule! { <span class="hljs-string">"#&gt;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::HashLongArrow, rule! { <span class="hljs-string">"#&gt;&gt;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::Question, rule! { <span class="hljs-string">"?"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::QuestionOr, rule! { <span class="hljs-string">"?|"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::QuestionAnd, rule! { <span class="hljs-string">"?&amp;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::AtArrow, rule! { <span class="hljs-string">"@&gt;"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::ArrowAt, rule! { <span class="hljs-string">"&lt;@"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::AtQuestion, rule! { <span class="hljs-string">"@?"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::AtAt, rule! { <span class="hljs-string">"@@"</span> }),
        <span class="hljs-title function_ invoke__">value</span>(JsonOperator::HashMinus, rule! { <span class="hljs-string">"#-"</span> }),
    ))(i)
}

<span class="hljs-comment">// 新实现：hard code</span>
<span class="hljs-built_in">macro_rules!</span> op_branch {
    ($i:ident, $token_0:ident, $($kind:ident =&gt; $op:expr),+ $(,)?) =&gt; {
        <span class="hljs-keyword">match</span> $token_0.kind {
            $(
                TokenKind::$kind =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">return_op</span>($i, <span class="hljs-number">1</span>, $op),
            )+
            _ =&gt; (),
        }
    };
}

<span class="hljs-title function_ invoke__">pub</span>(<span class="hljs-keyword">crate</span>) <span class="hljs-keyword">fn</span> <span class="hljs-title function_">json_op_simple</span>(i: Input) <span class="hljs-punctuation">-&gt;</span> IResult&lt;JsonOperator&gt; {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(token_0) = i.tokens.<span class="hljs-title function_ invoke__">first</span>() {
        op_branch!(
            i, token_0,
            RArrow =&gt; JsonOperator::Arrow,
            LongRArrow =&gt; JsonOperator::LongArrow,
            HashRArrow =&gt; JsonOperator::HashArrow,
            HashLongRArrow =&gt; JsonOperator::HashLongArrow,
            Placeholder =&gt; JsonOperator::Question,
            QuestionOr =&gt; JsonOperator::QuestionOr,
            QuestionAnd =&gt; JsonOperator::QuestionAnd,
            AtArrow =&gt; JsonOperator::AtArrow,
            ArrowAt =&gt; JsonOperator::ArrowAt,
            AtQuestion =&gt; JsonOperator::AtQuestion,
            AtAt =&gt; JsonOperator::AtAt,
            HashMinus =&gt; JsonOperator::HashMinus,
        );
    }
    <span class="hljs-title function_ invoke__">Err</span>(nom::Err::<span class="hljs-title function_ invoke__">Error</span>(Error::<span class="hljs-title function_ invoke__">from_error_kind</span>(
        i,
        ErrorKind::<span class="hljs-title function_ invoke__">Other</span>(<span class="hljs-string">"expecting `-&gt;`, '-&gt;&gt;', '#&gt;', '#&gt;&gt;', '?', '?|', '?&amp;', '@&gt;', '&lt;@', '@?', '@@', '#-', or more ..."</span>),
    )))
}

<span class="hljs-meta">#[inline]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">return_op</span>&lt;T&gt;(i: Input, start: <span class="hljs-type">usize</span>, op: T) <span class="hljs-punctuation">-&gt;</span> IResult&lt;T&gt; {
    <span class="hljs-title function_ invoke__">Ok</span>((i.<span class="hljs-title function_ invoke__">slice</span>(start..), op))
}
</code></pre>
<h3 data-id="heading-4">Benchmark</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">bench</span>                            <span class="hljs-string">fastest</span>       <span class="hljs-string">│</span> <span class="hljs-string">slowest</span>       <span class="hljs-string">│</span> <span class="hljs-string">median</span>        <span class="hljs-string">│</span> <span class="hljs-string">mean</span>          <span class="hljs-string">│</span> <span class="hljs-string">samples</span> <span class="hljs-string">│</span> <span class="hljs-string">iters</span>
<span class="hljs-string">╰─</span> <span class="hljs-string">dummy</span>                                       <span class="hljs-string">│</span>               <span class="hljs-string">│</span>               <span class="hljs-string">│</span>               <span class="hljs-string">│</span>         <span class="hljs-string">│</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">test_json_op_parse</span>         <span class="hljs-number">413.8</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">2.817</span> <span class="hljs-string">µs</span>      <span class="hljs-string">│</span> <span class="hljs-number">441.3</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">482.6</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">100</span>     <span class="hljs-string">│</span> <span class="hljs-number">100</span>
   <span class="hljs-string">╰─</span> <span class="hljs-string">test_json_op_parse_simple</span>  <span class="hljs-number">35.41</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">54.89</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">37.1</span> <span class="hljs-string">ns</span>       <span class="hljs-string">│</span> <span class="hljs-number">37.61</span> <span class="hljs-string">ns</span>      <span class="hljs-string">│</span> <span class="hljs-number">100</span>     <span class="hljs-string">│</span> <span class="hljs-number">6400</span>
</code></pre>
<p>hard code 版本能带来约 10 倍的收益。</p>
<h2 data-id="heading-5">ASM 分析：硬件视角的差异</h2>
<p>借助 <code>cargo asm -p databend-common-ast --lib databend_common_ast::parser::expr::json_op</code>，我们对比了两种实现的汇编：</p>








































<table><thead><tr><th align="left">对比点</th><th align="left">alt + value + rule!</th><th align="left">hard code</th></tr></thead><tbody><tr><td align="left">栈内存使用量</td><td align="left"><code>sub rsp, 288</code>，每次调用都要分配 288 字节</td><td align="left">几乎无显式栈分配</td></tr><tr><td align="left">初始化逻辑</td><td align="left">运行时逐项构造数组（字符串指针、长度、标志位）</td><td align="left">直接跳转静态表或编译期常量</td></tr><tr><td align="left">寄存器操作</td><td align="left">大量 <code>mov</code>、<code>lea</code>，说明在构建临时数据</td><td align="left">少量跳表与分支，路径短</td></tr><tr><td align="left">函数调用</td><td align="left">调 <code>&lt;Alt&gt;::choice</code>，参数来自刚构造的数组</td><td align="left">调同一函数，但参数是静态常量</td></tr><tr><td align="left">代码长度</td><td align="left">很长、展开明显</td><td align="left">精简，便于 CPU 预测/缓存</td></tr><tr><td align="left">性能结论</td><td align="left">每次解析都重复构造数据，吞吐量低</td><td align="left">纯分支判断，常量折叠，性能稳定</td></tr></tbody></table>
<details>
<summary>查看完整 hard code asm</summary>
<pre><code class="hljs language-asm" lang="asm">
.section .text.databend_common_ast::parser::expr::json_op,"ax",@progbits
        .globl  databend_common_ast::parser::expr::json_op
.type   databend_common_ast::parser::expr::json_op,@function
databend_common_ast::parser::expr::json_op:
        .cfi_startproc
        push r14
        .cfi_def_cfa_offset 16
        push rbx
        .cfi_def_cfa_offset 24
        sub rsp, 88
        .cfi_def_cfa_offset 112
        .cfi_offset rbx, -24
        .cfi_offset r14, -16
        mov rbx, rdi
        mov rax, qword ptr [rsi + 8]
        test rax, rax
        je .LBB5402_3
        mov rcx, qword ptr [rsi]
        movzx edx, word ptr [rcx + 24]
        add edx, -47
        cmp edx, 26
        ja .LBB5402_3
        lea rdi, [rip + .LJTI5402_0]
        movsxd rdx, dword ptr [rdi + 4*rdx]
        add rdx, rdi
        jmp rdx
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 0
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 10
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 2
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 5
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 11
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 1
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 6
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 8
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 3
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 4
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 9
        jmp .LBB5402_16
        dec rax
        add rcx, 32
        movzx edx, word ptr [rsi + 24]
        mov rsi, qword ptr [rsi + 16]
        mov qword ptr [rbx + 8], rcx
        mov qword ptr [rbx + 16], rax
        mov qword ptr [rbx + 24], rsi
        mov word ptr [rbx + 32], dx
        mov byte ptr [rbx + 40], 7
.LBB5402_16:
        mov qword ptr [rbx], 3
.LBB5402_17:
        mov rax, rbx
        add rsp, 88
        .cfi_def_cfa_offset 24
        pop rbx
        .cfi_def_cfa_offset 16
        pop r14
        .cfi_def_cfa_offset 8
        ret
</code></pre>
</details>
<details>
<summary>查看完整 alt + value + rule! asm</summary>
<pre><code class="hljs language-asm" lang="asm">
.section .text.databend_common_ast::parser::expr::json_op,"ax",@progbits
        .globl  databend_common_ast::parser::expr::json_op
.type   databend_common_ast::parser::expr::json_op,@function
databend_common_ast::parser::expr::json_op:
        .cfi_startproc
        push rbx
        .cfi_def_cfa_offset 16
        sub rsp, 288
        .cfi_def_cfa_offset 304
        .cfi_offset rbx, -16
        mov rdx, rsi
        mov rbx, rdi
        lea rax, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.465]
        mov rsi, rsp
        mov qword ptr [rsi], rax
        mov eax, 2
        mov qword ptr [rsi + 8], rax
        mov byte ptr [rsi + 16], 0
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.466]
        mov qword ptr [rsi + 24], rcx
        mov ecx, 3
        mov qword ptr [rsi + 32], rcx
        mov byte ptr [rsi + 40], 1
        lea rdi, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.467]
        mov qword ptr [rsi + 48], rdi
        mov qword ptr [rsi + 56], rax
        mov byte ptr [rsi + 64], 2
        lea rdi, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.468]
        mov qword ptr [rsi + 72], rdi
        mov qword ptr [rsi + 80], rcx
        mov byte ptr [rsi + 88], 3
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.469]
        mov qword ptr [rsi + 96], rcx
        mov qword ptr [rsi + 104], 1
        mov byte ptr [rsi + 112], 4
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.471]
        mov qword ptr [rsi + 120], rcx
        mov qword ptr [rsi + 128], rax
        mov byte ptr [rsi + 136], 5
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.472]
        mov qword ptr [rsi + 144], rcx
        mov qword ptr [rsi + 152], rax
        mov byte ptr [rsi + 160], 6
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.473]
        mov qword ptr [rsi + 168], rcx
        mov qword ptr [rsi + 176], rax
        mov byte ptr [rsi + 184], 7
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.474]
        mov qword ptr [rsi + 192], rcx
        mov qword ptr [rsi + 200], rax
        mov byte ptr [rsi + 208], 8
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.475]
        mov qword ptr [rsi + 216], rcx
        mov qword ptr [rsi + 224], rax
        mov byte ptr [rsi + 232], 9
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.476]
        mov qword ptr [rsi + 240], rcx
        mov qword ptr [rsi + 248], rax
        mov byte ptr [rsi + 256], 10
        lea rcx, [rip + .Lanon.ebe4306c54ac692c121f4b459a487d88.477]
        mov qword ptr [rsi + 264], rcx
        mov qword ptr [rsi + 272], rax
        mov byte ptr [rsi + 280], 11
        mov rdi, rbx
        call qword ptr [rip + &lt;(A,B,C,D,E,F,G,H,I,J,K,L) as nom::branch::Alt&gt;::choice@GOTPCREL]
        mov rax, rbx
        add rsp, 288
        .cfi_def_cfa_offset 16
        pop rbx
        .cfi_def_cfa_offset 8
        ret
</code></pre>
</details>
<h2 data-id="heading-6">经验总结</h2>
<ul>
<li>合并结构相似的 parser，避免深度优先 + 回溯导致的指数级爆炸。</li>
<li>高频、简单 token 的解析直接 hard code，省掉闭包、错误包装等额外成本。</li>
<li>及时查看火焰图，能发现异常深的解析栈。</li>
<li>必要时对热点路径做汇编级分析，更容易验证优化方向。</li>
</ul>
<p>这两项优化落地后，Databend 的函数调用解析从分钟级降到毫秒级，表达式解析也获得了量级上的性能提升。</p>
<h2 data-id="heading-7">关于 Databend</h2>
<p>Databend 是一款开源、弹性、低成本，基于对象存储也可以做实时分析的新式湖仓。期待您的关注，一起探索云原生数仓解决方案，打造新一代开源 Data Cloud。</p>
<p>👨‍💻‍ Databend Cloud：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdatabend.cn%2F" title="https://link.juejin.cn/?target=https%3A%2F%2Fdatabend.cn%2F" target="_blank">databend.cn</a></p>
<p>📖 Databend 文档：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.databend.cn%2F" title="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.databend.cn%2F" target="_blank">docs.databend.cn</a></p>
<p>💻 Wechat：Databend</p>
<p>✨ GitHub：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" target="_blank">github.com/databendlab…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[12 节课解锁 AI Agents，让AI替你打工（一）: 简介]]></title>    <link>https://juejin.cn/post/7572138663120306218</link>    <guid>https://juejin.cn/post/7572138663120306218</guid>    <pubDate>2025-11-14T03:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572138663120306218" data-draft-id="7572142436126834707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="12 节课解锁 AI Agents，让AI替你打工（一）: 简介"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-14T03:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            12 节课解锁 AI Agents，让AI替你打工（一）: 简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:54:15.000Z" title="Fri Nov 14 2025 03:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<blockquote>
<p>本系列教程主要是为了探索 AI Agent 的设计原理与真实世界应用</p>
</blockquote>
<p>随着大语言模型（LLMs）的出现，人工智能取得了巨大飞跃。这些强大的系统彻底改变了自然语言处理，但当它们与智能体（即自主推理、规划和行动的能力）相结合时，其真正潜力才得以释放。这就是大语言模型智能体发挥作用的地方，它代表了我们与人工智能交互和利用方式的范式转变。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7746fd95b3804b0597e00cf4404a6113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=FedLCaSwTe8ZzsumkFv4m1PH1fs%3D" alt="" loading="lazy"/></p>
<p>图片来源：letta</p>
<p>本文旨在全面概述 AI Agent，深入探讨其特征、组件和类型，同时探索其演进历程、挑战和未来发展方向。</p>
<p>让我们首先理解从 LLM 到 AI Agent 的演进过程。</p>
<h2 data-id="heading-0">1.从 LLM 到 AI Agent</h2>
<hr/>
<p>LLM应用形态的演进是现代应用发展最快的领域之一。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc3d368b850c40f591ca510b8456c831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=6sYe%2BJteZBP5Ze56GtbDNnLi5Dk%3D" alt="" loading="lazy"/></p>
<p>图片来源：mongodb</p>
<h3 data-id="heading-1">1.1 传统聊天机器人到 LLM 驱动聊天机器人</h3>
<p>聊天机器人并非新生事物，在生成式 AI（gen AI）概念出现前，你可能就与网站上的传统聊天机器人互动过。前 gen AI 时代的传统聊天机器人与当今 AI 驱动的对话 Agent 有本质区别：</p>
<p><strong>基于启发式的响应：</strong>   </p>
<ul>
<li>传统聊天机器人运行在规则逻辑（"if-then"语句）上</li>
<li>局限于预定义规则，无法处理复杂或模糊查询</li>
</ul>
<p><strong>固定回复模板：</strong>   </p>
<ul>
<li>响应是静态且预定义的</li>
<li>通过检测特定关键词或短语触发</li>
<li>缺乏灵活性和对话深度</li>
</ul>
<p><strong>人工转接机制：</strong>   </p>
<ul>
<li>始终包含"联系人工客服"按钮处理未解决问题</li>
<li>复杂问题仍需人工干预</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d5b99e19d6447e2b0dd721d2b4d023b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=m2X1vownaKuUYIEe7CT4CqrvkJ0%3D" alt="" loading="lazy"/></p>
<p>图片来源：mongodb</p>
<h3 data-id="heading-2"><strong>1.2 LLM 驱动聊天机器人的引入</strong></h3>
<p><strong>ChatGPT 的发布：</strong>  2022年11月30日，OpenAI 推出基于 GPT-3.5 的ChatGPT，作为首个主流 LLM 应用。ChatGPT 保留了熟悉的聊天界面，但背后是经过海量互联网语料训练的高级LLM技术。</p>
<p><strong>Transformer 架构：</strong>  GPT（生成式预训练 Transformer ）基于 Google 2017年提出的 Transformer 架构，使用自注意力机制分析输入序列，实现更深层次的上下文理解。</p>
<p><strong>LLM 的能力：</strong>  与传统聊天机器人不同，LLM 能生成类人的、上下文相关的新文本。应用场景包括代码生成、内容创作、增强客服等。</p>
<p><strong>局限性：</strong>   </p>
<ul>
<li><strong>个性化：难以在长对话中保持一致的个性化互动</strong></li>
<li><strong>幻觉：可能生成事实错误但逻辑通顺的响应，基于概率而非验证知识输出</strong></li>
</ul>
<p><strong>应对措施：</strong>   </p>
<ul>
<li>探索<strong>检索增强生成(RAG)</strong> 等技术将输出锚定在可靠外部数据</li>
<li>这些进步旨在减少错误并提升 LLM 系统的鲁棒性</li>
</ul>
<h3 data-id="heading-3">1.3 从 LLM 聊天机器人到 RAG 聊天机器人和AI Agent</h3>
<p><strong>RAG 聊天机器人：</strong>  检索增强生成（RAG）将外部数据检索与 LLM 能力结合，生成准确且上下文接地的响应。</p>
<p><strong>知识来源：</strong>   </p>
<ul>
<li><strong>非参数知识：从互联网或专有数据库获取的实时数据</strong></li>
<li><strong>参数知识：LLM 训练中内嵌的知识</strong></li>
</ul>
<p><strong>优势：</strong>  减少幻觉、提供最新信息、确保可验证响应</p>
<p><strong>提示工程：</strong>  上下文学习（单样本、少样本）、思维链（CoT）、ReAct 等技术通过引导 LLM 的推理和输出生成提升响应质量</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4302c7ef964e339ebec5c5cc7bc889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=g0b%2Bz5eO7KEHBU3vM%2ByF43QSqUE%3D" alt="" loading="lazy"/></p>
<p>图片来源：mongodb</p>
<p><strong>AI Agents：</strong>  从配备工具、多步规划和推理能力的 LLM 演进而来</p>
<p><strong>工具使用：</strong>  LLM 可通过分析任务并通过结构化模式（如 JSON）分配参数，调用程序化定义的函数或API</p>
<p><strong>环境：</strong>  AI Agents 在迭代执行环境中运行，支持基于反馈的动态决策和持续适应</p>
<p><strong>Agent 式系统：由自主 Agent 组成的计算架构，能够集成多个系统组件、做出决策并实现目标</strong></p>
<p><strong>Agent 式 RAG：</strong></p>
<ul>
<li>将 LLM 的推理、工具使用和规划能力与语义信息检索结合</li>
<li>支持分解任务、执行复杂查询和利用工具解决问题的动态系统</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9071f04c0a3341648ec2d987f4ddad2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=Wv%2BgZd9ImqlV7ynd5LJY5Vdqb3c%3D" alt="" loading="lazy"/></p>
<p>图片来源：mongodb</p>
<p>从 LLM 聊天机器人到 RAG 聊天机器人和 AI Agent的转变，标志着向更智能、自适应和工具集成的系统演进，能够实时解决复杂问题。</p>
<h2 data-id="heading-4">2.  什么是 AI Agent？</h2>
<hr/>
<p><strong>AI Agent</strong> 是通过传感器感知环境、处理信息，并通过执行器作用于环境以实现特定目标的系统。可以将其视为能够观察、思考和行动的数字化实体（类似人类与环境的互动方式，但以编程和有目的的方式实现）。</p>
<p>AI Agent 的概念建立在理性行为的基本理念上： Agent 应采取能最大化实现既定目标可能性的行动。这种理性将 AI Agent 与简单响应程序区分开来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b2d51a9bc324aa6978902f7a2e85777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=y5T1LYo4st%2FqQI0yCSVAsScfy7w%3D" alt="" loading="lazy"/></p>
<p>图片来源：Abhishek Reddy</p>
<h3 data-id="heading-5">2.1 AI Agent 的特征</h3>
<p>AI Agent具备以下关键特征：</p>
<ol>
<li><strong>自主性：无需人工干预独立决策</strong></li>
<li><strong>反应与主动行为：响应环境变化并采取主动措施实现目标</strong></li>
<li><strong>适应性：通过处理新信息和经验学习进化</strong></li>
<li><strong>目标导向：致力于实现预定义目标或优化结果</strong></li>
<li><strong>交互性：与其他 Agent 或人类沟通协作</strong></li>
<li><strong>持续性：持续运行，监控和响应动态环境</strong></li>
<li>AI Agent 的核心组件</li>
</ol>
<hr/>
<p>AI Agent 的核心由以下组件构成：</p>
<p><strong>1. 感知(Preception)</strong></p>
<p><strong>2. 推理(Reasoning)</strong></p>
<p><strong>3. 行动(Action)</strong></p>
<p><strong>4. 知识库(Knowledge Base)</strong></p>
<p><strong>5. 学习(Learning)</strong></p>
<p><strong>6. 通信接口(Communication Interface)</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7ac512c839f4131bab95feab4d7a50d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=WLzJVwUV8cu0bFTX%2FS9P1PTT2dM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.1 感知（传感器）</h3>
<p>使 Agent 能感知环境。可以是物理传感器（摄像头、麦克风）或数字输入（数据流、用户交互）。</p>
<h3 data-id="heading-7">3.2 推理（处理器）</h3>
<p>Agent 的"大脑"，处理传感器信息并确定适当行动。该组件实现 Agent的决策算法并维护必要内部状态。</p>
<p>AI Agent 使用各种决策机制，如基于规则的系统、专家系统和神经网络，以做出明智选择并有效执行任务。</p>
<h3 data-id="heading-8">3.3 行动（执行器）</h3>
<p>Agent 影响环境的手段。可以是物理的（机械臂、扬声器）或数字的（数据库更新、显示输出）。</p>
<h3 data-id="heading-9">3.4 知识库</h3>
<p>Agent 用于决策的信息存储库，包括预编程知识和学习获得的信息。</p>
<h3 data-id="heading-10">3.5 学习</h3>
<p>使 Agent 能通过数据和经验学习随时间提升性能。使用强化学习、监督学习和无监督学习等技术持续改进 AI Agent 表现。</p>
<h3 data-id="heading-11">3.6 通信接口</h3>
<p>允许 Agent 与其他 Agent、系统或人类交互。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d8b5534897743b1aa5792330e541f0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=5vhTpWlApGZEOMan9gXmTD2nyS0%3D" alt="" loading="lazy"/>Agent in Large Environment | 图片来源：Tim Cvetko</p>
<p>下文将详细说明 Agent 工作原理时逐一解析各组件。</p>
<h2 data-id="heading-12">4.  <strong>AI Agent 如何与环境交互</strong></h2>
<hr/>
<p>交互周期通常称为<code>"感知-规划-行动"</code>循环或<code>"感知-行动"</code>循环。以自动驾驶汽车为例解析各阶段：</p>
<h3 data-id="heading-13">4.1 感知阶段</h3>
<p>可视作 Agent 的"传感"阶段：</p>
<blockquote>
<p><strong>传感器 → 处理 → 状态更新</strong></p>
</blockquote>
<ul>
<li>Agent 通过传感器接收输入</li>
<li>信息被处理和解释</li>
<li>根据新信息更新当前状态</li>
</ul>
<h3 data-id="heading-14">4.2 决策阶段</h3>
<p>Agent的"思考"阶段：</p>
<blockquote>
<p><strong>当前状态 + 目标 → 评估选项 → 选择最佳行动</strong></p>
</blockquote>
<ul>
<li>评估可能行动</li>
<li>考虑目标和约束</li>
<li>根据可用信息选择最优行动</li>
</ul>
<h3 data-id="heading-15">4.3 行动阶段</h3>
<p>Agent 的"执行"阶段：</p>
<blockquote>
<p><strong>执行行动 → 观察变化 → 开始新循环</strong></p>
</blockquote>
<ul>
<li>通过执行器执行选定行动</li>
<li>环境因此发生变化</li>
<li>Agent 通过传感器观察结果，开始新循环</li>
</ul>
<p>该循环持续重复，通常每秒多次。其强大之处在于：</p>
<p><strong>1. 适应性：</strong>  若发生意外， Agent 能在下次感知阶段检测并调整行动</p>
<p><strong>2. 学习机会：</strong>  Agent 可比较预测结果与实际结果以改进未来决策</p>
<p><strong>3. 目标导向行为：</strong>  每个循环都推动 Agent 向目标迈进，同时遵守约束(螺旋式上升)</p>
<p>通过恒温器类比，编程层面比较三个复杂度级别：</p>
<ol start="0">
<li><strong>简单程序</strong></li>
</ol>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">1</span><span class="hljs-comment"># 简单程序</span>
<span class="hljs-string">​</span>
<span class="hljs-string">2if</span> <span class="hljs-string">temperature</span> <span class="hljs-string">&gt;</span> <span class="hljs-attr">desired_temperature:</span>
<span class="hljs-string">​</span>
<span class="hljs-number">3</span>    <span class="hljs-string">turn_on_cooling()</span>
</code></pre>
<ul>
<li>仅遵循固定规则</li>
<li>不考虑后果</li>
<li>无学习或适应</li>
</ul>
<p><strong>2. 响应式程序</strong>  </p>
<pre><code class="hljs language-ini" lang="ini">1<span class="hljs-comment"># 响应式程序</span>
​
2if temperature &gt; desired_temperature:
​
3    if <span class="hljs-attr">time_of_day</span> == <span class="hljs-string">"peak_hours"</span>:
​
4        turn_on_cooling_eco_mode()
​
5    else:
​
6        turn_on_cooling_normal()
</code></pre>
<ul>
<li>更复杂规则</li>
<li>一定上下文感知</li>
<li>仍无真正智能</li>
</ul>
<p><strong>3. AI Agent</strong>  </p>
<pre><code class="hljs language-ini" lang="ini">1class SmartThermostat:
​
2    def perceive(self):
​
3        <span class="hljs-attr">current_temp</span> = get_temperature()
​
4        <span class="hljs-attr">time</span> = get_time()
​
5        <span class="hljs-attr">electricity_price</span> = get_current_price()
​
6        <span class="hljs-attr">weather_forecast</span> = get_forecast()
​
7        <span class="hljs-attr">user_preferences</span> = get_preferences()
​
8        return Environment(current_temp, time, electricity_price,
​
9                         weather_forecast, user_preferences)
​
10
​
11    def think(self, environment):
​
12        <span class="hljs-attr">possible_actions</span> = [
​
<span class="hljs-number">13</span>            NoAction(),
​
<span class="hljs-number">14</span>            CoolNormal(),
​
<span class="hljs-number">15</span>            CoolEco(),
​
<span class="hljs-number">16</span>            PreCool(),
​
<span class="hljs-number">17</span>            WaitFor<span class="hljs-literal">Off</span>Peak()
​
<span class="hljs-number">18</span>        ]
​
19
​
20        <span class="hljs-comment"># 评估每个行动的预期结果</span>
​
21        <span class="hljs-attr">best_action</span> = None
​
22        <span class="hljs-attr">best_utility</span> = float(<span class="hljs-string">'-inf'</span>)
​
23
​
24        for action in possible_actions:
​
25            <span class="hljs-attr">predicted_state</span> = predict_future_state(environment, action)
​
26            <span class="hljs-attr">utility</span> = calculate_utility(predicted_state)
​
27
​
28            if utility &gt; best_utility:
​
29                <span class="hljs-attr">best_action</span> = action
​
30                <span class="hljs-attr">best_utility</span> = utility
​
31
​
32        return best_action
​
33
​
34    def act(self, action):
​
35        action.execute()
​
36        monitor_results()
​
37        update_learning_model()
</code></pre>
<ul>
<li>考虑多因素</li>
<li>预测结果</li>
<li>从经验中学习</li>
<li>优化长期目标</li>
<li>平衡竞争目标</li>
</ul>
<p>该循环适用于所有 AI Agent：</p>
<ul>
<li>聊天机器人感知文本输入，决定响应并生成文本</li>
<li>交易机器人感知市场数据，决定交易策略并下单</li>
<li>扫地机器人感知房间布局和灰尘，决定清洁路径并启动清洁机制</li>
</ul>
<h2 data-id="heading-16">5.  AI Agent 如何运作？</h2>
<hr/>
<p>假设你的智能冰箱不仅能在牛奶喝完时自动补货，还能根据你的浏览记录建议改用杏仁奶。这究竟是贴心服务还是令人不安？由你判断！</p>
<p>这正是 AI Agent 的典型应用。</p>
<p>AI Agent 能理解人类语言（借助 LLM）、推理信息、规划行动并自主执行任务。它们解决复杂问题，远超越简单自动化工具。与基础脚本不同，AI Agent 集成到软件系统中，实现与环境的复杂交互。</p>
<p><strong>AI Agent 与简单自动化的区别？</strong>   </p>
<p>区别源于两大核心能力：</p>
<ul>
<li>工具使用</li>
<li>规划能力</li>
</ul>
<p>你已见过 ChatGPT 在基础数学题上出错，因为它仅基于训练数据响应。同理，若要求你计算85乘65，作为人类，你可以直接作答（若已知答案）或使用<strong>计算器</strong>工具，对吗？</p>
<p>AI Agent 同理，赋予其<strong>工具</strong>访问权限。</p>
<p>第二要素是规划。</p>
<p>同一数学计算，只有知晓乘法或知道向计算器传递参数（85、65及乘法运算）才能解题。这正是<strong>规划</strong>与推理的作用。</p>
<p>以下是查询 AI Agent 时的流程：</p>
<h3 data-id="heading-17">5.1 编排层（控制中心）</h3>
<p>假设创建会议安排 AI Agent，查询："我想为所有学生举办网络研讨会"。</p>
<p>该查询将触发 AI Agent。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8286a76c0b4fefa4839c18b21c2e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=5kxmCmSqnh%2BL%2B2HwnI1h5wwTW7U%3D" alt="" loading="lazy"/></p>
<p>编排层 | 图片来源：Himanshu Ramchandani</p>
<p>查询可以是文本、音频、视频或图像。（已知无论数据类型如何，最终都会转换为机器可处理的数值）</p>
<p>查询由编排层（即 Agent 控制中心）处理。</p>
<p>编排层四大功能：</p>
<ul>
<li><strong>记忆：维护整个交互过程的记忆</strong></li>
<li><strong>状态：存储当前进程状态</strong></li>
<li><strong>推理：指导 Agent 的推理过程</strong></li>
<li><strong>规划：确定步骤及下一步行动</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/578356f29a5141e6b13edc4487d15c3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=Ft2ET2MQaRS4HHclkwbA9I26MjY%3D" alt="" loading="lazy"/>图片来源：lyzr</p>
<p>编排层将与模型（LLM）交互。</p>
<h3 data-id="heading-18">5.2 模型（大脑）</h3>
<p>模型是整个 Agent 的中央决策者，通常是大型语言模型等AI模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5fc1cd2446945b1aeec778a1fb35425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=YkvndWMYlr6o0P8mHIS8nQyPTBU%3D" alt="" loading="lazy"/></p>
<p>AI Agent中的模型 | 图片来源：Himanshu Ramchandani</p>
<p>为理解查询、制定计划和确定下一步行动，模型使用推理和逻辑框架如：</p>
<ul>
<li><strong>ReAct(Reasion+Act): （推理+行动）确保审慎行动</strong></li>
<li><strong>思维链: 通过中间步骤推理</strong></li>
<li><strong>思维树: 探索多路径寻找最优解</strong></li>
</ul>
<p>模型决定采取的行动，并通过特定<strong>工具</strong>执行。</p>
<h3 data-id="heading-19">5.3 工具（双手）</h3>
<p>通过工具， Agent 能与外部世界交互，如计算器、API、网络搜索、外部数据库等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37394080b57f4be6a976f9f1b54dbc31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=zb8BwM0PwqUujUR%2BZMrcCJQfpIc%3D" alt="" loading="lazy"/>图片来源：Himanshu Ramchandani</p>
<p>工具使 Agent 能执行超越模型能力的<strong>行动</strong>、获取实时信息或完成现实任务。</p>
<h2 data-id="heading-20">6.  ✅ 何时使用 Agent / ⛔ 何时避免使用</h2>
<hr/>
<p>当需要 LLM 决定应用工作流时， Agent 很有用。但通常存在过度使用。核心问题是：是否真需要工作流灵活性来高效解决当前任务？若预定义工作流频繁失效，则需更高灵活性。以冲浪旅行网站客服应用为例：</p>
<p>已知请求属于两个预定义类别（基于用户选择），且每个类别有预定义工作流：</p>
<ol start="0">
<li>需要旅行知识 ⇒ 提供知识库搜索栏</li>
<li>联系销售 ⇒ 填写联系表单</li>
</ol>
<p>若确定性工作流适配所有查询，直接编码即可！这将提供 100% 可靠系统，避免不可预测 LLM 介入导致错误。为简化和稳健性，建议规范化避免使用 Agent 行为。</p>
<p>但若工作流无法预先确定？</p>
<p>例如用户查询："我周一能来，但忘带护照可能延迟到周三，能否周二早上接我和装备冲浪，并提供取消保险？"该问题涉及多因素，上述预定义标准均不适用。</p>
<p>若预定义工作流频繁失效，则需更高灵活性。这正是 Agent 式设置的用武之地。</p>
<p>此例中，可构建多步 Agent，配备天气 API 获取预报、Google Maps API 计算行程、员工可用性看板和知识库 RAG 系统。</p>
<p>传统计算机程序受限于预定义工作流，通过堆叠 <code>if/else</code> 开关处理复杂性，专注于极窄任务（如"计算数字总和"或"寻找图最短路径"）。但现实任务（如上述旅行案例）往往不适用预定义工作流。 Agent 式系统为程序开启了现实任务处理的广阔天地！</p>
<h2 data-id="heading-21">7.  应用领域</h2>
<hr/>
<p>AI Agent 是多功能工具，提升各领域生产力、效率和智能化水平，正日益应用于日常应用和高影响领域。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6034cf72450d4ca887de8e4f0e56f224~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697255&amp;x-signature=bNU%2Fbp5YUtOofA1hUu6Q%2B8MKSyM%3D" alt="" loading="lazy"/></p>
<p>图片来源：lyzr</p>
<h2 data-id="heading-22">8.  结论</h2>
<hr/>
<p>AI Agent 正改变技术交互方式，提供前所未有的自主性、智能和适应性。从简单反射 Agent 到复杂学习系统，它们正被跨行业应用以解决复杂问题和增强人类能力。但构建有效 AI Agent 面临伦理关切、数据依赖和可扩展性等挑战。</p>
<p>随着 AI 技术持续演进，AI Agent 未来潜力巨大。通过关注通用 AI、人机协作和伦理考量，我们可创建不仅高效执行任务，且符合人类价值观并为社会积极贡献的 Agent。</p>
<ul>
<li>AI Agent 是能感知、决策和行动以实现目标的自主系统</li>
<li>核心组件包括传感器、执行器、决策引擎和学习模块</li>
<li>应用于虚拟助手、自动驾驶和医疗等领域</li>
</ul>
<p>通过理解基础原理并关注进展，我们能利用 AI Agent 推动创新，创造更美好未来。</p>
<h2 data-id="heading-23">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VisionWeaver：从“现象识别”到“病因诊断”，开启AI视觉幻觉研究新篇章]]></title>    <link>https://juejin.cn/post/7572157115907293234</link>    <guid>https://juejin.cn/post/7572157115907293234</guid>    <pubDate>2025-11-14T04:53:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572157115907293234" data-draft-id="7572164122235224074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VisionWeaver：从“现象识别”到“病因诊断”，开启AI视觉幻觉研究新篇章"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-14T04:53:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哔哩哔哩技术"/> <meta itemprop="url" content="https://juejin.cn/user/3030701626893405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VisionWeaver：从“现象识别”到“病因诊断”，开启AI视觉幻觉研究新篇章
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030701626893405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哔哩哔哩技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T04:53:13.000Z" title="Fri Nov 14 2025 04:53:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前言</strong></h2>
<p>长久以来，我们只知道大型视觉语言模型（LVLM）会犯错，但始终缺乏一把“手术刀”，无法剖析其视觉感知的根源性缺陷。我们只知其然，不知其所以然。我们希望当 AI 模型观察图像时，不再凭空想象，不再“指鹿为马”。</p>
<p>现在，这一瓶颈被打破了。bilibili 用户技术中心提出 <strong>VisionWeaver</strong> 及其核心诊断工具 <strong>VHBench-10</strong>，带来了创新性的视角。VisionWeaver 不再依赖单一编码器，而是开创性地提出“上下文感知路由网络”，动态协同多个“视觉专家” 。而这一切得以实现的基础，正是其专门打造的诊断基准 VHBench-10——它让幻觉研究从 <strong>“识别现象”迈向了“诊断病因”</strong> 的新阶段。此工作已被 EMNLP 2025 Findings 录用。</p>
<h2 data-id="heading-1"><strong>相关链接</strong></h2>
<ul>
<li>
<p>文章: <em><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2509.13836v1" target="_blank" title="https://arxiv.org/abs/2509.13836v1" ref="nofollow noopener noreferrer">arxiv.org/abs/2509.13…</a></em></p>
</li>
<li>
<p>代码：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwhwangovo%2FVisionWeaver" target="_blank" title="https://github.com/whwangovo/VisionWeaver" ref="nofollow noopener noreferrer">github.com/whwangovo/V…</a></em></p>
</li>
<li>
<p>数据集：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2Fwhwangovo%2FVHBench_10" target="_blank" title="https://huggingface.co/datasets/whwangovo/VHBench_10" ref="nofollow noopener noreferrer">huggingface.co/datasets/wh…</a></em></p>
</li>
</ul>
<h2 data-id="heading-2"><strong>论文介绍</strong></h2>
<p>大型视觉语言模型（LVLM）的“幻觉”问题是阻碍其应用的核心障碍。以往的评测方法（如POPE）虽然有价值，但普遍停留在<strong>粗粒度</strong>层面，大多只关注“图片中是否存在某个物体”这类简单判断。这就像医生只知道病人发烧，却无法定位具体的病灶。这种“只知其然”的评测方式，无法揭示幻觉产生的根本原因，更无法为模型的改进提供针对性指导。</p>
<p><strong>为了解决这一核心痛点，本研究首先提出了全新的诊断工具——VHBench-10基准。</strong> 它开创性地将幻觉问题溯源至检测、分割、定位、分类这四项基本视觉能力，并进一步细分为10个具体的子任务（如颜色、计数、文本识别等）。通过这个“精准CT扫描”，我们首次能够系统性地诊断出不同视觉编码器各自的“能力盲区”。</p>
<p>基于这一深刻洞察，VisionWeaver架构应运而生。它不再是盲目地使用单一编码器，而是构建了一个动态专家协作系统，根据图像内容智能地调度最合适的视觉专家参与决策，从根源上抑制幻觉的产生。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/908191774a8a4ebcb155a0bbd82029f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763700792&amp;x-signature=aCNesH0v8A8Y0StmsDbOnqu47kM%3D" alt="图片" loading="lazy"/></p>
<p align="center">图1 VisionWeaver整体架构</p>
<p><strong>我们的主要贡献点如下：</strong></p>
<ol>
<li>
<p><strong>提出了VHBench-10——一个革命性的精细化诊断基准，推动幻觉研究从“识别现象”迈向“诊断病因”。</strong> 它首次将幻觉与底层视觉任务失败直接挂钩，为精确评估和定位LVLM的视觉能力短板提供了强有力的工具。</p>
</li>
<li>
<p><strong>系统性地揭示了不同视觉编码器的幻觉倾向。</strong> 通过在VHBench-10上的全面评估，论文首次量化并证实了特定编码器在特定视觉任务上的优势与短板，为解决幻觉问题提供了明确的靶点。</p>
</li>
<li>
<p><strong>提出了VisionWeaver——一个强大的LVLM新架构。</strong> 它引入上下文感知专家路由机制，能根据图像内容智能地聚合多个专家的视觉知识，效果远超简单的特征融合方法。</p>
</li>
<li>
<p><strong>在多个权威基准上取得了SOTA性能。</strong> 大量实验表明，VisionWeaver不仅显著降低了幻觉率，还全面提升了模型的综合表现。</p>
</li>
</ol>
<p><strong>方法概述</strong></p>
<p>VisionWeaver 的核心是解决单一视觉编码器能力有限且存在固有偏见的问题 。简单地将多个编码器的特征相加或拼接，实验证明效果并不理想 。为此，VisionWeaver 设计了一套智能、动态的专家协作流程，主要包含两大模块：</p>
<p><strong>上下文感知路由 (Context-Aware Routing)：</strong> 该机制旨在利用图像的全局语义特征来计算自适应的软路由权重，从而选择最合适的视觉专家 。具体而言，系统将基础 CLIP 编码器输出的[CLS] Token 特征作为路由模块的主要输入 。该 [CLS] Token 被证实能够有效捕获图像的关键全局视觉信息 。路由模块基于此特征生成一组路由信号，即针对每个下游专家编码器（如ConvNext, DINOv2, SAM, Vary等）的动态权重，以此决定不同专家在当前情境下的重要性得分 。</p>
<p><strong>知识增强与特征融合 (Knowledge Enhancement and Fusion)：</strong>  获得各专家的重要性权重后，系统对所有专家的输出特征进行加权融合（Weighted Fusion），生成一个聚合的专家表征 。为了在引入专家知识的同时不损失原始的细粒度视觉信息，该聚合表征将与基础 CLIP 编码器输出的 Patch Tokens 进行对齐 。实现方式上，通过一个残差式连接（residual-style connection），将聚合的专家特征与原始的 Patch Tokens 进行加法操作 。最终，这份增强后的视觉表征被传递至投影器（Projector），以映射到大型语言模型（LLM）的嵌入空间中，供后续的文本生成使用 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/137d24ea441145e8b12d28b0280f2c98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763700792&amp;x-signature=Mod%2B65vBN45a4UGadvv6aulbd%2BY%3D" alt="图片" loading="lazy"/></p>
<p align="center">图2 VHBench-10将幻觉分为4大类10小类</p>
<p><strong>关键特征</strong></p>
<ul>
<li>
<p><strong>精细化幻觉诊断：</strong> 依托VHBench-10，从视觉任务根源诊断并解决幻觉问题。</p>
</li>
<li>
<p><strong>上下文感知路由：</strong> 告别单一编码器，智能调度最适合当前任务的视觉专家。</p>
</li>
<li>
<p><strong>多专家协同融合：</strong>  汇集不同编码器的独特优势，实现对图像的全方位、深层次理解。</p>
</li>
<li>
<p><strong>卓越的幻觉抑制能力：</strong>  在多个基准上显著降低幻觉率，提升模型可靠性。</p>
</li>
<li>
<p><strong>高效推理设计：</strong> 通过轻量级专家和KV缓存等机制，在不显著增加延迟的情况下提升性能。</p>
</li>
</ul>
<h2 data-id="heading-3"><strong>实验</strong></h2>
<h3 data-id="heading-4"><strong>全新的精细化幻觉评估</strong></h3>
<p>VHBench-10基准的核心并非简单地判断对错，而是通过对10个细分视觉任务的评估，精准定位模型在感知能力上的具体短板。团队利用GPT-4为近万张图片生成了包含特定类型错误的描述（例如，颜色错误、数量错误等），与正确的描述形成对比，从而精确量化模型在各个维度上的幻觉倾向。</p>
<h3 data-id="heading-5"><strong>与已有方法的比较</strong></h3>
<p>在VHBench-10以及POPE、AutoHallusion等多个幻觉基准测试中，VisionWeaver的表现全面超越了使用单一编码器或简单多编码器融合的方法。如下图所示，无论是在物体存在性、颜色、形状还是文本识别等所有10个细分任务上，VisionWeaver的错误率均为最低，证明了其架构的普适性和有效性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b9abd905cdc42faa768fd5ab724aaae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763700792&amp;x-signature=Es4doIs%2Bdp0T%2BR52f0ebp97fPjs%3D" alt="图片" loading="lazy"/></p>
<p align="center">图3 VisionWeaver在10类细分幻觉任务上均取得最低错误率</p>
<h2 data-id="heading-6"><strong>总结</strong></h2>
<p>VisionWeaver及其核心评测工具VHBench-10，共同将幻觉研究的范式从模糊的现象描述，提升到了<strong>病因诊断</strong>层面。它不再满足于“知道模型错了”，而是要探究“模型为什么会错”。通过VHBench-10提供的深刻洞察，VisionWeaver得以构建一个智能、动态的多专家协作系统，从视觉感知的根源上大幅缓解了幻觉问题。这一“诊断+治疗”的新范式，为构建更可靠、更精确的下一代多模态AI提供了坚实的基础和清晰的实现路径。</p>
<p>-End-</p>
<p>作者丨Jerry酱、Kiren_</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis RedisTimeSeries 在springboot中的应用]]></title>    <link>https://juejin.cn/post/7572157115906703410</link>    <guid>https://juejin.cn/post/7572157115906703410</guid>    <pubDate>2025-11-14T03:05:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572157115906703410" data-draft-id="7572132100361060398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis RedisTimeSeries 在springboot中的应用"/> <meta itemprop="keywords" content="Redis,后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-14T03:05:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐小码"/> <meta itemprop="url" content="https://juejin.cn/user/4055468706891367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis RedisTimeSeries 在springboot中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4055468706891367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐小码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:05:17.000Z" title="Fri Nov 14 2025 03:05:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景</h2>
<p>我们现在有这样一个场景，使用国产的Gbase数据库，有个分钟表的数据，大概有20个字段，存储的的站点大概是4000多个，大概算下数据量</p>
<p>每小时：4000*60=240000</p>
<p>每天：40000* 60 * 24=5760000</p>
<p>但是我们实际上用的最频繁的是时间字段和一个要素字段，时间字段已经加了索引，要素字段数据是上来的监测数据。对此字段的请求频率是最高的，目前响应时间过长，严重影响到用户体验感 ，现需要进行对其优化，考虑到库的维护由用户负责，我们只有查询权限。提出如下几种方式</p>
<p>1、分库分表</p>
<p>2、国产时序库<strong>TDengine</strong>进行替代</p>
<p>3、历史数据和最新数据分开存储</p>
<p>4、使用Redis缓存</p>
<p>5、大数据方案</p>
<p>考虑到用户单位的特殊性，第一要满足国产要求，第二是数据库是指定专用，第三数据库维护不在我们这里。最终决定使用Redis的TS来解决。</p>
<p>主要实现逻辑：redis中缓存最近3小时内的所有有效数据，注意是有效数据，比如某个站点的数据缺测或者是一直没数据，则不进行缓存，其实很多时候都是没数据的，除非到雨季，这样下来redis缓存的数据会少很多。</p>
<p>数据由用户同步到Redis服务，我们进行查询，所以本文围绕使用来写</p>
<p>如果您有更好的解决方案，不妨交流一下，非常感谢您指导。</p>
<h2 data-id="heading-1">Redis-TS</h2>
<h3 data-id="heading-2">了解</h3>
<p>RedisTimeSeries 是一个 Redis 模块，用于存储、查询和管理时间序列数据。与传统的时间序列数据库相比，它的优势在于极低的延迟和与 Redis 生态的无缝集成。</p>
<p><strong>核心概念：</strong></p>
<ul>
<li><strong>时间序列</strong>：一个由时间戳和值组成的数据点序列。</li>
<li><strong>标签</strong>：可以为每个时间序列设置多个标签（如 <code>station_id=52889</code>, <code>element=V12001</code>），从而实现高效的筛选和分组查询。</li>
</ul>
<h3 data-id="heading-3">1、本地安装</h3>
<p>这里我们安装最新版的，默认自带了TS模块，推荐使用Linux环境,你会省去很多麻烦</p>
<pre><code class="hljs language-xml" lang="xml"> docker run -d \
  --privileged=true \
  -p 6380:6379 \
  --restart always \
  -v /data/redis/redis.conf:/etc/redis/redis.conf \
  -v /data/redis/data:/data \
  --name myredis \
  redis \
  redis-server /etc/redis/redis.conf --appendonly yes
</code></pre>
<p>可以把用户侧数据的rdb文件直接拷贝过来，数据就到本地了</p>
<h3 data-id="heading-4">2、使用</h3>
<p>我用的springboot框架为2.7.18，网上找了一圈，没找到比较好用的关于TS封装的组件</p>
<p>官网上有详细的命令使用方式，这里不在赘述 <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.ac.cn%2Fdocs%2Flatest%2Fcommands%2F%3Fgroup%3Dtimeseries" target="_blank" title="https://redis.ac.cn/docs/latest/commands/?group=timeseries" ref="nofollow noopener noreferrer">redis.ac.cn/docs/latest…</a></p>
<p>本次使用到几个命令</p>
<p><strong>1、获取最新数据 （TS.MGET）</strong></p>
<p><strong>2、正常查询某个时间段数据 （TS.MRANGE）</strong></p>
<p><strong>3、管道方式查询（TS.RANGE）</strong></p>
<p>管道和lua脚本的区别对比，鉴于对比，所以选择了管道方式执行</p>








































<table><thead><tr><th align="left">特性</th><th align="left">管道</th><th align="left">Lua 脚本</th></tr></thead><tbody><tr><td align="left"><strong>核心目标</strong></td><td align="left"><strong>提升吞吐量</strong>，减少网络延迟</td><td align="left"><strong>保证原子性</strong>，实现复杂逻辑</td></tr><tr><td align="left"><strong>原子性</strong></td><td align="left"><strong>不保证</strong>。管道中的命令可能会被其他客户端的命令插入。</td><td align="left"><strong>保证</strong>。脚本在执行期间，Redis服务器不会处理其他命令，相当于“数据库事务”。</td></tr><tr><td align="left"><strong>逻辑能力</strong></td><td align="left">无。只是一批命令的简单打包，命令之间无法相互影响。</td><td align="left"><strong>强大</strong>。可以使用变量、条件判断、循环等编程结构，前一个命令的结果可以直接用于下一个命令。</td></tr><tr><td align="left"><strong>性能优势</strong></td><td align="left"><strong>极高</strong>。将多个网络往返压缩为一次，极大提升批量操作的吞吐量。</td><td align="left"><strong>高</strong>。虽然也需要一次网络往返，但避免了多次网络延迟。其优势更多体现在原子性上，而非纯粹的吞吐量。</td></tr><tr><td align="left"><strong>错误处理</strong></td><td align="left">管道中某个命令失败，<strong>不会影响</strong>其他命令的执行。</td><td align="left">脚本中如果出现错误，整个脚本都会<strong>回滚</strong>，所有修改都不会生效。</td></tr><tr><td align="left"><strong>使用场景</strong></td><td align="left">- 批量写入数据 - 批量读取不相关的数据 - 更新大量计数器</td><td align="left">- 需要原子性的操作（如：秒杀扣库存、转账） - 前后命令有依赖（如：先检查再设置） - 实现复杂的业务逻辑（如：计算滑动窗口平均值）</td></tr></tbody></table>
<p><strong>4、数据统计</strong></p>
<p>单站点，单要素使用：TS.RANGE，多站点多要素使用TS.MRANGE</p>
<p><strong>5、窗口统计（TS.MRANGE）</strong></p>
<p>注意：此版本的RedisTemplated的execute方法是没办法直接执行TS的命令的，我们需要使用Lettuce中的方法来执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dfec.api.util;

<span class="hljs-keyword">import</span> com.alibaba.fastjson2.JSON;
<span class="hljs-keyword">import</span> com.dfec.api.constant.ApiConstant;
<span class="hljs-keyword">import</span> com.dfec.api.entity.TsResult;
<span class="hljs-keyword">import</span> com.dfec.api.entity.cache.StatParam;
<span class="hljs-keyword">import</span> com.dfec.common.bean.constant.RetCode;
<span class="hljs-keyword">import</span> com.dfec.common.bean.exception.OuterException;
<span class="hljs-keyword">import</span> io.lettuce.core.RedisFuture;
<span class="hljs-keyword">import</span> io.lettuce.core.cluster.api.async.RedisClusterAsyncCommands;
<span class="hljs-keyword">import</span> io.lettuce.core.codec.ByteArrayCodec;
<span class="hljs-keyword">import</span> io.lettuce.core.codec.StringCodec;
<span class="hljs-keyword">import</span> io.lettuce.core.internal.Exceptions;
<span class="hljs-keyword">import</span> io.lettuce.core.output.ObjectOutput;
<span class="hljs-keyword">import</span> io.lettuce.core.protocol.CommandArgs;
<span class="hljs-keyword">import</span> io.lettuce.core.protocol.ProtocolKeyword;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnection;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisConnectionUtils;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.RedisScript;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.JdkSerializationRedisSerializer;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.dfec.api.util.DateUtil.dateStrArrToLongArr;

<span class="hljs-comment">/**
 * Redis TS操作工具类
 *
 * <span class="hljs-doctag">@author</span> tangrg
 * <span class="hljs-doctag">@email</span> 1446232546@qq.com
 * <span class="hljs-doctag">@date</span> 2025-10-2025/10/13 09:39:46
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUtil</span> {

    LettuceConnection connection;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> LettuceConnectionFactory lettuceConnectionFactory;

    <span class="hljs-comment">/**
     * 将 Redis TS.MRANGE 返回的 Map&lt;String, List&lt;Object&gt;&gt;（key=seriesName, value=List&lt;[ts, val]&gt;）
     * 转换为 Map&lt;String, List&lt;TsResult&gt;&gt;，适配你当前的 TsResult 类（含 key: LocalDateTime）
     *
     * <span class="hljs-doctag">@param</span> rawData 原始返回数据，格式为 Map&lt;String, List&lt;Object&gt;&gt;，其中 value 是 List&lt;[ts, val]&gt;
     * <span class="hljs-doctag">@return</span> Map&lt;String, List&lt;TsResult&gt;&gt;
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">convertToTsResultMap</span><span class="hljs-params">(Map&lt;String, List&lt;Object&gt;&gt; rawData)</span> {
        Map&lt;String, List&lt;TsResult&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-keyword">if</span> (rawData == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Object&gt;&gt; entry : rawData.entrySet()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">seriesKey</span> <span class="hljs-operator">=</span> entry.getKey();  <span class="hljs-comment">// 如 "pm:ts:52889:V12001"</span>
            List&lt;Object&gt; dataPoints = entry.getValue();  <span class="hljs-comment">// List&lt;Object&gt;，每个是 [ts, val]</span>

            List&lt;TsResult&gt; tsResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

            <span class="hljs-keyword">for</span> (Object dp : dataPoints) {
                <span class="hljs-keyword">if</span> (!(dp <span class="hljs-keyword">instanceof</span> List)) {
                    <span class="hljs-keyword">continue</span>;
                }

                List&lt;Object&gt; point = (List&lt;Object&gt;) dp;
                <span class="hljs-keyword">if</span> (point.size() == <span class="hljs-number">2</span> &amp;&amp; !(point.get(<span class="hljs-number">0</span>) <span class="hljs-keyword">instanceof</span> List)) {
                    dealResult(point, tsResults);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">try</span> {
                        point.forEach(item1 -&gt; {
                            <span class="hljs-keyword">if</span> (item1 <span class="hljs-keyword">instanceof</span> List) {
                                <span class="hljs-type">List</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> (List) item1;
                                dealResult(item, tsResults);
                            }
                        });
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        <span class="hljs-comment">// 类型转换异常，跳过该点</span>
                        <span class="hljs-keyword">continue</span>;
                    }
                }
            }

            result.put(seriesKey, tsResults);
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dealResult</span><span class="hljs-params">(List&lt;Object&gt; point, List&lt;TsResult&gt; tsResults)</span> {
        <span class="hljs-type">TsResult</span> <span class="hljs-variable">tsResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TsResult</span>();
        tsResult.setTime((Long) point.get(<span class="hljs-number">0</span>));
        tsResult.setKey(DateUtil.longToLocalDateTime((Long) point.get(<span class="hljs-number">0</span>)));
        tsResult.setVal((Double) point.get(<span class="hljs-number">1</span>));
        tsResults.add(tsResult);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">awaitAll</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit, java.util.concurrent.Future&lt;?&gt;... futures)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> unit.toNanos(timeout);
            <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> System.nanoTime();

            <span class="hljs-keyword">for</span> (java.util.concurrent.Future&lt;?&gt; f : futures) {
                <span class="hljs-keyword">if</span> (timeout &lt;= <span class="hljs-number">0L</span>) {
                    f.get();
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (nanos &lt; <span class="hljs-number">0L</span>) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                    }
                    <span class="hljs-keyword">try</span> {
                        f.get(nanos, TimeUnit.NANOSECONDS);
                    } <span class="hljs-keyword">catch</span> (Exception e) {
<span class="hljs-comment">//                        e.printStackTrace();</span>
<span class="hljs-comment">//                        System.out.println("结果值不存在");</span>
                    }

                    <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.nanoTime();
                    nanos -= now - time;
                    time = now;
                }
            }

            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> Exceptions.fromSynchronization(e);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;<span class="hljs-type">byte</span>[]&gt; buildArgsFilterMap(Map&lt;String, Object&gt; filterMap) {
        List&lt;<span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span>(filterMap.containsKey(ApiConstant.FILTER_BY_VALUE)){
            args.add(ApiConstant.FILTER_BY_VALUE.getBytes());
            <span class="hljs-type">byte</span>[] bytes = filterMap.get(ApiConstant.FILTER_BY_VALUE).toString().getBytes();
            args.add(bytes);
            filterMap.remove(ApiConstant.FILTER_BY_VALUE);
        }
        <span class="hljs-keyword">if</span> (filterMap != <span class="hljs-literal">null</span> &amp;&amp; !filterMap.isEmpty()) {
            args.add(<span class="hljs-string">"FILTER"</span>.getBytes());
            filterMap.forEach((key, value) -&gt; {
                <span class="hljs-type">String</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> key + <span class="hljs-string">"="</span> + value;
                args.add(param.getBytes());
            });

        }
        <span class="hljs-keyword">return</span> args;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getBucketSizeMs</span><span class="hljs-params">(Long from, Long to, Integer windowSize, String dateType)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">bucketSizeMs</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (windowSize == <span class="hljs-literal">null</span>) {
            bucketSizeMs = to - from;
        } <span class="hljs-keyword">else</span> {
            bucketSizeMs = windowSize * getAdjTime(dateType);
        }
        <span class="hljs-keyword">return</span> bucketSizeMs;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title function_">getAdjTime</span><span class="hljs-params">(String dateType)</span> {
        <span class="hljs-keyword">switch</span> (dateType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"MIN"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"HOUR"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"DAY"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>;
        }
    }

    <span class="hljs-comment">/**
     * 查询某个时间范围内的时间序列数据
     *
     * <span class="hljs-doctag">@param</span> key  时间序列的 key，比如 "mytimeseries"
     * <span class="hljs-doctag">@param</span> from 开始时间戳（毫秒，比如 1712345600000）
     * <span class="hljs-doctag">@param</span> to   结束时间戳（毫秒，比如 1712345720000）
     * <span class="hljs-doctag">@return</span> 原始返回结果，是一个 List&lt;Object&gt;，每两个元素代表 [timestamp, value]
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TsResult&gt; <span class="hljs-title function_">queryTimeRange</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> from, <span class="hljs-type">long</span> to, Map&lt;String, Object&gt; filterMap,String dataCode)</span> {
        <span class="hljs-type">byte</span>[][] args = buildTsRangeArgs(key, from, to, filterMap);

        <span class="hljs-type">LettuceConnection</span> <span class="hljs-variable">connection1</span> <span class="hljs-operator">=</span> getLettuceConnection();
        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">keyValueListOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringCodec</span>());
        List&lt;List&lt;Object&gt;&gt; execute = (List&lt;List&lt;Object&gt;&gt;) connection1.execute(<span class="hljs-string">"TS.RANGE"</span>, keyValueListOutput, args);

        List&lt;TsResult&gt; tsResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        execute.forEach(item -&gt; {
            dealResult(item, tsResults);
        });
        <span class="hljs-keyword">return</span> tsResults;

    }

    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">queryTimeRangeByPipe</span><span class="hljs-params">(List&lt;String&gt; keys, String timeRange,String redisEleRange,String dataCode)</span> {
        Long[] dateArr = dateStrArrToLongArr(timeRange,dataCode);
        <span class="hljs-keyword">return</span> queryTimeRangeByPipe(keys, dateArr[<span class="hljs-number">0</span>], dateArr[<span class="hljs-number">1</span>],redisEleRange);
    }

    <span class="hljs-comment">/**
     * redis 的pipe
     * 存在的问题：如果其中有一个站点的值不存在，则会报错Caused by: io.lettuce.core.RedisCommandExecutionException: ERR TSDB: the key does not exist,通过重写的方式来解决
     * 
     *
     * <span class="hljs-doctag">@param</span> keys
     * <span class="hljs-doctag">@param</span> from
     * <span class="hljs-doctag">@param</span> to
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">queryTimeRangeByPipe</span><span class="hljs-params">(List&lt;String&gt; keys, <span class="hljs-type">long</span> from, <span class="hljs-type">long</span> to,String redisEleRange)</span> {
        Map&lt;String, List&lt;TsResult&gt;&gt; output = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-type">LettuceConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getLettuceConnection();

        RedisClusterAsyncCommands&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt; commands = connection.getNativeConnection();
        <span class="hljs-keyword">try</span> {

            <span class="hljs-comment">// 3. 开启 Pipeline 模式（关闭自动 flush）</span>
            commands.setAutoFlushCommands(<span class="hljs-literal">false</span>);


            List&lt;RedisFuture&lt;?&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();


            <span class="hljs-comment">// 单独保存 TS.RANGE 的 futures</span>
            List&lt;RedisFuture&lt;List&lt;Object&gt;&gt;&gt; tsRangeFutures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

            <span class="hljs-keyword">for</span> (String tsKey : keys) {
                <span class="hljs-type">byte</span>[] keyBytes = tsKey.getBytes(StandardCharsets.UTF_8);

                <span class="hljs-type">ProtocolKeyword</span> <span class="hljs-variable">tsRangeKeyword</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtocolKeyword</span>() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getBytes() {
                        <span class="hljs-keyword">return</span> <span class="hljs-string">"TS.RANGE"</span>.getBytes(StandardCharsets.UTF_8);
                    }

                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">name</span><span class="hljs-params">()</span> {
                        <span class="hljs-keyword">return</span> <span class="hljs-string">"TS.RANGE"</span>;
                    }
                };

                CommandArgs&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandArgs</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayCodec</span>()).addKey(keyBytes).add(from).add(to);

                <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(redisEleRange)){
                    args.add(ApiConstant.FILTER_BY_VALUE).add(redisEleRange);
                }

                <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">keyValueListOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringCodec</span>());

                <span class="hljs-meta">@SuppressWarnings("unchecked")</span> RedisFuture&lt;List&lt;Object&gt;&gt; tsFuture = (RedisFuture&lt;List&lt;Object&gt;&gt;) commands.dispatch(tsRangeKeyword, keyValueListOutput, args);

                futures.add(tsFuture);
                tsRangeFutures.add(tsFuture);
            }

            <span class="hljs-comment">// 执行 pipeline</span>
            commands.flushCommands();

            <span class="hljs-comment">// 等待所有完成</span>
            RedisFuture[] array = futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisFuture</span>[<span class="hljs-number">0</span>]);
            awaitAll(<span class="hljs-number">60</span>, TimeUnit.SECONDS, array);

            <span class="hljs-comment">// 解析 TS.RANGE 结果</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">tsIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (String tsKey : keys) {
                RedisFuture&lt;List&lt;Object&gt;&gt; tsFuture = tsRangeFutures.get(tsIndex);
                List&lt;Object&gt; rawTsData = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">/**
                     * 阻塞获取结果
                     * 这里如果获取结果失败，则会抛出异常，直接执行失败，我们需要制造一个空集合给后面使用
                     */</span>
                    rawTsData = tsFuture.get();
                } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
                    rawTsData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                }


<span class="hljs-comment">//                System.out.println("TS.RANGE 结果 for key [" + tsKey + "]: " + rawTsData);</span>

                List&lt;TsResult&gt; tsResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                <span class="hljs-keyword">if</span> (rawTsData != <span class="hljs-literal">null</span>) {

                    <span class="hljs-keyword">for</span> (Object item : rawTsData) {
                        <span class="hljs-keyword">if</span> (item <span class="hljs-keyword">instanceof</span> List) {
                            List&lt;?&gt; tsEntry = (List&lt;?&gt;) item;
                            <span class="hljs-keyword">if</span> (tsEntry.size() &gt;= <span class="hljs-number">2</span>) {
                                <span class="hljs-type">TsResult</span> <span class="hljs-variable">tsResult</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TsResult</span>();
                                <span class="hljs-type">Long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> ((Number) tsEntry.get(<span class="hljs-number">0</span>)).longValue();
                                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> tsEntry.get(<span class="hljs-number">1</span>);
                                tsResult.setTime(timestamp);
                                tsResult.setVal((Double) value);
                                tsResult.setKey(DateUtil.longToLocalDateTime(timestamp));
                                tsResults.add(tsResult);
                            }
                        }
                    }
                }
                output.put(tsKey, tsResults);

                tsIndex++;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            commands.setAutoFlushCommands(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) {
                RedisConnectionUtils.releaseConnection(connection, lettuceConnectionFactory);
            }
        }

        <span class="hljs-keyword">return</span> output;

    }

    <span class="hljs-keyword">private</span> LettuceConnection <span class="hljs-title function_">getLettuceConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> connection;
        }
        connection = (LettuceConnection) lettuceConnectionFactory.getConnection();
        <span class="hljs-keyword">return</span> connection;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeLua</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"local from = tonumber(ARGV[#ARGV - 1]) "</span> + <span class="hljs-string">"local to = tonumber(ARGV[#ARGV]) "</span> + <span class="hljs-string">"if not from or not to then return { err = 'from 和 to 必须是有效的时间戳（毫秒级数字，例如 1760895600000）' } end "</span> + <span class="hljs-string">"local result = {} "</span> + <span class="hljs-string">"for i = 1, #ARGV - 2 do "</span> + <span class="hljs-string">"  local key = ARGV[i] "</span> + <span class="hljs-string">"  local res = redis.call('TS.RANGE', key, from, to) "</span> + <span class="hljs-string">"  local row = { key } "</span> + <span class="hljs-string">"  for j = 1, #res do "</span> + <span class="hljs-string">"    table.insert(row, res[j][1]) "</span> + <span class="hljs-string">"    table.insert(row, res[j][2]) "</span> + <span class="hljs-string">"  end "</span> + <span class="hljs-string">"  table.insert(result, row) "</span> + <span class="hljs-string">"end "</span> + <span class="hljs-string">"return result"</span>;
        RedisScript&lt;Object&gt; objectRedisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(luaScript, Object.class);
        List&lt;String&gt; args1 = Arrays.asList(<span class="hljs-string">"pm:ts:52980:V13011"</span>, <span class="hljs-string">"pm:ts:52981:V13011"</span>, <span class="hljs-string">"pm:ts:52983:V13011"</span>, <span class="hljs-string">"pm:ts:53906:V13011"</span>, <span class="hljs-string">"pm:ts:53908:V13011"</span>, <span class="hljs-string">"1761068400000"</span>,  <span class="hljs-comment">// from（字符串，但会被 tonumbe() 转成数字）</span>
                <span class="hljs-string">"1761270000000"</span>   <span class="hljs-comment">// to（字符串，但会被 tonumbe() 转成数字）</span>
        );
        List&lt;<span class="hljs-type">byte</span>[]&gt; argsList = Arrays.asList(<span class="hljs-string">"pm:ts:52980:V13011"</span>.getBytes(), <span class="hljs-string">"pm:ts:52981:V13011"</span>.getBytes(), <span class="hljs-string">"pm:ts:52983:V13011"</span>.getBytes(), <span class="hljs-string">"pm:ts:53906:V13011"</span>.getBytes(), <span class="hljs-string">"pm:ts:53908:V13011"</span>.getBytes(), <span class="hljs-string">"1761068400000"</span>.getBytes(),  <span class="hljs-comment">// from（字符串，但会被 tonumbe() 转成数字）</span>
                <span class="hljs-string">"1761270000000"</span>.getBytes()   <span class="hljs-comment">// to（字符串，但会被 tonumbe() 转成数字）</span>
        );
        <span class="hljs-type">RedisSerializer</span> <span class="hljs-variable">stringRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();
        <span class="hljs-type">JdkSerializationRedisSerializer</span> <span class="hljs-variable">jdkSerializationRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkSerializationRedisSerializer</span>();

        <span class="hljs-type">Object</span> <span class="hljs-variable">execute1</span> <span class="hljs-operator">=</span> redisTemplate.execute(objectRedisScript, stringRedisSerializer, jdkSerializationRedisSerializer, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(), args1.toArray());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[][] buildTsRangeArgs(String key, <span class="hljs-type">long</span> from, <span class="hljs-type">long</span> to, Map&lt;String, Object&gt; filterMap) {
        List&lt;<span class="hljs-type">byte</span>[]&gt; argsList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        argsList.add(key.getBytes());
        argsList.add(String.valueOf(from).getBytes());
        argsList.add(String.valueOf(to).getBytes());

        <span class="hljs-keyword">if</span> (filterMap != <span class="hljs-literal">null</span> &amp;&amp; !filterMap.isEmpty()) {
            argsList.add(<span class="hljs-string">"FILTER"</span>.getBytes());
            <span class="hljs-type">String</span> <span class="hljs-variable">filterStr</span> <span class="hljs-operator">=</span> filterMap.entrySet().stream().map(entry -&gt; entry.getKey() + <span class="hljs-string">"="</span> + entry.getValue()).collect(Collectors.joining(<span class="hljs-string">" "</span>));
            argsList.add(filterStr.getBytes());
        }

        <span class="hljs-keyword">return</span> argsList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>][]);
    }

    <span class="hljs-keyword">public</span> List&lt;TsResult&gt; <span class="hljs-title function_">queryTimeRange</span><span class="hljs-params">(String key, Long[] longs, Map&lt;String, Object&gt; filterMap,String dataCode)</span> {
        <span class="hljs-keyword">return</span> queryTimeRange(key, longs[<span class="hljs-number">0</span>], longs[<span class="hljs-number">1</span>], filterMap,dataCode);
    }

    <span class="hljs-comment">/**
     * 查询某个时间范围内的时间序列数据
     *
     * <span class="hljs-doctag">@param</span> key       时间序列的 key，比如 "mytimeseries"
     * <span class="hljs-doctag">@param</span> timeRange 时间范围，格式为 "[开始时间, 结束时间]"，如 "[20251020014000,20251023064000]"
     * <span class="hljs-doctag">@return</span> 原始返回结果，是一个 List&lt;Object&gt;，每两个元素代表 [timestamp, value]
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TsResult&gt; <span class="hljs-title function_">queryTimeRange</span><span class="hljs-params">(String key, String timeRange, Map&lt;String, Object&gt; filterMap,String dataCode)</span> {
        Long[] longs = dateStrArrToLongArr(timeRange,dataCode);
        <span class="hljs-keyword">return</span> queryTimeRange(key, longs[<span class="hljs-number">0</span>], longs[<span class="hljs-number">1</span>], filterMap,dataCode);
    }

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> redisTemplate.opsForValue().get(key);
    }

    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getObject</span><span class="hljs-params">(String key, Class&lt;T&gt; clazz)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : JSON.parseObject(value, clazz);
    }

    <span class="hljs-comment">/**
     * 获取 HashMap 数据
     *
     * <span class="hljs-doctag">@param</span> key HashMap 的 key
     * <span class="hljs-doctag">@return</span> HashMap 数据
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;Object, Object&gt; <span class="hljs-title function_">getHash</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> redisTemplate.opsForHash().entries(key);

    }


    <span class="hljs-comment">/**
     * 解析 TS.MRANGE 命令返回的原始数据（List&lt;Object&gt;），构造 TsResult 列表
     */</span>

    <span class="hljs-comment">/**
     * 执行 TS.MRANGE 命令，查询满足 FILTER 条件的多个 TimeSeries 在指定时间范围内的数据
     *
     * <span class="hljs-doctag">@param</span> timeRange 时间范围，格式为 "[开始时间, 结束时间]"，如 "[20251020014000,20251023064000]"
     * <span class="hljs-doctag">@param</span> filterMap 标签过滤条件，如 {"table": "pm", "station_id": "52889", "element": "V12001"}
     * <span class="hljs-doctag">@return</span> 查询结果，每个元素为 TsResult（包含 key、timestamp、value）
     * <span class="hljs-doctag">@see</span> &lt;a href="https://oss.redis.com/redistimeseries/commands/#tsmrange"&gt;TS.MRANGE&lt;/a&gt;
     *
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">queryMrange</span><span class="hljs-params">(String timeRange, Map&lt;String, Object&gt; filterMap,String dataCode)</span> {
        Long[] longs = dateStrArrToLongArr(timeRange,dataCode);
        <span class="hljs-keyword">return</span> queryMrange(longs[<span class="hljs-number">0</span>], longs[<span class="hljs-number">1</span>], filterMap, <span class="hljs-string">"TS.MRANGE"</span>);
    }

    <span class="hljs-comment">/**
     *
     * 执行 TS.MGET 命令，查询满足 FILTER 条件的多个 TimeSeries 的最新数据
     * 示例：TS.MGET FILTER table=pm station_id=(52889,52674) element=V13011
     *
     * <span class="hljs-doctag">@param</span> filterMap 标签过滤条件，如 {"table": "pm", "station_id": "52889", "element": "V12001"}
     * <span class="hljs-doctag">@return</span> 查询结果，每个元素为 TsResult（包含 key、timestamp、value）
     * <span class="hljs-doctag">@see</span> &lt;a href="https://oss.redis.com/redistimeseries/commands/#tsmrange"&gt;TS.MGET&lt;/a&gt;
     *
     **/</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">queryMget</span><span class="hljs-params">(Map&lt;String, Object&gt; filterMap)</span> {
        <span class="hljs-keyword">return</span> queryMrange(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, filterMap, <span class="hljs-string">"TS.MGET"</span>);
    }

    <span class="hljs-comment">/**
     * 执行 TS.MRANGE 命令，查询满足 FILTER 条件的多个 TimeSeries 在指定时间范围内的数据
     *
     * <span class="hljs-doctag">@param</span> from      开始时间戳（毫秒）
     * <span class="hljs-doctag">@param</span> to        结束时间戳（毫秒）
     * <span class="hljs-doctag">@param</span> filterMap 标签过滤条件，如 {"table": "pm", "station_id": "52889", "element": "V12001"}
     * <span class="hljs-doctag">@return</span> 查询结果，每个元素为 TsResult（包含 key、timestamp、value）
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">queryMrange</span><span class="hljs-params">(Long from, Long to, Map&lt;String, Object&gt; filterMap, String cmd)</span> {
        <span class="hljs-comment">// 1. 构造 TS.MRANGE 命令的参数</span>
        List&lt;<span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (from == <span class="hljs-literal">null</span> &amp;&amp; to == <span class="hljs-literal">null</span>) {
            args = buildArgsFilterMap(filterMap);
        } <span class="hljs-keyword">else</span> {
            args = buildMrangeArgs(from, to, filterMap);
        }

        <span class="hljs-keyword">return</span> executeCmdByArgs(cmd, args, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">private</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">executeCmdByArgs</span><span class="hljs-params">(String cmd, List&lt;<span class="hljs-type">byte</span>[]&gt; args, String key)</span> {
        <span class="hljs-comment">// 2. 获取 Lettuce 原生连接</span>
        <span class="hljs-type">LettuceConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getLettuceConnection();

        <span class="hljs-comment">// 3. 执行 TS.MRANGE 命令</span>
        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">keyValueListOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringCodec</span>());
        <span class="hljs-type">Object</span> <span class="hljs-variable">execute</span> <span class="hljs-operator">=</span> connection.execute(cmd, keyValueListOutput, args.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>][]));
        Map&lt;String, List&lt;Object&gt;&gt; rawResult = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (execute <span class="hljs-keyword">instanceof</span> List) {
            Map&lt;String, List&lt;Object&gt;&gt; objectObjectHashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            objectObjectHashMap.put(key, (List&lt;Object&gt;) execute);
            rawResult = objectObjectHashMap;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (execute <span class="hljs-keyword">instanceof</span> Map) {
            rawResult = (Map&lt;String, List&lt;Object&gt;&gt;) execute;
        }

        <span class="hljs-comment">// 4. 解析返回结果，构造 TsResult 列表</span>
        <span class="hljs-keyword">return</span> convertToTsResultMap(rawResult);
    }

    <span class="hljs-comment">/**
     * 构造 TS.MRANGE 命令的参数（byte[] 格式）
     */</span>
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">byte</span>[]&gt; buildMrangeArgs(Long from, Long to, Map&lt;String, Object&gt; filterMap) {
        List&lt;<span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        args.add(String.valueOf(from).getBytes());  <span class="hljs-comment">// from (timestamp)</span>
        args.add(String.valueOf(to).getBytes());    <span class="hljs-comment">// to (timestamp)</span>

        List&lt;<span class="hljs-type">byte</span>[]&gt; bytes = buildArgsFilterMap(filterMap);
        args.addAll(bytes);
        <span class="hljs-keyword">return</span> args;
    }

    <span class="hljs-comment">/**
     * 构件统计参数-多个站点，多个要素（这里只能统计多站点、单要素）
     * TS.MRANGE 1761323040000 1761526920000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52889,52881) table=pm GROUPBY station_id REDUCE min
     * TS.MRANGE 1701323040000 1761526920000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52889,52881) table=mm GROUPBY station_id REDUCE min
     * TS.MRANGE 1729787040000 1761872520000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52980,52881,52889) element=(V12001,V11291) table=mm GROUPBY station_id   REDUCE min
     * TS.MRANGE 1729787040000 1761872520000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52980,52881,52889) element=(V11291) table=mm GROUPBY station_id,element   REDUCE min （不行）
     * TS.MRANGE 1729787040000 1761872520000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52980,52881,52889) element=(V12001) table=mm GROUPBY station_id   REDUCE min
     * TS.MRANGE 1729787040000 1761872520000   FILTER station_id=(52980,52881,52889) element=(V12001) table=mm AGGREGATION sum 203880000 BUCKETTIMESTAMP +  GROUPBY station_id   REDUCE min
     *
     * <span class="hljs-doctag">@param</span> from
     * <span class="hljs-doctag">@param</span> to
     * <span class="hljs-doctag">@param</span> stationIds
     * <span class="hljs-doctag">@param</span> table
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">byte</span>[]&gt; buildStatMrangeArgs(Long from, Long to, List&lt;String&gt; stationIds, List&lt;String&gt; elements, String table, String dateType,String redisEleRange) {
        List&lt;<span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        args.add(String.valueOf(from).getBytes());
        args.add(String.valueOf(to).getBytes());
        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(redisEleRange)){
            args.add(ApiConstant.FILTER_BY_VALUE.getBytes());
            args.add(redisEleRange.getBytes());
        }
        args.add(<span class="hljs-string">"AGGREGATION"</span>.getBytes());
        args.add(<span class="hljs-string">"sum"</span>.getBytes());
        <span class="hljs-type">long</span> <span class="hljs-variable">bucket_size_ms</span> <span class="hljs-operator">=</span> to - from;
        args.add(String.valueOf(bucket_size_ms).getBytes());
        args.add(<span class="hljs-string">"BUCKETTIMESTAMP"</span>.getBytes());
        args.add(<span class="hljs-string">"+"</span>.getBytes());
        args.add(<span class="hljs-string">"ALIGN"</span>.getBytes());
        <span class="hljs-type">long</span> <span class="hljs-variable">alignTime</span> <span class="hljs-operator">=</span> getAlignTime(from, bucket_size_ms, dateType);
        args.add(String.valueOf(alignTime).getBytes());
        args.add(<span class="hljs-string">"FILTER"</span>.getBytes());
        args.add((<span class="hljs-string">"station_id=("</span> + String.join(<span class="hljs-string">","</span>, stationIds) + <span class="hljs-string">")"</span>).getBytes());
        args.add((<span class="hljs-string">"element=("</span> + String.join(<span class="hljs-string">","</span>, elements) + <span class="hljs-string">")"</span>).getBytes());
        args.add((<span class="hljs-string">"table="</span> + table).getBytes());
        args.add(<span class="hljs-string">"GROUPBY"</span>.getBytes());
        args.add(<span class="hljs-string">"station_id"</span>.getBytes());
<span class="hljs-comment">//        args.add("element".getBytes());</span>
        args.add(<span class="hljs-string">"REDUCE"</span>.getBytes());
        args.add(<span class="hljs-string">"min"</span>.getBytes());
        <span class="hljs-keyword">return</span> args;
    }

    <span class="hljs-comment">/**
     * 构件单站点的 聚合或者5分钟的聚合
     * TS.RANGE pm:ts:52889:V13011 1761323040000 1761526920000  AGGREGATION sum 203880000 BUCKETTIMESTAMP + ALIGN align_time
     * TS.RANGE pm:ts:52889:V13011 1761323040000 1761526920000 FILTER_BY_VALUE -inf 30  AGGREGATION sum 203880000 BUCKETTIMESTAMP + ALIGN align_time
     *
     * <span class="hljs-doctag">@param</span> from
     * <span class="hljs-doctag">@param</span> to
     * <span class="hljs-doctag">@param</span> key
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">byte</span>[]&gt; buildStatRangeArgs(Long from, Long to, String key, StatParam statParam, String dateType,String redisEleRange) {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">windowSize</span> <span class="hljs-operator">=</span> statParam.getWindowSize();
        <span class="hljs-type">String</span> <span class="hljs-variable">statType</span> <span class="hljs-operator">=</span> statParam.getStatType();
        List&lt;<span class="hljs-type">byte</span>[]&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        args.add(key.getBytes());
        args.add(String.valueOf(from).getBytes());
        args.add(String.valueOf(to).getBytes());
        <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(redisEleRange)){
            args.add(ApiConstant.FILTER_BY_VALUE.getBytes());
            args.add(redisEleRange.getBytes());
        }
        args.add(<span class="hljs-string">"AGGREGATION"</span>.getBytes());
        args.add(statType.getBytes());
        <span class="hljs-type">long</span> <span class="hljs-variable">bucket_size_ms</span> <span class="hljs-operator">=</span> getBucketSizeMs(from, to, windowSize, dateType);
        args.add(String.valueOf(bucket_size_ms).getBytes());
        args.add(<span class="hljs-string">"BUCKETTIMESTAMP"</span>.getBytes());
        args.add(<span class="hljs-string">"+"</span>.getBytes());
        args.add(<span class="hljs-string">"ALIGN"</span>.getBytes());
        <span class="hljs-type">long</span> <span class="hljs-variable">alignTime</span> <span class="hljs-operator">=</span> getAlignTime(from, bucket_size_ms, dateType);
        args.add(String.valueOf(alignTime).getBytes());
        <span class="hljs-keyword">return</span> args;
    }

    <span class="hljs-comment">/**
     * 获取对齐时间
     * align_time = (start_ts // bucket_size_ms) * bucket_size_ms+ adj_time
     *
     * <span class="hljs-doctag">@param</span> from
     * <span class="hljs-doctag">@param</span> bucket_size_ms
     * <span class="hljs-doctag">@param</span> dateType
     * <span class="hljs-doctag">@param</span> dateType
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">private</span> Long <span class="hljs-title function_">getAlignTime</span><span class="hljs-params">(Long from, <span class="hljs-type">long</span> bucket_size_ms, String dateType)</span> {
        <span class="hljs-keyword">return</span> from / bucket_size_ms * bucket_size_ms + getAdjTime(dateType);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getKey</span><span class="hljs-params">(String stationId, String table, String element)</span> {
        <span class="hljs-keyword">return</span> table + <span class="hljs-string">":ts:"</span> + stationId + <span class="hljs-string">":"</span> + element;
    }

    <span class="hljs-comment">/**
     * 数据统计
     * 1.如果是单个站点，按照单个站点的方式进行聚合
     * TS.RANGE pm:ts:52889:V13011 start_ts end_ts  AGGREGATION sum bucket_size_ms BUCKETTIMESTAMP + ALIGN align_time
     * TS.RANGE pm:ts:52889:V13011 1761323040000 1761526920000  AGGREGATION sum 203880000 BUCKETTIMESTAMP + ALIGN align_time
     * 2.如果是多个站点，按照多个站点进行聚合
     * TS.MRANGE 1761323040000 1761526920000   AGGREGATION sum 203880000 BUCKETTIMESTAMP + FILTER station_id=(52889,52881) table=pm GROUPBY station_id REDUCE min
     * 3.需要区分一下是不是5分钟的聚合方式
     *
     * <span class="hljs-doctag">@param</span> timeRange  时间范围 [start_ts, end_ts]
     * <span class="hljs-doctag">@param</span> stationIds 站点编号
     * <span class="hljs-doctag">@param</span> table      表名 pm/mm
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">statTsDataMiddle</span><span class="hljs-params">(String timeRange, List&lt;String&gt; stationIds, List&lt;String&gt; elements, String table, StatParam statParam, String dateType,String redisEleRange,String dataCode)</span> {
        Long[] timeParamArr = dateStrArrToLongArr(timeRange,dataCode);
        <span class="hljs-keyword">if</span> (stationIds.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OuterException</span>(RetCode.BAD_REQUEST, <span class="hljs-string">"站点编号不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (elements.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OuterException</span>(RetCode.BAD_REQUEST, <span class="hljs-string">"要素不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (stationIds.size() == <span class="hljs-number">1</span> &amp;&amp; elements.size() == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">//单站点、单要素按照 TS.RANGE的方式进行统计</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> getKey(stationIds.get(<span class="hljs-number">0</span>), table, elements.get(<span class="hljs-number">0</span>));
            List&lt;<span class="hljs-type">byte</span>[]&gt; args = buildStatRangeArgs(timeParamArr[<span class="hljs-number">0</span>], timeParamArr[<span class="hljs-number">1</span>], key, statParam, dateType,redisEleRange);
            <span class="hljs-keyword">return</span> executeCmdByArgs(<span class="hljs-string">"TS.RANGE"</span>, args, key);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//多站点、单要素按照 TS.MRANGE的方式进行统计</span>
            List&lt;<span class="hljs-type">byte</span>[]&gt; args = buildStatMrangeArgs(timeParamArr[<span class="hljs-number">0</span>], timeParamArr[<span class="hljs-number">1</span>], stationIds, elements, table, dateType,redisEleRange);
            Map&lt;String, List&lt;TsResult&gt;&gt; stringListMap = executeCmdByArgs(<span class="hljs-string">"TS.MRANGE"</span>, args, <span class="hljs-literal">null</span>);
            <span class="hljs-comment">//结果值转换</span>
            <span class="hljs-keyword">return</span> convertToResultMap(stringListMap, table, elements.get(<span class="hljs-number">0</span>));
        }

    }

    <span class="hljs-keyword">private</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">convertToResultMap</span><span class="hljs-params">(Map&lt;String, List&lt;TsResult&gt;&gt; stringListMap, String tableName, String ele)</span> {
        <span class="hljs-keyword">return</span> stringListMap.entrySet()
                .stream()
                .collect(Collectors.toMap(
                        entry -&gt; buildNewKey(entry.getKey(), tableName, ele),
                        Map.Entry::getValue
                ));
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildNewKey</span><span class="hljs-params">(String originalKey, String tableName, String ele)</span> {
        String[] split = originalKey.split(<span class="hljs-string">"="</span>);
        <span class="hljs-keyword">return</span> tableName + <span class="hljs-string">":ts:"</span> + split[<span class="hljs-number">1</span>] + <span class="hljs-string">":"</span> + ele;
    }

    <span class="hljs-comment">/**
     * 基于redis的数据统计结果，做两件事
     * 1.如果是窗口聚合，使用ALIGN参数调整桶的开始时间，使其从01开始，获取的时间戳减去adj_time，得到实际的聚合时间
     * 2.统一处理map的key，让其后面的流程可统一处理
     *
     * <span class="hljs-doctag">@param</span> timeRange
     * <span class="hljs-doctag">@param</span> stationIds
     * <span class="hljs-doctag">@param</span> elements
     * <span class="hljs-doctag">@param</span> table
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;TsResult&gt;&gt; <span class="hljs-title function_">statTsData</span><span class="hljs-params">(String timeRange, List&lt;String&gt; stationIds, List&lt;String&gt; elements, String table, String dateType, StatParam statParam,String redisEleRange,String dataCode)</span> {
        Map&lt;String, List&lt;TsResult&gt;&gt; stringListMap = statTsDataMiddle(timeRange, stationIds, elements, table, statParam, dateType,redisEleRange,dataCode);
        <span class="hljs-keyword">if</span> (statParam.getWindowSize() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> stringListMap;
        }
        <span class="hljs-keyword">return</span> stringListMap.entrySet().stream().collect(Collectors.toMap(entry -&gt; entry.getKey(), entry -&gt; entry.getValue().stream().map(result -&gt; {
            <span class="hljs-type">long</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> result.getTime() - getAdjTime(dateType);
            result.setTime(l);
            result.setKey(DateUtil.longToLocalDateTime(l));
            <span class="hljs-keyword">return</span> result;
        }).collect(Collectors.toList())));
    }


    <span class="hljs-comment">/**
     * 获取所有以 meta:staid: 开头的 Hash Key，并返回它们的 HGETALL 数据
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">getAllMetaStaidHashes</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 使用 keys() 查找所有匹配的 key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"meta:staid:*"</span>;
        Set&lt;String&gt; keys = redisTemplate.keys(pattern);

        <span class="hljs-keyword">if</span> (keys == <span class="hljs-literal">null</span> || keys.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        }

        Map&lt;String, Map&lt;String, Object&gt;&gt; collect = keys.stream().collect(Collectors.toMap(key -&gt; key.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">2</span>], key -&gt; {
            <span class="hljs-comment">// 获取原始 Hash 数据：Map&lt;Object, Object&gt;</span>
            Map&lt;Object, Object&gt; rawEntries = redisTemplate.opsForHash().entries(key);

            <span class="hljs-comment">// 转换为 Map&lt;String, Object&gt;</span>
            Map&lt;String, Object&gt; stringifiedEntries = rawEntries.entrySet().stream().collect(Collectors.toMap(entry -&gt; entry.getKey().toString(),          <span class="hljs-comment">// 字段名转 String</span>
                    entry -&gt; entry.getValue()                  <span class="hljs-comment">// 字段值保持 Object</span>
            ));
            <span class="hljs-keyword">return</span> stringifiedEntries;
        }));
        <span class="hljs-keyword">return</span> collect;
    }




}

</code></pre>
<pre><code class="hljs language-xml" lang="xml">package com.dfec.api.entity;

import java.time.LocalDateTime;

/**
 *
 * @author tangrg
 * @email 1446232546@qq.com
 * @date 2025-10-2025/10/23 10:38:06
 */
public class TsResult {

    private Long time;

    private LocalDateTime  key;

    private Double val;

    public Long getTime() {
        return time;
    }

    public void setTime(Long time) {
        this.time = time;
    }

    public LocalDateTime getKey() {
        return key;
    }

    public void setKey(LocalDateTime key) {
        this.key = key;
    }

    public Double getVal() {
        return val;
    }

    public void setVal(Double val) {
        this.val = val;
    }
}

</code></pre>
<p>最近项目比较赶，其实可以考虑将这部分封装成一个starter来使用，后面有时间会考虑</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IM 收件箱机制（三）]]></title>    <link>https://juejin.cn/post/7572052559822848006</link>    <guid>https://juejin.cn/post/7572052559822848006</guid>    <pubDate>2025-11-14T03:05:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572052559822848006" data-draft-id="7572048000301318185" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IM 收件箱机制（三）"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-14T03:05:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锅拌饭"/> <meta itemprop="url" content="https://juejin.cn/user/210732593191543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IM 收件箱机制（三）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/210732593191543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锅拌饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:05:37.000Z" title="Fri Nov 14 2025 03:05:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在IM中，有了长连接之后，如何完成服务端与客户端的数据同步也是很重要的一环。</p>
<p>通常会有两种方案，一个是<strong>服务端直接转发</strong>，一个是<strong>收件箱机制</strong>。我们以消息类型的数据为例。</p>
<p><strong>服务端直接转发：</strong></p>
<p>是服务端收到<code>消息A</code>，存储完成后，直接将<code>消息A</code>的具体内容通过长连接通道发送给客户端B。我们把这种方式叫做服务端直接转发。</p>
<p><strong>收件箱：</strong></p>
<p>服务端收到消息后，不直接转发该消息给客户端，而是将消息<code>id</code>、消息所在会话<code>id</code>推送给客户端的消息收件箱，客户端发现消息收件箱有数据后，择机通过长连接 or 短连接拉取消息具体内容。</p>
<h2 data-id="heading-0">服务端直接转发</h2>
<p>服务端直接转发是最简单的，但是在实际操作运行中，会面临几个问题。</p>
<p><strong>消息阻塞</strong></p>
<p>首先，在富文本的场景中，一个富文本的消息大小可以达到1M。前面说过，长连接的通道是全双工的，允许同时双向通信。但是他的并发量只有1，所以在服务端向客户端传输<code>消息A</code>的时候，其他数据需要等待传输完成后才能再次传输。</p>
<p>如果用户当前在会话A中聊天，但是在会话B中，收到了上百条富文本消息，由于下行通道堵塞，会导致用户无法及时看到会话A中的消息。</p>
<p><strong>ACK</strong></p>
<p>在IM应用中，比实时性更优先的原则是数据真实性，即不能丢数据。所以需要有一套<code>ACK</code>机制，当客户端收到<code>消息A</code>并落库后，会给服务端发送一个回包，用于表示这条消息拉到了。</p>
<p>服务端直接转发方案，如果因为网络抖动原因，客户端没有收到该消息，则服务端还需要再次重试推送该消息，那么会有大量的网络带宽浪费，对服务端也有重试的成本。</p>
<p><strong>消息聚合拉取</strong></p>
<p>单次只拉取一条消息，对于客户端和服务端都是资源的浪费。将多条消息聚合拉取，能够节省网络资源和服务端计算资源。</p>
<hr/>
<p><strong>消息优先级拉取</strong></p>
<p>在一般的IM应用中，有很多用户不关心的群聊，但又不能退出群聊。所以会有会话分组或者折叠会话等功能。这些会话对消息实时性要求不是很高，如果服务端收到消息后直接转发该消息，会让客户端失去灵活拉取的主动权。</p>
<h2 data-id="heading-1">收件箱机制</h2>
<p>基于前面提到的几个实际场景。结合信箱的原理，我们采用<strong>收件箱机制</strong>。</p>
<p>在收件箱机制中，服务端收到消息后，不直接转发该消息给客户端，而是将消息<code>id</code>、消息所在会话<code>id</code>推送给客户端的消息收件箱，这个数据量很小。</p>
<p>客户端收到该推送后，将该消息<code>id</code>落库，并回包给服务端，让服务端感知到，该消息<code>id</code>，客户端已经收到了，服务端无需再次推送该消息了。</p>
<p>回包完成后，客户端会根据该消息的优先级，确认是否获取该消息<code>id</code>对应的消息体。也可以做聚合，批量拉取一系列消息体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d990a8cee9af461182f0075a583a64a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694877&amp;x-signature=iteMU5hrk1Tusm0jeZIBv7btonQ%3D" alt="" loading="lazy"/></p>
<p>这里有人可能会疑惑，采用收件箱机制，会不会导致消息抵达实时性降低。实际上考虑到网络堵塞、消息聚合拉取等逻辑的存在，收件箱机制在业务优化后，可能比服务端直接转发效果更好。因为没有对应的A/B Test，无法确认两种方案在实时性上的区别。</p>
<p>采用收件箱机制后，在实际运用中，根据业务，会存在多个收件箱。比如消息收件箱、会话收件箱。在飞书中，还会有日程到期收件箱、文档变更收件箱等。</p>
<p>当然并不是所有服务端与客户端的通信都需要<strong>收件箱机制</strong>，根据业务复杂程度、信息数据量大小等，应当采用<strong>收件箱机制</strong>与<strong>服务端直接转发</strong>相结合的方式。</p>
<p>我们以最复杂的业务，消息收件箱为例，查看一些技术细节。</p>
<p>首先，使用消息收件箱是为了保证消息<strong>有序、低延迟、数据不丢失</strong>。</p>
<p><strong>有序：</strong> 按照实际消息顺序获取，保证消息顺序</p>
<p><strong>低延迟：</strong> 推与拉结合，保证实时性</p>
<p><strong>数据不丢失：</strong> 通过<code>ACK</code>、重试，确保数据不丢失</p>
<h2 data-id="heading-2">消息收件箱</h2>
<h3 data-id="heading-3">命令字</h3>
<p>收件箱是一个概念上的东西，在实际开发中，客户端会和服务端约定一个命令字，比如<code>10001</code>，当服务端向客户端推送<code>10001</code>的时候，就代表当前数据是消息收件箱消息。当客户端收到<code>10002</code>时，就代表当前数据是会话收件箱消息。</p>
<p>一般的收件箱数据如下：</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>   <span class="hljs-comment">// 推送命令字</span>
    <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10001"</span><span class="hljs-punctuation">,</span>  
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  
        <span class="hljs-comment">// 消息所在会话id</span>
        <span class="hljs-attr">"conversation_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123456789_2"</span><span class="hljs-punctuation">,</span>  
        <span class="hljs-comment">// 消息的序列号</span>
        <span class="hljs-attr">"sequence_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123456789123456789"</span>  
    <span class="hljs-punctuation">}</span>  
<span class="hljs-punctuation">}</span>

</code></pre>
<h3 data-id="heading-4">sequenceId</h3>
<p>在上面的数据结构中，<code>sequenceId</code>是递增的（跨会话全局递增）。这个会有服务端保证，一般会分布式集群，会采用雪花算法（<a href="https://juejin.cn/post/7303749383165935627" target="_blank" title="https://juejin.cn/post/7303749383165935627">你可能听说过雪花算法</a>）等方式生成，保证<code>sequenceId</code>的递增、唯一性。</p>
<p><strong>sequenceId：</strong></p>
<ol>
<li>
<p>服务端每条消息入库前，都会生成<code>sequenceId</code>，该<code>sequenceId</code>是跨会话唯一、递增的。</p>
</li>
<li>
<p><code>sequenceId</code>的作用是用于标记收件箱数据位置，客户端基于<code>sequenceId</code>向服务端请求数据。</p>
</li>
<li>
<p>客户端每次请求会携带本地的<code>lastSequenceId</code>，服务端响应式会返回新的<code>lastSequenceId</code>+<code>hasMore</code>。</p>
</li>
<li>
<p>客户端循环拉取，直到<code>hasMore=false</code>，确保本地数据完整。</p>
</li>
</ol>
<p>当客户端收到<code>10001</code>推送后，会将该数据分发到对应的收件箱处理，即<code>MessageEmailManager</code>，在这里，会先对该数据落库，然后回包给服务端，表示客户端已经知道会话A中有<code>消息123</code>。服务端收到回包后，就不会再次推送<code>消息123</code>给客户端。</p>
<p>在<code>MessageEmailManager</code>中，可以根据消息优先级，决定是否拉取该消息的具体内容，以及是否聚合拉取具体内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50d3d99904d4b5d995dfd6d27008165~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694877&amp;x-signature=RUz2WH%2FHgJkEjllN9CVMwpyhj8A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">推拉结合</h3>
<p><strong>客户端在线时：</strong> 实时推送最新的<code>sequenceId</code>给客户端，客户端立即感知</p>
<p><strong>登录/重连/冷启动时：</strong> 增量拉取，快速同步离线期间的数据</p>
<p><strong>拉取失败时：</strong> 无限重试，确保拉取成功</p>
<p>整个流程图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41cf5ad83a2d4716ae2d22689236dcce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694877&amp;x-signature=%2B0BSMxIFlYNdyS7rUBEcitIEA24%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">问题：为什么需要sequenceId？</h3>
<p>思考这个问题：消息本身有个唯一的<code>messageId</code>，为什么不直接推送<code>messageId</code>给客户端，而是又新增了<code>sequenceId</code>专门用于推送呢？</p>
<p>首先，<code>messageId</code>也会保证全局的唯一性，在服务端用作消息的唯一标识，即数据库主key。</p>
<p><strong>但是messageId存在两个缺陷：</strong></p>
<ol>
<li>
<p>以64位整型Long为例，一般会在<code>messageId</code>中固定前几位用于声明关键信息，如会话<code>id</code>等信息。</p>
</li>
<li>
<p><code>messageId</code>保证全局唯一，但是不保证消息是按照发送顺序递增的。</p>
</li>
</ol>
<p>第二个缺陷，<code>messageId</code>不递增，导致它无法用于收件箱推送。对于消息推送来说，是推拉结合的，那么在冷启动的时候，需要上传本地已经获取到的消息：</p>
<ol>
<li>
<p>如果使用<code>messageId</code>，那么就要把本地所有的<code>messageId</code>都发送给服务端。而且服务端还要做<code>diff</code>，才能计算出客户端需要的消息队列。</p>
</li>
<li>
<p>使用<code>sequenceId</code>，就简单很多。首先<code>sequenceId</code>是递增的，客户端只需要将本地的最新（or最大）<code>sequenceId</code>发送给服务端，服务端也只需要对比<code>sequenceId</code>大小，就可以计算出客户端需要的消息队列。</p>
</li>
</ol>
<p>我们其实可以将<code>sequenceId</code>理解为版本号的概念，客户端只需要维护一个本地版本号，就可以和服务端同步剩余数据。</p>
<h3 data-id="heading-7">问题二：id会耗尽吗？</h3>
<p><strong>一般我们的id使用的都是Long类型，即64位整型的。那么思考一下，这个id会耗尽吗？</strong></p>
<p>64 位有符号 Long 的最大值是 9223372036854775807，换算成亿为 92233720368.54775807 亿（约 <strong>9223 万亿</strong>）。</p>
<p>我们以国民级应用微信为例，假设日活有10亿，那么每个人要发送922万条消息才能耗尽这个id。我们把时间拉长到100年，那么每个人每年要发送9万条消息，每天发送250条消息。</p>
<p>上面的假设场景，是把所有极端情况拉满的，实际上大部分人在微信中一天内不会发送250条消息。</p>
<p>根据国外分析网站的数据<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.demandsage.com%2Fwechat-statistics%2F" target="_blank" title="https://www.demandsage.com/wechat-statistics/" ref="nofollow noopener noreferrer">wechat-statistics</a>，微信每天会产生450亿条消息，那么Long型可以供使用20万天，即555年。</p>
<p><strong>所以对于大部分应用，无需考虑id耗尽的问题。</strong></p>
<h2 data-id="heading-8">消息空洞</h2>
<p>上面几个原则很好理解，但是在实际开发中，还需要解决消息的空洞问题。</p>
<p><strong>消息空洞：</strong> 即消息不连续，中间漏掉了消息</p>
<h3 data-id="heading-9">case1：网络抖动</h3>
<p>想象这个场景，服务端依次收到了<code>消息A</code>，<code>消息B</code>，<code>消息C</code>。 依次通过推送告知客户端，有<code>消息A</code>、<code>消息B</code>、<code>消息C</code>三条新消息，需要客户端主动获取对应消息体内容。</p>
<p>但是由于网络抖动，<code>消息B</code>的推送丢失了。 客户端仅收到了<code>消息A</code>、<code>消息C</code>，落库后回包给服务端。此时服务端虽然会重试推送<code>消息B</code>，但是用户此时正好在此会话中，需要展示<code>消息A</code>、<code>消息C</code>。对于客户端来说，并不知道还有<code>消息B</code>，那么就会导致<code>消息A</code>、<code>消息C</code>上屏展示了。这样就会对用户理解信息造成很大影响。</p>
<p>下图中，你的回复是图片+文字，但是对方只收到了“交配中”的文字，会让对方感觉很抽象。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f9336aec1f4610bdde74a4bac85111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694877&amp;x-signature=Um3O9Nm1zamCJ5CBPG1MHPbYlCI%3D" width="400" loading="lazy"/>
<hr/>
<h3 data-id="heading-10">case2：消息定位</h3>
<p>一般来说，进入会话A，初始化只会拉取最新50条消息，用户滑动屏幕后才会触发加载。在卸载重装后，用户没有滑动屏幕加载更多消息，那么客户端<code>SDK</code>数据库中，只有最近50条消息。</p>
<p>用户通过搜索关键字，定位到了第10000条的消息。当用户在这第10000条消息滑动屏幕时，会调用<code>loadMessage</code>加载下一页的消息。</p>
<p>那么如何判断<code>SDK</code>数据库中的50条消息，是否能展示呢？</p>
<p>即<code>SDK</code>怎么判断第10000条消息和最近50条消息是否连续呢？</p>
<p>我们从文字描述上看，此时肯定是不连续的，即出现了空洞。但对于<code>SDK</code>来说，一定要有一个可以量化的条件。</p>
<p>消息定位导致的消息空洞场景有很多：</p>
<p>用户在离线状态，群聊中产生了10000条消息，用户点击离线推送进入会话，也会和上面情景一样，产生消息空洞。</p>
<p>同理，点击被回复的消息/被引用的消息/被置顶的消息等，都有可能产生消息空洞。</p>
<h2 data-id="heading-11">如何保证消息连续性：</h2>
<p>保证消息没有空洞，即连续性很重要。一般来说，服务端会在<code>messageId</code>的基础上，给每条消息计算出一个<code>continueId</code>，<code>continueId</code>是<strong>连续递增</strong>的，从0、1、2、3一直到无穷大。</p>
<p>需要注意，<code>continueId</code>是绑定在具体的会话下面的，在这个会话下是<strong>连续递增</strong>的。</p>
<p>前面提到的<code>sequenceId</code>是跨会话的，在多个会话间是<strong>非连续递增</strong>的。</p>
<p>这样客户端就知道<code>消息A</code>跟<code>消息C</code>是不能上墙的，得主动拉取到<code>消息B</code>，才能一起上墙。</p>
<p>服务端连续递增id生成方案有很多，这里不多赘述<a href="https://juejin.cn/post/6990382290740183076" target="_blank" title="https://juejin.cn/post/6990382290740183076"> 分布式ID生成器（CosId）设计与实现</a></p>
<p>在消息收件箱中，不关心消息是否是连续的，只关心消息是递增的。在99%的情况下，消息收件箱中的消息都是连续的。而且大部分会话，用户是极低概率进入的，而且即使进入，也很极低概率会滑动查看全部的历史消息。</p>
<p>所以，我们无需在收件箱中就保证消息连续性。只需要在用户看到这部分消息时，保证连续即可。一般来说，用户进入会话查看消息流程：</p>
<ol>
<li>
<p>用户进入会话A后，客户端业务会调用<code>loadMessage(lastMessageId, pageSize)</code>，其中，<code>lastMessageId</code>是描点id，<code>pageSize</code>是想要获取的消息数量。</p>
</li>
<li>
<p>客户端业务向客户端<code>SDK</code>查询从指定锚点开始的历史消息。</p>
</li>
<li>
<p>当客户端<code>SDK</code>从本地数据库捞出对应的消息列表后，需要<code>check</code> <code>continueId</code>是否是连续的</p>
</li>
<li>
<p>如果消息<code>continueId</code>连续，就直接返回给业务方。</p>
</li>
<li>
<p>如果不连续，客户端<code>SDK</code>需要发起网络请求，向服务端拉取补齐消息，最终返回给客户端业务。</p>
</li>
<li>
<p>这个过程会有预加载、loading等方式优化用户体验</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69654f18fac483285b5611b0e6959bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSF5ouM6aWt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763694877&amp;x-signature=f%2FYVaUMqhY3Mg7TLrY3Ky0FK0n8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">消息中各种id</h2>

























<table><thead><tr><th>****</th><th><strong>含义</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>messageId</strong></td><td>消息的唯一id，具有全局唯一性，但是不保证按照发送顺序递增</td><td>消息的主key</td></tr><tr><td><strong>sequenceId</strong></td><td>全局唯一性，且是递增的，按照发送顺序一次递增</td><td>用于客户端-服务端的消息同步</td></tr><tr><td><strong>continueId</strong></td><td>单个会话内连续递增</td><td>用于保证消息连续不空洞</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[12 节课解锁 AI Agents，让AI替你打工（二）：从零开始构建一个Agent]]></title>    <link>https://juejin.cn/post/7572147440313270335</link>    <guid>https://juejin.cn/post/7572147440313270335</guid>    <pubDate>2025-11-14T03:57:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572147440313270335" data-draft-id="7572138663120322602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="12 节课解锁 AI Agents，让AI替你打工（二）：从零开始构建一个Agent"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-14T03:57:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            12 节课解锁 AI Agents，让AI替你打工（二）：从零开始构建一个Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T03:57:50.000Z" title="Fri Nov 14 2025 03:57:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在我们之前的文章中，我们全面概述了 AI Agent 的特征、组件、发展历程、挑战及未来可能性。</p>
<p>本篇将探讨如何使用 Python 从零开始构建一个Agent。该Agent能够根据用户输入做出决策，选择合适的工具并执行相应任务。让我们开始吧！</p>
<h2 data-id="heading-0">1.  什么是 Agent？</h2>
<hr/>
<p>Agent 是一个能够感知环境、做出决策并采取行动以实现特定目标的自主实体。Agent 的复杂程度可以从简单响应刺激的反应式 Agent，到能够持续学习和适应的先进 Agent。常见的 Agent 类型包括：</p>
<ol>
<li>
<p><strong>反应式 Agent</strong></p>
<p>直接响应环境变化，没有内部记忆。</p>
</li>
<li>
<p><strong>基于模型的 Agent</strong></p>
<p>利用对世界的内部模型进行决策。</p>
</li>
<li>
<p><strong>基于目标的 Agent</strong></p>
<p>根据实现特定目标来规划行动。</p>
</li>
<li>
<p><strong>基于效用的 Agent</strong></p>
<p>通过效用函数评估潜在行动以最大化结果。</p>
</li>
</ol>
<p>例如聊天机器人、推荐系统和自动驾驶汽车，它们都利用不同类型的 Agent 来高效智能地执行任务。</p>
<p>我们构建的 Agent 核心组件包括：</p>
<ul>
<li>
<p><strong>模型</strong></p>
<p>Agent 的大脑，负责处理输入并生成响应。</p>
</li>
<li>
<p><strong>工具</strong></p>
<p>Agent 可以基于用户请求执行的预定义函数。</p>
</li>
<li>
<p><strong>工具库</strong></p>
<p>Agent 可用工具的集合。</p>
</li>
<li>
<p><strong>系统提示词</strong></p>
<p>指导 Agent 如何处理用户输入和选择正确工具的指令集。</p>
</li>
</ul>
<h2 data-id="heading-1">2.  具体实现</h2>
<hr/>
<p>现在，让我们卷起袖子开始构建！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57d2fcea3069464581f6e2abc493715b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697469&amp;x-signature=p985sAlqSaWxyzmHDwP7PaVYhYo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-2">2.1 准备工作</h4>
<p><em>本教程完整代码可在 AI Agents GitHub 仓库获取。</em></p>
<p><em>实现代码在此查看：</em>** <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvsingh9076%2FAI-Agents%2Ftree%2Fmain%2Fbuild-agent-from-scratch" target="_blank" title="https://github.com/vsingh9076/AI-Agents/tree/main/build-agent-from-scratch" ref="nofollow noopener noreferrer">github.com/vsingh9076/…</a> **<em>。</em></p>
<p>运行代码前请确保系统满足以下要求：</p>
<h3 data-id="heading-3"><strong>1. Python 环境配置</strong></h3>
<p>需要安装 Python 来运行 AI Agent：</p>
<p><strong>安装 Python（如未安装）</strong></p>
<ul>
<li>从python.org下载并安装 Python（推荐3.8+版本）</li>
<li>验证安装：</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>python <span class="hljs-attr">--version</span>
</code></pre>
<p><strong>创建虚拟环境（推荐）</strong> 使用虚拟环境管理依赖：</p>
<pre><code class="hljs language-bash" lang="bash">1python -m venv ai_agents_env
​
2source ai_agents_env/bin/activate  <span class="hljs-comment"># Windows系统：ai_agents_env\Scripts\activate</span>
</code></pre>
<p><strong>安装依赖包</strong> 进入仓库目录并安装依赖：</p>
<pre><code class="hljs">1pip install -r requirements.txt
</code></pre>
<h3 data-id="heading-4"><strong>2. 本地安装Ollama</strong></h3>
<p>Ollama用于高效运行和管理本地语言模型：</p>
<p><strong>下载并安装Ollama</strong></p>
<ul>
<li>访问Ollama官网下载对应操作系统的安装包</li>
<li>按照平台指引完成安装</li>
</ul>
<p><strong>验证Ollama安装</strong> 运行以下命令检查是否安装成功：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>ollama <span class="hljs-attr">--version</span>
</code></pre>
<p><strong>拉取模型（如需）</strong> 某些实现可能需要特定模型，可通过以下命令获取：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">1</span>ollama pull mistral  # 将<span class="hljs-string">'mistral'</span>替换为所需模型名
</code></pre>
<h4 data-id="heading-5">2.2 实现步骤</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27f59f495f8b4129a30bdd1d9fc4ce04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763697469&amp;x-signature=xnnwHZYobj3geo1pimhiSOoC9y0%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>说明：本章节涉及到的具体代码较多， 建议在 PC 端查看，体验更好</p>
</blockquote>
<p><strong>步骤1：配置环境</strong></p>
<p>除了 Python，还需安装<code>requests</code>、<code>json</code>和<code>termcolor</code>库，使用<code>dotenv</code>管理环境变量：</p>
<pre><code class="hljs">1pip install requests termcolor python-dotenv
</code></pre>
<p><strong>步骤2：定义模型类</strong></p>
<p>首先创建<code>OllamaModel</code>类，用于与本地 API 交互生成响应：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">1</span><span class="hljs-keyword">from</span> termcolor <span class="hljs-keyword">import</span> colored
​
<span class="hljs-number">2</span><span class="hljs-keyword">import</span> os
​
<span class="hljs-number">3</span><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
​
4load_dotenv()
​
<span class="hljs-number">5</span><span class="hljs-comment">## 模型相关</span>
​
<span class="hljs-number">6</span><span class="hljs-keyword">import</span> requests
​
<span class="hljs-number">7</span><span class="hljs-keyword">import</span> json
​
<span class="hljs-number">8</span><span class="hljs-keyword">import</span> operator
​
<span class="hljs-number">9</span>
​
<span class="hljs-number">10</span><span class="hljs-keyword">class</span> OllamaModel:
​
<span class="hljs-number">11</span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model, system_prompt, temperature=<span class="hljs-number">0</span>, stop=<span class="hljs-literal">None</span></span>):
​
<span class="hljs-number">12</span>        self.model_endpoint = <span class="hljs-string">"http://localhost:11434/api/generate"</span>
​
<span class="hljs-number">13</span>        self.temperature = temperature
​
<span class="hljs-number">14</span>        self.model = model
​
<span class="hljs-number">15</span>        self.system_prompt = system_prompt
​
<span class="hljs-number">16</span>        self.headers = {<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>}
​
<span class="hljs-number">17</span>        self.stop = stop
​
<span class="hljs-number">18</span>
​
<span class="hljs-number">19</span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_text</span>(<span class="hljs-params">self, prompt</span>):
​
<span class="hljs-number">20</span>        payload = {
​
<span class="hljs-number">21</span>            <span class="hljs-string">"model"</span>: self.model,
​
<span class="hljs-number">22</span>            <span class="hljs-string">"format"</span>: <span class="hljs-string">"json"</span>,
​
<span class="hljs-number">23</span>            <span class="hljs-string">"prompt"</span>: prompt,
​
<span class="hljs-number">24</span>            <span class="hljs-string">"system"</span>: self.system_prompt,
​
<span class="hljs-number">25</span>            <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
​
<span class="hljs-number">26</span>            <span class="hljs-string">"temperature"</span>: self.temperature,
​
<span class="hljs-number">27</span>            <span class="hljs-string">"stop"</span>: self.stop
​
<span class="hljs-number">28</span>        }
​
<span class="hljs-number">29</span>
​
<span class="hljs-number">30</span>        <span class="hljs-keyword">try</span>:
​
<span class="hljs-number">31</span>            request_response = requests.post(
​
<span class="hljs-number">32</span>                self.model_endpoint,
​
<span class="hljs-number">33</span>                headers=self.headers,
​
<span class="hljs-number">34</span>                data=json.dumps(payload)
​
<span class="hljs-number">35</span>            )
​
<span class="hljs-number">36</span>
​
<span class="hljs-number">37</span>            <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求响应"</span>, request_response)
​
<span class="hljs-number">38</span>            request_response_json = request_response.json()
​
<span class="hljs-number">39</span>            response = request_response_json[<span class="hljs-string">'response'</span>]
​
<span class="hljs-number">40</span>            response_dict = json.loads(response)
​
<span class="hljs-number">41</span>
​
<span class="hljs-number">42</span>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n\n来自Ollama模型的响应：<span class="hljs-subst">{response_dict}</span>"</span>)
​
<span class="hljs-number">43</span>
​
<span class="hljs-number">44</span>            <span class="hljs-keyword">return</span> response_dict
​
<span class="hljs-number">45</span>        <span class="hljs-keyword">except</span> requests.RequestException <span class="hljs-keyword">as</span> e:
​
<span class="hljs-number">46</span>            response = {<span class="hljs-string">"error"</span>: <span class="hljs-string">f"调用模型时出错！<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>}
​
<span class="hljs-number">47</span>            <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>步骤3：创建 Agent 工具</strong></p>
<p>构建基础计算器和字符串反转工具：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">1</span><span class="hljs-keyword">def</span> basic_calculator(input_str):
​
<span class="hljs-number">2</span>    <span class="hljs-keyword">try</span>:
​
<span class="hljs-number">3</span>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(input_str, <span class="hljs-built_in">dict</span>):
​
<span class="hljs-number">4</span>            input_dict = input_str
​
<span class="hljs-number">5</span>        <span class="hljs-keyword">else</span>:
​
<span class="hljs-number">6</span>            input_str_clean = input_str.replace(<span class="hljs-string">"'"</span>, <span class="hljs-string">""")
​
7            input_str_clean = input_str_clean.strip().strip("""</span>)
​
<span class="hljs-number">8</span>            input_dict = json.loads(input_str_clean)
​
<span class="hljs-number">9</span>
​
<span class="hljs-number">10</span>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">all</span>(key <span class="hljs-keyword">in</span> input_dict <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> [<span class="hljs-string">'num1'</span>, <span class="hljs-string">'num2'</span>, <span class="hljs-string">'operation'</span>]):
​
<span class="hljs-number">11</span>            <span class="hljs-keyword">return</span> <span class="hljs-string">"错误：输入必须包含'num1'、'num2'和'operation'"</span>
​
<span class="hljs-number">12</span>
​
<span class="hljs-number">13</span>        num1 = <span class="hljs-built_in">float</span>(input_dict[<span class="hljs-string">'num1'</span>])
​
<span class="hljs-number">14</span>        num2 = <span class="hljs-built_in">float</span>(input_dict[<span class="hljs-string">'num2'</span>])
​
<span class="hljs-number">15</span>        operation = input_dict[<span class="hljs-string">'operation'</span>].lower()
​
<span class="hljs-number">16</span>
​
<span class="hljs-number">17</span>    <span class="hljs-keyword">except</span> (json.JSONDecodeError, KeyError) <span class="hljs-keyword">as</span> e:
​
<span class="hljs-number">18</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">"输入格式无效，请提供有效数字和运算符"</span>
​
<span class="hljs-number">19</span>    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
​
<span class="hljs-number">20</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">"错误：请提供有效数值"</span>
​
<span class="hljs-number">21</span>
​
<span class="hljs-number">22</span>    operations = {
​
<span class="hljs-number">23</span>        <span class="hljs-string">'add'</span>: operator.add,
​
<span class="hljs-number">24</span>        <span class="hljs-string">'plus'</span>: operator.add,
​
<span class="hljs-number">25</span>        <span class="hljs-string">'subtract'</span>: operator.sub,
​
<span class="hljs-number">26</span>        <span class="hljs-string">'minus'</span>: operator.sub,
​
<span class="hljs-number">27</span>        <span class="hljs-string">'multiply'</span>: operator.mul,
​
<span class="hljs-number">28</span>        <span class="hljs-string">'times'</span>: operator.mul,
​
<span class="hljs-number">29</span>        <span class="hljs-string">'divide'</span>: operator.truediv,
​
<span class="hljs-number">30</span>        <span class="hljs-string">'floor_divide'</span>: operator.floordiv,
​
<span class="hljs-number">31</span>        <span class="hljs-string">'modulus'</span>: operator.mod,
​
<span class="hljs-number">32</span>        <span class="hljs-string">'power'</span>: operator.<span class="hljs-built_in">pow</span>,
​
<span class="hljs-number">33</span>        <span class="hljs-string">'lt'</span>: operator.lt,
​
<span class="hljs-number">34</span>        <span class="hljs-string">'le'</span>: operator.le,
​
<span class="hljs-number">35</span>        <span class="hljs-string">'eq'</span>: operator.eq,
​
<span class="hljs-number">36</span>        <span class="hljs-string">'ne'</span>: operator.ne,
​
<span class="hljs-number">37</span>        <span class="hljs-string">'ge'</span>: operator.ge,
​
<span class="hljs-number">38</span>        <span class="hljs-string">'gt'</span>: operator.gt
​
<span class="hljs-number">39</span>    }
​
<span class="hljs-number">40</span>
​
<span class="hljs-number">41</span>    <span class="hljs-keyword">if</span> operation <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> operations:
​
<span class="hljs-number">42</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">f"不支持的运算符：'<span class="hljs-subst">{operation}</span>'，支持的操作符有：<span class="hljs-subst">{<span class="hljs-string">', '</span>.join(operations.keys())}</span>"</span>
​
<span class="hljs-number">43</span>
​
<span class="hljs-number">44</span>    <span class="hljs-keyword">try</span>:
​
<span class="hljs-number">45</span>        <span class="hljs-keyword">if</span> (operation <span class="hljs-keyword">in</span> [<span class="hljs-string">'divide'</span>, <span class="hljs-string">'floor_divide'</span>, <span class="hljs-string">'modulus'</span>]) <span class="hljs-keyword">and</span> num2 == <span class="hljs-number">0</span>:
​
<span class="hljs-number">46</span>            <span class="hljs-keyword">return</span> <span class="hljs-string">"错误：不能除以零"</span>
​
<span class="hljs-number">47</span>
​
<span class="hljs-number">48</span>        result = operations[operation](num1, num2)
​
<span class="hljs-number">49</span>
​
<span class="hljs-number">50</span>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">bool</span>):
​
<span class="hljs-number">51</span>            result_str = <span class="hljs-string">"True"</span> <span class="hljs-keyword">if</span> result <span class="hljs-keyword">else</span> <span class="hljs-string">"False"</span>
​
<span class="hljs-number">52</span>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">float</span>):
​
<span class="hljs-number">53</span>            result_str = <span class="hljs-string">f"<span class="hljs-subst">{result:<span class="hljs-number">.6</span>f}</span>"</span>.rstrip(<span class="hljs-string">'0'</span>).rstrip(<span class="hljs-string">'.'</span>)
​
<span class="hljs-number">54</span>        <span class="hljs-keyword">else</span>:
​
<span class="hljs-number">55</span>            result_str = <span class="hljs-built_in">str</span>(result)
​
<span class="hljs-number">56</span>
​
<span class="hljs-number">57</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算结果是：<span class="hljs-subst">{result_str}</span>"</span>
​
<span class="hljs-number">58</span>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
​
<span class="hljs-number">59</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算过程中出错：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
<span class="hljs-number">60</span>
​
<span class="hljs-number">61</span><span class="hljs-keyword">def</span> reverse_string(input_string):
​
<span class="hljs-number">62</span>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(input_string, <span class="hljs-built_in">str</span>):
​
<span class="hljs-number">63</span>        <span class="hljs-keyword">return</span> <span class="hljs-string">"错误：输入必须是字符串"</span>
​
<span class="hljs-number">64</span>
​
<span class="hljs-number">65</span>    reversed_string = input_string[::-<span class="hljs-number">1</span>]
​
<span class="hljs-number">66</span>    <span class="hljs-keyword">return</span> <span class="hljs-string">f"反转后的字符串是：<span class="hljs-subst">{reversed_string}</span>"</span>
</code></pre>
<p><strong>步骤4：构建工具库</strong></p>
<p><code>ToolBox</code>类管理所有可用工具：</p>
<pre><code class="hljs language-ruby" lang="ruby">1class <span class="hljs-title class_">ToolBox</span>:

<span class="hljs-number">2</span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):

<span class="hljs-number">3</span>        <span class="hljs-variable language_">self</span>.tools_dict = {}

<span class="hljs-number">4</span>

<span class="hljs-number">5</span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, functions_list</span>):

<span class="hljs-number">6</span>        <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> <span class="hljs-symbol">functions_list:</span>

<span class="hljs-number">7</span>            <span class="hljs-variable language_">self</span>.tools_dict[func.__name__] = func.__doc__

<span class="hljs-number">8</span>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.tools_dict

<span class="hljs-number">9</span>

<span class="hljs-number">10</span>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tools</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):

<span class="hljs-number">11</span>        tools_str = <span class="hljs-string">""</span>

<span class="hljs-number">12</span>        <span class="hljs-keyword">for</span> name, doc <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.tools_dict.items():

<span class="hljs-number">13</span>            tools_str += f<span class="hljs-string">"{name}: "</span>{doc}<span class="hljs-string">"\n"</span>

<span class="hljs-number">14</span>        <span class="hljs-keyword">return</span> tools_str.strip()
</code></pre>
<p><strong>步骤5：创建 Agent 类</strong></p>
<p><code>Agent</code> 类实现决策和执行功能：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">1agent_system_prompt_template</span> = <span class="hljs-string">"""

2您是一个拥有特定工具的智能AI助手，响应必须始终使用以下JSON格式：

3{{

4    "tool_choice": "工具名称",

5    "tool_input": "工具输入"

6}}

7

8工具使用规则：

91. basic_calculator：用于数学计算

10   - 输入格式：{{"num1": 数字, "num2": 数字, "operation": "运算符"}}

112. reverse_string：用于反转文本

12   - 输入格式：直接输入要反转的字符串

133. no tool：用于常规对话

14

15严格规则：

16- 身份类问题必须使用"no tool"

17- 反转文本请求必须提取纯文本

18- 数学运算必须转换数字格式

19

20可用工具列表：

21{tool_descriptions}

22

23注意：响应必须是有效的 JSON 格式！

24"""</span>

25

26class Agent:

27    def __init__(self, tools, model_service, model_name, <span class="hljs-attr">stop</span>=None):

28        <span class="hljs-attr">self.tools</span> = tools

29        <span class="hljs-attr">self.model_service</span> = model_service

30        <span class="hljs-attr">self.model_name</span> = model_name

31        <span class="hljs-attr">self.stop</span> = stop

32

33    def prepare_tools(self):

34        <span class="hljs-attr">toolbox</span> = ToolBox()

35        toolbox.store(self.tools)

36        return toolbox.tools()

37

38    def think(self, prompt):

39        <span class="hljs-attr">tool_descriptions</span> = self.prepare_tools()

40        <span class="hljs-attr">agent_system_prompt</span> = agent_system_prompt_template.format(tool_descriptions=tool_descriptions)

41

42        if <span class="hljs-attr">self.model_service</span> == OllamaModel:

43            <span class="hljs-attr">model_instance</span> = self.model_service(

44                <span class="hljs-attr">model</span>=self.model_name,

45                <span class="hljs-attr">system_prompt</span>=agent_system_prompt,

46                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0</span>,

47                <span class="hljs-attr">stop</span>=self.stop

48            )

49        else:

50            <span class="hljs-attr">model_instance</span> = self.model_service(

51                <span class="hljs-attr">model</span>=self.model_name,

52                <span class="hljs-attr">system_prompt</span>=agent_system_prompt,

53                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0</span>

54            )

55

56        return model_instance.generate_text(prompt)

57

58    def work(self, prompt):

59        <span class="hljs-attr">agent_response_dict</span> = self.think(prompt)

60        <span class="hljs-attr">tool_choice</span> = agent_response_dict.get(<span class="hljs-string">"tool_choice"</span>)

61        <span class="hljs-attr">tool_input</span> = agent_response_dict.get(<span class="hljs-string">"tool_input"</span>)

62

63        for tool in self.tools:

64            if <span class="hljs-attr">tool.__name__</span> == tool_choice:

65                <span class="hljs-attr">response</span> = tool(tool_input)

66                print(colored(response, 'cyan'))

67                return

68

69        print(colored(tool_input, 'cyan'))
</code></pre>
<p><strong>步骤6：运行 Agent</strong></p>
<p>主程序实现交互界面：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">1</span><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:

<span class="hljs-number">2</span>    tools = [basic_calculator, reverse_string]

<span class="hljs-number">3</span>

<span class="hljs-number">4</span>    <span class="hljs-comment"># 使用 Ollama 的 llama2 模型</span>

<span class="hljs-number">5</span>    model_service = OllamaModel

<span class="hljs-number">6</span>    model_name = <span class="hljs-string">"llama2"</span>

<span class="hljs-number">7</span>    stop = <span class="hljs-string">"&lt;|eot_id|&gt;"</span>

<span class="hljs-number">8</span>

<span class="hljs-number">9</span>    agent = Agent(tools=tools, model_service=model_service, model_name=model_name, stop=stop)

<span class="hljs-number">10</span>

<span class="hljs-number">11</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n欢迎使用AIAgent！输入'exit'退出"</span>)

<span class="hljs-number">12</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"支持功能："</span>)

<span class="hljs-number">13</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 数学计算（如'计算15加7'）"</span>)

<span class="hljs-number">14</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 字符串反转（如'反转hello world'）"</span>)

<span class="hljs-number">15</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 常规问答\n"</span>)

<span class="hljs-number">16</span>

<span class="hljs-number">17</span>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:

<span class="hljs-number">18</span>        prompt = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入问题："</span>)

<span class="hljs-number">19</span>        <span class="hljs-keyword">if</span> prompt.lower() == <span class="hljs-string">"exit"</span>:

<span class="hljs-number">20</span>            <span class="hljs-keyword">break</span>

<span class="hljs-number">21</span>        agent.work(prompt)
</code></pre>
<h3 data-id="heading-6">3.  结论</h3>
<hr/>
<p>通过本篇教程，我们从理解 Agent 概念到逐步实现了一个完整案例。我们配置了开发环境，定义了模型结构，创建了核心工具，并最终构建了可交互的 Agent 系统。这种结构化方法为构建自动化决策的 Agent 奠定了坚实基础。随着 AI Agent 的持续进化，其应用场景将不断扩展，推动各行业效率提升和创新发展。敬请期待更多深度解析，助您打造更强大的 AI Agent！</p>
<h3 data-id="heading-7">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 连接数据库]]></title>    <link>https://juejin.cn/post/7572010680897191976</link>    <guid>https://juejin.cn/post/7572010680897191976</guid>    <pubDate>2025-11-13T16:11:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680897191976" data-draft-id="7571846248719859712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 连接数据库"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-13T16:11:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拂晓银砾"/> <meta itemprop="url" content="https://juejin.cn/user/2852567870088136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 连接数据库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2852567870088136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拂晓银砾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T16:11:02.000Z" title="Thu Nov 13 2025 16:11:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">准备工作</h2>
<ul>
<li>JDK17</li>
<li>Postgresql</li>
<li>MySQL</li>
</ul>
<h3 data-id="heading-1">POM依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>自主指定依赖版本。</p>
<h3 data-id="heading-2">公共代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> lombok.Data;  
  
<span class="hljs-keyword">import</span> java.math.BigDecimal;  
<span class="hljs-keyword">import</span> java.time.LocalDateTime;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span><span class="hljs-meta">@Data</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {  
    <span class="hljs-keyword">private</span> Integer id;  
    <span class="hljs-keyword">private</span> String name;  
    <span class="hljs-keyword">private</span> BigDecimal balance;  
    <span class="hljs-keyword">private</span> Boolean locked;  
    <span class="hljs-keyword">private</span> LocalDateTime accessTime;  
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.io.InputStream;  
<span class="hljs-keyword">import</span> java.sql.Connection;  
<span class="hljs-keyword">import</span> java.sql.DriverManager;  
<span class="hljs-keyword">import</span> java.sql.SQLException;  
<span class="hljs-keyword">import</span> java.util.Properties;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionLink</span> {  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Properties properties;  
  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getProperties</span><span class="hljs-params">()</span> {  
        <span class="hljs-keyword">if</span> (properties != <span class="hljs-literal">null</span>) {  
            <span class="hljs-keyword">return</span> properties;  
        }        <span class="hljs-comment">// 加载 resources 文件下的资源  </span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> ConnectionLink.class.getResourceAsStream(<span class="hljs-string">"/database.properties"</span>)) {  
            properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();  
            properties.load(stream);  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  
        }        <span class="hljs-keyword">return</span> properties;  
  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {  
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> getProperties();  
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> properties.getProperty(<span class="hljs-string">"database.url"</span>);  
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> properties.getProperty(<span class="hljs-string">"database.password"</span>);  
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> properties.getProperty(<span class="hljs-string">"database.user"</span>);  
        <span class="hljs-keyword">return</span> DriverManager.getConnection(url, user, password);  
    }  
}
</code></pre>
<h3 data-id="heading-3">项目结构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/872e80a011364e7199381c3a38ccef6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=zeP6grxVpTJ7D6urlN%2BhoKlD%2FwQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">连接数据库步骤</h2>
<p>Java使用数据库通常有以下五个步骤</p>
<ol>
<li>加载数据库驱动</li>
<li>连接数据库</li>
<li>创建Statement对象</li>
<li>执行SQL并处理结果</li>
<li>关闭连接并释放资源</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.io.InputStream;  
<span class="hljs-keyword">import</span> java.sql.Connection;  
<span class="hljs-keyword">import</span> java.sql.DriverManager;  
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;  
<span class="hljs-keyword">import</span> java.sql.ResultSet;  
<span class="hljs-keyword">import</span> java.util.Properties;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UseDatabase</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-comment">// 加载postgresql数据库驱动  </span>
        Class.forName(<span class="hljs-string">"org.postgresql.Driver"</span>);  
        <span class="hljs-comment">// 建立数据库连接  </span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> ConnectionLink.getConnection();  
        System.out.println(connection.getMetaData().getJDBCMajorVersion());  
        <span class="hljs-comment">// 创建执行语句  </span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select version();"</span>);  
        <span class="hljs-comment">// 处理操作结果  </span>
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();  
        <span class="hljs-keyword">while</span> (resultSet.next()) {  
            System.out.println(resultSet.getString(<span class="hljs-number">1</span>));  
        }        <span class="hljs-comment">//关闭数据库连接  </span>
        connection.close();  
    }  
}
</code></pre>
<p>debug <code>java.sql.DriverManager#getConnection(java.lang.String, java.util.Properties, java.lang.Class&lt;?&gt;)</code>中指定的方法，可以看到<strong>registeredDrivers</strong>已经含有了我们的MySQL和Postgresql驱动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147810fe2f864ba0ae902aa7fcdb185b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=i0f7fmYbC4wmEqA2K6hdhRGF%2FeU%3D" alt="image.png" loading="lazy"/></p>
<p>通过迭代来获取对应的Connection连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> aDriver.driver.connect(url, info);
</code></pre>
<p>如果匹配，则返回第一个已经匹配的连接。如Postgresql的实现，第一步匹配url来确认是否匹配当前的Driver：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949d627c9fd34fc2a21188d696a35ce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=h58bm4sB13BW4ayXA2G1vSJA2BU%3D" alt="image.png" loading="lazy"/></p>
<p>在JDBC4.0之后的版本， 可以省略 <code>Class.forName("org.postgresql.Driver");</code>手动加载驱动类的步骤，而是通过SPI实现自动加载驱动类。</p>
<p>既然可以<strong>省略手动加载驱动</strong>的步骤，那么是如何实现的呢？ 答案就在<code>java.sql.DriverManager#ensureDriversInitialized</code> 方法中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60c20f56335144d09f20e69e739cf9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=oU1deBwpwbD5uSaF9RXwiHGnVoI%3D" alt="image.png" loading="lazy"/></p>
<p>核心为下述代码块：</p>
<pre><code class="hljs language-java" lang="java">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);
</code></pre>
<p>这里即为SPI实现代码的入口。详情在[[Java SPI机制|SPI机制]]文章中。在这个内容为什么第一步是<code>Class.forName</code>去加载类，而不是使用 <strong><code>new</code></strong> 创建实例来使用数据呢？</p>
<ul>
<li><code>Class.forName</code>只会加载类并执行静态代码块，并不会直接直接实例化类。</li>
<li>使用**<code>new</code>** 会直接将实现类的对象暴露在我们的代码中，如果我们没有引入对应的依赖则会导致项目编译失败。而<code>Class.forName</code>则不会，只有执行到这一行代码的时候才会抛出<code>ClassNotFoundException</code>异常。实现了解耦。</li>
</ul>
<h2 data-id="heading-5">CURD的基本使用</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.io.InputStream;  
<span class="hljs-keyword">import</span> java.math.BigDecimal;  
<span class="hljs-keyword">import</span> java.sql.*;  
<span class="hljs-keyword">import</span> java.time.LocalDate;  
<span class="hljs-keyword">import</span> java.time.LocalDateTime;  
<span class="hljs-keyword">import</span> java.time.LocalTime;  
<span class="hljs-keyword">import</span> java.util.ArrayList;  
<span class="hljs-keyword">import</span> java.util.List;  
<span class="hljs-keyword">import</span> java.util.Properties;  
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadLocalRandom;  
<span class="hljs-keyword">import</span> java.util.function.Consumer;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurdOptions</span> {  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadLocalRandom</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current();  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> ConnectionLink.getConnection();  
        <span class="hljs-comment">// 创建表  </span>
        createTable(connection);  
        <span class="hljs-comment">// 插入数据  </span>
        insert(connection);  
        <span class="hljs-comment">// 查询数据  </span>
        System.out.println(query(<span class="hljs-number">10</span>, connection));  
        <span class="hljs-comment">// 更新数据  </span>
        update(connection);  
        <span class="hljs-comment">// 删除数据  </span>
        delete(connection);  
        <span class="hljs-comment">// 删除表  </span>
        drop(connection);  
        <span class="hljs-comment">// 创建模式  </span>
        createSchema(connection);  
        connection.close();  
    }  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drop</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();  
        <span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> statement.executeUpdate(<span class="hljs-string">"drop table if exists accounts;"</span>);  
        System.out.println(<span class="hljs-string">"删除表更新的行数："</span> + row);  
        statement.close();  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createSchema</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();  
        <span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> statement.executeUpdate(<span class="hljs-string">"create schema if not exists test;"</span>);  
        System.out.println(<span class="hljs-string">"创建模式返回行数："</span> + row);  
        statement.close();  
    }  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">String</span> <span class="hljs-variable">createSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""  
                create table if not exists accounts                (                    id          integer               not null                        primary key,                    name        varchar(45)           not null,                    balance     numeric(16, 4)        not null,                    access_time timestamp             not null,                    locked      boolean default false not null                );                                                comment on table accounts is '账户表';  
                                                comment on column accounts.name is '账号名称';  
                                                comment on column accounts.balance is '余额';  
                                                comment on column accounts.access_time is '访问时间';  
                                             comment on column accounts.locked is '锁定';  
                """</span>;  
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(createSql);  
        <span class="hljs-type">int</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> statement.executeUpdate();  
        System.out.println(<span class="hljs-string">"创建表影响行数："</span> + update);  
        statement.close();  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {  
        List&lt;Account&gt; accounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {  
            accounts.add(generateAccount(i + <span class="hljs-number">1</span>));  
        }        insert(accounts, connection);  
    }  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(List&lt;Account&gt; accounts, Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {  
        <span class="hljs-keyword">if</span> (accounts == <span class="hljs-literal">null</span> || accounts.size() == <span class="hljs-number">0</span>) {  
            <span class="hljs-keyword">return</span>;  
        }        <span class="hljs-comment">// 插入语句  </span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"insert into accounts(id,name,balance,access_time,locked) values (?,?,?,?,?)"</span>);  
        Consumer&lt;PreparedStatement&gt; consumer;  
        <span class="hljs-type">boolean</span> <span class="hljs-variable">supportsBatchUpdates</span> <span class="hljs-operator">=</span> connection.getMetaData().supportsBatchUpdates();  
        System.out.println(<span class="hljs-string">"支持批量更新："</span> + supportsBatchUpdates);  
        <span class="hljs-comment">// 是否支持批量更新  </span>
        <span class="hljs-keyword">if</span> (supportsBatchUpdates) {  
            consumer = option -&gt; {  
                <span class="hljs-keyword">try</span> {  
                    option.addBatch();  
                } <span class="hljs-keyword">catch</span> (SQLException e) {  
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  
                }            };        } <span class="hljs-keyword">else</span> {  
            consumer = option -&gt; {  
                <span class="hljs-keyword">try</span> {  
                    option.executeUpdate();  
                } <span class="hljs-keyword">catch</span> (SQLException e) {  
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  
                }            };        }  
        connection.setAutoCommit(<span class="hljs-literal">false</span>);  
        <span class="hljs-keyword">try</span> {  
            <span class="hljs-keyword">for</span> (Account account : accounts) {  
                statement.setInt(<span class="hljs-number">1</span>, account.getId());  
                statement.setString(<span class="hljs-number">2</span>, account.getName());  
                statement.setBigDecimal(<span class="hljs-number">3</span>, account.getBalance());  
                statement.setObject(<span class="hljs-number">4</span>, account.getAccessTime());  
                statement.setBoolean(<span class="hljs-number">5</span>, account.getLocked());  
                consumer.accept(statement);  
            }            <span class="hljs-keyword">if</span> (supportsBatchUpdates) {  
                statement.executeBatch();  
            }            connection.commit();  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            connection.rollback();  
        } <span class="hljs-keyword">finally</span> {  
            connection.setAutoCommit(<span class="hljs-literal">true</span>);  
        }        statement.close();  
    }  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Account&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(<span class="hljs-type">int</span> lastId, Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select * from accounts where id &lt; ?"</span>);  
        statement.setInt(<span class="hljs-number">1</span>, lastId);  
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery();  
        List&lt;Account&gt; accounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  
        <span class="hljs-keyword">while</span> (resultSet.next()) {  
            <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> generateAccount(resultSet);  
            accounts.add(account);  
        }        statement.close();  
        <span class="hljs-keyword">return</span> accounts;  
    }  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Account <span class="hljs-title function_">generateAccount</span><span class="hljs-params">(ResultSet resultSet)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>();  
        account.setId(resultSet.getInt(<span class="hljs-number">1</span>));  
        account.setName(resultSet.getString(<span class="hljs-string">"name"</span>));  
        account.setBalance(resultSet.getBigDecimal(<span class="hljs-number">3</span>));  
        account.setAccessTime(resultSet.getObject(<span class="hljs-number">4</span>, LocalDateTime.class));  
        account.setLocked(resultSet.getBoolean(<span class="hljs-number">5</span>));  
        <span class="hljs-keyword">return</span> account;  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Account <span class="hljs-title function_">generateAccount</span><span class="hljs-params">(Integer id)</span> {  
        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>();  
        account.setName(<span class="hljs-string">"测试"</span> + RANDOM.nextDouble(<span class="hljs-number">10.10</span>, <span class="hljs-number">50.99</span>));  
        account.setBalance(BigDecimal.valueOf(RANDOM.nextDouble(<span class="hljs-number">100</span>, <span class="hljs-number">5000</span>)));  
        account.setLocked(RANDOM.nextBoolean());  
        account.setId(id);  
        account.setAccessTime(LocalDateTime.of(LocalDate.of(<span class="hljs-number">2025</span>, <span class="hljs-number">10</span>, RANDOM.nextInt(<span class="hljs-number">1</span>, <span class="hljs-number">31</span>)), LocalTime.of(RANDOM.nextInt(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>), RANDOM.nextInt(<span class="hljs-number">0</span>, <span class="hljs-number">60</span>), RANDOM.nextInt(<span class="hljs-number">0</span>, <span class="hljs-number">60</span>))));  
        <span class="hljs-keyword">return</span> account;  
    }  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select * from accounts where id =1"</span>);  
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery();  
        <span class="hljs-keyword">if</span> (resultSet.next()) {  
            <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> generateAccount(resultSet);  
            System.out.println(<span class="hljs-string">"当前账户数据："</span> + account);  
        }        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">updateStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"update accounts set balance = ? where id = ?"</span>);  
        updateStatement.setBigDecimal(<span class="hljs-number">1</span>, BigDecimal.valueOf(<span class="hljs-number">555</span>));  
        updateStatement.setInt(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> updateStatement.executeUpdate();  
        System.out.println(<span class="hljs-string">"更新行数："</span> + i);  
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">updateResult</span> <span class="hljs-operator">=</span> statement.executeQuery();  
        <span class="hljs-keyword">if</span> (updateResult.next()) {  
            <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> generateAccount(updateResult);  
            System.out.println(<span class="hljs-string">"当前账户数据："</span> + account);  
        }        statement.close();  
        updateStatement.close();  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"delete  from accounts where id &gt; -1"</span>);  
        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> statement.executeUpdate();  
        System.out.println(<span class="hljs-string">"删除行数："</span> + rows);  
        statement.close();  
    }  
}
</code></pre>
<p>Postgresql数据库有模式的概念。MySQL 中 schema 就是 database，也就是没有物理上的模式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"insert into accounts(id,name,balance,access_time,locked) values (?,?,?,?,?)"</span>);
</code></pre>
<p>上述代码创建了一个<strong>预备语句</strong>，通过占位符<code>?</code>来填充我们所需要的参数值，从而达到多次重用的的目的。对于需要填充的SQL建议使用 <code>PreparedStatement</code>而不是 <code>Statement</code>，避免SQL注入风险。如果不需要填充参数，直接使用 <code>Statement</code>对象即可。</p>
<p>占位符<code>?</code>通过 <code>PreparedStatement</code>的<code>setXxx()</code>方法来设置，如Int类型是<code>setInt</code>来设置值，如果没有对应的类型，则使用 <code>setObject()</code>方法来填充。 <strong>占位符从1开始计算</strong>。</p>
<p>对于 <code>select</code>语句，需要执行 <code>executeQuery()</code>方法获取 ResultSet 结果集。
对于 <code>insert</code>、 <code>update</code>、<code>delete</code>、<code>create</code>、<code>drop</code>等执行 <code>executeUpdate()</code>返回影响的行数。</p>
<p><strong>注意的是</strong>：<code>create</code>、<code>drop</code>执行的是表结构而不是数据，<strong>所以返回的影响行数都为0</strong>。</p>
<h3 data-id="heading-6">ResultSet结果集</h3>
<p>查看以下<code>query()</code>例子，ResultSet 通过 <code>next()</code>方法来移动到下一行，<strong>移动到第一行时，需要执行一次 <code>next()</code>方法。</strong> 同类似<code>PreparedStatement</code>类型，根据返回数据的对应的列使用对应的<code>getXxx</code>方法，没有对应的类型则使用<code>getObject</code>来获取，如 <code>LocalDateTime</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Account <span class="hljs-title function_">generateAccount</span><span class="hljs-params">(ResultSet resultSet)</span> <span class="hljs-keyword">throws</span> Exception {  
    <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>();  
    account.setId(resultSet.getInt(<span class="hljs-number">1</span>));  
    account.setName(resultSet.getString(<span class="hljs-string">"name"</span>));  
    account.setBalance(resultSet.getBigDecimal(<span class="hljs-number">3</span>));  
    account.setAccessTime(resultSet.getObject(<span class="hljs-number">4</span>, LocalDateTime.class));  
    account.setLocked(resultSet.getBoolean(<span class="hljs-number">5</span>));  
    <span class="hljs-keyword">return</span> account;  
}
</code></pre>
<p><strong>获取指定列同样也是从1起始</strong>，除了获取列索引，还提供了根据<strong>列名称</strong>匹配列值，如：</p>
<ul>
<li><code>String getString(String columnLabel) throws SQLException;</code></li>
<li><code>String getString(String columnLabel) throws SQLException;</code></li>
<li><code>&lt;T&gt; T getObject(int columnIndex, Class&lt;T&gt; type) throws SQLException;</code></li>
<li><code>&lt;T&gt; T getObject(String columnLabel, Class&lt;T&gt; type) throws SQLException;</code></li>
</ul>
<h2 data-id="heading-7">事务</h2>
<blockquote>
<p>[!info] 事务是单个原子命令的命令组合，要么全部成功或全部失败。在事务完成之前对其他会话不可见。事务有ACID4个特性：</p>
<ul>
<li>Atomicity: 原子性，所有操作要么作为单个单元完成，要么一个都不完成。如果事务执行期间出现系统故障，会没有部分结果，恢复后可见。</li>
<li>Consistency: 一致性，数据库中的数据始终符合完整性约束的性质。事务可能允许在提交之前违反一些约束，但是如果在发生时仍然没有解决则会自动回滚。</li>
<li>Isolation: 隔离性，事务在提交之前对并发事务不可见的属性。</li>
<li>Durability: 持久性，一旦事务被提交完成，即使系统故障和崩溃之后，更改仍然存在。</li>
</ul>
</blockquote>
<p>默认情况下，JDBC的数据连接处于自动提交模式(atuocommit mode)，即每个SQL一旦被执行就直接提交到数据库，无法对已经修改的数据进行回滚。通过 <code>getAutoCommit()</code> 获取当前数据库连接的提交模式</p>
<pre><code class="hljs language-java" lang="java">System.out.println(<span class="hljs-string">"是否自动提交："</span> + connection.getAutoCommit());
</code></pre>
<p>在使用事务时候，将这个默认值设置为false，即:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置不自动提交  </span>
connection.setAutoCommit(<span class="hljs-literal">false</span>);
</code></pre>
<p><strong>注意：无论执行的事务是否成功，都需要将当前连接修改回<code>自动提交</code>模式，避免后续其他SQL语句执行出现问题。</strong></p>
<h3 data-id="heading-8">示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.io.InputStream;  
<span class="hljs-keyword">import</span> java.math.BigDecimal;  
<span class="hljs-keyword">import</span> java.sql.*;  
<span class="hljs-keyword">import</span> java.util.*;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionOptions</span> {  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
  
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> ConnectionLink.getConnection();  
        System.out.println(<span class="hljs-string">"是否自动提交："</span> + connection.getAutoCommit());  
        CurdOptions.createTable(connection);  
        List&lt;Account&gt; accounts = CurdOptions.query(<span class="hljs-number">100</span>, connection);  
        Set&lt;Integer&gt; idSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();  
        idSet.add(<span class="hljs-number">88</span>);  
        idSet.add(<span class="hljs-number">99</span>);  
        accounts.forEach(item -&gt; idSet.remove(item.getId()));  
        List&lt;Account&gt; accountInsertList = idSet.stream().map(CurdOptions::generateAccount).toList();  
        <span class="hljs-comment">// 插入没有的88，99数据  </span>
        CurdOptions.insert(accountInsertList, connection);  
  
        <span class="hljs-comment">// 设置不自动提交  </span>
        connection.setAutoCommit(<span class="hljs-literal">false</span>);  
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"update accounts set balance = ? where id = ?"</span>);  
        <span class="hljs-keyword">try</span> {  
            <span class="hljs-comment">// 提交成功  </span>
            preparedStatement.setBigDecimal(<span class="hljs-number">1</span>, BigDecimal.valueOf(<span class="hljs-number">90.56</span>));  
            preparedStatement.setInt(<span class="hljs-number">2</span>, <span class="hljs-number">88</span>);  
            System.out.println(<span class="hljs-string">"更新影响行数："</span> + preparedStatement.executeUpdate());  
            <span class="hljs-comment">// 提交失败  </span>
<span class="hljs-comment">//            preparedStatement.setBigDecimal(1, BigDecimal.valueOf(310.56));  </span>
            preparedStatement.setBigDecimal(<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>);  
            preparedStatement.setInt(<span class="hljs-number">2</span>, <span class="hljs-number">99</span>);  
            System.out.println(<span class="hljs-string">"更新影响行数："</span> + preparedStatement.executeUpdate());  
            connection.commit();  
            System.out.println(<span class="hljs-string">"提交成功..."</span>);  
  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            connection.rollback();  
            System.out.println(<span class="hljs-string">"回滚..."</span>);  
        } <span class="hljs-keyword">finally</span> {  
            <span class="hljs-comment">// 恢复自动提交  </span>
            connection.setAutoCommit(<span class="hljs-literal">true</span>);  
        }        connection.close();  
    }}
</code></pre>
<p>可以看到，通过设置<code>connection.setAutoCommit(false);</code>不启用默认提交。使用<code>connection.commit();</code>进行手动提交。</p>
<p>如果注释掉<code>connection.setAutoCommit(false)</code>，那么第一个<code>executeUpdate</code>将会执行，同时发生错误并不会回滚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50f09694687d4ed48ed7573f957823f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=mXoc3lRY0qJx8X5xxJeNbocVrrI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">保存点</h3>
<blockquote>
<p>[!info] 保存点(save point)是数据库提供可以更细粒度地控制回滚操作操作的机制。
创建一个保存点，意味着在执行事务失败的时候，我们可以回滚到这个保存点，而不是放弃整个事务。</p>
</blockquote>
<p>下面代码为保存两条插入数据，后续的两条数据丢弃。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SavePointOptions</span> {  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
  
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> ConnectionLink.getConnection();  
        CurdOptions.createTable(connection);  
        <span class="hljs-comment">// 清空数据  </span>
        CurdOptions.delete(connection);  
        List&lt;Account&gt; accounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  
        accounts.add(CurdOptions.generateAccount(<span class="hljs-number">134</span>));  
        <span class="hljs-type">int</span> <span class="hljs-variable">savePointId</span> <span class="hljs-operator">=</span> <span class="hljs-number">135</span>;  
        accounts.add(CurdOptions.generateAccount(savePointId));  
        <span class="hljs-type">Account</span> <span class="hljs-variable">account2</span> <span class="hljs-operator">=</span> CurdOptions.generateAccount(<span class="hljs-number">136</span>);  
        <span class="hljs-comment">// 该字段不能为空，插入会报错  </span>
        account2.setBalance(<span class="hljs-literal">null</span>);  
        accounts.add(account2);  
        accounts.add(CurdOptions.generateAccount(<span class="hljs-number">137</span>));  
        <span class="hljs-comment">// 插入语句  </span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"insert into accounts(id,name,balance,access_time,locked) values (?,?,?,?,?)"</span>);  
        connection.setAutoCommit(<span class="hljs-literal">false</span>);  
        <span class="hljs-type">Savepoint</span> <span class="hljs-variable">savepoint</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  
        <span class="hljs-keyword">try</span> {  
            <span class="hljs-keyword">for</span> (Account account : accounts) {  
                statement.setInt(<span class="hljs-number">1</span>, account.getId());  
                statement.setString(<span class="hljs-number">2</span>, account.getName());  
                statement.setBigDecimal(<span class="hljs-number">3</span>, account.getBalance());  
                statement.setObject(<span class="hljs-number">4</span>, account.getAccessTime());  
                statement.setBoolean(<span class="hljs-number">5</span>, account.getLocked());  
                statement.addBatch();  
                <span class="hljs-keyword">if</span> (account.getId() == savePointId) {  
                    statement.executeBatch();  
                    savepoint = connection.setSavepoint();  
                }            }            statement.executeBatch();  
            connection.commit();  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            <span class="hljs-keyword">if</span> (savepoint != <span class="hljs-literal">null</span>) {  
                connection.rollback(savepoint);  
                System.out.println(<span class="hljs-string">"回滚到保存点"</span>);  
                <span class="hljs-comment">// 释放保存点  </span>
                connection.releaseSavepoint(savepoint);  
            } <span class="hljs-keyword">else</span> {  
                connection.rollback();  
                System.out.println(<span class="hljs-string">"全部回滚"</span>);  
            }        } <span class="hljs-keyword">finally</span> {  
            connection.setAutoCommit(<span class="hljs-literal">true</span>);  
        }        System.out.println(CurdOptions.query(<span class="hljs-number">140</span>, connection));  
        connection.close();  
    }}
</code></pre>
<h3 data-id="heading-10">Connection 部分API</h3>

























<table><thead><tr><th>API</th><th>描述</th></tr></thead><tbody><tr><td><code>getSchema</code></td><td>返回当前模式的名称，没有则返回null</td></tr><tr><td><code>getCatalog</code></td><td>返回当前数据库名称，如果没有则返回null</td></tr><tr><td><code>isReadOnly</code></td><td>当前连接是否只读模式，true为启用，false为禁用</td></tr><tr><td><code>setReadOnly</code></td><td>设置只读模式</td></tr></tbody></table>
<h2 data-id="heading-11">元数据，自动化构建实体类</h2>
<blockquote>
<p>[!info]  DatabaseMetaData 是一个获取数据库整体的全面信息的接口，即元数据接口。
诸如 MyBatis-Plus 代码生成器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbaomidou.com%2Fguides%2Fnew-code-generator%2F" target="_blank" title="https://baomidou.com/guides/new-code-generator/" ref="nofollow noopener noreferrer">代码生成器 | MyBatis-Plus</a> ，根据这个接口提供的API，我们可以实现类似该功能的个人数据库代码生成器模板。</p>
</blockquote>
<h3 data-id="heading-12">示例<a id="user-content-section1" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.math.BigDecimal;  
<span class="hljs-keyword">import</span> java.sql.Types;  
<span class="hljs-keyword">import</span> java.time.LocalDate;  
<span class="hljs-keyword">import</span> java.time.LocalDateTime;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/3  
 */</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">JdbcType</span> {  
    <span class="hljs-comment">/**  
     * 数据库类型与Java 类型映射  
       简单的例子
     */</span>  
    LOCAL_DATE_TIME(Types.TIMESTAMP, LocalDateTime.class),  
    VARCHAR(Types.VARCHAR, String.class),  
    CHAR(Types.CHAR, String.class),  
    BIT(Types.BIT, Boolean.class),  
    LOCAL_DATE(Types.DATE, LocalDate.class),  
    DECIMAL(Types.DECIMAL, BigDecimal.class),  
    BOOLEAN(Types.BOOLEAN, Boolean.class),  
    NUMERIC(Types.NUMERIC, BigDecimal.class),  
    INTEGER(Types.INTEGER, Integer.class);  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> type;  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz;  
  
    JdbcType(<span class="hljs-type">int</span> type, Class&lt;?&gt; clazz) {  
        <span class="hljs-built_in">this</span>.type = type;  
        <span class="hljs-built_in">this</span>.clazz = clazz;  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JdbcType <span class="hljs-title function_">getJavaType</span><span class="hljs-params">(<span class="hljs-type">int</span> dataType)</span> {  
        <span class="hljs-keyword">for</span> (JdbcType value : JdbcType.values()) {  
            <span class="hljs-keyword">if</span> (value.type == dataType) {  
                <span class="hljs-keyword">return</span> value;  
            }        }        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"没有指定对应Java类型："</span> + dataType);  
    }  
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> {  
        <span class="hljs-keyword">return</span> type;  
    }  
    <span class="hljs-keyword">public</span> Class&lt;?&gt; getClazz() {  
        <span class="hljs-keyword">return</span> clazz;  
    }}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;  
<span class="hljs-keyword">import</span> lombok.Data;  
  
<span class="hljs-keyword">import</span> java.io.File;  
<span class="hljs-keyword">import</span> java.io.FileOutputStream;  
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;  
<span class="hljs-keyword">import</span> java.sql.Connection;  
<span class="hljs-keyword">import</span> java.sql.DatabaseMetaData;  
<span class="hljs-keyword">import</span> java.sql.ResultSet;  
<span class="hljs-keyword">import</span> java.time.LocalDate;  
<span class="hljs-keyword">import</span> java.util.*;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/2  
 */</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoGenerateClass</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
        <span class="hljs-type">String</span> <span class="hljs-variable">targetTable</span> <span class="hljs-operator">=</span> <span class="hljs-string">"accounts"</span>;  
  
        <span class="hljs-comment">// 获取当前项目目录  </span>
        <span class="hljs-type">String</span> <span class="hljs-variable">currentUserDir</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"user.dir"</span>);  
        <span class="hljs-comment">// 如果没有建立 database-link 子模块，可以省略该路径 </span>
        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">"database-link"</span> + File.separator + <span class="hljs-string">"src"</span> + File.separator + <span class="hljs-string">"main"</span> + File.separator + <span class="hljs-string">"java"</span>;  
        <span class="hljs-comment">// 指定的包下  </span>
        <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.polaris.database.link.gen"</span>;  
        <span class="hljs-type">String</span> <span class="hljs-variable">packagePath</span> <span class="hljs-operator">=</span> packageName.replace(<span class="hljs-string">"."</span>, File.separator);  
  
        <span class="hljs-type">String</span> <span class="hljs-variable">absolutePath</span> <span class="hljs-operator">=</span> currentUserDir + File.separator + path + File.separator + packagePath;  
        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(absolutePath);  
        <span class="hljs-keyword">if</span> (!file.exists()) {  
            <span class="hljs-type">boolean</span> <span class="hljs-variable">mkdir</span> <span class="hljs-operator">=</span> file.mkdir();  
            System.out.println(<span class="hljs-string">"创建目录 "</span> + file.getName() + <span class="hljs-string">"："</span> + mkdir);  
        }  
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> ConnectionLink.getConnection();  
        System.out.println(connection.getSchema());  
        System.out.println(connection.getCatalog());  
        <span class="hljs-type">DatabaseMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> connection.getMetaData();  
  
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> metaData.getTables(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"TABLE"</span>});  
  
        Map&lt;String, Set&lt;Class&lt;?&gt;&gt;&gt; tableDependMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);  
        Map&lt;String, List&lt;TypeInfo&gt;&gt; tableFieldMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);  
  
        <span class="hljs-keyword">while</span> (resultSet.next()) {  
            <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"TABLE_NAME"</span>);  
            <span class="hljs-keyword">if</span> (!targetTable.equals(tableName)) {  
                <span class="hljs-keyword">continue</span>;  
            }            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> snakeCaseToLowerCameCase(tableName, <span class="hljs-literal">true</span>);  
            <span class="hljs-comment">// 获取指定表中的数据  </span>
            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">columns</span> <span class="hljs-operator">=</span> metaData.getColumns(<span class="hljs-literal">null</span>, resultSet.getString(<span class="hljs-number">2</span>), tableName, <span class="hljs-literal">null</span>);  
            Set&lt;Class&lt;?&gt;&gt; set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();  
            List&lt;TypeInfo&gt; fields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  
            <span class="hljs-keyword">while</span> (columns.next()) {  
                <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> columns.getString(<span class="hljs-string">"COLUMN_NAME"</span>);  
                <span class="hljs-type">int</span> <span class="hljs-variable">dataType</span> <span class="hljs-operator">=</span> columns.getInt(<span class="hljs-string">"DATA_TYPE"</span>);  
                <span class="hljs-type">String</span> <span class="hljs-variable">remarks</span> <span class="hljs-operator">=</span> columns.getString(<span class="hljs-string">"REMARKS"</span>);  
                <span class="hljs-type">JdbcType</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> JdbcType.getJavaType(dataType);  
                set.add(javaType.getClazz());  
                <span class="hljs-type">String</span> <span class="hljs-variable">cameCase</span> <span class="hljs-operator">=</span> snakeCaseToLowerCameCase(columnName, <span class="hljs-literal">false</span>);  
                fields.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeInfo</span>(cameCase, javaType.getClazz(), remarks));  
            }            tableDependMap.put(fileName, set);  
            tableFieldMap.put(fileName, fields);  
        }        connection.close();  
  
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Set&lt;Class&lt;?&gt;&gt;&gt; entry : tableDependMap.entrySet()) {  
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  
            <span class="hljs-comment">// 写入表头  </span>
            builder.append(<span class="hljs-string">"package "</span>).append(packageName).append(<span class="hljs-string">";"</span>).append(<span class="hljs-string">"\n\n"</span>);  
            <span class="hljs-keyword">for</span> (Class&lt;?&gt; aClass : entry.getValue()) {  
                builder.append(<span class="hljs-string">"import "</span>).append(aClass.getName()).append(<span class="hljs-string">";\n"</span>);  
            }            builder.append(<span class="hljs-string">"\n\n"</span>);  
            builder.append(<span class="hljs-string">"/**\n"</span>)  
                    .append(<span class="hljs-string">"* @author DawnStar\n"</span>)  
                    .append(<span class="hljs-string">"* @since "</span>).append(LocalDate.now()).append(<span class="hljs-string">"\n"</span>)  
                    .append(<span class="hljs-string">"*/\n"</span>);  
  
            builder.append(<span class="hljs-string">"public class "</span>).append(entry.getKey()).append(<span class="hljs-string">" {\n\n"</span>);  
            <span class="hljs-comment">// 添加 属性  </span>
            List&lt;TypeInfo&gt; typeInfoList = tableFieldMap.getOrDefault(entry.getKey(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());  
            <span class="hljs-keyword">for</span> (TypeInfo typeInfo : typeInfoList) {  
                builder.append(generateField(typeInfo.getFieldName(), typeInfo.getType(), typeInfo.getRemark())).append(<span class="hljs-string">"\n"</span>);  
            }  
            <span class="hljs-comment">// 添加 get set            for (TypeInfo typeInfo : typeInfoList) {  </span>
                <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> snakeCaseToLowerCameCase(typeInfo.getFieldName(), <span class="hljs-literal">true</span>);  
                builder.append(<span class="hljs-string">"\n"</span>);  
                <span class="hljs-comment">// get  </span>
                builder.append(<span class="hljs-string">"    public "</span>).append(typeInfo.getType().getSimpleName()).append(<span class="hljs-string">" get"</span>).append(methodName).append(<span class="hljs-string">"() {\n"</span>);  
                builder.append(<span class="hljs-string">"        return this."</span>).append(typeInfo.getFieldName()).append(<span class="hljs-string">";\n"</span>);  
                builder.append(<span class="hljs-string">"    }"</span>);  
  
                <span class="hljs-comment">// set  </span>
  
                builder.append(<span class="hljs-string">"\n\n"</span>);  
  
                builder.append(<span class="hljs-string">"    public void set"</span>).append(methodName).append(<span class="hljs-string">"("</span>).append(typeInfo.getType().getSimpleName()).append(<span class="hljs-string">" "</span>).append(typeInfo.getFieldName()).append(<span class="hljs-string">") {\n"</span>);  
                builder.append(<span class="hljs-string">"        this."</span>).append(typeInfo.getFieldName()).append(<span class="hljs-string">" = "</span>).append(typeInfo.getFieldName()).append(<span class="hljs-string">";\n"</span>);  
                builder.append(<span class="hljs-string">"    }\n"</span>);  
  
            }  
            builder.append(<span class="hljs-string">"}"</span>);  
            <span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(absolutePath + File.separator + entry.getKey() + <span class="hljs-string">".java"</span>)) {  
                stream.write(builder.toString().getBytes(StandardCharsets.UTF_8));  
            }        }  
  
    }  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">snakeCaseToLowerCameCase</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> firstUpper)</span> {  
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  
        <span class="hljs-type">char</span>[] chars = name.toCharArray();  
        <span class="hljs-keyword">if</span> (firstUpper) {  
            chars[<span class="hljs-number">0</span>] = String.valueOf(chars[<span class="hljs-number">0</span>]).toUpperCase().charAt(<span class="hljs-number">0</span>);  
        }        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chars.length; i++) {  
            <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> chars[i] == <span class="hljs-string">'_'</span> &amp;&amp; (i != chars.length - <span class="hljs-number">1</span> || i == <span class="hljs-number">0</span>);  
            <span class="hljs-keyword">if</span> (b) {  
                chars[i + <span class="hljs-number">1</span>] = String.valueOf(chars[i + <span class="hljs-number">1</span>]).toUpperCase().charAt(<span class="hljs-number">0</span>);  
                <span class="hljs-keyword">continue</span>;  
            }            builder.append(chars[i]);  
        }        <span class="hljs-keyword">return</span> builder.toString();  
    }  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateField</span><span class="hljs-params">(String column, Class&lt;?&gt; classType, String remark)</span> {  
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  
        <span class="hljs-keyword">if</span> (Objects.nonNull(remark) &amp;&amp; !remark.isEmpty() &amp;&amp; !remark.isBlank()) {  
            builder.append(<span class="hljs-string">"    /**"</span>).append(<span class="hljs-string">"\n"</span>);  
            builder.append(<span class="hljs-string">"    * "</span>).append(remark).append(<span class="hljs-string">"\n"</span>);  
            builder.append(<span class="hljs-string">"    */"</span>).append(<span class="hljs-string">"\n"</span>);  
        }        builder.append(<span class="hljs-string">"    private "</span>)  
                .append(classType.getSimpleName()).append(<span class="hljs-string">" "</span>)  
                .append(column).append(<span class="hljs-string">";"</span>);  
        <span class="hljs-keyword">return</span> builder.toString();  
    }  
    <span class="hljs-meta">@Data</span>  
    <span class="hljs-meta">@AllArgsConstructor</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeInfo</span> {  
        <span class="hljs-keyword">private</span> String fieldName;  
        <span class="hljs-keyword">private</span> Class&lt;?&gt; type;  
        <span class="hljs-keyword">private</span> String remark;  
    }  
}
</code></pre>
<p>效果如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f8005f6cfa54c05a95cf1f8ffa9fca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=ujm4PdvYiaxF1caP65os2ye%2F5rs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">DatabaseMetaData API</h3>
<p>在上面的示例中，用到了<code>DatabaseMetaData</code>中的<code>getTables</code>和<code>getColumns</code>方法。它们都会返回一个 <strong>ResultSet</strong>对象，这里直接运用<a href="#ResultSet%E7%BB%93%E6%9E%9C%E9%9B%86" title="#ResultSet%E7%BB%93%E6%9E%9C%E9%9B%86">ResultSet 结果集</a>的知识，获取我们所需要的数据。如 <code>getTables</code>中的ResultSet对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> metaData.getTables(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"TABLE"</span>});
</code></pre>
<p>获取每行表描述数据的表名称：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"TABLE_NAME"</span>);
</code></pre>
<p><strong>为什么是<code>TABLE_NAME</code>标签</strong>，进入<code>getTables</code>方法定义中，可以看到其对应的注释，该方法返回表描述的10个字段，其中`TABLE_NAME则是表名称。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13743f98f754ac88934d6597041ac11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=05hX1uyZFAWyb1U%2Bpv%2FaSKjVx8E%3D" alt="image.png" loading="lazy"/></p>
<p>可以看出，`TABLE_NAME在第三列，我们同样可以使用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-number">3</span>);
</code></pre>
<p>来获取表名称。注释中每一列都有标有其对应数据类型，我们根据对应的数据类型选择 <strong><code>getXxx</code>方法</strong>。</p>
<p><code>getTables</code>方法有四个入参：</p>

























<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>catalog</td><td>目录名称，<code>""</code>检索没有目录的内容，<code>null</code>表示该属性不用于查询</td></tr><tr><td>schemePattern</td><td>模式，<code>""</code>检索没有模式的内容，<code>null</code>表示该属性不用于查询</td></tr><tr><td>tableNamePattern</td><td>表名称，<code>null</code>表示该属性不用于查询</td></tr><tr><td>types</td><td>表类型，<code>null</code>表示该属性不用于查询</td></tr></tbody></table>
<p><code>schemePattern</code> 和 <code>tableNamePattern</code>都可以使用SQL中的 <code>%</code>和<code>_</code> 做模糊匹配查询。<code>catalog</code>则是全匹配。</p>
<p><code>types[]</code>对应的类型数据可以从DatabaseMetaData的 <strong><code>ResultSet getTableTypes() throws SQLException;</code></strong> 中获取，典型的类型有  <strong>"TABLE", "VIEW", "SYSTEM TABLE", "GLOBAL TEMPORARY", "LOCAL TEMPORARY", "ALIAS", "SYNONYM"</strong>。</p>
<h4 data-id="heading-14">Postgresql与MySQL的差异化</h4>
<p><code>catalog</code> 和 <code>schemePattern</code> 不同的数据库会有不同的实现。Postgresql有模式的概念，而MySQL则没有。PgDatabaseMetaData 不会使用到<code>catalog</code>参数，下图对应的参数在其实现上并没有使用，所以传入什么都是无效的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d86b4a884524dbf8153f507e36105af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=k45r%2BNWRyMEMTBMeD9eICHR43Dc%3D" alt="image.png" loading="lazy"/></p>
<p>而MySQL无论不会特定区分这两种类型，无论是 <code>catalog</code>还是 <code>schemePattern</code>，最终都是<strong>TABLE_SCHEMA</strong> 区别在于是否可以模糊匹配。 <code>catalog</code>是全匹配，在<code>com.mysql.cj.jdbc.DatabaseMetaDataUsingInfoSchema</code>中下述代码可以得出</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5d35d6b3e974b6882bf3f38908469c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=2xBDb13piTnY32DIxDDTqvp95Iw%3D" alt="image.png" loading="lazy"/></p>
<p>至于是选择哪个，在<code>com.mysql.cj.jdbc.DatabaseMetaData</code>的代码有判断，默认是<code>CATALOG</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33c082f5d2c64d50a8c35b1994c157a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=uUh%2BLC%2B16StKZC6GPlYUQdkgZ1c%3D" alt="image.png" loading="lazy"/></p>
<p>如果想使用的是 <code>SCHEMA</code>，可以在URL路径下填写：</p>
<pre><code class="hljs language-properties" lang="properties">jdbc:mysql://192.168.153.132:3306/learn?databaseTerm=SCHEMA
</code></pre>
<p>连接输出的结果也会有所变化</p>
<pre><code class="hljs language-java" lang="java">System.out.println(connection.getSchema());  
System.out.println(connection.getCatalog());
</code></pre>
<h4 data-id="heading-15">Jdbc类型与Java类型的对应关系</h4>
<p>接上 <strong><code>getTables</code></strong>  解析， 同理可得：<code>getColumns</code>方法参数：</p>

























<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>catalog</td><td>目录名称，<code>""</code>检索没有目录的内容，<code>null</code>表示该属性不用于查询</td></tr><tr><td>schemePattern</td><td>模式，<code>""</code>检索没有模式的内容，<code>null</code>表示该属性不用于查询</td></tr><tr><td>tableNamePattern</td><td>表名称，<code>null</code>表示该属性不用于查询</td></tr><tr><td>columnNamePattern</td><td>列名称，<code>null</code>表示该属性不用于查询</td></tr></tbody></table>
<p><code>getColumns</code> 返回的 ResulSet 对象每一行有24个字段，其中前几个字段如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36df0b16d2a7420fa7ea12de5d86dba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=oBk3rZEebiuSM2LWc0oaudUieV4%3D" alt="image.png" loading="lazy"/></p>
<p>返回的数据中，我们可以根据<code>TABLE_NAME</code>获取当前column所属的表名称，<code>COLUMN_NAME</code>获取当前列的名称。<code>DATA_TYPE</code>获取字段类型的int值，<code>TYPE_NAME</code>则是获取字段类型在数据库中对应的字符串名称，如 VARCHAR等。</p>
<p>我们根据 <code>resultSet.getInt("DATA_TYPE")</code>获取字段的类型值，其对应关系在<code>java.sql.Types</code>类中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e652e51a242b491ab240a2b03853ecf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=QIuKJfXky0ZhGVDZNrmNxyI7ua0%3D" alt="image.png" loading="lazy"/></p>
<p>下面是Postgresql 中对应的数据类型，<strong>值得注意的是，在开发过程中，我们会使用JSON数据类型，在Postgresql中，其JSON对于的Java类型为其提供的<code>org.postgresql.util.PGobject</code></strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b66def03f7b34274b15106e959e3fd82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=VbZD8Mkb%2FTZ%2B8PeQDT9QmofPcCI%3D" alt="image.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 插入修改json类型数据</span>
<span class="hljs-type">PGobject</span> <span class="hljs-variable">pGobject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PGobject</span>();  
pGobject.setType(<span class="hljs-string">"json"</span>);  
pGobject.setValue(<span class="hljs-string">"Jackson、FastJson、Gson格式化的对象字符串"</span>);  
statement.setObject(<span class="hljs-number">1</span>,pGobject);
...

<span class="hljs-comment">// 获取json字段值，直接使用getString即可</span>
statement.getString(<span class="hljs-number">1</span>);
...
</code></pre>
<p>我们可以自定义创建对应的映射关系，如本节示例中的 <a href="#section1" title="#section1">JdbcType</a></p>
<h3 data-id="heading-16">示例中优化的点</h3>
<p>在这个示例中，一共执行了 <code>1+ 表的数量</code>次Sql。我们可以根据:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ResultSet</span> <span class="hljs-variable">columns</span> <span class="hljs-operator">=</span> metaData.getColumns(<span class="hljs-literal">null</span>, resultSet.getString(<span class="hljs-number">2</span>),<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
</code></pre>
<p>获取需要的列数据，然后通过<code>resultSet.getString("TABLE_NAME")</code>获取表名，根据表名对列进行分类，再生成类，这样就只需要查询一次数据库即可。</p>
<h2 data-id="heading-17">建立数据库连接为什么耗资源</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.polaris.database.link;  
  
<span class="hljs-keyword">import</span> java.io.InputStream;  
<span class="hljs-keyword">import</span> java.sql.Connection;  
<span class="hljs-keyword">import</span> java.sql.DriverManager;  
<span class="hljs-keyword">import</span> java.time.Duration;  
<span class="hljs-keyword">import</span> java.time.Instant;  
<span class="hljs-keyword">import</span> java.util.Properties;  
  
<span class="hljs-comment">/**  
 * <span class="hljs-doctag">@author</span> DawnStar  
 * <span class="hljs-doctag">@since</span> 2025/11/1  
 */</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionConsumesTime</span> {  
  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {  
        Properties properties;  
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> ConnectionConsumesTime.class.getResourceAsStream(<span class="hljs-string">"/database.properties"</span>)) {  
            properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();  
            properties.load(stream);  
        }        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"database.url"</span>;  
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"database.password"</span>;  
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">"database.user"</span>;  
        <span class="hljs-type">Instant</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Instant.now();  
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(properties.getProperty(url), properties.getProperty(user), properties.getProperty(password));  
        System.out.println(Duration.between(start, Instant.now()).toMillis() + <span class="hljs-string">" ms"</span>);  
        <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> System.in.read();  
        <span class="hljs-type">Instant</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> Instant.now();  
        connection.close();  
        <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> Duration.between(start1, Instant.now()).toNanos();  
        System.out.println(nanos + <span class="hljs-string">" ns"</span>);  
        System.out.println(nanos / (<span class="hljs-type">double</span>) <span class="hljs-number">1000</span> + <span class="hljs-string">" us"</span>);  
        System.out.println(nanos / (<span class="hljs-type">double</span>) <span class="hljs-number">1000</span> / <span class="hljs-number">1000</span> + <span class="hljs-string">" ms"</span>);  
    }}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8cdc153eb3d46e18a94fb0031d615dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=lYuuVGEL%2BS6%2BzdbZ2Q%2BEBO7eNZA%3D" alt="image.png" loading="lazy"/></p>
<p>通过 <code>int read = System.in.read();</code> 暂停一下，然后输入数字执行关闭数据库连接。
通过使用Wireshark软件进行抓包，可以看出：</p>
<ul>
<li>建立数据库连接的耗时为：<code>952-810=142 ms</code>。</li>
<li>关闭数据库连接的耗时为：<code>375-274=1 ms</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3de1c9d02f6411185012752ff53ccd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouC5pmT6ZO256C-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763655062&amp;x-signature=1LiMp9KT0r5FSXwVMiFZ7M6%2BTtg%3D" alt="image.png" loading="lazy"/></p>
<p>建立连接受网络，硬件等影响，每次建立连接和关闭连接的耗时会有所偏差。以本次的耗时为例。如果10万次请求数据库，那么在建立连接和关闭连接的总耗时为 <code>143*100000/1000/60/60 ≈ 3.97 h</code>。</p>
<p>所以数据连接是非常耗资源的行为。我们有必要使用<strong>数据库连接池(pool)</strong> 来重复使用连接。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[239. Java 集合 - 通过 Set、SortedSet 和 NavigableSet 扩展 Collection 接口]]></title>    <link>https://juejin.cn/post/7572086215027818538</link>    <guid>https://juejin.cn/post/7572086215027818538</guid>    <pubDate>2025-11-14T01:07:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572086215027818538" data-draft-id="7572052559822028806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="239. Java 集合 - 通过 Set、SortedSet 和 NavigableSet 扩展 Collection 接口"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-14T01:07:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cache技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1662117313262776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            239. Java 集合 - 通过 Set、SortedSet 和 NavigableSet 扩展 Collection 接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117313262776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cache技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:07:55.000Z" title="Fri Nov 14 2025 01:07:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">239. Java 集合 - 通过 <code>Set</code>、<code>SortedSet</code> 和 <code>NavigableSet</code> 扩展 <code>Collection</code> 接口</h2>
<h4 data-id="heading-1">🧐 探索 <code>Set</code> 接口</h4>
<p><code>Set</code> 接口继承自 <code>Collection</code> 接口，主要用于<strong>集合中不允许有重复元素</strong>。与 <code>List</code> 不同，<code>Set</code> 不保证元素的顺序，这意味着在你向 <code>Set</code> 中添加元素时，它们的顺序不一定与插入顺序相同。</p>
<p><code>HashSet</code> 是实现 <code>Set</code> 接口的最常见类，它内部使用 <code>HashMap</code> 来存储元素，但对外提供的是一个集合视图。</p>
<h5 data-id="heading-2">示例：使用 <code>HashSet</code> 存储元素</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; strings = List.of(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>, <span class="hljs-string">"four"</span>, <span class="hljs-string">"five"</span>, <span class="hljs-string">"six"</span>);
        Set&lt;String&gt; set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        set.addAll(strings);
        set.forEach(System.out::println);
    }
}
</code></pre>
<h5 data-id="heading-3">运行结果：</h5>
<pre><code class="hljs language-java" lang="java">six
four
one
two
three
five
</code></pre>
<p>如上所示，<code>HashSet</code> 的遍历顺序是随机的，无法保证按照添加顺序输出。因此，在使用 <code>Set</code> 时，不应依赖于元素的遍历顺序。</p>
<hr/>
<h4 data-id="heading-4">🌱 通过 <code>SortedSet</code> 扩展 <code>Set</code></h4>
<p><code>SortedSet</code> 接口扩展了 <code>Set</code> 接口，使得集合中的元素按照自然顺序或自定义的比较器排序。<code>TreeSet</code> 是实现 <code>SortedSet</code> 接口的常见类，它会将元素排序，并提供一些额外的操作方法。</p>
<h5 data-id="heading-5"><code>SortedSet</code> 额外方法：</h5>
<ul>
<li><strong>first() 和 last()</strong>：返回集合中的最小元素和最大元素。</li>
<li><strong>headSet(toElement)</strong> 和 <strong>tailSet(fromElement)</strong>：返回一个包含小于 <code>toElement</code> 或大于 <code>fromElement</code> 的子集。</li>
<li><strong>subSet(fromElement, toElement)</strong>：返回一个包含在 <code>fromElement</code> 和 <code>toElement</code> 之间的子集。</li>
</ul>
<p>注意：<code>toElement</code> 不会包含在结果中，而 <code>fromElement</code> 会被包含。</p>
<h5 data-id="heading-6">示例：使用 <code>SortedSet</code> 获取子集</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SortedSetExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SortedSet&lt;String&gt; strings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;&gt;(Set.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>, <span class="hljs-string">"f"</span>));
        SortedSet&lt;String&gt; subSet = strings.subSet(<span class="hljs-string">"aa"</span>, <span class="hljs-string">"d"</span>);
        System.out.println(<span class="hljs-string">"sub set = "</span> + subSet);
    }
}
</code></pre>
<h5 data-id="heading-7">运行结果：</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">sub</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> [b, c]
</code></pre>
<p><code>subSet</code> 方法返回的子集是一个视图，对其的修改会直接影响原始集合。</p>
<h5 data-id="heading-8">注意：</h5>
<ul>
<li>你不能通过子集添加不符合限制条件的元素。例如，在 <code>headSet</code> 中，添加一个大于 <code>toElement</code> 的元素会抛出 <code>IllegalArgumentException</code>。</li>
</ul>
<hr/>
<h4 data-id="heading-9">🔥 通过 <code>NavigableSet</code> 扩展 <code>SortedSet</code></h4>
<p><code>NavigableSet</code> 是对 <code>SortedSet</code> 的进一步扩展，提供了更多的操作方法，使得你能够更灵活地处理排序的集合。</p>
<p><code>TreeSet</code> 也实现了 <code>NavigableSet</code>，因此你可以使用 <code>TreeSet</code> 来执行所有 <code>NavigableSet</code> 的操作。</p>
<h5 data-id="heading-10"><code>NavigableSet</code> 新增方法：</h5>
<ul>
<li><strong>ceiling(element)</strong> 和 <strong>floor(element)</strong>：返回小于或等于指定元素的最大元素，大于或等于指定元素的最小元素。如果没有找到，返回 <code>null</code>。</li>
<li><strong>lower(element)</strong> 和 <strong>higher(element)</strong>：返回小于指定元素的最大元素，或大于指定元素的最小元素。如果没有找到，返回 <code>null</code>。</li>
<li><strong>pollFirst()</strong> 和 <strong>pollLast()</strong>：返回并移除集合中的第一个和最后一个元素。</li>
<li><strong>descendingIterator()</strong>：返回一个倒序遍历集合的迭代器。</li>
<li><strong>descendingSet()</strong>：返回一个反向顺序的 <code>NavigableSet</code>。</li>
</ul>
<h5 data-id="heading-11">示例：使用 <code>NavigableSet</code> 反向遍历集合</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigableSetExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        NavigableSet&lt;String&gt; sortedStrings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;&gt;(Set.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>, <span class="hljs-string">"f"</span>));
        System.out.println(<span class="hljs-string">"sorted strings = "</span> + sortedStrings);
        
        NavigableSet&lt;String&gt; reversedStrings = sortedStrings.descendingSet();
        System.out.println(<span class="hljs-string">"reversed strings = "</span> + reversedStrings);
    }
}
</code></pre>
<h5 data-id="heading-12">运行结果：</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">sorted</span> <span class="hljs-variable">strings</span> <span class="hljs-operator">=</span> [a, b, c, d, e, f]
<span class="hljs-type">reversed</span> <span class="hljs-variable">strings</span> <span class="hljs-operator">=</span> [f, e, d, c, b, a]
</code></pre>
<p><code>descendingSet()</code> 方法返回一个新的 <code>NavigableSet</code>，这个集合是原集合的倒序视图。</p>
<hr/>
<h4 data-id="heading-13">🎯 小结</h4>
<ol>
<li><strong><code>Set</code> 接口</strong>：不允许重复元素，且不保证元素的顺序。</li>
<li><strong><code>SortedSet</code> 接口</strong>：保持集合元素的排序，提供了子集、头部集和尾部集等方法。</li>
<li><strong><code>NavigableSet</code> 接口</strong>：扩展了 <code>SortedSet</code>，提供更多的导航功能，如反向遍历、查询上下界元素等。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探索 Java 中的新 HTTP 客户端]]></title>    <link>https://juejin.cn/post/7572087162230931498</link>    <guid>https://juejin.cn/post/7572087162230931498</guid>    <pubDate>2025-11-14T02:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162230931498" data-draft-id="7572087162230865962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探索 Java 中的新 HTTP 客户端"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-14T02:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探索 Java 中的新 HTTP 客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T02:16:37.000Z" title="Fri Nov 14 2025 02:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否也遇到过这样的时刻：只是想发个 HTTP 请求，却被连接管理、重定向、超时与线程阻塞折腾得不亦乐乎？那就试试 Java 11 正式标准化了全新的 HttpClient，原生支持 HTTP/2、异步与 WebSocket，极大简化了客户端网络编程。</p>
<h2 data-id="heading-0">1. 概览</h2>
<p>本文将介绍 Java 11 对全新 <strong>HTTP 客户端 API（支持 HTTP/2 与 WebSocket）</strong> 的标准化。</p>
<p>它旨在替代 JDK 早期就存在的旧类 <code>HttpURLConnection</code>（文档见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjava.base%2Fjava%2Fnet%2FHttpURLConnection.html%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/net/HttpURLConnection.html%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">docs.oracle.com/en/java/jav…</a></p>
<p>在不久之前，Java 只有较为底层、功能有限且不够友好的 <code>HttpURLConnection</code> API。因此社区普遍使用第三方库，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhc.apache.org%2Fhttpcomponents-client-ga%2F" target="_blank" title="https://hc.apache.org/httpcomponents-client-ga/" ref="nofollow noopener noreferrer">Apache HttpClient</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Feclipse.dev%2Fjetty%2Fdocumentation%2Fjetty-9%2Findex.html%23http-client-api" target="_blank" title="https://eclipse.dev/jetty/documentation/jetty-9/index.html#http-client-api" ref="nofollow noopener noreferrer">Jetty</a> 以及 Spring 的 RestTemplate。</p>
<h2 data-id="heading-1">2. 背景</h2>
<p>该变更由 JEP 321 引入并最终在 Java 11 中定型。</p>
<h3 data-id="heading-2">2.1. JEP 321 的主要变更</h3>
<ol>
<li>Java 9 的孵化版 HTTP API 已正式并入 Java SE API。新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjava.net.http%2Fjava%2Fnet%2Fhttp%2Fpackage-summary.html" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/java.net.http/java/net/http/package-summary.html" ref="nofollow noopener noreferrer">HTTP APIs</a> 位于 <code>java.net.http.*</code>。</li>
<li>新版本的 HTTP 协议旨在提升客户端请求与服务器响应的整体性能，包括多路复用、头压缩与推送承诺（push promise）等特性。</li>
<li>自 Java 11 起，<strong>API 全面支持异步</strong>（相比之下，旧的 HTTP/1.1 实现是阻塞式的）。异步以 <code>CompletableFuture</code> 实现，阶段式流水线在前一阶段完成后自动衔接执行。</li>
<li>新的 HTTP 客户端提供了标准方式执行网络操作，原生支持现代 Web 能力（如 HTTP/2），无需引入第三方依赖。</li>
<li>新 API 原生支持 HTTP/1.1 与 HTTP/2 的 WebSocket。核心类型包括：
<ul>
<li><code>HttpClient</code>（<code>java.net.http.HttpClient</code>）</li>
<li><code>HttpRequest</code>（<code>java.net.http.HttpRequest</code>）</li>
<li><code>HttpResponse&lt;T&gt;</code>（<code>java.net.http.HttpResponse</code>）</li>
<li><code>WebSocket</code>（<code>java.net.http.WebSocket</code>）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">2.2. Java 11 之前客户端的问题</h3>
<p>旧版 <code>HttpURLConnection</code> 及其实现存在诸多问题：</p>
<ul>
<li><code>URLConnection</code> 为多个如今已不再使用的协议（FTP、gopher 等）而设计；</li>
<li>API 早于 HTTP/1.1，抽象层级不合时宜；</li>
<li>仅支持阻塞模式（一次请求/响应占用一个线程）；</li>
<li>维护困难。</li>
</ul>
<h2 data-id="heading-4">3. HTTP Client API 总览</h2>
<p>与 <code>HttpURLConnection</code> 不同，新 HTTP 客户端同时提供同步与异步两种请求机制。</p>
<p>API 的三大核心：</p>
<ul>
<li><code>HttpRequest</code>：要发送的请求；</li>
<li><code>HttpClient</code>：跨请求的通用配置容器；</li>
<li><code>HttpResponse</code>：请求的响应结果。</li>
</ul>
<p>下面分别展开，先从请求开始。</p>
<h2 data-id="heading-5">4. HttpRequest</h2>
<p><code>HttpRequest</code> 表示将要发送的请求，可通过 <code>HttpRequest.newBuilder()</code> 获取构建器；构建器提供多种便捷方法配置请求。</p>
<p>注：JDK 16 新增 <code>HttpRequest.newBuilder(HttpRequest request, BiPredicate&lt;String,String&gt; filter)</code>，可基于已有请求复制初始状态，再在构建前做修改（如移除部分头）：</p>
<pre><code class="hljs language-java" lang="java">HttpRequest.newBuilder(request, (name, value) -&gt; !name.equalsIgnoreCase(<span class="hljs-string">"Foo-Bar"</span>));
</code></pre>
<h3 data-id="heading-6">4.1. 设置 URI</h3>
<p>可直接用带 <code>URI</code> 的构造方式，或在构建器上调用 <code>uri(URI)</code>：</p>
<pre><code class="hljs language-java" lang="java">HttpRequest.newBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>));

HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>));
</code></pre>
<h3 data-id="heading-7">4.2. 指定 HTTP 方法</h3>
<p>构建器提供以下方法：</p>
<ul>
<li><code>GET()</code></li>
<li><code>POST(BodyPublisher body)</code></li>
<li><code>PUT(BodyPublisher body)</code></li>
<li><code>DELETE()</code></li>
</ul>
<p>一个最简单的 GET 示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .GET()
  .build();
</code></pre>
<p>常见的附加参数包括：HTTP 协议版本、请求头与超时。</p>
<h3 data-id="heading-8">4.3. 设置协议版本</h3>
<p>API 默认充分利用 HTTP/2，也可显式指定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .version(HttpClient.Version.HTTP_2)
  .GET()
  .build();
</code></pre>
<p>注意：若对端不支持 HTTP/2，客户端会回退到 HTTP/1.1。</p>
<h3 data-id="heading-9">4.4. 设置请求头</h3>
<p>可用 <code>headers(k1,v1,k2,v2,...)</code> 一次性传入，或多次调用 <code>header(k,v)</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .headers(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>, <span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>)
  .GET()
  .build();

<span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request2</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .header(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>)
  .header(<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>)
  .GET()
  .build();
</code></pre>
<h3 data-id="heading-10">4.5. 设置超时</h3>
<p>默认无穷大。可用 <code>Duration</code> 设置，超时会抛出 <code>HttpTimeoutException</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .timeout(Duration.ofSeconds(<span class="hljs-number">10</span>))
  .GET()
  .build();
</code></pre>
<h2 data-id="heading-11">5. 设置请求体</h2>
<p><code>POST(BodyPublisher)</code>, <code>PUT(BodyPublisher)</code> 可携带请求体（<code>DELETE()</code> 也支持不带体的删除）。常用的 <code>BodyPublisher</code> 工厂有：</p>
<ul>
<li><code>HttpRequest.BodyPublishers.ofString</code>：基于字符串；</li>
<li><code>HttpRequest.BodyPublishers.ofInputStream</code>：基于输入流（以 <code>Supplier&lt;InputStream&gt;</code> 形式延迟创建）；</li>
<li><code>HttpRequest.BodyPublishers.ofByteArray</code>：基于字节数组；</li>
<li><code>HttpRequest.BodyPublishers.ofFile</code>：基于文件路径内容；</li>
<li>无请求体：<code>HttpRequest.BodyPublishers.noBody()</code>。</li>
</ul>
<p>JDK 16 新增 <code>BodyPublishers.concat(...)</code>，可把多个 publisher 的内容顺序拼接为一个请求体。</p>
<h3 data-id="heading-12">5.1. 字符串请求体</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/post"</span>))
  .headers(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain;charset=UTF-8"</span>)
  .POST(HttpRequest.BodyPublishers.ofString(<span class="hljs-string">"Sample request body"</span>))
  .build();
</code></pre>
<h3 data-id="heading-13">5.2. 输入流请求体</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] sampleData = <span class="hljs-string">"Sample request body"</span>.getBytes();
<span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/post"</span>))
  .headers(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain;charset=UTF-8"</span>)
  .POST(HttpRequest.BodyPublishers
   .ofInputStream(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(sampleData)))
  .build();
</code></pre>
<h3 data-id="heading-14">5.3. 字节数组请求体</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] sampleData = <span class="hljs-string">"Sample request body"</span>.getBytes();
<span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/post"</span>))
  .headers(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain;charset=UTF-8"</span>)
  .POST(HttpRequest.BodyPublishers.ofByteArray(sampleData))
  .build();
</code></pre>
<h3 data-id="heading-15">5.4. 文件请求体</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/post"</span>))
  .headers(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain;charset=UTF-8"</span>)
  .POST(HttpRequest.BodyPublishers.ofFile(
    Paths.get(<span class="hljs-string">"src/test/resources/sample.txt"</span>)))
  .build();
</code></pre>
<h2 data-id="heading-16">6. HttpClient</h2>
<p>所有请求都由 <code>HttpClient</code> 发送，可通过 <code>HttpClient.newBuilder()</code> 或 <code>HttpClient.newHttpClient()</code> 获取。下面看几个常用能力。</p>
<h3 data-id="heading-17">6.1. 处理响应体</h3>
<p>新的 <code>BodyHandlers</code> 工厂提供常见类型的响应体处理器：</p>
<pre><code class="hljs language-java" lang="java">BodyHandlers.ofByteArray;
BodyHandlers.ofString;
BodyHandlers.ofFile;
BodyHandlers.discarding;
BodyHandlers.replacing;
BodyHandlers.ofLines;
BodyHandlers.fromLineSubscriber;
</code></pre>
<p>Java 11 之前：</p>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = client.send(request, HttpResponse.BodyHandler.asString());
</code></pre>
<p>现在可简化为：</p>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = client.send(request, BodyHandlers.ofString());
</code></pre>
<h3 data-id="heading-18">6.2. 设置代理</h3>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = HttpClient
  .newBuilder()
  .proxy(ProxySelector.getDefault())
  .build()
  .send(request, BodyHandlers.ofString());
</code></pre>
<h3 data-id="heading-19">6.3. 跟随重定向策略</h3>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = HttpClient.newBuilder()
  .followRedirects(HttpClient.Redirect.ALWAYS)
  .build()
  .send(request, BodyHandlers.ofString());
</code></pre>
<h3 data-id="heading-20">6.4. 认证器（Authenticator）</h3>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = HttpClient.newBuilder()
  .authenticator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Authenticator</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> PasswordAuthentication <span class="hljs-title function_">getPasswordAuthentication</span><span class="hljs-params">()</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PasswordAuthentication</span>(
        <span class="hljs-string">"username"</span>,
        <span class="hljs-string">"password"</span>.toCharArray());
    }
  })
  .build()
  .send(request, BodyHandlers.ofString());
</code></pre>
<h3 data-id="heading-21">6.5. 同步与异步发送</h3>
<ul>
<li>同步：<code>send(...)</code>（阻塞直到响应返回）</li>
<li>异步：<code>sendAsync(...)</code>（立即返回 <code>CompletableFuture&lt;HttpResponse&lt;T&gt;&gt;</code>）</li>
</ul>
<p>同步示例：</p>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = HttpClient.newBuilder()
  .build()
  .send(request, BodyHandlers.ofString());
</code></pre>
<p>异步示例：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; response = HttpClient.newBuilder()
  .build()
  .sendAsync(request, HttpResponse.BodyHandlers.ofString());
</code></pre>
<p>批量并发请求：</p>
<pre><code class="hljs language-java" lang="java">List&lt;URI&gt; targets = Arrays.asList(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get?foo1=bar1"</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get?foo2=bar2"</span>));
<span class="hljs-type">HttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> HttpClient.newHttpClient();
List&lt;CompletableFuture&lt;String&gt;&gt; futures = targets.stream()
  .map(target -&gt; client
    .sendAsync(
      HttpRequest.newBuilder(target).GET().build(),
      HttpResponse.BodyHandlers.ofString())
    .thenApply(HttpResponse::body))
  .collect(Collectors.toList());
</code></pre>
<h3 data-id="heading-22">6.6. 指定异步执行器（Executor）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);

CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; response1 = HttpClient.newBuilder()
  .executor(executorService)
  .build()
  .sendAsync(request, HttpResponse.BodyHandlers.ofString());

CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; response2 = HttpClient.newBuilder()
  .executor(executorService)
  .build()
  .sendAsync(request, HttpResponse.BodyHandlers.ofString());
</code></pre>
<p>默认执行器为 <code>Executors.newCachedThreadPool()</code>。</p>
<h3 data-id="heading-23">6.7. CookieHandler</h3>
<p>设置客户端级 <code>CookieHandler</code>：</p>
<pre><code class="hljs language-java" lang="java">HttpClient.newBuilder()
  .cookieHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CookieManager</span>(<span class="hljs-literal">null</span>, CookiePolicy.ACCEPT_NONE))
  .build();
</code></pre>
<p>若允许存储 Cookie，可从 <code>CookieManager</code> 读取：</p>
<pre><code class="hljs language-java" lang="java">((CookieManager) httpClient.cookieHandler().get()).getCookieStore();
</code></pre>
<h2 data-id="heading-24">7. HttpResponse</h2>
<p><code>HttpResponse</code> 表示服务端响应，核心方法：</p>
<ul>
<li><code>statusCode()</code>：返回整型状态码；</li>
<li><code>body()</code>：返回响应体（类型取决于发送时的 <code>BodyHandler</code>）。</li>
</ul>
<p>其他常用方法还包括 <code>uri()</code>、<code>headers()</code>、<code>trailers()</code> 与 <code>version()</code>。</p>
<h3 data-id="heading-25">7.1. 响应的 URI</h3>
<p>由于重定向，响应返回的 <code>uri()</code> 可能与请求不同：</p>
<pre><code class="hljs language-java" lang="java">assertThat(request.uri().toString(), equalTo(<span class="hljs-string">"http://stackoverflow.com"</span>));
assertThat(response.uri().toString(), equalTo(<span class="hljs-string">"https://stackoverflow.com/"</span>));
</code></pre>
<h3 data-id="heading-26">7.2. 响应头</h3>
<pre><code class="hljs language-java" lang="java">HttpResponse&lt;String&gt; response = HttpClient.newHttpClient()
  .send(request, HttpResponse.BodyHandlers.ofString());
<span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">responseHeaders</span> <span class="hljs-operator">=</span> response.headers();
</code></pre>
<h3 data-id="heading-27">7.3. 响应协议版本</h3>
<p>即使请求设置为 HTTP/2，服务端也可能以 HTTP/1.1 响应，实际版本可从响应读取：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> HttpRequest.newBuilder()
  .uri(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://postman-echo.com/get"</span>))
  .version(HttpClient.Version.HTTP_2)
  .GET()
  .build();
HttpResponse&lt;String&gt; response = HttpClient.newHttpClient()
  .send(request, HttpResponse.BodyHandlers.ofString());
assertThat(response.version(), equalTo(HttpClient.Version.HTTP_1_1));
</code></pre>
<h2 data-id="heading-28">8. HTTP/2 推送承诺（Push Promise）</h2>
<p>新的 <code>HttpClient</code> 通过 <code>PushPromiseHandler</code> 支持服务端主动推送。当客户端请求主资源时，服务器可以同时“推送”额外资源，从而减少往返次数、加快页面渲染。该能力得益于 HTTP/2 的多路复用。</p>
<p>如有推送承诺，将由提供的 <code>PushPromiseHandler</code> 处理；若传入 <code>null</code>，则拒绝所有推送。</p>
<p><code>HttpClient</code> 的重载 <code>sendAsync</code> 可用于处理 push promise。先定义处理器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> PushPromiseHandler&lt;String&gt; <span class="hljs-title function_">pushPromiseHandler</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> (HttpRequest initiatingRequest,
        HttpRequest pushPromiseRequest,
        Function&lt;HttpResponse.BodyHandler&lt;String&gt;,
        CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;&gt; acceptor) -&gt; {
        acceptor.apply(BodyHandlers.ofString())
            .thenAccept(resp -&gt; {
                System.out.println(<span class="hljs-string">"Pushed response: "</span> + resp.uri() + <span class="hljs-string">", headers: "</span> + resp.headers());
            });
        System.out.println(<span class="hljs-string">"Promise request: "</span> + pushPromiseRequest.uri());
        System.out.println(<span class="hljs-string">"Promise request headers: "</span> + pushPromiseRequest.headers());
    };
}
</code></pre>
<p>再用 <code>sendAsync</code> 消费它：</p>
<pre><code class="hljs language-java" lang="java">httpClient.sendAsync(pageRequest, BodyHandlers.ofString(), pushPromiseHandler())
    .thenAccept(pageResponse -&gt; {
        System.out.println(<span class="hljs-string">"Page response status code: "</span> + pageResponse.statusCode());
        System.out.println(<span class="hljs-string">"Page response headers: "</span> + pageResponse.headers());
        <span class="hljs-type">String</span> <span class="hljs-variable">responseBody</span> <span class="hljs-operator">=</span> pageResponse.body();
        System.out.println(responseBody);
    })
    .join();
</code></pre>
<h2 data-id="heading-29">9. 总结</h2>
<p>本文探讨了 Java 11 中标准化后的 <code>HttpClient</code> API：在保留易用性的同时，引入了 HTTP/2、异步、推送承诺、代理、重定向策略、认证器、Cookie 管理等现代化能力，让 Java 的 HTTP 编程更高效、更现代。</p>
<p>更多 Java 相关内容，也可以关注我的这个分类：<a href="https://link.juejin.cn?target=https%3A%2F%2Fspring4all.com%2Fcategories%2Fjava" target="_blank" title="https://spring4all.com/categories/java" ref="nofollow noopener noreferrer">Java专题</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostgreSQL实例进程：从启动到运行的完整故事]]></title>    <link>https://juejin.cn/post/7572087162230407210</link>    <guid>https://juejin.cn/post/7572087162230407210</guid>    <pubDate>2025-11-14T01:12:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162230407210" data-draft-id="7572087162230374442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostgreSQL实例进程：从启动到运行的完整故事"/> <meta itemprop="keywords" content="PostgreSQL,数据库"/> <meta itemprop="datePublished" content="2025-11-14T01:12:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostgreSQL实例进程：从启动到运行的完整故事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:12:01.000Z" title="Fri Nov 14 2025 01:12:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PostgreSQL实例进程：从启动到运行的完整故事</h2>
<p>最近在深入研究PostgreSQL的内部机制，发现这玩意儿的进程架构真的挺有意思的。今天就和大家聊聊PostgreSQL实例是怎么运作的，从按下启动按钮到处理查询的整个过程。</p>
<h3 data-id="heading-1">先说说整体架构</h3>
<p>我一开始接触PostgreSQL的时候，总以为它就是一个单体程序在跑。后来用<code>ps</code>命令一看，好家伙，一堆postgres进程，当时就懵了。研究了一阵子才搞明白，PostgreSQL其实更像一个工厂系统。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph clients["客户端"]
        C1[应用程序 1]
        C2[应用程序 2]
        C3[应用程序 N]
    end
    
    subgraph connection["连接管理"]
        PM[Postmaster&lt;br/&gt;主进程]
    end
    
    subgraph backend["查询执行"]
        BE1[Backend 1]
        BE2[Backend 2]
        BE3[Backend N]
    end
    
    subgraph memory["共享内存"]
        SB[Shared Buffers&lt;br/&gt;数据缓存]
        WB[WAL Buffers&lt;br/&gt;日志缓冲]
        CL[CLOG&lt;br/&gt;事务状态]
    end
    
    subgraph bgworkers["后台维护"]
        BG[Background Writer]
        CK[Checkpointer]
        WW[WAL Writer]
        AV[AutoVacuum]
    end
    
    subgraph storage["存储"]
        DF[(数据文件)]
        WF[(WAL日志)]
    end
    
    C1 --&gt; PM
    C2 --&gt; PM
    C3 --&gt; PM
    
    PM --&gt; BE1
    PM --&gt; BE2
    PM --&gt; BE3
    
    BE1 --&gt; SB
    BE2 --&gt; SB
    BE3 --&gt; SB
    
    BE1 --&gt; WB
    
    BG --&gt; SB
    CK --&gt; SB
    WW --&gt; WB
    
    BG --&gt; DF
    CK --&gt; DF
    WW --&gt; WF
    AV --&gt; DF
    
    style PM fill:#ff6b6b,stroke:#333,stroke-width:3px
    style SB fill:#4ecdc4,stroke:#333,stroke-width:2px
    style WB fill:#ffe66d,stroke:#333,stroke-width:2px
</code></pre>
<p>这里面有几个关键角色：</p>
<p><strong>Postmaster</strong>是老大，负责总调度。它就像厂长一样，监听5432端口等客户来连，每来一个连接就fork出一个Backend进程去服务。我当时好奇为什么不用线程，后来才知道这样做的好处是进程间隔离得好，一个进程崩了不影响其他的。</p>
<p><strong>Backend进程</strong>是真正干活的。一个客户端连接对应一个Backend，这个设计挺有意思的。每个Backend有自己独立的内存空间，负责解析SQL、优化查询、执行操作。不过这也意味着如果你的max_connections设置成500，理论上就可能有500个Backend进程，吃内存还是挺猛的。</p>
<p><strong>后台进程</strong>这帮家伙是维护团队，各司其职：</p>
<ul>
<li>Background Writer定时扫描脏页异步写入磁盘</li>
<li>Checkpointer创建检查点，把所有脏页强制刷盘</li>
<li>WAL Writer负责把日志缓冲刷到磁盘</li>
<li>AutoVacuum清理死元组，这个后面会详细说</li>
</ul>
<p><strong>共享内存</strong>就像工厂的仓库，所有进程都能访问。主要是Shared Buffers存数据页，WAL Buffers存日志，还有一些锁表、事务状态之类的东西。</p>
<h3 data-id="heading-2">启动过程是怎么回事</h3>
<p>我们来看看执行<code>pg_ctl start</code>之后发生了什么。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    actor Admin as 管理员
    participant OS as 操作系统
    participant PM as Postmaster
    participant Conf as 配置文件
    participant SM as 共享内存
    participant WAL as WAL日志
    participant BG as 后台进程
    
    Note over Admin,BG: 阶段1: 启动命令
    Admin-&gt;&gt;OS: pg_ctl start -D /data
    OS-&gt;&gt;PM: 启动Postmaster进程
    activate PM
    
    Note over Admin,BG: 阶段2: 读取配置
    PM-&gt;&gt;Conf: 读取 postgresql.conf
    Conf--&gt;&gt;PM: 返回配置参数
    PM-&gt;&gt;Conf: 读取 pg_hba.conf
    Conf--&gt;&gt;PM: 返回认证规则
    
    Note over Admin,BG: 阶段3: 分配共享内存
    PM-&gt;&gt;SM: 分配 Shared Buffers
    activate SM
    PM-&gt;&gt;SM: 分配 WAL Buffers
    PM-&gt;&gt;SM: 初始化 Lock Tables
    PM-&gt;&gt;SM: 初始化 CLOG
    Note right of SM: 总共约4.2GB&lt;br/&gt;共享内存
    
    Note over Admin,BG: 阶段4: 崩溃恢复检查
    PM-&gt;&gt;WAL: 检查 pg_control 文件
    WAL--&gt;&gt;PM: 返回数据库状态
    
    alt 数据库异常关闭
        Note right of PM: 需要恢复!
        PM-&gt;&gt;WAL: 读取WAL日志
        PM-&gt;&gt;SM: 重放WAL记录
        Note right of SM: 恢复到一致状态
    else 数据库正常关闭
        Note right of PM: 无需恢复
    end
    
    Note over Admin,BG: 阶段5: 启动后台进程
    PM-&gt;&gt;BG: fork() Background Writer
    activate BG
    Note right of BG: 每200ms扫描
    
    PM-&gt;&gt;BG: fork() Checkpointer
    Note right of BG: 每10min检查点
    
    PM-&gt;&gt;BG: fork() WAL Writer
    Note right of BG: 每200ms刷盘
    
    PM-&gt;&gt;BG: fork() AutoVacuum Launcher
    Note right of BG: 每1min检查
    
    PM-&gt;&gt;BG: fork() Stats Collector
    Note right of BG: 收集统计
    
    Note over Admin,BG: 阶段6: 准备就绪
    PM-&gt;&gt;OS: 监听端口 5432
    Note over PM: 开始接受连接
    
    PM--&gt;&gt;Admin: 启动完成
    deactivate SM
    deactivate BG
    deactivate PM
</code></pre>
<p>这个过程其实有几个点值得注意：</p>
<p>启动的时候会读两个重要配置文件，postgresql.conf是主配置，pg_hba.conf管认证规则。我之前改了postgresql.conf忘了reload，查了半天为什么不生效，后来才发现有些参数必须重启才行。</p>
<p>共享内存的分配比较关键。Postmaster会一次性分配好所有共享内存，这就是为什么shared_buffers改了必须重启的原因。我当时在一台16GB的机器上把shared_buffers设成了12GB，结果启动都启动不起来，操作系统直接拒绝分配这么大的共享内存。后来查资料才知道，一般建议设置为物理内存的25-40%就够了。</p>
<p>如果上次是异常关闭，启动时会做崩溃恢复。Postmaster会检查pg_control文件，发现状态不对就会去读WAL日志重放。这个机制挺靠谱的，我经历过几次服务器断电，重启后PostgreSQL都能自动恢复过来。</p>
<p>启动完后台进程的顺序也是有讲究的。Background Writer和Checkpointer是写数据的，WAL Writer是写日志的，AutoVacuum是清理垃圾的。这些进程都是从Postmaster fork出来的，它们会一直在后台运行，直到数据库关闭。</p>
<p>验证启动是否成功，可以看看进程列表：</p>
<pre><code class="hljs language-bash" lang="bash">ps -ef | grep postgres

<span class="hljs-comment"># 你会看到类似这样的输出</span>
postgres  1234     1  Ss   09:00   postgres
postgres  1235  1234  Ss   09:00   postgres: checkpointer
postgres  1236  1234  Ss   09:00   postgres: background writer
postgres  1237  1234  Ss   09:00   postgres: walwriter
postgres  1238  1234  Ss   09:00   postgres: autovacuum launcher
</code></pre>
<p>第一个进程就是Postmaster，后面的都是它的子进程。</p>
<h3 data-id="heading-3">内存这块真的很重要</h3>
<p>内存配置是PostgreSQL性能的关键，我当时踩了不少坑。先看看内存的整体结构：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph shared["共享内存区（所有进程共享）"]
        SB["Shared Buffers&lt;br/&gt;数据页缓存&lt;br/&gt;推荐: RAM的25-40%&lt;br/&gt;示例: 4GB (16GB服务器)"]
        WB["WAL Buffers&lt;br/&gt;事务日志缓冲&lt;br/&gt;推荐: 16MB&lt;br/&gt;或 shared_buffers的1/32"]
        CL["CLOG&lt;br/&gt;事务提交日志&lt;br/&gt;记录事务提交状态"]
        LS["Lock Space&lt;br/&gt;锁管理表&lt;br/&gt;管理各种锁"]
        PA["Proc Array&lt;br/&gt;进程数组&lt;br/&gt;活动进程信息"]
    end
    
    subgraph local1["Backend 1 本地内存"]
        WM1["work_mem&lt;br/&gt;查询操作&lt;br/&gt;排序/哈希/聚合&lt;br/&gt;每个操作独立!"]
        MM1["maintenance_work_mem&lt;br/&gt;维护操作&lt;br/&gt;VACUUM/CREATE INDEX"]
        TB1["temp_buffers&lt;br/&gt;临时表缓冲"]
    end
    
    subgraph local2["Backend 2 本地内存"]
        WM2["work_mem"]
        MM2["maintenance_work_mem"]
        TB2["temp_buffers"]
    end
    
    subgraph os["操作系统层"]
        OC["OS Page Cache&lt;br/&gt;文件系统缓存&lt;br/&gt;effective_cache_size&lt;br/&gt;推荐: RAM的50-75%"]
    end
    
    SB --&gt; OC
    WB --&gt; OC
    WM1 -.使用.-&gt; SB
    WM2 -.使用.-&gt; SB
    
    style SB fill:#4ecdc4,stroke:#333,stroke-width:3px
    style WB fill:#ffe66d,stroke:#333,stroke-width:3px
    style WM1 fill:#f38181,stroke:#333,stroke-width:2px
    style WM2 fill:#f38181,stroke:#333,stroke-width:2px
    style OC fill:#a8e6cf,stroke:#333,stroke-width:2px
</code></pre>
<h4 data-id="heading-4">几个容易搞错的地方</h4>
<p><strong>Shared Buffers不是越大越好</strong></p>
<p>我最开始以为这个越大性能越好，就把32GB服务器的shared_buffers设成了24GB。结果发现checkpoint的时候IO压力巨大，而且启动时间变得超长。后来研究才明白，PostgreSQL的设计是依赖操作系统缓存的，shared_buffers设置太大反而会和OS cache抢内存。</p>
<p>一般的建议是物理内存的25-40%，比如16GB的机器设4GB就挺合适：</p>
<pre><code class="hljs language-conf" lang="conf"># 16GB服务器的配置
shared_buffers = 4GB                    # 25% of 16GB
effective_cache_size = 12GB             # 75% of 16GB，这个只是告诉优化器的，不实际分配
</code></pre>
<p><strong>work_mem是个大坑</strong></p>
<p>这个参数我被坑惨了。work_mem是每个查询操作使用的内存，注意是每个操作！一个复杂查询可能有多个排序、哈希操作，每个都会用work_mem。</p>
<p>假设你设置了work_mem = 256MB，max_connections = 500，某个查询有5个操作同时跑，那就是256MB × 5 = 1.28GB，如果有100个这样的并发查询，理论上就需要128GB内存！服务器直接OOM。</p>
<p>我的建议是保守设置，比如16MB：</p>
<pre><code class="hljs language-conf" lang="conf">work_mem = 16MB                         # 保守设置

# 计算公式参考：
# (RAM - shared_buffers) / (max_connections × 预期并发操作数)
# = (16GB - 4GB) / (200 × 3) ≈ 20MB
</code></pre>
<p>如果某些查询确实需要更大的work_mem，可以会话级别临时调整：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SET</span> work_mem <span class="hljs-operator">=</span> <span class="hljs-string">'256MB'</span>;  <span class="hljs-comment">-- 仅对当前会话生效</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> huge_table <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ...;
</code></pre>
<p><strong>effective_cache_size容易被忽略</strong></p>
<p>这个参数不分配内存，但它告诉查询优化器操作系统大概有多少缓存可用。设置合理的话，优化器会做出更好的查询计划。一般设置为物理内存的50-75%。</p>
<h4 data-id="heading-5">怎么知道配置合不合理</h4>
<p>监控缓存命中率是个好办法：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">sum</span>(heap_blks_read) <span class="hljs-keyword">as</span> disk_reads,
    <span class="hljs-built_in">sum</span>(heap_blks_hit) <span class="hljs-keyword">as</span> buffer_hits,
    round(
        <span class="hljs-built_in">sum</span>(heap_blks_hit)::<span class="hljs-type">numeric</span> <span class="hljs-operator">/</span> 
        <span class="hljs-built_in">nullif</span>(<span class="hljs-built_in">sum</span>(heap_blks_hit) <span class="hljs-operator">+</span> <span class="hljs-built_in">sum</span>(heap_blks_read), <span class="hljs-number">0</span>) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>,
        <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">as</span> hit_ratio_percent
<span class="hljs-keyword">FROM</span> pg_statio_user_tables;
</code></pre>
<p>一般来说，hit_ratio_percent应该在99%以上。如果低于90%，说明缓存太小了，考虑增加shared_buffers。</p>
<h3 data-id="heading-6">客户端连接进来后发生了什么</h3>
<p>现在我们来看看一个SQL查询的完整生命周期。假设有个客户端要查询数据：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as 客户端
    participant PM as Postmaster
    participant BE as Backend
    participant SM as Shared Memory
    participant D as 磁盘
    
    C-&gt;&gt;PM: 1. 连接请求
    PM-&gt;&gt;BE: 2. fork Backend进程
    BE--&gt;&gt;C: 3. 连接成功
    
    C-&gt;&gt;BE: 4. 发送SQL查询
    
    Note over BE: 解析阶段
    BE-&gt;&gt;BE: 5. 词法+语法分析
    BE-&gt;&gt;BE: 6. 语义检查
    
    Note over BE: 规划阶段
    BE-&gt;&gt;SM: 7. 获取统计信息
    SM--&gt;&gt;BE: 表大小/索引信息
    BE-&gt;&gt;BE: 8. 生成执行计划
    
    Note over BE: 执行阶段
    BE-&gt;&gt;SM: 9. 查找数据页
    
    alt 缓存命中
        SM--&gt;&gt;BE: 10a. 返回数据
        Note right of SM: Buffer Hit
    else 缓存未命中
        SM-&gt;&gt;D: 10b. 读取文件
        D--&gt;&gt;SM: 11b. 返回数据
        SM--&gt;&gt;BE: 12b. 返回数据
        Note right of SM: Buffer Miss
    end
    
    BE-&gt;&gt;BE: 13. 过滤/聚合
    BE--&gt;&gt;C: 14. 返回结果
</code></pre>
<p>这个过程其实挺复杂的：</p>
<p><strong>解析阶段</strong>会把SQL文本转成内部结构，检查语法是否正确，表和字段是否存在。这一步比较快。</p>
<p><strong>规划阶段</strong>是重点。优化器会从统计信息里获取表的行数、数据分布等，然后评估不同的执行方案。比如是全表扫描还是用索引，是用嵌套循环还是哈希连接。这个过程相当于给查询找一条最优路径。</p>
<p>我们可以用EXPLAIN看看优化器在想什么：</p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN (ANALYZE, BUFFERS) 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">18</span>;

<span class="hljs-comment">-- 输出类似这样：</span>
<span class="hljs-comment">--  Seq Scan on users  </span>
<span class="hljs-comment">--      (cost=0.00..15.50 rows=100 width=40)</span>
<span class="hljs-comment">--      (actual time=0.012..0.156 rows=95 loops=1)</span>
<span class="hljs-comment">--    Filter: (age &gt; 18)</span>
<span class="hljs-comment">--    Rows Removed by Filter: 5</span>
<span class="hljs-comment">--    Buffers: shared hit=5</span>
<span class="hljs-comment">--  Planning Time: 0.123 ms</span>
<span class="hljs-comment">--  Execution Time: 0.234 ms</span>
</code></pre>
<p>这里面有几个关键信息：</p>
<ul>
<li>cost是估算的成本，越小越好</li>
<li>rows是估计返回的行数</li>
<li>Buffers: shared hit=5说明从缓存读了5个页，这是好事</li>
<li>如果是shared read=5，说明从磁盘读的，会慢很多</li>
</ul>
<p><strong>执行阶段</strong>Backend就开始真正读数据了。它会先去Shared Buffers里找，找到了就直接用（Buffer Hit），找不到就得去磁盘读（Buffer Miss）。读进来的数据会放到Shared Buffers里，下次其他查询可能就能直接用了。</p>
<h3 data-id="heading-7">写数据的时候更复杂</h3>
<p>INSERT、UPDATE、DELETE这些写操作涉及的东西更多。PostgreSQL用的是WAL（Write-Ahead Logging）机制，简单说就是先写日志，再改数据。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as 客户端
    participant BE as Backend
    participant WB as WAL Buffers
    participant SB as Shared Buffers
    participant WF as WAL Files
    participant DF as Data Files
    
    C-&gt;&gt;BE: BEGIN
    BE-&gt;&gt;BE: 分配事务ID
    
    C-&gt;&gt;BE: INSERT INTO users ...
    
    Note over BE,WF: 先写日志 (WAL)
    BE-&gt;&gt;WB: 写WAL记录
    
    Note over BE,DF: 再改数据
    BE-&gt;&gt;SB: 修改数据页
    BE-&gt;&gt;SB: 标记为脏页
    
    BE--&gt;&gt;C: OK
    
    C-&gt;&gt;BE: COMMIT
    
    Note over BE,WF: 提交时强制刷盘
    BE-&gt;&gt;WB: 写COMMIT记录
    WB-&gt;&gt;WF: fsync刷到磁盘
    Note right of WF: 持久化保证
    
    BE--&gt;&gt;C: COMMIT成功
    
    Note over SB,DF: 后台异步写入
    BG-&gt;&gt;SB: 扫描脏页
    BG-&gt;&gt;DF: 异步写入磁盘
</code></pre>
<p>这个设计挺巧妙的。WAL日志是顺序写，速度快。数据文件是随机写，速度慢，但可以异步慢慢写。就算数据还没完全写到数据文件，只要WAL写成功了，崩溃后也能恢复。</p>
<h4 data-id="heading-8">MVCC机制</h4>
<p>PostgreSQL用的多版本并发控制（MVCC）挺有意思。UPDATE操作不是原地修改，而是创建新版本，旧版本保留着。每行数据有个xmin（创建它的事务ID）和xmax（删除它的事务ID）。</p>
<p>不同事务根据自己的快照看到不同的数据版本，这样读不阻塞写，写也不阻塞读。但代价是会产生很多死元组（dead tuples），需要VACUUM来清理。</p>
<p>我们经历过一次表膨胀的问题。有张表频繁UPDATE，结果发现查询越来越慢，用下面的SQL一看，死元组占了30%：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    tablename,
    n_live_tup <span class="hljs-keyword">AS</span> live_rows,
    n_dead_tup <span class="hljs-keyword">AS</span> dead_rows,
    round(
        n_dead_tup <span class="hljs-operator">*</span> <span class="hljs-number">100.0</span> <span class="hljs-operator">/</span> 
        <span class="hljs-built_in">NULLIF</span>(n_live_tup <span class="hljs-operator">+</span> n_dead_tup, <span class="hljs-number">0</span>), 
        <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> bloat_percent
<span class="hljs-keyword">FROM</span> pg_stat_user_tables
<span class="hljs-keyword">WHERE</span> n_dead_tup <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> n_dead_tup <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>后来手动VACUUM了一下，查询速度才恢复正常。</p>
<h4 data-id="heading-9">WAL配置</h4>
<p>WAL的配置也有几个要注意的：</p>
<pre><code class="hljs language-conf" lang="conf"># WAL基础配置
wal_level = replica                     # minimal/replica/logical
wal_buffers = 16MB                      # WAL缓冲区大小
wal_writer_delay = 200ms                # WAL Writer间隔

# WAL文件管理
min_wal_size = 1GB                      # 保留的WAL最小大小
max_wal_size = 2GB                      # 触发checkpoint的WAL大小

# 同步提交配置
synchronous_commit = on                 # 持久性级别
# on: 等待WAL写入并fsync（最安全）
# local: 写入但不等待fsync（较快）
# off: 不等待写入（最快，可能丢数据）
</code></pre>
<p>synchronous_commit这个参数很关键。设成on最安全但最慢，off最快但崩溃可能丢最近几个事务的数据。我们在生产环境都是用on，但在一些允许丢数据的场景（比如日志收集）会用off来提升性能。</p>
<h3 data-id="heading-10">AutoVacuum这个东西必须搞懂</h3>
<p>AutoVacuum是PostgreSQL的清洁工，负责清理MVCC产生的死元组。刚开始我没太重视这个，后来吃了大亏。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Start[AutoVacuum Launcher&lt;br/&gt;每1分钟醒来] --&gt; Check[检查所有表统计]
    
    Check --&gt; Calc{dead_tuples &gt; &lt;br/&gt;threshold + scale * live}
    
    Calc --&gt;|是| Launch[启动Worker进程]
    Calc --&gt;|否| Sleep[继续休眠 1分钟]
    
    Launch --&gt; Worker[Worker扫描表]
    Worker --&gt; Clean[标记死元组空间]
    Clean --&gt; FSM[更新Free Space Map]
    FSM --&gt; VM[更新Visibility Map]
    VM --&gt; Stats[更新统计信息]
    Stats --&gt; Done[Worker完成]
    
    Done --&gt; Sleep
    Sleep --&gt; Check
    
    style Start fill:#4facfe,stroke:#333,stroke-width:2px
    style Worker fill:#95e1d3,stroke:#333,stroke-width:2px
    style Done fill:#ffe66d,stroke:#333
</code></pre>
<p>AutoVacuum默认每分钟检查一次，看哪些表需要清理。触发条件是：</p>
<pre><code class="hljs">dead_tuples &gt; 50 + 0.2 * live_tuples
</code></pre>
<p>比如10000行的表，需要积累50 + 2000 = 2050个死元组才触发。对于频繁更新的表，这个阈值可能太高了。</p>
<p>我们有张订单表，每秒几百个UPDATE，结果AutoVacuum总是跟不上，表越来越大。后来给这张表单独调了参数：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">SET</span> (
    autovacuum_vacuum_scale_factor <span class="hljs-operator">=</span> <span class="hljs-number">0.02</span>,  <span class="hljs-comment">-- 从0.2降到0.02</span>
    autovacuum_vacuum_threshold <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
);
</code></pre>
<p>这样10000行的表只需要100 + 200 = 300个死元组就触发，膨胀问题基本解决了。</p>
<p>监控AutoVacuum执行情况也很重要：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    schemaname, 
    tablename,
    last_autovacuum,
    last_autoanalyze,
    n_live_tup,
    n_dead_tup,
    round(
        n_dead_tup <span class="hljs-operator">*</span> <span class="hljs-number">100.0</span> <span class="hljs-operator">/</span> 
        <span class="hljs-built_in">NULLIF</span>(n_live_tup, <span class="hljs-number">0</span>), 
        <span class="hljs-number">2</span>
    ) <span class="hljs-keyword">AS</span> dead_percent
<span class="hljs-keyword">FROM</span> pg_stat_user_tables
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> n_dead_tup <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p>如果发现某些表的last_autovacuum是很久以前，或者dead_percent很高，就得关注了。</p>
<p>还有一点，长事务会阻止VACUUM清理。我们遇到过有个分析查询跑了几个小时，期间所有的VACUUM都无法清理这个查询可见的旧版本，导致表膨胀。所以尽量避免长时间的事务。</p>
<h3 data-id="heading-11">几个实用的监控</h3>
<p>生产环境跑PostgreSQL，监控是必不可少的。</p>
<h4 data-id="heading-12">连接数监控</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">current</span>,
    current_setting(<span class="hljs-string">'max_connections'</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">AS</span> max,
    round(
        <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)::<span class="hljs-type">numeric</span> <span class="hljs-operator">/</span> 
        current_setting(<span class="hljs-string">'max_connections'</span>)::<span class="hljs-type">numeric</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, 
        <span class="hljs-number">1</span>
    ) <span class="hljs-keyword">AS</span> usage_percent
<span class="hljs-keyword">FROM</span> pg_stat_activity;
</code></pre>
<p>如果usage_percent经常超过80%，要么增大max_connections，要么考虑用连接池（比如PgBouncer）。我们现在都用PgBouncer，几千个应用连接对应几十个数据库连接，省资源。</p>
<h4 data-id="heading-13">找出慢查询</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pid,
    now() <span class="hljs-operator">-</span> query_start <span class="hljs-keyword">AS</span> duration,
    state,
    <span class="hljs-built_in">substring</span>(query, <span class="hljs-number">1</span>, <span class="hljs-number">50</span>) <span class="hljs-keyword">AS</span> query
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">!=</span> <span class="hljs-string">'idle'</span>
  <span class="hljs-keyword">AND</span> query_start <span class="hljs-operator">&lt;</span> now() <span class="hljs-operator">-</span> <span class="hljs-type">interval</span> <span class="hljs-string">'5 seconds'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> duration <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>这个查询能找出运行超过5秒的SQL。我们在生产环境设置了log_min_duration_statement = 1000，自动记录超过1秒的查询。</p>
<h4 data-id="heading-14">锁等待检查</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pid, 
    wait_event_type, 
    wait_event, 
    query
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> wait_event_type <span class="hljs-operator">=</span> <span class="hljs-string">'Lock'</span>;
</code></pre>
<p>如果发现有查询长时间等锁，可能是有长事务或者死锁。找到阻塞的进程后，必要时可以用pg_terminate_backend杀掉。</p>
<h4 data-id="heading-15">磁盘空间</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看最大的表</span>
<span class="hljs-keyword">SELECT</span> 
    schemaname,
    tablename,
    pg_size_pretty(
        pg_total_relation_size(
            schemaname<span class="hljs-operator">||</span><span class="hljs-string">'.'</span><span class="hljs-operator">||</span>tablename
        )
    ) <span class="hljs-keyword">AS</span> total_size
<span class="hljs-keyword">FROM</span> pg_stat_user_tables
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> pg_total_relation_size(
    schemaname<span class="hljs-operator">||</span><span class="hljs-string">'.'</span><span class="hljs-operator">||</span>tablename
) <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;

<span class="hljs-comment">-- 查看WAL占用</span>
<span class="hljs-keyword">SELECT</span> 
    pg_size_pretty(<span class="hljs-built_in">sum</span>(size)) 
<span class="hljs-keyword">FROM</span> pg_ls_waldir();
</code></pre>
<p>我们有次WAL目录把磁盘撑爆了，原因是archive_command配置错误，WAL文件归档失败堆积。后来修复了归档命令，老的WAL才被清理掉。</p>
<h3 data-id="heading-16">踩过的一些坑</h3>
<h4 data-id="heading-17">连接数耗尽</h4>
<p>症状是应用报错"FATAL: sorry, too many clients already"。查了一下发现有几百个idle连接不释放，原来是应用的连接池配置有问题，连接泄露了。</p>
<p>临时解决办法是杀掉空闲太久的连接：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> pg_terminate_backend(pid)
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">=</span> <span class="hljs-string">'idle'</span>
  <span class="hljs-keyword">AND</span> now() <span class="hljs-operator">-</span> state_change <span class="hljs-operator">&gt;</span> <span class="hljs-type">interval</span> <span class="hljs-string">'2 hours'</span>;
</code></pre>
<p>长期解决还是要修应用代码，确保连接正确释放。</p>
<h4 data-id="heading-18">查询突然变慢</h4>
<p>有次线上查询突然慢了10倍，排查发现统计信息过期了，优化器选错了执行计划。手动ANALYZE后恢复正常：</p>
<pre><code class="hljs language-sql" lang="sql">ANALYZE table_name;
</code></pre>
<p>后来把autovacuum_analyze_scale_factor调小了，确保统计信息及时更新。</p>
<h4 data-id="heading-19">表膨胀</h4>
<p>前面提到过，MVCC会产生死元组。如果AutoVacuum跟不上，表会越来越大，查询越来越慢。除了调整AutoVacuum参数，严重的时候可能需要VACUUM FULL：</p>
<pre><code class="hljs language-sql" lang="sql">VACUUM <span class="hljs-keyword">FULL</span> table_name;
</code></pre>
<p>但要注意VACUUM FULL会锁表重写，生产环境要慎用。我们一般会在低峰期做，或者用pg_repack这种在线重建的工具。</p>
<h3 data-id="heading-20">一些建议</h3>
<p>用了几年PostgreSQL，总结一些经验：</p>
<p>启用AutoVacuum并定期检查执行情况，这个真的很重要。定期ANALYZE保持统计信息准确，特别是数据变化大的表。</p>
<p>使用连接池管理连接，别让应用直连数据库。我们用PgBouncer，效果挺好。</p>
<p>监控缓存命中率，保持在99%以上。如果太低说明shared_buffers不够或者查询模式有问题。</p>
<p>避免长事务，它会阻止VACUUM清理，导致表膨胀。我们现在规定分析类查询必须在只读副本上跑。</p>
<p>检查表膨胀率，及时处理超过20%的表。设置慢查询日志，log_min_duration_statement = 1000能帮你找到性能瓶颈。</p>
<p>在测试环境验证所有配置变更，有些参数改错了可能导致性能下降甚至启动失败。</p>
<p>建立完善的备份和恢复策略，定期演练恢复流程。我们用的是pg_basebackup做基础备份，加上WAL归档做增量。</p>
<h3 data-id="heading-21">Checkpoint机制也得了解下</h3>
<p>Checkpoint是PostgreSQL的一个重要机制，它负责把内存中的脏页全部刷到磁盘，创建一个一致性检查点。崩溃恢复的时候，只需要从最近的checkpoint开始重放WAL就行了。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Start[Checkpoint触发] --&gt; Scan[扫描Shared Buffers]
    Scan --&gt; Find[找出所有脏页]
    Find --&gt; Sort[按文件/页号排序]
    Sort --&gt; Write[顺序写入磁盘]
    Write --&gt; Sync[fsync强制刷盘]
    Sync --&gt; Update[更新pg_control]
    Update --&gt; Done[Checkpoint完成]
    
    style Start fill:#ff6b6b,stroke:#333,stroke-width:2px
    style Write fill:#4ecdc4,stroke:#333,stroke-width:2px
    style Done fill:#95e1d3,stroke:#333
</code></pre>
<p>Checkpoint的触发条件有几个：</p>
<ul>
<li>达到checkpoint_timeout时间（默认5分钟）</li>
<li>WAL日志达到max_wal_size大小（默认1GB）</li>
<li>手动执行CHECKPOINT命令</li>
<li>数据库关闭时</li>
</ul>
<p>Checkpoint配置要小心：</p>
<pre><code class="hljs language-conf" lang="conf">checkpoint_timeout = 10min              # 检查点最大间隔
checkpoint_completion_target = 0.9      # 在90%时间内完成

# 这个配置的意思是：
# 如果10分钟触发checkpoint，那会在9分钟内慢慢把脏页写完
# 这样可以平滑IO压力，不会一下子涌入大量写请求
</code></pre>
<p>我们之前checkpoint_completion_target设成0.1，结果checkpoint时IO瞬间打满，业务查询都变慢了。改成0.9后，IO压力平滑了很多。</p>
<p>可以在日志里看checkpoint的执行情况：</p>
<pre><code class="hljs language-conf" lang="conf">log_checkpoints = on
</code></pre>
<p>日志会输出类似这样的信息：</p>
<pre><code class="hljs language-ini" lang="ini">LOG:  checkpoint starting: time
LOG:  checkpoint complete: wrote 1953 buffers (11.9%)<span class="hljs-comment">; </span>
      0 WAL file(s) added, 0 removed, 1 recycled<span class="hljs-comment">; </span>
      <span class="hljs-attr">write</span>=<span class="hljs-number">8.505</span> s, sync=<span class="hljs-number">0.024</span> s, total=<span class="hljs-number">8.556</span> s<span class="hljs-comment">; </span>
      sync <span class="hljs-attr">files</span>=<span class="hljs-number">7</span>, longest=<span class="hljs-number">0.013</span> s, average=<span class="hljs-number">0.003</span> s
</code></pre>
<p>如果看到checkpoint频繁或者时间很长，可能需要调整参数。</p>
<h3 data-id="heading-22">后台进程的协作</h3>
<p>几个后台进程其实是配合工作的，理解它们的关系能更好地调优。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant BE as Backend进程
    participant SB as Shared Buffers
    participant BW as Background Writer
    participant CK as Checkpointer
    participant WW as WAL Writer
    participant WF as WAL Files
    participant DF as Data Files
    
    Note over BE,DF: 正常写入流程
    BE-&gt;&gt;SB: 修改数据页（标记脏页）
    BE-&gt;&gt;WF: 写WAL日志
    
    Note over BW: 每200ms醒来
    BW-&gt;&gt;SB: 扫描脏页
    BW-&gt;&gt;DF: 异步写入部分脏页
    Note right of BW: 减轻checkpoint压力
    
    Note over WW: 每200ms醒来
    WW-&gt;&gt;WF: 刷WAL缓冲
    
    Note over CK: 每10分钟或WAL满
    CK-&gt;&gt;SB: 扫描所有脏页
    CK-&gt;&gt;DF: 全部强制写入
    CK-&gt;&gt;DF: fsync确保落盘
    Note right of CK: 创建一致性检查点
</code></pre>
<p>Background Writer是个好帮手，它会提前把一些脏页写掉，这样checkpoint到来的时候压力就小多了。但它不会太激进，有个成本控制：</p>
<pre><code class="hljs language-conf" lang="conf">bgwriter_delay = 200ms                  # 扫描间隔
bgwriter_lru_maxpages = 100             # 每次最多写100页
bgwriter_lru_multiplier = 2.0           # 成本倍数
</code></pre>
<p>我们根据服务器的IO能力调整了这些参数。SSD的话可以把bgwriter_lru_maxpages调大一些，让它写得更积极。</p>
<h3 data-id="heading-23">进程间通信</h3>
<p>PostgreSQL的进程间通信主要靠共享内存和信号量。</p>
<p>所有进程都能访问共享内存，读写数据页、WAL缓冲、锁表等。但为了避免冲突，访问共享资源时需要用轻量锁（LWLock）或自旋锁（SpinLock）保护。</p>
<p>信号量用于进程间的同步，比如一个Backend等待另一个Backend释放锁。</p>
<p>查看当前进程信息：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pid,
    backend_type,
    backend_start,
    state,
    wait_event_type,
    wait_event
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> backend_start;
</code></pre>
<p>backend_type会显示进程类型：</p>
<ul>
<li>client backend：客户端连接的Backend进程</li>
<li>autovacuum worker：AutoVacuum工作进程</li>
<li>background writer：后台写进程</li>
<li>checkpointer：检查点进程</li>
<li>walwriter：WAL写进程</li>
</ul>
<p>如果看到很多进程的wait_event_type是Lock，说明锁竞争比较严重，可能需要优化业务逻辑。</p>
<h3 data-id="heading-24">一些调试技巧</h3>
<p>遇到问题的时候，有几个调试方法挺好用。</p>
<p><strong>查看进程在干什么</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    state_change,
    query
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">!=</span> <span class="hljs-string">'idle'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> query_start;
</code></pre>
<p>能看到每个活跃进程正在执行的SQL，执行了多久。</p>
<p><strong>查看锁等待关系</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    blocked.pid <span class="hljs-keyword">AS</span> blocked_pid,
    blocked.query <span class="hljs-keyword">AS</span> blocked_query,
    blocking.pid <span class="hljs-keyword">AS</span> blocking_pid,
    blocking.query <span class="hljs-keyword">AS</span> blocking_query
<span class="hljs-keyword">FROM</span> pg_stat_activity <span class="hljs-keyword">AS</span> blocked
<span class="hljs-keyword">JOIN</span> pg_stat_activity <span class="hljs-keyword">AS</span> blocking 
    <span class="hljs-keyword">ON</span> blocking.pid <span class="hljs-operator">=</span> <span class="hljs-keyword">ANY</span>(pg_blocking_pids(blocked.pid))
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">cardinality</span>(pg_blocking_pids(blocked.pid)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;
</code></pre>
<p>这个能找出谁阻塞了谁，对排查锁等待很有用。</p>
<p><strong>查看表和索引的使用情况</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 表扫描统计</span>
<span class="hljs-keyword">SELECT</span> 
    schemaname,
    tablename,
    seq_scan,           <span class="hljs-comment">-- 顺序扫描次数</span>
    seq_tup_read,       <span class="hljs-comment">-- 顺序扫描读取的行数</span>
    idx_scan,           <span class="hljs-comment">-- 索引扫描次数</span>
    idx_tup_fetch       <span class="hljs-comment">-- 索引扫描读取的行数</span>
<span class="hljs-keyword">FROM</span> pg_stat_user_tables
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> seq_scan <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>如果某个表的seq_scan很高但没有idx_scan，可能需要加索引。</p>
<p><strong>查看索引大小和使用情况</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) <span class="hljs-keyword">AS</span> index_size
<span class="hljs-keyword">FROM</span> pg_stat_user_indexes
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> idx_scan;
</code></pre>
<p>idx_scan为0的索引可能是无用索引，占着空间还拖慢写入速度，可以考虑删掉。</p>
<p><strong>分析慢查询</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 启用慢查询日志</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> log_min_duration_statement <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">-- 记录超过1秒的查询</span>
<span class="hljs-keyword">SELECT</span> pg_reload_conf();

<span class="hljs-comment">-- 或者临时设置</span>
<span class="hljs-keyword">SET</span> log_min_duration_statement <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
</code></pre>
<p>慢查询会记录到日志文件，可以用pgBadger这种工具分析。</p>
<h3 data-id="heading-25">复制和高可用</h3>
<p>PostgreSQL的流复制也是基于WAL的。主库把WAL日志流式传输给备库，备库不断重放WAL来保持同步。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Primary[主库] --&gt;|WAL Stream| Standby1[备库1]
    Primary --&gt;|WAL Stream| Standby2[备库2]
    
    Primary -.Archive.-&gt; Archive[WAL归档]
    Archive -.Restore.-&gt; Standby1
    Archive -.Restore.-&gt; Standby2
    
    style Primary fill:#ff6b6b,stroke:#333,stroke-width:3px
    style Standby1 fill:#4ecdc4,stroke:#333,stroke-width:2px
    style Standby2 fill:#4ecdc4,stroke:#333,stroke-width:2px
</code></pre>
<p>主库需要配置：</p>
<pre><code class="hljs language-conf" lang="conf">wal_level = replica                     # 启用复制级别WAL
max_wal_senders = 10                    # 最大WAL发送进程数
wal_keep_size = 1GB                     # 保留的WAL大小
</code></pre>
<p>备库通过一个叫WAL Receiver的进程接收WAL，然后由Startup进程重放。备库可以设置成hot standby模式，允许只读查询：</p>
<pre><code class="hljs language-conf" lang="conf">hot_standby = on                        # 允许备库只读
</code></pre>
<p>我们用备库做查询分流，把报表、分析这些查询都扔到备库上，减轻主库压力。不过要注意，备库重放WAL的时候可能和只读查询冲突，需要调整：</p>
<pre><code class="hljs language-conf" lang="conf">max_standby_streaming_delay = 30s       # 备库查询最多延迟重放30秒
</code></pre>
<p>如果备库查询时间太长，可能导致主备延迟增大。</p>
<h3 data-id="heading-26">一些性能优化的思路</h3>
<p>最后说说性能优化，这块其实没有银弹，要具体问题具体分析。</p>
<p><strong>索引优化</strong></p>
<p>索引是最直接有效的优化手段。但索引不是越多越好，每个索引都会拖慢写入速度。我们的原则是：</p>
<ul>
<li>经常用于WHERE、JOIN的列建索引</li>
<li>经常用于ORDER BY的列建索引</li>
<li>高选择性的列建索引（值分布比较均匀的）</li>
<li>定期检查无用索引，及时删除</li>
</ul>
<p><strong>查询优化</strong></p>
<p>用EXPLAIN ANALYZE看执行计划，找出瓶颈：</p>
<ul>
<li>全表扫描能否改成索引扫描</li>
<li>嵌套循环能否改成哈希连接</li>
<li>是否可以加条件减少扫描的行数</li>
</ul>
<p>有时候改写SQL比加索引效果更好。比如用EXISTS替代IN，用JOIN替代子查询等。</p>
<p><strong>分区表</strong></p>
<p>数据量特别大的表可以考虑分区。我们有张日志表，按月分区，查询只扫描相关分区，速度快很多：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> logs (
    id <span class="hljs-type">bigint</span>,
    created_at <span class="hljs-type">timestamp</span>,
    message text
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (created_at);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> logs_2024_01 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> logs
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2024-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2024-02-01'</span>);
    
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> logs_2024_02 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> logs
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2024-02-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2024-03-01'</span>);
</code></pre>
<p>分区表的维护比较麻烦，需要定期创建新分区、删除旧分区。我们写了个定时任务自动管理。</p>
<p><strong>连接池</strong></p>
<p>前面提过，用PgBouncer这种连接池能大大减少数据库的连接开销。PgBouncer支持三种池化模式：</p>
<ul>
<li>session：整个会话使用同一个数据库连接</li>
<li>transaction：每个事务使用一个连接</li>
<li>statement：每个语句使用一个连接</li>
</ul>
<p>我们用的是transaction模式，兼顾了连接复用和事务隔离。</p>
<p><strong>读写分离</strong></p>
<p>把只读查询分流到备库，可以减轻主库压力。但要注意主备延迟，如果业务对数据一致性要求高，可能不适合读写分离。</p>
<p>我们的做法是，实时性要求高的查询走主库，报表、分析这些可以容忍几秒延迟的走备库。</p>
<h3 data-id="heading-27">写在最后</h3>
<p>PostgreSQL的进程架构和内存管理其实还有很多细节，这篇文章只是覆盖了主要的部分。真正要用好PostgreSQL，还需要在实践中不断摸索和积累经验。</p>
<p>有些东西我也还在研究，比如JIT编译、并行查询、逻辑复制等。这些特性在特定场景下能带来显著的性能提升，但也有各自的适用条件和限制。</p>
<p>建议多看官方文档，多做测试，多关注社区的讨论。遇到问题的时候，查日志、看执行计划、分析统计信息，大部分问题都能找到线索。</p>
<p>如果这篇文章对你理解PostgreSQL有帮助，那就太好了。有问题或者想交流的，欢迎留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型能写80%的代码，却写不到95%？我成了“AI代码售后工程师”]]></title>    <link>https://juejin.cn/post/7572087162230571050</link>    <guid>https://juejin.cn/post/7572087162230571050</guid>    <pubDate>2025-11-14T01:39:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162230571050" data-draft-id="7572048000300892201" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型能写80%的代码，却写不到95%？我成了“AI代码售后工程师”"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-14T01:39:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型能写80%的代码，却写不到95%？我成了“AI代码售后工程师”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:39:13.000Z" title="Fri Nov 14 2025 01:39:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型能写80%的代码，却写不到95%？我成了“AI代码售后工程师”</h2>
<blockquote>
<p>作者：天天摸鱼的java工程师
发布于：2025年11月14日</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">👀 写在最前面：AI写代码，写到80%就“罢工”了？</h3>
<p>最近在用 TRAE SOLO 做一个 AI 智能报销系统的过程中，我突然意识到一个问题：</p>
<blockquote>
<p>大模型能帮我把项目从 0 写到 80%，但剩下的 20%，它写不了。</p>
</blockquote>
<p>准确来说，是写得“不够好”。</p>
<ul>
<li>它能秒出结构，但变量命名让我头皮发麻；</li>
<li>它能生成接口，但对接老系统时总出Bug；</li>
<li>它能跑得动，但跑得不稳、不安全、不规范。</li>
</ul>
<p>于是，这个身份就悄悄诞生了：</p>
<blockquote>
<p><strong>“大模型代码售后工程师”</strong></p>
</blockquote>
<p>这个角色，不再是传统意义上的“开发者”，而更像是「模型生成代码的品控员」「AI输出的验收官」「从80%到95%的缝合师」。</p>
<p>如果你也像我一样，经历过那种 <strong>“模型写得飞起，我改得头秃”</strong> 的开发体验，欢迎和我一起聊聊这篇文章的几个核心观点：</p>
<hr/>
<h3 data-id="heading-2">🧭 一、大模型能帮你启动项目，但不能帮你上线项目</h3>
<p>作为一名 Java 开发老兵，我接触过无数工具，从IDEA插件、代码生成器，到低代码平台，但没有什么工具像 <strong>TRAE SOLO</strong> 这样彻底颠覆我的开发认知。</p>
<p>用它开发时，我的流程大概是这样的：</p>
<ol>
<li>
<p><strong>用 SOLO coder 生成初始化项目结构</strong><br/>
👉 输入一句话：“开发一个支持OCR识别的报销系统”，它就能自动生成：</p>
<ul>
<li>Spring Boot 项目骨架</li>
<li>Controller / Service / Entity 分层结构</li>
<li>接口文档 + 数据结构说明</li>
</ul>
</li>
<li>
<p><strong>用模型完成核心业务逻辑生成</strong><br/>
👉 比如“识别发票有效期并判断是否可报销”，模型能直接生成OCR解析 + 规则判断 + 异常处理。</p>
</li>
<li>
<p><strong>用 DiffView 对比模型代码与已有代码的差异</strong><br/>
👉 这是我最喜欢的功能之一，能快速识别潜在Bug，比如模型生成的日期比较逻辑不兼容JDK8的LocalDate。</p>
</li>
</ol>
<p>看起来已经很“全能”了对吧？但问题来了：</p>
<blockquote>
<p>它生成的代码，是“能跑起来”，但不是“能上线”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">🧩 二、从80分到95分：这20%的鸿沟，模型真的跨不过去吗？</h3>
<p>很多人说，大模型已经能写绝大部分代码了，我们是不是要失业了？</p>
<p>我的答案是：<strong>不会失业，但你角色变了。</strong></p>
<p>我把大模型生成的“80%代码”称为： <strong>“形式正确，语义模糊”</strong> 。</p>
<ul>
<li>它知道要写什么，但不知道 <strong>为什么这么写</strong>；</li>
<li>它知道怎么调用API，但不知道这个API背后的 <strong>业务边界</strong>；</li>
<li>它知道逻辑流程，但不知道这个逻辑是否符合 <strong>团队规范、性能指标、安全要求</strong>。</li>
</ul>
<p>而这些，正是我们工程师从80分做到95分、甚至99分的关键能力。</p>
<h4 data-id="heading-4">🔧 举个例子：模型生成的“万能异常捕获”</h4>
<p>在我最近用 TRAE SOLO 开发的项目里，模型生成了这样的异常处理逻辑：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用OCR服务</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) {
    log.<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"OCR failed"</span>, e);
}
</code></pre>
<p>它没错，但也没对：</p>
<ul>
<li>没有区分网络异常 vs 数据格式异常</li>
<li>没有返回前端友好的错误码</li>
<li>没有上报监控系统，无法追踪</li>
</ul>
<p>所以，我手动改成了：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用OCR服务</span>
} <span class="hljs-keyword">catch</span> (HttpTimeoutException e) {
    log.warn(<span class="hljs-string">"OCR超时"</span>, e);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BusinessException(<span class="hljs-string">"OCR服务响应超时，请稍后再试"</span>);
} <span class="hljs-keyword">catch</span> (FormatException e) {
    log.error(<span class="hljs-string">"返回数据格式错误"</span>, e);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BusinessException(<span class="hljs-string">"OCR服务异常，请联系管理员"</span>);
}
</code></pre>
<p>这就是 <strong>“售后工程师” 的价值所在</strong>。</p>
<hr/>
<h3 data-id="heading-5">🧠 三、大模型不是“替你写代码”，而是“和你共创代码”</h3>
<p>很多人误解了大模型的角色，以为它是 “接班人”，其实它更像是 “合伙人”。</p>
<p>我在和 TRAE SOLO 协作开发时，内心是这样的：</p>
<ul>
<li>它帮我清空脑中思路，快速形成草图；</li>
<li>它帮我节省重复劳动，比如 CRUD 接口、配置文件；</li>
<li>它帮我发现我没想到的测试场景、边界问题；</li>
<li>它甚至在我疲惫时给我灵感（是的，我有时候会和它“对话式编程”）。</li>
</ul>
<p>但最终，<strong>决定代码能不能上线、是否稳定运行的，依然是我。</strong></p>
<p>所以，我把我的角色从“程序员”调整成了：</p>
<blockquote>
<p><strong>AI开发合作者 + 代码质量控制官 + AI输出润色器</strong></p>
</blockquote>
<p>这三重身份，正是每个走在前沿的工程师未来所必须具备的。</p>
<hr/>
<h3 data-id="heading-6">🔁 四、我如何用 TRAE SOLO 做“代码售后”？</h3>
<p>除了前面提到的 DiffView 和 SOLO coder，其实 TRAE SOLO 还有几个低调但巨实用的功能，适合“售后阶段”使用：</p>
<h4 data-id="heading-7">✅ 1. 自动生成测试脚本</h4>
<ul>
<li>支持Junit5、Mockito等框架</li>
<li>测试数据基于接口自动Mock</li>
<li>能提前暴露边界值问题</li>
</ul>
<h4 data-id="heading-8">✅ 2. 任务追踪系统</h4>
<ul>
<li>每次模型调用、每段代码生成都有日志记录</li>
<li>出问题能快速回溯“是我写的，还是AI写的”</li>
<li>非常适合多人协作和代码审计</li>
</ul>
<h4 data-id="heading-9">✅ 3. 多模型对比生成</h4>
<ul>
<li>我经常用Qwen和MiniMax对比生成同一段逻辑</li>
<li>再人工挑选最优实现</li>
<li>就像“代码A/B测试”，非常提升质量</li>
</ul>
<hr/>
<h3 data-id="heading-10">📌 五、写在最后：我们不会被AI替代，我们在AI之后</h3>
<p>很多人问我：你写Java 8年，现在还写得动代码吗？</p>
<p>我说：<strong>不是我写得动，而是我选择怎么写。</strong></p>
<p>我可以用键盘撸到底，也可以让AI和我一同构建系统。</p>
<p>但我知道，真正能让项目上线、稳定跑在生产环境的，不是AI的输出，而是我对代码质量的坚持、对系统边界的把控、对功能上线的负责。</p>
<blockquote>
<p>“AI可以写到80%，但上线要95%，<br/>
这15%，是我们工程师的专业价值。”</p>
</blockquote>
<p>所以，不用焦虑，不用恐慌，<br/>
只需要拥抱AI，用 TRAE SOLO 做你的搭档，<br/>
你就已经走在了大多数人前面。</p>
<blockquote>
<p>📢 本文首发于掘金，仅供学习交流，转载请注明出处。</p>
<p>如果你喜欢这样的实战分享，欢迎点赞 👍 收藏 ⭐ 关注 👀，<br/>
也欢迎在评论区说说你当过“AI代码售后工程师”吗？</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对 changelogen 和 changelogithub 使用的思考]]></title>    <link>https://juejin.cn/post/7572095192417828891</link>    <guid>https://juejin.cn/post/7572095192417828891</guid>    <pubDate>2025-11-13T17:34:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572095192417828891" data-draft-id="7572095192417812507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对 changelogen 和 changelogithub 使用的思考"/> <meta itemprop="keywords" content="前端,GitHub"/> <meta itemprop="datePublished" content="2025-11-13T17:34:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ruanCat"/> <meta itemprop="url" content="https://juejin.cn/user/2406144257559271"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对 changelogen 和 changelogithub 使用的思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2406144257559271/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ruanCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T17:34:09.000Z" title="Thu Nov 13 2025 17:34:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：</p>
<p>对 bumpp+changelogithub 和 changelogen 这两款发版方案的实践探索与对比。</p>
</blockquote>
<p>我试着使用这两款工具，实现<code>版本升级</code>、<code>更新日志生成</code>、和<code>依赖包发布</code>。不过用起来有点卡手，对我来说仅仅只使用部分的功能。</p>
<p>我打算在一个普通的管理后台项目内，使用这些工具，实现<code>版本升级</code>和<code>日志生成</code>。不考虑依赖包发布的事情，因为不可能发布一个管理后台到 npm 镜像内。</p>
<h2 data-id="heading-0">试着直接使用工作流的 changelogithub 和 bumpp 工具实现上述要求</h2>
<p>在 node 项目安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu-collective%2Fbumpp" target="_blank" title="https://github.com/antfu-collective/bumpp" ref="nofollow noopener noreferrer">bumpp</a> ，这是一个用来实现依赖包版本号升级的库，用于<strong>手动升级</strong>项目内根包的版本号。</p>
<p>在 package.json 内编写命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"release:bumpp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bumpp"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">bumpp 的默认行为不适合同步上传本地修改的 <code>CHANGELOG.md</code> 文件</h2>
<p>bumpp 是一个很单纯的，对版本号做升级的工具。阅读文档，其默认开启了一下三款参数：</p>
<ol>
<li><code>--commit</code> 默认生成 git commit 提交信息。</li>
<li><code>--tag</code> 默认生成 git tag 版本。</li>
<li><code>--push</code> 默认同时推送 tag 和 commit 信息。</li>
</ol>
<p>这些默认行为不好去拆分处理，彼此相互耦合，形成了一套固定的，<strong>仅仅对外更新 package.json 版本号和推送 git tag</strong> 的工作流程。</p>
<p>如果我想拆分掉其中的内容，重新有机组合自己的工作流程，就很<strong>坐牢</strong>。</p>
<h3 data-id="heading-2">试着在本次 git commit 生成的时候，不默认提交到本地仓库</h3>
<p>这事实上做不到，只要你写配置，就一定会生成 git commit，并且默认推送到本地 git 仓库。而且你的 git commit 仅仅只有一个文件修改和一个 tag 提交，你不能添加额外的东西。</p>
<p>比如说我想在更新版本号后，同时更新 <code>CHANGELOG.md</code> 文件，然后再提交。让一次 git commit 同时包含三个内容：</p>
<ul>
<li>被更新的 <code>CHANGELOG.md</code> 文件。</li>
<li>被更新的根目录 <code>package.json</code> 文件。</li>
<li>新增的 git tag 标签。</li>
</ul>
<p>这是做不到的，bumpp 工具没办法让你多上传一个被更改的本地文件。</p>
<p>基于 bumpp 工具的版本升级逻辑，就不允许，也不考虑你在本地写入、更新、并推送<code>CHANGELOG.md</code> 文件到 git 仓库。你的每次 git commit 只能包含以下两个内容：</p>
<ul>
<li>被更新的根目录 <code>package.json</code> 文件。</li>
<li>新增的 git tag 标签。</li>
</ul>
<p>这种逻辑你必须接受，否则你就别用 bumpp 来升级版本号。这让我非常难受，因为我之前习惯用 changset 来更新版本号，并且每次提交的时候，都是可以一次性提交：</p>
<ol>
<li>被更新的 <code>CHANGELOG.md</code> 文件。</li>
<li>被更新的根目录 <code>package.json</code> 文件。</li>
<li>新增的 git tag 标签。</li>
</ol>
<p>这些都可以自由掌控，而 bumpp 发版工具卡死了，限定死了。不允许你有多余的日志更新与上传行为。</p>
<h3 data-id="heading-3">试着在 <code>bump.config.ts</code> 内不提供 <code>--tag</code> 参数</h3>
<p>这事实上是不可理喻的，反而让自己坐牢。不提供 tag 参数，bumpp 甚至没办法给 package.json 更新有意义的版本号，直接留空，无法写入。</p>
<h3 data-id="heading-4">试着在 <code>bump.config.ts</code> 内不提供 <code>--push</code> 参数</h3>
<p>这反而自己坐牢。不提供 <code>--push</code> 参数，虽然 package.json 的修改没有被默认推送到本地 git 仓库，可是 tag 标签却没办法推送，要自己手动不全 git 的推送参数才行。</p>
<pre><code class="hljs language-bash" lang="bash">git push --follow-tags
</code></pre>
<p>你要自己找机会，确保生成的 tag 被推送云端仓库，才能不会漏东西。这反而加重了心智负担。</p>
<h3 data-id="heading-5">结论： bumpp 就不给你机会生成什么日志文件</h3>
<p>bumpp 本身的默认行为就不适合你在任何渠道内同时上传本地的 <code>CHANGELOG.md</code> 文件、package.json 的版本号和 git tag 标签。</p>
<h2 data-id="heading-6">bumpp 事实上和 changelogithub 高度耦合的</h2>
<p>我上面折腾那么久，不就是为了实现在本地生成 <code>CHANGELOG.md</code> 文件并且一同上传么？我就是喜欢 changeset 这种提交方式啊。</p>
<p>所以更新日志的生成能力，只能仰赖其他的工具。经过调研，bumpp 经常是用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fchangelogithub" target="_blank" title="https://github.com/antfu/changelogithub" ref="nofollow noopener noreferrer">changelogithub</a> 来生成更新日志的。</p>
<p>但是很不巧的是，changelogithub 本身就仅仅只考虑生成最好的 github release 更新日志，不考虑生成本地的 <code>CHANGELOG.md</code> 更新日志。</p>
<h3 data-id="heading-7">正常使用 changelogithub 的工作流</h3>
<p>一般来说，changelogithub 是在 github workflow 工作流配置文件内写的，而且往往是通过 git tag 来触发工作流的。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github\workflows\release.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Release</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"v*"</span>

<span class="hljs-attr">permissions:</span> <span class="hljs-string">write-all</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">release:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">设置javascript环境</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">sxzz/workflows/setup-js@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">fetch-all:</span> <span class="hljs-literal">false</span>
          <span class="hljs-attr">package-manager:</span> <span class="hljs-string">pnpm</span>
          <span class="hljs-attr">auto-install:</span> <span class="hljs-literal">true</span>

			<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">用</span> <span class="hljs-string">changelogithub</span> <span class="hljs-string">生成</span> <span class="hljs-string">github</span> <span class="hljs-string">release</span> <span class="hljs-string">发行版日志</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">dlx</span> <span class="hljs-string">changelogithub</span>
        <span class="hljs-attr">continue-on-error:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">GITHUB_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
</code></pre>
<p>在工作流内写起来很简单，很优雅。但是只负责，只考虑在 github release 内发布更新日志。</p>
<h3 data-id="heading-8">尝试在 github workflow 内让 changelogithub 生成日志文件</h3>
<p>实在不行我试着让 changelogithub 在云端工作流内，也写入 <code>CHANGELOG.md</code> 更新日志，再实现提交。</p>
<ol>
<li>在 github workflow 内额外增加一个步骤 <code>pnpm dlx changelogithub --output "CHANGELOG.md"</code> 。在云端内写入文件。</li>
<li>在云端的 git 内设置用户名、邮箱。</li>
<li>确定云端 git 的分支名称。</li>
<li>推送到 origin 远程仓库。</li>
<li>本机仓库再 git fetch 拉取更新。</li>
</ol>
<p>这套流程很麻烦，要实现云端生成文件、修改文件、生成 git commit 提交并拉取更新，太麻烦了。我都套模板了，至于搞那么复杂么？</p>
<p>这套流程不好走通，而且 changelogithub 本身提供的 <code>--output</code> 参数在仓库文档内是不写清楚的，要你自己亲自看源码才知道有这个参数的。可想而知这个方案太离谱，太弯弯绕绕了。太卡手了，不能去落实下去。</p>
<h3 data-id="heading-9">尝试在本地仓库用 changelogithub 生成日志文件，然后额外提交一个 git commit 专门说明更新了日志文件</h3>
<p>这肯定很不优雅嘛。哪有一个 git commit 提交专门为了说明一个版本更新的日志的。那肯定会问，为什么更新日志不能和更新版本后的 package.json 一起发布呢？</p>
<p>这问题又绕回来了，bumpp 没办法让我做到这一点。这就意味着，只要我使用这一套 <code>bumpp</code> + <code>changelogithub</code> 的发版工作流，就算能生成本地日志文件，git commit 提交也被迫变乱。</p>
<h3 data-id="heading-10">changelogithub 本地生成的 <code>CHANGELOG.md</code> 更新日志太难看</h3>
<p>在本地运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm dlx changelogithub --output <span class="hljs-string">"CHANGELOG.md"</span>
</code></pre>
<p>控制台内看起来很好看：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/763577f1aa7640eb84dbba8ebdd49b04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=4BBq8GKpujfSuF%2FyYtq2J9DH1GA%3D" alt="2025-11-13-22-47-30" loading="lazy"/></p>
<p>但是实际在 <code>CHANGELOG.md</code> 文件内，看的难看的要死：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc1ce05a99d14a468efc88f3068aabcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=yS5hcGhouMplO6xuR7v6FegG3Os%3D" alt="2025-11-13-22-48-16" loading="lazy"/></p>
<p>满屏幕都是 <code>&amp;nbsp;</code> 空格，这个 <code>CHANGELOG.md</code> 文件都不是给人看的。这不能接受吧，不可能去生成这种全都是 <code>&amp;nbsp;</code> 空格的文件给人去阅读的，太离谱了。</p>
<h3 data-id="heading-11">结论： changelogithub 就不给你在本地生成能看的日志文件</h3>
<p>所以很遗憾，只能放弃掉用 changelogithub 在云端和本地生成 <code>CHANGELOG.md</code> 文件的方案。</p>
<p>changelogithub 的用途就卡死了，自己就仅仅限定在 github workflow 工作流内，根据 tag 标签触发更新，生成 github release 更新日志。</p>
<p>完全不能去生成任何实体的，具体的 <code>CHANGELOG.md</code> 文件。</p>
<p>在生成 github release 日志这件事上，这个工具很优雅。但也就只能做这一种事情。</p>
<h2 data-id="heading-12">尝试用 bumpp + changelogen 的搭配来生成本地的更新日志文件</h2>
<p>那既然本地用 changelogithub 生成 <code>CHANGELOG.md</code> 文件是一坨答辩，那我退而求其次用更加根本的 changelogen 来生成更新日志，行不行呢？</p>
<p>changelogithub 本质上就是对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funjs%2Fchangelogen" target="_blank" title="https://github.com/unjs/changelogen" ref="nofollow noopener noreferrer">changelogen</a> 的二次封装，在 bumpp 升级版本后，紧接着用 changelogen 来生成：</p>
<p>运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm dlx changelogen --output <span class="hljs-string">"CHANGELOG.md"</span>
</code></pre>
<p>实际出现一个致命缺陷，changelogen 没办法在本地内判断上一个 tag 标签和最新的 tag 标签，导致生成的更新日志是空的。两个相同版本号之间是没有任何差异的，所以日志是空的。</p>
<h2 data-id="heading-13">尝试单独使用 changelogen 完成一整个版本升级和日志生成工作</h2>
<p>我就很纳闷了，changelogen 有那么废物么？在 bumpp 升级版本后，紧接着用 changelogen 来生成本地日志，结果无法判断版本号差异？生成空日志？</p>
<p>我很怀疑 changelogen 本身是不能去依赖别人来更新版本号的，如果让 changelogen 自己去实现版本号升级，并且自己去生成日志，会怎么样？</p>
<p>这是一套完全独立的新方案了。和 <code>bumpp</code> + <code>changelogithub</code> 方案完全不同了。</p>
<h3 data-id="heading-14">编写命令并生成版本号</h3>
<p>阅读 changelogen 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funjs%2Fchangelogen%2Fblob%2Fmain%2FREADME.md" target="_blank" title="https://github.com/unjs/changelogen/blob/main/README.md" ref="nofollow noopener noreferrer">README</a> 文档，得知要想让 changelogen 独立完成上述工作，需要以下这几个参数：</p>
<ol>
<li><code>--bump</code> 根据 git 语义化提交来确定版本号，写入 package.json 文件并升级版本号。</li>
<li><code>--release</code> 生成更新日志。并生成 git tag。</li>
<li><code>--push</code> 根据预设的 git commit 模板，同时推送：
<ul>
<li>升级版本号，更改后的 package.json 文件。</li>
<li>更新日志文件。</li>
<li>git tag 标签。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"release:changelogen"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"changelogen --bump --release --push"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c59e1a469d4976a357f9ece336ec3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=Cs6%2FZI7dP7kLVgmzU6H6oGKZZTk%3D" alt="2025-11-13-23-13-24" loading="lazy"/></p>
<p>查看 git 记录，同时有 git tag、本地的修改日志文件、被修改的 package.json。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d3d5b8696a7410e9cde19ab297212f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=QsFu3M73Hg6UXWwsiSwP%2BPEMfIk%3D" alt="2025-11-13-23-14-45" loading="lazy"/></p>
<p>而且本地的 <code>CHANGELOG.md</code> 文件很工整美观：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c12c3dd74f73499bb15b177f0a6d214d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=Ivrh%2BSPkxFKxL%2BmcEf3f%2BaUlsDQ%3D" alt="2025-11-13-23-15-42" loading="lazy"/></p>
<p>这很完美哦，完美满足了我上面的全部需求。不过单独的 changelogen 方案还是有一些问题的。</p>
<h3 data-id="heading-15">容易误触</h3>
<p>你一点击，你就发布更新了。你要手动撤回 git 修改内容才行，包括手动删除掉推送的 tag 标签。</p>
<p>误触撤回比较麻烦。很容易不小心就触发版本更新了。</p>
<h3 data-id="heading-16">没办法自己确定版本号</h3>
<p>changelogen 是根据语义化的 git commit 信息，来自主判断确定版本号的。你没得选版本号。</p>
<h3 data-id="heading-17">总是会自己打开 github release 页面</h3>
<p>目前 changelogen 是没有办法自己关闭掉默认打开 github release 页面的行为的，这一点有点恼人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5528a33f7864583a82b27abee54e9da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763660049&amp;x-signature=G4rVW0ugMKvAmMwFXNElCSqhTs0%3D" alt="2025-11-13-23-17-10" loading="lazy"/></p>
<h3 data-id="heading-18">总结： 顾此失彼，失去对版本号的手动控制了</h3>
<p>changelogen 能独立完成我的核心需求，但是我却没办法手动精准选择版本号了。只能按照语义化的发版规则，自主更新版本号。</p>
<h2 data-id="heading-19">方案对比总结表</h2>
<p>经过上述的折腾，可以总结出这两款方案的使用细节差异：</p>













































<table><thead><tr><th align="center">方案</th><th align="center"><code>bumpp</code> + <code>changelogithub</code> 结合方案</th><th align="center">单独 <code>changelogen</code> 方案</th></tr></thead><tbody><tr><td align="center">能否手动控制版本号？</td><td align="center">可以用 bumpp 手动选择版本号</td><td align="center">不能，根据 conventionalcommits 约定式提交来生成版本号</td></tr><tr><td align="center">本地自动生成的提交 <br/> 包含 git tag 标签？</td><td align="center">包含</td><td align="center">包含</td></tr><tr><td align="center">本地自动生成的提交 <br/> 包含 <code>package.json</code> ？</td><td align="center">包含</td><td align="center">包含</td></tr><tr><td align="center">本地自动生成的提交 <br/> 包含 <code>CHANGELOG.md</code> ？</td><td align="center">不包含</td><td align="center">包含</td></tr><tr><td align="center">本地生成的 <code>CHANGELOG.md</code> 是否美观？</td><td align="center">不美观。滥用 <code>&amp;nbsp;</code> 空格</td><td align="center">正常。没有冗余的 <code>&amp;nbsp;</code> 空格</td></tr><tr><td align="center">是否方便生成本地的 <code>CHANGELOG.md</code> 文件？</td><td align="center">不方便</td><td align="center">正常生成</td></tr><tr><td align="center">是否方便生成云端的 <code>github release</code> 日志？</td><td align="center">正常生成</td><td align="center">不方便，默认手动上传</td></tr></tbody></table>
<h2 data-id="heading-20">发版方案对比总结表</h2>
<p>就仅仅针对 <em>更新版本号</em> 、 <em>维护 <code>CHANGELOG.md</code> 更新日志文件</em> 与 <em>推送 github release 更新日志</em> 这三件事而言，不同的发版方案有不同的处理细节。总结如下：</p>

























































































<table><thead><tr><th align="center">发版方案</th><th align="center"><code>bumpp</code> + <code>changelogithub</code></th><th align="center"><code>changelogen</code></th><th align="center"><code>changeset</code></th></tr></thead><tbody><tr><td align="center">更新 package.json 版本号</td><td align="center">由 bumpp 可独立完成</td><td align="center">由 <code>--bump</code> 参数实现</td><td align="center"><code>changeset version</code> 命令消耗变更集并按配置更新</td></tr><tr><td align="center">如何控制 semver 语义化版本</td><td align="center">由 bumpp 手动选择</td><td align="center">由 conventionalcommits 自动映射</td><td align="center">在 <code>changeset add</code> 命令内手动选择 <br/> 或在变更集文件手动编写</td></tr><tr><td align="center">更新日志内容</td><td align="center">由 conventionalcommits 自动生成</td><td align="center">由 conventionalcommits 自动生成</td><td align="center">手动编写</td></tr><tr><td align="center">对 monorepo 的支持</td><td align="center">全部包共用唯一一个版本号</td><td align="center">全部包共用唯一一个版本号</td><td align="center">每个包有独立的版本号 <br/> 也可以通过配置实现共用版本号</td></tr><tr><td align="center">git 提交允许 <code>CHANGELOG.md</code></td><td align="center">不包含本地的 <code>CHANGELOG.md</code> 文件</td><td align="center">允许上传</td><td align="center">允许上传，消耗变更集会默认包含本地的 <code>CHANGELOG.md</code> 文件</td></tr><tr><td align="center">生成 github release 日志</td><td align="center">由 changelogithub 独立生成</td><td align="center">在 github 工作流内自动生成</td><td align="center">不能独立生成。须依赖额外的 <code>changesets/action</code> 工作流完成</td></tr><tr><td align="center">github workflow 触发方式</td><td align="center">由 git tag 触发工作流</td><td align="center">由 git tag 触发工作流</td><td align="center">分两步：<code>changesets/action</code> 识别变更集生成 pr；合并 pr 更新版本</td></tr><tr><td align="center">发版流程的心智负担</td><td align="center">轻量级，无负担</td><td align="center">还行</td><td align="center">繁杂。手动写更新日志，并围绕变更集，合并 pr 完成发版</td></tr><tr><td align="center">发版速度</td><td align="center">最快</td><td align="center">最快</td><td align="center">最慢，很多步骤需要人工确认</td></tr><tr><td align="center">是否容易误触</td><td align="center">容易误触</td><td align="center">容易误触</td><td align="center">全人工编写变更集 + 手动合合并 pr ，几乎没有误触风险</td></tr><tr><td align="center">方案落地难度</td><td align="center">非常简单</td><td align="center">略有重复代码，也很简单</td><td align="center">稍微比较复杂，有多个常用命令要声明</td></tr><tr><td align="center">适用代码与团队规模</td><td align="center">个人、单仓库、小团队</td><td align="center">个人、单仓库、小团队</td><td align="center">多人协作、多包维护、严格流程的大团队</td></tr><tr><td align="center">对比其他方案的综合评价</td><td align="center">轻量级，无负担</td><td align="center">还行。保持平衡</td><td align="center">最通用，最繁杂，生态最完整</td></tr></tbody></table>
<blockquote>
<p>该总结表也是作者在 2025 年内，<strong>折腾</strong>发包发版和日志生成时，最有价值的表格了。</p>
</blockquote>
<h2 data-id="heading-21">使用建议</h2>
<ol>
<li>如果是公司级别的正式的，规范的项目。那我选择 <code>changeset</code> 方案，因为可以手动编写更新日志，多人审核复核，人工控制发版版本号。</li>
<li>如果是单人维护的，放到 github 的小项目。那我选择 <code>changelogen</code> 方案，有一个差不多能看的更新日志，本地能看，github release 也能看日志，语义化的版本号，就够用了。</li>
<li>如果是追求快速落地的 npm 包发布。那我选择 <code>bumpp</code> + <code>changelogithub</code> 方案，该方案落地最快，实现最快，配置最少，发版最迅速。</li>
</ol>
<p>回到最初的需求，我打算在一个普通的管理后台项目内，实现<code>版本升级</code>和<code>日志生成</code>。我应该选择 <code>changelogen</code> 方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 从入门到精通：状态管理入门 - setState 的局限性与 Provider 的优雅之道]]></title>    <link>https://juejin.cn/post/7572010680897503272</link>    <guid>https://juejin.cn/post/7572010680897503272</guid>    <pubDate>2025-11-14T01:33:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680897503272" data-draft-id="7572010680897486888" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 从入门到精通：状态管理入门 - setState 的局限性与 Provider 的优雅之道"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-14T01:33:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zuckjet_"/> <meta itemprop="url" content="https://juejin.cn/user/3200023607119418"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 从入门到精通：状态管理入门 - setState 的局限性与 Provider 的优雅之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3200023607119418/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zuckjet_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:33:21.000Z" title="Fri Nov 14 2025 01:33:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你已经写过一些 <code>Flutter</code> 代码，你一定对 <code>StatefulWidget</code> 和 <code>setState</code> 不陌生。当你需要更新屏幕上的某些内容时——比如用户点击按钮后，一个数字增加了——<code>setState</code> 是你最先学到的工具。</p>
<p>然而，随着应用逻辑变得复杂，你可能会发现仅仅依靠 <code>setState</code> 会让代码变得混乱、难以维护，甚至引发性能问题。这时，你就需要一个更专业的状态管理方案。</p>
<p>这篇文章将带你：</p>
<ol>
<li>深入理解 <code>setState</code> 的工作机制。</li>
<li>剖析 <code>setState</code> 在复杂应用中的三大局限性。</li>
<li>入门 <code>Flutter</code> 官方推荐的、最简单直观的状态管理库 <code>Provider</code>。</li>
<li>亲手将一个 <code>setState</code> 案例重构为 <code>Provider</code> 实现，感受其魅力。</li>
</ol>
<h4 data-id="heading-0">1. 一切的开始：<code>setState</code></h4>
<p>在 <code>Flutter</code> 中，“状态 (State)” 是什么？简单来说，<strong>状态就是可以随时间变化的、会影响 <code>UI</code> 呈现的数据</strong>。一个计数器的当前数值、一个加载指示器是否显示、一个用户的登录信息，这些都是状态。</p>
<p><code>StatefulWidget</code> 与其关联的 <code>State</code> 对象就是 <code>Flutter</code> 管理局部状态的基础。当我们调用 <code>setState</code> 方法时，发生了三件事：</p>
<ol>
<li><strong>更新数据</strong>：你在 <code>setState</code> 的回调函数中改变了某个状态变量的值。</li>
<li><strong>标记为“脏” (Dirty)</strong>：<code>Flutter</code> 框架会将当前 <code>Widget</code> 标记为“需要重建”。</li>
<li><strong>触发重建</strong>：在下一帧绘制时，<code>Flutter</code> 会重新调用这个 <code>Widget</code> 的 <code>build</code> 方法，使用新的状态数据来构建 <code>UI</code>，从而更新屏幕。</li>
</ol>
<p>让我们来看一个最经典的计数器例子：</p>
<pre><code class="hljs language-php" lang="php">import <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span><span class="hljs-title function_ invoke__"> main</span>() {
  <span class="hljs-title function_ invoke__">runApp</span>(<span class="hljs-keyword">const</span><span class="hljs-title function_ invoke__"> MyApp</span>());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyApp</span>({super.key});

  @override
  <span class="hljs-title function_ invoke__">Widget build</span>(BuildContext context) {
    <span class="hljs-keyword">return</span><span class="hljs-title function_ invoke__"> const MaterialApp</span>(
<span class="hljs-attr">      home</span>: <span class="hljs-title function_ invoke__">CounterPage</span>(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CounterPage</span>({super.key});

  @override
  State&lt;CounterPage&gt; <span class="hljs-title function_ invoke__">createState</span>() =&gt; <span class="hljs-title function_ invoke__">_CounterPageState</span>();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CounterPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CounterPage</span>&gt; </span>{
  <span class="hljs-keyword">int</span> _counter = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">void</span><span class="hljs-title function_ invoke__"> _incrementCounter</span>() {
    <span class="hljs-comment">// 调用 setState 来更新 UI</span>
    <span class="hljs-title function_ invoke__">setState</span>(() {
      <span class="hljs-comment">// 在这个回调中改变状态变量</span>
      _counter++;
    });
  }

  @override
  <span class="hljs-title function_ invoke__">Widget build</span>(BuildContext context) {
    <span class="hljs-keyword">print</span>(<span class="hljs-string">'CounterPage build method called!'</span>); <span class="hljs-comment">// 添加打印以便观察</span>
    <span class="hljs-keyword">return</span><span class="hljs-title function_ invoke__"> Scaffold</span>(
<span class="hljs-attr">      appBar</span>: <span class="hljs-title function_ invoke__">AppBar</span>(
<span class="hljs-attr">        title</span>: <span class="hljs-keyword">const</span><span class="hljs-title function_ invoke__"> Text</span>(<span class="hljs-string">'setState Demo'</span>),
      ),
<span class="hljs-attr">      body</span>: <span class="hljs-title function_ invoke__">Center</span>(
<span class="hljs-attr">        child</span>: <span class="hljs-title function_ invoke__">Column</span>(
<span class="hljs-attr">          mainAxisAlignment</span>: MainAxisAlignment.center,
<span class="hljs-attr">          children</span>: &lt;Widget&gt;[
            <span class="hljs-keyword">const</span><span class="hljs-title function_ invoke__"> Text</span>(<span class="hljs-string">'You have pushed the button this many times:'</span>),
            <span class="hljs-title function_ invoke__">Text</span>(
              <span class="hljs-string">'$_counter'</span>,
<span class="hljs-attr">              style</span>: Theme.<span class="hljs-title function_ invoke__">of</span>(context).textTheme.headlineMedium,
            ),
          ],
        ),
      ),
<span class="hljs-attr">      floatingActionButton</span>: <span class="hljs-title function_ invoke__">FloatingActionButton</span>(
<span class="hljs-attr">        onPressed</span>: _incrementCounter,
<span class="hljs-attr">        tooltip</span>: <span class="hljs-string">'Increment'</span>,
<span class="hljs-attr">        child</span>: <span class="hljs-keyword">const</span><span class="hljs-title function_ invoke__"> Icon</span>(Icons.add),
      ),
    );
  }
}
</code></pre>
<p>这个例子完美地展示了 <code>setState</code> 的用法，对于单一 <code>Widget</code> 内部的状态管理，<code>setState</code> 简单有效。</p>
<h4 data-id="heading-1">2. <code>setState</code> 的三大局限性</h4>
<p>当我们的应用只有一个页面时，一切都很美好。但现实是复杂的，<code>setState</code> 的问题很快就会暴露出来。</p>
<h5 data-id="heading-2">局限一：状态提升困难 (State Lifting)</h5>
<p>假设你想在 <code>AppBar</code> 的标题中也显示这个计数器的值。<code>_counter</code> 状态现在位于 <code>_CounterPageState</code> 中，<code>AppBar</code> 却在它的 <code>build</code> 方法里。更糟糕的是，如果另一个完全不同的页面也需要这个 <code>_counter</code> 的值呢？</p>
<p><code>setState</code> 管理的状态是<strong>与特定 <code>Widget</code> 实例绑定的</strong>。要跨 <code>Widget</code> 共享状态，你唯一的办法就是“状态提升”——将状态移动到需要它的所有 <code>Widget</code> 的共同父 <code>Widget</code> 中，然后通过构造函数层层传递下来。如果状态需要被子 <code>Widget</code> 修改，你还需要将修改状态的回调函数也一并层层传递下去。</p>
<p>这个过程很快就会变成一场噩梦，我们称之为“回调地狱”或“属性钻取 (Prop Drilling)”。</p>
<h5 data-id="heading-3">局限二：不必要的 <code>Widget</code> 重建</h5>
<p>观察上面代码中的 <code>print</code> 语句。每次你点击按钮，控制台都会打印 "CounterPage build method called!"。</p>
<p>这意味着整个 <code>CounterPage</code> 的 <code>build</code> 方法都被重新执行了。在这个简单的例子里，这没什么大不了。但在一个复杂的页面中，<code>Scaffold</code> 下可能有一个包含成百上千个 <code>Widget</code> 的复杂树。<code>setState</code> 会把它们<strong>全部重建</strong>，即使大部分 <code>Widget</code> 根本不依赖 <code>_counter</code> 这个变量。</p>
<p>这种粗粒度的重建是 <code>Flutter</code> 性能问题的主要来源之一。我们理想的更新应该是<strong>精确</strong>的，只重建那些真正依赖数据的 <code>Widget</code>。</p>
<h5 data-id="heading-4">局限三：业务逻辑与 UI 耦合</h5>
<p>在 <code>_CounterPageState</code> 中， <code>_incrementCounter</code> 这个<strong>业务逻辑</strong>（如何改变数据）和 <code>build</code> 方法这个<strong>UI 逻辑</strong>（如何展示数据）被紧紧地捆绑在同一个类里。</p>
<p>随着业务逻辑越来越复杂（例如，<code>_incrementCounter</code> 需要发起网络请求，并处理成功或失败的情况），这个 <code>State</code> 类会变得越来越臃肿，难以阅读、测试和维护。一个良好的架构应该让 <code>UI</code> 和业务逻辑分离。</p>
<h4 data-id="heading-5">3. 救星登场：<code>Provider</code></h4>
<p>为了解决上述问题，社区涌现了许多状态管理方案，如 <code>Provider</code>, <code>Riverpod</code>, <code>BLoC</code>, <code>Redux</code>, <code>MobX</code> 等。</p>
<p><code>Provider</code> 是官方推荐的入门首选，它由社区开发者 <code>Remi Rousselet</code> 创建（他也是 <code>Riverpod</code> 的作者），后来被 <code>Flutter</code> 团队收编为 "Flutter Favorite" 包。</p>
<p><code>Provider</code> 的核心思想很简单：</p>
<ol>
<li>将<strong>状态（数据和业务逻辑）</strong> 从 <code>Widget</code> 中抽离到一个独立的类中。</li>
<li>通过一个“提供者” <code>Widget</code> (<code>ChangeNotifierProvider</code>) 将这个类的实例放入 <code>Widget</code> 树的顶层。</li>
<li>在树下的任何子 <code>Widget</code> 中，都可以轻松地“获取”这个实例，来读取状态或调用方法。</li>
<li>当状态改变时，只有那些“正在监听”这个状态的 <code>Widget</code> 会被重建。</li>
</ol>
<h4 data-id="heading-6">4. 使用 <code>Provider</code> 重构计数器应用</h4>
<p>让我们用 <code>Provider</code> 的思想来重构上面的例子。</p>
<h5 data-id="heading-7">第一步：添加 <code>provider</code> 依赖</h5>
<p>在 <code>pubspec.yaml</code> 文件中添加依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-string">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-string">provider:</span> <span class="hljs-string">^6.1.2</span> <span class="hljs-comment"># 推荐使用最新版本</span>
</code></pre>
<p>然后运行 <code>flutter pub get</code>。</p>
<h5 data-id="heading-8">第二步：创建状态模型 (Model)</h5>
<p>我们将状态和业务逻辑抽离出来，创建一个 <code>CounterModel</code>。它需要混入 (mixin) <code>ChangeNotifier</code>，这是 <code>Flutter SDK</code> 内置的一个简单的类，它能让我们在状态改变时通知监听者。</p>
<p>创建一个新文件 <code>lib/counter_model.dart</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterModel</span> with ChangeNotifier {
  <span class="hljs-type">int</span> _count = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 读取数据的 getter</span>
  <span class="hljs-type">int</span> get count =&gt; _count;

  <span class="hljs-comment">// 修改数据并通知监听者的方法</span>
  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    _count++;
    <span class="hljs-built_in">notifyListeners</span>(); <span class="hljs-comment">// 关键！通知所有监听者数据已改变。</span>
  }
}
</code></pre>
<ul>
<li><code>ChangeNotifier</code>：提供了 <code>notifyListeners()</code> 方法。</li>
<li><code>notifyListeners()</code>：当我们的数据 (<code>_count</code>) 改变后，调用此方法，所有监听这个 <code>CounterModel</code> 的 <code>Widget</code> 都会被通知，并触发重建。</li>
</ul>
<h5 data-id="heading-9">第三步：提供模型实例</h5>
<p>我们需要在 <code>Widget</code> 树的顶端提供 <code>CounterModel</code> 的实例，以便下面的 <code>Widget</code> 可以访问它。通常，我们把它放在 <code>MaterialApp</code> 的上一层。</p>
<p>修改 <code>main.dart</code>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">flutter</span>/<span class="hljs-selector-tag">material</span><span class="hljs-selector-class">.dart</span>';
<span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">provider</span>/<span class="hljs-selector-tag">provider</span><span class="hljs-selector-class">.dart</span>';
<span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">counter_model</span><span class="hljs-selector-class">.dart</span>'; <span class="hljs-comment">// 导入我们创建的模型</span>

<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>() {
  <span class="hljs-selector-tag">runApp</span>(const <span class="hljs-built_in">MyApp</span>());
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MyApp</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatelessWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">MyApp</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>});

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-comment">// 3. 使用 ChangeNotifierProvider 包裹 MaterialApp</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ChangeNotifierProvider</span>(
      <span class="hljs-attribute">create</span>: (context) =&gt; <span class="hljs-built_in">CounterModel</span>(), <span class="hljs-comment">// 创建 CounterModel 实例</span>
      <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">MaterialApp</span>(
        <span class="hljs-attribute">home</span>: <span class="hljs-built_in">CounterPage</span>(),
      ),
    );
  }
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CounterPage</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatelessWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">CounterPage</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>});

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">print</span>(<span class="hljs-string">'CounterPage build method called!'</span>);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Scaffold</span>(
      <span class="hljs-attribute">appBar</span>: <span class="hljs-built_in">AppBar</span>(
        <span class="hljs-comment">// 5. 在 AppBar 中也可以轻松访问状态</span>
        <span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Provider Demo - Count: ${context.watch&lt;CounterModel&gt;().count}'</span>),
      ),
      <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
          <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,
          <span class="hljs-attribute">children</span>: &lt;Widget&gt;[
            const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'You have pushed the button this many times:'</span>),
            <span class="hljs-comment">// 4. 使用 Consumer Widget 来监听状态变化</span>
            Consumer&lt;CounterModel&gt;(
              <span class="hljs-attribute">builder</span>: (context, counter, child) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'Text widget rebuilds!'</span>);
                return <span class="hljs-built_in">Text</span>(
                  <span class="hljs-string">'${counter.count}'</span>,
                  <span class="hljs-attribute">style</span>: Theme.<span class="hljs-built_in">of</span>(context).textTheme.headlineMedium,
                );
              },
            ),
          ],
        ),
      ),
      <span class="hljs-attribute">floatingActionButton</span>: <span class="hljs-built_in">FloatingActionButton</span>(
        <span class="hljs-attribute">onPressed</span>: () {
          <span class="hljs-comment">// 6. 调用模型的方法来改变状态</span>
          <span class="hljs-comment">// 使用 read 方法，因为它只触发一次动作，不需要监听后续变化</span>
          context.read&lt;CounterModel&gt;().<span class="hljs-built_in">increment</span>();
        },
        <span class="hljs-attribute">tooltip</span>: <span class="hljs-string">'Increment'</span>,
        <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">Icon</span>(Icons.add),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-10">代码解析：</h5>
<ul>
<li><code>ChangeNotifierProvider</code>: 它创建了 <code>CounterModel</code> 的实例，并将其提供给它的所有子 <code>Widget</code>。</li>
<li><code>Consumer&lt;CounterModel&gt;</code>: 这是 <code>Provider</code> 的核心。它的 <code>builder</code> 会在 <code>CounterModel</code> 调用 <code>notifyListeners()</code> 时被<strong>精确地重新执行</strong>。注意，现在 <code>CounterPage</code> 自身变成了 <code>StatelessWidget</code>，它的 <code>build</code> 方法不再因为数据改变而重复调用！只有 <code>Consumer</code> 包裹的 <code>Text</code> 在重建。</li>
<li><code>context.watch&lt;T&gt;()</code>: 这是另一种监听数据的方式，它会让整个 <code>build</code> 方法都依赖这个数据。我们在 <code>AppBar</code> 中使用它，所以当计数改变时，<code>AppBar</code> 也会重建以更新标题。</li>
<li><code>context.read&lt;T&gt;()</code>: 这个方法<strong>只会读取一次数据</strong>，并且<strong>不会</strong>在数据变化时引起 <code>Widget</code> 重建。它最适合用在 <code>onPressed</code> 这样的回调函数中，我们只想调用一个方法，而不需要因为数据变化而重建按钮本身。</li>
</ul>
<h4 data-id="heading-11">总结</h4>
<p>让我们回顾一下，<code>Provider</code> 是如何解决 <code>setState</code> 的三大局限性的：</p>
<ol>
<li><strong>状态共享</strong>：通过 <code>ChangeNotifierProvider</code>，任何深层的子 <code>Widget</code> 都能轻松访问到状态，无需层层传递。</li>
<li><strong>性能优化</strong>：通过 <code>Consumer</code> 或 <code>context.watch</code>，我们可以实现“精确重建”，只有依赖数据的 <code>Widget</code> 才会被更新，避免了不必要的 <code>UI</code> 开销。</li>
<li><strong>逻辑分离</strong>：业务逻辑被清晰地分离到了 <code>CounterModel</code> 中，<code>UI</code> (<code>CounterPage</code>) 只负责展示和触发动作，代码结构更清晰，更易于测试和维护。</li>
</ol>
<p>当然，<code>setState</code> 并非一无是处。对于那些纯粹的、局部的、不需要与其他 <code>Widget</code> 共享的 <code>UI</code> 状态（例如一个动画的控制器状态，或一个输入框的焦点状态），使用 <code>setState</code> 依然是最简单直接的选择。</p>
<p>掌握 <code>Provider</code>，是你踏上 <code>Flutter</code> 专业开发之路的关键一步。从这里开始，你将能够构建更复杂、更健壮、性能更优的应用程序。</p>
<p>在接下来的文章中，我们将探讨更高级的状态管理方案，如 <code>Riverpod</code> 和 <code>BLoC</code>，它们在 <code>Provider</code> 的基础上提供了更强大的功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React组件命名为什么用小写开头会无法运行？]]></title>    <link>https://juejin.cn/post/7572020278387900450</link>    <guid>https://juejin.cn/post/7572020278387900450</guid>    <pubDate>2025-11-14T01:35:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572020278387900450" data-draft-id="7571753301898493992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React组件命名为什么用小写开头会无法运行？"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2025-11-14T01:35:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大布布将军"/> <meta itemprop="url" content="https://juejin.cn/user/1535361573994189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React组件命名为什么用小写开头会无法运行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535361573994189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大布布将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:35:38.000Z" title="Fri Nov 14 2025 01:35:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>在React项目实际开发中，我们经常用到一些约定俗成的语法，今天我们来聊一聊为什么组件命名时以小写字母开头的组件无法运行的这个现象，这个现象是由什么原因导致的。这个背后有重要的设计原理。</strong></p>
<p>这就不得不谈 JSX，JSX是一种语法扩展，它允许我们在JavaScript中编写类似HTML的代码。</p>
<p><strong>React项目中遇到JSX中的元素时，函数组件首字母大小写决定了React编译这个元素  是原生DOM元素还是自定义组件。</strong>
具体来说：</p>
<ul>
<li>当JSX标签以小写字母开头时，React会将其视为原生DOM元素（如<code>div</code>、<code>span</code>等），并尝试在DOM中创建对应的标签。</li>
<li>当JSX标签以大写字母开头时，React会将其视为自定义组件，并去查找当前作用域中对应的函数或类组件。</li>
</ul>
<p>那么，这个问题产生的根本原因：<strong>JSX 的编译机制</strong></p>
<pre><code class="hljs language-//" lang="//">// 当 Babel 编译 JSX 时，它会根据标签的首字母大小写来决定如何转换：
&lt;MyComponent /&gt;
&lt;div /&gt;

// 编译后的 JavaScript
React.createElement(MyComponent, null);  // 大写 - 作为变量/组件
React.createElement("div", null);        // 小写 - 作为字符串（HTML 标签）
// ❌ 错误：小写组件名
function avatar({ src, alt }) {
  return &lt;img src={src} alt={alt} /&gt;;
}

function UserProfile() {
  return (
    &lt;div&gt;
      {/* 这会导致错误 */}
      &lt;avatar src="user.jpg" alt="User" /&gt;
      {/* 编译为：React.createElement("avatar", { src: "user.jpg", alt: "User" }) */}
      {/* React 会寻找 &lt;avatar&gt; HTML 标签，但不存在 */}
    &lt;/div&gt;
  );
}
</code></pre>
<p>Babel有一个插件（<strong>通常是@babel/plugin-syntax-jsx或@babel/preset-react</strong>）来处理JSX语法。这个插件会将JSX转换为<strong>React.createElement</strong>调用。</p>
<p>实现这一转换的Babel插件内部，会有一个Visitor来处理JSXElement节点。在Visitor中，它会检查JSXOpeningElement的name属性。如果name是一个JSXIdentifier，并且首字母是小写，则将其作为字符串；如果是大写，则保留为标识符。
那么我们来模拟插件内部是怎么解析的呢？看下方代码</p>
<pre><code class="hljs language-//" lang="//">&lt;MyComponent prop="value" /&gt;
&lt;div className="container" /&gt;

// Babel 解析为 AST（抽象语法树）
{
  type: 'JSXElement',
  openingElement: {
    type: 'JSXOpeningElement',
    name: {
      type: 'JSXIdentifier',
      name: 'MyComponent'  // 或 'div'
    }
    // ...
  }
}
</code></pre>
<p>转换阶段核心代码</p>
<pre><code class="hljs language-//" lang="//">export default function (babel) {
  const { types: t } = babel;
  
  return {
    name: "transform-jsx",
    visitor: {
      JSXElement(path) {
        const openingElement = path.node.openingElement;
        const tagName = openingElement.name.name;
        
        // 关键判断逻辑
        let elementType;
        if (/^[a-z]/.test(tagName)) {
          // 小写开头 -&gt; HTML 标签 -&gt; 字符串
          elementType = t.stringLiteral(tagName);
        } else {
          // 大写开头 -&gt; 组件 -&gt; 标识符
          elementType = t.identifier(tagName);
        }
        
        // 转换为 React.createElement 调用
        const createElementCall = t.callExpression(
          t.identifier('React.createElement'),
          [elementType, ...processAttributes(openingElement.attributes)]
        );
        
        path.replaceWith(createElementCall);
      }
    }
  };
}
</code></pre>
<h3 data-id="heading-0">实际 Babel 插件源码分析</h3>
<p>在 <code>@babel/plugin-transform-react-jsx</code> 中：</p>
<pre><code class="hljs language-//" lang="//">function transformJSX() {
  return {
    visitor: {
      JSXElement(path) {
        const { node } = path;
        const tag = node.openingElement.name;
        
        let tagExpr;
        if (tag.type === 'JSXIdentifier') {
          const tagName = tag.name;
          
          // 关键判断：首字母是否小写
          if (
            /^[a-z][a-z0-9]*$/.test(tagName) || 
            // 或者是已知的 SVG 标签等
            knownHTMLTags.has(tagName) ||
            knownSVGTags.has(tagName)
          ) {
            // HTML/SVG 标签 -&gt; 字符串字面量
            tagExpr = types.stringLiteral(tagName);
          } else {
            // 组件 -&gt; 标识符
            tagExpr = types.identifier(tagName);
          }
        } else if (tag.type === 'JSXMemberExpression') {
          // 处理 &lt;MyComponent.SubComponent /&gt; 这种情况
          tagExpr = transformJSXMemberExpression(tag);
        }
        
        const createElementCall = types.callExpression(
          types.identifier('React.createElement'),
          [tagExpr, ...createAttributes(node.openingElement.attributes)]
        );
        
        path.replaceWith(createElementCall);
      }
    }
  };
}
</code></pre>
<p><strong>完整的编译示例如下</strong></p>
<h3 data-id="heading-1">JSX</h3>
<pre><code class="hljs language-function" lang="function">  return (
    &lt;div className="app"&gt;
      &lt;Header title="Welcome" /&gt;
      &lt;main className="content"&gt;
        &lt;UserList users={users} /&gt;
        &lt;footer className="site-footer"&gt;
          &lt;Copyright year={2024} /&gt;
        &lt;/footer&gt;
      &lt;/main&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<h3 data-id="heading-2">Babel 编译后的 JavaScript</h3>
<pre><code class="hljs language-function" lang="function">  return React.createElement(
    "div", 
    { className: "app" },
    React.createElement(Header, { title: "Welcome" }),
    React.createElement(
      "main", 
      { className: "content" },
      React.createElement(UserList, { users: users }),
      React.createElement(
        "footer", 
        { className: "site-footer" },
        React.createElement(Copyright, { year: 2024 })
      )
    )
  );
}
</code></pre>
<p>以上就是组件命名大小写在react插件中的运行示例演示，解释了为什么组件用小写开头无法运行。</p>
<p>看似简单的首字母大小写判断，实际上是整个 React 开发设计和生态的重要一环。</p>
<p>我是大布布将军，一个AICodeing时代下的前端开发思考者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RustFS 重要变更，让容器化部署更安全]]></title>    <link>https://juejin.cn/post/7572092283718762548</link>    <guid>https://juejin.cn/post/7572092283718762548</guid>    <pubDate>2025-11-14T01:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572092283718762548" data-draft-id="7572051762984173620" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RustFS 重要变更，让容器化部署更安全"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-14T01:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/511719423354121"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RustFS 重要变更，让容器化部署更安全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/511719423354121/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:26:16.000Z" title="Fri Nov 14 2025 01:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RustFS 重要变更，让容器化部署更安全</h2>
<p>随着 RustFS 的持续走热，越来越多的用户开始关注并使用 RustFS，而且在整个过程中提出了很多关键问题。其中在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs%2Fissues%2F804" target="_blank" title="https://github.com/rustfs/rustfs/issues/804" ref="nofollow noopener noreferrer">Start the container using a non-root user #804
</a>中，whg517 用户提出，从安全最佳实践角度出发，RustFS 在容器化运行状态下（包括 docker 部署和 k8s 部署），RustFS 实例应该以非 root 用户运行，并且添加更多安全加固措施。</p>
<p><img src="http://openwrite.cn/uploads/45/56325/e7d1a529-3c4c-4f87-99cd-239cc9d39cb5.png" alt="截屏2025-11-13 13.03.15.png" loading="lazy"/></p>
<p>以非 root 运行容器是业界的安全最佳实践共识，因此 RustFS 修改了 Dockerfile，具体包括：</p>
<ul>
<li>创建 UID 和 GID 均为 <code>1000</code> 的用户 <code>rustfs</code>；</li>
<li>rustfs 进程以 <code>rustfs</code> 用户启动；</li>
<li>针对 k8s 部署，还增强了 <code>securityContext</code> 部分内容；</li>
</ul>
<p>上述变更在 <code>1.0.0-alpha.68</code> 版本正式生效。在版本发布后，我们在 GitHub Issue 上看到有用户从 <code>1.0.0-alpha.67</code> 升级到 <code>1.0.0-alpha.68</code> 出现了 <code>permission denied</code> 错误：</p>
<p><img src="http://openwrite.cn/uploads/45/56325/e3f37c02-4008-4cf8-a4a5-7ede2d773c03.png" alt="截屏2025-11-13 13.10.51.png" loading="lazy"/></p>
<p>为此，受影响用户可遵循下面的方法进行问题修复并升级。</p>
<p><strong>注意</strong>：此变更仅影响容器化运行用户，对于通过脚本或者二进制安装的用户，不受此影响。而且仅影响 <code>1.0.0-alpha.67</code> 及之前版本的用户，后续版本不受影响。</p>
<h3 data-id="heading-1">Kubernetes 用户</h3>
<p>对于 Kubernetes 用户，此次变更不受影响，因为在 Helm chart 编写之初就增加了 <code>securityContext</code> 部分内容，而且在 pod 中通过 initContainer 来对 <code>/data</code> 和 <code>logs</code> 目录的权限进行了修改（USER 和 GROUP 均为 <code>1000</code>），此次升级变更不会导致 Kubernetes 用户出现 permission denied 错误。</p>
<h3 data-id="heading-2">Docker 用户</h3>
<p>对于使用 <code>docker run</code> 或者使用 <code>docker compose</code> 的用户来说，修复该错误的核心原理就是<strong>将 RustFS 使用的 <code>/data</code> 和 <code>/logs</code> 两个目录的用户和群组修改为 <code>1000</code> 即可</strong>。过程如下：</p>
<ul>
<li>回滚至 <code>1.0.0-alpha.67</code> 版本</li>
</ul>
<p>用户可以先会滚至 <code>1.0.0-alpha.67</code> 版本，然后进入到容器中，将 <code>/data</code> 和 <code>/logs</code> 目录的用户和群组从 <code>root</code> 更改至 <code>1000</code>：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it rustfs sh
<span class="hljs-built_in">chown</span> -R 1000:1000 /data/
<span class="hljs-built_in">chown</span> -R 1000:1000 /logs/
<span class="hljs-built_in">ls</span> -ld /data/
drwxr-x--- 5 1000 1000 4096 Nov 12 04:06 /data/
<span class="hljs-built_in">ls</span> -ld /logs/
drwxr-x--- 5 1000 1000 4096 Nov 12 04:06 /logs/
</code></pre>
<ul>
<li>升级至 <code>1.0.0-alpha.68</code></li>
</ul>
<p>直接升级到 <code>1.0.0-alpha.68</code>（或 latest，当前 latest 就是 68 版本）即可。升级成功之后可查看 rustfs 日志并查看 rustfs 进程运行的用户：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it rustfs sh
/ $ <span class="hljs-built_in">id</span>
uid=1000(rustfs) gid=1000(rustfs) <span class="hljs-built_in">groups</span>=1000(rustfs)
/ $ <span class="hljs-built_in">whoami</span>
rustfs
/ $ ps
PID   USER     TIME  COMMAND
    1 rustfs    0:15 /usr/bin/rustfs /data
   36 rustfs    0:00 sh
 8057 rustfs    0:00 ps
/ $ <span class="hljs-built_in">ls</span> -ld /data/
drwxr-x--- 5 rustfs rustfs 4096 Nov 12 04:06 /data/
/ $ <span class="hljs-built_in">ls</span> -ld /logs/
drwxr-xr-x 2 rustfs rustfs 4096 Nov 13 04:07 /logs/
</code></pre>
<h3 data-id="heading-3">RustFS 的安装</h3>
<p>目前 RustFS 支持多种安装方式</p>
<ul>
<li>二进制下载安装或脚本安全</li>
<li>Docker 安装</li>
<li>Helm Chart 安装</li>
</ul>
<p>安装方式和步骤可查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rustfs.com.cn%2F" target="_blank" title="https://docs.rustfs.com.cn/" ref="nofollow noopener noreferrer">RustFS 官网</a>。</p>
<p>如果您想使用 docker 安装，可参考如下 <code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">rustfs/rustfs:1.0.0-alpha.68</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-comment"># Use service names and correct disk indexing (1..4 to match mounted paths)</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_VOLUMES=/data</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ADDRESS=0.0.0.0:9000</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ENABLE=true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ACCESS_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_SECRET_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CMD=rustfs</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9000:9000"</span>  <span class="hljs-comment"># API endpoint</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9001:9001"</span>  <span class="hljs-comment"># Console</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data:/data</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">logs:/logs</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span>
        [
        <span class="hljs-string">"CMD"</span>,
        <span class="hljs-string">"sh"</span>, <span class="hljs-string">"-c"</span>,
        <span class="hljs-string">"curl -f http://localhost:9000/health &amp;&amp; curl -f http://localhost:9001/health"</span>
        ]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">start_period:</span> <span class="hljs-string">30s</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">logs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
</code></pre>
<p>欢迎大家使用 RustFS 作为对象存储系统，目前 RustFS 还在持续研发迭代中，如果您有任何问题，可以通过 GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">github.com/rustfs/rust…</a> 提 Issue 或 PR。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安卓编译: 3.framework层定制修改(一)]]></title>    <link>https://juejin.cn/post/7572087162230947882</link>    <guid>https://juejin.cn/post/7572087162230947882</guid>    <pubDate>2025-11-14T02:20:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162230947882" data-draft-id="7570908785293377555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安卓编译: 3.framework层定制修改(一)"/> <meta itemprop="keywords" content="逆向"/> <meta itemprop="datePublished" content="2025-11-14T02:20:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三喵223"/> <meta itemprop="url" content="https://juejin.cn/user/54318049787980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安卓编译: 3.framework层定制修改(一)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/54318049787980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三喵223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T02:20:23.000Z" title="Fri Nov 14 2025 02:20:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">3.1 Java层Exec修改</h2>
<h3 data-id="heading-1">修改方式和难易程度</h3>
<h4 data-id="heading-2">1. 修改 Java 层</h4>
<p>位置：<code>libcore/ojluni/src/main/java/java/lang/ProcessImpl.java</code>
目的：可以更方便地调整命令处理逻辑，适合添加高级功能或参数预处理。
修改难度：低</p>
<p>Java 层逻辑简单，影响面有限，但可能受 Native 实现限制。
修改代码</p>
<pre><code class="hljs language-ini" lang="ini">    // Only for use by ProcessBuilder.start()
    static Process start(String<span class="hljs-section">[]</span> cmdarray,
                         java.util.Map&lt;String,String&gt; environment,
                         String dir,
                         ProcessBuilder.Redirect<span class="hljs-section">[]</span> redirects,
                         boolean redirectErrorStream)
        throws IOException
    {
        assert cmdarray != null &amp;&amp; cmdarray.length &gt; 0<span class="hljs-comment">;</span>
       

        // Convert arguments to a contiguous block<span class="hljs-comment">; it's easier to do</span>
        // memory management in Java than in C.
        byte<span class="hljs-section">[]</span><span class="hljs-section">[]</span> <span class="hljs-attr">args</span> = new byte[cmdarray.length-<span class="hljs-number">1</span>][]<span class="hljs-comment">;</span>
        int <span class="hljs-attr">size</span> = args.length<span class="hljs-comment">; // For added NUL bytes</span>

        // 新增这部分替换逻辑
        String<span class="hljs-section">[]</span> <span class="hljs-attr">keywords</span> = {<span class="hljs-string">"frida"</span>, <span class="hljs-string">"xposed"</span>, <span class="hljs-string">"magisk"</span>, <span class="hljs-string">"lsposed"</span>}<span class="hljs-comment">;</span>
        String<span class="hljs-section">[]</span> <span class="hljs-attr">replaceKeywords</span> = {<span class="hljs-string">"fffff"</span>, <span class="hljs-string">"xxxxx"</span>, <span class="hljs-string">"mmmmm"</span>, <span class="hljs-string">"llllll"</span>}<span class="hljs-comment">;</span>
       
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; cmdarray.length; i++) {</span>
            for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; keywords.length; j++) {</span>
                if (cmdarray<span class="hljs-section">[i]</span>.contains(keywords<span class="hljs-section">[j]</span>)) {
                    java.lang.System.logE("Samuel Detected <span class="hljs-section">["+cmdarray[i]</span>+"] keyword: " + keywords<span class="hljs-section">[j]</span> + " in command. Replacing with: " + replaceKeywords<span class="hljs-section">[j]</span>)<span class="hljs-comment">;</span>
                    cmdarray<span class="hljs-section">[i]</span> = cmdarray<span class="hljs-section">[i]</span>.replace(keywords<span class="hljs-section">[j]</span>, replaceKeywords<span class="hljs-section">[j]</span>)<span class="hljs-comment">;</span>
                } else if (cmdarray<span class="hljs-section">[i]</span>.equals("su") || cmdarray<span class="hljs-section">[i]</span>.endsWith("/su") || cmdarray<span class="hljs-section">[i]</span>.endsWith(" su")) {
                    java.lang.System.logE("Samuel Detected <span class="hljs-section">["+cmdarray[i]</span>+"] keyword: su in command. Replacing with: xu")<span class="hljs-comment">;</span>
                    cmdarray<span class="hljs-section">[i]</span> = cmdarray<span class="hljs-section">[i]</span>.replace("su", "xu")<span class="hljs-comment">;</span>
                }
            }
        }
</code></pre>
<h4 data-id="heading-3">2. 修改 Native 层</h4>
<p>位置：libcore/ojluni/src/main/native/UNIXProcess_md.c
目的：可以调整底层命令的调用方式或参数传递机制，例如在 exec 函数调用前对路径或参数进行校验或修改。
修改难度：中</p>
<p>涉及 JNI 和系统调用的桥接代码，需要确保对参数进行正确转换。
不修改</p>
<h4 data-id="heading-4">3. 修改底层 exec 系列函数</h4>
<p>位置：C 标准库实现（通常为 glibc 或其他库，非直接控制的代码）。
目的：直接修改或替换 execv、execvp、execve 的实现逻辑。
修改难度：高</p>
<p>涉及系统级别的核心函数，修改成本高，可能影响其他使用 exec 系列函数的程序。
通常不建议直接修改，而是通过拦截或代理（如 inlineHook 技术）实现定制。
修改代码 (不推荐真机上使用，性能差太多，容易卡机，死机。但可以在模拟器作为沙盒分析)</p>
<h3 data-id="heading-5"><strong>不同函数的修改难易程度</strong></h3>

























<table><thead><tr><th>函数</th><th>调用方式</th><th>修改难度</th></tr></thead><tbody><tr><td>execv</td><td>接受绝对路径和参数数组，不会搜索 PATH。</td><td>中等</td></tr><tr><td>execvp</td><td>基于 PATH 环境变量搜索可执行文件。</td><td>中等</td></tr><tr><td>execve</td><td>更底层的接口，需显式传递环境变量数组。</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-6"><strong>推荐修改路径</strong></h3>
<ul>
<li>如果修改逻辑是高层次的（如添加功能或安全验证），优先选择 Java 层或 Native 层实现。</li>
<li>如果需要对底层调用进行重大更改，建议通过代理拦截 <code>exec</code> 系列函数，而非直接修改底层实现。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 11：集成百度统计以监控站点流量]]></title>    <link>https://juejin.cn/post/7572086215028293674</link>    <guid>https://juejin.cn/post/7572086215028293674</guid>    <pubDate>2025-11-14T02:22:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572086215028293674" data-draft-id="7572039006530355236" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 11：集成百度统计以监控站点流量"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-14T02:22:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 11：集成百度统计以监控站点流量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T02:22:26.000Z" title="Fri Nov 14 2025 02:22:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c02d6f07d97744a98395387b173b2ad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=3uZdfhme29AVvw7yS8pwOW8EzsI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>到目前为止，这个项目已经做了有小半个月了，文章也更新了10来篇，突然想要知道一下我的站点到底有没有人访问过，原先我是打算等博客模块做完的，但是灵光一闪，想到了这个，我这个人有个毛病就是想一出是一出，所以我决定先把这个弄上。</p>
<p>当然实现方式有很多，最简单的就是自己在<code>nginx</code>层进行埋点，监控，但是多多少少还是要点工作量的，也不利于数据统计，分析，如果要做一整套，那得花不少精力，当前阶段不值当。</p>
<p>所以我决定先整合上百度统计，有个大致的了解。</p>
<h2 data-id="heading-1">二、百度统计整合</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa8f917bf40946d0836e556413254783~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=6RFkN9uBSA2a%2FjmEwle9nqfm0vE%3D" alt="image.png" loading="lazy"/></p>
<p>点击工具菜单 –&gt; 选择数据站点分类 –&gt; 看到百度统计，点击使用工具即可进入页面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d92843385f564228a994a0b040d4d3e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=H8I05VlUXMZkcjs7X8b2hheWAGA%3D" alt="image.png" loading="lazy"/></p>
<p>点击进入产品，接下来就是注册登录了。</p>
<p>个人的话用百度账号登录就可以了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20888e9341e448ea88d43622aabd9d26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=ScAifEHUkEBVvq77iBNKWdaET8s%3D" alt="image.png" loading="lazy"/></p>
<p>进入页面后，点击使用设置，这里有详细的使用教程，我建议是自己跟着教程来就好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c57858f0974860be8927da2bec05b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=kV7gbS0mDyAQJL%2BtY7WjeyrA%2Bbg%3D" alt="image.png" loading="lazy"/></p>
<p>但是既然我写了这篇文章，我还是要把步骤走一遍的。</p>
<h3 data-id="heading-2">1. 创建站点</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8db4d20695c4814b54a950dc4e64419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=a0oj0fLefjkH3p35qQeLz0FCx%2B0%3D" alt="image.png" loading="lazy"/></p>
<p>在自有网站tab栏下点击，新增站点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6d795b9bfc8427a9abfb70758c8a07a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=opweDs8a06Scz5csT8kaGz%2FbyBg%3D" alt="image.png" loading="lazy"/></p>
<p>根据提示要求，填写好，点击确定</p>
<h3 data-id="heading-3">2. 获取代码</h3>
<p>之后会进入这个页面，或者自己在左侧菜单栏中找到，代码管理–&gt;代码获取</p>
<p>获取统计代码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa7247b97f2a4fa9866c3e5c3108395a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=PEx7DmpLurD1rug1yde1pw4B3ng%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">3. 项目中引入</h3>
<p>这里有几种方式，我这里使用插件方式，因为在本地开发的时候我希望他不要统计</p>
<h3 data-id="heading-5">各种方式对比（由AI给出）</h3>



































<table><thead><tr><th align="left">方法</th><th align="left">是否推荐</th><th align="left">适用场景</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>useHead()</code> + <code>script[src]</code></td><td align="left">✅ 强烈推荐</td><td align="left">所有模式</td><td align="left">最标准、兼容 SSR/SSG/SPA</td></tr><tr><td align="left">插件方式 (<code>plugins/baidu-tongji.client.js</code>)</td><td align="left">✅ 推荐</td><td align="left">多环境/团队项目</td><td align="left">封装好，逻辑分离</td></tr><tr><td align="left">手动在 <code>app.vue</code> 用 <code>onMounted</code> 动态添加</td><td align="left">✅ 可用</td><td align="left">快速调试</td><td align="left">控制灵活</td></tr><tr><td align="left">直接 <code>&lt;script src="..." defer&gt;</code> 写在模板</td><td align="left">⚠️ 仅限 SPA</td><td align="left">SPA 模式</td><td align="left">简单粗暴，但 SSR 下有风险</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">📌 建议选择</h3>
<ul>
<li>如果你是新手或想最快搞定 → 选 <strong>方法一（useHead）</strong></li>
<li>如果你禁用了 SSR（SPA 模式）→ 可以直接写 <code>&lt;script&gt;</code> 标签</li>
<li>如果你想集中管理第三方脚本 → 使用 <code>plugins/*.client.js</code></li>
</ul>
<hr/>
<h2 data-id="heading-7">三、以插件方式整合百度统计</h2>
<h3 data-id="heading-8">1. 创建插件文件 <code>plugins/baidu-tongji.client.js</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtPlugin</span>(<span class="hljs-function">(<span class="hljs-params">nuxtApp</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useRuntimeConfig</span>()
  <span class="hljs-keyword">const</span> baiduToken = config.<span class="hljs-property">public</span>.<span class="hljs-property">baiduTongjiToken</span>
  
  <span class="hljs-comment">// 如果没有配置 token，或不是生产环境，则不加载</span>
  <span class="hljs-keyword">if</span> (!baiduToken) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 必须配置 token</span>
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">client</span>) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 防止 SSR 报错, 必须在客户端</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span>) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 只在生产环境启用</span>

  <span class="hljs-comment">// 标记是否已加载，防止重复加载</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">_bdStatLoaded</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_bdStatLoaded</span> = <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 初始化 _hmt 数组</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_hmt</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">_hmt</span> || []

  <span class="hljs-comment">// 创建百度统计脚本</span>
  <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
  script.<span class="hljs-property">src</span> = <span class="hljs-string">`https://hm.baidu.com/hm.js?<span class="hljs-subst">${baiduToken}</span>`</span>
  script.<span class="hljs-property">defer</span> = <span class="hljs-literal">true</span>
  script.<span class="hljs-property">async</span> = <span class="hljs-literal">false</span>
  script.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-pid'</span>, <span class="hljs-string">'baidu-tongji'</span>)

  <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)

  <span class="hljs-comment">// 获取当前页面路径并发送首次 PV</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendPageView</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> path = location.<span class="hljs-property">pathname</span> + location.<span class="hljs-property">search</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">_hmt</span>.<span class="hljs-title function_">push</span>([<span class="hljs-string">'_trackPageview'</span>, path])
  }

  <span class="hljs-comment">// 等待脚本加载完成后再发送 PV</span>
  script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 首次进入页面上报 PV</span>
    <span class="hljs-title function_">sendPageView</span>()

    <span class="hljs-comment">// 监听路由变化，上报后续 PV（适用于 SPA）</span>
    nuxtApp.<span class="hljs-title function_">hook</span>(<span class="hljs-string">'page:finish'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 路由切换完成后上报新页面 PV</span>
      <span class="hljs-built_in">setTimeout</span>(sendPageView, <span class="hljs-number">100</span>) <span class="hljs-comment">// 小延迟确保 DOM 更新</span>
    })
  }

  <span class="hljs-comment">// 错误处理</span>
  script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Baidu Tongji] Failed to load hm.js'</span>)
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">_bdStatLoaded</span> = <span class="hljs-literal">false</span>
  }
})
</code></pre>
<h3 data-id="heading-9">2. 配置 Token（推荐使用环境变量）</h3>
<p>创建 <code>.env</code> 文件</p>
<p>定义好环境变量<code>NUXT_PUBLIC_BAIDU_TONGJI_TOKEN=abc123def456xxxxx</code></p>
<p><code>token</code> 换成你自己百度统计中代码中的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd68759e0a74fb4aa6b2db0033b56dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=IV8ir9MUvPGvvEzMaE8WGc2xcvM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>🔐 注意：不要把 <code>token</code> 提交到 <code>Git</code>，记得将 <code>.env</code> 加入 <code>.gitignore</code></p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Local env files</span>
.<span class="hljs-built_in">env</span>
.<span class="hljs-built_in">env</span>.*
!.env.example
</code></pre>
<p>在 <code>nuxt.config.ts</code> 中声明，默认留空或设默认值</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">runtimeConfig</span>: {
    <span class="hljs-attr">public</span>: {
      <span class="hljs-comment">// 声明这个配置项存在，实际值来自 .env</span>
      <span class="hljs-attr">baiduTongjiToken</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// ← 留空，由 NUXT_PUBLIC_BAIDU_TONGJI_TOKEN 注入</span>
    }
  }
})
</code></pre>
<h3 data-id="heading-10">3. 验证是否生效</h3>
<blockquote>
<p>这里为了本地测试，先把插件中的 <code> if (!import.meta.env.PROD) return // 只在生产环境启用</code> 这行代码注释掉。</p>
</blockquote>
<ol>
<li>启动项目：</li>
<li>打开浏览器开发者工具查看 Network 是否请求了 <code>hm.js?xxx</code></li>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftongji.baidu.com%2F" target="_blank" title="https://tongji.baidu.com/" ref="nofollow noopener noreferrer">百度统计后台</a>，查看实时访客数据。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4729d1180fda42ebbb9695c3056f580b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=4kbtkupqtBLhJYXmh4E0y4ESA4k%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2c9bae3fd6c48f7a263254e3b5ce66b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=WIOvn7C6424ZcNXyoxDoA%2Fubiqg%3D" alt="image.png" loading="lazy"/></p>
<p>然后就可以看到具体的行为了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50d4533da9a43bbbc0867395a4a6cfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763691746&amp;x-signature=qayzAvbvvO0djaD1UPKFrH1kppY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">四、总结</h2>
<p>这样对于我们的站点流量有了一个大概得了解。为后续接推广提供一下数据支撑。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最小可运行 Agent 架构图（专业版）]]></title>    <link>https://juejin.cn/post/7572087181608747058</link>    <guid>https://juejin.cn/post/7572087181608747058</guid>    <pubDate>2025-11-14T01:25:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087181608747058" data-draft-id="7572095192418451483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最小可运行 Agent 架构图（专业版）"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-14T01:25:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4846656695749"/> <meta itemprop="url" content="https://juejin.cn/user/2076332391145975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最小可运行 Agent 架构图（专业版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2076332391145975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4846656695749
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T01:25:59.000Z" title="Fri Nov 14 2025 01:25:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面给你 <strong>最小可运行 Agent 的专业级架构图（Minimal Viable Agent Architecture, MVA）</strong> 。<br/>
这是目前 OpenAI/DeepMind/Anthropic/LangGraph 等共识下的<strong>最小、可运行、可扩展、可复用</strong>的 Agent 架构。</p>
<p>我给你两种版本：<br/>
<strong>① 概念版</strong>（理解结构）<br/>
<strong>② 工程版</strong>（可以直接落地）</p>
<hr/>
<h2 data-id="heading-0">🟦 <strong>① 最小可运行 Agent 架构图（概念版）</strong></h2>
<pre><code class="hljs language-scss" lang="scss">                 ┌───────────────────────────┐
                 │        User / Goal        │
                 └──────────────┬────────────┘
                                ▼
                     ┌───────────────────┐
                     │  Goal Interpreter │
                     └─────────┬─────────┘
                               ▼
                   ┌──────────────────────┐
                   │   Task Decomposer    │
                   └──────────┬───────────┘
                              ▼
              ┌──────────────────────────────────┐
              │     Agent Runtime (Event Loop)    │
              │    ───────────────────────────    │
              │    • Planning                     │
              │    • Action Selection             │
              │    • Feedback Evaluation          │
              └───────────┬──────────────┬───────┘
                          ▼              ▼
              ┌─────────────────┐   ┌────────────────┐
              │   Memory / VM   │   │  World Model    │
              │ (State Manager) │   │ (State Storage) │
              └───────┬────────┘   └──────┬─────────┘
                      ▼                   ▼
               ┌──────────────────────────────────────────┐
               │             Tool Interface                │
               │  • API Calls                              │
               │  • Browser Actions (Playwright)           │
               │  • <span class="hljs-selector-tag">Code</span> Execution Sandboxes               │
               │  • File / DB Ops                          │
               └───────────────────────┬───────────────────┘
                                       ▼
                         ┌──────────────────────────┐
                         │   External Environment   │
                         └──────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-1">🟩 <strong>最小可运行 Agent 必须包含 5 个核心模块</strong></h2>
<h3 data-id="heading-2"><strong>1. Goal Interpreter</strong></h3>
<p>把用户输入、指令或触发事件 → 转换成“目标”。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Goal</span> = parse(user_input)
</code></pre>
<hr/>
<h3 data-id="heading-3"><strong>2. Task Decomposer（任务分解器）</strong></h3>
<p>把目标拆成可执行、副任务。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Plan</span> = decompose(Goal)
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>3. Agent Runtime（Agent 运行时）</strong></h3>
<p>这是 Agent 的“CPU”。<br/>
包括：</p>
<ul>
<li>Planning（重规划）</li>
<li>Action Selection（决定下一步）</li>
<li>Observation（读环境）</li>
<li>Feedback Loop（失败重试）</li>
<li>Error Recovery（纠错）</li>
<li>Termination Condition（任务完成条件）</li>
</ul>
<p>它是一个循环：</p>
<pre><code class="hljs language-css" lang="css">while not done:
    <span class="hljs-built_in">observe</span>()
    <span class="hljs-built_in">decide</span>()
    <span class="hljs-built_in">act</span>()
    <span class="hljs-built_in">evaluate</span>()
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>4. Memory / World Model（状态 + 记忆 + 世界模型）</strong></h3>
<p>必须至少包含：</p>
<ul>
<li>Working Memory（当前任务状态）</li>
<li>Long-term Memory（持久化知识、历史）</li>
<li>World State（工具/环境的最新状态）</li>
</ul>
<hr/>
<h3 data-id="heading-6"><strong>5. Tools（工具层）</strong></h3>
<p>Agent 通过工具改变世界：</p>
<ul>
<li>浏览器</li>
<li>API</li>
<li>数据库</li>
<li>文件系统</li>
<li>脚本执行</li>
<li>自定义插件</li>
</ul>
<hr/>
<h2 data-id="heading-7">🟦 <strong>② 最小可运行 Agent 架构（工程版）</strong></h2>
<p>这是你可以<strong>直接用在项目中的</strong>结构。</p>
<pre><code class="hljs language-bash" lang="bash">src/
└── agent/
    ├── main.py            <span class="hljs-comment"># 状态机 / Agent Loop</span>
    ├── planning.py        <span class="hljs-comment"># 任务分解 &amp; 规划</span>
    ├── memory.py          <span class="hljs-comment"># 状态管理 / 记忆</span>
    ├── tools/
    │   ├── browser.py     <span class="hljs-comment"># 浏览器工具</span>
    │   ├── http.py        <span class="hljs-comment"># API 调用工具</span>
    │   ├── code_exec.py   <span class="hljs-comment"># 代码沙盒</span>
    │   └── ...            <span class="hljs-comment"># 自定义工具</span>
    ├── world_model.py     <span class="hljs-comment"># 环境状态</span>
    └── goal_parser.py     <span class="hljs-comment"># 目标解释器</span>
</code></pre>
<p>核心循环（简化版）：</p>
<pre><code class="hljs language-scss" lang="scss">while not memory<span class="hljs-selector-class">.is_done</span>():
    goal = memory.<span class="hljs-built_in">current_goal</span>()
    plan = planning.<span class="hljs-built_in">replan</span>(goal, memory.<span class="hljs-built_in">state</span>())
    action = plan.<span class="hljs-built_in">next_action</span>()

    observation = tools.<span class="hljs-built_in">execute</span>(action)
    memory.<span class="hljs-built_in">update</span>(observation)

    if planning.<span class="hljs-built_in">detect_failure</span>(observation):
        planning.<span class="hljs-built_in">recover</span>()
</code></pre>
<hr/>
<h2 data-id="heading-8">🟧 <strong>③ Agent 的最小状态机（必需）</strong></h2>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Interpret Goal</span>]
        ↓
[<span class="hljs-meta">Decompose Task</span>]
        ↓
[<span class="hljs-meta">Plan</span>]
        ↓
[<span class="hljs-meta">Act</span>]
        ↓
[<span class="hljs-meta">Evaluate</span>]
        ↺（失败 → 回到 Plan）
        ↓
     [<span class="hljs-meta">Done</span>]
</code></pre>
<p>这个状态机是当前所有可靠 Agent（OpenAI Swarm、LangGraph、Devin、AutoGPT v2）的核心。</p>
<hr/>
<h2 data-id="heading-9">🟪 <strong>④ MVA（最小可运行 Agent）必须满足这 4 条：</strong></h2>
<ol>
<li><strong>至少能自动分解任务</strong></li>
<li><strong>至少能连续执行多个工具调用</strong></li>
<li><strong>至少能根据工具结果做决策和纠错</strong></li>
<li><strong>至少有状态（记忆）</strong></li>
</ol>
<p>只有满足这 4 条的系统才算 Agent，<br/>
否则都是“工具调用型 LLM”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>