<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[一种新HTML页面转换成 PDF 技术方案]]></title>    <link>https://juejin.cn/post/7576608733612425242</link>    <guid>https://juejin.cn/post/7576608733612425242</guid>    <pubDate>2025-11-26T07:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576608733612425242" data-draft-id="7576236480114475058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一种新HTML页面转换成 PDF 技术方案"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-26T07:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一种新HTML页面转换成 PDF 技术方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T07:15:49.000Z" title="Wed Nov 26 2025 07:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    115
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<blockquote>
<p>本文将深入讲解如何使用 snapdom 和 jsPDF 实现高质量的 HTML 转 PDF 功能，并通过一个完整的消息列表导出案例，带你掌握这套方案的核心技术。</p>
</blockquote>
<h3 data-id="heading-1">为什么 HTML 转 PDF 如此重要？</h3>
<p>在现代 Web 应用中，<strong>HTML 转 PDF</strong> 是一个非常常见的需求场景：</p>
<ol>
<li><strong>客服系统</strong>：导出聊天记录用于存档或投诉处理</li>
<li><strong>电商平台</strong>：生成订单详情、发票等 PDF 文档</li>
<li><strong>报表系统</strong>：将可视化图表和数据导出为 PDF 报告</li>
<li><strong>在线文档</strong>：支持用户将网页内容离线保存</li>
<li><strong>合同签署</strong>：生成合同 PDF 用于电子签名</li>
</ol>
<p>然而，实现一个<strong>高质量</strong>的 HTML 转 PDF 功能并不简单。我们面临以下挑战：</p>





























<table><thead><tr><th>挑战</th><th>描述</th></tr></thead><tbody><tr><td><strong>样式还原</strong></td><td>CSS 样式、字体、渐变等能否完美呈现？</td></tr><tr><td><strong>分页处理</strong></td><td>长内容如何智能分页，避免内容被截断？</td></tr><tr><td><strong>清晰度</strong></td><td>导出的 PDF 是否足够清晰，尤其在打印时？</td></tr><tr><td><strong>性能</strong></td><td>大量内容（如 1000 条消息）能否快速导出？</td></tr><tr><td><strong>兼容性</strong></td><td>不同浏览器表现是否一致？</td></tr></tbody></table>
<p>传统的 <code>html2canvas</code> + <code>jsPDF</code> 方案虽然能用，但在<strong>样式还原度</strong>和<strong>截图质量</strong>上存在明显不足。</p>
<p>今天笔者介绍一套新解决方案：<strong>snapdom + jsPDF</strong>。</p>
<h2 data-id="heading-2">snapdom 和 jsPDF 基础理论知识</h2>
<h3 data-id="heading-3">snapdom 是什么？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzumerlab%2Fsnapdom" target="_blank" title="https://github.com/zumerlab/snapdom" ref="nofollow noopener noreferrer">SnapDOM</a> 是一个现代化的 DOM 截图库，它的核心特点是：</p>
<pre><code class="hljs language-css" lang="css">DOM Element → <span class="hljs-selector-tag">Canvas</span>/PNG/SVG
</code></pre>
<h4 data-id="heading-4">核心优势</h4>
<ol>
<li><strong>高保真截图</strong>：完美还原 CSS 样式，包括 flexbox、grid、渐变、阴影等</li>
<li><strong>多种输出格式</strong>：支持 Canvas、PNG、SVG 等多种格式</li>
<li><strong>高清缩放</strong>：通过 <code>scale</code> 参数实现 2x/3x 高清截图</li>
<li><strong>体积小巧</strong>：压缩后仅 ~20KB</li>
</ol>
<h4 data-id="heading-5">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 获取 DOM 元素</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.my-element'</span>);

<span class="hljs-comment">// 截图</span>
<span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,      <span class="hljs-comment">// 2倍清晰度</span>
  <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>  <span class="hljs-comment">// PNG 质量</span>
});

<span class="hljs-comment">// 输出方式</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toCanvas</span>();  <span class="hljs-comment">// Canvas 元素</span>
<span class="hljs-keyword">const</span> imgEl = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>();      <span class="hljs-comment">// &lt;img&gt; 元素，src 为 data URL</span>
<span class="hljs-keyword">const</span> svgStr = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toSvg</span>();     <span class="hljs-comment">// SVG 字符串</span>
</code></pre>
<h4 data-id="heading-6">关键参数说明</h4>























<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>scale</code></td><td>number</td><td>1</td><td>缩放倍数，2 表示 2 倍清晰度</td></tr><tr><td><code>quality</code></td><td>number</td><td>0.92</td><td>图片质量，范围 0-1</td></tr></tbody></table>
<p>更多详细内容请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fsnapdom.dev%2F%25E5%25AE%2598%25E6%2596%25B9%25E6%2596%2587%25E6%25A1%25A3" target="_blank" title="https://snapdom.dev/%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" ref="nofollow noopener noreferrer">snapdom.dev/官方文档</a></p>
<h3 data-id="heading-7">jsPDF 是什么？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparallax%2FjsPDF" target="_blank" title="https://github.com/parallax/jsPDF" ref="nofollow noopener noreferrer">jsPDF</a> 是最流行的 JavaScript PDF 生成库，支持在浏览器端直接创建 PDF 文件。</p>
<h4 data-id="heading-8">核心特点</h4>
<ol>
<li><strong>纯前端方案</strong>：无需服务端，浏览器直接生成</li>
<li><strong>功能丰富</strong>：支持文本、图片、表格、链接等</li>
<li><strong>多种尺寸</strong>：A4、Letter 等标准纸张格式</li>
<li><strong>插件生态</strong>：支持 AutoTable 等扩展插件</li>
</ol>
<h4 data-id="heading-9">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { jsPDF } <span class="hljs-keyword">from</span> <span class="hljs-string">'jspdf'</span>;

<span class="hljs-comment">// 创建 PDF 实例</span>
<span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsPDF</span>({
  <span class="hljs-attr">orientation</span>: <span class="hljs-string">'portrait'</span>,  <span class="hljs-comment">// 纵向</span>
  <span class="hljs-attr">unit</span>: <span class="hljs-string">'mm'</span>,               <span class="hljs-comment">// 单位：毫米</span>
  <span class="hljs-attr">format</span>: <span class="hljs-string">'a4'</span>,             <span class="hljs-comment">// A4 纸张</span>
  <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>            <span class="hljs-comment">// 启用压缩</span>
});

<span class="hljs-comment">// 添加图片</span>
pdf.<span class="hljs-title function_">addImage</span>(
  imageDataUrl,  <span class="hljs-comment">// Base64 图片数据</span>
  <span class="hljs-string">'PNG'</span>,         <span class="hljs-comment">// 图片格式</span>
  <span class="hljs-number">10</span>,            <span class="hljs-comment">// X 坐标（mm）</span>
  <span class="hljs-number">10</span>,            <span class="hljs-comment">// Y 坐标（mm）</span>
  <span class="hljs-number">190</span>,           <span class="hljs-comment">// 宽度（mm）</span>
  <span class="hljs-number">100</span>            <span class="hljs-comment">// 高度（mm）</span>
);

<span class="hljs-comment">// 添加新页面</span>
pdf.<span class="hljs-title function_">addPage</span>();

<span class="hljs-comment">// 保存文件</span>
pdf.<span class="hljs-title function_">save</span>(<span class="hljs-string">'output.pdf'</span>);
</code></pre>
<h4 data-id="heading-10">A4 尺寸常量</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// A4 标准尺寸（单位：mm）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_WIDTH_MM</span> = <span class="hljs-number">210</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_HEIGHT_MM</span> = <span class="hljs-number">297</span>;

<span class="hljs-comment">// 页面边距</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MARGIN_MM</span> = <span class="hljs-number">10</span>;

<span class="hljs-comment">// 可用内容区域</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONTENT_WIDTH_MM</span> = <span class="hljs-number">190</span>;   <span class="hljs-comment">// 210 - 10*2</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONTENT_HEIGHT_MM</span> = <span class="hljs-number">277</span>;  <span class="hljs-comment">// 297 - 10*2</span>
</code></pre>
<h3 data-id="heading-11">snapdom + jsPDF 组合的优势</h3>
<h2 data-id="heading-12"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6dfc5710dc44cb683e902ccef1c5c5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818465&amp;x-signature=BWGSg2sI1NPQ%2FnYMd6a7vmPLta0%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-13">案例讲述</h2>
<p>笔者写一个IM产品中 MessageList 消息导出DEMO。接下来，我们通过一个完整的<strong>客服消息列表导出</strong>案例，讲解如何使用 snapdom + jsPDF 实现 HTML 转 PDF。</p>
<h3 data-id="heading-14">项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/
│   ├── MessageList.tsx      <span class="hljs-comment"># 消息列表组件</span>
│   └── MessageList.css      <span class="hljs-comment"># 消息列表样式</span>
├── services/
│   └── messageExportService.ts  <span class="hljs-comment"># PDF 导出服务（核心）</span>
└── App.tsx
</code></pre>
<h3 data-id="heading-15">核心流程</h3>
<p>整个导出过程分为 <strong>4 个步骤</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cb91cd191a4466b508c3f7776510fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818465&amp;x-signature=LAFXGjzfD5n437Fjlx5sc5FY44g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">Step 1：DOM 截图（snapdom）</h3>
<p>第一步，使用 snapdom 将整个消息列表 DOM 转换为高清 PNG 图片。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// messageExportService.ts</span>

<span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 图片质量配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IMAGE_QUALITY</span> = <span class="hljs-number">0.95</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IMAGE_FORMAT</span> = <span class="hljs-string">'image/png'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">/**
 * 将 DOM 元素转换为图片
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureElementToImage</span>(<span class="hljs-params">
  element: HTMLElement,
  quality: <span class="hljs-built_in">number</span> = IMAGE_QUALITY
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始截图...'</span>);

  <span class="hljs-comment">// 保存原始样式</span>
  <span class="hljs-keyword">const</span> originalOverflow = element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span>;
  <span class="hljs-keyword">const</span> originalHeight = element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span>;
  <span class="hljs-keyword">const</span> originalMaxHeight = element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span>;

  <span class="hljs-comment">// 临时设置样式，确保完整截图</span>
  element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">'visible'</span>;
  element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">'auto'</span>;
  element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span> = <span class="hljs-string">'none'</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 核心：使用 snapdom 进行截图</span>
    <span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
      <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 2倍清晰度</span>
      <span class="hljs-attr">quality</span>: quality
    });

    <span class="hljs-comment">// 优先使用 toPng()</span>
    <span class="hljs-keyword">const</span> imgElement = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>();
    <span class="hljs-keyword">const</span> dataUrl = imgElement.<span class="hljs-property">src</span>;

    <span class="hljs-comment">// 验证数据有效性</span>
    <span class="hljs-keyword">if</span> (!dataUrl || dataUrl.<span class="hljs-property">length</span> &lt; <span class="hljs-number">100</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'toPng 返回无效，尝试 toCanvas...'</span>);
      <span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toCanvas</span>();
      <span class="hljs-keyword">return</span> canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-variable constant_">IMAGE_FORMAT</span>, quality);
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'截图成功，大小:'</span>, (dataUrl.<span class="hljs-property">length</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'KB'</span>);
    <span class="hljs-keyword">return</span> dataUrl;

  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 恢复原始样式</span>
    element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = originalOverflow;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = originalHeight;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span> = originalMaxHeight;
  }
}
</code></pre>
<p><strong>关键点解析</strong>：</p>
<ol>
<li><strong>临时修改样式</strong>：将 <code>overflow</code>、<code>height</code>、<code>maxHeight</code> 临时设置为可见状态，确保截取完整内容</li>
<li><strong>scale: 2</strong>：2 倍缩放提高清晰度，打印时效果更佳</li>
<li><strong>降级处理</strong>：<code>toPng()</code> 失败时自动回退到 <code>toCanvas()</code></li>
<li><strong>样式恢复</strong>：截图完成后恢复原始样式</li>
</ol>
<h3 data-id="heading-17">Step 2：图片分页（Canvas）</h3>
<p>长图片需要按照 A4 页面高度进行分割，这是最复杂的一步。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 尺寸常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_WIDTH_MM</span> = <span class="hljs-number">210</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_HEIGHT_MM</span> = <span class="hljs-number">297</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_MARGIN_MM</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span> = <span class="hljs-variable constant_">A4_WIDTH_MM</span> - <span class="hljs-variable constant_">PDF_MARGIN_MM</span> * <span class="hljs-number">2</span>;   <span class="hljs-comment">// 190mm</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_CONTENT_HEIGHT_MM</span> = <span class="hljs-variable constant_">A4_HEIGHT_MM</span> - <span class="hljs-variable constant_">PDF_MARGIN_MM</span> * <span class="hljs-number">2</span>; <span class="hljs-comment">// 277mm</span>

<span class="hljs-comment">// 1mm = 3.7795275590551 像素（96 DPI）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MM_TO_PX</span> = <span class="hljs-number">3.7795275590551</span>;

<span class="hljs-comment">// 分页后的图片数据</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PageImageData</span> {
  <span class="hljs-attr">dataUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 将长图片分割成多个 A4 页面
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">splitImageIntoPages</span>(<span class="hljs-params">
  imageDataUrl: <span class="hljs-built_in">string</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PageImageData</span>[]&gt; {

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;

    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">pages</span>: <span class="hljs-title class_">PageImageData</span>[] = [];
      <span class="hljs-keyword">const</span> originalWidth = img.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> originalHeight = img.<span class="hljs-property">height</span>;

      <span class="hljs-comment">// 将 A4 内容区域转换为像素（考虑 scale=2）</span>
      <span class="hljs-keyword">const</span> pageContentHeightPx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(
        <span class="hljs-variable constant_">PDF_CONTENT_HEIGHT_MM</span> * <span class="hljs-variable constant_">MM_TO_PX</span> * <span class="hljs-number">2</span>  <span class="hljs-comment">// scale=2</span>
      );
      <span class="hljs-keyword">const</span> pageContentWidthPx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(
        <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span> * <span class="hljs-variable constant_">MM_TO_PX</span> * <span class="hljs-number">2</span>
      );

      <span class="hljs-comment">// 计算缩放比例（图片宽度适配页面宽度）</span>
      <span class="hljs-keyword">const</span> widthScale = pageContentWidthPx / originalWidth;
      <span class="hljs-keyword">const</span> scaledHeight = originalHeight * widthScale;

      <span class="hljs-comment">// 计算总页数</span>
      <span class="hljs-keyword">const</span> totalPages = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(scaledHeight / pageContentHeightPx);

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`原始尺寸: <span class="hljs-subst">${originalWidth}</span>x<span class="hljs-subst">${originalHeight}</span>px`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`缩放后高度: <span class="hljs-subst">${scaledHeight}</span>px, 总页数: <span class="hljs-subst">${totalPages}</span>`</span>);

      <span class="hljs-comment">// 逐页裁剪</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pageIndex = <span class="hljs-number">0</span>; pageIndex &lt; totalPages; pageIndex++) {
        <span class="hljs-keyword">const</span> startY = pageIndex * pageContentHeightPx;
        <span class="hljs-keyword">const</span> endY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(startY + pageContentHeightPx, scaledHeight);
        <span class="hljs-keyword">const</span> currentPageHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(endY - startY);

        <span class="hljs-comment">// 计算源图片对应的区域</span>
        <span class="hljs-keyword">const</span> sourceStartY = startY / widthScale;
        <span class="hljs-keyword">const</span> sourceHeight = currentPageHeight / widthScale;

        <span class="hljs-comment">// 创建新 Canvas</span>
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;

        canvas.<span class="hljs-property">width</span> = pageContentWidthPx;
        canvas.<span class="hljs-property">height</span> = currentPageHeight;

        <span class="hljs-comment">// 高质量渲染</span>
        ctx.<span class="hljs-property">imageSmoothingEnabled</span> = <span class="hljs-literal">true</span>;
        ctx.<span class="hljs-property">imageSmoothingQuality</span> = <span class="hljs-string">'high'</span>;

        <span class="hljs-comment">// 绘制当前页内容</span>
        ctx.<span class="hljs-title function_">drawImage</span>(
          img,
          <span class="hljs-number">0</span>, sourceStartY,           <span class="hljs-comment">// 源图片起始位置</span>
          originalWidth, sourceHeight, <span class="hljs-comment">// 源图片尺寸</span>
          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,                        <span class="hljs-comment">// 目标起始位置</span>
          pageContentWidthPx, currentPageHeight <span class="hljs-comment">// 目标尺寸</span>
        );

        <span class="hljs-comment">// 转换为 data URL</span>
        <span class="hljs-keyword">const</span> pageDataUrl = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-variable constant_">IMAGE_FORMAT</span>, <span class="hljs-variable constant_">IMAGE_QUALITY</span>);

        pages.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">dataUrl</span>: pageDataUrl,
          <span class="hljs-attr">width</span>: pageContentWidthPx,
          <span class="hljs-attr">height</span>: currentPageHeight
        });

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`第 <span class="hljs-subst">${pageIndex + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">${totalPages}</span> 页处理完成`</span>);
      }

      <span class="hljs-title function_">resolve</span>(pages);
    };

    img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'图片加载失败'</span>));
    img.<span class="hljs-property">src</span> = imageDataUrl;
  });
}
</code></pre>
<p><strong>分页算法图解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">原始长图 (假设 <span class="hljs-number">5000px</span> 高)
┌───────────────────┐
│                   │ ─┐
│      Page <span class="hljs-number">1</span>       │  │ <span class="hljs-number">1046px</span> (<span class="hljs-number">277mm</span> × <span class="hljs-number">3.78</span> × <span class="hljs-number">2</span>)
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">2</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">3</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">4</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│      Page <span class="hljs-number">5</span>       │ ── 剩余 <span class="hljs-number">816px</span>
│                   │
└───────────────────┘
</code></pre>
<h3 data-id="heading-18">Step 3：创建 PDF（jsPDF）</h3>
<p>将分页后的图片逐一添加到 PDF 中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { jsPDF } <span class="hljs-keyword">from</span> <span class="hljs-string">'jspdf'</span>;

<span class="hljs-comment">/**
 * 从分页图片创建 PDF
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createPdfFromPages</span>(<span class="hljs-params">pages: PageImageData[]</span>): jsPDF {
  <span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsPDF</span>({
    <span class="hljs-attr">orientation</span>: <span class="hljs-string">'portrait'</span>,
    <span class="hljs-attr">unit</span>: <span class="hljs-string">'mm'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'a4'</span>,
    <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 启用压缩，减小文件体积</span>
  });

  <span class="hljs-keyword">if</span> (pages.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有可添加的页面'</span>);
  }

  pages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">page, index</span>) =&gt;</span> {
    <span class="hljs-comment">// 第一页直接用，后续需要 addPage</span>
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">0</span>) {
      pdf.<span class="hljs-title function_">addPage</span>();
    }

    <span class="hljs-comment">// 像素转毫米（考虑 scale=2）</span>
    <span class="hljs-keyword">const</span> scaleFactor = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> pageHeightMm = page.<span class="hljs-property">height</span> / <span class="hljs-variable constant_">MM_TO_PX</span> / scaleFactor;

    <span class="hljs-comment">// 图片适配内容区域宽度</span>
    <span class="hljs-keyword">const</span> finalWidth = <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span>;  <span class="hljs-comment">// 190mm</span>
    <span class="hljs-keyword">const</span> finalHeight = pageHeightMm;

    <span class="hljs-comment">// 位置：左上角对齐，保留 10mm 边距</span>
    <span class="hljs-keyword">const</span> x = <span class="hljs-variable constant_">PDF_MARGIN_MM</span>;
    <span class="hljs-keyword">const</span> y = <span class="hljs-variable constant_">PDF_MARGIN_MM</span>;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`添加第 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span> 页: <span class="hljs-subst">${finalWidth}</span>x<span class="hljs-subst">${finalHeight.toFixed(<span class="hljs-number">2</span>)}</span>mm`</span>);

    <span class="hljs-comment">// 添加图片到 PDF</span>
    pdf.<span class="hljs-title function_">addImage</span>(page.<span class="hljs-property">dataUrl</span>, <span class="hljs-string">'PNG'</span>, x, y, finalWidth, finalHeight);
  });

  <span class="hljs-keyword">return</span> pdf;
}
</code></pre>
<h3 data-id="heading-19">Step 4：主导出函数</h3>
<p>将以上步骤串联起来，提供统一的导出接口。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExportConfig</span> {
  <span class="hljs-attr">targetSelector</span>: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// CSS 选择器</span>
  filename?: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 文件名</span>
  quality?: <span class="hljs-built_in">number</span>;         <span class="hljs-comment">// 图片质量</span>
}

<span class="hljs-comment">/**
 * 主导出函数
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">exportMessagesToPdf</span>(<span class="hljs-params">config: ExportConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> {
    targetSelector,
    filename = <span class="hljs-string">'messages.pdf'</span>,
    quality = <span class="hljs-variable constant_">IMAGE_QUALITY</span>
  } = config;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 开始导出 PDF ==='</span>);

  <span class="hljs-comment">// 1. 获取目标元素</span>
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(targetSelector) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
  <span class="hljs-keyword">if</span> (!element) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`元素未找到: <span class="hljs-subst">${targetSelector}</span>`</span>);
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素尺寸:'</span>, {
    <span class="hljs-attr">width</span>: element.<span class="hljs-property">offsetWidth</span>,
    <span class="hljs-attr">height</span>: element.<span class="hljs-property">scrollHeight</span>
  });

  <span class="hljs-comment">// 2. DOM 截图</span>
  <span class="hljs-keyword">const</span> imageDataUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">captureElementToImage</span>(element, quality);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'截图完成，大小:'</span>, (imageDataUrl.<span class="hljs-property">length</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'KB'</span>);

  <span class="hljs-comment">// 3. 图片分页</span>
  <span class="hljs-keyword">const</span> pages = <span class="hljs-keyword">await</span> <span class="hljs-title function_">splitImageIntoPages</span>(imageDataUrl);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`分页完成，共 <span class="hljs-subst">${pages.length}</span> 页`</span>);

  <span class="hljs-comment">// 4. 创建 PDF</span>
  <span class="hljs-keyword">const</span> pdf = <span class="hljs-title function_">createPdfFromPages</span>(pages);

  <span class="hljs-comment">// 5. 保存文件</span>
  pdf.<span class="hljs-title function_">save</span>(filename);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 导出完成 ==='</span>);
}
</code></pre>
<h3 data-id="heading-20">在组件中使用</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// MessageList.tsx</span>

<span class="hljs-keyword">import</span> { exportMessagesToPdf } <span class="hljs-keyword">from</span> <span class="hljs-string">'../services/messageExportService'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageList</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> messageListRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isExporting, setIsExporting] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> handleExportToPdf = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-title function_">setIsExporting</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 生成带时间戳的文件名</span>
      <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[:.]/g</span>, <span class="hljs-string">'-'</span>);
      <span class="hljs-keyword">const</span> filename = <span class="hljs-string">`messages-<span class="hljs-subst">${timestamp}</span>.pdf`</span>;

      <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportMessagesToPdf</span>({
        <span class="hljs-attr">targetSelector</span>: <span class="hljs-string">'.message-list-container'</span>,
        filename,
        <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>
      });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'导出失败:'</span>, error);
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'导出失败，请重试'</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsExporting</span>(<span class="hljs-literal">false</span>);
    }
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{messageListRef}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>消息记录<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"export-button"</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleExportToPdf}</span>
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isExporting}</span>
        &gt;</span>
          {isExporting ? '导出中...' : '导出 PDF'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list"</span>&gt;</span>
        {messages.map(message =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">MessageItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id}</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-21">完整效果</h3>
<p>运行项目后，点击「导出 PDF」按钮：</p>
<ol>
<li>控制台显示详细的导出日志</li>
<li>自动计算页数并分页</li>
<li>生成高清 PDF 文件并自动下载</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">=== 开始导出 <span class="hljs-attr">PDF</span> ===
目标选择器: .message-list-container
元素尺寸: { width: 600, height: 8500 }
开始截图...
截图完成，大小: 2847.65 KB
分页完成，共 8 页
添加第 1 页: 190x277.00mm
添加第 2 页: 190x277.00mm
...
添加第 8 页: <span class="hljs-attr">190x156.32mm</span>
=== 导出完成 ===
</code></pre>
<hr/>
<h2 data-id="heading-22">SnapDOM VS html2canvas</h2>
<p>为什么选择 SnapDOM 而不是更流行的 html2canvas？让我们来对比一下：</p>
<h3 data-id="heading-23">详细对比表</h3>




























































<table><thead><tr><th>对比维度</th><th>SnapDOM</th><th>html2canvas</th></tr></thead><tbody><tr><td><strong>样式还原</strong></td><td>★★★★★ 接近完美</td><td>★★★☆☆ 部分样式丢失</td></tr><tr><td><strong>Flexbox/Grid</strong></td><td>✅ 完美支持</td><td>⚠️ 部分问题</td></tr><tr><td><strong>渐变背景</strong></td><td>✅ 完美支持</td><td>⚠️ 可能失真</td></tr><tr><td><strong>阴影效果</strong></td><td>✅ 完美支持</td><td>⚠️ 部分丢失</td></tr><tr><td><strong>自定义字体</strong></td><td>✅ 支持</td><td>⚠️ 需要额外处理</td></tr><tr><td><strong>SVG 支持</strong></td><td>✅ 原生支持</td><td>⚠️ 有限支持</td></tr><tr><td><strong>输出格式</strong></td><td>PNG/Canvas/SVG</td><td>Canvas/PNG</td></tr><tr><td><strong>包大小</strong></td><td>~20KB</td><td>~60KB</td></tr><tr><td><strong>维护状态</strong></td><td>活跃更新</td><td>较少更新</td></tr><tr><td><strong>API 设计</strong></td><td>现代 Promise</td><td>回调 + Promise</td></tr></tbody></table>
<h3 data-id="heading-24">代码对比</h3>
<p><strong>html2canvas 方式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">'html2canvas'</span>;

<span class="hljs-comment">// 需要处理各种兼容性问题</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> <span class="hljs-title function_">html2canvas</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">logging</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">allowTaint</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">foreignObjectRendering</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 可能不生效</span>
  <span class="hljs-comment">// 还需要处理字体、SVG 等问题...</span>
});

<span class="hljs-keyword">const</span> dataUrl = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/png'</span>);
</code></pre>
<p><strong>SnapDOM 方式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 简洁的 API，无需额外配置</span>
<span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>
});

<span class="hljs-keyword">const</span> dataUrl = (<span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>()).<span class="hljs-property">src</span>;
</code></pre>
<h3 data-id="heading-25">什么时候选择 html2canvas？</h3>
<p>虽然 SnapDOM 在大多数场景下更优秀，但 html2canvas 在以下情况可能更适合：</p>
<ol>
<li><strong>项目已在使用</strong>：迁移成本较高</li>
<li><strong>简单场景</strong>：只需截取简单文本，无复杂样式</li>
<li><strong>团队熟悉度</strong>：团队对 html2canvas 更熟悉</li>
</ol>
<h2 data-id="heading-26">总结</h2>
<h3 data-id="heading-27">核心要点回顾</h3>
<ol>
<li><strong>SnapDOM</strong> 提供高保真的 DOM 截图能力，通过 <code>scale: 2</code> 实现 2 倍清晰度</li>
<li><strong>jsPDF</strong> 是强大的 PDF 生成库，支持 A4 纸张、压缩等特性</li>
<li><strong>分页算法</strong> 是整个方案的核心难点，需要精确计算像素与毫米的转换</li>
<li><strong>SnapDOM</strong> 相比 html2canvas 在样式还原度上有明显优势</li>
</ol>
<h3 data-id="heading-28">进一步优化方向</h3>





























<table><thead><tr><th>优化点</th><th>说明</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>将分页计算放到 Worker 中，避免阻塞主线程</td></tr><tr><td><strong>分段截图</strong></td><td>超长内容分段截图，避免内存溢出</td></tr><tr><td><strong>加载提示</strong></td><td>添加进度条，提升用户体验</td></tr><tr><td><strong>PDF 压缩</strong></td><td>使用 pdf-lib 进一步压缩 PDF 体积</td></tr><tr><td><strong>页眉页脚</strong></td><td>添加页码、时间戳等信息</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO中国版终于来了，完全免费！]]></title>    <link>https://juejin.cn/post/7576580177662132234</link>    <guid>https://juejin.cn/post/7576580177662132234</guid>    <pubDate>2025-11-26T04:34:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576580177662132234" data-draft-id="7576646142315937833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO中国版终于来了，完全免费！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T04:34:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO中国版终于来了，完全免费！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:34:27.000Z" title="Wed Nov 26 2025 04:34:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 454 篇原创！</p>
<p>大家好，我是还没秃顶的苍何。</p>
<p>昨晚听了 TRAE SOLO 国内版上线的发布会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a52e09b1f24a669b6039c91d2450ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=0XY9x7d8iNF1Vlt%2BhvEfs9PoZBs%3D" alt="图片" loading="lazy"/></p>
<p>时隔 4 个月，它终于来了。</p>
<p>我也第一时间做了下体验，做了几个 case，录了个视频给大家看看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ea2fc4cbe04f63a92a4f3b65840006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=tFRfXJgCl1EV6%2BCd0RqY8Btf6c0%3D" alt="wxv_4269304641676214281" loading="lazy"/></p>
<p>追溯到 7 月份，那时候国际版刚开 Beta 测试，全网爆火，激活码真是一码难求。我当时废了很大劲，第一时间抢鲜体验了一把，手感确实惊艳，为此还专门写过一篇文章分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e3bfebe492740cab632a4b7a26e89d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=wh5d7TvihbfhjeQt6wosEvfCtrk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也是从那时起，我和 Trae 算是「杠」上了，关系变得相当微妙。</p>
<p>后来我还成了武汉的 Trae Fellow，在武汉搞了一场黑客松。看着大家在现场用它从 0 到 1 构建项目，我是真切感受到了工具带来的变化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250626d7ed844bb0a57773ac8935e4ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=ZOAYXNR8s4WiRFhT3SGgg93OuTc%3D" alt="图片" loading="lazy"/></p>
<p>至于为啥我一直盯着 Trae 不放，又为啥觉得这次国内版 SOLO 模式的发布意义非凡？</p>
<p>理由其实很简单。</p>
<p>虽然 Cursor 很强，但网络问题把太多人挡在门外了。我们太缺一款能真正对标甚至超越 Cursor，同时又没有任何网络门槛的 AI IDE 了。</p>
<p>AI 编程不该是少数人的特权。</p>
<p>要想让这种强大的生产力真正铺开，让每个人都能体会到它的强大，就得把门槛踩碎。</p>
<p>这正是 Trae 这段时间一直在默默做的事。</p>
<p>11 月 25 日发布的这个版本，直接同步了国际版最核心的 SOLO Coder 功能，甚至包括 Plan 模式、多任务并行这些硬核能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dc3653e8434bfe8a2e91642294e9b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=qjd62r%2FZsZ1sX9yhB4UzN8vVVxk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>最最关键的是，它目前<strong>完全免费</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be1518803bd41b898e9a6726b5372a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1HT2kZ9K6%2F3WlOMEsRiK2pbvqUY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>可以实时跟随，还会自动打开浏览器页面预览，非常方便。</p>
<p>这就很有意思了。以前我们用 AI 写代码，总感觉像是在「开盲盒」。你给个指令，AI 闷头写，写出来能跑算运气好，不能跑你就得在那对着一堆代码干瞪眼，完全不知道它中间经历了什么心路历程。</p>
<p>但 TRAE SOLO 主打的概念叫「Responsive Coding Agent」。</p>
<p>别被这个英文吓到，我自己上手盘了一下，觉得用大白话解释就是：<strong>它不再是个只会执行命令的死板工具，而是一个能和你「有商有量」的智能队友。</strong></p>
<p>具体强在哪？我挑几个咱们写代码时最感同身受的点聊聊。</p>
<p><strong>第一，它懂得「先思考，再动手」。</strong></p>
<p>以前的 AI 是急性子，你需求还没说完，它代码可能就生成了一半。结果往往是方向错了，还得推倒重来。</p>
<p>TRAE SOLO 有个 <strong>Plan 模式</strong>。当你抛出一个复杂需求时，它不会急着写代码，而是先给你列一个 To-Do List，告诉你它准备分几步走。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28279fd152f94235a5b404a7fd0ebd35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=CaOfEkZ3AKrNDfoJpmgRhfBExc4%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这就很像带徒弟了。</p>
<p>你看了计划，觉得没问题，它再开工；觉得逻辑不对，直接在计划阶段就指出来。把错误扼杀在写代码之前，这才是正经的工程思维。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f8615e6134b819e7066e3ad68231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=6u1MWBujjCMpZQGfr90%2FAPtwnow%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第二，告别黑盒，代码改了哪一目了然。</strong></p>
<p>这次新增的代码变更（ <strong>DiffView</strong> ）功能我个人非常喜欢。</p>
<p>以前 AI 改代码，经常把好的逻辑也给改坏了。现在，它做了哪些新增、改了哪些逻辑，都在界面上清清楚楚地展示出来。</p>
<p>你可以实时审查（Code Review），就像看同事提交的代码一样。你没点头，它就不敢乱合并。这种「随时可掌控」的感觉，才是我们敢在实际项目里用 AI 的底气。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e79022ae1ff423f9ac7e9215d1d81a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=LLKNsMavSOSm37mOd5xYhWNQB8A%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第三，脑子好使，还懂得「断舍离」。</strong></p>
<p>做大项目最怕 AI 聊着聊着就「失忆」，或者因为上下文太长开始胡言乱语。</p>
<p>TRAE SOLO 在这块做得比较聪明。它能支持检索海量的代码文件（据说能扛住 10 万个文件），更重要的是，它有一套自动的上下文压缩机制。</p>
<p>当对话太长时，它会自动触发压缩，保留核心信息；你也可以手动点一下压缩，让它把没用的废话清掉。这样既保留了关键记忆，又不会让模型跑偏。</p>
<p><strong>除此，它还能「分身」。</strong></p>
<p>这玩意儿支持多任务并行 sub agent。你可以开一个线程让它去修 Bug，同时开另一个线程让它去写新功能的接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca08f3fe2b84b6583cd6c0291dd9d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=VW8Mrm4rK8LpYaLQ%2FgBVwi46z8g%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>一个人就是一支队伍，这回真不是说说而已。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6242fa3c9ee3409abcd55bc373db269f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=2GrcV1KDXI%2FxENe6DFU1J6SVv98%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这些智能体也是可以自己创建的，点「创建智能体」就能创建了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b883d8c325084545954e87bf2212da84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=vQEIIt65AKol489Y236CkCZhRPg%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>创建好后就能看到自己拥有的智能体了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8254192470f4ba191e26e935671b09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1hw0UzJ%2Fcv6k%2BVmpNYAOapnHF%2F8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>目前国内版支持了国内顶尖的代码模型，比如 Doubao-Seed-Code、Kimi K2、GLM 4.6 等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f521848b7e4e1eb4a80885117a8918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=o51GEbXYwKRgRlBQiDJ2lGQZuyk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也支持自定义模型。</p>
<p>同样内置不少 MCP。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bbbf2dcefc24e199bce02b606cf6c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=lWbEPTx5ANz1qP1IDo6th5kPxLY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>广场能搜素到非常多好用的 MCP，配置也很简单相对 Cursor 来说。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c251ca0914e406b9c9844c0e9a4419e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=yQ5TLllMOnxrVNqPixWLzzLjVD0%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>体验下来，最大的感受就是「顺滑」。没有网络延迟的焦虑，加上这种透明的协作模式，确实能让人专注于创造本身。</p>
<p>说实话，Trae SOLO 给我的感觉是「瑕不掩瑜」。</p>
<p>如果要吹毛求疵，国内底层的代码模型在处理极度复杂的深层逻辑时，距离国外最顶尖的模型确实还有一些提升空间。这点咱们得认，模型能力的打磨还需要时间。</p>
<p>但 Trae 团队聪明的地方在于，他们用极致的产品细节弥补了这一点。</p>
<p>那种行云流水的交互感，DiffView 带来的掌控感，以及 Plan 模式下的「商量着来」，让你在使用过程中往往会忽略掉模型本身的一点小瑕疵。</p>
<p>更重要的是，它打破了那堵把无数人挡在 AI 编程门外的「墙」。</p>
<p>不用折腾网络，不用担心账单，打开就能用。对于大多数想尝试 AI 编程的朋友来说，这就够了。</p>
<p>国产 IDE 能做到这个细腻程度，值得给点掌声。</p>
<p>去试试吧，也许它就是你期待已久的那个「编程搭子」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析]]></title>    <link>https://juejin.cn/post/7576543407013232659</link>    <guid>https://juejin.cn/post/7576543407013232659</guid>    <pubDate>2025-11-26T00:39:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407013232659" data-draft-id="7571815573933408319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2025-11-26T00:39:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:39:47.000Z" title="Wed Nov 26 2025 00:39:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在健康类 App 开发中，睡眠周期分析和冥想数据展示是核心功能模块。一个直观、美观且交互流畅的可视化图表，能极大提升用户对健康数据的理解和使用体验。今天给大家推荐一款专为 Flutter 开发者打造的全能型图表插件——<strong>sleep_stage_chart</strong>，它不仅能完美呈现睡眠阶段数据，还支持冥想时长可视化，跨平台兼容且高度可定制。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p><code>sleep_stage_chart</code>是一款专注于睡眠阶段和冥想数据可视化的 Flutter 插件，借鉴了 Apple Health 应用的优雅设计风格，提供了平滑的过渡效果和丰富的交互能力。该插件支持 Android、iOS 和 Windows 三大平台，能够满足健康类 App 对睡眠周期分析、冥想时长统计等场景的可视化需求。</p>
<h3 data-id="heading-1">1.1. 例图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b79258904c437ebbd0ad21222c3480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=j27zZH389EnntvmiOQ5T5xdwVVo%3D" alt="睡眠图" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6c35ad686d4faab1d7fb8b59c205fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=Kp5YCWV4ao5d15cAckwkfDNzm%2Bo%3D" alt="冥想图" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 核心功能</h3>
<p>该插件的功能覆盖了健康数据可视化的核心需求，同时提供了足够的灵活性：</p>
<ul>
<li>📊 <strong>双图表支持</strong>：同时兼容睡眠阶段图（浅睡/深睡/REM/清醒状态）和冥想时长图</li>
<li>🎨 <strong>深度定制化</strong>：支持颜色、样式、布局、网格线等全维度自定义</li>
<li>📱 <strong>跨平台兼容</strong>：无缝运行于 Android、iOS、Windows 平台</li>
<li>🤏 <strong>交互体验</strong>：支持触摸拖拽指示器，查看不同时段的详细数据</li>
<li>🕐 <strong>精准时间展示</strong>：清晰呈现时间范围、阶段时长，支持自定义时间格式化</li>
<li>🎀 <strong>样式扩展</strong>：支持自定义底部组件、圆角、背景色等外观属性</li>
<li>📖 <strong>完善文档</strong>：提供完整的 API 说明和可直接运行的示例代码</li>
</ul>
<h2 data-id="heading-3">2. 快速集成</h2>
<p>在项目的 <code>pubspec.yaml</code> 文件中添加插件依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">sleep_stage_chart:</span> <span class="hljs-string">^1.1.2</span>  <span class="hljs-comment"># 建议使用最新版本</span>
</code></pre>
<p>执行安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h3 data-id="heading-4">2.1. 基础使用示例</h3>
<p>插件提供了两种核心图表场景：睡眠阶段图和冥想时长图，以下是最简实现示例。</p>
<h4 data-id="heading-5">睡眠阶段图</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SleepChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 构造睡眠数据：包含阶段类型、起止时间、描述信息</span>
    <span class="hljs-keyword">final</span> sleepData = [
      SleepStageDetails(
        model: SleepStageEnum.light,  <span class="hljs-comment">// 浅睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'浅睡，睡眠质量良好'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.deep,   <span class="hljs-comment">// 深睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        info: [<span class="hljs-string">'深睡，身体修复阶段'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.rem,    <span class="hljs-comment">// REM睡眠（快速眼动）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>),
        info: [<span class="hljs-string">'REM睡眠，大脑活跃'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.awake,  <span class="hljs-comment">// 清醒</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'清醒，准备起床'</span>],
      ),
    ];

    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: sleepData,  <span class="hljs-comment">// 睡眠数据（必填）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),  <span class="hljs-comment">// 开始时间（必填）</span>
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),     <span class="hljs-comment">// 结束时间（必填）</span>
        backgroundColor: Colors.white,            <span class="hljs-comment">// 背景色（必填）</span>
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,                   <span class="hljs-comment">// 高度比例单位</span>
        onIndicatorMoved: (stage) {               <span class="hljs-comment">// 指示器移动回调</span>
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前阶段：<span class="hljs-subst">${stage.model.name}</span>，时长：<span class="hljs-subst">${stage.duration}</span>分钟'</span>);
        },
        bottomChild: <span class="hljs-keyword">const</span> [Text(<span class="hljs-string">'入睡'</span>), Text(<span class="hljs-string">'起床'</span>)],  <span class="hljs-comment">// 底部自定义文本</span>
        stageColors: {  <span class="hljs-comment">// 自定义各阶段颜色</span>
          SleepStageEnum.light: Colors.blue.shade300,
          SleepStageEnum.deep: Colors.blue.shade700,
          SleepStageEnum.rem: Colors.teal.shade400,
          SleepStageEnum.awake: Colors.orange.shade300,
        },
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-6">冥想时长图</h4>
<p>冥想图表通常需要展示全天或特定时段的冥想分布，可通过统一颜色和时间轴配置实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MeditationChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> dayStart = <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: [
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">30</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">75</span>)),
            info: [<span class="hljs-string">'晨间冥想，专注呼吸'</span>],
          ),
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">19</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">20</span>, minutes: <span class="hljs-number">20</span>)),
            info: [<span class="hljs-string">'睡前冥想，放松身心'</span>],
          ),
        ],
        startTime: dayStart,
        endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">1</span>)),
        backgroundColor: Colors.transparent,
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,
        allDayModel: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 开启全天模式</span>
        minuteInterval: <span class="hljs-number">360</span>,  <span class="hljs-comment">// 时间轴间隔：6小时</span>
        stageColors: <span class="hljs-keyword">const</span> {  <span class="hljs-comment">// 统一冥想颜色</span>
          SleepStageEnum.light: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.deep: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.rem: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.awake: Color(<span class="hljs-number">0xFF43CAC4</span>),
        },
        bottomChild: [<span class="hljs-string">'00:00'</span>, <span class="hljs-string">'06:00'</span>, <span class="hljs-string">'12:00'</span>, <span class="hljs-string">'18:00'</span>, <span class="hljs-string">'00:00'</span>]
            .map((time) =&gt; Text(time, style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>)))
            .toList(),
        showVerticalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示竖线分隔</span>
        showHorizontalLine: <span class="hljs-keyword">false</span>,  <span class="hljs-comment">// 隐藏横线</span>
        borderRadius: <span class="hljs-number">12</span>,  <span class="hljs-comment">// 圆角优化</span>
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">2.2. 高级定制指南</h3>
<p><code>sleep_stage_chart</code>提供了丰富的定制属性，以下是常见场景的定制方案。</p>
<h4 data-id="heading-8">颜色定制</h4>
<p>通过 <code>stageColors</code> 属性自定义各睡眠阶段的颜色，支持所有 <code>SleepStageEnum</code> 类型：</p>
<pre><code class="hljs language-dart" lang="dart">stageColors: <span class="hljs-keyword">const</span> {
  SleepStageEnum.light: Color(<span class="hljs-number">0xFFE3F2FD</span>),  <span class="hljs-comment">// 浅睡-淡蓝</span>
  SleepStageEnum.deep: Color(<span class="hljs-number">0xFF90CAF9</span>),   <span class="hljs-comment">// 深睡-中蓝</span>
  SleepStageEnum.rem: Color(<span class="hljs-number">0xFF42A5F5</span>),    <span class="hljs-comment">// REM-深蓝</span>
  SleepStageEnum.awake: Color(<span class="hljs-number">0xFFFFE0B2</span>),  <span class="hljs-comment">// 清醒-淡橙</span>
  SleepStageEnum.notWorn: Color(<span class="hljs-number">0xFFF5F5F5</span>),<span class="hljs-comment">// 未佩戴-灰色</span>
  SleepStageEnum.unknown: Color(<span class="hljs-number">0xFFEEEEEE</span>),<span class="hljs-comment">// 未知-浅灰</span>
},
</code></pre>
<h4 data-id="heading-9">网格线定制</h4>
<p>控制网格线的显示/隐藏和样式：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 横线样式</span>
horizontalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
  space: <span class="hljs-number">2.0</span>,  <span class="hljs-comment">// 虚线间隔</span>
),
<span class="hljs-comment">// 竖线样式</span>
verticalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
),
showHorizontalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示横线</span>
showVerticalLine: <span class="hljs-keyword">true</span>,    <span class="hljs-comment">// 显示竖线</span>
horizontalLineCount: <span class="hljs-number">6</span>,    <span class="hljs-comment">// 横线数量（分割图表高度）</span>
</code></pre>
<h4 data-id="heading-10">时间格式化</h4>
<p>通过 <code>dateFormatter</code> 自定义时间轴的显示格式：</p>
<pre><code class="hljs language-dart" lang="dart">dateFormatter: (<span class="hljs-built_in">DateTime</span> date) {
  <span class="hljs-comment">// 自定义格式：小时-分钟（补零）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${date.hour.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>:<span class="hljs-subst">${date.minute.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>'</span>;
},
</code></pre>
<h4 data-id="heading-11">交互控制</h4>
<p>控制指示器的显示和回调：</p>
<pre><code class="hljs language-dart" lang="dart">hasIndicator: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示触摸指示器</span>
onIndicatorMoved: (SleepStageDetails stage) {
  <span class="hljs-comment">// 指示器移动时回调，可用于更新详情面板</span>
  setState(() {
    _currentStage = stage;
    _currentDuration = <span class="hljs-string">'<span class="hljs-subst">${stage.duration}</span>分钟'</span>;
    _currentInfo = stage.info.join(<span class="hljs-string">' '</span>);
  });
},
</code></pre>
<h2 data-id="heading-12">3. 核心 API 参考</h2>
<p>下面是核心的api属性列举：</p>
<h3 data-id="heading-13">SleepStageChart（主组件）</h3>





































































































<table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>details</code></td><td>List</td><td>-</td><td>核心数据（必填）</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>-</td><td>开始时间（必填）</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>-</td><td>结束时间（必填）</td></tr><tr><td><code>backgroundColor</code></td><td>Color</td><td>-</td><td>背景色（必填）</td></tr><tr><td><code>stageColors</code></td><td>Map&lt;SleepStageEnum, Color&gt;?</td><td>null</td><td>阶段颜色映射</td></tr><tr><td><code>heightUnitRatio</code></td><td>double</td><td>-</td><td>高度比例单位</td></tr><tr><td><code>borderRadius</code></td><td>double</td><td>8.0</td><td>圆角半径</td></tr><tr><td><code>showVerticalLine</code></td><td>bool</td><td>true</td><td>是否显示竖线</td></tr><tr><td><code>showHorizontalLine</code></td><td>bool</td><td>true</td><td>是否显示横线</td></tr><tr><td><code>hasIndicator</code></td><td>bool</td><td>true</td><td>是否显示触摸指示器</td></tr><tr><td><code>onIndicatorMoved</code></td><td>void Function(SleepStageDetails)?</td><td>null</td><td>指示器移动回调</td></tr><tr><td><code>allDayModel</code></td><td>bool</td><td>false</td><td>是否开启全天模式</td></tr><tr><td><code>minuteInterval</code></td><td>int</td><td>360</td><td>全天模式时间间隔（分钟）</td></tr><tr><td><code>bottomChild</code></td><td>List</td><td>[]</td><td>底部自定义组件列表</td></tr><tr><td><code>dateFormatter</code></td><td>String Function(DateTime)?</td><td>null</td><td>时间格式化函数</td></tr></tbody></table>
<h3 data-id="heading-14">SleepStageDetails（数据模型）</h3>



































<table><thead><tr><th>属性名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>model</code></td><td>SleepStageEnum</td><td>睡眠/冥想阶段类型</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>阶段开始时间</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>阶段结束时间</td></tr><tr><td><code>info</code></td><td>List</td><td>阶段描述信息</td></tr><tr><td><code>duration</code></td><td>int</td><td>时长（分钟，自动计算）</td></tr></tbody></table>
<h3 data-id="heading-15">SleepStageEnum（阶段枚举）</h3>





























<table><thead><tr><th>枚举值</th><th>描述</th></tr></thead><tbody><tr><td><code>light</code></td><td>浅睡/冥想</td></tr><tr><td><code>deep</code></td><td>深睡</td></tr><tr><td><code>rem</code></td><td>REM睡眠</td></tr><tr><td><code>awake</code></td><td>清醒</td></tr><tr><td><code>unknown</code></td><td>未知状态</td></tr></tbody></table>
<h2 data-id="heading-16">4. 示例App项目</h2>
<p>插件提供了完整的示例项目，可直接克隆源码运行体验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wp993080086/sleep_stage_chart.git

<span class="hljs-comment"># 进入示例目录</span>
<span class="hljs-built_in">cd</span> sleep_stage_chart/example

<span class="hljs-comment"># 安装依赖并运行</span>
flutter pub get
flutter run
</code></pre>
<p>示例项目包含了睡眠图表、冥想图表的各种定制场景，可直接参考复用。</p>
<h2 data-id="heading-17">5. 总结</h2>
<p>sleep_stage_chart 是一款功能全面、高度可定制的 Flutter 健康数据可视化插件，凭借其优雅的设计风格、流畅的交互体验和跨平台兼容性，能够快速满足睡眠和冥想数据的可视化需求。无论是快速集成基础图表，还是深度定制符合 App 风格的可视化效果，该插件都能提供简洁高效的解决方案。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>睡眠监测类 App：展示深睡、浅睡、REM 睡眠周期分布</li>
<li>冥想类 App：统计每日/每周冥想时长和时段分布</li>
<li>健康管理 App：整合睡眠与冥想数据的综合可视化</li>
<li>智能穿戴设备配套 App：同步设备采集的睡眠数据展示</li>
</ul>
<p>如果你的项目中需要实现睡眠周期分析或冥想数据展示，不妨试试 sleep_stage_chart，让健康数据可视化开发更高效！</p>
<p><strong>相关链接：</strong></p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart" ref="nofollow noopener noreferrer">GitHub仓库</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart%2Fblob%2Fmaster%2FREADME_zh.md" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart/blob/master/README_zh.md" ref="nofollow noopener noreferrer">中文文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fsleep_stage_chart" target="_blank" title="https://pub.dev/packages/sleep_stage_chart" ref="nofollow noopener noreferrer">pub.dev仓库</a></p>
</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被国外IP持续DDOS怎么办？]]></title>    <link>https://juejin.cn/post/7576669556150403110</link>    <guid>https://juejin.cn/post/7576669556150403110</guid>    <pubDate>2025-11-26T06:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576669556150403110" data-draft-id="7576580177662640138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被国外IP持续DDOS怎么办？"/> <meta itemprop="keywords" content="前端,Node.js,Nginx"/> <meta itemprop="datePublished" content="2025-11-26T06:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洞窝技术"/> <meta itemprop="url" content="https://juejin.cn/user/2538113306470631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被国外IP持续DDOS怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538113306470631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洞窝技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:38:20.000Z" title="Wed Nov 26 2025 06:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    58
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c801015fd006484384445c9421b6ec01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811946&amp;x-signature=Tfoe1ntAgSUIr8tgkmb23oANSNE%3D" alt="logo.png" loading="lazy"/></p>
<p>最近持续被东南亚的几个IP持续攻击，我用的是阿里云的免费应用防火墙，一直没什么好办法。今天看到了几个免费的IP库，一下子就想到了如果我直接屏蔽这些来源国家的访问不就好了。</p>
<p>在网站运营、网络安全或流量管控场景中，按国家/地区限制IP访问（如仅允许国内IP访问、屏蔽特定国家IP）是常见需求。实现这一需求的核心步骤是：获取目标国家的IP段 → 将IP段配置到 Nginx 中生效。本文将详细讲解如何通过Node.js或Shell脚本获取国家IP段，并结合 Nginx 的geo模块完成配置。</p>
<h2 data-id="heading-0">一、选择 IP 数据源</h2>
<p>获取国家 IP 段的前提是选择可靠的数据源，目前主流免费/商用数据源包括：</p>
<h3 data-id="heading-1">1. MaxMind GeoLite2</h3>
<p>MaxMind 是全球知名的 IP 地理信息服务商，提供免费的 GeoLite2 数据库（需注册账号），包含 IPv4/IPv6 的国家 / 地区映射，数据精度高且更新及时（每月更新）。</p>
<h3 data-id="heading-2">2. apnic</h3>
<p>apnic提供免费可直接获取的IP信息，直接下载就能获取最新的IP数据信息。</p>
<h3 data-id="heading-3">3. 其他</h3>
<ul>
<li>ip2region：国内开源的 IP 定位库，支持国家 / 城市级映射，数据文件小（约 10MB），查询速度快。</li>
<li>17monip（纯真 IP）：国内常用的 IP 库，需定期下载更新包。</li>
<li>IP2Location LITE：类似 GeoLite2 的免费数据库，提供 CSV/MMDB 格式。</li>
</ul>
<p>本文以apnic为例讲解（兼容性和易用性最优）。</p>
<h2 data-id="heading-4">二、获取国家 IP 段的方法</h2>
<h3 data-id="heading-5">方法 1：使用bash脚本获取并处理</h3>
<p>这种方式适合linux系统下的简单使用，兼容centos、ubuntu等系统。</p>
<h4 data-id="heading-6">步骤一：获取数据</h4>
<p>可以使用<code>wget</code>或者<code>curl</code>这种命令直接从远程下载脚本，脚本地址取最新数据<code>http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest</code>，脚本内容类似：</p>
<pre><code class="hljs language-bash" lang="bash">wget -c -O /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest

curl -C - -o /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest
</code></pre>
<h3 data-id="heading-7">步骤二：处理数据</h3>
<p>官方提供的数据通常都是txt格式的，逐行进行排列的数据。我们要使用还需要对数据进行解析，把我们需要的数据单独获取出来。可以使用脚本的<code>awk</code>命令进行处理。</p>
<p><code>awk</code>的命令格式:</p>
<pre><code class="hljs language-bash" lang="bash">awk [参数] [处理内容] [操作对象]
</code></pre>
<h3 data-id="heading-8">完整脚本</h3>
<p>我们假设要把数据处理成“起始IP|数量/前缀长度|注册机构|国家代码”的格式，按照这个逻辑，再加上错误处理，我们输出以下脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -eu  <span class="hljs-comment"># 移除 pipefail，兼容低版本 Bash，保留关键错误检查</span>

<span class="hljs-comment"># 脚本配置</span>
URL=<span class="hljs-string">"http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest"</span>
DOWNLOAD_DIR=<span class="hljs-string">"/root/apnic"</span>
DOWNLOAD_FILENAME=<span class="hljs-string">"delegated-apnic-latest"</span>
IPV4_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv4.txt"</span>
IPV6_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv6.txt"</span>

<span class="hljs-comment"># 帮助信息</span>
<span class="hljs-function"><span class="hljs-title">show_help</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法：<span class="hljs-variable">$0</span> --download-dir &lt;下载目录&gt; [--temp-dir &lt;临时目录&gt;]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"选项："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  --download-dir  可选，文件下载保存目录"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  -h/--help       显示帮助信息"</span>
}

<span class="hljs-comment"># 解析命令行参数</span>
<span class="hljs-function"><span class="hljs-title">parse_args</span></span>() {

    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --download-dir)
                DOWNLOAD_DIR=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            -h|--<span class="hljs-built_in">help</span>)
                show_help
                <span class="hljs-built_in">exit</span> 0
                ;;
            *)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未知参数 <span class="hljs-variable">$1</span>"</span>
                show_help
                <span class="hljs-built_in">exit</span> 1
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 检查依赖工具（wget 或 curl）</span>
<span class="hljs-function"><span class="hljs-title">check_dependencies</span></span>() {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v wget &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"wget"</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v curl &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"curl"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未找到 wget 或 curl，请先安装其中一个工具"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 下载文件 + 校验文件有效性</span>
<span class="hljs-function"><span class="hljs-title">download_file</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始下载文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"URL: <span class="hljs-variable">$URL</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"保存路径: <span class="hljs-variable">$download_path</span>"</span>

    <span class="hljs-comment"># 检查下载目录是否存在</span>
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：无法创建保持目录 <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 下载文件（支持断点续传）</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_TOOL</span>"</span> == <span class="hljs-string">"wget"</span> ]]; <span class="hljs-keyword">then</span>
        wget -c -O <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：wget 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">else</span>
        curl -C - -o <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：curl 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 校验下载文件是否为空</span>
    <span class="hljs-keyword">if</span> [[ ! -s <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：下载的文件为空，请检查 URL 或网络连接"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span>  <span class="hljs-comment"># 删除空文件</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 文件下载完成（大小：<span class="hljs-subst">$(du -sh <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> | awk '{print $1}')</span>）==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"下载文件路径: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 解析并筛选 IPv4/IPv6（容错增强）</span>
<span class="hljs-function"><span class="hljs-title">parse_and_filter_ip</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv4_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV4_OUTPUT_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv6_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV6_OUTPUT_FILENAME}</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始解析文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"源文件: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"解析目录: <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>

    <span class="hljs-comment"># 清空输出文件（避免残留旧数据）</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>

    <span class="hljs-comment"># 筛选规则：</span>
    <span class="hljs-comment"># 1. 跳过注释行（以 # 开头）和空行</span>
    <span class="hljs-comment"># 2. 第 3 列（type）为 ipv4/ipv6 的行</span>
    <span class="hljs-comment"># 3. 输出格式：起始IP|数量/前缀长度|注册机构|国家代码（字段 4|5|1|2）</span>
    <span class="hljs-comment"># 用 awk 处理，即使部分行格式异常也不中断</span>
    awk -F <span class="hljs-string">'|'</span> <span class="hljs-string">'
        !/^#/ &amp;&amp; NF &gt;= 6 {  # 只处理非注释行且字段数≥6的行
            if ($3 == "ipv4") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span><span class="hljs-string">'"
            } else if ($3 == "ipv6") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span><span class="hljs-string">'"
            }
        }
    '</span> <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> || {
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：部分行格式异常，已跳过"</span>
    }

    <span class="hljs-comment"># 检查筛选结果（允许其中一种IP类型为空，避免误判）</span>
    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv4 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv6 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 解析筛选完成 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 文件路径: <span class="hljs-variable">$ipv4_output</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 文件路径: <span class="hljs-variable">$ipv6_output</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 主流程</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    parse_args <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
    check_dependencies
    download_file
    parse_and_filter_ip

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 任务全部完成 ==="</span>
}

<span class="hljs-comment"># 启动脚本</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>脚本首先设置默认变量，也就是默认的存储位置是<code>/root/apnic</code>，然后再把最新数据下载到文件里，通过命令筛选我们需要的数据分别存到对应的文件中。</p>
<h3 data-id="heading-9">方法 2：Node.js处理数据</h3>
<p>使用nodejs整体流程设计上就不需要临时存储文件了，我们直接每次获取之后在内存中就全部处理完成。整体处理如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-comment">// 要允许通过的国家</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ALLowList</span> = [<span class="hljs-string">'CN'</span>, <span class="hljs-string">'HK'</span>, <span class="hljs-string">'MO'</span>, <span class="hljs-string">'TW'</span>];

<span class="hljs-comment">// 获取远程数据</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getApnicTxt</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
}

<span class="hljs-comment">// apnic|BD|ipv4|103.132.248.0|1024|20190116|allocated</span>
<span class="hljs-comment">// apnic|ID|ipv6|2001:df0:f180::|48|20190718|assigned</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIpRecord</span>(<span class="hljs-params">line, dot = <span class="hljs-string">'24'</span></span>) {
    <span class="hljs-keyword">const</span> parts = line.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">ALLowList</span>.<span class="hljs-title function_">includes</span>(parts[<span class="hljs-number">1</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`allow <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`deny <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> txts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getApnicTxt</span>();
    <span class="hljs-keyword">const</span> list = txts.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">const</span> ipv4list = [];
    <span class="hljs-keyword">const</span> ipv6list = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; list.<span class="hljs-property">length</span>; index++) {
        <span class="hljs-keyword">const</span> txt = list[index];
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv4|'</span>)) {
            ipv4list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt));
        }
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv6|'</span>)) {
            ipv6list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt, <span class="hljs-string">'32'</span>));
        }
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv4list);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv6list);
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>脚本中同样是先获取最新的数据，然后直接交给处理函数进行分批处理。这里我们假设处理的结果是给nginx使用的，所以我们直接在结构上增加<code>allow</code>和<code>deny</code>前缀，方便在nginx中直接使用。</p>
<h2 data-id="heading-10">三、配置nginx文件</h2>
<h3 data-id="heading-11">方法1：使用<code>allow</code>进行管理</h3>
<p>这种配置方式兼容新老版本的nginx，只需要在nginx中提前引入配置文件，每次更新配置文件内容之后重启nginx就能达到自动允许和拒绝来源国家的访问地址。</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com;

    # 引入允许的IP白名单
    include /etc/nginx/conf.d/china-ipv4.conf;
    include /etc/nginx/conf.d/china-ipv6.conf;

    # 可选：放行本地回环（避免自己被拦）
    allow 127.0.0.1;
    allow ::1;

    # 拒绝所有未匹配的请求
    deny all;

    location / {
        root /var/www/html;
        index index.html;
        # 你的其他配置...
    }
}
</code></pre>
<p>通过以上配置就可以达到只允许我们需要的访问，其他国家访问一律禁止。</p>
<h3 data-id="heading-12">方法2：使用geo模块</h3>
<p>Nginx 通过geo模块（默认编译）实现 IP 段的快速匹配，该模块将 IP 段加载到内存中，查询效率极高（不受 IP 段数量影响）。</p>
<pre><code class="hljs language-nginx" lang="nginx">http {
    # 定义IPv4的国家匹配变量（$is_cn_v4：1=中国IP，0=非中国IP）
    geo $is_cn_v4 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv4.conf;  # 引入中国IPv4段文件
    }

    # 定义IPv6的国家匹配变量（如需支持IPv6）
    geo $is_cn_v6 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv6.conf;  # 引入中国IPv6段文件
    }

    # 合并IPv4/IPv6的匹配结果
    map $scheme $is_cn {
        http $is_cn_v4;
        https $is_cn_v4;
        httpv6 $is_cn_v6;
        httpsv6 $is_cn_v6;
    }

    server {
      listen 80;
      listen [::]:80;
      server_name yourdomain.com;

      # 非中国IP返回403
      if ($is_cn != 1) {
          return 403;
      }

      # 正常业务配置...
      location / {
          root /var/www/html;
          index index.html;
      }
  }
}
</code></pre>
<p>通过使用nginx的geo模块可以非常快速的识别到ip对应的国家，然后在具体的路由中通过自动一判断来返回自己想要返回的内容。同样的，配置文件更新之后要重新启动nginx服务。</p>
<h3 data-id="heading-13">其他命令</h3>
<p>检查nginx配置文件是否正确。</p>
<pre><code class="hljs">nginx -t
</code></pre>
<p>重新启动nginx。</p>
<pre><code class="hljs">systemctl restart nginx
</code></pre>
<p>严重IP匹配的效果。</p>
<pre><code class="hljs language-bash" lang="bash">curl -H <span class="hljs-string">"X-Forwarded-For: 8.8.8.8"</span> http://yourdomain.com  <span class="hljs-comment"># 8.8.8.8为美国IP</span>
</code></pre>
<h2 data-id="heading-14">四、注意事项</h2>
<p>在具体的使用过程中还有一些是需要特别注意的：</p>
<ol>
<li>geo和allow的配置文件格式是不一样的。</li>
<li>如果使用云服务做转发，来源ip是云服务的地址，需要额外增加IP透传的功能。</li>
<li>远程地址的更新没那么快，可以设置每隔一周来定时更新一次。持续访问可能会被官方封禁哦。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP]]></title>    <link>https://juejin.cn/post/7576555431943503882</link>    <guid>https://juejin.cn/post/7576555431943503882</guid>    <pubDate>2025-11-26T03:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576555431943503882" data-draft-id="7496341294567800883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP"/> <meta itemprop="keywords" content="前端,Node.js,NestJS"/> <meta itemprop="datePublished" content="2025-11-26T03:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:04:24.000Z" title="Wed Nov 26 2025 03:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文保证绝对大白话！简单易懂!</p>
<p>最近跟一个好友讨论，他说想学习 <code>node.js</code> 后端框架 <code>nest.js</code>，但对于 <code>nest.js</code> 的下面用法一头雾水，为什么要这么用呢？什么 <code>Contoller</code>, <code>Provider</code>，怎么跟一般的 <code>javascript</code> 代码的用法完全不一样呢？如下的 <code>@Controller</code>,<code>@Injectable</code> 你理解是什么意思吗？为什么要用这样的方式组织代码呢？</p>
<pre><code class="hljs language-Javascript" lang="Javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cat</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./interfaces/cat.interface'</span>;


@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'cats'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsController</span> {
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-title function_">findAll</span>(): string {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action returns all cats'</span>;
  }
}

@<span class="hljs-title class_">Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsService</span> {
  private readonly <span class="hljs-attr">cats</span>: <span class="hljs-title class_">Cat</span>[] = [];

  <span class="hljs-title function_">create</span>(<span class="hljs-params">cat: Cat</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cats</span>.<span class="hljs-title function_">push</span>(cat);
  }

  <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Cat</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cats</span>;
  }
}

</code></pre>
<p>基于此，我写了这篇文章，帮助大家从 0 开始，层层递进到所有这些让你陌生的 <code>nest.js</code> 的概念！</p>
<h2 data-id="heading-1">从编程范式说起</h2>
<p>编程范式在之前面试经常被问到了，什么 <code>FP</code>(函数式编程)，<code>RP</code>(响应式编程)，<code>FRP</code>（函数式响应式编程），还有我们熟知的大兄弟 <code>面相对象编程</code>，现在 <code>nest.js</code> 又来个 <code>AOP</code>（面相切面编程），属实让人蒙圈了。。。。太多概念了。</p>
<p>别急，我们一个一个来！</p>
<h3 data-id="heading-2">函数式编程 - FP</h3>
<p>简单来说就是要求你使用纯函数，什么是纯函数，就是输入一定的时候输出一定，就是传入相同的参数得到相同的结果。就这么简单，例如</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    sum = a + b;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>常见有几种情况会影响纯函数的纯净，最常见就是：</p>
<ul>
<li>修改传参的值，或者引用，或者全局状态，改 DOM，例如</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) { 
     <span class="hljs-comment">// 假设 c 传入一个对象，c 的 xx 属性被修改</span>
     c.<span class="hljs-property">xx</span> = a + b; <span class="hljs-comment">// 修改传参的值</span>
     <span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span> = a; <span class="hljs-comment">// 修改全局变量</span>
    sum = a + b;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<ul>
<li>做一些 i/o 操作，例如 console.log, 写文件。好了接下里说说 <code>RP</code>(响应式编程)</li>
</ul>
<h3 data-id="heading-3">响应式编程 - RP</h3>
<p>也能很好理解，我们举个例子：</p>
<p>就像“Excel 表格”：<br/>
你改了 A1，B1 = A1 + 10 会自动更新，这就是典型的 RP。</p>
<p>在 vue 和 react 都非常常见，跟踪一个值变化，然后引发另一些值变化。</p>
<p>它强调：</p>
<ul>
<li>数据是“流”（stream）</li>
<li>数据变化会自动传播到依赖它的逻辑（自动更新）</li>
<li>你不需要手动触发</li>
</ul>
<h3 data-id="heading-4">函数式响应式编程 - FRP</h3>
<p>FRP 是“函数式编程 + 响应式编程”的结合。比较典型的就是 Rxjs 的风格：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听 DOM 的 input 事件</span>
<span class="hljs-keyword">const</span> input$ = <span class="hljs-title function_">fromEvent</span>(searchInput, <span class="hljs-string">'input'</span>); <span class="hljs-comment">// 输入是一个“流”</span>

<span class="hljs-keyword">const</span> results$ = input$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>),  <span class="hljs-comment">// 函数式转换</span>
);

results$.<span class="hljs-title function_">subscribe</span>(renderResults);
</code></pre>
<p>简单理解就是当触发 <code>DOM</code> 的 <code>input</code> 事件触发的时候，也就是一个值改变的时候，触发 results$ 值的改变，这就是 <code>RP</code>（响应式编程），然后在 <code>input</code> 事件触发值改变的过程中，还执行了 <code>map</code> 方法，这是一个纯函数，所以也算 <code>FP</code> 函数式编程。</p>
<h3 data-id="heading-5">OOP - 面向对象编程</h3>
<p>顾名思义，面相对象就是以对象为对象为单位，例如</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: string</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is barking!`</span>);
  }
}
</code></pre>
<p>使用到的数据，最好都封装为对象，如上面，使用的时候需要 <code>new Dog()</code> 返回我们新创造出来的实例，也就是 class 仅仅是个模板。对象是由模板创造出来的。</p>
<p>然后就是面向对象的特点，也就是最熟悉的三件套，封装，继承，多态。靠这三个，面向对象编程的思维模式认为可以模拟现实世界。</p>
<p>封装：很简单，例如 <code>Dog</code> 这个类，把跟 <code>Dog</code> 相关的属性和方法都放在一个类里就是封装，例如有 name 属性，狗的名字，你如果想加其它参数，继续拓展就行了，例如性别，品种。当然封装还有一些细节，例如封装私有属性什么的，这些细枝末节不用太在意。我们主要是简单介绍 OOP 的思想。</p>
<p>继承：可以将别的类的东西继承过来，例如, 很多动物都可以继承<code>Animal</code> 这个类：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">public name: string</span>) {}

  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Some sound..."</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> says meow~`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> says woof!`</span>);
  }
}

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">"Mimi"</span>);
<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">"Coco"</span>);

cat.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// Mimi says meow~</span>
dog.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// Coco says woof!</span>

</code></pre>
<p>主要是为我们抽象代码用的，例如公共部分放到一个类中，子类单独实现。思想是挺好的，就是实现起来有时候会比较麻烦，因为刚开始设计的时候，不太容易一开始就能预知未来需要抽象哪些。</p>
<p>多态：简单来说就是一个接口，不同实现，Javascript 中没有多态，更多在 typescript 中出现，例如用重载实现多态。如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: number, <span class="hljs-attr">b</span>: number): number;
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: string, <span class="hljs-attr">b</span>: string): string;
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: any, <span class="hljs-attr">b</span>: any): any {
    <span class="hljs-keyword">return</span> a + b;
  }
}

<span class="hljs-keyword">const</span> calc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>));       <span class="hljs-comment">// 15</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc.<span class="hljs-title function_">add</span>(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>)) <span class="hljs-comment">// foobar</span>
</code></pre>
<h2 data-id="heading-6">面相切面编程 - AOP</h2>
<p>为我们提供了一种将代码注入现有函数或对象的方法，而无需修改目标逻辑。这句话大家看看就行了，很官方，我们简单理解就是：</p>
<p>把横跨多个功能的“通用逻辑”抽出来，统一管理，而不是在每个函数里重复写。</p>
<p>常见实现的方式，就是在函数前后，注册一个钩子，这样达到不修改当前函数逻辑的目的。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logBefore</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Calling:"</span>, fn.<span class="hljs-property">name</span>, <span class="hljs-string">"args:"</span>, args);
    <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  }
}
</code></pre>
<p>以上方法是一个 <code>切面</code> ，也就是可以包装到另一个函数上，在这个函数调用之前打印日志，是一个独立的功能。例如：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">getUser</span> = logBefore(function getUser(id) {
  // 在数据库搜索数据返回
  return db.query(`SELECT * FROM users WHERE <span class="hljs-attr">id</span> = <span class="hljs-variable">${id}</span>`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这样其它函数都可以共享这个 <code>logBefore</code> 的逻辑。</p>
<p>当然实际场景，例如鉴权，在调用一个方法前，看看有没有权限，就是一个很好的使用 <code>AOP</code> 的场景。</p>
<h2 data-id="heading-7">AOP 跟 nest.js 关系</h2>
<p>nest.js 后面我们会讲一个很关键的概念，pipeline，我们这里先简单介绍一下，后面详细说。pipeline 就是当客户端收到请求到返回的过程。</p>
<p>首先 nest.js 需要注册一个 Controller 来处理请求,如下</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'cats'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsController</span> {
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-title function_">findAll</span>(): string {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action returns all cats'</span>;
  }
}
</code></pre>
<p>一般情况下，get 方法访问路径 <code>/cats</code> 的时候，返回 'This action returns all cats'。</p>
<p>但实际上到 <code>Controller</code> 处理数据之前，还有许多步骤。</p>
<p>例如在 nest.js 中有 <code>Middleware</code>（中间件） 的概念，也有 <code>Guard</code>(守卫的概念) 等等概念，我们这里不细说，后面文章会有，这里只需要记住：请求来了之后，先到 <code>Middleware</code> 然后到 <code>Guard</code>。。。兜兜转转好几回才能到 <code>Controller</code>。</p>
<p>之前我们提到，AOP 中的面向切面，一个 <code>切面</code> ，也就是可以包装到另一个函数上，在这个函数调用之前打印日志，是一个独立的功能。</p>
<p>nest.js 中的 <code>Middleware</code> 可以打印日志，是不是在不直接影响  <code>Controller</code> 逻辑的前提下，实现了一个可以复用的独立的功能，因为所有路由接收的请求都会经过  <code>Middleware</code>。</p>
<p>从这个意义上说 <code>Middleware</code>，<code>Guard</code> 这些概念本质就是 “切面”。</p>
<p>如果你对node.js ，组件库，前端动画感兴趣，欢迎进群交流。这是我组件库教程官网。感谢star，再次感谢：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank" title="https://www.frontlight.tech/" ref="nofollow noopener noreferrer">t-ui</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">github 点赞</a></li>
</ul>
<h2 data-id="heading-8">依赖注入和控制反转</h2>
<p>这两个概念看起来挺唬人的，比较高大上。我们简单解释一下：</p>
<p>我们从一个简单例子说起：</p>
<p>假设有一个类叫老王，专指那些住在美女隔壁的靓仔们。他们喜欢助人为乐，送大帽子。能力上擅长逃跑。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hobby</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gender</span>){
        <span class="hljs-keyword">return</span> [gender, <span class="hljs-string">'助人为乐'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'送帽子'</span>, <span class="hljs-string">'跑路'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-attr">hobby</span>: <span class="hljs-title class_">Hobby</span>
    <span class="hljs-attr">skill</span>: <span class="hljs-title class_">Skill</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hobby</span>(<span class="hljs-string">'女'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">skill</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Skill</span>();
    }
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>()); <span class="hljs-comment">// { hobby: ['女', '助人为乐'], skill: ['送帽子', '跑路'] }</span>
</code></pre>
<p>好了，这个Person类，我们看看有啥缺点：</p>
<ul>
<li>每次创建Person类的实例，都要传入Hobby类和Skill类，也就是对这两个类都产生了依赖，假如有一天我们想创建不同的老王，比如有的老王喜欢小鲜肉，有的老王喜欢老腊肉，这个Person类写死了，没法定制</li>
</ul>
<p>有同学马上就会说，这个简单啊，Hobby和Skill当做参数传入不就行了，是的，这个方法确实能解决问题，如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hobby</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gender</span>){
        <span class="hljs-keyword">return</span> [gender, <span class="hljs-string">'助人为乐'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'送帽子'</span>, <span class="hljs-string">'跑路'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-attr">hobby</span>: <span class="hljs-title class_">Hobby</span>
    <span class="hljs-attr">skill</span>: <span class="hljs-title class_">Skill</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">hobby, skill</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span> = hobby;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">skill</span> = skill;
    }
}

<span class="hljs-comment">// { hobby: [’男', '助人为乐'], skill: ['送帽子', '跑路'] }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hobby</span>(<span class="hljs-string">'男'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Skill</span>()); 
</code></pre>
<ul>
<li>但有没有更好的办法，也就是这个类我们不用自己去new，像下面这样，系统帮我们自动导入呢？</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">hobby: Hobby, skill: Skill</span>){
  
    }
    <span class="hljs-title function_">hello</span>(<span class="hljs-params"/>){
        这里直接就可以用<span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span>了
    }
}
</code></pre>
<p>也就是说，在你new Person的时候，hobby和skill参数，自动帮你实例化导入，而且你还需要new Person，能不能不new Person 都是自动调用并把参数导入？</p>
<ul>
<li>这就引申出第一个概念就控制反转，以前我们都要自己主动去new，从而创建实例，现在是把创建实例的任务交给了一个容器（后面会实现，你就明白了，相当于一个掌控者，或者说造物主，专门来创建实例的，并管理依赖关系），所以控制权是不是就反转了，你主动的创建实例和控制依赖，反转为容器创建实例和控制依赖。</li>
<li>对于控制反转，最常用件的方式叫依赖注入，意思是容器动态的将依赖关系注入到组件中。</li>
<li>控制反转可以通过依赖注入实现，所以本质上是一回事。</li>
</ul>
<p>到这里，其实大家也没觉得依赖注入有啥毛用吧！下面的讲解一言以蔽之就是，虽然我们js可以把函数或者类当参数传入另一个类里，这确实解决了之前讲的写死代码的问题，也就是说我们不用依赖注入也能解决代码耦合的问题，所以看起来我们并不是那么需要依赖注入。</p>
<h2 data-id="heading-9">小结</h2>
<p>这里第一篇 nest.js 内容完毕，接下来会详细解释上文提到的 pipline，也就是一个请求经过 <code>nest.js</code> 的全过程，以及这些经过的过程中，碰到的核心概念！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 接口与代码复用：替代继承的设计哲学]]></title>    <link>https://juejin.cn/post/7576609946190577700</link>    <guid>https://juejin.cn/post/7576609946190577700</guid>    <pubDate>2025-11-26T04:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190577700" data-draft-id="7576575703167254534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 接口与代码复用：替代继承的设计哲学"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-26T04:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 接口与代码复用：替代继承的设计哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:45:44.000Z" title="Wed Nov 26 2025 04:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Go 接口与代码复用：替代继承的设计哲学</h2>
<h3 data-id="heading-1">一、前言</h3>
<p>Go 是 Google 设计的类 C 静态类型语言，兼顾底层性能与开发效率。它并非传统意义上的面向对象（OOP）语言 —— 没有 class 关键字，也不支持传统的 “继承” 语法，但通过 <strong>接口的隐式实现</strong> 和 <strong>结构体组合（嵌入）</strong>，Go 能灵活实现 OOP 的核心特性（多态、代码复用），且设计更简洁、无继承带来的耦合问题。
与 C++ 相比，Go 的设计哲学是 “<strong>组合优于继承</strong>”：用接口实现多态，用结构体嵌入实现代码复用，既避免了继承的复杂语法，又解决了多重继承的歧义问题。本文将通过类比 C++ 的接口 / 继承逻辑，详解 Go 如何实现类似效果。</p>
<h3 data-id="heading-2">二、Go 中的 “单一复用”（类似单一继承）</h3>
<p>C++ 的单一继承核心是 “一个子类继承一个父类 / 接口”，Go 中通过两种方式实现类似效果：<strong>仅用接口实现多态</strong>（无代码复用，仅约束行为）、<strong>结构体组合（嵌入）+ 接口</strong>（既有代码复用，又有多态）。</p>
<h4 data-id="heading-3">2.1 仅通过接口实现（隐式多态）</h4>
<p>C++ 的接口是 “纯虚函数集合”，子类需显式声明继承并实现所有接口方法；而 Go 的接口是 “方法签名集合”，<strong>无需显式声明实现</strong>—— 只要结构体实现了接口的所有方法，就自动满足该接口，这就是 “隐式实现”，也是 Go 接口的核心特性。</p>
<h5 data-id="heading-4">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++ 需显式声明继承接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IFruit</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> : <span class="hljs-keyword">public</span> IFruit { <span class="hljs-comment">// 显式继承</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function">std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"apple"</span>; }
};
</code></pre>
<h5 data-id="heading-5">Go 实现代码</h5>
<p>首先定义接口（仅约束行为，无实现）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义 Fruit 接口：仅声明方法签名，无实现</span>
<span class="hljs-keyword">type</span> FruitType <span class="hljs-type">string</span> <span class="hljs-comment">// 补充类型定义，使代码可运行</span>
<span class="hljs-keyword">const</span> (
    BananaType FruitType = <span class="hljs-string">"banana"</span>
    AppleType  FruitType = <span class="hljs-string">"apple"</span>
)

<span class="hljs-keyword">type</span> Fruit <span class="hljs-keyword">interface</span> {
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    GetType() FruitType <span class="hljs-comment">// 明确类型，避免歧义</span>
}
</code></pre>
<p>定义 Banana 结构体，隐式实现 Fruit 接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Banana <span class="hljs-keyword">struct</span> {
    name   <span class="hljs-type">string</span>
    energy <span class="hljs-type">float32</span> <span class="hljs-comment">// 自定义字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Banana 实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBanana</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Banana {
    <span class="hljs-keyword">return</span> &amp;Banana{
        name:   name,
        energy: <span class="hljs-number">0</span>,
    }
}

<span class="hljs-comment">// 实现 Fruit 接口的所有方法（隐式满足 Fruit 接口）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetType() FruitType {
    <span class="hljs-keyword">return</span> BananaType
}

<span class="hljs-comment">// Banana 自定义方法（接口未约束，仅自身可用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetEnergy(energy <span class="hljs-type">float32</span>) {
    b.energy = energy
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetEnergy() <span class="hljs-type">float32</span> {
    <span class="hljs-keyword">return</span> b.energy
}
</code></pre>
<h5 data-id="heading-6">接口的两种使用方式（体现多态）</h5>
<h6 data-id="heading-7">1. 赋值给接口变量：通过接口统一调用，屏蔽具体实现</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> fruit Fruit <span class="hljs-comment">// 接口变量</span>
fruit = NewBanana(<span class="hljs-string">"big banana"</span>) <span class="hljs-comment">// 隐式转换，无需显式声明</span>
fmt.Println(fruit.GetName()) <span class="hljs-comment">// 输出：big banana（调用 Banana 的实现）</span>
fmt.Println(fruit.GetType()) <span class="hljs-comment">// 输出：banana</span>
</code></pre>
<h6 data-id="heading-8">2. 直接使用结构体实例：可调用接口方法 + 自定义方法</h6>
<pre><code class="hljs language-go" lang="go">banana := NewBanana(<span class="hljs-string">"little banana"</span>)
banana.SetEnergy(<span class="hljs-number">100</span>) <span class="hljs-comment">// 调用自定义方法</span>
fmt.Println(banana.GetEnergy()) <span class="hljs-comment">// 输出：100</span>
fmt.Println(banana.GetName()) <span class="hljs-comment">// 输出：little banana（调用接口方法）</span>
</code></pre>
<h6 data-id="heading-9">3. 工厂方法统一创建实例（增强多态灵活性）</h6>
<p>补充 NewFruit 实现，根据类型创建不同 Fruit 实例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFruit</span><span class="hljs-params">(fruitType FruitType, name <span class="hljs-type">string</span>)</span></span> Fruit {
    <span class="hljs-keyword">switch</span> fruitType {
    <span class="hljs-keyword">case</span> BananaType:
        <span class="hljs-keyword">return</span> NewBanana(name)
    <span class="hljs-keyword">case</span> AppleType:
        <span class="hljs-keyword">return</span> NewApple(name) <span class="hljs-comment">// 需实现 Apple 结构体（类似 Banana）</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-comment">// 使用工厂方法</span>
apple := NewFruit(AppleType, <span class="hljs-string">"red apple"</span>)
banana := NewFruit(BananaType, <span class="hljs-string">"yellow banana"</span>)
fmt.Println(apple.GetName(), banana.GetName()) <span class="hljs-comment">// 统一调用接口方法`</span>
</code></pre>
<h4 data-id="heading-10">2.2 结构体组合（嵌入）实现代码复用（类似基类继承）</h4>
<p>C++ 中通过 “子类继承基类” 复用基类代码，Go 中通过 “结构体嵌入”（将一个结构体作为另一个结构体的匿名字段）实现代码复用 —— 嵌入的结构体（称为 “嵌入类型”）的方法和字段，会被外层结构体 “继承”（实际是隐式代理），外层结构体可直接调用，也可覆盖这些方法。</p>
<h5 data-id="heading-11">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 基类（含部分实现）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleBase</span> : <span class="hljs-keyword">public</span> IVehicle {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetWheelCount</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> <span class="hljs-keyword">override</span> </span>{ wheelCount = count; }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetWheelCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> wheelCount; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>; }
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> wheelCount;
};

<span class="hljs-comment">// 子类继承基类，复用方法并可覆盖</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bus</span> : <span class="hljs-keyword">public</span> VehicleBase {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string n)</span> <span class="hljs-keyword">override</span> </span>{ name = n; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> VehicleBase::<span class="hljs-built_in">ToString</span>() + <span class="hljs-string">"Bus -&gt; "</span> + name; <span class="hljs-comment">// 调用基类方法</span>
    }
<span class="hljs-keyword">private</span>:
    std::string name;
};
</code></pre>
<h5 data-id="heading-12">Go 实现代码</h5>
<h6 data-id="heading-13">1. 定义接口（约束核心行为）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> VehicleType <span class="hljs-type">string</span>
<span class="hljs-keyword">const</span> (
    BusType VehicleType = <span class="hljs-string">"bus"</span>
)

<span class="hljs-keyword">type</span> Vehicle <span class="hljs-keyword">interface</span> {
    GetType() VehicleType
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    SetWheelCount(count <span class="hljs-type">int</span>)
    GetWheelCount() <span class="hljs-type">int</span>
    ToString() <span class="hljs-type">string</span>
}
</code></pre>
<h6 data-id="heading-14">2. 定义 “嵌入结构体”（类似基类，提供通用实现）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// vehicleImpl 是通用实现，作为嵌入类型供其他结构体复用</span>
<span class="hljs-keyword">type</span> vehicleImpl <span class="hljs-keyword">struct</span> {
    wheelCount <span class="hljs-type">int</span> <span class="hljs-comment">// 通用字段</span>
}

<span class="hljs-comment">// 通用方法实现（供嵌入者复用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> SetWheelCount(count <span class="hljs-type">int</span>) {
    v.wheelCount = count
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> GetWheelCount() <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> v.wheelCount
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>
}
</code></pre>
<h6 data-id="heading-15">3. 定义外层结构体（嵌入 vehicleImpl，复用代码）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Bus 结构体通过嵌入 vehicleImpl，复用其方法和字段</span>
<span class="hljs-keyword">type</span> Bus <span class="hljs-keyword">struct</span> {
    vehicleImpl <span class="hljs-comment">// 匿名嵌入（组合），无需显式调用</span>
    name        <span class="hljs-type">string</span> <span class="hljs-comment">// 自身字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Bus 实例（需初始化嵌入结构体）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBus</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Bus {
    <span class="hljs-keyword">return</span> &amp;Bus{
        name: name,
        vehicleImpl: vehicleImpl{ <span class="hljs-comment">// 初始化嵌入结构体</span>
            wheelCount: <span class="hljs-number">4</span>, <span class="hljs-comment">// 公交车默认4个轮子</span>
        },
    }
}

<span class="hljs-comment">// 实现 Vehicle 接口的剩余方法（未被 vehicleImpl 实现的部分）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetType() VehicleType {
    <span class="hljs-keyword">return</span> BusType
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-comment">// 覆盖嵌入结构体的 ToString 方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 调用嵌入结构体的被覆盖方法：b.vehicleImpl.ToString()</span>
    <span class="hljs-keyword">return</span> b.vehicleImpl.ToString() + fmt.Sprintf(<span class="hljs-string">"Bus -&gt; %s (wheels: %d)"</span>, b.GetName(), b.GetWheelCount())
}
</code></pre>
<h6 data-id="heading-16">核心特性说明</h6>
<ul>
<li>代码复用：<code>Bus</code> 无需重新实现 <code>SetWheelCount</code>、<code>GetWheelCount</code>，直接复用 <code>vehicleImpl</code> 的方法；</li>
<li>方法覆盖：<code>Bus</code> 定义了与 <code>vehicleImpl</code> 同名的 <code>ToString</code> 方法，会覆盖嵌入结构体的方法，优先调用外层方法；</li>
<li>显式调用嵌入方法：通过 <code>b.vehicleImpl.ToString()</code> 可调用被覆盖的嵌入结构体方法；</li>
<li>字段访问：嵌入结构体的字段可直接访问（<code>b.wheelCount</code>），也可显式访问（<code>b.vehicleImpl.wheelCount</code>）。</li>
</ul>
<h3 data-id="heading-17">三、Go 中的 “多组合”（类似多重继承）</h3>
<p>C++ 支持多重继承（一个类继承多个父类），但容易引发 “菱形继承”（多个父类继承自同一基类）的歧义问题。Go 本身<strong>不支持传统多重继承</strong>，但通过 “多嵌入”（一个结构体嵌入多个结构体），可实现类似 “多重继承” 的效果 —— 复用多个嵌入结构体的方法和字段，且无歧义。</p>
<h4 data-id="heading-18">类比 C++ 伪代码</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mother</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-comment">// 多重继承：同时继承 Father 和 Mother</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> : <span class="hljs-keyword">public</span> Father, <span class="hljs-keyword">public</span> Mother {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 显式调用父类方法，避免歧义</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>() + <span class="hljs-string">", Father: "</span> + Father::<span class="hljs-built_in">Say</span>() + <span class="hljs-string">", Mother: "</span> + Mother::<span class="hljs-built_in">Say</span>();
    }
};
</code></pre>
<h4 data-id="heading-19">Go 实现代码（多嵌入结构体）</h4>
<h5 data-id="heading-20">1. 定义两个 “被组合” 的结构体（类似父类）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Father 结构体（提供一组方法）</span>
<span class="hljs-keyword">type</span> Father <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFather</span><span class="hljs-params">()</span></span> *Father {
    <span class="hljs-keyword">return</span> &amp;Father{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + f.GetName()
}

<span class="hljs-comment">// Mother 结构体（提供另一组方法）</span>
<span class="hljs-keyword">type</span> Mother <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMother</span><span class="hljs-params">()</span></span> *Mother {
    <span class="hljs-keyword">return</span> &amp;Mother{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + m.GetName()
}
</code></pre>
<h5 data-id="heading-21">2. 定义 Child 结构体（嵌入 Father 和 Mother）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Child 嵌入两个结构体，复用其方法</span>
<span class="hljs-keyword">type</span> Child <span class="hljs-keyword">struct</span> {
    *Mother <span class="hljs-comment">// 指针嵌入（需初始化指针）</span>
    *Father <span class="hljs-comment">// 指针嵌入</span>
}

<span class="hljs-comment">// 构造函数：初始化 Child 及嵌入的结构体指针</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewChild</span><span class="hljs-params">()</span></span> *Child {
    <span class="hljs-keyword">return</span> &amp;Child{
        Mother: NewMother(), <span class="hljs-comment">// 初始化 Mother 指针</span>
        Father: NewFather(), <span class="hljs-comment">// 初始化 Father 指针</span>
    }
}

<span class="hljs-comment">// 覆盖嵌入结构体的同名方法（避免调用歧义）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>
}

<span class="hljs-comment">// 自定义方法，显式调用嵌入结构体的方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 显式指定嵌入结构体，调用其方法（无歧义）</span>
    fatherSay := c.Father.Say()
    motherSay := c.Mother.Say()
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"I am %s. Father: %s, Mother: %s"</span>, c.GetName(), fatherSay, motherSay)
}
</code></pre>
<h5 data-id="heading-22">3. 使用示例：</h5>
<pre><code class="hljs language-go" lang="go">child := NewChild()
fmt.Println(child.Say())
<span class="hljs-comment">// 输出：I am Jerry. Father: I am Tony, Mother: I am Aurora</span>
</code></pre>
<h5 data-id="heading-23">核心规则（避免歧义）</h5>
<ul>
<li><strong>嵌入方式</strong>：支持值嵌入（<code>Father</code>）和指针嵌入（<code>*Mother</code>），指针嵌入需在构造时初始化指针；</li>
<li><strong>同名方法处理</strong>：若多个嵌入结构体有同名方法，外层结构体必须定义同名方法覆盖（否则调用时会编译报错，提示歧义）；</li>
<li><strong>显式调用嵌入方法</strong>：通过 <code>c.Father.Say()</code> 显式指定嵌入结构体，避免歧义，这是 Go 处理 “多组合” 冲突的核心方式。</li>
</ul>
<h3 data-id="heading-24">四、Go 与 C++ 核心区别总结</h3>



































<table><thead><tr><th>特性</th><th>C++</th><th>Go</th></tr></thead><tbody><tr><td>接口实现</td><td>显式继承（<code>public</code> 接口）</td><td>隐式实现（无需声明，实现方法即满足）</td></tr><tr><td>代码复用</td><td>继承基类</td><td>结构体嵌入（组合）</td></tr><tr><td>多重继承</td><td>支持（易引发菱形继承歧义）</td><td>不支持，通过多嵌入实现多组合（无歧义）</td></tr><tr><td>方法覆盖</td><td>需 <code>override</code> 关键字</td><td>同名方法自动覆盖（外层优先）</td></tr><tr><td>核心设计哲学</td><td>继承优先</td><td>组合优于继承</td></tr></tbody></table>
<h3 data-id="heading-25">五、完整代码仓库</h3>
<p>本文所有可运行代码已整理至 GitHub，包含接口、组合、多组合的完整示例，可直接克隆运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-inheritance-example" target="_blank" title="https://github.com/tx7do/go-inheritance-example" ref="nofollow noopener noreferrer">github.com/tx7do/go-in…</a></p>
<h3 data-id="heading-26">六、总结</h3>
<p>Go 没有传统 OOP 的 “类” 和 “继承”，但通过 <strong>接口的隐式多态</strong> 和 <strong>结构体的组合（嵌入）</strong>，实现了更灵活、低耦合的代码复用和多态特性：</p>
<ol>
<li>接口负责 “约束行为”，隐式实现让代码更简洁，支持多态；</li>
<li>结构体嵌入负责 “复用代码”，替代传统继承，无耦合问题；</li>
<li>多嵌入实现类似 “多重继承” 的效果，但通过显式调用避免歧义。</li>
</ol>
<p>这种设计既保留了 OOP 的核心优势，又规避了继承带来的复杂问题，是 Go 简洁、高效的关键原因之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都React 19了,他到底带来了什么?]]></title>    <link>https://juejin.cn/post/7576559408660234292</link>    <guid>https://juejin.cn/post/7576559408660234292</guid>    <pubDate>2025-11-26T06:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576559408660234292" data-draft-id="7576559408660152372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都React 19了,他到底带来了什么?"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周尛先森"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402377933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都React 19了,他到底带来了什么?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402377933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周尛先森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:50:42.000Z" title="Wed Nov 26 2025 06:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c865216d9814d28a29831d6cbc2def2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1920&amp;h=1080&amp;s=225936&amp;e=webp&amp;b=020e37" alt="src=http___pic1.win4000.com_wallpaper_2020-07-22_5f17fe7fe9959.jpg&amp;refer=http___pic1.win4000 (1).webp" loading="lazy"/></p>
<p>如果你还在 React 应用的 <code>useEffect</code>里写 <code>fetch</code>请求，那你就做错了。我们每天都听到这种说法。但我们应该怎么做才对呢？好吧，事实证明，React 团队已经清楚地听到了我们的声音。React 19.2 不仅仅是修补异步问题——它通过 <code>use()</code>、<code>&lt;Suspense&gt;</code>、<code>useTransition()</code>以及现在的 View Transitions，从头重建了异步处理机制。这些基础构建块共同将异步逻辑从一个"必要的麻烦"转变为一流的架构特性。让我带你了解 React 的异步叙事是如何彻底改变的，以及它为什么对你的团队很重要。</p>
<p><strong>旧方式：useEffect + isLoading</strong></p>
<p>让我们从一个展示旧的 <code>useEffect</code>/ <code>fetch</code>组合模式的例子开始：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageData, setImageData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isPending, setIsPending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">fetchImage</span>(imageId).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">setImageData</span>(data);
      <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">false</span>);
    });
  }, [imageId]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setImageId((id) =&gt; id + 1)}&gt;Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {isPending ? <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> : }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>（这里的 <code>fetchImage</code>只是 <code>fetch</code>的一个包装函数，以保持示例简短。）</p>
<p>这个模式确实能用，但你做了很多重复性的工作。例如，你管理了三个状态（<code>imageId</code>, <code>imageData</code>, <code>isPending</code>），而实际上你只是想显示一张图片。加载状态逻辑是手动的，错误处理也常常是事后才考虑。而且很可能，你的代码库中每个异步操作看起来都略有不同。</p>
<p>最糟糕的是，那个 <code>useEffect</code>的依赖数组是个隐患。漏掉一个依赖项，你会得到过时的闭包；包含太多依赖项，又会触发无限循环。这是无数生产环境 bug 的根源。</p>
<p>这并不理想，老实说，用这种代码你能做到的最好程度就是"不搞砸"。而这并不是你想要编写的代码类型。</p>
<p><strong>新的异步基础构建块</strong></p>
<p>React 19.2 给我们提供了一种完全不同的方法。我们不再用 <code>useEffect</code>来管理 Promise，而是直接使用 <code>use()</code>和 <code>&lt;Suspense&gt;</code>来处理 Promise。</p>
<p><strong>核心模式：use() + <code>&lt;Suspense&gt;</code></strong></p>
<p>下面是使用 React 新的 <code>use</code>Hook 和 <code>Suspense</code>组件组合重写的同一个组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{image.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看看这有多简洁。没有 <code>useEffect</code>。没有手动的 <code>isPending</code>状态。父组件中没有条件渲染逻辑。我们存储的是一个 Promise 而不是数据，React 会处理剩下的事情。</p>
<p><strong>但这是如何工作的呢？<code>&lt;Suspense&gt;</code>背后的魔法</strong></p>
<p>当 <code>&lt;Suspense&gt;</code>尝试渲染其子组件时，<code>&lt;Image&gt;</code>组件会调用 <code>use(imageDataPromise)</code>。如果那个 Promise 还没有解决，<code>use()</code>会直接<em>抛出</em>这个 Promise。是的——像抛出异常一样抛出它。</p>
<p>我知道你在想什么："用异常来控制流程？这太奇怪了！"但请听我说，因为这其实非常巧妙。</p>
<p>那个被抛出的 Promise 会向上冒泡穿过组件树，直到被 <code>&lt;Suspense&gt;</code>捕获。<code>&lt;Suspense&gt;</code>于是知道："啊，我的子组件需要从这个 Promise 获取数据。我会显示我的加载状态（fallback），并等待这个 Promise 解决。"</p>
<p>当 Promise 解决后，<code>&lt;Suspense&gt;</code>会重新渲染其子组件，<code>use()</code>返回数据，图片就显示出来了。</p>
<p>这消除了在组件树的每个层级进行条件渲染的需要。加载状态变得声明式，因为你可以用 <code>&lt;Suspense&gt;</code>包装异步组件，并定义在加载时显示什么。React 会处理时机。</p>
<p><strong>更流畅的交互：useTransition() + action</strong></p>
<p>但我们可以让它变得更好。目前，当你点击 "Next Image" 时，按钮在新图片加载期间仍然可点击。这不是很好的用户体验；用户可能会多次点击，造成竞态条件。React 19.2 引入了 action props 和 <code>useTransition()</code>来优雅地处理这种情况：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>名为 <code>action</code>的 prop 本身并没有什么特别之处。它只是一个约定，告诉其他开发者这个按钮会将处理器包装在一个过渡（transition）中。</p>
<p><strong>View Transitions：GPU 加速的润色</strong></p>
<p>既然我们谈到了异步的 UI 部分，让我们聊聊 View Transitions。React 19.2（在实验性分支上）添加了对浏览器原生 View Transitions API 的支持。这让你在异步内容加载时能获得如黄油般顺滑的、GPU 加速的动画。而且只需要几行代码。</p>
<p>首先，添加一些 CSS 动画：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> fadeIn {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
}
<span class="hljs-keyword">@keyframes</span> fadeOut {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}
<span class="hljs-keyword">@keyframes</span> pulse {
  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
}

::<span class="hljs-built_in">view-transition-old</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeOut <span class="hljs-number">0.3s</span> ease-out;
}
::<span class="hljs-built_in">view-transition-new</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.3s</span> ease-in;
}
::<span class="hljs-built_in">view-transition-old</span>(button-pulse) {
  <span class="hljs-attribute">animation</span>: pulse <span class="hljs-number">0.3s</span> ease-in-out;
}
</code></pre>
<p>然后将 View Transitions 添加到你的组件中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { experimental_useViewTransition <span class="hljs-keyword">as</span> useViewTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> ;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageSkeleton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"image-skeleton"</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children, disabled }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  <span class="hljs-keyword">const</span> viewTransition = <span class="hljs-title function_">useViewTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...viewTransition</span>("<span class="hljs-attr">button-pulse</span>")}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...useViewTransition</span>("<span class="hljs-attr">image-container</span>")}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>就这样。浏览器会自动处理 GPU 加速的过渡动画。你的骨架屏淡出，你的图片淡入，你的按钮在加载时会脉动。效果非常丝滑，而你几乎没写什么代码。</p>
<p><strong>注意：</strong> ​ 你需要 React 19.2 实验版才能使用此功能：<code>npm install react@experimental react-dom@experimental</code></p>
<p><strong>这对前端团队为何重要</strong></p>
<p>这些改变不仅仅是清理 <code>useEffect</code>/ <code>fetch</code>的烂摊子。它关乎构建一个更优秀的 React，这个 React 终于承认异步是一等公民。</p>
<p>这些模式意味着你的团队编写的代码更容易理解和维护。框架处理了更多事情。UI 响应更迅捷，因为它是按需更新的。你正在利用更多底层框架的能力，为你的应用赋予具有流畅动画的现代感。</p>
<p>这不再是"你爷爷辈的 React"了，是时候让团队开始使用这些新工具了。</p>
<p><strong>关键要点</strong></p>
<ul>
<li>
<p>React 19.2 带来了"无处不在的异步"。</p>
</li>
<li>
<p>这些基础构建块作为一个系统协同工作：</p>
<ul>
<li><code>use()</code>从 Promise 中提取数据</li>
<li><code>&lt;Suspense&gt;</code>声明式地处理加载状态</li>
<li><code>useTransition()</code>免费为你提供加载标志</li>
<li>View Transitions 添加 GPU 加速的润色</li>
</ul>
</li>
<li>
<p>旧方式（<code>useEffect</code>和 <code>fetch</code>）对 React 来说是个严重的痛点，但我们有了很好的替代方案。</p>
</li>
<li>
<p>React 的异步基础构建块意味着更少的代码、更少的 bug 和更好的用户体验。</p>
</li>
<li>
<p>你的团队可以更专注于构建体验，而不是支撑它的底层管道。</p>
</li>
</ul>
<p><strong>非 19.2 的选择：TanStack Query</strong></p>
<p>话虽如此，如果你还没准备好升级到 React 19.2，有一个很好的替代方案：TanStack Query（前身为 React Query）。它适用于任何 React 版本，并为你提供自动缓存、后台重新获取、乐观更新等功能。它是一个久经考验的解决方案，解决了与 React 19.2 异步基础构建块相同的问题，只是 API 不同。有充分的理由说明为什么这么多 React 应用都安装了 <code>react-query</code>。</p>
<p><strong>下一步：React 19.2 引领的前端未来</strong></p>
<p>React 19.2 已经发布。它是稳定的。你应该将其用于生产环境（除了仍在完善中的 View Transitions）。</p>
<p>异步变革已经到来。React 终于解决了它最大的痛点，框架也因此变得更好。</p>
<p>如果你还没有探索过 React 19.2，现在是时候了。在一个副项目上试试 <code>use()</code>和 <code>&lt;Suspense&gt;</code>，看看异步逻辑变得多么简单。你会惊讶于自己以前没有它是怎么过的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端三大权限场景全解析：设计、实现、存储与企业级实践]]></title>    <link>https://juejin.cn/post/7576821684251918379</link>    <guid>https://juejin.cn/post/7576821684251918379</guid>    <pubDate>2025-11-26T09:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684251918379" data-draft-id="7576575703166402566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端三大权限场景全解析：设计、实现、存储与企业级实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-26T09:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端三大权限场景全解析：设计、实现、存储与企业级实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:13:00.000Z" title="Wed Nov 26 2025 09:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    38
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><p>权限控制是前端应用（尤其是中大型系统）的核心安全与体验保障，完整的权限体系需覆盖「路由权限、页面元素权限、接口权限」三大场景。本文结合真实项目落地经验，系统梳理各场景的应用逻辑、实现方案、设计模式与存储安全，补充企业级开发的关键细节与避坑要点。</p>
<h2 data-id="heading-0">一、路由权限：页面访问的 “第一道门槛”</h2>
<h3 data-id="heading-1">1. 核心应用场景</h3>
<ul>
<li><strong>角色差异化访问</strong>：企业后台中，管理员可访问用户管理、系统配置页，运营仅能访问订单管理、商品管理页。</li>
<li><strong>SaaS 多租户定制</strong>：不同租户（客户）开通不同功能模块（如 A 租户有报表分析模块，B 租户无），后端根据租户 ID 返回对应路由。</li>
<li><strong>权限动态变更</strong>：管理员在后台修改用户角色后，前端无需重启应用，实时更新可访问页面。</li>
<li><strong>刷新丢失修复</strong>：单页应用（SPA）刷新后，动态添加的路由会丢失，需重新加载路由配置。</li>
<li><strong>路由懒加载适配</strong>：大型应用中，路由组件体积大，需结合权限预校验实现按需加载，避免无效资源请求。</li>
</ul>
<h3 data-id="heading-2">2. 企业级实现方式</h3>
<h4 data-id="heading-3">（1）混合式路由配置（前端预设 + 后端过滤）</h4>
<p>纯后端返回路由灵活性差，纯前端预设路由难以应对权限变更，实际项目常用混合方案：</p>
<ul>
<li>前端预设「基础路由」（登录页、404 页、首页）和「权限路由模板」（含 meta.permission 标识页面所需权限）。</li>
<li>登录后，后端返回用户「权限标识列表」，前端过滤出可访问的权限路由，动态添加到路由实例。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端预设路由模板</span>
<span class="hljs-keyword">const</span> asyncRoutes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user-manage'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserManage'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/UserManage.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'user:manage'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'用户管理'</span> } <span class="hljs-comment">// 页面所需权限标识</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/system-config'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'SystemConfig'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/SystemConfig.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'system:config'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'系统配置'</span> }
  }
];

<span class="hljs-comment">// 生成可访问路由（核心逻辑）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">generateAccessibleRoutes</span> = (<span class="hljs-params">permissions</span>) =&gt; {
  <span class="hljs-keyword">return</span> asyncRoutes.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
    <span class="hljs-comment">// 无权限标识的路由默认可访问，有权限标识需匹配用户权限</span>
    <span class="hljs-keyword">return</span> !route.<span class="hljs-property">meta</span>?.<span class="hljs-property">permission</span> || permissions.<span class="hljs-title function_">includes</span>(route.<span class="hljs-property">meta</span>.<span class="hljs-property">permission</span>);
  });
};
</code></pre>
<h4 data-id="heading-4">（2）路由守卫的 “责任链校验”</h4>
<p>将登录校验、权限校验、刷新修复等逻辑拆分为独立守卫，按顺序执行，降低耦合：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">router.beforeEach(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
  <span class="hljs-keyword">const</span> token = localStorage.getItem(<span class="hljs-comment">'token');</span>
  <span class="hljs-keyword">const</span> userPermissions = store.getters.userPermissions;

  // <span class="hljs-number">1</span>. 未登录拦截（责任链第一环）
  <span class="hljs-keyword">if</span> (!token &amp;&amp; <span class="hljs-keyword">to</span>.path !== <span class="hljs-comment">'/login') {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/login?redirect=' + to.fullPath); // 记录跳转目标，登录后回跳</span>
  }

  // <span class="hljs-number">2</span>. 已登录但无权限访问（责任链第二环）
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">to</span>.meta.permission &amp;&amp; !userPermissions.includes(<span class="hljs-keyword">to</span>.meta.permission)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/403'); // 跳转到自定义无权限页，提升体验</span>
  }

  // <span class="hljs-number">3</span>. 刷新后动态路由丢失修复（责任链第三环）
  <span class="hljs-keyword">if</span> (store.getters.accessRoutes.length === <span class="hljs-number">0</span> &amp;&amp; token) {
    <span class="hljs-keyword">const</span> accessibleRoutes = generateAccessibleRoutes(userPermissions);
    store.dispatch(<span class="hljs-comment">'setAccessRoutes', accessibleRoutes);</span>
    accessibleRoutes.forEach(route =&gt; router.addRoute(route));
    // 重新触发路由跳转，避免空白页
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>({ ...<span class="hljs-keyword">to</span>, replace: <span class="hljs-literal">true</span> });
  }

  <span class="hljs-keyword">next</span>();
});
</code></pre>
<h4 data-id="heading-5">（3）路由独享守卫增强</h4>
<p>针对敏感页面（如财务对账、用户权限配置），添加二次校验：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> routes = [
  {
    path: <span class="hljs-comment">'/financial-reconciliation',</span>
    component: FinancialReconciliation,
    meta: { permission: <span class="hljs-comment">'financial:view' },</span>
    beforeEnter: (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
      // 额外校验：仅工作时间可访问
      <span class="hljs-keyword">const</span> hour = <span class="hljs-built_in">new</span> <span class="hljs-type">Date</span>().getHours();
      <span class="hljs-keyword">if</span> (hour &lt; <span class="hljs-number">9</span> || hour &gt; <span class="hljs-number">18</span>) {
        ElMessage.warning(<span class="hljs-comment">'仅工作时间（9:00-18:00）可访问');</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-keyword">from</span>.path);
      }
      <span class="hljs-keyword">next</span>();
    }
  }
];
</code></pre>
<h3 data-id="heading-6">3. 设计模式</h3>
<ul>
<li><strong>责任链模式</strong>：路由守卫按 “登录校验→权限校验→刷新修复” 的顺序执行，每个守卫负责单一职责，可灵活增删调整。</li>
<li><strong>策略模式</strong>：根据用户角色（如 admin、editor）应用不同的路由过滤策略，例如管理员保留所有权限路由，运营仅保留业务相关路由。</li>
<li><strong>观察者模式</strong>：权限变更时（如管理员修改用户权限），触发路由重新加载事件，更新可访问路由列表。</li>
</ul>
<h3 data-id="heading-7">4. 权限存储与安全性</h3>
<h4 data-id="heading-8">（1）存储方案</h4>
<ul>
<li>路由配置：存储在 Vuex/Pinia（内存），刷新后重新请求后端获取，避免 localStorage 存储敏感路由规则（如接口地址、权限标识）。</li>
<li>用户权限标识：采用 “localStorage（持久化）+ Vuex/Pinia（内存访问）” 双存储，localStorage 确保刷新后不丢失，Vuex/Pinia 提升访问效率。</li>
<li>Token：存储在 localStorage 或 sessionStorage，建议设置过期时间（如 2 小时），降低泄露风险。</li>
</ul>
<h4 data-id="heading-9">（2）安全性保障</h4>
<ul>
<li>权限标识加密：对 localStorage 中的权限标识做简单加密（如 Base64），避免明文泄露（虽不能防破解，但能提升基础安全）。</li>
<li>防 URL 绕过：即使前端隐藏路由，用户直接输入 URL 访问时，后端需对 “页面初始化接口” 做权限校验（如访问<code>/system-config</code>时，后端校验<code>system:config</code>权限）。</li>
<li>敏感路由隐藏：无权限的路由不添加到路由实例，同时在菜单渲染时过滤，避免用户感知未授权功能。</li>
</ul>
<h2 data-id="heading-10">二、页面元素权限：细粒度的 “功能可见性控制”</h2>
<h3 data-id="heading-11">1. 核心应用场景</h3>
<ul>
<li><strong>操作权限差异化</strong>：同一页面中，管理员可看到 “删除用户”“批量导出” 按钮，普通用户仅能看到 “查看详情” 按钮。</li>
<li><strong>数据列权限</strong>：表格中，管理员可查看 “手机号”“身份证号” 列，运营仅能查看 “用户名”“订单号” 列。</li>
<li><strong>复杂权限组合</strong>：按钮显示需满足 “角色为 editor + 拥有 order:edit 权限 + 数据归属本部门” 等多条件组合。</li>
<li><strong>灰度功能发布</strong>：新功能上线时，仅对部分用户（如内部测试账号）显示入口，逐步全量开放。</li>
<li><strong>权限动态更新</strong>：管理员修改用户权限后，页面元素实时刷新（如立即隐藏 “删除” 按钮）。</li>
</ul>
<h3 data-id="heading-12">2. 企业级实现方式</h3>
<h4 data-id="heading-13">（1）权限中心封装（解决碎片化问题）</h4>
<p>构建全局权限中心，统一管理权限校验逻辑，避免散落在各组件中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/utils/permissionCenter.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionCenter</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.permissions = []; <span class="hljs-comment">// 权限码列表（如["user:add", "order:edit"]）</span>
    <span class="hljs-keyword">this</span>.roles = []; <span class="hljs-comment">// 角色列表（如["admin", "editor"]）</span>
    <span class="hljs-keyword">this</span>.customRules = new Map(); <span class="hljs-comment">// 自定义权限规则（应对复杂场景）</span>
    <span class="hljs-keyword">this</span>.cache = new Map(); <span class="hljs-comment">// 校验结果缓存，提升性能</span>
  }

  <span class="hljs-comment">// 初始化权限数据</span>
  <span class="hljs-keyword">init</span>(permissions, roles) {
    <span class="hljs-keyword">this</span>.permissions = permissions;
    <span class="hljs-keyword">this</span>.roles = roles;
    <span class="hljs-keyword">this</span>.cache.clear(); <span class="hljs-comment">// 初始化时清空缓存</span>
  }

  <span class="hljs-comment">// 基础权限校验（权限码匹配）</span>
  hasPermission(code) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(code)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">get</span>(code);
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">this</span>.permissions.includes(code);
    <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">set</span>(code, result); <span class="hljs-comment">// 缓存校验结果</span>
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 角色校验</span>
  hasRole(role) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.roles.includes(role);
  }

  <span class="hljs-comment">// 复杂规则校验（支持多条件组合）</span>
  checkCustomRule(ruleName, ...args) {
    <span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">get</span>(ruleName);
    <span class="hljs-keyword">if</span> (!rule) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> rule(...args);
  }

  <span class="hljs-comment">// 注册自定义规则</span>
  registerCustomRule(ruleName, ruleFn) {
    <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">set</span>(ruleName, ruleFn);
  }

  <span class="hljs-comment">// 权限更新（触发元素重新渲染）</span>
  updatePermissions(permissions, roles) {
    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>(permissions, roles);
    <span class="hljs-comment">// 触发Vue响应式更新（需结合Vuex/Pinia）</span>
    store.dispatch(<span class="hljs-string">'updateUserPermissions'</span>, { permissions, roles });
  }
}

export default new PermissionCenter();
</code></pre>
<h4 data-id="heading-14">（2）指令 + 组件的双层控制</h4>
<ul>
<li><strong>全局指令（v-perm）</strong> ：负责基础权限校验，快速隐藏无权限元素：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 注册全局权限指令
app.directive('perm', {
  mounted(el, binding) {
    const { value, arg } = binding<span class="hljs-comment">;</span>
    let <span class="hljs-attr">hasAccess</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

    // 支持权限码校验（<span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>）和自定义规则校验（v-perm:rule=<span class="hljs-string">"xxx"</span>）
    if (<span class="hljs-attr">arg</span> === <span class="hljs-string">'rule'</span>) {
      const { name, args } = value<span class="hljs-comment">;</span>
      <span class="hljs-attr">hasAccess</span> = permissionCenter.checkCustomRule(name, ...args)<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">hasAccess</span> = permissionCenter.hasPermission(value)<span class="hljs-comment">;</span>
    }

    // 无权限时移除元素（避免用户通过DOM操作显示）
    if (!hasAccess) {
      el.parentNode?.removeChild(el)<span class="hljs-comment">;</span>
    }
  },
  // 权限更新时重新校验（如管理员修改权限后）
  updated(el, binding) {
    // 复用mounted逻辑，重新校验权限
    this.mounted(el, binding)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>权限组件（PermissionWrap）</strong> ：应对复杂场景（如多条件组合、权限变更刷新）：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- components/PermissionWrap.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"hasAccess"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> permissionCenter <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/permissionCenter'</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// 权限码（单个或数组）</span>
  <span class="hljs-attr">perm</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 角色（单个或数组）</span>
  <span class="hljs-attr">role</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">customRule</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> }
});

<span class="hljs-comment">// 权限校验逻辑</span>
<span class="hljs-keyword">const</span> hasAccess = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 权限码校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">perm</span>) {
    <span class="hljs-keyword">const</span> perms = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">perm</span>) ? props.<span class="hljs-property">perm</span> : [props.<span class="hljs-property">perm</span>];
    <span class="hljs-keyword">if</span> (!perms.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">perm</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasPermission</span>(perm))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 角色校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">role</span>) {
    <span class="hljs-keyword">const</span> roles = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">role</span>) ? props.<span class="hljs-property">role</span> : [props.<span class="hljs-property">role</span>];
    <span class="hljs-keyword">if</span> (!roles.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasRole</span>(role))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 自定义规则校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">customRule</span>) {
    <span class="hljs-keyword">const</span> { name, args } = props.<span class="hljs-property">customRule</span>;
    <span class="hljs-keyword">if</span> (!permissionCenter.<span class="hljs-title function_">checkCustomRule</span>(name, ...args)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">（3）页面中使用示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 基础权限按钮 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 角色+权限组合控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">perm</span>=<span class="hljs-string">"order:export"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"admin"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>批量导出订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 复杂自定义规则（仅能操作自己创建的订单） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">:custom-rule</span>=<span class="hljs-string">"{ name: 'canOperateOrder', args: [order] }"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"editOrder(order.id)"</span>&gt;</span>编辑订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 表格列权限 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"手机号"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"permissionCenter.hasPermission('user:view:phone')"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"scope"</span>&gt;</span>{{ scope.row.phone }}<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">3. 设计模式</h3>
<ul>
<li><strong>装饰器模式</strong>：通过<code>v-perm</code>指令或<code>PermissionWrap</code>组件包装原有元素，添加权限控制逻辑，不修改元素本身代码，符合开闭原则。</li>
<li><strong>组合模式</strong>：将基础权限校验、角色校验、自定义规则校验组合为复杂权限逻辑，支持灵活组合与扩展。</li>
<li><strong>单例模式</strong>：权限中心（PermissionCenter）采用单例设计，确保全应用权限数据一致，避免重复初始化。</li>
</ul>
<h3 data-id="heading-17">4. 权限存储与安全性</h3>
<h4 data-id="heading-18">（1）存储方案</h4>
<ul>
<li>权限码 / 角色列表：存储在 Vuex/Pinia（内存）+ localStorage（持久化），与路由权限共用存储，确保数据一致性。</li>
<li>自定义规则：存储在权限中心实例中（内存），初始化时注册，无需持久化。</li>
<li>校验结果缓存：存储在权限中心的<code>cache</code>属性（内存），页面刷新后清空，避免缓存过期。</li>
</ul>
<h4 data-id="heading-19">（2）安全性保障</h4>
<ul>
<li>防 DOM 篡改：仅用<code>v-if</code>隐藏元素不够，需用<code>el.remove()</code>彻底移除，避免用户通过浏览器控制台修改 DOM 显示无权限元素。</li>
<li>二次校验：按钮点击事件中添加权限二次校验，防止用户通过控制台触发事件：</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> handleDelete = (userId) =&gt; {
  <span class="hljs-keyword">if</span> (!permissionCenter.hasPermission(<span class="hljs-string">'user:delete'</span>)) {
    ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'无删除权限'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 执行删除逻辑</span>
};
</code></pre>
<ul>
<li>权限更新同步：管理员修改用户权限后，前端调用<code>permissionCenter.updatePermissions</code>更新权限数据，触发元素重新渲染。</li>
</ul>
<h2 data-id="heading-20">三、接口权限：系统安全的 “最后一道防线”</h2>
<h3 data-id="heading-21">1. 核心应用场景</h3>
<ul>
<li><strong>敏感操作接口控制</strong>：<code>/api/user/delete</code>（删除用户）、<code>/api/order/update-status</code>（修改订单状态）等高危接口，仅授权角色可调用。</li>
<li><strong>数据范围权限</strong>：<code>/api/order/list</code>接口，管理员返回所有订单，普通用户仅返回自己创建的订单。</li>
<li><strong>接口频率限制</strong>：免费用户调用<code>/api/search</code>接口每分钟最多 10 次，付费用户无限制。</li>
<li><strong>接口版本权限</strong>：新版本接口（如<code>/api/v2/order</code>）仅对已升级版本的租户开放。</li>
<li><strong>Token 失效 / 权限变更处理</strong>：Token 过期或权限被回收时，接口返回 403/401，前端需优雅处理（如登出、刷新 Token）。</li>
</ul>
<h3 data-id="heading-22">2. 企业级实现方式</h3>
<h4 data-id="heading-23">（1）请求 / 响应拦截器的全链路控制</h4>
<ul>
<li><strong>请求拦截器</strong>：添加 Token、权限预判、数据范围参数：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 添加Token（鉴权基础）</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }

    <span class="hljs-comment">// 2. 接口权限预判（减少无效请求）</span>
    <span class="hljs-keyword">const</span> { url, method } = config;
    <span class="hljs-comment">// 生成接口权限标识（如"DELETE:/api/user/delete" → "user:delete"）</span>
    <span class="hljs-keyword">const</span> apiPerm = <span class="hljs-title function_">generateApiPermissionKey</span>(method, url);
    <span class="hljs-keyword">if</span> (apiPerm &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasPermission</span>(apiPerm)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`无接口权限：<span class="hljs-subst">${apiPerm}</span>`</span>));
    }

    <span class="hljs-comment">// 3. 数据范围参数（配合后端过滤）</span>
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/order/list'</span>) &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasRole</span>(<span class="hljs-string">'admin'</span>)) {
      config.<span class="hljs-property">params</span> = { ...config.<span class="hljs-property">params</span>, <span class="hljs-attr">creatorId</span>: store.<span class="hljs-property">getters</span>.<span class="hljs-property">userId</span> };
    }

    <span class="hljs-comment">// 4. 幂等性处理（敏感接口防重复调用）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>].<span class="hljs-title function_">includes</span>(method)) {
      config.<span class="hljs-property">headers</span>[<span class="hljs-string">'X-Request-Id'</span>] = <span class="hljs-title function_">uuidv4</span>();
    }

    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
);
</code></pre>
<ul>
<li><strong>响应拦截器</strong>：处理权限异常、Token 失效：</li>
</ul>
<pre><code class="hljs language-go" lang="go">axios.interceptors.response.use(
  (response) =&gt; {
    <span class="hljs-comment">// 缓存频繁调用的非敏感接口（如用户信息）</span>
    <span class="hljs-keyword">if</span> (response.config.url === <span class="hljs-string">'/api/user/info'</span> &amp;&amp; response.status === <span class="hljs-number">200</span>) {
      store.dispatch(<span class="hljs-string">'cacheUserInfo'</span>, response.data);
    }
    <span class="hljs-keyword">return</span> response;
  },
  (<span class="hljs-type">error</span>) =&gt; {
    <span class="hljs-keyword">const</span> { status, data } = <span class="hljs-type">error</span>.response || {};
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
        <span class="hljs-comment">// Token失效，登出并跳转登录页</span>
        ElMessage.<span class="hljs-type">error</span>(data.msg || <span class="hljs-string">'登录已失效，请重新登录'</span>);
        store.dispatch(<span class="hljs-string">'logout'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
        <span class="hljs-comment">// 区分接口权限不足和数据权限不足</span>
        <span class="hljs-keyword">const</span> msg = data.msg || <span class="hljs-string">'无接口访问权限'</span>;
        ElMessage.<span class="hljs-type">error</span>(msg);
        <span class="hljs-comment">// 敏感操作权限不足，可记录日志</span>
        <span class="hljs-keyword">if</span> (msg.includes(<span class="hljs-string">'敏感操作'</span>)) {
          reportPermissionError({ url: <span class="hljs-type">error</span>.config.url, msg });
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">429</span>:
        ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'接口调用过于频繁，请稍后再试'</span>);
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> Promise.reject(<span class="hljs-type">error</span>);
  }
);
</code></pre>
<h4 data-id="heading-24">（2）接口权限标识生成规则</h4>
<p>统一接口与权限码的映射关系，避免混乱：</p>
<pre><code class="hljs language-ini" lang="ini">// 生成接口权限标识（method + 接口路径简化）
const <span class="hljs-attr">generateApiPermissionKey</span> = (method, url) =&gt; {
  // 示例：DELETE /api/user/123 → user:delete
  // 示例：GET /api/order/list → order:list
  const <span class="hljs-attr">pathParts</span> = url.replace(/^/api//, <span class="hljs-string">''</span>).split(<span class="hljs-string">'/'</span>)<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">pathParts.length</span> === <span class="hljs-number">0</span>) return <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">resource</span> = pathParts[<span class="hljs-number">0</span>]<span class="hljs-comment">; // 资源名（user/order）</span>
  let <span class="hljs-attr">action</span> = method.toLowerCase()<span class="hljs-comment">; // 操作（get/post/delete）</span>
  // 特殊映射：get列表 → list，get详情 → view
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.includes(<span class="hljs-string">'list'</span>)) action = <span class="hljs-string">'list'</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.length &gt;= <span class="hljs-number">2</span> &amp;&amp; !isNaN(pathParts[<span class="hljs-number">1</span>])) action = <span class="hljs-string">'view'</span><span class="hljs-comment">;</span>
  return `${resource}:${action}`<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">3. 设计模式</h3>
<ul>
<li><strong>代理模式</strong>：请求拦截器作为接口调用的代理，统一添加鉴权信息、权限预判、数据范围参数，不修改业务请求代码。</li>
<li><strong>责任链模式</strong>：后端接口校验按 “Token 校验→权限码校验→数据范围校验→频率限制” 的顺序执行，前端响应拦截器按 “401 处理→403 处理→429 处理” 顺序处理异常。</li>
<li><strong>缓存模式</strong>：对非敏感接口结果进行缓存，减少重复请求，提升性能（需在权限变更时清空缓存）。</li>
</ul>
<h3 data-id="heading-26">4. 权限存储与安全性</h3>
<h4 data-id="heading-27">（1）存储方案</h4>
<ul>
<li>Token：存储在 localStorage（持久化）或 sessionStorage（会话级），建议设置<code>HttpOnly</code>和<code>Secure</code>属性（需后端配合），防止 XSS 攻击。</li>
<li>接口权限标识映射规则：前端预设（如<code>user:delete</code>对应<code>/api/user/delete</code>），无需持久化，确保与后端一致。</li>
<li>接口缓存：存储在 Vuex/Pinia（内存），缓存 key 包含用户 ID 和权限标识，避免多用户数据混淆。</li>
</ul>
<h4 data-id="heading-28">（2）安全性保障</h4>
<ul>
<li>后端绝对校验：前端权限预判仅为体验优化，后端必须对每个接口做独立权限校验，防止用户通过 Postman 等工具绕过前端拦截。</li>
<li>Token 加密传输：所有接口采用 HTTPS 协议，Token 在传输过程中加密，避免中间人攻击。</li>
<li>敏感接口二次验证：核心接口（如删除用户、转账）需添加二次验证（如输入密码、短信验证码），即使权限校验通过，也需确认操作意图。</li>
<li>权限日志记录：前端调用敏感接口时，传递操作人、操作时间、IP 地址等信息，后端存储日志，便于安全追溯。</li>
</ul>
<h2 data-id="heading-29">四、限设计的额外关键要点</h2>
<h3 data-id="heading-30">1. 权限可视化配置</h3>
<ul>
<li>管理员通过系统后台的 “权限配置页面”，勾选角色对应的权限（如 “用户管理”→“删除用户”），后端存储角色 - 权限映射关系。</li>
<li>前端渲染 “权限树”，支持按模块折叠 / 展开，便于管理员操作；支持批量分配权限（如给 “运营” 角色分配所有订单相关权限）。</li>
</ul>
<h3 data-id="heading-31">2. 权限动态更新与同步</h3>
<ul>
<li>管理员修改用户权限后，前端通过 WebSocket 或轮询实时获取最新权限，调用<code>permissionCenter.updatePermissions</code>更新数据，无需用户刷新页面。</li>
<li>跨标签页权限同步：通过<code>localStorage</code>监听事件，一个标签页修改权限后，其他标签页自动更新权限状态。</li>
</ul>
<h3 data-id="heading-32">3. 跨端权限统一管理</h3>
<ul>
<li>若项目包含 PC 端、移动端、小程序，设计统一的权限中心（后端），各端共用一套权限码和角色体系（如<code>user:delete</code>在所有端含义一致）。</li>
<li>前端各端复用权限校验逻辑（如<code>permissionCenter</code>工具类），确保权限控制行为一致。</li>
</ul>
<h3 data-id="heading-33">4. 性能优化</h3>
<ul>
<li>权限校验缓存：对频繁校验的权限码（如表格列权限）进行缓存，避免重复计算。</li>
<li>动态路由懒加载：动态添加的路由组件采用懒加载（<code>() =&gt; import('../views/xxx.vue')</code>），减少首屏加载时间。</li>
<li>权限数据批量请求：登录后一次性获取用户角色、权限码、路由配置，避免多次请求后端。</li>
</ul>
<h3 data-id="heading-34">5. 灰度发布与 A/B 测试</h3>
<ul>
<li>权限中心支持 “灰度规则”，如 “用户 ID 在白名单内”“部门为测试部” 的用户可访问新功能路由和按钮。</li>
<li>通过权限配置实现 A/B 测试，给不同用户组分配不同权限，验证功能效果后全量开放。</li>
</ul>
<h2 data-id="heading-35">五、总结</h2>
<h3 data-id="heading-36">1. 权限设计的三层逻辑</h3>
<ul>
<li>前端路由权限：控制 “能否访问页面”，优化用户体验，减少无效请求。</li>
<li>前端元素权限：控制 “能否看到功能”，隐藏无权限元素，避免用户困惑。</li>
<li>后端接口权限：控制 “能否执行操作”，是安全核心，必须绝对可靠。</li>
</ul>
<h3 data-id="heading-37">2. 安全性原则</h3>
<ul>
<li>前端权限是 “体验层”，不能替代后端校验；后端权限是 “安全层”，必须覆盖所有敏感操作。</li>
<li>敏感信息（Token、权限标识）需加密存储和传输，防止泄露。</li>
<li>权限变更需实时同步，避免权限不一致导致的安全隐患。</li>
</ul>
<h3 data-id="heading-38">3. 可扩展性原则</h3>
<ul>
<li>采用设计模式（如责任链、装饰器、单例）降低代码耦合，便于后期扩展权限规则。</li>
<li>预留自定义权限规则接口，应对复杂业务场景（如多条件组合权限）。</li>
<li>权限配置可视化、动态化，减少前端发版频率，提升运营效率。</li>
</ul>
<p>项目中，权限设计并非一成不变，需根据业务规模和安全要求逐步迭代：初期可采用 “角色 + 静态权限”，中期引入 “权限码 + 动态路由”，后期升级为 “可视化配置 + 细粒度数据权限”，最终实现 “安全、灵活、易维护” 的权限体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 cupsd.conf 查看打印服务的配置文件]]></title>    <link>https://juejin.cn/post/7577215663968026666</link>    <guid>https://juejin.cn/post/7577215663968026666</guid>    <pubDate>2025-11-27T10:31:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663968026666" data-draft-id="7577204540417753151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 cupsd.conf 查看打印服务的配置文件"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-27T10:31:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 cupsd.conf 查看打印服务的配置文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:31:38.000Z" title="Thu Nov 27 2025 10:31:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 cupsd.conf 查看打印服务的配置文件</h3>
<pre><code class="hljs language-c" lang="c">root@uos:/var/<span class="hljs-built_in">log</span>/cups<span class="hljs-meta"># cat /etc/cups/cupsd.conf </span>
#
# Configuration file <span class="hljs-keyword">for</span> the CUPS scheduler.  See <span class="hljs-string">"man cupsd.conf"</span> <span class="hljs-keyword">for</span> a
<span class="hljs-meta"># complete description of this file.</span>
#

# Log general information in error_log - change <span class="hljs-string">"warn"</span> to <span class="hljs-string">"debug"</span>
<span class="hljs-meta"># for troubleshooting...</span>
LogLevel warn
PageLogFormat

# Specifies the maximum size of the <span class="hljs-built_in">log</span> files before they are rotated.  The value <span class="hljs-string">"0"</span> disables <span class="hljs-built_in">log</span> rotation.
MaxLogSize <span class="hljs-number">0</span>

# Default error policy <span class="hljs-keyword">for</span> printers
ErrorPolicy retry-job

# Only listen <span class="hljs-keyword">for</span> connections from the local machine.
Listen localhost:<span class="hljs-number">631</span>
Listen /run/cups/cups.sock

# Show shared printers on the local network.
Browsing Yes
BrowseLocalProtocols dnssd

# Default authentication type, when authentication is required...
DefaultAuthType Basic

# Web interface setting...
WebInterface Yes

# Timeout after cupsd exits <span class="hljs-keyword">if</span> <span class="hljs-title function_">idle</span> <span class="hljs-params">(applied only <span class="hljs-keyword">if</span> cupsd runs on-demand - with -l)</span>
IdleExitTimeout 60

# Restrict access to the server...
&lt;Location /&gt;
  Order allow,deny
&lt;/Location&gt;

# Restrict access to the admin pages...
&lt;Location /admin&gt;
  Order allow,deny
&lt;/Location&gt;

# Restrict access to configuration files...
&lt;Location /admin/conf&gt;
  AuthType Default
  Require user @SYSTEM
  Order allow,deny
&lt;/Location&gt;

# Restrict access to <span class="hljs-built_in">log</span> files...
&lt;Location /admin/<span class="hljs-built_in">log</span>&gt;
  AuthType Default
  Require user @SYSTEM
  Order allow,deny
&lt;/Location&gt;

# Set the <span class="hljs-keyword">default</span> printer/job policies...
&lt;Policy <span class="hljs-keyword">default</span>&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit CUPS-Get-Document&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default CUPS-Get-Devices&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;

# Set the authenticated printer/job policies...
&lt;Policy authenticated&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    AuthType Default
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job CUPS-Get-Document&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;

# Set the kerberized printer/job policies...
&lt;Policy kerberos&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    AuthType Negotiate
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job CUPS-Get-Document&gt;
    AuthType Negotiate
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    AuthType Negotiate
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;
root@uos:/var/<span class="hljs-built_in">log</span>/cups# 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[电子书阅读器：解析 EPUB 底层原理与实战]]></title>    <link>https://juejin.cn/post/7576841976927567908</link>    <guid>https://juejin.cn/post/7576841976927567908</guid>    <pubDate>2025-11-26T08:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576841976927567908" data-draft-id="7576487832089804815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="电子书阅读器：解析 EPUB 底层原理与实战"/> <meta itemprop="keywords" content="Android,HTML"/> <meta itemprop="datePublished" content="2025-11-26T08:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            电子书阅读器：解析 EPUB 底层原理与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:25:44.000Z" title="Wed Nov 26 2025 08:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>当我们想要开发一个电子书阅读器时，不可避免地会遇到 EPUB 格式。</p>
<p>其实，EPUB 并不复杂，只要掌握了 XML 解析和 HTML 处理，就能够写出一个高性能、轻量级的解析引擎。</p>
<p>我们先从最基础的解析工具开始。</p>
<h2 data-id="heading-1">XmlPullParser</h2>
<p>EPUB 的核心元数据文件（<code>.opf</code>）和容器描述文件（<code>.xml</code>），本质上都是 XML。Android 官方推荐使用 <code>XmlPullParser</code> 来解析它们。</p>
<h3 data-id="heading-2">什么是 Pull 解析？</h3>
<p>Pull 解析就是一行行往下读取，这种方式内存占用低。</p>
<p>与之相对的有 DOM 解析，它是一次性将整个文件读入内存，它的优点是快，但对内存极度不友好。</p>
<h3 data-id="heading-3">事件循环</h3>
<p><code>XmlPullParser</code> 的工作模式其实就是一个 while 循环，不断处理当前的<strong>事件类型</strong>：</p>
<ul>
<li><code>START_DOCUMENT</code>: 开始</li>
<li><code>START_TAG</code>: 读到了开始标签</li>
<li><code>TEXT</code>: 读到了标签里的文字</li>
<li><code>END_TAG</code>: 读到了结束标签</li>
<li><code>END_DOCUMENT</code>: 结束</li>
</ul>
<h3 data-id="heading-4">实战</h3>
<p>了解完以上内容，就可以开始解析一段 XML 了。</p>
<p>以下面这段 XML 为例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">student</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">student</span>&gt;</span>
</code></pre>
<blockquote>
<p>作为 <code>student_data.xml</code> 文件存放在 <code>app/src/main/assets</code> 目录下。</p>
</blockquote>
<p>在 <code>MainActivity</code> 中使用 <code>XmlPullParser</code> 来解析：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(<span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>)

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseStudentXml</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Student? = withContext(Dispatchers.IO) { <span class="hljs-comment">// 将耗时操作放在 IO 线程中</span>
    <span class="hljs-comment">// 创建 Pull 解析器</span>
    <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
    <span class="hljs-keyword">var</span> student: Student? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">try</span> {
        parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
        <span class="hljs-keyword">var</span> eventType = parser.eventType

        <span class="hljs-keyword">var</span> currentName = <span class="hljs-string">""</span>
        <span class="hljs-keyword">var</span> currentAge = <span class="hljs-number">0</span>

        Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"开始解析 XML 文档..."</span>)
        <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
            <span class="hljs-keyword">when</span> (eventType) {
                XmlPullParser.START_TAG -&gt; {
                    <span class="hljs-comment">// 获取标签名</span>
                    <span class="hljs-keyword">when</span> (parser.name) {
                        <span class="hljs-string">"student"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 student"</span>)
                        }
                        <span class="hljs-comment">// 获取标签内容, 并移到标签末位</span>
                        <span class="hljs-string">"name"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 name"</span>)
                            currentName = parser.nextText()
                        }
                        <span class="hljs-string">"age"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 age"</span>)
                            currentAge = parser.nextText().toIntOrNull() ?: <span class="hljs-number">0</span>
                        }
                    }
                }
            }
            <span class="hljs-comment">// 获取下一个事件</span>
            eventType = parser.next()
        }

        student = Student(currentName, currentAge)
        Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析成功: <span class="hljs-variable">$student</span>"</span>)

    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析失败"</span>, e)
    } <span class="hljs-keyword">finally</span> {
        inputStream.close()
    }

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> student
}


<span class="hljs-comment">// 调用示例</span>
lifecycleScope.launch {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"student_data.xml"</span>)
        <span class="hljs-keyword">val</span> student = parseStudentXml(inputStream)
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">开始解析 XML 文档...
遇到标签 student
遇到标签 name
遇到标签 age
解析成功: Student(<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">18</span>)
</code></pre>
<h3 data-id="heading-5">nextText() 陷阱</h3>
<p><code>nextText()</code> 会读取当前标签的内容，并移动到标签末尾 <code>END_TAG</code>。</p>
<ul>
<li>
<p>如果标签内容是空的，那么它会返回空串 ""。</p>
</li>
<li>
<p>如果标签还嵌套了标签，那么它可能会抛出异常或导致数据丢失。</p>
</li>
</ul>
<p>例如，我们将上述的 XML 内容改为：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">student</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>张<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>三
    <span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">student</span>&gt;</span>
</code></pre>
<p>此时运行程序，会报错：</p>
<pre><code class="hljs language-less" lang="less">解析失败                                                        <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.xmlpull</span><span class="hljs-selector-class">.v1</span><span class="hljs-selector-class">.XmlPullParserException</span>: <span class="hljs-selector-tag">END_TAG</span> <span class="hljs-selector-tag">expected</span> (<span class="hljs-attribute">position</span>:START_TAG (empty) &lt;br&gt;<span class="hljs-variable">@2</span>:<span class="hljs-number">18</span> in java.io.InputStreamReader<span class="hljs-variable">@352bfed</span>) 
</code></pre>
<p>意思是说在期望找到一个结束标签时，却遇到了一个开始标签 <code>&lt;br</code>。但我们认为的 <code>&lt;br /&gt;</code> 只是一个换行符，应该被当作文本内容进行处理。</p>
<p>这时，我们需要手动处理 TEXT 事件。</p>
<blockquote>
<p>标签之间的换行符也是一个 TEXT 事件。</p>
</blockquote>
<h4 data-id="heading-6">手动处理 TEXT 事件</h4>
<p>手动处理 <code>TEXT</code> 事件时，为了解决 XML 嵌套导致的状态丢失问题，我们需要引入栈来维护状态。我们推荐使用 <code>ArrayDeque</code> 来替换 <code>Stack</code>，性能更好。</p>
<p>逻辑流程：</p>
<ul>
<li>
<p><strong>START_TAG</strong>：将当前标签名压入状态栈中。</p>
</li>
<li>
<p><strong>TEXT</strong>：检查栈顶元素，如果是目标标签，就提取并拼接文本；如果是目标标签的子标签，根据业务逻辑判断是否需要提取。</p>
</li>
<li>
<p><strong>END_TAG</strong>：弹出栈顶元素，回到最近一层的父标签的状态。</p>
</li>
</ul>
<p>代码实现：<strong>基于栈的状态机</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseStudentXmlManual</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Student? =
    withContext(Dispatchers.IO) {
        <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
        <span class="hljs-keyword">var</span> student: Student? = <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 用 ArrayDeque 代替 Stack</span>
        <span class="hljs-keyword">val</span> stateStack = ArrayDeque&lt;String&gt;()

        <span class="hljs-keyword">try</span> {
            parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
            <span class="hljs-keyword">var</span> eventType = parser.eventType
            <span class="hljs-keyword">val</span> sbName = StringBuilder()
            <span class="hljs-keyword">var</span> age = <span class="hljs-number">0</span>

            <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
                <span class="hljs-keyword">when</span> (eventType) {
                    XmlPullParser.START_TAG -&gt; {
                        <span class="hljs-keyword">val</span> tagName = parser.name
                        <span class="hljs-comment">// 存入新状态</span>
                        stateStack.addLast(tagName)
                    }

                    XmlPullParser.TEXT -&gt; {
                        <span class="hljs-comment">// 获取当前文本内容</span>
                        <span class="hljs-keyword">val</span> text = parser.text
                        <span class="hljs-keyword">if</span> (!text.isNullOrBlank()) {
                            <span class="hljs-comment">// 查看栈顶，决定了当前文本属于谁</span>
                            <span class="hljs-keyword">if</span> (stateStack.isNotEmpty()) {
                                <span class="hljs-keyword">val</span> currentTag = stateStack.last() <span class="hljs-comment">// 获取当前所处的最近一层标签</span>

                                <span class="hljs-keyword">when</span> (currentTag) {
                                    <span class="hljs-string">"name"</span> -&gt; sbName.append(text.trim())
                                    <span class="hljs-string">"br"</span> -&gt; { <span class="hljs-comment">/* 忽略 */</span>
                                    }

                                    <span class="hljs-string">"age"</span> -&gt; age = text.trim().toIntOrNull() ?: <span class="hljs-number">0</span>
                                }
                            }
                        }
                    }

                    XmlPullParser.END_TAG -&gt; {
                        <span class="hljs-comment">// 恢复到上一个状态</span>
                        <span class="hljs-keyword">if</span> (stateStack.isNotEmpty()) {
                            stateStack.removeLast()
                        }
                    }
                }
                eventType = parser.next()
            }

            <span class="hljs-keyword">val</span> name: String = sbName.toString()
            student = Student(name, age)
            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析成功: <span class="hljs-variable">$student</span>"</span>)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析失败"</span>, e)
        } <span class="hljs-keyword">finally</span> {
            inputStream.close()
        }

        <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> student
    }
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">解析成功: Student(<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">18</span>)
</code></pre>
<h2 data-id="heading-7">Jsoup</h2>
<p>EPUB 的正文内容其实就是网页（XHTML/HTML）。对于解析 HTML，我们不会去使用 <code>XmlPullParser</code>，因为它嵌套很复杂，并且标签常常不闭合。</p>
<p>这时，我们会使用 Jsoup 来解析。</p>
<p>它能将杂乱的 HTML 修正为标准的 DOM 树，并且有着 CSS 选择器：可以像写 CSS 样式一样查找元素。</p>
<h3 data-id="heading-8">CSS 选择器</h3>
<p>提取数据非常容易：</p>
<ul>
<li>
<p>选取所有一级标题：<code>doc.select("h1")</code>。</p>
</li>
<li>
<p>选取所有带图片路径的 img 标签：<code>doc.select("img[src]")</code>。</p>
</li>
</ul>
<h3 data-id="heading-9">实战</h3>
<p>假设要解析如下 HTML 文件，我们需要提取标题、作者和正文内容，去除掉正文中的广告。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Android 性能优化实战 - 技术周刊<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nav"</span>&gt;</span>首页 &gt; Android &gt; 性能优化<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post-title"</span>&gt;</span>Android 内存优化：从入门到精通<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"meta-info"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>作者：Android专家<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>阅读：1024<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post-content"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
                    在 Android 开发中，<span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>内存泄漏<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span>是导致应用卡顿的主要原因之一。
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ad-banner"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>广告：点击领取高薪面试题库！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
                    使用 <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://square.github.io/leakcanary/"</span>&gt;</span>LeakCanary<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> 工具，可以帮助我们快速定位 <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Activity<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 和 <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Fragment<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的泄漏点。
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>只有深入理解 GC 机制，才能写出健壮的代码。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Copyright © 2022 技术博客<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>首先引入依赖：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    implementation(<span class="hljs-string">"org.jsoup:jsoup:1.21.2"</span>)
}
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Blog</span>(
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> author: String,
    <span class="hljs-keyword">val</span> content: String,
)

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseHtmlContent</span><span class="hljs-params">(
    inputStream: <span class="hljs-type">InputStream</span>
)</span></span> = withContext(Dispatchers.IO) {
    <span class="hljs-comment">// 解析 HTML 为 Document 对象</span>
    <span class="hljs-keyword">val</span> doc: Document = Jsoup.parse(inputStream, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">""</span>)

    <span class="hljs-comment">// 提取标题</span>
    <span class="hljs-keyword">val</span> title = doc.select(<span class="hljs-string">"h1.post-title"</span>).text()

    <span class="hljs-comment">// 提取作者</span>
    <span class="hljs-keyword">val</span> author = doc.selectFirst(<span class="hljs-string">"div.meta-info"</span>)?.text()
            ?.substringAfter(<span class="hljs-string">"作者："</span>)
            ?.substringBefore(<span class="hljs-string">"阅读："</span>)
            ?.trim()
            ?: <span class="hljs-string">"未知"</span>

    <span class="hljs-keyword">val</span> contentDiv = doc.select(<span class="hljs-string">"div.post-content"</span>)

    <span class="hljs-comment">// 先去除广告节点</span>
    contentDiv.select(<span class="hljs-string">".ad-banner"</span>).remove()

    <span class="hljs-comment">// 获取内容</span>
    <span class="hljs-keyword">val</span> content = contentDiv.text()

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> Blog(title, author, content)
}

<span class="hljs-comment">// 使用示例</span>
lifecycleScope.launch(Dispatchers.IO) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"blog.html"</span>)
        <span class="hljs-keyword">val</span> blog = parseHtmlContent(inputStream)
        Log.d(<span class="hljs-string">"EpubTest"</span>, <span class="hljs-string">"Blog: <span class="hljs-variable">$blog</span>"</span>)
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">Blog: Blog(<span class="hljs-attr">title</span>=Android 内存优化：从入门到精通, author=Android专家, content=在 Android 开发中，内存泄漏是导致应用卡顿的主要原因之一。 使用 LeakCanary 工具，可以帮助我们快速定位 Activity 和 Fragment 的泄漏点。 只有深入理解 GC 机制，才能写出健壮的代码。)
</code></pre>
<h3 data-id="heading-10">DOM 遍历与节点操作</h3>
<p>直接使用 <code>text()</code>，确实很方便，它能自动处理换行。但它也会将 <code>&lt;b&gt;</code>, <code>&lt;a&gt;</code> 等标签剥离，导致加粗、斜体等样式也都丢失了。</p>
<p>这时，我们可以手动遍历 DOM 树来手动处理特定标签，代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseHtmlContent</span><span class="hljs-params">(
    inputStream: <span class="hljs-type">InputStream</span>
)</span></span> = withContext(Dispatchers.IO) {
    <span class="hljs-keyword">val</span> doc: Document = Jsoup.parse(inputStream, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">""</span>)
    <span class="hljs-keyword">val</span> title = doc.select(<span class="hljs-string">"h1.post-title"</span>).text()

    <span class="hljs-comment">// 提取作者</span>
    <span class="hljs-keyword">val</span> author = doc.selectFirst(<span class="hljs-string">"div.meta-info"</span>)?.text()
        ?.substringAfter(<span class="hljs-string">"作者："</span>)
        ?.substringBefore(<span class="hljs-string">"阅读："</span>)
        ?.trim()
        ?: <span class="hljs-string">"未知"</span>

    <span class="hljs-keyword">val</span> sbContent = StringBuilder()

    <span class="hljs-keyword">val</span> contentDiv = doc.select(<span class="hljs-string">"div.post-content"</span>).first()
    <span class="hljs-comment">// 移除广告节点</span>
    contentDiv?.select(<span class="hljs-string">".ad-banner"</span>)?.remove()

    contentDiv?.let {
        <span class="hljs-comment">// 遍历容器的子节点</span>
        <span class="hljs-keyword">for</span> (node <span class="hljs-keyword">in</span> it.childNodes()) {
            traverseNode(node, sbContent)
        }
    }
    <span class="hljs-keyword">val</span> content = sbContent.toString().trim()

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> Blog(title, author, content)
}

<span class="hljs-comment">/**
 * 递归遍历节点树
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">traverseNode</span><span class="hljs-params">(
    node: <span class="hljs-type">Node</span>,
    sb: <span class="hljs-type">StringBuilder</span>
)</span></span> {
    <span class="hljs-keyword">when</span> (node) {
        <span class="hljs-comment">// 纯文本节点</span>
        <span class="hljs-keyword">is</span> TextNode -&gt; {
            <span class="hljs-keyword">val</span> text = node.text().trim()
            <span class="hljs-keyword">if</span> (text.isNotBlank()) {
                sb.append(text)
            }
        }
        <span class="hljs-comment">// 元素节点</span>
        <span class="hljs-keyword">is</span> Element -&gt; {
            <span class="hljs-keyword">when</span> (node.tagName()) {
                <span class="hljs-string">"p"</span> -&gt; { <span class="hljs-comment">// 段落</span>
                    sb.append(<span class="hljs-string">"\n"</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                }

                <span class="hljs-string">"div"</span>, <span class="hljs-string">"span"</span> -&gt; { <span class="hljs-comment">// 容器</span>
                    node.childNodes().forEach { traverseNode(it, sb) }
                }

                <span class="hljs-string">"b"</span>, <span class="hljs-string">"strong"</span> -&gt; {
                    sb.append(<span class="hljs-string">"[加粗: "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-string">"i"</span>, <span class="hljs-string">"em"</span> -&gt; {
                    sb.append(<span class="hljs-string">"[斜体: "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-string">"a"</span> -&gt; {
                    <span class="hljs-keyword">val</span> href = node.attr(<span class="hljs-string">"href"</span>)
                    sb.append(<span class="hljs-string">"[链接(<span class="hljs-variable">$href</span>): "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-keyword">else</span> -&gt; {}
            }
        }
    }
}
</code></pre>
<p>解析出的内容：</p>
<pre><code class="hljs language-css" lang="css">在 Android 开发中，<span class="hljs-selector-attr">[加粗: 内存泄漏]</span>是导致应用卡顿的主要原因之一。
使用<span class="hljs-selector-attr">[链接(https://square.github.io/leakcanary/): LeakCanary]</span>工具，可以帮助我们快速定位<span class="hljs-selector-attr">[斜体: Activity]</span>和<span class="hljs-selector-attr">[斜体: Fragment]</span>的泄漏点。
只有深入理解 GC 机制，才能写出健壮的代码。
</code></pre>
<blockquote>
<p>在实际开发中，我们会使用 <code>SpannableStringBuilder</code> 来拼接结果，比如遇到 <code>&lt;b&gt;</code> 标签时应用 <code>StyleSpan(Typeface.BOLD)</code>，这样可以直接在 UI 组件中显示富文本效果。</p>
</blockquote>
<h2 data-id="heading-11">EPUB 的组成</h2>
<p>EPUB 电子书本质上就是一个 ZIP 压缩包，你可以将其后缀改为 .zip 并解压，查看其目录结构：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">eBook</span>/
├── <span class="hljs-selector-tag">META-INF</span>/
│   └── <span class="hljs-selector-tag">container</span><span class="hljs-selector-class">.xml</span>      (入口)
├── <span class="hljs-selector-tag">OEBPS</span>/                 
│   ├── <span class="hljs-selector-tag">content</span><span class="hljs-selector-class">.opf</span>        (核心)
│   ├── <span class="hljs-selector-tag">nav</span><span class="hljs-selector-class">.xhtml</span>          (导航)  
│   ├── <span class="hljs-selector-tag">toc</span><span class="hljs-selector-class">.ncx</span>            (目录)
│   ├── <span class="hljs-selector-tag">Styles</span>/            (样式)
│   ├── <span class="hljs-selector-tag">Text</span>/              (正文)
│   └── <span class="hljs-selector-tag">Images</span>/            (图片)
└── <span class="hljs-selector-tag">mimetype</span>               (身份标识)
</code></pre>
<h3 data-id="heading-12">关键文件：META-INF/container.xml</h3>
<p>它的作用是告诉我们核心描述文件（.opf）的位置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:oasis:names:tc:opendocument:xmlns:container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rootfiles</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">rootfile</span> <span class="hljs-attr">full-path</span>=<span class="hljs-string">"OEBPS/content.opf"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/oebps-package+xml"</span>/&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">rootfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span>
</code></pre>
<p>我们只需使用 <code>XmlPullParser</code> 读取 <code>full-path</code> 属性，就能拿到文件路径 "OEBPS/content.opf"。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseContainer</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: String? = withContext(Dispatchers.IO) {
    <span class="hljs-keyword">val</span> xmlPullParser = Xml.newPullParser()

    xmlPullParser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
    <span class="hljs-keyword">var</span> eventType = xmlPullParser.eventType

    <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
        <span class="hljs-keyword">when</span> (eventType) {
            XmlPullParser.START_TAG -&gt; {
                <span class="hljs-keyword">val</span> tagName = xmlPullParser.name
                <span class="hljs-keyword">if</span> (tagName == <span class="hljs-string">"rootfile"</span>) {
                    <span class="hljs-keyword">val</span> rootFilePath = xmlPullParser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"full-path"</span>)
                    Log.d(<span class="hljs-string">"ContainerRootFilePath"</span>, <span class="hljs-string">"rootFilePath: <span class="hljs-variable">$rootFilePath</span>"</span>)
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> rootFilePath
                }
            }
        }
        eventType = xmlPullParser.next()
    }
    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-bash" lang="bash">rootFilePath: OEBPS/content.opf
</code></pre>
<h3 data-id="heading-13">关键文件：opf 文件</h3>
<p>OPF 文件也是一个 XML，它存着书籍的重要信息：</p>
<ul>
<li><strong><code>&lt;metadata&gt;</code></strong>：元数据。书名、作者、标识符、简介、语言、简介、出版社、分类、封面等。</li>
<li><strong><code>&lt;mainfest&gt;</code></strong>：资源清单。书中的所有文件都要在此进行注册，每一项（<code>item</code>）都有着 <code>href</code>、<code>id</code>、<code>media-type</code>。</li>
<li><strong><code>spine</code></strong>：书脊。它引用了资源清单里面的 id，定义了书的阅读顺序。</li>
</ul>
<h4 data-id="heading-14">OPF 示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span> <span class="hljs-attr">unique-identifier</span>=<span class="hljs-string">"BookId"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"3.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://purl.org/dc/elements/1.1/"</span> <span class="hljs-attr">xmlns:opf</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！） 第一卷 Flag1.不然到三十岁还单身就跟我在一起吧？<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-2"</span>&gt;</span>七菜なな<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-3"</span>&gt;</span>Parum<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span>&gt;</span>calibre:19525<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span>&gt;</span>uuid:77842cae-a0d7-4144-9f4d-9ca1a73b2129<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BookId"</span> <span class="hljs-attr">opf:scheme</span>=<span class="hljs-string">"UUID"</span>&gt;</span>urn:uuid:52746820-f83f-11ee-bf6c-08bfb888ec3a<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:source</span>&gt;</span>https://www.wenku8.cc/book/3103.htm<span class="hljs-tag">&lt;/<span class="hljs-name">dc:source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:language</span>&gt;</span>zh<span class="hljs-tag">&lt;/<span class="hljs-name">dc:language</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:contributor</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-1"</span>&gt;</span>calibre (7.0.0) [https://calibre-ebook.com]<span class="hljs-tag">&lt;/<span class="hljs-name">dc:contributor</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:description</span>&gt;</span>在某一所乡村国中，一对男女向彼此立下永恒友情的誓言。
朝着同一个梦想前进，成为命运共同体的两人之间──
关系并没有任何特别的发展，就这么度过了两年的岁月……！
至今都还没谈过初恋的 High 咖女子──犬冢日葵，
以及热爱花卉的植物男子──夏目悠宇，
就算升上高中二年级，还是一样在只有两人的园艺社中，平和地当着挚友。
然而这时，悠宇跟初恋对象重逢，使得两人之间的关系开始失控？
究竟「已经懂得恋慕之心」的日葵，能不能摆脱「理想挚友」的身份呢？<span class="hljs-tag">&lt;/<span class="hljs-name">dc:description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:publisher</span>&gt;</span>电击文库<span class="hljs-tag">&lt;/<span class="hljs-name">dc:publisher</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>校园<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>青春<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>恋爱<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>后宫<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>欢乐向<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"title-type"</span>&gt;</span>main<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！） 第一卷 Flag1.不然到三十岁还单身就跟我在一起吧？<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cover"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"img157909.jpg"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-1"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>bkp<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-2"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>aut<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-2"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>七菜なな<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-3"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>aut<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-3"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>Parum<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"belongs-to-collection"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-4"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！）<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-4"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"collection-type"</span>&gt;</span>series<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-4"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"group-position"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/Cover.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Cover.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/chapter0.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chapter0.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/chapter1.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chapter1.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/Credits.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Credits.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nav"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"nav.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> <span class="hljs-attr">properties</span>=<span class="hljs-string">"nav"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"toc.ncx"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ncxuks"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/x-dtbncx+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Styles/style.css"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"style.css"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"text/css"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Images/157909.jpg"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"img157909.jpg"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"image/jpeg"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Images/157910.jpg"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"img157910.jpg"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"image/jpeg"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">spine</span> <span class="hljs-attr">toc</span>=<span class="hljs-string">"ncxuks"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"Cover.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"chapter0.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"chapter1.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"Credits.xhtml"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">spine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
</code></pre>
<p>定义数据类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 书籍元数据
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookMetadata</span>(
    <span class="hljs-keyword">val</span> title: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> authors: List&lt;String&gt; = emptyList(),
    <span class="hljs-keyword">val</span> description: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> language: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> cover: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> publisher: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> categories: List&lt;String&gt; = emptyList(),
)

<span class="hljs-comment">/**
 * 书籍目录顺序
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookSpineItem</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> href: String,
    <span class="hljs-keyword">val</span> mediaType: String,
)

<span class="hljs-comment">// 临时存储 manifest 数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ManifestItem</span>(<span class="hljs-keyword">val</span> href: String, <span class="hljs-keyword">val</span> mediaType: String)
</code></pre>
<p>因为元数据封面和书脊都使用了 ID 引用，所以我们可以先解析 <code>Manifest</code>，构建出一个映射表，再来解析 <code>Metadata</code> 和 <code>Spine</code>，这样更加清晰。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseOpf</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Pair&lt;BookMetadata, List&lt;BookSpineItem&gt;&gt; {
    <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
    parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
    <span class="hljs-comment">// 开启命名空间处理，这样 parser.name 会返回 "title" 而不是 "dc:title"，不包含 dc: 前缀</span>
    parser.setFeature(XmlPullParser.FEATURE_PROCESS_NAMESPACES, <span class="hljs-literal">true</span>)

    <span class="hljs-keyword">var</span> eventType = parser.eventType

    <span class="hljs-comment">// 映射表：ID -&gt; ManifestItem</span>
    <span class="hljs-keyword">val</span> manifestMap = mutableMapOf&lt;String, ManifestItem&gt;()

    <span class="hljs-comment">// 书籍元数据</span>
    <span class="hljs-keyword">var</span> title = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> authors = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> description = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> language = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> publisher = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> categories = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> coverId = <span class="hljs-string">""</span> <span class="hljs-comment">// 封面 ID</span>

    <span class="hljs-comment">// 脊骨列表：只存 ID 引用，稍后解析</span>
    <span class="hljs-keyword">val</span> spineIdRefs = mutableListOf&lt;String&gt;()

    <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
        <span class="hljs-keyword">when</span> (eventType) {
            XmlPullParser.START_TAG -&gt; {
                <span class="hljs-keyword">val</span> tagName = parser.name

                <span class="hljs-keyword">when</span> (tagName) {
                    <span class="hljs-comment">// 处理元数据 (Metadata)</span>
                    <span class="hljs-string">"title"</span> -&gt; title = safeNextText(parser)
                    <span class="hljs-string">"creator"</span> -&gt; authors.add(safeNextText(parser))
                    <span class="hljs-string">"description"</span> -&gt; description = safeNextText(parser)
                    <span class="hljs-string">"language"</span> -&gt; language = safeNextText(parser)
                    <span class="hljs-string">"publisher"</span> -&gt; publisher = safeNextText(parser)
                    <span class="hljs-string">"subject"</span> -&gt; categories.add(safeNextText(parser))

                    <span class="hljs-string">"meta"</span> -&gt; {
                        <span class="hljs-comment">// 处理封面：&lt;meta name="cover" content="img157909.jpg"/&gt;</span>
                        <span class="hljs-keyword">val</span> nameAttr = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"name"</span>)
                        <span class="hljs-keyword">if</span> (nameAttr == <span class="hljs-string">"cover"</span>) {
                            coverId = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"content"</span>)
                        }
                    }

                    <span class="hljs-comment">// 处理清单 (Manifest)</span>
                    <span class="hljs-string">"item"</span> -&gt; {
                        <span class="hljs-comment">// &lt;item id="..." href="..." media-type="..."/&gt;</span>
                        <span class="hljs-keyword">val</span> id = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"id"</span>)
                        <span class="hljs-keyword">val</span> href = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"href"</span>)
                        <span class="hljs-keyword">val</span> mediaType = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"media-type"</span>)

                        <span class="hljs-keyword">if</span> (id != <span class="hljs-literal">null</span> &amp;&amp; href != <span class="hljs-literal">null</span> &amp;&amp; mediaType != <span class="hljs-literal">null</span>) {
                            manifestMap[id] = ManifestItem(href, mediaType)
                        }
                    }

                    <span class="hljs-comment">// --- 3. 处理脊骨 (Spine) ---</span>
                    <span class="hljs-string">"itemref"</span> -&gt; {
                        <span class="hljs-comment">// &lt;itemref idref="..."/&gt;</span>
                        <span class="hljs-keyword">val</span> idref = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"idref"</span>)
                        <span class="hljs-keyword">if</span> (idref != <span class="hljs-literal">null</span>) {
                            spineIdRefs.add(idref)
                        }
                    }
                }
            }
        }
        eventType = parser.next()
    }


    <span class="hljs-comment">// 解析封面路径：利用 coverId 从 manifestMap 查找真实路径</span>
    <span class="hljs-keyword">val</span> finalCoverPath = coverId.let { id -&gt;
        manifestMap[id]?.href
    } ?: <span class="hljs-string">""</span>

    <span class="hljs-keyword">val</span> metadata = BookMetadata(
        title = title,
        authors = authors,
        description = description,
        language = language,
        cover = finalCoverPath, <span class="hljs-comment">// 真实路径</span>
        publisher = publisher,
        categories = categories
    )

    <span class="hljs-keyword">val</span> bookSpineItems = spineIdRefs.mapNotNull { idref -&gt;
        <span class="hljs-keyword">val</span> item = manifestMap[idref]
        <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) {
            BookSpineItem(
                id = idref,
                href = item.href,
                mediaType = item.mediaType
            )
        } <span class="hljs-keyword">else</span> {
            Log.w(<span class="hljs-string">"OpfParser"</span>, <span class="hljs-string">"Spine item '<span class="hljs-variable">$idref</span>' not found in manifest."</span>)
            <span class="hljs-literal">null</span>
        }
    }

    <span class="hljs-keyword">return</span> Pair(metadata, bookSpineItems)
}

<span class="hljs-comment">// 防止空标签导致异常</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">safeNextText</span><span class="hljs-params">(parser: <span class="hljs-type">XmlPullParser</span>)</span></span>: String {
    <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> (parser.next() == XmlPullParser.TEXT) {
        result = parser.text
        parser.nextTag() <span class="hljs-comment">// 移至 END_TAG</span>
    }
    <span class="hljs-keyword">return</span> result
}
</code></pre>
<p>测试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch(Dispatchers.IO) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"OEBPS/content.opf"</span>)

        <span class="hljs-keyword">val</span> (metadata, spine) = parseOpf(inputStream)

        println(<span class="hljs-string">"=== 书籍信息 ==="</span>)
        println(<span class="hljs-string">"标题: <span class="hljs-subst">${metadata.title}</span>"</span>)
        println(<span class="hljs-string">"作者: <span class="hljs-subst">${metadata.authors}</span>"</span>)
        println(<span class="hljs-string">"封面路径: <span class="hljs-subst">${metadata.cover}</span>"</span>)
        println(<span class="hljs-string">"简介: <span class="hljs-subst">${metadata.description.take(<span class="hljs-number">100</span>)}</span>..."</span>)

        println(<span class="hljs-string">"\n=== 章节列表 (Spine) ==="</span>)
        spine.forEach { item -&gt;
            println(<span class="hljs-string">"ID: <span class="hljs-subst">${item.id.padEnd(<span class="hljs-number">15</span>)}</span> | Type: <span class="hljs-subst">${item.mediaType.padEnd(<span class="hljs-number">25</span>)}</span> | Path: <span class="hljs-subst">${item.href}</span>"</span>)
        }
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">===</span> <span class="hljs-string">书籍信息</span> <span class="hljs-string">===</span>
<span class="hljs-string">标题:</span> <span class="hljs-string">男女之间存在纯友情吗？（不，不存在！）</span> <span class="hljs-string">第一卷</span> <span class="hljs-string">Flag1.不然到三十岁还单身就跟我在一起吧？</span>
<span class="hljs-string">作者:</span> [<span class="hljs-string">七菜なな</span>, <span class="hljs-string">Parum</span>]
<span class="hljs-string">封面路径:</span> <span class="hljs-string">Images/157909.jpg</span>
<span class="hljs-string">简介:</span> <span class="hljs-string">在某一所乡村国中，一对男女向彼此立下永恒友情的誓言。</span>
<span class="hljs-string">朝着同一个梦想前进，成为命运共同体的两人之间──</span>
<span class="hljs-string">关系并没有任何特别的发展，就这么度过了两年的岁月……！</span>
<span class="hljs-string">至今都还没谈过初恋的</span> <span class="hljs-string">High</span> <span class="hljs-string">咖女子─...</span>
<span class="hljs-string">===</span> <span class="hljs-string">章节列表</span> <span class="hljs-string">(Spine)</span> <span class="hljs-string">===</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">Cover.xhtml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/Cover.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter0.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter0.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter1.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter1.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter2.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter2.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter3.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter3.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter4.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter4.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter5.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter5.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter6.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter6.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter7.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter7.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">Credits.xhtml</span>   <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/Credits.xhtml</span>
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>关于解析的内容就到这里，我们来总结一下 EPUB 阅读器的解析流程：</p>
<ol>
<li>获取 EPUB 电子书的 Uri。</li>
<li>使用 <code>ZipInputStream</code> 读取这个压缩文件（节省空间）。</li>
<li>在 Zip 流中找到 <code>META-INF/container.xml</code> 文件，解析出 <code>.opf</code> 文件的相对路径。</li>
<li>从 OPF 文件中解析出书籍元数据，以及阅读顺序（书籍目录）。</li>
<li>最后，在渲染内容时，根据路径找到内容文件，使用 <code>Jsoup</code> 解析 HTML 即可。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置]]></title>    <link>https://juejin.cn/post/7576821684252016683</link>    <guid>https://juejin.cn/post/7576821684252016683</guid>    <pubDate>2025-11-26T09:24:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252016683" data-draft-id="7576841976927993892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-26T09:24:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:24:52.000Z" title="Wed Nov 26 2025 09:24:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c35e9c8d2f43f09a8c45c7858d7513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=vVZYOE1xotETMxheo5tMCO8v%2FXg%3D" alt="image-20251126172101658" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在开始写代码之前，我已经将官网上的核心概念大致扫了一遍，<a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2Fconcept%2F%25EF%25BC%258C%25E8%25AF%25B4%25E5%25AE%259E%25E8%25AF%259D%25EF%25BC%258C%25E4%25B8%258D%25E7%259F%25A5%25E6%2589%2580%25E4%25BA%2591%25EF%25BC%258C%25E4%25B8%258E%25E6%2588%2591%25E4%25B9%258B%25E5%2589%258D%25E7%2586%259F%25E6%2582%2589%25E7%259A%2584" target="_blank" title="https://tauri.app/zh-cn/concept/%EF%BC%8C%E8%AF%B4%E5%AE%9E%E8%AF%9D%EF%BC%8C%E4%B8%8D%E7%9F%A5%E6%89%80%E4%BA%91%EF%BC%8C%E4%B8%8E%E6%88%91%E4%B9%8B%E5%89%8D%E7%86%9F%E6%82%89%E7%9A%84" ref="nofollow noopener noreferrer">tauri.app/zh-cn/conce…</a> <code>web</code> 端相差甚远，不过我好像摸到了一些门路，以下都是我个人见解，可能有所偏差，欢迎指正。<code>Tauri</code> 开发的应用程序分为两个部分，前端和后端，其实本质上也是 C/S 架构。前端就和之前 <code>web</code> 开发一样，你可以选择自己擅长的 UI 框架，而后端则是基于 <code>Rust</code> 来做的，可以完成业务逻辑操作，系统调用等等。我的脑海里目前结构是这样的，对应代码的目录，前端就是 <code>src</code> 下的代码，后端就是 <code>src-tauri</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6e3236740745338f15aafefbba6ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=hwimUXiBU0In96rVZE4EX9B3l6w%3D" alt="image-20251126112339786" loading="lazy"/></p>
<p>看到这其实就比较熟悉了，把 <code>Rust</code> 换成我们熟悉的 <code>Java</code>，又回到了 <code>web</code> 开发的模式了。当然如果你愿意深入学习 <code>Rust</code>，完全用 <code>Rust</code> 来构建服务端也是可以的。</p>
<p>所以最后实际上我的项目就变成了这样。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d6d0b6d4eaa48878d653b986e55d88c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=n835ZsPkv2diTIKKQT99%2Bg01KA8%3D" alt="image-20251126113509775" loading="lazy"/></p>
<p>这就很熟悉了，<code>Tauri</code> 似乎只是简单的套壳了。后来仔细想想好像也不是，相比于 <code>Web</code> 端多了一些访问系统原生 <code>Api</code> 的能力。</p>
<p>✅ <strong>Vue3</strong>：前端开发体验好</p>
<p>✅ <strong>Java 后端</strong>：成熟稳定，开发效率高</p>
<p>✅ <strong>Tauri</strong>：提供桌面应用外壳，未来可扩展系统功能</p>
<h2 data-id="heading-1">二、技术栈选择</h2>
<h3 data-id="heading-2">前端（Tauri）：</h3>
<ul>
<li>Vue3 + TypeScript</li>
<li>UI 组件库：Ant Design  Vue</li>
<li>HTTP 客户端：axios</li>
<li>状态管理：Pinia</li>
</ul>
<h3 data-id="heading-3">后端（Java）：</h3>
<ul>
<li>
<p>Spring Boot + Sa-Token</p>
</li>
<li>
<p>数据库：PostgreSQL + MyBatis-Plus</p>
</li>
<li>
<p>API 文档：Swagger</p>
</li>
<li>
<p>部署：Docker + 云服务器</p>
</li>
</ul>
<blockquote>
<p>截止目前 2025.11.26 我会使用当前所有最新稳定版本进行开发。我建议是我当前的文章作为辅助，以官方文档为主，我会在关键位置给出文档链接。</p>
</blockquote>
<h2 data-id="heading-4">三、完成前后端数据交互</h2>
<h3 data-id="heading-5">3.1. 目录机构规划</h3>
<p>首先和常规 <code>Vue</code> 项目一样，规划好我们的目录结构，大致如下</p>
<pre><code class="hljs language-bash" lang="bash">src               
├─ api            <span class="hljs-comment"># API 接口   </span>
├─ assets          <span class="hljs-comment"># 静态资源</span>
├─ components       <span class="hljs-comment"># 通用组件   </span>
├─ layouts         <span class="hljs-comment"># 布局组件     </span>
├─ router          <span class="hljs-comment"># 路由配置  </span>
├─ stores      		 <span class="hljs-comment"># 状态管理(Pinia)  </span>
├─ utils      		 <span class="hljs-comment"># 工具函数 </span>
├─ views     		 <span class="hljs-comment"># 页面组件     </span>
├─ App.vue        
├─ main.ts        
└─ vite-env.d.ts  

</code></pre>
<h3 data-id="heading-6">3.2. 安装整合常用依赖</h3>
<p>安装所有依赖</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Vue 生态</span>
pnpm add vue-router@4 pinia pinia-plugin-persistedstate
<span class="hljs-comment"># UI 组件库 (Ant Design Vue)</span>
pnpm add ant-design-vue@4.x @ant-design/icons-vue
<span class="hljs-comment"># 样式预处理</span>
pnpm add install less 
<span class="hljs-comment"># HTTP 客户端</span>
pnpm add install axios
</code></pre>
<p>一键安装所有</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add vue-router@4 pinia pinia-plugin-persistedstate ant-design-vue@4.x @ant-design/icons-vue less  axios
</code></pre>
<h4 data-id="heading-7">3.2.1. 整合 Ant Design Vue</h4>
<blockquote>
<p>这里我希望能够实现自动按需导入，官方文档这里写的不够清楚，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.antdv.com%2Fdocs%2Fvue%2Fgetting-started-cn%25E3%2580%2582%25E6%2588%2591%25E4%25BB%25AC%25E5%258F%25AF%25E4%25BB%25A5%25E5%2580%259F%25E5%258A%25A9" target="_blank" title="https://www.antdv.com/docs/vue/getting-started-cn%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%80%9F%E5%8A%A9" ref="nofollow noopener noreferrer">www.antdv.com/docs/vue/ge…</a> <code>unplugin-vue-components</code> 和 <code>unplugin-auto-import</code>这两款插件来完成。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">pnpm install -D unplugin-vue-components unplugin-auto-import
</code></pre>
<p>在插件的 <code>GitHub</code> 仓库中可以看到是支持的，所以无需担心。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funplugin%2Funplugin-auto-import" target="_blank" title="https://github.com/unplugin/unplugin-auto-import" ref="nofollow noopener noreferrer">github.com/unplugin/un…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funplugin%2Funplugin-vue-components" target="_blank" title="https://github.com/unplugin/unplugin-vue-components" ref="nofollow noopener noreferrer">github.com/unplugin/un…</a></p>
<p><strong>在 <code>vite.config.js</code> 中配置按需引入：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AntDesignVueResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-title class_">AutoImport</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">AntDesignVueResolver</span>()],
    }),
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [
        <span class="hljs-title class_">AntDesignVueResolver</span>({
           <span class="hljs-attr">importStyle</span>: <span class="hljs-string">'less'</span>, <span class="hljs-comment">// 使用 less</span>
        }),
      ],
    }),
  ],
})
</code></pre>
<blockquote>
<p>这里要注意， 必须用 <code>less</code></p>
</blockquote>
<p>随便找一个组件，测试一下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0834b46076024be48455c818b6b990ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=6%2FMVZNzjYD68VOeuynUf2SxCwIU%3D" alt="image-20251126153900116" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2. 整合 Vue Router</h4>
<p>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Finstallation.html" target="_blank" title="https://router.vuejs.org/zh/installation.html" ref="nofollow noopener noreferrer">router.vuejs.org/zh/installa…</a></p>
<p>创建路由实例 <code>router/index.js</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">HomeView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HomeView.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AboutView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AboutView.vue'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
    <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),
    <span class="hljs-attr">routes</span>: [
        { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeView</span> },
        { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">AboutView</span> },
    ]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router

</code></pre>
<blockquote>
<p>为了方便测试，我定义了两个页面组件。</p>
</blockquote>
<p><code>main.ts</code> 中注册路由</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App.vue"</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>


<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">"#app"</span>);

</code></pre>
<p>在 <code>app.vue</code> 中测试</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;h1&gt;Hello App!&lt;/h1&gt;
  &lt;p&gt;&lt;strong&gt;Current route path:&lt;/strong&gt; {{ $route.fullPath }}&lt;/p&gt;
  &lt;nav&gt;
    &lt;RouterLink to="/"&gt;Go to Home&lt;/RouterLink&gt;
    &lt;RouterLink to="/about"&gt;Go to About&lt;/RouterLink&gt;
  &lt;/nav&gt;
  &lt;main&gt;
    &lt;RouterView /&gt;
  &lt;/main&gt;
&lt;/template&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8e06f1842ad4659a32549bc0cae73bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=25BdHKyoEbylpWLuWo%2B3MDabM1c%3D" alt="PixPin_2025-11-26_16-14-56.gif" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3. 整合 pinia &amp; pinia-plugin-persistedstate</h4>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2Fzh%2Fintroduction.html" target="_blank" title="https://pinia.vuejs.org/zh/introduction.html" ref="nofollow noopener noreferrer">pinia.vuejs.org/zh/introduc…</a></p>
<p><strong>按模块化定义 store</strong>，以下为目录结构</p>
<pre><code class="hljs">stores         
├─ modules     
│  └─ user.ts  
└─ index.ts    
</code></pre>
<ul>
<li>创建 <code>src/stores/index.ts</code></li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store
</code></pre>
<ul>
<li><code>main.ts</code> 里引入</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//main.ts</span>
...
<span class="hljs-comment">// 引入 pinia</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(store)
...
</code></pre>
<ul>
<li>modules: 按模块定义对应的 store, user.ts 表示用户相关数据存储的仓库</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// user.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 你可以对 `defineStore()` 的返回值进行任意命名，但最好使用 store 的名字，同时以 `use` 开头且以 `Store` 结尾。(比如 `useUserStore`，`useCartStore`，`useProductStore`)</span>
<span class="hljs-comment">// 第一个参数是你的应用中 Store 的唯一 ID。</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserInfoStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'userInfo'</span>, {
    <span class="hljs-comment">// 其他配置...</span>
})
</code></pre>
<blockquote>
<p><strong>在引入 pinia 的时候做一些调整，不直接在 main.ts 里引入，这样做的好处在于，之后对于 pinia 集成一些插件，或者做一些其他配置，可以独立出来，不用全部堆积在 main.ts 中</strong></p>
</blockquote>
<ul>
<li>使用 <code>pinia-plugin-persistedstate</code> 持久化</li>
</ul>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpraz.codeberg.page%2Fpinia-plugin-persistedstate%2Fguide%2F%23usage" target="_blank" title="https://praz.codeberg.page/pinia-plugin-persistedstate/guide/#usage" ref="nofollow noopener noreferrer">praz.codeberg.page/pinia-plugi…</a></p>
<blockquote>
<p>在 <code>web</code> 端的时候可以用 <code>LocalStorage</code>、<code>SessionStorage</code> 等，但是桌面端我就不确定了，我去搜了一下，据说是支持 <code>LocalStorage</code> 的，但是有局限性，推荐了一个 <code>Tauri Store</code>，这个等到具体使用的时候再去研究，今天任务就是先整合上。</p>
</blockquote>
<p>将插件添加到 <code>pinia</code> 实例上</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ./stores/index.ts</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>()

store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store
</code></pre>
<p>只需要在定义的 <code>store</code> 里开启配置即可完成持久化操作</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserInfoStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'userInfo'</span>, {
    <span class="hljs-comment">// 其他配置...</span>
    <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>   
})
</code></pre>
<blockquote>
<p>默认使用的就是 <code>LocalStorage</code>，这里我暂时不测试了，等到用的时候替换为 <code>Tauri Store</code> 再研究。</p>
</blockquote>
<h4 data-id="heading-10">3.2.4. 整合 Axios</h4>
<p>定义请求实例，这里我直接从之前项目中拷贝过来的，基本上都差不多。</p>
<p>创建 <code>utils/request.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue'</span>
<span class="hljs-keyword">import</span> axios, { <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosInstance</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosRequestConfig</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RequestConfig</span>&lt;T = <span class="hljs-built_in">unknown</span>&gt; = <span class="hljs-title class_">AxiosRequestConfig</span> &amp; {
    <span class="hljs-comment">// 可以在这里扩展自定义配置</span>
    mock?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否使用mock数据</span>
    mockData?: T <span class="hljs-comment">// mock数据</span>
    noErrorToast?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否不显示错误提示</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">AxiosInstance</span> <span class="hljs-comment">// axios实例</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span> = axios.<span class="hljs-title function_">create</span>({
            <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_BASE_API</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-number">180000</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json;charset=UTF-8'</span>,
            },
        })

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupInterceptors</span>()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">setupInterceptors</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 请求拦截器</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
            <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> config,
            <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error),
        )

        <span class="hljs-comment">// 响应拦截器</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
            <span class="hljs-function">(<span class="hljs-params">response: AxiosResponse</span>) =&gt;</span> {
                <span class="hljs-comment">// 业务状态码处理</span>
                <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>) {
                    <span class="hljs-keyword">const</span> config = response.<span class="hljs-property">config</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span>
                    <span class="hljs-keyword">if</span> (!config.<span class="hljs-property">noErrorToast</span>) {
                        message.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>)
                    }
                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(response.<span class="hljs-property">data</span>)
                }
                <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>
            },
            <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                <span class="hljs-comment">// 处理mock数据</span>
                <span class="hljs-keyword">if</span> (error.<span class="hljs-property">isMock</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(error.<span class="hljs-property">data</span>)
                }
                <span class="hljs-keyword">const</span> config = error.<span class="hljs-property">config</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span> | <span class="hljs-literal">undefined</span>

                <span class="hljs-comment">// 只有配置了不跳过错误处理时才显示错误提示</span>
                <span class="hljs-keyword">if</span> (!config?.<span class="hljs-property">noErrorToast</span>) {
                    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">'请求错误'</span>
                    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>) {
                        <span class="hljs-keyword">switch</span> (error.<span class="hljs-property">response</span>.<span class="hljs-property">status</span>) {
                            <span class="hljs-keyword">case</span> <span class="hljs-number">400</span>:
                                msg = <span class="hljs-string">'请求参数错误'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                                msg = <span class="hljs-string">'未授权，请登录'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
                                msg = <span class="hljs-string">'拒绝访问'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
                                msg = <span class="hljs-string">'请求资源不存在'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
                                msg = <span class="hljs-string">'服务器异常，请稍后再试'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-attr">default</span>:
                                msg = error.<span class="hljs-property">response</span>.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> || <span class="hljs-string">`服务器错误: <span class="hljs-subst">${error.response.status}</span>`</span>
                        }
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">request</span>) {
                        msg = <span class="hljs-string">'请求超时或网络异常'</span>
                    } <span class="hljs-keyword">else</span> {
                        msg = error.<span class="hljs-property">message</span> || <span class="hljs-string">'未知错误'</span>
                    }
                    message.<span class="hljs-title function_">error</span>(msg)
                }
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
            },
        )
    }

    <span class="hljs-comment">// 封装核心请求方法</span>
    <span class="hljs-keyword">public</span> request&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-comment">// 模拟数据直接返回</span>
        <span class="hljs-keyword">if</span> (config.<span class="hljs-property">mock</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(config.<span class="hljs-property">mockData</span> <span class="hljs-keyword">as</span> T)
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">instance</span>(config)
    }

    <span class="hljs-keyword">public</span> get&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>, url })
    }

    <span class="hljs-keyword">public</span> post&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, url, data })
    }

    <span class="hljs-keyword">public</span> put&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, url, data })
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delete</span>&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span>, url, data })
    }
}

<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http

</code></pre>
<p>定义个接口测试一下</p>
<p>创建 <code>api/user.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/request'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userApi = {
    <span class="hljs-comment">// 获取用户列表</span>
    <span class="hljs-attr">getUserInfo</span>: <span class="hljs-function">() =&gt;</span>
        http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/user/info'</span>),

}
</code></pre>
<p>在 <code>app.vue</code> 中测试</p>
<pre><code class="hljs language-vue" lang="vue">&lt;a-button type="primary" @click="getUserInfo"&gt;获取用户信息&lt;/a-button&gt;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { userApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'./api/user'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  userApi.<span class="hljs-title function_">getUserInfo</span>()
}

&lt;/script&gt;
</code></pre>
<p>在应用窗口点击按钮，按 <code>F12</code>，看到请求出去了，即表示成功了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c94b2860a83481989b65ee375b7eab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=9AHuJDg4NYLVweMEeAH43fnOW3Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">四、总结</h2>
<p>到头来发现又回到了熟悉的领域，如果你不想做成桌面端，直接使用 vue 脚手架搭建项目，所有整合步骤几乎一模一样。今天就先这样，现在有个问题，先做前端用 <code>mock</code> 数据做接口，完成基础功能后，再开发服务端，还是直接同时进行。如果有人看到这里，你希望采用哪种方式呢？欢迎留言。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CopilotKit-丝滑连接agent和应用-理论篇]]></title>    <link>https://juejin.cn/post/7576646142315495465</link>    <guid>https://juejin.cn/post/7576646142315495465</guid>    <pubDate>2025-11-26T03:11:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142315495465" data-draft-id="7573486671296790570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CopilotKit-丝滑连接agent和应用-理论篇"/> <meta itemprop="keywords" content="前端,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-11-26T03:11:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="let_code"/> <meta itemprop="url" content="https://juejin.cn/user/4265760847307678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CopilotKit-丝滑连接agent和应用-理论篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4265760847307678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    let_code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:11:52.000Z" title="Wed Nov 26 2025 03:11:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CopilotKit是什么</h2>
<p><code>CopilotKit</code> 将应用的逻辑、状态和用户上下文连接到 <code>AI</code> 代理。提供了构建、部署和监控 <code>AI</code> 辅助功能的工具，这些功能感觉直观、有用且深度集成。</p>
<h2 data-id="heading-1">CopilotKit特点</h2>
<ul>
<li><code>Generative UI</code>(生成式 UI)：使用自定义 UI 组件实时呈现<code>agent</code>的状态、进度、输出和工具调用。</li>
<li><code>Human in the Loop</code>(人机协同)：用户可以在关键点指导<code>agent</code>。实现更可靠的输出。</li>
<li><code>Shared State</code>(共享状态)：agent和应用状态保持同步。<code>agent</code>可以查看应用中的所有状态，应用可以实时响应<code>agent</code>。</li>
</ul>
<h2 data-id="heading-2">CopilotKit和LangGraph的关系</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adb67101b1754134b048eda4e40a8540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGV0X2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764731511&amp;x-signature=NOWH6B6nYzD30Eb%2BjSq1maA7XRM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">聊天组件</h2>
<p>前三个组件由<code>@copilotkit/react-ui</code>提供。</p>
<ol>
<li><code>CopilotChat</code> ：灵活的聊天界面组件。</li>
<li><code>CopilotSidebar</code> ：可折叠和扩展的侧边栏聊天组件。</li>
<li><code>CopilotPopup</code> ： 可以打开和关闭的浮动聊天组件。</li>
<li><code>HeadLess UI</code> : 支持自定义组件。
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useCopilotChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Role</span>, <span class="hljs-title class_">TextMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/runtime-client-gql"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomChatInterface</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> {
    visibleMessages,
    appendMessage,
    setMessages,
    deleteMessage,
    reloadMessages,
    stopGeneration,
    isLoading,
} = <span class="hljs-title function_">useCopilotChat</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = (<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-title function_">appendMessage</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>({ content, <span class="hljs-attr">role</span>: <span class="hljs-title class_">Role</span>.<span class="hljs-property">User</span> }));
};

<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    {/* Implement your custom chat UI here */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">设置聊天组件的样式</h3>
<ul>
<li>样式：主要思路是通过<strong>样式覆盖</strong>的方式进行组件样式的设定。支持通过css变量、css类的方式进行组件样式和字体的定义。</li>
<li>图标：通过组件的<code>icons</code>属性进行定义。</li>
<li>标签：通过组件的<code>labels</code>属性进行自定义。</li>
</ul>
<p>具体类名、变量名、icons属性、labels属性<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.copilotkit.ai%2Flanggraph%2Fcustom-look-and-feel%2Fcustomize-built-in-ui-components%23css-variables-easiest" target="_blank" title="https://docs.copilotkit.ai/langgraph/custom-look-and-feel/customize-built-in-ui-components#css-variables-easiest" ref="nofollow noopener noreferrer">参考这里</a></p>
<h3 data-id="heading-5">自定义子组件</h3>
<p>支持通过组件的<code>props</code>将自定义的子组件传递进去，从而实现子组件的自定义。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { type <span class="hljs-title class_">AssistantMessageProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { useChatContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Markdown</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SparklesIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@heroicons/react/24/outline"</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotSidebar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@copilotkit/react-ui/styles.css"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CustomAssistantMessage</span> = (<span class="hljs-params">props: AssistantMessageProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> { icons } = <span class="hljs-title function_">useChatContext</span>();
  <span class="hljs-keyword">const</span> { message, isLoading, subComponent } = props;

  <span class="hljs-keyword">const</span> avatarStyles = <span class="hljs-string">"bg-zinc-400 border-zinc-500 shadow-lg min-h-10 min-w-10 rounded-full text-white flex items-center justify-center"</span>;
  <span class="hljs-keyword">const</span> messageStyles = <span class="hljs-string">"px-4 rounded-xl pt-2"</span>;

  <span class="hljs-keyword">const</span> avatar = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{avatarStyles}</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">SparklesIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-6 w-6"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"py-2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-start"</span>&gt;</span>
        {!subComponent &amp;&amp; avatar}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{messageStyles}</span>&gt;</span>
          {message &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Markdown</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{message.content</span> || ""} /&gt;</span> }
          {isLoading &amp;&amp; icons.spinnerIcon}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"my-2"</span>&gt;</span>{subComponent}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};


<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CopilotKit</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CopilotSidebar</span> <span class="hljs-attr">AssistantMessage</span>=<span class="hljs-string">{CustomAssistantMessage}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">CopilotKit</span>&gt;</span></span>
</code></pre>
<p>子组件包括：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f9933b815f4cb9b26dccbc18c95b94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGV0X2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764731511&amp;x-signature=zXAVBmOlJGjLy%2FfXYE3t%2FDo9a7A%3D" alt="image.png" loading="lazy"/></p>
<p>除此之外，markdown的渲染默认使用<code>react-markdown</code>。支持通过<code>markdownTagRenderers</code>属性来自定义markdown渲染组件。</p>
<h4 data-id="heading-6">Actions</h4>
<p>允许 LLM 与应用程序的功能交互。当 LLM 调用 Action 时，可以提供自定义组件来可视化其执行和结果。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span> <span class="hljs-comment">// only necessary if you are using Next.js with the App Router.</span>
<span class="hljs-keyword">import</span> { useCopilotAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Your custom components (examples - implement these in your app)</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoadingView</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./loading-view"</span>; <span class="hljs-comment">// Your loading component</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CalendarMeetingCardComponent</span>, type <span class="hljs-title class_">CalendarMeetingCardProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./calendar-meeting-card"</span>; <span class="hljs-comment">// Your meeting card component</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">YourComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useCopilotAction</span>({ 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"showCalendarMeeting"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Displays calendar meeting information"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"date"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Meeting date (YYYY-MM-DD)"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"time"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Meeting time (HH:mm)"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"meetingName"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Name of the meeting"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>
      }
    ],
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ status, args }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { date, time, meetingName } = args;
 
      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'inProgress'</span>) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoadingView</span> /&gt;</span></span>; <span class="hljs-comment">// Your own component for loading state</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">meetingProps</span>: <span class="hljs-title class_">CalendarMeetingCardProps</span> = {
          <span class="hljs-attr">date</span>: date,
          time,
          meetingName
        };
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CalendarMeetingCardComponent</span> {<span class="hljs-attr">...meetingProps</span>} /&gt;</span></span>;
      }
    },
  });
 
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>...<span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-7">Agent State</h4>
<p><code>Agent State</code>组件允许可视化 <code>CoAgents</code> 的内部状态和进度。使用 <code>CoAgents</code> 时，可以提供自定义组件来呈现代理的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span>; <span class="hljs-comment">// only necessary if you are using Next.js with the App Router.</span>
 
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Progress</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./progress"</span>;

type <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">logs</span>: string[];
}

useCoAgentStateRender&lt;<span class="hljs-title class_">AgentState</span>&gt;({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"basic_agent"</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state, nodeName, status }</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">logs</span> || state.<span class="hljs-property">logs</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// Progress is a component we are omitting from this example for brevity.</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Progress</span> <span class="hljs-attr">logs</span>=<span class="hljs-string">{state.logs}</span> /&gt;</span></span>; 
  },
});
</code></pre>
<h2 data-id="heading-8">前端工具</h2>
<p>前端工具指的是前端定义的函数可以被 agent 调用。当函数被 agent 调用时，函数在客户端执行，使agent可以直接访问前端环境，从而实现agent对UI的控制和人机交互。</p>
<p>前端工具可以轻松实现：</p>
<ol>
<li>读取或修改 React 组件状态</li>
<li>访问浏览器 API，如 localStorage、sessionStorage 或 cookie</li>
<li>触发 UI 更新或动画</li>
<li>与第三方前端库交互</li>
<li>执行需要用户即时浏览上下文的操作</li>
</ol>
<h3 data-id="heading-9">实现</h3>
<h4 data-id="heading-10">1.创建前端工具</h4>
<p>需要使用 <code>useFrontendTool</code> 钩子创建一个前端工具。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//page.tsx </span>
<span class="hljs-keyword">import</span> { useFrontendTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-title function_">useFrontendTool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sayHello"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Say hello to the user"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"name"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"The name of the user to say hello to"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    ],
    <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ name }) =&gt; {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>);
    },
  });

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-11">2.修改代理</h4>
<p>安装 CopilotKit SDK <code>npm install @copilotkit/sdk-js</code>。</p>
<p>要访问 CopilotKit 提供的前端工具，可以在代理的状态定义中继承 CopilotKitState ：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>之后，代理的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。</p>
<p>agent调用前端工具：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h2 data-id="heading-12">Generative UI</h2>
<p>用自定义 UI 组件实时呈现 agent 的状态、进度、输出和工具调用。</p>
<p>主要有三种方式使用生成式UI：</p>
<ol>
<li>后端工具：通过生成式UI组件渲染工具的调用</li>
<li>前端工具：为agent提供前端工具来显示自定义组件并且驱动UI</li>
<li>agent 状态：用自定义组件来显示agent的状态、进度和输出</li>
</ol>
<h3 data-id="heading-13">后端工具</h3>
<p>工具是 LLM 调用预定义的（通常是确定性函数）的一种方式。CopilotKit 允许在 UI 中将这些工具呈现为自定义组件，我们称之为生成式 UI。</p>
<p>简而言之就是允许我们向用户展示agent正在执行的操作，尤其是当我们调用工具时，允许完全自定义工具在聊天中的呈现方式。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">const</span> get_weather = <span class="hljs-title function_">tool</span>(
  <span class="hljs-function">(<span class="hljs-params">args</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`The weather for <span class="hljs-subst">${args.location}</span> is 70 degrees.`</span>;
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the weather for a given location."</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">location</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"The location to get weather for"</span>),
    }),
  }
);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> });
  <span class="hljs-keyword">const</span> modelWithTools = model.<span class="hljs-title function_">bindTools</span>([get_weather]); 

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> modelWithTools.<span class="hljs-title function_">invoke</span>([
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"You are a helpful assistant."</span>),
    ...state.<span class="hljs-property">messages</span>,
  ], config);

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>前端通过<code>useCopilotAction</code>钩子在UI中呈现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//page.tsx  </span>
<span class="hljs-keyword">import</span> { useRenderToolCall } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useRenderToolCall</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,<span class="hljs-comment">// 注意name保持一致</span>
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{status, args}</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>
          {status !== "complete" &amp;&amp; "Calling weather API..."}
          {status === "complete" &amp;&amp; `Called the weather API for ${args.location}.`}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
      );
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><code>useDefaultTool</code> 捕获所有没有专用渲染器的工具。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useDefaultTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useDefaultTool</span>({
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ name, args, status, result }</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> "<span class="hljs-attr">black</span>" }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
            {status === "complete" ? "✓" : "⏳"}
            {name}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          {status === "complete" &amp;&amp; result &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>{JSON.stringify(result, null, 2)}<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-14">前端工具</h3>
<p>定义 LangGraph agent 可以调用的客户端函数，执行完全在用户的浏览器中进行。当agent调用前端工具时，逻辑会在客户端运行，使agent可以直接访问前端环境。一般在agent需要和客户端交互时使用。</p>
<p>使用 <code>useFrontendTool</code> 钩子创建一个前端工具:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// page.tsx</span>
<span class="hljs-keyword">import</span> { useFrontendTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-title function_">useFrontendTool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sayHello"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Say hello to the user"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"name"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"The name of the user to say hello to"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    ],
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ name }</span>) {
      <span class="hljs-comment">// Handler returns the result of the tool call</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">currentURLPath</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>, <span class="hljs-attr">userName</span>: name };
    },
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ args }</span>) =&gt;</span> {
      <span class="hljs-comment">// Renders UI based on the data of the tool call</span>
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {args.name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>You're currently on {window.location.href}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    },
  });

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>agent 访问前端工具：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-comment">//现在，agent的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-15">agent 状态</h3>
<p>所有 LangGraph agent 都是状态化的。这意味着当 agent 通过节点时，一个状态对象会在它们之间传递，以保持会话的整体状态。CopilotKit 允许使用自定义 UI 组件(生成式 UI)在应用程序中呈现此状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { copilotkitEmitState, <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Search</span> = {
  <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">searches</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-title class_">Search</span>[]&gt;,
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  state.<span class="hljs-property">searches</span> = [
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Initial research"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Retrieving sources"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Forming an answer"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
  ];

  <span class="hljs-comment">// We can call copilotkit_emit_state to emit updated state</span>
  <span class="hljs-comment">// before a node finishes</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">copilotkitEmitState</span>(config, state);

  <span class="hljs-comment">// Simulate state updates</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> search <span class="hljs-keyword">of</span> state.<span class="hljs-property">searches</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
    search.<span class="hljs-property">done</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// We can also emit updates in a loop to simulate progress</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">copilotkitEmitState</span>(config, state);
  }

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>([
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({ <span class="hljs-attr">content</span>: <span class="hljs-string">"You are a helpful assistant."</span>}),
    ...state.<span class="hljs-property">messages</span>,
  ], config);
</code></pre>
<p>前端通过 <code>useCoAgentStateRender</code> 在聊天中呈现agent的状态:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;

<span class="hljs-comment">// For type safety, redefine the state of the agent. If you're using</span>
<span class="hljs-comment">// using LangGraph JS you can import the type here and share it.</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">searches</span>: {
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
  }[];
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// styles omitted for brevity</span>
  useCoAgentStateRender&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>, <span class="hljs-comment">// the name the agent is served as</span>
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        {state.searches?.map((search, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>
            {search.done ? "✅" : "❌"} {search.query}{search.done ? "" : "..."}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    ),
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>除此之外还允许在聊天之外呈现agent的状态:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">// Define the state of the agent, should match the state of the agent in your LangGraph.</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">searches</span>: {
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
  }[];
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>, <span class="hljs-comment">// the name the agent is served as</span>
  })

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* ... */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col gap-2 mt-4"</span>&gt;</span>
        {state.searches?.map((search, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-row"</span>&gt;</span>
            {search.done ? "✅" : "❌"} {search.query}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-16">Human in the Loop (HITL)</h2>
<p>用户与 agent 协作处理复杂任务。</p>
<p>主要有三种方式实现人机交互：</p>
<ol>
<li>基于中断</li>
<li>基于前端工具</li>
<li>基于节点</li>
</ol>
<h3 data-id="heading-17">基于中断</h3>
<h4 data-id="heading-18">基础</h4>
<p>需要一个状态属性来存储名称：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">// This is the state of the agent.</span>
<span class="hljs-comment">// It inherits from the CopilotKitState properties from CopilotKit.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">agentName</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>在LangGraph 代理中调用 interrupt：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { interrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-comment">// add the agent state definition from the previous step</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">agentName</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-keyword">const</span> agentName = state.<span class="hljs-property">agentName</span>
    ?? <span class="hljs-title function_">interrupt</span>(<span class="hljs-string">"Before we start, what would you like to call me?"</span>); 

    <span class="hljs-comment">// Tell the agent its name</span>
    <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
        <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant named <span class="hljs-subst">${agentName}</span>...`</span>,
    });

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>(
        [systemMessage, ...state.<span class="hljs-property">messages</span>],
        config
    );

    <span class="hljs-keyword">return</span> {
        ...state,
        agentName,
        <span class="hljs-attr">messages</span>: response,
    };
}
</code></pre>
<p>前端使用 <code>useLangGraphInterrupt</code> 钩子，为终中断提供一个要渲染的组件，然后使用用户的响应调用 resolve。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// styles omitted for brevity</span>
<span class="hljs-title function_">useLangGraphInterrupt</span>({
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{event.value}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                e.preventDefault();
                resolve((e.target as HTMLFormElement).response.value);
            }}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"response"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter your response"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
});
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* ... */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h4 data-id="heading-19">高级</h4>
<p>在代理中呈现多个中断事件时，UI 中的多个 <code>useLangGraphInterrupt</code> 钩子调用之间可能会发生冲突。出于这个原因，钩子可以接受一个 <code>enabled</code> 参数，该参数将有条件地应用它：</p>
<p>定义两个不同的中断，通过<code>type</code>进行区分：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { interrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-comment">// ... your full state definition</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  state.<span class="hljs-property">approval</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">interrupt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"approval"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"please approve"</span> }); 

  <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">agentName</span>) {
    state.<span class="hljs-property">agentName</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">interrupt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"ask"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"Before we start, what would you like to call me?"</span> }); 
  }

  <span class="hljs-comment">// Tell the agent its name</span>
  <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
    <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant...`</span>,
  });

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>(
    [systemMessage, ...state.<span class="hljs-property">messages</span>],
    config
  );

  <span class="hljs-keyword">return</span> {
    ...state,
    <span class="hljs-attr">messages</span>: response,
  };
}
</code></pre>
<p>前端定义多个处理程序：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ApproveComponent</span> = (<span class="hljs-params">{ content, onAnswer }: { content: <span class="hljs-built_in">string</span>; onAnswer: (approved: <span class="hljs-built_in">boolean</span>) =&gt; <span class="hljs-built_in">void</span> }</span>) =&gt; (
    <span class="hljs-comment">// styles omitted for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Do you approve?<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onAnswer(true)}&gt;Approve<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onAnswer(false)}&gt;Reject<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">AskComponent</span> = (<span class="hljs-params">{ question, onAnswer }: { question: <span class="hljs-built_in">string</span>; onAnswer: (answer: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span> }</span>) =&gt; (
<span class="hljs-comment">// styles omitted for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{question}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            e.preventDefault();
            onAnswer((e.target as HTMLFormElement).response.value);
        }}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"response"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter your response"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">enabled</span>: <span class="hljs-function">(<span class="hljs-params">{ eventValue }</span>) =&gt;</span> eventValue.<span class="hljs-property">type</span> === <span class="hljs-string">'ask'</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AskComponent</span> <span class="hljs-attr">question</span>=<span class="hljs-string">{event.value.content}</span> <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{answer</span> =&gt;</span> resolve(answer)} /&gt;</span>
        )
    });

    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">enabled</span>: <span class="hljs-function">(<span class="hljs-params">{ eventValue }</span>) =&gt;</span> eventValue.<span class="hljs-property">type</span> === <span class="hljs-string">'approval'</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ApproveComponent</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{event.value.content}</span> <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{answer</span> =&gt;</span> resolve(answer)} /&gt;</span>
        )
    });

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>选择自定义聊天 UI 时，某些情况可能需要预处理中断事件的传入值，甚至需要完全解析它而不显示其 UI。这可以使用 <code>handeer</code> 属性来实现，该属性不需要返回一个 React 组件。 处理程序的返回值将作为结果参数传递给 render 方法。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-comment">// We will assume an interrupt event in the following shape</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Department</span> = <span class="hljs-string">'finance'</span> | <span class="hljs-string">'engineering'</span> | <span class="hljs-string">'admin'</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationInterruptEvent</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'auth'</span>,
    <span class="hljs-attr">accessDepartment</span>: <span class="hljs-title class_">Department</span>,
}

<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> [userEmail, setUserEmail] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">email</span>: <span class="hljs-string">'example@user.com'</span> })
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>): { <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">department</span>: <span class="hljs-title class_">Department</span> } {
        <span class="hljs-comment">// ... an implementation of user fetching</span>
    }

    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// styles omitted for brevity</span>
    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ result, event, resolve }) =&gt; {
            <span class="hljs-keyword">const</span> { department } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByEmail</span>(userEmail)
            <span class="hljs-keyword">if</span> (event.<span class="hljs-property">value</span>.<span class="hljs-property">accessDepartment</span> === department || department === <span class="hljs-string">'admin'</span>) {
                <span class="hljs-comment">// Following the resolution of the event, we will not proceed to the render method</span>
                <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">code</span>: <span class="hljs-string">'AUTH_BY_DEPARTMENT'</span> })
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">return</span> { department, userId }
        },
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ result, event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Request for {event.value.type}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Members from {result.department} department cannot access this information<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You can request access from an administrator to continue.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resolve({ code: 'REQUEST_AUTH', data: { department: result.department, userId: result.userId } })}
                &gt;
                    Request Access
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resolve({ code: 'CANCEL' })}
                &gt;
                    Cancel
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    });
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* ... */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-20">基于前端工具</h3>
<p>前端工具可以用在多种方式上。其中一种方式是有人工介入的流程，工具的响应由用户的决定来控制。</p>
<p>在这个例子中，我们将模拟一个用于执行命令的“批准”流程。首先，使用<code>useHumanInTheLoop</code>钩子来创建一个提示用户批准的工具。</p>
<p>要访问由 CopilotKit 提供的前端工具，您可以在agent的状态定义中继承自 CopilotKitState:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>经上述操作，agent的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。接下来就可以调用前端工具方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.tsx</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-21">基于节点</h3>
<p>LangGraph 和 CopilotKit 现在都不鼓励使用基于节点的中断。从 LangGraph 0.2.57 开始，推荐的设置断点的方法是使用 interrupt 函数 ，因为它简化了人机交互模式。</p>
<p>想要了解可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.copilotkit.ai%2Flanggraph%2Fhuman-in-the-loop%2Fnode-flow" target="_blank" title="https://docs.copilotkit.ai/langgraph/human-in-the-loop/node-flow" ref="nofollow noopener noreferrer">这里</a></p>
<h2 data-id="heading-22">状态共享</h2>
<p>在 UI 和 LangGraph agent 状态之间创建双向连接。</p>
<h3 data-id="heading-23">读取agent状态</h3>
<p>不仅可以在聊天界面中使用实时代理状态，还可以在原生应用程序中使用。</p>
<p>LangGraph 是有状态的。在节点之间转换时，该状态将更新并传递到下一个节点。假设agent状态如下所示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">language</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  <span class="hljs-comment">// If language is not defined, use a default value.</span>
  <span class="hljs-keyword">const</span> language = state.<span class="hljs-property">language</span> ?? <span class="hljs-string">'spanish'</span>

  <span class="hljs-comment">// ... add the rest of the node implementation and use the language variable</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// ... add the rest of state to return</span>
    <span class="hljs-comment">// return the language to make it available for the next nodes &amp; frontend to read</span>
    language
  }
}
</code></pre>
<p>前端调用 <code>useCoAgent</code> 钩子，传递agent的名称，并选择性地提供初始状态：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//pages.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// style excluded for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Your main content<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> // [!code highlight]
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong><code>useCoAgent</code> 中的状态是响应式的，当代理的状态发生变化时会自动更新</strong></p>
<h4 data-id="heading-24">在聊天中渲染 agent 状态</h4>
<p>可以使用 <code>useCoAgentStateRender</code> 钩子。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useCoAgentStateRender</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">language</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong><code>useCoAgentStateRender</code> 中的状态是响应式的，当代理的状态发生变化时会自动更新。</strong></p>
<h3 data-id="heading-25">写入agent状态</h3>
<p>假设 agent 状态：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agebt.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">language</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p><code>useCoAgent</code> 返回一个 <code>setState</code> 函数，您可以使用该函数来更新代理状态。调用这个将更新代理状态并触发依赖于代理状态的任何内容的重新渲染。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-comment">// Example usage in a pseudo React component</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state, setState } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleLanguage</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">language</span>: state.<span class="hljs-property">language</span> === <span class="hljs-string">"english"</span> ? <span class="hljs-string">"spanish"</span> : <span class="hljs-string">"english"</span> }); 
  };

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// style excluded for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Your main content<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleLanguage}</span>&gt;</span>Toggle Language<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-26">高级用法</h4>
<h5 data-id="heading-27">重新运行agent，并提示更改内容</h5>
<p>新的 agent 状态将在下次 agent 运行时使用。如果您想手动重新运行它，请在<code>useCoAgent</code>钩子上使用<code>run</code>参数。
agent将重新运行，它不仅会获得最新的更新状态，还会获得可能取决于以前状态和当前状态之间的数据增量的提示 。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TextMessage</span>, <span class="hljs-title class_">MessageRole</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/runtime-client-gql"</span>;  

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state, setState, run } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// setup to be called when some event in the app occurs</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleLanguage</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> newLanguage = state.<span class="hljs-property">language</span> === <span class="hljs-string">"english"</span> ? <span class="hljs-string">"spanish"</span> : <span class="hljs-string">"english"</span>;
    <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">language</span>: newLanguage });

    <span class="hljs-comment">// re-run the agent and provide a hint about what's changed</span>
    <span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">{ previousState, currentState }</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-title class_">MessageRole</span>.<span class="hljs-property">User</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`the language has been updated to <span class="hljs-subst">${currentState.language}</span>`</span>,
      });
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// ...</span>
  );
}
</code></pre>
<h3 data-id="heading-28">agent状态输入和输出</h3>
<p>有些属性是内部处理的，而另一些则是 UI 传递用户输入的方式。此外，有些状态属性包含大量信息。在agent和 UI 之间来回同步它们可能成本高昂，而且可能没有实际好处。</p>
<p>假设状态如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
  <span class="hljs-attr">question</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;, <span class="hljs-comment">//期望LLM回答的问题</span>
  <span class="hljs-attr">answer</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,<span class="hljs-comment">//LLM回应的答案</span>
  <span class="hljs-attr">resources</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,<span class="hljs-comment">//用于LLM回答问题，不应向用户同步</span>
})
</code></pre>
<p>agent定义输入输出：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

  <span class="hljs-comment">// Divide the state to 3 parts</span>

  <span class="hljs-comment">// An input schema for inputs you are willing to accept from the frontend</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">InputAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">question</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  });

  <span class="hljs-comment">// Output schema for output you are willing to pass to the frontend</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">OutputAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">answer</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  });

  <span class="hljs-comment">// The full schema, including the inputs, outputs and internal state ("resources" in our case)</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    ...<span class="hljs-title class_">OutputAnnotation</span>.<span class="hljs-property">spec</span>,
    ...<span class="hljs-title class_">InputAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">resources</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,
  });

  <span class="hljs-comment">// Define a typed state that supports the entire</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">answerNode</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>()

    <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
      <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant. Answer the question: <span class="hljs-subst">${state.question}</span>.`</span>,
    });

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> modelWithTools.<span class="hljs-title function_">invoke</span>(
      [systemMessage, ...state.<span class="hljs-property">messages</span>],
      config
    );

    <span class="hljs-comment">// ...add the rest of the agent implementation</span>
    <span class="hljs-comment">// extract the answer, which will be assigned to the state soon</span>
    <span class="hljs-keyword">const</span> answer = response.<span class="hljs-property">content</span>

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">messages</span>: response,
      <span class="hljs-comment">// include the answer in the returned state</span>
      answer,
    }
  }

  <span class="hljs-comment">// finally, before compiling the graph, we define the 3 state components</span>
  <span class="hljs-keyword">const</span> workflow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>({
    <span class="hljs-attr">input</span>: <span class="hljs-title class_">InputAnnotation</span>,
    <span class="hljs-attr">output</span>: <span class="hljs-title class_">OutputAnnotation</span>,
    <span class="hljs-comment">// @ts-expect-error -- LangGraph does not expect a "full schema with internal properties".</span>
    <span class="hljs-attr">stateSchema</span>: <span class="hljs-title class_">AgentStateAnnotation</span>,
  })
    .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"answer_node"</span>, answerNode) <span class="hljs-comment">// add all the different nodes and edges and compile the graph</span>
    .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"answer_node"</span>)
    .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"answer_node"</span>, <span class="hljs-variable constant_">END</span>)
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> graph = workflow.<span class="hljs-title function_">compile</span>()
</code></pre>
<h3 data-id="heading-29">预测状态更新</h3>
<p>一个LangGraph agent的状态更新是不连续的；仅在图中的节点转换之间进行。但是，图中单个节点运行往往需要许多秒，并且包含用户感兴趣的子步骤。</p>
<p>预测状态更新帮助我们向用户尽可能连续的反应 agent 正在执行的操作。</p>
<p>当你的LangGraph中的节点执行完毕时，其返回的状态成为唯一的真实来源。虽然中间状态更新对于实时反馈很有帮助，但任何你想持久化的更改都必须明确地包含在节点的最终返回状态中。否则，它们将在节点完成时被覆盖。</p>
<p>在状态中定义一个 <code>observed_steps</code> 字段，该字段将在agent编写报告的不同部分时更新。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,  <span class="hljs-comment">// Array of completed steps</span>
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>有两种发出状态更新的方式：手动预测和基于工具的预测。</p>
<h4 data-id="heading-30">手动预测状态更新</h4>
<p>对于长时间运行的任务，可以逐步发出状态更新，作为最终状态的预测。在这个例子中，我们通过执行一系列带有每次更新之间一秒延迟的步骤来模拟一个长时间运行的任务。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { copilotkitEmitState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">// Simulate executing steps one by one</span>
    <span class="hljs-keyword">const</span> steps = [
        <span class="hljs-string">"Analyzing input data..."</span>,
        <span class="hljs-string">"Identifying key patterns..."</span>,
        <span class="hljs-string">"Generating recommendations..."</span>,
        <span class="hljs-string">"Formatting final output..."</span>
    ];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> step <span class="hljs-keyword">of</span> steps) {
        state.<span class="hljs-property">observed_steps</span> = [...(state.<span class="hljs-property">observed_steps</span> ?? []), step];
        <span class="hljs-title function_">copilotkitEmitState</span>(config, state);
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
    }
}
</code></pre>
<p>这些预测将在代理运行时发出，允许您在确定最终状态之前跟踪其进度:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent, useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/react-core'</span>;

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-built_in">string</span>[];
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// Get access to both predicted and final states</span>
    <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span> });

    <span class="hljs-comment">// Add a state renderer to observe predictions</span>
    <span class="hljs-title function_">useCoAgentStateRender</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">observed_steps</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Current Progress:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
            );
        },
    });

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Agent Progress<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {state.observed_steps?.length &gt; 0 &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Final Steps:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-31">基于工具预测状态更新</h4>
<p>对于长时间运行的任务，您可以配置 CopilotKit 在执行特定工具调用时自动预测状态更新。在这个示例中，我们将配置 CopilotKit 在 LLM 调用步骤进度工具时预测状态更新。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { copilotkitCustomizeConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/sdk-js/langgraph'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">frontendActionsNode</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AgentState</span>&gt; {
    <span class="hljs-keyword">const</span> modifiedConfig = <span class="hljs-title function_">copilotkitCustomizeConfig</span>(config, {
        <span class="hljs-attr">emitIntermediateState</span>: [
        {
            <span class="hljs-attr">stateKey</span>: <span class="hljs-string">"observed_steps"</span>,
            <span class="hljs-attr">tool</span>: <span class="hljs-string">"StepProgressTool"</span>,
            <span class="hljs-attr">toolArgument</span>: <span class="hljs-string">"steps"</span>,
        },
        ],
    });

    <span class="hljs-keyword">const</span> stepProgress = <span class="hljs-title function_">tool</span>(
        <span class="hljs-keyword">async</span> (args) =&gt; args,
        {
            <span class="hljs-attr">name</span>: <span class="hljs-string">"StepProgressTool"</span>,
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Records progress by updating the steps array"</span>,
            <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
                <span class="hljs-attr">steps</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()),
            }),
        }
    );

    <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span>,
    }).<span class="hljs-title function_">bindTools</span>([stepProgress]);

    <span class="hljs-keyword">const</span> system_message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"You are a task performer. Pretend doing tasks you are given, report the steps using StepProgressTool."</span>)
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>([system_message, ...state.<span class="hljs-property">messages</span>], modifiedConfig);


    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">messages</span>: response;
            <span class="hljs-attr">observed_steps</span>: response.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">args</span>.<span class="hljs-property">steps</span>,
        }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">messages</span>: response };
}
</code></pre>
<p>这些预测将在代理运行时发出，允许您在确定最终状态之前跟踪其进度:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent, useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/react-core'</span>;

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-built_in">string</span>[];
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// Get access to both predicted and final states</span>
    <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span> });

    <span class="hljs-comment">// Add a state renderer to observe predictions</span>
    <span class="hljs-title function_">useCoAgentStateRender</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">observed_steps</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Current Progress:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
            );
        },
    });

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Agent Progress<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {state.observed_steps?.length &gt; 0 &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Final Steps:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h2 data-id="heading-32">子图</h2>
<p>一个子图简单地是作为另一个图中的节点使用的图。把它看作是LangGraph的封装：每个子图是一个自包含的单元，可以组合起来构建更大、更复杂的系统。</p>
<p>使用此功能不需要在agent端执行额外步骤。您需要做的就是在 useCoAgent 钩子中启用子图流：</p>
<pre><code class="hljs language-tsx" lang="tsx">  <span class="hljs-keyword">const</span> { state, nodeName } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: <span class="hljs-variable constant_">INITIAL_STATE</span>,
    <span class="hljs-attr">config</span>: {
      <span class="hljs-attr">streamSubgraphs</span>: <span class="hljs-literal">true</span>, 
    }
  });
</code></pre>
<p>子图节点将照常流式传输，你将能够使用 <code>nodeName</code> 变量查看哪个子图正在流式传输。您也可以直接从子图使用 <code>interrupt（）</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型瘦身术:量化与蒸馏技术全解析]]></title>    <link>https://juejin.cn/post/7576825095134986266</link>    <guid>https://juejin.cn/post/7576825095134986266</guid>    <pubDate>2025-11-26T05:57:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576825095134986266" data-draft-id="7576669556150190118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型瘦身术:量化与蒸馏技术全解析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T05:57:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型瘦身术:量化与蒸馏技术全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:57:07.000Z" title="Wed Nov 26 2025 05:57:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要给大模型"瘦身"?</h2>
<p>在AI技术飞速发展的今天,大语言模型已经成为各行各业的得力助手。但你是否知道,部署一个大模型的成本有多高?</p>
<p>一个千亿参数级别的模型,不仅需要占用大量的存储空间,在实际运行时更是需要惊人的计算资源。对于企业来说,这意味着高昂的硬件成本和运营开支。因此,如何在保持模型性能的同时降低部署成本,成为了AI工程师们必须面对的挑战。</p>
<p>今天,我们就来聊聊大模型压缩的两大主流技术——<strong>量化(Quantization)和蒸馏(Distillation)</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb122be11df49e0b2e47cbda4123427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=xUqEIgMf6B0xrbulchmQuih2GlY%3D" alt="大模型压缩技术概览" loading="lazy"/></p>
<h2 data-id="heading-1">量化:用更少的位数存储参数</h2>
<h3 data-id="heading-2">什么是量化?</h3>
<p>要理解量化,我们首先需要知道:大模型本质上是由海量参数组成的。比如GPT-3,就包含了1750亿个参数。每个参数都是一个数值,而这些数值的存储方式,直接决定了模型占用的空间大小。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52330fabeb214786abcfba009f5b1a54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=pSf6HinPuv6%2BzRgb9BBfXvk51ew%3D" alt="量化原理解释" loading="lazy"/></p>
<p>让我们举个简单的例子。假设某个参数的值是1.2768,为了在计算机中存储这个精确的数值,我们需要开辟一定的内存空间。但如果我们做个"四舍五入",把它简化成1或者1.28,所需的存储空间就会大大减少。</p>
<p><strong>这就是量化的核心思想——通过降低数值精度来节省存储空间。</strong></p>
<h3 data-id="heading-3">从Float32到INT8的转变</h3>
<p>在深度学习中,参数通常以Float32的格式存储,也就是说每个参数占用32个bits(4个字节)的空间。但通过量化技术,我们可以将这些参数转换为更低精度的数据类型:</p>
<ul>
<li>
<p><strong>Float32 → Float16</strong>:空间减半,每个参数仅占16个bits</p>
</li>
<li>
<p><strong>Float32 → INT8</strong>:空间压缩至1/4,每个参数仅占8个bits</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33d3fcb13a374856b9dcb900473adbce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=QQEPn3g8hMDSsGwBjZrtfFDWChg%3D" alt="数据类型转换示意" loading="lazy"/></p>
<p>这种转换带来的好处是显而易见的:</p>
<ol>
<li>
<p><strong>大幅降低存储需求</strong>:模型文件变小,更容易部署</p>
</li>
<li>
<p><strong>加速推理速度</strong>:计算量减少,响应更快</p>
</li>
<li>
<p><strong>降低成本</strong>:对硬件的要求大幅下降</p>
</li>
</ol>
<p>你可能会担心:精度降低了,模型的准确率会不会受影响?</p>
<p>答案是:**如果量化过程把控得当,模型的准确率是有保障的。**这也是为什么量化成为目前大模型压缩最常用的方法之一。</p>
<h2 data-id="heading-4">蒸馏:让小模型学会"模仿"</h2>
<h3 data-id="heading-5">蒸馏的本质是什么?</h3>
<p>如果说量化是"压缩参数",那么蒸馏则是完全不同的思路——<strong>让一个小模型去模仿大模型的行为</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad612a7432bc401ba6d549483e411cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=Selr8ftFG1%2FKCdLwZulvF0z%2BAW0%3D" alt="模型蒸馏原理" loading="lazy"/></p>
<p>想象一个场景:我们已经训练好了一个千亿参数的大模型,但它太大太重,部署成本太高。这时候,我们可以构造一个小得多的模型,然后让这个"学生模型"(Student Model)去学习"教师模型"(Teacher Model)的行为。</p>
<h3 data-id="heading-6">蒸馏是如何工作的?</h3>
<p>具体来说,蒸馏的过程是这样的:</p>
<ol>
<li>
<p>给定一个输入(比如一个prompt)</p>
</li>
<li>
<p>将这个输入同时喂给大模型和小模型</p>
</li>
<li>
<p>观察大模型的输出</p>
</li>
<li>
<p>训练小模型,让它的输出尽可能接近大模型的输出</p>
</li>
</ol>
<p><strong>就像小孩子模仿大人一样,大模型做什么,小模型也学着做什么。</strong></p>
<p>通过这种方式,小模型逐渐学会了大模型的"行为模式",最终能够在保持相似性能的同时,大幅减少模型规模和计算开销。</p>
<h3 data-id="heading-7">蒸馏在实际中的应用</h3>
<p>蒸馏技术不仅用于模型压缩,在训练新模型时也经常使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795d7eabee8d40d7ac4381417456b8f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=yuPYq1MLtEck17Uwlt0MCoTUmKQ%3D" alt="蒸馏应用场景" loading="lazy"/></p>
<p>一个典型的例子是:市面上很多开源大模型,都是通过"模仿"GPT-4训练出来的。具体做法是:</p>
<ol>
<li>
<p>收集GPT-4对各种问题的回复</p>
</li>
<li>
<p>将这些输入-输出对作为训练数据</p>
</li>
<li>
<p>用这些数据训练自己的模型</p>
</li>
</ol>
<p>通过这种方式,开源模型能够逐步接近GPT-4的表现,同时保持更低的部署成本。</p>
<h2 data-id="heading-8">量化vs蒸馏:该选哪一个?</h2>
<p>这两种技术各有特点,适用于不同场景:</p>
<p><strong>量化技术</strong>:</p>
<ul>
<li>
<p>优势:实施简单,不需要重新训练,压缩效果明显</p>
</li>
<li>
<p>适用场景:已有模型的快速优化,对精度要求不是特别严格的应用</p>
</li>
<li>
<p>主流方法:目前大模型压缩最常用的手段</p>
</li>
</ul>
<p><strong>蒸馏技术</strong>:</p>
<ul>
<li>
<p>优势:可以获得一个全新的小模型,灵活性更高</p>
</li>
<li>
<p>适用场景:需要大幅度缩小模型规模,或训练新模型时借鉴大模型能力</p>
</li>
<li>
<p>应用广泛:很多开源模型都基于蒸馏思路训练</p>
</li>
</ul>
<p>在实际应用中,这两种技术也可以结合使用,达到更好的压缩效果。</p>
<h2 data-id="heading-9">其他压缩技术</h2>
<p>除了量化和蒸馏,还有一些其他的模型压缩技术,比如<strong>剪枝(Pruning)</strong>——通过移除模型中不重要的参数或连接来减小模型规模。</p>
<p>但在大模型领域,剪枝的实用性相对较弱,量化和蒸馏仍然是最主流、最实用的两种方法。</p>
<h2 data-id="heading-10">写在最后</h2>
<p>随着大模型应用的不断普及,模型压缩技术变得越来越重要。无论是量化还是蒸馏,它们的目标都是在保证模型性能的前提下,让AI技术更加"平民化"——降低部署门槛,让更多人能够用得起、用得好大模型。</p>
<p>对于开发者来说,理解这些技术原理,不仅能帮助我们更好地部署模型,也能在设计AI应用时做出更明智的技术选择。</p>
<p>你在实际项目中使用过这些技术吗?欢迎在评论区分享你的经验!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 TRAE SOLO 一台服务器，它能干什么？]]></title>    <link>https://juejin.cn/post/7576821684252475435</link>    <guid>https://juejin.cn/post/7576821684252475435</guid>    <pubDate>2025-11-26T12:36:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252475435" data-draft-id="7576859345935089718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 TRAE SOLO 一台服务器，它能干什么？"/> <meta itemprop="keywords" content="Trae,Solo,AI编程"/> <meta itemprop="datePublished" content="2025-11-26T12:36:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 TRAE SOLO 一台服务器，它能干什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:36:45.000Z" title="Wed Nov 26 2025 12:36:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前一阵子刷到一个很有意思的操作：有人直接把一台服务器的权限扔给了 AI，并简单说了句目标。</p>
<p>然后，AI 就从零开始安装环境、配依赖，拉仓库，启动服务，最后成功完成了对外服务的提供。</p>
<p>今天，我们就尝试下这个思路：让 <code>TRAE SOLO</code> 自行在远程服务器中搭建一套 <code>MinerU</code> 环境。</p>
<h2 data-id="heading-0">MinerU</h2>
<p>首先，简单介绍下 <code>MinerU</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f6d82478d04e299eb19d753a2feee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=eyAcvMYv80Ko0lYxi894%2BhOMfN4%3D" alt="" loading="lazy"/></p>
<p><code>MinerU</code> 是一款能将<strong>PDF/图片转换为机器可读格式</strong>（例如 <code>markdown</code>、<code>JSON</code>）的工具，诞生于上海人工智能实验室出品大模型 <code>InternLM</code> 的预训练过程中。</p>
<p>核心特性：</p>
<ul>
<li><strong>多模态文档解析</strong>：支持多种文档类型，包括扫描版 PDF</li>
<li><strong>结构化还原</strong>：可识别表格、公式、分子式等</li>
<li><strong>高保真语义理解</strong>：利用布局分析和阅读顺序推理，避免传统 OCR 机械识别导致的逻辑错乱。</li>
<li><strong>本地化 &amp; 开源免费</strong>：全部模型和代码开源，可私有部署，无需调用外部 API，保障数据隐私。</li>
</ul>
<h2 data-id="heading-1">共绩算力</h2>
<p>AI 要部署的应用已经了解了，现在需要给 AI 找一个可以操作的服务器。</p>
<p>最近我使用的算力平台是“共绩算力”，<code>RTX 4090</code> 只要 <code>1.68</code> 元/小时，还能按毫秒计费、自动扩容，非常便于我根据研究的模型挑选合适的节点配置。</p>
<p>尤其是目前，平台还有福利，<strong>注册就送算力券</strong>。</p>
<h2 data-id="heading-2">实操记录</h2>
<h3 data-id="heading-3">节点建立</h3>
<p>注册并登录“共绩算力”平台。</p>
<p>在“云主机”页面选择合适的节点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381d765e27df439a89ad4481f0287395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=Rc4YtH5x9fML4ri8vP5vSZVT9jw%3D" alt="" loading="lazy"/></p>
<p>选择合适的节点类型后，配置相关镜像、存储等，我这里配置了“基础镜像”，由于是测试搭建模型，未配置相关存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45720f1c6b0c433eb1630a9778577e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=ZHXguh3rd2MYd2LyIXgx%2F%2FIF8wI%3D" alt="" loading="lazy"/></p>
<p>如果是第一次租用，账户余额为 0，会要求充值一下（0.01元即可），然后，需要在个人中心关注下公众号，这些按照页面提示进行即可。</p>
<p>租用成功后，会在“控制台”-“云主机列表”中看到租用的节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ced2f6fccc284a258c6b961f3df6fc34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=c53clo2VeJABljwf1KwMHtyaP8E%3D" alt="" loading="lazy"/></p>
<p>24G 显存、63G 内存，1小时 1.68 元，并且有算力券抵扣，还很合适的。</p>
<h3 data-id="heading-4">远程连接</h3>
<p><strong>第一步</strong>，我们先来调整下 <code>SSH</code> 连接的命令，让其支持端口映射，方便访问 demo。</p>
<p>在上一步的“云主机列表”-“SSH登录信息”中，复制出登录指令，格式如下。</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>增加<strong>端口映射参数</strong>。</p>
<pre><code class="hljs language-java" lang="java">ssh -vvN -L <span class="hljs-number">7860</span>:<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">7860</span> root<span class="hljs-meta">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>其中 <code>7860</code> 是 <code>MinerU demo</code> 的服务端口。</p>
<p><strong>第二步</strong>，我们打开 <code>TRAE</code> 进行远程连接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9b703dfe8241f19585bdafa24cd984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=M1BqQ%2FKJfoL%2FPVZAlOzkjla%2Fc70%3D" alt="" loading="lazy"/></p>
<p>输入上面的指令，回车即可。</p>
<p>此时会要求录入密码，再次从“云主机列表”-“SSH登录信息”中复制“登录密码”即可。</p>
<blockquote>
<p>如果同一地址连接多次，可能会在 SSH 连接中生成多个相同的 Host，此时会出现登录失败的情况，手动删除重复的 Host 即可。</p>
</blockquote>
<p>成功连接后，终端信息如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a9b28a6d3d742e1a8102d68ad591783~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=m8gIiVOKAC5gAOWKDOX9fEqEBFc%3D" alt="" loading="lazy"/></p>
<p>正常情况下可以在编辑器中打开远程文件夹，也可以在终端执行命令了。</p>
<p>但今天，我们都交给 AI。</p>
<h3 data-id="heading-5">环境部署</h3>
<p>开发环境：国际版 <code>SOLO Coder</code> 智能体，未选择 <code>Plan</code> 模式。</p>
<p>直接在 <code>Chat</code> 窗口录入如下指令，等待完成。</p>
<p><strong>指令</strong></p>
<p>指令非常简单，让 AI 参考 <code>MinerU</code> 官方仓库文档，自行完成部署。</p>
<p>因为模型下载涉及到 <code>HuggingFace</code> 的网络问题，一般各大算力企业都会提供镜像内容，这里把“共绩算力”的镜像文档也放上了。</p>
<pre><code class="hljs language-ruby" lang="ruby">参考github文档<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/opendatalab</span><span class="hljs-regexp">/mineru?tab=readme-ov-file ，帮我完成mineru的安装，并完成demo启动。
云服务器文档：https:/</span><span class="hljs-regexp">/www.gongjiyun.com/docs</span><span class="hljs-regexp">/server/introduction</span><span class="hljs-regexp">/rznmwsy13i4a8yktuyycoxyinmg/</span> 
</code></pre>
<p><strong>过程</strong></p>
<p>过程很清晰：安装依赖、下载模型、启动Demo。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed996c916d140cdb6e08f5c1fdf5da5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=zqHwEcUepdAd22Ase9gK8vIZOhs%3D" alt="" loading="lazy"/></p>
<p>后面还有详细的安装步骤、网络加速与镜像建议、常用参数与优化、问题排查、后续可选增强等内容，便于我们回顾审阅。</p>
<p><strong>SOLO 模式的好处就是中间遇到问题，它可以自行解决</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a961e3db9aa7494f8246f58bcf74ae20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=xQkx4ScwbTogw%2Bfyg2KosdmFI84%3D" alt="" loading="lazy"/></p>
<p>最后还给出了 demo 的访问方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9688c470114572ba55130ceef88e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=BzTO%2FbDrygPDuRktGgBxwy02eHw%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>命令执行完成后，<code>SOLO</code> 内置浏览器已经帮我把 demo 打开了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb24fca4efe455ea6f1c14f79537ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=1diCpbeVDiDxzba0NULY8kS%2F6PU%3D" alt="" loading="lazy"/></p>
<p>这里可以通过 <code>http://localhost:7860/</code> 访问到服务器，就是因为“远程连接”章节中的 SSH 命令中增加了端口映射。</p>
<h3 data-id="heading-6">调试优化</h3>
<p>上面跑起来的 demo，上传测试的 PDF 后，转换报错。</p>
<p>不着急，我们直接让 <code>SOLO</code> 帮忙修复下。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">demo中上传后报错，请帮我修复
</code></pre>
<p><strong>过程</strong></p>
<p><code>SOLO</code> 可以从终端中获取错误信息，快速定位问题：</p>
<p>“上传解析时报错的根因是 Gradio 处理流程在解析时尝试访问 HuggingFace 获取模型元数据，出现 SSL 错误导致函数返回 None ，最终触发 TypeError: cannot unpack non-iterable NoneType object ”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147e903ead2f409eb39b6ffa8b9c95c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=NjQAkBUNiBJd0hRoLD75Qfim%2B1c%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>再次上传 <code>PDF</code>，可以看到提取结果了，已经完成了今天的既定目标了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fad90c7e2c44072961045993260da4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=nZEk2Y46KqYNQjC%2F79J7mgqmy%2FQ%3D" alt="" loading="lazy"/></p>
<p>由于模型参数未调优，识别中存在些许问题，非此次分享重点，我们就不再讨论了。</p>
<h2 data-id="heading-7">结语</h2>
<p>整个过程还是非常顺利的，除了我第一次忘记配置模型镜像下载导致的失败。</p>
<p>之前以为 AI 可以自己 <code>SOLO</code> 代码就很酷了，没想到，AI 都已经可以自己掌控服务器了。</p>
<p>给个目标，就能直接等待验收？那后续技术验证、环境搭建脚本岂不是更轻松了。</p>
<p>当部署、调试、优化也能交给 AI 自主完成后，开发者就有了更多的时间去思考“做什么”而非“怎么做”——这或许才是智能时代的生产力跃迁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑]]></title>    <link>https://juejin.cn/post/7576827115967954979</link>    <guid>https://juejin.cn/post/7576827115967954979</guid>    <pubDate>2025-11-26T08:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576827115967954979" data-draft-id="7576676694784294946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-26T08:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:55:59.000Z" title="Wed Nov 26 2025 08:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>为什么同样是做 RAG，有的效果拔群，有的却差强人意？分块（Chunking）策略可能是那个被你忽略的关键环节。</p>
<h2 data-id="heading-1">什么是Chunk？</h2>
<p>AI中的分块是指将大型文档分割成称为“chunk”的较小片段。这些片段可以是段落、句子、词组或受token限制的片段，这使得模型能更轻松地仅搜索和检索所需内容。这种分块技术对于优化检索增强生成（RAG）的性能至关重要。</p>
<h2 data-id="heading-2">为什么在RAG中需要Chunk？</h2>
<p>在RAG中，检索到正确的信息是关键，但当知识库非常庞大，可能包含数百万字或文档时，使用有效的RAG分块技术对于从这类大型数据集中高效检索相关信息，就变得至关重要了。举个例子，你有一个服务QPS达到千万级还要在30ms内返回结果，这时一定会搞一组本地缓存的集群。把你的数据按规则初始化到缓存里，就是对应的RAG的Chunk操作。</p>
<p>Chunk也是RAG ETL Pipeline中Transform环节的核心组件之一，可以比喻成我们切蛋糕，在切之前就已经想好要分几块了。让我看看“切蛋糕🍰”有几种手法。</p>
<p>﻿</p>
<h2 data-id="heading-3">二、主流RAG的分块策略详解</h2>
<h3 data-id="heading-4">2.1.固定大小分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e717f4856f4b4d6b8c1e6d1233624a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=g2xtCDIgEz0NUrWeff8FwuFXQlU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 根据预定义的字符数或 token 数将文本分成统一的块。</p>
<p>•<strong>工作方式：</strong> 例如，固定每块 500 tokens。引入 “重叠区”（Overlap）来缓解上下文断裂问题。</p>
<p>•<strong>优点：</strong> 实现简单，处理速度快，不依赖复杂模型。</p>
<p>•<strong>缺点：</strong> 可能破坏语义完整性（如拆分句子或段落），对结构差异大的文档适应性差。</p>
<h3 data-id="heading-5">2.2.语义分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e691b1f6ab74899b57fedc35ac0bd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=0PbrXc1dPP93Kudu%2F7nns4uu7GM%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>•<strong>核心思想：</strong> 根据文本的语义相似度而非物理结构进行分块，确保每个 Chunk 内部主题高度相关。</p>
<p>•<strong>工作方式：</strong> 通常通过计算句子 Embedding 的余弦相似度，当相似度低于某个阈值时进行分割。</p>
<p>•<strong>优点：</strong> 能创建逻辑上最连贯的 Chunk，对后续检索和生成质量提升显著。特别适用于处理主题跳跃较多的文档。</p>
<p>•<strong>缺点：</strong> 计算成本高（需要调用 Embedding 模型），处理速度较慢。</p>
<h3 data-id="heading-6">2.3.基于递归分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670c024dfd7c43b993949ac771409482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=NF7aI%2ByLRo0r2qMx0qoUlOT3wV8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 一种更智能的组合式策略，按优先级顺序尝试多种分隔符进行递归分割。</p>
<p>•<strong>工作方式：</strong> 例如，优先按段落分割，如果段落仍过大，再按句子分割，最后才按字符数强制分割。</p>
<p>•<strong>优点：</strong> 尽可能保留高级别的语义结构（段落 &gt; 句子 &gt; ...），适应性强，能处理多种类型文档。</p>
<p>•<strong>缺点：</strong> 实现稍复杂，性能开销高于纯固定大小分块。</p>
<h3 data-id="heading-7">2.4.基于文档的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a97488467434bb7a0be391548c9780b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=%2BEmotgSPOZxQkpc1vpbZTKqazUE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 利用文档本身的元数据和结构信息（如标题层级、表格、图片说明、PDF 页码等）进行智能分割。</p>
<p>•<strong>工作方式：</strong> 例如，将一个一级标题下的所有内容（包括子标题和段落）作为一个大 Chunk，或者将每个表格单独作为一个 Chunk。</p>
<p>•<strong>优点：</strong> 完美贴合特定类型文档（如法律合同、学术论文、报告）的逻辑结构，信息组织性强。</p>
<p>•<strong>缺点：</strong> 依赖高质量的文档解析和结构识别，通用性相对较弱。</p>
<h3 data-id="heading-8">2.5.智能体分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8593b21374bc4634a5f4eed20831a28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=xz1Qm%2Bdn1fnEl31%2BxgY1bdrERc0%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>﻿</p>
<p>•<strong>核心思想：</strong> 这是一种更前沿的动态策略，根据 Agent 将要执行的具体任务或目标来决定如何分块。</p>
<p>•<strong>工作方式：</strong> Agent 会先理解任务，然后自适应地从文档中提取和组织最相关的信息块。例如，任务是 “总结”，则可能提取关键论点；任务是 “回答特定问题”，则可能精准定位相关证据。</p>
<p>•<strong>优点：</strong> 灵活性和针对性极高，能最大化任务效果。</p>
<p>•<strong>缺点：</strong> 实现复杂，通常需要强大的规划和推理能力，目前还不普及。</p>
<h3 data-id="heading-9">2.6.基于句子的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a67aeda6ad49a59bd6f28bfa68daec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=mWfClsUnrnUw4UQKfLkYfblJJso%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 将文本分割成完整的句子，确保每个 Chunk 都包含一个或多个完整的思想。</p>
<p>•<strong>工作方式：</strong> 使用 NLP 工具（如 NLTK, SpaCy）识别句子边界，然后可以将几个连续的句子组合成一个 Chunk。</p>
<p>•<strong>优点：</strong> 保证了基本的语义单元完整，避免了 “半句话” 的问题。</p>
<p>•<strong>缺点：</strong> 句子长度差异仍可能导致 Chunk 大小不均；多个句子组合时，如何确定最佳组合仍需策略。</p>
<h3 data-id="heading-10">2.7.基于段落的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbabf005b3df4b2aaa70477648bf3e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=pomnwhwuKz%2FPfPicHwIalOihUM4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 基于段落的分块，通过提示符截取，将整个文本划分成多个段落。这种方式同样适合结构清晰的文档。</p>
<p>•<strong>工作方式：</strong> 例如，保险条款、法律、论文、AB实验报告等文档。</p>
<p>•<strong>优点：</strong> 优点自然分段，语义完整。</p>
<p>•<strong>缺点：</strong> 缺点自然是段落长度不一，可能超token限制。</p>
<p>﻿</p>
<h3 data-id="heading-11">其他</h3>
<p>除以上7种外，还有很多大神们总结的切块方法论，如按照token、按照层级，按照excel sheet页，按照pdf页码等。都是针对特定场景。下面我结合<strong>实战</strong>和<strong>中文</strong>的切块的方法论做一下总结。</p>
<p>﻿</p>
<h2 data-id="heading-12">三、分块策略的选择与实战优化</h2>
<h3 data-id="heading-13">3.1. 没有“万能”的分块策略</h3>
<p>现实中不存在一种“one-for-all” 的数据读取和分块方法，特别像是 PDF 和 Word 这类复杂格式的文档。比较流行的方案是实用DeepDoc（OCR、TSR、DLR），所以实际中应根据业务，制作不同的模板。那么评估Chunk的参数和指标有哪些呢？ 指标就是<strong>Precision和Recall</strong>，详细看表格 <strong>：</strong></p>

























<table><thead><tr><th>参数</th><th>参考值</th><th>作用</th></tr></thead><tbody><tr><td>chunk_size</td><td>512-1024</td><td>1.切的越小chunks数越多，所以chunk_size跟你的top-k值有关。在 Recall 差不多的情況下，可以选Precision 高的，比较有效率。 2.如果是能力強的大模型，Precision 低一點，也没问题。 3.如果是能力弱的小模型，容易被噪声影响，Precision 太低不好，因此切块需要调小。 4.为什么默认值是512？与主流预训练语言模型的上下文窗口大小（如BERT的512）保持兼容。</td></tr><tr><td>separator</td><td>/n</td><td>分隔符</td></tr><tr><td>overlap</td><td>10%-15%</td><td>通常重叠块长度在10%-20%之间</td></tr></tbody></table>
<p>﻿</p>
<p>Chunk参数与指标，我设计了两套策略：512/10%和2500/25 （单位token）</p>

















<table><thead><tr><th>通用策略（512/10%）</th><th>最大上下文策略（2500/25）</th></tr></thead><tbody><tr><td>chunk_size：512个token，约450多个汉字是相对中等的切块大小。这个大小足以容纳完整的剧组或段落。大多情况可以在“准确率”与“上下文完整性”之间取的平衡</td><td>chunk_size：2500个token相当于2000多个汉字，属于非常大的文本块了。这个设定的背后逻辑是利用现在的大模型（GPT-5.1、gemini 3）的超大token。当任务是进行长篇文件的深度思考推理时，可以提供丰富的信息给到模型，从而获得较高的Precision。</td></tr><tr><td>overlap：10%是比较中庸设定，是业界普遍的建议，能缓解边界切割问题。</td><td>overlap：10个左右汉字，基本可以忽略了，超大文本块被切割的几率相对较小。</td></tr></tbody></table>
<h3 data-id="heading-14">﻿</h3>
<h3 data-id="heading-15">3.2.Chunk策略的选择</h3>
<p>我的方法论：<strong>段落分块（Paragraph Chunking），句子分块（Semantic Chunking），递归分块（Recursive Chunking），语义分块（Semantic Chunking）。</strong></p>
<p>现在的RAG框架基本都是基于段落或句子来分块，也都都支持（\n。；！？）的递归分块。那从运营用户角度出发，或者第一次切的时候，如何傻瓜式操作呢？RAGFlow交出了一份方案，看一下它的分块核心算法</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63a86ad1118a49449dcaf1d79b33dd69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=dxXiwgAZLZHvrkAc%2BjYkTAJTjsQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-16">四、方法论总结</h2>
<p>如何开始？可以从512 tokens 搭配 10-15%的重叠率开始。</p>
<p>如何优化？调试参数，多使用递归分块和句子分块，语义分块还是不够优秀。</p>
<p>如何测评？上号 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrandonstarxel%2Fchunking_evaluation" target="_blank" title="https://github.com/brandonstarxel/chunking_evaluation" ref="nofollow noopener noreferrer">chunking_evaluation </a>﻿</p>
<p>有和方法论？ 上号 <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2401.17043" target="_blank" title="https://arxiv.org/abs/2401.17043" ref="nofollow noopener noreferrer">CRUD-RAG</a> 论文指出对于创意生成和保持文章连贯性的任务，切分较大的块表现会更佳。我们在</p>
<p>﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2309.15217.pdf" target="_blank" title="https://arxiv.org/pdf/2309.15217.pdf" ref="nofollow noopener noreferrer">RAGas</a>实验也得到了相同的答案。</p>
<p>﻿</p>
<p>好了，以上是我们的实践总结，希望能帮到大家。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统]]></title>    <link>https://juejin.cn/post/7576827115967791139</link>    <guid>https://juejin.cn/post/7576827115967791139</guid>    <pubDate>2025-11-26T08:38:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576827115967791139" data-draft-id="7576661150684299279" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-26T08:38:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:38:32.000Z" title="Wed Nov 26 2025 08:38:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：言合、古琦</p>
<h2 data-id="heading-0">前言</h2>
<p>Dify 是时下热门的低代码 LLM 应用开发平台，其丰富的模型支持、Prompt 编排、RAG 引擎、Workflow/Agent 框架以及插件生态大大便利了 Agentic 应用的开发。</p>
<p>生产级的 Agentic 应用涉及大量动态内容，诸如历史会话、记忆处理，工具调用、知识库召回，模型生成，脚本执行和流程控制等环节给 Agentic 应用生成的效果带来很大不确定性。可观测性贯穿 Agentic 应用开发调试、运维迭代的全生命周期，并串联 Agentic 应用执行和上下游系统中的工具、模型和调用方，是支撑 Agentic 应用生产落地的关键。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c767555e86904128bcb30e84159e00ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=7QQ5BnNtSRW7YJlOXR3KFnAgI9c%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">Dify 可观测的两个视角丨开发者 &amp; 运维方</h3>
<p>对 Dify 这类低代码平台的可观测性需求，有开发者和平台运维两个视角。</p>
<p>Agentic 应用开发者使用 Dify SaaS 或自部署的 Dify 服务开发 Workflow 应用，专注于 Workflow 的构建，观测的主体是 Dify 平台上运行的一个个 Workflow 应用。关注点在于 Workflow 整体和其中 RAG、Tool、LLM 等各个步骤的执行，开发者依赖可观测服务监测大模型应用生成效果和性能，追踪用户多轮会话的交互体验。在 Agentic 应用开发构建和上线后的迭代维护阶段可观测能力都是 Agentic 应用持续优化的关键。</p>
<p>Dify 平台运维方关注 Dify 集群中从基础设施到各个组件的负载和异常情况，管理 Dify 和上下游的服务和依赖，观测的主体是 Dify 集群及其上下游依赖。Dify 集群包含执行引擎、插件引擎、任务队列、沙箱环境和存储服务等十多个组件；同时还涉及调用方、模型服务、工具访问、外部知识库等上下游依赖。请求过程的全链路可观测是线上问题追溯，性能瓶颈定位的关键工具。</p>
<h3 data-id="heading-2">Dify 可观测现状 &amp; 痛点</h3>
<p>可观测性一直是 Dify 社区活跃的议题，目前 Dify 原生支持的可观测能力由三个方面组成。</p>
<p>其一是 <strong>Dify 内置的应用监控能力</strong>，数据采自 Dify 执行引擎运行过程中生成的执行明细记录，存储在 Dify 数据库内。其特点是和 Dify 自身的集成度最高，在开发调试阶段使用非常方便。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/776d30c9592a49b4801e8ec4e981b2a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Bvb6t4ibpQAQB1RtQXuSYA7dYBI%3D" alt="图片" loading="lazy"/></p>
<p>然而内置的应用监控在分析能力和性能两个方面存在不足。在分析能力上，Workflow 上线后对其观测数据需要多维度的聚合分析或二次加工，问题排查也需要关键字、时间范围、模糊匹配、错误类型等多维度的检索能力，但 Dify 自带的监控只能通过会话 ID 和用户 ID 等有限方式检索，不能满足数据分析和问题排查的需要。在性能上，受限于在 DB 中记录执行日志的数据存储方式，内置应用监控在大规模应用的生产环境下性能不佳，日志数据加载较慢甚至大量的执行明细数据会拖慢数据库整体性能，需要在后台 Celery 任务中配置清理任务周期性清理日志数据。</p>
<p>其二是 <strong>Dify 官方集成的第三方应用追踪服务</strong>，包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a> / Langfuse 和 LangSmith 等。数据采自 Dify 特有的 OpsTrace 事件机制和 Dify 引擎生成的执行明细记录，主要采集 Workflow/Agent 层面的大模型、工具、知识库召回等节点信息。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">阿里云云监控</a>从 Dify v1.6.0 起也集成了 Dify 官方可观测能力，提供全托管免运维的可观测服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de98bd86d5c4172b97fdb9d68cf1d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=W8qHsqwkBVrVXTVixPPMlOEtgQk%3D" alt="图片" loading="lazy"/></p>
<p>第三方集成的追踪服务痛点在于<strong>数据采集粒度受限且缺少全链路追踪能力</strong>。Dify 集成的第三方应用追踪服务主要关注 Agentic 应用开发者视角下的 Wrokflow 执行情况，更多地用于 Prompt 调优、Wrokflow 优化、数据分析等场景，但对于自建 Dify 集群时平台运维方的集群监控和上下游全链路问题排查能提供的帮助就很有限。同时受限于 Dify 的 OpsTrace 机制，能够采集的数据粒度在 Workflow 节点层面，其他更细粒度的数据支持起来比较困难。</p>
<p>其三是对 <strong>Dify 集群自身的可观测性</strong>，面向 Dify 集群各组件及上下游依赖的全链路可观测。目前 Dify 原生支持 Sentry 和 OpenTelemetry 两套可观测方式。两者主要采集 Flask、HTTP、DB、Redis、Celery 等框架层面的数据，对 Dify 自身的内部执行逻辑未做埋点。Sentry 由于相对封闭，目前社区 issue 主要转向更开放的 OTel 生态。</p>
<p>原生 OTel 方式的痛点在于<strong>采集的数据非常有限，无法串联上下游</strong>实现全链路追踪且无法与 Workflow 执行明细数据联动。原生的 OTel 只支持对 Dify 执行引擎和 Celery 任务组件埋点，采集的信息并不完整，同时由于 Dify 架构复杂且存在部分自定义协议，缺少全链路可观测以及和 Workflow 执行明细数据联动的能力。</p>
<h2 data-id="heading-3">Dify 全景可观测——挑战与方案</h2>
<p>针对现有可观测方案的痛点，云监控上线了 Dify 全组件无侵入探针 + Dify 官方集成的应用追踪服务组合的 Dify 全景可观测解决方案，满足 Dify Agentic 应用开发者和 Dify 平台维护者两个视角对可观测性的需要，实现对执行引擎、插件引擎、沙箱环境、插件运行时以及 Workflow 应用的全方位监控。在这一过程中，因 Dify 架构复杂迭代迅速，全景可观测的实现面临多项挑战：</p>
<h3 data-id="heading-4">1. Dify 组件众多，执行链路复杂</h3>
<p>Dify 请求经过网关入口、执行引擎、插件引擎、代码沙箱、插件运行时等多个组件，关联 Celery 后台任务队列，插件运行时受插件引擎的私有协议管理，链路复杂。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a>为执行引擎、插件运行提供 Python 探针，通过函数 Patch 实现零代码改动的无侵入埋点；为插件引擎和代码沙箱提供 Go 探针，通过编译时插桩实现无侵入注入；为 Nginx 和 Celery 任务队列提供 OTel 探针的解决方案；对于生命周期受插件引擎管控的插件运行时，通过代码插桩改造插件拉起流程，引入探针挂载逻辑。最终对 Dify 集群内的各个组件，只需配置环境变量并修改启动命令即可实现无侵入注入。</p>
<h3 data-id="heading-5">2. Dify 迭代迅速，代码变动频繁</h3>
<p>Dify 社区已有 1000+ 贡献者，经常一周甚至数天发布一个版本。Dify 实现的频繁变动给无侵入探针的实现带来很大挑战，纯无侵入方式很难跟上 Dify 的发版节奏。</p>
<p>云监控团队和社区积极合作，对接官方提供的第三方集成方式，对于 Dify 内部易变的 Workflow 执行逻辑采用官方方式上报，由社区维护版本更迭引起的改动。同时在无侵入探针中对 Dify 内部方法做最小依赖，仅处理框架层面的埋点和上下文传递过程中的断链问题。</p>
<h3 data-id="heading-6">3. Dify 官方集成的监测和 OTel 生态难以串联</h3>
<p>Dify 官方集成的第三方应用监控服务使用 Dify 自定义的 OpsTrace 机制，采用异步后聚合的方式上报追踪数据，这和标准的 OTel 实现存在较大差异。现有的集成方如 Langfuse 等都无法实现官方的应用追踪和全链路追踪结合。</p>
<p>云监控采用 OTel 格式上报数据，在 Dify 引擎挂载探针时将 traceId 信息透传到后台的 Celery 任务，通过 Trace Link 方式关联 Dify 官方集成方式上报的 Workflow 执行明细数据和无侵入探针上报的全链路追踪数据，实现全景可观测。</p>
<h2 data-id="heading-7">云监控可观测集成</h2>
<h3 data-id="heading-8">接入速览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215a805636554690a9cb18dfec64518d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=lF5XO8gHh%2BBTw7jDXYCdTX3wo%2B0%3D" alt="图片" loading="lazy"/></p>
<p>云监控给 Dify 的各个组件都提供了可观测方案，其中 Workflow 应用无需挂载探针，在 Dify 控制台上为需要监控的应用开启追踪即可。其余组件需要挂载探针实现监控，其中 API 和 Plugin-Daemon 是核心的工作流和插件系统执行引擎，推荐优先挂载。Sandbox、Worker、Nginx 按需可选挂载。</p>
<h3 data-id="heading-9">版本要求</h3>
<h4 data-id="heading-10">Python 探针</h4>
<p>使用最新版 Python 探针即可，Dify v1.x 版本都可用，因为只采 HTTP/Flask/Redis/DB 等框架层数据，所以 Python 探针对 Dify 版本无强要求。Dify v1.8.0 以后的版本支持通过 Trace Link 方式串联 Dify 官方集成上报的 Workflow 执行明细数据。</p>
<h4 data-id="heading-11">Go 探针</h4>
<p>使用最新版本的 Go 探针即可，Dify v1.x 版本都可用，提供对 dify-plugin-damon 的监控，同时支持对插件生命周期进行监控。</p>
<h4 data-id="heading-12">Dify 原生监控</h4>
<p>从 Dify v1.6.x 开始集成，更高的版本功能更全，推荐使用较新的版本。更新记录如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79959323cae54e3b891b74c8eae1f537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Jur6z0Yh7%2BbulM3k0z0xdmPt7Rk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">Opentelemetry 插件</h4>
<p>推荐首选 Python 探针，阿里云 Python 探针按照 OTel 标准实现，并在探针基座和数据上报上做了增强。Dify 的 Worker、Nginx 可以使用 OTel 方案。Dify 从 v1.3.0 开始支持 OTel 配置，但上报端点存在兼容性问题，从 Dify v1.7.0 以后支持上报到阿里云的云监控2.0/ARMS 后端。</p>
<h3 data-id="heading-14">监控 Workflow 应用</h3>
<p>使用 Dify 官方集成的云监控可采集 LLM、Tool、RAG 等 Workflow 层面的 Trace 数据，即 Dify 官方集成的监控采集大模型应用数据，一个 Workflow 对应一个大模型应用。</p>
<p>限于 Dify 框架特性，Dify 官方集成的云监控和 Python 探针采集的 Trace 无法直接联通，但可以通过 Trace Link 方式实现大模型应用和微服务应用的相关关联，通过 Python 探针和 Dify 原生监控组合实现 API 组件的可观测。</p>
<h4 data-id="heading-15">前提条件</h4>
<p>Dify 版本 &gt;= 1.6.0</p>
<h4 data-id="heading-16">步骤一：获取阿里云 Endpoint 和 License Key</h4>
<p>方式一）云监控 2.0 且 Dify 版本 &gt;= 1.9.1 的用户推荐使用云监控 2.0 的上报端点：</p>
<ol>
<li>
<p>登录云监控 2.0 控制台，在左侧导航栏单击接入中心。</p>
</li>
<li>
<p>在应用监控&amp;链路追踪区域单击 Dify 卡片。</p>
</li>
<li>
<p>在弹出的接入面板中选择数据上报地域，点击获取 LicenseKey。</p>
</li>
<li>
<p>记录生成的 LicenseKey 和 Endpoint。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011914895a7f43a481eeb59208911244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=5sgZL7sw%2BL1n7zfVPCSNciMmwDY%3D" alt="图片" loading="lazy"/></p>
<p>方式二）<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">ARMS</a> 用户或 Dify 版本在 1.6.0～1.9.0 的用户可以使用 ARMS 的上报端点，数据也会在云监控 2.0 上同步呈现：</p>
<ol>
<li>
<p>登录 ARMS 控制台，在左侧导航栏单击接入中心。</p>
</li>
<li>
<p>在服务端应用区域单击 OpenTelemetry 卡片。</p>
</li>
<li>
<p>在弹出的 OpenTelemetry 面板中选择数据上报地域，上报方式选 gRPC。</p>
</li>
<li>
<p>记录生成的 LicenseKey 和 Endpoint，注意 Endpoint 不要带端口号。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a65d3ea809046c68dc01bce25e87beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ngyc0HDEgtyIbd6X9SIDm7t1PAE%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">步骤二：配置应用性能追踪</h4>
<ol>
<li>
<p>登录 Dify 控制台，并进入需要监控的 Dify 应用。</p>
</li>
<li>
<p>在左侧导航栏单击监测。</p>
</li>
<li>
<p>单击追踪应用性能，然后在云监控区域单击配置。</p>
</li>
<li>
<p>在弹出的对话框中输入步骤一获取的 License Key 和 Endpoint，并自定义 App Name（ARMS 控制台显示的应用名称），然后单击保存并启用。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca257e9687a4b918ff735379fd303be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=zVjRZp2rF5dYKphlJLX8YOZeNW8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-18">步骤三：查看 Dify 应用监控数据</h4>
<p>配置完毕后在 Dify 控制台或通过 Dify API 发起几次请求，稍等 1～2 分钟即可登录阿里云控制台查看上报的数据。</p>
<p>方式一：监控 2.0 用户在应用中心- AI 应用可观测处查看</p>
<p>方式二：ARMS 用户在 LLM 应用监控处查看</p>
<p><strong>应用详情示例：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd080d6ce771403987e394600a9a815c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3%2FIocsqIkXxCtTSBkBENOQZbqYA%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情示例：</strong></p>
<p>LLM 节点会采集系统/用户提示词、模型输出、模型提供商和型号、token 用量等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7f92d57fa4d4e6199dc722af405b03b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=L9z4jQlm5i3zwFg4izFQgBYoaCE%3D" alt="图片" loading="lazy"/></p>
<p>Retriever 节点会采集查询语句、召回片段、关联文档元数据、embbeding 评分等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a351fc888844770bd172f54d4684fc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Ki14WctZgV6Jg1QNN9mrV2qBCS0%3D" alt="图片" loading="lazy"/></p>
<p>Tool 节点会采集工具参数和调用结果、工具提供商和描述等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95aa2c0ec49141068afccaa622b53a77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3fbOgKrvscyWwujNEap0kbhh%2BhM%3D" alt="图片" loading="lazy"/></p>
<p>其他流程节点也都会采集节点的输入输出、会话 ID、用户 ID 等必要数据。</p>
<p>接入可参考文档[3][4]。</p>
<h3 data-id="heading-19">监控执行引擎 API</h3>
<p>API 是 Dify 执行引擎。使用 Python 探针可采集 HTTP/Flask/Redis/DB 等框架层面的 Trace 数据，并关联上下游调用实现全链路追踪，即 Python 探针采集微服务数据，API 组件对应一个微服务应用。</p>
<h4 data-id="heading-20">步骤一：安装 Python 探针</h4>
<p>首先需要卸载冲突的 OTel 插件，下载并安装 Python 探针。</p>
<p>启动脚本开头改动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保pip环境</span>
python -m ensurepip --upgrade

<span class="hljs-comment"># 卸载冲突的OTel插件</span>
pip3 uninstall -y opentelemetry-instrumentation-celery \
  opentelemetry-instrumentation-flask \
  opentelemetry-instrumentation-redis \
  opentelemetry-instrumentation-requests \
  opentelemetry-instrumentation-logging \
  opentelemetry-instrumentation-wsgi \
  opentelemetry-instrumentation-fastapi \
  opentelemetry-instrumentation-asgi \
  opentelemetry-instrumentation-sqlalchemy

<span class="hljs-comment"># 安装Python探针</span>
pip3 config <span class="hljs-built_in">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple/ &amp;&amp; pip3 config <span class="hljs-built_in">set</span> install.trusted-host mirrors.aliyun.com
pip3 install aliyun-bootstrap &amp;&amp; aliyun-bootstrap -a install
</code></pre>
<p><strong>提示：</strong></p>
<p>可以通过 Docker 数据卷挂载方式用修改后的启动脚本替换原脚本（修改源码并重打镜像也可以）。即将修改后的脚本作为配置项挂载到容器目录内，并指定容器从此脚本启动。例如：</p>
<p>将修改后的脚本 entrypoint.sh 存储为配置项，并挂载到容器目录 /app/api/docker。</p>
<p>指定启动命令：["/bin/bash","/app/api/docker/entrypoint.sh"]</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bf9c3ba8bd4cf7b74ebafe95bdb4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=42kRrfGt9ddXNf9t4e7BRgpwsw4%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-21">步骤二：修改启动命令</h4>
<p>在启动脚本最后的应用启动部分做修改，从 aliyun-instrument 启动：</p>
<p>启动脚本末尾改动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用aliyun-instrument启动</span>
<span class="hljs-built_in">exec</span> aliyun-instrument gunicorn \
      --<span class="hljs-built_in">bind</span> <span class="hljs-string">"<span class="hljs-variable">${DIFY_BIND_ADDRESS:-0.0.0.0}</span>:<span class="hljs-variable">${DIFY_PORT:-5001}</span>"</span> \
      --workers <span class="hljs-variable">${SERVER_WORKER_AMOUNT:-1}</span> \
      --worker-class <span class="hljs-variable">${SERVER_WORKER_CLASS:-gevent}</span> \
      --worker-connections <span class="hljs-variable">${SERVER_WORKER_CONNECTIONS:-10}</span> \
      --<span class="hljs-built_in">timeout</span> <span class="hljs-variable">${GUNICORN_TIMEOUT:-200}</span> \
      app:app
</code></pre>
<p>同理此步骤也可以通过修改镜像打包过程或通过挂载 K8S 配置项并替换 Dify 启动脚本的方式实现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b018a7ed8f24d9bb851032e19a02009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=FlQs%2FuUGFyQ3JxrUIks7Fwl6q%2Fo%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-22">步骤三：配置环境变量</h4>
<p>配置如下环境变量，应用名、地域和 License Key 根据实际情况填写。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692375ca8b844b4e85ee655417062a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ykq%2Fjxwpji54g7LfA268%2FzTBtHo%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-23">步骤四：部署并查看 API 监控数据</h4>
<p>进入应用监控列表可以看到 dify-api 应用，应用详情示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04c1d649e734abf9905b5e2d485d68d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=PICxuZzFy5C8A9EnijtD%2B%2FUTWLA%3D" alt="图片" loading="lazy"/></p>
<p>调用链会串联上下游调用信息，示例数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67eba21a02843b499e28167f2ab384e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=P9o%2BWMuxktAhAMG3loTJBZXVc9I%3D" alt="图片" loading="lazy"/></p>
<p>可以参考文档[5]，注意如果直接使用 ack-onepilot 自动注入，会存在 Dify 自带的 OTel SDK 和 Python 探针冲突的问题，还需要手动改启动脚本卸载冲突的 OTel 依赖。</p>
<h3 data-id="heading-24">监控插件引擎 Dify-Plugin-Daemon</h3>
<p>Dify-Plugin-Daemon 是 Dify 的插件管理器，Dify 的 LLM、插件、Agent 策略的执行都依赖 Plugin-Daemon。Go Agent[2]支持监控 Dify-Plugin-Daemon，接入 Go 监控需修改Dockerfile、重新编译镜像后配置环境变量开启。Plugin-Daemon 的 Go 探针同时也会自动为插件运行时挂载 Python 探针。</p>
<h4 data-id="heading-25">步骤一：修改 Dockerfile 文件重新编译对应镜像</h4>
<p>local.dockerfile 修改示例</p>
<p>DockerFile</p>
<pre><code class="hljs language-bash" lang="bash">FROM golang:1.23-alpine AS builder


ARG VERSION=unknown
<span class="hljs-comment"># copy project</span>
COPY . /app
<span class="hljs-comment"># set working directory</span>
WORKDIR /app
<span class="hljs-comment"># using goproxy if you have network issues</span>
<span class="hljs-comment"># ENV GOPROXY=https://goproxy.cn,direct</span>
<span class="hljs-comment"># download arms instgo</span>
RUN wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
RUN <span class="hljs-built_in">chmod</span> 777 instgo
<span class="hljs-comment"># instgo build</span>
RUN INSTGO_EXTRA_RULES=<span class="hljs-string">"dify_python"</span> ./instgo go build \
    -ldflags <span class="hljs-string">"\
    -X 'github.com/langgenius/dify-plugin-daemon/internal/manifest.VersionX=<span class="hljs-variable">${VERSION}</span>' \
    -X 'github.com/langgenius/dify-plugin-daemon/internal/manifest.BuildTimeX=<span class="hljs-subst">$(date -u +%Y-%m-%dT%H:%M:%S%z)</span>'"</span> \
    -o /app/main cmd/server/main.go
<span class="hljs-comment"># copy entrypoint.sh</span>
COPY entrypoint.sh /app/entrypoint.sh
RUN <span class="hljs-built_in">chmod</span> +x /app/entrypoint.sh
FROM ubuntu:24.04
WORKDIR /app
<span class="hljs-comment"># check build args</span>
ARG PLATFORM=<span class="hljs-built_in">local</span>
<span class="hljs-comment"># Install python3.12if PLATFORM is local</span>
RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y curl python3.12 python3.12-venv python3.12-dev python3-pip ffmpeg build-essential \
    &amp;&amp; apt-get clean \
    &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/apt/lists/* \
    &amp;&amp; update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1;
<span class="hljs-comment"># preload tiktoken</span>
ENV TIKTOKEN_CACHE_DIR=/app/.tiktoken
<span class="hljs-comment"># Install dify_plugin to speedup the environment setup, test uv and preload tiktoken</span>
RUN <span class="hljs-built_in">mv</span> /usr/lib/python3.12/EXTERNALLY-MANAGED /usr/lib/python3.12/EXTERNALLY-MANAGED.bk \
    &amp;&amp; python3 -m pip install uv \
    &amp;&amp; uv pip install --system dify_plugin \
    &amp;&amp; python3 -c <span class="hljs-string">"from uv._find_uv import find_uv_bin;print(find_uv_bin());"</span> \
    &amp;&amp; python3 -c <span class="hljs-string">"import tiktoken; encodings = ['o200k_base', 'cl100k_base', 'p50k_base', 'r50k_base', 'p50k_edit', 'gpt2']; [tiktoken.get_encoding(encoding).special_tokens_set for encoding in encodings]"</span>
ENV UV_PATH=/usr/local/bin/uv
ENV PLATFORM=<span class="hljs-variable">$PLATFORM</span>
ENV GIN_MODE=release
COPY --from=builder /app/main /app/entrypoint.sh /app/
<span class="hljs-comment"># run the server, using sh as the entrypoint to avoid process being the root process</span>
<span class="hljs-comment"># and using bash to recycle resources</span>
CMD [<span class="hljs-string">"/bin/bash"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"/app/entrypoint.sh"</span>]
</code></pre>
<p>注意 INSTGO_EXTRA_RULES 选项会开启 Plugin 运行时自动监测功能，如果不需要在 Plugin-Daemon 启动时拉起对 Plugin 探针，可以去除编译文件中的<code>INSTGO_EXTRA_RULES="dify_python"。</code></p>
<h4 data-id="heading-26">步骤二：配置环境变量</h4>
<p>方式一）ECS 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14ec06f90f44155b0bd899e6ea1d2fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=E%2Bpeiy1kp2YXQZ2WRw5cbxrg4WI%3D" alt="图片" loading="lazy"/></p>
<p>方式二）容器化 ack-onepilot 环境</p>
<p>在 dify-plugin-daemon 应用的 YAML 配置中将以下 labels 添加到 spec.template.metadata 层级下。</p>
<pre><code class="hljs language-bash" lang="bash">labels:
  aliyun.com/app-language: golang
  armsPilotAutoEnable: <span class="hljs-string">'on'</span>
  armsPilotCreateAppName: <span class="hljs-string">"dify-daemon-plugin"</span>
</code></pre>
<h4 data-id="heading-27">步骤三：部署并查看 dify-plugin-daemon 监控</h4>
<p>在应用列表页面进入 dify-plugin-daemon 应用，监控详情如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58ac56cd7ef24c119d2a7db118a59370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=IFOGvcgL99hkyGAlVsx1qAaPUIo%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac53088b9e66401c95422be50dfbd1ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=6hAhQq8xXNCOyOHZjOurjLYx4Po%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-28">步骤四：查看 Plugin 监控</h4>
<p>挂载探针后，Plugin-Daemon 会自动拉起插件运行时的探针。每个插件运行时对应一个可观测应用，应用名为 {plugin_daemon_name}<em>plugin</em>{plugin_name}_{plugin_version}。例如，Plugin-Daemon 配置的应用名为 local-dify-plugin-daemon，安装了 tongyi 的 version 0.0.53 插件时，会自动生成应用 local-dify-plugin-daemon_plugin_tongyi_0.0.53。</p>
<p>插件监控概览页示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02763908464745ddba514613fadaad9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=67YjRhs2uZFciyoBgCzmMbcpyVE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-29">(可选) 监控代码沙箱 Sandbox</h3>
<p>Sandbox 是 Dify 代码沙箱引擎，负责执行 Workflow 中的 Python/Node.js 代码。Go 探针支持监控 Sandbox，需修改 Dockerfile、重新编译镜像后配置环境变量开启。</p>
<h4 data-id="heading-30">步骤一：修改 Dockerfile 文件重新编译对应镜像</h4>
<p>修改 ./build/build_[amd64|arm64].sh 文件。</p>
<p>a. 添加 instgo 下载命令。</p>
<p>下载命令示例如下，其他地域和架构的下载命令请参见下载 instgo。</p>
<p>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Finstgo-tool-introduction%255B%239b94bbe8a62ra%25EF%25BC%2589" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/instgo-tool-introduction%5B#9b94bbe8a62ra%EF%BC%89" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<pre><code class="hljs language-bash" lang="bash">wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
<span class="hljs-built_in">chmod</span> 777 instgo
</code></pre>
<p>b. 在 <code>go build</code> 前添加 <code>instgo</code> 命令。</p>
<p>以 amd64 为例，修改示例如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -f internal/core/runner/python/python.so
<span class="hljs-built_in">rm</span> -f internal/core/runner/nodejs/nodejs.so
<span class="hljs-built_in">rm</span> -f /tmp/sandbox-python/python.so
<span class="hljs-built_in">rm</span> -f /tmp/sandbox-nodejs/nodejs.so
wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
<span class="hljs-built_in">chmod</span> 777 instgo
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building Python lib"</span>
CGO_ENABLED=1 GOOS=linux GOARCH=amd64 ./instgo go build -o internal/core/runner/python/python.so -buildmode=c-shared -ldflags=<span class="hljs-string">"-s -w"</span> cmd/lib/python/main.go &amp;&amp;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building Nodejs lib"</span> &amp;&amp;
CGO_ENABLED=1 GOOS=linux GOARCH=amd64 ./instgo go build -o internal/core/runner/nodejs/nodejs.so -buildmode=c-shared -ldflags=<span class="hljs-string">"-s -w"</span> cmd/lib/nodejs/main.go &amp;&amp;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building main"</span> &amp;&amp;
GOOS=linux GOARCH=amd64 ./instgo go build -o main -ldflags=<span class="hljs-string">"-s -w"</span> cmd/server/main.go
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building env"</span>
GOOS=linux GOARCH=amd64 ./instgo go build -o <span class="hljs-built_in">env</span> -ldflags=<span class="hljs-string">"-s -w"</span> cmd/dependencies/init.go
</code></pre>
<h4 data-id="heading-31">步骤二：配置环境变量</h4>
<p>方式一）无 ack-onepilot 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/636de4fea1ba4df388e678b033c1292b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=UMp4vE%2FC7Da%2BuYs0XwYfnohVztQ%3D" alt="图片" loading="lazy"/></p>
<p>方式二）容器化 ack-onepilot 环境</p>
<p>在 dify-plugin-daemon 应用的 YAML 配置中将以下 labels 添加到 spec.template.metadata 层级下。</p>
<pre><code class="hljs language-bash" lang="bash">labels:
  aliyun.com/app-language: golang
  armsPilotAutoEnable: <span class="hljs-string">'on'</span>
  armsPilotCreateAppName: <span class="hljs-string">"dify-daemon-plugin"</span>
</code></pre>
<h3 data-id="heading-32">步骤三：部署并查看 sandbox 监控</h3>
<p>在应用列表页面进入 dify-sandbox 应用，监控详情如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae047344ee80435e904f9c0194e681f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Y6U4bD3OhAGluZix7Js7uiw8VRg%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fbaf52127eb4d2089932fa04bcdfd86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=MR5AIp%2FKsI%2BpBr%2BOASuV%2BNrUpHM%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>参考文档：</strong></p>
<p>监控 Go 应用</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Fmonitoring-the-golang-applications%2F" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/monitoring-the-golang-applications/" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Fconnect-a-dify-application-to-arms-application-monitoring(%25E6%25AD%25A5%25E9%25AA%25A4%25E4%25BA%2594)" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/connect-a-dify-application-to-arms-application-monitoring(%E6%AD%A5%E9%AA%A4%E4%BA%94)" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
</blockquote>
<h3 data-id="heading-33">(可选) 监控任务队列 Worker</h3>
<p>Worker 是 Dify 后台任务组件，知识库构建和周期性清理任务依赖 Worker 执行。按普通 Python Celery 应用方式接入即可。这里给出使用 Dify 内置的 OTel 插件上报数据的示例：</p>
<h4 data-id="heading-34">步骤一：修改 Worker 环境变量</h4>
<p>OTel 插件是 Dify 内置功能，直接修改环境变量即可。注意要求 Dify 1.7.0 以上版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e3f6587c64405b9a3a4c710f9b37e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=SiojLQfW6wPHik4GYNGkKQHEH6c%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-35">步骤二：部署并查看 Worker 监控</h4>
<p>进入应用监控/ OpenTelemetry 监控页面查看上报的数据。</p>
<p>Worker 执行的后台任务 Trace 详情示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec32342ce9dc4987ac13f0e10543d630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=QuiZVT7nWh7SKNV%2FjlpyfAoRMyE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-36">(可选) 监控入口网关 Nginx</h3>
<p>Nginx 是 Dify 的入口网关，一些超时问题和知识库/插件/Workflow 的文件上传问题可能和 Nginx 配置有关。</p>
<p>直接使用 Opentelemetry 方式上报即可，推荐使用预构建的 Nginx-OTel 镜像方式。</p>
<h4 data-id="heading-37">步骤一：下载预构建 Docker 镜像</h4>
<p>前往 Docker 官网，搜索并拉取带有 -otel 后缀的 Nginx 镜像（如 nginx:1.29.0-otel），通过标准容器启动流程部署服务。</p>
<h4 data-id="heading-38">步骤二：获取 gRPC 接入点和鉴权 Token 信息</h4>
<p>登录可观测链路 OpenTelemetry 版控制台，在接入中心选取 OpenTelemetry 卡片，选择 gRPC 协议上报数据。</p>
<p>记录接入点和鉴权 Token 备用。</p>
<p>在开源框架区域单击，在弹出的 OpenTelemetry 面板中选择数据需要上报的地域。</p>
<h4 data-id="heading-39">步骤三：启用 Nginx OTel 模块</h4>
<p>修改 Nginx 配置文件 nginx.conf.template：</p>
<p>Nginx 配置文件</p>
<pre><code class="hljs language-bash" lang="bash">load_module modules/ngx_otel_module.so; <span class="hljs-comment"># 加载 ngx_otel_module</span>
...
http {
    ...

    otel_exporter {
        endpoint <span class="hljs-string">"<span class="hljs-variable">${GRPC_ENDPOINT}</span>"</span>; <span class="hljs-comment"># 前提条件中获取的 gRPC 接入点</span>
        header Authentication <span class="hljs-string">"<span class="hljs-variable">${GRPC_TOKEN}</span>"</span>; <span class="hljs-comment"># 前提条件中获取的鉴权 Token</span>
    }

    otel_trace on;                     <span class="hljs-comment"># 开启链路追踪</span>
    otel_service_name <span class="hljs-variable">${SERVICE_NAME}</span>;  <span class="hljs-comment"># 应用名</span>
    otel_trace_context propagate;         <span class="hljs-comment"># 向下游服务注入Trace上下文</span>
    ...
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5227e4b9ca54920a9a9a53844bb74ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Bu5XRQk9cTA6X70IBB4c2SVgdwI%3D" alt="图片" loading="lazy"/></p>
<p>可参考文档[6]接入 Nginx 监控。</p>
<h2 data-id="heading-40">实践指南</h2>
<h3 data-id="heading-41">关联 LLM Trace 和微服务 Trace=</h3>
<p>Dify 的 Workflow 执行数据通过官方集成方式上报 Trace，而 Dify-api、Dify-Worker、Dify-Plugin-Daemon 等基础设施通过无侵入探针按 OTel 标准上报 Trace。这两套割裂的体系无法直接融合，阿里云提供了 Trace Link 能力，将应用层和基础设施层的两条 Trace 串联。</p>
<p><strong>从 LLM Trace 跳转微服务 Trace：</strong></p>
<p>进入一条 LLM Trace 的详情，可以看到完整的 Workflow 执行数据，但如何找到基础设施组件的 span 和上下游串联数据？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24fafe96a69b49048838f757dfd418e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=jNXWyQ0AcuH5JH2Q%2BdjLK1JaWAg%3D" alt="图片" loading="lazy"/></p>
<p>选中一个 span，在 span 右侧的附加信息面板选择 Links 标签页，可以看到和此 LLM Trace 相关联的基础设施 Trace 的信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5e80d4adcb42dca86b90a8ea68a61a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=6r%2Bm4DZN45tktcRh2ET4JwWyM%2Bc%3D" alt="图片" loading="lazy"/></p>
<p>点击“查询关联的调用链”，可以直接跳转到关联的基础设施 Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305362d503c8496fb726565b9f31e53c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=%2BZGzsXOkfnHqkbPTcm4Ya%2BmIYA4%3D" alt="图片" loading="lazy"/></p>
<p>从 微服务 Trace 跳转 LLM Trace：</p>
<p>在基础设施的微服务 Trace 上，可以看到 nginx、dify-api、dify-plugin-daemon、dify-sandbox 等各个组件的 Trace 数据，是否可以将它关联到 Dify 官方集成的 Trace 数据上？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8195d657974f3298a3aff0cd747a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=gRdQvmhpAG93%2BZ4V285Hp8r2W3I%3D" alt="图片" loading="lazy"/></p>
<p>点击调用链上方的筛选功能，用 span 名称筛选，找到名称为 AdvancedChatAppRunner.run 或 WorkflowAppRunner.run 的 span。（取决于 Dify Workflow 的类型，如果调用了子 Workflow 可能会有多个这样的 span）。</p>
<p>如果对应的 Workflow 开启了云监控追踪，在 span 附加信息的 Links 页签可以看到关联的 LLM Trace Id，点击“查询关联的调用链”可跳转到相应 LLM Trace。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/990d1a3ed5c545f68a7fa98197d5aa49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ift9PpxfUZAT232KQs506nz%2Bnp8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-42">分析执行引擎异常根因</h3>
<p>工作流层面的异常通常在 LLM Trace 或 Dify 日志追踪里可以看到直观的报错信息，但还有一类错误是底层 Dify 引擎的配置不当或内部 bug 引起的。无侵入探针提供了对这类错误的定位分析能力。</p>
<p>如图的示例场景，在 Dify Workflow 的某次执行中发现知识检索的输出总是为空，但是 Dify 控制台上又没有报错信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/786acfb4f8554128a091f809faaaab86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=h3c3W5FC1scrPu2m9g0ylyfCDCE%3D" alt="图片" loading="lazy"/></p>
<p>此时，可以根据 Dify 对话 ID、用户 ID 等信息在云监控上定位对应的 LLM Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5837c0bfdb804b0ba9e478a2666385a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=5wY53GrBvbzDjPFxn%2FhujFfWIs4%3D" alt="图片" loading="lazy"/></p>
<p>进入会话详情，找到对应 Trace 和相关 Span，首先尝试在 Span 详情中查找相关信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53f1b598bab8498bad1c3b84e8f897a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Lw1ZkBwcHL3SiYMEpylaOlIglQw%3D" alt="图片" loading="lazy"/></p>
<p>这个 Case 的问题不在 Wrokflow 层面，所以只能观察到输出异常，要定位具体原因，可以通过上一节介绍的 Links 功能，跳转到对应的 Dify infra 层 Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84477c7605d54eb9a70998491736c6f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=FjjOpKOyqqXgq4HbHMHtImrhScs%3D" alt="图片" loading="lazy"/></p>
<p>可以观察到 Trace 上存在部分错误 Span，通过快捷筛选直接定位错误 Span：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/320193f2edd744a1beb37b19071725dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Lz3FlEESb2EoNHvRTjfnJ22H9Kg%3D" alt="图片" loading="lazy"/></p>
<p>在错误 Span 的 Details 和 Events 中，可以看到错误信息和异常堆栈。并定位到根因是 Weaviate 向量存储配置引起的问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58664826c8b4ad4acc96f2ecc2feff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=IhAli%2FHfPX46Qt3osBWPzoboM3w%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-43">定位插件慢调用</h3>
<p>Dify 社区提供了丰富的插件生态，但管理插件的 Dify-Plugin-Daemon 和插件运行时却是难以定位故障的黑盒。在 Dify 控制台上能清晰地看到各个工作流节点的运行记录，但对于流程节点之下 Dify infra 设施的故障却无从分析。一次 Workflow 调用链路涉及 Nginx、API、Plugin-Daemon、Plugin 运行时和模型网关等多个组件，阿里云云监控提供的全链路追踪能力可以串联上下游的完整链路，定位插件内的错慢异常。</p>
<p>如图示例中“查询 SLS 日志”是一个 Dify 插件，正常调用只需 200 ms，但在这个 Trace 中却有 5s 多的慢调用。仅看 LLM Trace 或 Dify 执行日志，无法判断慢请求是因为 Dify-Api 引擎、Dify-Plugin-Daemon 插件引擎、Dify-Plugin 运行时或者 SLS 日志服务本身导致的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/870192cf24ea4ab8a18159450602d410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=HZiPR7WdfcJ7OZY7C99aiDiNC3o%3D" alt="图片" loading="lazy"/></p>
<p>通过 Links 找到关联的 Infra 层调用，可以看到 Trace 详情：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ea1a24080041efbb9aec94f0cf7d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=1nuEpsJiHfJ7s8%2BLmskoX3PO2Cc%3D" alt="图片" loading="lazy"/></p>
<p>Dify 引擎会做大量 DB 和 Redis 访问，排查非 DB/Redis 类问题时，可以在组件标签处点选并滤去 sqlalchemy 和 redis 组件的 Span 以便排查。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e4d0b5cb3e743c29c6979fe32545e53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3iKdzKHNuo%2BPwycjp9FaXN%2FyUyg%3D" alt="图片" loading="lazy"/></p>
<p>可以看到 dify 执行引擎（local-dify-api）发起了对 dify 插件引擎（local-dify-plugin-daemon）的 POST 调用，插件引擎调用插件运行时（local-dify-plugin-daemon_plugin_cms_0.0.1）并转发请求给 SLS 服务端口。整个链路上耗时最长的是 dify_plugin_execute，这是插件运行时内部的入口方法，我们正是在此处注入了故障模拟的慢调用。</p>
<p>欢迎大家加入我们的钉钉群，共同构建更好的 Dify 全链路监控能力。</p>
<ul>
<li>
<p>LoongSuite Python 开源交流群：101925034286</p>
</li>
<li>
<p>LoongSuite Go Agent 开源交流群：102565007776</p>
</li>
<li>
<p>ARMS 多语言应用监控产品交流群：159215000379</p>
</li>
</ul>
<p><strong>参考：</strong></p>
<p>[1] 获取 LicenseKey</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Fapi-arms-2019-08-08-describetracelicensekey-apps" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/api-arms-2019-08-08-describetracelicensekey-apps" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p>[2] ARMS 应用监控支持的 Go 组件和框架</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Fgo-components-and-frameworks-supported-by-arms-application-monitoring" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/go-components-and-frameworks-supported-by-arms-application-monitoring" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p>[3] Dify 官方监控接入</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Ftracing-analysis%2Funtitled-document-1750672984680" target="_blank" title="https://help.aliyun.com/zh/arms/tracing-analysis/untitled-document-1750672984680" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/tra…</a></p>
<p>[4] 集成阿里云云监控</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.dify.ai%2Fzh-hans%2Fguides%2Fmonitoring%2Fintegrate-external-ops-tools%2Fintegrate-aliyun" target="_blank" title="https://docs.dify.ai/zh-hans/guides/monitoring/integrate-external-ops-tools/integrate-aliyun" ref="nofollow noopener noreferrer">docs.dify.ai/zh-hans/gui…</a></p>
<p>[5] Dify Python 探针接入</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fcms%2Fcloudmonitor-2-0%2Fuser-guide%2Fmonitor-dify-applications" target="_blank" title="https://help.aliyun.com/zh/cms/cloudmonitor-2-0/user-guide/monitor-dify-applications" ref="nofollow noopener noreferrer">help.aliyun.com/zh/cms/clou…</a></p>
<p>[6] 使用 OpenTelemetry 对 Nginx 进行链路追踪</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fopentelemetry%2Fuser-guide%2Fuse-opentelemetry-to-perform-tracing-analysis-on-nginx" target="_blank" title="https://help.aliyun.com/zh/opentelemetry/user-guide/use-opentelemetry-to-perform-tracing-analysis-on-nginx" ref="nofollow noopener noreferrer">help.aliyun.com/zh/opentele…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付请求幂等性设计：从原理到落地，杜绝重复扣款]]></title>    <link>https://juejin.cn/post/7576843726011301914</link>    <guid>https://juejin.cn/post/7576843726011301914</guid>    <pubDate>2025-11-26T10:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011301914" data-draft-id="7576838095519105075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付请求幂等性设计：从原理到落地，杜绝重复扣款"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-26T10:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付请求幂等性设计：从原理到落地，杜绝重复扣款
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:01:52.000Z" title="Wed Nov 26 2025 10:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">支付请求幂等性设计：从原理到落地，杜绝重复扣款</h2>
<p>支付场景中，“重复支付” 是最致命的问题之一 —— 用户点击两次支付按钮、网络延迟导致系统重试、第三方支付回调重复通知，都可能导致 “一笔订单扣两次款”。一旦发生，不仅会引发用户投诉，还可能造成资金损失与合规风险。而解决这一问题的核心，就是<strong>保证支付请求的幂等性</strong>。</p>
<p>本文结合电商、金融支付的实战经验，从 “为什么需要幂等性”“重复请求的来源”“具体实现方案” 到 “落地避坑”，完整拆解支付幂等性的设计逻辑，提供可直接复用的技术方案。</p>
<h3 data-id="heading-1">一、先搞懂：支付场景的幂等性是什么？</h3>
<h4 data-id="heading-2">1. 幂等性的定义</h4>
<p>在计算机领域，幂等性是指：<strong>同一操作无论执行多少次，最终结果都是一致的</strong>。</p>
<p>对于支付请求，幂等性的核心要求是：</p>
<ul>
<li>同一笔订单，无论用户发起多少次支付请求，都只扣一次款；</li>
</ul>

<ul>
<li>同一笔支付回调，无论第三方（如微信支付、支付宝）重复通知多少次，都只更新一次订单状态；</li>
</ul>

<ul>
<li>重复操作不会产生额外的业务影响（如重复生成支付记录、重复发送扣款短信）。</li>
</ul>
<h4 data-id="heading-3">2. 为什么支付场景必须保证幂等性？</h4>
<p>支付的核心是 “资金安全”，幂等性是资金安全的底线：</p>
<ul>
<li>若不保证幂等性：用户因网络卡顿重复点击支付，可能导致 “一笔订单扣两次款”（资损风险）；</li>
</ul>

<ul>
<li>若不保证幂等性：第三方支付回调重复通知，可能导致 “订单已支付但重复回调更新状态”（业务混乱）；</li>
</ul>

<ul>
<li>合规要求：金融支付场景需满足 “一笔交易一次清算”，幂等性是合规的基础。</li>
</ul>
<h3 data-id="heading-4">二、支付请求重复的 4 个常见场景</h3>
<p>在设计方案前，先明确 “重复请求从哪来”，才能针对性解决：</p>






























<table><thead><tr><th>重复场景</th><th>具体描述</th><th>典型案例</th></tr></thead><tbody><tr><td>用户重复操作</td><td>用户点击支付按钮后，因页面无响应再次点击（或连续点击）</td><td>电商下单后，用户快速点击 “微信支付” 按钮 3 次</td></tr><tr><td>网络延迟 / 超时重试</td><td>支付请求发送后，因网络延迟未收到响应，客户端 / 服务端触发重试</td><td>移动端支付请求超时，APP 自动重试 2 次</td></tr><tr><td>系统故障重发</td><td>服务端处理支付时宕机，重启后重新接收未完成的请求</td><td>支付服务处理中数据库宕机，恢复后重放请求</td></tr><tr><td>第三方支付回调重复通知</td><td>微信支付 / 支付宝的支付结果回调，因网络波动重复发送</td><td>支付宝回调通知超时，重复发送 3 次支付成功通知</td></tr></tbody></table>
<p><strong>关键结论</strong>：重复请求无法避免（用户操作、网络、系统都可能导致），必须通过技术手段让重复请求 “无害”。</p>
<h3 data-id="heading-5">三、核心方案：支付幂等性的 5 种实现方式（按易落地排序）</h3>
<p>支付幂等性的实现核心是 “<strong>唯一标识 + 状态校验</strong>”—— 用唯一标识区分请求，用状态校验判断是否允许执行，以下是 5 种主流方案，覆盖不同场景：</p>
<h4 data-id="heading-6">方案 1：唯一订单号（幂等号）—— 最基础、最常用</h4>
<h5 data-id="heading-7">原理</h5>
<p>用<strong>全局唯一的订单号</strong>作为幂等标识，支付请求必须携带该订单号，服务端通过订单号判断是否已处理：</p>
<ol>
<li>下单时生成唯一订单号（如ORDER202511210001），关联用户、金额等核心信息；</li>
</ol>

<ol start="2">
<li>用户支付时，请求携带该订单号；</li>
</ol>

<ol start="3">
<li>服务端接收请求后，先查询 “该订单号是否已支付 / 处理中”；</li>
</ol>

<ol start="4">
<li>若已处理：直接返回成功结果；若未处理：执行支付逻辑；若处理中：返回 “处理中”（避免并发重复）。</li>
</ol>
<h5 data-id="heading-8">实现步骤（Java+MySQL）</h5>
<ol>
<li><strong>订单表设计</strong>（核心字段）：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_order` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'唯一订单号（幂等标识）'</span>,
  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付金额'</span>,
  `status` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付状态：0=待支付，1=支付中，2=已支付，3=支付失败'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`) COMMENT <span class="hljs-string">'订单号唯一索引（确保幂等）'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付订单表'</span>;
</code></pre>
<ul>
<li>关键：order_no加唯一索引，避免重复创建订单；status字段用于状态校验。</li>
</ul>
<ol start="2">
<li><strong>服务端支付接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentOrderMapper orderMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PayGatewayClient payGateway; <span class="hljs-comment">// 调用第三方支付网关（如微信支付）</span>
    
    <span class="hljs-comment">/**
     * 支付接口（保证幂等性）
     * <span class="hljs-doctag">@param</span> orderNo 唯一订单号（幂等标识）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@param</span> amount 支付金额
     * <span class="hljs-doctag">@return</span> 支付结果
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO pay(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：查询订单（通过唯一订单号）</span>
        PaymentOrder order = orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 步骤2：已处理过，直接返回结果</span>
            <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">2</span>) { <span class="hljs-comment">// 已支付</span>
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">1</span>) { <span class="hljs-comment">// 支付中</span>
                <span class="hljs-keyword">return</span> PaymentResultDTO.processing(<span class="hljs-string">"支付处理中，请稍后查询"</span>, orderNo);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">3</span>) { <span class="hljs-comment">// 支付失败，允许重试</span>
                <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
            }
        }
        <span class="hljs-comment">// 步骤3：未处理，执行支付逻辑</span>
        <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
    }
    
    <span class="hljs-comment">/**
     * 核心支付逻辑（抽离复用）
     */</span>
    <span class="hljs-keyword">private</span> PaymentResultDTO processPayment(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：创建订单（唯一索引保证不会重复创建）</span>
        PaymentOrder newOrder = new PaymentOrder();
        newOrder.setOrderNo(orderNo);
        newOrder.setUserId(userId);
        newOrder.setAmount(amount);
        newOrder.setStatus(<span class="hljs-number">1</span>); <span class="hljs-comment">// 状态设为“支付中”（防止并发重复）</span>
        <span class="hljs-keyword">try</span> {
            orderMapper.insert(newOrder);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 并发场景下，其他线程已创建订单，直接查询返回</span>
            <span class="hljs-keyword">return</span> pay(orderNo, userId, amount);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤2：调用第三方支付网关（如微信支付统一下单接口）</span>
            PayGatewayResponse gatewayResp = payGateway.unifiedOrder(orderNo, amount);
            <span class="hljs-keyword">if</span> (gatewayResp.isSuccess()) {
                <span class="hljs-comment">// 步骤3：支付成功，更新状态为“已支付”</span>
                orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">2</span>);
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 步骤4：支付失败，更新状态为“支付失败”</span>
                orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>);
                <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付失败："</span> + gatewayResp.getMsg(), orderNo);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 步骤5：异常情况，更新状态为“支付失败”</span>
            orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>);
            log.error(<span class="hljs-string">"支付异常，订单号：{}"</span>, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-9">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：单体应用、订单驱动的支付（如电商订单支付）、同步支付请求；</li>
</ul>

<ul>
<li><strong>优点</strong>：实现简单，无额外依赖（仅用订单表），兼容性强；</li>
</ul>

<ul>
<li><strong>缺点</strong>：依赖订单号的唯一性，若订单号生成规则泄露可能被恶意利用（需配合签名验证）。</li>
</ul>
<h4 data-id="heading-10">方案 2：令牌机制（Token）—— 适合前端重复提交</h4>
<h5 data-id="heading-11">原理</h5>
<p>针对 “用户重复点击” 场景，通过 “预生成令牌” 控制支付请求的唯一性：</p>
<ol>
<li>前端发起支付前，先调用 “获取支付令牌” 接口，服务端生成唯一 Token（如TOKEN_123456），存入 Redis（设置 15 分钟过期）；</li>
</ol>

<ol start="2">
<li>前端携带该 Token 发起支付请求；</li>
</ol>

<ol start="3">
<li>服务端校验 Token：若 Token 不存在（已使用 / 过期），拒绝请求；若存在，执行支付逻辑并删除 Token（或标记为已使用）。</li>
</ol>
<h5 data-id="heading-12">实现步骤（Java+Redis）</h5>
<ol>
<li><strong>获取令牌接口</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api/pay"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> String TOKEN_PREFIX = <span class="hljs-string">"pay:token:"</span>;
    
    <span class="hljs-comment">/**
     * 获取支付令牌（前端支付前调用）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 唯一Token
     */</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/get-token"</span>)</span>
    <span class="hljs-keyword">public</span> ResultDTO getPayToken(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 生成唯一Token（UUID+用户ID，确保唯一性）</span>
        String token = <span class="hljs-string">"TOKEN_"</span> + UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>) + <span class="hljs-string">"_"</span> + userId;
        <span class="hljs-comment">// 存入Redis，过期时间15分钟（避免Token长期有效）</span>
        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(TOKEN_PREFIX + token, userId.toString(), <span class="hljs-number">15</span>, TimeUnit.MINUTES);
        <span class="hljs-keyword">return</span> ResultDTO.success(token);
    }
}
</code></pre>
<ol start="2">
<li><strong>支付接口（结合 Token 校验）</strong> ：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"pay:token:"</span>;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO <span class="hljs-title function_">payWithToken</span><span class="hljs-params">(String token, String orderNo, Long userId, BigDecimal amount)</span> {
        <span class="hljs-comment">// 步骤1：Token校验（核心幂等逻辑）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> TOKEN_PREFIX + token;
        <span class="hljs-type">String</span> <span class="hljs-variable">redisUserId</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(redisKey);
        <span class="hljs-keyword">if</span> (redisUserId == <span class="hljs-literal">null</span> || !redisUserId.equals(userId.toString())) {
            <span class="hljs-comment">// Token不存在/已使用/用户不匹配，拒绝请求</span>
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"无效的支付请求，请刷新页面重试"</span>, orderNo);
        }
        
        <span class="hljs-comment">// 步骤2：订单校验（同方案1，双重保障）</span>
        <span class="hljs-type">PaymentOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.getStatus() == <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤3：执行支付逻辑（同方案1）</span>
            <span class="hljs-type">PaymentResultDTO</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processPayment(orderNo, userId, amount);
            
            <span class="hljs-comment">// 步骤4：支付完成后，删除Token（标记为已使用）</span>
            redisTemplate.delete(redisKey);
            
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 异常时不删除Token，允许重试（避免因系统异常导致无法支付）</span>
            log.error(<span class="hljs-string">"支付异常，Token：{}，订单号：{}"</span>, token, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-13">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：前端重复提交（如按钮连续点击）、移动端支付、需要防止恶意请求的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：Token 一次性有效，安全性高，能有效防止无 Token 的恶意支付请求；</li>
</ul>

<ul>
<li><strong>缺点</strong>：多一步 “获取 Token” 接口调用，增加前端开发成本；依赖 Redis（分布式场景需 Redis 集群）。</li>
</ul>
<h4 data-id="heading-14">方案 3：支付状态机校验 —— 防止状态回退</h4>
<h5 data-id="heading-15">原理</h5>
<p>支付订单的状态变更遵循固定流程（如 “待支付→支付中→已支付”），通过状态机限制 “不允许的状态变更”，避免重复处理：</p>
<ul>
<li>状态流转规则：0=待支付 → 1=支付中 → 2=已支付 或 3=支付失败；</li>
</ul>

<ul>
<li>幂等逻辑：若当前状态是 “已支付” 或 “支付中”，拒绝重复支付请求；只有 “待支付” 或 “支付失败” 状态允许执行支付。</li>
</ul>
<h5 data-id="heading-16">实现示例（状态机校验）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 支付状态机校验（工具类）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStateMachine</span> {
    <span class="hljs-comment">// 状态流转规则：key=当前状态，value=允许流转的目标状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Integer, List&lt;Integer&gt;&gt; STATE_RULES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 待支付（0）可流转到：支付中（1）</span>
        STATE_RULES.put(<span class="hljs-number">0</span>, Collections.singletonList(<span class="hljs-number">1</span>));
        <span class="hljs-comment">// 支付中（1）可流转到：已支付（2）、支付失败（3）</span>
        STATE_RULES.put(<span class="hljs-number">1</span>, Arrays.asList(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));
        <span class="hljs-comment">// 支付失败（3）可流转到：支付中（1）（允许重试）</span>
        STATE_RULES.put(<span class="hljs-number">3</span>, Collections.singletonList(<span class="hljs-number">1</span>));
        <span class="hljs-comment">// 已支付（2）不可流转到任何状态（不允许重复支付）</span>
        STATE_RULES.put(<span class="hljs-number">2</span>, Collections.emptyList());
    }
    
    <span class="hljs-comment">/**
     * 校验状态是否允许流转
     * <span class="hljs-doctag">@param</span> currentState 当前状态
     * <span class="hljs-doctag">@param</span> targetState 目标状态
     * <span class="hljs-doctag">@return</span> true=允许，false=不允许
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkStateTransition</span><span class="hljs-params">(<span class="hljs-type">int</span> currentState, <span class="hljs-type">int</span> targetState)</span> {
        List&lt;Integer&gt; allowedStates = STATE_RULES.getOrDefault(currentState, Collections.emptyList());
        <span class="hljs-keyword">return</span> allowedStates.contains(targetState);
    }
}
<span class="hljs-comment">// 支付接口中使用状态机校验</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> PaymentResultDTO <span class="hljs-title function_">payWithStateMachine</span><span class="hljs-params">(String orderNo, Long userId, BigDecimal amount)</span> {
    <span class="hljs-type">PaymentOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 状态机校验：若当前状态不允许流转到“支付中”，直接返回</span>
        <span class="hljs-keyword">if</span> (!PaymentStateMachine.checkStateTransition(order.getStatus(), <span class="hljs-number">1</span>)) {
            <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"当前订单状态不允许支付"</span>, orderNo);
            }
        }
    }
    <span class="hljs-comment">// 后续执行支付逻辑（同方案1）</span>
    <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
}
</code></pre>
<h5 data-id="heading-17">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：复杂支付流程（如分期支付、预授权支付）、需要严格控制状态流转的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：状态校验严谨，能防止 “已支付订单重复支付”“支付中订单被重复处理”；</li>
</ul>

<ul>
<li><strong>缺点</strong>：需维护状态机规则，适合状态流转清晰的场景。</li>
</ul>
<h4 data-id="heading-18">方案 4：防重表 —— 分布式场景的强一致性保障</h4>
<h5 data-id="heading-19">原理</h5>
<p>针对分布式系统（多服务实例），用 “防重表” 记录已处理的支付请求，通过数据库唯一索引保证幂等：</p>
<ol>
<li>防重表仅存储 “幂等标识”（如订单号、支付流水号），无其他业务字段；</li>
</ol>

<ol start="2">
<li>支付请求到达后，先向防重表插入幂等标识；</li>
</ol>

<ol start="3">
<li>若插入成功（无重复），执行支付逻辑；若插入失败（已存在），直接返回成功结果。</li>
</ol>
<h5 data-id="heading-20">实现步骤</h5>
<ol>
<li><strong>防重表设计</strong>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_idempotent` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `idempotent_key` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'幂等标识（订单号/支付流水号）'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_idempotent_key` (`idempotent_key`) COMMENT <span class="hljs-string">'幂等标识唯一索引'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付防重表'</span>;
</code></pre>
<ul>
<li>核心：idempotent_key加唯一索引，确保同一标识只能插入一次。</li>
</ul>
<ol start="2">
<li><strong>分布式支付接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedPaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentIdempotentMapper idempotentMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentOrderMapper orderMapper;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO distributedPay(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：插入防重表（核心幂等逻辑）</span>
        PaymentIdempotent idempotent = new PaymentIdempotent();
        idempotent.setIdempotentKey(orderNo); <span class="hljs-comment">// 用订单号作为幂等标识</span>
        <span class="hljs-keyword">try</span> {
            idempotentMapper.insert(idempotent);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 插入失败，说明已处理过，查询订单状态返回</span>
            PaymentOrder order = orderMapper.selectByOrderNo(orderNo);
            <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.getStatus() == <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            }
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"该订单已提交支付，请稍后查询结果"</span>, orderNo);
        }
        
        <span class="hljs-comment">// 步骤2：执行支付逻辑（同方案1）</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 步骤3：支付失败，删除防重表记录（允许重试）</span>
            idempotentMapper.deleteByIdempotentKey(orderNo);
            log.error(<span class="hljs-string">"分布式支付异常，订单号：{}"</span>, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-21">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：分布式系统（多服务实例）、高并发支付（如秒杀支付）、需要强一致性的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：不依赖缓存，数据库唯一索引保证强一致性，适合分布式环境；</li>
</ul>

<ul>
<li><strong>缺点</strong>：多一张防重表，增加数据库存储成本；插入删除操作增加数据库压力（可通过分表优化）。</li>
</ul>
<h4 data-id="heading-22">方案 5：第三方支付回调幂等 —— 处理重复通知</h4>
<h5 data-id="heading-23">原理</h5>
<p>第三方支付平台（微信支付、支付宝）的支付结果回调可能重复发送，需单独处理回调的幂等性：</p>
<ol>
<li>第三方回调会携带唯一的 “支付流水号”（如微信的transaction_id、支付宝的trade_no）；</li>
</ol>

<ol start="2">
<li>服务端接收回调后，先校验该流水号是否已处理；</li>
</ol>

<ol start="3">
<li>若已处理：直接返回第三方 “成功” 标识（避免第三方重复通知）；若未处理：更新订单状态并记录流水号。</li>
</ol>
<h5 data-id="heading-24">实现步骤（以微信支付回调为例）</h5>
<ol>
<li><strong>回调记录表设计</strong>（存储已处理的回调流水号）：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_callback_record` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `third_party_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'第三方支付流水号（如微信transaction_id）'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'关联订单号'</span>,
  `callback_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'回调时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_third_party_no` (`third_party_no`) COMMENT <span class="hljs-string">'第三方流水号唯一索引'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付回调记录表'</span>;
</code></pre>
<ol start="2">
<li><strong>微信支付回调接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@RestController</span>
<span class="hljs-keyword">@RequestMapping</span>(<span class="hljs-string">"/api/pay/callback"</span>)
public class WechatPayCallbackController {
    <span class="hljs-keyword">@Autowired</span>
    private PaymentCallbackRecordMapper callbackMapper;
    <span class="hljs-keyword">@Autowired</span>
    private PaymentOrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 微信支付回调接口（保证幂等性）
     */</span>
    <span class="hljs-keyword">@PostMapping</span>(<span class="hljs-string">"/wechat"</span>)
    public String wechatPayCallback(<span class="hljs-keyword">@RequestBody</span> String xmlData) {
        <span class="hljs-comment">// 步骤1：解析微信回调数据（获取transaction_id、order_no、result_code等）</span>
        WechatCallbackDTO callbackDTO = <span class="hljs-built_in">parseWechatCallback</span>(xmlData);
        String thirdPartyNo = callbackDTO<span class="hljs-selector-class">.getTransactionId</span>(); <span class="hljs-comment">// 第三方唯一流水号</span>
        String orderNo = callbackDTO<span class="hljs-selector-class">.getOutTradeNo</span>(); <span class="hljs-comment">// 商户订单号</span>
        
        <span class="hljs-comment">// 步骤2：校验回调是否已处理（幂等核心）</span>
        PaymentCallbackRecord record = callbackMapper<span class="hljs-selector-class">.selectByThirdPartyNo</span>(thirdPartyNo);
        if (record != null) {
            <span class="hljs-comment">// 已处理，返回微信“成功”标识（避免重复回调）</span>
            return <span class="hljs-built_in">buildWechatSuccessXml</span>();
        }
        
        <span class="hljs-comment">// 步骤3：校验支付结果（仅处理支付成功的回调）</span>
        if (!"SUCCESS".equals(callbackDTO.getResultCode())) {
            log<span class="hljs-selector-class">.error</span>("微信支付回调失败，订单号：{}，原因：{}", orderNo, callbackDTO.getErrCodeDes());
            return <span class="hljs-built_in">buildWechatFailXml</span>("支付失败");
        }
        
        try {
            <span class="hljs-comment">// 步骤4：更新订单状态为“已支付”</span>
            int updateCount = orderMapper<span class="hljs-selector-class">.updateStatusByOrderNo</span>(orderNo, <span class="hljs-number">2</span>);
            if (updateCount == <span class="hljs-number">0</span>) {
                log<span class="hljs-selector-class">.error</span>("订单不存在或已处理，订单号：{}", orderNo);
                return <span class="hljs-built_in">buildWechatSuccessXml</span>(); <span class="hljs-comment">// 仍返回成功，避免重复回调</span>
            }
            
            <span class="hljs-comment">// 步骤5：记录回调流水号（标记为已处理）</span>
            PaymentCallbackRecord newRecord = new <span class="hljs-built_in">PaymentCallbackRecord</span>();
            newRecord<span class="hljs-selector-class">.setThirdPartyNo</span>(thirdPartyNo);
            newRecord<span class="hljs-selector-class">.setOrderNo</span>(orderNo);
            callbackMapper<span class="hljs-selector-class">.insert</span>(newRecord);
            
            <span class="hljs-comment">// 步骤6：返回成功标识</span>
            return <span class="hljs-built_in">buildWechatSuccessXml</span>();
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("微信支付回调处理异常，订单号：{}", orderNo, e);
            <span class="hljs-comment">// 回调处理失败，返回失败标识，微信会重试（需做好重试机制）</span>
            return <span class="hljs-built_in">buildWechatFailXml</span>("处理异常");
        }
    }
    
    <span class="hljs-comment">// 工具方法：解析微信回调XML、构建返回XML（省略）</span>
    private WechatCallbackDTO <span class="hljs-built_in">parseWechatCallback</span>(String xmlData) { <span class="hljs-comment">/* ... */</span> }
    private String <span class="hljs-built_in">buildWechatSuccessXml</span>() { <span class="hljs-comment">/* ... */</span> }
    private String <span class="hljs-built_in">buildWechatFailXml</span>(String msg) { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<h5 data-id="heading-25">关键注意点</h5>
<ul>
<li>必须用第三方提供的 “唯一流水号” 作为幂等标识，而非商户订单号（避免同一订单多次支付的回调冲突）；</li>
</ul>

<ul>
<li>回调处理成功后，无论订单状态是否更新成功，都需返回第三方 “成功” 标识（否则第三方会持续重复回调）；</li>
</ul>

<ul>
<li>回调接口需支持幂等重试（如订单不存在时仍返回成功，避免第三方重复通知）。</li>
</ul>
<h3 data-id="heading-26">四、实战案例：电商支付幂等性完整流程</h3>
<p>结合以上方案，以电商支付为例，梳理完整的幂等性保障流程：</p>
<ol>
<li><strong>下单阶段</strong>：生成唯一订单号ORDER202511210001，订单状态设为 “待支付”；</li>
</ol>

<ol start="2">
<li><strong>前端支付前</strong>：调用 “获取 Token” 接口，获取 TokenTOKEN_XXX；</li>
</ol>

<ol start="3">
<li><strong>支付请求阶段</strong>：前端携带 Token + 订单号发起支付，服务端执行：</li>
</ol>
<ul>
<li>
<ul>
<li>Token 校验（方案 2）→ 订单状态校验（方案 3）→ 防重表插入（方案 4）→ 调用第三方支付；</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>第三方回调阶段</strong>：微信支付回调携带transaction_id，服务端执行：</li>
</ol>
<ul>
<li>
<ul>
<li>回调流水号校验（方案 5）→ 更新订单状态→ 记录回调记录；</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>重复请求处理</strong>：用户重复点击支付时，服务端通过 Token / 防重表 / 订单状态直接返回结果，不重复扣款。</li>
</ol>
<h3 data-id="heading-27">五、避坑指南：支付幂等性的 6 个关键注意事项</h3>
<ol>
<li><strong>幂等标识必须全局唯一</strong>：订单号、Token、第三方流水号等幂等标识，需保证全局唯一（如订单号用 “时间戳 + 随机数 + 用户 ID” 生成）；</li>
</ol>

<ol start="2">
<li><strong>并发场景加锁</strong>：高并发支付时，需用分布式锁（如 Redis 锁）锁定订单号，避免 “同时插入防重表” 导致的 DuplicateKeyException 过多；</li>
</ol>

<ol start="3">
<li><strong>异常处理需谨慎</strong>：支付失败 / 系统异常时，需释放幂等标识（如删除 Token、防重表记录），允许用户重试；</li>
</ol>

<ol start="4">
<li><strong>避免状态回退</strong>：已支付的订单不允许再次支付（状态机限制），防止 “已支付订单重复扣款”；</li>
</ol>

<ol start="5">
<li><strong>第三方回调必须幂等</strong>：第三方回调的幂等性独立处理，不依赖订单状态（避免同一订单多次支付的回调冲突）；</li>
</ol>

<ol start="6">
<li><strong>日志与监控</strong>：记录每笔支付的幂等校验结果、状态变更日志，监控重复请求次数，异常时触发告警（如重复支付请求突增）。</li>
</ol>
<h3 data-id="heading-28">六、方案选型建议</h3>



































<table><thead><tr><th>业务场景</th><th>推荐方案组合</th><th>核心原因</th></tr></thead><tbody><tr><td>中小电商（单体应用）</td><td>唯一订单号（方案 1）+ 状态机（方案 3）</td><td>实现简单，无额外依赖，满足基础幂等需求</td></tr><tr><td>移动端支付（防重复点击）</td><td>令牌机制（方案 2）+ 唯一订单号（方案 1）</td><td>Token 防止重复点击，订单号双重保障</td></tr><tr><td>分布式电商（多服务）</td><td>防重表（方案 4）+ 状态机（方案 3）</td><td>分布式强一致性，支持高并发</td></tr><tr><td>第三方支付回调</td><td>回调流水号校验（方案 5）</td><td>针对性处理第三方重复通知</td></tr><tr><td>秒杀支付（高并发）</td><td>防重表（方案 4）+ Redis 分布式锁</td><td>兼顾高并发与强一致性</td></tr></tbody></table>
<h3 data-id="heading-29">总结：支付幂等性的核心逻辑</h3>
<p>支付幂等性的本质是 “<strong>用唯一标识锁定操作，用状态校验控制流程</strong>”—— 无论重复请求来自用户、网络还是系统，只要通过 “唯一标识判断是否已处理”，就能保证结果一致。</p>
<p>设计时需遵循 “<strong>简单优先，兼顾场景</strong>”：</p>
<ul>
<li>中小团队 / 单体应用：优先用 “唯一订单号 + 状态机”，低成本落地；</li>
</ul>

<ul>
<li>分布式 / 高并发场景：叠加 “防重表 + 分布式锁”，保证强一致性；</li>
</ul>

<ul>
<li>第三方回调：单独用 “第三方流水号” 做幂等，避免重复通知。</li>
</ul>
<p>最终，支付幂等性是资金安全的底线，没有 “最优方案”，只有 “最适合业务场景的方案”—— 结合自身业务规模、技术架构选择组合方案，同时做好监控与日志，才能杜绝重复扣款，保障用户与平台的资金安全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter之阿里云视频播放器支持 iOS模拟器解决方案]]></title>    <link>https://juejin.cn/post/7576556950331867136</link>    <guid>https://juejin.cn/post/7576556950331867136</guid>    <pubDate>2025-11-26T03:16:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576556950331867136" data-draft-id="7576559408659103796" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter之阿里云视频播放器支持 iOS模拟器解决方案"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-26T03:16:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卢叁"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403434270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter之阿里云视频播放器支持 iOS模拟器解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403434270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卢叁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:16:30.000Z" title="Wed Nov 26 2025 03:16:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题描述</h2>
<p>项目中要做视频播放，接入阿里云的 <code>flutter_aliplayer</code>后模拟器跑不起来</p>
<pre><code class="hljs language-bash" lang="bash">Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilter</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilterConfig</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilterOptions</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPPreloadTask</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AliMediaLoaderV2</span>

</code></pre>
<h3 data-id="heading-1">问题原因</h3>
<p>AliPlayer SDK 的 <code>AliyunPlayer.framework</code> 在 iOS 模拟器架构（x86_64/arm64-simulator）中缺少以下符号的实现：</p>
<ul>
<li>
<p><code>AVPFilter</code>、<code>AVPFilterConfig</code>、<code>AVPFilterOptions</code> - 视频滤镜相关类</p>
</li>
<li>
<p><code>AVPPreloadTask</code>、<code>AliMediaLoaderV2</code> - 预加载功能相关类</p>
</li>
</ul>
<p>这些符号在真机架构（arm64）中存在，但在模拟器架构中缺失，导致链接失败。</p>
<h2 data-id="heading-2">解决方案</h2>
<p>通过在 <code>flutter_aliplayer</code> 插件中添加条件编译，在模拟器上使用存根实现，在真机上使用完整实现。</p>
<h3 data-id="heading-3">核心思路</h3>
<ol>
<li>
<p><strong><strong>条件编译</strong></strong>：使用 <code>#if TARGET_OS_SIMULATOR</code> 区分模拟器和真机</p>
</li>
<li>
<p><strong><strong>存根实现</strong></strong>：在模拟器上提供最小化实现，返回明确的错误提示</p>
</li>
<li>
<p><strong><strong>完整实现</strong></strong>：在真机上使用完整的 AliPlayer SDK 功能</p>
</li>
<li>
<p><strong><strong>依赖管理</strong></strong>：通过 <code>dependency_overrides</code> 使用修改后的本地版本</p>
</li>
</ol>
<h2 data-id="heading-4">实现细节</h2>
<h3 data-id="heading-5">1. 修改 <code>FlutterAliMediaLoaderV2.m</code></h3>
<p>为预加载 v2 功能添加模拟器存根：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">
#import "FlutterAliMediaLoaderV2.h"

#import &lt;TargetConditionals.h&gt;

#if TARGET_OS_SIMULATOR
// 模拟器版本：返回错误，不调用任何 AliPlayer API

- (void)handleMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result {

    result([FlutterError errorWithCode:@"AliPlayerPreloadV2Unavailable"

                               message:@"AliPlayer preload v2 is not available on the iOS Simulator."

                               details:nil]);

}

  


#else

// 真机版本：正常实现

// ... 原有完整实现 ...

#endif

</code></pre>
<h3 data-id="heading-6">2. 修改 AliPlayerFactory.m</h3>
<p>为滤镜功能添加模拟器保护：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">
- (void)setFilterConfig:(NSArray *)arr {

    FlutterResult result = arr[1];

#if TARGET_OS_SIMULATOR

    result([FlutterError errorWithCode:@"AliPlayerFilterUnavailable"

                               message:@"Video filter effects are not available on the iOS Simulator."

                               details:nil]);

    return;

#else

    // 真机版本：正常实现滤镜功能

    // ... 原有完整实现 ...

#endif

}

  


- (void)updateFilterConfig:(NSArray *)arr {

    FlutterResult result = arr[1];

#if TARGET_OS_SIMULATOR

    result([FlutterError errorWithCode:@"AliPlayerFilterUnavailable"

                               message:@"Video filter effects are not available on the iOS Simulator."

                               details:nil]);

    return;

#else

    // 真机版本：正常实现

    // ... 原有完整实现 ...

#endif

}

</code></pre>
<p>修改完毕后，就可以愉快的用模拟器开发啦。个人开发直接放在本地，使用模拟器开发的时候引用本地<code>flutter_aliplayer</code>包，真机上线时使用阿里云的正式包。团队开发时最好把修改后的代码上传到自己公司的git,然后配置打包脚本。</p>
<h2 data-id="heading-7">项目配置</h2>
<h3 data-id="heading-8">1. 使用 Git 仓库版本</h3>
<p>在 <code>pubspec.yaml</code> 中配置 <code>dependency_overrides</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-attr">dependency_overrides:</span>

  <span class="hljs-attr">flutter_aliplayer:</span>

    <span class="hljs-attr">git:</span>

      <span class="hljs-attr">url:</span> <span class="hljs-string">自己的.git</span>

</code></pre>
<h3 data-id="heading-9">2. 构建脚本自动切换</h3>
<p><code>build.sh</code> 脚本会在不同场景自动切换依赖源：</p>
<ul>
<li>
<p>注释掉 git 配置，使用 pub.dev 原始版本</p>
</li>
<li>
<p>取消注释 git 配置，使用包含模拟器修复的版本</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 注释掉 flutter_aliplayer git 配置，使用 pub.dev 版本</span>

comment_flutter_aliplayer_override

  


<span class="hljs-comment"># 恢复 flutter_aliplayer git 配置，使用 git 版本（包含模拟器修复）</span>

uncomment_flutter_aliplayer_override

</code></pre>
<h3 data-id="heading-10">模拟器上的限制</h3>
<p>在 iOS 模拟器上，视频播放的功能不可用，修改只是为了开发中方便使用iOS模拟器。</p>
<h3 data-id="heading-11">符号检查</h3>
<p>可以通过以下命令检查框架中的符号：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 检查所有架构</span>

lipo -info ios/Pods/AliPlayerSDK_iOS/AliyunPlayer.framework/AliyunPlayer

<span class="hljs-comment"># 检查 x86_64 架构中的符号</span>

lipo ios/Pods/AliPlayerSDK_iOS/AliyunPlayer.framework/AliyunPlayer -thin x86_64 -output /tmp/AliyunPlayer_x86_64

nm -gU /tmp/AliyunPlayer_x86_64 | grep AVPFilter

</code></pre>
<h3 data-id="heading-12">依赖管理</h3>
<ul>
<li>
<p><strong><strong>开发环境</strong></strong>：使用 git 仓库版本（包含模拟器修复）</p>
</li>
<li>
<p><strong><strong>生产环境</strong></strong>：使用 pub.dev 原始版本（避免本地修改影响生产构建）</p>
</li>
</ul>
<h2 data-id="heading-13">未来改进</h2>
<p>如果哪天<code>AliPlayer SDK</code>官方提供了包含完整模拟器支持的版本，那最好不过。</p>
<h2 data-id="heading-14">相关文件</h2>
<ul>
<li>
<p><code>plugins/flutter_aliplayer/ios/Classes/FlutterAliMediaLoaderV2.m</code> - 预加载 v2 实现</p>
</li>
<li>
<p><code>plugins/flutter_aliplayer/ios/Classes/AliPlayerFactory.m</code> - 播放器工厂实现</p>
</li>
<li>
<p><code>pubspec.yaml</code> - 依赖配置</p>
</li>
<li>
<p><code>build.sh</code> - 构建脚本</p>
</li>
</ul>
<h2 data-id="heading-15">参考资料</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fvod%2Fdeveloper-reference" target="_blank" title="https://help.aliyun.com/zh/vod/developer-reference" ref="nofollow noopener noreferrer">AliPlayer SDK 官方文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fdevelopment%2Fplatform-integration%2Fplatform-channels" target="_blank" title="https://docs.flutter.dev/development/platform-integration/platform-channels" ref="nofollow noopener noreferrer">Flutter iOS 平台特定代码</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FDeveloperTools%2FConceptual%2Fcross_development%2FUsing%2Fusing.html" target="_blank" title="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/cross_development/Using/using.html" ref="nofollow noopener noreferrer">Objective-C 条件编译</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++类型转换的隐蔽陷阱：当size_t遇见负数]]></title>    <link>https://juejin.cn/post/7577228831137660971</link>    <guid>https://juejin.cn/post/7577228831137660971</guid>    <pubDate>2025-11-27T10:55:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831137660971" data-draft-id="7577215663968124970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++类型转换的隐蔽陷阱：当size_t遇见负数"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T10:55:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++类型转换的隐蔽陷阱：当size_t遇见负数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:55:19.000Z" title="Thu Nov 27 2025 10:55:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d90ed9aea7445f7b7e461d158f6fb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845718&amp;x-signature=WWe2r7BZJwc6tTMGSMR7AIoYtZE%3D" alt="4c1920f98b528d631ce91ff20a708bd6.png" loading="lazy"/></p>
<p>在C++开发中，我们经常会遇到各种类型转换的问题，但有一种情况特别容易导致难以发现的bug——那就是无符号类型与有符号类型的混合运算。今天，我们就来深入探讨这个看似简单却暗藏玄机的问题。</p>
<h2 data-id="heading-0">一个看似无害的循环</h2>
<p>考虑下面这段代码，它看起来完全正确：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processPair</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"Processing: "</span> &lt;&lt; a &lt;&lt; <span class="hljs-string">" and "</span> &lt;&lt; b &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::vector&lt;<span class="hljs-type">int</span>&gt; data = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
    
    <span class="hljs-comment">// 处理相邻元素对</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>当向量中有数据时，这段代码运行得很好。它会输出：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Processing: 1 and 2</span>
<span class="hljs-section">Processing: 2 and 3</span>
<span class="hljs-section">Processing: 3 and 4</span>
<span class="hljs-section">Processing: 4 and 5</span>
</code></pre>
<p>但是，当我们面对一个空向量时，问题就出现了：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::vector&lt;<span class="hljs-type">int</span>&gt; empty_vec;  <span class="hljs-comment">// 空向量</span>

<span class="hljs-comment">// 同样的代码，不同的结果</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; empty_vec.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-built_in">processPair</span>(empty_vec[i], empty_vec[i + <span class="hljs-number">1</span>]);
}
</code></pre>
<p><strong>思考一下：你期望这个循环执行多少次？</strong></p>
<h2 data-id="heading-1">问题的根源：隐式类型转换</h2>
<p>要理解这个问题，我们需要深入了解C++的类型转换规则。</p>
<h3 data-id="heading-2">常用算术转换（Usual Arithmetic Conversions）</h3>
<p>在C++中，当二元操作符两边的操作数类型不同时，编译器会执行<strong>常用算术转换</strong>。其中一个关键规则是：</p>
<p><strong>当有符号类型与无符号类型进行运算时，有符号类型会被提升为无符号类型。</strong></p>
<p>让我们分解那个问题表达式：<code>empty_vec.size() - 1</code></p>
<ol>
<li><code>empty_vec.size()</code> 返回 <code>size_t</code> 类型（无符号整型）</li>
<li><code>1</code> 是 <code>int</code> 类型（有符号整型）</li>
<li>根据规则，<code>1</code> 被转换为 <code>size_t</code> 类型</li>
<li>表达式变为：<code>size_t_value - size_t(1)</code></li>
</ol>
<h3 data-id="heading-3">无符号整数的下溢行为</h3>
<p>当容器为空时：</p>
<ul>
<li><code>empty_vec.size()</code> = 0</li>
<li><code>size_t(0) - size_t(1)</code> 发生下溢</li>
</ul>
<p>由于<code>size_t</code>是无符号类型，它遵循模算术规则：</p>
<ul>
<li>下溢不会产生负数，而是回绕到该类型的最大值</li>
<li>在64位系统上，<code>0 - 1</code> 变成了 <code>18446744073709551615</code></li>
</ul>
<p>于是我们的循环条件变成了：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">18446744073709551615</span>; i++)
</code></pre>
<p>这就导致了一个几乎无限循环！</p>
<h2 data-id="heading-4">为什么这个问题如此危险？</h2>
<h3 data-id="heading-5">1. 隐蔽性极高</h3>
<p>这种bug在大多数情况下都不会出现：</p>
<ul>
<li>在测试环境中，我们很少测试空容器的情况</li>
<li>在代码审查时，这样的循环看起来完全正常</li>
<li>在有数据的正常情况下，代码运行完美</li>
</ul>
<h3 data-id="heading-6">2. 后果严重</h3>
<p>当问题真的发生时：</p>
<ul>
<li>程序陷入死循环，消耗大量CPU资源</li>
<li>可能导致整个服务不可用</li>
<li>在嵌入式或资源受限环境中可能造成系统崩溃</li>
</ul>
<h3 data-id="heading-7">3. 调试困难</h3>
<p>由于问题只在特定条件下出现：</p>
<ul>
<li>难以在开发环境中复现</li>
<li>核心转储文件可能非常大（因为循环次数极多）</li>
<li>日志输出可能淹没系统</li>
</ul>
<h2 data-id="heading-8">解决方案</h2>
<h3 data-id="heading-9">方案1：显式检查边界</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 明确检查容器大小</span>
<span class="hljs-keyword">if</span> (!data.<span class="hljs-built_in">empty</span>() &amp;&amp; data.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
    }
}
</code></pre>
<p>这是最安全的做法，明确表达了我们的意图。</p>
<h3 data-id="heading-10">方案2：调整循环条件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 避免减法操作</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i + <span class="hljs-number">1</span> &lt; data.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
}
</code></pre>
<p>这种方法通过调整比较逻辑来避免减法操作。</p>
<h3 data-id="heading-11">方案3：使用迭代器</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用标准库迭代器</span>
<span class="hljs-keyword">if</span> (data.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = data.<span class="hljs-built_in">begin</span>(); it != std::<span class="hljs-built_in">prev</span>(data.<span class="hljs-built_in">end</span>()); ++it) {
        <span class="hljs-built_in">processPair</span>(*it, *(std::<span class="hljs-built_in">next</span>(it)));
    }
}
</code></pre>
<p>迭代器方式更符合C++的惯用法。</p>
<h3 data-id="heading-12">方案4：使用标准库算法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用标准库算法（如果适用）</span>
std::<span class="hljs-built_in">adjacent_difference</span>(data.<span class="hljs-built_in">begin</span>(), data.<span class="hljs-built_in">end</span>(), 
                        std::<span class="hljs-built_in">ostream_iterator</span>&lt;<span class="hljs-type">int</span>&gt;(std::cout, <span class="hljs-string">" "</span>));
</code></pre>
<p>对于某些场景，标准库已经提供了现成的算法。</p>
<h2 data-id="heading-13">防御性编程的最佳实践</h2>
<h3 data-id="heading-14">1. 保持类型一致性</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 好：使用一致的size_t类型</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>(); i++)

<span class="hljs-comment">// 更好：如果需要减法，确保类型一致</span>
<span class="hljs-type">size_t</span> size = data.<span class="hljs-built_in">size</span>();
<span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; size - <span class="hljs-number">1</span>; i++)
}
</code></pre>
<h3 data-id="heading-15">2. 启用编译器警告</h3>
<p>现代编译器可以检测到很多类型转换问题：</p>
<pre><code class="hljs language-bash" lang="bash">g++ -Wall -Wextra -Wsign-conversion -Wsign-compare program.cpp
</code></pre>
<p>关键警告选项：</p>
<ul>
<li><code>-Wsign-conversion</code>：警告有符号/无符号转换</li>
<li><code>-Wsign-compare</code>：警告有符号/无符号比较</li>
<li><code>-Wconversion</code>：警告可能改变值的隐式转换</li>
</ul>
<h3 data-id="heading-16">3. 使用静态分析工具</h3>
<p>工具如Clang-Tidy、CPPCheck等可以帮助发现这类问题：</p>
<pre><code class="hljs language-bash" lang="bash">clang-tidy -checks=<span class="hljs-string">'*'</span> program.cpp -- -std=c++17
</code></pre>
<h3 data-id="heading-17">4. 全面的边界测试</h3>
<p>确保测试用例覆盖所有边界情况：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">TEST</span>(ContainerTest, EmptyVector) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; empty_vec;
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(empty_vec));
}

<span class="hljs-built_in">TEST</span>(ContainerTest, SingleElement) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; single_vec{<span class="hljs-number">42</span>};
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(single_vec));
}

<span class="hljs-built_in">TEST</span>(ContainerTest, NormalCase) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; normal_vec{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(normal_vec));
}
</code></pre>
<h2 data-id="heading-18">更广泛的适用场景</h2>
<p>这个问题不仅出现在<code>std::vector</code>中，还出现在所有返回<code>size_t</code>的容器中：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::string str;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-built_in">length</span>() - <span class="hljs-number">1</span>; i++) {}  <span class="hljs-comment">// 同样的问题！</span>

std::array&lt;<span class="hljs-type">int</span>, 5&gt; arr;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {}    <span class="hljs-comment">// 这里也是！</span>

<span class="hljs-comment">// 甚至自定义容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContainer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> data_size; }
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p>C++的类型系统虽然强大，但也充满了陷阱。无符号类型与有符号类型的混合运算就是其中一个典型的"坑"。通过理解背后的转换规则，并采用防御性编程策略，我们可以避免这类隐蔽的bug。</p>
<p><strong>关键要点：</strong></p>
<ul>
<li>警惕无符号类型的减法操作</li>
<li>保持运算中的类型一致性</li>
<li>启用编译器警告并使用静态分析工具</li>
<li>全面测试边界情况</li>
<li>优先使用标准库算法和迭代器</li>
</ul>
<p>记住：在C++编程中，最危险的bug往往藏在最"明显"的代码里。多一份谨慎，少一份调试的煎熬！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中不同类型的默认转换详解]]></title>    <link>https://juejin.cn/post/7577204540417982527</link>    <guid>https://juejin.cn/post/7577204540417982527</guid>    <pubDate>2025-11-27T10:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417982527" data-draft-id="7577220965437751350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中不同类型的默认转换详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T10:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中不同类型的默认转换详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:57:40.000Z" title="Thu Nov 27 2025 10:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>不熟悉默认类型转换，真的很容易写出bug！！！</p>
</blockquote>
<p>在C++中，类型转换是一个非常重要的概念。下面详细讲解C++中各种默认类型转换的规则和机制。</p>
<h2 data-id="heading-0">1. 算术类型转换</h2>
<h3 data-id="heading-1">整型提升 (Integral Promotion)</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span> c = <span class="hljs-string">'A'</span>;
<span class="hljs-type">short</span> s = <span class="hljs-number">100</span>;
<span class="hljs-type">int</span> i = c + s;  <span class="hljs-comment">// char和short都提升为int</span>
</code></pre>
<h3 data-id="heading-2">算术转换规则</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 转换优先级：long double &gt; double &gt; float &gt; unsigned long long &gt; long long &gt; </span>
<span class="hljs-comment">// unsigned long &gt; long &gt; unsigned int &gt; int</span>

<span class="hljs-type">int</span> i = <span class="hljs-number">10</span>;
<span class="hljs-type">double</span> d = <span class="hljs-number">3.14</span>;
<span class="hljs-type">double</span> result = i + d;  <span class="hljs-comment">// int转换为double</span>

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> u = <span class="hljs-number">100</span>;
<span class="hljs-type">int</span> j = <span class="hljs-number">-50</span>;
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> result2 = u + j;  <span class="hljs-comment">// int转换为unsigned int</span>
</code></pre>
<h2 data-id="heading-3">2. 指针类型转换</h2>
<h3 data-id="heading-4">隐式指针转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 派生类指针到基类指针</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {};

Derived d;
Base* bp = &amp;d;  <span class="hljs-comment">// 隐式向上转换</span>

<span class="hljs-comment">// 数组到指针退化</span>
<span class="hljs-type">int</span> arr[<span class="hljs-number">5</span>];
<span class="hljs-type">int</span>* ptr = arr;  <span class="hljs-comment">// 数组退化为指针</span>

<span class="hljs-comment">// 0或nullptr到指针</span>
<span class="hljs-type">int</span>* p1 = <span class="hljs-number">0</span>;
<span class="hljs-type">int</span>* p2 = <span class="hljs-literal">nullptr</span>;

<span class="hljs-comment">// 任意指针到void*</span>
<span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
<span class="hljs-type">void</span>* vp = &amp;x;
</code></pre>
<h2 data-id="heading-5">3. 引用类型转换</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Base"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Derived"</span> &lt;&lt; endl; }
};

Derived d;
Base&amp; br = d;  <span class="hljs-comment">// 派生类引用到基类引用</span>
br.<span class="hljs-built_in">show</span>();     <span class="hljs-comment">// 输出: Derived (多态)</span>
</code></pre>
<h2 data-id="heading-6">4. 限定符转换 (Qualification Conversions)</h2>
<h3 data-id="heading-7">const转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span>* cp = &amp;x;     <span class="hljs-comment">// 非const到const</span>
<span class="hljs-comment">// int* p = cp;         // 错误: 不能去掉const限定</span>

<span class="hljs-type">const</span> <span class="hljs-type">int</span> y = <span class="hljs-number">20</span>;
<span class="hljs-comment">// int* p2 = &amp;y;        // 错误: 不能去掉const限定</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span>* cp2 = &amp;y;    <span class="hljs-comment">// OK</span>
</code></pre>
<h3 data-id="heading-8">volatile转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> normal = <span class="hljs-number">10</span>;
<span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> vi = <span class="hljs-number">20</span>;
<span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span>* vp = &amp;normal;  <span class="hljs-comment">// 非volatile到volatile</span>
<span class="hljs-comment">// int* p = &amp;vi;            // 错误: 不能去掉volatile限定</span>
</code></pre>
<h2 data-id="heading-9">5. 布尔转换</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 以下情况会隐式转换为bool</span>
<span class="hljs-type">int</span>* ptr = <span class="hljs-literal">nullptr</span>;
<span class="hljs-keyword">if</span> (ptr) {  <span class="hljs-comment">// 指针到bool: nullptr→false, 其他→true</span>
    cout &lt;&lt; <span class="hljs-string">"Pointer is valid"</span> &lt;&lt; endl;
}

<span class="hljs-type">int</span> value = <span class="hljs-number">10</span>;
<span class="hljs-keyword">if</span> (value) {  <span class="hljs-comment">// 算术类型到bool: 0→false, 非0→true</span>
    cout &lt;&lt; <span class="hljs-string">"Value is non-zero"</span> &lt;&lt; endl;
}
</code></pre>
<h2 data-id="heading-10">6. 用户定义类型转换</h2>
<h3 data-id="heading-11">转换构造函数</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyString</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">char</span>* str;
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 转换构造函数: const char* → MyString</span>
    <span class="hljs-built_in">MyString</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* s) {
        str = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-built_in">strlen</span>(s) + <span class="hljs-number">1</span>];
        <span class="hljs-built_in">strcpy</span>(str, s);
    }
    
    ~<span class="hljs-built_in">MyString</span>() { <span class="hljs-keyword">delete</span>[] str; }
};

MyString s = <span class="hljs-string">"Hello"</span>;  <span class="hljs-comment">// 隐式调用转换构造函数</span>
</code></pre>
<h3 data-id="heading-12">类型转换运算符</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartBool</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">bool</span> value;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">SmartBool</span>(<span class="hljs-type">bool</span> b) : <span class="hljs-built_in">value</span>(b) {}
    
    <span class="hljs-comment">// 类型转换运算符: SmartBool → bool</span>
    <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> value;
    }
};

SmartBool sb = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">if</span> (sb) {  <span class="hljs-comment">// 隐式调用operator bool()</span>
    cout &lt;&lt; <span class="hljs-string">"SmartBool is true"</span> &lt;&lt; endl;
}
</code></pre>
<h2 data-id="heading-13">7. 标准转换序列</h2>
<p>C++编译器会尝试以下标准转换序列：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> {};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(A a)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    B b;
    <span class="hljs-built_in">func</span>(b);  <span class="hljs-comment">// 标准转换: B → A (派生类到基类)</span>
    
    <span class="hljs-comment">// 可能的转换序列:</span>
    <span class="hljs-comment">// 1. 精确匹配</span>
    <span class="hljs-comment">// 2. 提升转换</span>
    <span class="hljs-comment">// 3. 标准转换</span>
    <span class="hljs-comment">// 4. 用户定义转换</span>
    <span class="hljs-comment">// 5. 省略号匹配</span>
}
</code></pre>
<h2 data-id="heading-14">8. 显式控制隐式转换</h2>
<h3 data-id="heading-15">explicit关键字</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExplicitClass</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ExplicitClass</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>{}  <span class="hljs-comment">// 禁止隐式转换</span>
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">(ExplicitClass ec)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// ExplicitClass ec = 10;  // 错误: 不能隐式转换</span>
    <span class="hljs-function">ExplicitClass <span class="hljs-title">ec</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;      <span class="hljs-comment">// OK: 直接初始化</span>
    <span class="hljs-built_in">test</span>(<span class="hljs-built_in">ExplicitClass</span>(<span class="hljs-number">10</span>));   <span class="hljs-comment">// OK: 显式转换</span>
}
</code></pre>
<h3 data-id="heading-16">删除转换函数</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NoConvert</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">NoConvert</span>(<span class="hljs-type">int</span>) {}
    
    <span class="hljs-comment">// 删除不需要的转换</span>
    <span class="hljs-built_in">NoConvert</span>(<span class="hljs-type">double</span>) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> </span>= <span class="hljs-keyword">delete</span>;
};

<span class="hljs-function">NoConvert <span class="hljs-title">nc</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;    <span class="hljs-comment">// OK</span>
<span class="hljs-comment">// NoConvert nc(3.14); // 错误: 使用已删除的函数</span>
<span class="hljs-comment">// if (nc) {}         // 错误: 使用已删除的函数</span>
</code></pre>
<h2 data-id="heading-17">9. 转换的优先级和歧义</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Ambiguous</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Ambiguous</span>(<span class="hljs-type">int</span> x) {}
    <span class="hljs-built_in">Ambiguous</span>(<span class="hljs-type">double</span> x) {}
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(Ambiguous a)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// func(10);     // 歧义: int可以转换为int或double</span>
    <span class="hljs-built_in">func</span>(<span class="hljs-built_in">Ambiguous</span>(<span class="hljs-number">10</span>));  <span class="hljs-comment">// 必须显式指定</span>
}
</code></pre>
<h2 data-id="heading-18">10. 最佳实践和注意事项</h2>
<ol>
<li>
<p><strong>避免意外的隐式转换</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用explicit防止意外的构造函数转换</span>
<span class="hljs-comment">// 小心算术类型转换的精度损失</span>
</code></pre>
</li>
<li>
<p><strong>注意符号性和大小</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> u = <span class="hljs-number">10</span>;
<span class="hljs-type">int</span> i = <span class="hljs-number">-5</span>;
<span class="hljs-keyword">if</span> (u &gt; i) {  <span class="hljs-comment">// i转换为unsigned int, 结果可能出乎意料</span>
    cout &lt;&lt; <span class="hljs-string">"Unexpected result!"</span> &lt;&lt; endl;
}
</code></pre>
</li>
<li>
<p><strong>使用static_cast进行显式转换</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">double</span> d = <span class="hljs-number">3.14</span>;
<span class="hljs-type">int</span> i = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(d);  <span class="hljs-comment">// 明确的意图</span>
</code></pre>
</li>
</ol>
<p>理解C++的类型转换规则对于编写安全、高效的代码至关重要。在可能产生歧义或意外行为的地方，建议使用显式转换来明确意图。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 8 款最佳远程协作工具]]></title>    <link>https://juejin.cn/post/7577215663967420458</link>    <guid>https://juejin.cn/post/7577215663967420458</guid>    <pubDate>2025-11-27T09:02:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663967420458" data-draft-id="7577215663967387690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年 8 款最佳远程协作工具"/> <meta itemprop="keywords" content="后端,远程工作,前端"/> <meta itemprop="datePublished" content="2025-11-27T09:02:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年 8 款最佳远程协作工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:02:42.000Z" title="Thu Nov 27 2025 09:02:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>现在不少开发团队会选择远程办公，但他们的协作效率问题依然存在。介绍几款好用的远程协作工具，提升开发效率。</p>
<h3 data-id="heading-0">直击开发核心：从环境到编码的无缝协作</h3>
<p>对开发者来说，最高效的协作，就是能让大家像坐在同一间办公室里一样，面对同样的环境、同样的代码，顺畅地沟通。下面这几个工具，就是为了实现这个目标。</p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">ServBay</a>：对齐团队开发环境的颗粒度</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d0fd44ddff4516b14577392afcfb47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=ZGnJ4sejl1P6BFljDCOl6NOOJnM%3D" alt="" loading="lazy"/></p>
<p>“我电脑上跑得好好的啊！” 这句话你肯定不陌生。一个团队里，老张用 PHP 8.1，老李用 8.2，老外的 Node.js 还是旧版本，光是解决这些环境差异带来的 bug，就能耗费掉大量时间。</p>
<p>ServBay就是解决这些问题而存在。</p>
<p>ServBay 本身是一个非常强大的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">本地 Web 开发环境集成工具</a>，支持 PHP、Node.js、Python、Go、Java 等各种语言和数据库。但它真正让我觉得惊艳的，是它的团队协作功能。</p>
<p>它通过 <code>.servbay.config</code> 的配置文件，把团队开发环境不一致这个难题给解决了。</p>
<p>通过 <code>.servbay.config</code> ，团队负责人可以在这个文件里，精确指定项目需要用到的 Python 版本、Node.js 版本或者其他的语言，甚至是 Node.js 包管理器的仓库地址和缓存目录。然后把这个文件随代码一起提交到 Git 仓库。</p>
<p>这样一来，团队协作的体验就完全不同了：</p>
<ul>
<li><strong>告别“我这儿没问题”的问题</strong>：团队里所有人，只要拉下代码，ServBay 就会自动根据 <code>.servbay.config</code> 文件来切换和配置环境。确保了从开发、测试到最终上线，环境都是高度一致的。</li>
<li><strong>新人入职速度快到飞起</strong>：新人来了，不用再对着长长的文档折腾半天环境。直接用团队的 <code>.servbay.config</code> 文件，几分钟就能把项目跑起来，马上就能投入工作。</li>
<li><strong>环境管理不再是散装的</strong>：团队的技术负责人可以统一管理和更新这份配置文件。比如项目需要升级语言版本，只需要修改一下文件，团队成员下次拉取代码时，环境就自动同步了。</li>
<li><strong>大家能更专注于写代码</strong>：环境统一了，因为环境问题导致的冲突和阻塞就少了。开发者可以把精力都放在业务逻辑上，协作效率自然就高了。</li>
</ul>
<p>ServBay的这个功能，不管是远程工作还是线下工作，都是必不可少的。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fblogs%2F2017%2F11%2F15%2Flive-share" target="_blank" title="https://code.visualstudio.com/blogs/2017/11/15/live-share" ref="nofollow noopener noreferrer">Live Share</a>：身临其境的远程结对编程</h4>
<p>环境统一了，下一步就是怎么高效地一起写代码。Live Share 是 VS Code 的一个插件，它能让开发者把自己的编辑器分享给队友。队友可以直接进入你的编辑器，实时看到你的代码，和你一起编辑、调试，甚至共享你的终端。</p>
<p>整个过程非常流畅，就像他坐在你旁边一样。</p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGruntfuggly%2Ftodo-tree" target="_blank" title="https://github.com/Gruntfuggly/todo-tree" ref="nofollow noopener noreferrer">Todo Tree</a>：代码中的异步备忘录</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26ca1444f1943dfbbc67e64c7920b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=NU8X4%2BsTDrByAYEJ4UHcgKQQoMA%3D" alt="" loading="lazy"/></p>
<p>不是所有问题都需要拉着人实时沟通。有时候，我们在代码里发现一个小bug，可以先记下来。Todo Tree 这个 VS Code 插件就能派上用场。</p>
<p>它能扫描整个项目代码里的 <code>TODO</code>、<code>FIXME</code> 等注释，并把它们集中在一个视图里展示。这样，在写代码时随手记下的待办事项就不会被遗忘。在 Code Review 的时候，团队成员也能清晰地看到还有哪些地方需要完善，算是一种轻量级的、代码层面的异步协同。</p>
<h3 data-id="heading-4">任务与项目管理：为开发流程服务的骨架</h3>
<p>代码层面的协作理顺了，我们再来看更高一层的项目管理。这里的工具选择很多，它们各有侧重，适合不同风格的团队。</p>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Flinear.app%2F" target="_blank" title="https://linear.app/" ref="nofollow noopener noreferrer">Linear</a>：追求极致速度的开发者首选</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6efc5bc49bd460a9129b40d94ee8abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=mpx0ELjmDCwjvnrh9rCDh6y%2BSGc%3D" alt="" loading="lazy"/></p>
<p>如果你受够了 Jira 的臃肿和卡顿，Linear 绝对能让你眼前一亮。它的界面极简、响应飞快，所有操作基本都能用键盘快捷键完成。它和 GitHub 的集成做得非常好，代码提交能自动更新任务状态。用它来管理 Sprint 和 Bug，感觉就像在写代码一样流畅。</p>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Ftrello.com%2F" target="_blank" title="https://trello.com/" ref="nofollow noopener noreferrer">Trello</a>：简单直观的看板</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5098b3c992ad4b5fba1051bff91af2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=Wt%2BA6I9g2NPJbKD7jn3Yjc%2FVMZ4%3D" alt="" loading="lazy"/></p>
<p>Trello 就像一块白板和一堆便利贴。它的核心就是看板（Board）、列表（List）、卡片（Card）。操作简单直观，学习成本几乎为零。非常适合规模不大、流程不复杂的团队，或者用来管理一些临时的、非核心的项目。</p>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fmonday.com%2F" target="_blank" title="https://monday.com/" ref="nofollow noopener noreferrer">Monday</a>：高度定制化的项目工具</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0440d1d54b241ecadfdfb76d7203582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=eKuNsDDgmlt%2BZiEOt0QLhsuBVO0%3D" alt="" loading="lazy"/></p>
<p>Monday 更像一个工作操作系统。它的强大之处在于高度的可定制性，你可以用它搭建出各种各样的工作流。它的各种视图（时间线、图表）非常丰富，很适合需要向管理层或非技术同事展示项目进度的场景。</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.teamcamp.app%2F" target="_blank" title="https://www.teamcamp.app/" ref="nofollow noopener noreferrer">Teamcamp</a>：整合代码与任务的一体化平台</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2165b0336a7f46078001fccf541ec6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=pEuhq67X8odcTA4RAeOJD1NQEms%3D" alt="" loading="lazy"/></p>
<p>Teamcamp 的思路是把项目管理和代码工作流更紧密地结合起来。比如它的一个特色是 Git 提交可以自动更新任务状态，减少了开发者在任务板和代码库之间来回切换的手动操作。如果想要任务状态能和代码进度强绑定，它可以作为一个不错的选择。</p>
<h3 data-id="heading-9">时间与效率追踪</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fclockify.me%2F" target="_blank" title="https://clockify.me/" ref="nofollow noopener noreferrer">Clockify</a>：简单直接的时间记录工具</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2a9937d241449fdad7ef01d4d55e728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=nFqE9JzeCd1b%2Bys3iGW5rXQ%2FDMc%3D" alt="" loading="lazy"/></p>
<p>远程工作，有时候需要记录一下自己在各个项目上花了多少时间，以便评估工作量或进行项目复盘。Clockify 是一个免费又简单的时间追踪工具。它没什么学习成本，可以按项目、按任务来记录时间，也能生成简单的报表。如果你只是需要一个不打扰、不复杂的工具来记录工时，它足够了。</p>
<h3 data-id="heading-11">总结一下</h3>
<p>一个好的远程协作工具栈，有自己擅长的领域：</p>
<ul>
<li>
<p><strong>ServBay</strong> 负责打好地基，统一开发环境。</p>
</li>
<li>
<p><strong>Linear、Trello、Monday、Teamcamp</strong> 负责搭建项目管理的骨架，风格各异，按需使用。</p>
</li>
<li>
<p><strong>Live Share</strong> 和 <strong>Todo</strong> <strong>Tree</strong> 负责填充代码协作的血肉，一个实时、一个异步。</p>
</li>
<li>
<p><strong>Clockify</strong> 负责最后的度量和复盘。</p>
</li>
</ul>
<p>先把地基打牢，上层的协作才会事半功倍。希望这些工具能帮到你和你的团队。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何打造AI时代的数据基石 | Databend Meetup 上海站]]></title>    <link>https://juejin.cn/post/7577204540417228863</link>    <guid>https://juejin.cn/post/7577204540417228863</guid>    <pubDate>2025-11-27T09:08:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417228863" data-draft-id="7577220965437079606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何打造AI时代的数据基石 | Databend Meetup 上海站"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-27T09:08:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Databend"/> <meta itemprop="url" content="https://juejin.cn/user/4477651847485534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何打造AI时代的数据基石 | Databend Meetup 上海站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4477651847485534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Databend
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:08:58.000Z" title="Thu Nov 27 2025 09:08:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数据洪流奔涌，AI 浪潮澎湃。当 Data 与 AI 深度交织，如何构建面向未来的技术栈？如何基于亚马逊云科技构数据分析业务？11月29日「如何打造AI时代的数据基石 | Databend Meetup 上海站」 应势而来！我们力邀多位来自明星开源项目与一线大厂的资深专家，为您全景解析数据平台架构、AI 创新实践与职业发展路径，开启一场思想与技术的碰撞。</p>
<p>本次 Meetup，我们荣幸地邀请到 Databend Labs 联合创始人吴炳锡、沉浸式翻译技术专家陈琦、数据平台架构师邵锋、平凯星辰（TiDB）解决方案架构师刘源、Airwallex 空中云汇数据库架构师赵飞祥，他们将带来兼具深度与广度的干货分享，为您呈现一场 Data + AI 的实践。</p>
<h2 data-id="heading-0">活动信息</h2>
<p>⏰ 活动时间：2025 年 11 月 29 日（周六）13:30 - 17:30</p>
<p>📍 活动地点：上海市黄浦区中海国际中心 A 座 21 楼 </p>
<p>🔗 报名方式：（扫描海报二维码）线下参与采取审核制 (100 人)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124728b4348f4bbd9806b0c14104e8e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGF0YWJlbmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839337&amp;x-signature=Yw%2FRhuOP3GIs7koFqUSbE3%2BHeUQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">活动亮点</h2>
<p>一线实战： 嘉宾来自业内知名企业及开源项目，分享内容源于真实业务场景。</p>
<p>全景视角： 覆盖从开源工具、AI 产品到企业级平台的完整产业链视角。</p>
<p>深度互动： 圆桌讨论与交流环节，让您有机会与嘉宾直接对话。</p>
<p>高端人脉： 结识众多对 Data 和 AI 充满热情的同道中人，拓展专业人脉圈。</p>
<h2 data-id="heading-2">活动参与奖励</h2>
<p>🎁 丰厚参会福利：Databend 社区丰富周边,另有技术资料等你来拿~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b583891dbd246d0bdb544ec905eb85b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGF0YWJlbmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839337&amp;x-signature=oMMykhkhFrk8VEEPQ3FZcL0s9mI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">立即行动，锁定席位！</h3>
<ul>
<li>活动主题： DATA AI Databend Meetup</li>
<li>活动形式： 线下分享 + 圆桌讨论 + 自由交流</li>
</ul>
<p>无论您是数据工程师、AI 开发者、技术负责人，还是对数据智能充满好奇的学习者，这都将是一场收获满满的盛会。席位有限，请立即报名，与我们一同站在技术浪潮之巅，共绘 Data 与 AI 的未来图景！</p>
<h2 data-id="heading-4">关于 Databend</h2>
<p>Databend 是一款 100% Rust 构建、面向对象存储设计的新一代开源云原生数据仓库，统一支持 BI 分析、AI 向量、全文检索及地理空间分析等多模态能力。期待您的关注，一起打造新一代开源 AI + Data Cloud。</p>
<p>👨‍💻‍ Databend Cloud：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdatabend.cn" target="_blank" title="https://databend.cn" ref="nofollow noopener noreferrer">databend.cn</a></p>
<p>📖 Databend 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn" target="_blank" title="https://docs.databend.cn" ref="nofollow noopener noreferrer">docs.databend.cn</a></p>
<p>💻 Wechat：Databend</p>
<p>✨ GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" target="_blank" title="https://github.com/databendlabs/databend" ref="nofollow noopener noreferrer">github.com/databendlab…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案]]></title>    <link>https://juejin.cn/post/7577215663967535146</link>    <guid>https://juejin.cn/post/7577215663967535146</guid>    <pubDate>2025-11-27T09:10:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663967535146" data-draft-id="7577198193215094827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:10:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:10:13.000Z" title="Thu Nov 27 2025 09:10:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在许多团队中，iOS 加固往往是构建链路中被忽略的一环。
要么依赖人工操作，要么走专人执行，导致：</p>
<ul>
<li>混淆策略不统一</li>
<li>某些渠道包忘记加固</li>
<li>手工操作易出错</li>
<li>不同构建之间映射表不一致</li>
<li>发布流程不可审计、不可追踪</li>
<li>审核前的加固步骤临时补救、压力巨大</li>
</ul>
<p>而随着 <strong>Ipa Guard CLI</strong> 支持命令行操作、支持符号文件、可控混淆策略，iOS 加固终于可以被正式纳入 <strong>CI/CD 流程</strong>，实现：</p>
<p>自动加固
自动测试
自动重签
自动上传
自动归档混淆映射表
可回滚、可审计、可追踪</p>
<p>本文将从 DevOps 实践角度介绍如何让 <strong>Ipa Guard + CI/CD</strong> 形成完整闭环，并结合 MobSF、kxsign、Frida/Hopper、KMS 等工具给出整套自动化方案。</p>
<hr/>
<h2 data-id="heading-0">一、为什么要把 Ipa Guard 集成到 CI/CD？</h2>
<h3 data-id="heading-1"><strong>1. 消除人工步骤，降低风险</strong></h3>
<p>手动混淆容易出错，尤其是多渠道、多版本、多团队。</p>
<h3 data-id="heading-2"><strong>2. 加固策略可控、可治理</strong></h3>
<p>使用 sym.json，确保每次混淆一致性。</p>
<h3 data-id="heading-3"><strong>3. 映射表自动归档</strong></h3>
<p>用于崩溃符号化、问题回溯与审计。</p>
<h3 data-id="heading-4"><strong>4. 拉齐多个版本流程</strong></h3>
<p>主包、渠道包、品牌定制包都可统一处理。</p>
<h3 data-id="heading-5"><strong>5. 形成可证实的安全链路</strong></h3>
<p>对外合规与内部审计更友好。</p>
<p>因此，Ipa Guard CLI 的命令行能力为构建流水线奠定了最佳基础。</p>
<hr/>
<h2 data-id="heading-6">二、CI/CD 中需要的工具矩阵（全链路自动化）</h2>























































<table><thead><tr><th>阶段</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF、class-dump</td><td>自动识别暴露符号，辅助生成白名单</td></tr><tr><td>IPA 解析</td><td><strong>Ipa Guard CLI parse</strong></td><td>导出符号文件 sym.json</td></tr><tr><td>策略生成</td><td>自定义脚本</td><td>自动合并白名单或策略模板</td></tr><tr><td>IPA 加固</td><td><strong>Ipa Guard CLI protect</strong></td><td>自动混淆、资源扰动、MD5 修改</td></tr><tr><td>重签名</td><td>kxsign</td><td>生成可安装 ipa（Dev / Adhoc / Release）</td></tr><tr><td>自动测试</td><td>XCTest / UI 自动化 / 真机组</td><td>验证加固后稳定性</td></tr><tr><td>安全验证</td><td>Frida、Hopper</td><td>自动检查关键方法是否被混淆</td></tr><tr><td>归档</td><td>KMS / S3 / 内网文件库</td><td>保存映射表、产物与审计日志</td></tr><tr><td>分发</td><td>Fastlane / GitLab Runner / Jenkins</td><td>自动上传 TestFlight / 内部分发平台</td></tr></tbody></table>
<p>这是一套可控、可维护的 iOS 加固流水线体系。</p>
<hr/>
<h2 data-id="heading-7">三、Ipa Guard 在 CI/CD 中的完整集成流程</h2>
<p>下面以 Jenkins/GitLab CI 为例介绍流水线。</p>
<hr/>
<h2 data-id="heading-8"><strong>① Step 1：生成基础 IPA</strong></h2>
<p>来自：</p>
<ul>
<li>Xcode 构建（主包）</li>
<li>外包提交的 IPA</li>
<li>渠道包</li>
<li>自动构建流程</li>
</ul>
<p>将 IPA 存放到 <code>$WORKSPACE/app.ipa</code></p>
<hr/>
<h2 data-id="heading-9"><strong>② Step 2：导出可混淆符号（自动执行）</strong></h2>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>CI 将生成的 <code>sym.json</code> 上传到：</p>
<ul>
<li>内网仓库</li>
<li>Git repo</li>
<li>或者 KMS 存储</li>
</ul>
<p>用于审计。</p>
<hr/>
<h2 data-id="heading-10"><strong>③ Step 3：自动编辑符号（策略合并）</strong></h2>
<p>通常包含两部分：</p>
<h3 data-id="heading-11">1. 项目专属白名单（如 MethodChannel、JSBridge 黑名单）</h3>
<p>由安全团队维护，例如：</p>
<pre><code class="hljs">whitelist.json
</code></pre>
<h3 data-id="heading-12">2. 自动生成的 sym.json（来自 parse）</h3>
<p>脚本自动合并两者，得到最终可混淆策略：</p>
<pre><code class="hljs">merged_sym.json
</code></pre>
<hr/>
<h2 data-id="heading-13"><strong>④ Step 4：执行 Ipa Guard 混淆（CI 核心步骤）</strong></h2>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect app.ipa \
  -c merged_sym.json \
  --email team@company.com \
  --image \
  --js \
  -o protected.ipa
</code></pre>
<p>CI 自动完成：</p>
<p>Swift/ObjC 方法、类名混淆
变量名混淆
图片、资源文件名扰动
JSON/JS/H5 路径修改
MD5 修改
生成映射表（用于回滚与符号化）</p>
<p>所有结果自动备份。</p>
<hr/>
<h2 data-id="heading-14"><strong>⑤ Step 5：自动重签名</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa \
  -c cert.p12 \
  -p $CERT_PASSWORD \
  -m profile.mobileprovision \
  -z <span class="hljs-type">signed</span>.ipa
</code></pre>
<p>可自动生成：</p>
<ul>
<li>Dev 测试包</li>
<li>Adhoc 内测包</li>
<li>Release 提审包</li>
<li>渠道专属签名包</li>
</ul>
<p>CI 下发对应文件即可。</p>
<hr/>
<h2 data-id="heading-15"><strong>⑥ Step 6：自动化测试（可选但强烈建议）</strong></h2>
<p>包括：</p>
<ul>
<li>XCTest 单元测试</li>
<li>XCUITest UI 自动化</li>
<li>真机自动化跑一遍主流程</li>
<li>或者使用第三方真机集群（如内部设备农场）</li>
</ul>
<p>重点验证：</p>
<ul>
<li>混淆后是否崩溃</li>
<li>JS/H5 页面是否正常</li>
<li>Flutter/RN 是否正常加载</li>
<li>SDK（登录/支付）是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-16"><strong>⑦ Step 7：自动逆向验证（可自动执行）</strong></h2>
<h3 data-id="heading-17">1. class-dump 应该完全看不懂</h3>
<h3 data-id="heading-18">2. Frida Hook 应该难以直接定位方法名称</h3>
<h3 data-id="heading-19">3. Hopper 中符号应该全乱码</h3>
<p>脚本自动比对是否存在可读符号：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span>-dump <span class="hljs-type">signed</span>.ipa | grep <span class="hljs-string">"Controller"</span>
</code></pre>
<p>若输出不为空 → 阻断发布</p>
<hr/>
<h2 data-id="heading-20"><strong>⑧ Step 8：保存映射表、审计数据</strong></h2>
<p>CI 自动将：</p>
<ul>
<li>映射表</li>
<li>sym.json</li>
<li>merged_sym.json</li>
<li>ipa 产物</li>
<li>构建号、Git 提交</li>
<li>时间戳、操作日志</li>
</ul>
<p>归档至：</p>
<ul>
<li>内部对象存储（S3、OSS、COS）</li>
<li>KMS 加密机制</li>
<li>内部符号化服务（Sentry/Bugly）</li>
</ul>
<p>实现完整可追踪治理体系。</p>
<hr/>
<h2 data-id="heading-21"><strong>⑨ Step 9：自动分发 / 上传审核</strong></h2>
<p>通过 Fastlane：</p>
<pre><code class="hljs">fastlane deliver
</code></pre>
<p>或内部分发平台：</p>
<ul>
<li>蒲公英</li>
<li>自建分发</li>
<li>Jenkins Artifacts</li>
</ul>
<p>从此 iOS 加固成为流水线自动的一环。</p>
<hr/>
<h2 data-id="heading-22">四、Ipa Guard 集成 CI/CD 的最终效果</h2>
<p>当这套流程跑通后，你会获得：</p>
<h3 data-id="heading-23">自动混淆</h3>
<h3 data-id="heading-24">自动重签</h3>
<h3 data-id="heading-25">自动测试</h3>
<h3 data-id="heading-26">自动审计</h3>
<h3 data-id="heading-27">自动逆向检测</h3>
<h3 data-id="heading-28">自动分发</h3>
<h3 data-id="heading-29">结构清晰、可回滚</h3>
<h3 data-id="heading-30">有映射表可符号化</h3>
<p>整个 iOS 加固不再依靠人工，而是：</p>
<p><strong>自动化、可重复、可审计、可治理。</strong></p>
<p>这才是现代移动团队应该达到的安全水平。</p>
<hr/>
<h2 data-id="heading-31">五、总结：Ipa Guard 与 CI/CD 的结合，是工程体系升级的关键</h2>
<p>最终推荐组合如下：</p>
<h3 data-id="heading-32"><strong>分析层</strong></h3>
<p>MobSF、class-dump</p>
<h3 data-id="heading-33"><strong>加固层（核心）</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 混淆</li>
<li>资源扰动</li>
<li>加固策略控制</li>
</ul>
<h3 data-id="heading-34"><strong>验证层</strong></h3>
<p>kxsign、Frida、Hopper、自动化测试</p>
<h3 data-id="heading-35"><strong>治理层</strong></h3>
<p>KMS、Sentry/Bugly、GitLab/Jenkins 归档</p>
<h3 data-id="heading-36"><strong>分发层</strong></h3>
<p>Fastlane、Jenkins、内部平台</p>
<p>通过这套链路，iOS 加固才能“工程化”，而不是“手工化”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Axios 请求取消机制详解]]></title>    <link>https://juejin.cn/post/7577042851080880171</link>    <guid>https://juejin.cn/post/7577042851080880171</guid>    <pubDate>2025-11-27T09:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577042851080880171" data-draft-id="7576994308274307091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Axios 请求取消机制详解"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-27T09:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Axios 请求取消机制详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:14:51.000Z" title="Thu Nov 27 2025 09:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Axios是否真的支持取消请求呢</h2>
<p>是的，<strong>Axios 完全支持取消请求</strong>。</p>
<p>Axios 提供了两种主要的取消请求的方式：</p>
<ol>
<li><strong>使用 <code>AbortController</code> (推荐，现代浏览器和 Node.js 环境)</strong></li>
<li><strong>使用 <code>CancelToken</code> (旧版方式，Axios 0.22.0 之前的主要方式，现在已废弃但仍兼容)</strong></li>
</ol>
<hr/>
<h3 data-id="heading-1">1. 使用 <code>AbortController</code> (推荐)</h3>
<p><code>AbortController</code> 是 Web 标准 API，用于中止一个或多个 Web 请求。Axios 从 v0.22.0 开始支持它，并推荐使用这种方式。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 AbortController 实例</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>; <span class="hljs-comment">// 获取 AbortSignal 对象</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 signal</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 controller.abort()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 这会触发 signal 上的 abort 事件，Axios 会捕获并取消请求</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>是 Web 标准 API，不仅限于 Axios，也可以用于 <code>fetch</code> API 或其他支持 <code>AbortSignal</code> 的异步操作。</li>
<li>更现代、更简洁的 API 设计。</li>
<li>可以取消多个请求（将同一个 <code>signal</code> 传递给多个请求）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 使用 <code>CancelToken</code> (旧版，已废弃但仍兼容)</h3>
<p><code>CancelToken</code> 是 Axios 早期提供的取消请求机制。虽然现在推荐使用 <code>AbortController</code>，但如果你在使用旧版本的 Axios 或者需要兼容旧代码，它仍然可用。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 CancelToken.Source 工厂函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CancelToken</span> = axios.<span class="hljs-property">CancelToken</span>;
<span class="hljs-keyword">const</span> source = <span class="hljs-title class_">CancelToken</span>.<span class="hljs-title function_">source</span>(); <span class="hljs-comment">// source 对象包含 token 和 cancel 方法</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 token</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { <span class="hljs-attr">cancelToken</span>: source.<span class="hljs-property">token</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 source.cancel()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  source.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">'用户取消了请求'</span>); <span class="hljs-comment">// 传入一个可选的消息</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>在旧版本 Axios 中广泛使用。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Axios 特有的 API，不适用于其他 Web API。</li>
<li>已被 <code>AbortController</code> 替代，未来可能不再维护或推荐。</li>
</ul>
<hr/>
<h3 data-id="heading-3">何时需要取消请求？</h3>
<p>取消请求在前端开发中非常有用，常见场景包括：</p>
<ol>
<li><strong>组件卸载时</strong>：当用户在请求完成前切换页面或组件被销毁时，避免因请求返回后尝试更新已不存在的组件状态而导致的内存泄漏或错误。</li>
<li><strong>用户操作取消</strong>：例如，用户点击了“取消上传”按钮，或在搜索框中快速输入时，取消之前的旧搜索请求，只保留最新的请求。</li>
<li><strong>避免重复请求</strong>：在某些情况下，为了防止用户多次点击或快速触发某个操作导致发送多个相同的请求，可以在新请求发出前取消旧请求。</li>
</ol>
<p>总之，Axios 提供了强大且灵活的请求取消机制，推荐在现代项目中使用 <code>AbortController</code>。</p>
<h2 data-id="heading-4">这种取消是前端拒绝接收数据还是真的停止http的请求链接呢？</h2>
<h3 data-id="heading-5">1. 它是如何“真取消”的？（浏览器层面）</h3>
<p>当你调用 <code>controller.abort()</code>（或旧版的 <code>cancelToken</code>）时，Axios 会调用浏览器底层的 API（<code>XMLHttpRequest.abort()</code> 或 <code>fetch</code> 的 signal 机制）。</p>
<p>这意味着：</p>
<ul>
<li><strong>网络连接被切断</strong>：浏览器会立即关闭与服务器的 TCP 连接。</li>
<li><strong>停止接收数据</strong>：如果服务器正在发送一个很大的响应（比如下载一个 100MB 的文件），浏览器会立刻停止下载，<strong>节省带宽</strong>。</li>
<li><strong>Promise 立即 Reject</strong>：Axios 的 Promise 会立刻抛出一个 <code>CanceledError</code>，你的代码会立刻进入 <code>.catch()</code>，而不需要等待服务器响应超时。</li>
</ul>
<p><strong>对比：</strong>  如果仅仅是“前端不予接收”，浏览器会傻傻地把 100MB 下载完，然后你的代码再把数据扔掉。<strong>Axios 的取消是前者，直接掐断连接，节省资源。</strong></p>
<hr/>
<h3 data-id="heading-6">2. 服务器端发生了什么？（后端层面）</h3>
<p>这是最容易产生误解的地方。 <strong>“前端取消了请求”并不代表“后端撤销了操作”。</strong></p>
<ul>
<li>
<p><strong>请求已发出</strong>：在大多数情况下，当你点击取消时，请求指令已经通过网络发送到了服务器。</p>
</li>
<li>
<p><strong>服务器正在处理</strong>：服务器收到请求后，开始查询数据库、计算数据或写入记录。</p>
</li>
<li>
<p><strong>连接中断</strong>：此时前端断开了连接。</p>
<ul>
<li><strong>大多数后端框架（如 Java Spring, Node Express, Python Flask）</strong> ：通常<strong>不会</strong>自动检测连接断开而停止业务逻辑。它们会继续把活干完（比如把数据写进数据库），然后试图把结果返回给前端。</li>
<li><strong>结果</strong>：当服务器试图返回结果时，发现连接已经没了，服务器会报错（如 <code>Broken pipe</code>），但之前的业务逻辑（如写库）可能已经执行了。</li>
</ul>
</li>
</ul>
<p><strong>举个例子：</strong><br/>
你在餐厅点了一道菜（<strong>发送请求</strong>）。<br/>
厨师开始做菜（<strong>服务器处理</strong>）。<br/>
你突然有急事走了，跟服务员说“我不要了”（<strong>前端取消请求</strong>）。</p>
<ul>
<li><strong>前端视角</strong>：你走了，没吃到菜，也没付钱（节省了时间和资源）。</li>
<li><strong>后端视角</strong>：厨师可能已经把菜做好了，发现没人吃，只能倒掉。<strong>但菜确实被做出来了（副作用已产生）。</strong></li>
</ul>
<hr/>
<h3 data-id="heading-7">3. 总结：三种情况</h3>
<p>根据取消的时机不同，效果也不同：</p>
<ol>
<li>
<p><strong>请求还在排队（极少见）</strong> ：</p>
<ul>
<li>浏览器还没来得及把请求发出去你就取消了。</li>
<li><strong>结果</strong>：服务器完全不知道有这回事，这是最彻底的取消。</li>
</ul>
</li>
<li>
<p><strong>请求在传输中/服务器处理中（最常见）</strong> ：</p>
<ul>
<li>请求已发，服务器正在算，前端取消。</li>
<li><strong>结果</strong>：前端断开连接，不再等待。服务器可能还是会把活干完，但发不回来。<strong>这对前端来说是真取消（不卡界面、不费流量），对后端来说通常无法撤销副作用。</strong></li>
</ul>
</li>
<li>
<p><strong>响应已到达浏览器</strong>：</p>
<ul>
<li>服务器数据已经发回来了，浏览器刚收到，你正好点了取消。</li>
<li><strong>结果</strong>：这时候其实已经晚了，Axios 只是抛个错让你忽略结果。这就变成了你说的“前端不予接收”。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">核心建议</h3>
<ul>
<li><strong>用于优化体验</strong>：Axios 的取消非常适合用于<strong>搜索框联想</strong>（输入 <code>a</code> 发请求，紧接着输入 <code>ab</code>，此时取消 <code>a</code> 的请求）或<strong>切换 Tab</strong>。这能有效防止“旧数据的响应覆盖了新数据”的 Bug，并节省带宽。</li>
<li><strong>不要依赖它来回滚数据</strong>：如果你发的是 <code>POST</code> 请求（比如“付款”），千万不要指望前端取消就能阻止服务器扣款。后端必须要有幂等性设计或专门的撤销接口。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月]]></title>    <link>https://juejin.cn/post/7577189654488989746</link>    <guid>https://juejin.cn/post/7577189654488989746</guid>    <pubDate>2025-11-27T09:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654488989746" data-draft-id="7576968345876283419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月"/> <meta itemprop="keywords" content="Flutter,客户端"/> <meta itemprop="datePublished" content="2025-11-27T09:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:13:45.000Z" title="Thu Nov 27 2025 09:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>老刘做Flutter开发差不多7年了，期间如何选择Flutter版本是被问得最多的问题之一。</p>
<p>所以老刘新开了一个系列文章，每个月都会深度分析最近的几个Flutter版本。</p>
<ul>
<li>提供具体的版本选择建议</li>
<li>分享真实的生产环境经验</li>
<li>给出详细的升级和回滚策略</li>
</ul>
<p>让你在版本选择上不再纠结，不再踩坑。</p>
<hr/>
<h2 data-id="heading-0">一、Flutter版本选择策略</h2>
<p>对于技术框架和版本的选择，不应该是盲目的选择最新版，或者无脑看网上别人怎么推荐，而是应该有自己的分析方法。</p>
<p>最新的版本大概率解决了之前版本中比较严重的问题，优化了性能，添加了新特性。</p>
<p>但是最新版有很有可能引入新的bug或者缺陷。</p>
<p>那么作为开发者该如何权衡这两者的利弊呢？</p>
<p><strong>第一个法则：2个月观察期，别当小白鼠</strong></p>
<p>新版本发布后的前2个月，就是一场大型真人实验。</p>
<p>大部分严重的bug在发布后的一到两个月都能被爆出来。</p>
<p>所以聪明的做法是什么？</p>
<p>等2个月，看社区反馈，看bug列表。如果这段时间没有什么比较严重的问题，那么大概率就是比较安全的。</p>
<p>也可以看老刘每个月发布的《Flutter版本选择指南》。</p>
<p>这就像买股票一样，不要追高，要等进入低估区间。</p>
<p><strong>第二个法则：分环境测试，别一上来就all in</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/069712e44df847c2b90613ce4f1892c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=Wt%2BEWnIMdRIGP%2BqQor82AwplVoY%3D" alt="" loading="lazy"/></p>
<p><strong>开发环境 → 测试环境 → 生产环境</strong></p>
<p>开发环境用最新版，踩坑我认了，反正影响不了用户。</p>
<p>测试环境用经过开发环境检验的版本，充分测试，记录问题。</p>
<p>生产环境用稳定版，用户至上，稳定压倒一切。</p>
<p>升级前预留足够的时间窗口，比如在当前已经发布的版本上只升级Flutter版本，然后快速发布一个小版本。</p>
<p>如果发现问题可以尽快回滚。</p>
<hr/>
<h2 data-id="heading-1">二、Flutter最近5个版本深度解析</h2>
<h3 data-id="heading-2">1. 版本列表</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982928cab4c54c32982500ec2a44f651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=c%2FykUfoOuFEtgx2urT4mSNiYU70%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>Flutter 3.38</strong> (最新) - 2025年11月发布</li>
<li><strong>Flutter 3.35</strong> - 2025年8月发布</li>
<li><strong>Flutter 3.32</strong> - 2025年5月发布</li>
<li><strong>Flutter 3.29</strong> - 2025年2月发布</li>
<li><strong>Flutter 3.27</strong> - 2024年12月发布</li>
</ol>
<h3 data-id="heading-3">2. 各版本问题分析与风险评估</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feabfc3b870d4ad89cb56e5063093a86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=SFsswHzu7MiIX%2FrTiNOT%2BVLOYRo%3D" alt="" loading="lazy"/></p>
<p><strong>Flutter 3.38 - 刚发布，进入观察期</strong></p>
<ul>
<li><strong>工具链升级</strong>：iOS 引入 UIScene 生命周期支持，旧工程需按指南迁移；Android 默认 NDK 升至 r28，满足 Google Play 16 KB 页面大小兼容要求。</li>
<li><strong>渲染与性能</strong>：Web与移动端有优化，建议用真机与线上数据做对比。</li>
<li><strong>生态适配</strong>：第三方插件与库通常需要1–3周完成适配。</li>
<li><strong>建议</strong>：建议等待三方库适配，同时观察社群反馈</li>
</ul>
<blockquote>
<p>注意：此版本支持了iOS端的UIScene生命周期迁移和Android端的Google Play 16 KB 页面大小兼容，因此建议开发者保持关注，时机成熟后尽早进行适配。</p>
</blockquote>
<p><strong>Flutter 3.35 - 当前推荐版本</strong></p>
<ul>
<li><strong>稳定性提升</strong>：修复了前期版本的主要问题</li>
<li><strong>新功能</strong>：Web端热重载、Widget预览等功能逐步完善</li>
<li><strong>社区评价</strong>：稳定版本，推荐各种项目使用</li>
</ul>
<p><strong>Flutter 3.32 - 渲染引擎调整期</strong></p>
<ul>
<li><strong>渲染后端调整</strong>：从Vulkan回退到OpenGLES，性能有所影响</li>
<li><strong>设备兼容性</strong>：部分老旧设备支持有限</li>
<li><strong>过渡期建议</strong>：等待后续版本稳定性提升</li>
</ul>
<p><strong>Flutter 3.29 - 启动和内存管理需关注</strong></p>
<ul>
<li><strong>应用启动问题</strong>：部分开发者反馈启动阶段存在崩溃现象</li>
<li><strong>内存管理优化</strong>：相比早期版本有所改进，但需持续观察</li>
<li><strong>建议</strong>：生产环境升级前需充分测试</li>
</ul>
<p><strong>Flutter 3.27 - 高风险版本，需谨慎评估</strong></p>
<ul>
<li><strong>Impeller渲染引擎稳定性问题</strong>：新渲染引擎在部分设备上存在问题
<ul>
<li>部分Android设备出现花屏、黑屏现象，影响用户体验</li>
<li>开发环境模拟器性能下降，影响开发效率</li>
<li>可通过 <code>--no-enable-impeller</code> 参数禁用新渲染引擎</li>
</ul>
</li>
<li><strong>社区反馈</strong>：Reddit等平台有用户报告蓝屏和冻结问题</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、不同场景的版本选择策略</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eca95582b2f4ff39eaa0d7e7cbaa185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=3SROAOvuBn%2F%2FONUqcG3GcSLnrjw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5"><strong>生产环境（求稳不求新）</strong></h4>
<ul>
<li><strong>首选</strong>：Flutter 3.35 - 新功能与稳定性的平衡点</li>
<li><strong>观察期</strong>：Flutter 3.38 - 刚发布，暂不建议直接上生产</li>
</ul>
<p><strong>理由</strong>：用户体验 &gt; 开发体验，稳定压倒一切</p>
<p><strong>3.35版本经过两个月验证没什么大问题，10月份提升为首选</strong></p>
<ul>
<li>如果对稳定性没有极端要求的App可以考虑升级3.35。</li>
<li>如果对稳定性要求很高，建议再观察一个月。</li>
</ul>
<h4 data-id="heading-6"><strong>开发环境（可以激进一点）</strong></h4>
<ul>
<li><strong>推荐</strong>：Flutter 3.35 - 体验最新功能，当前最稳定的版本</li>
<li><strong>注意</strong>：随时准备回滚，不要在deadline前升级</li>
<li><strong>观察期</strong>：3.38版本发布时间太短，三方库适配不够充分，暂时不建议进入开发环境</li>
</ul>
<h4 data-id="heading-7"><strong>新项目启动</strong></h4>
<ul>
<li><strong>最佳选择</strong>：Flutter 3.35</li>
<li><strong>优势</strong>：长期支持、社区活跃、bug修复及时</li>
<li><strong>观察期</strong>：3.38版本发布时间太短，三方库适配不够充分，暂时不建议进入开发环境</li>
</ul>
<h3 data-id="heading-8">⚠️ <strong>需谨慎使用的版本</strong></h3>
<ul>
<li><strong>Flutter 3.38</strong>：刚发布，建议先在开发环境验证，等待社区反馈</li>
<li><strong>Flutter 3.32</strong>：渲染引擎调整期，性能有所影响</li>
<li><strong>Flutter 3.29</strong>：建议充分测试后再用于生产环境</li>
<li><strong>Flutter 3.27</strong>：Impeller渲染引擎在部分设备上存在稳定性问题</li>
</ul>
<hr/>
<h2 data-id="heading-9">总结</h2>
<p>当前的现状是：大厂都在用"过时"版本，而小公司却在追最新。</p>
<p>在客户端项目中，基础框架的版本选择核心原则是不要追新，留两个月冷静期。</p>
<p>"在这个快速迭代的时代，懂得慢下来选择稳定版本的开发者，才是真正的高手。"</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[事务与消息中间件：分布式系统中的可见性边界问题]]></title>    <link>https://juejin.cn/post/7577050643203375154</link>    <guid>https://juejin.cn/post/7577050643203375154</guid>    <pubDate>2025-11-27T09:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577050643203375154" data-draft-id="7577031454586273819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="事务与消息中间件：分布式系统中的可见性边界问题"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-27T09:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="每天进步一点_JL"/> <meta itemprop="url" content="https://juejin.cn/user/1161549994267080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            事务与消息中间件：分布式系统中的可见性边界问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1161549994267080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    每天进步一点_JL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:06:06.000Z" title="Thu Nov 27 2025 09:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">事务与消息中间件：分布式系统中的可见性边界问题</h2>
<h3 data-id="heading-1">一、问题的本质：时空错位的一致性困境</h3>
<p>在微服务架构中，我们常遇到这样的场景：一个业务方法既要修改数据库状态，又要发送消息到MQ触发下游服务。表面看，这只是简单的"写DB+发消息"，但细究其执行时序，隐藏着一个致命陷阱【本文以@Transactional为例】：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
    userRepository.<span class="hljs-title function_">save</span>(user); <span class="hljs-comment">// 1. 数据库操作</span>
    mqProducer.<span class="hljs-title function_">sendUserCreatedEvent</span>(user.<span class="hljs-title function_">getId</span>()); <span class="hljs-comment">// 2. 发送MQ消息</span>
    ......
}
</code></pre>
<p><strong>问题核心</strong>：当事务尚未提交时，MQ消息已被发出。下游消费者立即处理该消息，尝试查询刚刚创建的用户数据，却因<strong>事务尚未提交</strong>而查询不到，导致业务失败。</p>
<p>这不是简单的代码bug，而是分布式系统中<strong>时空错位</strong>的典型表现——事务边界与消息传递在时间维度上不同步，造成数据可见性不一致。正如物理学中的相对论，不同参照系（服务）对"现在"的定义并不相同。</p>
<h4 data-id="heading-2">1.1 事务提交时机的迷思</h4>
<p>Spring的<code>@Transactional</code>背后运作机制常被误解：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/212bc1a115e94599bf4fe23bd04a1767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q-P5aSp6L-b5q2l5LiA54K5X0pM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839166&amp;x-signature=2Q913JqQTWr59DU6UfyIMr8SynE%3D" alt="image.png" loading="lazy"/></p>
<p>关键洞察：<strong>事务提交发生在方法执行结束之后</strong>，而非数据库操作之后。当<code>mqProducer.send()</code>执行时，事务尚未提交，数据对其他连接不可见。</p>
<h3 data-id="heading-3">二、如何识别这种场景？</h3>
<p>在代码审查中，警惕同时出现的以下模式：</p>
<ul>
<li><code>@Transactional</code>注解的方法内直接调用MQ发送</li>
<li>事务方法内调用异步方法(<code>@Async</code>)</li>
<li>事务方法内触发远程服务调用</li>
<li>事务方法中操作缓存(如Redis)</li>
</ul>
<h3 data-id="heading-4">三、解决方案</h3>
<h4 data-id="heading-5">3.1 事务同步机制：让消息在提交后发送</h4>
<p>利用Spring的<code>TransactionSynchronizationManager</code>注册回调：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeUserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userRepository.<span class="hljs-title function_">save</span>(user);
        
        <span class="hljs-comment">// 注册事务提交后的回调</span>
        <span class="hljs-title class_">TransactionSynchronizationManager</span>.<span class="hljs-title function_">registerSynchronization</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionSynchronization</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">afterCommit</span>(<span class="hljs-params"/>) {
                    mqProducer.<span class="hljs-title function_">sendUserCreatedEvent</span>(user.<span class="hljs-title function_">getId</span>());
                }
            }
        );
    }
}
</code></pre>
<h4 data-id="heading-6">3.2 事务消息表：本地事务与消息的原子性</h4>
<p>将消息作为业务数据的一部分，写入同一事务：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
    userRepository.<span class="hljs-title function_">save</span>(user);
    <span class="hljs-comment">// 同一事务中保存消息</span>
    messageRepository.<span class="hljs-title function_">save</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutboxMessage</span>(<span class="hljs-string">"user.created"</span>, user.<span class="hljs-title function_">getId</span>()));
}

<span class="hljs-comment">// 独立的定时任务/监听器</span>
<span class="hljs-meta">@Scheduled</span>(fixedDelay = <span class="hljs-number">1000</span>)
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendPendingMessages</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">OutboxMessage</span>&gt; messages = messageRepository.<span class="hljs-title function_">findPending</span>(<span class="hljs-number">100</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">OutboxMessage</span> message : messages) {
        <span class="hljs-keyword">if</span> (mqProducer.<span class="hljs-title function_">send</span>(message)) {
            message.<span class="hljs-title function_">setSent</span>(<span class="hljs-literal">true</span>);
        }
    }
}
</code></pre>
<p>优势：本地事务保证数据与消息的一致性；</p>
<p>劣势：增加了系统复杂度，需要处理消息表清理、重复发送等问题。</p>
<h4 data-id="heading-7">3.3 事件溯源：重构数据与事件的关系</h4>
<p>将事件本身作为首要数据存储，而非副产品：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Transactional
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createUser</span>(<span class="hljs-params">User user</span>)</span> {
    <span class="hljs-comment">// 创建领域事件(持久化)</span>
    UserCreatedEvent <span class="hljs-keyword">event</span> = <span class="hljs-keyword">new</span> UserCreatedEvent(user);
    eventRepository.save(<span class="hljs-keyword">event</span>);
    
    <span class="hljs-comment">// 业务数据从事件中派生</span>
    userRepository.save(user);
}

<span class="hljs-comment">// 事件处理器(独立事务)</span>
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleUserCreated</span>(<span class="hljs-params">UserCreatedEvent <span class="hljs-keyword">event</span></span>)</span> {
    mqProducer.send(<span class="hljs-keyword">event</span>);
}
</code></pre>
<p>这种模式将事件提升为一等公民，从根本上解决了时序问题，但需要对领域模型进行重构。</p>
<h3 data-id="heading-8">四、架构层面的思考</h3>
<h4 data-id="heading-9">4.1 最终一致性 vs 强一致性</h4>
<p>认识到分布式系统中强一致性的高昂代价，大多数业务场景可接受<strong>最终一致性</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">public void handleUserCreatedEvent(String userId) {
    User <span class="hljs-attr">user</span> = null<span class="hljs-comment">;</span>
    int <span class="hljs-attr">retryCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    // 重试机制，等待数据可见
    while (<span class="hljs-attr">user</span> == null &amp;&amp; retryCount &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-attr">user</span> = userRepository.findById(userId).orElse(null)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">user</span> == null) {
            Thread.sleep(100 * (long)Math.pow(2, retryCount))<span class="hljs-comment">; // 指数退避</span>
            retryCount++<span class="hljs-comment">;</span>
        }
    }
    
    if (<span class="hljs-attr">user</span> == null) {
        // 重试失败，进入死信队列或人工干预
        deadLetterService.handleUnresolvedEvent(userId)<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    
    // 正常处理
    processUser(user)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-10">4.2 事务边界设计原则</h4>
<ul>
<li><strong>单一职责原则</strong>：事务方法应只负责数据一致性，不混杂外部通信</li>
<li><strong>最小事务原则</strong>：事务范围应当尽可能小，只包含必要的数据库操作</li>
<li><strong>分层明确原则</strong>：将事务控制、业务逻辑、集成通信分层实现</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化后的分层设计</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionalEventPublisher eventPublisher;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(CreateUserCommand command)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(command.getName(), command.getEmail());
        userRepository.save(user);
        
        <span class="hljs-comment">// 仅发布领域事件，不关心传输细节</span>
        eventPublisher.publishAfterCommit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCreatedEvent</span>(user.getId()));
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEventConsumer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmailService emailService;
    
    <span class="hljs-meta">@TransactionalEventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserCreated</span><span class="hljs-params">(UserCreatedEvent event)</span> {
        <span class="hljs-comment">// 保证在事务提交后处理</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(event.getUserId())
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntityNotFoundException</span>(<span class="hljs-string">"User not found after TX commit"</span>));
        
        emailService.sendWelcomeEmail(user);
    }
}
</code></pre>
<h3 data-id="heading-11">五、规避</h3>
<p>当在事务方法中涉及异步操作时，问自己：</p>
<ol>
<li><strong>时序验证</strong>：我的MQ消费者是否依赖此事务中创建/修改的数据？</li>
<li><strong>边界识别</strong>：事务边界是否恰好包裹了所有数据操作，不包含通信逻辑？</li>
<li><strong>回滚考量</strong>：若事务回滚，已发送的MQ消息如何处理？(补偿机制)</li>
<li><strong>重试设计</strong>：消费者是否具备幂等性和重试能力，应对短暂不一致？</li>
<li><strong>监控覆盖</strong>：是否有监控能检测到"消息先于数据到达"的异常情况？</li>
</ol>
<p>事务与MQ的协调问题，本质是分布式系统中时空关系的映射。</p>
<p>避免此问题不在于使用更复杂的框架，而在于<strong>深刻理解事务边界</strong>、<strong>明确系统组件间的时序依赖</strong>，以及<strong>设计符合物理规律的架构</strong>。</p>
<p>当你下次在事务方法中编写MQ发送代码时，不妨暂停片刻，思考：此刻，我的数据的确切位置是什么？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ResizeObserver：轻松监听元素尺寸变化]]></title>    <link>https://juejin.cn/post/7577189654488842290</link>    <guid>https://juejin.cn/post/7577189654488842290</guid>    <pubDate>2025-11-27T08:47:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654488842290" data-draft-id="7577189654488645682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ResizeObserver：轻松监听元素尺寸变化"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T08:47:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Drift_Dream"/> <meta itemprop="url" content="https://juejin.cn/user/3107677514241500"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ResizeObserver：轻松监听元素尺寸变化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3107677514241500/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Drift_Dream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:47:03.000Z" title="Thu Nov 27 2025 08:47:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ResizeObserver：轻松监听元素尺寸变化</h2>
<h3 data-id="heading-1">什么是ResizeObserver？</h3>
<p>在前端开发中，我们经常需要知道一个元素的尺寸是否发生了变化。过去，我们只能通过监听window的resize事件，但这只能监听浏览器窗口的变化，无法监听具体元素的变化。ResizeObserver应运而生，它可以帮助我们监听任意元素的大小变化。</p>
<p>简单来说，ResizeObserver就像是一个"尺寸监视器"，当被观察的元素尺寸发生变化时，它会立即通知我们。</p>
<h3 data-id="heading-2">为什么需要ResizeObserver？</h3>
<p>在ResizeObserver出现之前，我们想要监听元素尺寸变化通常有以下几种方法：</p>
<ol>
<li><strong>window.resize事件</strong>：只能监听窗口变化，不能监听具体元素</li>
<li><strong>轮询检查</strong>：通过定时器不断检查元素尺寸，性能差</li>
<li><strong>MutationObserver</strong>：可以监听DOM变化，但无法直接监听尺寸变化</li>
</ol>
<p>这些方法要么功能有限，要么性能不佳。ResizeObserver专门为解决这个问题而生，它提供了高效、精准的元素尺寸监听能力。</p>
<h3 data-id="heading-3">基本使用方法</h3>
<h4 data-id="heading-4">创建ResizeObserver</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建ResizeObserver实例</span>
<span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-comment">// entry.target：被观察的元素</span>
    <span class="hljs-comment">// entry.contentRect：元素的尺寸信息</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素尺寸发生变化:'</span>, entry.<span class="hljs-property">contentRect</span>);
  }
});
</code></pre>
<h4 data-id="heading-5">观察元素</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myElement'</span>);
resizeObserver.<span class="hljs-title function_">observe</span>(element);
</code></pre>
<h4 data-id="heading-6">停止观察</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 停止观察特定元素</span>
resizeObserver.<span class="hljs-title function_">unobserve</span>(element);

<span class="hljs-comment">// 停止所有观察并销毁实例</span>
resizeObserver.<span class="hljs-title function_">disconnect</span>();
</code></pre>
<h3 data-id="heading-7">完整示例</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ResizeObserver<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.box</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-class">.resizeable</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">resize</span>: both;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">overflow</span>: auto;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.resizeable1</span> {
      <span class="hljs-attribute">background-color</span>: aquamarine;
    }
    <span class="hljs-selector-class">.resizeable2</span> {
      <span class="hljs-attribute">background-color</span>: blueviolet;
    }
    <span class="hljs-selector-class">.log</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">resize</span>: both;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-direction</span>: column;
      <span class="hljs-attribute">justify-content</span>: space-around;
      <span class="hljs-attribute">align-items</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizeable resizeable1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"resizeable1"</span>&gt;</span>box1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizeable resizeable2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"resizeable2"</span>&gt;</span>box2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"log"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> textNode1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".text1"</span>);
    <span class="hljs-keyword">const</span> textNode2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".text2"</span>);

    <span class="hljs-keyword">const</span> resizeNode1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#resizeable1"</span>);
    <span class="hljs-keyword">const</span> resizeNode2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#resizeable2"</span>);

    <span class="hljs-keyword">const</span> nodeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry);
        <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>;
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">target</span>.<span class="hljs-property">id</span> === <span class="hljs-string">"resizeable1"</span>) {
          textNode1.<span class="hljs-property">textContent</span> = <span class="hljs-string">`box1当前尺寸：<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(
            width
          )}</span> * <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(height)}</span> 像素`</span>;
        } <span class="hljs-keyword">else</span> {
          textNode2.<span class="hljs-property">textContent</span> = <span class="hljs-string">`box2当前尺寸：<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(
            width
          )}</span> * <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(height)}</span> 像素`</span>;
        }
      }
    });
    nodeObserver.<span class="hljs-title function_">observe</span>(resizeNode1);
    nodeObserver.<span class="hljs-title function_">observe</span>(resizeNode2);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b3ca003d764be99aab9eb28c9d639a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJpZnRfRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838022&amp;x-signature=sofh2PB60pDRxQWbUIPTaXkLfxI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">在Vue 3中的使用实践</h3>
<h4 data-id="heading-9">组合式API用法</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-observer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"resizableElement"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizable-box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ResizeObserver 简单示例<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前宽度: {{ width }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前高度: {{ height }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">const</span> resizableElement = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> width = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> height = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
        width.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
        height.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">height</span>;
      }
    });

    resizeObserver.<span class="hljs-title function_">observe</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizeObserver) {
    resizeObserver.<span class="hljs-title function_">disconnect</span>();
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.resizable-box</span> {
  <span class="hljs-attribute">resize</span>: both;
  <span class="hljs-attribute">overflow</span>: auto;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-10">自定义Hook封装</h4>
<p>为了更好地复用，我们可以将ResizeObserver封装成自定义Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { onUnmounted, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useResizeObserver</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> width = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">observe</span> = (<span class="hljs-params">el: HTMLElement</span>) =&gt; {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
        width.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
        height.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">height</span>;
      }
    });
    resizeObserver.<span class="hljs-title function_">observe</span>(el);
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">unobserve</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
  };
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
  });
  <span class="hljs-keyword">return</span> {
    width,
    height,
    observe,
    unobserve,
  };
}

</code></pre>
<p>使用自定义Hook</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-observer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"resizableElement"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizable-box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用钩子函数实现的 ResizeObserver<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前宽度: {{ width }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前高度: {{ height }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted, onUnmounted, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useResizeObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hook/useResizeObserver.ts"</span>;

<span class="hljs-keyword">const</span> { width, height, observe, unobserve } = <span class="hljs-title function_">useResizeObserver</span>();

<span class="hljs-keyword">const</span> resizableElement = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">observe</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">unobserve</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.resizable-box</span> {
  <span class="hljs-attribute">resize</span>: both;
  <span class="hljs-attribute">overflow</span>: auto;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background-color</span>: aquamarine;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-11">Vue 3中ResizeObserver的实际应用：可调整布局的管理后台</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-container"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 可调整宽度的侧边栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"sidebarRef"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>
      <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: sidebarWidth + 'px' }"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航菜单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in menuItems"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: activeMenu === item.id }"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"activeMenu = item.id"</span>
          &gt;</span>
            {{ item.name }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 拖拽把手 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-handle"</span> @<span class="hljs-attr">mousedown</span>=<span class="hljs-string">"startResize"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"mainRef"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleSidebar"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toggle-btn"</span>&gt;</span>
          {{ isSidebarCollapsed ? "展开侧边栏" : "折叠侧边栏" }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主要内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 显示当前尺寸信息 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"size-info"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>侧边栏宽度: {{ sidebarWidth }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>主内容区域宽度: {{ mainContentWidth }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">//  侧边栏状态</span>
<span class="hljs-keyword">const</span> sidebarWidth = <span class="hljs-title function_">ref</span>(<span class="hljs-number">280</span>);
<span class="hljs-keyword">const</span> isSidebarCollapsed = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> activeMenu = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"dashboard"</span>);

<span class="hljs-comment">// 元素引用</span>
<span class="hljs-keyword">const</span> sidebarRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> mainRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 尺寸数据</span>
<span class="hljs-keyword">const</span> mainContentWidth = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 菜单数据</span>
<span class="hljs-keyword">const</span> menuItems = [
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"dashboard"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"仪表盘"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"users"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"用户管理"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"orders"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"订单管理"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"settings"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"系统设置"</span> },
];

<span class="hljs-comment">// 监听主内容区域宽度变化</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">mainResizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 监听主内容区域宽度</span>
  mainResizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
      mainContentWidth.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
    }
  });

  <span class="hljs-keyword">if</span> (mainRef.<span class="hljs-property">value</span>) {
    mainResizeObserver.<span class="hljs-title function_">observe</span>(mainRef.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-comment">// 切换侧边栏显示/隐藏</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleSidebar</span> = (<span class="hljs-params"/>) =&gt; {
  isSidebarCollapsed.<span class="hljs-property">value</span> = !isSidebarCollapsed.<span class="hljs-property">value</span>;
  sidebarWidth.<span class="hljs-property">value</span> = isSidebarCollapsed.<span class="hljs-property">value</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">280</span>;
};

<span class="hljs-comment">// 开始调整侧边栏宽度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startResize</span> = (<span class="hljs-params">e: MouseEvent</span>) =&gt; {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">const</span> startX = e.<span class="hljs-property">clientX</span>;
  <span class="hljs-keyword">const</span> startWidth = sidebarWidth.<span class="hljs-property">value</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseMove</span> = (<span class="hljs-params">e: MouseEvent</span>) =&gt; {
    <span class="hljs-keyword">const</span> newWidth = startWidth + (e.<span class="hljs-property">clientX</span> - startX);
    <span class="hljs-comment">// 限制最小和最大宽度</span>
    <span class="hljs-keyword">if</span> (newWidth &gt;= <span class="hljs-number">200</span> &amp;&amp; newWidth &lt;= <span class="hljs-number">500</span>) {
      sidebarWidth.<span class="hljs-property">value</span> = newWidth;
      isSidebarCollapsed.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousemove"</span>, handleMouseMove);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
  };

  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousemove"</span>, handleMouseMove);
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
};

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (mainResizeObserver) {
    mainResizeObserver.<span class="hljs-title function_">disconnect</span>();
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.demo-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
}

<span class="hljs-selector-class">.sidebar</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2c3e50</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.sidebar-content</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#34495e</span>;
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.nav-item</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#34495e</span>;
}

<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.resize-handle</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#34495e</span>;
  <span class="hljs-attribute">cursor</span>: col-resize;
  <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.resize-handle</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.main-content</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ecf0f1</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}

<span class="hljs-selector-class">.content-header</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.toggle-btn</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.toggle-btn</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2980b9</span>;
}

<span class="hljs-selector-class">.size-info</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
}

<span class="hljs-selector-class">.chart-container</span>,
<span class="hljs-selector-class">.table-container</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3中createApp多个实例共享状态]]></title>    <link>https://juejin.cn/post/7577016562252873779</link>    <guid>https://juejin.cn/post/7577016562252873779</guid>    <pubDate>2025-11-27T08:47:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252873779" data-draft-id="7576953459544916022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3中createApp多个实例共享状态"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T08:47:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jason_yang"/> <meta itemprop="url" content="https://juejin.cn/user/2972704795802653"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3中createApp多个实例共享状态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2972704795802653/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jason_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:47:28.000Z" title="Thu Nov 27 2025 08:47:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.背景</h2>
<p>在 Vue 3 开发中，通常一个应用只需要调用一次 <code>createApp()</code> 创建一个根应用实例。但在某些特定场景下，确实需要创建多个 Vue 应用实例（即多次调用 <code>createApp</code>）。这些场景主要包括：</p>
<h2 data-id="heading-1">2.场景</h2>
<h3 data-id="heading-2">1.动态生成html</h3>
<p><strong>说明</strong>：<br/>
比如在使用google地图的时候，点击弹框使用传入一个html弹框内容详情内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96752d0b501d4d1d88e1c6604a7a50ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839137&amp;x-signature=NK%2FKgzo6IZCklM4TVPIw848jaE8%3D" alt="image.png" loading="lazy"/>
上面就是谷歌点击时候提供的弹框内容，使用<code>InfoWindow.open</code>触发弹框，。<code>infoWindow.setContent</code>插入自己要显示的详情内容。</p>
<p>老办法是直接jquery 插各种dom操作。但现在都组件化了如果能复用现有的架构和样式是最理想的。</p>
<h4 data-id="heading-3">方案1 createApp</h4>
<p>这时候就可以利用createApp创建vue来渲染详情，这样就可以复用系统已经开发好的样式的结构。（缺点重新实例了一遍有一定开销）</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-Js" lang="Js">  <span class="hljs-keyword">import</span> <span class="hljs-title class_">StoreInfoWindow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/StoreInfoWindow.vue'</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">infoWindow</span>: google.<span class="hljs-property">maps</span>.<span class="hljs-property">InfoWindow</span>
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">markerShowDetail</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">marker: google.maps.marker.AdvancedMarkerElement</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用接口查询详情数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: any = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getStoreInfo</span>(marker)
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>) {
        <span class="hljs-comment">// 详情页面显示</span>
        <span class="hljs-keyword">const</span> storeDetail = res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>
        <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
        infoWindow.<span class="hljs-title function_">setContent</span>(content)
        infoWindow.<span class="hljs-title function_">open</span>(map, marker)
        <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">StoreInfoWindow</span>, { <span class="hljs-attr">store</span>: xxx })
        app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementPlus</span>)
        app.<span class="hljs-title function_">mount</span>(content)
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// loading.value = false</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error fetching store info:'</span>, error)
    }
  }
</code></pre>
<h4 data-id="heading-4">方案2 隐藏div</h4>
<p>当然也可以不使用createApp，直接在现有sfc页面里 插入一个隐藏的div，内容把内容渲染到隐藏div，调用<code>infoWindow.setContent</code>传入dom</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">import</span> <span class="hljs-title class_">StoreInfoWindow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/StoreInfoWindow.vue'</span>
  
 &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"hideDiv"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StoreInfoWindow</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"storeInfoRef"</span> <span class="hljs-attr">:store</span>=<span class="hljs-string">"storeDetail"</span>  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">StoreInfoWindow</span>&gt;</span></span>
    &lt;/div&gt;


  <span class="hljs-keyword">const</span> storeDetail = ref&lt;<span class="hljs-title class_">MapStore</span>&gt;()
  <span class="hljs-keyword">const</span> storeInfoRef = <span class="hljs-title function_">ref</span>()
  <span class="hljs-keyword">let</span> <span class="hljs-attr">infoWindow</span>: google.<span class="hljs-property">maps</span>.<span class="hljs-property">InfoWindow</span>
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">markerShowDetail</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">marker: google.maps.marker.AdvancedMarkerElement</span>) =&gt; {    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用接口查询详情数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: any = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getStoreInfo</span>(marker)
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>) {
        <span class="hljs-comment">// 详情页面显示</span>
        storeDetail.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>
        <span class="hljs-keyword">if</span> (storeInfoRef.<span class="hljs-property">value</span>) {
          <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
            infoWindow.<span class="hljs-title function_">setContent</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)
            infoWindow.<span class="hljs-title function_">open</span>(map, marker)
          })
        }
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error fetching store info:'</span>, error)
    }
  }
</code></pre>
<blockquote>
<p>由于一个dom节点 不能同时挂在多个不同节点下，所以上面的infoWindow.setContent(storeInfoRef.value.$el) 设置后，hideDiv的下面的内容会被移走。所以关闭时候需要还原回来。防止节点引用丢失。</p>
</blockquote>
<p>关闭后，补偿方法</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">infoWindowClose</span> = (<span class="hljs-params"/>) =&gt; {
    infoWindow.<span class="hljs-title function_">close</span>()
    <span class="hljs-keyword">const</span> hideDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hideDiv'</span>)
    <span class="hljs-keyword">if</span> (hideDiv) {
      <span class="hljs-keyword">if</span> (!hideDiv.<span class="hljs-title function_">contains</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)) {
        hideDiv.<span class="hljs-title function_">appendChild</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)
      }
    }
  }
</code></pre>
<h3 data-id="heading-5">2.微前端架构（Micro Frontends）</h3>
<p>在微前端架构中，一个页面可能由多个独立的子应用组成，每个子应用可能是由不同的团队开发、使用不同的框架或不同版本的 Vue。为了隔离作用域和避免冲突，每个子应用应拥有自己的 Vue 实例。</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-number">1</span><span class="hljs-comment">// 子应用 A</span>
2<span class="hljs-keyword">const</span> appA = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">AppA</span>);
3appA.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#micro-app-a'</span>);
<span class="hljs-number">4</span>
<span class="hljs-number">5</span><span class="hljs-comment">// 子应用 B</span>
6<span class="hljs-keyword">const</span> appB = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">AppB</span>);
7appB.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#micro-app-b'</span>);
</code></pre>
<blockquote>
<p>每个子应用可以独立注册插件、全局组件、指令等，互不影响。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">3.在同一个页面嵌入多个独立的 Vue 应用</h3>
<p><strong>说明</strong>：<br/>
比如一个传统多页网站（非 SPA）中，某些页面包含多个功能模块（如导航栏、侧边购物车、评论区），它们彼此逻辑独立，不需要共享状态，也不需要通信。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-Html" lang="Html"><span class="hljs-comment">&lt;!-- index.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"header-widget"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cart-widget"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"comment-section"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HeaderWidget</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HeaderWidget.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CartWidget</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CartWidget.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CommentSection</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CommentSection.vue'</span>;

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">HeaderWidget</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#header-widget'</span>);
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">CartWidget</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#cart-widget'</span>);
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">CommentSection</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#comment-section'</span>);
</code></pre>
<blockquote>
<p>每个 widget 是一个独立的 Vue 应用，可单独开发、测试、部署。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">4.插件或第三方库需要隔离的 Vue 实例</h3>
<p><strong>说明</strong>：<br/>
当你开发一个 Vue 插件（如 UI 组件库中的弹窗、通知等），而该插件内部需要渲染 Vue 组件时，为避免污染主应用的全局配置（如全局指令、混入、provide/inject 等），应创建独立的 Vue 实例。</p>
<p><strong>示例</strong>（封装一个全局 Toast 组件）：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-comment">// toast.js</span>
<span class="hljs-keyword">import</span> { createVNode, render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ToastComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Toast.vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showToast</span>(<span class="hljs-params">message</span>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);

  <span class="hljs-keyword">const</span> vm = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">ToastComponent</span>, { message });
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>({}); <span class="hljs-comment">// 创建干净实例</span>
  app.<span class="hljs-title function_">mount</span>(container);
  <span class="hljs-title function_">render</span>(vm, container);
}
</code></pre>
<blockquote>
<p>这样 Toast 不会继承主应用的全局配置，更安全可靠。</p>
</blockquote>
<h3 data-id="heading-8">5.单元测试或多实例沙箱环境</h3>
<p><strong>说明</strong>：<br/>
在编写测试用例时，为避免测试之间互相干扰，每个测试用例应使用独立的 Vue 应用实例。</p>
<p><strong>示例</strong>（Vitest / Jest）：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-title function_">test</span>(<span class="hljs-string">'Component A works'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">ComponentA</span>);
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  app.<span class="hljs-title function_">mount</span>(div);
  <span class="hljs-comment">// ...断言</span>
  app.<span class="hljs-title function_">unmount</span>();
});

<span class="hljs-title function_">test</span>(<span class="hljs-string">'Component B works'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">ComponentB</span>); <span class="hljs-comment">// 全新实例，无污染</span>
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<h2 data-id="heading-9">3.createApp 构造方式</h2>
<p>我们复习一下 创建的方式</p>
<h3 data-id="heading-10"><strong>1.传入 SFC（单文件组件）【最常用】</strong></h3>
<h4 data-id="heading-11">传入 .vue 文件作为根组件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-12">带 root props 的方式</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'Hello'</span> }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>SFC 内：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">title</span>: <span class="hljs-title class_">String</span>
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-13"><strong>2.传入 Options API 对象（构造对象组件）</strong></h3>
<p>不用 SFC，直接传一个对象：</p>
<h4 data-id="heading-14">直接传组件对象</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">msg</span>: <span class="hljs-string">'Hello'</span> }
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;{{ msg }}&lt;/div&gt;`</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-15">带 root props</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'title'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;h1&gt;{{ title }}&lt;/h1&gt;`</span>
}, {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'Hello Props'</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-16"><strong>3.传入 Render Function（函数式创建根组件）</strong></h3>
<h4 data-id="heading-17">使用 <code>h()</code> 渲染函数</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp, h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">createApp</span>({
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'Hello from render'</span>)
  }
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-18">带 root props 的 render 写法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'msg'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, props.<span class="hljs-property">msg</span>)
  }
}, {
  <span class="hljs-attr">msg</span>: <span class="hljs-string">'Hello props'</span>
})
.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<hr/>
<h3 data-id="heading-19"><strong>4.传入 Template 字符串（inline 模板）</strong></h3>
<p>适用于快速 demo：</p>
<h4 data-id="heading-20">根组件直接写 template 字符串</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;p&gt;Hello Template&lt;/p&gt;`</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-21">root props + template</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'text'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;p&gt;{{ text }}&lt;/p&gt;`</span>
}, {
  <span class="hljs-attr">text</span>: <span class="hljs-string">'Hello!'</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h2 data-id="heading-22">4.数据共享问题</h2>
<p>由于两个app 是独立的沙盒，但是我们又需要同步部分数据状态</p>
<h3 data-id="heading-23">1.全局变量（简单场景，不推荐大型项目）</h3>
<p>通过浏览器全局对象（<code>window</code>）存储共享数据，利用 Vue 的响应式 API（<code>ref</code>/<code>reactive</code>）保证数据变更能触发视图更新。</p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;

  <span class="hljs-comment">// 1. 定义全局共享的响应式数据</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span> = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">'Vue开发者'</span>,
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  });

  <span class="hljs-comment">// 2. 应用实例1：使用全局共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> shared = <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; shared.<span class="hljs-property">value</span>.<span class="hljs-property">count</span>++;
      <span class="hljs-keyword">return</span> { shared, increment };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
      &lt;div&gt;
        &lt;h3&gt;应用1 - 计数：{{ shared.count }}&lt;/h3&gt;
        &lt;button @click="increment"&gt;+1&lt;/button&gt;
      &lt;/div&gt;
    `</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 3. 应用实例2：共享同一份数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> shared = <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeName</span> = (<span class="hljs-params"/>) =&gt; shared.<span class="hljs-property">value</span>.<span class="hljs-property">username</span> = <span class="hljs-string">'新名称'</span>;
      <span class="hljs-keyword">return</span> { shared, changeName };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
      &lt;div&gt;
        &lt;h3&gt;应用2 - 用户名：{{ shared.username }}&lt;/h3&gt;
        &lt;h3&gt;应用2 - 同步计数：{{ shared.count }}&lt;/h3&gt;
        &lt;button @click="changeName"&gt;修改用户名&lt;/button&gt;
      &lt;/div&gt;
    `</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-24">2.事件总线</h3>
<p>通过第三方事件库（如 <code>mitt</code>）实现跨实例的 “发布 - 订阅” 通信，适用于需要<strong>触发行为 / 传递临时数据</strong>的场景（而非持久化共享状态）。</p>
<h4 data-id="heading-25">步骤：</h4>
<ol>
<li>安装 <code>mitt</code>（工程化项目）：<code>npm install mitt</code>；</li>
<li>创建全局事件总线实例；</li>
<li>不同应用实例通过 <code>emit</code> 发布事件，<code>on</code> 监听事件传递数据。</li>
</ol>
<pre><code class="hljs language-js" lang="js">&lt;!-- <span class="hljs-variable constant_">CDN</span> 方式示例 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.prod.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/mitt/dist/mitt.umd.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;
  <span class="hljs-comment">// 1. 创建全局事件总线</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span> = <span class="hljs-title function_">mitt</span>();

  <span class="hljs-comment">// 应用1：发布事件（传递数据）</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendCount</span> = (<span class="hljs-params"/>) =&gt; {
        count.<span class="hljs-property">value</span>++;
        <span class="hljs-comment">// 发布事件，携带数据</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'count-change'</span>, count.<span class="hljs-property">value</span>);
      };
      <span class="hljs-keyword">return</span> { count, sendCount };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;button @click="sendCount"&gt;应用1发送计数&lt;/button&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 应用2：监听事件（接收数据）</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> receiveCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
      <span class="hljs-comment">// 监听事件，接收数据</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'count-change'</span>, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
        receiveCount.<span class="hljs-property">value</span> = val;
      });
      <span class="hljs-keyword">return</span> { receiveCount };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用2接收的计数：{{ receiveCount }}&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-26">3.Pinia/Vuex</h3>
<p>Pinia（Vue 3 官方推荐）/ Vuex 是专门的状态管理库，可创建<strong>全局共享的状态仓库</strong>，多个应用实例通过访问同一仓库实现数据共享（最规范的方案）。</p>
<h4 data-id="heading-27">创建全局 Pinia</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/index.js</span>
<span class="hljs-keyword">import</span> { createPinia, defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-comment">// 1. 创建全局 Pinia 实例（唯一）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-comment">// 2. 定义共享仓库</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useSharedStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'shared'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Pinia 共享数据'</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;
    },
    <span class="hljs-title function_">updateMessage</span>(<span class="hljs-params">newMsg</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = newMsg;
    }
  }
});
</code></pre>
<h4 data-id="heading-28">多个应用实例挂载同一 Pinia 并使用仓库</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/app1.js（应用实例1）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { pinia, useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App1</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App1.vue'</span>;

<span class="hljs-keyword">const</span> app1 = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App1</span>);
<span class="hljs-comment">// 挂载全局 Pinia 实例</span>
app1.<span class="hljs-title function_">use</span>(pinia);
<span class="hljs-comment">// 组件内使用仓库</span>
<span class="hljs-comment">// App1.vue 中：</span>
<span class="hljs-comment">// setup() { const store = useSharedStore(); store.increment(); }</span>
app1.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

<span class="hljs-comment">// src/app2.js（应用实例2）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { pinia, useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App2</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App2.vue'</span>;

<span class="hljs-keyword">const</span> app2 = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App2</span>);
<span class="hljs-comment">// 挂载同一个 Pinia 实例</span>
app2.<span class="hljs-title function_">use</span>(pinia);
<span class="hljs-comment">// App2.vue 中可直接访问同一份仓库数据</span>
app2.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
</code></pre>
<h4 data-id="heading-29">组件内使用示例（App1.vue）：</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>应用1 - {{ store.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{{ store.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useSharedStore</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-30">组件内使用示例（App2.vue）：</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>应用2 - {{ store.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>同步计数：{{ store.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.updateMessage('应用2修改了消息')"</span>&gt;</span>修改消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useSharedStore</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-31">4.共享响应式对象</h3>
<h4 data-id="heading-32">1. 非sfc方式</h4>
<p>直接创建一个独立的响应式对象（<code>ref</code>/<code>reactive</code>），作为多个应用实例的 “数据源”，本质是将响应式数据抽离到实例外部。</p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;

  <span class="hljs-comment">// 1. 抽离共享的响应式数据（独立于应用实例）</span>
  <span class="hljs-keyword">const</span> sharedData = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">text</span>: <span class="hljs-string">'共享响应式数据'</span>
  });

  <span class="hljs-comment">// 应用1：使用共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; sharedData.<span class="hljs-property">value</span>.<span class="hljs-property">count</span>++;
      <span class="hljs-keyword">return</span> { sharedData, increment };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用1：{{ sharedData.count }} &lt;button @click="increment"&gt;+1&lt;/button&gt;&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 应用2：使用同一份共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeText</span> = (<span class="hljs-params"/>) =&gt; sharedData.<span class="hljs-property">value</span>.<span class="hljs-property">text</span> = <span class="hljs-string">'应用2修改'</span>;
      <span class="hljs-keyword">return</span> { sharedData, changeText };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用2：{{ sharedData.text }} / {{ sharedData.count }} &lt;button @click="changeText"&gt;改文本&lt;/button&gt;&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-33">2.sfc的方式</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e477e7b7eb844fd8b509a983b12229b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839137&amp;x-signature=stE2D8COLFf5zIUrdg314iPtls8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue 3 共享Ref示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主应用组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主应用<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>共享计数: {{ sharedCount }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>标题: {{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"incrementCount"</span>&gt;</span>增加计数<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTitle"</span>&gt;</span>修改标题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 动态创建的组件容器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dynamic-component"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
  <span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

  <span class="hljs-comment">// 子组件定义</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ChildComponent</span> = {
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="child-component"&gt;
      &lt;h3&gt;动态创建的子组件&lt;/h3&gt;
      &lt;p&gt;共享计数: {{ count }}&lt;/p&gt;
      &lt;p&gt;标题: {{ title }}&lt;/p&gt;
      &lt;button @click="decrementCount"&gt;减少计数&lt;/button&gt;
      &lt;button @click="resetTitle"&gt;重置标题&lt;/button&gt;
    &lt;/div&gt;
  `</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">count</span>: {
        <span class="hljs-comment">// 这里要传入ref类型</span>
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">title</span>: {
        <span class="hljs-comment">// 这里要传入ref类型</span>
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">onDecrement</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Function</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">onResetTitle</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Function</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    },
    <span class="hljs-attr">methods</span>: {
      <span class="hljs-title function_">decrementCount</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onDecrement</span>()
      },
      <span class="hljs-title function_">resetTitle</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onResetTitle</span>()
      },
    },
  }

  <span class="hljs-comment">// 创建共享的ref</span>
  <span class="hljs-keyword">const</span> sharedCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> title = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Hello'</span>)
  <span class="hljs-keyword">let</span> dynamicApp = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">incrementCount</span> = (<span class="hljs-params"/>) =&gt; {
    sharedCount.<span class="hljs-property">value</span>++
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrementCount</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (sharedCount.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
      sharedCount.<span class="hljs-property">value</span>--
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeTitle</span> = (<span class="hljs-params"/>) =&gt; {
    title.<span class="hljs-property">value</span> = <span class="hljs-string">`标题已修改 <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetTitle</span> = (<span class="hljs-params"/>) =&gt; {
    title.<span class="hljs-property">value</span> = <span class="hljs-string">'Hello'</span>
  }

  <span class="hljs-comment">// 动态应用的根组件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicRoot</span> = {
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;ChildComponent :count="count" :title="title" :on-decrement="onDecrement" :on-reset-title="onResetTitle" /&gt;'</span>,
    <span class="hljs-attr">components</span>: {
      <span class="hljs-title class_">ChildComponent</span>,
    },
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">count</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">onDecrement</span>: <span class="hljs-title class_">Function</span>,
      <span class="hljs-attr">onResetTitle</span>: <span class="hljs-title class_">Function</span>,
    },
  }

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 使用createApp(App, props)的写法创建动态应用</span>
    dynamicApp = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">DynamicRoot</span>, {
      <span class="hljs-attr">count</span>: sharedCount,
      <span class="hljs-attr">title</span>: title,
      <span class="hljs-attr">onDecrement</span>: decrementCount,
      <span class="hljs-attr">onResetTitle</span>: resetTitle,
    })

    <span class="hljs-comment">// 挂载到DOM</span>
    dynamicApp.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#dynamic-component'</span>)
  })

  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 清理动态创建的应用</span>
    <span class="hljs-keyword">if</span> (dynamicApp) {
      dynamicApp.<span class="hljs-title function_">unmount</span>()
    }
  })
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
  }

  <span class="hljs-selector-class">.main-app</span>,
  <span class="hljs-selector-class">.child-component</span> {
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#e0e0e0</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9f9f9</span>;
  }

  <span class="hljs-selector-class">.child-component</span> {
    <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#007bff</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f8ff</span>;
  }

  <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#007bff</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
  }

  <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#0056b3</span>;
  }

  <span class="hljs-selector-tag">h1</span>,
  <span class="hljs-selector-tag">h2</span>,
  <span class="hljs-selector-tag">h3</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<blockquote>
<p>注意 子组件需要使用ref类型作为参数，因为是根节点</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用]]></title>    <link>https://juejin.cn/post/7577016562252890163</link>    <guid>https://juejin.cn/post/7577016562252890163</guid>    <pubDate>2025-11-27T08:49:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252890163" data-draft-id="7577031454585831451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T08:49:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_瑶瑶_"/> <meta itemprop="url" content="https://juejin.cn/user/3635454702002747"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3635454702002747/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _瑶瑶_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:49:59.000Z" title="Thu Nov 27 2025 08:49:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">我的需求</h3>
<p>同时在一个表格中显示6个甚至更多的传感器数据，数据量在每个传感器每10秒1条数据，一般请求1天的数据。</p>
<p>以6个传感器计算一下数据量：</p>
<p><code>6 * 24 * 60 * 6 = 51840</code></p>
<p>一次只能请求到1个传感器的数据，也就是8640条，当查询时间范围变化时，循环请求接口获取数据，并且需要很快的渲染完毕。</p>
<p>效果像这样</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa8193045524e92941d241d6041b374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-eRtueRtl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838242&amp;x-signature=nA55nICdoid0l8aLZgY7OBv7SL0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">我的经历</h3>
<h4 data-id="heading-2">先使用的 Table（el-table）</h4>
<p>调用一次接口反应时间（浏览器网络窗口查看）约在1-2s左右，一次接口的数据使用<code>Table</code>渲染一次时间约是4s左右。</p>
<h4 data-id="heading-3">最开始的想法</h4>
<p>新添加一个传感器的数据，每一次需要重新渲染一次没有问题。</p>
<p>当切换查询时间后，循环调用时，采用的是——给tableData中直接添加。这会导致在循环调取数据时，每调取一次就会重新渲染一次。出现渲染卡顿问题，6个接口调用完毕且渲染完成，需要20-30s的时间，数据量大的时间会更长，有兴趣的朋友可以试一下。</p>
<pre><code class="hljs language-js" lang="js">&lt;el-table v-loading=<span class="hljs-string">"loading"</span> element-loading-text=<span class="hljs-string">"数据加载中"</span>:data=<span class="hljs-string">"tableData"</span>
  height=<span class="hljs-string">"100%"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">:min-width</span>=<span class="hljs-string">"leftWidth"</span> <span class="hljs-attr">:fixed</span>=<span class="hljs-string">"index == 0"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(column, index) in columns"</span>
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"column.prop"</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">"column.label"</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">"column.prop"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
&lt;/el-table&gt;
······
tableData.<span class="hljs-property">value</span> = tableData.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...item,
      [<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>)]: <span class="hljs-title class_">Number</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">Data</span>[index].<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>)
    }
})
</code></pre>
<h4 data-id="heading-4">对最开始的想法优化</h4>
<p>在循环调用时，调用一次渲染一次非常慢，第一次优化是拿到所有的数据之后，再将数据添加至tableData，之后同意进行渲染，这种方式快了一点，但没有太大改善。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">buildTableFromAllData</span> = (<span class="hljs-params">allFetched: <span class="hljs-built_in">Array</span>&lt;any&gt;</span>) =&gt; {
  <span class="hljs-keyword">if</span> (allFetched.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 第一步：构建 columns</span>
  <span class="hljs-keyword">const</span> newColumns = [
    { <span class="hljs-attr">prop</span>: <span class="hljs-string">'time'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'时间'</span> }
  ];
  allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ device, gateway }</span>) =&gt;</span> {
    newColumns.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">prop</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>),
      <span class="hljs-attr">label</span>: sensor.<span class="hljs-property">name</span>
    });
  });

  <span class="hljs-comment">// 第二步：对齐时间轴（假设所有设备返回的时间点一致）</span>
  <span class="hljs-keyword">const</span> firstData = allFetched[<span class="hljs-number">0</span>].<span class="hljs-property">rawData</span>;
  <span class="hljs-keyword">const</span> timeList = firstData.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title function_">dayjs</span>(item.<span class="hljs-property">time</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span>));

  <span class="hljs-comment">// 第三步：构建 tableData 行数据</span>
  <span class="hljs-keyword">const</span> newTableData = timeList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">time: string, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">row</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = { time };
    allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">_, colIndex</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = allFetched[colIndex].<span class="hljs-property">rawData</span>[index]?.<span class="hljs-property">data</span>;
      <span class="hljs-keyword">const</span> formatted = value ? <span class="hljs-title class_">Number</span>(value).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>) : <span class="hljs-string">''</span>;
      row[<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(_.<span class="hljs-property">sensor</span>.<span class="hljs-property">id</span>)] = formatted;
    });
    <span class="hljs-keyword">return</span> row;
  });

  <span class="hljs-comment">// 第四步：构建 lineData（用于图表）</span>
  <span class="hljs-keyword">const</span> newLineData = allFetched.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fetched</span> =&gt;</span>
    fetched.<span class="hljs-property">rawData</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>))
  );

  <span class="hljs-comment">// ✅ 一次性赋值！只触发一次响应式更新</span>
  columns.<span class="hljs-property">value</span> = newColumns;
  tableData.<span class="hljs-property">value</span> = newTableData;
};
</code></pre>
<h4 data-id="heading-5">虚拟化表格的接触</h4>
<p>在AI的建议下使用虚拟化表格。</p>
<p><code>ElementPlus</code>中的说明<code>通过虚拟化表格组件，超大数据渲染将不再是一个头疼的问题</code>。</p>
<p>使用虚拟化表格之后，渲染速度至少提升一半时间以上。</p>
<pre><code class="hljs language-js" lang="js">&lt;el-auto-resizer&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ height, width }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-v2</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">element-loading-text</span>=<span class="hljs-string">"数据加载中"</span> <span class="hljs-attr">:columns</span>=<span class="hljs-string">"columns"</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span>
      <span class="hljs-attr">:width</span>=<span class="hljs-string">"width"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">fixed</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/el-auto-resizer&gt;
······
<span class="hljs-keyword">const</span> <span class="hljs-title function_">buildTableFromAllData</span> = (<span class="hljs-params">allFetched: <span class="hljs-built_in">Array</span>&lt;any&gt;</span>) =&gt; {
  <span class="hljs-keyword">if</span> (allFetched.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">newColumns</span>: any[] = [
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'time'</span>,
      <span class="hljs-attr">dataKey</span>: <span class="hljs-string">'time'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'时间'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> * <span class="hljs-title class_">Number</span>(ratio.<span class="hljs-property">value</span>),
      <span class="hljs-attr">fixed</span>: <span class="hljs-string">'left'</span>
    }
  ];

  allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ sensor }</span>) =&gt;</span> {
    newColumns.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>),
      <span class="hljs-attr">dataKey</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(device.<span class="hljs-property">Deviceid</span>),
      <span class="hljs-attr">title</span>: sensor.<span class="hljs-property">name</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> * <span class="hljs-title class_">Number</span>(ratio.<span class="hljs-property">value</span>)
    })
  });

  <span class="hljs-keyword">const</span> firstData = allFetched[<span class="hljs-number">0</span>].<span class="hljs-property">rawData</span>;
  <span class="hljs-keyword">const</span> timeList = firstData.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title function_">dayjs</span>(item.<span class="hljs-property">time</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span>));

  <span class="hljs-keyword">const</span> newTableData = timeList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">time: string, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">row</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = { time };
    allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">_, colIndex</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = allFetched[colIndex].<span class="hljs-property">rawData</span>[index]?.<span class="hljs-property">data</span>;
      <span class="hljs-keyword">const</span> formatted = value ? <span class="hljs-title class_">Number</span>(value).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>) : <span class="hljs-string">''</span>;
      row[<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(_.<span class="hljs-property">sensor</span>.<span class="hljs-property">id</span>)] = formatted;
    });
    <span class="hljs-keyword">return</span> row;
  });
  
  <span class="hljs-keyword">const</span> newLineData = allFetched.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fetched</span> =&gt;</span>
    fetched.<span class="hljs-property">rawData</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>))
  );

  <span class="hljs-comment">// ✅ 一次性赋值！只触发一次响应式更新</span>
  columns.<span class="hljs-property">value</span> = newColumns;
  tableData.<span class="hljs-property">value</span> = newTableData;
};
</code></pre>
<h4 data-id="heading-6">其它问题</h4>
<h5 data-id="heading-7">问题</h5>
<p>其实以上用法已经完全解决了我的问题，但是在电脑浏览器中使用无误，但是<code>一换到手机浏览器或者平板浏览器中，虚拟表格直接滑不动</code>，能看到滚动条，但是就是滑不动，以下是我的解决尝试过程。</p>
<h5 data-id="heading-8">AI给的解决方案——添加CSS</h5>
<p>查询到滚动的内容是这样的<code>&lt;div class="el-vl__wrapper el-table-v2__body"</code>，于是我添加了下面的样式</p>
<pre><code class="hljs language-css" lang="css">:<span class="hljs-built_in">deep</span>(.el-table-v2__main .el-table-v2__body) {
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-x</span>: auto <span class="hljs-meta">!important</span>;
  touch-action: pan-x pan-y <span class="hljs-meta">!important</span>;
}
</code></pre>
<p>结果就是没有结果，并没有解决我的问题。</p>
<h5 data-id="heading-9">最终解决方案——还是添加CSS，但略有不同</h5>
<p>在审查元素的时候发现了一个东西，第二行div中的<code>overflow: hidden;</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-vl__wrapper el-table-v2__body"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"rowgroup"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">""</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: relative; overflow: hidden; will-change: transform; direction: ltr; height: 1313.11px; width: 2143.33px;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 3000px; width: 2137.33px;"</span>&gt;</span>
    ······
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>怎么给body设置滚动都没有用，因为里面给<code>hidden</code>了，于是添加的CSS变成了这样</p>
<pre><code class="hljs language-css" lang="css">:<span class="hljs-built_in">deep</span>(.el-table-v2__main .el-table-v2__body) {
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-x</span>: auto <span class="hljs-meta">!important</span>;
  touch-action: pan-x pan-y <span class="hljs-meta">!important</span>;
}
</code></pre>
<blockquote>
<p>OK！成功解决问题，以上就是虚拟化表格的浅用过程，得下次有机会再深入使用！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过<RouterView/>来切换页面组件时，transition如何生效？]]></title>    <link>https://juejin.cn/post/7577204540417146943</link>    <guid>https://juejin.cn/post/7577204540417146943</guid>    <pubDate>2025-11-27T08:59:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417146943" data-draft-id="7576681897297920015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过&lt;RouterView/&gt;来切换页面组件时，transition如何生效？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T08:59:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="saberxyL"/> <meta itemprop="url" content="https://juejin.cn/user/3942228504379243"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过&lt;RouterView/&gt;来切换页面组件时，transition如何生效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3942228504379243/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    saberxyL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:59:31.000Z" title="Thu Nov 27 2025 08:59:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">场景</h3>
<p>在使用Vue提供的<code>transition</code>组件来实现页面切换时的过渡效果时，直接使用了<code>transition</code>来包裹路由，结果发现了一个问题，新页面进入时的动画效果成功实现了，而旧页面离开的动画却失效了。</p>
<p>子页面1：</p>
<pre><code class="hljs language-Page1.Vue" lang="Page1.Vue">&lt;template&gt;
    &lt;div class="page1"&gt;
        page1
    &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.page1 {
    width: 100%;
    height: 100%;
    border: 1px solid #000;
    background-color: pink;
    text-align: center;
    font-size: 50px;
}
&lt;/style&gt;
</code></pre>
<p>子页面2:</p>
<pre><code class="hljs language-Page2.vue" lang="Page2.vue">&lt;template&gt;
    &lt;div class="page2"&gt;
        page2
    &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.page2 {
    width: 100%;
    height: 100%;
    background-color: blue;
    text-align: center;
    font-size: 50px;
}
&lt;/style&gt;
</code></pre>
<p>主页面：</p>
<pre><code class="hljs language-App.vue" lang="App.vue">&lt;template&gt;
&lt;div class="container"&gt;
      &lt;div class="tabs"&gt;
    &lt;router-link to="/page1"&gt;page1&lt;/router-link&gt;
    &lt;router-link to="/page2"&gt;page2&lt;/router-link&gt;
  &lt;/div&gt;
  &lt;div class="page"&gt;
      &lt;transition name="fade" mode="out-in"&gt;
          &lt;/router-view&gt;
      &lt;/transition&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;/template&gt;

&lt;style&gt;
.container {
  margin: 0 auto;
  width: 800px;
  height: 600px;
  border: 1px solid #000;
}
.page {
  width: 100%;
  height: calc(100% - 60px);
}
.tabs {
  height: 40px;
  width: 200px;
  margin: 0 auto;
  background: green;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
}
a {
  color: #fff;
  font-size: 20px;
}
.fade-enter-active {
  transition: all 0.5s ease-in-out;
}
.fade-enter-from {
  opacity: 0;
  transform: translateX(100%);
}
.fade-enter-to {
  opacity: 1;
  transform: translateX(0);
}
.fade-leave-active {
  transition: all 0.5s ease-in-out;
}
.fade-leave-from {
  opacity: 1;
  transform: translateX(0);
}
.fade-leave-to {
  opacity: 0;
  transform: translateX(-100%);
}
&lt;/style&gt;

</code></pre>
<p>页面效果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/980b5ba1a5ef499686630ea997387dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=tU80UIBMZm6C9wYyKKGsc0ph%2FuI%3D" alt="" loading="lazy"/>
切换页面
<code>.fade-enter</code>相关CSS成功执行，<code>.fade-leave</code>相关CSS执行失败.（如图）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6681024eaf4f12afc4766407dcb97a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=I8Fkf02k0IkhwAntN%2F2sN3jYRyo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">解决方法</h3>
<p>后来我从别人那获取到了解决方法：用 <code>RouterView</code> 包裹 <code>Transition</code> 配合 <code>Component</code> 实现过渡效果。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;router-view v-slot="{ Component }"&gt;
      &lt;transition&gt;
        &lt;component :is="Component" /&gt;
      &lt;/transition&gt;
    &lt;/router-view&gt;
&lt;template/&gt;
</code></pre>
<p>改为这样子后，无论是进入还是里离开都能正确执行了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79bdcc035173466e885a59b6c78e6780~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=zae8qDK8WznCLSolSoGwJ8OHSIs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">原因</h3>
<p>Vue3 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fguide%2Fbuilt-ins%2Ftransition.html" target="_blank" title="https://cn.vuejs.org/guide/built-ins/transition.html" ref="nofollow noopener noreferrer">Transition</a>一节中，给出了<code>transition</code>组件的触发条件（满足其一）：</p>
<ul>
<li>由 <code>v-if</code> 所触发的切换</li>
<li>由 <code>v-show</code> 所触发的切换</li>
<li>由特殊元素 <code>&lt;component&gt;</code> 切换的动态组件</li>
<li>改变特殊的 <code>key</code> 属性</li>
</ul>
<p>意思就是说<code>&lt;transition&gt;</code> 组件要正常工作，<strong>包裹的内容必须是 “可复用” 的元素或组件</strong></p>
<h4 data-id="heading-3">问题根源：<code>router-view</code> 是一个 “动态渲染出口”</h4>
<p>其关键在于<code>router-view</code>本身不可复用，它的核心行为如下：</p>
<ul>
<li>当路由切换时，<strong>销毁旧组件实例</strong>，<strong>创建新组件实例</strong>；</li>
<li><code>router-view</code> 本身不会 “更新”，而是直接替换内部的组件内容。</li>
</ul>
<p>当直接写 <code>&lt;transition&gt;&lt;router-view /&gt;&lt;/transition&gt;</code> 时，路由更新，<code>transition</code>还没有来得及给旧组件添加离开的效果时，旧的组件实例已经销毁了，这时新的组件实例创建，<code>transition</code>能够正常捕获到该组件实例。而解决方法是通过作用域插槽 <code>"v-slot={Component}"</code> ，把当前路由对应的组件实例暴露出来, 然后使用 <code>component</code>来动态渲染，由于 <code>&lt;component&gt;</code> 本身是一个 “可复用” 的容器，它不会被销毁，只是改变内部渲染的组件。可以让 <code>&lt;transition&gt;</code> 正常监听组件的 “离开” 和 “进入”，从而执行完整的过渡动画。</p>
<h3 data-id="heading-4">总结</h3>
<p>总之，路由切换过渡动画的核心是让 <code>&lt;transition&gt;</code> 能正常捕获组件的 “离开” 与 “进入” 状态（满足官方给出的触发条件）。避开直接包裹 <code>&lt;router-view&gt;</code> 的误区，同时呢也需要注意样式隔离、动画执行顺序等细节，这样就能实现完整的路由过渡效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android多层嵌套RecyclerView滚动]]></title>    <link>https://juejin.cn/post/7577226553285984291</link>    <guid>https://juejin.cn/post/7577226553285984291</guid>    <pubDate>2025-11-27T09:16:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577226553285984291" data-draft-id="7577226553285935139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android多层嵌套RecyclerView滚动"/> <meta itemprop="keywords" content="Android,Kotlin,Java"/> <meta itemprop="datePublished" content="2025-11-27T09:16:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方白羽"/> <meta itemprop="url" content="https://juejin.cn/user/2333635831676704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android多层嵌套RecyclerView滚动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2333635831676704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方白羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:16:07.000Z" title="Thu Nov 27 2025 09:16:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android嵌套滚动终极指南：从Fling中断到丝滑联动的实现之路（含多层嵌套扩展）</h2>
<p>在构建复杂的Android界面时，<strong>RecyclerView嵌套RecyclerView</strong>是无法回避的经典难题。用户期望的是「如丝般顺滑、浑然一体」的滚动体验，但现实往往充斥着滑动冲突、卡顿与恼人的 <strong>「Fling中断」</strong>。</p>
<p>本文将以一个真实的复杂首页场景为例，系统性拆解问题根源，并通过<strong>自定义RecyclerView</strong>从根源解决问题，最终实现「一个整体」的滚动效果。<strong>更重要的是，这套「托管Fling+手动分发」的方案具备极强的扩展性，可支持3层、4层甚至更多层嵌套滚动</strong>（如「外层列表→ViewPager→内层列表→滚动子列表」）。</p>
<h3 data-id="heading-1">一、问题的根源：为什么官方方案「不完美」？</h3>
<h4 data-id="heading-2">1.1 CoordinatorLayout的局限性</h4>
<p><code>CoordinatorLayout + AppBarLayout</code>是官方推荐的嵌套滑动方案，能优雅处理<strong>拖拽滑动</strong>（如向上滚动收起AppBar、向下展开），但在 <strong>Fling（惯性滑动）</strong> ​ 时存在致命缺陷：</p>
<blockquote>
<p><strong>惯性速度无法跨View传递</strong>​</p>
<p>系统的Fling是一次性的动画，一旦某个View的Fling结束，其速度立即消失。不同View间没有天然的「速度接力」机制，导致滚动体验被硬生生中断。</p>
</blockquote>
<h4 data-id="heading-3">1.2 核心矛盾：Fling为何难以跨RecyclerView传递？</h4>
<p>要理解Fling中断的本质，需先明确两个关键事实：</p>
<ul>
<li><strong>系统Fling的一次性</strong>：系统对Fling的处理是「触发即执行完毕」，动画过程中无法中途干预或传递速度；</li>
<li><strong>无天然速度接力机制</strong>：不同RecyclerView作为独立View，没有内置逻辑感知彼此的滚动状态并传递惯性。</li>
</ul>
<p>这导致：当用户快速滑动屏幕时，头部（如AppBar）的Fling结束后，下方列表的Fling无法自动接续，用户会明显感受到「滚动突然停了一下」。</p>
<h3 data-id="heading-4">二、破局之道：托管Fling + 手动分发，实现无缝滚动</h3>
<p>面对官方方案的局限，我们需要跳出「依赖系统Fling」的思维，转向<strong>主动控制滚动流程</strong>：</p>
<h4 data-id="heading-5">2.1 核心策略：从「被动响应」到「主动托管」</h4>
<p>通过两个关键动作打破Fling中断困局：</p>
<ul>
<li><strong>托管Fling</strong>：自行实现惯性滚动的物理模拟（替代系统一次性Fling），掌控每帧滚动的距离与速度；</li>
<li><strong>手动分发</strong>：在每帧滚动中，按预设规则（如上滑外部优先、下滑内部优先）将滚动距离分配给不同RecyclerView。</li>
</ul>
<h3 data-id="heading-6">三、困境：理想滚动与「Fling中断」的现实冲突</h3>
<h4 data-id="heading-7">3.1 目标场景：复杂首页的典型结构</h4>
<p>我们以电商/资讯类App的首页为例，其结构极具代表性：</p>
<ul>
<li><strong>顶部Header</strong>：Banner、金刚区、运营位等固定/可滚动区域；</li>
<li><strong>中部容器</strong>：ViewPager（多Tab切换）；</li>
<li><strong>底部列表</strong>：ViewPager每个Tab对应一个「无限滚动的推荐信息流RecyclerView」。</li>
</ul>
<p><strong>理想体验</strong>：用户一次快速滑动，整个页面（从Header到ViewPager内的列表）应像「单一超长列表」一样惯性滚动到底，无任何中断感。</p>
<h4 data-id="heading-8">3.2 官方方案的尝试与折戟</h4>
<h5 data-id="heading-9">3.2.1 CoordinatorLayout的「拖拽优势」</h5>
<p>通过XML布局，<code>CoordinatorLayout</code>可实现拖拽时的无缝衔接：</p>
<ul>
<li>向上拖拽 → AppBar先收起 → Header完全隐藏后，ViewPager内的列表开始滚动；</li>
<li>向下拖拽 → 列表滚到顶部后，AppBar开始展开。</li>
</ul>
<h5 data-id="heading-10">3.2.2 致命缺陷：Fling速度「断档」</h5>
<p>尽管拖拽体验流畅，但<strong>Fling时惯性速度无法传递</strong>：</p>
<p>当用户快速上滑触发Fling，AppBar的收起动画结束后，速度直接消失，下方的ViewPager列表不会自动接续滚动，用户会看到「列表突然停住，需再次滑动才能继续」的割裂感。</p>
<h3 data-id="heading-11">四、终极方案：自定义嵌套RecyclerView——总指挥官的「托管与分发」</h3>
<p>要彻底解决Fling中断，需让父容器成为滚动的「总指挥官」，完全接管滑动事件的分发权。我们设计的<strong>自定义父RecyclerView</strong>，核心逻辑围绕「精准路权分配」与「Fling托管」展开。</p>
<h4 data-id="heading-12">4.1 策略一：精准的拖拽「路权」分配</h4>
<p>通过重写 <code>dispatchNestedPreScroll</code>定义清晰的滚动优先级规则，确保拖拽过程连贯如「接力赛」：</p>

















<table><thead><tr><th>滑动方向</th><th>路权分配规则</th></tr></thead><tbody><tr><td><strong>上滑</strong>​</td><td>外部父RecyclerView先滚动 → 滑到底后，剩余滚动距离无缝分配给内部子RecyclerView</td></tr><tr><td><strong>下滑</strong>​</td><td>内部子RecyclerView先滚动 → 滑到顶后，外部父RecyclerView开始接管滚动</td></tr></tbody></table>
<p><strong>实现逻辑</strong>：在 <code>dispatchNestedPreScroll</code>中，根据当前滑动方向和子View的滚动边界（如是否滑到底/顶），动态调整传递给子View的滚动距离 <code>consumed</code>，确保「一个View滚不动了，另一个立刻跟上」。</p>
<h4 data-id="heading-13">4.2 策略二：化整为零，托管Fling（方案精髓）</h4>
<p>Fling中断的核心是「系统一次性动画无法接力」，因此我们需要<strong>将Fling拆解为连续的手动滚动帧</strong>，具体分三步：</p>
<h5 data-id="heading-14">4.2.1 拦截Fling：告诉系统「我来处理」</h5>
<p>重写 <code>dispatchNestedPreFling</code>并返回 <code>true</code>，拦截系统的默认Fling处理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchNestedPreFling</span><span class="hljs-params">(velocityX: <span class="hljs-type">Float</span>, velocityY: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-comment">// 拦截Fling，后续由自定义逻辑接管</span>
    startCustomFling(velocityY) 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> 
}
</code></pre>
<h5 data-id="heading-15">4.2.2 启动模拟器：用OverScroller计算每帧位置</h5>
<p>借助 <code>OverScroller</code>模拟物理滚动（类似「自定义物理引擎」），根据初始Fling速度计算未来每帧的滚动位置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> overScroller = OverScroller(context, customInterpolator)

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCustomFling</span><span class="hljs-params">(initialVelocityY: <span class="hljs-type">Float</span>)</span></span> {
    <span class="hljs-comment">// 传入初始速度（如用户快速上滑的velocityY），OverScroller会自动计算滚动轨迹</span>
    overScroller.fling(
        <span class="hljs-number">0</span>, getCurrentScrollY(), <span class="hljs-comment">// 起始位置</span>
        <span class="hljs-number">0</span>, initialVelocityY,   <span class="hljs-comment">// 初始速度（x轴无需处理，聚焦垂直滚动）</span>
        <span class="hljs-built_in">Int</span>.MIN_VALUE, <span class="hljs-built_in">Int</span>.MAX_VALUE, <span class="hljs-comment">// 滚动范围（理论上无限）</span>
        <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    )
    <span class="hljs-comment">// 触发重绘，进入computeScroll循环</span>
    invalidate()
}
</code></pre>
<h5 data-id="heading-16">4.2.3 逐帧分发：按规则分配滚动距离</h5>
<p>重写 <code>computeScroll</code>方法，在每帧动画中：</p>
<ol>
<li>检查 <code>OverScroller</code>是否还有未完成的滚动；</li>
<li>计算当前帧需滚动的微小距离 <code>dy</code>；</li>
<li>按「上滑外部优先、下滑内部优先」规则，将 <code>dy</code>分配给父/子RecyclerView；</li>
<li>调用 <code>scrollBy(0, dy)</code>执行滚动，直至Fling结束。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">computeScroll</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> (overScroller.computeScrollOffset()) { <span class="hljs-comment">// 滚动未结束</span>
        <span class="hljs-keyword">val</span> currentY = overScroller.currY
        <span class="hljs-keyword">val</span> dy = currentY - lastFlingY <span class="hljs-comment">// 当前帧滚动距离</span>
        lastFlingY = currentY

        <span class="hljs-comment">// 按规则分发dy：上滑时父RV先消费，剩余给子RV；下滑时相反</span>
        distributeScroll(dy, isUpward = dy &lt; <span class="hljs-number">0</span>) 

        invalidate() <span class="hljs-comment">// 继续下一帧</span>
    }
}
</code></pre>
<p><strong>效果</strong>：原本「一次性Fling」被转化为「连续可控的scrollBy」，父/子RecyclerView的滚动无缝接力，彻底消除Fling中断。</p>
<h4 data-id="heading-17">4.3 连接：findViewWithTag——总指挥官的「GPS定位」</h4>
<p>「总指挥官」（父RecyclerView）需精准找到「士兵」（子RecyclerView）。我们通过<strong>Tag链式查找</strong>实现动态定位（避免硬编码ID，增强复用性）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchNestedChild</span><span class="hljs-params">()</span></span>: RecyclerView? {
    <span class="hljs-comment">// 1. 找到ViewPager（假设Tag为"main_viewpager"）</span>
    <span class="hljs-keyword">val</span> viewPager = findViewWithTag&lt;ViewPager&gt;(<span class="hljs-string">"main_viewpager"</span>) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 2. 获取当前显示的Fragment（需结合ViewPager适配器逻辑）</span>
    <span class="hljs-keyword">val</span> adapter = viewPager.adapter <span class="hljs-keyword">as</span>? MainViewPagerAdapter ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">val</span> currentFragment = adapter.getCurrentFragment() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 3. 在Fragment视图中找到子RecyclerView（Tag为"inner_feed_rv"）</span>
    <span class="hljs-keyword">return</span> currentFragment.view?.findViewWithTag&lt;RecyclerView&gt;(<span class="hljs-string">"inner_feed_rv"</span>)
}
</code></pre>
<p><strong>优势</strong>：通过Tag解耦布局层级，即使ViewPager的Fragment动态切换，也能实时定位当前活跃的子RecyclerView。</p>
<h4 data-id="heading-18">4.4 灵魂：手感的秘密——五次方缓出插值器</h4>
<p>滚动「手感」决定用户体验的上限。我们通过自定义插值器，让Fling的减速过程更接近真实物理摩擦力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">customInterpolator</span> <span class="hljs-operator">=</span> Interpolator { t -&gt;
    <span class="hljs-type">val</span> <span class="hljs-variable">adjustedT</span> <span class="hljs-operator">=</span> t - <span class="hljs-number">1.0f</span>
    adjustedT * adjustedT * adjustedT * adjustedT * adjustedT + <span class="hljs-number">1.0f</span> <span class="hljs-comment">// 五次方缓出公式</span>
}

<span class="hljs-comment">// 初始化OverScroller时传入插值器</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">overScroller</span> <span class="hljs-operator">=</span> OverScroller(context, customInterpolator)
</code></pre>
<p><strong>五次方缓出（Quintic Ease-Out）的特性</strong>：</p>
<ul>
<li>速度曲线：瞬间达到峰值 → 迅速衰减 → 缓慢归零；</li>
<li>物理感：接近「带摩擦力的滚动」，比系统原生指数衰减更灵敏、动态感更强；</li>
<li>体验优化：避免Fling「戛然而止」的突兀感，滚动结束更自然。</li>
</ul>
<h3 data-id="heading-19">五、【关键扩展】从2层到N层：多层嵌套滚动的实现逻辑</h3>
<p>前文方案以「2层嵌套」（父RecyclerView→子RecyclerView）为例，但<strong>核心设计天然支持3层、4层甚至更多层嵌套</strong>。关键在于：<strong>将「父子分发」抽象为「层级链分发」，每层仅关注「自身与直接子View」的交互，形成递归式滚动接力</strong>。</p>
<h4 data-id="heading-20">5.1 多层嵌套的典型场景</h4>
<p>例如某资讯App的「专题详情页」：</p>
<ul>
<li><strong>第1层</strong>：外层纵向RecyclerView（包含专题Header、简介、章节列表）；</li>
<li><strong>第2层</strong>：章节列表中的Item是横向RecyclerView（展示该章节的文章卡片）；</li>
<li><strong>第3层</strong>：文章卡片点击后展开为纵向RecyclerView（展示文章评论流）；</li>
<li><strong>第4层</strong>：评论流中可能嵌套横向RecyclerView（展示热门回复标签）。</li>
</ul>
<p><strong>需求</strong>：用户快速上滑时，从第1层Header到第4层评论流，需像「单一长列表」一样惯性滚动到底，无任何中断。</p>
<h4 data-id="heading-21">5.2 扩展核心：层级链分发 + 递归路权判断</h4>
<p>多层嵌套的关键是<strong>让每层RecyclerView都成为「局部指挥官」</strong>，通过「递归判断滚动边界」实现跨层接力：</p>
<h5 data-id="heading-22">5.2.1 抽象分发规则：每层仅需处理「自身与直接子View」</h5>
<p>无论多少层，每层RecyclerView的分发逻辑可抽象为：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/** 通用滚动分发逻辑：当前层先消费滚动距离，剩余传递给直接子View */</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchScrollToChild</span><span class="hljs-params">(dy: <span class="hljs-type">Int</span>, isUpward: <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> remainingDy = dy <span class="hljs-comment">// 剩余未消费的滚动距离</span>
    <span class="hljs-comment">// 1. 当前层先判断是否可滚动（如未到顶部/底部）</span>
    <span class="hljs-keyword">val</span> currentConsumed = consumeSelfScroll(remainingDy, isUpward)
    remainingDy -= currentConsumed

    <span class="hljs-comment">// 2. 若当前层已滚不动（remainingDy≠0），则传递给直接子View</span>
    <span class="hljs-keyword">if</span> (remainingDy != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> child = findDirectChildRecyclerView() <span class="hljs-comment">// 找直接子RecyclerView（如第2层找第3层）</span>
        <span class="hljs-keyword">if</span> (child != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 递归调用子View的分发逻辑（子View可能继续传递给它的子View）</span>
            remainingDy = child.dispatchScrollRecursive(remainingDy, isUpward)
        }
    }
    <span class="hljs-keyword">return</span> dy - remainingDy <span class="hljs-comment">// 返回当前层及子View总共消费的距离</span>
}
</code></pre>
<h5 data-id="heading-23">5.2.2 递归终止条件：最内层View或滚动边界</h5>
<p>递归分发会在两种情况下终止：</p>
<ul>
<li><strong>触达最内层View</strong>：如第4层评论流的RecyclerView无嵌套子View，直接消费剩余滚动距离；</li>
<li><strong>滚动到边界</strong>：某层View已滑到顶部/底部（如第2层横向RecyclerView滑到最左/右），无法继续消费滚动距离，此时滚动停止或反向传递（如下滑时从内层向外层传递）。</li>
</ul>
<h5 data-id="heading-24">5.2.3 Fling托管的跨层延续</h5>
<p>Fling的托管逻辑同样支持多层：</p>
<ul>
<li>每层RecyclerView维护自身的 <code>OverScroller</code>，但根据「层级优先级」决定是否接管Fling；</li>
<li>例如第1层Fling时，若第1层未滚到底，则自身消费Fling；若已滚到底，则将Fling速度传递给第2层；第2层同理传递给第3层，直至最内层消费完毕。</li>
</ul>
<h4 data-id="heading-25">5.3 多层嵌套的关键实现细节</h4>
<h5 data-id="heading-26">5.3.1 动态层级查找：从「单层GPS」到「层级链GPS」</h5>
<p>通过<strong>层级Tag标记</strong>实现任意层View的定位，例如：</p>
<ul>
<li>第1层RecyclerView Tag：<code>"layer1_main_rv"</code></li>
<li>第2层横向RecyclerView Tag：<code>"layer2_horizontal_rv"</code></li>
<li>第3层评论流RecyclerView Tag：<code>"layer3_comment_rv"</code></li>
</ul>
<p>查找第N层View时，通过链式Tag拼接定位：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findLayerNChild</span><span class="hljs-params">(layerTagPrefix: <span class="hljs-type">String</span>)</span></span>: RecyclerView? {
    <span class="hljs-keyword">var</span> currentView: View = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">2.</span>.layerTagPrefix.last().digitToInt()) { <span class="hljs-comment">// 从第2层开始递归查找</span>
        currentView = currentView.findViewWithTag(<span class="hljs-string">"<span class="hljs-subst">${layerTagPrefix}</span><span class="hljs-subst">${i}</span>"</span>) ?: <span class="hljs-keyword">break</span>
    }
    <span class="hljs-keyword">return</span> currentView <span class="hljs-keyword">as</span>? RecyclerView
}
</code></pre>
<h5 data-id="heading-27">5.3.2 性能考量：避免递归过深导致的卡顿</h5>
<p>多层递归可能增加计算开销，需通过以下方式优化：</p>
<ul>
<li><strong>缓存子View引用</strong>：对频繁访问的内层View（如当前显示的ViewPager Tab内的RecyclerView），缓存其引用避免重复查找；</li>
<li><strong>限制最大嵌套深度</strong>：实际业务中嵌套超过4层的情况极少，可通过配置限制最大递归深度，避免栈溢出；</li>
<li><strong>异步预加载边界</strong>：提前计算各层View的滚动边界（如是否已滑到底），减少实时递归判断的性能消耗。</li>
</ul>
<h3 data-id="heading-28">六、结论：从「用轮子」到「造轮子」的工程智慧</h3>
<p>当官方API无法满足复杂场景需求时，深入底层构建自定义方案是一种「高级工程权衡」。本文方案的核心启示：</p>
<h4 data-id="heading-29">6.1 理解问题本质是基础</h4>
<p>CoordinatorLayout的局限不在「拖拽」，而在「Fling速度无法跨View传递」——这是所有嵌套滚动卡顿/中断的起点。</p>
<h4 data-id="heading-30">6.2 选择正确的「攻坚道路」</h4>
<p>上层API（如CoordinatorLayout）是「通用工具」，复杂业务场景需「定制化武器」。通过深入 <code>NestedScrolling</code>机制与事件分发底层，我们能构建更贴合业务的滚动规则。</p>
<h4 data-id="heading-31">6.3 扩展性：从2层到N层的核心价值</h4>
<p>本文方案的最大亮点并非仅解决2层嵌套，而是提供了<strong>一套可扩展的嵌套滚动框架</strong>：通过「层级链分发+递归路权判断」，支持3层、4层甚至更多层嵌套，满足电商首页、资讯专题页等超复杂场景的无缝滚动需求。</p>
<h4 data-id="heading-32">6.4 优雅解决问题：功能与体验的双重打磨</h4>
<p>我们不仅通过「托管Fling+手动分发」解决了Fling中断的功能问题，更通过<strong>五次方插值器</strong>优化了滚动手感，让体验从「能用」升级为「好用」。</p>
<h4 data-id="heading-33">最终权衡：牺牲100%保真，换99%流畅与100%连贯</h4>
<p>该方案虽未100%复刻系统Fling的物理精度，却换来了复杂业务场景下「几乎无中断」的流畅体验。这是工程实践中「取舍与平衡」的典范——<strong>用户的「连贯感」比「物理精度」更重要</strong>。</p>
<p>下一次面对棘手嵌套滚动时，不妨思考：除了使用现成轮子，我们也可选择成为「造轮子的人」——毕竟，极致的用户体验，往往藏在自定义的细节里，而「可扩展的自定义方案」，更能支撑业务的无限可能</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[密码算法的OID查阅]]></title>    <link>https://juejin.cn/post/7577189654489169970</link>    <guid>https://juejin.cn/post/7577189654489169970</guid>    <pubDate>2025-11-27T09:33:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654489169970" data-draft-id="7576968345876348955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="密码算法的OID查阅"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-11-27T09:33:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鳄鱼儿"/> <meta itemprop="url" content="https://juejin.cn/user/3751996066103758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            密码算法的OID查阅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3751996066103758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鳄鱼儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:33:51.000Z" title="Thu Nov 27 2025 09:33:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、OID 命名结构</h3>
<h4 data-id="heading-1">1. 纯模式（Pure Mode）</h4>
<p>直接对原始消息签名，OID 格式为：</p>
<pre><code class="hljs language-xml" lang="xml">id-slh-dsa-<span class="hljs-tag">&lt;<span class="hljs-name">hash-family</span>&gt;</span>-<span class="hljs-tag">&lt;<span class="hljs-name">security-level</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">variant</span>&gt;</span>
</code></pre>
<p>其中：</p>
<ul>
<li><code>&lt;hash-family&gt;</code>：<code>sha2</code> 或 <code>shake</code></li>
<li><code>&lt;security-level&gt;</code>：<code>128</code>、<code>192</code>、<code>256</code></li>
<li><code>&lt;variant&gt;</code>：<code>s</code>（small，优化签名长度）或 <code>f</code>（fast，优化签名/密钥生成速度）</li>
</ul>
<p>示例：</p>
<ul>
<li><code>id-slh-dsa-sha2-128s</code></li>
<li><code>id-slh-dsa-shake-256f</code></li>
</ul>
<p>这些 OID 隶属于 <code>nistAlgorithms(2.16.840.1.101.3.4.3)</code> 下的 <code>sigAlgs(20–31)</code> 范围。</p>
<h4 data-id="heading-2">2. 预哈希模式（Hashed Mode）</h4>
<p>先对消息进行指定哈希，再对摘要签名，OID 格式为：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">id</span>-<span class="hljs-built_in">hash</span>-slh-dsa-&lt;<span class="hljs-built_in">hash</span>-family&gt;-&lt;security-level&gt;&lt;variant&gt;-<span class="hljs-keyword">with</span>-&lt;prehash-alg&gt;
</code></pre>
<p>其中 <code>&lt;prehash-alg&gt;</code> 必须与安全级别匹配：</p>
<ul>
<li>128 位安全 → SHA-256 或 SHAKE128</li>
<li>192 位安全 → SHA-384 或 SHAKE192</li>
<li>256 位安全 → SHA-512 或 SHAKE256</li>
</ul>
<p>示例：</p>
<ul>
<li><code>id-hash-slh-dsa-sha2-128s-with-sha256</code></li>
<li><code>id-hash-slh-dsa-shake-256f-with-shake256</code></li>
</ul>
<p>这些 OID 隶属于 <code>nistAlgorithms.sigAlgs(2.16.840.1.101.3.4.3)</code> 的 <code>35–46</code> 范围。</p>
<hr/>
<h3 data-id="heading-3">二、完整 OID 列表（按安全级别分类）</h3>
<h4 data-id="heading-4">SLH-DSA算法</h4>
<p>SLH-DSA（Stateless Hash-Based Digital Signature Algorithm）是 NIST 在 FIPS 205 标准中正式标准化的后量子数字签名算法，其 OID（对象标识符）由 <strong>NIST CSOR（Computer Security Objects Registry）</strong> 分配，用于在 X.509 PKI、CMS 等密码协议中唯一标识不同参数组合和工作模式。</p>













































































































































































































<table><thead><tr><th>安全级别</th><th>模式</th><th>哈希家族</th><th>变体</th><th>OID 名称</th><th>示例 OID（十进制点分格式）</th></tr></thead><tbody><tr><td>128</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-128s</td><td><code>2.16.840.1.101.3.4.3.20</code></td></tr><tr><td>128</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-128f</td><td><code>2.16.840.1.101.3.4.3.21</code></td></tr><tr><td>128</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-128s</td><td><code>2.16.840.1.101.3.4.3.22</code></td></tr><tr><td>128</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-128f</td><td><code>2.16.840.1.101.3.4.3.23</code></td></tr><tr><td>192</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-192s</td><td><code>2.16.840.1.101.3.4.3.24</code></td></tr><tr><td>192</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-192f</td><td><code>2.16.840.1.101.3.4.3.25</code></td></tr><tr><td>192</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-192s</td><td><code>2.16.840.1.101.3.4.3.26</code></td></tr><tr><td>192</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-192f</td><td><code>2.16.840.1.101.3.4.3.27</code></td></tr><tr><td>256</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-256s</td><td><code>2.16.840.1.101.3.4.3.28</code></td></tr><tr><td>256</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-256f</td><td><code>2.16.840.1.101.3.4.3.29</code></td></tr><tr><td>256</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-256s</td><td><code>2.16.840.1.101.3.4.3.30</code></td></tr><tr><td>256</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-256f</td><td><code>2.16.840.1.101.3.4.3.31</code></td></tr><tr><td>128</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-128s-with-sha256</td><td><code>2.16.840.1.101.3.4.3.35</code></td></tr><tr><td>128</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-128f-with-sha256</td><td><code>2.16.840.1.101.3.4.3.36</code></td></tr><tr><td>128</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-128s-with-shake128</td><td><code>2.16.840.1.101.3.4.3.37</code></td></tr><tr><td>128</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-128f-with-shake128</td><td><code>2.16.840.1.101.3.4.3.38</code></td></tr><tr><td>192</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-192s-with-sha384</td><td><code>2.16.840.1.101.3.4.3.39</code></td></tr><tr><td>192</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-192f-with-sha384</td><td><code>2.16.840.1.101.3.4.3.40</code></td></tr><tr><td>192</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-192s-with-shake192</td><td><code>2.16.840.1.101.3.4.3.41</code></td></tr><tr><td>192</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-192f-with-shake192</td><td><code>2.16.840.1.101.3.4.3.42</code></td></tr><tr><td>256</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-256s-with-sha512</td><td><code>2.16.840.1.101.3.4.3.43</code></td></tr><tr><td>256</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-256f-with-sha512</td><td><code>2.16.840.1.101.3.4.3.44</code></td></tr><tr><td>256</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-256s-with-shake256</td><td><code>2.16.840.1.101.3.4.3.45</code></td></tr><tr><td>256</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-256f-with-shake256</td><td><code>2.16.840.1.101.3.4.3.46</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">三、参考资料</h3>
<ul>
<li><strong>FIPS 205</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnvlpubs.nist.gov%2Fnistpubs%2FFIPS%2FNIST.FIPS.205.pdf" target="_blank" title="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.205.pdf" ref="nofollow noopener noreferrer">nvlpubs.nist.gov/nistpubs/FI…</a></li>
<li><strong>RFC 9814</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Frfc9814.html" target="_blank" title="https://www.rfc-editor.org/rfc/rfc9814.html" ref="nofollow noopener noreferrer">www.rfc-editor.org/rfc/rfc9814…</a></li>
<li><strong>NIST CSOR Registry</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fcsrc.nist.gov%2Fprojects%2Fcomputer-security-objects-register" target="_blank" title="https://csrc.nist.gov/projects/computer-security-objects-register" ref="nofollow noopener noreferrer">csrc.nist.gov/projects/co…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcsrc.nist.gov%2Fprojects%2Fcomputer-security-objects-register%2Falgorithm-registration" target="_blank" title="https://csrc.nist.gov/projects/computer-security-objects-register/algorithm-registration" ref="nofollow noopener noreferrer">NIST CSOR</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道]]></title>    <link>https://juejin.cn/post/7577050643203588146</link>    <guid>https://juejin.cn/post/7577050643203588146</guid>    <pubDate>2025-11-27T09:29:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577050643203588146" data-draft-id="7577016562253103155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-11-27T09:29:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月光技术杂谈"/> <meta itemprop="url" content="https://juejin.cn/user/3323149076668138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323149076668138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月光技术杂谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:29:12.000Z" title="Thu Nov 27 2025 09:29:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道</h2>
<h3 data-id="heading-1">概要</h3>
<p>在使用编译好的固件烧写系统启动后，你是否遇到过这样的困惑：明明硬件 eMMC 存储为 32G，可系统显示的用户分区却仅有 812M。常规修改固件分区表来调整的方法较为繁琐，本文将带你验证一种更为简便的方式，轻松找回那些 “消失” 的 eMMC 存储空间。</p>
<h3 data-id="heading-2">问题分析</h3>
<p>系统启动后，通过执行相关命令查看分区信息，能清晰了解当前系统的存储分配状况：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   19M  968M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup

<span class="hljs-comment"># lsblk</span>
NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
mmcblk0      179:0    0 28.9G  0 disk 
├─mmcblk0p1  179:1    0    4M  0 part 
├─mmcblk0p2  179:2    0    4M  0 part 
├─mmcblk0p3  179:3    0   64M  0 part 
├─mmcblk0p4  179:4    0   64M  0 part 
├─mmcblk0p5  179:5    0   32M  0 part 
├─mmcblk0p6  179:6    0    6G  0 part /
├─mmcblk0p7  179:7    0  128M  0 part 
└─mmcblk0p8  179:8    0 22.6G  0 part 
mmcblk0boot0 179:32   0    4M  1 disk 
mmcblk0boot1 179:64   0    4M  1 disk 
zram0        254:0    0    0B  0 disk 
</code></pre>
<p>从上述信息可知，分区<code>mmcblk0p6</code>被挂载为根分区，而拥有 22.6G 空间的<code>mmcblk0p8</code>却处于闲置状态，这便是存储空间未被充分利用的症结所在。</p>
<h3 data-id="heading-3">解决过程</h3>
<ol>
<li><strong>初次挂载尝试</strong>：尝试挂载<code>mmcblk0p8</code>分区到<code>/mnt/</code>目录，然而，执行<code>df -h</code>命令查看时，却发现并未显示其实际大小：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mount /dev/mmcblk0p8 /mnt/
<span class="hljs-built_in">df</span> -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   20M  967M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   24K   21G   1% /mnt

<span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   19M  968M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8  4.0M  283K  3.5M   8% /mnt
</code></pre>
<ol>
<li><strong>格式化与重新挂载</strong>：为解决这一问题，需先对<code>/dev/mmcblk0p8</code>进行格式化操作。格式化使用<code>mkfs.ext4</code>命令，此命令将在该分区创建一个 ext4 文件系统：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># mkfs.ext4 /dev/mmcblk0p8</span>
mke2fs 1.46.5 (30 - Dec - 2021)
/dev/mmcblk0p8 contains a ext2 file system labelled <span class="hljs-string">'userdata'</span>
    last mounted on Wed Dec 20 16:54:25 2023
Proceed anyway? (y,N) y
Discarding device blocks: <span class="hljs-keyword">done</span>                            
Creating filesystem with 5926904 4k blocks and 1482752 inodes
Filesystem UUID: af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb
Superblock backups stored on blocks: 
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
    4096000

Allocating group tables: <span class="hljs-keyword">done</span>                            
Writing inode tables: <span class="hljs-keyword">done</span>                            
Creating journal (32768 blocks): <span class="hljs-keyword">done</span>
Writing superblocks and filesystem accounting information: <span class="hljs-keyword">done</span>  
</code></pre>
<p>格式化完成后，卸载之前的挂载点，重新挂载<code>/dev/mmcblk0p8</code>到<code>/mnt/</code>。此时再次执行<code>df -h</code>和<code>lsblk</code>命令查看，分区大小已显示正常：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># umount /mnt/</span>
<span class="hljs-comment"># mount /dev/mmcblk0p8 /mnt/</span>
<span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   20M  967M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   24K   21G   1% /mnt

<span class="hljs-comment"># lsblk </span>
NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
mmcblk0      179:0    0 28.9G  0 disk 
├─mmcblk0p1  179:1    0    4M  0 part 
├─mmcblk0p2  179:2    0    4M  0 part 
├─mmcblk0p3  179:3    0   64M  0 part 
├─mmcblk0p4  179:4    0   64M  0 part 
├─mmcblk0p5  179:5    0   32M  0 part 
├─mmcblk0p6  179:6    0    6G  0 part /
├─mmcblk0p7  179:7    0  128M  0 part 
└─mmcblk0p8  179:8    0 22.6G  0 part /root
mmcblk0boot0 179:32   0    4M  1 disk 
mmcblk0boot1 179:64   0    4M  1 disk 
zram0        254:0    0    0B  0 disk
</code></pre>
<h3 data-id="heading-4">配置永久生效</h3>
<p>为使上述挂载配置在系统重启后依然生效，需对<code>fstab</code>文件进行相应设置。</p>
<ol>
<li><strong>导出 fstab 配置</strong>：通过执行<code>block detect &gt; /etc/config/fstab</code>命令，导出当前系统的<code>fstab</code>配置信息。查看该文件内容如下：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># cat  /etc/config/fstab </span>
config <span class="hljs-string">'global'</span>
    option	anon_swap	<span class="hljs-string">'0'</span>
    option	anon_mount	<span class="hljs-string">'0'</span>
    option	auto_swap	<span class="hljs-string">'1'</span>
    option	auto_mount	<span class="hljs-string">'1'</span>
    option	delay_root	<span class="hljs-string">'5'</span>
    option	check_fs	<span class="hljs-string">'0'</span>

config<span class="hljs-string">'mount'</span>
    option	target	<span class="hljs-string">'/mnt'</span>
    option	uuid	<span class="hljs-string">'af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb'</span>
    option	enabled	<span class="hljs-string">'0'</span>
</code></pre>
<ol>
<li><strong>修改 fstab 配置</strong>：对<code>/etc/config/fstab</code>文件内容进行修改，将挂载目标设为<code>/root</code>，并将<code>enabled</code>选项设为<code>1</code>，使能系统自动挂载<code>mmcblk0p8</code>到<code>/root</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">config<span class="hljs-string">'mount'</span>
    option	target	<span class="hljs-string">'/root'</span>
    option	uuid	<span class="hljs-string">'af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb'</span>
    option	enabled	<span class="hljs-string">'1'</span>
</code></pre>
<ol>
<li><strong>验证配置生效</strong>：重启系统后，再次执行<code>df -h</code>命令查看，确认挂载配置已生效，<code>/dev/mmcblk0p8</code>分区已正确挂载到<code>/root</code>目录，且空间大小显示正常：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  608M  147M  81% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   18M  969M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   57M   21G   1% /root
</code></pre>
<p>通过以上步骤，我们成功地以一种简便的方式找回了 eMMC 存储中 “消失” 的空间，并使其配置在系统重启后持续生效，为系统存储资源的充分利用提供了有效解决方案。希望本文能为遇到类似问题的开发者和技术爱好者带来帮助。</p>
<p><strong>相关标签</strong>：#eMMC 存储 #系统分区 #挂载配置 #Openwrt 系统</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeanSpec：一个轻量级的 SDD 框架]]></title>    <link>https://juejin.cn/post/7577203946063020072</link>    <guid>https://juejin.cn/post/7577203946063020072</guid>    <pubDate>2025-11-27T09:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577203946063020072" data-draft-id="7577049352839315471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeanSpec：一个轻量级的 SDD 框架"/> <meta itemprop="keywords" content="GitHub,架构,开源"/> <meta itemprop="datePublished" content="2025-11-27T09:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MarvinZhang"/> <meta itemprop="url" content="https://juejin.cn/user/2348212566363197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeanSpec：一个轻量级的 SDD 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212566363197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MarvinZhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:39:17.000Z" title="Thu Nov 27 2025 09:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今年年初，我被 Claude Sonnet 3.7 的 AI 编程能力深深震撼。那时 "Vibe Coding" 这个词还没流行起来，但我做的正是这件事——让 AI 生成代码，我只负责引导对话。感觉像魔法一样神奇。直到问题开始浮现。</p>
<p>几周后，我注意到一些规律：代码冗余越来越多，实现方向偏离了最初的设想，AI 在不同会话之间丢失上下文导致返工不断增加。蜜月期结束了。我需要一套结构化的方法，但又不想引入那些拖慢开发速度的重型流程。</p>
<p>这段探索之旅让我先后尝试了 Kiro、Spec Kit、OpenSpec 等工具，最终促使我开发了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec" target="_blank" title="https://github.com/codervisor/lean-spec" ref="nofollow noopener noreferrer">LeanSpec</a>——一个轻量级的规格驱动开发（Spec-Driven Development，SDD）框架。今天发布的 v0.2.7 版本，是三周内的第十个版本。这篇文章分享我为什么要做 LeanSpec、它有什么不同，以及如何快速上手。</p>
<h2 data-id="heading-0">Vibe Coding 的隐性成本</h2>
<p>📝 <strong>Vibe Coding 的陷阱</strong></p>
<blockquote>
<p>AI 编程助手的生产力惊人——直到它们开始出问题。缺乏结构化的上下文，AI 会生成看似合理但前后矛盾的代码，导致技术债务在每个会话中不断累积。</p>
</blockquote>
<p>如果你深度使用过 AI 编程工具，大概率遇到过这些问题：</p>






























<table><thead><tr><th>症状</th><th>根本原因</th><th>影响</th></tr></thead><tbody><tr><td><strong>代码冗余</strong></td><td>AI 不记得之前的实现</td><td>重复逻辑散落在各处</td></tr><tr><td><strong>意图偏移</strong></td><td>上下文在会话间丢失</td><td>功能与你的设想渐行渐远</td></tr><tr><td><strong>返工增多</strong></td><td>缺少持久的单一信息源</td><td>反复解释相同的背景</td></tr><tr><td><strong>架构不一致</strong></td><td>缺乏结构化指导</td><td>组件之间无法顺畅协作</td></tr></tbody></table>
<p>业界的解决方案是 <strong>规格驱动开发（Spec-Driven Development，SDD）</strong>——先写规格文档，再写代码，为 AI（和人类）提供持久的上下文。但当我考察现有工具时，发现了一个空白地带。</p>
<p>ℹ️ <strong>延伸阅读</strong></p>
<blockquote>
<p>刚接触 SDD？可以先阅读我的基础文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fspec-driven-development" target="_blank" title="https://marvinzhang.dev/zh/blog/spec-driven-development" ref="nofollow noopener noreferrer">规格驱动开发：复杂功能的系统化方法</a> 了解方法论基础，或者看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fsdd-tools-practices" target="_blank" title="https://marvinzhang.dev/zh/blog/sdd-tools-practices" ref="nofollow noopener noreferrer">2025 年 SDD 工具全景</a> 了解业界工具的全面对比。想不安装任何工具就体验方法论？试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2Fdocs%2Ftutorials%2Fsdd-without-toolkit" target="_blank" title="https://www.lean-spec.dev/docs/tutorials/sdd-without-toolkit" ref="nofollow noopener noreferrer">不用工具实践 SDD</a> 教程。</p>
</blockquote>
<h2 data-id="heading-1">为什么要做 LeanSpec</h2>
<p>我在 SDD 领域的探索揭示了三类工具，每类都有不适合我的地方：</p>
<p><strong>厂商锁定</strong>：Kiro（亚马逊的 SDD IDE）集成度很高，但要求放弃现有工作流。我喜欢自己的工具组合，换 IDE 不在考虑范围内。</p>
<p><strong>认知负担过重</strong>：Spec Kit 提供了完整的结构，但其繁复的格式带来了很大的认知负担。即使有 AI 辅助撰写，理解和维护这些规格文档仍然耗费大量心智资源，对于独立开发者和小团队来说过于沉重。</p>
<p><strong>缺少项目管理</strong>：OpenSpec 最接近我理想中的样子——轻量且灵活——但缺乏跨项目管理几十个规格的能力。</p>
<p>我想要的是：<strong>一套方法论，而不只是一个工具</strong>。就像敏捷开发一样——一组人人可以采纳的原则，配合不碍事的轻量工具。</p>
<p>于是我做了 LeanSpec。然后用 LeanSpec 来开发 LeanSpec。</p>
<h2 data-id="heading-2">第一性原理：设计基石</h2>
<p>LeanSpec 不只是工具链，它建立在五条第一性原理（First Principles）之上，指导每一个设计决策：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f5be651f69463fa882f85473fbc673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=Zud9LpIYiu3frMHVyfrnyW0sItA%3D" alt="" loading="lazy"/></p>
<p><strong>上下文经济（Context Economy）</strong>：规格必须装进工作记忆——无论人还是 AI。目标 300 行以内。如果 10 分钟读不完，就太长了。</p>
<p><strong>信噪比最大化（Signal-to-Noise）</strong>：每一行都要服务于决策。没有样板文件，没有填充内容，没有为了形式的形式。</p>
<p><strong>意图优先于实现（Intent Over Implementation）</strong>：记录 <em>为什么</em>，而不只是 <em>怎么做</em>。实现细节会变，意图不会。</p>
<p><strong>弥合鸿沟（Bridge the Gap）</strong>：规格同时服务于人和 AI。任何一方看不懂，这份规格就是失败的。</p>
<p><strong>渐进披露（Progressive Disclosure）</strong>：从简单开始，只在感到痛点时才增加结构。不做预设的复杂。</p>
<p>这些原则不只是文档——LeanSpec 的 <code>validate</code> 命令会自动检查规格是否符合它们。</p>
<h2 data-id="heading-3">核心功能</h2>
<h3 data-id="heading-4">Web UI 可视化管理</h3>
<p>我最兴奋的功能：<code>lean-spec ui</code> 启动完整的 Web 界面，让你可视化地管理规格。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 Web UI</span>
npx lean-spec ui
</code></pre>
<p>UI 提供看板视图、规格详情页（支持 Mermaid 图表渲染）和依赖关系可视化——全在浏览器里完成。适合规划会议或审查项目状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56971740b714a3984dca3debb4ecabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=w0yLhPWCaDlyyy85Zc7tcIFpGao%3D" alt="LeanSpec 看板视图" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea45798bdc5e4ddeaa572f14f1ef9a2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=HfxMM9x%2BoCc5W3wLKA0KAuvpkFc%3D" alt="LeanSpec 规格详情页" loading="lazy"/></p>
<h3 data-id="heading-5">第一性原理校验</h3>
<p>LeanSpec 不只存储规格，还会对照第一性原理进行校验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 校验规格是否符合第一性原理</span>
lean-spec validate

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># specs/045-user-auth/README.md</span>
<span class="hljs-comment">#   ⚠️  warning  Spec exceeds 300 lines (342)  context-economy</span>
<span class="hljs-comment">#   ⚠️  warning  Missing overview section      structure</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># ✖ 2 warnings in 1 spec</span>
</code></pre>
<p>这能保持规格精简有意义，防止重型 SDD 工具常见的规格膨胀问题。</p>
<h3 data-id="heading-6">智能搜索与项目管理</h3>
<p>查找相关规格不应该需要记住精确名称：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 跨所有规格的语义搜索</span>
lean-spec search <span class="hljs-string">"authentication flow"</span>

<span class="hljs-comment"># 高级查询</span>
lean-spec search <span class="hljs-string">"status:in-progress tag:api"</span>
lean-spec search <span class="hljs-string">"created:&gt;2025-11-01"</span>
</code></pre>
<p>看板视图让项目状态一目了然：</p>
<pre><code class="hljs language-bash" lang="bash">lean-spec board

<span class="hljs-comment"># 📋 LeanSpec Board</span>
<span class="hljs-comment"># ─────────────────────────────────────</span>
<span class="hljs-comment"># 📅 Planned (12)     🚧 In Progress (3)     ✅ Complete (47)</span>
<span class="hljs-comment"># ─────────────────────────────────────</span>
</code></pre>
<h3 data-id="heading-7">MCP Server：AI 集成</h3>
<p>LeanSpec 内置 MCP（Model Context Protocol）服务器，让 AI 助手可以直接与你的规格交互：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"leanspec"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@leanspec/mcp"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>支持 Claude Code、Cursor、GitHub Copilot 等 MCP 兼容工具。AI 代理可以搜索规格、读取上下文、更新状态——全部通过编程接口完成。</p>
<h3 data-id="heading-8">示例项目快速上手</h3>
<p>刚接触 SDD？从一个完整的示例开始：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成一个完整的教程项目</span>
npx lean-spec init --example dark-theme
</code></pre>
<p>提供三个示例：<code>dark-theme</code>、<code>dashboard-widgets</code> 和 <code>api-refactor</code>——分别演示不同的 SDD 模式。</p>
<h2 data-id="heading-9">开发历程：用 LeanSpec 开发 LeanSpec</h2>
<p>这个项目最有意思的地方在于：初版发布后，<strong>LeanSpec 完全使用 LeanSpec 自身来开发</strong>。</p>






























<table><thead><tr><th>里程碑</th><th>日期</th><th>说明</th></tr></thead><tbody><tr><td>第一行代码</td><td>2025 年 10 月 23 日</td><td>从基础的规格增删改查开始</td></tr><tr><td>v0.1.0（首次发布）</td><td>2025 年 11 月 2 日</td><td>从零到发布仅用 10 天</td></tr><tr><td>v0.2.0（生产就绪）</td><td>2025 年 11 月 10 日</td><td>第一性原理校验，完整 CLI</td></tr><tr><td>v0.2.7（当前版本）</td><td>2025 年 11 月 26 日</td><td>24 天内发布 10 个版本</td></tr></tbody></table>
<p>在 LeanSpec 项目内部，已经创建了超过 120 个规格——涵盖功能实现、架构决策、复盘反思，甚至营销策略。反馈循环非常紧凑：发现痛点 → 写规格 → 实现 → 用真实场景验证。</p>
<p>我还把 LeanSpec 应用到了其他项目：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrawlab-team%2Fcrawlab" target="_blank" title="https://github.com/crawlab-team/crawlab" ref="nofollow noopener noreferrer">Crawlab</a>（12k+ stars）—— 网络爬虫管理平台</li>
<li>这个博客（marvinzhang.dev）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor" target="_blank" title="https://github.com/codervisor" ref="nofollow noopener noreferrer">codervisor</a> 组织下即将发布的新项目</li>
</ul>
<p>在所有项目中，规律都是一致的：规格提供了跨会话存续的上下文，AI 能持续对齐我的意图，我花在反复解释上的时间大幅减少。</p>
<h2 data-id="heading-10">LeanSpec 的独特之处</h2>
<p>如果你读过我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fsdd-tools-practices" target="_blank" title="https://marvinzhang.dev/zh/blog/sdd-tools-practices" ref="nofollow noopener noreferrer">SDD 工具分析</a>，就知道我评估过这个领域的六个主要工具。LeanSpec 的定位是这样的：</p>








































<table><thead><tr><th>维度</th><th>重型工具</th><th>LeanSpec</th></tr></thead><tbody><tr><td><strong>学习曲线</strong></td><td>数天到数周</td><td>几分钟</td></tr><tr><td><strong>规格开销</strong></td><td>大量前期工作</td><td>边写边补</td></tr><tr><td><strong>Token 成本</strong></td><td>通常 &gt;2,000</td><td>目标 &lt;300 行</td></tr><tr><td><strong>灵活性</strong></td><td>结构刚性</td><td>适应你的工作流</td></tr><tr><td><strong>厂商锁定</strong></td><td>常见</td><td>不存在</td></tr><tr><td><strong>理念</strong></td><td>工具优先</td><td>方法论优先</td></tr></tbody></table>
<p>LeanSpec 的 "Lean" 有多重含义：</p>
<ul>
<li><strong>方法论</strong>：像敏捷一样，是无论工具如何都能采纳的原则</li>
<li><strong>认知负担</strong>：低开销，快速上手</li>
<li><strong>Token 经济</strong>：规格保持精简，能装进 AI 的上下文窗口</li>
<li><strong>灵活性</strong>：适应你的工作流，而不是反过来</li>
</ul>
<h2 data-id="heading-11">快速上手</h2>
<p>5 分钟内试用 LeanSpec：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装</span>
npm install -g lean-spec

<span class="hljs-comment"># 在项目中初始化</span>
lean-spec init

<span class="hljs-comment"># 创建第一个规格</span>
lean-spec create user-authentication

<span class="hljs-comment"># 启动 Web UI</span>
lean-spec ui
</code></pre>
<p>或者试试示例项目：</p>
<pre><code class="hljs language-bash" lang="bash">npx lean-spec init --example dark-theme
</code></pre>
<p><strong>已经在用 Spec Kit 或 OpenSpec？</strong> 参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2Fdocs%2Fguide%2Fmigration" target="_blank" title="https://www.lean-spec.dev/docs/guide/migration" ref="nofollow noopener noreferrer">迁移指南</a>——迁移过程很顺畅。</p>
<h2 data-id="heading-12">未来规划</h2>
<p>LeanSpec 仍在活跃迭代中。当前开发重点包括：</p>
<ul>
<li>VS Code 插件，实现内联规格管理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F17" target="_blank" title="https://web.lean-spec.dev/specs/17" ref="nofollow noopener noreferrer">规格 17</a>）</li>
<li>AI 聊天界面，实现交互式规格辅助（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F94" target="_blank" title="https://web.lean-spec.dev/specs/94" ref="nofollow noopener noreferrer">规格 94</a>）</li>
<li>全面的国际化支持（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F91" target="_blank" title="https://web.lean-spec.dev/specs/91" ref="nofollow noopener noreferrer">规格 91</a>）</li>
<li>GitHub 多项目集成（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F98" target="_blank" title="https://web.lean-spec.dev/specs/98" ref="nofollow noopener noreferrer">规格 98</a>）</li>
</ul>
<p>我做 LeanSpec 是为了解决自己的问题——Vibe Coding 带来的代码质量下降、AI 会话间的上下文丢失、重型 SDD 工具的认知负担。如果你也面临类似的挑战，希望它对你同样有帮助。</p>
<hr/>
<p><strong>链接：</strong></p>
<ul>
<li>📦 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec" target="_blank" title="https://github.com/codervisor/lean-spec" ref="nofollow noopener noreferrer">GitHub</a></li>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2F" target="_blank" title="https://www.lean-spec.dev/" ref="nofollow noopener noreferrer">文档</a></li>
<li>📊 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Flean-spec" target="_blank" title="https://www.npmjs.com/package/lean-spec" ref="nofollow noopener noreferrer">npm 包</a></li>
</ul>
<p>有问题、反馈或功能建议？欢迎提 issue 或发起 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec%2Fdiscussions" target="_blank" title="https://github.com/codervisor/lean-spec/discussions" ref="nofollow noopener noreferrer">讨论</a>。每一条我都会看。</p>
<hr/>
<p>📝 <strong>本文同步发布于我的个人技术博客</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fintroducing-leanspec" target="_blank" title="https://marvinzhang.dev/zh/blog/introducing-leanspec" ref="nofollow noopener noreferrer">marvinzhang.dev</a></p>
<p>🔗 <strong>完整文章链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fintroducing-leanspec" target="_blank" title="https://marvinzhang.dev/zh/blog/introducing-leanspec" ref="nofollow noopener noreferrer">marvinzhang.dev/zh/blog/int…</a></p>
<p>💬 <strong>欢迎访问我的博客了解更多技术文章！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践]]></title>    <link>https://juejin.cn/post/7577204540417474623</link>    <guid>https://juejin.cn/post/7577204540417474623</guid>    <pubDate>2025-11-27T09:40:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417474623" data-draft-id="7577042851080994859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:40:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:40:49.000Z" title="Thu Nov 27 2025 09:40:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在许多公司内部，iOS 上架常被误认为是“必须依赖 Mac 才能进行的任务”。
但随着跨端项目增多，甚至有团队完全以 Windows 为主力开发环境，“没有 Mac 可以上架吗？”成为实际工程中反复被提及的问题。
答案是肯定的：<strong>在合规和工程链路允许的前提下，iOS 上架流程完全可以在 Windows 环境中顺利完成。</strong></p>
<p>本文从实践角度复盘一个典型的 Windows 环境上架方案，重点关注：构建、签名、上传、协作、审核等环节如何在无 Mac 条件下保持稳定性和可控性。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、为什么许多团队选择在 Windows 环境完成上架？</strong></h2>
<p>Windows 在企业中的普及率极高，无论是前端团队、跨端团队、后端团队还是游戏团队，开发机大量使用 Windows 是事实。</p>
<p>在以下场景中，“Windows 上架”需求尤其突出：</p>
<ul>
<li>前端主导的 App（Hybrid、uni-app、H5）</li>
<li>小团队无预算购买 Mac</li>
<li>游戏团队使用 Unity / Cocos，编辑器本地是 Windows</li>
<li>企业 CI/CD 在 Linux / Windows 服务器运行</li>
<li>海外团队分布式协作，Mac 数量有限</li>
</ul>
<p>因此，一个可在 Windows 自然运行的上架方案，能显著降低成本并提升工程协作效率。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、在 Windows 环境上架的关键挑战</strong></h2>
<p>没有 Mac 的关键难点并非编码，而是：</p>
<ol>
<li><strong>证书生成不依赖钥匙串助手</strong></li>
<li><strong>构建无需本地 Xcode</strong></li>
<li><strong>上传 IPA 不依赖 Transporter/Xcode Organizer</strong></li>
<li><strong>团队协作与分发流程需可重复执行</strong></li>
</ol>
<p>解决以上关键点，Windows 上架自然成立。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、Windows 环境的证书与签名管理：跨平台工具链成为基础</strong></h2>
<p>传统方式：</p>
<ul>
<li>使用 Mac 的钥匙串助手生成 CSR</li>
<li>在 Apple Developer 中下载证书</li>
<li>生成 p12</li>
</ul>
<p>问题在于 Windows 无法直接处理钥匙串与 Mac 私钥格式。</p>
<p>现代解决方式依赖开心上架（Appuploader）跨平台命令行工具，可在 Windows 直接生成 iOS 证书：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04bd5df26aed4b0ea353205414290b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841249&amp;x-signature=ikPHx6ZLjdVbQwQDzpA%2FbdPIuW0%3D" alt="证书生成" loading="lazy"/></p>
<p>优点：</p>
<ul>
<li>Windows / Linux / macOS 都能生成证书</li>
<li>团队协作不需要反复导出</li>
<li>多设备共享证书不再受限</li>
</ul>
<p>这是整个 Windows 上架体系的“第一块基石”。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、构建 IPA：不同项目类型的 Windows 解决方案</strong></h2>
<p>构建方式取决于 App 技术栈。</p>
<hr/>
<h3 data-id="heading-4"><strong>1. Web / Hybrid / uni-app 项目</strong></h3>
<p>最友好的类型。</p>
<p>因为：</p>
<ul>
<li>不需要本地 iOS 原生代码编译</li>
<li>不需要 Xcode</li>
<li>云端直接生成 ipa</li>
</ul>
<p>常见方式：</p>
<ul>
<li>HBuilderX 云打包</li>
<li>Web 项目 → 云端编译 → 得到 ipa</li>
</ul>
<p>整个过程可以完全在 Windows 执行。</p>
<hr/>
<h3 data-id="heading-5"><strong>2. Flutter / React Native 项目</strong></h3>
<p>构建仍需要 iOS 编译链，因此在 Windows 环境通常采用：</p>
<ul>
<li>GitHub Actions（macOS runner）</li>
<li>Codemagic / Appcircle</li>
<li>团队共享的云构建节点</li>
</ul>
<p>构建步骤自动化，最终从流水线下载 ipa，即可转入 Windows 端继续处理上传。</p>
<hr/>
<h3 data-id="heading-6"><strong>3. Unity / Cocos 游戏项目</strong></h3>
<p>游戏资源构建在 Windows 完成：</p>
<ul>
<li>在 Windows 生成 Xcode 工程</li>
<li>上传到云端构建（CI/CD）</li>
<li>得到 ipa</li>
</ul>
<p>这种方式在游戏团队中最常见。</p>
<hr/>
<h2 data-id="heading-7"><strong>五、Windows 环境的上传环节：真正实现跨平台的关键</strong></h2>
<p>在 Windows 上，最大突破点是 ipa 上传环节。
传统工具（Transporter、Xcode Organizer）都需要 macOS。</p>
<p>现在的工程实践是使用开心上架（Appuploader）跨平台命令行上传：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli \
  -u ios@team.com \
  -p xxx-xxx-xxx-xxx \
  -c 2 \
  -f ./build/release.ipa
</code></pre>
<p>特点：</p>
<ul>
<li>完整支持 Windows 命令行</li>
<li>无需 Xcode</li>
<li>新旧上传通道可选</li>
<li>适用于 TF 测试与正式发布</li>
<li>支持自动化集成发展到 CI/CD</li>
</ul>
<p>这意味着团队不必再为“上传”特意配置独立 Mac 环境。</p>
<p>图形化界面：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/881bd76652134b61803ca8348f3bcab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841249&amp;x-signature=HNvp5cfZIf%2BvRfA4S%2FO%2FisgGJtM%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8"><strong>六、上架提交：Windows 环境与 App Store Connect 的协作方式</strong></h2>
<p>上传构建后，剩余任务主要在网页端 App Store Connect 执行：</p>
<ul>
<li>配置截图（可在 Windows 制作）</li>
<li>填写描述、关键词</li>
<li>设置权限与隐私标签</li>
<li>上传预览视频（可选）</li>
<li>审核说明</li>
<li>添加测试账号（如需要）</li>
</ul>
<p>这些操作全部通过浏览器完成，不依赖系统平台。</p>
<hr/>
<h2 data-id="heading-9"><strong>七、审核阶段：与系统无关，但与流程质量强相关</strong></h2>
<p>审核本身不依赖操作系统。
真正影响审核的并不是“你用 Mac 还是 Windows”，而是：</p>
<ul>
<li>功能稳定</li>
<li>首屏加载速度</li>
<li>登录流程是否可复现</li>
<li>权限说明是否清晰</li>
<li>隐私标签是否一致</li>
<li>服务器是否能访问</li>
<li>截图是否真实</li>
<li>提交是否包含足够说明</li>
</ul>
<p>以下拒审最常见：</p>
<ul>
<li>2.1：功能不可用</li>
<li>4.2：内容不足 / 壳应用</li>
<li>5.1.1：隐私权限未说明</li>
<li>4.3：重复 App</li>
<li>3.1：支付违规</li>
</ul>
<p>这些问题与操作系统无关，与 App 质量和提交内容有关。</p>
<hr/>
<h2 data-id="heading-10"><strong>八、Windows 上架方案的优势：不是权宜，而是趋势</strong></h2>
<p>经过多项目实践，Windows 上架方案体现出几个明显优势：</p>
<hr/>
<h3 data-id="heading-11"><strong>1. 团队不再被“必须有 Mac”限制</strong></h3>
<p>前端团队、测试团队、运营团队不需要 Mac，即可独立完成上架流程。</p>
<hr/>
<h3 data-id="heading-12"><strong>2. 更适合跨国团队与多人协作</strong></h3>
<p>Windows 环境普及率高，多人可并行处理：</p>
<ul>
<li>构建触发</li>
<li>上传</li>
<li>文案准备</li>
<li>截图整理</li>
<li>审核沟通</li>
</ul>
<p>减少对“唯一一台 Mac”的依赖。</p>
<hr/>
<h3 data-id="heading-13"><strong>3. 更适合 CI/CD 自动化</strong></h3>
<p>服务器多数是 Linux 或 Windows：</p>
<ul>
<li>云构建生成 ipa</li>
<li>Windows / Linux CLI 上传</li>
<li>自动触发 TF 测试</li>
<li>自动通知团队</li>
</ul>
<p>上架流程可以高度自动化。</p>
<hr/>
<h3 data-id="heading-14"><strong>4. 成本更低，风险更低</strong></h3>
<p>不需要维护额外硬件、不需要手工上传，也无需担心 Mac 系统升级带来的兼容问题。</p>
<hr/>
<h2 data-id="heading-15"><strong>在 Windows 上进行 iOS 上架，不仅可行，而且成熟</strong></h2>
<p>通过以下组合：</p>
<ul>
<li><strong>跨系统证书管理</strong></li>
<li><strong>云构建生成 ipa</strong></li>
<li><strong>Windows/Linux 上传 ipa</strong></li>
<li><strong>浏览器完成 App Store Connect 操作</strong></li>
</ul>
<p>一个完整的 iOS 上架流程即可在 Windows 环境顺利展开。</p>
<p>这不是权宜之计，而是一种适合现代多端团队的可持续上架体系。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.applicationloader.net%2Ftutorial%2Fzh%2F83%2F83.html" target="_blank" title="https://www.applicationloader.net/tutorial/zh/83/83.html" ref="nofollow noopener noreferrer">www.applicationloader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南]]></title>    <link>https://juejin.cn/post/7577220965437358134</link>    <guid>https://juejin.cn/post/7577220965437358134</guid>    <pubDate>2025-11-27T09:43:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965437358134" data-draft-id="7577204540417540159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:43:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:43:51.000Z" title="Thu Nov 27 2025 09:43:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，无论是前端调试、移动端开发，还是接口联调与性能优化，“抓包”几乎是每位开发者绕不开的关键技能。
而在所有抓包工具中，<strong>Fiddler抓包工具</strong> 以其强大的功能和灵活的配置能力，成为业内最受欢迎的网络调试利器之一。</p>
<p>本文将以实战角度，详细介绍 <strong>Fiddler使用教程、代理配置、HTTPS抓包技巧、请求调试与常见问题分析</strong>，帮助你从入门到精通，真正掌握这款强大的网络调试工具。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具概览</strong></h2>
<p><strong>Fiddler</strong> 是 Telerik 公司推出的一款 HTTP/HTTPS 抓包和网络调试工具。
它通过充当系统代理服务器的方式，捕获设备发出的网络请求与响应，从而帮助开发者直观查看、修改和分析网络通信数据。</p>
<p>相较于其他工具（如 Charles、Postman、Wireshark），Fiddler 的优势体现在：</p>
<ul>
<li>免费、稳定、功能全面；</li>
<li>支持多端抓包（Web、App、小程序）；</li>
<li>可实现断点调试、请求修改、Mock 接口；</li>
<li>支持 HTTPS 解密与性能分析；</li>
<li>可自定义规则与脚本扩展。</li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p>Fiddler 不只是“抓包工具”，更是一款“网络分析与接口调试平台”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与配置</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>Fiddler 的安装包体积小，安装过程简单。
安装完成后，启动软件即可自动接管系统代理。</p>
<ul>
<li>左下角显示 “Capturing” 表示正在抓包；</li>
<li>若显示 “Paused”，点击即可恢复。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理设置（电脑与移动端）</strong></h3>
<p>默认情况下，Fiddler 仅捕获本机请求。
若需抓取手机或其他设备的请求，则需开启远程代理。</p>
<p><strong>配置步骤如下：</strong></p>
<ol>
<li>打开菜单栏 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>记录电脑 IP 地址和端口号（默认 8888）；</li>
<li>确保手机与电脑在同一 Wi-Fi 网络；</li>
<li>在手机 Wi-Fi 设置中添加代理：
<ul>
<li>主机名：电脑 IP</li>
<li>端口号：8888</li>
</ul>
</li>
</ol>
<p>此时，Fiddler 即可捕获移动端的 HTTP 流量。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包配置</strong></h3>
<p>随着 HTTPS 普及，Fiddler 需要通过证书解密方式查看加密流量。</p>
<p><strong>配置方法如下：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任 Fiddler 根证书；</li>
<li>若抓取移动端 HTTPS 请求，还需导出证书并在手机信任。</li>
</ul>
<p>完成配置后，你将能查看 HTTPS 请求的完整内容，包括参数与响应。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler核心功能与使用技巧</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>Fiddler 会记录系统中的所有请求，每条请求都包含：</p>
<ul>
<li>请求方式（GET、POST、PUT、DELETE）；</li>
<li>请求路径与参数；</li>
<li>请求头、Cookie 与请求体；</li>
<li>响应状态码、响应体与时间消耗。</li>
</ul>
<p>某次调试接口时，响应返回空 JSON。
通过 Fiddler 发现请求头中 <code>Content-Type</code> 缺失，导致后端未正确解析请求体。</p>
<p>短短几秒即可定位错误源。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 断点调试（Breakpoints）</strong></h3>
<p>Fiddler 可在请求发出前或响应返回前拦截数据，允许开发者修改请求或响应内容。</p>
<p><strong>应用场景：</strong></p>
<ul>
<li>模拟接口返回错误（如 500/403）；</li>
<li>修改参数测试接口容错；</li>
<li>延迟响应验证前端加载逻辑。</li>
</ul>
<p>输入命令 <code>bpu yourapi.com</code> 可对指定接口启用断点。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 模拟接口响应（AutoResponder）</strong></h3>
<p>Fiddler 的 AutoResponder 模块可用于 Mock 接口数据。</p>
<p><strong>使用步骤：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>点击 “Add Rule” 添加匹配规则；</li>
<li>指定本地 JSON 文件或自定义返回内容；</li>
<li>启用规则后，请求将自动返回模拟响应。</li>
</ol>
<p>前端可模拟 <code>{ "code":200,"msg":"success" }</code>，无需后端即可完成调试。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块支持自定义构造与重发请求。</p>
<p><strong>常见用途：</strong></p>
<ul>
<li>验证接口签名；</li>
<li>测试参数变化；</li>
<li>复现线上 Bug。</li>
</ul>
<p>右键历史请求 → “Replay → Reissue Request” 可快速重放。</p>
<hr/>
<h3 data-id="heading-10"><strong>5. 性能分析（Timeline）</strong></h3>
<p>Timeline 模块展示请求生命周期（DNS → TCP → TLS → Server → Download）。</p>
<p>通过时序图可分析：</p>
<ul>
<li>哪个阶段耗时最长；</li>
<li>请求延迟是否来自网络或服务器；</li>
<li>页面加载是否被资源阻塞。</li>
</ul>
<hr/>
<h2 data-id="heading-11"><strong>四、Fiddler实战案例：定位接口延迟问题</strong></h2>
<p>一次移动端接口请求经常超时。
通过 Fiddler 的 Timeline 发现 请求阶段中 <strong>TLS 握手耗时 1.2 秒</strong>，明显高于正常范围。</p>
<p>进一步排查发现，测试环境的 HTTPS 证书配置错误，导致多次握手重试。
修复证书后，接口耗时从 3.8 秒降至 1.1 秒。</p>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler功能模块汇总</strong></h2>



































<table><thead><tr><th>模块</th><th>功能说明</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按条件过滤请求</td><td>聚焦目标接口调试</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口返回</td><td>前后端分离开发</td></tr><tr><td><strong>Breakpoints</strong></td><td>拦截并修改请求</td><td>测试异常与安全验证</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>接口测试与复现</td></tr><tr><td><strong>Timeline</strong></td><td>分析性能瓶颈</td><td>请求优化与性能评估</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler与其他工具对比</strong></h2>






























<table><thead><tr><th>工具</th><th>特点</th><th>适用人群</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、功能全、支持请求修改</td><td>开发 / 测试人员</td></tr><tr><td><strong>Charles</strong></td><td>界面简洁、易上手</td><td>新手用户</td></tr><tr><td><strong>Postman</strong></td><td>请求构造灵活</td><td>API 测试人员</td></tr><tr><td><strong>Wireshark</strong></td><td>底层网络分析强</td><td>安全研究者</td></tr></tbody></table>
<p>Fiddler 是开发调试阶段最实用的 HTTP/HTTPS 抓包工具之一，兼顾可视化、易用性与灵活性。</p>
<hr/>
<h2 data-id="heading-14"><strong>七、学习与资源推荐</strong></h2>
<p>想更掌握 <strong>Fiddler使用教程</strong>、<strong>代理设置</strong> 与 <strong>HTTPS 调试技巧</strong>？推荐访问 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a></strong></p>
<p>你将找到：</p>
<ul>
<li>Fiddler 安装与配置教程；</li>
<li>HTTPS 抓包与证书安装指南；</li>
<li>移动端代理设置；</li>
<li>Mock 数据与性能调试实例；</li>
<li>常见错误与实战解决方案。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果App上架全流程指南：从注册到审核通过，一文读懂]]></title>    <link>https://juejin.cn/post/7577220965437390902</link>    <guid>https://juejin.cn/post/7577220965437390902</guid>    <pubDate>2025-11-27T09:46:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965437390902" data-draft-id="7577198193215307819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果App上架全流程指南：从注册到审核通过，一文读懂"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:46:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果App上架全流程指南：从注册到审核通过，一文读懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:46:23.000Z" title="Thu Nov 27 2025 09:46:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果 App 上架全流程指南：从注册到审核通过，一文读懂</p>
<p>在移动应用市场中，苹果 App Store 凭借庞大的用户基数与高付费意愿，成为开发者必争之地。但 App 上架绝非易事，从注册账号、准备资料，到提交审核、应对反馈，每一环节都暗藏挑战，稍有差池就可能被拒，耗费大量时间精力。今天，我们就梳理苹果 App 上架全流程，帮开发者顺利闯关，让优质 App 快速触达用户。</p>
<p><strong>一、前期准备：注册账号与获取资质</strong></p>
<p>（一）选择开发者账号类型</p>
<p>苹果提供个人、公司、企业三类开发者账号，功能与适用场景各异：</p>
<p>个人开发者账号：年费 99 美元，适合独立开发者。权限覆盖 App Store 上架、开发测试，无团队协作功能，应用归属个人。</p>
<p>公司开发者账号：同样年费 99 美元，适用于企业团队。需提交公司资质证明（营业执照等），支持多人协作开发，应用归属公司，利于品牌建设与市场推广。</p>
<p>企业开发者账号：年费 299 美元，主要用于企业内部应用分发，无法上架 App Store。适合大型企业定制内部办公 App，保障数据安全与应用隐私。</p>
<p>（二）注册开发者账号</p>
<p>访问苹果开发者官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2F%25EF%25BC%2589%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB" target="_blank" title="https://developer.apple.com/%EF%BC%89%EF%BC%8C%E7%82%B9%E5%87%BB" ref="nofollow noopener noreferrer">developer.apple.com/），点击</a> “Join the Apple Developer Program”，按提示填写个人 / 公司信息，完成注册流程。</p>
<p>若申请公司账号，需申请邓白氏码（D-U-N-S Number），这是全球通用的企业身份识别编码。申请耗时 1 - 2 周，获批后苹果会邮件通知，建议 14 个工作日后再使用，以便苹果同步数据。</p>
<p>（三）准备相关资质文件</p>
<p>隐私政策：自 2018 年 10 月起，所有新 App 及更新版本均需提供隐私政策链接，详细说明如何收集、使用、存储用户数据，保障用户知情权与隐私权。</p>
<p>版权证明：若 App 使用第三方素材（图片、音乐、代码等），需获取合法授权，备好版权文件，避免侵权纠纷导致上架受阻。</p>
<p><strong>二、技术筹备：创建 App ID、证书与描述文件</strong></p>
<p>（一）创建 App ID</p>
<p>登录开发者账号，进入 “Certificates, Identifiers &amp; Profiles” 页面。</p>
<p>点击 “Identifiers” - “App IDs”，选择 “+” 创建新 App ID。格式为 “com.company.appname”，其中 “company” 为公司缩写或自定义标识，“appname” 是 App 名称，此 ID 是 App 唯一标识，后续证书申请、应用配置都需用到。</p>
<p>（二）申请证书</p>
<p>打开 Mac 的钥匙串访问工具，依次选择 “钥匙串访问” - “证书助理” - “从证书颁发机构请求证书”，按提示填写信息，生成证书签名请求文件（.certSigningRequest）。</p>
<p>返回开发者账号 “Certificates” 页面，点击 “+”，按证书类型（开发证书用于真机调试、发布证书用于 App Store 上架、推送证书用于推送通知）上传上述文件，生成并下载对应证书。开发证书可在多台设备调试，发布证书则关联 App Store 发布。</p>
<p>（三）生成描述文件</p>
<p>描述文件关联证书与 App ID，在开发者账号 “Profiles” 页面，点击 “+” 创建。</p>
<p>按提示选择 App ID、证书，配置设备列表（开发描述文件需指定调试设备），生成并下载描述文件。</p>
<p><strong>三、App 信息配置：iTunes Connect 设置</strong></p>
<p>（一）基础信息填写</p>
<p>登录 iTunes Connect，点击 “我的 App” - “+” 创建新 App，填写 App 名称、主要语言、Bundle ID（与创建 App ID 时一致）等基础信息。</p>
<p>主标题：显示在 App Store 的本地化名称，简洁展现 App 功能特性，选取高热度相关词汇，避免竞品品牌词，利于搜索排名。</p>
<p>副标题：对 App 的简要介绍，补充主标题，控制在 30 字符内，同样避免竞品词，增强吸引力。</p>
<p>（二）隐私政策与详细描述</p>
<p>在 “App 信息” 页面，填入隐私政策网址，确保政策内容清晰、合法合规。</p>
<p>应用描述限定在 4000 字符内，详细介绍 App 特色功能。建议开篇前三行突出核心优势，吸引用户，且描述仅在版本更新时可修改。</p>
<p>（三）关键词与应用分级</p>
<p>关键词：在 “关键词” 栏填写 100 字符，尽量写满，少用逗号分隔，提升关键词覆盖度，影响 App 搜索曝光与基础排名。</p>
<p>应用分级：回答 13 个问题，依 App 实际内容与功能，确定分级（4 岁以上、9 岁以上、12 岁以上、17 岁以上、无分级），无分级无法上架销售。</p>
<p>（四）屏幕截图与图标上传</p>
<p>准备各版本屏幕截图，展示 App 核心功能与界面设计，适配不同设备尺寸。</p>
<p>上传 1024*1024 像素的图标，图标设计简洁、醒目，不得有圆角，符合苹果设计规范。若 App 支持预定，可设置相关信息，提前吸引用户关注。</p>
<p><strong>四、打包上传：Xcode 配置与提交</strong></p>
<p>（一）Xcode 项目配置</p>
<p>打开 Xcode，确保已正确导入申请的证书与描述文件。在项目设置中，选择 iOS device 真机（非模拟器）作为运行目标。</p>
<p>若 App 不支持横屏，在 “General” 选项取消 “Landscape Left” 与 “Landscape Right” 勾选；检查版本号与构建版本号，配置发布证书。确保项目无黄色叹号（代表证书、描述文件或 Bundle Identifier 匹配异常），切换至 release 发布模式（debug 用于测试）。</p>
<p>（二）打包与上传</p>
<p>选择 “Xcode” - “Product” - “Archive” 打包项目。完成后，可选择直接上传至 App Store，或导出 ipa 文件（务必选择 “Save for iOS App Store Deployment”）。</p>
<p>若导出 ipa，借助 Application Loader 工具上传。登录后，按提示选择 ipa 文件，上传至 iTunes Connect。</p>
<p>对于没有 Mac 电脑的开发者，可以使用 AppUploader 工具在 Windows、Linux 或 Mac 系统上直接上传 IPA 文件到 App Store，支持证书申请和管理，简化上架流程。</p>
<p><strong>五、提交审核：App Store Connect 操作</strong></p>
<p>（一）创建新 App 版本</p>
<p>在 App Store Connect “我的 App” 页面，选择对应 App，点击 “+” 创建新版本，填写版本号、构建版本号等信息。</p>
<p>（二）选择构建版本</p>
<p>执行 archive 操作后，生成的 ipa 会显示在构建版本列表。选择已上传的构建版本关联至新版本。</p>
<p>（三）提交审核</p>
<p>仔细核对 App 各项信息，确保准确无误。若 App 需登录使用，在后台提供测试账号（账号权限、数据完备，方便审核人员测试）。确认无误后，提交审核。</p>
<p><strong>六、审核应对：等待结果与处理反馈</strong></p>
<p>（一）审核时间预估</p>
<p>苹果审核通常需 1 - 3 个工作日，复杂应用、敏感内容或提交高峰期，审核时长可能延长至 7 个工作日甚至更久。开发者可在 App Store Connect 查看审核进度。</p>
<p>（二）常见审核不通过原因及解决</p>
<p>功能问题：如 App 崩溃、卡顿、关键功能无法使用，需全面测试修复，提交新版本审核。</p>
<p>隐私合规：未按规定获取用户权限、收集使用数据，或隐私政策不完善，需调整隐私策略，优化数据处理流程。</p>
<p>界面设计：界面布局混乱、不遵循苹果设计规范（如按钮样式、交互逻辑），重新设计界面，提升用户体验。</p>
<p>内容侵权：使用未经授权素材、存在抄袭内容，立即替换侵权素材，确保内容原创合法。</p>
<p>描述不符：App 描述、截图与实际功能不符，修改描述与截图，真实反映 App 特性。</p>
<p>每个开发者账号有两次加急审核机会，若遇紧急情况（如修复重大安全漏洞），可申请加急，加快审核进程。</p>
<p><strong>结语</strong></p>
<p>苹果 App 上架是一场精心筹备的 “闯关之旅”，从账号注册的细致规划，到技术配置的严谨操作，再到审核反馈的灵活应对，每一环节都考验开发者的耐心与专业度。但只要严格遵循苹果审核指南，打磨产品质量，精心准备上架资料，就能提升上架成功率，让 App 在 App Store 的舞台上大放异彩，收获海量用户与商业价值。若你正筹备 App 上架，不妨参考这份指南，提前布局、稳步推进，助力产品顺利上线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「半空」富脚手架模式：字节 Go2Rust 工程落地]]></title>    <link>https://juejin.cn/post/7577204540417556543</link>    <guid>https://juejin.cn/post/7577204540417556543</guid>    <pubDate>2025-11-27T09:52:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417556543" data-draft-id="7577198193215291435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「半空」富脚手架模式：字节 Go2Rust 工程落地"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-27T09:52:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CloudWeGo"/> <meta itemprop="url" content="https://juejin.cn/user/3998273922407624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「半空」富脚手架模式：字节 Go2Rust 工程落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3998273922407624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CloudWeGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:52:05.000Z" title="Thu Nov 27 2025 09:52:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在云原生与高性能服务的发展趋势下，Go 项目迁移到 Rust 项目成为提升性能和稳定性的最重要优化方向，但依赖复杂、有语言门槛等问题长期制约着 Go2Rust 的大规模落地。字节跳动服务框架团队基于内部大量迁移实践，融合大模型能力与工程经验，推出「半空」富脚手架模式，将迁移从“人工主导”转变为“标准化流程”，为需要进行 Go2Rust 迁移的团队提供了一套可落地的技术参考。</p>
<p>本文基于字节跳动服务框架团队研发工程师范广宇在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg2MTc0Mjg2Mw%3D%3D%26mid%3D2247495370%26idx%3D1%26sn%3Dbf5a7b5e536b82a7c56bbec367d47200%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg2MTc0Mjg2Mw==&amp;mid=2247495370&amp;idx=1&amp;sn=bf5a7b5e536b82a7c56bbec367d47200&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">CloudWeGo 四周年技术沙龙</a>上的演讲内容整理，详细拆解了「半空」富脚手架模式的设计逻辑、实施步骤与实践成效。</p>
<p>点击链接可查看本次分享回放👉🏻<a href="https://link.juejin.cn?target=https%3A%2F%2Fb23.tv%2Fv7rRu7D" target="_blank" title="https://b23.tv/v7rRu7D" ref="nofollow noopener noreferrer">b23.tv/v7rRu7D</a></p>
<h2 data-id="heading-0">一、从 Go 到 Rust：不止于性能的追求</h2>
<p>字节跳动内部的多个项目实践已经证明，将 Golang 服务迁移至 Rust，不仅能带来显著的 CPU 性能提升，还能有效增强服务稳定性、降低运维成本。这背后，是 Rust 语言本身在内存安全和高并发处理上的独特优势。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f24e56f8c0847d3a210bbe76ed7c046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=JvdWAMNprNsInNhtmSv6r3YXeTw%3D" alt="image.png" loading="lazy"/></p>
<p>为了让更多业务团队享受到迁移带来的红利，服务框架团队探索出两条路径：</p>
<ul>
<li>
<p><strong>间接优化</strong>：让 Golang 服务无需改造代码，即可间接获得 Rust 的性能优势。关于ROG 技术剖析和业务落地，可以点击观看视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fb23.tv%2F35jPPMg" target="_blank" title="https://b23.tv/35jPPMg" ref="nofollow noopener noreferrer">b23.tv/35jPPMg</a></p>
</li>
<li>
<p><strong>完全迁移</strong>：通过自动化方案，将业务代码完全迁移至 Rust，实现更彻底的性能飞跃。</p>
</li>
</ul>
<p>「半空」富脚手架模式，正是为实现第二条路径——<strong>规模化、低门槛的完全迁移</strong>——而生。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fc6b0bc4a6c4718bd25930d5d98af74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=AoNS0nOR0SJJ2sA%2B9bIJTgZWz2I%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、迁移面临的三大挑战</h2>
<p>尽管 Go2Rust 的价值显而易见，但长久以来，大规模落地始终面临着三大挑战：</p>
<ul>
<li>
<p><strong>陡峭的学习曲线</strong>：Rust 独特的所有权、生命周期等概念，对习惯了 Golang 的工程师来说，无疑是一道不低的门槛。这使得许多团队在迁移面前望而却步。</p>
</li>
<li>
<p><strong>复杂的依赖黑洞</strong>：一个 Golang 项目，其直接和间接依赖往往构成一个庞大的依赖树。依赖的层级越深，迁移的复杂度就越高，甚至呈指数级增长。如何有效管理和迁移这些依赖，是一个棘手的问题。</p>
</li>
<li>
<p><strong>不可控的翻译质量</strong>：单纯依赖大模型进行代码翻译，结果往往充满不确定性。生成的“Go 味” Rust 代码，不仅风格怪异，更难以满足生产环境对代码质量的严苛要求。</p>
</li>
</ul>
<p>为了跨越这些鸿沟，服务框架团队的迁移模式也经历了持续的演进：从完全依赖人工经验的“作坊式”迁移，到利用工具辅助的“渐进式”翻译，再到如今将迁移升级为“标准化流程”的「半空」富脚手架模式。</p>
<h2 data-id="heading-2">三、「半空」富脚手架：三步走的标准化迁移流程</h2>
<p>「半空」富脚手架的核心，是将复杂、高度依赖人工经验的迁移过程，抽象、封装成一个标准化的三步流程。它以 IDE 插件的形式提供服务，接收用户的 Golang 项目，输出一个 100% 可编译、保留完整业务逻辑的 Rust 脚手架，彻底将工程师从繁琐的“体力活”中解放出来。
这套流程完全复刻了资深工程师进行手动迁移时的心智模型，分为<strong>翻译前、翻译中、翻译后</strong>三个阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff537d63eac84ea192745a286d66a213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=RWE6jLIdMBdq%2Fv9frJrJ1jDShfk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">第一步：翻译前 —— 运筹帷幄，绘制精准迁移蓝图</h3>
<p>如同建造大楼前需要有精确的施工图纸，「半空」在启动翻译前，会进行一次彻底的“项目体检”，为后续的自动化迁移绘制清晰的路径。</p>
<ul>
<li>
<p><strong>项目深度理解文档</strong>：自动解析项目并生成完整的项目梳理文档，涵盖整体架构、接口定义、函数逻辑、结构体设计等，让工程师对项目全貌有宏观的把握。</p>
</li>
<li>
<p><strong>依赖梳理</strong>：系统性地梳理项目的直接与间接依赖，并智能标注出无需翻译的依赖项。这不仅能精确评估迁移的工作量与难度，也让迁移的范围和质量变得清晰可控。</p>
</li>
<li>
<p><strong>接口梳理及规划</strong>：对于复杂的微服务项目，工具会自动提取目标接口及其完整的函数调用链，将庞大的业务逻辑拆解为一个个可以独立编译、验证和运行的单元。</p>
</li>
</ul>
<h3 data-id="heading-4">第二步：翻译中 —— 黑盒操作，从“神似”到“形似”的精准转化</h3>
<p>准备工作就绪后，工程师只需在熟悉的 IDE 中一键触发，即可启动翻译。</p>
<ul>
<li>
<p><strong>基础映射与</strong> <strong>IDE****搜集</strong>：针对 Kitex 微服务项目，自动完成从 Golang 框架到 Rust 框架的基础结构映射，并自动化搜集下游服务所依赖的 IDL 文件，免去了大量繁杂的手动梳理。</p>
</li>
<li>
<p><strong>“意译”而非“直译”</strong>：这是「半空」翻译质量的核心保障。它以“节点”为基本单元，采用“意译”的逻辑，深入理解 Golang 代码的业务意图，然后用最符合 Rust 语言习惯和最佳实践的方式来生成代码，从根本上避免了生硬、别扭的“Go 风格 Rust 代码”。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdc53925b96d49cd85bfe2fa58975446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=CmHiKU5J5dvBlF4NzSDQz4cRjjw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>智能化的依赖处理</strong>：针对不同类型的依赖，「半空」采取了不同的处理策略：
<ul>
<li>
<p><strong>本地依赖</strong>：通过递归翻译直接迁移。</p>
</li>
<li>
<p><strong>业务</strong> <strong>SDK</strong>：标记为递归翻译后，生成对应的 Rust 版本。</p>
</li>
<li>
<p><strong>内部基础组件</strong>：建立专门的知识库，映射 Golang 组件在 Rust 中的等效实现与用法。</p>
</li>
<li>
<p><strong>开源组件</strong>：优先调用知识库中的成熟方案，当知识库缺失时，再由大模型进行补全。</p>
</li>
</ul>
</li>
</ul>
<p>通过自下而上的递归翻译逻辑，从最底层的函数开始，逐个节点完成编译和翻译，最终确保整个接口链路的完整性与可运行性。</p>
<h3 data-id="heading-5">第三步：翻译后 —— 自动优化与辅助校验，守好交付质量最后一关</h3>
<p>翻译完成不等于大功告成。为了确保交付的代码能直接进入生产环境，「半空」还提供了一套完善的“售后服务”。</p>
<ul>
<li><strong>基于 LLM Agent 驱动的代码质量优化</strong>：一个内置的 Agent 会自动尝试编译生成的 Rust 代码，智能解析编译过程中出现的错误，并进行多轮自我修复。实践证明，这能将代码的初始编译通过率从约 80%~90% 提升至 100% 可直接运行的状态。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2feec11bfaba4d0a87cb87688d1b3c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=NctfKIJMaBY0TSVx1NmzSR%2BYNA4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>IDE</strong> <strong>辅助校验</strong>：提供便捷的 IDE 校验插件，支持翻译后的 Rust 代码与原始 Golang 源码的一键跳转、对比查看。这使得工程师可以像 Code Review 一样，快速核对业务逻辑的一致性，确保迁移的准确无误。</li>
</ul>
<p>内部实践表明，经「半空」处理后的代码，质量已非常接近资深工程师手动编写的水平，真正实现了高质量、低成本的规模化迁移。</p>
<h2 data-id="heading-6">四、未来展望：不止于迁移，更重塑研发体验</h2>
<p>「半空」富脚手架模式的推出，仅仅是 Go2Rust 工程化探索的第一步。服务框架团队的目标，不止于实现 1:1 的精准翻译，更希望借此重塑 Rust 的研发体验。<strong>截至发稿前，「半空」在字节内部已实现万行代码 0 编译错误的翻译交付。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b624d1251b2d4ee2a416b498a6a98ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842029&amp;x-signature=h6d7CElNOsRFIT%2BrBcrAYmYOzGs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>引入 Deep Research 架构</strong>：在未来，服务框架团队希望「半空」不仅能“翻译”代码，更能“重构”代码。它将能自动将翻译后的代码，重构为更符合 Rust 最佳实践的形态，充分释放 Rust 语言的强大潜力。</p>
</li>
<li>
<p><strong>持续推广优化</strong>：服务框架团队将持续扩大「半空」的推广范围，积累更多场景的迁移案例，并建立用户反馈的闭环。通过分析用户对翻译代码的修改，持续、智能地优化翻译流程与代码质量。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观测云 MCP Server 接入和使用最佳实践]]></title>    <link>https://juejin.cn/post/7577229187896229923</link>    <guid>https://juejin.cn/post/7577229187896229923</guid>    <pubDate>2025-11-27T09:54:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577229187896229923" data-draft-id="7577202452799111168" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观测云 MCP Server 接入和使用最佳实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-27T09:54:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观测云 MCP Server 接入和使用最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:54:44.000Z" title="Thu Nov 27 2025 09:54:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP 介绍</h2>
<p>MCP Server，模型上下文协议（Model Context Protocol，简称 MCP） 是一个开放协议，旨在标准化应用程序与 AI 模型之间的安全连接和数据源访问。它的核心目标是让开发者能够通过统一的“工具”和“资源”，轻松地为模型提供上下文信息（如数据、内容、操作），从而增强模型能力，而无需重新训练模型。</p>
<p>基于 MCP Server 构建的服务，最终提供一个统一的多模型可调用接口。该服务支持多客户端接入，并采用 API Key 鉴权机制，以此安全访问观测云的各项核心功能，包括监控器、日志、仪表板及 DQL 查询。</p>
<h2 data-id="heading-1">观测云</h2>
<p>观测云是一款专为 IT 工程师打造的全链路可观测产品，它集成了基础设施监控、应用程序性能监控和日志管理，为整个技术栈提供实时可观察性。这款产品能够帮助工程师全面了解端到端的用户体验追踪，了解应用内函数的每一次调用，以及全面监控云时代的基础设施。此外，观测云还具备快速发现系统安全风险的能力，为数字化时代提供安全保障。</p>
<h3 data-id="heading-2">MCP Server 接入</h3>
<p>此处以通过 Cherry Studio 接入方式为例。</p>
<p>1、下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cherry-ai.com%2Fcherry-studio%2Fdownload" target="_blank" title="https://docs.cherry-ai.com/cherry-studio/download" ref="nofollow noopener noreferrer">MCP Server 客⼾端 Cherry Studio</a>，选择对应版本</p>
<p>2、打开 Cherry Studio，点击设置，点击 MCP，点击添加</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9afddf2307341adac35d517c7fdefd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=540dCJm75InFIAgJquAiCOr40io%3D" alt="" loading="lazy"/></p>
<p>提示：如果 mcp 服务不能开启请安装 UV Bun</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52cc4194aaaf4eafad8e0ce9c2bd6d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=Q7on9f%2FjaYsfAajciYVnwAiNKjc%3D" alt="" loading="lazy"/></p>
<p>3、MCP Server 设置</p>
<p>3.1 设置 MCP 服务器名称 （这里以命名 MCP 服务器 为例） 点击类型选择 streamableHttp</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7505ee0cf2854edfaac0e6bf72f579cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=nyI1zNZVMTD%2F%2FlGZrrpzfvczAFY%3D" alt="" loading="lazy"/></p>
<p>3.2 配置URL以及请求头</p>
<p>定义 URL：<code>https://obsy-ai.guance.com/obsy_ai_mcp/mcp</code></p>
<p>请求头格式为：<code>Authorization=DF-API-KEY;Endpoint=SITE_KEY</code></p>
<p>配置说明</p>
<ul>
<li>接⼝以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fmanagement%2Fapi-key%2F" target="_blank" title="https://docs.guance.com/management/api-key/" ref="nofollow noopener noreferrer">API KEY</a> 为认证⽅式，每⼀次请求使⽤请求体 Header 中的 <code>DF-API-KEY</code> 的值作为有效性检验，以及本次请求的⼯作空间限定依据（取此 <code>DF-API-KEY</code> 所属的⼯作空间）；</li>
<li>当前 MCP 服务所展⽰的所有接⼝都只需要提供 <code>API KEY</code> （Header：<code>DF-API-KEY</code>）作为凭证。如果凭据存在且有效，则视为认证通过。</li>
<li>MCP Endpoint 配置参数为 <code>SITE_KEY</code>，例如: <code>cn1</code>。具体对应 MAP 参考如下：</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile">SITE_KEY_MAP = {
    <span class="hljs-comment"># === 中国区 SaaS 部署 ===</span>
    <span class="hljs-string">"cn1"</span>: <span class="hljs-string">"https://openapi.guance.com"</span>,        <span class="hljs-comment"># 中国区1（杭州）——默认</span>
    <span class="hljs-string">"cn2"</span>: <span class="hljs-string">"https://aws-openapi.guance.com"</span>,    <span class="hljs-comment"># 中国区2（宁夏）</span>
    <span class="hljs-string">"cn4"</span>: <span class="hljs-string">"https://cn4-openapi.guance.com"</span>,    <span class="hljs-comment"># 中国区4（广州）</span>
    <span class="hljs-string">"cn6"</span>: <span class="hljs-string">"https://cn6-openapi.guance.one"</span>,    <span class="hljs-comment"># 中国区6（香港）</span>
    <span class="hljs-string">"us1"</span>: <span class="hljs-string">"https://us1-openapi.guance.com"</span>,    <span class="hljs-comment"># 海外区1（俄勒冈）</span>
    <span class="hljs-string">"eu1"</span>: <span class="hljs-string">"https://eu1-openapi.guance.one"</span>,    <span class="hljs-comment"># 欧洲区1（法兰克福）</span>
    <span class="hljs-string">"ap1"</span>: <span class="hljs-string">"https://ap1-openapi.guance.one"</span>,    <span class="hljs-comment"># 亚太区1（新加坡）</span>
    <span class="hljs-string">"za1"</span>: <span class="hljs-string">"https://za1-openapi.guance.com"</span>,    <span class="hljs-comment"># 非洲区1（南非）</span>
    <span class="hljs-string">"id1"</span>: <span class="hljs-string">"https://id1-openapi.guance.com"</span>,    <span class="hljs-comment"># 印尼区1（雅加达）</span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbcc22e52568462cbac875f9e5a316f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=xe8XGc24NRuJx7%2BVQhBmC%2FdZz3k%3D" alt="" loading="lazy"/></p>
<p>4、配置完 MCP 服务后，点击开启按钮</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cb406a27727428893ce0622ef0c6002~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=orDr%2B1iMVkJomzhSdzX82EZ4P0I%3D" alt="" loading="lazy"/></p>
<p>5、回到⾸⻚，选择话题或者助手中点击图标，选择刚刚创建的 MCP（这里以 MCP 服务器为例）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc09c799693749588fc63da999690e97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=lINfYWW0aG9wg5UWS3UP0rl7d80%3D" alt="" loading="lazy"/></p>
<p>6、验证消息已确认是否接入了 MCP 服务</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c643af2637ef42018e59c718e06d0354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842083&amp;x-signature=qvKF2av9UiZDEAUtqmaQFRQB5DY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>大模型接入 MCP 服务的好处：</p>
<ul>
<li>突破自身局限，既能获取训练数据之外的实时信息，也能安全调取企业私有数据，还能弥补复杂操作能力短板；</li>
<li>调用工具更高效，MCP 的统一标准省去逐个适配不同工具接口的麻烦，还能串联多个工具协同完成复杂任务；</li>
<li>降低开发与运维成本，开发者无需关注工具底层差异，可聚焦业务，同时多工具协作的问题也能通过标准化协议简化；</li>
<li>便于搭建应用生态，既能轻松接入现有各类 MCP 服务快速适配新场景，也能将自身特色能力封装成 MCP 服务供他人复用。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大部分人都错了！这才是chrome插件多脚本通信的正确姿势 | 掘金一周 11.27]]></title>    <link>https://juejin.cn/post/7576968345876463643</link>    <guid>https://juejin.cn/post/7576968345876463643</guid>    <pubDate>2025-11-27T09:56:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576968345876463643" data-draft-id="7577189654488432690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大部分人都错了！这才是chrome插件多脚本通信的正确姿势 | 掘金一周 11.27"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-27T09:56:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大部分人都错了！这才是chrome插件多脚本通信的正确姿势 | 掘金一周 11.27
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:56:12.000Z" title="Thu Nov 27 2025 09:56:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1500+ ，阅读时间大约需要 5分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7573521516324732955" target="_blank" title="https://juejin.cn/post/7573521516324732955">大部分人都错了！这才是chrome插件多脚本通信的正确姿势</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7573521516324896795" target="_blank" title="https://juejin.cn/post/7573521516324896795">别再滥用 Base64 了——Blob 才是前端减负的正确姿势</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7574739133945675818" target="_blank" title="https://juejin.cn/post/7574739133945675818">转转UI自动化走查方案探索</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7575017581036765222" target="_blank" title="https://juejin.cn/post/7575017581036765222">Spring 项目别再乱注入 Service 了！用 Lambda 封装个统一调用组件，爽到飞起</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7573601651782385691" target="_blank" title="https://juejin.cn/post/7573601651782385691">Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7575438636331630643" target="_blank" title="https://juejin.cn/post/7575438636331630643">回顾 Flutter Flight Plans ，关于 Flutter 的现状和官方热门问题解答</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7575107094800449542" target="_blank" title="https://juejin.cn/post/7575107094800449542">Doubao-Seed-Code深度测评:一张设计稿生成完整网站,视觉理解编程模型全流程实战</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842171&amp;x-signature=yPlZnnrwlE7vKrbs37Z848GW4Xw%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7573521516324732955" target="_blank" title="https://juejin.cn/post/7573521516324732955">大部分人都错了！这才是chrome插件多脚本通信的正确姿势</a> <a href="https://juejin.cn/user/3035079961218551/posts" target="_blank" title="https://juejin.cn/user/3035079961218551/posts">@不一样的少年_</a></p>
<blockquote>
<p>Chrome 浏览器其实就是把各种工作分开来做，谁负责啥都很清楚。<code>主进程</code>管大局，<code>渲染进程</code>负责把网页内容展示出来，<code>网络进程</code>专门搞数据传输，<code>GPU进程</code>让动画和视频更流畅，<code>插件进程</code>则让你装的各种扩展各自独立运行。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7573521516324896795" target="_blank" title="https://juejin.cn/post/7573521516324896795">别再滥用 Base64 了——Blob 才是前端减负的正确姿势</a> <a href="https://juejin.cn/user/193147068224126/posts" target="_blank" title="https://juejin.cn/user/193147068224126/posts">@404星球的猫</a></p>
<blockquote>
<p>Blob 最大的特点是<strong>纯客户端、零网络</strong>：数据一旦进入 Blob，就活在内存里，无需上传服务器即可预览、下载或进一步加工。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7574739133945675818" target="_blank" title="https://juejin.cn/post/7574739133945675818">转转UI自动化走查方案探索</a> <a href="https://juejin.cn/user/606586148237431/posts" target="_blank" title="https://juejin.cn/user/606586148237431/posts">@转转技术团队</a></p>
<blockquote>
<p>整个方案的核心其实就做了一件事：把两个看起来完全不同的东西（设计稿的JSON和HTML的DOM树），通过一系列归一化处理，变成可以直接比对的同构数据。这个过程中最大的感受是，<strong>前端开发和UI设计之间的gap，本质上是两套不同的渲染规则在互相较劲。</strong></p>
</blockquote>
<p><a href="https://juejin.cn/post/7573588675638001679" target="_blank" title="https://juejin.cn/post/7573588675638001679"> npm scripts的高级玩法：pre、post和--，你真的会用吗？</a> <a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts"> @ErpanOmer</a></p>
<blockquote>
<p><code>npm scripts</code>，它不是一个简单的脚本快捷方式。<strong>它是一个工作流（Workflow）的定义</strong> 。<code>pre</code>和<code>post</code>，定义了你工作流的<strong>执行顺序</strong>和<strong>依赖</strong>，保证了<strong>代码检查</strong>等功能，而<code>--</code>是确保你工作流中的<strong>脚本参数</strong>。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7574281453708214278" target="_blank" title="https://juejin.cn/post/7574281453708214278">Vue高阶组件已过时？这3种新方案让你的代码更优雅</a> <a href="https://juejin.cn/user/3940246036939358/posts" target="_blank" title="https://juejin.cn/user/3940246036939358/posts"> @良山有风来</a></p>
<blockquote>
<p>HOC到Composition API，不仅仅是API的变化，更是开发思维的升级。
HOC代表的组件包装模式已经成为过去，而基于函数的组合模式正是未来。这种转变让我们的代码更加清晰、可测试、可维护。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7575017581036765222" target="_blank" title="https://juejin.cn/post/7575017581036765222">Spring 项目别再乱注入 Service 了！用 Lambda 封装个统一调用组件，爽到飞起</a>  <a href="https://juejin.cn/user/995479086189514/posts" target="_blank" title="https://juejin.cn/user/995479086189514/posts">@只会写代码</a></p>
<blockquote>
<p>其实这组件就干了 3 件事：1.  你传个 Lambda（比如UserService::queryUser），它帮你找到对应的 Service 实例；2.  把找到的实例和方法缓存起来，下次调用更快；3.  统一执行方法，顺便把日志、异常处理都包了。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7573601651782385691" target="_blank" title="https://juejin.cn/post/7573601651782385691">Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</a> <a href="https://juejin.cn/user/2392954206960247/posts" target="_blank" title="https://juejin.cn/user/2392954206960247/posts">@得物技术</a></p>
<blockquote>
<p>HTTP请求看似简单，但它连接着整个系统的"血管"。忽视超时和重试，就像在血管上留了个缺口——平时没事，压力一来就大出血。构建高可靠的网络请求需要在超时控制、重试策略、幂等性保证和性能优化之间取得平衡。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7575438636331630643" target="_blank" title="https://juejin.cn/post/7575438636331630643">回顾 Flutter Flight Plans ，关于 Flutter 的现状和官方热门问题解答</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>在 Flutter 官方刚举行的 Flutter Flight Plans 直播里，除了发布 <a href="https://juejin.cn/post/7571693273728696356" title="https://juejin.cn/post/7571693273728696356" target="_blank">Flutter 3.38</a> 和 <a href="https://juejin.cn/post/7571693273728942116" title="https://juejin.cn/post/7571693273728942116" target="_blank">Dart 3.10</a> 之外，其实还有不少值得一聊的内容，例如企业级的 Flutter 案例展示，Flutter + AI 的场景，<strong>重点还有针对大量热门问题的 Q&amp;A（多窗口、GenUI、PC\Web 插件） 等</strong>。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7573549302620258347" target="_blank" title="https://juejin.cn/post/7573549302620258347">Android系统BUG：修改线程名目标错乱问题探究</a> <a href="https://juejin.cn/user/4089838984502199/posts" target="_blank" title="https://juejin.cn/user/4089838984502199/posts">@卓修武K</a></p>
<blockquote>
<p>此次的问题发生原因是 三方地图SDK 重写了start()函数，又多次调用了start函数，导致滴滴的booster插件添加的setName逻辑也被多次触发，而此时调用setName的线程<strong>刚好是主线程，因此最终影响了 主进程名称</strong>。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7575107094800449542" target="_blank" title="https://juejin.cn/post/7575107094800449542">Doubao-Seed-Code深度测评:一张设计稿生成完整网站,视觉理解编程模型全流程实战</a> <a href="https://juejin.cn/user/1722263248317024/posts" target="_blank" title="https://juejin.cn/user/1722263248317024/posts">@Nturmoils</a></p>
<blockquote>
<p>即使有些模型通过MCP工具调用实现了"看图",但本质上是先把图片转成文字描述,再交给模型理解。这个过程中信息折损非常大,效果远不及原生VLM能力。Doubao-Seed-Code的视觉理解是<strong>模型训练阶段就内置的能力</strong>,可以直接"看懂"图片,识别UI布局、配色方案、设计细节,然后生成对应的代码。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7574568258788851763" target="_blank" title="https://juejin.cn/post/7574568258788851763">如何实现 Remote MCP-Server</a> <a href="https://juejin.cn/user/2137106333053912/posts" target="_blank" title="https://juejin.cn/user/2137106333053912/posts"> @袋鼠云数栈UED团队</a></p>
<blockquote>
<p>对于公司内部的MCP-Server, 由于隐私性问题不能发布为npm包，那么就没法以<code>npx</code>或者<code>uvx</code>等形式快速的共享使用。所以基本会以STDIO类型的MCP-Server进行开发，在内部进行共享时只能将对应源文件拉取本地使用。</p>
</blockquote>
<h2 data-id="heading-5">社区活动日历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c589decbd804477a753bfc1a3b8f5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764842171&amp;x-signature=5zQqoShbufXJ9vNoZqQINJnaMd0%3D" alt="掘金官方 文章头图 1303x734.jpg" loading="lazy"/></p>
<h4 data-id="heading-6">活动日历</h4>

















<table><thead><tr><th>活动名称</th><th>活动时间</th><th/><th/></tr></thead><tbody><tr><td><a href="https://juejin.cn/post/7571751304625815598" target="_blank" title="https://juejin.cn/post/7571751304625815598">🚀TRAE SOLO 实战赛</a></td><td>2025年11月13日-2025年12月16日</td><td/><td/></tr></tbody></table>
<h2 data-id="heading-7">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[诶，这么好用的 mock 你怎么不早说]]></title>    <link>https://juejin.cn/post/7577016562252644403</link>    <guid>https://juejin.cn/post/7577016562252644403</guid>    <pubDate>2025-11-27T08:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252644403" data-draft-id="7574726841543213094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="诶，这么好用的 mock 你怎么不早说"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T08:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="imoo"/> <meta itemprop="url" content="https://juejin.cn/user/2682464104364766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            诶，这么好用的 mock 你怎么不早说
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464104364766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    imoo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:09:50.000Z" title="Thu Nov 27 2025 08:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>老板：小王啊，你 bug 率也太高了，得想想办法，不然扣你绩效。
小王眼里闪过一分无奈二分心酸三分苦涩四分身不由己，很多条件 case、边缘 case 都不好触发，很难自测充分，比如：</p>
<ul>
<li>新手引导，标识由后端下发，申请个新账号非常麻烦</li>
<li>各类状态的流转，比如 xx 任务失败，但是大多数情况下都走不到失败路线</li>
<li>余额为 0 的情况下的各种 case，测试账号往往都是拉满的余额</li>
<li>vip 与普通用户的各种差异点</li>
</ul>
<p>对这类的情况，就只能盲写，然后手动在代码里改状态来大致看一下效果，就很难模拟出一个完整的流程，会出 bug 也属实正常。</p>
<p>有心急的同学就要说了，mock 呀，用 mock 呀！</p>
<p>话虽如此，但是要使用这一套，一是你需要起服务/开程序、写数据、运行，这一套下来还是比较费时间的。二是此类问题绵绵无绝期，每次都这么搞，时间成本会无限累加。</p>
<p>而且频繁调试往往会弄脏代码，很容易提交上一些调试数据，有没有更简单好用的方案呢？</p>
<p>有的有的（掏出 chrome），这么简单的方案还有一个，那就是我们常打交道的控制台了。</p>
<h2 data-id="heading-1">chrome 之替换</h2>
<p>这里举个实际例子带大家走一遍，比如我是掘金的前端，我想测试一下文章<strong>审核中</strong>的样式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a4208ee424d4a6d9f34ec4d219657ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=bsPP2tCMunltvJ9bVrceIFZ91C4%3D" alt="image.png" loading="lazy"/></p>
<p>但是总不能回回都重新写一个审核中的文章供自己测试，费时费力。已知审核中的状态由后端 <code>dynamic</code> 接口的 <code>audit_status</code>决定，该状态为 1 时会展示审核中，为 0 时是正常。</p>
<p>先看一下最终实现的效果吧，只需要简单的操作就可以开闭 mock，而且不侵入代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af229bbdedac4b569af5c0022b072034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=F3px88llUPNi5OSGy9fJSsRemYo%3D" alt="20251121172420_rec_.gif" loading="lazy"/></p>
<p>OK，再说下详细使用步骤：</p>
<ol>
<li>在网络中找到目标接口
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c700ca4a136b48948efe5e20270cda42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=uvE5BnXYd3aCHH4LrZ83MbcuOQU%3D" alt="image.png" loading="lazy"/></li>
<li>右键进行替换
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/267d38f35f7d47a9a4b87fff14401abc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=DuDOgdR4K0IrlBDUNlSxP7b9k7k%3D" alt="image.png" loading="lazy"/></li>
<li>如果是首次使用，会有个提示，需要你选择一个文件夹来存放数据
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47999f2a2e7c4a0fb37405527d037a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=TdQw5CLefKLlRQIFQk2lblbIEWU%3D" alt="image.png" loading="lazy"/></li>
<li>此时会进入到替换的编辑页，该页面可能为刚才请求的内容，也有时候为空。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c23b06a1154fb7a261644d0a59b8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=vSjFXByznn%2F1qFpmd6mvjMRAfRo%3D" alt="image.png" loading="lazy"/>
如果为空的话，可以先去刚才的响应里复制，再贴过来
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d18e0b123084d109e2ece1e98c90716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=qUhMRh0QZWhnQq0lqvLdCsmz4ow%3D" alt="image.png" loading="lazy"/></li>
<li>接着就可以自行修改响应的内容了：这里我们把<code>audit_status</code>从0改为1
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2e7d38c18f2484c885522087c6567e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=zcFKFJVp%2BhGsDyy4gDNVEZdY%2FOc%3D" alt="image.png" loading="lazy"/></li>
<li>ctrl s 保存后，刷新页面即可看到效果
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76949dd8c9f84a788d85e302467ba645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW1vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835790&amp;x-signature=K%2B9ivq1QlM1WL%2FDu4yqtzg3g24I%3D" alt="image.png" loading="lazy"/></li>
</ol>
<p>大功告成，虽然看起来步骤很多，但大多数情况下实际上<strong>只需要右键替换，编辑保存两步就完事了</strong>，既方便启用，又不侵入代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SurfaceControlViewHost 实现跨进程UI渲染]]></title>    <link>https://juejin.cn/post/7577016562252595251</link>    <guid>https://juejin.cn/post/7577016562252595251</guid>    <pubDate>2025-11-27T08:06:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252595251" data-draft-id="7576929700842881033" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SurfaceControlViewHost 实现跨进程UI渲染"/> <meta itemprop="keywords" content="Android,设计"/> <meta itemprop="datePublished" content="2025-11-27T08:06:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="菜就多学"/> <meta itemprop="url" content="https://juejin.cn/user/2663485744614969"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SurfaceControlViewHost 实现跨进程UI渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2663485744614969/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    菜就多学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:06:52.000Z" title="Thu Nov 27 2025 08:06:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在学习photo picker文档时，看到了这样一个描述；可以通过一种方法，将另一个进程的复杂页面渲染到当前页面中，并支持做复杂交互，且具备一定的安全性和隐私性保护。结合之前项目上的一个诉求（给第三方业务暴露登陆按钮，但不想让业务方得知实现细节，避免业务方后台调用该按钮后台偷偷登陆）感觉可以用这种方式去实现，因此去了解下细节</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50a3246520b04957b446dedec0536922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c5bCx5aSa5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835611&amp;x-signature=owV9h84ninqTt1Gjs33ljEHLISU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">实现效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/342a89d800f1480a8b468617d4823ebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c5bCx5aSa5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835611&amp;x-signature=wqrFWlcwTi%2FRsV3u80GNSO5%2BbRI%3D" alt="等.gif" loading="lazy"/></p>
<h2 data-id="heading-2">实现方式：</h2>
<p>1、使用<strong>SurfaceControlViewHost + SurfaceView 实现</strong></p>
<p><strong>SurfaceView原理：</strong> 核心是把主进程的surface传递给单独的渲染进程，从而实现跨进程渲染的效果</p>
<p><strong>SurfaceControlViewHost：</strong> 并提供将渲染进程的view嵌入到主进程中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4ba132b918a4535851d47cfa2415b0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c5bCx5aSa5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835611&amp;x-signature=Btw7PslBogzrrjx4g%2BX7jKdgJ2I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f2fbf0d10344e60aef0adaf72f600c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c5bCx5aSa5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835611&amp;x-signature=P89LIe7AATJsaCkao8Ol%2FNWFkQ4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">使用步骤</h2>
<p>客户端（主进程）：</p>
<p>--创建用于展示内容的，surfaceView，提供host token确定是具体哪个surface View，提供display ID，用于渲染的一些基础依赖（字体大小等）</p>
<p>--获取服务端返回的SurfacePackage，与surfaceView绑定</p>
<p>--事件通知，所有input事件，通知服务器</p>
<p>服务端（渲染进程）：</p>
<p>--使用客户端提供的display ID、hostToken 创建SurfaceControlViewHost，创建自定义view，返回SurfacePackage给客户端</p>
<p>--接收input事件，传递给自定义view</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e3415585a04e6f8ec7a2beb5d35029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c5bCx5aSa5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835611&amp;x-signature=R2DUcRKqcMra8sMrksr2e%2B9qrc0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//aidl</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteRender</span> {
    <span class="hljs-comment">//客户端提供surface、大小、display 从服务端获取 surfacePackage</span>
    SurfacePackage <span class="hljs-title function_">getSurfacePackage</span><span class="hljs-params">(<span class="hljs-type">int</span> displayId, IBinder hostToken, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span>;
    <span class="hljs-comment">//客户端向服务端传递 事件</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(in MotionEvent motionEvent)</span>;
}
 
<span class="hljs-comment">//服务端</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IRemoteRender.<span class="hljs-type">Stub</span> <span class="hljs-variable">mBinder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IRemoteRender</span>.Stub() {
 
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> SurfaceControlViewHost.SurfacePackage <span class="hljs-title function_">getSurfacePackage</span><span class="hljs-params">(<span class="hljs-type">int</span> displayId, IBinder hostToken, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
            Log.i(TAG, <span class="hljs-string">"getSurfacePackage, displayId="</span> + displayId + <span class="hljs-string">", hostToken="</span> + hostToken + <span class="hljs-string">", width="</span> + width + <span class="hljs-string">", height="</span> + height);
            <span class="hljs-keyword">final</span> SurfaceControlViewHost.SurfacePackage[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SurfaceControlViewHost</span>.SurfacePackage[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
            mHandler.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-comment">// 创建SurfaceControlViewHost</span>
                    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> getBaseContext();
                    <span class="hljs-type">Display</span> <span class="hljs-variable">display</span> <span class="hljs-operator">=</span> context.getSystemService(DisplayManager.class).getDisplay(displayId);
                    mSurfaceControlViewHost = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SurfaceControlViewHost</span>(context, display, hostToken);
                    createRootView(width,height);
                    <span class="hljs-comment">// 将视图附加到SurfaceControlViewHost</span>
                    mSurfaceControlViewHost.setView(mRootView, width, height);
                    result[<span class="hljs-number">0</span>] = mSurfaceControlViewHost.getSurfacePackage();
                    latch.countDown();
                }
            });
 
            <span class="hljs-keyword">try</span> {
                latch.await(); <span class="hljs-comment">// 等待主线程完成操作</span>
                <span class="hljs-keyword">return</span> result[<span class="hljs-number">0</span>];
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Log.i(TAG, <span class="hljs-string">"getSurfacePackage, e="</span> + e.getMessage());
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
 
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(MotionEvent event)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span>[] result = {<span class="hljs-literal">true</span>};
            mHandler.post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    mRootView.dispatchTouchEvent(event);
                    latch.countDown();
                }
            });
            <span class="hljs-keyword">try</span> {
                latch.await(); <span class="hljs-comment">// 等待主线程完成操作</span>
                <span class="hljs-keyword">return</span> result[<span class="hljs-number">0</span>];
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Log.i(TAG, <span class="hljs-string">"getSurfacePackage, e="</span> + e.getMessage());
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    };
 
 
<span class="hljs-comment">//客户端</span>
      <span class="hljs-keyword">try</span> {
            <span class="hljs-type">IBinder</span> <span class="hljs-variable">hostToken</span> <span class="hljs-operator">=</span> mSurfaceView.getHostToken();
            SurfaceControlViewHost.<span class="hljs-type">SurfacePackage</span> <span class="hljs-variable">surfacePackage</span> <span class="hljs-operator">=</span> mRemoteRender.getSurfacePackage(<span class="hljs-number">0</span>, hostToken, <span class="hljs-number">1000</span>, <span class="hljs-number">2000</span>);
            mSurfaceView.setChildSurfacePackage(surfacePackage);
            mSurfaceView.setOnTouchListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnTouchListener() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouch</span><span class="hljs-params">(View view, MotionEvent motionEvent)</span> {
 
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">return</span> mRemoteRender.onTouch(motionEvent);
                    } <span class="hljs-keyword">catch</span> (RemoteException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                }
            });
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            e.printStackTrace();
        }



</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字节跳动：Apache Doris + AI 一站式融合数据引擎的探索与实践]]></title>    <link>https://juejin.cn/post/7577049352838758415</link>    <guid>https://juejin.cn/post/7577049352838758415</guid>    <pubDate>2025-11-27T08:09:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577049352838758415" data-draft-id="7577049352838742031" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字节跳动：Apache Doris + AI 一站式融合数据引擎的探索与实践"/> <meta itemprop="keywords" content="数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-27T08:09:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字节跳动：Apache Doris + AI 一站式融合数据引擎的探索与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:09:01.000Z" title="Thu Nov 27 2025 08:09:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着人工智能技术在业务中的渗透，我们逐渐意识到：AI 不仅是提升效率的工具，更是重构数据处理与消费方式的核心驱动力。在这一背景下，我们思考：<strong>能否构建一款「AI + Data」一站式融合的数据引擎？</strong> 它不仅能够统一处理文本、音视频等非结构化数据与传统结构化数据，还能为算法工程师提供流畅的数据开发体验，实现数据处理与 AI 模型无缝衔接，并能确保数据处理负载与在线服务负载完全隔离。这是 2024 年末启动 DataMind 项目的初衷。</p>
<p><em>本文整理自字节跳动 DataMind 负责人郭泽晖在 Doris Summit 2025 中的演讲内容，并以演讲者第一视角进行叙述。</em></p>
<h2 data-id="heading-0">一、DataMind：Doris + AI 一站式融合数据引擎</h2>
<p>在项目启动前，我们评估了多种市面上的开源方案，但未能找到完全符合 AI + Data 引擎需求的产品。因此，我们决定选择一款优秀的 OLAP 数据库，并在此基础上融合和增强 AI 功能。Apache Doris 凭借完善的功能、卓越的 OLAP 性能、丰富的生态体系、活跃的社区氛围及良好的产品口碑吸引了我们的注意。</p>
<p>与此同时，<strong>我们了解到社区也在积极探索 Doris 与 AI 能力的结合，因此决定在 Apache Doris 基础上二次开发，打造一站式引擎——DataMind</strong>。这些能力包括：</p>
<ul>
<li>Hybrid Search：将基于文本相似性、语义相似性、业务规则匹配这三种能力集成至 Doris 中，并在此基础上补齐了向量检索及 Tablet-level BM25 能力。(<em>详见章节二</em>）。</li>
<li>AI  Function：基于 Doris 补齐了 AI_QUERY 和 TEXT_EMBEDDING ，并支持了 Python UDF。(<em>详见章节三）</em></li>
<li>GraphRAG ：在基于 Doris 的 DataMind 产品上构建了 GraphRAG，应用层研发团队能够更便捷地接入新的 AI 能力，缩短研发周期。(<em>详见章节四</em>）</li>
</ul>
<blockquote>
<p><em>目前，我们已将部分 AI 融合的实践成果贡献给开源社区，大家可从 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1518" target="_blank" title="https://www.selectdb.com/blog/1518" ref="nofollow noopener noreferrer">Doris 4.0 版本</a></strong> 中关注。</em></p>
</blockquote>
<p>这些能力不仅是 Datamind 的重要组成，也是构建企业级 AI 问数平台奠定了坚实的技术基础。后文将逐一展开其设计思路、实现路径与优化实践。</p>
<h2 data-id="heading-1">二、Hybrid Search 能力集成</h2>
<p>AI 场景下典型的混合搜索的架构可以概括为三种搜索方式：基于<strong>文本相似性、语义相似性、业务规则</strong>的匹配。这三路的搜索结果会在后端统一排序，排序方法依赖自训练的模型，分为粗排和精排两个阶段。粗排模型可提高处理性能，精排模型实现更优的重排序效果，平衡整体开销。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e1235af247410fb830ea85de741d06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=X4ZgM3jmIBI4pU0t57etnTM2u%2Bk%3D" alt="二、Hybrid Search 能力集成.PNG" loading="lazy"/></p>
<p>我们希望将这三类搜索能力集成至基于 Doris 的 DataMind 引擎之中，让用户只需导入一份数据，并在完成必要的处理及索引构建后，即可直接上线服务，无需介入其他三方工具。为实现这一目标，团队基于 Doris 补充了向量索引和 BM25 打分函数这两项核心能力。</p>
<h3 data-id="heading-2">2.1 向量索引</h3>
<p>我们基于 Faiss （Facebook 开源的 AI 相似性搜索工具）实现了 <strong>HNSW 与 IVF_PQ 两种 ANN 算法的向量索引</strong>。HNSW 在大规模数据集上性能表现更优，但资源开销较大； IVF_PQ 在大规模数据集上，成本与性能表现更加均衡。</p>
<p>向量索引支持与其他索引条件组合使用。比如，可将倒排索引的结果通过 Faiss 提供 IDSelector 接口传递到底层 ANN 算法实现上以控制搜索过程。基本原理是：倒排索引首先检索匹配行号的 Bitmap，这一 Bitmap 被传递给 Faiss 库。当进行向量搜索时，Faiss 会将搜索范围限制，最终输出 TopN 行号结果，代表融合后的结果集。当倒排索引在第一阶段筛选出的数据量较少时，会跳过向量索引进行暴力计算，这样耗时更短、时间更精准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e3afe07d1f4f98863742f7e9bd5692~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=nuUbO4lVqq%2FdBEaXAjtUiltgzoI%3D" alt="2.1 向量索引.PNG" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 Tablet-level BM25</h3>
<p>BM25 是一种用于信息检索的排名函数，用于衡量查询与文档的相关性。它基于词频（t）和文档长度进行加权计算，同时考虑逆文档频率（IDF）以惩罚常见词。在整个公式中，需重点关注总文档数 N 和文档频率 DF 等全局统计信息，这些信息直接影响实现的难度。（<em>更多信息可自行搜索查阅</em>）</p>
<p>在 Doris 的设计中，一个 segment 对应一个倒排索引的解决方案，因此在 segment 级别实施 BM25 较为简单，系统可以基于每个 segment 的统计信息（如总文档数 N 和文档频率 DF）计算每一行的得分。然而，合并小 segment 可能导致统计信息变化，从而影响 BM25 得分，造成用户评分波动，这在生产环境中不可接受。</p>
<p><strong>为了避免此问题，团队将 BM25 公式提升至 tablet 级（tablet-level）。所有全局统计信息（包括 N 和 DF）需基于整个 tablet 聚合，以保持得分结果的一致性</strong>。</p>
<p>以 Merge on Write / Merge on Write 为例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba25609b4ffe480491cce8b1a02fd0b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=vPRZ9ImQQcXhkcRdzMJWxtnKcUw%3D" alt="2.2 Tablet-level BM25.png" loading="lazy"/></p>
<ol>
<li><strong>在 Scan 算子初始化阶段</strong>：系统会预先搜索用于 BM25 计算的 tablet 级 统计信息。每个 segment 会被依次扫描，并以流式方式输出数据块。</li>
<li><strong>数据收集阶段</strong>：在处理每个 segment 之前，需计算完整的 tablet 级统计信息。Scan 算子初始化时，系统使用相应搜索条件访问每个 segment 的解决方案。此过程中产生的文件操作、数据读取和内存命中等结果构成搜索上下文信息。同时，与搜索相关的对象会被缓存，以避免重复产生 IO 开销。</li>
<li><strong>索引查找及数据读取</strong>：当正式进入某个索引后，索引搜索将基于此前收集的 tablet 级统计信息，为命中的每一行计算分数。最终，计算所得的分数通过虚拟列的迭代器返回到 segment，随数据块输出。</li>
</ol>
<h3 data-id="heading-4">2.3 搜索框架优化</h3>
<p>在补充了向量索引和 BM25 能力后，我们面临一个新问题：在混合搜索框架中，涉及的函数并非传统意义上在计算层基于输入直接进行求值，而是必须在索引检索的过程中计算出结果，因此需要设计一套特殊的投影下推流程，具体实现如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4b3be839c643819beabf2fbc86f18c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=AWbapogl%2F3sDgq4dCDkUDG1d3w4%3D" alt="2.3 搜索框架优化.png" loading="lazy"/></p>
<p>在执行计划层，我们将相关函数替换为虚拟列，并将这些虚拟列下推至 OlapScanNode。OlapScanNode 携带虚拟列的信息，将其传递到接近索引计算与查询块存储逻辑的执行路径中。</p>
<p>在索引计算过程中，系统基于这些虚拟列计算向量距离分数和 BM25 相似性分数，并将结果填充回对应的 block。最终，带有虚拟列计算结果的 block 由 Scan 算子输出，并传递至下游算子，以自然衔接的执行计划完成整个检索流程。</p>
<h2 data-id="heading-5">三、AI Function  补齐</h2>
<p>在 AI Function 上，主要基于 Doris 补齐了 AI_QUERY 和 TEXT_EMBEDDING 两种函数。</p>
<h3 data-id="heading-6">3.1 AI_QUERY</h3>
<p>该函数用于调用大模型并能较好地处理非结构化文本这类数据，<strong>将其转化为结构化数据，再进行传统分析</strong>。例如，对于一张客户评价表，可以让大模型为每条评价打分并分类，如好评输出 1、差评输出 0，通过统计即可得出好评与差评的大致数量。</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">WITH</span> reviews <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> 
 AI_QUERY(<span class="hljs-string">'volcengine/Doubao-pro-128k-240628'</span>, concat(<span class="hljs-string">'判断这条产品评价是好评还是差评，好评输出1，差评输出0：'</span>,  review_txt)) <span class="hljs-keyword">AS</span> review_type
<span class="hljs-keyword">FROM</span> customer_reviews
) <span class="hljs-keyword">SELECT</span> review_type, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> reviews
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> review_type
</code></pre>
<h3 data-id="heading-7">3.2 TEXT_EMBEDDING</h3>
<p>该函数主要有两个阶段：</p>
<ul>
<li>数据清洗阶段：在 AI 清洗过程中生成对应向量并构建向量索引。</li>
<li>数据查询阶段：此阶段提供两种使用方式。第一种是由用户的应用层代码自行生成查询向量，并作为参数传入 SQL 进行搜索，该方式需传入较长的向量 float 数组，会增加优化器的解析开销。第二种方式是<strong>直接调用 TEXT_EMBEDDING 函数</strong>，将查询文本传入并执行搜索，这种方法更为便捷，且性能更佳。</li>
</ul>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    content, 
    APPROX_COSINE_SIMILARITY(
        TEXT_EMBEDDING(<span class="hljs-string">'volcengine/Doubao-embedding-240715'</span>, <span class="hljs-string">'Doris Summit'</span>), 
        content_vec_col) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span> my_table 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score
LIMIT <span class="hljs-number">7</span>;
</code></pre>
<h3 data-id="heading-8">3.3 Python UDF 的实现</h3>
<p>除上述标准函数外，<strong>我们基于 Doris 支持了 Python UDF，以满足自部署模型的需求</strong>，包括 Rerank 模型、Embedding 模型、甚至大模型的访问需求，以及依赖 Python 库进行非结构化数据处理的需求场景。</p>
<p>Python UDF 的核心设计主要包含几个关键点：</p>
<ol>
<li><strong>多进程架构</strong>：旨在解决 UDF 之间的隔离问题，避免 Python 的全局解释器锁（GIL）。每个 Python UDF 能通过虚拟环境（venv）实现依赖隔离。</li>
<li><strong>生命周期绑定</strong>：执行 Python 的子进程与 Doris 的 pipeline task 生命周期绑定。当一个 pipeline task 生成时，相应的子进程也会被创建，并在任务结束时进行清理。这种设计使得并发模型与 Doris 的计算引擎密切结合，用户只需调整 Doris 的并发参数即可管理 Python UDF 的执行并发，简化了维护工作。</li>
<li><strong>数据传输和序列化</strong>：主进程与子进程之间的数据传输通过管道进行。支持 Python 原生对象输入输出的版本采用 Python 的 Marshal 机制进行序列化。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6244bc643a4146d99cc95c21a40e04f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=C7aNVDYAc18be2hvHZG2Q75wFW4%3D" alt="3.3 Python UDF 的实现.png" loading="lazy"/></p>
<p>如下方代码示例，<strong>示例中展示了混合搜索（向量+全文检索）的应用</strong>，两个检索通过用户自研的 Python UDF 模型进行重排序，最终使用 Hybrid Search 进行数据摄取。在 AI Function 和 Python UDF 的加持下，用户只需通过一条简单的 SQL 语句即可串联整个业务搜索流程及数据处理流程，使用十分便捷。</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> predict_class(<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span><span class="hljs-type">FLOAT</span><span class="hljs-operator">&gt;</span>) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">INT</span> 
PROPERTIES ( 
    "file"<span class="hljs-operator">=</span>"https://cloud-storage/obj/datamind/pyudf.zip", 
    "symbol"<span class="hljs-operator">=</span>"predict_class", 
    "type"<span class="hljs-operator">=</span>"PYTHON_UDF" 
);
<span class="hljs-keyword">WITH</span> channel_1 <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> 
        content
    <span class="hljs-keyword">FROM</span> my_table 
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> 
        APPROX_COSINE_SIMILARITY(py_udf_embed(<span class="hljs-string">'Doris Summit'</span>), content_vec_col) <span class="hljs-keyword">DESC</span>
    LIMIT <span class="hljs-number">7</span>
), 
channel_2 <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> 
        content
    <span class="hljs-keyword">FROM</span> my_table
    <span class="hljs-keyword">WHERE</span> MATCH_ANY(content, <span class="hljs-string">'Doris Summit'</span>)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> 
         BM25() <span class="hljs-keyword">DESC</span>
    LIMIT <span class="hljs-number">7</span>
)
<span class="hljs-keyword">SELECT</span> 
    content
<span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> content <span class="hljs-keyword">FROM</span> channel_1
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-keyword">SELECT</span> content <span class="hljs-keyword">FROM</span> channel_2
) t
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> py_udf_score(<span class="hljs-string">'Doris Summit'</span>, content) <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">7</span>;
</code></pre>
<h2 data-id="heading-9">四、GraphRAG on DataMind</h2>
<h3 data-id="heading-10">4.1 GraphRAG</h3>
<p>GraphRAG 是一种结合图数据库与 RAG（Retrieval-Augmented Generation）技术。推动 DataMind 集成 GraphRAG 功能的原因是，我们在推广 AI 功能时发现多个业务团队对此有需求。与标准 RAG 相比，GraphRAG 的实现过程更为复杂，需要在基础 AI 能力上进一步构建。</p>
<p><strong>构建阶段</strong>：该阶段的输入为文档或分割成的片段（chunk）。利用大模型（AI Function）进行实体抽取——从文档中提取出关键信息，实体之间的关系可以看作是图中的边，每条边具有一定的权重，这些权重由大模型自动识别，提取的实体及其描述经过向量化后存储，以构建索引。</p>
<p>此外，图结构和边的描述也会存储在一张表中。基于该图，系统利用 Search 发现算法（如 Lighting）进行聚类，将相似的实体归类为一个 Search，并生成 Search 报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09fcfbb2bf734cd1ad31663f37bbd5da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=2iLA29kVgA7QEKKukaxdXoRnGeU%3D" alt="4.1 GraphRAG.png" loading="lazy"/></p>
<p><strong>查询阶段</strong>：在检索过程中，首先将 Query 转换为向量，该向量用于 Search 实体，以找到与之相关的 Top-K 实体。得到 TopK 实体后，系统将召回它们相关的边，这些边包含与实体相关的描述和信息，以及这些实体关联的报告和原始文档的片段。在有限的上下文内，系统会按优先级拼接相关内容，形成最终上下文，随后将其输入 AI 以生成回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e123b45e604420958fccf888b5e47f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=NBsV%2FNSvJcEHqVnj3G8YE28AazY%3D" alt="4.1 GraphRAG-1.png" loading="lazy"/></p>
<h3 data-id="heading-11">4.2 GraphRAG on DataMind</h3>
<p>基于 Apache Doris 的 DataMind 产品上如何构建 GraphRAG 呢？整体设计分为多层，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6a6905aa83840e2841c95e32569339b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=TzXNy7U%2BeetM%2FNX3wy1feBDQzh0%3D" alt="4.2 GraphRAG on DataMind.png" loading="lazy"/></p>
<p>最底层是表结构的设计，包括实体表、Search 表以及用户自定义的源数据表等。在此基础上，通过一系列函数，包含用于文档切分的函数、Leiden 聚合函数等等，最后结合 ETL SQL、Query SQL 等，共同实现 GraphRAG 的构建与查询流程。</p>
<p>由于底层 SQL 相对复杂，团队在这些 SQL 上封装了 Go、Python 与 Java 的 SDK，以方便用户使用。用户只需调用如 build 或 import 等接口即可完成数据导入与构建，再通过 query 接口实现查询能力。这样一来，应用层研发能够更快速地接入新的 AI 能力。只需使用 Apache Doris 数据库并结合团队提供的 SDK，即可直接将业务流程跑通并验证效果。</p>
<h2 data-id="heading-12">五、企业级 AI 问数 Datamind 落地方案</h2>
<p>企业级 AI 问数是当前行业内较为经典且热门的探索方向。行业内普遍采用 NL2SQL 直接查询 Apache Doris 等数据库的模式。那么，字节是如何落地的呢？</p>
<h3 data-id="heading-13">5.1 企业 AI 问数理想架构</h3>
<p>首先，我们基于 Doris 构建了湖仓一体的数据架构，以数据湖为中心，外部业务系统或企业内部信息系统（如 RDS、API 取数），数据经过 DTS 等工具摄入，最终沉淀在云存储中，呈现为传统 Hive 的原生 Parquet 格式。随后，数据通过 Spark 或 Flink 进行 ETL 清洗，遵循标准的 Lambda 架构，最终生成可供消费的数据，并存储至 OLAP 引擎 Apache Doris 以实现查询加速。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4a678bfd8640d9bcd105a70e21235f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=y2yvM928aRWBRQrKvOFBtH6gkLo%3D" alt="5.1 企业 AI 问数理想架构.png" loading="lazy"/></p>
<p>若要利用 AI 进行数据消费，以实现类似企业智能体的功能，它需要访问所有企业信息系统的数据。因此，我们期望的理想架构处理流程应如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d47df3a47d4312beae1a2efa4be56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=PhsnSFIRozhEAxsh2AGKEr08mZA%3D" alt="5.1 企业 AI 问数理想架构-1.png" loading="lazy"/></p>
<p>具体流程：AI 问数应用通过 Data Agent 调用 NL2SQL 这类外部工具，Data Agent 采用 Plan Execute 或 React 模型规划执行路径，需要元数据以及依据业务自定义的语义模型——简单理解为表字段的描述，基于这些信息，Data Agent 生成取数 SQL，并发给 Apache Doris（即 DataMind） 加速执行，最终将数据返回到 AI 问数应用层。在这其中，Apache Doris 主要作用是将湖上的数据同步到其内部进行查询加速。</p>
<p>而这种理想处理方式面临数据安全性及查询延迟等问题，比如：</p>
<ul>
<li>数据湖中的数据量庞大，全部同步到 Apache Doris 并不现实，且敏感数据也不宜全量同步。</li>
<li>当数据加速到 DataMind 后，Apache Doris 的内表与外表存在差异。加速会影响 SQL 的 Catalog 语法，例如加速后，外表的 Catalog 名称为 Hive，内表则为 Internal。这对 AI 生成 SQL 产生一定影响，迫使 AI 必须感知是否存在加速。</li>
</ul>
<h3 data-id="heading-14">5.2 企业 AI 问数最终架构</h3>
<p>为解决上述问题，我们进行了如下优化，具体改进为：</p>
<ul>
<li><strong>改进 Data Agent 查询的路由机制</strong>：用户只需书写库表名，系统将在优化器阶段自动判断路由、补全表名。用户对于 Data Agent 的使用，只需理解数据湖中的 Schema，无需关注表是存储在数据湖还是已加速至 Apache Doris。</li>
<li><strong>数据湖权限系统的打通</strong>：我们的数据湖拥有独立的权限管理系统，控制读写访问。将数据加速至 Apache Doris 相当于复制一份数据，可能导致安全管控失效。为解决这一问题，我们设计了机制：即使数据同步至 Apache Doris，其权限仍受 Triton 数据湖权限系统管控，且与 Apache Doris 的账号密码无关。这一设计确保应用层在数据湖上申请的权限依然有效，加速后无需额外权限申请。此外，这一机制保证了即使数据同步到 Apache Doris，持有其账号密码的人员（如 DBA），未经原数据湖系统申请的权限仍无法访问。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/285b9583631d4edcb3385984dd2397ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=SF5KB6Q6rhENVCgFdRCUQFw2%2F3g%3D" alt="5.2 企业 AI 问数最终架构.png" loading="lazy"/></p>
<h2 data-id="heading-15">六、结束语</h2>
<p>Doris + AI  一站式融合数据引擎 DataMind 的实现，已在字节内部应用一段时间，并在持续推广之中，典型应用场景包括智能简历搜索、ByteRAG 平台、CapCut 内容治理等。且在 GraphRAG 上线后，团队与多方客户合作实现了场景落地，例如广告场景、代码搜索的场景，以及近期业界关注的 PRD2Code 等研发提效场景 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b6eaf3aaffb4547a9d65f846828601e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=zrrUhDp2OmFLsvzZ%2BnT7Gwe1cOE%3D" alt="六、结束语-1.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/110d14815c8b486dbe50dde8abb3ca98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=13GCCMEdVlfD%2FhNnQmShhSsD4qg%3D" alt="六、结束语.png" loading="lazy"/></p>
<p>未来，我们还会在 DATA + AI 上继续探索，搭建更加完善的企业 AI 问数架构。此外，我们将保持与 Doris 开源社区的紧密联系保持联系，积极参与共建并为社区提供反馈。</p>
<p>欢迎更多的同仁加入 AI 能力共创中来，可通过下方二维码添加 Doris 小助手，回复【AI】即可加入 AI 专项交流群。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88f9e91d41684893bdad7579c96f4fa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835740&amp;x-signature=oh9r9BDgNGmrhstZ5EyTjxSWHng%3D" alt="Doris AI 专项群二维码" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 协议演进：从 MCP 到 ACP 的架构对比与未来展望]]></title>    <link>https://juejin.cn/post/7577031454585929755</link>    <guid>https://juejin.cn/post/7577031454585929755</guid>    <pubDate>2025-11-27T08:12:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577031454585929755" data-draft-id="7576918517238218802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 协议演进：从 MCP 到 ACP 的架构对比与未来展望"/> <meta itemprop="keywords" content="MCP,Gemini,OpenAI"/> <meta itemprop="datePublished" content="2025-11-27T08:12:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="魁首"/> <meta itemprop="url" content="https://juejin.cn/user/3817931570691031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 协议演进：从 MCP 到 ACP 的架构对比与未来展望
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817931570691031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    魁首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:12:52.000Z" title="Thu Nov 27 2025 08:12:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Multi-Agent 协作的基石：协议标准化探索之路</h2>
<blockquote>
<p>基于 Google Gemini CLI 和 OpenAI Codex 源码的深度技术剖析</p>
<p><strong>源码版本说明</strong>
本文基于以下版本的源码分析：</p>
<ul>
<li><strong>Gemini CLI</strong>: v0.10.0-nightly (2025-10-13)</li>
<li><strong>Codex CLI</strong>: v0.2.0-alpha.2 (2025-11-25)</li>
<li><strong>MCP 协议</strong>: 2025-06-18 规范</li>
</ul>
</blockquote>
<h3 data-id="heading-1">摘要</h3>
<ul>
<li>随着 AI Agent 的快速发展，如何让不同的 Agent 之间高效协作、如何标准化 Agent 与外部工具的交互，已成为业界关注的焦点。</li>
<li>本文通过深入分析 <strong>Google Gemini CLI</strong> 和 <strong>OpenAI Codex</strong> 的源码实现，对比两大主流协议——<strong>MCP (Model Context Protocol)</strong> 和 <strong>ACP (Agent Context Protocol)</strong> 的设计理念、技术架构和应用场景，并探讨 AI Agent 协议的未来发展方向。</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、协议背景：为什么需要标准化？</h3>
<h4 data-id="heading-3">1.1 当前 AI Agent 生态的痛点</h4>
<p>在协议标准化之前，AI Agent 面临以下核心挑战：</p>






























<table><thead><tr><th>痛点</th><th>描述</th><th>影响</th></tr></thead><tbody><tr><td><strong>孤岛效应</strong></td><td>每个 Agent 使用私有协议，无法互操作</td><td>无法构建 Multi-Agent 系统</td></tr><tr><td><strong>工具集成困难</strong></td><td>每个工具需要为不同 Agent 重复开发适配器</td><td>开发成本高，生态碎片化</td></tr><tr><td><strong>状态不可恢复</strong></td><td>会话状态无法持久化或跨系统传递</td><td>用户体验差，无法长期任务</td></tr><tr><td><strong>安全性缺失</strong></td><td>缺乏统一的权限控制和审计机制</td><td>企业级部署存在风险</td></tr></tbody></table>
<h4 data-id="heading-4">1.2 协议标准化的价值</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph before["标准化前：N × M 问题"]
        A1["Agent1"] --&gt; T1A["Tool1 (适配器 1-1)"]
        A1 --&gt; T2A["Tool2 (适配器 1-2)"]
        A1 --&gt; T3A["Tool3 (适配器 1-3)"]

        A2["Agent2"] --&gt; T1B["Tool1 (适配器 2-1)"]
        A2 --&gt; T2B["Tool2 (适配器 2-2)"]
        A2 --&gt; T3B["Tool3 (适配器 2-3)"]

        style before fill:#ffebee,stroke:#c62828
    end

    subgraph after["标准化后：N + M 问题"]
        Agent1["Agent1"] --&gt; Protocol["MCP/ACP 协议层"]
        Agent2["Agent2"] --&gt; Protocol
        Agent3["Agent3"] --&gt; Protocol

        Protocol --&gt; Tool1["Tool1"]
        Protocol --&gt; Tool2["Tool2"]
        Protocol --&gt; Tool3["Tool3"]

        style after fill:#e8f5e9,stroke:#2e7d32
        style Protocol fill:#fff3e0,stroke:#e65100
    end
</code></pre>
<p><strong>对比结果</strong>:</p>
<ul>
<li><strong>标准化前</strong>: 需要 <strong>N × M</strong> 个适配器 (每个 Agent 为每个 Tool 开发专用适配器)</li>
<li><strong>标准化后</strong>: 仅需 <strong>N + M</strong> 个适配器 (Agent 实现协议 + Tool 实现协议)</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、MCP (Model Context Protocol) 深度解析</h3>
<h4 data-id="heading-6">2.1 MCP 协议概述</h4>
<p><strong>MCP</strong> 由 Anthropic 提出，是一个专注于 <strong>Agent 与外部工具/资源交互</strong> 的标准协议。</p>
<p><strong>核心设计理念</strong>:</p>
<ul>
<li>📦 <strong>资源抽象</strong>: 将外部系统（数据库、API、文件系统）抽象为统一的 Resource</li>
<li>🔧 <strong>工具调用</strong>: 标准化的工具发现、调用和响应流程</li>
<li>🔌 <strong>传输无关</strong>: 支持 stdio、SSE、HTTP 等多种传输方式</li>
<li>🔐 <strong>权限控制</strong>: 内置的工具执行审批机制</li>
</ul>
<p><strong>协议版本</strong>: <code>2025-06-18</code> (来源: Codex <code>mcp-types/src/lib.rs</code>)</p>
<h4 data-id="heading-7">2.2 Gemini CLI 的 MCP 实现架构</h4>
<h5 data-id="heading-8"><strong>核心组件</strong>:</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/core/src/tools/mcp-client.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpClient</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">Client</span>;                    <span class="hljs-comment">// MCP SDK Client</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>;              <span class="hljs-comment">// 传输层 (stdio/SSE/HTTP)</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">status</span>: <span class="hljs-title class_">MCPServerStatus</span>;           <span class="hljs-comment">// 连接状态</span>

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-comment">// 1. 建立传输连接</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">transport</span> = <span class="hljs-title function_">createTransport</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverConfig</span>);

    <span class="hljs-comment">// 2. 初始化 MCP Client</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'gemini-cli'</span>,
      <span class="hljs-attr">version</span>: <span class="hljs-string">'0.10.0'</span>
    }, {
      <span class="hljs-attr">capabilities</span>: {
        <span class="hljs-attr">roots</span>: { <span class="hljs-attr">listChanged</span>: <span class="hljs-literal">true</span> },
        <span class="hljs-attr">sampling</span>: {}
      }
    });

    <span class="hljs-comment">// 3. 连接到 MCP Server</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">transport</span>);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">discover</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-comment">// 发现工具</span>
    <span class="hljs-keyword">const</span> tools = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">listTools</span>();

    <span class="hljs-comment">// 发现资源</span>
    <span class="hljs-keyword">const</span> resources = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">listResources</span>();

    <span class="hljs-comment">// 发现 Prompts</span>
    <span class="hljs-keyword">const</span> prompts = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">listPrompts</span>();
  }
}
</code></pre>
<h5 data-id="heading-9"><strong>工具调用流程</strong>:</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/core/src/tools/mcp-tool.ts</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiscoveredMCPToolInvocation</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-attr">signal</span>: <span class="hljs-title class_">AbortSignal</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ToolResult</span>&gt; {
    <span class="hljs-comment">// 1. 检查是否需要用户批准</span>
    <span class="hljs-keyword">const</span> confirmationDetails = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldConfirmExecute</span>(signal);
    <span class="hljs-keyword">if</span> (confirmationDetails) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">waitForUserApproval</span>(confirmationDetails);
    }

    <span class="hljs-comment">// 2. 调用 MCP Tool</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">functionCalls</span>: <span class="hljs-title class_">FunctionCall</span>[] = [{
      <span class="hljs-attr">name</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">serverToolName</span>,
      <span class="hljs-attr">args</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>
    }];

    <span class="hljs-keyword">const</span> rawResponseParts = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mcpTool</span>.<span class="hljs-title function_">callToolBatch</span>(
      functionCalls,
      signal
    );

    <span class="hljs-comment">// 3. 处理响应</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseToolResponse</span>(rawResponseParts);
  }
}
</code></pre>
<h4 data-id="heading-10">2.3 Codex 的 MCP 实现架构</h4>
<h5 data-id="heading-11"><strong>核心组件</strong> (基于 Rust):</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// codex-rs/core/src/mcp_connection_manager.rs</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">McpConnectionManager</span> {
    clients: HashMap&lt;<span class="hljs-type">String</span>, AsyncManagedClient&gt;,
    elicitation_requests: ElicitationRequestManager,
    tool_timeout: Duration,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">McpConnectionManager</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">connect_server</span>(
        &amp;<span class="hljs-keyword">self</span>,
        server_name: <span class="hljs-type">String</span>,
        config: McpServerConfig
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
        <span class="hljs-comment">// 1. 创建 RmcpClient (Rust MCP Client)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">client</span> = RmcpClient::<span class="hljs-title function_ invoke__">new</span>(
            Implementation {
                name: <span class="hljs-string">"codex"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
                version: <span class="hljs-built_in">env!</span>(<span class="hljs-string">"CARGO_PKG_VERSION"</span>).<span class="hljs-title function_ invoke__">to_string</span>(),
            },
            ClientCapabilities {
                roots: <span class="hljs-title function_ invoke__">Some</span>(RootsCapability { list_changed: <span class="hljs-literal">true</span> }),
                sampling: <span class="hljs-title function_ invoke__">Some</span>(SamplingCapability {}),
            },
        );

        <span class="hljs-comment">// 2. 建立传输连接</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">transport</span> = <span class="hljs-keyword">match</span> &amp;config.transport {
            StdioTransport =&gt; <span class="hljs-title function_ invoke__">create_stdio_transport</span>(config),
            SseTransport =&gt; <span class="hljs-title function_ invoke__">create_sse_transport</span>(config),
        };

        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_ invoke__">connect</span>(transport)?;

        <span class="hljs-comment">// 3. 列举并限定工具</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tools</span> = client.<span class="hljs-title function_ invoke__">list_tools</span>().<span class="hljs-keyword">await</span>?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">qualified_tools</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">qualify_tools</span>(server_name, tools);

        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
}
</code></pre>
<h5 data-id="heading-12"><strong>工具名称限定 (Fully Qualified Names)</strong>:</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// codex-rs/core/src/mcp_connection_manager.rs</span>
<span class="hljs-keyword">const</span> MCP_TOOL_NAME_DELIMITER: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"__"</span>;
<span class="hljs-keyword">const</span> MAX_TOOL_NAME_LENGTH: <span class="hljs-type">usize</span> = <span class="hljs-number">64</span>;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">qualify_tools</span>(tools: <span class="hljs-type">Vec</span>&lt;ToolInfo&gt;) <span class="hljs-punctuation">-&gt;</span> HashMap&lt;<span class="hljs-type">String</span>, ToolInfo&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">qualified_tools</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-keyword">for</span> <span class="hljs-variable">tool</span> <span class="hljs-keyword">in</span> tools {
        <span class="hljs-comment">// 格式: mcp__&lt;server_name&gt;__&lt;tool_name&gt;</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">qualified_name</span> = <span class="hljs-built_in">format!</span>(
            <span class="hljs-string">"mcp{}{}{}{}"</span>,
            MCP_TOOL_NAME_DELIMITER,
            tool.server_name,
            MCP_TOOL_NAME_DELIMITER,
            tool.tool_name
        );

        <span class="hljs-comment">// 超长则使用 SHA1 截断</span>
        <span class="hljs-keyword">if</span> qualified_name.<span class="hljs-title function_ invoke__">len</span>() &gt; MAX_TOOL_NAME_LENGTH {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">hash</span> = sha1::Sha1::<span class="hljs-title function_ invoke__">digest</span>(qualified_name.<span class="hljs-title function_ invoke__">as_bytes</span>());
            qualified_name = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}_{:x}"</span>,
                &amp;qualified_name[..<span class="hljs-number">48</span>],
                hash
            );
        }

        qualified_tools.<span class="hljs-title function_ invoke__">insert</span>(qualified_name, tool);
    }

    qualified_tools
}
</code></pre>
<h4 data-id="heading-13">2.4 MCP 协议消息示例</h4>
<h5 data-id="heading-14"><strong>工具列表请求</strong>:</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-15"><strong>工具列表响应</strong>:</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Read contents of a file"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"path"</span><span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-16"><strong>工具调用请求</strong>:</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/etc/hosts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-17"><strong>工具调用响应</strong>:</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"127.0.0.1 localhost\n::1 localhost"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">三、ACP (Agent Client Protocol) 官方标准深度解析</h3>
<h4 data-id="heading-19">3.1 ACP 协议概述</h4>
<p><strong>ACP (Agent Client Protocol)</strong> 是由 <strong>Zed Industries</strong> 在 <strong>2025 年 8 月</strong>正式发布的开放标准，旨在标准化<strong>代码编辑器/IDE 与 AI 编码代理之间的通信</strong>。</p>
<blockquote>
<p>📖 <strong>官方资源</strong></p>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2F" target="_blank" title="https://agentclientprotocol.com/" ref="nofollow noopener noreferrer">agentclientprotocol.com/</a></li>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Fagent-client-protocol" target="_blank" title="https://github.com/agentclientprotocol/agent-client-protocol" ref="nofollow noopener noreferrer">github.com/agentclient…</a></li>
<li>TypeScript SDK：<code>@agentclientprotocol/sdk</code> (npm)</li>
<li>协议版本：<strong>Version 1</strong> (当前)</li>
</ul>
</blockquote>
<p><strong>核心定位</strong>:
ACP 类似于 <strong>LSP (Language Server Protocol)</strong> 在语言服务器领域的作用，解决了 Agent-Editor 集成的 <strong>N×M 问题</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph before["ACP 之前：N × M 集成问题"]
        E1["Editor1"] --&gt; A1A["Agent1 (定制集成)"]
        E1 --&gt; A2A["Agent2 (定制集成)"]
        E1 --&gt; A3A["Agent3 (定制集成)"]

        E2["Editor2"] --&gt; A1B["Agent1 (重复开发)"]
        E2 --&gt; A2B["Agent2 (重复开发)"]

        style before fill:#ffebee,stroke:#c62828
    end

    subgraph after["ACP 之后：N + M 标准化"]
        Editor1["Editor1"] --&gt; ACP["ACP 协议层"]
        Editor2["Editor2"] --&gt; ACP
        Editor3["Editor3"] --&gt; ACP

        ACP --&gt; Agent1["Agent1"]
        ACP --&gt; Agent2["Agent2"]
        ACP --&gt; Agent3["Agent3"]

        style after fill:#e8f5e9,stroke:#2e7d32
        style ACP fill:#e3f2fd,stroke:#1565c0
    end
</code></pre>
<p><strong>核心设计理念</strong>:</p>
<ul>
<li>📝 <strong>标准化通信</strong>: 基于 JSON-RPC 2.0，使用 stdio 传输</li>
<li>🔌 <strong>即插即用</strong>: 任何支持 ACP 的编辑器都能使用任何 ACP 代理</li>
<li>🎯 <strong>代理自主性</strong>: 代理作为编辑器的子进程运行，可自主修改代码</li>
<li>🔐 <strong>权限控制</strong>: 明确的权限请求机制（文件系统、终端等）</li>
<li>🔄 <strong>会话管理</strong>: 支持会话创建、加载、状态追踪</li>
<li>📊 <strong>能力协商</strong>: 初始化时协商双方支持的功能</li>
</ul>
<h4 data-id="heading-20">3.2 ACP 协议架构</h4>
<h5 data-id="heading-21"><strong>通信模型</strong></h5>
<p>ACP 遵循 <strong>JSON-RPC 2.0</strong> 规范，定义了两种消息类型：</p>




















<table><thead><tr><th>消息类型</th><th>描述</th><th>是否需要响应</th></tr></thead><tbody><tr><td><strong>Methods</strong></td><td>请求-响应对，期望返回结果或错误</td><td>✅ 是</td></tr><tr><td><strong>Notifications</strong></td><td>单向消息，用于事件通知</td><td>❌ 否</td></tr></tbody></table>
<h5 data-id="heading-22"><strong>角色定义</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Agent：使用生成式 AI 自主修改代码的程序</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Agent</span> {
  <span class="hljs-comment">// === 基线方法（必须实现） ===</span>
  <span class="hljs-title function_">initialize</span>(): <span class="hljs-title class_">InitializeResult</span>;           <span class="hljs-comment">// 初始化和能力协商</span>
  authenticate?(): <span class="hljs-title class_">AuthResult</span>;              <span class="hljs-comment">// 身份验证（可选）</span>
  <span class="hljs-string">'session/new'</span>(): <span class="hljs-title class_">SessionId</span>;              <span class="hljs-comment">// 创建新会话</span>
  <span class="hljs-string">'session/prompt'</span>(<span class="hljs-attr">msg</span>: <span class="hljs-title class_">Message</span>): <span class="hljs-built_in">void</span>;    <span class="hljs-comment">// 接收用户提示词</span>

  <span class="hljs-comment">// === 可选方法 ===</span>
  <span class="hljs-string">'session/load'</span>?(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Session</span>;    <span class="hljs-comment">// 加载已有会话</span>
  <span class="hljs-string">'session/set_mode'</span>?(<span class="hljs-attr">mode</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 设置模式（如 edit/chat）</span>

  <span class="hljs-comment">// === 通知 ===</span>
  <span class="hljs-string">'session/cancel'</span>(): <span class="hljs-built_in">void</span>;                <span class="hljs-comment">// 取消当前操作</span>
}

<span class="hljs-comment">// Client：提供用户界面的代码编辑器/IDE</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Client</span> {
  <span class="hljs-comment">// === 基线方法（必须实现） ===</span>
  <span class="hljs-string">'session/request_permission'</span>(<span class="hljs-attr">req</span>: <span class="hljs-title class_">PermissionRequest</span>): <span class="hljs-title class_">PermissionResult</span>;

  <span class="hljs-comment">// === 可选方法（根据能力） ===</span>
  <span class="hljs-string">'fs/read_text_file'</span>?(<span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span>;
  <span class="hljs-string">'fs/write_text_file'</span>?(<span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;
  <span class="hljs-string">'terminal/create'</span>?(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">TerminalId</span>;
  <span class="hljs-string">'terminal/output'</span>?(<span class="hljs-attr">id</span>: <span class="hljs-title class_">TerminalId</span>): <span class="hljs-title class_">TerminalOutput</span>;

  <span class="hljs-comment">// === 通知 ===</span>
  <span class="hljs-string">'session/update'</span>(<span class="hljs-attr">update</span>: <span class="hljs-title class_">SessionUpdate</span>): <span class="hljs-built_in">void</span>;  <span class="hljs-comment">// 会话状态更新</span>
}
</code></pre>
<h4 data-id="heading-23">3.3 ACP 核心流程</h4>
<h5 data-id="heading-24"><strong>1. 初始化流程</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Client → Agent</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"initialize"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"protocolVersion"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"clientCapabilities"</span>: {
      <span class="hljs-string">"fs"</span>: {
        <span class="hljs-string">"readTextFile"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"writeTextFile"</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-string">"terminal"</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-string">"clientInfo"</span>: {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"vscode"</span>,
      <span class="hljs-string">"title"</span>: <span class="hljs-string">"Visual Studio Code"</span>,
      <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.95.0"</span>
    }
  }
}

<span class="hljs-comment">// Agent → Client</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"protocolVersion"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"agentCapabilities"</span>: {
      <span class="hljs-string">"loadSession"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"promptCapabilities"</span>: {
        <span class="hljs-string">"image"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"audio"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"embeddedContext"</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-string">"mcp"</span>: {
        <span class="hljs-string">"http"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"sse"</span>: <span class="hljs-literal">false</span>
      }
    },
    <span class="hljs-string">"agentInfo"</span>: {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"claude-agent"</span>,
      <span class="hljs-string">"title"</span>: <span class="hljs-string">"Claude Code Agent"</span>,
      <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>
    },
    <span class="hljs-string">"authMethods"</span>: []
  }
}
</code></pre>
<p><strong>关键要求</strong>:</p>
<ul>
<li>🔢 <strong>协议版本协商</strong>: Client 提供支持的最新版本，Agent 响应选定版本</li>
<li>🎛️ <strong>能力声明</strong>: 双方明确声明支持的功能（文件系统、终端、MCP 等）</li>
<li>⚙️ <strong>向后兼容</strong>: 未声明的能力视为不支持</li>
</ul>
<h5 data-id="heading-25"><strong>2. 会话管理流程</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建新会话</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"session/new"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"workspaceRoot"</span>: <span class="hljs-string">"/Users/pojian/code/project"</span>,
    <span class="hljs-string">"capabilities"</span>: {
      <span class="hljs-string">"edit"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"execute"</span>: <span class="hljs-literal">true</span>
    }
  }
}

<span class="hljs-comment">// 响应</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"sessionId"</span>: <span class="hljs-string">"sess_abc123"</span>,
    <span class="hljs-string">"state"</span>: <span class="hljs-string">"ready"</span>
  }
}
</code></pre>
<h5 data-id="heading-26"><strong>3. 提示词交互流程</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Client → Agent: 发送用户提示词</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"session/prompt"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"sessionId"</span>: <span class="hljs-string">"sess_abc123"</span>,
    <span class="hljs-string">"message"</span>: {
      <span class="hljs-string">"parts"</span>: [
        {
          <span class="hljs-string">"kind"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"重构这个函数以提高性能"</span>
        },
        {
          <span class="hljs-string">"kind"</span>: <span class="hljs-string">"resource_link"</span>,
          <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/pojian/code/project/src/utils.ts"</span>,
          <span class="hljs-string">"lineRange"</span>: { <span class="hljs-string">"start"</span>: <span class="hljs-number">10</span>, <span class="hljs-string">"end"</span>: <span class="hljs-number">25</span> }
        }
      ]
    }
  }
}

<span class="hljs-comment">// Agent → Client: 实时状态更新（通知）</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"session/update"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"sessionId"</span>: <span class="hljs-string">"sess_abc123"</span>,
    <span class="hljs-string">"update"</span>: {
      <span class="hljs-string">"kind"</span>: <span class="hljs-string">"agent_message_chunk"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"我来分析这个函数的性能瓶颈..."</span>
    }
  }
}

<span class="hljs-comment">// Agent → Client: 请求权限</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"session/request_permission"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"sessionId"</span>: <span class="hljs-string">"sess_abc123"</span>,
    <span class="hljs-string">"permission"</span>: {
      <span class="hljs-string">"kind"</span>: <span class="hljs-string">"file_write"</span>,
      <span class="hljs-string">"path"</span>: <span class="hljs-string">"/Users/pojian/code/project/src/utils.ts"</span>,
      <span class="hljs-string">"preview"</span>: <span class="hljs-string">"--- a/utils.ts\n+++ b/utils.ts\n..."</span>
    }
  }
}

<span class="hljs-comment">// Client → Agent: 权限响应</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"granted"</span>: <span class="hljs-literal">true</span>
  }
}

<span class="hljs-comment">// Agent → Client: 完成状态</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"session/update"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"sessionId"</span>: <span class="hljs-string">"sess_abc123"</span>,
    <span class="hljs-string">"update"</span>: {
      <span class="hljs-string">"kind"</span>: <span class="hljs-string">"state_change"</span>,
      <span class="hljs-string">"state"</span>: <span class="hljs-string">"completed"</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">3.4 ACP 能力系统</h4>
<h5 data-id="heading-28"><strong>Client 能力</strong></h5>





























<table><thead><tr><th>能力域</th><th>能力</th><th>描述</th><th>关联方法</th></tr></thead><tbody><tr><td><strong>文件系统</strong></td><td><code>fs.readTextFile</code></td><td>读取文本文件</td><td><code>fs/read_text_file</code></td></tr><tr><td/><td><code>fs.writeTextFile</code></td><td>写入文本文件</td><td><code>fs/write_text_file</code></td></tr><tr><td><strong>终端</strong></td><td><code>terminal</code></td><td>执行和管理 Shell 命令</td><td><code>terminal/*</code> 全系列方法</td></tr></tbody></table>
<h5 data-id="heading-29"><strong>Agent 能力</strong></h5>








































<table><thead><tr><th>能力域</th><th>能力</th><th>描述</th></tr></thead><tbody><tr><td><strong>会话</strong></td><td><code>loadSession</code></td><td>支持加载已有会话</td></tr><tr><td><strong>提示词</strong></td><td><code>image</code></td><td>支持图像输入</td></tr><tr><td/><td><code>audio</code></td><td>支持音频输入</td></tr><tr><td/><td><code>embeddedContext</code></td><td>支持嵌入式上下文资源</td></tr><tr><td><strong>MCP</strong></td><td><code>http</code></td><td>支持 HTTP 传输的 MCP 服务器</td></tr><tr><td/><td><code>sse</code></td><td>支持 SSE 传输的 MCP 服务器（已弃用）</td></tr></tbody></table>
<h4 data-id="heading-30">3.5 ACP 协议约定</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 关键约定</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ACP_CONVENTIONS</span> = {
  <span class="hljs-comment">// 1. 路径要求</span>
  <span class="hljs-attr">filePaths</span>: <span class="hljs-string">"MUST be absolute"</span>,  <span class="hljs-comment">// 所有文件路径必须是绝对路径</span>

  <span class="hljs-comment">// 2. 行号约定</span>
  <span class="hljs-attr">lineNumbers</span>: <span class="hljs-string">"1-based"</span>,  <span class="hljs-comment">// 行号从 1 开始</span>

  <span class="hljs-comment">// 3. 文本格式</span>
  <span class="hljs-attr">textFormat</span>: <span class="hljs-string">"Markdown"</span>,  <span class="hljs-comment">// 默认使用 Markdown 格式</span>

  <span class="hljs-comment">// 4. 扩展机制</span>
  <span class="hljs-attr">customMethods</span>: <span class="hljs-string">"prefix with underscore (_method_name)"</span>,
  <span class="hljs-attr">customData</span>: <span class="hljs-string">"use _meta field"</span>,

  <span class="hljs-comment">// 5. 错误处理</span>
  <span class="hljs-attr">errorHandling</span>: <span class="hljs-string">"JSON-RPC 2.0 standard (code + message)"</span>
};
</code></pre>
<hr/>
<h3 data-id="heading-31">四、A2A (Agent-to-Agent) 深度剖析：Multi-Agent 系统的探索</h3>
<h4 data-id="heading-32">4.0 A2A 概述与设计哲学</h4>
<p><strong>A2A (Agent-to-Agent Protocol)</strong> 是 Google Gemini CLI 团队提出的实验性协议，专注于解决 <strong>Multi-Agent 系统</strong>中的核心挑战：如何让不同的 Agent 无缝协作、状态同步和任务编排。</p>
<blockquote>
<p>🎯 <strong>核心价值主张</strong></p>
<p>虽然 ACP 解决了 Editor ↔ Agent 的标准化，MCP 解决了 Agent ↔ Tools 的标准化，但 <strong>Agent ↔ Agent</strong> 的协作仍是空白地带。A2A 正是为填补这一空白而生。</p>
</blockquote>
<h5 data-id="heading-33"><strong>A2A 的三大设计支柱</strong></h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A2A["A2A 设计哲学"]

    A2A --&gt; P1["1️⃣ Event-Driven Architecture&lt;br/&gt;事件驱动"]
    A2A --&gt; P2["2️⃣ Stateful Task Management&lt;br/&gt;有状态任务管理"]
    A2A --&gt; P3["3️⃣ HTTP + SSE Hybrid Transport&lt;br/&gt;混合传输"]

    P1 --&gt; P1A["通过 EventBus 实现松耦合"]
    P1 --&gt; P1B["Agent 只需订阅感兴趣的事件"]
    P1 --&gt; P1C["支持流式和实时状态更新"]

    P2 --&gt; P2A["任务可持久化和恢复"]
    P2 --&gt; P2B["完整的状态转换历史"]
    P2 --&gt; P2C["支持长时间运行的复杂任务"]

    P3 --&gt; P3A["HTTP 用于 Request/Response"]
    P3 --&gt; P3B["SSE 用于实时事件推送"]
    P3 --&gt; P3C["天然支持跨网络的 Agent 协作"]

    style A2A fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    style P1 fill:#fff3e0,stroke:#e65100
    style P2 fill:#f3e5f5,stroke:#4a148c
    style P3 fill:#e8f5e9,stroke:#1b5e20
</code></pre>
<h5 data-id="heading-34"><strong>为什么需要 A2A？</strong></h5>






























<table><thead><tr><th>场景</th><th>传统方案的痛点</th><th>A2A 的解决方案</th></tr></thead><tbody><tr><td><strong>Multi-Agent 协作</strong></td><td>每个 Agent 使用私有 API，无法互操作</td><td>统一的 AgentCard + Task API</td></tr><tr><td><strong>长时间任务</strong></td><td>同步调用易超时，状态无法追踪</td><td>异步 Task + 状态机管理</td></tr><tr><td><strong>实时反馈</strong></td><td>只能轮询或等待最终结果</td><td>SSE 流式推送中间状态</td></tr><tr><td><strong>Agent 发现</strong></td><td>硬编码 Agent 地址和能力</td><td>AgentCard 动态发现和能力协商</td></tr></tbody></table>
<h4 data-id="heading-35">4.1 A2A 核心架构组件</h4>
<h5 data-id="heading-36"><strong>1. AgentCard - Agent 身份与能力声明</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/http/app.ts</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">agentCard</span>: <span class="hljs-title class_">AgentCard</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Gemini SDLC Agent'</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">'Code generation agent with streaming support'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:41242/'</span>,
  <span class="hljs-attr">protocolVersion</span>: <span class="hljs-string">'0.3.0'</span>,

  <span class="hljs-attr">capabilities</span>: {
    <span class="hljs-attr">streaming</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 支持流式输出</span>
    <span class="hljs-attr">pushNotifications</span>: <span class="hljs-literal">false</span>,     <span class="hljs-comment">// 不支持推送</span>
    <span class="hljs-attr">stateTransitionHistory</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 支持状态历史</span>
  },

  <span class="hljs-attr">skills</span>: [
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'code_generation'</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Code Generation'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Generate code from natural language'</span>,
      <span class="hljs-attr">tags</span>: [<span class="hljs-string">'code'</span>, <span class="hljs-string">'development'</span>],
      <span class="hljs-attr">inputModes</span>: [<span class="hljs-string">'text'</span>],
      <span class="hljs-attr">outputModes</span>: [<span class="hljs-string">'text'</span>],
      <span class="hljs-attr">examples</span>: [
        <span class="hljs-string">'Write a Python function to calculate fibonacci'</span>,
        <span class="hljs-string">'Create a REST API with authentication'</span>
      ]
    }
  ]
};
</code></pre>
<p><strong>AgentCard 的关键字段解析</strong>:</p>








































<table><thead><tr><th>字段</th><th>作用</th><th>示例值</th></tr></thead><tbody><tr><td><code>name</code></td><td>Agent 的唯一标识符</td><td>"Gemini SDLC Agent"</td></tr><tr><td><code>url</code></td><td>Agent 的 HTTP 端点</td><td>"<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A41242%2F" target="_blank" title="http://localhost:41242/" ref="nofollow noopener noreferrer">http://localhost:41242/</a>"</td></tr><tr><td><code>protocolVersion</code></td><td>A2A 协议版本</td><td>"0.3.0"</td></tr><tr><td><code>capabilities.streaming</code></td><td>是否支持 SSE 流式输出</td><td><code>true</code></td></tr><tr><td><code>capabilities.stateTransitionHistory</code></td><td>是否保留状态历史</td><td><code>true</code></td></tr><tr><td><code>skills[]</code></td><td>Agent 擅长的技能列表</td><td>代码生成、测试、重构等</td></tr></tbody></table>
<h5 data-id="heading-37"><strong>2. 任务状态机 - 生命周期管理</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 基于 @a2a-js/sdk 的 TaskState</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TaskState</span> =
  | <span class="hljs-string">'submitted'</span>       <span class="hljs-comment">// 已提交</span>
  | <span class="hljs-string">'working'</span>         <span class="hljs-comment">// 执行中</span>
  | <span class="hljs-string">'input-required'</span>  <span class="hljs-comment">// 等待输入</span>
  | <span class="hljs-string">'completed'</span>       <span class="hljs-comment">// 已完成</span>
  | <span class="hljs-string">'failed'</span>          <span class="hljs-comment">// 失败</span>
  | <span class="hljs-string">'canceled'</span>;       <span class="hljs-comment">// 取消</span>

<span class="hljs-comment">// 状态转换流程</span>
submitted → working → input-required → working → completed
                                    ↓
                                  failed
                                    ↓
                                 canceled
</code></pre>
<p><strong>状态转换详解</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/types.ts</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaskMetadata</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;                    <span class="hljs-comment">// 任务唯一 ID</span>
  <span class="hljs-attr">contextId</span>: <span class="hljs-built_in">string</span>;             <span class="hljs-comment">// 所属会话 ID</span>
  <span class="hljs-attr">taskState</span>: <span class="hljs-title class_">TaskState</span>;          <span class="hljs-comment">// 当前状态</span>
  <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;                 <span class="hljs-comment">// 使用的 LLM 模型</span>
  <span class="hljs-attr">mcpServers</span>: <span class="hljs-title class_">MCPServerInfo</span>[];   <span class="hljs-comment">// 可用的 MCP 服务器列表</span>
  <span class="hljs-attr">availableTools</span>: <span class="hljs-title class_">ToolInfo</span>[];    <span class="hljs-comment">// 可调用的工具列表</span>
}

<span class="hljs-comment">// 状态转换触发器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
  <span class="hljs-title function_">setTaskState</span>(<span class="hljs-params">newState: TaskState</span>) {
    <span class="hljs-keyword">const</span> oldState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">metadata</span>.<span class="hljs-property">taskState</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">metadata</span>.<span class="hljs-property">taskState</span> = newState;

    <span class="hljs-comment">// 记录状态历史（如果开启）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">capabilities</span>.<span class="hljs-property">stateTransitionHistory</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateHistory</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">from</span>: oldState,
        <span class="hljs-attr">to</span>: newState,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">reason</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">transitionReason</span>
      });
    }

    <span class="hljs-comment">// 触发状态变更事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">publish</span>({
      <span class="hljs-attr">kind</span>: <span class="hljs-title class_">CoderAgentEvent</span>.<span class="hljs-property">StateChangeEvent</span>,
      <span class="hljs-attr">taskId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
      oldState,
      newState,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
  }
}
</code></pre>
<p><strong>关键状态说明</strong>:</p>















































<table><thead><tr><th>状态</th><th>含义</th><th>典型持续时间</th><th>下一状态</th></tr></thead><tbody><tr><td><code>submitted</code></td><td>任务已提交但未开始执行</td><td>0-50ms</td><td><code>working</code></td></tr><tr><td><code>working</code></td><td>LLM 正在生成响应或执行工具调用</td><td>数秒到数分钟</td><td><code>input-required</code> / <code>completed</code> / <code>failed</code></td></tr><tr><td><code>input-required</code></td><td>等待用户确认工具调用或提供额外输入</td><td>取决于用户</td><td><code>working</code> / <code>canceled</code></td></tr><tr><td><code>completed</code></td><td>任务成功完成</td><td>终态</td><td>-</td></tr><tr><td><code>failed</code></td><td>任务执行失败</td><td>终态</td><td>-</td></tr><tr><td><code>canceled</code></td><td>用户主动取消</td><td>终态</td><td>-</td></tr></tbody></table>
<h5 data-id="heading-38"><strong>3. EventBus - 事件驱动核心</strong></h5>
<p>A2A 的 EventBus 是整个系统的神经中枢，负责：</p>
<ul>
<li>📡 <strong>解耦组件</strong>：Agent、Task、Tool 之间通过事件通信</li>
<li>🔄 <strong>流式传输</strong>：通过 SSE 实时推送事件到客户端</li>
<li>📊 <strong>状态追踪</strong>：所有状态变化都通过事件记录</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/agent/executor.ts</span>

<span class="hljs-comment">// EventBus 事件类型定义</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">CoderAgentEvent</span> {
  <span class="hljs-title class_">ToolCallConfirmationEvent</span> = <span class="hljs-string">'tool-call-confirmation'</span>,  <span class="hljs-comment">// 请求工具确认</span>
  <span class="hljs-title class_">ToolCallUpdateEvent</span> = <span class="hljs-string">'tool-call-update'</span>,              <span class="hljs-comment">// 工具调用状态更新</span>
  <span class="hljs-title class_">TextContentEvent</span> = <span class="hljs-string">'text-content'</span>,                     <span class="hljs-comment">// LLM 生成的文本</span>
  <span class="hljs-title class_">StateChangeEvent</span> = <span class="hljs-string">'state-change'</span>,                     <span class="hljs-comment">// 任务状态变更</span>
  <span class="hljs-title class_">ThoughtEvent</span> = <span class="hljs-string">'thought'</span>,                              <span class="hljs-comment">// Agent 的思考过程</span>
}

<span class="hljs-comment">// EventBus 实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutionEventBus</span> {
  <span class="hljs-keyword">private</span> listeners = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">EventListener</span>&gt;&gt;();
  <span class="hljs-keyword">private</span> sseClients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">SSEClient</span>&gt;();

  <span class="hljs-comment">// 发布事件</span>
  <span class="hljs-title function_">publish</span>(<span class="hljs-params">event: CoderAgentMessage</span>) {
    <span class="hljs-comment">// 1. 通知本地监听器</span>
    <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(event.<span class="hljs-property">kind</span>) || <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>(event));

    <span class="hljs-comment">// 2. 通过 SSE 推送给客户端</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseClients</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">client</span> =&gt;</span> {
      client.<span class="hljs-title function_">send</span>({
        <span class="hljs-attr">event</span>: event.<span class="hljs-property">kind</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(event)
      });
    });

    <span class="hljs-comment">// 3. 持久化到数据库（可选）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">persistenceEnabled</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveEvent</span>(event);
    }
  }

  <span class="hljs-comment">// 订阅事件</span>
  <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">eventType: CoderAgentEvent, listener: EventListener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(eventType)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(eventType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(eventType)!.<span class="hljs-title function_">add</span>(listener);
  }

  <span class="hljs-comment">// 添加 SSE 客户端</span>
  <span class="hljs-title function_">addSSEClient</span>(<span class="hljs-params">client: SSEClient</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sseClients</span>.<span class="hljs-title function_">add</span>(client);

    <span class="hljs-comment">// 发送历史事件（如果需要）</span>
    <span class="hljs-keyword">if</span> (client.<span class="hljs-property">wantsHistory</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">replayEvents</span>(client);
    }
  }
}
</code></pre>
<p><strong>EventBus 流式工作流程</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph LLM["LLM Stream 处理流程"]
        Stream["LLM Stream"] --&gt; Chunk1["Chunk 1"]
        Stream --&gt; Chunk2["Chunk 2"]
        Stream --&gt; Chunk3["Chunk 3"]
        Stream --&gt; ToolCall["Tool Call"]

        Chunk1 --&gt; Publish1["EventBus.publish(TextContent)"]
        Chunk2 --&gt; Publish1
        Chunk3 --&gt; Publish1
        ToolCall --&gt; Publish1

        Publish1 --&gt; Local["Local Listeners"]
        Publish1 --&gt; SSE["SSE Clients&lt;br/&gt;(实时推送)"]
        Publish1 --&gt; Persist["Persistence Layer"]

        style LLM fill:#e3f2fd,stroke:#1565c0
    end

    subgraph Tool["Tool Execution 处理流程"]
        ToolExec["Tool Execution"] --&gt; ConfReq["Confirmation Request"]
        ConfReq --&gt; Publish2["EventBus.publish()"]

        UserApproval["User Approval"] --&gt; SetState["setState(working)"]

        ToolResult["Tool Result"] --&gt; Publish3["EventBus.publish()"]

        style Tool fill:#fff3e0,stroke:#e65100
    end

    style Publish1 fill:#c8e6c9,stroke:#2e7d32
    style Publish2 fill:#c8e6c9,stroke:#2e7d32
    style Publish3 fill:#c8e6c9,stroke:#2e7d32
</code></pre>
<h5 data-id="heading-39"><strong>4. 核心执行器 - 编排引擎</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/agent/executor.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoderAgentExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AgentExecutor</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">requestContext: RequestContext, eventBus: ExecutionEventBus</span>) {
    <span class="hljs-keyword">const</span> { userMessage, task } = requestContext;

    <span class="hljs-comment">// 1. 获取或创建任务</span>
    <span class="hljs-keyword">let</span> wrapper = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">get</span>(taskId) || <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createTask</span>(taskId);

    <span class="hljs-comment">// 2. 设置状态为 working</span>
    wrapper.<span class="hljs-property">task</span>.<span class="hljs-title function_">setTaskState</span>(<span class="hljs-string">'working'</span>);
    eventBus.<span class="hljs-title function_">publish</span>({
      <span class="hljs-attr">kind</span>: <span class="hljs-string">'status-update'</span>,
      taskId,
      <span class="hljs-attr">status</span>: { <span class="hljs-attr">state</span>: <span class="hljs-string">'working'</span> },
      <span class="hljs-attr">final</span>: <span class="hljs-literal">false</span>
    });

    <span class="hljs-comment">// 3. 调用 LLM</span>
    <span class="hljs-keyword">const</span> agentEvents = wrapper.<span class="hljs-property">task</span>.<span class="hljs-property">geminiClient</span>.<span class="hljs-title function_">sendMessageStream</span>(
      userMessage.<span class="hljs-property">parts</span>,
      abortSignal
    );

    <span class="hljs-comment">// 4. 处理 Agent 响应</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> agentEvents) {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">'tool_call_request'</span>) {
        <span class="hljs-comment">// 调度工具执行</span>
        <span class="hljs-keyword">await</span> wrapper.<span class="hljs-property">task</span>.<span class="hljs-title function_">scheduleToolCalls</span>(event.<span class="hljs-property">toolCalls</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">'content'</span>) {
        <span class="hljs-comment">// 发布文本内容</span>
        eventBus.<span class="hljs-title function_">publish</span>({
          <span class="hljs-attr">kind</span>: <span class="hljs-string">'status-update'</span>,
          <span class="hljs-attr">status</span>: {
            <span class="hljs-attr">state</span>: <span class="hljs-string">'working'</span>,
            <span class="hljs-attr">message</span>: { <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">kind</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: event.<span class="hljs-property">content</span> }] }
          }
        });
      }
    }

    <span class="hljs-comment">// 5. 等待工具执行完成</span>
    <span class="hljs-keyword">await</span> wrapper.<span class="hljs-property">task</span>.<span class="hljs-title function_">waitForPendingTools</span>();

    <span class="hljs-comment">// 6. 设置状态为 input-required</span>
    wrapper.<span class="hljs-property">task</span>.<span class="hljs-title function_">setTaskState</span>(<span class="hljs-string">'input-required'</span>);
    eventBus.<span class="hljs-title function_">publish</span>({
      <span class="hljs-attr">kind</span>: <span class="hljs-string">'status-update'</span>,
      <span class="hljs-attr">status</span>: { <span class="hljs-attr">state</span>: <span class="hljs-string">'input-required'</span> },
      <span class="hljs-attr">final</span>: <span class="hljs-literal">true</span>
    });
  }
}
</code></pre>
<p><strong>执行器的核心职责</strong>:</p>
<ol>
<li>📝 <strong>任务生命周期管理</strong>：从 submitted 到终态的完整流程控制</li>
<li>🔄 <strong>流式响应处理</strong>：实时处理 LLM 的 streaming output</li>
<li>🛠️ <strong>工具调度编排</strong>：管理并发的工具调用请求</li>
<li>📡 <strong>事件发布</strong>：将所有状态变化通过 EventBus 广播</li>
<li>💾 <strong>状态持久化</strong>：支持任务暂停和恢复</li>
</ol>
<h5 data-id="heading-40"><strong>5. Tool Scheduling - 工具调度机制</strong></h5>
<p>A2A 的工具调度是其核心能力之一，支持：</p>
<ul>
<li>⚡ <strong>并发执行</strong>：多个工具可以并行调用</li>
<li>🔄 <strong>依赖管理</strong>：自动处理工具间的依赖关系</li>
<li>⏸️ <strong>暂停/恢复</strong>：可以中断工具执行并稍后恢复</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/agent/task.ts</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
  <span class="hljs-keyword">private</span> pendingTools = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ToolExecution</span>&gt;();
  <span class="hljs-keyword">private</span> <span class="hljs-attr">toolQueue</span>: <span class="hljs-title class_">ToolCall</span>[] = [];

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">scheduleToolCalls</span>(<span class="hljs-params">toolCalls: ToolCall[]</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> toolCalls) {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">execution</span>: <span class="hljs-title class_">ToolExecution</span> = {
        <span class="hljs-attr">id</span>: toolCall.<span class="hljs-property">id</span>,
        <span class="hljs-attr">toolName</span>: toolCall.<span class="hljs-property">name</span>,
        <span class="hljs-attr">args</span>: toolCall.<span class="hljs-property">arguments</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span>,
        <span class="hljs-attr">startTime</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">endTime</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">result</span>: <span class="hljs-literal">null</span>
      };

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingTools</span>.<span class="hljs-title function_">set</span>(toolCall.<span class="hljs-property">id</span>, execution);

      <span class="hljs-comment">// 检查是否需要用户确认</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldConfirmTool</span>(toolCall.<span class="hljs-property">name</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">publish</span>({
          <span class="hljs-attr">kind</span>: <span class="hljs-title class_">CoderAgentEvent</span>.<span class="hljs-property">ToolCallConfirmationEvent</span>,
          <span class="hljs-attr">taskId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
          <span class="hljs-attr">toolCall</span>: {
            <span class="hljs-attr">id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">name</span>: toolCall.<span class="hljs-property">name</span>,
            <span class="hljs-attr">arguments</span>: toolCall.<span class="hljs-property">arguments</span>,
            <span class="hljs-attr">description</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getToolDescription</span>(toolCall.<span class="hljs-property">name</span>)
          }
        });
        execution.<span class="hljs-property">status</span> = <span class="hljs-string">'awaiting_confirmation'</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 自动批准，立即执行</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeToolCall</span>(toolCall);
      }
    }
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeToolCall</span>(<span class="hljs-params">toolCall: ToolCall</span>) {
    <span class="hljs-keyword">const</span> execution = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingTools</span>.<span class="hljs-title function_">get</span>(toolCall.<span class="hljs-property">id</span>)!;
    execution.<span class="hljs-property">status</span> = <span class="hljs-string">'running'</span>;
    execution.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-comment">// 发布开始事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">publish</span>({
      <span class="hljs-attr">kind</span>: <span class="hljs-title class_">CoderAgentEvent</span>.<span class="hljs-property">ToolCallUpdateEvent</span>,
      <span class="hljs-attr">taskId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
      <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">id</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-string">'running'</span>
    });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用 MCP 工具</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mcpClient</span>.<span class="hljs-title function_">callTool</span>(
        toolCall.<span class="hljs-property">name</span>,
        toolCall.<span class="hljs-property">arguments</span>
      );

      execution.<span class="hljs-property">status</span> = <span class="hljs-string">'completed'</span>;
      execution.<span class="hljs-property">result</span> = result;
      execution.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

      <span class="hljs-comment">// 发布完成事件</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">publish</span>({
        <span class="hljs-attr">kind</span>: <span class="hljs-title class_">CoderAgentEvent</span>.<span class="hljs-property">ToolCallUpdateEvent</span>,
        <span class="hljs-attr">taskId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
        <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">id</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">'completed'</span>,
        <span class="hljs-attr">result</span>: result,
        <span class="hljs-attr">duration</span>: execution.<span class="hljs-property">endTime</span> - execution.<span class="hljs-property">startTime</span>
      });

      <span class="hljs-comment">// 从 pending 移除</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingTools</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">id</span>);

    } <span class="hljs-keyword">catch</span> (error) {
      execution.<span class="hljs-property">status</span> = <span class="hljs-string">'failed'</span>;
      execution.<span class="hljs-property">error</span> = error.<span class="hljs-property">message</span>;
      execution.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">publish</span>({
        <span class="hljs-attr">kind</span>: <span class="hljs-title class_">CoderAgentEvent</span>.<span class="hljs-property">ToolCallUpdateEvent</span>,
        <span class="hljs-attr">taskId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
        <span class="hljs-attr">toolCallId</span>: toolCall.<span class="hljs-property">id</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">'failed'</span>,
        <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>
      });

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingTools</span>.<span class="hljs-title function_">delete</span>(toolCall.<span class="hljs-property">id</span>);
    }
  }

  <span class="hljs-comment">// 等待所有待处理的工具完成</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">waitForPendingTools</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingTools</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    }
  }
}
</code></pre>
<p><strong>工具调度流程图</strong>:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    LLM["LLM: I need to call tools A, B, C"] --&gt; Schedule["scheduleToolCalls([A, B, C])"]

    Schedule --&gt; ToolA["Tool A: Auto-approved"]
    Schedule --&gt; ToolB["Tool B: Needs confirmation"]
    Schedule --&gt; ToolC["Tool C: Auto-approved"]

    ToolA --&gt; ExecA["executeToolCall(A)"]
    ExecA --&gt; MCPA["MCP Server"]

    ToolB --&gt; ConfEvent["Publish ConfirmationEvent"]
    ConfEvent --&gt; WaitApproval["Wait for user approval"]
    WaitApproval --&gt; ExecB["executeToolCall(B)"]
    ExecB --&gt; MCPB["MCP Server"]

    ToolC --&gt; ExecC["executeToolCall(C)"]
    ExecC --&gt; MCPC["MCP Server"]

    MCPA --&gt; Complete["All tools completed"]
    MCPB --&gt; Complete
    MCPC --&gt; Complete

    Complete --&gt; Continue["LLM continues"]

    style LLM fill:#e1f5fe,stroke:#01579b
    style Schedule fill:#fff3e0,stroke:#e65100
    style ToolA fill:#c8e6c9,stroke:#2e7d32
    style ToolB fill:#ffcdd2,stroke:#c62828
    style ToolC fill:#c8e6c9,stroke:#2e7d32
    style Complete fill:#e1bee7,stroke:#6a1b9a
    style Continue fill:#e1f5fe,stroke:#01579b

    %% 注释：A 和 C 并发执行，B 需要等待确认
</code></pre>
<h4 data-id="heading-41">4.2 A2A 与 MCP 的深度集成</h4>
<p>A2A 并非孤立协议，它巧妙地将 MCP 整合为底层工具层，形成<strong>两层协议栈</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Layer3["Layer 3: Agent Orchestration (A2A)"]
        A3A["Agent discovery&lt;br/&gt;(AgentCard)"]
        A3B["Task management&lt;br/&gt;(TaskState)"]
        A3C["Event streaming&lt;br/&gt;(EventBus + SSE)"]

        style Layer3 fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    end

    subgraph Layer2["Layer 2: Tool Interface (MCP)"]
        A2A["Tool discovery&lt;br/&gt;(tools/list)"]
        A2B["Tool execution&lt;br/&gt;(tools/call)"]
        A2C["Resource access&lt;br/&gt;(resources/read)"]

        style Layer2 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    end

    subgraph Layer1["Layer 1: Transport Layer"]
        A1A["JSON-RPC 2.0&lt;br/&gt;(for MCP)"]
        A1B["HTTP + SSE&lt;br/&gt;(for A2A)"]
        A1C["stdio / HTTP / SSE"]

        style Layer1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    end

    Layer3 --&gt; Layer2
    Layer2 --&gt; Layer1

    style A3A fill:#b3e5fc,stroke:#01579b
    style A3B fill:#b3e5fc,stroke:#01579b
    style A3C fill:#b3e5fc,stroke:#01579b
    style A2A fill:#ffe0b2,stroke:#e65100
    style A2B fill:#ffe0b2,stroke:#e65100
    style A2C fill:#ffe0b2,stroke:#e65100
</code></pre>
<p><strong>集成实现细节</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/a2a-server/src/agent/task.ts</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
  <span class="hljs-keyword">private</span> mcpClients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">McpClient</span>&gt;();

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initializeMCPServers</span>(<span class="hljs-params">serverConfigs: MCPServerConfig[]</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> serverConfigs) {
      <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpClient</span>(config);

      <span class="hljs-comment">// 连接到 MCP Server</span>
      <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();

      <span class="hljs-comment">// 获取工具列表</span>
      <span class="hljs-keyword">const</span> tools = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">listTools</span>();

      <span class="hljs-comment">// 注册到任务的可用工具</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tool <span class="hljs-keyword">of</span> tools) {
        <span class="hljs-keyword">const</span> qualifiedName = <span class="hljs-string">`mcp__<span class="hljs-subst">${config.name}</span>__<span class="hljs-subst">${tool.name}</span>`</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">availableTools</span>.<span class="hljs-title function_">set</span>(qualifiedName, {
          <span class="hljs-attr">originalName</span>: tool.<span class="hljs-property">name</span>,
          <span class="hljs-attr">serverName</span>: config.<span class="hljs-property">name</span>,
          <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,
          <span class="hljs-attr">parameterSchema</span>: tool.<span class="hljs-property">inputSchema</span>,
          <span class="hljs-attr">mcpClient</span>: client
        });
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mcpClients</span>.<span class="hljs-title function_">set</span>(config.<span class="hljs-property">name</span>, client);
    }

    <span class="hljs-comment">// 通知 LLM 可用的工具列表（通过 Gemini Function Calling）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">geminiClient</span>.<span class="hljs-title function_">updateTools</span>(
      <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">availableTools</span>.<span class="hljs-title function_">values</span>()).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">tool</span> =&gt;</span> ({
        <span class="hljs-attr">name</span>: tool.<span class="hljs-property">originalName</span>,  <span class="hljs-comment">// Gemini 看到的是原始名称</span>
        <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,
        <span class="hljs-attr">parameters</span>: tool.<span class="hljs-property">parameterSchema</span>
      }))
    );
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">callTool</span>(<span class="hljs-attr">toolName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-comment">// 从qualified name 解析 server 和 tool</span>
    <span class="hljs-keyword">const</span> [_, serverName, originalToolName] = toolName.<span class="hljs-title function_">split</span>(<span class="hljs-string">'__'</span>);

    <span class="hljs-keyword">const</span> toolInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">availableTools</span>.<span class="hljs-title function_">get</span>(toolName);
    <span class="hljs-keyword">if</span> (!toolInfo) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Tool <span class="hljs-subst">${toolName}</span> not found`</span>);
    }

    <span class="hljs-comment">// 调用 MCP Server</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> toolInfo.<span class="hljs-property">mcpClient</span>.<span class="hljs-title function_">callTool</span>(
      originalToolName,
      args
    );

    <span class="hljs-keyword">return</span> result;
  }
}
</code></pre>
<p><strong>工具名称转换策略</strong>:</p>






























<table><thead><tr><th>层级</th><th>工具名称</th><th>说明</th></tr></thead><tbody><tr><td><strong>MCP Server</strong></td><td><code>read_file</code></td><td>MCP 原生工具名</td></tr><tr><td><strong>A2A 内部存储</strong></td><td><code>mcp__filesystem__read_file</code></td><td>带命名空间的限定名</td></tr><tr><td><strong>Gemini LLM</strong></td><td><code>read_file</code></td><td>LLM 看到的简化名（通过 description 区分）</td></tr><tr><td><strong>用户界面</strong></td><td>"读取文件 (filesystem)"</td><td>用户友好的显示名</td></tr></tbody></table>
<h4 data-id="heading-42">4.3 A2A 实战案例：Multi-Agent 协作系统</h4>
<h5 data-id="heading-43"><strong>场景：AI 驱动的全栈应用开发</strong></h5>
<p>假设我们要开发一个包含前端、后端、数据库的完整应用。传统方式是单个 Agent 完成所有工作，但使用 A2A 可以让专业 Agent 协作：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createAgent, <span class="hljs-title class_">AgentOrchestrator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@a2a-js/sdk'</span>;

<span class="hljs-comment">// 1. 定义专业 Agent 团队</span>
<span class="hljs-keyword">const</span> agents = {
  <span class="hljs-comment">// 前端专家</span>
  <span class="hljs-attr">frontendAgent</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Frontend Specialist'</span>,
    <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://localhost:8001/api'</span>,
    <span class="hljs-attr">skills</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'typescript'</span>, <span class="hljs-string">'css'</span>, <span class="hljs-string">'ui-design'</span>]
  }),

  <span class="hljs-comment">// 后端专家</span>
  <span class="hljs-attr">backendAgent</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Backend Specialist'</span>,
    <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://localhost:8002/api'</span>,
    <span class="hljs-attr">skills</span>: [<span class="hljs-string">'nodejs'</span>, <span class="hljs-string">'express'</span>, <span class="hljs-string">'api-design'</span>, <span class="hljs-string">'authentication'</span>]
  }),

  <span class="hljs-comment">// 数据库专家</span>
  <span class="hljs-attr">databaseAgent</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Database Specialist'</span>,
    <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://localhost:8003/api'</span>,
    <span class="hljs-attr">skills</span>: [<span class="hljs-string">'postgresql'</span>, <span class="hljs-string">'schema-design'</span>, <span class="hljs-string">'migrations'</span>, <span class="hljs-string">'optimization'</span>]
  }),

  <span class="hljs-comment">// 测试专家</span>
  <span class="hljs-attr">testAgent</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'QA Specialist'</span>,
    <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://localhost:8004/api'</span>,
    <span class="hljs-attr">skills</span>: [<span class="hljs-string">'jest'</span>, <span class="hljs-string">'e2e-testing'</span>, <span class="hljs-string">'test-strategy'</span>]
  })
};

<span class="hljs-comment">// 2. 创建编排器</span>
<span class="hljs-keyword">const</span> orchestrator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentOrchestrator</span>(agents);

<span class="hljs-comment">// 3. 定义工作流</span>
<span class="hljs-keyword">const</span> workflow = orchestrator.<span class="hljs-title function_">defineWorkflow</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Build E-Commerce App'</span>,

  <span class="hljs-attr">steps</span>: [
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'design-schema'</span>,
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'databaseAgent'</span>,
      <span class="hljs-attr">task</span>: <span class="hljs-string">'设计电商应用的数据库 schema，包括用户、产品、订单表'</span>,
      <span class="hljs-attr">dependencies</span>: []
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'create-migrations'</span>,
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'databaseAgent'</span>,
      <span class="hljs-attr">task</span>: <span class="hljs-string">'创建数据库迁移文件'</span>,
      <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'design-schema'</span>]
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'build-api'</span>,
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'backendAgent'</span>,
      <span class="hljs-attr">task</span>: <span class="hljs-string">'基于数据库 schema 构建 REST API，包括 CRUD 和认证'</span>,
      <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'design-schema'</span>],
      <span class="hljs-attr">inputs</span>: {
        <span class="hljs-attr">schema</span>: <span class="hljs-string">'{{ steps.design-schema.result.schema }}'</span>
      }
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'build-frontend'</span>,
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'frontendAgent'</span>,
      <span class="hljs-attr">task</span>: <span class="hljs-string">'构建 React 前端，连接到 API'</span>,
      <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'build-api'</span>],
      <span class="hljs-attr">inputs</span>: {
        <span class="hljs-attr">apiSpec</span>: <span class="hljs-string">'{{ steps.build-api.result.openapi }}'</span>
      }
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'write-tests'</span>,
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'testAgent'</span>,
      <span class="hljs-attr">task</span>: <span class="hljs-string">'编写端到端测试'</span>,
      <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">'build-frontend'</span>, <span class="hljs-string">'build-api'</span>]
    }
  ]
});

<span class="hljs-comment">// 4. 执行工作流（支持流式监控）</span>
<span class="hljs-keyword">const</span> execution = <span class="hljs-keyword">await</span> orchestrator.<span class="hljs-title function_">execute</span>(workflow);

<span class="hljs-comment">// 5. 订阅事件，实时监控进度</span>
execution.<span class="hljs-title function_">on</span>(<span class="hljs-string">'step-started'</span>, <span class="hljs-function">(<span class="hljs-params">{ stepId, agent }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✨ <span class="hljs-subst">${agent}</span> 开始工作: <span class="hljs-subst">${stepId}</span>`</span>);
});

execution.<span class="hljs-title function_">on</span>(<span class="hljs-string">'step-progress'</span>, <span class="hljs-function">(<span class="hljs-params">{ stepId, progress }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`⏳ <span class="hljs-subst">${stepId}</span>: <span class="hljs-subst">${progress.message}</span>`</span>);
});

execution.<span class="hljs-title function_">on</span>(<span class="hljs-string">'step-completed'</span>, <span class="hljs-function">(<span class="hljs-params">{ stepId, result, duration }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ <span class="hljs-subst">${stepId}</span> 完成 (耗时: <span class="hljs-subst">${duration}</span>ms)`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   输出: <span class="hljs-subst">${result.summary}</span>`</span>);
});

execution.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">{ stepId, error }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ <span class="hljs-subst">${stepId}</span> 失败: <span class="hljs-subst">${error.message}</span>`</span>);
});

<span class="hljs-comment">// 等待完成</span>
<span class="hljs-keyword">const</span> finalResult = <span class="hljs-keyword">await</span> execution.<span class="hljs-title function_">complete</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🎉 全栈应用开发完成！'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`总耗时: <span class="hljs-subst">${finalResult.totalDuration}</span>ms`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`创建的文件数: <span class="hljs-subst">${finalResult.filesCreated}</span>`</span>);
</code></pre>
<p><strong>工作流执行时间线</strong>:</p>
<pre><code class="hljs language-makefile" lang="makefile">Time  Agent              Event
────  ────────────────  ──────────────────────────────────
<span class="hljs-section">00:00 DatabaseAgent     ✨ 开始设计 schema</span>
<span class="hljs-section">00:05 DatabaseAgent       ⏳ 正在分析电商领域模型...</span>
<span class="hljs-section">00:15 DatabaseAgent       ⏳ 生成用户表 schema...</span>
<span class="hljs-section">00:25 DatabaseAgent       ⏳ 生成产品表 schema...</span>
<span class="hljs-section">00:35 DatabaseAgent     ✅ Schema 设计完成</span>

<span class="hljs-section">00:35 DatabaseAgent     ✨ 开始创建迁移文件</span>
<span class="hljs-section">00:38 DatabaseAgent       ⏳ 生成 SQL migration...</span>
<span class="hljs-section">00:42 DatabaseAgent     ✅ 迁移文件创建完成</span>

<span class="hljs-section">00:42 BackendAgent      ✨ 开始构建 API</span>
<span class="hljs-section">00:45 BackendAgent        ⏳ 设置 Express server...</span>
<span class="hljs-section">00:50 BackendAgent        ⏳ 生成 CRUD endpoints...</span>
<span class="hljs-section">01:05 BackendAgent        ⏳ 实现 JWT 认证...</span>
<span class="hljs-section">01:20 BackendAgent      ✅ API 构建完成</span>

<span class="hljs-section">01:20 FrontendAgent     ✨ 开始构建前端</span>
<span class="hljs-section">01:25 FrontendAgent       ⏳ 创建 React 项目结构...</span>
<span class="hljs-section">01:35 FrontendAgent       ⏳ 生成组件代码...</span>
<span class="hljs-section">01:50 FrontendAgent       ⏳ 集成 API client...</span>
<span class="hljs-section">02:10 FrontendAgent     ✅ 前端构建完成</span>

<span class="hljs-section">02:10 TestAgent         ✨ 开始编写测试</span>
<span class="hljs-section">02:15 TestAgent           ⏳ 生成 E2E 测试场景...</span>
<span class="hljs-section">02:30 TestAgent           ⏳ 编写测试代码...</span>
<span class="hljs-section">02:45 TestAgent         ✅ 测试完成</span>

🎉 全栈应用开发完成！
<span class="hljs-section">总耗时: 165秒</span>
<span class="hljs-section">创建的文件数: 47</span>
<span class="hljs-section">测试通过率: 100%</span>
</code></pre>
<h4 data-id="heading-44">4.4 A2A 的核心优势</h4>
<p>与其他协议相比，A2A 在以下方面具有独特优势：</p>













































<table><thead><tr><th>优势</th><th>具体表现</th><th>对比 ACP/MCP</th></tr></thead><tbody><tr><td><strong>🔄 真正的流式体验</strong></td><td>通过 SSE 实时推送 LLM 生成的每个 token</td><td>ACP 也支持流式，MCP 不支持</td></tr><tr><td><strong>📊 完整状态管理</strong></td><td>6 种状态 + 状态转换历史</td><td>ACP 有会话状态，MCP 无状态</td></tr><tr><td><strong>🔌 Multi-Agent 支持</strong></td><td>原生支持 Agent 发现和协作</td><td>ACP 专注 Editor-Agent，MCP 无此概念</td></tr><tr><td><strong>🛠️ MCP 集成</strong></td><td>无缝复用整个 MCP 生态的工具</td><td>ACP 也支持 MCP，但未深度集成</td></tr><tr><td><strong>⚡ 并发工具调用</strong></td><td>可同时执行多个工具，大幅提升效率</td><td>MCP 也支持，但需要自行实现并发控制</td></tr><tr><td><strong>💾 任务持久化</strong></td><td>支持暂停任务，稍后从断点恢复</td><td>ACP 支持 session 加载，MCP 无此能力</td></tr><tr><td><strong>🎯 事件驱动架构</strong></td><td>EventBus 解耦组件，易于扩展</td><td>ACP 使用通知，但没有统一 EventBus</td></tr></tbody></table>
<p><strong>A2A 的适用场景</strong>:</p>
<p>✅ <strong>推荐使用 A2A</strong>:</p>
<ul>
<li>需要多个 Agent 协作完成复杂任务</li>
<li>任务执行时间较长（&gt;30秒），需要中间状态反馈</li>
<li>需要支持任务暂停和恢复</li>
<li>需要完整的审计日志和状态历史</li>
<li>希望复用 MCP 生态的工具</li>
</ul>
<p>❌ <strong>不推荐使用 A2A</strong>:</p>
<ul>
<li>简单的单 Agent 场景（用 ACP 更轻量）</li>
<li>对性能要求极高的场景（Rust 实现的 Codex 更快）</li>
<li>只需要工具调用，不需要 Agent 协作（直接用 MCP）</li>
<li>低延迟要求（&lt;100ms）的实时场景</li>
</ul>
<hr/>
<h4 data-id="heading-45">4.5 Codex 的 SQ/EQ 协议设计</h4>
<blockquote>
<p>⚠️ <strong>注意</strong>: Codex 的实现与 ACP 官方标准也<strong>不同</strong>，采用了独特的 <strong>SQ/EQ (Submission Queue / Event Queue)</strong> 模式。</p>
</blockquote>
<p>Codex 的协议设计：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// codex-rs/protocol/src/protocol.rs</span>

<span class="hljs-comment">/// Submission Queue - 用户提交的操作</span>
<span class="hljs-meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Submission</span> {
    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> op: Op,
}

<span class="hljs-meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="hljs-meta">#[serde(tag = <span class="hljs-string">"type"</span>, rename_all = <span class="hljs-string">"snake_case"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Op</span> {
    <span class="hljs-comment">/// 用户输入</span>
    UserTurn {
        items: <span class="hljs-type">Vec</span>&lt;UserInput&gt;,
        cwd: PathBuf,
        approval_policy: AskForApproval,
        sandbox_policy: SandboxPolicy,
        model: <span class="hljs-type">String</span>,
    },

    <span class="hljs-comment">/// 中断当前任务</span>
    Interrupt,

    <span class="hljs-comment">/// 批准工具执行</span>
    ExecApproval {
        id: <span class="hljs-type">String</span>,
        decision: ReviewDecision,
    },

    <span class="hljs-comment">/// 批准代码补丁</span>
    PatchApproval {
        id: <span class="hljs-type">String</span>,
        decision: ReviewDecision,
    },

    <span class="hljs-comment">/// 解决 MCP 授权请求</span>
    ResolveElicitation {
        server_name: <span class="hljs-type">String</span>,
        request_id: RequestId,
        decision: ElicitationAction,
    },
}

<span class="hljs-comment">/// Event Queue - Agent 发出的事件</span>
<span class="hljs-meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Event</span> {
    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> msg: EventMsg,
}

<span class="hljs-meta">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="hljs-meta">#[serde(tag = <span class="hljs-string">"type"</span>, rename_all = <span class="hljs-string">"snake_case"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EventMsg</span> {
    <span class="hljs-comment">/// Agent 消息</span>
    <span class="hljs-title function_ invoke__">AgentMessage</span>(AgentMessageEvent),

    <span class="hljs-comment">/// 工具调用请求</span>
    <span class="hljs-title function_ invoke__">ToolCall</span>(ToolCallEvent),

    <span class="hljs-comment">/// 需要批准执行</span>
    <span class="hljs-title function_ invoke__">ExecApprovalRequest</span>(ExecApprovalRequestEvent),

    <span class="hljs-comment">/// 需要批准补丁</span>
    <span class="hljs-title function_ invoke__">ApplyPatchApprovalRequest</span>(ApplyPatchApprovalRequestEvent),

    <span class="hljs-comment">/// Turn 完成</span>
    <span class="hljs-title function_ invoke__">TurnComplete</span>(TurnCompleteEvent),

    <span class="hljs-comment">/// Turn 中止</span>
    <span class="hljs-title function_ invoke__">TurnAborted</span>(TurnAbortedEvent),
}
</code></pre>
<h4 data-id="heading-46">4.3 协议关系梳理：ACP vs A2A vs Codex</h4>
<p>为避免混淆，这里明确三者的定位和关系：</p>

































<table><thead><tr><th>协议/实现</th><th>定位</th><th>标准化状态</th><th>主要用途</th><th>实现方</th></tr></thead><tbody><tr><td><strong>ACP (Agent Client Protocol)</strong></td><td>官方标准协议</td><td>✅ 开放标准</td><td>Editor ↔ Agent 通信</td><td>Zed Industries (2025-08)</td></tr><tr><td><strong>A2A (Agent-to-Agent)</strong></td><td>实验性实现</td><td>🔬 非标准</td><td>Agent ↔ Agent 协作</td><td>Google Gemini CLI</td></tr><tr><td><strong>Codex SQ/EQ</strong></td><td>实验性实现</td><td>🔬 非标准</td><td>User ↔ Agent 交互</td><td>OpenAI/社区</td></tr></tbody></table>
<h5 data-id="heading-47"><strong>关键区别</strong></h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Official["官方标准"]
        MCP["MCP (Anthropic)&lt;br/&gt;Agent ↔ Tools"]
        ACP["ACP (Zed)&lt;br/&gt;Editor ↔ Agent"]

        style Official fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
        style MCP fill:#a5d6a7,stroke:#388e3c
        style ACP fill:#a5d6a7,stroke:#388e3c
    end

    subgraph Vendor["厂商实现 (实验性)"]
        A2A["A2A (Google)&lt;br/&gt;Agent ↔ Agent"]
        Codex["Codex SQ/EQ (社区)&lt;br/&gt;User ↔ Agent"]

        style Vendor fill:#fff3e0,stroke:#e65100,stroke-width:2px
        style A2A fill:#ffcc80,stroke:#f57c00
        style Codex fill:#ffcc80,stroke:#f57c00
    end
</code></pre>
<p><strong>为什么会有这种现象？</strong></p>
<ol>
<li><strong>ACP 发布时间线</strong>：ACP 在 2025 年 8 月才正式发布，而 Gemini CLI 和 Codex 的开发更早，当时还没有统一标准</li>
<li><strong>不同的关注点</strong>：
<ul>
<li>ACP 关注 <strong>编辑器集成</strong>（类似 LSP）</li>
<li>A2A 关注 <strong>Agent 编排</strong>（Multi-Agent 系统）</li>
<li>Codex SQ/EQ 关注 <strong>用户体验</strong>（审批流程和安全）</li>
</ul>
</li>
<li><strong>演进方向</strong>：预计未来这些实现可能会向 ACP 标准靠拢或互补</li>
</ol>
<p><strong>对开发者的建议</strong>：</p>
<ul>
<li>✅ 如果开发编辑器插件，优先使用 <strong>ACP 官方标准</strong></li>
<li>🔬 如果研究 Multi-Agent 系统，可以参考 <strong>A2A 的设计思路</strong></li>
<li>🔐 如果注重安全审批，可以借鉴 <strong>Codex 的 Approval 机制</strong></li>
</ul>
<hr/>
<h3 data-id="heading-48">五、核心差异对比：ACP vs MCP vs 各家实现</h3>
<h4 data-id="heading-49">5.1 协议定位对比</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph AppLayer["应用层 - A2A (Agent-to-Agent)"]
        App1["Gemini A2A Server"]
        App2["Agent 协作编排"]
        App3["任务状态管理"]

        style AppLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    end

    subgraph AgentLayer["Agent层 - Codex SQ/EQ Protocol"]
        Agent1["Submission Queue&lt;br/&gt;(用户 → Agent)"]
        Agent2["Event Queue&lt;br/&gt;(Agent → 用户)"]
        Agent3["审批流程 (Approval)"]

        style AgentLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    end

    subgraph ToolLayer["工具层 - MCP (Model Context Protocol)"]
        Tool1["工具发现与调用"]
        Tool2["资源访问"]
        Tool3["Prompt 管理"]

        style ToolLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    end

    subgraph TransportLayer["传输层"]
        Trans1["stdio / SSE / HTTP / WebSocket"]

        style TransportLayer fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    end

    AppLayer --&gt; AgentLayer
    AgentLayer --&gt; ToolLayer
    ToolLayer --&gt; TransportLayer

    style App1 fill:#b3e5fc,stroke:#01579b
    style App2 fill:#b3e5fc,stroke:#01579b
    style App3 fill:#b3e5fc,stroke:#01579b
    style Agent1 fill:#e1bee7,stroke:#6a1b9a
    style Agent2 fill:#e1bee7,stroke:#6a1b9a
    style Agent3 fill:#e1bee7,stroke:#6a1b9a
    style Tool1 fill:#ffe0b2,stroke:#e65100
    style Tool2 fill:#ffe0b2,stroke:#e65100
    style Tool3 fill:#ffe0b2,stroke:#e65100
</code></pre>
<h4 data-id="heading-50">5.2 详细对比表</h4>


















































































<table><thead><tr><th>维度</th><th>MCP</th><th>ACP (官方)</th><th>A2A (Gemini)</th><th>Codex SQ/EQ</th></tr></thead><tbody><tr><td><strong>协议目标</strong></td><td>Agent ↔ 工具/资源</td><td>Editor ↔ Agent</td><td>Agent ↔ Agent</td><td>用户 ↔ Agent</td></tr><tr><td><strong>发布方</strong></td><td>Anthropic</td><td>Zed Industries</td><td>Google</td><td>OpenAI (社区)</td></tr><tr><td><strong>协议版本</strong></td><td>2025-06-18</td><td>Version 1 (2025-08)</td><td>0.3.0</td><td>v0.2.0-alpha</td></tr><tr><td><strong>通信模式</strong></td><td>Request/Response</td><td>Request/Response + Notifications</td><td>Event-Driven (SSE)</td><td>Queue-Based</td></tr><tr><td><strong>状态管理</strong></td><td>无状态</td><td>有状态 (会话)</td><td>有状态 (任务)</td><td>有状态 (会话)</td></tr><tr><td><strong>传输方式</strong></td><td>stdio, SSE, HTTP</td><td>stdio (JSON-RPC)</td><td>HTTP + SSE</td><td>In-Process Channels</td></tr><tr><td><strong>权限模型</strong></td><td>Elicitation</td><td>Permission Request</td><td>Confirmation</td><td>Approval</td></tr><tr><td><strong>流式支持</strong></td><td>❌ 不支持</td><td>✅ 支持</td><td>✅ 支持</td><td>✅ 支持</td></tr><tr><td><strong>语言绑定</strong></td><td>TS, Rust, Python</td><td>TS, Go, Rust, Python</td><td>TypeScript</td><td>Rust + TS SDK</td></tr><tr><td><strong>标准化程度</strong></td><td>✅ 官方标准</td><td>✅ 官方标准</td><td>🔬 实验性实现</td><td>🔬 实验性实现</td></tr></tbody></table>
<h4 data-id="heading-51">5.3 工具调用流程对比</h4>
<h5 data-id="heading-52"><strong>MCP 工具调用</strong> (同步):</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">User</span> <span class="hljs-string">→</span> <span class="hljs-attr">Agent:</span> <span class="hljs-string">"读取文件 /etc/hosts"</span>
<span class="hljs-string">Agent</span> <span class="hljs-string">→</span> <span class="hljs-attr">MCP Server:</span> <span class="hljs-string">tools/call</span> { <span class="hljs-attr">name:</span> <span class="hljs-string">"read_file"</span>, <span class="hljs-attr">args:</span> {<span class="hljs-string">...</span>} }
<span class="hljs-string">MCP</span> <span class="hljs-string">Server</span> <span class="hljs-string">→</span> <span class="hljs-attr">Agent:</span> { <span class="hljs-attr">content:</span> [<span class="hljs-string">...</span>], <span class="hljs-attr">isError:</span> <span class="hljs-literal">false</span> }
<span class="hljs-string">Agent</span> <span class="hljs-string">→</span> <span class="hljs-attr">User:</span> <span class="hljs-string">"文件内容如下..."</span>
</code></pre>
<h5 data-id="heading-53"><strong>A2A 工具调用</strong> (流式):</h5>
<pre><code class="hljs language-css" lang="css">User → Agent <span class="hljs-selector-tag">A</span>: <span class="hljs-string">"读取并分析文件"</span>
Agent A → EventBus: { status: <span class="hljs-string">'working'</span>, message: <span class="hljs-string">"正在读取..."</span> }
Agent <span class="hljs-selector-tag">A</span> → Tool: <span class="hljs-built_in">read_file</span>(...)
Tool → Agent A: (file content)
Agent A → EventBus: { status: <span class="hljs-string">'working'</span>, message: <span class="hljs-string">"正在分析..."</span> }
Agent <span class="hljs-selector-tag">A</span> → Agent <span class="hljs-selector-tag">B</span>: <span class="hljs-built_in">analyze</span>(content)  // 可选的 Multi-Agent
Agent B → EventBus: { status: <span class="hljs-string">'working'</span>, message: <span class="hljs-string">"分析结果..."</span> }
EventBus → User: (流式展示每一步)
</code></pre>
<h5 data-id="heading-54"><strong>Codex SQ/EQ</strong> (异步队列):</h5>
<pre><code class="hljs language-css" lang="css">User → SQ: Submission { op: UserTurn { text: <span class="hljs-string">"..."</span> } }
Agent → EQ: Event { msg: AgentMessage { text: <span class="hljs-string">"正在处理..."</span> } }
Agent → EQ: Event { msg: ToolCall { tool: <span class="hljs-string">"shell"</span>, cmd: <span class="hljs-string">"ls"</span> } }
Agent → EQ: Event { msg: ExecApprovalRequest {...} }
User → SQ: Submission { op: ExecApproval { decision: Allow } }
Agent → EQ: Event { msg: ToolCallResult {...} }
Agent → EQ: Event { msg: TurnComplete }
</code></pre>
<hr/>
<h3 data-id="heading-55">六、实际应用场景</h3>
<h4 data-id="heading-56">6.1 MCP 典型场景</h4>
<h5 data-id="heading-57"><strong>场景 1: 统一的开发工具接入</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 配置文件: ~/.gemini/settings.json</span>
{
  <span class="hljs-string">"mcpServers"</span>: {
    <span class="hljs-string">"github"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"-y"</span>, <span class="hljs-string">"@modelcontextprotocol/server-github"</span>],
      <span class="hljs-string">"env"</span>: {
        <span class="hljs-string">"GITHUB_TOKEN"</span>: <span class="hljs-string">"${GITHUB_TOKEN}"</span>
      }
    },
    <span class="hljs-string">"postgres"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"uvx"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"mcp-server-postgres"</span>],
      <span class="hljs-string">"env"</span>: {
        <span class="hljs-string">"DATABASE_URL"</span>: <span class="hljs-string">"postgresql://..."</span>
      }
    },
    <span class="hljs-string">"filesystem"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"-y"</span>, <span class="hljs-string">"@modelcontextprotocol/server-filesystem"</span>, <span class="hljs-string">"/workspace"</span>]
    }
  }
}
</code></pre>
<p><strong>使用</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">$ gemini
&gt; @github List my open pull requests
&gt; @postgres Run query: SELECT * FROM <span class="hljs-built_in">users</span> WHERE active = <span class="hljs-literal">true</span>
&gt; @filesystem Read file package.json
</code></pre>
<h5 data-id="heading-58"><strong>场景 2: 企业内部工具集成</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自定义 MCP Server</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server'</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'company-internal-tools'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
});

server.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-title class_">ListToolsRequestSchema</span>, <span class="hljs-keyword">async</span> () =&gt; ({
  <span class="hljs-attr">tools</span>: [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'query_jira'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Query JIRA tickets'</span>,
      <span class="hljs-attr">inputSchema</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">jql</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span> }
        }
      }
    },
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'deploy_to_k8s'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Deploy application to Kubernetes'</span>,
      <span class="hljs-attr">inputSchema</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">namespace</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span> },
          <span class="hljs-attr">image</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span> }
        }
      }
    }
  ]
}));
</code></pre>
<h4 data-id="heading-59">6.2 ACP 典型场景（官方标准）</h4>
<h5 data-id="heading-60"><strong>场景 1: Multi-Agent 协作工作流</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@a2a-js/sdk'</span>;

<span class="hljs-comment">// Agent 1: 代码生成专家</span>
<span class="hljs-keyword">const</span> codeGenAgent = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
  <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://gemini-a2a:41242'</span>
});

<span class="hljs-comment">// Agent 2: 代码审查专家</span>
<span class="hljs-keyword">const</span> codeReviewAgent = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
  <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://claude-a2a:3000'</span>
});

<span class="hljs-comment">// 工作流编排</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">developFeature</span>(<span class="hljs-params">requirement: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// Step 1: 生成代码</span>
  <span class="hljs-keyword">const</span> codeTask = <span class="hljs-keyword">await</span> codeGenAgent.<span class="hljs-title function_">createTask</span>({
    <span class="hljs-attr">message</span>: {
      <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">kind</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">`实现功能: <span class="hljs-subst">${requirement}</span>`</span> }]
    }
  });

  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> codeTask.<span class="hljs-title function_">waitForCompletion</span>();

  <span class="hljs-comment">// Step 2: 审查代码</span>
  <span class="hljs-keyword">const</span> reviewTask = <span class="hljs-keyword">await</span> codeReviewAgent.<span class="hljs-title function_">createTask</span>({
    <span class="hljs-attr">message</span>: {
      <span class="hljs-attr">parts</span>: [{
        <span class="hljs-attr">kind</span>: <span class="hljs-string">'text'</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-string">`审查以下代码并提供改进建议:\n<span class="hljs-subst">${code}</span>`</span>
      }]
    }
  });

  <span class="hljs-keyword">const</span> review = <span class="hljs-keyword">await</span> reviewTask.<span class="hljs-title function_">waitForCompletion</span>();

  <span class="hljs-comment">// Step 3: 根据审查意见改进</span>
  <span class="hljs-keyword">const</span> improvedCodeTask = <span class="hljs-keyword">await</span> codeGenAgent.<span class="hljs-title function_">createTask</span>({
    <span class="hljs-attr">message</span>: {
      <span class="hljs-attr">parts</span>: [{
        <span class="hljs-attr">kind</span>: <span class="hljs-string">'text'</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-string">`根据审查意见改进代码:\n审查意见: <span class="hljs-subst">${review}</span>\n原代码: <span class="hljs-subst">${code}</span>`</span>
      }]
    }
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> improvedCodeTask.<span class="hljs-title function_">waitForCompletion</span>();
}
</code></pre>
<h5 data-id="heading-61"><strong>场景 2: Agent 服务化部署</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 将 Gemini CLI 部署为 A2A 服务</span>
<span class="hljs-keyword">import</span> { A2AExpressApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@a2a-js/sdk/server/express'</span>;
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> a2aApp = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A2AExpressApp</span>(requestHandler);

a2aApp.<span class="hljs-title function_">setupRoutes</span>(app, <span class="hljs-string">'/api'</span>);
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">41242</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Gemini A2A Server running on http://localhost:41242'</span>);
});

<span class="hljs-comment">// 现在其他 Agent 可以调用</span>
<span class="hljs-keyword">const</span> geminiAgent = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({
  <span class="hljs-attr">agentUrl</span>: <span class="hljs-string">'http://localhost:41242/api'</span>
});
</code></pre>
<h4 data-id="heading-62">6.3 Codex SQ/EQ 典型场景</h4>
<h5 data-id="heading-63"><strong>场景 1: 细粒度的审批控制</strong></h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义审批策略</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">approval_policy</span> = AskForApproval::AskBeforeExecuting;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">sandbox_policy</span> = SandboxPolicy::Strict;

<span class="hljs-comment">// 提交用户输入</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">submission</span> = Submission {
    id: <span class="hljs-string">"sub-001"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    op: Op::UserTurn {
        items: <span class="hljs-built_in">vec!</span>[UserInput::<span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">"删除所有日志文件"</span>.<span class="hljs-title function_ invoke__">to_string</span>())],
        cwd: PathBuf::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"/var/log"</span>),
        approval_policy,
        sandbox_policy,
        model: <span class="hljs-string">"gpt-4"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    }
};

<span class="hljs-comment">// Agent 请求批准</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">event</span> = Event {
    id: <span class="hljs-string">"evt-001"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    msg: EventMsg::<span class="hljs-title function_ invoke__">ExecApprovalRequest</span>(ExecApprovalRequestEvent {
        command: <span class="hljs-string">"rm -rf *.log"</span>,
        assessment: SandboxCommandAssessment {
            risk_level: SandboxRiskLevel::High,
            reason: <span class="hljs-string">"批量删除操作"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        }
    })
};

<span class="hljs-comment">// 用户批准或拒绝</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">approval</span> = Submission {
    id: <span class="hljs-string">"sub-002"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    op: Op::ExecApproval {
        id: <span class="hljs-string">"evt-001"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        decision: ReviewDecision::Approve,
    }
};
</code></pre>
<h5 data-id="heading-64"><strong>场景 2: 会话恢复</strong></h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 保存会话状态</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">conversation_id</span> = ConversationId::<span class="hljs-title function_ invoke__">new</span>();
conversation_manager.<span class="hljs-title function_ invoke__">save_state</span>(conversation_id, &amp;state).<span class="hljs-keyword">await</span>?;

<span class="hljs-comment">// 稍后恢复</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">restored_state</span> = conversation_manager.<span class="hljs-title function_ invoke__">load_state</span>(conversation_id).<span class="hljs-keyword">await</span>?;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">conversation</span> = CodexConversation::<span class="hljs-title function_ invoke__">from_state</span>(restored_state)?;
</code></pre>
<hr/>
<h3 data-id="heading-65">七、技术挑战与解决方案</h3>
<h4 data-id="heading-66">7.1 工具命名冲突</h4>
<p><strong>问题</strong>: 多个 MCP Server 可能提供同名工具</p>
<p><strong>Gemini CLI 解决方案</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 server_name 作为 namespace</span>
<span class="hljs-keyword">const</span> toolName = <span class="hljs-string">`<span class="hljs-subst">${serverName}</span>.<span class="hljs-subst">${originalToolName}</span>`</span>;
<span class="hljs-comment">// 例如: "github.create_issue", "gitlab.create_issue"</span>
</code></pre>
<p><strong>Codex 解决方案</strong>:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用双下划线分隔符 + SHA1 截断</span>
<span class="hljs-keyword">const</span> DELIMITER = <span class="hljs-string">"__"</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">qualified_name</span> = <span class="hljs-built_in">format!</span>(
    <span class="hljs-string">"mcp{}{}{}{}"</span>,
    DELIMITER, server_name, DELIMITER, tool_name
);

<span class="hljs-keyword">if</span> qualified_name.<span class="hljs-title function_ invoke__">len</span>() &gt; <span class="hljs-number">64</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">hash</span> = sha1::Sha1::<span class="hljs-title function_ invoke__">digest</span>(qualified_name);
    qualified_name = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}_{:x}"</span>, &amp;qualified_name[..<span class="hljs-number">48</span>], hash);
}
<span class="hljs-comment">// 例如: "mcp__github__create_issue"</span>
</code></pre>
<h4 data-id="heading-67">7.2 流式输出的挑战</h4>
<p><strong>问题</strong>: LLM 生成是流式的，但工具调用是同步的</p>
<p><strong>A2A 解决方案</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 EventBus 解耦</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> llmStream) {
  eventBus.<span class="hljs-title function_">publish</span>({
    <span class="hljs-attr">kind</span>: <span class="hljs-string">'status-update'</span>,
    <span class="hljs-attr">status</span>: {
      <span class="hljs-attr">message</span>: { <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">kind</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: chunk }] }
    },
    <span class="hljs-attr">final</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 非最终状态，继续接收</span>
  });
}
</code></pre>
<p><strong>Codex 解决方案</strong>:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用 AsyncIterator</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">send_message_stream</span>(
    &amp;<span class="hljs-keyword">self</span>,
    items: <span class="hljs-type">Vec</span>&lt;UserInput&gt;
) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Stream</span>&lt;Item = <span class="hljs-type">Result</span>&lt;Event&gt;&gt; {
    async_stream::stream! {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">response</span> = <span class="hljs-keyword">self</span>.llm_client.<span class="hljs-title function_ invoke__">chat</span>(items).<span class="hljs-keyword">await</span>?;
        <span class="hljs-keyword">for</span> <span class="hljs-title class_">await</span> chunk <span class="hljs-keyword">in</span> response.stream {
            <span class="hljs-keyword">yield</span> <span class="hljs-title function_ invoke__">Ok</span>(Event {
                msg: EventMsg::<span class="hljs-title function_ invoke__">AgentMessage</span>(chunk)
            });
        }
    }
}
</code></pre>
<h4 data-id="heading-68">7.3 安全性和沙箱</h4>
<p><strong>Codex 的多层沙箱方案</strong>:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 1. Execpolicy - 命令级别的策略</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExecPolicy</span> {
    auto_approve: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,    <span class="hljs-comment">// 自动批准的命令</span>
    always_deny: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,      <span class="hljs-comment">// 始终拒绝的命令</span>
    require_confirm: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,  <span class="hljs-comment">// 需要确认的命令</span>
}

<span class="hljs-comment">// 2. Platform Sandbox - 操作系统级别的隔离</span>
<span class="hljs-meta">#[cfg(target_os = <span class="hljs-string">"macos"</span>)]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">apply_seatbelt_sandbox</span>(cmd: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">profile</span> = <span class="hljs-string">"(version 1) (deny default) (allow network*) (allow file-read* /usr/bin)"</span>;
    <span class="hljs-title function_ invoke__">sandbox_exec</span>(cmd, profile)
}

<span class="hljs-meta">#[cfg(target_os = <span class="hljs-string">"linux"</span>)]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">apply_landlock_sandbox</span>(cmd: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    landlock::Ruleset::<span class="hljs-title function_ invoke__">new</span>()
        .<span class="hljs-title function_ invoke__">allow_read</span>(<span class="hljs-string">"/usr/bin"</span>)
        .<span class="hljs-title function_ invoke__">allow_execute</span>(<span class="hljs-string">"/usr/bin"</span>)
        .<span class="hljs-title function_ invoke__">restrict_self</span>()?;
    <span class="hljs-title function_ invoke__">execute</span>(cmd)
}

<span class="hljs-comment">// 3. Network Isolation</span>
<span class="hljs-keyword">if</span> sandbox_policy == SandboxPolicy::Strict {
    env::<span class="hljs-title function_ invoke__">set_var</span>(<span class="hljs-string">"CODEX_SANDBOX_NETWORK_DISABLED"</span>, <span class="hljs-string">"1"</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-69">八、性能对比</h3>
<h4 data-id="heading-70">8.1 连接建立时间</h4>



































<table><thead><tr><th>实现</th><th>传输方式</th><th>平均耗时</th><th>备注</th></tr></thead><tbody><tr><td>Gemini MCP (TypeScript)</td><td>stdio</td><td>~150ms</td><td>Node.js 子进程启动</td></tr><tr><td>Gemini MCP (TypeScript)</td><td>SSE</td><td>~80ms</td><td>HTTP 连接</td></tr><tr><td>Codex MCP (Rust)</td><td>stdio</td><td>~50ms</td><td>原生进程启动</td></tr><tr><td>Codex MCP (Rust)</td><td>SSE</td><td>~40ms</td><td>Tokio HTTP Client</td></tr></tbody></table>
<h4 data-id="heading-71">8.2 工具调用延迟</h4>

























<table><thead><tr><th>场景</th><th>Gemini CLI</th><th>Codex CLI</th></tr></thead><tbody><tr><td>简单工具 (read_file)</td><td>~100ms</td><td>~30ms</td></tr><tr><td>复杂工具 (database query)</td><td>~500ms</td><td>~200ms</td></tr><tr><td>批量工具调用 (10个)</td><td>~1.5s</td><td>~600ms</td></tr></tbody></table>
<p><strong>性能差异原因</strong>:</p>
<ul>
<li>Rust 的零成本抽象和编译优化</li>
<li>Tokio 异步运行时的高效调度</li>
<li>无 GC (Garbage Collection) 的确定性延迟</li>
</ul>
<h4 data-id="heading-72">8.3 内存占用</h4>























<table><thead><tr><th>实现</th><th>空闲内存</th><th>单会话内存</th><th>10会话内存</th></tr></thead><tbody><tr><td>Gemini CLI (Node.js)</td><td>~80MB</td><td>~150MB</td><td>~500MB</td></tr><tr><td>Codex CLI (Rust)</td><td>~5MB</td><td>~15MB</td><td>~80MB</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-73">九、未来发展方向</h3>
<h4 data-id="heading-74">9.1 协议融合趋势</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Layer4["Layer 4: Orchestration Layer"]
        L4A["Multi-Agent DAG 编排"]
        L4B["分布式任务调度"]
        L4C["Agent Marketplace"]

        style Layer4 fill:#e8eaf6,stroke:#283593,stroke-width:2px
    end

    subgraph Layer3["Layer 3: Agent Communication (ACP++)"]
        L3A["统一的任务状态管理"]
        L3B["Agent 发现与注册"]
        L3C["流式通信 + 状态持久化"]

        style Layer3 fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    end

    subgraph Layer2["Layer 2: Tool &amp; Resource (MCP++)"]
        L2A["工具发现与调用"]
        L2B["资源抽象与访问控制"]
        L2C["Prompt 库管理"]

        style Layer2 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    end

    subgraph Layer1["Layer 1: Transport Layer"]
        L1A["gRPC / WebSocket / QUIC"]
        L1B["加密传输 (TLS 1.3)"]

        style Layer1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    end

    Layer4 --&gt; Layer3
    Layer3 --&gt; Layer2
    Layer2 --&gt; Layer1

    style L4A fill:#c5cae9,stroke:#283593
    style L4B fill:#c5cae9,stroke:#283593
    style L4C fill:#c5cae9,stroke:#283593
    style L3A fill:#b3e5fc,stroke:#01579b
    style L3B fill:#b3e5fc,stroke:#01579b
    style L3C fill:#b3e5fc,stroke:#01579b
    style L2A fill:#ffe0b2,stroke:#e65100
    style L2B fill:#ffe0b2,stroke:#e65100
    style L2C fill:#ffe0b2,stroke:#e65100
</code></pre>
<h4 data-id="heading-75">9.2 关键演进方向</h4>
<h5 data-id="heading-76"><strong>1. 标准化组织推动</strong></h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 可能的标准化路径</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">W3C</span> <span class="hljs-string">Web</span> <span class="hljs-string">Agent</span> <span class="hljs-string">Working</span> <span class="hljs-string">Group</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">定义</span> <span class="hljs-string">Web-native</span> <span class="hljs-string">Agent</span> <span class="hljs-string">Protocol</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">浏览器原生支持</span> <span class="hljs-string">Agent</span> <span class="hljs-string">通信</span>

<span class="hljs-bullet">-</span> <span class="hljs-string">IETF</span> <span class="hljs-string">RFC</span> <span class="hljs-string">提案</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Agent</span> <span class="hljs-string">Communication</span> <span class="hljs-string">Protocol</span> <span class="hljs-string">(ACP)</span> <span class="hljs-string">RFC</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">类似</span> <span class="hljs-string">HTTP/2,</span> <span class="hljs-string">gRPC</span> <span class="hljs-string">的标准化进程</span>

<span class="hljs-bullet">-</span> <span class="hljs-string">Linux</span> <span class="hljs-string">Foundation</span> <span class="hljs-string">AI</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Data</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">MCP</span> <span class="hljs-string">Foundation</span> <span class="hljs-string">(类似</span> <span class="hljs-string">CNCF)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">开源参考实现和认证体系</span>
</code></pre>
<h5 data-id="heading-77"><strong>2. 性能优化</strong></h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用 gRPC 替代 JSON-RPC</span>
service AgentService {
  rpc <span class="hljs-title function_ invoke__">ExecuteTask</span>(TaskRequest) <span class="hljs-title function_ invoke__">returns</span> (stream TaskEvent);
  rpc <span class="hljs-title function_ invoke__">CallTool</span>(ToolCallRequest) <span class="hljs-title function_ invoke__">returns</span> (ToolCallResponse);
}

<span class="hljs-comment">// 使用 Protocol Buffers 替代 JSON</span>
message TaskEvent {
  string task_id = <span class="hljs-number">1</span>;
  TaskState state = <span class="hljs-number">2</span>;
  oneof payload {
    AgentMessage message = <span class="hljs-number">3</span>;
    ToolCall tool_call = <span class="hljs-number">4</span>;
  }
}

<span class="hljs-comment">// 性能提升预期</span>
<span class="hljs-comment">// - 序列化速度: 5-10x</span>
<span class="hljs-comment">// - 传输体积: 30-50% 减少</span>
<span class="hljs-comment">// - 类型安全: 编译时检查</span>
</code></pre>
<h5 data-id="heading-78"><strong>3. 安全性增强</strong></h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Zero Trust Agent Network</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">端到端加密</span> <span class="hljs-string">(E2EE)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Agent</span> <span class="hljs-string">间通信默认加密</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">密钥轮换机制</span>

<span class="hljs-bullet">-</span> <span class="hljs-string">细粒度访问控制</span> <span class="hljs-string">(FGAC)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">基于</span> <span class="hljs-string">RBAC</span> <span class="hljs-string">的工具权限</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">基于</span> <span class="hljs-string">ABAC</span> <span class="hljs-string">的资源访问</span>

<span class="hljs-bullet">-</span> <span class="hljs-string">审计与合规</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">完整的调用链追踪</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">符合</span> <span class="hljs-string">SOC2</span> <span class="hljs-string">/</span> <span class="hljs-string">ISO27001</span>

<span class="hljs-bullet">-</span> <span class="hljs-string">沙箱增强</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">WebAssembly</span> <span class="hljs-string">(WASI)</span> <span class="hljs-string">沙箱</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">容器级别隔离</span> <span class="hljs-string">(Firecracker)</span>
</code></pre>
<h5 data-id="heading-79"><strong>4. 可观测性</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// OpenTelemetry 集成</span>
<span class="hljs-keyword">import</span> { trace, context } <span class="hljs-keyword">from</span> <span class="hljs-string">'@opentelemetry/api'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InstrumentedAgent</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeTask</span>(<span class="hljs-params">task: Task</span>) {
    <span class="hljs-keyword">const</span> span = trace.<span class="hljs-title function_">getTracer</span>(<span class="hljs-string">'agent'</span>).<span class="hljs-title function_">startSpan</span>(<span class="hljs-string">'execute_task'</span>, {
      <span class="hljs-attr">attributes</span>: {
        <span class="hljs-string">'task.id'</span>: task.<span class="hljs-property">id</span>,
        <span class="hljs-string">'agent.name'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>,
        <span class="hljs-string">'agent.version'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">version</span>
      }
    });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">executor</span>.<span class="hljs-title function_">execute</span>(task);
      span.<span class="hljs-title function_">setStatus</span>({ <span class="hljs-attr">code</span>: <span class="hljs-title class_">SpanStatusCode</span>.<span class="hljs-property">OK</span> });
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      span.<span class="hljs-title function_">recordException</span>(error);
      span.<span class="hljs-title function_">setStatus</span>({ <span class="hljs-attr">code</span>: <span class="hljs-title class_">SpanStatusCode</span>.<span class="hljs-property">ERROR</span> });
      <span class="hljs-keyword">throw</span> error;
    } <span class="hljs-keyword">finally</span> {
      span.<span class="hljs-title function_">end</span>();
    }
  }
}

<span class="hljs-comment">// 分布式追踪</span>
<span class="hljs-title class_">User</span> → <span class="hljs-title class_">Agent</span> A (<span class="hljs-attr">trace_id</span>: abc123, <span class="hljs-attr">span_id</span>: <span class="hljs-number">001</span>)
  → <span class="hljs-variable constant_">MCP</span> <span class="hljs-title class_">Tool</span> <span class="hljs-number">1</span> (<span class="hljs-attr">trace_id</span>: abc123, <span class="hljs-attr">span_id</span>: <span class="hljs-number">002</span>)
  → <span class="hljs-title class_">Agent</span> B (<span class="hljs-attr">trace_id</span>: abc123, <span class="hljs-attr">span_id</span>: <span class="hljs-number">003</span>)
    → <span class="hljs-variable constant_">MCP</span> <span class="hljs-title class_">Tool</span> <span class="hljs-number">2</span> (<span class="hljs-attr">trace_id</span>: abc123, <span class="hljs-attr">span_id</span>: <span class="hljs-number">004</span>)
</code></pre>
<h5 data-id="heading-80"><strong>5. 跨语言互操作</strong></h5>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────┐
│           多语言 SDK 生态                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  TypeScript  │  @mcp/sdk, @acp/sdk                      │
│  Rust        │  mcp-rs, acp-rs                          │
│  Python      │  mcp-python, acp-python                  │
│  Go          │  go-mcp, go-acp                          │
│  Java        │  mcp-java, acp-java                      │
│                                                          │
│  共同特性:                                               │
│  - Protocol Buffers 定义                                │
│  - 自动生成代码绑定                                     │
│  - 统一的测试套件                                       │
│  - 互操作性验证                                         │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-81">9.3 应用场景展望</h4>
<h5 data-id="heading-82"><strong>场景 1: 企业级 AI Mesh</strong></h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Agent 服务网格</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">AgentMesh</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">company-ai-mesh</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">agents:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">code-gen-agent</span>
      <span class="hljs-attr">provider:</span> <span class="hljs-string">gemini</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">tools:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">github</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">gitlab</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">jira</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">code-review-agent</span>
      <span class="hljs-attr">provider:</span> <span class="hljs-string">claude</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
      <span class="hljs-attr">tools:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">sonarqube</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">codecov</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">security-scan-agent</span>
      <span class="hljs-attr">provider:</span> <span class="hljs-string">codex</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">tools:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">snyk</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">trivy</span>

  <span class="hljs-attr">routing:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">code_generation</span>
      <span class="hljs-attr">route:</span> <span class="hljs-string">code-gen-agent</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">code_review</span>
      <span class="hljs-attr">route:</span> <span class="hljs-string">code-review-agent</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">security_scan</span>
      <span class="hljs-attr">route:</span> <span class="hljs-string">security-scan-agent</span>
</code></pre>
<h5 data-id="heading-83"><strong>场景 2: Personal AI Assistant Ecosystem</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 个人 AI 助手编排</span>
<span class="hljs-keyword">const</span> personalAI = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentOrchestrator</span>({
  <span class="hljs-attr">agents</span>: {
    <span class="hljs-attr">calendar</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'http://calendar-agent:8080'</span> }),
    <span class="hljs-attr">email</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'http://email-agent:8081'</span> }),
    <span class="hljs-attr">task</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'http://task-agent:8082'</span> }),
    <span class="hljs-attr">research</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">createAgent</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'http://research-agent:8083'</span> })
  }
});

<span class="hljs-comment">// 复杂任务编排</span>
<span class="hljs-keyword">await</span> personalAI.<span class="hljs-title function_">execute</span>({
  <span class="hljs-attr">task</span>: <span class="hljs-string">"准备下周的产品发布会"</span>,
  <span class="hljs-attr">steps</span>: [
    {
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'calendar'</span>,
      <span class="hljs-attr">action</span>: <span class="hljs-string">'检查下周日程并预定会议室'</span>
    },
    {
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'task'</span>,
      <span class="hljs-attr">action</span>: <span class="hljs-string">'创建发布会任务清单'</span>
    },
    {
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'research'</span>,
      <span class="hljs-attr">action</span>: <span class="hljs-string">'调研竞品最新动态'</span>,
      <span class="hljs-attr">depends_on</span>: [<span class="hljs-string">'task'</span>]
    },
    {
      <span class="hljs-attr">agent</span>: <span class="hljs-string">'email'</span>,
      <span class="hljs-attr">action</span>: <span class="hljs-string">'发送会议邀请给相关人员'</span>,
      <span class="hljs-attr">depends_on</span>: [<span class="hljs-string">'calendar'</span>, <span class="hljs-string">'research'</span>]
    }
  ]
});
</code></pre>
<hr/>
<h3 data-id="heading-84">十、给开发者的建议</h3>
<h4 data-id="heading-85">10.1 选择 MCP 还是 ACP？</h4>



































<table><thead><tr><th>如果你需要...</th><th>推荐协议</th><th>理由</th></tr></thead><tbody><tr><td>为 Agent 添加外部工具能力</td><td><strong>MCP</strong></td><td>成熟的工具发现和调用机制</td></tr><tr><td>构建多 Agent 协作系统</td><td><strong>ACP/A2A</strong></td><td>原生的 Agent 间通信支持</td></tr><tr><td>企业级合规和审计</td><td><strong>Codex SQ/EQ</strong></td><td>完整的审批流程和状态追踪</td></tr><tr><td>快速原型开发</td><td><strong>MCP</strong></td><td>丰富的社区工具和示例</td></tr><tr><td>高性能生产环境</td><td><strong>Codex (Rust)</strong></td><td>低延迟、低内存占用</td></tr></tbody></table>
<h4 data-id="heading-86">10.2 最佳实践</h4>
<h5 data-id="heading-87"><strong>1. MCP Server 开发</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 好的实践</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server'</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'my-tool-server'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
});

<span class="hljs-comment">// 提供详细的工具描述</span>
server.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-title class_">ListToolsRequestSchema</span>, <span class="hljs-keyword">async</span> () =&gt; ({
  <span class="hljs-attr">tools</span>: [{
    <span class="hljs-attr">name</span>: <span class="hljs-string">'search_documents'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'在文档库中搜索相关内容。支持全文搜索和语义搜索。'</span>,
    <span class="hljs-attr">inputSchema</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">query</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">'搜索关键词或自然语言问题'</span>
        },
        <span class="hljs-attr">mode</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
          <span class="hljs-attr">enum</span>: [<span class="hljs-string">'fulltext'</span>, <span class="hljs-string">'semantic'</span>],
          <span class="hljs-attr">default</span>: <span class="hljs-string">'semantic'</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">'搜索模式'</span>
        }
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">'query'</span>]
    }
  }]
}));

<span class="hljs-comment">// ❌ 不好的实践</span>
<span class="hljs-keyword">const</span> badTools = [{
  <span class="hljs-attr">name</span>: <span class="hljs-string">'search'</span>,  <span class="hljs-comment">// 名称过于泛化</span>
  <span class="hljs-attr">description</span>: <span class="hljs-string">'搜索'</span>,  <span class="hljs-comment">// 描述不清晰</span>
  <span class="hljs-attr">inputSchema</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
    <span class="hljs-attr">properties</span>: {
      <span class="hljs-attr">q</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span> }  <span class="hljs-comment">// 参数名不明确</span>
    }
  }
}];
</code></pre>
<h5 data-id="heading-88"><strong>2. Agent 安全设计</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 好的实践: 最小权限原则</span>
<span class="hljs-keyword">const</span> agentConfig = {
  <span class="hljs-attr">mcpServers</span>: {
    <span class="hljs-attr">filesystem</span>: {
      <span class="hljs-attr">command</span>: <span class="hljs-string">'npx'</span>,
      <span class="hljs-attr">args</span>: [<span class="hljs-string">'-y'</span>, <span class="hljs-string">'@mcp/server-filesystem'</span>, <span class="hljs-string">'/workspace/project'</span>],
      <span class="hljs-comment">// 仅允许访问项目目录</span>
      <span class="hljs-attr">env</span>: {
        <span class="hljs-attr">ALLOWED_PATHS</span>: <span class="hljs-string">'/workspace/project'</span>
      }
    }
  },
  <span class="hljs-attr">execPolicy</span>: {
    <span class="hljs-attr">autoApprove</span>: [
      <span class="hljs-string">'npm install'</span>,
      <span class="hljs-string">'git status'</span>,
      <span class="hljs-string">'git diff'</span>
    ],
    <span class="hljs-attr">alwaysDeny</span>: [
      <span class="hljs-string">'rm -rf /'</span>,
      <span class="hljs-string">'sudo *'</span>,
      <span class="hljs-string">'chmod 777 *'</span>
    ]
  }
};

<span class="hljs-comment">// ❌ 不好的实践: 过度权限</span>
<span class="hljs-keyword">const</span> badConfig = {
  <span class="hljs-attr">mcpServers</span>: {
    <span class="hljs-attr">filesystem</span>: {
      <span class="hljs-attr">args</span>: [<span class="hljs-string">'/'</span>],  <span class="hljs-comment">// 允许访问整个文件系统</span>
    }
  },
  <span class="hljs-attr">execPolicy</span>: {
    <span class="hljs-attr">autoApprove</span>: [<span class="hljs-string">'*'</span>]  <span class="hljs-comment">// 自动批准所有命令</span>
  }
};
</code></pre>
<h5 data-id="heading-89"><strong>3. 错误处理和重试</strong></h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 好的实践: 指数退避重试</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callToolWithRetry</span>(<span class="hljs-params">
  tool: <span class="hljs-built_in">string</span>,
  params: <span class="hljs-built_in">any</span>,
  maxRetries = <span class="hljs-number">3</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attempt = <span class="hljs-number">0</span>; attempt &lt; maxRetries; attempt++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> mcpClient.<span class="hljs-title function_">callTool</span>(tool, params);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (attempt === maxRetries - <span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> error;

      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRetryable</span>(error)) {
        <span class="hljs-keyword">const</span> backoff = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, attempt) * <span class="hljs-number">1000</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(backoff);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">throw</span> error;
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isRetryable</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-comment">// 网络错误、超时等可重试</span>
  <span class="hljs-keyword">return</span> error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'ETIMEDOUT'</span>) ||
         error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'ECONNREFUSED'</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-90">十一、总结</h3>
<h4 data-id="heading-91">11.1 核心洞察</h4>
<ol>
<li><strong>MCP</strong> 专注于 <strong>Agent ↔ 工具/资源</strong> 的标准化，由 Anthropic 主导</li>
<li><strong>ACP</strong> 是 <strong>Editor ↔ Agent</strong> 的官方标准，由 Zed Industries 发布，类似于 LSP 在语言服务器领域的作用</li>
<li><strong>A2A</strong> (Gemini 实现) 专注于 <strong>Agent ↔ Agent</strong> 的互操作，是构建 Multi-Agent 系统的探索</li>
<li><strong>Codex SQ/EQ</strong> 提供了一个完整的 <strong>用户 ↔ Agent</strong> 交互模型，强调安全性和可控性</li>
</ol>
<h4 data-id="heading-92">11.2 技术趋势</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024          </span><span class="hljs-number">2025          </span><span class="hljs-number">2026          </span><span class="hljs-number">2027</span>
  <span class="hljs-string">│</span>             <span class="hljs-string">│</span>             <span class="hljs-string">│</span>             <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">MCP</span> <span class="hljs-number">1.0</span>    <span class="hljs-string">├─</span> <span class="hljs-string">MCP++</span>      <span class="hljs-string">├─</span> <span class="hljs-string">Unified</span>    <span class="hljs-string">├─</span> <span class="hljs-string">W3C</span> <span class="hljs-string">Standard</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">发布</span>       <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">gRPC</span>     <span class="hljs-string">│</span>  <span class="hljs-string">Protocol</span>   <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">浏览器原生</span>
  <span class="hljs-string">│</span>             <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">WebAssembly│</span>            <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">硬件加速</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">A2A</span> <span class="hljs-number">0.3</span>    <span class="hljs-string">├─</span> <span class="hljs-string">A2A</span> <span class="hljs-number">1.0</span>    <span class="hljs-string">├─</span> <span class="hljs-string">Agent</span> <span class="hljs-string">Mesh</span> <span class="hljs-string">├─</span> <span class="hljs-string">Edge</span> <span class="hljs-string">AI</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">实验</span>       <span class="hljs-string">│</span>  <span class="hljs-string">生产可用</span>   <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">K8s</span> <span class="hljs-string">集成</span> <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">本地优先</span>
  <span class="hljs-string">│</span>             <span class="hljs-string">│</span>             <span class="hljs-string">│</span>             <span class="hljs-string">│</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">碎片化</span>     <span class="hljs-string">└─</span> <span class="hljs-string">融合期</span>     <span class="hljs-string">└─</span> <span class="hljs-string">成熟期</span>     <span class="hljs-string">└─</span> <span class="hljs-string">普及期</span>
</code></pre>
<h4 data-id="heading-93">11.3 给未来的思考</h4>
<blockquote>
<p><strong>"The future of AI is not just about smarter models, but about smarter collaboration between models."</strong></p>
<p>—— 未来的 AI 不仅仅是更智能的模型，而是模型之间更智能的协作。</p>
</blockquote>
<p>协议标准化是 AI Agent 从 <strong>工具</strong> 向 <strong>基础设施</strong> 演进的关键一步。就像 HTTP 成就了互联网，Docker 成就了云原生，<strong>MCP 和 ACP 正在成就 AI Agent 的生态系统</strong>。</p>
<hr/>
<h3 data-id="heading-94">参考资源</h3>
<h4 data-id="heading-95">官方文档</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification" target="_blank" title="https://modelcontextprotocol.io/specification" ref="nofollow noopener noreferrer">Model Context Protocol (MCP) Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2F" target="_blank" title="https://agentclientprotocol.com/" ref="nofollow noopener noreferrer">Agent Client Protocol (ACP) Official Site</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2Fprotocol%2Foverview" target="_blank" title="https://agentclientprotocol.com/protocol/overview" ref="nofollow noopener noreferrer">ACP Protocol Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer">Gemini CLI Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fcodex" target="_blank" title="https://github.com/openai/codex" ref="nofollow noopener noreferrer">Codex CLI Documentation</a></li>
</ul>
<h4 data-id="heading-96">源码仓库</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Fagent-client-protocol" target="_blank" title="https://github.com/agentclientprotocol/agent-client-protocol" ref="nofollow noopener noreferrer">Agent Client Protocol</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentclientprotocol%2Ftypescript-sdk" target="_blank" title="https://github.com/agentclientprotocol/typescript-sdk" ref="nofollow noopener noreferrer">ACP TypeScript SDK</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer">Gemini CLI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fcodex" target="_blank" title="https://github.com/openai/codex" ref="nofollow noopener noreferrer">Codex CLI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Ftypescript-sdk" target="_blank" title="https://github.com/modelcontextprotocol/typescript-sdk" ref="nofollow noopener noreferrer">MCP TypeScript SDK</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fpython-sdk" target="_blank" title="https://github.com/modelcontextprotocol/python-sdk" ref="nofollow noopener noreferrer">MCP Python SDK</a></li>
</ul>
<h4 data-id="heading-97">社区资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fservers" target="_blank" title="https://github.com/modelcontextprotocol/servers" ref="nofollow noopener noreferrer">MCP Servers Hub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpunkpeye%2Fawesome-mcp-servers" target="_blank" title="https://github.com/punkpeye/awesome-mcp-servers" ref="nofollow noopener noreferrer">Awesome MCP Servers</a></li>
</ul>
<p><strong>作者</strong>：前端领秀——悄悄学习，惊艳所有人~</p>
<h3 data-id="heading-98"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0756528722f34e8d940996215c1693af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6a2B6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764835972&amp;x-signature=owqb0Tvjt1v0MOVxKd02Ca%2FAlXo%3D" alt="扫码_搜索联合传播样式-白色版.png" loading="lazy"/></h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀TRAE SOLO 实战干货：从零到一部署国内版“拍立得”应用的踩坑避坑指南🧣]]></title>    <link>https://juejin.cn/post/7577198193214750763</link>    <guid>https://juejin.cn/post/7577198193214750763</guid>    <pubDate>2025-11-27T08:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577198193214750763" data-draft-id="7576953459544424502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀TRAE SOLO 实战干货：从零到一部署国内版“拍立得”应用的踩坑避坑指南🧣"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-27T08:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="围巾哥萧尘"/> <meta itemprop="url" content="https://juejin.cn/user/1222312659548446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀TRAE SOLO 实战干货：从零到一部署国内版“拍立得”应用的踩坑避坑指南🧣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312659548446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    围巾哥萧尘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:28:14.000Z" title="Thu Nov 27 2025 08:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀TRAE SOLO 实战干货：从零到一部署国内版“拍立得”应用的踩坑避坑指南🧣</h2>
<p><strong>导读：</strong> 随着 TRAE SOLO 3.0 Code 工具功能的日益强大，快速构建应用成为可能。今天，给大家分析零基础小白如何构建如“拍立得”这类热门产品，并分享提高开发的效率的解决问题的实战策略。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29096b33051e451dbfc88fc84592ad24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=AZvgfqA6YT9MUD2Ac6i2MZcql6I%3D" alt="截屏2025-11-27 15.23.18.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oRUzBZEPQ%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1oRUzBZEPQ/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">TRAE SOLO Code 3.0 拍立得国内版本开发实际演示🧣#TRAE 3.0 SOLO出道 并 @trae #SOLO已就位 #TRAE发布 ##TR</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftrae52utezgj.vercel.app%2F" target="_blank" title="https://trae52utezgj.vercel.app/" ref="nofollow noopener noreferrer">trae52utezgj.vercel.app/</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fba2220af8a4d4fb94f9fbdd56d2482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=T9iAyggH2%2BdU2JQuBTy5hdswHsU%3D" alt="35.gif" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">第一部分：实战中的“四大深坑”与高效避坑指南</h3>
<p>在 TRAE  的开发流程中，许多问题并非技术难题，而是工具特性和操作逻辑带来的限制。掌握以下避坑策略，能大幅缩短迭代时间：</p>
<h4 data-id="heading-2">陷阱一：初始效果，不尽人意</h4>
<p>当工具根据你的初始提示（Prompt）生成初步界面时，其美观度和细节往往和你的提示词和原型图息息相关。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52d4db733fc416ba1c7b4e8b4bcbd7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=Qd1zBl4i%2B%2BcBF2S2IEz72abjJBc%3D" alt="截屏2025-11-27 10.46.43.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>避坑指南（策略）：</strong> <strong>优化原型和提示词是关键</strong>。</p>
<ol>
<li>
<p><strong>原型制胜：</strong> 我个人的经验总结是，在制作任何产品时， <strong>你的原型 的 图片 越 好</strong> ，工具就<strong>越 能 够 去 还 原 你 的 这 个 原型 图 的 样 式</strong>。高品质的原型和提示词是高效还原的基础。</p>
</li>
<li>
<p><strong>借助外部工具：</strong> 当初始效果不满意时，应重新制作和优化提示。我一般下都是<strong>借助 Google Gemini</strong> 来生成一段更精细、更准确的提示，以此来优化界面。</p>
</li>
</ol>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/316baf32d63a4db38b7c7c5eeccb3076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=fOG2TPF3N%2FUODw2ZVWFrIEfKM9M%3D" alt="截屏2025-11-27 15.25.28.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span> creamy beige retro instant camera on the <span class="hljs-attribute">left</span>, facing forward with <span class="hljs-selector-tag">a</span> reflection of <span class="hljs-selector-tag">a</span> girl in the lens. <span class="hljs-selector-tag">To</span> the <span class="hljs-attribute">right</span>, three scattered Polaroid photos of <span class="hljs-selector-tag">a</span> young Asian woman with long hair in playful selfie poses. The photos have handwritten text at the <span class="hljs-attribute">bottom</span> saying "MAY <span class="hljs-selector-tag">I</span> MEET YOU" and "<span class="hljs-number">2025</span>/<span class="hljs-number">11</span>/<span class="hljs-number">19</span>". Clean light gray <span class="hljs-attribute">background</span> with <span class="hljs-selector-tag">a</span> subtle white polka dot pattern. Soft studio lighting, <span class="hljs-number">3</span>D C4D render style, cute aesthetic, high detail, product photography vibe, soft shadows.

中文提示词分析 (用于理解或国内 AI 工具):

主体： 奶黄色的复古拍立得相机 (Creamy beige retro instant camera)，镜头有反光细节 (Reflection in lens)。

配角： 三张拍立得照片 (Three Polaroid photos)，散落在右侧。

人物内容： 亚洲女孩自拍 (Asian girl selfies)，长发，俏皮姿势。

文字： 照片底部写着 <span class="hljs-string">"MAY I MEET YOU"</span> 和日期。

背景： 浅灰色背景，带白色波点图案 (Light gray background with white dots)。

风格： C4D <span class="hljs-number">3</span>D渲染风格，电商产品摄影，柔光，可爱，高质感。

关键细节注意事项：

关于文字： 目前的 AI（如 FLUX 或 Midjourney v6）已经能比较准确地生成指定的文字，但日期和具体句子可能需要抽卡几次才能完全正确。

关于鼠标手势： 图中右下角的照片上有一个白色的“鼠标手型光标”，这暗示了这可能是一张 UI 界面设计图或者是为了增加互动感的设计。如果在提示词中需要这个细节，可以加上 <span class="hljs-string">"a white cursor hand icon hovering over one photo"</span>。
</code></pre>
<h4 data-id="heading-3">陷阱二：功能缺失与等待延迟</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b4f06b7789e42deac043a456a76de7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=laxzR2xJ4YlvO4Vp%2BDlxrifnG%2Bo%3D" alt="截屏2025-11-27 15.56.44.png" loading="lazy"/></p>
<p>在功能完善阶段，我发现打造“拍立得”应用缺少必要的<strong>清除功能</strong>和<strong>删除功能 <strong>。同时，在要求工具增加功能时，它“有 的 时 候 它 反 应 的 时 候 比 较 慢”，</strong> “不能够直接快速执行”</strong>。</p>
<ul>
<li>
<p><strong>避坑指南（解决方案）：</strong></p>
<ol>
<li><strong>明确要求增补：</strong> 必须通过提示明确要求工具增补缺失的功能，例如要求它<strong>去 增 加 这 个 清 除 的 功 能 和 这 个 删 除 的 功 能</strong>。</li>
<li><strong>重复操作法：</strong> 针对工具执行延迟的问题，我们的经验是，需要<strong>多 去 重 复 的 操 作 一 下</strong>，这样它才能比较快地执行我们的想法。</li>
</ol>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7bb54b99bff4026aaa87d990b17ba4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=d3OAM2q03GbeEAqeHUBVRfR6a%2FY%3D" alt="截屏2025-11-27 15.56.35.png" loading="lazy"/></p>
<h4 data-id="heading-4">陷阱三：国内版本部署功能缺失</h4>
<p>国内版本的 TRAE  “缺乏一个部署的 这个 按 钮”，我们可以通过国际版 TRAE 来结合使用，从而完成自动化部署。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9011bd3309e4b4c97391a7f88823e3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838092&amp;x-signature=qtYGZBiSfaMAXXglAsHyjkkU32E%3D" alt="截屏2025-11-27 16.19.10.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>避坑指南（解决方案）：</strong> <strong>版本部署</strong>。</p>
<ul>
<li>使用<strong>国际版本</strong>的浏览器界面去完成应用的部署。在国际版本中找到部署按钮并点击，才能将应用的网址上传上去。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">第二部分：效率倍增的个人经验总结与思维升级</h3>
<p>使用 TRAE SOLO 绝不仅仅是输入提示词，更重要的是思维模式的转变。</p>
<h4 data-id="heading-6">1. 核心的“干货”：问题的定义是重中之重</h4>
<p>当前编程工具的功能已经“比较强大”。因此， <strong>“你 最 需 要 去 做 核 心 的 事 情”</strong> ，不再是关注如何编码，而是要**“去 完 成 这 个 核 心 的 解 决” <strong>，即：</strong> “问 題 的 定 义 就 很 重 要”**。</p>
<ul>
<li><strong>思维转变：</strong> 应当思考你在日常工作或生活中遇到了<strong>什么比较棘手的问题 <strong>，然后利用这些工具来解决</strong>，你 实 际 当 中 的 问 题</strong>。只有明确了要解决的问题，工具的核心效果才能更好地发挥。</li>
</ul>
<h4 data-id="heading-7">2. 用“流程化体系”提升工作效率</h4>
<p>我建议采用<strong>编程思维来思考问题</strong>，借助日常工作中遇到的问题，<strong>将重复化的工作</strong>做 成 这 种 流 程 化 的 自 动 化  体 系。这种流程化的体系能够让您的工作效率有更大的提升。</p>
<h4 data-id="heading-8">3. 成本优势与入门途径</h4>
<p>对于初学者而言，国内版本提供了极佳的入门机会：</p>
<ul>
<li><strong>免费优势：</strong> 国内版本的最大优势在于它是<strong>免 费 使 用 这 个 solo code  这个 功 能</strong>。</li>
<li><strong>付费差异：</strong> 相比之下，如果想更好地使用<strong>国际版本</strong>，通常需要<strong>支 付 一 定 的 费 用</strong>。</li>
<li><strong>总结：</strong> 因此，<strong>国内版本是一个“比 较 好 的  入 门 的  途 径”</strong> ，建议大家可以去实际尝试一下。</li>
</ul>
<h3 data-id="heading-9">结论</h3>
<p>通过掌握原型提示词的优化、功能迭代等重复操作法，以及国际版本部署策略，我们可以高效地利用 TRAE SOLO Code 3.0 完成应用开发。但最核心的价值，还是在于从<strong>问题定义</strong>出发，将编程思维融入工作，把重复性任务转化为<strong>流程化体系</strong>，这才是真正实现效率倍增的意义所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BBDown：高效便捷的哔哩哔哩视频下载工具]]></title>    <link>https://juejin.cn/post/7577042851080650795</link>    <guid>https://juejin.cn/post/7577042851080650795</guid>    <pubDate>2025-11-27T08:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577042851080650795" data-draft-id="7577042851080618027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BBDown：高效便捷的哔哩哔哩视频下载工具"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-11-27T08:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BBDown：高效便捷的哔哩哔哩视频下载工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:44:29.000Z" title="Thu Nov 27 2025 08:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">BBDown：高效便捷的哔哩哔哩视频下载工具</h2>
<h3 data-id="heading-1">项目描述</h3>
<p>BBDown是一个免费且便捷高效的哔哩哔哩下载/解析软件，支持命令行操作和HTTP API服务。该项目采用C#开发，提供完整的B站视频解析和下载解决方案，支持多种视频格式、多线程下载、弹幕下载等丰富功能。</p>
<h3 data-id="heading-2">功能特性</h3>
<ul>
<li><strong>多平台解析</strong>：支持Web端、TV端、APP端和国际版API解析模式</li>
<li><strong>多种下载方式</strong>：支持普通下载、aria2c下载和多线程下载</li>
<li><strong>格式支持</strong>：支持HEVC、AV1、AVC等多种视频编码格式</li>
<li><strong>画质选择</strong>：提供丰富的画质优先级设置，支持8K、杜比视界等高清格式</li>
<li><strong>弹幕处理</strong>：支持XML和ASS格式的弹幕下载</li>
<li><strong>API服务</strong>：内置HTTP服务器，提供完整的RESTful API接口</li>
<li><strong>批量下载</strong>：支持收藏夹、合集、系列列表等批量下载功能</li>
<li><strong>交互式选择</strong>：提供交互式清晰度选择界面</li>
</ul>
<h3 data-id="heading-3">安装指南</h3>
<h4 data-id="heading-4">通过Dotnet Tool安装</h4>
<p>如果你本地有dotnet环境，使用如下命令即可安装使用：</p>
<pre><code class="hljs language-bash" lang="bash">dotnet tool install --global BBDown
</code></pre>
<h4 data-id="heading-5">更新BBDown</h4>
<pre><code class="hljs language-bash" lang="bash">dotnet tool update --global BBDown
</code></pre>
<h4 data-id="heading-6">系统要求</h4>
<ul>
<li>.NET运行时环境</li>
<li>混流需要外部程序：ffmpeg或mp4box</li>
<li>杜比视界需要ffmpeg 5.0以上或新版mp4box</li>
</ul>
<h4 data-id="heading-7">下载地址</h4>
<ul>
<li>Release版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnilaoda%2FBBDown%2Freleases" target="_blank" title="https://github.com/nilaoda/BBDown/releases" ref="nofollow noopener noreferrer">GitHub Releases</a></li>
<li>自动构建测试版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnilaoda%2FBBDown%2Factions" target="_blank" title="https://github.com/nilaoda/BBDown/actions" ref="nofollow noopener noreferrer">GitHub Actions</a></li>
</ul>
<h3 data-id="heading-8">使用说明</h3>
<h4 data-id="heading-9">基础使用</h4>
<pre><code class="hljs language-bash" lang="bash">BBDown &lt;url&gt; [options]
</code></pre>
<h4 data-id="heading-10">常用参数示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 仅显示视频信息而不下载</span>
BBDown <span class="hljs-string">"BV1qt4y1X7TW"</span> --only-show-info

<span class="hljs-comment"># 使用TV端API解析</span>
BBDown <span class="hljs-string">"BV1qt4y1X7TW"</span> --use-tv-api

<span class="hljs-comment"># 设置编码优先级</span>
BBDown <span class="hljs-string">"BV1qt4y1X7TW"</span> --encoding-priority <span class="hljs-string">"hevc,av1,avc"</span>

<span class="hljs-comment"># 多线程下载</span>
BBDown <span class="hljs-string">"BV1qt4y1X7TW"</span> --multi-thread

<span class="hljs-comment"># 使用aria2c下载</span>
BBDown <span class="hljs-string">"BV1qt4y1X7TW"</span> --use-aria2c
</code></pre>
<h4 data-id="heading-11">API服务器模式</h4>
<p>启动服务器模式后，BBDown会在本地启动HTTP服务，提供以下API接口：</p>
<h5 data-id="heading-12">获取任务列表</h5>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:58682/get-tasks/
</code></pre>
<h5 data-id="heading-13">添加下载任务</h5>
<pre><code class="hljs language-bash" lang="bash">curl -X POST -H <span class="hljs-string">'Content-Type: application/json'</span> -d <span class="hljs-string">'{"Url": "BV1qt4y1X7TW"}'</span> http://localhost:58682/add-task
</code></pre>
<h5 data-id="heading-14">下载到指定目录</h5>
<pre><code class="hljs language-bash" lang="bash">curl -X POST -H <span class="hljs-string">'Content-Type: application/json'</span> -d <span class="hljs-string">'{"Url": "BV1qt4y1X7TW", "FilePattern": "/Downloads/&lt;videoTitle&gt;[&lt;dfn&gt;]"}'</span> http://localhost:58682/add-task
</code></pre>
<h3 data-id="heading-15">核心代码</h3>
<h4 data-id="heading-16">下载任务管理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DownloadTask</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Aid { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">default</span>!;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Url { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">default</span>!;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> TaskCreateTime { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Pic { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span>? VideoPubTime { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span>? TaskFinishTime { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Progress { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> DownloadSpeed { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> TotalDownloadedBytes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsSuccessful { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DownloadTaskCollection</span>
{
    <span class="hljs-keyword">public</span> List&lt;DownloadTask&gt; Running { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();
    <span class="hljs-keyword">public</span> List&lt;DownloadTask&gt; Finished { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DownloadTaskCollection</span>(<span class="hljs-params">List&lt;DownloadTask&gt; running, List&lt;DownloadTask&gt; finished</span>)</span>
    {
        Running = running;
        Finished = finished;
    }
}
</code></pre>
<h4 data-id="heading-17">多线程下载实现</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BBDownDownloadUtil</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DownloadConfig</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> UseAria2c { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Aria2cArgs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> ForceHttp { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> MultiThread { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">public</span> DownloadTask? RelatedTask { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RangeDownloadToTmpAsync</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id, <span class="hljs-built_in">string</span> url, <span class="hljs-built_in">string</span> tmpName, 
        <span class="hljs-built_in">long</span> fromPosition, <span class="hljs-built_in">long</span>? toPosition, Action&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">long</span>, <span class="hljs-built_in">long</span>&gt; onProgress, 
        <span class="hljs-built_in">bool</span> failOnRangeNotSupported = <span class="hljs-literal">false</span></span>)</span>
    {
        <span class="hljs-comment">// 实现范围下载和进度回调</span>
        DateTimeOffset? lastTime = File.Exists(tmpName) ? 
            <span class="hljs-keyword">new</span> FileInfo(tmpName).LastWriteTimeUtc : <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> fileStream = <span class="hljs-keyword">new</span> FileStream(tmpName, FileMode.OpenOrCreate);
        fileStream.Seek(<span class="hljs-number">0</span>, SeekOrigin.End);
        
        <span class="hljs-comment">// 下载逻辑实现...</span>
    }
}
</code></pre>
<h4 data-id="heading-18">视频解析器工厂</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FetcherFactory</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IFetcher <span class="hljs-title">CreateFetcher</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> aidOri, <span class="hljs-built_in">bool</span> useIntlApi</span>)</span>
    {
        IFetcher fetcher = <span class="hljs-keyword">new</span> NormalInfoFetcher();
        
        <span class="hljs-keyword">if</span> (aidOri.StartsWith(<span class="hljs-string">"cheese"</span>))
        {
            fetcher = <span class="hljs-keyword">new</span> CheeseInfoFetcher();
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aidOri.StartsWith(<span class="hljs-string">"ep"</span>))
        {
            fetcher = useIntlApi ? 
                <span class="hljs-keyword">new</span> IntlBangumiInfoFetcher() : <span class="hljs-keyword">new</span> BangumiInfoFetcher();
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (aidOri.StartsWith(<span class="hljs-string">"mid"</span>))
        {
            fetcher = <span class="hljs-keyword">new</span> SpaceVideoFetcher();
        }
        <span class="hljs-comment">// 更多解析器类型...</span>
        
        <span class="hljs-keyword">return</span> fetcher;
    }
}
</code></pre>
<h4 data-id="heading-19">进度条显示</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProgressBar</span> : <span class="hljs-title">IDisposable</span>, <span class="hljs-title">IProgress</span>&lt;<span class="hljs-title">double</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> blockCount = <span class="hljs-number">40</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> TimeSpan animationInterval = TimeSpan.FromSeconds(<span class="hljs-number">1.0</span> / <span class="hljs-number">8</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> animation = <span class="hljs-string">@"|/-\"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Report</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> <span class="hljs-keyword">value</span></span>)</span>
    {
        <span class="hljs-comment">// 确保进度值在0-1范围内</span>
        <span class="hljs-keyword">value</span> = Math.Max(<span class="hljs-number">0</span>, Math.Min(<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>));
        Interlocked.Exchange(<span class="hljs-keyword">ref</span> currentProgress, <span class="hljs-keyword">value</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Report</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> bytesCount</span>)</span>
    {
        <span class="hljs-keyword">value</span> = Math.Max(<span class="hljs-number">0</span>, Math.Min(<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>));
        Interlocked.Exchange(<span class="hljs-keyword">ref</span> currentProgress, <span class="hljs-keyword">value</span>);
        Interlocked.Exchange(<span class="hljs-keyword">ref</span> downloadedBytes, bytesCount);
    }
    
    <span class="hljs-comment">// 进度显示和速度计算实现...</span>
}
</code></pre>
<h4 data-id="heading-20">配置文件解析</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BBDownConfigParser</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleConfig</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">string</span>&gt; newArgsList, RootCommand rootCommand</span>)</span>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">var</span> configPath = newArgsList.Contains(<span class="hljs-string">"--config-file"</span>)
                ? newArgsList.ElementAt(newArgsList.IndexOf(<span class="hljs-string">"--config-file"</span>) + <span class="hljs-number">1</span>)
                : Path.Combine(Program.APP_DIR, <span class="hljs-string">"BBDown.config"</span>);
                
            <span class="hljs-keyword">if</span> (File.Exists(configPath))
            {
                <span class="hljs-comment">// 配置文件读取和解析逻辑</span>
                <span class="hljs-keyword">var</span> configArgs = File
                    .ReadAllLines(configPath)
                    .Where(s =&gt; !<span class="hljs-built_in">string</span>.IsNullOrEmpty(s) &amp;&amp; !s.StartsWith(<span class="hljs-string">'#'</span>))
                    .SelectMany(s =&gt; ParseConfigLine(s));
                
                <span class="hljs-comment">// 命令行参数优先级 &gt; 配置文件优先级</span>
            }
        }
        <span class="hljs-keyword">catch</span> (Exception)
        {
            LogError(<span class="hljs-string">"配置文件读取异常，忽略"</span>);
        }
    }
}
</code></pre>
<p>BBDown项目提供了完整的哔哩哔哩视频下载解决方案，从视频解析到下载管理，再到进度跟踪和文件混流，每个环节都经过精心设计和实现，确保了软件的稳定性和易用性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中 ArrayList 线程安全问题]]></title>    <link>https://juejin.cn/post/7577049352838955023</link>    <guid>https://juejin.cn/post/7577049352838955023</guid>    <pubDate>2025-11-27T08:46:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577049352838955023" data-draft-id="7577049352838905871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中 ArrayList 线程安全问题"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-27T08:46:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中 ArrayList 线程安全问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:46:25.000Z" title="Thu Nov 27 2025 08:46:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>假设你正在开发一个多线程的 Java 应用程序，该程序中有多个线程同时访问并修改一个共享的<code>ArrayList</code>。例如，你有一个订单处理系统，不同的线程负责添加新订单到订单列表，同时有其他线程可能会遍历订单列表进行统计等操作。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListThreadBug</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; orderList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动添加订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                orderList.add(i);
            }
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>; i &lt; <span class="hljs-number">2000</span>; i++) {
                orderList.add(i);
            }
        });

        <span class="hljs-comment">// 启动遍历订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">traverseThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (Integer order : orderList) {
                System.out.println(order);
            }
        });

        addThread1.start();
        addThread2.start();
        traverseThread.start();
    }
}
</code></pre>
<h2 data-id="heading-2">三、问题描述</h2>
<p>在运行上述代码时，你可能会遇到<code>ConcurrentModificationException</code>异常。这是因为<code>ArrayList</code>不是线程安全的，当多个线程同时对其进行修改和遍历操作时，就可能出现这种问题。在遍历过程中，如果其他线程修改了列表的结构（例如添加或删除元素），就会破坏迭代器的一致性，从而抛出该异常。</p>
<h2 data-id="heading-3">四、解决方案</h2>
<ol>
<li><strong>使用线程安全的集合类</strong>：可以将<code>ArrayList</code>替换为<code>CopyOnWriteArrayList</code>，它在修改时会创建一个新的数组，从而保证遍历操作的线程安全性。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CopyOnWriteArrayListExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; orderList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动添加订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                orderList.add(i);
            }
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>; i &lt; <span class="hljs-number">2000</span>; i++) {
                orderList.add(i);
            }
        });

        <span class="hljs-comment">// 启动遍历订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">traverseThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">for</span> (Integer order : orderList) {
                System.out.println(order);
            }
        });

        addThread1.start();
        addThread2.start();
        traverseThread.start();
    }
}
</code></pre>
<ol start="2">
<li><strong>使用同步机制</strong>：通过<code>synchronized</code>关键字来同步对<code>ArrayList</code>的访问，确保同一时间只有一个线程能修改或遍历列表。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedArrayListExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; orderList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动添加订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                    orderList.add(i);
                }
            }
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">addThread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>; i &lt; <span class="hljs-number">2000</span>; i++) {
                    orderList.add(i);
                }
            }
        });

        <span class="hljs-comment">// 启动遍历订单线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">traverseThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (lock) {
                <span class="hljs-keyword">for</span> (Integer order : orderList) {
                    System.out.println(order);
                }
            }
        });

        addThread1.start();
        addThread2.start();
        traverseThread.start();
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中日期格式化的潜在问题]]></title>    <link>https://juejin.cn/post/7577049352838971407</link>    <guid>https://juejin.cn/post/7577049352838971407</guid>    <pubDate>2025-11-27T08:46:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577049352838971407" data-draft-id="7513029089147666471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中日期格式化的潜在问题"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-27T08:46:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中日期格式化的潜在问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:46:50.000Z" title="Thu Nov 27 2025 08:46:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个电商系统中，需要将用户下单时间以特定格式展示给用户，同时在后台也会基于这个格式化后的时间进行一些数据统计和分析。开发人员使用 <code>SimpleDateFormat</code> 类对日期进行格式化操作。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.text.ParseException;
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateFormatBug</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy - MM - dd HH:mm:ss"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 模拟获取到的订单时间字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderTimeStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2023 - 10 - 15 14:30:00"</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Date</span> <span class="hljs-variable">orderDate</span> <span class="hljs-operator">=</span> dateFormat.parse(orderTimeStr);
            System.out.println(<span class="hljs-string">"解析后的日期: "</span> + dateFormat.format(orderDate));
        } <span class="hljs-keyword">catch</span> (ParseException e) {
            System.out.println(<span class="hljs-string">"日期解析错误: "</span> + e.getMessage());
        }


        <span class="hljs-comment">// 多线程环境下测试</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Date</span> <span class="hljs-variable">date1</span> <span class="hljs-operator">=</span> dateFormat.parse(<span class="hljs-string">"2023 - 10 - 16 10:00:00"</span>);
                System.out.println(<span class="hljs-string">"线程 1 解析后的日期: "</span> + dateFormat.format(date1));
            } <span class="hljs-keyword">catch</span> (ParseException e) {
                System.out.println(<span class="hljs-string">"线程 1 日期解析错误: "</span> + e.getMessage());
            }
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Date</span> <span class="hljs-variable">date2</span> <span class="hljs-operator">=</span> dateFormat.parse(<span class="hljs-string">"2023 - 10 - 17 15:30:00"</span>);
                System.out.println(<span class="hljs-string">"线程 2 解析后的日期: "</span> + dateFormat.format(date2));
            } <span class="hljs-keyword">catch</span> (ParseException e) {
                System.out.println(<span class="hljs-string">"线程 2 日期解析错误: "</span> + e.getMessage());
            }
        });

        thread1.start();
        thread2.start();
    }
}
</code></pre>
<h2 data-id="heading-2">三、问题描述</h2>
<ol>
<li><strong>单线程情况</strong>：乍一看，代码在单线程环境下运行良好，能正确地将字符串解析为 <code>Date</code> 对象并格式化输出。例如，上述代码在单线程执行 <code>main</code> 方法时，输出结果符合预期：</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">解析后的日期: 2023 - 10 - 15 14:30:00
</code></pre>
<ol start="2">
<li><strong>多线程情况</strong>：然而，在多线程环境下，<code>SimpleDateFormat</code> 不是线程安全的。当多个线程同时使用同一个 <code>SimpleDateFormat</code> 实例进行日期解析和格式化操作时，可能会出现不可预测的结果，比如抛出 <code>ParseException</code> 或者得到错误的格式化日期。在上述代码中启动 <code>thread1</code> 和 <code>thread2</code> 后，可能会出现以下错误输出：</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">线程 1 日期解析错误: Unparseable date: "2023 - 10 - 16 10:00:00"
线程 2 日期解析错误: Unparseable date: "2023 - 10 - 17 15:30:00"
</code></pre>
<p>这是因为 <code>SimpleDateFormat</code> 内部维护了一些状态信息，如日历对象等，多个线程并发访问和修改这些状态时会相互干扰，导致解析或格式化失败。</p>
<h2 data-id="heading-3">四、解决方案</h2>
<ol>
<li><strong>线程局部变量（ThreadLocal）</strong> ：可以使用 <code>ThreadLocal</code> 为每个线程创建独立的 <code>SimpleDateFormat</code> 实例，避免多线程之间的状态干扰。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.text.ParseException;
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateFormatBugFixed</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt; dateFormatThreadLocal = ThreadLocal.withInitial(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy - MM - dd HH:mm:ss"</span>));

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 模拟获取到的订单时间字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderTimeStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2023 - 10 - 15 14:30:00"</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Date</span> <span class="hljs-variable">orderDate</span> <span class="hljs-operator">=</span> dateFormatThreadLocal.get().parse(orderTimeStr);
            System.out.println(<span class="hljs-string">"解析后的日期: "</span> + dateFormatThreadLocal.get().format(orderDate));
        } <span class="hljs-keyword">catch</span> (ParseException e) {
            System.out.println(<span class="hljs-string">"日期解析错误: "</span> + e.getMessage());
        }


        <span class="hljs-comment">// 多线程环境下测试</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Date</span> <span class="hljs-variable">date1</span> <span class="hljs-operator">=</span> dateFormatThreadLocal.get().parse(<span class="hljs-string">"2023 - 10 - 16 10:00:00"</span>);
                System.out.println(<span class="hljs-string">"线程 1 解析后的日期: "</span> + dateFormatThreadLocal.get().format(date1));
            } <span class="hljs-keyword">catch</span> (ParseException e) {
                System.out.println(<span class="hljs-string">"线程 1 日期解析错误: "</span> + e.getMessage());
            }
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Date</span> <span class="hljs-variable">date2</span> <span class="hljs-operator">=</span> dateFormatThreadLocal.get().parse(<span class="hljs-string">"2023 - 10 - 17 15:30:00"</span>);
                System.out.println(<span class="hljs-string">"线程 2 解析后的日期: "</span> + dateFormatThreadLocal.get().format(date2));
            } <span class="hljs-keyword">catch</span> (ParseException e) {
                System.out.println(<span class="hljs-string">"线程 2 日期解析错误: "</span> + e.getMessage());
            }
        });

        thread1.start();
        thread2.start();
    }
}
</code></pre>
<ol start="2">
<li><strong>使用 Java 8 的 DateTimeFormatter</strong>：Java 8 引入的 <code>DateTimeFormatter</code> 是线程安全的。可以使用它来替代 <code>SimpleDateFormat</code>。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatterExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy - MM - dd HH:mm:ss"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 模拟获取到的订单时间字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderTimeStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"2023 - 10 - 15 14:30:00"</span>;

        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">orderDateTime</span> <span class="hljs-operator">=</span> LocalDateTime.parse(orderTimeStr, formatter);
        System.out.println(<span class="hljs-string">"解析后的日期: "</span> + orderDateTime.format(formatter));


        <span class="hljs-comment">// 多线程环境下测试</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">date1</span> <span class="hljs-operator">=</span> LocalDateTime.parse(<span class="hljs-string">"2023 - 10 - 16 10:00:00"</span>, formatter);
            System.out.println(<span class="hljs-string">"线程 1 解析后的日期: "</span> + date1.format(formatter));
        });

        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">date2</span> <span class="hljs-operator">=</span> LocalDateTime.parse(<span class="hljs-string">"2023 - 10 - 17 15:30:00"</span>, formatter);
            System.out.println(<span class="hljs-string">"线程 2 解析后的日期: "</span> + date2.format(formatter));
        });

        thread1.start();
        thread2.start();
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云渠道商：阿里云服务器出问题如何处理？]]></title>    <link>https://juejin.cn/post/7577189654488891442</link>    <guid>https://juejin.cn/post/7577189654488891442</guid>    <pubDate>2025-11-27T08:56:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654488891442" data-draft-id="7577050643202900018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云渠道商：阿里云服务器出问题如何处理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T08:56:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云渠道商yunshuguoji"/> <meta itemprop="url" content="https://juejin.cn/user/3854235718130362"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云渠道商：阿里云服务器出问题如何处理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3854235718130362/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云渠道商yunshuguoji
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:56:26.000Z" title="Thu Nov 27 2025 08:56:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>云服务器故障是业务运营中的高概率事件，据统计，超过80%的企业每年至少经历一次严重影响业务的云服务中断。正确的故障响应流程可将平均恢复时间（MTTR）从小时级缩短至分钟级，减少90%的业务损失。通过系统化的故障处理机制，企业不仅能快速恢复业务，更能从中积累经验，提升系统韧性。如果你还没有上云账号或上云实际使用云服务过程中有不懂的，可寻云枢国际yunshuguoji免卡上云用云以及获得专业的技术支持和折扣。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/888deed4d75d432db1da6a644db34afb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5rig6YGT5ZWGeXVuc2h1Z3Vvamk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838585&amp;x-signature=3HjT%2FiyYHXFeJxBI0NFq%2Fng15dE%3D" alt="3e90dd9372b04e95ac41846763b4ef0c~tplv-obj.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、故障处理核心原则</h2>
<h2 data-id="heading-2">1. 优先级划分标准</h2>
<p><strong>进行业务影响评估矩阵</strong></p>
<p><strong>优先级定义</strong>：</p>
<p>P0（紧急）：核心业务完全不可用，需立即全员响应</p>
<p>P1（高）：关键功能受损，1小时内必须处理</p>
<p>P2（中）：部分功能受影响，4小时内处理</p>
<p>P3（低）：轻微问题，24小时内解决</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab59ff492ddd48fe88652b1e22efaaab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5rig6YGT5ZWGeXVuc2h1Z3Vvamk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838585&amp;x-signature=sX1vjnEwL%2FGVNUChsYRSzqh6ho8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-3">三、故障诊断与处理流程</h2>
<h2 data-id="heading-4">1. 初步诊断与信息收集</h2>
<p><strong>故障识别检查表</strong>：</p>
<p>第一步: 症状分析</p>
<p>业务层面:</p>
<p>网站/应用是否可访问?</p>
<p>功能是否正常?</p>
<p>用户报告哪些错误?</p>
<p>系统层面:</p>
<p>服务器能否连接?</p>
<p>资源使用率是否异常?</p>
<p>日志有无错误信息?</p>
<p>第二步: 影响范围评估</p>
<p>受影响业务: [列出具体业务]</p>
<p>影响用户数: [预估影响范围]</p>
<p>数据完整性: [是否有数据丢失风险]</p>
<p><strong>2.四步应急处理流程</strong></p>






























<table><thead><tr><th><strong>步骤</strong></th><th><strong>操作指引</strong></th><th><strong>预期耗时</strong></th></tr></thead><tbody><tr><td><strong>1. 基础诊断</strong></td><td>登录控制台 → 查看「云监控」中的 CPU / 内存 / 带宽峰值（&gt;90% 需扩容）</td><td>3 分钟</td></tr><tr><td><strong>2. 网络检查</strong></td><td>进入「安全组」→ 验证端口开放状态（常见问题：SSH 22 端口被误关闭）</td><td>2 分钟</td></tr><tr><td><strong>3. 快速恢复</strong></td><td>使用「实例重启」功能（非强制重启，保留数据）</td><td>1 分钟</td></tr><tr><td><strong>4. 根因排查</strong></td><td>下载「系统日志」→ 搜索关键词 error/timeout</td><td/></tr></tbody></table>
<h2 data-id="heading-5">3. 数据恢复优先级排序：</h2>
<ol>
<li><strong>核心业务功能</strong>：确保主要业务流可运行</li>
<li><strong>数据完整性</strong>：恢复最新可用数据</li>
</ol>
<p>辅助功能：非核心功能可稍后恢复</p>
<h2 data-id="heading-6">四、总结</h2>
<h2 data-id="heading-7">1. 故障处理黄金法则</h2>
<p><strong>响应阶段要点</strong>：</p>
<ul>
<li><strong>先恢复，后排查</strong>：优先保证业务连续性</li>
<li><strong>沟通透明</strong>：及时向相关方通报处理进展</li>
<li><strong>文档记录</strong>：详细记录所有操作和现象</li>
</ul>
<p><strong>技术操作原则</strong>：</p>
<ul>
<li><strong>变更谨慎</strong>：生产环境变更要有回滚方案</li>
<li><strong>数据安全</strong>：确保操作不会导致数据丢失</li>
<li><strong>影响评估</strong>：评估操作对业务的影响范围</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>