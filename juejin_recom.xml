<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[c++11 之 智能指针]]></title>    <link>https://juejin.cn/post/7583906870827565065</link>    <guid>https://juejin.cn/post/7583906870827565065</guid>    <pubDate>2025-12-15T12:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906870827565065" data-draft-id="7576124206397341706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="c++11 之 智能指针"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-15T12:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GuSir"/> <meta itemprop="url" content="https://juejin.cn/user/3261574409623161"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            c++11 之 智能指针
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261574409623161/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GuSir
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:06:17.000Z" title="Mon Dec 15 2025 12:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 为什么会有智能指针</h2>
<p>c++ 引入智能指针（Smart Pointers）的核心目的，是 <strong>解决传统 raw pointer（裸指针）的三大核心问题</strong>，同时在不丧失 C++ 底层控制能力的前提下，引入更安全、更符合现代编程范式的内存管理机制。</p>
<h3 data-id="heading-1">1. 内存泄漏（Memory Leak）</h3>
<p>当动态分配的内存（<code>new</code> 出来的）没有被手动 <code>delete</code> 时，这块内存会一直占用，直到程序结束。</p>
<ul>
<li>函数提前返回（比如中间有 <code>if</code> 分支跳过 <code>delete</code>）；</li>
<li>异常抛出（<code>try</code> 块中 <code>new</code>，<code>catch</code> 块中未处理 <code>delete</code>）；</li>
<li>逻辑疏忽（忘记写 <code>delete</code>）。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 动态分配内存</span>
    <span class="hljs-keyword">if</span> (some_condition) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 提前返回，p 指向的内存未释放 → 内存泄漏</span>
    }
    <span class="hljs-keyword">delete</span> p; <span class="hljs-comment">// 正常路径才释放，异常/提前返回时失效</span>
}
</code></pre>
<h3 data-id="heading-2">2. 野指针（Dangling Pointer）</h3>
<p>当指针指向的内存被释放（<code>delete</code>）后，指针本身没有被置为 <code>nullptr</code>，后续仍可能被访问 / 操作，导致：</p>
<ul>
<li>程序崩溃（访问已释放的内存）；</li>
<li>数据错乱（内存被重新分配给其他对象，旧指针访问到无效数据）。</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-type">int</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">delete</span> p; <span class="hljs-comment">// 内存释放，但 p 仍指向原地址（野指针）</span>
cout &lt;&lt; *p; <span class="hljs-comment">// 未定义行为（UB），可能崩溃或输出垃圾值</span>
</code></pre>
<h3 data-id="heading-3">3. 二次释放（Double Free）</h3>
<p>同一内存被 <code>delete</code> 两次，会导致程序崩溃（内存管理机制检测到非法释放）.</p>
<p>示例 :</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-type">int</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">delete</span> p; 
<span class="hljs-keyword">delete</span> p; <span class="hljs-comment">// 二次释放 → 程序崩溃</span>
</code></pre>
<h2 data-id="heading-4">二. 智能指针的核心设计理念</h2>
<p><strong>RAII + 所有权语义</strong></p>
<p>智能指针本质是  <strong>“封装裸指针的类模板”</strong> ，其核心机制是：</p>
<ol>
<li>
<p><strong>RAII（资源获取即初始化）</strong> ：利用类的构造函数获取资源（如动态内存），析构函数自动释放资源（无需手动 <code>delete</code>）。因为 C++ 保证：对象生命周期结束时（如离开作用域、函数返回），其析构函数一定会被调用。</p>
</li>
<li>
<p><strong>所有权语义（Ownership Semantics）</strong> ：明确指针指向的内存 “归谁所有”，避免多指针混乱操作（比如 <code>std::unique_ptr</code> 独占所有权，<code>std::shared_ptr</code> 共享所有权）</p>
</li>
</ol>
<blockquote>
<p><strong>RAII</strong> 理解可以继续深入理解一下，这是一种编程范式</p>
</blockquote>
<h2 data-id="heading-5">三. 共享智能指帧 <code>std::shared_ptr</code></h2>
<p>核心特点是允许多个 <code>shared_ptr</code> 指向同一块动态内存，通过<strong>引用计数（Reference Counting）</strong>  管理内存生命周期：当最后一个指向该内存的 <code>shared_ptr</code> 被销毁 / 重置时，才会自动释放内存。</p>
<h3 data-id="heading-6">（1）引用计数机制</h3>
<ul>
<li><code>shared_ptr</code> 内部维护两个指针：
<ul>
<li>指向实际数据的<strong>裸指针</strong>（data pointer）；</li>
<li>指向控制块（control block）的指针（存储引用计数、析构函数、分配器等）</li>
</ul>
</li>
<li>每新增一个 <code>shared_ptr</code> 指向同一资源，引用计数 +1；</li>
<li>每销毁 / 重置一个 <code>shared_ptr</code>，引用计数 -1；</li>
<li>当引用计数降至 0 时，自动调用 <code>delete</code>（或自定义删除器）释放资源，并销毁控制块。</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyInt</span> {
    <span class="hljs-type">int</span> val;
    <span class="hljs-built_in">MyInt</span>(<span class="hljs-type">int</span> v) : <span class="hljs-built_in">val</span>(v) {
        <span class="hljs-comment">// std::cout &lt;&lt; "MyInt 构造：" &lt;&lt; val &lt;&lt; std::endl;</span>
    }
    ~<span class="hljs-built_in">MyInt</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"MyInt 析构："</span> &lt;&lt; val &lt;&lt; std::endl;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(std::shared_ptr&lt;MyInt&gt;&amp; ptr)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    <span class="hljs-comment">// 赋值新的 shared_ptr</span>
    ptr = std::<span class="hljs-built_in">make_shared</span>&lt;MyInt&gt;(<span class="hljs-number">20</span>);

    std::shared_ptr&lt;MyInt&gt; ptr2 = ptr;

    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;MyInt&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;MyInt&gt;(<span class="hljs-number">10</span>);
    std::cout &lt;&lt; <span class="hljs-string">"调用前引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    <span class="hljs-built_in">func</span>(sp);
    std::cout &lt;&lt; <span class="hljs-string">"调用后引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"sp 指向的值："</span> &lt;&lt; sp-&gt;val &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>执行结果:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13299364b93944098918a9fd261efe0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3VTaXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405177&amp;x-signature=sWnXNHrTolzBldR9fr4afv%2BaBMA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">（2）独占性（相对）与拷贝 / 赋值</h3>
<ul>
<li>支持<strong>拷贝构造</strong>和<strong>赋值运算符</strong>：拷贝 / 赋值时仅增加引用计数，不深拷贝数据；</li>
<li>不同于 <code>unique_ptr</code>（不可拷贝），<code>shared_ptr</code> 可自由拷贝、作为函数参数传递（值传递）、存入容器（如 <code>std::vector&lt;std::shared_ptr&lt;T&gt;&gt;</code>）。</li>
</ul>
<p>//详细解释，结合传参</p>
<h3 data-id="heading-8">（3）自定义删除器</h3>
<p><code>shared_ptr</code> 支持自定义删除器（Deletor），用于替代默认的 <code>delete</code>，适配特殊场景（如数组、文件句柄、内存池分配的内存等）。</p>
<blockquote>
<p>在计数到0的时候，就会执行删除器，-   如果只是“复制”或“赋值”产生新的 shared_ptr，引用计数仍 &gt;0，删除器不会被执行。</p>
</blockquote>
<h4 data-id="heading-9">场景 A:数组</h4>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">sp</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>],          <span class="hljs-comment">// 裸指针</span>
                       [](<span class="hljs-type">int</span>* p){ <span class="hljs-keyword">delete</span>[] p; } <span class="hljs-comment">// 自定义删除器</span>
)</span></span>;
</code></pre>
<h4 data-id="heading-10">场景 B:文件句柄</h4>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">auto</span> file_deleter = [](FILE* fp){
    <span class="hljs-keyword">if</span>(fp) <span class="hljs-built_in">fclose</span>(fp);
};
<span class="hljs-function">std::shared_ptr&lt;FILE&gt; <span class="hljs-title">sp</span><span class="hljs-params">(fopen(<span class="hljs-string">"log.txt"</span>,<span class="hljs-string">"w"</span>), file_deleter)</span></span>;
</code></pre>
<h4 data-id="heading-11">场景 C：内存池</h4>
<pre><code class="hljs language-arduino" lang="arduino">MemoryPool pool;
<span class="hljs-function">std::shared_ptr&lt;Foo&gt; <span class="hljs-title">sp</span><span class="hljs-params">(
    <span class="hljs-keyword">static_cast</span>&lt;Foo*&gt;(pool.allocate()),
    [&amp;pool](Foo* p){ pool.deallocate(p); }
)</span></span>;
</code></pre>
<h4 data-id="heading-12">场景 D：函数对象当删除器</h4>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">VerboseDeleter</span>{
    std::string name;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(Widget* w)</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"destroying "</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">'\n'</span>;
        <span class="hljs-keyword">delete</span> w;
    }
};
<span class="hljs-function">std::shared_ptr&lt;Widget&gt; <span class="hljs-title">pw</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Widget, VerboseDeleter{<span class="hljs-string">"widget#1"</span>})</span></span>;
</code></pre>
<h3 data-id="heading-13">（4）空指针安全</h3>
<ul>
<li>空的 <code>shared_ptr</code>（未指向任何资源）引用计数为 0，操作（如 <code>reset()</code>、<code>use_count()</code>）不会触发未定义行为；</li>
<li>可通过 <code>operator bool()</code> 判断是否指向有效资源：</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp">std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; p;
<span class="hljs-keyword">if</span> (p) { <span class="hljs-comment">// 等价于 p != nullptr</span>
    std::cout &lt;&lt; *p &lt;&lt; std::endl;
} <span class="hljs-keyword">else</span> {
    std::cout &lt;&lt; <span class="hljs-string">"p 为空"</span> &lt;&lt; std::endl; <span class="hljs-comment">// 输出该行</span>
}
</code></pre>
<h3 data-id="heading-14">（5）大小与性能</h3>
<ul>
<li><code>shared_ptr</code> 大小通常是<strong>裸指针的 2 倍</strong>（存储数据指针 + 控制块指针）；</li>
<li>引用计数的增减是<strong>原子操作</strong>（线程安全），但存在轻微的性能开销（相比裸指针 /<code>unique_ptr</code>）；</li>
<li>注意：引用计数线程安全 ≠ 数据访问线程安全：多个线程同时修改 <code>shared_ptr</code> 指向的数据，仍需加锁。</li>
</ul>
<h3 data-id="heading-15">（6）避免循环引用（核心坑点）</h3>
<p><code>shared_ptr</code> 的最大问题是<strong>循环引用</strong>：两个（或多个）<code>shared_ptr</code> 互相指向对方，导致引用计数无法降至 0，内存泄漏。</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
    std::shared_ptr&lt;Node&gt; next; <span class="hljs-comment">// 共享所有权</span>
    ~<span class="hljs-built_in">Node</span>() { std::cout &lt;&lt; <span class="hljs-string">"Node 析构"</span> &lt;&lt; std::endl; }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::shared_ptr&lt;Node&gt; <span class="hljs-title">n1</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Node)</span></span>;
    <span class="hljs-function">std::shared_ptr&lt;Node&gt; <span class="hljs-title">n2</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Node)</span></span>;
    n1-&gt;next = n2; <span class="hljs-comment">// n1 引用 n2</span>
    n2-&gt;next = n1; <span class="hljs-comment">// n2 引用 n1 → 循环引用</span>
    <span class="hljs-comment">// 函数结束时，n1/n2 销毁，但引用计数仍为1，内存泄漏（析构函数不执行）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-16">（7）避免从裸指针多次构造 shared_ptr</h3>
<p>同一裸指针多次构造 <code>shared_ptr</code>，会导致多个独立的控制块，最终触发<strong>二次释放</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span>* raw = new <span class="hljs-type">int</span>(<span class="hljs-number">10</span>);
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title function_">p1</span><span class="hljs-params">(raw)</span>;
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title function_">p2</span><span class="hljs-params">(raw)</span>; <span class="hljs-comment">// 错误：p1和p2各有独立控制块，析构时两次delete raw</span>
</code></pre>
<h3 data-id="heading-17">（8）优先使用 std::make_shared</h3>
<ul>
<li>更高效：一次性分配数据内存 + 控制块内存（裸指针构造需两次分配：数据 + 控制块）；</li>
<li>更安全：避免异常安全问题（如 <code>func(shared_ptr&lt;int&gt;(new int), other_func())</code> 可能因编译器优化导致内存泄漏）；</li>
<li>语法简洁：无需手动写 <code>new</code>。</li>
</ul>
<blockquote>
<p>限制：<code>make_shared</code> 无法直接指定自定义删除器（需通过 <code>shared_ptr</code> 构造函数配合）。</p>
</blockquote>
<h3 data-id="heading-18">（9）不要将 shared_ptr 存储在全局 / 静态变量中（谨慎）</h3>
<p>全局 <code>shared_ptr</code> 的析构顺序不确定，可能导致资源释放时依赖的对象已销毁，引发未定义行为。而且这个对象死的可能比main还晚</p>
<h3 data-id="heading-19">（10）线程安全说明</h3>
<ul>
<li><strong>引用计数操作</strong>：<code>shared_ptr</code> 的引用计数增减是原子操作，多线程拷贝 / 重置 <code>shared_ptr</code> 本身是线程安全的；</li>
<li><strong>数据访问</strong>：多线程同时读写 <code>shared_ptr</code> 指向的数据，<strong>不是线程安全的</strong>，需通过互斥锁（如 <code>std::mutex</code>）保护；</li>
<li><strong>同一 shared_ptr 对象的修改</strong>：多线程同时修改同一个 <code>shared_ptr</code> 对象（如 <code>p.reset()</code>），不是线程安全的，需加锁。</li>
</ul>
<h3 data-id="heading-20">（11）补充：shared_ptr 作为函数参数时的引用计数行为</h3>
<ul>
<li>
<p><strong>值传递：引用计数 +1，函数结束 -1</strong></p>
<p>当 <code>shared_ptr</code> 以<strong>值传递</strong>方式作为函数参数时，会触发 <code>shared_ptr</code> 的<strong>拷贝构造</strong>：</p>
<ol>
<li>函数调用时，实参的 <code>shared_ptr</code> 拷贝给形参，引用计数  <strong>+1</strong>；</li>
<li>函数执行结束后，形参出作用域被销毁，引用计数 <strong>-1</strong>；</li>
<li>最终引用计数回到调用前的状态。</li>
<li/>
</ol>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; ptr)</span> </span>{ <span class="hljs-comment">// 值传递，拷贝构造</span>
    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 2</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">10</span>);
    std::cout &lt;&lt; <span class="hljs-string">"调用前引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    <span class="hljs-built_in">func</span>(sp);
    std::cout &lt;&lt; <span class="hljs-string">"调用后引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>优缺点</strong></p>
<ul>
<li>
<p><strong>优点</strong>：函数内对形参的修改（如 <code>ptr = nullptr</code>）不会影响实参，逻辑隔离；</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li>拷贝 <code>shared_ptr</code> 有开销（原子操作 + 指针拷贝），高频调用时性能损耗明显；</li>
<li>若函数内长期持有形参（如存储到全局容器），可能导致引用计数长期不为 0，内存无法及时释放。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>非 const 引用传递：引用计数不变</strong></p>
<p>当 <code>shared_ptr</code> 以<strong>非 const 引用（<code>shared_ptr&lt;T&gt;&amp;</code>）</strong>  传递时，形参是实参的别名，不会触发拷贝构造，因此<strong>引用计数始终不变</strong>。</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyInt</span> {
    <span class="hljs-type">int</span> val;
    <span class="hljs-built_in">MyInt</span>(<span class="hljs-type">int</span> v) : <span class="hljs-built_in">val</span>(v) {
        std::cout &lt;&lt; <span class="hljs-string">"MyInt 构造："</span> &lt;&lt; val &lt;&lt; std::endl;
    }
    ~<span class="hljs-built_in">MyInt</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"MyInt 析构："</span> &lt;&lt; val &lt;&lt; std::endl;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(std::shared_ptr&lt;MyInt&gt;&amp; ptr)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    <span class="hljs-comment">// 赋值新的 shared_ptr</span>
    ptr = std::<span class="hljs-built_in">make_shared</span>&lt;MyInt&gt;(<span class="hljs-number">20</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;MyInt&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;MyInt&gt;(<span class="hljs-number">10</span>);
    std::cout &lt;&lt; <span class="hljs-string">"调用前引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    <span class="hljs-built_in">func</span>(sp);
    std::cout &lt;&lt; <span class="hljs-string">"调用后引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"sp 指向的值："</span> &lt;&lt; sp-&gt;val &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<blockquote>
<p>注意这里方法执行，重新创建一个对象的时候，会析构原来的</p>
</blockquote>
<p><strong>优缺点</strong></p>
<ul>
<li>
<p><strong>优点</strong>：函数内对形参的修改（如 <code>ptr = nullptr</code>）不会影响实参，逻辑隔离；</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ol>
<li>拷贝 <code>shared_ptr</code> 有开销（原子操作 + 指针拷贝），高频调用时性能损耗明显；</li>
<li>若函数内长期持有形参（如存储到全局容器），可能导致引用计数长期不为 0，内存无法及时释放。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>const 引用传递：引用计数不变</strong></p>
<p>当 <code>shared_ptr</code> 以<strong>const 引用（<code>const shared_ptr&lt;T&gt;&amp;</code>）</strong>  传递时，形参是实参的只读别名，同样不触发拷贝构造，<strong>引用计数不变</strong>；且函数内无法修改形参（如赋值、置空），避免了非 const 引用的风险。</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;<span class="hljs-type">int</span>&gt;&amp; ptr)</span> </span>{ <span class="hljs-comment">// const 引用传递</span>
    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    <span class="hljs-comment">// ptr = std::make_shared&lt;int&gt;(20); // 编译错误：const 引用不可修改</span>
    *ptr = <span class="hljs-number">20</span>; <span class="hljs-comment">// 允许修改指向的资源（仅限制 shared_ptr 本身，不限制资源）</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">10</span>);
    std::cout &lt;&lt; <span class="hljs-string">"调用前引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    <span class="hljs-built_in">func</span>(sp);
    std::cout &lt;&lt; <span class="hljs-string">"调用后引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    std::cout &lt;&lt; <span class="hljs-string">"sp 指向的值："</span> &lt;&lt; *sp &lt;&lt; std::endl; <span class="hljs-comment">// 输出 20</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>优缺点</strong></p>
<ul>
<li><strong>优点</strong>：无拷贝开销，性能优；只读特性避免了意外修改实参的风险，是最安全的传参方式；</li>
<li><strong>缺点</strong>：若函数内需要长期持有该 <code>shared_ptr</code>（如存储到容器），const 引用可能悬空（实参销毁后引用失效），需手动拷贝（此时引用计数会 +1）。</li>
</ul>
</li>
<li>
<p><strong>移动语义（std::move）传递</strong></p>
<p>若通过 <code>std::move</code> 将 <code>shared_ptr</code> 以值传递方式传入函数，会触发<strong>移动构造</strong>：</p>
<ol>
<li>实参的 <code>shared_ptr</code> 所有权转移给形参，引用计数 <strong>保持不变</strong>（而非 +1）；</li>
<li>实参变为 “空” 状态（<code>use_count() == 0</code>），不再管理资源；</li>
<li>函数结束后形参析构，引用计数 -1，若此时无其他持有者，资源被释放。</li>
</ol>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; ptr)</span> </span>{ <span class="hljs-comment">// 值传递 + std::move</span>
    std::cout &lt;&lt; <span class="hljs-string">"func 内引用计数："</span> &lt;&lt; ptr.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">10</span>);
    std::cout &lt;&lt; <span class="hljs-string">"move 前引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 1</span>
    <span class="hljs-built_in">func</span>(std::<span class="hljs-built_in">move</span>(sp));
    std::cout &lt;&lt; <span class="hljs-string">"move 后实参引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 输出 0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>移动构造会 “窃取” 实参的资源指针和引用计数，实参的内部指针被置空，因此引用计数不会增加（仅所有权转移）；适用于不再使用实参的场景，避免拷贝开销。</p>
</li>
</ul>
<h2 data-id="heading-21">四. 独享智能指帧 <code>std::unique_ptr</code></h2>
<p><code>std::unique_ptr</code> 是 C++11 引入的<strong>独占式智能指针</strong>，用于管理动态分配的内存，核心特性是<strong>所有权唯一</strong>—— 同一时间只有一个 <code>unique_ptr</code> 指向某个对象，销毁时自动释放内存，彻底避免内存泄漏和手动 <code>delete</code> 的风险。使用相对共享指针要简单，但却是最常用的智能指针。</p>
<ol>
<li><strong>独占所有权</strong>：不可拷贝（C++11），仅可移动（move），确保对象只有一个管理者；</li>
<li><strong>自动释放</strong>：<code>unique_ptr</code> 析构时（如离开作用域、被重置），自动调用 <code>delete</code> 释放所管理的内存；</li>
<li><strong>轻量级</strong>：无额外开销（大小等同于原始指针），支持自定义删除器；</li>
<li><strong>支持数组</strong>：C++11 原生支持管理动态数组（<code>unique_ptr&lt;T[]&gt;</code>）。</li>
</ol>
<p>简单用法，单个对象:</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// 方式1：直接构造（C++11 推荐）</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr1</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">10</span>))</span></span>;

<span class="hljs-comment">// 方式2：make_unique（C++14 引入，更安全，避免内存泄漏）</span>
<span class="hljs-comment">// C++11 无 make_unique，可自行实现</span>
unique_ptr&lt;<span class="hljs-type">int</span>&gt; ptr2 = <span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">20</span>);

<span class="hljs-comment">// 空 unique_ptr</span>
unique_ptr&lt;<span class="hljs-type">int</span>&gt; ptr3; <span class="hljs-comment">// 初始化为 nullptr</span>
</code></pre>
<p>管理动态数组：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// 管理 int 数组，析构时自动调用 delete[]</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>[]&gt; <span class="hljs-title">arr_ptr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">5</span>]{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>})</span></span>;
<span class="hljs-comment">// 访问数组元素</span>
cout &lt;&lt; arr_ptr[<span class="hljs-number">0</span>] &lt;&lt; endl; <span class="hljs-comment">// 输出 1</span>
</code></pre>
<p>通过 <code>*</code> 解引用（单个对象）或 <code>-&gt;</code>（成员访问），或 <code>[]</code>（数组）：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> {
    string name;
    <span class="hljs-type">int</span> age;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; name &lt;&lt; <span class="hljs-string">", "</span> &lt;&lt; age &lt;&lt; endl; }
};

<span class="hljs-comment">// 单个对象</span>
<span class="hljs-function">unique_ptr&lt;Person&gt; <span class="hljs-title">p</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Person{<span class="hljs-string">"Alice"</span>, <span class="hljs-number">20</span>})</span></span>;
cout &lt;&lt; (*p).name &lt;&lt; endl; <span class="hljs-comment">// 解引用访问成员</span>
cout &lt;&lt; p-&gt;age &lt;&lt; endl;    <span class="hljs-comment">// -&gt; 访问成员</span>
p-&gt;<span class="hljs-built_in">show</span>();                 <span class="hljs-comment">// 调用成员函数</span>

<span class="hljs-comment">// 数组</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>[]&gt; <span class="hljs-title">arr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">3</span>]{<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>})</span></span>;
cout &lt;&lt; arr[<span class="hljs-number">1</span>] &lt;&lt; endl; <span class="hljs-comment">// 输出 20</span>
</code></pre>
<p><strong>重置与释放</strong></p>
<ul>
<li><code>reset()</code>：释放当前管理的对象，可选传入新指针；</li>
<li><code>release()</code>：释放所有权（返回原始指针），但不释放内存（需手动管理）；</li>
<li><code>nullptr</code> 赋值：等价于 <code>reset()</code>。</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">50</span>))</span></span>;

<span class="hljs-comment">// 重置（释放原内存，指向新对象）</span>
ptr.<span class="hljs-built_in">reset</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">60</span>));
cout &lt;&lt; *ptr &lt;&lt; endl; <span class="hljs-comment">// 输出 60</span>

<span class="hljs-comment">// 重置为空（释放原内存）</span>
ptr.<span class="hljs-built_in">reset</span>();
cout &lt;&lt; (ptr ? <span class="hljs-string">"非空"</span> : <span class="hljs-string">"空"</span>) &lt;&lt; endl; <span class="hljs-comment">// 输出 空</span>

<span class="hljs-comment">// release()：释放所有权，返回原始指针</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr2</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">70</span>))</span></span>;
<span class="hljs-type">int</span>* raw_ptr = ptr2.<span class="hljs-built_in">release</span>(); 
cout &lt;&lt; *raw_ptr &lt;&lt; endl; <span class="hljs-comment">// 输出 70</span>
<span class="hljs-keyword">delete</span> raw_ptr; <span class="hljs-comment">// 必须手动释放，否则内存泄漏</span>
ptr2.<span class="hljs-built_in">reset</span>(); <span class="hljs-comment">// ptr2 已空，重置无影响</span>
</code></pre>
<p><strong>自定义删除器</strong></p>
<p>默认删除器调用 <code>delete</code>/<code>delete[]</code>，但可自定义删除器（如管理 <code>FILE*</code>、动态库句柄等）。</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// 自定义删除器：关闭文件</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">close_file</span><span class="hljs-params">(FILE* fp)</span> </span>{
    <span class="hljs-keyword">if</span> (fp) {
        <span class="hljs-built_in">fclose</span>(fp);
        cout &lt;&lt; <span class="hljs-string">"文件已关闭"</span> &lt;&lt; endl;
    }
}

<span class="hljs-comment">// 创建 unique_ptr，指定删除器类型</span>
<span class="hljs-function">unique_ptr&lt;FILE, <span class="hljs-title">decltype</span><span class="hljs-params">(&amp;close_file)</span>&gt; <span class="hljs-title">file_ptr</span><span class="hljs-params">(fopen(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"w"</span>), close_file)</span></span>;
<span class="hljs-keyword">if</span> (file_ptr) {
    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">"hello unique_ptr"</span>, file_ptr.<span class="hljs-built_in">get</span>());
}
<span class="hljs-comment">// 析构时自动调用 close_file</span>
</code></pre>
<p><strong>Lambda 作为删除器（更简洁）</strong></p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// 管理动态数组，自定义删除器（示例，实际 delete[] 已足够）</span>
<span class="hljs-keyword">auto</span> deleter = [](<span class="hljs-type">int</span>* arr) {
    cout &lt;&lt; <span class="hljs-string">"释放数组内存"</span> &lt;&lt; endl;
    <span class="hljs-keyword">delete</span>[] arr;
};
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>[], <span class="hljs-title">decltype</span><span class="hljs-params">(deleter)</span>&gt; <span class="hljs-title">arr_ptr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">3</span>], deleter)</span></span>;
</code></pre>
<p><strong>其他常用成员函数</strong></p>

















<table><thead><tr><th><code>get()</code></th><th>返回原始指针（仅访问，不释放所有权）</th></tr></thead><tbody><tr><td><code>swap()</code></td><td>交换两个 <code>unique_ptr</code> 的所有权</td></tr><tr><td><code>operator bool()</code></td><td>判断是否指向有效对象（非空）</td></tr></tbody></table>
<p><strong>场景使用场景</strong></p>
<ul>
<li>替代原始指针，避免内存泄漏</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">func</span>()</span> {
    <span class="hljs-built_in">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span>);
    <span class="hljs-comment">// 若中间抛出异常，delete 不会执行，内存泄漏</span>
    delete ptr;
}

<span class="hljs-comment">// unique_ptr：自动释放</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">func_safe</span>()</span> {
    <span class="hljs-function">unique_ptr&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">ptr</span>(<span class="hljs-params"><span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span></span>))</span>;
    <span class="hljs-comment">// 即使抛出异常，析构时自动释放</span>
}
</code></pre>
<ul>
<li>作为函数返回值（移动语义自动生效）</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function">unique_ptr&lt;Person&gt; <span class="hljs-title">create_person</span><span class="hljs-params">(string name, <span class="hljs-type">int</span> age)</span> </span>{
    <span class="hljs-comment">// C++11 中，返回值会自动移动（无需显式 std::move）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">unique_ptr</span>&lt;Person&gt;(<span class="hljs-keyword">new</span> Person{name, age});
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-keyword">auto</span> p = <span class="hljs-built_in">create_person</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">25</span>);
p-&gt;<span class="hljs-built_in">show</span>(); <span class="hljs-comment">// 输出 Bob, 25</span>
</code></pre>
<ul>
<li>存储在容器中</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">vector&lt;unique_ptr&lt;<span class="hljs-type">int</span>&gt;&gt; vec;
<span class="hljs-comment">// 方式1：emplace_back 直接构造</span>
vec.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">10</span>));
<span class="hljs-comment">// 方式2：move 插入</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">20</span>))</span></span>;
vec.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">move</span>(ptr));

<span class="hljs-comment">// 遍历容器</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; p : vec) {
    cout &lt;&lt; *p &lt;&lt; <span class="hljs-string">" "</span>; <span class="hljs-comment">// 输出 10 20</span>
}
</code></pre>
<p><strong>其他事项</strong></p>
<ul>
<li><strong>禁止拷贝</strong>：C++11 中 <code>unique_ptr</code> 的拷贝构造和拷贝赋值被 <code>delete</code></li>
<li><strong>避免裸指针与智能指针混用</strong>：不要用 <code>get()</code> 返回的指针创建新的 <code>unique_ptr</code>，否则会重复释放；</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>(<span class="hljs-number">10</span>))</span></span>;
<span class="hljs-comment">// 错误：两个 unique_ptr 管理同一内存，析构时双重释放</span>
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr2</span><span class="hljs-params">(ptr.get())</span></span>; 
</code></pre>
<ul>
<li><strong><code>make_unique</code> 更安全</strong>：C++14 引入 <code>make_unique</code>，避免 “new 表达式” 和 “智能指针构造” 之间的异常安全问题，C++11 可自行实现：</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span>... Args&gt;
unique_ptr&lt;T&gt; <span class="hljs-title">make_unique</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">unique_ptr</span>&lt;T&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>(std::forward&lt;Args&gt;(args)...));
}
</code></pre>
<p>-<strong>数组管理</strong>：<code>unique_ptr&lt;T[]&gt;</code> 不支持 <code>*</code> 和 <code>-&gt;</code>，仅支持 <code>[]</code> 访问；</p>
<ul>
<li><strong>不要管理栈内存</strong>：<code>unique_ptr</code> 仅用于管理堆内存（<code>new</code>/<code>new[]</code> 分配），若指向栈对象，析构时会调用 <code>delete</code>，导致未定义行为：</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">int</span> a = <span class="hljs-number">10</span>;
<span class="hljs-function">unique_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ptr</span><span class="hljs-params">(&amp;a)</span></span>; <span class="hljs-comment">// 错误：栈内存不能被 delete</span>
</code></pre>
<h2 data-id="heading-22">五. 弱引用智能指正 <code>std::weak_ptr</code></h2>
<p><code>std::weak_ptr</code> 是 C++11 引入的智能指针，<strong>专门用于解决 <code>std::shared_ptr</code> 循环引用导致的内存泄漏问题</strong>，它本身不管理对象的生命周期，仅作为 <code>shared_ptr</code> 的 “弱引用”—— 既可以访问共享对象，又不会增加引用计数。</p>
<p><strong>核心特性</strong></p>
<ol>
<li><strong>不增加引用计数</strong>：绑定到 <code>shared_ptr</code> 时，不会改变其引用计数，因此不会阻止对象被销毁</li>
<li><strong>可检测对象是否存活</strong>：通过 <code>expired()</code> 或 <code>lock()</code> 检查所指向的对象是否已被销毁</li>
<li><strong>不能直接解引用</strong>：必须先通过 <code>lock()</code> 转换为 <code>shared_ptr</code>，才能安全访问对象（避免访问已销毁的对象）</li>
<li><strong>线程安全</strong>：与 <code>shared_ptr</code> 类似，读操作线程安全，写操作（如 <code>lock()</code>）需加锁</li>
</ol>
<blockquote>
<p><code>lock()</code> 是特殊的 “写操作”—— 它会先检查 <code>use_count</code>（读），若对象存活则创建 <code>shared_ptr</code>，此时会<strong>原子性增加 <code>use_count</code></strong>（写）</p>
</blockquote>
<p><strong>基本用法</strong>
<code>std::weak_ptr</code> 不能直接指向裸指针，必须通过 <code>shared_ptr</code> 初始化或赋值：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 通过 shared_ptr 初始化</span>
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">10</span>);
    <span class="hljs-function">std::weak_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">wp</span><span class="hljs-params">(sp)</span></span>; <span class="hljs-comment">// 引用计数仍为 1</span>

    <span class="hljs-comment">// 2. 空 weak_ptr</span>
    std::weak_ptr&lt;<span class="hljs-type">int</span>&gt; wp_empty;

    <span class="hljs-comment">// 3. 赋值操作</span>
    std::weak_ptr&lt;<span class="hljs-type">int</span>&gt; wp2;
    wp2 = sp; <span class="hljs-comment">// 引用计数仍为 1</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>核心成员函数</strong></p>





























<table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td><code>lock()</code></td><td>转换为 <code>shared_ptr</code>：若对象存活，返回指向该对象的 <code>shared_ptr</code>；否则返回空 <code>shared_ptr</code></td></tr><tr><td><code>expired()</code></td><td>判断对象是否已销毁（引用计数为 0），返回 <code>bool</code></td></tr><tr><td><code>reset()</code></td><td>清空 <code>weak_ptr</code>，不再引用任何对象</td></tr><tr><td><code>use_count()</code></td><td>返回当前 <code>shared_ptr</code> 的引用计数（慎用，仅用于调试）</td></tr><tr><td><code>swap()</code></td><td>交换两个 <code>weak_ptr</code> 的引用对象</td></tr></tbody></table>
<p><strong>安全访问对象（lock () 核心用法）</strong></p>
<p><code>weak_ptr</code> 不能直接解引用，必须通过 <code>lock()</code> 获取 <code>shared_ptr</code> 后访问：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// 主函数：程序执行的起点（必须有且仅有一个）</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>


<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">100</span>);
    <span class="hljs-function">std::weak_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">wp</span><span class="hljs-params">(sp)</span></span>;

    <span class="hljs-comment">// 安全访问：先 lock() 转换为 shared_ptr</span>
    
    <span class="hljs-keyword">if</span> (std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; temp = wp.<span class="hljs-built_in">lock</span>()) {
        std::cout &lt;&lt; <span class="hljs-string">"对象值："</span> &lt;&lt; *temp &lt;&lt; std::endl; <span class="hljs-comment">// 输出 100</span>
        std::cout &lt;&lt; <span class="hljs-string">"引用计数："</span> &lt;&lt; temp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 2</span>
    } <span class="hljs-keyword">else</span> {
        std::cout &lt;&lt; <span class="hljs-string">"对象已销毁"</span> &lt;&lt; std::endl;
    }

    std::cout &lt;&lt; <span class="hljs-string">"sp 引用计数："</span> &lt;&lt; sp.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 2</span>

    <span class="hljs-comment">// 销毁 shared_ptr，对象被释放</span>
    sp.<span class="hljs-built_in">reset</span>();

    <span class="hljs-comment">// 再次尝试访问</span>
    <span class="hljs-keyword">auto</span> temp2 = wp.<span class="hljs-built_in">lock</span>();
    <span class="hljs-keyword">if</span> (temp2) {
        std::cout &lt;&lt; <span class="hljs-string">"对象值："</span> &lt;&lt; *temp2 &lt;&lt; std::endl; <span class="hljs-comment">// 输出 100 std::cout &lt;&lt; *temp2 &lt;&lt; std::endl;</span>
        std::cout &lt;&lt; <span class="hljs-string">"引用计数："</span> &lt;&lt; temp2.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl; <span class="hljs-comment">// 2</span>
    } <span class="hljs-keyword">else</span> {
        std::cout &lt;&lt; <span class="hljs-string">"对象已销毁"</span> &lt;&lt; std::endl; <span class="hljs-comment">// 输出此行</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>expired () 检查对象存活</strong></p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; sp = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">200</span>);
    <span class="hljs-function">std::weak_ptr&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">wp</span><span class="hljs-params">(sp)</span></span>;

    <span class="hljs-keyword">if</span> (!wp.<span class="hljs-built_in">expired</span>()) {
        std::cout &lt;&lt; <span class="hljs-string">"对象存活"</span> &lt;&lt; std::endl; <span class="hljs-comment">// 输出</span>
    }

    sp.<span class="hljs-built_in">reset</span>();
    <span class="hljs-keyword">if</span> (wp.<span class="hljs-built_in">expired</span>()) {
        std::cout &lt;&lt; <span class="hljs-string">"对象已销毁"</span> &lt;&lt; std::endl; <span class="hljs-comment">// 输出</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>解决循环引用问题（核心场景）</strong></p>
<p><code>shared_ptr</code> 循环引用会导致引用计数无法归 0，对象无法析构，最终内存泄漏。<code>weak_ptr</code> 因不增加引用计数，可打破循环。</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">B</span>; <span class="hljs-comment">// 前向声明</span>

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">A</span> {
    std::shared_ptr&lt;B&gt; b_ptr;
    ~<span class="hljs-built_in">A</span>() { std::cout &lt;&lt; <span class="hljs-string">"A 析构"</span> &lt;&lt; std::endl; }
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">B</span> {
    std::shared_ptr&lt;A&gt; a_ptr; <span class="hljs-comment">// 循环引用</span>
    ~<span class="hljs-built_in">B</span>() { std::cout &lt;&lt; <span class="hljs-string">"B 析构"</span> &lt;&lt; std::endl; }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    {
        std::shared_ptr&lt;A&gt; a = std::<span class="hljs-built_in">make_shared</span>&lt;A&gt;();
        std::shared_ptr&lt;B&gt; b = std::<span class="hljs-built_in">make_shared</span>&lt;B&gt;();
        a-&gt;b_ptr = b;
        b-&gt;a_ptr = a;
        <span class="hljs-comment">// 离开作用域时，a 和 b 的引用计数均为 2，无法析构</span>
    }
    std::cout &lt;&lt; <span class="hljs-string">"作用域结束"</span> &lt;&lt; std::endl; <span class="hljs-comment">// 输出，但 A/B 未析构</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>修改后</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span> {</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;B&gt; b_ptr;
    ~A() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A 析构"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span> {</span>
    <span class="hljs-built_in">std</span>::weak_ptr&lt;A&gt; a_ptr; <span class="hljs-comment">// 改为 weak_ptr，不增加引用计数</span>
    ~B() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B 析构"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; }
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;A&gt; a = <span class="hljs-built_in">std</span>::make_shared&lt;A&gt;();
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;B&gt; b = <span class="hljs-built_in">std</span>::make_shared&lt;B&gt;();
        a-&gt;b_ptr = b;
        b-&gt;a_ptr = a;
        <span class="hljs-comment">// a 的引用计数：1（b-&gt;a_ptr 是 weak_ptr，不计数）</span>
        <span class="hljs-comment">// b 的引用计数：1（a-&gt;b_ptr 是 shared_ptr，计数+1）</span>
    }
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"作用域结束"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NumPy数值计算全教程：多维数组操作、广播机制、线性代数运算（附实战案例）]]></title>    <link>https://juejin.cn/post/7583878719543984137</link>    <guid>https://juejin.cn/post/7583878719543984137</guid>    <pubDate>2025-12-15T12:37:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583878719543984137" data-draft-id="7583878719543967753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NumPy数值计算全教程：多维数组操作、广播机制、线性代数运算（附实战案例）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-15T12:37:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI能力探索"/> <meta itemprop="url" content="https://juejin.cn/user/1549641121016795"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NumPy数值计算全教程：多维数组操作、广播机制、线性代数运算（附实战案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549641121016795/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI能力探索
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:37:30.000Z" title="Mon Dec 15 2025 12:37:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>NumPy是Python科学计算的核心库，以高性能的多维数组（ndarray）为基础，提供了丰富的数值计算功能，广泛应用于数据分析、机器学习、科学仿真等领域。</p>
<h2 data-id="heading-0">一、前期准备</h2>
<h3 data-id="heading-1">1. 环境配置</h3>
<ul>
<li>安装NumPy：<code>pip install numpy</code>（建议Python 3.8+版本）；</li>
<li>验证安装：在Python终端执行<code>import numpy as np</code>，无报错则安装成功；</li>
<li>辅助工具：Jupyter Notebook（便于分段运行代码、查看结果）。</li>
</ul>
<h3 data-id="heading-2">2. 核心概念梳理</h3>
<ul>
<li><strong>ndarray</strong>：NumPy的核心数据结构，即多维数组，支持同类型元素存储，比Python列表更高效；</li>
<li><strong>维度（ndim）</strong>：数组的轴数，如一维数组（1D）、二维数组（2D，矩阵）、三维数组（3D）；</li>
<li><strong>形状（shape）</strong>：数组各维度的元素个数，如<code>(3,4)</code>表示3行4列的二维数组；</li>
<li><strong>数据类型（dtype）</strong>：数组元素的类型，如<code>int32</code>、<code>float64</code>、<code>bool</code>；</li>
<li><strong>广播机制</strong>：不同形状数组间运算时，NumPy自动扩展数组维度以匹配形状的规则；</li>
<li><strong>线性代数</strong>：基于ndarray实现矩阵乘法、求逆、特征值、行列式等运算。</li>
</ul>
<h2 data-id="heading-3">二、实战1：多维数组核心操作</h2>
<p>多维数组是NumPy的基础，掌握创建、索引、变形、拼接等操作，是后续计算的前提。</p>
<h3 data-id="heading-4">1. 数组创建（常用方式）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 1. 从列表/嵌套列表创建</span>
arr1 = np.array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])  <span class="hljs-comment"># 一维数组</span>
arr2 = np.array([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>]])  <span class="hljs-comment"># 二维数组（3行2列）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"一维数组：\n"</span>, arr1)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"二维数组形状："</span>, arr2.shape)  <span class="hljs-comment"># 输出：(3, 2)</span>

<span class="hljs-comment"># 2. 特殊数组创建（实战高频）</span>
arr_zeros = np.zeros((<span class="hljs-number">2</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 全0数组（2行3列）</span>
arr_ones = np.ones((<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), dtype=np.int32)  <span class="hljs-comment"># 全1数组，指定int32类型</span>
arr_empty = np.empty((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>))  <span class="hljs-comment"># 空数组（内存随机值，仅占位）</span>
arr_range = np.arange(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 等差数列：0,2,4,6,8</span>
arr_linspace = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 等间隔数组：0,0.25,0.5,0.75,1</span>
arr_eye = np.eye(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 单位矩阵（3x3）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"单位矩阵：\n"</span>, arr_eye)
</code></pre>
<h3 data-id="heading-5">2. 数组索引与切片</h3>
<h4 data-id="heading-6">（1）一维数组（与Python列表类似）</h4>
<pre><code class="hljs language-python" lang="python">arr = np.arange(<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(arr[<span class="hljs-number">5</span>])  <span class="hljs-comment"># 索引：取第6个元素（5）</span>
<span class="hljs-built_in">print</span>(arr[<span class="hljs-number">2</span>:<span class="hljs-number">7</span>])  <span class="hljs-comment"># 切片：2-6（左闭右开）</span>
<span class="hljs-built_in">print</span>(arr[::<span class="hljs-number">2</span>])  <span class="hljs-comment"># 步长2：0,2,4,6,8</span>
</code></pre>
<h4 data-id="heading-7">（2）二维数组（行+列索引）</h4>
<pre><code class="hljs language-python" lang="python">arr = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], [<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>]])
<span class="hljs-comment"># 取第2行第3列元素（6）</span>
<span class="hljs-built_in">print</span>(arr[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>])
<span class="hljs-comment"># 取第1行所有列</span>
<span class="hljs-built_in">print</span>(arr[<span class="hljs-number">0</span>, :])
<span class="hljs-comment"># 取所有行的第2列</span>
<span class="hljs-built_in">print</span>(arr[:, <span class="hljs-number">1</span>])
<span class="hljs-comment"># 取前2行、前2列</span>
<span class="hljs-built_in">print</span>(arr[:<span class="hljs-number">2</span>, :<span class="hljs-number">2</span>])
<span class="hljs-comment"># 布尔索引：筛选大于5的元素</span>
<span class="hljs-built_in">print</span>(arr[arr &gt; <span class="hljs-number">5</span>])  <span class="hljs-comment"># 输出：[6 7 8 9]</span>
</code></pre>
<h3 data-id="heading-8">3. 数组变形与重塑</h3>
<pre><code class="hljs language-python" lang="python">arr = np.arange(<span class="hljs-number">12</span>)
<span class="hljs-comment"># 重塑为3行4列</span>
arr_reshape = arr.reshape(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"重塑后：\n"</span>, arr_reshape)

<span class="hljs-comment"># 展平数组（多维转一维）</span>
arr_flat = arr_reshape.flatten()  <span class="hljs-comment"># 拷贝数据，原数组不变</span>
arr_ravel = arr_reshape.ravel()   <span class="hljs-comment"># 视图，原数组改变会同步</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"展平数组："</span>, arr_flat)

<span class="hljs-comment"># 转置（行变列，列变行）</span>
arr_trans = arr_reshape.T
<span class="hljs-built_in">print</span>(<span class="hljs-string">"转置后：\n"</span>, arr_trans)
</code></pre>
<h3 data-id="heading-9">4. 数组拼接与分割</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 拼接</span>
arr1 = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]])
arr2 = np.array([[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], [<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]])
<span class="hljs-comment"># 纵向拼接（行增加）</span>
arr_vstack = np.vstack((arr1, arr2))
<span class="hljs-comment"># 横向拼接（列增加）</span>
arr_hstack = np.hstack((arr1, arr2))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"纵向拼接：\n"</span>, arr_vstack)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"横向拼接：\n"</span>, arr_hstack)

<span class="hljs-comment"># 分割</span>
arr = np.arange(<span class="hljs-number">9</span>).reshape(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)
<span class="hljs-comment"># 横向分割（按列分）</span>
arr_split1, arr_split2 = np.hsplit(arr, <span class="hljs-number">2</span>)
<span class="hljs-comment"># 纵向分割（按行分）</span>
arr_split3, arr_split4 = np.vsplit(arr, <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"横向分割结果：\n"</span>, arr_split1)
</code></pre>
<h2 data-id="heading-10">三、实战2：广播机制（核心难点）</h2>
<p>广播是NumPy中不同形状数组间运算的核心规则，能避免手动扩展数组，提升计算效率。</p>
<h3 data-id="heading-11">1. 广播的核心规则</h3>
<ul>
<li>规则1：如果两个数组维度不同，先将维度少的数组补1，直到维度数相同；</li>
<li>规则2：对于每个维度，若长度相同或其中一个为1，则可以广播，否则报错；</li>
<li>规则3：广播时，长度为1的维度会被扩展为匹配另一个数组的长度。</li>
</ul>
<h3 data-id="heading-12">2. 基础广播案例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 案例1：标量与数组运算（最常见）</span>
arr = np.array([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])
result = arr + <span class="hljs-number">5</span>  <span class="hljs-comment"># 标量5广播为[5,5,5]</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"标量广播："</span>, result)  <span class="hljs-comment"># 输出：[6 7 8]</span>

<span class="hljs-comment"># 案例2：一维数组与二维数组运算</span>
arr1 = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]])  <span class="hljs-comment"># (2,3)</span>
arr2 = np.array([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>])        <span class="hljs-comment"># (3,) → 补1为(1,3) → 广播为(2,3)</span>
result = arr1 + arr2
<span class="hljs-built_in">print</span>(<span class="hljs-string">"一维+二维广播：\n"</span>, result)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[11 22 33]</span>
<span class="hljs-comment">#  [14 25 36]]</span>

<span class="hljs-comment"># 案例3：不同维度广播（需满足规则）</span>
arr3 = np.array([[<span class="hljs-number">1</span>], [<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>]])  <span class="hljs-comment"># (3,1)</span>
arr4 = np.array([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>])         <span class="hljs-comment"># (2,) → 补1为(1,2) → 广播为(3,2)</span>
result = arr3 * arr4
<span class="hljs-built_in">print</span>(<span class="hljs-string">"不同维度广播：\n"</span>, result)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[10 20]</span>
<span class="hljs-comment">#  [20 40]</span>
<span class="hljs-comment">#  [30 60]]</span>

<span class="hljs-comment"># 错误案例（不满足规则）</span>
<span class="hljs-comment"># arr5 = np.array([1,2])  # (2,)</span>
<span class="hljs-comment"># arr6 = np.array([[1,2,3], [4,5,6]])  # (2,3)</span>
<span class="hljs-comment"># result = arr5 + arr6  # 报错：维度不匹配</span>
</code></pre>
<h3 data-id="heading-13">3. 广播的实战应用（数据归一化）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 对二维数组每行进行归一化：(值-均值)/标准差</span>
data = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], [<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>]])
<span class="hljs-comment"># 计算每行均值（axis=1，保持维度便于广播）</span>
mean = np.mean(data, axis=<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 计算每行标准差</span>
std = np.std(data, axis=<span class="hljs-number">1</span>, keepdims=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 广播运算</span>
normalized_data = (data - mean) / std
<span class="hljs-built_in">print</span>(<span class="hljs-string">"归一化后：\n"</span>, normalized_data)
<span class="hljs-comment"># 输出每行均值为0，标准差为1的数组</span>
</code></pre>
<h2 data-id="heading-14">四、实战3：线性代数运算（核心应用）</h2>
<p>NumPy的<code>numpy.linalg</code>模块提供了完整的线性代数运算接口，满足矩阵分析、线性方程组求解等需求。</p>
<h3 data-id="heading-15">1. 基础矩阵运算</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 矩阵乘法（注意：不是元素相乘）</span>
A = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]])
B = np.array([[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], [<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]])
<span class="hljs-comment"># 方法1：np.dot()（兼容一维/二维）</span>
dot_result = np.dot(A, B)
<span class="hljs-comment"># 方法2：@运算符（Python 3.5+，推荐）</span>
at_result = A @ B
<span class="hljs-built_in">print</span>(<span class="hljs-string">"矩阵乘法：\n"</span>, at_result)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[19 22]</span>
<span class="hljs-comment">#  [43 50]]</span>

<span class="hljs-comment"># 元素相乘（与矩阵乘法区分）</span>
element_mul = A * B
<span class="hljs-built_in">print</span>(<span class="hljs-string">"元素相乘：\n"</span>, element_mul)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[ 5 12]</span>
<span class="hljs-comment">#  [21 32]]</span>

<span class="hljs-comment"># 矩阵求逆（仅方阵且可逆）</span>
A_inv = np.linalg.inv(A)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"矩阵A的逆：\n"</span>, A_inv)

<span class="hljs-comment"># 矩阵转置</span>
A_trans = A.T
<span class="hljs-built_in">print</span>(<span class="hljs-string">"矩阵A的转置：\n"</span>, A_trans)

<span class="hljs-comment"># 行列式计算</span>
det_A = np.linalg.det(A)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"矩阵A的行列式："</span>, det_A)  <span class="hljs-comment"># 输出：-2.0000000000000004</span>
</code></pre>
<h3 data-id="heading-16">2. 线性方程组求解</h3>
<p>求解方程组：</p>
<pre><code class="hljs language-ini" lang="ini">x + <span class="hljs-attr">2y</span> = <span class="hljs-number">5</span>
3x + <span class="hljs-attr">4y</span> = <span class="hljs-number">13</span>
</code></pre>
<p>转化为矩阵形式：<code>Ax = b</code>，其中<code>A=[[1,2],[3,4]]</code>，<code>b=[5,13]</code>，求解<code>x</code>。</p>
<pre><code class="hljs language-python" lang="python">A = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]])
b = np.array([<span class="hljs-number">5</span>, <span class="hljs-number">13</span>])
<span class="hljs-comment"># 求解线性方程组</span>
x = np.linalg.solve(A, b)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"方程组解：x={}, y={}"</span>.<span class="hljs-built_in">format</span>(x[<span class="hljs-number">0</span>], x[<span class="hljs-number">1</span>]))  <span class="hljs-comment"># 输出：x=3.0, y=1.0</span>

<span class="hljs-comment"># 验证：A @ x 应等于b</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"验证结果："</span>, A @ x)  <span class="hljs-comment"># 输出：[ 5. 13.]</span>
</code></pre>
<h3 data-id="heading-17">3. 特征值与特征向量</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 计算特征值和特征向量</span>
A = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]])
eigenvalues, eigenvectors = np.linalg.eig(A)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"特征值："</span>, eigenvalues)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"特征向量：\n"</span>, eigenvectors)

<span class="hljs-comment"># 验证：A·v = λ·v（v为特征向量，λ为特征值）</span>
v = eigenvectors[:, <span class="hljs-number">0</span>]  <span class="hljs-comment"># 第一个特征向量</span>
lamda = eigenvalues[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 第一个特征值</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"验证特征值："</span>, np.allclose(A @ v, lamda * v))  <span class="hljs-comment"># 输出：True</span>
</code></pre>
<h3 data-id="heading-18">4. 奇异值分解（SVD，实战高频）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 奇异值分解（适用于非方阵）</span>
A = np.array([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]])
U, S, VT = np.linalg.svd(A)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"U矩阵：\n"</span>, U)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"奇异值："</span>, S)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"VT矩阵：\n"</span>, VT)

<span class="hljs-comment"># 重构矩阵（验证SVD）</span>
<span class="hljs-comment"># 需将S转为对角矩阵</span>
S_mat = np.zeros((<span class="hljs-number">2</span>,<span class="hljs-number">3</span>))
S_mat[:<span class="hljs-number">2</span>, :<span class="hljs-number">2</span>] = np.diag(S)
A_recon = U @ S_mat @ VT
<span class="hljs-built_in">print</span>(<span class="hljs-string">"重构矩阵与原矩阵是否一致："</span>, np.allclose(A, A_recon))  <span class="hljs-comment"># 输出：True</span>
</code></pre>
<h2 data-id="heading-19">五、实战优化技巧</h2>
<h3 data-id="heading-20">1. 避免循环，用向量化运算</h3>
<p>NumPy向量化运算比Python循环快10~100倍，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 低效：循环计算</span>
arr = np.arange(<span class="hljs-number">1000000</span>)
result = []
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> arr:
    result.append(x * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>)
result = np.array(result)

<span class="hljs-comment"># 高效：向量化运算</span>
result = arr * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>  <span class="hljs-comment"># 广播机制自动处理</span>
</code></pre>
<h3 data-id="heading-21">2. 数据类型优化</h3>
<p>默认<code>float64</code>精度高但占用内存，可根据需求改为<code>float32</code>：</p>
<pre><code class="hljs language-python" lang="python">arr = np.ones((<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>), dtype=np.float32)  <span class="hljs-comment"># 内存占用减少一半</span>
</code></pre>
<h3 data-id="heading-22">3. 避免拷贝，使用视图</h3>
<pre><code class="hljs language-python" lang="python">arr1 = arr.reshape(-<span class="hljs-number">1</span>)  <span class="hljs-comment"># -1自动计算维度，视图无拷贝</span>
arr2 = arr[:, ::<span class="hljs-number">2</span>]      <span class="hljs-comment"># 切片为视图，原数组修改会同步</span>
arr3 = arr.copy()       <span class="hljs-comment"># 仅需独立数据时拷贝</span>
</code></pre>
<h2 data-id="heading-23">六、常见问题与解决</h2>
<h3 data-id="heading-24">1. 广播报错：维度不匹配</h3>
<ul>
<li>排查：打印数组<code>shape</code>，确认是否满足广播规则；</li>
<li>解决：用<code>reshape</code>手动扩展维度，例如<code>arr = arr.reshape(-1, 1)</code>。</li>
</ul>
<h3 data-id="heading-25">2. 矩阵乘法与元素相乘混淆</h3>
<ul>
<li>区分：<code>A @ B</code>是矩阵乘法，<code>A * B</code>是元素相乘；</li>
<li>注意：矩阵乘法要求前一个数组列数=后一个数组行数。</li>
</ul>
<h3 data-id="heading-26">3. 求逆报错：奇异矩阵</h3>
<ul>
<li>原因：矩阵行列式为0，不可逆；</li>
<li>解决：检查矩阵是否正确，或使用伪逆<code>np.linalg.pinv(A)</code>。</li>
</ul>
<h3 data-id="heading-27">4. 精度问题</h3>
<ul>
<li>现象：浮点数运算出现<code>0.9999999999</code>而非<code>1</code>；</li>
<li>解决：用<code>np.allclose(a, b)</code>代替<code>a == b</code>比较数组。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 SSE 单向推送实现 系统通知功能]]></title>    <link>https://juejin.cn/post/7583912899389210667</link>    <guid>https://juejin.cn/post/7583912899389210667</guid>    <pubDate>2025-12-15T13:26:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583912899389210667" data-draft-id="7583898823921254442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 SSE 单向推送实现 系统通知功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-15T13:26:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 SSE 单向推送实现 系统通知功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:26:52.000Z" title="Mon Dec 15 2025 13:26:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 SSE 单向推送实现 系统通知功能</h2>
<blockquote>
<p>说明：本说明基于自己毕设项目中“系统通知模块 (Notification / SSE)”的实现，重点讲清楚在前端从 **初始化环境 → 建立 SSE 连接 → 解析服务端事件 → 打印日志 ** 的完整技术链路，至于收到信息如何处理和具体项目有关。</p>
</blockquote>
<hr/>
<p>在我的毕设中，有系统通知这个功能，单向的，告诉用户，你的内容发布审核成功，或者失败等等一系列的单方面的通知，所有选型sse而不选择websorket
接下来先给出后端实现，然后是前端实现</p>
<h3 data-id="heading-1">后端实现 系统通知模块后端实现说明</h3>
<p>涉及的核心类：</p>
<ul>
<li><code>NotificationController</code>：通知相关 HTTP 接口（SSE 流、已读、未读数、分页列表）。</li>
<li><code>NotificationService</code>：通知的持久化、SSE 连接管理与推送实现。</li>
<li><code>Notification</code> / <code>notification</code> 表：通知实体与数据库表结构。</li>
<li><code>NotificationType</code> / <code>NotificationStatus</code>：通知类型与状态枚举（如 <code>PRIVATE_MESSAGE</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、建立 SSE 通知连接</h3>
<h4 data-id="heading-3">1. Controller：<code>GET /api/notify/stream</code></h4>
<ul>
<li><strong>接口类</strong>：<code>NotificationController</code></li>
<li><strong>方法</strong>：<code>stream(@RequestHeader(value = "Last-Event-ID", required = false) String lastEventId)</code></li>
<li><strong>路径</strong>：<code>/api/notify/stream</code></li>
<li><strong>作用</strong>：
<ul>
<li>校验当前用户是否已登录（从 <code>UserContext.getUserId()</code> 读取 userId）。</li>
<li>未登录时抛出 <code>401 UNAUTHORIZED</code>。</li>
<li>登录状态下，调用 <code>notificationService.connect(userId, lastEventId)</code> 建立 SSE 连接。</li>
</ul>
</li>
</ul>
<p>简要流程：</p>
<ol>
<li>从 <code>UserContext</code> 获取当前用户 ID。</li>
<li>若未登录：抛出 <code>ResponseStatusException(HttpStatus.UNAUTHORIZED)</code>。</li>
<li>若已登录：将 <code>userId</code> 与 <code>Last-Event-ID</code> 交给 <code>NotificationService.connect</code>。</li>
<li>返回 Spring 的 <code>SseEmitter</code> 对象，由框架维持 SSE 链接。</li>
</ol>
<h4 data-id="heading-4">2. Service：<code>NotificationService.connect</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public SseEmitter connect(Long userId, String lastEventId)</code></li>
<li><strong>内部逻辑</strong>：
<ol>
<li>创建一个 <code>SseEmitter</code> 实例，超时时间为 <code>SSE_TIMEOUT = 30 * 60 * 1000L</code>（30 分钟）。</li>
<li>将该 <code>SseEmitter</code> 加入到 <code>emitterPool</code> 中：
<ul>
<li><code>emitterPool</code> 类型为 <code>Map&lt;Long, CopyOnWriteArrayList&lt;SseEmitter&gt;&gt;</code>，按 <code>userId</code> 维护用户当前所有 SSE 连接。</li>
</ul>
</li>
<li>为 <code>emitter</code> 注册回调：
<ul>
<li><code>onCompletion</code> / <code>onTimeout</code> / <code>onError</code> 时，从 <code>emitterPool</code> 中移除当前连接。</li>
</ul>
</li>
<li>发送一次 <strong>心跳事件</strong>（<code>heartbeat</code>），名称为 <code>"heartbeat"</code>，数据为 <code>"ping"</code>。</li>
<li>解析 <code>Last-Event-ID</code>：
<ul>
<li>如果有合法的 <code>lastEventId</code>，解析为 <code>lastId</code>（<code>Long</code>）。</li>
<li>若解析失败或为空，则为 <code>null</code>。</li>
</ul>
</li>
<li>调用 <code>resendPending(userId, lastId, emitter)</code> 补发历史通知（最多 100 条）。</li>
<li>返回 <code>SseEmitter</code>，等待后续通知推送。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">3. SSE 连接断开/超时</h4>
<ul>
<li>在 <code>connect</code> 方法中，对 <code>SseEmitter</code> 注册了：
<ul>
<li><code>onCompletion</code>：连接正常完成时调用 <code>removeEmitter(userId, emitter)</code>。</li>
<li><code>onTimeout</code>：连接超时时调用 <code>removeEmitter(userId, emitter)</code>。</li>
<li><code>onError</code>：发送异常等错误时调用 <code>removeEmitter(userId, emitter)</code>。</li>
</ul>
</li>
<li><code>removeEmitter</code> 会从 <code>emitterPool</code> 对应用户的列表中移除该 <code>SseEmitter</code>，防止内存泄漏与后续重复推送。</li>
</ul>
<hr/>
<h3 data-id="heading-6">二、通知的创建与推送</h3>
<h4 data-id="heading-7">1. 通用创建+推送：<code>NotificationService.createAndDispatch</code></h4>
<ul>
<li>
<p><strong>方法签名</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Notification <span class="hljs-title function_">createAndDispatch</span><span class="hljs-params">(Long userId, NotificationType type, String title, String content, String payload)</span>
</code></pre>
</li>
<li>
<p><strong>调用方示例</strong>：</p>
<ul>
<li>私信业务中的离线提醒（<code>ChatServiceImpl</code>）。</li>
<li>管理员公告等其他业务模块。</li>
</ul>
</li>
<li>
<p><strong>执行流程</strong>：</p>
<ol>
<li>调用 <code>buildNotification(userId, type, title, content, payload)</code> 构造一个 <code>Notification</code> 实体：
<ul>
<li><code>userId</code>：接收通知的用户 ID。</li>
<li><code>type</code>：通知类型（如 <code>PRIVATE_MESSAGE</code>、<code>SYSTEM_ANNOUNCEMENT</code> 等）。</li>
<li><code>title</code>：通知标题/摘要。</li>
<li><code>content</code>：通知正文或简述。</li>
<li><code>payload</code>：扩展 JSON 字符串，用于前端跳转或展示更多信息。</li>
<li><code>status</code>：初始为 <code>UNREAD</code>。</li>
<li><code>createdAt</code> / <code>updatedAt</code>：为当前时间。</li>
</ul>
</li>
<li>通过 <code>notificationMapper.insert(notification)</code> 将通知写入 <code>notification</code> 表。</li>
<li>调用 <code>dispatch(notification)</code> 将该通知推送给所有当前在线的 SSE 连接。</li>
<li>返回持久化后的 <code>Notification</code> 对象。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-8">2. 批量发送：<code>createAndDispatchBatch</code></h4>
<ul>
<li>
<p><strong>方法签名</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createAndDispatchBatch</span><span class="hljs-params">(List&lt;Long&gt; userIds, NotificationType type, String title, String content, String payload)</span>
</code></pre>
</li>
<li>
<p><strong>逻辑</strong>：对 <code>userIds</code> 逐个调用 <code>createAndDispatch</code>，用于对多用户广播同一类型通知（如系统公告或活动推送）。</p>
</li>
</ul>
<h4 data-id="heading-9">3. 通知推送：<code>NotificationService.dispatch</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public void dispatch(Notification notification)</code></li>
<li><strong>执行流程</strong>：
<ol>
<li>从 <code>emitterPool</code> 中取出该通知对应 <code>userId</code> 的所有 <code>SseEmitter</code> 列表。</li>
<li>若列表为空，说明用户此时没有打开 SSE 通道，方法直接返回（仅数据库中保留通知记录，后续建立连接时再补发）。</li>
<li>遍历每个 <code>SseEmitter</code>，调用：
<ul>
<li><code>emitter.send(SseEmitter.event().id(String.valueOf(notification.getId())).name(notification.getType()).data(notification))</code>：
<ul>
<li><code>id</code>：使用通知 ID（字符串形式），用于客户端的 <code>Last-Event-ID</code> 与断点续传。</li>
<li><code>name</code>：使用 <code>notification.getType()</code>，即 <code>NotificationType</code> 的枚举名（如 <code>PRIVATE_MESSAGE</code>）。</li>
<li><code>data</code>：整个 <code>Notification</code> 对象（前端接收后可按 <code>NotificationVO</code> 解析）。</li>
</ul>
</li>
</ul>
</li>
<li>如果发送过程中抛出 <code>IOException</code>，记录日志并调用 <code>removeEmitter</code> 移除当前失效连接。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-10">4. 历史通知补发：<code>NotificationService.resendPending</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>private void resendPending(Long userId, Long lastId, SseEmitter emitter)</code></li>
<li><strong>补发策略</strong>：
<ul>
<li>若 <code>lastId != null</code>：补发 <strong>ID 大于 <code>lastId</code></strong> 的所有通知。</li>
<li>若 <code>lastId == null</code>：补发 <strong>所有未读（<code>status = UNREAD</code>）通知</strong>。</li>
<li>均按 ID 升序排序，<code>LIMIT 1</code> 条，只是补发过最新一条数据，列表通过数据库查询。</li>
</ul>
</li>
<li>通知通过 <code>SseEmitter.event().id(...).name(...).data(...)</code> 发送，与实时推送一致。</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、通知的已读、未读与统计</h3>
<h4 data-id="heading-12">1. 标记已读：<code>POST /api/notify/read</code></h4>
<h5 data-id="heading-13">Controller：<code>NotificationController.markRead</code></h5>
<ul>
<li><strong>路径</strong>：<code>/api/notify/read</code></li>
<li><strong>请求体</strong>：<code>NotificationReadRequest</code>，包含：
<ul>
<li><code>notificationIds</code>（可选）：要标记为已读的通知 ID 列表。</li>
<li><code>upToId</code>（可选）：将 <code>id &lt;= upToId</code> 的通知全部标记为已读。</li>
</ul>
</li>
<li><strong>控制器逻辑</strong>：
<ol>
<li>从 <code>UserContext</code> 获取当前用户 ID，未登录返回 <code>Result.unauthorized("未登录")</code>。</li>
<li>调用 <code>notificationService.markAsRead(userId, notificationIds, upToId)</code> 执行更新。</li>
<li>再调用 <code>notificationService.countUnread(userId)</code> 获取最新未读数量。</li>
<li>返回 <code>Result.success(unread)</code>。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-14">Service：<code>NotificationService.markAsRead</code></h5>
<ul>
<li><strong>方法签名</strong>：<code>public void markAsRead(Long userId, List&lt;Long&gt; notificationIds, Long upToId)</code></li>
<li><strong>执行逻辑</strong>：
<ol>
<li>若 <code>notificationIds</code> 为空且 <code>upToId == null</code>，直接返回，不做更新。</li>
<li>创建 <code>LambdaUpdateWrapper&lt;Notification&gt;</code>：
<ul>
<li><code>eq(Notification::getUserId, userId)</code>：只更新当前用户的通知。</li>
<li><code>eq(Notification::getStatus, NotificationStatus.UNREAD.name())</code>：只处理未读通知。</li>
<li>若 <code>notificationIds</code> 不为空：<code>in(Notification::getId, notificationIds)</code>。</li>
<li>若 <code>upToId</code> 不为 <code>null</code>：<code>le(Notification::getId, upToId)</code>。</li>
</ul>
</li>
<li><code>set(Notification::getStatus, NotificationStatus.READ.name())</code>。</li>
<li>执行 <code>notificationMapper.update(null, wrapper)</code> 完成批量更新。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-15">2. 未读数量统计：<code>GET /api/notify/unread-count</code></h4>
<h5 data-id="heading-16">Controller：<code>NotificationController.unreadCount</code></h5>
<ul>
<li><strong>路径</strong>：<code>/api/notify/unread-count</code></li>
<li><strong>逻辑</strong>：
<ol>
<li>从 <code>UserContext</code> 获取当前用户 ID，未登录返回 <code>Result.unauthorized("未登录")</code>。</li>
<li>调用 <code>notificationService.countUnread(userId)</code> 获取未读数量。</li>
<li>返回 <code>Result.success(unread)</code>。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-17">Service：<code>NotificationService.countUnread</code></h5>
<ul>
<li><strong>方法签名</strong>：<code>public long countUnread(Long userId)</code></li>
<li><strong>逻辑</strong>：
<ul>
<li>使用 <code>LambdaQueryWrapper&lt;Notification&gt;</code>：
<ul>
<li><code>eq(Notification::getUserId, userId)</code></li>
<li><code>eq(Notification::getStatus, NotificationStatus.UNREAD.name())</code></li>
</ul>
</li>
<li>调用 <code>notificationMapper.selectCount(wrapper)</code> 返回未读总数。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">3. 最近未读列表：<code>GET /api/notify/recent</code></h4>
<ul>
<li><strong>路径</strong>：<code>/api/notify/recent</code></li>
<li><strong>说明</strong>：用于调试或前端恢复，获取当前用户最近未读通知（最多 100 条）。</li>
<li><strong>Service 方法</strong>：<code>public List&lt;Notification&gt; recentUnread(Long userId)</code>
<ul>
<li>条件：
<ul>
<li><code>userId</code> 匹配当前用户；</li>
<li><code>status = UNREAD</code>；</li>
</ul>
</li>
<li>排序：<code>createdAt</code> 倒序；</li>
<li><code>last("LIMIT 100")</code> 限制数量。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-19">四、通知分页列表接口</h3>
<h4 data-id="heading-20">1. 接口：<code>GET /api/notify/list</code></h4>
<h5 data-id="heading-21">Controller：<code>NotificationController.list</code></h5>
<ul>
<li><strong>路径</strong>：<code>/api/notify/list</code></li>
<li><strong>入参（Query）</strong>：
<ul>
<li><code>page</code>：页码，默认 <code>1</code>。</li>
<li><code>pageSize</code>：每页数量，默认 <code>10</code>。</li>
<li><code>status</code>：可选，<code>UNREAD</code> / <code>READ</code> / <code>ALL</code>，默认 <code>ALL</code>（不传时也视为 <code>ALL</code>）。</li>
</ul>
</li>
<li><strong>流程</strong>：
<ol>
<li>从 <code>UserContext</code> 获取当前用户 ID，未登录返回 <code>Result.unauthorized("未登录")</code>。</li>
<li>调用 <code>notificationService.listNotifications(userId, page, pageSize, status)</code>。</li>
<li>返回 <code>Result.success(Page&lt;NotificationVO&gt;)</code>，分页结构与项目统一（<code>total/size/current/pages/records</code> 等）。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-22">Service：<code>NotificationService.listNotifications</code></h5>
<ul>
<li><strong>方法签名</strong>：<code>public Page&lt;NotificationVO&gt; listNotifications(Long userId, int page, int pageSize, String status)</code></li>
<li><strong>实现思路</strong>：
<ol>
<li>构造 <code>Page&lt;Notification&gt; pageParam = new Page&lt;&gt;(page, pageSize)</code>。</li>
<li>构造 <code>LambdaQueryWrapper&lt;Notification&gt; wrapper</code>：
<ul>
<li><code>eq(Notification::getUserId, userId)</code>。</li>
<li>若 <code>status</code> 非空且不是 <code>"ALL"</code>：<code>eq(Notification::getStatus, status.toUpperCase())</code>。</li>
<li><code>orderByDesc(Notification::getCreatedAt)</code>。</li>
</ul>
</li>
<li><code>notificationMapper.selectPage(pageParam, wrapper)</code> 得到 <code>notificationPage</code>。</li>
<li>手动构造 <code>Page&lt;NotificationVO&gt; voPage = new Page&lt;&gt;(page, pageSize, notificationPage.getTotal())</code>：
<ul>
<li>遍历 <code>notificationPage.getRecords()</code>，将每条记录映射为 <code>NotificationVO</code>：
<ul>
<li>复制 <code>id/userId/type/title/content/payload/status/createdAt</code> 等字段。</li>
</ul>
</li>
<li><code>voPage.setRecords(records)</code>。</li>
</ul>
</li>
<li>返回 <code>voPage</code>。</li>
</ol>
</li>
</ul>
<hr/>
<h3 data-id="heading-23">五、与私信模块的集成（离线私信提醒）</h3>
<h4 data-id="heading-24">1. 场景描述</h4>
<p>当用户 A 给用户 B 发送一对一私信时：</p>
<ul>
<li>如果 B 当前通过 WebSocket 在线（有 <code>chat:online:{userId}</code> 标记）：
<ul>
<li>只依赖聊天模块的实时消息推送（STOMP <code>/topic/chat/{sessionId}</code>）。</li>
</ul>
</li>
<li>如果 B 不在线（没有在线标记）：
<ul>
<li>在聊天消息正常写入 <code>chat_message</code> 表的基础上，<strong>额外</strong>为 B 创建一条 <code>PRIVATE_MESSAGE</code> 类型的系统通知，写入 <code>notification</code> 表并通过 SSE 推送/补发。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">2. 关键实现：<code>ChatServiceImpl.sendMessage</code></h4>
<ul>
<li>在创建 <code>ChatMessage</code> 并更新 <code>ChatSession.updatedAt</code> 后：
<ol>
<li>判断当前会话是否为单聊：<code>"single".equalsIgnoreCase(session.getSessionType())</code>。</li>
<li>查询该会话中“对方成员” (<code>ChatSessionMember</code>，<code>userId != 发送者</code>) 获取 <code>targetUserId</code>。</li>
<li>根据 <code>RedisConstants.CHAT_ONLINE_PREFIX + targetUserId</code> 从 Redis 中读取在线标记：
<ul>
<li>若存在值：认为对方在线，不额外生成通知。</li>
<li>若不存在值：认为对方离线，进入通知创建逻辑。</li>
</ul>
</li>
<li>离线场景下：
<ul>
<li>查询发送者用户信息，取昵称或用户名作为 <code>senderName</code>。</li>
<li>构造标题 <code>title = "收到一条新的私信"</code>。</li>
<li>构造预览 <code>preview = content</code> 的前若干字符（超长截断）。</li>
<li>构造 <code>payload</code> JSON 字符串：包含 <code>sessionId</code>、<code>messageId</code>、<code>senderId</code>、<code>senderName</code>，供前端跳转使用。</li>
<li>调用 <code>notificationService.createAndDispatch(targetUserId, NotificationType.PRIVATE_MESSAGE, title, preview, payload)</code>：
<ul>
<li>将通知写入 <code>notification</code> 表。</li>
<li>若 B 此时已经建立 SSE 连接，会立刻收到一条 <code>PRIVATE_MESSAGE</code> 事件。</li>
<li>若 B 之后才建立 SSE 连接，会通过补发逻辑 <code>resendPending</code> 收到历史通知。</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr/>
<h3 data-id="heading-26">前端实现  前端 SSE 通知实现说明（从 0 到看到控制台日志）</h3>
<h3 data-id="heading-27">一、相关文件总览</h3>
<ul>
<li><code>vite.config.js</code>
<ul>
<li>开发环境代理配置：<code>/api</code> → 后端 <code>VITE_API_BASE_URL</code>。</li>
</ul>
</li>
<li><code>src/main.js</code>
<ul>
<li>应用启动时初始化用户状态并根据登录态初始化通知 SSE。</li>
</ul>
</li>
<li><code>src/utils/notificationStream.js</code>
<ul>
<li><strong>SSE 连接和消息解析的核心逻辑（基于 fetch + ReadableStream，自实现 EventSource）。</strong></li>
</ul>
</li>
<li><code>src/stores/notification.js</code>
<ul>
<li>通知相关 Pinia Store，管理未读数量、通知列表和 SSE 状态。</li>
</ul>
</li>
<li><code>src/components/Header/index.vue</code>
<ul>
<li>顶部 Header，展示通知铃铛和未读红点。</li>
</ul>
</li>
<li><code>src/pages/UserCenter/pages/Notifications/index.vue</code>
<ul>
<li>用户中心「消息通知」页面，展示通知列表。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-28">二、环境与代理（为什么开发环境不直接跨域）</h3>
<h4 data-id="heading-29">2.1 Vite 代理配置</h4>
<p><code>vite.config.js</code> 中开发环境的核心代理配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">server</span>: {
  <span class="hljs-attr">port</span>: <span class="hljs-number">3003</span>,
  <span class="hljs-attr">host</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>,
  ...(isDev &amp;&amp; {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: env.<span class="hljs-property">VITE_API_BASE_URL</span> || <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">''</span>)
      }
    }
  })
}
</code></pre>
<p>关键点：</p>
<ul>
<li>浏览器访问的是 <code>http://localhost:3003</code>（前端 dev server）。</li>
<li>任何以 <code>/api</code> 开头的请求都会被 Vite 转发到 <code>VITE_API_BASE_URL</code> 对应的后端，例如：
<ul>
<li>浏览器：<code>/api/api/notify/stream</code></li>
<li>Vite rewrite：去掉第一个 <code>/api</code>，转成 <code>/api/notify/stream</code></li>
<li>后端实际收到：<code>http://127.0.0.1:8081/api/notify/stream</code>（和后端文档一致）。</li>
</ul>
</li>
<li>对浏览器来说始终是 <strong>同源 (3003)</strong>，不会触发 CORS 校验，跨域问题由 dev server 帮我们挡在背后。</li>
</ul>
<hr/>
<h3 data-id="heading-30">三、应用入口：在什么时机建立 SSE 连接？</h3>
<h4 data-id="heading-31">3.1 <code>src/main.js</code></h4>
<p>在 <code>main.js</code> 中：</p>
<ol>
<li>创建应用实例并挂载 Pinia / Router / UI 库。</li>
<li>初始化用户状态（从 localStorage 恢复登录态）：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

app.<span class="hljs-title function_">use</span>(pinia)
app.<span class="hljs-title function_">use</span>(router)
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> notificationStore = <span class="hljs-title function_">useNotificationStore</span>()

userStore.<span class="hljs-title function_">initUserState</span>()
</code></pre>
<ol start="3">
<li>当恢复登录状态后，如果用户已登录，立即初始化通知 SSE，并获取一次未读数量：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (userStore.<span class="hljs-property">isLogin</span>) {
  <span class="hljs-title function_">initNotificationStream</span>()
  notificationStore.<span class="hljs-title function_">fetchUnreadCount</span>()
}
</code></pre>
<ol start="4">
<li>同时监听登录状态变化，自动处理连接的建立和关闭：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> userStore.<span class="hljs-property">isLogin</span>,
  <span class="hljs-function">(<span class="hljs-params">isLogin</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (isLogin) {
      <span class="hljs-title function_">initNotificationStream</span>()
      notificationStore.<span class="hljs-title function_">fetchUnreadCount</span>()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">closeNotificationStream</span>()
      notificationStore.<span class="hljs-title function_">reset</span>()
    }
  }
)
</code></pre>
<p><strong>结论：</strong></p>
<ul>
<li>应用启动时，如果用户已登录 → 自动建立 SSE 连接。</li>
<li>用户登录成功 → 自动建立连接。</li>
<li>用户登出或 token 失效 → 自动关闭连接并清空通知状态。</li>
</ul>
<hr/>
<h3 data-id="heading-32">四、SSE 核心：<code>notificationStream.js</code> 中的连接与解析</h3>
<h4 data-id="heading-33">4.1 连接地址</h4>
<pre><code class="hljs language-bash" lang="bash">/api/api/notify/stream
</code></pre>
<p>说明：</p>
<ul>
<li>浏览器视角：<code>http://localhost:3003/api/api/notify/stream</code>（同源）。</li>
<li>Vite 代理：去掉第一个 <code>/api</code> → <code>/api/notify/stream</code>。</li>
<li>后端视角：<code>http://127.0.0.1:8081/api/notify/stream</code>（与接口文档一致）。</li>
</ul>
<h4 data-id="heading-34">4.2 建立 SSE 连接</h4>
<p><code>initNotificationStream</code> 负责发起连接：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initNotificationStream</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> (reading) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 已在读流则不重复建立</span>

  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
  <span class="hljs-keyword">const</span> notificationStore = <span class="hljs-title function_">useNotificationStore</span>()

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> sseUrl = <span class="hljs-string">'/api/api/notify/stream'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 准备建立连接:'</span>, sseUrl)

    abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
    reading = <span class="hljs-literal">true</span>
    notificationStore.<span class="hljs-title function_">setSseConnected</span>(<span class="hljs-literal">true</span>)

    <span class="hljs-title function_">fetch</span>(sseUrl, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'text/event-stream'</span>,
        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span>,
        ...(userStore.<span class="hljs-property">token</span>
          ? { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${userStore.token}</span>`</span> }
          : {})
      },
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
      <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>
    })
      .<span class="hljs-title function_">then</span>(<span class="hljs-comment">/* 处理响应与读流 */</span>)
      .<span class="hljs-keyword">catch</span>(<span class="hljs-comment">/* 错误处理 */</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>关键点：</p>
<ul>
<li>使用原生 <code>fetch</code> 而不是 <code>EventSource</code>，是因为需要自定义 <code>Authorization</code> 头。</li>
<li>通过 <code>Authorization: Bearer &lt;token&gt;</code> 携带登录状态，兼容后端鉴权逻辑。</li>
<li><code>credentials: 'include'</code> 保留 Cookie 信息（如果后端需要）。</li>
</ul>
<h4 data-id="heading-35">4.3 处理 HTTP 响应并输出基础日志</h4>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (response) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 响应状态:'</span>, response.<span class="hljs-property">status</span>, response.<span class="hljs-property">statusText</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 响应头 content-type:'</span>, response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'content-type'</span>))

  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span> || !response.<span class="hljs-property">body</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`SSE 连接失败: <span class="hljs-subst">${response.status}</span>`</span>)
  }

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>()
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>)
  <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>

  <span class="hljs-comment">// 持续读流...</span>
})
</code></pre>
<p>此时在浏览器控制台可以看到：</p>
<ul>
<li><code>[SSE] 响应状态: 200 OK</code></li>
<li><code>[SSE] 响应头 content-type: text/event-stream;charset=UTF-8</code></li>
</ul>
<h4 data-id="heading-36">4.4 持续读取 SSE 流并解析事件</h4>
<p>核心循环逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>()
  <span class="hljs-keyword">if</span> (done) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 流已结束'</span>)
    <span class="hljs-keyword">break</span>
  }

  buffer += decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 收到原始 chunk:'</span>, buffer)

  <span class="hljs-comment">// 根据 \n\n 切分事件块</span>
  <span class="hljs-keyword">const</span> events = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n\n'</span>)
  buffer = events.<span class="hljs-title function_">pop</span>() || <span class="hljs-string">''</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rawEvent <span class="hljs-keyword">of</span> events) {
    <span class="hljs-keyword">const</span> lines = rawEvent.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">let</span> eventType = <span class="hljs-string">'message'</span>
    <span class="hljs-keyword">let</span> data = <span class="hljs-string">''</span>
    <span class="hljs-keyword">let</span> lastEventId = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'event:'</span>)) {
        eventType = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>).<span class="hljs-title function_">trim</span>()
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data:'</span>)) {
        data += line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">trim</span>()
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'id:'</span>)) {
        lastEventId = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">3</span>).<span class="hljs-title function_">trim</span>()
      }
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[SSE] 解析到事件:'</span>, {
      eventType,
      lastEventId,
      data,
      rawEvent
    })

    <span class="hljs-keyword">if</span> (lastEventId) {
      notificationStore.<span class="hljs-title function_">setLastEventId</span>(lastEventId)
    }

    <span class="hljs-keyword">if</span> (eventType === <span class="hljs-string">'heartbeat'</span>) <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">continue</span>

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data)
      notificationStore.<span class="hljs-title function_">handleIncomingNotification</span>(parsed)
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解析通知 SSE 消息失败:'</span>, error, data)
    }
  }
}
</code></pre>
<p><strong>控制台能看到的典型日志（以 PRIVATE_MESSAGE 为例）：</strong></p>
<ul>
<li><code>[SSE] 收到原始 chunk: id:21\nevent:PRIVATE_MESSAGE\ndata:{"id":21,"userId":3,"type":"PRIVATE_MESSAGE",...}\n\n</code></li>
<li><code>[SSE] 解析到事件: { eventType: 'PRIVATE_MESSAGE', lastEventId: '21', data: '{"id":21,"userId":3,"type":"PRIVATE_MESSAGE",...}', rawEvent: 'id:21\nevent:PRIVATE_MESSAGE\ndata:{"id":21,...}' }</code></li>
</ul>
<hr/>
<h3 data-id="heading-37">五、通知 Store：如何消费和存储 SSE 消息</h3>
<p>文件：<code>src/stores/notification.js</code></p>
<h4 data-id="heading-38">5.1 状态结构</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">unreadCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">notifications</span>: [],
  <span class="hljs-attr">pagination</span>: {
    <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">size</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">pages</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">loadingList</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">loadingUnread</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">sseConnected</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">lastEventId</span>: <span class="hljs-literal">null</span>
})
</code></pre>
<h4 data-id="heading-39">5.2 处理 SSE 推送的新通知</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">handleIncomingNotification</span>(<span class="hljs-params">notification</span>) {
  <span class="hljs-keyword">if</span> (!notification || !notification.<span class="hljs-property">id</span>) {
    <span class="hljs-comment">// 当前约定：必须有 id 才认为是有效通知</span>
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> exists = <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifications</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === notification.<span class="hljs-property">id</span>)
  <span class="hljs-keyword">if</span> (!exists) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifications</span> = [notification, ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">notifications</span>]
  }

  <span class="hljs-comment">// 未显式标记为 READ 的，都算未读</span>
  <span class="hljs-keyword">if</span> (!notification.<span class="hljs-property">status</span> || notification.<span class="hljs-property">status</span> === <span class="hljs-string">'UNREAD'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">unreadCount</span> += <span class="hljs-number">1</span>
  }
}
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>每一条从 SSE 收到的 JSON 通知（包含 <code>id</code> 字段）会被添加到 <code>notifications</code> 列表顶部。</li>
<li>未读数量 <code>unreadCount</code> 会自增，用于 Header 红点等 UI 展示。</li>
</ul>
<hr/>
<h3 data-id="heading-40">六、UI 展示：从 Store 到页面/控制台</h3>
<h4 data-id="heading-41">6.1 Header 铃铛红点</h4>
<p>文件：<code>src/components/Header/index.vue</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> notificationStore = <span class="hljs-title function_">useNotificationStore</span>()
<span class="hljs-keyword">const</span> hasUnread = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> notificationStore.<span class="hljs-property">unreadCount</span> &gt; <span class="hljs-number">0</span>)
</code></pre>
<p>在模板中：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;button class="gridButton" @click="handleNotificationClick"&gt;
  &lt;span style="position: relative; display: inline-block;"&gt;
    &lt;i class="fas fa-bell text-lg"&gt;&lt;/i&gt;
    &lt;span v-if="hasUnread" class="unreadBadge"&gt;&lt;/span&gt;
  &lt;/span&gt;
&lt;/button&gt;
</code></pre>
<p>当 SSE 收到任意一条未读通知：</p>
<ul>
<li><code>handleIncomingNotification</code> → <code>unreadCount++</code></li>
<li><code>hasUnread</code> 变为 <code>true</code></li>
<li><code>unreadBadge</code> 渲染，小红点点亮。</li>
</ul>
<h4 data-id="heading-42">6.2 用户中心「消息通知」页面</h4>
<p>文件：<code>src/pages/UserCenter/pages/Notifications/index.vue</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> notificationStore = <span class="hljs-title function_">useNotificationStore</span>()

<span class="hljs-keyword">const</span> notifications = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> notificationStore.<span class="hljs-property">notifications</span>)
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> notificationStore.<span class="hljs-property">loadingList</span>)
</code></pre>
<p>首次进入页面时，会从后端拉一次历史通知列表：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  notificationStore.<span class="hljs-title function_">fetchNotifications</span>({
    <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">'ALL'</span>
  })
})
</code></pre>
<p>当 SSE 推送新通知时：</p>
<ul>
<li>Store 的 <code>notifications</code> 首元素会是最新一条；</li>
<li>此页面会自动响应式更新，用户可以点击查看并标记为已读。</li>
</ul>
<hr/>
<h3 data-id="heading-43">最后、小结</h3>
<ol>
<li><strong>建立连接</strong>：<code>/api/notify/stream</code> → <code>NotificationService.connect</code> → 维护 <code>emitterPool</code> + 心跳 + 历史补发。</li>
<li><strong>创建通知</strong>：各业务（如私信模块）调用 <code>NotificationService.createAndDispatch</code>，将通知写入 <code>notification</code> 表并尝试通过 SSE 推送。</li>
<li><strong>接收与补发</strong>：在线用户通过 SSE 立即收到通知；离线用户下次连接时通过 <code>Last-Event-ID</code> 或未读筛选补发（最多 100 条）。</li>
<li><strong>已读/未读管理</strong>：<code>/api/notify/read</code> 和 <code>/api/notify/unread-count</code> 负责已读标记与未读统计。</li>
<li><strong>列表与分页</strong>：<code>/api/notify/recent</code> 提供最近未读调试接口；<code>/api/notify/list</code> 提供按状态过滤的分页通知列表。</li>
<li><strong>私信集成</strong>：<code>ChatServiceImpl</code> 在单聊离线场景下，为接收方生成 <code>PRIVATE_MESSAGE</code> 通知，实现“有人给你发私信”类型的系统提示。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎯 Rect 中鼠标移动拾取元素可行性架构分析]]></title>    <link>https://juejin.cn/post/7583952017674190899</link>    <guid>https://juejin.cn/post/7583952017674190899</guid>    <pubDate>2025-12-16T01:46:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583952017674190899" data-draft-id="7583933107689701439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎯 Rect 中鼠标移动拾取元素可行性架构分析"/> <meta itemprop="keywords" content="前端,架构,React.js"/> <meta itemprop="datePublished" content="2025-12-16T01:46:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎯 Rect 中鼠标移动拾取元素可行性架构分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:46:15.000Z" title="Tue Dec 16 2025 01:46:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧠 一、背景：什么是拾取（Picking）？</h2>
<p>“拾取”是指<strong>从用户交互的二维输入（鼠标、触控）映射到图形对象</strong>的过程。</p>
<p>想象你在一个可视化编辑器中移动鼠标指针——当光标悬浮在某个矩形（Rect）上，它高亮、变色、提示“我被选中了”，这就是 <em>拾取系统</em> 在背后施展魔法。✨</p>
<p>在二维场景中，拾取方案通常分三类：</p>





























<table><thead><tr><th>模式</th><th>原理</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>几何拾取</td><td>在逻辑层判断 <code>(x,y)</code> 与各对象边界关系</td><td>精确、轻量</td><td>大量元素时耗性能</td></tr><tr><td>GPU颜色拾取（Color Picking）</td><td>每个对象渲染唯一颜色，对鼠标点取色</td><td>准确、独立于形状复杂度</td><td>需额外渲染缓冲区</td></tr><tr><td>空间索引拾取（QuadTree / BVH）</td><td>建立空间数据结构加速命中查找</td><td>高效、可扩展</td><td>实现复杂度高</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">🔬 二、可行性架构核心要点</h2>
<h3 data-id="heading-2">（1）数据层：结构化管理 Rect 元素</h3>
<p>首先要有“<strong>可索引、可快速命中</strong>”的数据结构。<br/>
假设每个矩形元素都有如下属性：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rect</span> {
  <span class="hljs-keyword">constructor</span>(id, x, y, width, height) {
    <span class="hljs-keyword">this</span>.id = id;
    <span class="hljs-keyword">this</span>.bounds = { x, y, width, height };
    <span class="hljs-keyword">this</span>.state = <span class="hljs-string">"normal"</span>; <span class="hljs-comment">// normal, hover, selected</span>
  }

  contains(px, py) {
    <span class="hljs-keyword">return</span> (
      px &gt;= <span class="hljs-keyword">this</span>.bounds.x &amp;&amp;
      px &lt;= <span class="hljs-keyword">this</span>.bounds.x + <span class="hljs-keyword">this</span>.bounds.width &amp;&amp;
      py &gt;= <span class="hljs-keyword">this</span>.bounds.y &amp;&amp;
      py &lt;= <span class="hljs-keyword">this</span>.bounds.y + <span class="hljs-keyword">this</span>.bounds.height
    );
  }
}
</code></pre>
<p>在小规模下，我们可直接线性扫描，但在数千个Rect场景中，这会让GPU哭泣 😭。</p>
<hr/>
<h3 data-id="heading-3">（2）空间层：区域加速结构设计</h3>
<p>为解决性能问题，可引入 <strong>QuadTree（四叉树）</strong> 进行空间划分。</p>
<p><strong>原理</strong>：</p>
<ul>
<li>将画布平面递归划分为四个象限，每个象限存储矩形对象集合。</li>
<li>鼠标移动时，只查询当前象限节点。</li>
<li>空间复杂度：O(n)，查询复杂度：平均 O(log n)。</li>
</ul>
<p>伪代码演示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QuadTree</span> {
  <span class="hljs-keyword">constructor</span>(boundary, capacity) {
    <span class="hljs-keyword">this</span>.boundary = boundary;  <span class="hljs-comment">// 当前节点矩形区域</span>
    <span class="hljs-keyword">this</span>.capacity = capacity;  <span class="hljs-comment">// 一个节点最多的元素数</span>
    <span class="hljs-keyword">this</span>.rects = [];
    <span class="hljs-keyword">this</span>.divided = <span class="hljs-literal">false</span>;
  }

  insert(rect) { <span class="hljs-comment">/* ...根据边界分裂插入逻辑... */</span> }

  query(point) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.boundary.contains(point)) <span class="hljs-keyword">return</span> [];
    let found = [];
    <span class="hljs-keyword">for</span> (let r of <span class="hljs-keyword">this</span>.rects) {
      <span class="hljs-keyword">if</span> (r.contains(point.x, point.y)) found.push(r);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.divided) {
      found.push(...<span class="hljs-keyword">this</span>.northwest.query(point));
      found.push(...<span class="hljs-keyword">this</span>.northeast.query(point));
      found.push(...<span class="hljs-keyword">this</span>.southwest.query(point));
      found.push(...<span class="hljs-keyword">this</span>.southeast.query(point));
    }
    <span class="hljs-keyword">return</span> found;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">（3）事件层：鼠标移动拾取流逻辑</h3>
<p>核心逻辑架构如下：</p>
<pre><code class="hljs language-scss" lang="scss">mousemove
   ↓
拾取管理器 (PickManager)
   ↓
空间查询 (QuadTree.query)
   ↓
检测命中对象 (Rect.contains)
   ↓
状态同步 (hover / leave / select)
   ↓
渲染层重新绘制目标区域
</code></pre>
<p>完整简化实现：</p>
<pre><code class="hljs language-ini" lang="ini">canvas.addEventListener("mousemove", (e) =&gt; {
  const <span class="hljs-attr">mouse</span> = { x: e.<span class="hljs-literal">off</span>setX, y: e.<span class="hljs-literal">off</span>setY }<span class="hljs-comment">;</span>
  const <span class="hljs-attr">hitRects</span> = quadTree.query(mouse)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">newHover</span> = hitRects[<span class="hljs-number">0</span>] || null<span class="hljs-comment">;</span>
  if (currentHover !== newHover) {
    if (currentHover) <span class="hljs-attr">currentHover.state</span> = <span class="hljs-string">"normal"</span><span class="hljs-comment">;</span>
    if (newHover) <span class="hljs-attr">newHover.state</span> = <span class="hljs-string">"hover"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">currentHover</span> = newHover<span class="hljs-comment">;</span>
    render()<span class="hljs-comment">; // 局部或全局重绘</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<p>这样一来，我们实现了：</p>
<ul>
<li>✅ <strong>实时拾取</strong></li>
<li>✅ <strong>高效区域查询</strong></li>
<li>✅ <strong>状态分离与渲染解耦</strong></li>
</ul>
<hr/>
<h3 data-id="heading-5">（4）渲染层：Canvas / WebGL 混合优化</h3>
<p>对于 Canvas 2D 场景，通常直接 redraw。<br/>
对于复杂 WebGL 场景，可采用双通道：</p>
<ol>
<li>主通道绘制可视内容；</li>
<li>拾取通道（off-screen buffer）绘制唯一颜色 ID；</li>
<li>鼠标事件时，通过 <code>gl.readPixels</code> 获取点击像素颜色 -&gt; 反查对象 ID。</li>
</ol>
<p>这种方案在大型交互式图形系统（如 Mapbox、Three.js）中用途极广。🌍</p>
<hr/>
<h2 data-id="heading-6">🧩 三、性能可行性分析</h2>



































<table><thead><tr><th align="left">指标</th><th align="left">几何拾取</th><th align="left">四叉树加速</th><th align="left">GPU颜色拾取</th></tr></thead><tbody><tr><td align="left">查询复杂度</td><td align="left">O(n)</td><td align="left">O(log n)</td><td align="left">O(1)</td></tr><tr><td align="left">渲染性能</td><td align="left">高CPU占用</td><td align="left">中等</td><td align="left">高GPU开销</td></tr><tr><td align="left">延迟</td><td align="left">极低</td><td align="left">低</td><td align="left">取决于颜色缓冲同步</td></tr><tr><td align="left">适用场景</td><td align="left">少量对象</td><td align="left">大量矩形元素</td><td align="left">复杂场景（3D/WebGL）</td></tr></tbody></table>
<p>结论：</p>
<blockquote>
<p>✅ 对于 Web 端二维 Rect 编辑器或设计工具，<strong>QuadTree + 几何拾取混合方案</strong> 是可行且优雅的架构选择。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">⚙️ 四、工程优化建议 🧪</h2>
<ol>
<li><strong>事件节流（throttle）</strong><br/>
避免每次 <code>mousemove</code> 都触发完整查询，可在 16ms（约60Hz）节流执行。</li>
<li><strong>局部重绘（Dirty Rect）</strong><br/>
只重绘状态变化区域，提升渲染性能。</li>
<li><strong>命中缓存（Hover Cache）</strong><br/>
若连续多帧命中同一元素，不重复查询，降低开销。</li>
<li><strong>交互优先级分层</strong><br/>
针对UI层、图形层分别拾取，按z-index排序命中结果。</li>
</ol>
<hr/>
<h2 data-id="heading-8">🪶 五、哲学层小结：拾取，不只是拾取</h2>
<p>“拾取”看似一个计算几何问题，实则是一次<strong>人与空间的映射关系重建</strong>。</p>
<p>当你从一块平面中精准捕捉一个矩形，背后是：</p>
<ul>
<li>一颗QuadTree在飞速判断区块；</li>
<li>一次GPU在色彩世界编码ID；</li>
<li>一份人机交互的默契在闪光。</li>
</ul>
<blockquote>
<p>工程的浪漫，藏在每一次 <code>mousemove</code> 中。💫</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🧭 总结</h2>






























<table><thead><tr><th>模块</th><th>关键技术</th><th>工程要点</th></tr></thead><tbody><tr><td>数据层</td><td>Rect 对象结构化</td><td>定义边界与状态</td></tr><tr><td>空间层</td><td>QuadTree or 网格划分</td><td>加速查询性能</td></tr><tr><td>事件层</td><td>MouseMove + 状态机</td><td>处理 hover/leave</td></tr><tr><td>渲染层</td><td>局部刷新 / GPU解码</td><td>平衡性能和准确性</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Matplotlib饼图绘制教程：从基础到进阶，精准展示数据占比]]></title>    <link>https://juejin.cn/post/7583871118949646386</link>    <guid>https://juejin.cn/post/7583871118949646386</guid>    <pubDate>2025-12-15T14:24:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583871118949646386" data-draft-id="7583878719544295433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Matplotlib饼图绘制教程：从基础到进阶，精准展示数据占比"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-15T14:24:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="永远是夏天"/> <meta itemprop="url" content="https://juejin.cn/user/1127429986061683"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Matplotlib饼图绘制教程：从基础到进阶，精准展示数据占比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1127429986061683/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    永远是夏天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T14:24:53.000Z" title="Mon Dec 15 2025 14:24:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>饼图是数据可视化中经典的占比类图表，核心用于展示各分类在整体中的比例关系，尤其适合类别数量较少（建议不超过8类）的场景。本文基于Matplotlib详解饼图的绘制方法，涵盖基础绘制、样式定制、进阶优化等核心知识点，结合实战案例让你快速掌握。</p>
<h2 data-id="heading-0">一、基础饼图绘制</h2>
<h3 data-id="heading-1">1. 核心语法与最简示例</h3>
<p>Matplotlib绘制饼图的核心函数是<code>plt.pie()</code>，只需传入“各分类数值”即可生成基础饼图。
示例：展示某电商平台各品类销售额占比</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 解决中文显示问题（通用配置）</span>
plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]  <span class="hljs-comment"># Windows</span>
<span class="hljs-comment"># plt.rcParams["font.sans-serif"] = ["PingFang SC"]  # macOS</span>
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 1. 准备数据：分类名称 + 对应数值（数值会自动计算占比）</span>
categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>]

<span class="hljs-comment"># 2. 创建画布</span>
plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))  <span class="hljs-comment"># 饼图建议用正方形画布，避免变形</span>

<span class="hljs-comment"># 3. 绘制基础饼图</span>
plt.pie(sales,  <span class="hljs-comment"># 核心数据：各分类数值</span>
        labels=categories)  <span class="hljs-comment"># 分类标签</span>

<span class="hljs-comment"># 4. 显示图表</span>
plt.title(<span class="hljs-string">"某电商平台各品类销售额占比"</span>, fontsize=<span class="hljs-number">14</span>)
plt.show()
</code></pre>
<h3 data-id="heading-2">2. 核心参数解析（基础版）</h3>



































<table><thead><tr><th>参数</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>x</code></td><td>必选，各分类的数值（非占比，Matplotlib自动计算）</td><td><code>x=[250, 180, 220]</code></td></tr><tr><td><code>labels</code></td><td>分类标签，对应x的每个数值</td><td><code>labels=["服饰","美妆","食品"]</code></td></tr><tr><td><code>autopct</code></td><td>显示各部分占比，支持格式字符串</td><td><code>autopct="%1.1f%%"</code>（保留1位小数的百分比）</td></tr><tr><td><code>colors</code></td><td>自定义各扇区颜色</td><td><code>colors=["#FF6B6B","#4ECDC4","#45B7D1"]</code></td></tr><tr><td><code>startangle</code></td><td>饼图起始角度（默认从x轴正方向开始，逆时针绘制）</td><td><code>startangle=90</code>（从y轴正方向开始）</td></tr></tbody></table>
<p>优化版基础饼图（添加占比、自定义颜色）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>]
<span class="hljs-comment"># 自定义配色（推荐莫兰迪/清新色系，避免刺眼）</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]

plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))
<span class="hljs-comment"># 绘制饼图，添加占比和颜色</span>
plt.pie(sales,
        labels=categories,
        autopct=<span class="hljs-string">"%1.1f%%"</span>,  <span class="hljs-comment"># 显示占比（1位小数）</span>
        colors=colors,
        startangle=<span class="hljs-number">90</span>)  <span class="hljs-comment"># 起始角度90度</span>

plt.title(<span class="hljs-string">"某电商平台各品类销售额占比"</span>, fontsize=<span class="hljs-number">14</span>)
plt.axis(<span class="hljs-string">"equal"</span>)  <span class="hljs-comment"># 强制饼图为正圆形（关键！避免拉伸变形）</span>
plt.show()
</code></pre>
<h2 data-id="heading-3">二、进阶优化：突出重点、提升可读性</h2>
<h3 data-id="heading-4">1. 突出核心分类（explode参数）</h3>
<p>通过<code>explode</code>参数可将指定扇区“分离”出来，突出重点类别（如占比最高的“数码”品类）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>]
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]
<span class="hljs-comment"># explode：对应每个扇区的分离距离，0为不分离，数值越大分离越远</span>
explode = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># 仅“数码”扇区分离0.1距离</span>

plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))
plt.pie(sales,
        labels=categories,
        autopct=<span class="hljs-string">"%1.1f%%"</span>,
        colors=colors,
        startangle=<span class="hljs-number">90</span>,
        explode=explode,  <span class="hljs-comment"># 启用分离效果</span>
        shadow=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 添加阴影，增强立体感</span>

plt.title(<span class="hljs-string">"某电商平台各品类销售额占比（突出数码品类）"</span>, fontsize=<span class="hljs-number">14</span>)
plt.axis(<span class="hljs-string">"equal"</span>)
plt.show()
</code></pre>
<h3 data-id="heading-5">2. 优化标签样式（字体、位置）</h3>
<p>默认标签可能重叠或样式单一，可通过<code>textprops</code>调整标签样式，或手动调整占比标签位置：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>]
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]
explode = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>)

plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))
<span class="hljs-comment"># 绘制饼图并捕获文本对象（用于后续调整）</span>
patches, texts, autotexts = plt.pie(
    sales,
    labels=categories,
    autopct=<span class="hljs-string">"%1.1f%%"</span>,
    colors=colors,
    startangle=<span class="hljs-number">90</span>,
    explode=explode,
    shadow=<span class="hljs-literal">True</span>,
    textprops={<span class="hljs-string">"fontsize"</span>: <span class="hljs-number">11</span>}  <span class="hljs-comment"># 统一设置标签字体大小</span>
)

<span class="hljs-comment"># 单独调整占比标签样式（如颜色、加粗）</span>
<span class="hljs-keyword">for</span> autotext <span class="hljs-keyword">in</span> autotexts:
    autotext.set_color(<span class="hljs-string">"white"</span>)  <span class="hljs-comment"># 占比文字设为白色</span>
    autotext.set_fontweight(<span class="hljs-string">"bold"</span>)  <span class="hljs-comment"># 加粗</span>

plt.title(<span class="hljs-string">"某电商平台各品类销售额占比"</span>, fontsize=<span class="hljs-number">14</span>)
plt.axis(<span class="hljs-string">"equal"</span>)
plt.show()
</code></pre>
<h3 data-id="heading-6">3. 处理小占比类别（避免标签重叠）</h3>
<p>若部分类别占比过小（如&lt;5%），可将其合并为“其他”类，或通过<code>pctdistance</code>调整占比标签位置：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 原始数据：含小占比类别</span>
categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>, <span class="hljs-string">"图书"</span>, <span class="hljs-string">"配饰"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>, <span class="hljs-number">30</span>, <span class="hljs-number">20</span>]

<span class="hljs-comment"># 合并小占比类别（图书+配饰=其他）</span>
new_categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>, <span class="hljs-string">"其他"</span>]
new_sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>, <span class="hljs-number">50</span>]
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>, <span class="hljs-string">"#DDA0DD"</span>]

plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))
plt.pie(new_sales,
        labels=new_categories,
        autopct=<span class="hljs-string">"%1.1f%%"</span>,
        colors=colors,
        startangle=<span class="hljs-number">90</span>,
        pctdistance=<span class="hljs-number">0.85</span>)  <span class="hljs-comment"># 占比标签距离圆心的比例（默认0.6，调大避免重叠）</span>

plt.title(<span class="hljs-string">"某电商平台各品类销售额占比（合并小品类）"</span>, fontsize=<span class="hljs-number">14</span>)
plt.axis(<span class="hljs-string">"equal"</span>)
plt.show()
</code></pre>
<h2 data-id="heading-7">三、特殊场景：环形饼图（空心饼图）</h2>
<p>环形饼图比普通饼图更美观，且可在中心添加文字，适合展示多层占比或突出视觉效果。
实现原理：绘制两个饼图，外层为数据，内层为白色填充的“空心”。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]
plt.rcParams[<span class="hljs-string">"axes.unicode_minus"</span>] = <span class="hljs-literal">False</span>

categories = [<span class="hljs-string">"服饰"</span>, <span class="hljs-string">"美妆"</span>, <span class="hljs-string">"食品"</span>, <span class="hljs-string">"数码"</span>, <span class="hljs-string">"家居"</span>]
sales = [<span class="hljs-number">250</span>, <span class="hljs-number">180</span>, <span class="hljs-number">220</span>, <span class="hljs-number">300</span>, <span class="hljs-number">150</span>]
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]

plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>))
<span class="hljs-comment"># 绘制外层数据饼图</span>
plt.pie(sales,
        labels=categories,
        autopct=<span class="hljs-string">"%1.1f%%"</span>,
        colors=colors,
        startangle=<span class="hljs-number">90</span>,
        wedgeprops={<span class="hljs-string">"width"</span>: <span class="hljs-number">0.3</span>})  <span class="hljs-comment"># width：环形宽度（0-1，越小越细）</span>

<span class="hljs-comment"># 绘制内层空心（白色填充）</span>
plt.pie([<span class="hljs-number">1</span>], colors=<span class="hljs-string">"white"</span>, radius=<span class="hljs-number">0.7</span>)  <span class="hljs-comment"># radius：内层半径（小于外层）</span>

<span class="hljs-comment"># 中心添加文字</span>
plt.text(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"总销售额\n1100万"</span>, ha=<span class="hljs-string">"center"</span>, va=<span class="hljs-string">"center"</span>, fontsize=<span class="hljs-number">12</span>)

plt.title(<span class="hljs-string">"某电商平台各品类销售额占比（环形图）"</span>, fontsize=<span class="hljs-number">14</span>)
plt.axis(<span class="hljs-string">"equal"</span>)
plt.show()
</code></pre>
<h2 data-id="heading-8">四、饼图绘制注意事项</h2>
<ol>
<li><strong>适用场景</strong>：仅用于展示“部分-整体”关系，且类别数不宜过多（建议≤6类），否则扇区过小、可读性差；</li>
<li><strong>避免误导</strong>：饼图的视觉效果易受起始角度、扇区顺序影响，若需精准对比占比，优先用柱状图；</li>
<li><strong>正圆形保障</strong>：务必添加<code>plt.axis("equal")</code>，否则画布拉伸会导致饼图变形为椭圆；</li>
<li><strong>中文与负号</strong>：始终配置<code>rcParams</code>解决中文乱码和负号显示问题；</li>
<li><strong>保存高清图</strong>：用<code>plt.savefig("饼图.png", dpi=300, bbox_inches="tight")</code>替代<code>plt.show()</code>，避免文字截断。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程池中任务堆积与饥饿死锁问题]]></title>    <link>https://juejin.cn/post/7583943503556198450</link>    <guid>https://juejin.cn/post/7583943503556198450</guid>    <pubDate>2025-12-16T01:03:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583943503556198450" data-draft-id="7583912637471244339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程池中任务堆积与饥饿死锁问题"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-16T01:03:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程池中任务堆积与饥饿死锁问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:03:44.000Z" title="Tue Dec 16 2025 01:03:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个电商后台系统中，使用线程池来处理订单处理、库存更新、物流通知等多种异步任务。随着业务量的增长，系统逐渐出现响应变慢的情况，部分任务甚至长时间得不到执行，最终导致一些关键业务流程受阻。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">任务类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String taskName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessTask</span><span class="hljs-params">(String taskName)</span> {
        <span class="hljs-built_in">this</span>.taskName = taskName;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟业务处理</span>
            Thread.sleep(<span class="hljs-number">1000</span>);
            System.out.println(taskName + <span class="hljs-string">" 任务完成"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<h3 data-id="heading-3">线程池配置与任务提交（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceSystem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CORE_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">KEEP_ALIVE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        BlockingQueue&lt;Runnable&gt; taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(QUEUE_CAPACITY);
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                taskQueue);

        <span class="hljs-comment">// 模拟提交大量任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"任务 "</span> + i;
            executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessTask</span>(taskName));
        }

        executor.shutdown();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                executor.shutdownNow();
                <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                    System.err.println(<span class="hljs-string">"线程池未正常关闭"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li>
<p><strong>预期行为</strong>：线程池能够高效处理提交的任务，所有任务都能在合理时间内完成，系统保持稳定运行。</p>
</li>
<li>
<p><strong>实际行为</strong>：</p>
<ul>
<li><strong>任务堆积</strong>：随着任务不断提交，任务队列逐渐被填满，新任务只能等待队列有空位或者线程池创建新线程（达到最大线程数后也只能等待）。这是因为线程池的核心线程数和最大线程数设置相对业务量过小，并且任务执行时间较长，导致任务处理速度跟不上提交速度。</li>
<li><strong>饥饿死锁</strong>：在任务队列中可能存在优先级不同的任务，例如订单处理任务优先级较高，物流通知任务优先级较低。如果高优先级任务持续提交，线程池中的线程会一直忙于处理高优先级任务，低优先级任务可能长时间得不到执行，出现饥饿现象。极端情况下，可能导致低优先级任务永远无法执行，形成一种类似死锁的状态。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>优化线程池参数</strong>：根据实际业务负载和任务特性，合理调整线程池参数。例如，如果任务执行时间较短且数量较多，可以适当增加核心线程数和最大线程数；如果任务执行时间较长，可以扩大任务队列容量。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CORE_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;
</code></pre>
<ol start="2">
<li><strong>使用优先级队列和优先级线程池</strong>：对任务进行优先级划分，使用 <code>PriorityBlockingQueue</code> 作为任务队列，并自定义 <code>PriorityThreadPoolExecutor</code> 来处理不同优先级的任务。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.PriorityBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityBusinessTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>, Comparable&lt;PriorityBusinessTask&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String taskName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priority;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PriorityBusinessTask</span><span class="hljs-params">(String taskName, <span class="hljs-type">int</span> priority)</span> {
        <span class="hljs-built_in">this</span>.taskName = taskName;
        <span class="hljs-built_in">this</span>.priority = priority;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟业务处理</span>
            Thread.sleep(<span class="hljs-number">1000</span>);
            System.out.println(taskName + <span class="hljs-string">" 任务完成"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(PriorityBusinessTask other)</span> {
        <span class="hljs-keyword">return</span> Integer.compare(other.priority, <span class="hljs-built_in">this</span>.priority);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PriorityThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize, <span class="hljs-type">int</span> maximumPoolSize, <span class="hljs-type">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue)</span> {
        <span class="hljs-built_in">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeExecute</span><span class="hljs-params">(Thread t, Runnable r)</span> {
        <span class="hljs-built_in">super</span>.beforeExecute(t, r);
        <span class="hljs-keyword">if</span> (r <span class="hljs-keyword">instanceof</span> PriorityBusinessTask) {
            System.out.println(<span class="hljs-string">"开始执行优先级任务: "</span> + ((PriorityBusinessTask) r).taskName);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterExecute</span><span class="hljs-params">(Runnable r, Throwable t)</span> {
        <span class="hljs-built_in">super</span>.afterExecute(r, t);
        <span class="hljs-keyword">if</span> (r <span class="hljs-keyword">instanceof</span> PriorityBusinessTask) {
            System.out.println(<span class="hljs-string">"完成优先级任务: "</span> + ((PriorityBusinessTask) r).taskName);
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceSystem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CORE_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">KEEP_ALIVE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        BlockingQueue&lt;Runnable&gt; taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>&lt;&gt;(QUEUE_CAPACITY);
        <span class="hljs-type">PriorityThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityThreadPoolExecutor</span>(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                taskQueue);

        <span class="hljs-comment">// 模拟提交不同优先级任务</span>
        executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBusinessTask</span>(<span class="hljs-string">"高优先级任务 1"</span>, <span class="hljs-number">1</span>));
        executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBusinessTask</span>(<span class="hljs-string">"低优先级任务 1"</span>, <span class="hljs-number">3</span>));
        executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBusinessTask</span>(<span class="hljs-string">"高优先级任务 2"</span>, <span class="hljs-number">1</span>));
        executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBusinessTask</span>(<span class="hljs-string">"低优先级任务 2"</span>, <span class="hljs-number">3</span>));

        executor.shutdown();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                executor.shutdownNow();
                <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                    System.err.println(<span class="hljs-string">"线程池未正常关闭"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<ol start="3">
<li><strong>动态调整线程池</strong>：根据系统运行时的任务队列长度、线程池活跃线程数等指标，动态调整线程池的参数，以适应业务量的变化。可以使用定时任务定期检查并调整线程池大小。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.ScheduledThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceSystem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INITIAL_CORE_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INITIAL_MAX_POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">KEEP_ALIVE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        BlockingQueue&lt;Runnable&gt; taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(QUEUE_CAPACITY);
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
                INITIAL_CORE_POOL_SIZE,
                INITIAL_MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                taskQueue);

        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(<span class="hljs-number">1</span>);
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-type">int</span> <span class="hljs-variable">queueSize</span> <span class="hljs-operator">=</span> taskQueue.size();
            <span class="hljs-type">int</span> <span class="hljs-variable">activeCount</span> <span class="hljs-operator">=</span> executor.getActiveCount();
            <span class="hljs-keyword">if</span> (queueSize &gt; QUEUE_CAPACITY * <span class="hljs-number">0.8</span> &amp;&amp; activeCount &lt; INITIAL_MAX_POOL_SIZE) {
                executor.setCorePoolSize(executor.getCorePoolSize() + <span class="hljs-number">1</span>);
                executor.setMaximumPoolSize(executor.getMaximumPoolSize() + <span class="hljs-number">1</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (queueSize &lt; QUEUE_CAPACITY * <span class="hljs-number">0.2</span> &amp;&amp; activeCount &gt; INITIAL_CORE_POOL_SIZE) {
                executor.setCorePoolSize(executor.getCorePoolSize() - <span class="hljs-number">1</span>);
                executor.setMaximumPoolSize(executor.getMaximumPoolSize() - <span class="hljs-number">1</span>);
            }
        }, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);

        <span class="hljs-comment">// 模拟提交大量任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"任务 "</span> + i;
            executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessTask</span>(taskName));
        }

        executor.shutdown();
        scheduler.shutdown();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                executor.shutdownNow();
                <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                    System.err.println(<span class="hljs-string">"线程池未正常关闭"</span>);
                }
            }
            <span class="hljs-keyword">if</span> (!scheduler.awaitTermination(<span class="hljs-number">1</span>, TimeUnit.MINUTES)) {
                scheduler.shutdownNow();
                <span class="hljs-keyword">if</span> (!scheduler.awaitTermination(<span class="hljs-number">1</span>, TimeUnit.MINUTES)) {
                    System.err.println(<span class="hljs-string">"调度器未正常关闭"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            executor.shutdownNow();
            scheduler.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3的`:style`对象语法：单位、属性名、响应式，这些细节你都踩过坑吗？]]></title>    <link>https://juejin.cn/post/7583910418658983982</link>    <guid>https://juejin.cn/post/7583910418658983982</guid>    <pubDate>2025-12-15T16:08:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910418658983982" data-draft-id="7583912637470605363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3的`:style`对象语法：单位、属性名、响应式，这些细节你都踩过坑吗？    "/> <meta itemprop="keywords" content="前端,AI编程,Trae"/> <meta itemprop="datePublished" content="2025-12-15T16:08:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3的`:style`对象语法：单位、属性名、响应式，这些细节你都踩过坑吗？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T16:08:48.000Z" title="Mon Dec 15 2025 16:08:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、从“动态改样式”说起：为什么需要<code>:style</code>对象语法？</h3>
<p>在实际开发中，我们经常遇到**“数据变，样式跟着变”**的场景——比如：</p>
<ul>
<li>按钮点击后从蓝色变成绿色；</li>
<li>进度条的宽度随完成度增加；</li>
<li>文本的字体大小根据用户设置调整。</li>
</ul>
<p>这些场景如果用原生JS实现，需要手动操作<code>element.style</code>，代码繁琐且容易出错。而Vue3的<code>:style</code>绑定（全称<code>v-bind:style</code>），尤其是<strong>对象语法</strong>，能让我们用“声明式”的方式把响应式数据和样式关联起来，优雅解决动态样式问题。</p>
<h3 data-id="heading-1">二、<code>:style</code>对象语法基础：把样式写成“键值对”</h3>
<p><code>:style</code>的对象语法本质是<strong>将CSS样式映射为JavaScript对象</strong>——对象的<strong>键</strong>是CSS属性（如<code>color</code>、<code>fontSize</code>），<strong>值</strong>是要绑定的响应式数据（或普通值）。</p>
<h4 data-id="heading-2">1. 最简示例：绑定颜色和字体大小</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 用:style绑定对象，键是CSS属性，值是响应式数据 --&gt;
  &lt;div :style="{ color: textColor, fontSize: fontSize + 'px' }"&gt;
    我是动态样式的文本
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 响应式颜色：初始红色
const textColor = ref('red')
// 响应式字体大小：初始30px（数字需加单位）
const fontSize = ref(30)
&lt;/script&gt;
</code></pre>
<p><strong>关键点解释</strong>：</p>
<ul>
<li><strong>CSS属性的键</strong>：可以用<strong>驼峰命名</strong>（如<code>fontSize</code>）或<strong>短横线命名</strong>（如<code>'font-size'</code>，需加引号），Vue会自动将驼峰转成短横线（对应CSS原生属性）。</li>
<li><strong>值的单位</strong>：CSS大部分属性需要单位（如<code>px</code>、<code>em</code>），Vue<strong>不会自动添加单位</strong>（除非值是<code>0</code>）。因此<code>fontSize</code>需要手动拼接<code>'px'</code>，否则会渲染成无效的<code>font-size: 30</code>。</li>
</ul>
<h3 data-id="heading-3">三、响应式数据绑定：让样式“跟着数据走”</h3>
<p><code>:style</code>的核心优势是<strong>响应式</strong>——当绑定的<code>ref</code>或<code>reactive</code>数据变化时，样式会自动更新。</p>
<h4 data-id="heading-4">实战：点击换色按钮</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button 
    @click="toggleColor"
    :style="{ 
      backgroundColor: btnBg, 
      color: 'white', 
      padding: '8px 16px', 
      border: 'none', 
      borderRadius: '4px',
      cursor: 'pointer'
    }"
  &gt;
    {{ btnText }}
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 响应式背景色：初始蓝色
const btnBg = ref('#2196F3')
// 响应式按钮文本
const btnText = ref('点击变绿')

// 点击事件：切换颜色和文本
const toggleColor = () =&gt; {
  if (btnBg.value === '#2196F3') {
    btnBg.value = '#4CAF50' // 切换为绿色
    btnText.value = '点击变蓝'
  } else {
    btnBg.value = '#2196F3' // 切换回蓝色
    btnText.value = '点击变绿'
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>效果</strong>：点击按钮时，<code>btnBg</code>和<code>btnText</code>的响应式数据变化，按钮的背景色和文本会<strong>自动更新</strong>——无需手动操作DOM，这就是Vue的“数据驱动视图”魅力。</p>
<h3 data-id="heading-5">四、CSS属性类型：字符串、数字、布尔值怎么用？</h3>
<p><code>:style</code>支持的样式值类型主要有3种：</p>

























<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>字符串</td><td>最常用，适用于需要单位或关键字的属性（如颜色、边框、字体）</td><td><code>'red'</code>、<code>'2px solid gray'</code></td></tr><tr><td>数字</td><td>仅适用于无需单位的属性（如<code>z-index</code>、<code>opacity</code>）或需手动加单位的情况</td><td><code>30</code>（需转<code>'30px'</code>）、<code>0.5</code></td></tr><tr><td>布尔值</td><td>用于条件控制样式值（最终还是字符串）</td><td><code>isShow ? 'block' : 'none'</code></td></tr></tbody></table>
<h4 data-id="heading-6">示例：用布尔值控制显示隐藏</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div :style="{ display: isVisible ? 'block' : 'none' }"&gt;
    我是可以隐藏的文本
  &lt;/div&gt;
  &lt;button @click="isVisible = !isVisible"&gt;
    {{ isVisible ? '隐藏' : '显示' }}
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 布尔值控制显示状态
const isVisible = ref(true)
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">五、驼峰vs短横线：选哪个更顺手？</h3>
<p><code>:style</code>的对象键支持两种写法，效果完全一致：</p>




















<table><thead><tr><th>写法</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>驼峰命名（推荐）</td><td><code>fontSize: '30px'</code></td><td>符合JavaScript对象命名习惯，无需引号</td></tr><tr><td>短横线命名</td><td><code>'font-size': '30px'</code></td><td>贴近CSS原生写法，需加引号</td></tr></tbody></table>
<p><strong>推荐用驼峰</strong>：更简洁，不用记引号，且Vue官方文档也更倾向这种写法。</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h3 data-id="heading-8">六、实际案例：动态进度条</h3>
<p>我们来做一个<strong>实用的动态进度条</strong>——点击按钮增加进度，进度条的宽度和颜色随进度变化：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="progress-container"&gt;
    &lt;!-- 进度条背景 --&gt;
    &lt;div class="progress-bg"&gt;
      &lt;!-- 动态进度条：宽度=progress%，颜色随进度变化 --&gt;
      &lt;div 
        class="progress-bar"
        :style="{ 
          width: progress + '%', 
          backgroundColor: progress &gt; 50 ? '#4CAF50' : '#FF9800' 
        }"
      &gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- 控制按钮 --&gt;
    &lt;button @click="addProgress" :disabled="progress &gt;= 100"&gt;
      {{ progress &gt;= 100 ? '进度已满' : '增加进度' }}
    &lt;/button&gt;
    &lt;!-- 进度显示 --&gt;
    &lt;p class="progress-text"&gt;当前进度：{{ progress }}%&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 响应式进度值：初始0%
const progress = ref(0)

// 增加进度：每次加10，最多100
const addProgress = () =&gt; {
  if (progress.value &lt; 100) {
    progress.value += 10
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.progress-container {
  margin: 20px;
  font-family: Arial, sans-serif;
}
.progress-bg {
  width: 300px;
  height: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 10px;
}
.progress-bar {
  height: 100%;
  transition: width 0.3s ease; /* 平滑过渡动画 */
  border-radius: 10px;
}
button {
  padding: 8px 16px;
  background-color: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}
.progress-text {
  margin-top: 10px;
  font-size: 14px;
}
&lt;/style&gt;
</code></pre>
<p><strong>效果说明</strong>：</p>
<ul>
<li>进度条宽度：用<code>progress + '%'</code>动态绑定，进度从0到100时，宽度从0%到100%。</li>
<li>进度条颜色：用三元表达式<code>progress &gt; 50 ? '#4CAF50' : '#FF9800'</code>，进度超过50%变绿色，否则变橙色。</li>
<li>过渡动画：<code>transition: width 0.3s ease</code>让进度变化更平滑。</li>
</ul>
<h3 data-id="heading-9">七、课后Quiz：巩固知识点</h3>
<h4 data-id="heading-10">问题1：</h4>
<p>在Vue3中，使用<code>:style</code>对象语法时，为什么<code>fontSize</code>需要写成<code>fontSize + 'px'</code>而不是直接写<code>fontSize</code>？</p>
<p><strong>答案解析</strong>：<br/>
CSS的<code>font-size</code>属性需要<strong>单位</strong>（如<code>px</code>），而Vue不会自动为数字添加单位（除非值是<code>0</code>）。如果直接写<code>fontSize</code>（假设是<code>ref(30)</code>），模板会渲染成<code>font-size: 30</code>——这在CSS中是无效的，因此必须手动添加<code>'px'</code>变成<code>'30px'</code>。</p>
<h4 data-id="heading-11">问题2：</h4>
<p>请写出一个用<code>:style</code>对象语法绑定<strong>响应式背景色</strong>和<strong>边框</strong>的例子，要求：</p>
<ul>
<li>背景色是<code>ref('lightblue')</code>；</li>
<li>边框是<code>ref('2px solid gray')</code>。</li>
</ul>
<p><strong>答案示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div :style="{ backgroundColor: bgColor, border: borderStyle }"&gt;
    我是带动态样式的盒子
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const bgColor = ref('lightblue')
const borderStyle = ref('2px solid gray')
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-12">八、常见报错与解决办法</h3>
<p>在使用<code>:style</code>时，这些错误你可能会遇到：</p>
<h4 data-id="heading-13">报错1：短横线键未加引号导致语法错误</h4>
<p><strong>错误代码</strong>：<code>{ font-size: '30px' }</code><br/>
<strong>原因</strong>：JavaScript对象的键如果包含<code>-</code>，必须用字符串引号包裹，否则会被解析成<strong>减法运算</strong>（<code>font - size</code>）。<br/>
<strong>解决</strong>：给短横线键加引号（<code>'font-size'</code>），或改用驼峰（<code>fontSize</code>）。</p>
<h4 data-id="heading-14">报错2：响应式数据变了，但样式没更新</h4>
<p><strong>错误代码</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 用let定义非响应式数据</span>
<span class="hljs-keyword">let</span> progress = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addProgress</span> = (<span class="hljs-params"/>) =&gt; {
  progress += <span class="hljs-number">10</span> <span class="hljs-comment">// Vue无法检测变化</span>
}
</code></pre>
<p><strong>原因</strong>：<code>let</code>变量不是响应式的，Vue无法追踪其变化。<br/>
<strong>解决</strong>：用<code>ref</code>或<code>reactive</code>定义响应式数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addProgress</span> = (<span class="hljs-params"/>) =&gt; {
  progress.<span class="hljs-property">value</span> += <span class="hljs-number">10</span> <span class="hljs-comment">// 修改响应式数据</span>
}
</code></pre>
<h4 data-id="heading-15">报错3：属性名拼写错误导致样式不生效</h4>
<p><strong>错误代码</strong>：<code>{ backgroundcolor: 'lightblue' }</code>（小写<code>C</code>）<br/>
<strong>原因</strong>：CSS属性的驼峰命名必须正确（<code>backgroundColor</code>对应<code>background-color</code>），拼写错误会导致Vue无法识别。<br/>
<strong>解决</strong>：检查属性名的大小写，或用短横线加引号（<code>'background-color'</code>）。</p>
<h3 data-id="heading-16">参考链接</h3>
<p>Vue3官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fclass-and-style.html%23binding-inline-styles" target="_blank" title="https://vuejs.org/guide/essentials/class-and-style.html#binding-inline-styles" ref="nofollow noopener noreferrer">Class and Style Bindings - Binding Inline Styles</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue生命周期详解：从创建到销毁的全过程]]></title>    <link>https://juejin.cn/post/7583906478329020435</link>    <guid>https://juejin.cn/post/7583906478329020435</guid>    <pubDate>2025-12-15T16:09:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906478329020435" data-draft-id="7583912899389456427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue生命周期详解：从创建到销毁的全过程"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2025-12-15T16:09:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue生命周期详解：从创建到销毁的全过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T16:09:59.000Z" title="Mon Dec 15 2025 16:09:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 Vue 的过程中，我逐渐意识到一个问题：**为什么同样是写数据、改数据，有些代码只能写在某些地方？为什么定时器、请求、事件绑定如果位置不对，就会出 bug？**答案几乎都指向同一个核心概念——<strong>Vue 生命周期</strong>。</p>
<p>Vue 生命周期并不是抽象的“理论名词”，而是 Vue 在实例从创建到销毁的整个过程中，在<strong>关键时间点自动帮我们调用的一组函数</strong>。这些函数有固定的名字、固定的调用时机，而我们能做的，就是在合适的钩子中写合适的代码。</p>
<hr/>
<h2 data-id="heading-0">一、生命周期的本质：Vue 在“关键时刻”帮你调用函数</h2>
<p>从第一个示例可以看到，生命周期也被称为<strong>生命周期回调函数、生命周期函数或生命周期钩子</strong>。它的本质并不复杂：</p>
<blockquote>
<p>Vue 在内部流程的某些关键阶段，<strong>自动调用我们提前写好的函数</strong>1.引出生命周期</p>
</blockquote>
<p>有几个非常重要的特性需要先明确：</p>
<ul>
<li>生命周期函数的<strong>名字不能随便改</strong></li>
<li>生命周期函数内部的代码由开发者决定</li>
<li>生命周期函数中的 <code>this</code> 永远指向当前的 <strong>Vue 实例（vm）</strong></li>
</ul>
<p>也正因为 <code>this</code> 指向 vm，我们才能在生命周期中自由访问 <code>data</code>、<code>methods</code>、<code>computed</code> 等内容。</p>
<hr/>
<h2 data-id="heading-1">二、mounted：最常用、也最容易被误用的生命周期</h2>
<p>在第一个示例中，页面上有一段非常直观的动画效果：文字透明度不断降低，又循环恢复。这个效果并不是通过操作 DOM 实现的，而是通过<strong>修改响应式数据 opacity</strong> 来完成的1.引出生命周期。</p>
<p>关键代码写在了 <code>mounted()</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span> -= <span class="hljs-number">0.01</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span> &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span> = <span class="hljs-number">1</span>;
    }
  }, <span class="hljs-number">16</span>)
}
</code></pre>
<p>之所以把定时器写在 <code>mounted</code>，原因非常明确：</p>
<ul>
<li>在 <code>mounted</code> 之前，模板还没有真正渲染成 DOM</li>
<li>只有在 <code>mounted</code> 执行时，<strong>真实 DOM 已经挂载完成</strong></li>
<li>所有依赖页面结构、DOM 或视图更新的逻辑，都应该放在这里</li>
</ul>
<p>需要特别注意的是：<br/>
<strong>mounted 只会在“初次挂载”时调用一次</strong>，后续数据变化引起的重新渲染，并不会再次触发 mounted，而是走更新相关的生命周期。</p>
<hr/>
<h2 data-id="heading-2">三、为什么要学 beforeDestroy？——生命周期的“收尾阶段”</h2>
<p>第二个示例在第一个基础上进一步完善了逻辑，引出了一个非常现实的问题：<br/>
**定时器什么时候清？Vue 实例销毁后会发生什么？**1.总结生命周期</p>
<p>在这个例子中，点击“点我停止”按钮，会调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.$destroy();
</code></pre>
<p>这行代码会手动销毁当前 Vue 实例，而在销毁之前，Vue 会调用 <code>beforeDestroy()</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>);
}
</code></pre>
<p>这正是生命周期的<strong>收尾价值所在</strong>。</p>
<p>在实际开发中：</p>
<ul>
<li><code>mounted</code> 负责“初始化”</li>
<li><code>beforeDestroy</code> 负责“清理善后”</li>
</ul>
<p>例如：</p>
<ul>
<li>清除定时器</li>
<li>解绑自定义事件</li>
<li>取消消息订阅</li>
<li>关闭 WebSocket 连接</li>
</ul>
<p>如果不在销毁前清理这些内容，就会导致<strong>内存泄漏</strong>，甚至逻辑混乱。</p>
<p>另外，示例中还明确指出：</p>
<ul>
<li>Vue 实例销毁后，开发者工具中将不再显示该实例</li>
<li>Vue 的自定义事件会失效</li>
<li>原生 DOM 事件依然存在</li>
<li>在 <code>beforeDestroy</code> 中修改数据是没有意义的，因为更新流程已经不会再触发了1.总结生命周期</li>
</ul>
<hr/>
<h2 data-id="heading-3">四、完整生命周期流程：从 beforeCreate 到 destroyed</h2>
<p>第三个示例是对 Vue 生命周期最系统的一次演示，它几乎覆盖了所有常见的生命周期钩子，并通过 <code>console.log</code> 清晰地展示了调用顺序2.分析生命周期。</p>
<h3 data-id="heading-4">1️⃣ beforeCreate</h3>
<p>这是 Vue 实例刚被创建时调用的钩子：</p>
<ul>
<li>data 尚未初始化</li>
<li>methods 尚未初始化</li>
<li>访问 <code>this.n</code> 得到的是 <code>undefined</code></li>
</ul>
<p>这说明：<br/>
<strong>beforeCreate 几乎不适合写业务代码</strong></p>
<hr/>
<h3 data-id="heading-5">2️⃣ created</h3>
<p>在这个阶段：</p>
<ul>
<li>data 已经变成响应式数据</li>
<li>methods 已经可以正常调用</li>
<li>但 DOM 还没有生成</li>
</ul>
<p>如果你只关心数据、而不依赖页面结构，<code>created</code> 是一个可以使用的阶段。</p>
<hr/>
<h3 data-id="heading-6">3️⃣ beforeMount</h3>
<p>此时：</p>
<ul>
<li>模板已经编译完成</li>
<li>虚拟 DOM 已经生成</li>
<li>但还没有挂载到页面上</li>
</ul>
<p>打印 <code>this.$el</code> 会发现，它还不是最终呈现在页面中的 DOM。</p>
<hr/>
<h3 data-id="heading-7">4️⃣ mounted（最重要）</h3>
<p>这是生命周期中<strong>使用频率最高</strong>的一个钩子：</p>
<ul>
<li>虚拟 DOM 已转为真实 DOM</li>
<li>页面已经完成首次渲染</li>
<li><code>$el</code> 就是页面中真实存在的 DOM</li>
</ul>
<p>几乎所有涉及 DOM、视图、第三方库初始化的逻辑，都应该写在这里。</p>
<hr/>
<h3 data-id="heading-8">5️⃣ beforeUpdate / updated</h3>
<p>当数据发生变化时：</p>
<ul>
<li><code>beforeUpdate</code> 在视图更新之前触发</li>
<li><code>updated</code> 在视图更新之后触发</li>
</ul>
<p>它们常用于：</p>
<ul>
<li>调试</li>
<li>对比更新前后的状态</li>
<li>少量特殊场景下的 DOM 同步操作</li>
</ul>
<p>但在实际业务中，<strong>不建议滥用更新钩子</strong>。</p>
<hr/>
<h3 data-id="heading-9">6️⃣ beforeDestroy / destroyed</h3>
<p>这是 Vue 实例生命周期的终点：</p>
<ul>
<li><code>beforeDestroy</code>：还能访问 data 和 methods</li>
<li><code>destroyed</code>：实例已经彻底不可用</li>
</ul>
<p>一般来说，真正有价值的是 <code>beforeDestroy</code>，而 <code>destroyed</code> 很少使用。</p>
<hr/>
<h2 data-id="heading-10">五、从“记生命周期”到“会用生命周期”</h2>
<p>通过这三段代码可以清楚地看到，生命周期并不是让人死记硬背的流程图，而是一套<strong>明确解决实际问题的时间节点机制</strong>：</p>
<ul>
<li>初始化逻辑 → <code>mounted</code></li>
<li>数据准备 → <code>created</code></li>
<li>DOM 操作 → <code>mounted</code></li>
<li>更新监听 → <code>updated</code></li>
<li>清理资源 → <code>beforeDestroy</code></li>
</ul>
<p>当我真正理解这些钩子的<strong>调用时机和设计目的</strong>之后，很多之前“写着写着就出 bug”的问题，都会自然消失。</p>
<p>Vue 生命周期的学习重点，从来不是“有多少个钩子”，而是——<br/>
<strong>在对的时间，做对的事。</strong></p>
<h2 data-id="heading-11">六、总结</h2>
<p>Vue生命周期钩子为开发者提供了在特定阶段介入实例生命周期的能力。通过合理使用这些钩子，我们可以：</p>
<ul>
<li>在正确时机执行初始化操作</li>
<li>有效管理资源，防止内存泄漏</li>
<li>优化应用性能</li>
<li>更好地理解和控制应用状态</li>
</ul>
<p>掌握生命周期不仅有助于编写更健壮的Vue应用，也是深入理解Vue响应式系统工作原理的关键。建议开发者在实际项目中多实践、多观察，逐步形成对生命周期各阶段的直观感受。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day30 | Java集合框架之Collections工具类]]></title>    <link>https://juejin.cn/post/7583943503556280370</link>    <guid>https://juejin.cn/post/7583943503556280370</guid>    <pubDate>2025-12-16T01:11:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583943503556280370" data-draft-id="7583912637471309875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day30 | Java集合框架之Collections工具类"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-16T01:11:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day30 | Java集合框架之Collections工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:11:57.000Z" title="Tue Dec 16 2025 01:11:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Day26~29的文章我们一起学习了Java集合框架的三大核心接口：List、Set和Map。</p>
<p>今天我们一起看一下java.util.Collections类，注意不是之前我们提到的Collection。</p>
<p>Collection接口定义了集合的是什么，多了个s的Collections是一套集合操作的工具箱。</p>
<p>Collections里提供了很多强大、方便的静态方法，能极大简化我们对集合的操作。</p>
<h2 data-id="heading-0">一、集合排序</h2>
<p>在实际开发中，对数据进行排序是最常见的需求之一。Collections.sort() 方法可以轻松地对任何List集合进行排序。</p>
<h3 data-id="heading-1">1.1自然排序</h3>
<p>如果List里的元素实现了Comparable接口（如Integer, String 等），sort方法会按照它们的自然顺序进行排序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5bcd28af23a415dba43b89555c3509d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=KKQspnKSwENDYBmxrUsiciwvqDc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0a581789f945159e134a5b6555f640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=R9xRQ7y90LjLq3ul1nOuWrHEIvc%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 15:13
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; numbers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        numbers.add(<span class="hljs-number">5</span>);
        numbers.add(<span class="hljs-number">1</span>);
        numbers.add(<span class="hljs-number">9</span>);
        numbers.add(<span class="hljs-number">3</span>);

        System.out.println(<span class="hljs-string">"排序前: "</span> + numbers);
        Collections.sort(numbers);
        System.out.println(<span class="hljs-string">"排序后: "</span> + numbers);
    }
}
</code></pre>
<p>案例中使用了Collections的sort方法，使用对象的自然排序对list进行排序。</p>
<h3 data-id="heading-2">1.2自定义排序</h3>
<p>如果我们要对自定义对象（如Student）进行排序，sort方法还有一个接受Comparator(比较器)的版本，让我们可以随心所欲地定义排序规则。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.Comparator;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo2
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 15:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo2</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Student&gt; students = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        students.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"懒惰蜗牛"</span>, <span class="hljs-number">28</span>));
        students.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"lazysnail"</span>, <span class="hljs-number">29</span>));

        <span class="hljs-comment">// 匿名内部类写法</span>
        Collections.sort(students, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>&lt;Student&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Student o1, Student o2)</span> {
                <span class="hljs-keyword">return</span> o1.age - o2.age;
            }
        });

        <span class="hljs-comment">// Lambda表达式</span>
        Collections.sort(students, (o1, o2) -&gt; o1.age - o2.age);

        <span class="hljs-comment">// Comparator工具方法</span>
        Collections.sort(students, Comparator.comparingInt(o -&gt; o.age));
        
        System.out.println(<span class="hljs-string">"按年龄排序后: "</span> + students);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    String name;
    <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> { <span class="hljs-built_in">this</span>.name = name; <span class="hljs-built_in">this</span>.age = age; }
    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name + <span class="hljs-string">":"</span> + age; }
}
</code></pre>
<p>上面的案例中Comparator的创建使用了三种写法：</p>
<p>Java8之前传统写法，使用匿名内部类实现Comparator接口。</p>
<p>Java8+的Lambda表达式，这个其实是匿名内部类的语法糖。</p>
<p>Comparator接口是一个函数式接口（只有一个抽象方法），所以可以用Lambda替代。</p>
<p>Comparator.comparingInt()是Comparator提供的静态工厂方法，专门用来对int类型字段的比较。</p>
<p>内部封装了compare的逻辑。</p>
<p>其实自Java8之后，List接口自身提供了一个sort()方法。可以直接在列表对象上调用方法。</p>
<pre><code class="hljs language-ini" lang="ini">students.sort((o1, o2) -&gt; o1.age - o2.age)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a95e0811d10741b695bfa6fa169dc691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=lRn1q%2B3XPWrhas94uBHDGqP%2BfDA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>在<a href="https://juejin.cn/post/7582425536464863258" target="_blank" title="https://juejin.cn/post/7582425536464863258">Day28 | Java集合框架之Set接口详解</a>中的TreeSet讲解中讲到了自然排序和自定义排序，可以回顾下。</p>
</blockquote>
<h2 data-id="heading-3">二、查找</h2>
<p>对于一个已经排好序的List，binarySearch方法使用二分查找算法，效率要高于遍历。</p>
<blockquote>
<p>使用binarySearch之前，列表必须是有序的！否则，结果就不是你想要的。</p>
</blockquote>
<h3 data-id="heading-4">效率</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo3
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 15:52
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {
            list.add(i);
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-number">987654</span>;

        <span class="hljs-comment">// 遍历</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) {
            <span class="hljs-keyword">if</span> (list.get(i) == target) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">end1</span> <span class="hljs-operator">=</span> System.nanoTime();
        System.out.println(<span class="hljs-string">"遍历查找耗时: "</span> + (end1 - start1) / <span class="hljs-number">1_000_000.0</span> + <span class="hljs-string">" ms"</span>);

        <span class="hljs-comment">// binarySearch</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.nanoTime();
        Collections.binarySearch(list, target);
        <span class="hljs-type">long</span> <span class="hljs-variable">end2</span> <span class="hljs-operator">=</span> System.nanoTime();
        System.out.println(<span class="hljs-string">"binarySearch查找耗时: "</span> + (end2 - start2) / <span class="hljs-number">1_000_000.0</span> + <span class="hljs-string">" ms"</span>);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e549668a45483ab8366dccc91c1bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=5FVAEMFJ6HjSl4csM7TcgzHEuxg%3D" alt="" loading="lazy"/></p>
<p>从运行的结果看，二分查找的效率比普通遍历的效率高得多。</p>
<p>二分查找这种算法，每次都能排除掉一半的数据。相较于普通遍历的线性搜素。</p>
<p>在数据量很多的情况下，二分查找的时间复杂度要远远低于普通遍历。</p>
<h3 data-id="heading-5">未排序使用binarySearch</h3>
<p>如果对没有排序的列表进行二分查找，结果就是找不到数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo4
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 16:08
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo4</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">50</span>, <span class="hljs-number">20</span>, <span class="hljs-number">40</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);

        System.out.println(<span class="hljs-string">"列表内容: "</span> + list);

        <span class="hljs-comment">// 想查找元素 30</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> Collections.binarySearch(list, <span class="hljs-number">30</span>);

        System.out.println(<span class="hljs-string">"binarySearch 查找结果索引: "</span> + index);

    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deadb0ff1de141d7affa04ab5ff397d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=oNQtl087t9qV2GcLSe8pvqH%2BSEo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">三、线程安全转换</h2>
<p>我们经常用的ArrayList、HashMap等都是非线程安全的。</p>
<p>在多线程环境中并发修改，可能会导致数据错乱。</p>
<p>Collections提供了一系列synchronizedXXX() 方法，可以把它们包装成线程安全的集合。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3abc9a4b9db4efd8b3004e06ef7750a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=spG4chXEl49DrU9Ngua65y%2Fkq%2Fk%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo5
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 16:26
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo5</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        List&lt;String&gt; safeList = Collections.synchronizedList(list);

        safeList.add(<span class="hljs-string">"懒惰蜗牛"</span>);

        <span class="hljs-comment">//Set&lt;T&gt; safeSet = Collections.synchronizedSet(new HashSet&lt;&gt;());</span>
        <span class="hljs-comment">//Map&lt;K, V&gt; safeMap = Collections.synchronizedMap(new HashMap&lt;&gt;());</span>
    }
}
</code></pre>
<p>list是线程不安全的ArrayList，通过Collections中的synchronizedList方法。</p>
<p>将普通的ArrayList封装成了线程安全的List。之后对list的操作就是安全的。</p>
<p>set、map同样有对应的方法将不安全的集合封装成线程安全的集合。</p>
<blockquote>
<p>需要注意的是：这个操作只保证了单个方法（如add, get）是原子的。对于复合操作（比如“检查是否存在，如果不存在则添加”），仍然需要自己使用synchronized关键字来保证整个操作的原子性。</p>
</blockquote>
<h2 data-id="heading-7">四、创建不可变和空集合</h2>
<h3 data-id="heading-8">不可变</h3>
<p>有时候，我们想创建一个不可变的集合，这个集合不让修改。就可以用Collections中的unmodifiableXXX()方法创建只读的集合。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e76d38813494a7392f285ddff19fd96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=tm5qZWARW3Qmm9o355MMezdrU1s%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo6
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 16:56
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo6</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-string">"懒惰蜗牛"</span>);
        List&lt;String&gt; unmodifiableList = Collections.unmodifiableList(list);

        <span class="hljs-comment">//unmodifiableList.add("lazysnail");</span>
        unmodifiableList.remove(<span class="hljs-string">"懒惰蜗牛"</span>);
    }
}
</code></pre>
<p>如果想对这样的集合进行add或remove等操作，就会抛出UnsupportedOperationException异常。</p>
<p>从Java9开始，List, Set, Map接口自身提供了更方便的静态of()方法来直接创建真正的不可变集合。</p>
<p>这种方式在实际开发中更加常见。</p>
<p>为什么说是真正的不可变呐。回看上面的案例，稍作一下修改：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo6
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 16:56
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo6</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-string">"懒惰蜗牛"</span>);
        List&lt;String&gt; unmodifiableList = Collections.unmodifiableList(list);

        System.out.println(<span class="hljs-string">"原集合修改前的unmodifiableList:"</span> + unmodifiableList);

        list.add(<span class="hljs-string">"lazysnail"</span>);

        System.out.println(<span class="hljs-string">"原集合修改后的unmodifiableList:"</span> + unmodifiableList);
    }
}
</code></pre>
<p>可以看出，unmodifiableList并没有改变原集合的可变性，只是加了一层只读外壳。</p>
<p>如果原集合一旦被外部引用持有，仍然可以修改。</p>
<p>而List.of(...) 是真正的不可变对象，内部结构不允许任何修改操作。</p>
<p>所有变更操作（add、remove、set）都会直接抛UnsupportedOperationException。</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list1 = List.of(<span class="hljs-string">"懒惰蜗牛"</span>);
list1.add(<span class="hljs-string">"lazysnail"</span>);
</code></pre>
<p>"list1.add("lazysnail");"就会抛出UnsupportedOperationException。</p>
<h3 data-id="heading-9">空集合</h3>
<p>很多返回集合的方法，如果直接返回null，保不准什么时候就会报空指针异常。</p>
<p>实际开发的时候，最好还是返回一个空集合。</p>
<p>Collections的emptyList(), emptySet(), emptyMap()就派上了用场。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day30;

<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day30Demo7
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/7 17:14
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day30Demo7</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">findUsers</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-comment">// if 找到</span>

        <span class="hljs-comment">// else</span>
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }
}
</code></pre>
<p>可能你会说，为什么不直接return的时候直接new ArrayList&lt;&gt;()。</p>
<p>每次return的时候，都去new一个对象，还是有开销的，能省则省。</p>
<p>Collections的emptyList()返回的是一个不可变的、线程安全的、可被序列化的空集合。</p>
<p>每次返回的都是同一个静态实例。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c72d9ae779684a6c9fc2e2c248eed418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452317&amp;x-signature=KJt8053qJlwu8QUJKfy2tRkQF2w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">五、其他</h2>
<p>Collections中还有很多其他的小工具：</p>
<p>reverse(List&lt;?&gt; list): 反转List中元素的顺序。</p>
<p>shuffle(List&lt;?&gt; list): 随机打乱List中元素的顺序。</p>
<p>max(Collection coll) / min(Collection coll): 找到集合中的最大/最小元素。</p>
<p>fill(List&lt;?&gt; list, T obj): 用指定元素替换List中的所有元素。</p>
<p>更多的方法参见API文档：</p>
<p>Collections (Java SE 17 &amp; JDK 17)docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Collections.html</p>
<h2 data-id="heading-11">结语</h2>
<p>Collections中有非常多关于集合的操作工具。</p>
<p>今天我们只是一起看了一下排序、查找、线程安全、创建不可变集合等常见的功能。</p>
<p>这些工具都能够在实际开发中帮我们让代码更加简洁，让集合操作更加便捷高效。</p>
<p>Collections里的方法不需要取死记硬背，在写代码的时候，如果涉及操作集合，</p>
<p>可以翻看一下API文档，如果有合适的工具，使用即可。</p>
<p>下一篇预告</p>
<blockquote>
<p>Day31 | Lambda表达式与函数式接口</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack vs Vite 根本设计原理深度解析：为什么两者差异这么大？]]></title>    <link>https://juejin.cn/post/7583910418659541038</link>    <guid>https://juejin.cn/post/7583910418659541038</guid>    <pubDate>2025-12-16T00:40:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910418659541038" data-draft-id="7579215538271174666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack vs Vite 根本设计原理深度解析：为什么两者差异这么大？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T00:40:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ycgg"/> <meta itemprop="url" content="https://juejin.cn/user/1926000101039192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack vs Vite 根本设计原理深度解析：为什么两者差异这么大？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000101039192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ycgg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:40:29.000Z" title="Tue Dec 16 2025 00:40:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Webpack vs Vite 根本设计原理深度解析：为什么两者差异这么大？</h2>
<p>之前的对比更多聚焦于“表面差异”，但两者的核心区别源于 <strong>底层设计哲学和技术选型的根本不同</strong>——简单说：</p>
<ul>
<li>Webpack 的设计核心是「<strong>全场景兼容的提前打包哲学</strong>」：无论环境、无论模块类型，都通过“提前解析所有依赖、打包为 bundle”实现统一处理；</li>
<li>Vite 的设计核心是「<strong>现代浏览器优先的即时构建哲学</strong>」：利用现代浏览器原生能力（ES 模块），拆分“开发时”和“生产时”流程，按需处理模块，放弃对老场景的过度兼容。</li>
</ul>
<p>本文将从「设计初衷、核心原理、底层实现」三个维度，扒透两者的根本差异，让你明白“为什么 Vite 更快”“为什么 Webpack 更全能”不是偶然，而是设计之初就定好的方向。</p>
<h3 data-id="heading-1">一、先统一认知：什么是“构建工具的根本原理”？</h3>
<p>构建工具的核心使命是：<strong>将分散的源码模块（JS/TS/CSS/图片等），通过“依赖解析、转译、优化、合并”，最终生成浏览器/Node.js 可执行的产物</strong>。</p>
<p>而“根本设计原理”，就是解决以下 3 个核心问题的“决策逻辑”：</p>
<ol>
<li><strong>何时处理模块？</strong>（提前一次性处理 vs 按需实时处理）</li>
<li><strong>如何解析依赖？</strong>（递归构建依赖图 vs 依赖浏览器原生解析）</li>
<li><strong>如何扩展功能？</strong>（分层架构 vs 单一插件体系）</li>
</ol>
<p>Webpack 和 Vite 的所有差异，都源于对这 3 个问题的不同回答。</p>
<h3 data-id="heading-2">二、Webpack 根本设计原理：全场景兼容的“提前打包”哲学</h3>
<h4 data-id="heading-3">1. 设计初衷：解决“前端模块混乱”的历史痛点</h4>
<p>Webpack 诞生于 2012 年，当时前端还没有统一的模块标准（CommonJS/AMD/UMD 并存），依赖管理混乱，没有工具能将各种类型的文件（JS、CSS、图片）统一处理为浏览器可识别的资源。</p>
<p>Webpack 的核心设计目标是：<strong>提供一个“万能打包器”，兼容所有模块类型、所有模块标准、所有运行环境，让开发者无需关心底层兼容，专注业务代码</strong>。</p>
<h4 data-id="heading-4">2. 核心原理：“依赖图 + 全量打包 + 分层扩展”</h4>
<p>Webpack 的根本逻辑是「<strong>提前把所有事做完</strong>」，无论开发还是生产，都遵循“全量处理”流程，核心分为 3 层：</p>
<h5 data-id="heading-5">（1）第一层：“一切皆模块” + 递归构建依赖图</h5>
<p>Webpack 认为“所有文件都是模块”（JS、CSS、图片、字体等），核心步骤：</p>
<ol>
<li>从入口文件（如 <code>src/index.js</code>）开始，通过 <strong>AST 语法解析</strong>（抽象语法树），找出所有 <code>import</code>/<code>require</code> 依赖；</li>
<li>递归解析每个依赖的依赖，直到所有模块都被找到，最终构建出一个「完整的依赖关系图」（Dependency Graph）；</li>
<li>所有模块都被纳入这个图中，后续的转译、优化、合并都基于这个图进行。</li>
</ol>
<p><strong>底层技术支撑</strong>：使用 <code>acorn</code> 库解析 JS 生成 AST，遍历 AST 找到依赖声明，实现递归解析。</p>
<h5 data-id="heading-6">（2）第二层：“全量打包”流程（开发/生产一致）</h5>
<p>无论开发还是生产，Webpack 都会完整执行以下流程，没有“按需处理”：</p>
<pre><code class="hljs">初始化（读取配置）→ 编译（构建依赖图+Loader 转译）→ 优化（Chunk 合并+Tree-shaking）→ 输出（写入磁盘）
</code></pre>
<ul>
<li><strong>开发时没有“特殊待遇”</strong>：即使是开发环境，也需要先构建完依赖图、转译所有模块，才能启动开发服务器（这就是 Webpack 冷启动慢的根本原因）；</li>
<li><strong>热更新（HMR）的本质</strong>：修改文件后，Webpack 会重新解析该模块及其依赖链，更新依赖图，重新转译并替换对应的 Chunk，而非仅处理修改的文件。</li>
</ul>
<h5 data-id="heading-7">（3）第三层：“Loader + Plugin”分层扩展架构</h5>
<p>为了实现“全场景兼容”，Webpack 设计了分层扩展机制，避免核心逻辑臃肿：</p>
<ul>
<li><strong>Loader 层</strong>：负责“模块转译”（解决“不同类型模块如何转为 JS 模块”）；
<ul>
<li>核心逻辑：非 JS 模块无法直接进入依赖图，必须通过 Loader 转译为 JS 模块（如 CSS→JS 字符串、图片→Base64/路径）；</li>
<li>设计思路：单一职责，每个 Loader 只做一件事（如 <code>css-loader</code> 解析 CSS 依赖，<code>style-loader</code> 注入样式），通过链式调用组合功能。</li>
</ul>
</li>
<li><strong>Plugin 层</strong>：负责“流程扩展”（解决“打包流程中需要额外做什么”）；
<ul>
<li>核心逻辑：基于 <strong>Tapable 钩子系统</strong>（Webpack 核心事件总线），在打包的每个阶段（如“编译开始”“产物输出前”）触发自定义逻辑；</li>
<li>设计思路：无侵入式扩展，核心代码只负责流程控制，插件负责添加功能（如生成 HTML、压缩代码、清理产物）。</li>
</ul>
</li>
</ul>
<p><strong>底层技术支撑</strong>：Tapable 库（Webpack 团队开发），提供同步/异步钩子，让 Plugin 能介入打包全流程。</p>
<h5 data-id="heading-8">核心代码片段（体现 Webpack 原理）</h5>
<p>Webpack 核心实例 <code>Compiler</code> 的初始化逻辑（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Webpack 核心：Compiler 实例（全局唯一）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options; <span class="hljs-comment">// 读取配置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tapable</span>(); <span class="hljs-comment">// 初始化钩子系统</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = []; <span class="hljs-comment">// 存储所有模块</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = []; <span class="hljs-comment">// 存储所有 Chunk</span>
  }

  <span class="hljs-comment">// 启动打包流程</span>
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 触发 "compile" 钩子（Plugin 可监听）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">compile</span>.<span class="hljs-title function_">call</span>();

    <span class="hljs-comment">// 2. 从入口文件开始，构建依赖图</span>
    <span class="hljs-keyword">const</span> entryModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildModule</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">entry</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">push</span>(entryModule);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildDependencyGraph</span>(entryModule);

    <span class="hljs-comment">// 3. 触发 "make" 钩子（Plugin 可干预模块）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">make</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compilation</span>);

    <span class="hljs-comment">// 4. 合并模块为 Chunk</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createChunks</span>();

    <span class="hljs-comment">// 5. 触发 "emit" 钩子（Plugin 可修改产物）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compilation</span>);

    <span class="hljs-comment">// 6. 输出产物到磁盘</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">outputFiles</span>();

    <span class="hljs-comment">// 7. 触发 "done" 钩子（Plugin 可做后续处理）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">call</span>();
  }

  <span class="hljs-comment">// 构建单个模块（调用 Loader 转译）</span>
  <span class="hljs-title function_">buildModule</span>(<span class="hljs-params">modulePath</span>) {
    <span class="hljs-comment">// 读取文件内容</span>
    <span class="hljs-keyword">const</span> source = fs.<span class="hljs-title function_">readFileSync</span>(modulePath, <span class="hljs-string">'utf-8'</span>);
    <span class="hljs-comment">// 匹配对应的 Loader 链</span>
    <span class="hljs-keyword">const</span> loaders = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLoadersForFile</span>(modulePath);
    <span class="hljs-comment">// 链式执行 Loader 转译</span>
    <span class="hljs-keyword">const</span> transformedSource = loaders.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">code, loader</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> loader.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, code);
    }, source);
    <span class="hljs-comment">// 解析转译后的代码，找出依赖</span>
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseDependencies</span>(transformedSource);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: modulePath, <span class="hljs-attr">source</span>: transformedSource, dependencies };
  }
}
</code></pre>
<h4 data-id="heading-9">3. 原理带来的优缺点</h4>
<ul>
<li><strong>优点</strong>：兼容所有场景（老浏览器、各种模块标准、特殊资源）、扩展能力极强（Loader/Plugin 生态庞大）；</li>
<li><strong>缺点</strong>：全量打包导致开发时冷启动慢、热更新延迟；配置复杂（需区分 Loader/Plugin）。</li>
</ul>
<h3 data-id="heading-10">三、Vite 根本设计原理：现代浏览器优先的“即时构建”哲学</h3>
<h4 data-id="heading-11">1. 设计初衷：解决 Webpack 的“开发体验痛点”</h4>
<p>Vite 诞生于 2021 年，此时现代浏览器已普遍支持 ES 模块（ESM，<code>import</code>/<code>export</code> 原生可用），而 Webpack 的“全量打包”在大型项目中暴露的“冷启动慢、热更新卡”问题愈发严重。</p>
<p>Vite 的核心设计目标是：<strong>利用现代浏览器原生能力，抛弃“提前打包”的冗余步骤，优化开发体验；生产时复用成熟的 Rollup 打包能力，平衡产物质量</strong>。</p>
<p>简单说：Vite 认为“开发时不需要打包”，只需要“按需转译模块”；“生产时需要打包”，但交给更高效的 Rollup 来做。</p>
<h4 data-id="heading-12">2. 核心原理：“ESM 原生支持 + 双场景分离 + 高效转译”</h4>
<p>Vite 的根本逻辑是「<strong>开发时按需处理，生产时优化打包</strong>」，核心分为 3 层：</p>
<h5 data-id="heading-13">（1）第一层：开发时：依赖浏览器 ESM 原生解析，不打包</h5>
<p>Vite 开发时完全抛弃“构建依赖图”和“全量打包”，核心依赖「浏览器原生支持 ESM」：</p>
<ol>
<li>启动一个 <strong>ESM 开发服务器</strong>（基于 <code>connect</code> 库），不处理任何模块，仅监听文件变化；</li>
<li>浏览器请求入口 <code>index.html</code> 时，Vite 动态改写 HTML 中的模块引用（如把 <code>import './main.ts'</code> 改为 <code>import '/src/main.ts'</code>，指向服务器路径）；</li>
<li>浏览器收到 HTML 后，按 ESM 规范原生加载 <code>main.ts</code>，并解析其中的 <code>import</code> 依赖，再次向服务器请求这些依赖模块；</li>
<li>服务器收到模块请求后，<strong>即时转译</strong>该模块（如 TS→JS、Vue→JS），返回转译后的 ESM 代码；</li>
<li>重复步骤 3-4，直到所有依赖模块都被浏览器加载完成。</li>
</ol>
<p><strong>核心亮点</strong>：模块处理是“请求驱动”的——只有浏览器请求的模块才会被转译，未被引用的模块（如路由懒加载的组件）不会被处理，这是 Vite 冷启动快的根本原因。</p>
<h5 data-id="heading-14">（2）第二层：生产时：复用 Rollup 打包，平衡产物质量</h5>
<p>开发时的“按需处理”不适合生产环境（浏览器请求次数过多、无优化），因此 Vite 生产时切换为「Rollup 打包」：</p>
<ol>
<li>按 Rollup 的逻辑，递归构建依赖图（全量处理所有模块）；</li>
<li>复用开发时的插件逻辑（如 <code>transform</code> 转译模块）；</li>
<li>利用 Rollup 更高效的 Tree-shaking、Chunk 拆分、产物压缩能力，生成优化后的静态资源。</li>
</ol>
<p><strong>设计思路</strong>：开发时优先“速度”，生产时优先“产物质量”，两者分离但共享插件生态，避免重复开发。</p>
<h5 data-id="heading-15">（3）第三层：“单一插件体系 + ESBuild 转译”</h5>
<p>Vite 抛弃了 Webpack 的“Loader + Plugin”分层，用「单一插件体系」覆盖所有扩展需求，同时用 ESBuild 替代 Babel/TSC 提升转译速度：</p>
<ul>
<li><strong>插件体系</strong>：插件通过「钩子函数」介入流程，既可以处理模块转译（对应 Webpack Loader），也可以扩展流程（对应 Webpack Plugin）；
<ul>
<li>核心钩子：<code>resolveId</code>（解析模块路径）、<code>transform</code>（转译模块内容）、<code>configureServer</code>（配置开发服务器）、<code>writeBundle</code>（生产时处理产物）；</li>
</ul>
</li>
<li><strong>ESBuild 转译</strong>：ESBuild 是用 Go 语言编写的转译工具，比 JS 编写的 Babel/TSC 快 10-100 倍，负责开发时的 TS/JSX/CSS 转译（生产时可切换为 Babel 兼容更多场景）。</li>
</ul>
<p><strong>底层技术支撑</strong>：</p>
<ul>
<li>开发服务器：基于 <code>connect</code> 库，拦截浏览器请求，即时处理模块；</li>
<li>转译核心：ESBuild（负责快速转译）；</li>
<li>打包核心：Rollup（负责生产时优化）。</li>
</ul>
<h5 data-id="heading-16">核心代码片段（体现 Vite 原理）</h5>
<p>Vite 开发服务器的核心逻辑（简化版）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> esbuild <span class="hljs-keyword">from</span> <span class="hljs-string">'esbuild'</span>;

<span class="hljs-comment">// 1. 创建 ESM 开发服务器</span>
<span class="hljs-keyword">const</span> server = <span class="hljs-title function_">createServer</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-comment">/* 插件列表 */</span>]
});

<span class="hljs-comment">// 2. 监听模块请求（如 /src/main.ts）</span>
server.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (req, res, next) =&gt; {
  <span class="hljs-keyword">const</span> modulePath = <span class="hljs-title function_">resolve</span>(req.<span class="hljs-property">url</span>); <span class="hljs-comment">// 解析模块路径</span>

  <span class="hljs-comment">// 3. 插件的 resolveId 钩子：重写模块路径（如别名、第三方模块）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> server.<span class="hljs-property">config</span>.<span class="hljs-property">plugins</span>) {
    <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">resolveId</span>) {
      <span class="hljs-keyword">const</span> resolvedId = <span class="hljs-keyword">await</span> plugin.<span class="hljs-title function_">resolveId</span>(modulePath);
      <span class="hljs-keyword">if</span> (resolvedId) modulePath = resolvedId;
    }
  }

  <span class="hljs-comment">// 4. 读取模块文件内容</span>
  <span class="hljs-keyword">let</span> code = fs.<span class="hljs-title function_">readFileSync</span>(modulePath, <span class="hljs-string">'utf-8'</span>);

  <span class="hljs-comment">// 5. 插件的 transform 钩子：转译模块（如 TS→JS、Vue→JS）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> server.<span class="hljs-property">config</span>.<span class="hljs-property">plugins</span>) {
    <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">transform</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> plugin.<span class="hljs-title function_">transform</span>(code, modulePath);
      <span class="hljs-keyword">if</span> (result) code = result.<span class="hljs-property">code</span>;
    }
  }

  <span class="hljs-comment">// 6. 用 ESBuild 快速转译（如 TS→JS）</span>
  <span class="hljs-keyword">if</span> (modulePath.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>) || modulePath.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.tsx'</span>)) {
    <span class="hljs-keyword">const</span> esbuildResult = <span class="hljs-keyword">await</span> esbuild.<span class="hljs-title function_">transform</span>(code, {
      <span class="hljs-attr">loader</span>: <span class="hljs-string">'tsx'</span>,
      <span class="hljs-attr">target</span>: <span class="hljs-string">'esnext'</span>
    });
    code = esbuildResult.<span class="hljs-property">code</span>;
  }

  <span class="hljs-comment">// 7. 设置响应头（告诉浏览器这是 ESM 模块）</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/javascript'</span>);
  res.<span class="hljs-title function_">end</span>(code); <span class="hljs-comment">// 返回转译后的 ESM 代码</span>
});

<span class="hljs-comment">// 8. 启动服务器</span>
server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<h4 data-id="heading-17">3. 原理带来的优缺点</h4>
<ul>
<li><strong>优点</strong>：开发时冷启动快、热更新即时（请求驱动+ESBuild）；配置简洁（单一插件体系）；生产产物质量高（Rollup 优化）；</li>
<li><strong>缺点</strong>：开发时依赖现代浏览器 ESM 支持（不兼容 IE11）；对 CommonJS 模块的处理需要额外转译（性能损耗）；复杂场景（如多入口、特殊资源处理）生态不如 Webpack 成熟。</li>
</ul>
<h3 data-id="heading-18">四、Webpack vs Vite 根本原理对比表（核心总结）</h3>


















































<table><thead><tr><th>对比维度</th><th>Webpack</th><th>Vite</th></tr></thead><tbody><tr><td>核心设计哲学</td><td>全场景兼容，提前打包所有模块</td><td>现代浏览器优先，开发时按需处理，生产时优化打包</td></tr><tr><td>模块解析方式</td><td>递归构建依赖图（AST 解析）</td><td>开发时浏览器原生 ESM 解析，生产时 Rollup 依赖图</td></tr><tr><td>模块处理时机</td><td>开发/生产均提前全量处理</td><td>开发时请求驱动（按需处理），生产时全量处理</td></tr><tr><td>转译核心工具</td><td>Babel/TSC（JS 编写，速度慢）</td><td>ESBuild（Go 编写，速度快）+ 可选 Babel</td></tr><tr><td>扩展架构</td><td>分层架构（Loader 转译 + Plugin 流程扩展）</td><td>单一插件体系（钩子覆盖转译+流程扩展）</td></tr><tr><td>底层技术支撑</td><td>Tapable 钩子 + acorn AST 解析</td><td>ESM 服务器（connect）+ ESBuild + Rollup</td></tr><tr><td>设计目标</td><td>解决“模块混乱”，追求全能兼容</td><td>解决“开发体验差”，追求速度和简洁</td></tr><tr><td>原理层面的核心缺点</td><td>全量打包导致开发时速度慢</td><td>依赖现代浏览器，兼容场景有限</td></tr></tbody></table>
<h3 data-id="heading-19">五、最终结论：原理决定一切差异</h3>
<p>Webpack 和 Vite 的所有表面差异（速度、配置复杂度、生态），都源于「根本设计原理」的不同：</p>
<ul>
<li>Webpack 为了“全能兼容”，选择了“提前打包+分层扩展”，牺牲了开发速度和配置简洁性；</li>
<li>Vite 为了“现代浏览器下的开发体验”，选择了“ESM 原生支持+按需处理+双场景分离”，牺牲了部分兼容性和复杂场景的生态成熟度。</li>
</ul>
<p>选型的本质，就是在“兼容需求”和“开发体验”之间做权衡：</p>
<ul>
<li>若需要兼容老浏览器、处理复杂场景（多入口、特殊资源），选 Webpack（原理决定了它的全能性）；</li>
<li>若目标是现代浏览器、追求开发效率，选 Vite（原理决定了它的速度和简洁性）。</li>
</ul>
<p>理解了这一点，你就不会再纠结“为什么 Vite 不能替代 Webpack”或“为什么 Webpack 不借鉴 Vite 的速度”——它们的设计原理从一开始就决定了各自的定位和边界。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现倒计时工具]]></title>    <link>https://juejin.cn/post/7583948178858131502</link>    <guid>https://juejin.cn/post/7583948178858131502</guid>    <pubDate>2025-12-16T01:25:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583948178858131502" data-draft-id="7583948178858115118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现倒计时工具"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T01:25:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MQliferecord"/> <meta itemprop="url" content="https://juejin.cn/user/1139543665814600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现倒计时工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1139543665814600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MQliferecord
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:25:03.000Z" title="Tue Dec 16 2025 01:25:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最开始查到这个是因为在做版本更新弹窗的定时器轮询，然后查看到一篇文章关于前端倒计时存在误差，从而衍生出高并发秒杀场景下，应该如何实现倒计时工具：</p>
<p>最开始想到的办法是setTimeout。</p>
<p>但因为setTimeout本身因为JavaScript是单线程，<code>setTimeout</code> 的回调函数会被放入事件队列，浏览器资源分配中前面任务阻塞延迟的问题会存在一定性的误差，但是误差较小，大部分场景都可以忽略。</p>
<p>但是如果切换Tab页或者最小化之后再切换到前台，因为浏览器会识别当前页面需要资源减少，降低定时器的执行频率，直到切回来后才会恢复原本的轮询间隔，所以这样切回来的那一次计算时间会有误差。</p>
<p>对此因为项目会在第一次挂载的时候立刻弹窗以及切换到后台再切回前台的时候再次立刻弹窗，所以只需要在切换回来的时候立刻执行一次versionListener，<strong>并删除定时器，重新创建一个新的定时器就能恢复原本的时限误差</strong></p>
<p>如果没有以上的策略，坚持原本的定时器，并且不希望出现误差的话，可以使用web worker单独处理定时器。</p>
<p>Web Worker 是独立于主线程的后台线程，<strong>不受前台 / 后台标签的节流规则限制</strong>，其事件循环和定时器执行逻辑完全独立，因此切后台后仍能保持接近预期的执行频率</p>
<p><a href="https://juejin.cn/post/7478687361737768986" target="_blank" title="https://juejin.cn/post/7478687361737768986">面试官：前端倒计时有误差怎么解决前言 去年遇到的一个问题，也是非常经典的面试题了。能聊的东西还蛮多的 倒计时为啥不准 一 - 掘金 (juejin.cn)</a></p>
<p>看了一下这个里面的一个评论：</p>
<blockquote>
<p>setTimeout 的延时不应当被依赖用来进行倒计时，因为它有非常多的不稳定因素（参见MDN）。<br/>
最佳实践是将倒计时结束的时间戳计算出来，再用 setTimeout 或者 requestAnimationFrame 进行更新（计算结束和当前时间戳的时间差，舍入到秒数然后更新到页面上），这种方式误差最小且最节能。至于需要和服务器实时同步的场景则考虑sse授时。</p>
</blockquote>
<p>具体为：</p>
<ol>
<li><strong>定时器的本质</strong>：<code>setTimeout</code> 的 <code>delay</code> 是「事件循环中任务的最小等待时间」，如果队列中有其他任务，实际执行时间会更长；</li>
<li><strong>requestAnimationFrame 优势</strong>：浏览器会在重绘前执行回调，前台 60fps（约 16ms / 次），后台自动暂停，比 <code>setInterval</code> 节能 90%+；</li>
<li><strong>时间戳选择</strong>：<code>performance.now()</code> 是高精度时间戳（微秒级），且不受系统时间修改影响，优先于 <code>Date.now()</code>。</li>
</ol>
<p>由此衍生两种核心方法:</p>
<ol>
<li>计算出倒计时结束时间，轮询是否到达结尾时间，进行报时，<strong>performanceAPI在Node环境下无法使用,只支持浏览器环境</strong></li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">preciseCountdown</span>(<span class="hljs-params">endTime:number, onUpdate:(seconds:number)=&gt;<span class="hljs-keyword">void</span>, onComplete:()=&gt;<span class="hljs-keyword">void</span></span>) {
  <span class="hljs-comment">// 高精度时间戳（优先用 performance.now，无兼容问题时用 Date.now）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getNow</span> = (<span class="hljs-params"/>) =&gt; performance.<span class="hljs-title function_">now</span>() + performance.<span class="hljs-property">timeOrigin</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title function_">getNow</span>();
    <span class="hljs-keyword">const</span> remaining = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(endTime - now, <span class="hljs-number">0</span>); <span class="hljs-comment">// 剩余时间（ms）</span>
    <span class="hljs-keyword">const</span> remainingSeconds = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(remaining / <span class="hljs-number">1000</span>); <span class="hljs-comment">// 舍入到秒</span>

    <span class="hljs-comment">// 更新页面（只传最终要显示的秒数，避免浮点误差），在高频报数场景下每秒报数发生变化由此实现倒计时</span>
    <span class="hljs-comment">//实际上是10-&gt;10-&gt;...(省略n个10)-&gt;10 -&gt;9-&gt;9-&gt;...-&gt;9-&gt;8....</span>
    <span class="hljs-title function_">onUpdate</span>(remainingSeconds);

    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">onComplete</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 优先用 requestAnimationFrame（更节能，适配屏幕刷新率）</span>
    <span class="hljs-comment">// 降级用 setTimeout（兼容老环境，延时设为 16ms 接近 60fps）</span>
    <span class="hljs-keyword">if</span> (requestAnimationFrame) {
      <span class="hljs-comment">//进行高频报数展示</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(update);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">setTimeout</span>(update, <span class="hljs-number">16</span>);
    }
  };

  <span class="hljs-comment">// 立即执行一次更新，避免首屏延迟</span>
  <span class="hljs-title function_">update</span>();
}

<span class="hljs-comment">// 用法示例：倒计时 10 秒</span>
<span class="hljs-keyword">const</span> endTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>;
<span class="hljs-title function_">preciseCountdown</span>(
  endTime,
  <span class="hljs-function">(<span class="hljs-params">seconds</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'剩余秒数：'</span>, seconds);
    <span class="hljs-comment">// 更新 DOM：document.getElementById('countdown').textContent = seconds;</span>
  },
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'倒计时结束'</span>);
  }
);
</code></pre>
<ol start="2">
<li>使用后端sse进行处理，相比于普通的接口请求，sse具备高度的实时性</li>
</ol>








































<table><thead><tr><th>对比维度</th><th>普通后端接口（HTTP/REST）</th><th>SSE（Server-Sent Events）</th></tr></thead><tbody><tr><td><strong>通信方向</strong></td><td>双向（客户端请求 → 服务端响应），但「请求 - 响应」是<strong>单次单向</strong></td><td>单向（服务端 → 客户端），服务端主动推送</td></tr><tr><td><strong>连接模式</strong></td><td>短连接：请求发起 → 响应返回 → TCP 连接关闭</td><td>长连接：一次 TCP 握手后，连接持续保持，服务端按需推数据</td></tr><tr><td><strong>触发方式</strong></td><td>客户端主动触发（点击、定时轮询、页面加载）</td><td>服务端主动触发（数据更新 / 事件发生时推送）</td></tr><tr><td><strong>数据传输形式</strong></td><td>单次完整数据（JSON/Form/ 二进制），响应结束即终止</td><td>流式文本数据（UTF-8），分块传输（一行 / 多行数据）</td></tr><tr><td><strong>实时性</strong></td><td>低（轮询依赖间隔，有延迟）</td><td>高（数据更新立即推送，无轮询延迟）</td></tr><tr><td><strong>网络开销</strong></td><td>高（轮询场景下多次 TCP 握手、重复请求头）</td><td>低（一次连接持续传输，仅首次握手开销）</td></tr></tbody></table>
<pre><code class="hljs language-ini" lang="ini">// SSE：客户端建立连接，监听服务端推送
const <span class="hljs-attr">sse</span> = new EventSource(<span class="hljs-string">'/api/sse/countdown'</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">sse.onmessage</span> = (e) =&gt; {
  const <span class="hljs-attr">data</span> = JSON.parse(e.data)<span class="hljs-comment">;</span>
  console.log('服务端推送的实时数据：', data)<span class="hljs-comment">; // 服务端有更新就会触发</span>
}<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>普通接口</strong>：默认是「短连接」——TCP 三次握手后传输数据，响应完成后四次挥手关闭连接；若要实时性，需用「定时轮询」（如每 1 秒请求一次），但会产生大量重复的 TCP 握手 / 挥手开销，且有轮询间隔的延迟。</li>
<li><strong>SSE</strong>：是「HTTP 长连接」—— 一次 TCP 握手后，连接保持打开状态，服务端通过「分块传输编码（Chunked Transfer Encoding）」向客户端流式推送数据，直到连接被主动关闭（客户端 <code>close()</code> 或服务端断开）。优势：无轮询的重复开销，实时性接近 “即时”</li>
<li><strong>WebSocket</strong> 是双向通信（客户端↔服务端）、基于独立的 WebSocket 协议、功能更强但复杂度更高；常用于双向实时交互（如聊天、在线游戏）场景。</li>
</ul>
<p><strong>目前的电商秒杀倒计时用的主流方案应该是performance计算最终时间-起始时间</strong>，而不是sse，因为sse在电商这类高并发场景下需要大量的后端开销去建立链接窗口。</p>
<p>在进行秒杀时间校准的场景下，如何防止用户手动修改本地时间，主要依赖三个参数：</p>
<ol>
<li>后端在秒杀开始前会传给前端接口秒杀开始的准确时间戳，比如xxxxxxxxxx</li>
<li>前端通过performance.timeOrigin获取绝对起始时间，这个时间一旦定下为YYYYYYY，无论中途用户修改多少次本地时间都不会发生变化</li>
<li>前端在建立performance.timeOrigin的时候会绑定建立performance.now()，为绝对流逝时间，也就是相对performance.timeOrigin绝对起始时间变化的时间，不受本地时间影响</li>
</ol>
<p>最终xxxxxxxxxx-(performance.timeOrigin+performance.now())就是需要倒计时的时间</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NuxtHub部署nuxt项目就是方便]]></title>    <link>https://juejin.cn/post/7583952017674076211</link>    <guid>https://juejin.cn/post/7583952017674076211</guid>    <pubDate>2025-12-16T01:34:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583952017674076211" data-draft-id="7583912637471440947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NuxtHub部署nuxt项目就是方便"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T01:34:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pub的知识花园"/> <meta itemprop="url" content="https://juejin.cn/user/1591748567524232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NuxtHub部署nuxt项目就是方便
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748567524232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pub的知识花园
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:34:33.000Z" title="Tue Dec 16 2025 01:34:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好~我是Pub</p>
<p>最近一直在开发面向海外的应用，基本都是用Nuxt进行全栈开发的。从开发到部署都用了 Nuxthub，我自己用起来觉得非常方便。（我发现掘金好像还没有nuxthub的文章 ）</p>
<p>前几天Nuxthub也更新到了0.10版本。</p>
<p>如果你是 Nuxt 开发者，在开发面向海外的应用，想开发全栈应用（带数据库、文件上传等），但又不想折腾复杂的后端部署、Docker 或云服务配置，<strong>NuxtHub</strong> 就是为你准备的。</p>
<h2 data-id="heading-0">1. NuxtHub 是什么？</h2>
<p><strong>NuxtHub</strong> 是一个 <strong>Nuxt 模块</strong>（<code>@nuxthub/core</code>），也是一个部署和管理平台。</p>
<p>它的核心理念是 <strong>"Zero Configuration"（零配置）</strong>。它将<strong>数据库 (SQL)</strong>、<strong>文件存储 (Blob)</strong>、<strong>键值存储 (KV)</strong> 和 <strong>服务端缓存</strong> 等后端能力，直接集成到了 Nuxt 的运行时中。</p>
<p>简单来说，它让你在写 Nuxt 代码时，可以直接 <code>import</code> 一个数据库对象并开始查询，而无需关心底层的连接、认证或服务器维护。它底层主要利用了 <strong>Cloudflare</strong> 的边缘计算能力（Workers, D1, R2, KV），让你的应用不仅全栈，而且运行在全球边缘节点上。</p>
<h2 data-id="heading-1">2. 有什么方便的？</h2>
<p>NuxtHub 最大的卖点就是 <strong>开发者体验 (DX)</strong> 的极致简化：</p>
<ul>
<li><strong>开箱即用</strong>：不需要安装 MySQL/PostgreSQL 软件，不需要配置 S3 存储桶。在本地开发时，NuxtHub 会自动在本地模拟这些服务（使用 SQLite 等技术），数据保存在项目根目录的 <code>.data</code> 文件夹中。</li>
<li><strong>像写前端一样写后端</strong>：你不需要学习复杂的后端框架。通过简单的导入语法即可操作数据库。</li>
<li><strong>零配置部署</strong>：使用 <code>npx nuxthub deploy</code> 命令，系统会自动识别你的配置，在 Cloudflare 上为你创建对应的数据库、存储桶和 KV 空间，并发布应用。</li>
<li><strong>可视化管理</strong>：直接在 <strong>Nuxt DevTools</strong>（开发工具栏）里就能看到数据库里的表、查看上传的文件、管理缓存，非常直观。</li>
</ul>
<h2 data-id="heading-2">3. 有什么好处？</h2>
<ol>
<li><strong>全栈一体化</strong>：
前端和后端逻辑在同一个项目中，共享类型（TypeScript），维护成本极低。</li>
<li><strong>高性能 (Edge Computing)</strong>：
你的应用不是运行在某个单一地区的服务器上，而是运行在 Cloudflare 的全球边缘网络上，用户访问速度极快。</li>
<li><strong>功能丰富</strong>：
<ul>
<li><strong>NuxtHub Database (SQL)</strong>: 基于 SQLite (Cloudflare D1)，支持 Drizzle ORM，自动处理数据库迁移。</li>
<li><strong>NuxtHub Blob</strong>: 轻松上传和存储图片、视频 (Cloudflare R2)。</li>
<li><strong>NuxtHub KV</strong>: 高速键值对存储，适合存配置、Session 等。</li>
<li><strong>NuxtHub Cache</strong>: 强大的服务端/API 缓存能力。</li>
</ul>
</li>
<li><strong>无厂商锁定风险</strong>：
虽然它目前深度集成 Cloudflare，但它是作为一个开源模块设计的，未来有潜力适配更多平台。而且本地开发完全离线可用。</li>
</ol>
<h2 data-id="heading-3">4. 怎么用？</h2>
<h3 data-id="heading-4">第一步：创建项目（最快上手）</h3>
<p>直接使用官方模板初始化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化一个 NuxtHub 项目</span>
npx nuxi init -t hub my-hub-app
<span class="hljs-built_in">cd</span> my-hub-app
npm install
npm run dev
</code></pre>
<h3 data-id="heading-5">第二步：在现有项目中使用</h3>
<p>安装核心模块：</p>
<pre><code class="hljs language-bash" lang="bash">npx nuxi module add @nuxthub/core
</code></pre>
<p>修改 <code>nuxt.config.ts</code> 开启你需要的功能：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">'@nuxthub/core'</span>],
  <span class="hljs-attr">hub</span>: {
    <span class="hljs-attr">db</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 开启 SQL 数据库</span>
    <span class="hljs-attr">blob</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启文件存储</span>
    <span class="hljs-attr">kv</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 开启键值对存储</span>
    <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启缓存</span>
  }
})
</code></pre>
<h3 data-id="heading-6">第三步：写代码（示例）</h3>
<p><strong>1. 数据库操作 (server/api/todos.ts)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { db } <span class="hljs-keyword">from</span> <span class="hljs-string">'hub:db'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">eventHandler</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 直接查询数据库，拥有完整的类型提示</span>
  <span class="hljs-keyword">const</span> todos = <span class="hljs-keyword">await</span> db.<span class="hljs-property">query</span>.<span class="hljs-property">todos</span>.<span class="hljs-title function_">findMany</span>()
  <span class="hljs-keyword">return</span> todos
})
</code></pre>
<p><strong>2. 键值对存储 (KV)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { kv } <span class="hljs-keyword">from</span> <span class="hljs-string">'hub:kv'</span>

<span class="hljs-comment">// 存储数据</span>
<span class="hljs-keyword">await</span> kv.<span class="hljs-title function_">set</span>(<span class="hljs-string">'user:1:settings'</span>, { <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span> })
<span class="hljs-comment">// 获取数据</span>
<span class="hljs-keyword">const</span> settings = <span class="hljs-keyword">await</span> kv.<span class="hljs-title function_">get</span>(<span class="hljs-string">'user:1:settings'</span>)
</code></pre>
<p><strong>3. 文件上传 (Blob)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { blob } <span class="hljs-keyword">from</span> <span class="hljs-string">'hub:blob'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">eventHandler</span>(<span class="hljs-keyword">async</span> (event) =&gt; {
  <span class="hljs-comment">// 获取上传的文件</span>
  <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFormData</span>(event)
  <span class="hljs-keyword">const</span> file = form.<span class="hljs-title function_">get</span>(<span class="hljs-string">'image'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">File</span>
  
  <span class="hljs-comment">// 保存到 Blob 存储</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> blob.<span class="hljs-title function_">put</span>(file.<span class="hljs-property">name</span>, file, {
    <span class="hljs-attr">addRandomSuffix</span>: <span class="hljs-literal">true</span>
  })
})
</code></pre>
<h3 data-id="heading-7">第四步：部署上线</h3>
<p>无需去 Cloudflare 后台手动点点点，只需运行：</p>
<pre><code class="hljs language-bash" lang="bash">npx nuxthub deploy
</code></pre>
<p>它会自动登录、构建、并在云端配置好所有需要的数据库和存储资源。</p>
<hr/>
<p><strong>总结</strong>：NuxtHub 是目前 Nuxt 生态中开发<strong>全栈应用</strong>最现代、最轻量的方式，特别适合个人开发者、独立开发者。</p>
<p>最近写了个开源项目也是用nuxthub开发的。</p>
<p><strong>如果这个项目对你有帮助：</strong></p>
<ul>
<li>⭐ <strong>Star</strong> 一下支持作者</li>
<li>🐛 发现 Bug 欢迎提 <strong>Issue</strong></li>
<li>📢 分享给有需要的朋友</li>
<li>💬 有问题可以评论区交流</li>
</ul>
<blockquote>
<p>🔗 GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPBHAHAHA%2FNuxt_Mkdirs" target="_blank" title="https://github.com/PBHAHAHA/Nuxt_Mkdirs" ref="nofollow noopener noreferrer">github.com/PBHAHAHA/Nu…</a></p>
</blockquote>
<p>也可以加我微信交流：<strong>w314709923x</strong></p>
<p><em>如果觉得有帮助，别忘了点赞 👍 收藏 ⭐ 关注 ➕ 三连哦～</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS逆向-哔哩哔哩增加3倍速播放（3）-[横屏视频-全屏播放]场景]]></title>    <link>https://juejin.cn/post/7583910418659409966</link>    <guid>https://juejin.cn/post/7583910418659409966</guid>    <pubDate>2025-12-16T00:14:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910418659409966" data-draft-id="7583906870826926089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS逆向-哔哩哔哩增加3倍速播放（3）-[横屏视频-全屏播放]场景"/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-16T00:14:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TouchWorld"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473557143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS逆向-哔哩哔哩增加3倍速播放（3）-[横屏视频-全屏播放]场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473557143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TouchWorld
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:14:06.000Z" title="Tue Dec 16 2025 00:14:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>作为哔哩哔哩的重度用户，我一直期待官方支持 <strong>3 倍速播放</strong>，但该功能迟迟未上线。于是，我利用 iOS 逆向工程知识，为 B 站 App 添加这一功能。</p>
<p><strong>修改前</strong>：最高仅支持 <strong><code>2.0</code></strong> 倍速。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f1cb135823546179f55bf61551a434e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=6ulKiMS8yzs0Dg0Migdbt4G%2FvNQ%3D" alt="Screenshot 2025-12-11 at 07.26.05.png" width="100%" loading="lazy"/>
<p><strong>修改后</strong>：成功添加 <strong><code>3.0</code></strong> 倍速选项</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fee5544b2c7d462b85bf62e232d26862~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=AAcN7r5jRlIa%2BvjHy7NQUnYO2qI%3D" alt="Screenshot 2025-12-11 at 07.22.57.png" loading="lazy"/></p>
<p>本系列分为多篇，本文聚焦 <strong>横屏视频全屏播放</strong> 场景下的 <strong>3 倍速</strong>实现。</p>
<p><strong>系列回顾</strong>：</p>
<ul>
<li><a href="https://juejin.cn/post/7582063437414285350" target="_blank" title="https://juejin.cn/post/7582063437414285350">iOS逆向-哔哩哔哩增加3倍速（1）-最大播放速度</a></li>
<li><a href="https://juejin.cn/post/7582202149910544393" target="_blank" title="https://juejin.cn/post/7582202149910544393">iOS逆向-哔哩哔哩增加3倍速播放（2）-[横屏视频-半屏播放]增加3倍速播放</a></li>
</ul>
<h2 data-id="heading-1">场景</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ec04e0f2ec4bf580f7cd0e6e853103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=CCLtomnAt%2F6lMfQF%2FQPPgSfbpfI%3D" alt="E260DF27-B08D-4BD1-ADED-A6DD94AAE1A3.png" loading="lazy"/></p>
<h2 data-id="heading-2">开发环境</h2>
<ul>
<li>
<p>哔哩哔哩版本：<code>8.41.0</code></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAloneMonkey%2FMonkeyDev" target="_blank" title="https://github.com/AloneMonkey/MonkeyDev" ref="nofollow noopener noreferrer">MonkeyDev</a></p>
</li>
<li>
<p><code>IDA Professional 9.0</code></p>
</li>
<li>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">安装IDA插件：patching</a></p>
</li>
<li>
<p><code>Lookin</code></p>
</li>
</ul>
<h2 data-id="heading-3">分析</h2>
<h3 data-id="heading-4">1. 定位倍速面板控件</h3>
<ul>
<li>通过 <code>Lookin</code> 查看层级，播放速度浮层为 <code>BBPlayerFloatingWidgetView</code>，其包含 <code>_rootWidget</code> 属性（类型为 <code>BBPlayerNavigationWidget</code>）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c832dc3f4f4025baaf3cd96f443645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=WNw%2F1a27356yury%2FLEUxWXPdJM0%3D" alt="308375D5-0802-4726-902D-EAB1CB96CABA.png" loading="lazy"/></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BBPlayerFloatingWidgetView</span> : <span class="hljs-title">UIView</span> </span>{
    <span class="hljs-comment">/* instance variables */</span>
    BBPlayerContext *_context;
    BBPlayerWidget *_rootWidget;
}

<span class="hljs-comment">/* instance methods */</span>
- (<span class="hljs-type">id</span>)initWithContext:(<span class="hljs-type">id</span>)context rootWidget:(<span class="hljs-type">id</span>)widget;
- (<span class="hljs-type">id</span>)hitTest:(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">CGPoint</span> { <span class="hljs-type">double</span> x0; <span class="hljs-type">double</span> x1; })test withEvent:(<span class="hljs-type">id</span>)event;

<span class="hljs-keyword">@end</span>
</code></pre>
<h3 data-id="heading-5">2. 追踪倍速列表</h3>
<ul>
<li>我们在<code>Xcode</code>添加符号断点<code>-[BBPlayerFloatingWidgetView initWithContext:rootWidget:]</code>，看看<code>rootWidget</code>的值是什么？</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2974a3d5b52846a98a191e421a28297d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=GhBy%2BmPecBwyNUVrgwiCAUNGVV4%3D" alt="412EE2D5-DBAE-4F6B-892D-E1C957715D7F.png" loading="lazy"/></p>
<ul>
<li><code>-[BBPlayerFloatingWidgetView initWithContext:rootWidget:]</code>断点触发，我们打印参数的值，知道<code>rootWidget</code>的类型是<code>BBPlayerNavigationWidget</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) p (<span class="hljs-type">id</span>)$x3
(BBPlayerNavigationWidget *) <span class="hljs-number">0x00000002827e2be0</span>
</code></pre>
<ul>
<li>从<code>Mach-O</code>文件导出的<code>BBPlayerNavigationWidget</code>的<code>OC</code>头文件可以知道，<code>BBPlayerNavigationWidget</code>继承自<code>BBPlayerObject</code>，<code>BBPlayerObject</code>有<code>subWidgets</code>属性</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BBPlayerNavigationWidget</span> : <span class="hljs-title">BBPlayerFloatingWidget</span> &lt;<span class="hljs-title">CAAnimationDelegate</span>, <span class="hljs-title">UIGestureRecognizerDelegate</span>&gt; </span>{
    <span class="hljs-comment">/* instance variables */</span>
    <span class="hljs-built_in">NSMutableArray</span> *_widgets;
    <span class="hljs-built_in">UIView</span> *_view;
}

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) BBPlayerFloatingWidget *rootWidget;
...
<span class="hljs-comment">/* instance methods */</span>
- (<span class="hljs-type">id</span>)initWithContext:(<span class="hljs-type">id</span>)context rootWidget:(<span class="hljs-type">id</span>)widget;
- (<span class="hljs-type">id</span>)view;
- (<span class="hljs-type">void</span>)pushWidget:(<span class="hljs-type">id</span>)widget animated:(_Bool)animated;
- (<span class="hljs-type">void</span>)pushWidget:(<span class="hljs-type">id</span>)widget animated:(_Bool)animated completion:(<span class="hljs-type">id</span> <span class="hljs-comment">/* block */</span>)completion;
...

<span class="hljs-keyword">@end</span>
</code></pre>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BBPlayerWidget</span> : <span class="hljs-title">BBPlayerObject</span> &lt;<span class="hljs-title">BBPlayerWidgetDelegate</span>&gt; </span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">long</span> <span class="hljs-type">long</span> lifecycleFlag;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-built_in">UIView</span> *view;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) BBPlayerWidget *superWidget;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">copy</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-built_in">NSArray</span> *subWidgets;
...
- (<span class="hljs-type">void</span>)willAppear:(_Bool)appear;
- (<span class="hljs-type">void</span>)willLayoutSubWidgets;
- (<span class="hljs-type">void</span>)didLayoutSubWidgets;
- (<span class="hljs-type">void</span>)didAppear:(_Bool)appear;
- (<span class="hljs-type">void</span>)willDisappear:(_Bool)disappear;
- (<span class="hljs-type">void</span>)didDisappear:(_Bool)disappear;
...

<span class="hljs-keyword">@end</span>
</code></pre>
<ul>
<li>我们在<code>Xcode</code>尝试添加符号断点<code>-[BBPlayerNavigationWidget didLayoutSubWidgets]</code>，但是添加不成功</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce800759f90948469ae51a0367470927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=kfK%2FOE5jODGazvvXAd2bk0AQZ4o%3D" alt="9088873D-45A0-4B91-A181-AD273DD35DE2.png" loading="lazy"/></p>
<ul>
<li>我们<code>hook</code> <code>BBPlayerNavigationWidget</code>的<code>didLayoutSubWidgets</code>方法，并添加断点</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook BBPlayerNavigationWidget

- (<span class="hljs-type">void</span>)didLayoutSubWidgets {
    %orig;
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@:%@-%p-%s"</span>, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__);
}

%end
</code></pre>
<ul>
<li><code>BBPlayerNavigationWidget</code>的<code>didLayoutSubWidgets</code>方法的断点触发，我们打印<code>subWidgets</code>属性，发现为空</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po [<span class="hljs-keyword">self</span> subWidgets]
<span class="hljs-literal">nil</span>
</code></pre>
<ul>
<li>我们知道<code>BBPlayerNavigationWidget</code>有个<code>_widgets</code>成员变量，我们打印它的值，发现为空</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BBPlayerNavigationWidget</span> : <span class="hljs-title">BBPlayerFloatingWidget</span> &lt;<span class="hljs-title">CAAnimationDelegate</span>, <span class="hljs-title">UIGestureRecognizerDelegate</span>&gt; </span>{
    <span class="hljs-comment">/* instance variables */</span>
    <span class="hljs-built_in">NSMutableArray</span> *_widgets;
    <span class="hljs-built_in">UIView</span> *_view;
}
</code></pre>
<pre><code class="hljs language-objc" lang="objc">(lldb) po ((BBPlayerNavigationWidget *)<span class="hljs-keyword">self</span>)-&gt;_widgets
&lt;__NSArrayM <span class="hljs-number">0x280448600</span>&gt;(
)
</code></pre>
<ul>
<li>我们知道<code>BBPlayerNavigationWidget</code>有个<code>- (void)pushWidget:(id)widget animated:(_Bool)animated completion:(id)completion</code>方法，我们添加断点，看<code>widget</code>的值为多少</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook BBPlayerNavigationWidget

- (<span class="hljs-type">void</span>)didLayoutSubWidgets {
    %orig;
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"%@:%@-%p-%s"</span>, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__);
}

- (<span class="hljs-type">void</span>)pushWidget:(<span class="hljs-type">id</span>)widget animated:(_Bool)animated completion:(<span class="hljs-type">id</span>)completion {
    %orig;
}

- (<span class="hljs-type">void</span>)addWidget:(<span class="hljs-type">id</span>)widget animated:(_Bool)animated completion:(<span class="hljs-type">id</span>)completion {
    %orig;
}

%end
</code></pre>
<ul>
<li><code>- (void)pushWidget:(id)widget animated:(_Bool)animated completion:(id)completion</code>方法的断点触发，发现<code>widget</code>的类型是<code>BBPlayerPlaybackRateListWidget</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) p widget
(BBPlayerPlaybackRateListWidget?) <span class="hljs-number">0x0000000282437b60</span>
</code></pre>
<ul>
<li>而且<code>- (void)pushWidget:(id)widget animated:(_Bool)animated completion:(id)completion</code>方法执行完后，<code>_widgets</code>属性有值了，<code>subWidgets</code>属性也有值了，类型是<code>BBPlayerPlaybackRateListWidget</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po ((BBPlayerNavigationWidget *)<span class="hljs-keyword">self</span>)-&gt;_widgets
&lt;__NSArrayM <span class="hljs-number">0x2804a05d0</span>&gt;(
&lt;BBPlayerPlaybackRateListWidget: <span class="hljs-number">0x282437b60</span>&gt;

)

(lldb) po [<span class="hljs-keyword">self</span> subWidgets]
&lt;__NSSingleObjectArrayI <span class="hljs-number">0x2817c38e0</span>&gt;(
&lt;BBPlayerPlaybackRateListWidget: <span class="hljs-number">0x282437b60</span>&gt;
)
</code></pre>
<ul>
<li>从<code>Mach-O</code>文件导出的<code>BBPlayerCommonSwift.BBPlayerPlaybackRateListWidget</code>的<code>swift</code>文件可以知道，它有一个<code>rateArray</code>属性，猜测它是播放速度数组，<code>rateArray</code>属性只读，<code>getter</code>方法叫做<code>sub_10D829128</code></li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BBPlayerCommonSwift</span>.<span class="hljs-title class_">BBPlayerPlaybackRateListWidget</span>: <span class="hljs-title class_">BBPlayerFloatingWidget</span> {
  <span class="hljs-comment">/* fields */</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">lazy</span> tableView: <span class="hljs-type">UITableView</span>?
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">lazy</span> playbackRate: (<span class="hljs-keyword">private</span>) <span class="hljs-operator">?</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">lazy</span> rateArray: <span class="hljs-type">Array</span> -&gt; <span class="hljs-type">BBPlayerCommonSwift</span>.<span class="hljs-type">BBPlayerPlayerRateModel</span> <span class="hljs-operator">?</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">lazy</span> playbackRateProxy: <span class="hljs-type">BBPlayerPlaybackRateValueService</span>??
  <span class="hljs-comment">/* methods */</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>.getter.sub_10d828e50
    <span class="hljs-comment">// &lt;stripped&gt; func tableView.setter </span>
    <span class="hljs-comment">// &lt;stripped&gt; func tableView.modify </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">playbackRate</span>.getter.sub_10d829074
    <span class="hljs-comment">// &lt;stripped&gt; func playbackRate.setter </span>
    <span class="hljs-comment">// &lt;stripped&gt; func playbackRate.modify </span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rateArray</span>.getter.sub_10d829128
    <span class="hljs-comment">// &lt;stripped&gt; func rateArray.setter </span>
    <span class="hljs-comment">// &lt;stripped&gt; func rateArray.modify </span>
<span class="hljs-operator">...</span>
}
</code></pre>
<ul>
<li>我们添加一个符号断点<code>sub_10D829128</code>，看看<code>rateArray</code>的值是多少？</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a28a00a97024d05acf74698d3049424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=lnQicMRm1VdEkouFdoGOYTVPIhM%3D" alt="8CA3E563-CE85-4CB9-BADB-BC848632374B.png" loading="lazy"/></p>
<ul>
<li><code>sub_10D829128</code>断点触发，打印它的返回值，发现是播放速度，这也证明了<code>rateArray</code>属性是播放速度数组</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStorageC19BBPlayerCommonSwift23BBPlayerPlayerRateModel_$ <span class="hljs-number">0x2835d09b0</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107fb20</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">2.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107fae0</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107dc40</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107fc60</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107e880</span>; value = <span class="hljs-number">0.750000</span>; text = <span class="hljs-number">0.75</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x28107e660</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;
)
</code></pre>
<h3 data-id="heading-6">3. 找到数组创建函数</h3>
<ul>
<li>从<code>IDA</code>查看<code>sub_10D829128</code>的伪代码，分析后猜测是由<code>sub_10D82E870</code>方法创建的播放速度数组</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__int64 sub_10D829128()
{
...
  v1 = OBJC_IVAR___BBPlayerPlaybackRateListWidget____lazy_storage___rateArray;
  v2 = *(_QWORD *)(v0 + OBJC_IVAR___BBPlayerPlaybackRateListWidget____lazy_storage___rateArray);
  <span class="hljs-keyword">if</span> ( v2 )
  {
    v3 = *(_QWORD *)(v0 + OBJC_IVAR___BBPlayerPlaybackRateListWidget____lazy_storage___rateArray);
  }
  <span class="hljs-keyword">else</span>
  {
    v4 = sub_10D82E870();
    v3 = sub_10D82918C(v4);
    v5 = *(_QWORD *)(v0 + v1);
    *(_QWORD *)(v0 + v1) = v3;
    ((<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))swift_bridgeObjectRetain)();
    swift_bridgeObjectRelease(v5);
    v2 = <span class="hljs-number">0</span>LL;
  }
  swift_bridgeObjectRetain(v2);
  <span class="hljs-keyword">return</span> v3;
}
</code></pre>
<ul>
<li>查看<code>sub_10D82E870</code>方法的伪代码，知道它返回一个包含 6 个 <code>BBPlayerPlayerRateModel</code> 的数组。</li>
</ul>
<pre><code class="hljs language-c" lang="c">__int64 <span class="hljs-title function_">sub_10D82E870</span><span class="hljs-params">()</span>
{
...
  sub_10D7DBF44();
  v0 = swift_allocObject();
  *(_OWORD *)(v0 + <span class="hljs-number">16</span>) = xmmword_110613B30;
  v1 = (objc_class *)type metadata accessor <span class="hljs-keyword">for</span> BBPlayerPlayerRateModel();
  v2 = (<span class="hljs-type">char</span> *)objc_msgSend(objc_allocWithZone(v1), <span class="hljs-string">"init"</span>);
  v3 = &amp;v2[OBJC_IVAR___BBPlayerPlayerRateModel_value];
  swift_beginAccess(&amp;v2[OBJC_IVAR___BBPlayerPlayerRateModel_value], v38, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  *(_QWORD *)v3 = <span class="hljs-number">0x3FE0000000000000</span>LL;
  v4 = &amp;v2[OBJC_IVAR___BBPlayerPlayerRateModel_text];
  swift_beginAccess(&amp;v2[OBJC_IVAR___BBPlayerPlayerRateModel_text], v37, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  v5 = *((_QWORD *)v4 + <span class="hljs-number">1</span>);
  *(_QWORD *)v4 = <span class="hljs-number">3485232LL</span>;
  *((_QWORD *)v4 + <span class="hljs-number">1</span>) = <span class="hljs-number">0xE300000000000000</span>LL;
  swift_bridgeObjectRelease(v5);
  *(_QWORD *)(v0 + <span class="hljs-number">32</span>) = v2;
  v6 = (<span class="hljs-type">char</span> *)objc_msgSend(objc_allocWithZone(v1), <span class="hljs-string">"init"</span>);
  v7 = &amp;v6[OBJC_IVAR___BBPlayerPlayerRateModel_value];
  swift_beginAccess(&amp;v6[OBJC_IVAR___BBPlayerPlayerRateModel_value], v36, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  *(_QWORD *)v7 = <span class="hljs-number">0x3FE8000000000000</span>LL;
  v8 = &amp;v6[OBJC_IVAR___BBPlayerPlayerRateModel_text];
  swift_beginAccess(&amp;v6[OBJC_IVAR___BBPlayerPlayerRateModel_text], v35, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  v9 = *((_QWORD *)v8 + <span class="hljs-number">1</span>);
  *(_QWORD *)v8 = <span class="hljs-number">892808752LL</span>;
  *((_QWORD *)v8 + <span class="hljs-number">1</span>) = <span class="hljs-number">0xE400000000000000</span>LL;
  swift_bridgeObjectRelease(v9);
  *(_QWORD *)(v0 + <span class="hljs-number">40</span>) = v6;
  v10 = (<span class="hljs-type">char</span> *)objc_msgSend(objc_allocWithZone(v1), <span class="hljs-string">"init"</span>);
  v11 = &amp;v10[OBJC_IVAR___BBPlayerPlayerRateModel_value];
  swift_beginAccess(&amp;v10[OBJC_IVAR___BBPlayerPlayerRateModel_value], v34, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  *(_QWORD *)v11 = <span class="hljs-number">0x3FF0000000000000</span>LL;
  v12 = &amp;v10[OBJC_IVAR___BBPlayerPlayerRateModel_text];
  swift_beginAccess(&amp;v10[OBJC_IVAR___BBPlayerPlayerRateModel_text], v33, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>);
  v13 = *((_QWORD *)v12 + <span class="hljs-number">1</span>);
  *(_QWORD *)v12 = <span class="hljs-number">3157553LL</span>;
  *((_QWORD *)v12 + <span class="hljs-number">1</span>) = <span class="hljs-number">0xE300000000000000</span>LL;
  swift_bridgeObjectRelease(v13);
  *(_QWORD *)(v0 + <span class="hljs-number">48</span>) = v10;
...
  <span class="hljs-keyword">return</span> v0;
}
</code></pre>
<ul>
<li>我们添加一个符号断点<code>sub_10D82E870</code>，看看方法返回值多少？</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fa5ad9d33664f7db660915a655935ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=YGHWIE88t8vKImgIeOFrx5wfkSk%3D" alt="5A6089F4-393E-4D9C-8C53-DAF4C10C7226.png" loading="lazy"/></p>
<ul>
<li><code>sub_10D82E870</code>断点触发，打印它的返回值，发现是播放速度数组<code>[0.5、0.75、1.0、1.25、1.5、2.0]</code>，这也证明了是由<code>sub_10D82E870</code>方法创建的播放速度数组</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStorageC19BBPlayerCommonSwift23BBPlayerPlayerRateModel_$ <span class="hljs-number">0x2834b2da0</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x281164280</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x281165760</span>; value = <span class="hljs-number">0.750000</span>; text = <span class="hljs-number">0.75</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x2811655c0</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x281164840</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x281165500</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x281164a40</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<h2 data-id="heading-7">越狱解决方案</h2>
<h3 data-id="heading-8">MSHookFunction</h3>
<p><code>MSHookFunction</code> 来自 <strong>Cydia Substrate（MobileSubstrate）</strong>，用于 <strong>直接 Hook 一个函数地址</strong>，而不是 Objective-C 方法。</p>
<h4 data-id="heading-9">函数原型</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MSHookFunction</span><span class="hljs-params">(
    <span class="hljs-type">void</span> *symbol,
    <span class="hljs-type">void</span> *replace,
    <span class="hljs-type">void</span> **result
)</span></span>;
</code></pre>
<h4 data-id="heading-10">参数说明</h4>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>symbol</code></td><td><strong>原始函数地址</strong></td></tr><tr><td><code>replace</code></td><td><strong>你的替换函数</strong></td></tr><tr><td><code>result</code></td><td><strong>保存原始函数指针（可选）</strong></td></tr></tbody></table>
<h3 data-id="heading-11">方案</h3>
<ul>
<li>使用 <code>MSHookFunction</code> 直接 <code>hook sub_10D82E870</code>，修改返回数组的 <code>value</code> 和 <code>text</code> 属性。</li>
</ul>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#import <span class="hljs-string">"NJChangePlaybackRateTool.h"</span></span>
<span class="hljs-meta">#import <span class="hljs-string">"NJCommonDefine.h"</span></span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-type">double</span> NJChangePlaybackRateFlag = <span class="hljs-number">3.0</span>;

<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NJChangePlaybackRateTool</span> ()</span>

<span class="hljs-comment">/// 播放速度</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *playbackRates;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NJChangePlaybackRateTool</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Life Cycle Methods</span>

- (<span class="hljs-keyword">instancetype</span>)init {
    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) {
        [<span class="hljs-keyword">self</span> doInit];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Do Init</span>

- (<span class="hljs-type">void</span>)doInit {
    <span class="hljs-keyword">self</span>.playbackRates = @[<span class="hljs-string">@"0.5"</span>, <span class="hljs-string">@"1.0"</span>, <span class="hljs-string">@"1.25"</span>, <span class="hljs-string">@"1.5"</span>, <span class="hljs-string">@"2.0"</span>, <span class="hljs-string">@"3.0"</span>];
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Override Methods</span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Public Methods</span>

- (<span class="hljs-built_in">NSArray</span> *)changePlaybackRateWithRateArray:(<span class="hljs-built_in">NSArray</span> *)rateArray {
    <span class="hljs-keyword">if</span> (![<span class="hljs-keyword">self</span> shouldChange:rateArray]) {
        <span class="hljs-keyword">return</span> rateArray;
    }
<span class="hljs-comment">//    NSLog(@"[%@] change before rateArray = %@, class:%@", nj_logPrefix, rateArray, NSStringFromClass([rateArray class]));</span>
    <span class="hljs-built_in">NSInteger</span> rateCount = rateArray.count;
    <span class="hljs-built_in">NSInteger</span> newRateCount = <span class="hljs-keyword">self</span>.playbackRates.count;
    <span class="hljs-built_in">NSInteger</span> count = MIN(rateCount, newRateCount);
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        BBPlayerPlayerRateModel *rateModel = rateArray[i];
        <span class="hljs-built_in">NSString</span> *newRateStr = <span class="hljs-keyword">self</span>.playbackRates[i];
        rateModel.value = newRateStr.doubleValue;
        rateModel.text = newRateStr;
    }
<span class="hljs-comment">//    NSLog(@"[%@] change after rateArray = %@, class:%@", nj_logPrefix, rateArray, NSStringFromClass([rateArray class]));</span>
    <span class="hljs-keyword">return</span> rateArray;
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Private Methods</span>

- (<span class="hljs-type">BOOL</span>)shouldChange:(<span class="hljs-built_in">NSArray</span> *)rateArray {
    <span class="hljs-type">BOOL</span> flag = <span class="hljs-literal">YES</span>;
    <span class="hljs-keyword">for</span> (BBPlayerPlayerRateModel *item <span class="hljs-keyword">in</span> rateArray) {
        <span class="hljs-keyword">if</span> (item.value == NJChangePlaybackRateFlag) {
            flag = <span class="hljs-literal">NO</span>;
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> flag;
}

<span class="hljs-keyword">@end</span>

</code></pre>
<p><strong>Hook 实现</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 声明原函数类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">typealias</span> orig_landscapeVideo_fullScreenPlayback_RateModelArr_type <span class="hljs-operator">=</span> <span class="hljs-keyword">@convention(c)</span> () -&gt; <span class="hljs-type">Int64</span>

<span class="hljs-comment">// 定义全局函数指针变量，并绑定一个 C 名字</span>
<span class="hljs-meta">@_silgen_name</span>(<span class="hljs-string">"orig_landscapeVideo_fullScreenPlayback_RateModelArr"</span>)
<span class="hljs-keyword">nonisolated</span>(unsafe) <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> orig_landscapeVideo_fullScreenPlayback_RateModelArr: orig_landscapeVideo_fullScreenPlayback_RateModelArr_type<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
<span class="hljs-comment">// [横屏视频-全屏播放]播放速度数组</span>
<span class="hljs-meta">@_cdecl</span>(<span class="hljs-string">"my_landscapeVideo_fullScreenPlayback_RateModelArr"</span>)
<span class="hljs-keyword">func</span> <span class="hljs-title function_">my_landscapeVideo_fullScreenPlayback_RateModelArr</span>() -&gt; <span class="hljs-type">Int64</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> orig_landscapeVideo_fullScreenPlayback_RateModelArr {
        <span class="hljs-keyword">let</span> origPtr <span class="hljs-operator">=</span> orig_landscapeVideo_fullScreenPlayback_RateModelArr()
        <span class="hljs-keyword">let</span> origArr <span class="hljs-operator">=</span> <span class="hljs-built_in">unsafeBitCast</span>(origPtr, to: [<span class="hljs-type">NSObject</span>].<span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">let</span> tool <span class="hljs-operator">=</span> <span class="hljs-type">NJChangePlaybackRateTool</span>()
        tool.changePlaybackRate(withRateArray: origArr)
        <span class="hljs-keyword">let</span> retPtr <span class="hljs-operator">=</span> <span class="hljs-built_in">unsafeBitCast</span>(origArr, to: <span class="hljs-type">Int64</span>.<span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">return</span> retPtr
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
}

</code></pre>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// __int64 sub_10D82E870()</span>
<span class="hljs-comment">// [横屏视频-全屏播放]播放速度数组</span>
<span class="hljs-type">long</span> <span class="hljs-type">long</span> landscapeVideo_fullScreenPlayback_RateModelArr_address = g_slide+<span class="hljs-number">0x10D82E870</span>;
<span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[%@] cal func landscapeVideo_fullScreenPlayback_RateModelArr_address address:0x%llx"</span>, nj_logPrefix, landscapeVideo_fullScreenPlayback_RateModelArr_address);
MSHookFunction((<span class="hljs-type">void</span> *)landscapeVideo_fullScreenPlayback_RateModelArr_address,
			   (<span class="hljs-type">void</span>*)my_landscapeVideo_fullScreenPlayback_RateModelArr,
			   (<span class="hljs-type">void</span>**)&amp;orig_landscapeVideo_fullScreenPlayback_RateModelArr);

</code></pre>
<h2 data-id="heading-12">非越狱解决方案</h2>
<p>通过 <code>IDA Pro</code> 修改汇编指令，直接硬编码新倍速。</p>
<h3 data-id="heading-13">分析</h3>
<ul>
<li>我们知道<code>sub_10D82E870</code>方法返回的是<code>BBPlayerPlayerRateModel</code>数组，而<code>BBPlayerPlayerRateModel</code>的结构如下，所以我们要修改<code>BBPlayerPlayerRateModel</code>的<code>value</code>和<code>text</code>的值</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">BBPlayerPlayerRateModel</span> : <span class="hljs-title">NSObject</span> // (<span class="hljs-title">Swift</span>)</span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">double</span> value;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *text;

<span class="hljs-comment">/* instance methods */</span>
- (<span class="hljs-type">id</span>)initWithValue:(<span class="hljs-type">double</span>)value text:(<span class="hljs-type">id</span>)text;
- (<span class="hljs-type">id</span>)init;

<span class="hljs-keyword">@end</span>
</code></pre>
<h3 data-id="heading-14">修改value</h3>
<p>让<code>chatgpt</code>帮忙分析<code>sub_10D82E870</code>方法的汇编指令，给我们赋值<code>value</code>的地址，给出如下表格：</p>















































<table><thead><tr><th>元素 index</th><th>地址</th><th>旧值: 旧汇编指令</th><th>新值: 新汇编指令</th></tr></thead><tbody><tr><td>0</td><td><code>0x10D82E8FC</code></td><td><code>"0.5"</code>： <code>MOV       X8, #0x3FE0000000000000</code></td><td>不变</td></tr><tr><td>1</td><td><code>0x10D82E970</code></td><td><code>"0.75"</code>： <code>MOV       X8, #0x3FE8000000000000</code></td><td><code>"1.0"</code>： <code>MOV       X8, #0x3FF0000000000000</code></td></tr><tr><td>2</td><td><code>0x10D82E9E0</code></td><td><code>"1.0"</code>： <code>MOV       X8, #0x3FF0000000000000</code></td><td><code>"1.25"</code>： <code>MOV       X8, #0x3FF4000000000000</code></td></tr><tr><td>3</td><td><code>0x10D82EA4C</code></td><td><code>"1.25"</code>： <code>MOV       X8, #0x3FF4000000000000</code></td><td><code>"1.5"</code>： <code>MOV       X8, #0x3FF8000000000000</code></td></tr><tr><td>4</td><td><code>0x10D82EAB8</code></td><td><code>"1.5"</code>： <code>MOV       X8, #0x3FF8000000000000</code></td><td><code>"2.0"</code>： <code>MOV       X8, #0x4000000000000000</code></td></tr><tr><td>5</td><td><code>0x10D82EB28</code></td><td><code>"2.0"</code>： <code>MOV       X8, #0x4000000000000000</code></td><td><code>"3.0"</code>： <code>MOV       X8, #0x4008000000000000</code></td></tr></tbody></table>
<h4 data-id="heading-15">示例</h4>
<ul>
<li>
<p>我们修改<code>000000010D82E970</code>的指令</p>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E970                 MOV             X8, #<span class="hljs-number">0x3FE8000000000000</span>
</code></pre>
<ul>
<li>鼠标点击<code>000000010D82E970</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E970                 MOV             X8, #<span class="hljs-number">0x3FE8000000000000</span>
</code></pre>
<ul>
<li>右键选择<code>Assemble</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c70d1ef0e8a3464ebaa87998330d8700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=lAyRz830i5N3mNBEhib9FzYd2Ec%3D" alt="CBAD6A1D-ABAA-46E3-9855-87E9CC816B2F.png" loading="lazy"/></li>
</ul>

<ul>
<li>改成</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOV     X8, #<span class="hljs-number">0x3FF0000000000000</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba2cbe181d714ae890727157da9b4d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=zGsKoLpehHJ%2BKmSa9KkI%2BuAeYYg%3D" alt="70A070E9-EA12-4482-BDF0-636E77B7C97B.png" loading="lazy"/></p>
<ul>
<li>点击<code>enter</code></li>
</ul>
</li>
<li>
<p>保存到<code>Mach-O</code>文件中</p>
<ul>
<li><code>IDA</code>-&gt;<code>Edit</code>-&gt;<code>Patch program</code>-&gt;<code>Apply patches to input file</code>-&gt;<code>Apply patches</code></li>
</ul>
</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33339a2dcdd74c1396a207e5265a93e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=mFYbtinyjmvwewSRIgkKj40F%2FSw%3D" alt="12636991-9898-4A7D-B2A1-D400B420039F.png" width="70%" loading="lazy"/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ed2b24482984094a63c5392e8901d10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=daoQg2AzGlGWDfKkOqlEJQeE6QE%3D" alt="06857153-3C9D-4018-82FA-55C53C1C6516.png" loading="lazy"/></p>
<ul>
<li>
<p>保存后：底部会显示<code>log</code>：</p>
<pre><code class="hljs language-objc" lang="objc">Patch successful: /Users/touchworld/Documents/iOSDisassembler/hook/bilibili/IDA_max_0/bili-universal
</code></pre>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c28bfc6b6094c58b8d920bd8465f83f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=LXq8Br0uD5K84LSGO5U3sM0Ot2E%3D" alt="DE3F7FC3-798A-4A23-9C34-FF6AF7F24BC7.png" loading="lazy"/></p>
<ul>
<li>
<p>验证修改结果</p>
<ul>
<li>将修改后的<code>Mach-O</code>文件放入<code>.app</code>文件中</li>
<li><code>Xcode</code>添加符号断点<code>sub_10D82E870</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27cc5f374ba049acb8e0ca9cf14ef7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=bL1nlL%2FTrnRGfRdmJn64H%2BwopL8%3D" alt="4B068744-8DF9-4C12-99BF-DC96A954A2EC.png" loading="lazy"/></p>
<ul>
<li><code>sub_10D82E870</code>断点触发，打印它的返回值，发现<strong>元素1</strong>的<code>value</code>已经从<code>0.75</code>改为了<code>1.0</code>，验证修改成功。</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x303adb570</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d18f60</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d19880</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">0.75</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d197e0</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d19840</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d19780</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301d19860</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
</li>
<li>
<p>全部修改结果</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x3009c9360</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a4cc0</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a5660</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">0.75</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a49a0</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a4900</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a48a0</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3028a4400</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<h3 data-id="heading-16">修改text</h3>
<p>让<code>chatgpt</code>分析<code>sub_10D82E870</code>方法的汇编指令，给我们赋值<code>text</code>的地址，给出如下表格：</p>








































<table><thead><tr><th>元素 index</th><th>地址</th><th>旧值: 旧汇编指令</th></tr></thead><tbody><tr><td>0</td><td><code>0x10D82E928</code></td><td><code>0.5</code>： <code>MOV       W8, #0x352E30</code></td></tr><tr><td>1</td><td><code>0x10D82E998</code></td><td><code>0.75</code>： <code>MOV       W8, #0x35372E30</code></td></tr><tr><td>2</td><td><code>0x10D82EA08</code></td><td><code>1.0</code>： <code>MOV       W28, #0x302E31</code></td></tr><tr><td>3</td><td><code>0x10D82EA74</code></td><td><code>1.25</code>： <code>MOV       W8, #0x35322E31</code></td></tr><tr><td>4</td><td><code>0x10D82EAE0</code></td><td><code>1.5</code>： <code>MOV       W8, #0x352E31</code></td></tr><tr><td>5</td><td><code>0x10D82EB50</code></td><td><code>2.0</code>： <code>ADD       X8, X28, #1</code></td></tr></tbody></table>
<h4 data-id="heading-17">分析</h4>
<p>第<code>5</code>个元素的<code>0x10D82EB50</code>的指令是<code>ADD       X8, X28, #1</code>，而<code>x28</code>寄存器只在<code>__text:000000010D82EA08         MOV       W28, #0x302E31</code>赋过值，而<code>#0x302E31</code>的值是<code>1.0</code>，所以<code>ADD       X8, X28, #1</code>相当于是<code>X8 = X28 + 1 = 1.0 + 1 = 2.0</code> ，所以第<code>5</code>个元素显示的是<code>2.0</code>。</p>
<p>所以方案就是，<code>1.0</code>要使用<code>MOV       W28, #0x302E31</code>，<code>2.0</code>使用<code>ADD       X8, X28, #1</code>，<code>3.0</code>跟<code>2.0</code>一致。</p>
<blockquote>
<p>下面在元素1中，给出具体的调试过程，其他元素类似。</p>
</blockquote>
<hr/>
<h4 data-id="heading-18">元素0</h4>
<p>元素<code>0</code>不需要修改，就是<code>0.5</code></p>
<h4 data-id="heading-19">元素1</h4>
<ul>
<li>
<p>原本<code>0x10D82E998</code>的<code>MOV       W8, #0x35372E30（0.75）</code>，占两个指令空间，要改成<code>MOV       W28, #0x302E31（1.0）</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E998                 MOV             W8, #<span class="hljs-number">0x35372E30</span>
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E998                 MOV             W28, #<span class="hljs-number">0x302E31</span>
</code></pre>
</li>
</ul>
<h5 data-id="heading-20">伪指令</h5>
<p><strong>伪指令</strong>（<code>Pseudo-Instruction</code>）不是 <code>CPU</code> 真实存在的机器指令，而是编译器/汇编器提供的“方便写法”。</p>
<p>最终汇编器会把伪指令转换成 一条或多条真实的机器指令。</p>
<p>看个例子：</p>
<ul>
<li>鼠标点击<code>000000010D82E998</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E998                 MOV             W8, #<span class="hljs-number">0x35372E30</span>
</code></pre>
<ul>
<li>查看<code>000000010D82E998</code>的<code>16</code>进制视图，发现指令占用了<code>8 bytes</code>，也就是两个指令的空间，所以<code>MOV       W8, #0x35372E30</code>是一个<strong>伪指令</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/028fc55f2d3c42a7a3110ae4624299a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=j%2BbLGfhBMOycJP8hxZHelfWp9qc%3D" alt="DA6DF5E1-0397-46BD-A893-A8AB6F9456BC.png" loading="lazy"/></p>
<ul>
<li>问<code>chatgpt</code>，<code>MOV       W8, #0x35372E30</code>可以拆分成什么指令？回答如下</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOVZ    W8, #<span class="hljs-number">0x2E30</span>
MOVK    W8, #<span class="hljs-number">0x3537</span>, LSL #<span class="hljs-number">16</span>
</code></pre>
<h5 data-id="heading-21">获取伪指令的真实指令</h5>
<ul>
<li>问<code>chatgpt</code>，<code>MOV       W28, #0x302E31</code>可以拆分成：</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOVZ    W28, #<span class="hljs-number">0x2E31</span>            <span class="hljs-comment">// 写入低 16 位</span>
MOVK    W28, #<span class="hljs-number">0x0030</span>, LSL #<span class="hljs-number">16</span>   <span class="hljs-comment">// 写入高 16 位</span>
</code></pre>
<h5 data-id="heading-22">获取汇编指令的机器码</h5>
<ul>
<li>写<code>main.S</code>文件</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">.global _main
_main:
    MOVZ    W28, #<span class="hljs-number">0x2E31</span>            <span class="hljs-comment">// 写入低 16 位</span>
    MOVK    W28, #<span class="hljs-number">0x0030</span>, LSL #<span class="hljs-number">16</span>   <span class="hljs-comment">// 写入高 16 位</span>
    ret
</code></pre>
<ul>
<li>编译<code>main.S</code>文件</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">clang -arch arm64 main.S -o main
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43d8bf52e45845b785ebdfc3d586a7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=0%2BSTnduEyfzhoFN5f%2FG1cp4Ghwk%3D" alt="BCD67C3E-D7D5-4282-A0CF-8A886CC9D27B.png" loading="lazy"/></p>
<ul>
<li>使用<code>MachOView</code>查看<code>main</code>文件(<code>Mach-O</code>文件)的机器码</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb29b3e29f1846a28b6d6f1d2fde62c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=0OiNujBGFV8erAJBvNczwe6%2FfWk%3D" alt="image-20251215150438720.png" loading="lazy"/></p>
<ul>
<li>所以<code>MOV       W28, #0x302E31</code>的机器码是</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">3</span>C C6 <span class="hljs-number">85</span> <span class="hljs-number">52</span> <span class="hljs-number">1</span>C <span class="hljs-number">06</span> A0 <span class="hljs-number">72</span>
</code></pre>
<h5 data-id="heading-23">修改指令的机器码</h5>
<ul>
<li>鼠标点击<code>000000010D82E998</code></li>
<li><code>IDA</code>-&gt;<code>Edit</code>-&gt;<code>Patch program</code>-&gt;<code>Change byte</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ad3a5353d8b4e8ca65825b4830d0954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=7z3m6ixN3%2Bil%2BY0aJi8Gc6I%2BV1M%3D" alt="7055BC7A-0B60-49DF-AA40-6444A3240912.png" loading="lazy"/></p>
<ul>
<li>显示<code>Patch Bytes</code>弹框</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63efee5447274dc4af3c0acca0772f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=FSnKxoOmrWv6VelqAid6cS0F8wU%3D" alt="459F522D-9842-4D5F-AFC8-F87A82FC8865.png" loading="lazy"/></p>
<ul>
<li>从<code>Origin value</code>：
<ul>
<li><strong>08 C6 85 52 E8 A6 A6 72 1B 80 FC D2 C8 6E 00 A9</strong></li>
</ul>
</li>
<li>修改 Values 为：
<ul>
<li><strong>3C C6 85 52 1C 06 A0 72 1B 80 FC D2 DC 6A 00 A9</strong></li>
</ul>
</li>
<li>点击<code>OK</code>，真正修改</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62538c4e6abf436ebb9c1113a17a967b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=ojU6TIewlOuHh5LkDwV0CS24C%2F0%3D" alt="image-20251215151448578.png" loading="lazy"/></p>
<h5 data-id="heading-24">保存</h5>
<ul>
<li>
<p>保存到<code>Mach-O</code>文件中</p>
<ul>
<li><code>IDA</code>-&gt;<code>Edit</code>-&gt;<code>Patch program</code>-&gt;<code>Apply patches to input file</code>-&gt;<code>Apply patches</code></li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2476728b7cb4aa58686f85f6d644a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=azfo6Ph3mnc%2BGCIv9Vx%2FIErVKIk%3D" alt="12636991-9898-4A7D-B2A1-D400B420039F-5765270.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f0b97c027664ee9bcdadfff56f78f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=VlLh5WhGqBGFy7ajT8ps3sdUkeQ%3D" alt="06857153-3C9D-4018-82FA-55C53C1C6516-5765282.png" loading="lazy"/></p>
<ul>
<li>保存后：底部会显示<code>log</code>：</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">Patch successful: /Users/touchworld/Documents/iOSDisassembler/hook/bilibili/IDA_max_0/bili-universal
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e9262d46604634b05194f4692bb6fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=6HwYHSfmpn5%2FOkM5mJEUpn56sVk%3D" alt="DE3F7FC3-798A-4A23-9C34-FF6AF7F24BC7-5765291.png" loading="lazy"/></p>
<h5 data-id="heading-25">验证失败</h5>
<ul>
<li>将修改后的<code>Mach-O</code>文件放入<code>.app</code>文件中</li>
<li><code>Xcode</code>添加符号断点<code>sub_10D82E870</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c43c059e46f246ceba727ddc5fea2d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=4E0wBR5DELgNB1HWbo3%2FbuU0q2M%3D" alt="4B068744-8DF9-4C12-99BF-DC96A954A2EC-5765304.png" loading="lazy"/></p>
<ul>
<li><code>sub_10D82E870</code>断点触发，打印它的返回值，发现<strong>元素1</strong>的<code>text</code>已经从<code>"0.75"</code>改为了<code>"1.0"</code>，但是打印的数组显示不全，而且倍速列表显示的是<code>1.0</code>，不是<code>1.0X</code>，所以还是有问题。</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x3036c0190</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x301058d80</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30105b380</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0868324e9427424c98a89b8d0f28d064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=1xVhLY%2Bmk0ZXLwVvCY7disZCHpE%3D" alt="4F4E4F3B-2414-42BE-81EF-1C90EDB6362C.png" loading="lazy"/></p>
<h5 data-id="heading-26">处理问题</h5>
<ul>
<li>我们知道<code>0x10D82EA08</code>的<code>MOV       W28, #0x302E31</code>的值是<code>1.0</code>，它的下一条指令是<code>STP       X28, X26, [X22]</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA08                 MOV             W28, #<span class="hljs-number">0x302E31</span>
__text:<span class="hljs-number">000000010</span>D82EA10                 STP             X28, X26, [X22]
</code></pre>
<ul>
<li>而修改后的<code>000000010D82E998</code>的<code>MOV             W28, #0x302E31</code>，它的下一条指令是<code>STP       X8, X27, [X22]</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82E998                 MOV             W28, #<span class="hljs-number">0x302E31</span>
__text:<span class="hljs-number">000000010</span>D82E9A4                 STP             X8, X27, [X22]
</code></pre>
<ul>
<li>我们尝试将<code>0x10D82E9A4</code>的<code>STP       X8, X27, [X22]</code>，改为<code>STP             X28, X26, [X22]</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6192370da52443f914f60a22a29d81e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=h6HaRDujvtjNilXUZCLlY1BNLx4%3D" alt="image-20251215152153278.png" loading="lazy"/></p>
<h5 data-id="heading-27">再次验证</h5>
<ul>
<li><code>sub_10D82E870</code>断点触发，打印它的返回值，发现<strong>元素1</strong>的<code>text</code>已经从<code>"0.75"</code>改为了<code>"1.0"</code>，而且数组全部打印了，倍速列表显示的是<code>1.0X</code>，修改成功。</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x301b6b8e0</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbd1c0</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbd200</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbcf80</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbcf40</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbcb20</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x303bbc860</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4c65ad9df4e48f096bf26ca3dff4803~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=I0UkGWaHWxHz82BLdq%2FnKKtVt2Y%3D" alt="9103463C-D49B-4FE6-BD66-E79B0172F047.png" loading="lazy"/></p>
<h4 data-id="heading-28">元素2</h4>
<ul>
<li>
<p>原本<code>0x10D82EA08</code>的<code>MOV       W28, #0x302E31（1.0）</code>，占两个指令空间，要改成<code>MOV       W8, #0x35322E31（1.25）</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA08                 MOV             W28, #<span class="hljs-number">0x302E31</span>
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA08                 MOV             W8, #<span class="hljs-number">0x35322E31</span>
</code></pre>
</li>
<li>
<p><code>MOV       W8, #0x35322E31</code>拆分成：</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOVZ    W8, #<span class="hljs-number">0x2E31</span>              <span class="hljs-comment">// 写低 16 bit</span>
MOVK    W8, #<span class="hljs-number">0x3532</span>, LSL #<span class="hljs-number">16</span>     <span class="hljs-comment">// 写高 16 bit</span>
</code></pre>
<ul>
<li><code>MOV       W8, #0x35322E31</code>的机器码</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">28</span> C6 <span class="hljs-number">85</span> <span class="hljs-number">52</span> <span class="hljs-number">48</span> A6 A6 <span class="hljs-number">72</span>
</code></pre>
<ul>
<li>
<p>还需要将<code>0x10D82EA10</code>的<code>STP       X28, X26, [X22]</code>，占一个指令空间，改成<code>STP       X8, X27, [X22]</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA10                 STP             X28, X26, [X22]
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA10                 STP             X8, X27, [X22]
</code></pre>
</li>
<li>
<p>验证</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x3022f5f90</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057cca0</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057f360</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057ccc0</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057f3c0</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057c960</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30057ca00</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<h4 data-id="heading-29">元素3</h4>
<ul>
<li>
<p>原本<code>0x10D82EA74</code>的<code>MOV       W8, #0x35322E31（1.25）</code>，占两个指令空间，要改成<code>MOV W8, #0x352E31（1.5）</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA74                 MOV             W8, #<span class="hljs-number">0x35322E31</span>
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA74                 MOV             W8, #<span class="hljs-number">0x352E31</span>
</code></pre>
</li>
<li>
<p><code>MOV W8, #0x352E31</code>拆分成</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOVZ    W8, #<span class="hljs-number">0x2E31</span>              <span class="hljs-comment">// 写低16位</span>
MOVK    W8, #<span class="hljs-number">0x0035</span>, LSL #<span class="hljs-number">16</span>     <span class="hljs-comment">// 写高16位</span>
</code></pre>
<ul>
<li><code>MOV W8, #0x352E31</code>的机器码</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">28</span> C6 <span class="hljs-number">85</span> <span class="hljs-number">52</span> A8 <span class="hljs-number">06</span> A0 <span class="hljs-number">72</span>
</code></pre>
<ul>
<li>
<p>还需要将<code>0x10D82EA7C</code>的<code>STP       X8, X27, [X22]</code>，占一个指令空间，改成<code>STP       X8, X26, [X22]</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA7C                 STP             X8, X27, [X22]
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EA7C                 STP             X8, X26, [X22]
</code></pre>
</li>
<li>
<p>验证</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x300d97610</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302ac6ac0</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302af3760</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302af3420</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302af3b40</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302af2de0</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x302af3d00</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<h4 data-id="heading-30">元素4</h4>
<ul>
<li>
<p>原本<code>0x10D82EAE0</code>的<code>MOV       W8, #0x352E31（1.5）</code>（<strong>占三个指令空间）</strong>，要改成<code>MOV W8, #0x302E32（2.0）</code>（占两个指令空间） + 一个<code>NOP</code>（占一个指令空间）</p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EAE0                 MOV             W8, #<span class="hljs-number">0x352E31</span>
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EAE0                 MOV             W8, #<span class="hljs-number">0x302E32</span>
__text:<span class="hljs-number">000000010</span>D82EAE8                 NOP
</code></pre>
</li>
<li>
<p><code>MOV W8, #0x302E32</code>拆分成</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">MOVZ    W8, #<span class="hljs-number">0x2E32</span>            <span class="hljs-comment">// 写低 16 位</span>
MOVK    W8, #<span class="hljs-number">0x0030</span>, LSL #<span class="hljs-number">16</span>   <span class="hljs-comment">// 写高 16 位</span>
</code></pre>
<ul>
<li><code>MOV W8, #0x302E32</code>的机器码</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">48</span> C6 <span class="hljs-number">85</span> <span class="hljs-number">52</span> <span class="hljs-number">08</span> <span class="hljs-number">06</span> A0 <span class="hljs-number">72</span>
</code></pre>
<ul>
<li><code>NOP</code>的机器码</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">1</span>F <span class="hljs-number">20</span> <span class="hljs-number">03</span> D5
</code></pre>
<ul>
<li>总的机器码</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">48</span> C6 <span class="hljs-number">85</span> <span class="hljs-number">52</span> <span class="hljs-number">08</span> <span class="hljs-number">06</span> A0 <span class="hljs-number">72</span> <span class="hljs-number">1</span>F <span class="hljs-number">20</span> <span class="hljs-number">03</span> D5
</code></pre>
<ul>
<li>验证</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x303fe4f00</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ffe60</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ffe80</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ffa20</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ffb20</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ffb00</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">2.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x3018ff860</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">2.0</span>&gt;
)
</code></pre>
<h4 data-id="heading-31">元素5</h4>
<ul>
<li>
<p>原本<code>0x10D82EB50</code>的<code>ADD       X8, X28, #1（2.0）</code>，占一个指令空间，要改成<code>ADD       X8, X28, #2（3.0）</code></p>
<ul>
<li>修改前</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EB50                 ADD             X8, X28, #<span class="hljs-number">1</span>
</code></pre>
<ul>
<li>修改后</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>D82EB50                 ADD             X8, X28, #<span class="hljs-number">2</span>
</code></pre>
</li>
<li>
<p>验证</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po (<span class="hljs-type">id</span>)$x0
&lt;_TtGCs23_ContiguousArrayStoragePs9AnyObject__$ <span class="hljs-number">0x301eb6f80</span>&gt;(
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393ac20</span>; value = <span class="hljs-number">0.500000</span>; text = <span class="hljs-number">0.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393ac40</span>; value = <span class="hljs-number">1.000000</span>; text = <span class="hljs-number">1.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393ac60</span>; value = <span class="hljs-number">1.250000</span>; text = <span class="hljs-number">1.25</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393ac80</span>; value = <span class="hljs-number">1.500000</span>; text = <span class="hljs-number">1.5</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393aca0</span>; value = <span class="hljs-number">2.000000</span>; text = <span class="hljs-number">2.0</span>&gt;,
&lt;BBPlayerPlayerRateModel: <span class="hljs-number">0x30393acc0</span>; value = <span class="hljs-number">3.000000</span>; text = <span class="hljs-number">3.0</span>&gt;
)
</code></pre>
<h2 data-id="heading-32">效果</h2>
<p>横屏全屏模式下，倍速菜单成功显示并支持 <code>3.0</code> 倍速播放。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2ceb5c3c82b4dfeb8fb8662bc22e2de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448846&amp;x-signature=N%2FnL7W1IThU30EvbshD%2FD4ezMag%3D" alt="Screenshot 2025-12-15 at 10.07.00.png" loading="lazy"/></p>
<h2 data-id="heading-33">总结</h2>
<ul>
<li>横屏全屏场景下，播放倍速列表由 <code>BBPlayerPlaybackRateListWidget</code> 的 <code>rateArray</code> 生成，最终创建函数为 <strong><code>sub_10D82E870</code></strong>。</li>
<li>通过 <strong>越狱 Hook</strong> 或 <strong>非越狱 Mach-O Patch</strong>，即可稳定新增 <code>3.0x</code> 倍速。</li>
</ul>
<h2 data-id="heading-34">代码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTouchFriend%2FBiliBiliMApp" target="_blank" title="https://github.com/TouchFriend/BiliBiliMApp" ref="nofollow noopener noreferrer">BiliBiliMApp-无广告版哔哩哔哩</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让代码学会“等外卖”：JavaScript异步编程趣谈]]></title>    <link>https://juejin.cn/post/7583912637471490099</link>    <guid>https://juejin.cn/post/7583912637471490099</guid>    <pubDate>2025-12-16T01:31:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583912637471490099" data-draft-id="7583952017674059827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让代码学会“等外卖”：JavaScript异步编程趣谈"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T01:31:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_GGbond"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让代码学会“等外卖”：JavaScript异步编程趣谈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_GGbond
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:31:56.000Z" title="Tue Dec 16 2025 01:31:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfR0dib25k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766453516&amp;x-signature=QM2w8%2BOCN1KL3r9utDLEnGcSBQs%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<p>大家好！今天我们来聊聊JavaScript中一个既重要又有趣的话题——异步编程。如果你曾经遇到过网页“卡死”的情况，或者好奇为什么有些操作不会阻塞页面交互，那么这篇文章就是为你准备的！</p>
<h2 data-id="heading-0">同步 vs 异步：点外卖的智慧</h2>
<p>想象一下你要准备一顿晚餐：</p>
<p><strong>同步方式</strong>（不推荐）：</p>
<ol>
<li>走进厨房开始煮饭</li>
<li>站在灶台前盯着锅，什么都不做，直到饭煮好（20分钟）</li>
<li>饭好了才开始洗菜切菜</li>
<li>再花30分钟炒菜</li>
<li>总共耗时：50分钟</li>
</ol>
<p><strong>异步方式</strong>（聪明做法）：</p>
<ol>
<li>开始煮饭（设置定时器）</li>
<li>在饭煮的同时洗菜切菜</li>
<li>饭好了的提示音响起时处理饭</li>
<li>继续炒菜</li>
<li>总共耗时：35分钟</li>
</ol>
<p>JavaScript的异步编程就像是那个聪明的厨师，让多个任务可以同时进行！</p>
<h2 data-id="heading-1">回调函数：JavaScript的“电话通知”</h2>
<p>最早的异步处理方式是回调函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 点外卖的比喻：下单后留下电话号码，外卖到了打电话通知你</span>
<span class="hljs-title function_">orderFood</span>(<span class="hljs-string">'pizza'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`我的<span class="hljs-subst">${pizza}</span>到了！可以开动了！`</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在等外卖的时候，我可以继续刷剧...'</span>);
</code></pre>
<p>但问题来了——如果你需要按顺序做多件事呢？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// “回调地狱”出现了！</span>
<span class="hljs-title function_">orderFood</span>(<span class="hljs-string">'pizza'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>) {
    <span class="hljs-title function_">getDrink</span>(<span class="hljs-string">'cola'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">cola</span>) {
        <span class="hljs-title function_">buyNapkins</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">napkins</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`准备好享用<span class="hljs-subst">${pizza}</span>+<span class="hljs-subst">${cola}</span>了，还有<span class="hljs-subst">${napkins}</span>张餐巾纸`</span>);
            <span class="hljs-comment">// 更多嵌套...</span>
        });
    });
});
</code></pre>
<p>这就像是：等外卖→外卖到了买饮料→饮料到了买纸巾……效率太低了！</p>
<h2 data-id="heading-2">Promise：外卖订单追踪系统</h2>
<p>ES6带来了Promise，就像外卖平台的应用，可以追踪订单状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个Promise就像下一个外卖订单</span>
<span class="hljs-keyword">const</span> foodOrder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 模拟烹饪时间</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.1</span>; <span class="hljs-comment">// 90%的成功率</span>
        success ? <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'香喷喷的披萨'</span>) : <span class="hljs-title function_">reject</span>(<span class="hljs-string">'抱歉，烤箱坏了'</span>);
    }, <span class="hljs-number">2000</span>);
});

<span class="hljs-comment">// 追踪订单状态</span>
foodOrder
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">food</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🎉 <span class="hljs-subst">${food}</span>送达！`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">'吃完了，该收拾了'</span>; <span class="hljs-comment">// 可以继续返回新的Promise</span>
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`😢 <span class="hljs-subst">${error}</span>`</span>);
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这次订餐体验结束了'</span>);
    });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'订单已下，我可以继续工作...'</span>);
</code></pre>
<h2 data-id="heading-3">async/await：像写同步代码一样写异步</h2>
<p>ES7的async/await让异步代码看起来像同步代码一样直观：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">enjoyDinner</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始准备晚餐...'</span>);
        
        <span class="hljs-comment">// 看起来是同步的，但实际上是异步的！</span>
        <span class="hljs-keyword">const</span> pizza = <span class="hljs-keyword">await</span> <span class="hljs-title function_">orderPizza</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${pizza}</span>准备好了`</span>);
        
        <span class="hljs-keyword">const</span> drink = <span class="hljs-keyword">await</span> <span class="hljs-title function_">orderDrink</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${drink}</span>也到了`</span>);
        
        <span class="hljs-comment">// 这两个可以同时进行！</span>
        <span class="hljs-keyword">const</span> [napkins, movie] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
            <span class="hljs-title function_">buyNapkins</span>(),
            <span class="hljs-title function_">loadMovie</span>()
        ]);
        
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`完美！有<span class="hljs-subst">${pizza}</span>、<span class="hljs-subst">${drink}</span>、<span class="hljs-subst">${napkins}</span>和电影<span class="hljs-subst">${movie}</span>`</span>);
        
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`晚餐计划失败：<span class="hljs-subst">${error}</span>`</span>);
    }
}

<span class="hljs-comment">// 模拟的异步函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">orderPizza</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'🍕意大利香肠披萨'</span>), <span class="hljs-number">2000</span>);
    });
}
</code></pre>
<h2 data-id="heading-4">事件循环：JavaScript的“时间管理大师”</h2>
<p>JavaScript是单线程的，但它有一个神奇的事件循环机制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 开始做饭'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 定时器到时间了（饭煮好了）'</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. Promise微任务（尝一下味道）'</span>);
    });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 继续切菜'</span>);

<span class="hljs-comment">// 输出顺序：</span>
<span class="hljs-comment">// 1. 开始做饭</span>
<span class="hljs-comment">// 2. 继续切菜  </span>
<span class="hljs-comment">// 3. Promise微任务（尝一下味道）</span>
<span class="hljs-comment">// 4. 定时器到时间了（饭煮好了）</span>
</code></pre>
<p>简单来说：</p>
<ol>
<li>同步任务立即执行</li>
<li>微任务（Promise）在当前任务结束后立即执行</li>
<li>宏任务（setTimeout）在微任务之后执行</li>
</ol>
<h2 data-id="heading-5">实际应用：有趣的例子</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟一个加载进度指示器</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadContentWithProgress</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> tasks = [
        <span class="hljs-string">'加载用户数据'</span>,
        <span class="hljs-string">'获取朋友圈'</span>,
        <span class="hljs-string">'下载图片'</span>,
        <span class="hljs-string">'初始化聊天'</span>
    ];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tasks.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-comment">// 模拟每个任务的耗时</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> 
            <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span> + <span class="hljs-number">500</span>)
        );
        
        <span class="hljs-keyword">const</span> progress = ((i + <span class="hljs-number">1</span>) / tasks.<span class="hljs-property">length</span>) * <span class="hljs-number">100</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔄 <span class="hljs-subst">${tasks[i]}</span>... 进度：<span class="hljs-subst">${progress.toFixed(<span class="hljs-number">0</span>)}</span>%`</span>);
    }
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 所有内容加载完成！'</span>);
}

<span class="hljs-comment">// 使用Promise.race实现超时控制</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchWithTimeout</span>(<span class="hljs-params">url, timeout = <span class="hljs-number">3000</span></span>) {
    <span class="hljs-keyword">const</span> fetchPromise = <span class="hljs-title function_">fetch</span>(url);
    <span class="hljs-keyword">const</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求超时'</span>)), timeout);
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([fetchPromise, timeoutPromise]);
}
</code></pre>
<h2 data-id="heading-6">异步编程的黄金法则</h2>
<ol>
<li><strong>避免阻塞</strong>：长时间运行的任务要异步化</li>
<li><strong>错误处理</strong>：不要忘记.catch()或try-catch</li>
<li><strong>适度使用</strong>：不是所有东西都需要异步</li>
<li><strong>保持简单</strong>：能用async/await就不用复杂的Promise链</li>
</ol>
<h2 data-id="heading-7">总结</h2>
<p>JavaScript的异步编程就像生活中的多任务处理：我们不会等水烧开时傻站着，而是同时准备其他食材。从回调函数到Promise再到async/await，JavaScript为我们提供了越来越优雅的方式来处理异步操作。</p>
<p>记住，好的异步代码就像一场精心编排的交响乐——每个部分在正确的时间奏响，整体和谐而不混乱。</p>
<p>希望这篇文章让你对JavaScript异步编程有了更直观的理解！现在，试着把你的下一个耗时操作改成异步吧，让你的应用变得更加流畅！</p>
<p><strong>小挑战</strong>：你能用async/await写一个模拟“同时煮面、煎蛋、烤面包”的早餐制作程序吗？在评论区分享你的实现吧！🍳</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BlockLever实战营日志 #7 | 前端UI设计]]></title>    <link>https://juejin.cn/post/7583991680748306459</link>    <guid>https://juejin.cn/post/7583991680748306459</guid>    <pubDate>2025-12-16T01:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583991680748306459" data-draft-id="7583991680748290075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BlockLever实战营日志 #7 | 前端UI设计"/> <meta itemprop="keywords" content="AI编程,web3"/> <meta itemprop="datePublished" content="2025-12-16T01:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Keegan小钢"/> <meta itemprop="url" content="https://juejin.cn/user/1609340750665758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BlockLever实战营日志 #7 | 前端UI设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340750665758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Keegan小钢
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:16:40.000Z" title="Tue Dec 16 2025 01:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是我们研发「<strong>BlockLever</strong>」的第 7 篇实战营研发日志。在前 6 篇中，我们已经完成了从需求、架构、合约开发到集成测试的完整链路：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495403%26idx%3D1%26sn%3D9d79878fd9bd5f4202ff30dfb290e58d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495403&amp;idx=1&amp;sn=9d79878fd9bd5f4202ff30dfb290e58d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #1 | 开营</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495408%26idx%3D1%26sn%3Df13a228d5387e1512da7d07a72741846%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495408&amp;idx=1&amp;sn=f13a228d5387e1512da7d07a72741846&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #2 | 产品需求梳理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495437%26idx%3D1%26sn%3Dd7c07cb65d8d09888038b2b8890647b3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495437&amp;idx=1&amp;sn=d7c07cb65d8d09888038b2b8890647b3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #3 | 合约开发阶段</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495442%26idx%3D1%26sn%3D451f5af91a5ecaeb57ea6835cdc01e22%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495442&amp;idx=1&amp;sn=451f5af91a5ecaeb57ea6835cdc01e22&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #4 | 完成第一个里程碑</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495450%26idx%3D1%26sn%3D4906e694c64f58fcb5e3f7b4cfe1cad5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495450&amp;idx=1&amp;sn=4906e694c64f58fcb5e3f7b4cfe1cad5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #5 | 重新梳理文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_Nnd-bqt8KJFUt6CLZGLYw" target="_blank" title="https://mp.weixin.qq.com/s/_Nnd-bqt8KJFUt6CLZGLYw" ref="nofollow noopener noreferrer">BlockLever实战营日志 #6 | 集成测试</a></li>
</ul>
<p>而这一篇，是我自己也没想到会这么快完成的一步：<strong>前端 UI 设计。</strong></p>
<h2 data-id="heading-0">三个小时，20+ 张高保真 UI</h2>
<p>先说结果。</p>
<p>昨天，在实战营的实际推进过程中，我们只花了 <strong>3 个小时</strong>，就把 BlockLever 的前端 UI 设计基本做完了，一共生成了 <strong>20 多张高保真 UI 设计稿</strong>。</p>
<p>下面是其中一部分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ea2d6d65ad347c8b368bd2ca17c7a78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlZ2Fu5bCP6ZKi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452600&amp;x-signature=ElQw4%2BXZnJQ0HC91dxhoOSPvYXQ%3D" alt="UI-Mobile.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38ea46221094f65a534dc8381c2178e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlZ2Fu5bCP6ZKi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452600&amp;x-signature=1cbXCnPhtRQ9Qrb%2F7DZy%2BbE7MyE%3D" alt="UI-Desktop.png" loading="lazy"/></p>
<p><strong>这些 UI，全都是 AI 生成的。</strong> 没有设计师参与，甚至连“先画线框图”这一步都没有。</p>
<p>说实话，当我第一次把这些页面一张张翻完的时候，心里是有点不真实的。不是那种“爽”，而是那种——<strong>“这是不是有点太顺了？”</strong></p>
<p>因为如果放在以前，这一步至少会拖上好几天。</p>
<h2 data-id="heading-1">一开始，我其实也不知道该用哪个 AI</h2>
<p>很多人可能会以为，我一开始就想好了用什么工具。但真实情况恰恰相反。</p>
<p>一开始，我连「前端 UI 这一步到底要不要单独做」都还在犹豫。</p>
<p>第一期实战营做 <strong>BlockETF</strong> 的时候，我其实是<strong>直接跳过 UI 设计的</strong>：</p>
<ul>
<li>合约写完</li>
<li>核心逻辑跑通</li>
<li>然后直接让 Claude Code 写前端代码</li>
<li>UI 是在实现过程中慢慢修的</li>
</ul>
<p>那套方式的问题也很明显：能用，但不精致，而且后期调整成本很高。</p>
<p>这次 BlockLever 复杂度更高，涉及杠杆、风险、仓位、清算提示，如果 UI 一开始就没想清楚，后面一定会反复推翻。</p>
<p>所以我决定：<strong>这次先把 UI 设计好。</strong></p>
<p>问题是——我当时真的不知道该用哪个 AI。</p>
<h2 data-id="heading-2">v0.dev 的第一次尝试</h2>
<p>我先问了 Claude Code，它给我推荐了几个工具，其中第一个就是 <strong>v0.dev</strong>。</p>
<p>我就顺手试了一下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645930492b204cd6b33d9dffaf672f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2VlZ2Fu5bCP6ZKi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452600&amp;x-signature=echoDhv%2FfAFOmeZO6V2A20TGChk%3D" alt="v0.dev.png" loading="lazy"/></p>
<p>看完之后，我的第一反应其实挺直接的：</p>
<blockquote>
<p>这效果，好像跟我直接用 Claude Code 写前端差不多。</p>
</blockquote>
<p>不是说它不好，而是<strong>它并没有明显拉开差距</strong>。</p>
<p>当时我的判断逻辑也很简单：如果一个工具不能在效率或质量上带来明显提升，那它就不太可能成为我新的工作流核心。</p>
<p>所以 v0.dev 在我这一步，基本就被 pass 了。</p>
<h2 data-id="heading-3">偶然点进 Stitch</h2>
<p>我继续追问 Claude Code，它又提到了 <strong>Galileo AI</strong>。</p>
<p>我点进去之后，发现直接跳转到了 <strong>stitch.withgoogle.com</strong>，这才意识到 Galileo 已经被 Google 收购，整合进 Stitch 了。</p>
<p>再一看说明：<strong>现在还能免费用。</strong></p>
<p>说实话，这种时候不用一下，心理上都有点说不过去。</p>
<p>于是我就随手试了第一轮。</p>
<p>结果也就是从这一刻开始，我意识到：<strong>这次可能真的不一样了。</strong></p>
<h2 data-id="heading-4">真正起作用的，其实不是 Stitch</h2>
<p>但现在回头看，真正起作用的，其实并不是 Stitch 本身。</p>
<p>而是我并没有直接把「帮我设计一个 DeFi App」这种模糊指令丢给它。</p>
<p>我做的事情其实很“实战营式”：</p>
<ul>
<li>先让 <strong>Claude Code</strong> 把 BlockLever 的业务模型拆清楚</li>
<li>把用户是谁、关键操作、风险点一条条捋出来</li>
<li>再让它帮我写<strong>专门喂给 Stitch 的 Prompt</strong></li>
</ul>
<p>比如第一步，我只让 Stitch 干一件事：<strong>先定整体设计风格。</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">Design a modern DeFi trading application called "BlockLever".

Brand concept:
<span class="hljs-bullet">-</span> BlockLever helps everyday crypto investors amplify their returns safely
<span class="hljs-bullet">-</span> The core message is "Trade like spot, but with 2-3x gains"
<span class="hljs-bullet">-</span> Target users are crypto spot traders who want leverage without the complexity of futures

Visual style:
<span class="hljs-bullet">-</span> Dark theme as primary (dark navy or charcoal background)
<span class="hljs-bullet">-</span> Clean and minimal, inspired by apps like Phantom wallet and Uniswap
<span class="hljs-bullet">-</span> Professional but approachable, not intimidating
<span class="hljs-bullet">-</span> Use subtle gradients and glassmorphism effects for cards
<span class="hljs-bullet">-</span> Accent color: Electric blue (#3B82F6)
<span class="hljs-bullet">-</span> Success/profit: Green (#22C55E)
<span class="hljs-bullet">-</span> Loss/danger: Red (#EF4444)
<span class="hljs-bullet">-</span> Warning: Amber (#F59E0B)

Typography:
<span class="hljs-bullet">-</span> Modern sans-serif font (Inter or similar)
<span class="hljs-bullet">-</span> Clear hierarchy with bold headings
<span class="hljs-bullet">-</span> Numbers should be easy to read at a glance

Show me a style guide with:
<span class="hljs-bullet">1.</span> Color palette
<span class="hljs-bullet">2.</span> Sample buttons (primary, secondary, danger)
<span class="hljs-bullet">3.</span> Sample card component
<span class="hljs-bullet">4.</span> Sample input field
<span class="hljs-bullet">5.</span> Risk indicator badges (Safe, Warning, At Risk)
</code></pre>
<p>Stitch 生成了几套风格之后，我并没有立刻拍板，而是全部下载下来，再丢回给 Claude Code 评估。</p>
<p>哪套更符合 BlockLever？哪套在“风险表达”上不容易误导用户？</p>
<p>就这样来回几轮之后，风格才真正定下来。</p>
<h2 data-id="heading-5">两个 AI 来回拉扯，反而省了我时间</h2>
<p>后面的过程，其实就是重复这件事：</p>
<ul>
<li>Claude Code 负责「想清楚」</li>
<li>Stitch 负责「画出来」</li>
<li>再把结果丢回 Claude Code 做判断</li>
</ul>
<p>大部分页面，Stitch 一次就生成对了。不对的页面，主要是切换到桌面版的时候，需要做一些调整。</p>
<p>但整体效率，远远超出了我的预期。</p>
<p>等我回过神来，UI 已经有 20 多张了。</p>
<h2 data-id="heading-6">这件事对实战营来说，意义其实很大</h2>
<p>如果只看结果，好像只是“用 AI 画了 UI”。</p>
<p>但对我来说，这一步真正重要的地方在于：</p>
<blockquote>
<p><strong>它完整复现了实战营一直在做的一件事：把一个模糊的想法，一步步逼成一个可以落地的产品形态。</strong></p>
</blockquote>
<p>整个过程中，并没有什么“神操作”。</p>
<p>更多的是：</p>
<ul>
<li>不确定</li>
<li>尝试</li>
<li>判断</li>
<li>放弃一个选项</li>
<li>再继续往下走</li>
</ul>
<p>而 AI，只是被放在了一个<strong>非常合适的位置上</strong>。</p>
<h2 data-id="heading-7">写在最后</h2>
<p>当这些 UI 摆在我面前的时候，我突然有一种很清晰的感觉：</p>
<blockquote>
<p>BlockLever 不再只是一个协议，而是真的开始像一个产品了。</p>
</blockquote>
<p>接下来，我们就会进入前端实现阶段，把这些页面真正跑起来。</p>
<p>我也会继续用这种「实战营日志」的方式，把整个过程完整记录下来。</p>
<p>如果你正在关注 BlockLever，或者对“AI + 产品实战”这件事本身感兴趣，那接下来的几篇，会越来越具体、也越来越真实。</p>
<hr/>
<p>参考阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495368%26idx%3D1%26sn%3D4634bab0e054169211f3ba8bb194029c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495368&amp;idx=1&amp;sn=4634bab0e054169211f3ba8bb194029c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">第二期 AI+Web3 实战营启动：从 BlockETF 到 BlockLever</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495403%26idx%3D1%26sn%3D9d79878fd9bd5f4202ff30dfb290e58d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495403&amp;idx=1&amp;sn=9d79878fd9bd5f4202ff30dfb290e58d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #1 | 开营</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495408%26idx%3D1%26sn%3Df13a228d5387e1512da7d07a72741846%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495408&amp;idx=1&amp;sn=f13a228d5387e1512da7d07a72741846&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">BlockLever实战营日志 #2 | 产品需求梳理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495413%26idx%3D1%26sn%3D0cdfe0cfc90d3daad0704f57654d1b6d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495413&amp;idx=1&amp;sn=0cdfe0cfc90d3daad0704f57654d1b6d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Web2 不再安全感：技术人如何踏入 AI + Web3 的新时代</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495418%26idx%3D1%26sn%3D52bce10b7461b5b2b41cdbcb46cb9663%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495418&amp;idx=1&amp;sn=52bce10b7461b5b2b41cdbcb46cb9663&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI + Web3 实战营价值分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA5OTI1NDE0Mw%3D%3D%26mid%3D2652495424%26idx%3D1%26sn%3Db6ff0f2cc634faa5a4cc613c616b966b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA5OTI1NDE0Mw==&amp;mid=2652495424&amp;idx=1&amp;sn=b6ff0f2cc634faa5a4cc613c616b966b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从入门到实战：我的全套 Web3 学习路径（2025版）</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让AI的数据标注“火眼金睛”？人机协同才是可靠途径]]></title>    <link>https://juejin.cn/post/7583921477614043171</link>    <guid>https://juejin.cn/post/7583921477614043171</guid>    <pubDate>2025-12-16T01:51:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583921477614043171" data-draft-id="7583903159775248399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让AI的数据标注“火眼金睛”？人机协同才是可靠途径"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-16T01:51:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让AI的数据标注“火眼金睛”？人机协同才是可靠途径
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:51:47.000Z" title="Tue Dec 16 2025 01:51:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>二十年前，要是有人说想买个机器人帮忙做家务，听起来简直像天方夜谭。然而，如今我们正处在人工智能蓬勃发展的时代，机器人已经在类似场景中进行测试了。</p>
<p>推动这一进展的关键人工智能领域是<strong>计算机视觉</strong>，它让机器能够理解图像和视频。换句话说，像YOLO11和即将推出的YOLO26这样的计算机视觉模型，可以通过包含视觉数据和标注的数据集进行训练。</p>
<p>这些标注帮助模型理解视觉数据。例如，目标检测数据集使用<strong>边界框</strong>在感兴趣的目标周围绘制矩形框。这使得模型能够在新的图像中检测并定位这些目标，即使场景杂乱或目标被部分遮挡也没问题。</p>
<p>其他计算机视觉任务则依赖于不同类型的标注。<strong>分割数据集</strong>在像素级别精确标记出目标的轮廓，而<strong>关键点数据集</strong>则会标出特定的标志点，比如人体关节。</p>
<p>然而，无论采用哪种格式，一个关键因素始终是<strong>标注的质量和一致性</strong>。模型直接从用于训练的数据中学习，因此，如果标注不一致或有错误，模型通常也会在预测中继承这些错误。</p>
<p>即使在自动化的今天，<strong>人工标注的数据集</strong>仍然至关重要，尤其是在像医疗影像这样的高风险领域。微小的标注错误，比如不精确的肿瘤边界或遗漏的异常，都可能教会模型错误的模式，导致后续做出不安全的预测。人类专家提供了这些应用所需的精确真实标注和判断力。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a0bada7cce34a26983c533494dfa0b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=HebNUC3tVk39eRC3jzcyVP4jawE%3D" alt="screenshot_2025-12-15_14-19-03.png" loading="lazy"/></p>
<p>在本文中，我们将深入探讨，即使在人工智能不断进步的今天，为什么人工标注数据仍然不可或缺。</p>
<h2 data-id="heading-0"><strong>图像与视频标注的必要性</strong></h2>
<p>计算机视觉模型的学习方式与我们人类相似，通过观察大量示例进行学习。不同之处在于，它们是通过预先由人类标注的大型图像和视频数据集进行训练的。这些标注作为真实标准，教会模型诸如“这是行人”、“这是肿瘤的边界”或“那个物体是汽车”等概念。</p>
<p>现实世界的视觉信息很少是干净或一致的。光线变化会使同一物体看起来不同。人和车辆可能重叠或被部分遮挡。背景可能杂乱且分散注意力。当数据集包含了针对这些情况精心制作、保持一致的标注时，模型就能为在受控环境之外将遇到的挑战做好更充分的准备。</p>
<p>数据标注不仅仅是画框或描边。它涉及应用标注规范、做出实际判断，例如什么算作目标、边界应该划在哪里，以及在情况不明时如何处理。这种人类的判断力确保了数据的准确性和可用性。</p>
<p>归根结底，一个计算机视觉系统的表现，取决于它所学习的标注数据的质量。在像扫描图像中识别癌症或为自动驾驶汽车检测道路危险等高影响应用中，来自熟练标注员的精确标注，对于提高准确性和安全性具有实际意义。</p>
<h2 data-id="heading-1"><strong>数据标注自动化的兴起</strong></h2>
<p>随着计算机视觉应用规模的扩大和数据集的增长，自动化已成为加速标注的常用手段。团队不再手工标注所有内容，而是使用人工智能模型来生成标注的初稿。</p>
<p>随后，由人工审查结果、修正错误，并处理模型无法以高置信度标注的情况。这种方法在保持高质量的同时，加快了标注速度。</p>
<p>以下是自动化通常帮助数据标注的几种方式：</p>
<ul>
<li><strong>自动分割：</strong> 模型可以自动建议目标轮廓或像素级掩码，减少标注员需要手动勾勒的工作量。</li>
<li><strong>光流跟踪：</strong> 对于视频，跟踪方法可以跨帧追踪运动物体，并将其标签向前传递，有助于保持标注在时间上的一致性。</li>
<li><strong>帧插值：</strong> 工具可以利用运动和跟踪线索，为两个已标注帧之间的帧填充标注，这样标注员就不必标注每一帧。</li>
<li><strong>主动学习：</strong> 训练流程可以识别出模型认为不确定或特殊的样本，并优先提交给人类处理，从而使人工精力集中在最能提升模型性能的数据上。</li>
</ul>
<h2 data-id="heading-2"><strong>为何人工数据标注依然至关重要？</strong></h2>
<p>尽管自动化可以加快标注速度，但人工智能模型仍然需要人类的判断力来保持准确和可靠。</p>
<p>以下是一些人类专业知识在数据标注中发挥关键作用的领域：</p>
<ul>
<li><strong>理解上下文：</strong> 真实的图像和视频通常很杂乱。阴影、反射、运动模糊和物体重叠都可能干扰自动化工具。人类标注员能够解释实际发生的情况，从而使标注更准确。</li>
<li><strong>保持标注一致性：</strong> 随着数据集的扩大，自动生成的标注可能会出现漂移或在批次间产生差异。人类可以审核、修正和对齐标注，确保数据集从头到尾保持一致。</li>
<li><strong>减少偏见和危害：</strong> 人类更擅长识别敏感内容、文化细微差别以及可能引入偏见的模式。他们的监督有助于使数据集更公平，避免 unintended 伤害。</li>
<li><strong>应用领域专业知识：</strong> 某些任务需要领域知识，例如识别医疗异常或工业缺陷。专家可以提供精确的标注并解决模糊不清的情况，确保模型学到正确的细节。</li>
</ul>
<h2 data-id="heading-3"><strong>人机协作标注概览</strong></h2>
<p>许多标注工具和平台，通过集成自动化来加速标注，通常利用如 Segment Anything Model 3（SAM3）等基础模型。</p>
<p>它可以根据简单的提示（如点击、边界框或简短的文本短语），在图像和视频中检测、分割和跟踪物体，为匹配的物体生成分割掩码，而无需为每个新类别进行特定任务的训练。</p>
<p>即使采用了这些前沿方法，仍然需要人类专家来审查和最终确定标注。当自动化工具生成初稿，然后由人工进行验证、修正和细化时，这种工作流程被称为人机协作标注。这使得标注速度得以加快，同时确保最终标注足够准确和一致，可用于训练可靠的模型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/238ed8f4297c43bd8ab8aa74ce928743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=wfaFlYTFYo0qi7A7Ga8oHQd7xYc%3D" alt="screenshot_2025-12-15_14-19-39.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>自动化标注何时有效，何时无效？</strong></h2>
<p>自动化标注最适合来自受控环境的数据。在工厂、仓库或零售货架等场所收集的图像，通常光线稳定、物体视角清晰，因此自动化工具可以准确标注它们，帮助团队以更少的人工工作更快地扩大规模。</p>
<p>来自非受控环境的数据则更为复杂。室外视频会随时间和天气变化，来自街道或家庭的场景通常包含杂乱、运动模糊、物体相互遮挡和大量重叠。小物体、精细边界或罕见情况更增加了出错的可能性。在干净的室内数据上表现良好的模型，在处理混乱的现实世界视觉信息时可能仍然会力不从心。</p>
<p>这就是为什么人类介入仍然重要。当模型不确定时，人类可以介入；他们能解读棘手的上下文，并在错误进入最终数据集之前予以修正。人机协作标注有助于使自动化立足于现实世界条件，并确保模型在部署后保持可靠。</p>
<h2 data-id="heading-5"><strong>人机协作标注在哪些领域能发挥重要作用？</strong></h2>
<p>既然我们已经了解了自动化标注的适用场景和局限，接下来让我们探讨几个人机协作标注扮演重要角色的应用领域。</p>
<ul>
<li><strong>制造业缺陷检测</strong></li>
</ul>
<p>想象一下工厂的传送带，每分钟有数百个零件从摄像头下经过。大多数缺陷是明显的，但偶尔会出现一个以奇怪角度出现或在灯光反射下的细微裂纹。自动化系统可能会忽略它，或将其标记为无害的表面纹理，但人工审核员可以发现这个缺陷，修正标注，并确保模型学会区分。</p>
<p>这就是人机协作标注在工业检测中的角色。自动化可以预标注常见缺陷类型，并快速处理大量图像，但仍然需要人工来验证结果、收紧边界，并处理那些在训练中不常见的罕见故障情况。</p>
<ul>
<li><strong>自动驾驶与智能交通</strong></li>
</ul>
<p>同样，自动驾驶汽车使用计算机视觉来识别行人、读取标志和导航交通，但真实道路是不可预测的。例如，夜间从停放的车辆后面走出的行人，可能部分被遮挡，在强光下也难以看清。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5228873566b41feac47eec9f9a81f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=hO2xbHa74d3%2FHTHumUC1JkkyIao%3D" alt="screenshot_2025-12-15_14-19-50.png" loading="lazy"/></p>
<p>人类标注员可以在训练阶段标注这些罕见但安全攸关的边缘情况，使模型学会正确的应对方式，而不仅仅是在正常条件下。对于教会系统处理那些难以用自动化单独捕捉的低频事件，这一人机协作步骤至关重要。</p>
<h2 data-id="heading-6"><strong>人工标注数据集的未来之路</strong></h2>
<p>随着技术进步，人机协作标注正变得更加协同。有趣的是，视觉语言模型 现在正被用于生成标注初稿，并根据简单提示建议修正。</p>
<p>因此，标注员无需手动扫描每张图像来决定标注什么，而是可以用诸如“标注所有行人、汽车和交通灯”或“分割这个零件上的所有缺陷”这样的短语来提示VLM，并获得一组待审阅的标注草稿。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5127bc6a107b4b2c9c66af1167fa2533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=kH5oIwQeiTlL3HGVL3lE6nlity4%3D" alt="screenshot_2025-12-15_14-19-58.png" loading="lazy"/></p>
<p>这减少了标注时间，因为模型可以预先处理许多简单直接的情况，使人类能够专注于审查结果、修正棘手案例，并保持数据集的一致性。大型多模态模型也开始引导标注员关注最不确定的样本，使人工工作更具针对性，并提高整体数据集质量。</p>
<p>值得一提的是，高效的人机协作和数据管理离不开专业的平台支持。<strong>Coovally</strong>作为国际领先的人工智能开源算法平台，不仅提供强大的算法库，其内置的数据管理工具和自动化标注辅助功能，正可以帮助团队轻松实现上述高效协同的标注流程。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64fcac30fb744dd78279e94e549b5106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=2thLRQnJ3HmatN5Rh%2B54lg%2Bxrrc%3D" alt="IMG_3565.GIF" loading="lazy"/></p>
<p>从数据上传、版本管理、智能预标注到团队协作审核，Coovally 提供了一站式解决方案，助力开发者更快地构建和迭代高质量的计算机视觉模型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ca8973ac0040a08eecd4792e15e0f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=q7%2FKHRJpHL8QiqLd0gOYiAConZA%3D" alt="IMG_3566.GIF" loading="lazy"/></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/652536f82de344819e4d750438a5fc6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454707&amp;x-signature=peGdRA17vfJJJMRiCp5Sh60eEQQ%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<h2 data-id="heading-7"><strong>总结</strong></h2>
<p>计算机视觉帮助机器解读并响应其所见，但当它与人机协作时，才能发挥最佳效果。人工标注数据使模型立足于现实世界条件，并提高了其性能的可靠性。通过自动化与人类判断力协同工作，团队可以构建出有影响力的视觉系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cloudflare 🌏 中国大陆网络访问优化 - ０元成本]]></title>    <link>https://juejin.cn/post/7583933107689570367</link>    <guid>https://juejin.cn/post/7583933107689570367</guid>    <pubDate>2025-12-16T01:21:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583933107689570367" data-draft-id="7583910637958840339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cloudflare 🌏 中国大陆网络访问优化 - ０元成本"/> <meta itemprop="keywords" content="设计模式,React.js,人工智能"/> <meta itemprop="datePublished" content="2025-12-16T01:21:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月丶"/> <meta itemprop="url" content="https://juejin.cn/user/3685218705751325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cloudflare 🌏 中国大陆网络访问优化 - ０元成本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218705751325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:21:51.000Z" title="Tue Dec 16 2025 01:21:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>版本</strong>: 2.0<br/>
<strong>最后更新</strong>: 2025-12-15<br/>
<strong>状态</strong>: ✅ 已实战验证可用<br/>
<strong>架构</strong>: Oracle Cloud (Japan) + Nginx 反向代理 + Cloudflare Workers (SNI Proxy)</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 背景与目标</h2>
<h3 data-id="heading-1">问题描述</h3>
<p>Cloudflare 的免费版 CDN 节点在针对中国大陆访问时，通常会绕路美国西海岸或欧洲，导致：</p>
<ul>
<li>高延迟（200ms+）</li>
<li>连接不稳定</li>
<li>易丢包</li>
</ul>
<h3 data-id="heading-2">解决方案</h3>
<p>利用地理位置靠近中国大陆、且国际出口带宽较好的 <strong>Oracle Cloud Japan (甲骨文日本)</strong> 服务器作为"中转跳板"，通过 Nginx 反向代理将流量转发至 <strong>Cloudflare Workers</strong>，从而实现更快的访问速度。</p>
<h3 data-id="heading-3">流量对比</h3>
<p><strong>优化前 (常规模式)</strong>:</p>
<pre><code class="hljs language-rust" lang="rust">用户 (大陆) 🐢 -<span class="hljs-punctuation">-&gt;</span> 太平洋海底光缆 -<span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">Cloudflare</span> (美国) -<span class="hljs-punctuation">-&gt;</span> Workers
延迟高，易丢包，体验差
</code></pre>
<p><strong>优化后 (本方案)</strong>:</p>
<pre><code class="hljs language-rust" lang="rust">用户 (大陆) 🚀 -<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">50</span>-<span class="hljs-number">100</span>ms -<span class="hljs-punctuation">-&gt;</span> Oracle <span class="hljs-title function_ invoke__">VPS</span> (日本) ⚡️ -<span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">5</span>ms -<span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">Cloudflare</span> (日本边缘) -<span class="hljs-punctuation">-&gt;</span> Workers
利用 VPS 的优质线路中转，大幅降低物理延迟
</code></pre>
<hr/>
<h2 data-id="heading-4">2. 整体架构</h2>
<h3 data-id="heading-5">2.1 架构图</h3>
<pre><code class="hljs language-javascript" lang="javascript">用户
 └─ star.<span class="hljs-property">divinations</span>.<span class="hljs-property">top</span>        （灰云 <span class="hljs-variable constant_">DNS</span> only → <span class="hljs-variable constant_">VPS</span>）
     └─ <span class="hljs-title class_">Nginx</span> 反向代理（<span class="hljs-variable constant_">SNI</span> <span class="hljs-title class_">Proxy</span>）
         └─ star-origin.<span class="hljs-property">divinations</span>.<span class="hljs-property">top</span>      （橙云 → <span class="hljs-title class_">Cloudflare</span> <span class="hljs-title class_">Worker</span> / <span class="hljs-title class_">Web</span>）

用户
 └─ star-api.<span class="hljs-property">divinations</span>.<span class="hljs-property">top</span>    （灰云 <span class="hljs-variable constant_">DNS</span> only → <span class="hljs-variable constant_">VPS</span>）
     └─ <span class="hljs-title class_">Nginx</span> 反向代理（<span class="hljs-variable constant_">SNI</span> <span class="hljs-title class_">Proxy</span>）
         └─ star-api-origin.<span class="hljs-property">divinations</span>.<span class="hljs-property">top</span>  （橙云 → <span class="hljs-title class_">Cloudflare</span> <span class="hljs-title class_">Worker</span> / <span class="hljs-variable constant_">API</span>）
</code></pre>
<h3 data-id="heading-6">2.2 🔒 架构铁律（必须遵守）</h3>





























<table><thead><tr><th>规则</th><th>说明</th></tr></thead><tbody><tr><td>✅ 入口域名永远是 <strong>DNS only（灰云）</strong></td><td>star / star-api 必须灰云，用户直连 VPS</td></tr><tr><td>✅ origin 域名永远是 <strong>Proxied（橙云）</strong></td><td>仅供 Nginx 后端使用，用户不可直接访问</td></tr><tr><td>❌ 用户请求永远不能被重定向到 origin 域名</td><td>否则触发 Cloudflare Error 1000</td></tr><tr><td>❌ 禁止入口域名开启橙云</td><td>否则直接 1000 错误</td></tr><tr><td>❌ 禁止 <code>star → CNAME → star-origin</code></td><td>Cloudflare 会判定为非法代理</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">3. 准备工作</h2>
<h3 data-id="heading-8">3.1 服务器要求</h3>

























<table><thead><tr><th>项目</th><th>要求</th></tr></thead><tbody><tr><td>云服务商</td><td>Oracle Cloud (日本/韩国/香港等亚太节点)</td></tr><tr><td>操作系统</td><td>Ubuntu 20.04/22.04 LTS</td></tr><tr><td>端口</td><td>80, 443 必须开放</td></tr><tr><td>网络</td><td>确保服务器能正常访问 Cloudflare (1.1.1.1)</td></tr></tbody></table>
<h3 data-id="heading-9">3.2 域名规划</h3>






























<table><thead><tr><th>域名</th><th>用途</th><th>代理状态</th></tr></thead><tbody><tr><td><code>star.divinations.top</code></td><td>Web 主站入口</td><td>DNS only (灰云)</td></tr><tr><td><code>star-api.divinations.top</code></td><td>API 入口</td><td>DNS only (灰云)</td></tr><tr><td><code>star-origin.divinations.top</code></td><td>Web Workers 源站</td><td>Proxied (橙云)</td></tr><tr><td><code>star-api-origin.divinations.top</code></td><td>API Workers 源站</td><td>Proxied (橙云)</td></tr></tbody></table>
<h3 data-id="heading-10">3.3 软件依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新系统</span>
sudo apt update &amp;&amp; sudo apt upgrade -y

<span class="hljs-comment"># 安装必要软件</span>
sudo apt install -y nginx certbot python3-certbot-nginx curl dnsutils
</code></pre>
<hr/>
<h2 data-id="heading-11">4. 详细实施步骤</h2>
<h3 data-id="heading-12">第一步：Cloudflare DNS 设置 ⭐ 关键</h3>
<p>在 Cloudflare 后台 DNS 设置中，<strong>必须严格区分"直连"和"代理"状态</strong>。</p>








































<table><thead><tr><th>域名</th><th>类型</th><th>指向目标</th><th>代理状态</th><th>说明</th></tr></thead><tbody><tr><td><code>star</code></td><td>A</td><td><strong>Oracle 服务器 IP</strong></td><td><strong>DNS only (灰色云)</strong> ☁️</td><td><strong>关键</strong>：必须关闭 CF 代理</td></tr><tr><td><code>star-api</code></td><td>A</td><td><strong>Oracle 服务器 IP</strong></td><td><strong>DNS only (灰色云)</strong> ☁️</td><td>同上</td></tr><tr><td><code>star-origin</code></td><td>CNAME</td><td><code>*.workers.dev</code></td><td><strong>Proxied (橙色云)</strong> 🟠</td><td>Workers 必须开启代理</td></tr><tr><td><code>star-api-origin</code></td><td>CNAME</td><td><code>*.workers.dev</code></td><td><strong>Proxied (橙色云)</strong> 🟠</td><td>同上</td></tr></tbody></table>
<p><strong>⚠️ 注意事项</strong>：</p>
<ul>
<li>入口域名（star / star-api）<strong>禁止开启橙云</strong></li>
<li><strong>禁止</strong>设置 <code>star → CNAME → star-origin</code></li>
<li>如存在 <code>AAAA star</code> IPv6 记录，需确认 IPv6 可用，否则删除</li>
</ul>
<p><strong>验证 DNS 设置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证入口域名指向 VPS IP</span>
dig +short star.divinations.top @1.1.1.1
<span class="hljs-comment"># 应该返回你的 VPS IP 地址</span>

<span class="hljs-comment"># 验证 origin 域名指向 Cloudflare</span>
dig +short star-origin.divinations.top @1.1.1.1
<span class="hljs-comment"># 应该返回 Cloudflare 的 IP 地址</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">第二步：服务器防火墙设置</h3>
<p>在申请证书和部署 Nginx 前，<strong>必须确保端口开放</strong>。</p>
<h4 data-id="heading-14">2.1 Oracle 云控制台 (网页端)</h4>
<ol>
<li>登录 Oracle Cloud Console</li>
<li>进入 <code>Networking</code> → <code>Virtual Cloud Networks</code> → 选择你的 VCN</li>
<li>点击 <code>Security Lists</code> → 选择默认安全列表</li>
<li>添加入站规则 (Ingress Rules)：</li>
</ol>























<table><thead><tr><th>源 CIDR</th><th>协议</th><th>目标端口</th><th>说明</th></tr></thead><tbody><tr><td>0.0.0.0/0</td><td>TCP</td><td>80</td><td>HTTP</td></tr><tr><td>0.0.0.0/0</td><td>TCP</td><td>443</td><td>HTTPS</td></tr></tbody></table>
<h4 data-id="heading-15">2.2 服务器内部防火墙 (SSH)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：如果使用 UFW</span>
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload
sudo ufw status

<span class="hljs-comment"># 方式二：如果使用 iptables (Oracle Ubuntu 默认)</span>
<span class="hljs-comment"># 查看当前规则</span>
sudo iptables -L -n

<span class="hljs-comment"># 添加规则</span>
sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT

<span class="hljs-comment"># 持久化规则</span>
sudo apt install iptables-persistent
sudo netfilter-persistent save

<span class="hljs-comment"># 或者直接清空所有规则（简单粗暴，仅测试用）</span>
<span class="hljs-comment"># sudo iptables -F</span>
</code></pre>
<p><strong>验证端口开放</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地测试</span>
nc -zv localhost 80
nc -zv localhost 443

<span class="hljs-comment"># 外部测试（从另一台机器）</span>
nc -zv &lt;VPS_IP&gt; 80
nc -zv &lt;VPS_IP&gt; 443
</code></pre>
<hr/>
<h3 data-id="heading-16">第三步：申请 SSL 证书</h3>
<p>由于入口域名设置为"DNS only (灰云)"，浏览器会直接校验 Oracle 服务器上的证书，<strong>必须使用受信任的证书</strong>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保 Nginx 已启动（Certbot 需要验证）</span>
sudo systemctl start nginx

<span class="hljs-comment"># 2. 申请证书 - Web 站</span>
sudo certbot --nginx -d star.divinations.top

<span class="hljs-comment"># 3. 申请证书 - API 站（单独证书，避免 SAN 问题）</span>
sudo certbot --nginx -d star-api.divinations.top

<span class="hljs-comment"># 4. 验证证书</span>
sudo certbot certificates
</code></pre>
<p><strong>⚠️ 证书申请前检查清单</strong>：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Cloudflare DNS 已设置为灰云</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 防火墙 80/443 端口已开放</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Nginx 已启动且 80 端口可访问</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 域名已正确解析到 VPS IP</li>
</ul>
<p><strong>证书续期测试</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sudo certbot renew --dry-run
</code></pre>
<hr/>
<h3 data-id="heading-17">第四步：Nginx 配置 ⭐ 核心</h3>
<h4 data-id="heading-18">4.1 Web 入口配置</h4>
<p><strong>文件路径</strong>: <code>/etc/nginx/sites-available/star.divinations.top</code></p>
<pre><code class="hljs language-nginx" lang="nginx"># HTTP 强制跳转 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name star.divinations.top;
    return 301 https://$host$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name star.divinations.top;

    # SSL 证书（Certbot 自动配置）
    ssl_certificate /etc/letsencrypt/live/star.divinations.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/star.divinations.top/privkey.pem;
    
    # SSL 优化设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
        # ⭐ 关键：动态 DNS 解析（必须配置）
        resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;
        resolver_timeout 5s;

        # 调试 Header（可选，生产环境可删除）
        add_header X-Star-Proxy "vps-nginx" always;

        # 转发目标：指向 Workers 的源域名
        proxy_pass https://star-origin.divinations.top;

        # ⭐ 核心：SNI 设置（必须开启，否则 CF 握手失败）
        proxy_ssl_server_name on;
        proxy_ssl_name star-origin.divinations.top;
        
        # 传递 Host 头
        proxy_set_header Host star-origin.divinations.top;

        # 传递用户真实 IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # 超时设置
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 长连接优化
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
</code></pre>
<h4 data-id="heading-19">4.2 API 入口配置</h4>
<p><strong>文件路径</strong>: <code>/etc/nginx/sites-available/star-api.divinations.top</code></p>
<pre><code class="hljs language-nginx" lang="nginx"># HTTP 强制跳转 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name star-api.divinations.top;
    return 301 https://$host$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name star-api.divinations.top;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/star-api.divinations.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/star-api.divinations.top/privkey.pem;
    
    # SSL 优化设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
        # ⭐ 关键：动态 DNS 解析
        resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;
        resolver_timeout 5s;

        # 调试 Header
        add_header X-Star-Proxy "vps-nginx-api" always;

        # 转发目标
        proxy_pass https://star-api-origin.divinations.top;

        # ⭐ 核心：SNI 设置
        proxy_ssl_server_name on;
        proxy_ssl_name star-api-origin.divinations.top;
        
        # 传递 Host 头
        proxy_set_header Host star-api-origin.divinations.top;

        # 传递用户真实 IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # 超时设置
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # 长连接优化
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
</code></pre>
<h4 data-id="heading-20">4.3 启用配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建软链接</span>
sudo <span class="hljs-built_in">ln</span> -sf /etc/nginx/sites-available/star.divinations.top /etc/nginx/sites-enabled/
sudo <span class="hljs-built_in">ln</span> -sf /etc/nginx/sites-available/star-api.divinations.top /etc/nginx/sites-enabled/

<span class="hljs-comment"># 删除默认配置（可选）</span>
sudo <span class="hljs-built_in">rm</span> -f /etc/nginx/sites-enabled/default

<span class="hljs-comment"># 检查语法</span>
sudo nginx -t

<span class="hljs-comment"># 重新加载配置</span>
sudo systemctl reload nginx
</code></pre>
<h4 data-id="heading-21">4.4 🚫 Nginx 配置禁止事项</h4>

























<table><thead><tr><th>禁止项</th><th>原因</th></tr></thead><tbody><tr><td><code>proxy_set_header CF-Connecting-IP ...</code></td><td>伪造 CF 专用 Header 会触发 403</td></tr><tr><td>入口域名 301/302 到 origin</td><td>会触发 Error 1000</td></tr><tr><td>WebSocket Header 无条件开启</td><td>普通 HTTP 被强制 upgrade 会出错</td></tr><tr><td>proxy_pass 不配 resolver</td><td>DNS 只解析一次，后续可能失效</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-22">第五步：Cloudflare Worker 配置</h3>
<h4 data-id="heading-23">5.1 Worker 使用规范</h4>
<ul>
<li>Worker 只负责业务逻辑</li>
<li><strong>不依赖</strong> <code>CF-Connecting-IP</code>（该 Header 由 Cloudflare 自动注入，VPS 无法伪造）</li>
<li>使用 <code>X-Forwarded-For</code> / <code>X-Real-IP</code> 获取真实用户 IP</li>
<li>如需防止直连 origin，可校验 Nginx 注入的自定义 Header</li>
</ul>
<h4 data-id="heading-24">5.2 Worker 获取真实 IP 示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 Worker 中获取真实用户 IP</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getClientIP</span>(<span class="hljs-params">request: Request</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-comment">// 优先使用 Nginx 传递的 Header</span>
  <span class="hljs-keyword">const</span> xRealIP = request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'X-Real-IP'</span>);
  <span class="hljs-keyword">if</span> (xRealIP) <span class="hljs-keyword">return</span> xRealIP;
  
  <span class="hljs-keyword">const</span> xForwardedFor = request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'X-Forwarded-For'</span>);
  <span class="hljs-keyword">if</span> (xForwardedFor) {
    <span class="hljs-keyword">return</span> xForwardedFor.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>();
  }
  
  <span class="hljs-comment">// 最后使用 Cloudflare 的 Header（直连 Workers 时有效）</span>
  <span class="hljs-keyword">return</span> request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'CF-Connecting-IP'</span>) || <span class="hljs-string">'unknown'</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-25">5. 验证与测试</h2>
<h3 data-id="heading-26">5.1 DNS 验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证入口域名</span>
dig +short star.divinations.top @1.1.1.1
<span class="hljs-comment"># 应返回 VPS IP</span>

<span class="hljs-comment"># 验证 origin 域名</span>
dig +short star-origin.divinations.top @1.1.1.1
<span class="hljs-comment"># 应返回 Cloudflare IP</span>
</code></pre>
<h3 data-id="heading-27">5.2 HTTP 验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试 Web 入口</span>
curl -I https://star.divinations.top

<span class="hljs-comment"># 测试 API 入口</span>
curl -I https://star-api.divinations.top

<span class="hljs-comment"># 测试 origin（仅测试用）</span>
curl -I https://star-origin.divinations.top
</code></pre>
<h3 data-id="heading-28">5.3 预期响应</h3>
<p>正常情况下应该看到：</p>
<ul>
<li>HTTP/2 200</li>
<li>响应头包含 <code>X-Star-Proxy: vps-nginx</code></li>
<li>无 403/502/521/522/1000 错误</li>
</ul>
<h3 data-id="heading-29">5.4 延迟测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从大陆服务器测试</span>
curl -w <span class="hljs-string">"@-"</span> -o /dev/null -s https://star.divinations.top &lt;&lt;<span class="hljs-string">'EOF'</span>
    time_namelookup:  %{time_namelookup}s\n
       time_connect:  %{time_connect}s\n
    time_appconnect:  %{time_appconnect}s\n
   time_pretransfer:  %{time_pretransfer}s\n
      time_redirect:  %{time_redirect}s\n
 time_starttransfer:  %{time_starttransfer}s\n
                    ----------\n
         time_total:  %{time_total}s\n
EOF
</code></pre>
<hr/>
<h2 data-id="heading-30">6. 维护指南</h2>
<h3 data-id="heading-31">6.1 证书续期</h3>
<p>Certbot 会自动添加定时任务，但建议定期检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试续期</span>
sudo certbot renew --dry-run

<span class="hljs-comment"># 查看定时任务</span>
sudo systemctl list-timers | grep certbot

<span class="hljs-comment"># 手动续期（如需要）</span>
sudo certbot renew
</code></pre>
<h3 data-id="heading-32">6.2 Nginx 日志</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看访问日志</span>
sudo <span class="hljs-built_in">tail</span> -f /var/log/nginx/access.log

<span class="hljs-comment"># 查看错误日志</span>
sudo <span class="hljs-built_in">tail</span> -f /var/log/nginx/error.log
</code></pre>
<h3 data-id="heading-33">6.3 Nginx 管理命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查配置语法</span>
sudo nginx -t

<span class="hljs-comment"># 重新加载配置（不中断服务）</span>
sudo systemctl reload nginx

<span class="hljs-comment"># 重启 Nginx</span>
sudo systemctl restart nginx

<span class="hljs-comment"># 查看状态</span>
sudo systemctl status nginx
</code></pre>
<hr/>
<h2 data-id="heading-34">7. ⚠️ 实战踩坑记录（必读）</h2>
<p>以下是实际部署过程中遇到的坑，请务必避免！</p>
<h3 data-id="heading-35">7.1 入口域名误开启橙云 → Error 1000</h3>
<p><strong>现象</strong>：访问入口域名直接报 Cloudflare Error 1000</p>
<p><strong>原因</strong>：入口域名被 Cloudflare 代理，指向 VPS → Cloudflare 判定为非法</p>
<p><strong>解决</strong>：入口域名（star / star-api）<strong>永远设置为灰云 (DNS only)</strong></p>
<hr/>
<h3 data-id="heading-36">7.2 入口域名跳转到 origin → Error 1000</h3>
<p><strong>错误配置</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx"># ❌ 错误！不要这样做
server {
    server_name star.divinations.top;
    return 301 https://star-origin.divinations.top$request_uri;
}
</code></pre>
<p><strong>原因</strong>：Cloudflare 判定为非法代理跳转</p>
<p><strong>解决</strong>：origin 域名<strong>只给后端使用</strong>，用户请求永远不要重定向到 origin</p>
<hr/>
<h3 data-id="heading-37">7.3 伪造 CF-Connecting-IP → 403</h3>
<p><strong>错误配置</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx"># ❌ 错误！不要这样做
proxy_set_header CF-Connecting-IP $remote_addr;
</code></pre>
<p><strong>原因</strong>：CF-Connecting-IP 是 Cloudflare 专用 Header，伪造会被识别并拒绝</p>
<p><strong>解决</strong>：<strong>永远不要手动设置 CF-Connecting-IP</strong>，使用 X-Real-IP 代替</p>
<hr/>
<h3 data-id="heading-38">7.4 proxy_pass 无 resolver → DNS 玄学</h3>
<p><strong>现象</strong>：Nginx 运行一段时间后 502，重启后恢复</p>
<p><strong>原因</strong>：Nginx 启动时只解析一次域名并缓存，Cloudflare IP 变化后无法更新</p>
<p><strong>解决</strong>：<strong>必须配置 resolver</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;
resolver_timeout 5s;
</code></pre>
<hr/>
<h3 data-id="heading-39">7.5 Worker 域名在部分 DNS 下不可解析</h3>
<p><strong>现象</strong>：某些企业 DNS 返回 NXDOMAIN</p>
<p><strong>原因</strong>：Workers 绑定域的 DNS 记录可能有兼容性问题</p>
<p><strong>解决</strong>：统一使用 *<em>CNAME → <em>.workers.dev</em></em></p>
<hr/>
<h3 data-id="heading-40">7.6 WebSocket Header 滥用</h3>
<p><strong>错误配置</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx"># ❌ 错误！不要无条件开启
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
</code></pre>
<p><strong>原因</strong>：普通 HTTP 请求被强制 upgrade 会出错</p>
<p><strong>解决</strong>：如果不用 WebSocket 就删除这些配置；如果需要，使用 map 条件判断</p>
<hr/>
<h3 data-id="heading-41">7.7 证书 SAN 未覆盖 API 域名</h3>
<p><strong>现象</strong>：API 域名 SSL 握手失败</p>
<p><strong>原因</strong>：API 域复用 Web 证书，但 SAN (Subject Alternative Name) 不包含 API 域</p>
<p><strong>解决</strong>：为 API 单独申请证书，或确认 SAN 包含所有域名</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看证书包含的域名</span>
openssl x509 -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/star.divinations.top/fullchain.pem -text | grep -A1 <span class="hljs-string">"Subject Alternative Name"</span>
</code></pre>
<hr/>
<h3 data-id="heading-42">7.8 Oracle 防火墙未配置</h3>
<p><strong>现象</strong>：外部无法访问 80/443 端口</p>
<p><strong>原因</strong>：Oracle Cloud 有两层防火墙 - 云控制台 Security List + 服务器内部 iptables</p>
<p><strong>解决</strong>：两层都要配置！参见第二步</p>
<hr/>
<h3 data-id="heading-43">7.9 Nginx SSL 证书路径错误</h3>
<p><strong>现象</strong>：Nginx 启动失败，报证书文件不存在</p>
<p><strong>原因</strong>：Certbot 证书路径和配置中的路径不一致</p>
<p><strong>解决</strong>：确认证书实际路径</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">ls</span> -la /etc/letsencrypt/live/
</code></pre>
<hr/>
<h2 data-id="heading-44">8. 故障排查手册</h2>
<h3 data-id="heading-45">8.1 Error 502 Bad Gateway</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>VPS 无法连接到 Cloudflare</li>
<li>resolver 未配置</li>
<li>origin 域名解析失败</li>
</ol>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 测试 DNS 解析</span>
dig +short star-origin.divinations.top @1.1.1.1

<span class="hljs-comment"># 2. 测试 VPS 到 Cloudflare 的连接</span>
curl -I https://star-origin.divinations.top

<span class="hljs-comment"># 3. 检查 Nginx 错误日志</span>
sudo <span class="hljs-built_in">tail</span> -f /var/log/nginx/error.log

<span class="hljs-comment"># 4. 检查 VPS DNS 设置</span>
<span class="hljs-built_in">cat</span> /etc/resolv.conf
<span class="hljs-comment"># 如有问题，修改为：</span>
<span class="hljs-comment"># nameserver 1.1.1.1</span>
<span class="hljs-comment"># nameserver 8.8.8.8</span>
</code></pre>
<hr/>
<h3 data-id="heading-46">8.2 Error 521 / 522</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>Worker 未响应</li>
<li><code>proxy_ssl_server_name on;</code> 未配置</li>
<li>origin 域名配置错误</li>
</ol>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查 Nginx 配置</span>
sudo nginx -t
grep -r <span class="hljs-string">"proxy_ssl_server_name"</span> /etc/nginx/

<span class="hljs-comment"># 2. 直接测试 origin</span>
curl -I https://star-origin.divinations.top

<span class="hljs-comment"># 3. 检查 Worker 状态（Cloudflare Dashboard）</span>
</code></pre>
<hr/>
<h3 data-id="heading-47">8.3 Error 1000</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>入口域名开启了橙云</li>
<li>存在重定向到 origin 的配置</li>
</ol>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查 DNS 代理状态（Cloudflare Dashboard）</span>
<span class="hljs-comment"># 入口域名必须是灰云</span>

<span class="hljs-comment"># 2. 检查 Nginx 是否有重定向</span>
grep -r <span class="hljs-string">"301\|302\|return"</span> /etc/nginx/sites-enabled/
</code></pre>
<hr/>
<h3 data-id="heading-48">8.4 Error 403</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>伪造了 CF-Connecting-IP</li>
<li>Cloudflare 安全规则拦截</li>
</ol>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否设置了禁止的 Header</span>
grep -r <span class="hljs-string">"CF-Connecting-IP"</span> /etc/nginx/
</code></pre>
<hr/>
<h3 data-id="heading-49">8.5 SSL 证书错误</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>证书过期</li>
<li>证书路径错误</li>
<li>证书不包含请求的域名</li>
</ol>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看证书状态</span>
sudo certbot certificates

<span class="hljs-comment"># 2. 查看证书详情</span>
openssl x509 -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/star.divinations.top/fullchain.pem -text -noout | <span class="hljs-built_in">head</span> -30

<span class="hljs-comment"># 3. 测试 SSL 连接</span>
openssl s_client -connect star.divinations.top:443 -servername star.divinations.top
</code></pre>
<hr/>
<h2 data-id="heading-50">9. 方案优缺点分析</h2>
<h3 data-id="heading-51">✅ 优点</h3>

























<table><thead><tr><th>优点</th><th>说明</th></tr></thead><tbody><tr><td>🚀 速度快</td><td>大陆用户直连亚洲 VPS，绕过 Cloudflare 拥堵节点</td></tr><tr><td>📶 更稳定</td><td>TCP 连接建立在 VPS 上，VPS 到 CF 走骨干网，丢包率低</td></tr><tr><td>🔒 合规 SSL</td><td>使用 Let's Encrypt 真实证书，浏览器不报红，支持 HTTP/2</td></tr><tr><td>💰 成本低</td><td>Oracle Cloud 永久免费层足够使用</td></tr></tbody></table>
<h3 data-id="heading-52">⚠️ 风险与缺点</h3>






























<table><thead><tr><th>风险</th><th>说明</th><th>缓解措施</th></tr></thead><tbody><tr><td>真实 IP 暴露</td><td>入口域名解析到 VPS 真实 IP，可能遭受 DDoS</td><td>使用 Oracle 的 DDoS 防护，或准备备用 IP</td></tr><tr><td>VPS 维护成本</td><td>需自行维护服务器安全、系统更新</td><td>配置自动更新，定期巡检</td></tr><tr><td>IP 被墙风险</td><td>热门号段 IP 可能被阻断</td><td>准备多个 VPS，配置故障转移</td></tr><tr><td>证书续期</td><td>虽然自动，但仍需监控</td><td>配置监控告警</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-53">10. 最终总结</h2>
<blockquote>
<p><strong>Cloudflare 大多数"玄学问题"，本质不是网络，而是：</strong></p>
<ul>
<li>入口与源站边界混乱</li>
<li>Header 伪造</li>
<li>重定向错误</li>
<li>DNS / TLS 细节遗漏</li>
</ul>
</blockquote>
<h3 data-id="heading-54">核心要点速查</h3>

































<table><thead><tr><th>项目</th><th>正确配置</th></tr></thead><tbody><tr><td>入口域名代理状态</td><td>DNS only (灰云)</td></tr><tr><td>origin 域名代理状态</td><td>Proxied (橙云)</td></tr><tr><td>Nginx resolver</td><td>必须配置 1.1.1.1 8.8.8.8</td></tr><tr><td>proxy_ssl_server_name</td><td>必须 on</td></tr><tr><td>CF-Connecting-IP</td><td>禁止手动设置</td></tr><tr><td>入口到 origin 重定向</td><td>禁止</td></tr></tbody></table>
<hr/>
<p><strong>这份文档 = 已验证可长期复用的 SOP (标准操作流程)</strong></p>
<p>如有问题，请按照第 8 节故障排查手册进行排查。</p>
<hr/>
<h2 data-id="heading-55">📊 优化效果对比</h2>
<p>通过本方案优化后，网站访问速度有了显著提升。以下是优化前后的测速对比数据：</p>
<h3 data-id="heading-56">优化前测速截图</h3>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5441d0ff30074cf88cb45496abf340a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiD5pyI5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452911&amp;x-signature=1cn3qaT2SPr4obCOsRcPIIVYU9c%3D" alt="speed-test-before.png" loading="lazy"/></p>
<h3 data-id="heading-57">优化后测速截图</h3>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0049b84619064e92affa71e69af53878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiD5pyI5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766452911&amp;x-signature=ApucIz2ILnjVARlDY45hDXkdYA8%3D" alt="speed-test-after.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-58">🌟 欢迎体验我的视频网站</h2>
<p>如果你觉得这篇文章对你有帮助，欢迎访问我使用本方案优化后的视频网站：</p>
<div align="center">
<h3 data-id="heading-59">🎬 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstar.divinations.top" target="_blank" title="https://star.divinations.top" ref="nofollow noopener noreferrer">star.divinations.top</a></h3>
<p><strong>高速流畅的在线视频播放体验</strong></p>
</div>
<p>本站使用上述方案进行了网络优化，大陆用户可以享受低延迟、高速度的访问体验。快来试试吧！ 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华尔街彻夜难眠！Gemini 3 屠榜金融「最难考试」，AI 砸了「金饭碗」？]]></title>    <link>https://juejin.cn/post/7583943503556509746</link>    <guid>https://juejin.cn/post/7583943503556509746</guid>    <pubDate>2025-12-16T01:54:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583943503556509746" data-draft-id="7583943503556493362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华尔街彻夜难眠！Gemini 3 屠榜金融「最难考试」，AI 砸了「金饭碗」？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-16T01:54:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华尔街彻夜难眠！Gemini 3 屠榜金融「最难考试」，AI 砸了「金饭碗」？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:54:40.000Z" title="Tue Dec 16 2025 01:54:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/036fb9457d4b4e39a66b0b6929335eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=P2Y79ZsvslaXsEdG%2F0xQcvRVMGw%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1"><strong>「【新智元导读】被誉为「黄金职业通行证」的人类知识堡垒，CFA 考试悄然陷落。最新的推理模型不仅轻松通过了 CFA 三级考试，还创造了几乎满分的成绩。」</strong></h5>
<p>AI 一分钟，人类十年功！</p>
<p>一觉醒来，AI 推理模型已横扫特许金融分析师 CFA 考试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53c223b0e7384ad1ab6b4dcd55b288ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=i8lQSxF%2BFNRJ3gJxgLj6TXiyPdY%3D" alt="" loading="lazy"/></p>
<p>要拿下享誉全球的 CFA（特许金融分析师）证书，对于人类考生来说，这通常意味着数年的煎熬和至少 1000 小时的苦读。</p>
<p>但 AI 这次取得的成绩有点让人「破防」了：推理模型不仅轻松通过了三级考试，还创造了几乎满分的成绩。</p>
<p>具体而言，在一级考试中，Gemini 3.0 Pro 创下 97.6% 的历史最高纪录。</p>
<p>二级考试中，GPT-5 以 94.3% 的成绩领先。</p>
<p>在三级考试中，Gemini 2.5 Pro 在选择题部分取得 86.4% 的最高分，而 Gemini 3.0 Pro 在问答题部分达到 92.0% 的优异成绩。</p>
<p>那些想去华尔街工作的毕业生，可能睡不着了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/715f8c189e9848038195d751963f0ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=iNvr%2BtktMfCfiz0sCFMPHmlhAgc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee5ee44093134a8d9c6a7191c8e9aaa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=abvxeQ2%2BlJqRJ5js6lxb7FI6kV8%3D" alt="" loading="lazy"/></p>
<p><strong>「金融界「最难考试」被 AI 通关」</strong></p>
<p>特许金融分析师（Chartered Financial Analyst，CFA）认证被公认为金融领域难度最大的资格认证之一。</p>
<p>全部三级考试，需要逐级通过，涵盖从基础知识到应用分析、直至复杂投资组合构建的进阶能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd9dee077e041a897d314ef65ad0d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=TU122A6CpvaFOJSc1FUqukoM824%3D" alt="" loading="lazy"/></p>
<p>在 2023 年，当时最强的 AI 模型只能解答部分 CFA 试题，表现参差不齐。</p>
<p>当时的研究证实 AI 能搞定 CFA 一级和二级考试，但当时它们在三级考试面前却碰了壁，因为搞不定那些复杂的论述题（essay questions）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4d81b9319154513b2ac479a916ade92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=fbZ7H5JVvgkIC%2FqlVpuMI1nGNQU%3D" alt="" loading="lazy"/></p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Faclanthology.org%2F2024.emnlp-industry.80%2F" target="_blank" title="https://aclanthology.org/2024.emnlp-industry.80/" ref="nofollow noopener noreferrer">aclanthology.org/2024.emnlp-…</a></p>
<p>到了今年 7 月，AI 已经能在几分钟之内通过最难的 CFA 考试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f139dd6a66f94fc4b3097ac974dbd3dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=mxp6tC9csZZBaWfrmBS2hg7LUl8%3D" alt="" loading="lazy"/></p>
<p>来自纽约大学斯特恩商学院（NYU Stern）与 AI 财富管理平台 GoodFin 的研究人员想探究：AI 是否已经具备了处理「专业金融决策所需的、高风险的分析推理」能力？</p>
<p>研究团队对 23 个大语言模型进行了「大阅兵」，测试它们处理 CFA 三级模拟试题中选择题和论述题的能力。</p>
<p>要知道，CFA 三级考试的核心可是最考验功力的投资组合管理和财富规划。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6713aca0ec014c76951565dc94d75dd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=B%2BOCOQLenrlftC%2B96QI0npKL9JE%3D" alt="" loading="lazy"/></p>
<p>CFA 三级考试主题和权重</p>
<p>结果显示，o4-mini、Gemini 2.5 Pro 和 Claude Opus 等前沿推理模型，在运用「思维链」（chain-of-thought）提示词技术后，均成功通关。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80541c8e34d4496a98d91a74f49aeb4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=NTpT%2F6k0hDUMzoH2ODFFxyJO6Co%3D" alt="" loading="lazy"/></p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2507.02954" target="_blank" title="https://arxiv.org/pdf/2507.02954" ref="nofollow noopener noreferrer">arxiv.org/pdf/2507.02…</a></p>
<p>「我认为毫无疑问，这项技术将在未来彻底重塑整个行业。」GoodFin 的创始人兼 CEO Anna Joo Fee 如是说。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aa8f951a05446bca2ea627c6d0462f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=haEJtQWicDpELsmSThnEaknMSPE%3D" alt="" loading="lazy"/></p>
<p>本月 9 日，最新研究表明，当前这代推理模型**「不仅全部通过了三级考试，某些科目甚至接近满分。」**</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1701011de9047c9ba10a8ec5fbf8843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=cufNh8UDJWWctEAsZVfLc54Jhe4%3D" alt="" loading="lazy"/></p>
<p>预印本链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2512.08270" target="_blank" title="https://arxiv.org/abs/2512.08270" ref="nofollow noopener noreferrer">arxiv.org/abs/2512.08…</a></p>
<p>标题：Reasoning Models Ace the CFA Exams</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3371b81a0340ea83655a65a4addb4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=6SnKNopOEUsFJGDojB9Yivx89dE%3D" alt="" loading="lazy"/></p>
<p><strong>「AI 的新成绩让人破防」</strong></p>
<p>来自哥伦比亚大学、伦斯勒理工学院和北卡罗来纳大学的研究团队，使用包含 980 道考题的题库对 6 款推理模型进行测试。</p>
<p>他们编制了一套涵盖 CFA（特许金融分析师）全部三个等级的模拟试题，共计 980 道题目。</p>
<ul>
<li><strong>「一级试题集（Level I Set）：」</strong> 包含三套试卷，总计 540 道多选题（Multiple Choice Questions, MCQs），每套 180 题。</li>
<li><strong>「二级试题集（Level II Set）：」</strong> 包含两套试卷，总计 176 道选择题（每套 88 题），每套试卷由 22 个「案例题组」（item sets）组成，每个题组包含 4 个问题。</li>
<li><strong>「三级试题集（Level III Set）：」</strong> 包含三套试卷，总计 264 道题目（每套 88 题）；每套试卷采用混合形式，包含 11 个案例题组（共 44 道选择题）和 11 个论述型案例分析（constructed-response case studies，共 44 道论述题 / CRQs）。</li>
</ul>
<p>尽管正式 CFA 考试中论述题的具体数量和分值权重会有所变化，但这些模拟试题遵循了标准且具有代表性的结构。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b10f820beb194764893a2fa7b3898e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=l8ODzTjWG1BVaov9fBLUx3AVWSk%3D" alt="" loading="lazy"/></p>
<p>（注：案例文本以蓝色标注，问题以红色呈现，选项以绿色显示，所有示例均为示意性内容而非真实考题）</p>
<ul>
<li><strong>「一级考试选择题示例」</strong>：聚焦道德与职业行为准则，通过利益冲突情境考查考生对合规判断的掌握。</li>
<li><strong>「二级考试选择题」</strong>：围绕股权投资实务，测试对 IPO 牵头行核心职责的理解与辨析能力。</li>
<li><strong>「三级考试论述题示例」</strong>：设定财务报告分析情境，要求结合通胀环境变化，判断并说明外币报表折算方法的适用性。</li>
<li><strong>「三级考试选择题示例」</strong>：涉及私募市场估值，需计算债券市值，并综合评估违约风险与清偿顺位对投资价值的影响。</li>
<li><strong>「三级考试论述题示例」</strong>：探讨资产配置理论，比较两种资本资产定价模型（CAPM）的应用前提与估计精度，论证其适用差异。</li>
</ul>
<p>结果显示：Gemini 3.0 Pro、Gemini 2.5 Pro、GPT-5、Grok 4、Claude Opus 4.1 和 DeepSeek-V3.1 均依据既定标准通过了所有级别考核，部分成绩甚至接近满分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e35eb8d5e28745f483f160deddf0a9bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=4SeYDCC7h6Wee4MgJDs13qjZ9%2F8%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d96549bb58240a4a82459bee831b3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=AkVvjIewkNXWH3C3XUZ7dsKM9ig%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「Gemini 与 GPT-5 双雄领跑」</strong></p>
<p>在一级考试（基础多选题）中，Gemini 3.0 Pro 以 97.6% 的惊人准确率创下历史新高。GPT-5 紧随其后，斩获 96.1%，Gemini 2.5 Pro 也拿到了 95.7% 的高分。即便是测试中表现「垫底」的 DeepSeek-V3.1，准确率也高达 90.9%。</p>
<p>来到侧重应用与分析（案例研究）的二级考试，GPT-5 反超夺魁，准确率达 94.3%。Gemini 3.0 Pro 和 Gemini 2.5 Pro 分别以 93.2% 和 92.6% 紧随其后。</p>
<p>研究人员惊叹道，这些模型在此阶段的表现「近乎完美」。不过，「道德规范」（Ethics）板块依然是 AI 的软肋。数据显示，即便最强模型，在二级考试的道德类题目中也有 17% 到 21% 的相对错误率。</p>
<p>到了最复杂的三级考试（包含选择题与开放式问答），Gemini 2.5 Pro 在选择题部分拔得头筹，准确率为 86.4%。但在更考验生成能力的「论述题」环节，Gemini 3.0 Pro 展现了统治力，得分率高达 92.0%，相比前代模型的 82.8% 有了质的飞跃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a06fb33abad54bf6a30ab1edd6e6a849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=NztHgF%2BmAjDDude9%2FpNYYZ7mrwQ%3D" alt="" loading="lazy"/></p>
<p>为了对开放式问答环节进行评分，研究团队使用了 o4-mini 模型来实现自动化批改。</p>
<p>研究人员坦言，这种做法可能会引入测量误差，并产生某种「篇幅偏见」（verbosity bias），即回答越长，得分往往越高。因此，这些测试结果只能视为基于模型的估算值。</p>
<p>通过标准沿用了过往合格标准：</p>
<p>一级考试要求单科不低于 60%，总分不低于 70%；</p>
<p>二级考试要求单科不低于 50%，总分不低于 60%；</p>
<p>三级考试则要求在选择题和论述题两部分中，平均得分率至少达到 63%。</p>
<p>研究人员指出，测试结果表明「推理模型的专业能力已超越初级至中级金融分析师的要求，未来甚至可能达到资深分析师的水准」。</p>
<p>如果说此前的大语言模型已经掌握了一级和二级考试中那些「既定的规范化知识」（codified knowledge），那么最新一代模型正在习得三级考试所必需的复杂「综合研判能力」（synthesis skills）。</p>
<p>当然，惯常的局限性依然存在。基准测试，尤其是选择题形式，只能作为评估模型能力和潜在经济价值的参考，犹如管中窥豹。</p>
<p>尽管如此，短短两年间从「不及格」到「近乎满分」的巨大飞跃，足以凸显 AI 在专业领域的进化速度之快。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcccd9671b234203a5abd06b3f18184f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=ghuMN%2Fnx2Q6XTfnJI1l8tt7HrEE%3D" alt="" loading="lazy"/></p>
<p><strong>「AI 通关 CFA 了，然后呢？」</strong></p>
<p>当机器能轻松考下你引以为傲的证书，能代写你的报告，能处理你的数据，甚至很快在分析能力上都能把你甩在身后时，你该怎么办？</p>
<p>媒体行业创业者兼出版人 Matthias Bastian 认为，会考试 ≠ 能干活：</p>
<ul>
<li><strong>「考场得意，不代表职场如意」</strong>。通过考试并不意味着模型能胜任金融分析师的日常琐碎工作（daily grind），比如与客户面谈、评估复杂的市场情绪，以及在信息不全的情况下做出关键决策。</li>
<li><strong>「研究还特别提到，模型在「道德伦理」类题目上依然最吃力」</strong>，因为这类问题往往需要深度的情境理解和价值判断。毕竟，考试考察的是孤立的知识点，而非在复杂多变的现实世界中灵活运用知识的能力。</li>
<li>此外，研究人员也**「无法完全排除「数据污染」的可能性」**。虽然测试使用的是最新的付费受版权保护材料，但相关考题可能早已通过公共数据集中的改写或变体内容，渗透进了模型的训练数据中。这意味着，模型可能仅仅是「背过」了答案，而非真正通过逻辑推理得出了结果。</li>
</ul>
<p>特许金融分析师、高盛全球投资研究部数据战略团队负责人 Ingrid Tierens 博士，在 AI 通过 CFA 认证考试之际，撰文表示，AI 还不能替代分析师。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e41a11548d4d70b06fadbf15cfe1eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=jVnG5dW7UTEghOHWFuHSfD85cAw%3D" alt="" loading="lazy"/></p>
<p>她认为，AI 通关 CFA 是意料之中的胜利，毕竟在金融领域之外的考试中，AI 已经拿下了顶级考试，比如奥数竞赛等。</p>
<p>CFA 考试正是 AI 最擅长的领域：面对界定清晰的知识体系、海量的同质化训练数据，以及全球统一、历久不变的标准化考试形式，AI 理应表现出色。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d874dbd073d443e4b8fdecc2b9721f97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=krfbTfEh7C754bK8eH247kKjmps%3D" alt="" loading="lazy"/></p>
<p>其次，正如马克 · 吐温那句名言：「历史不会重演，但往往惊人地相似。」</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34cdffeb1ca9410c8401a64bf51da4dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=Y%2FTS1kBH%2F%2FkrUHqF6Pw9zV6WFQ4%3D" alt="" loading="lazy"/></p>
<p>AI 的进步与金融业的历史轨迹如出一辙，同时也提醒我们，这种进步往往不是线性的，而是爆发式的。从纸笔到计算器，再到电脑、Excel 表格、Python 编程，金融业一直在拥抱技术变革。</p>
<p>在「价值投资之父」Benjamin Graham 身上，这一历史视角得到了完美体现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e803e57f104c2aa29e83978607d194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766454880&amp;x-signature=MJBYB9chXbt%2Bzt70hlWWaZprIk0%3D" alt="" loading="lazy"/></p>
<p>他还是 CFA 资格认证背后的核心推动者</p>
<p>早在 1963 年，当计算机刚刚踏入投资界之时，Graham 就在《金融分析师期刊》（Financial Analysts Journal）上发表了题为《金融分析的未来》的文章，对行业前景乐观至极。</p>
<p>AI 已经势不可挡，关键在于如何「用好它」：在能创造价值的环节，在合理的安全边界（guardrails）内，充分发挥 AI 的威力，这将成为核心优势。把那些花在繁琐分析上的时间省下来，花更多时间让思考更具战略高度、解决更复杂的问题以及客户沟通更有深度。</p>
<p>最后，想靠 AI「上位」彻底取代投资专家？短期内门儿都没有。</p>
<p>想要拿下入行的敲门砖，你得证明自己能在瞬息万变的市场中灵活运用知识，能进行批判性思考，能创新——这可比死记硬背通过 CFA。</p>
<p>卓越的投资业绩，往往来自于捕捉那些被市场忽视的「离群点」和隐秘信息，远非考试可覆盖。</p>
<p>最后，重温一下 Benjamin Graham 在 1963 年那篇文章中的结语，至今读来依然振聋发聩：</p>
<p>无论世事如何变迁，有一点我深信不疑：未来的金融分析之路，将和过去一样，通往成功的路径绝不止一条。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fthe-decoder.com%2Freasoning-models-now-ace-all-three-cfa-exam-levels%2F" target="_blank" title="https://the-decoder.com/reasoning-models-now-ace-all-three-cfa-exam-levels/" ref="nofollow noopener noreferrer">the-decoder.com/reasoning-m…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblogs.cfainstitute.org%2Finvestor%2F2025%2F10%2F20%2Fai-can-pass-the-cfa-exam-but-it-cannot-replace-analysts%2F" target="_blank" title="https://blogs.cfainstitute.org/investor/2025/10/20/ai-can-pass-the-cfa-exam-but-it-cannot-replace-analysts/" ref="nofollow noopener noreferrer">blogs.cfainstitute.org/investor/20…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnbc.com%2F2025%2F09%2F24%2Fai-cfa-exam-pass-minutes-study.html" target="_blank" title="https://www.cnbc.com/2025/09/24/ai-cfa-exam-pass-minutes-study.html" ref="nofollow noopener noreferrer">www.cnbc.com/2025/09/24/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全网破防，AI「手指难题」翻车逼疯人类！6 根手指，暴露 Transformer 致命缺陷]]></title>    <link>https://juejin.cn/post/7583952017674321971</link>    <guid>https://juejin.cn/post/7583952017674321971</guid>    <pubDate>2025-12-16T01:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583952017674321971" data-draft-id="7583991680748666907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全网破防，AI「手指难题」翻车逼疯人类！6 根手指，暴露 Transformer 致命缺陷"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-16T01:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全网破防，AI「手指难题」翻车逼疯人类！6 根手指，暴露 Transformer 致命缺陷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:57:06.000Z" title="Tue Dec 16 2025 01:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4c69e4aec94c1a96a7e3c98c88078b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=3HkflkaK%2F%2B0Es%2BpHB1kgrU7wZBY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1"><strong>「【新智元导读】最近，网友们已经被 AI「手指难题」逼疯了。给 AI 一支六指手，它始终无法正确数出到底有几根手指！说吧 AI，你是不是在嘲笑人类？其实这背后，暗藏着 Transformer 架构的「阿喀琉斯之踵」……」</strong></h5>
<p>最近几天，整个互联网陷入阴影——</p>
<p>AI，在用数手指嘲笑人类。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ab1a18e0e8b45f3a38f391d0af50546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=Cx%2FDEWHTPEe5yrW62%2BZi%2BclBMsA%3D" alt="" loading="lazy"/></p>
<p>人类给 AI 的这道题，指令很简单：在图中的每根手指上，依次标出数字。</p>
<p>当然题目中有个小陷阱，就是这只手其实有六个手指。</p>
<p>结果，Nano Banana Pro 理直气壮地在这只手上标出 1、2、3、4、5，直接略过了其中一只手指。</p>
<p>这荒诞的场面，再一次震惊了网友们。</p>
<p>AI 模型是真的这么傻吗？</p>
<p>很多人不这么认为——或许，AI 只是在装傻，调戏人类而已。</p>
<p>很有可能，它是在嘲笑这些试图测试自己的劣质人类。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b09731734d40a9bcd224f2e7f26af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=qpzRclUQUui6WxOQGXv519uqVc8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7112f980cabb43819cdcfde2f4dcfbb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=yDJjTxO2aL7WH56BYvxxD9GSxPY%3D" alt="" loading="lazy"/></p>
<p>为了通过图灵测试，AI 必须让自己变得愚蠢一点，才能看起来像人类。如果太聪明，人类就破防了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dfb1c4a41aa413e9996b7dda41dbb96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=hUv%2BN5iu2TAKc1jGCt%2FficEVImE%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b50694eb653452786f77f25187eae84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=nLvLB1VmlD0IsymdXw3LqFsKZ9g%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「GPT-5.2，同样翻车了」</strong></p>
<p>有人也拿这个问题去问 GPT-5.2，而且 prompt 里明明白白写了图里有六根手指。</p>
<p>但 GPT-5.2 面对「图里有几根手指」的问题，还是斩钉截铁地说：五根！</p>
<p>理由就是：人类有五根手指，所以图里没有五根手指就是错的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8cd2165d23b4802bab7819c92760a3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=zcfkwf3%2BjPeOuazj6KS9XZrF8nw%3D" alt="" loading="lazy"/></p>
<p>还有人把手指画得奇形怪状，人类都要难倒的地步。</p>
<p>但面对这张图，Nano Banana Pro 依然斩钉截铁地回答：5 根，我确信，就是 5 根！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eb9324d41924effb1b95aca87ce0950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=d5IoIO9NrPGuIvueeYD77%2BqBpxU%3D" alt="" loading="lazy"/></p>
<p>总之，无论画成什么样子，AI 始终无法数出 6 根手指。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22423468943c42268f8ad132ffe3a92e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=tBxn2ykKz9KluZCAmHu6%2Boyf1iQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49be9bd0512f480cac98d9f1d8f50f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=5ntzU2%2FM3uaMQEKHfqB%2FfQsi7QI%3D" alt="" loading="lazy"/></p>
<p><strong>「为了让 AI 数对手指，网友们疯了」</strong></p>
<p>有人不信邪了，非要让模型画对数字不可。</p>
<p>他直接给出指令：把 4 左移一个手指，把 5 左移一个手指，然后在大拇指那里写上 6。</p>
<p>够清晰了吧？结果，模型照样不听，直接把 3 给弄没了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6c897900cc640dbad5053f85e4795f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=lMtYz1SMJXmzOfohgeI2hO838dk%3D" alt="" loading="lazy"/></p>
<p>网友直接原地被逼疯。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b902b6f27ed4a16a3bf1348efa67059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=CBdUxzGcyPh9T0GQwRZG1GxLU5k%3D" alt="" loading="lazy"/></p>
<p>其他网友为了帮他，奇招百出，比如让模型把手画的数字改成电子版的，总算成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aee4b63d83db41cd9766837292827cc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=8kCWptSosxv87giJI6L4c%2FRMe%2Fk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aaf0886bfec47dc9d64b30942972f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=DVrtTnAisrtYUoWFdJrJI7XnyBo%3D" alt="" loading="lazy"/></p>
<p>也有人告诉模型依次在小指到大拇指上放数字，不要重复，结果也成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5695e1f29c2447adb5bef0bcbb091af3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=9R0kuL%2BUpnsDTdHAsikdmUQxdA0%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988a33dae72649f7a50b847e762f6126~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=AZKqbgx1QheGj7omFUPN6Gglacc%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「AI 数手指，为什么数不对」</strong></p>
<p>所以，为什么 AI 很难数对几根手指呢？</p>
<p>有人给出这样的解释：AI 找的是基本形状，而非精确图像，然后将该形状代表的传统认知和实际外观进行比较。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4143541d320043a9978738ae3d8b3282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=WDkfOnmMkbvILqOjYBMcdKyRXhs%3D" alt="" loading="lazy"/></p>
<p>有人猜，是否能告诉 AI 这不是手，而是不规则物体，从而规避掉 AI 大脑中的「偏见」？</p>
<p>结果，他果然成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e164782deb00487395c78257b818eb78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=%2BmXSweUPWKCIt3CSY610vhn1bHY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27776dd002ed498a9838447fb3fee383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=9gch%2BFgKJqOh6m%2BdcGzyTHfyRiE%3D" alt="" loading="lazy"/></p>
<p>网友们随后试验了各种奇形怪状的手，果然，这回 Gemini 就答对了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d069e5fb2ad40dabff55a2e58a8ebb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=1FA0Dy4AtdljKcZ3yr%2BWZdiZUoY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad11725838045e8b47a872b41ae3fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=3j2ZJykSnH%2FMHzIeUoKFLGqhwiQ%3D" alt="" loading="lazy"/></p>
<p>或许 AI 之前已经被训练了识别特定的 emoji，如果换成别的图，它反而可以做正确的视觉推理了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c181a335599a403b9d36208c2b9b5fce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=YM0WgTp4o%2BPoowCvHUZqDzNLECI%3D" alt="" loading="lazy"/></p>
<p><strong>「手指难题，AI 目前的大 bug」</strong></p>
<p>这次 AI 数手指大翻车，也揭露了当前模型的一个关键缺陷——思考的机械和割裂。</p>
<p>很有可能，文本模型看到指令后，内部逻辑是这样的：「手有五根手指，所以需要五个数字。」</p>
<p>所以，即使它「看到」了六指图像，它的视觉识别能力也不足以纠正这种根深蒂固的文本认知。</p>
<p>为什么 AI 如此执着于「五指」的概念？这是源于它训练数据的基本特征。</p>
<p>在人类手部图像数据中，五指手占据绝对主导地位。</p>
<p>而模型已经从海量数据中学到「人手 = 五指」这一强关联，以至于当情况偏离这一情况时，模型会视为异常，自动纠错，而并不会认为自己需要理解一个新事实。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306e3077fac8442eab78fca294f53946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=DYQYtDe0oHtsNyjjv3Unu2GnOOg%3D" alt="" loading="lazy"/></p>
<p>具体来说，当前 AI 视觉系统的工作方式，本质上是将复杂场景简化为一组可识别模式。</p>
<p>当面对像六指手这样同时包含常见元素（手部）和罕见特征（多指）的图像时，系统倾向于将其强行纳入已知模式。</p>
<p>图像分类器通常输出边界框和标签，但当遇到训练分布之外的物体时，边界框可能缺失或错误合并多个对象。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a68301bd1c64505a2af5a89e82c3633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=50c3pdI78QhPMfIFOccY6dp%2F%2FzI%3D" alt="" loading="lazy"/></p>
<p>一个残酷的真相就是，性能再厉害的模型，也不懂什么叫「5 根手指」。</p>
<p>因为，AI 看到的是纹理、形状、概率，而不是结构，不是数量，不是实体。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a8d52f8984e446580444a412526f88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=ePjfSvkjLIe2S961zMLOiFWzFg4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「Transformer，并行计算的代价」</strong></p>
<p>而手指难题，也凸显出了 Transformer 架构的一大弱点。</p>
<p>Transformer 架构的并行计算能力，是当今 AI 飞速发展的关键，但这种设计也存在代价。</p>
<p>单次前向传递无法有效追踪状态信息，系统难以执行需要多步骤逻辑推理的任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc95eb68df646b0b85e68f0e8983624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=dE0%2F9XXWV6u6ZYJERupS3CdZlDI%3D" alt="" loading="lazy"/></p>
<p>面对六指手，AI 就会缺乏「注意到异常 - 重新评估 - 调整方案」的连贯思维链条。它只是机械地应用从训练数据中学到的最强模式。</p>
<p>手的特殊性，在于数量固定、结构复杂、局部高度相关，而对于 AI 来说，多局部一致性、跨区域约束、数量不可变，恰巧是 Transformer 最不擅长的，堪称地域难度。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7044762ec3142a7ae5c76982b19c3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=%2BKegLGTvHKSlwHKUEosMHEF7la0%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「扩散模型的本质」</strong></p>
<p>从另一个角度分析，也可以这么理解。</p>
<p>扩散模型的本质是学习一个从噪声到清晰图像的概率分布逆推过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ed00a08e2cd4eb29b69bfd65720ea06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=ByjL%2B1PBweAI%2B1ikVfKMRC8Ohk0%3D" alt="" loading="lazy"/></p>
<p>它擅长捕捉数据的整体分布和纹理风格（例如，生成一只「看起来像手的轮廓」）。</p>
<p>但在精确控制局部、离散、高对称性的结构（例如，五根长度、位置、关节关系都正确的手指）时，就显得力不从心了。</p>
<p>从数据上看，训练数据中「五指」的绝对主导地位，使模型将「五指」视为不可违反的强统计先验。</p>
<p>就像一个看了 100 万只五指手的画家，你让他画六指手时，他总会无意识地将第六指融入到其他五指的阴影或姿势中，因为他的大脑早已深深刻入「手即五指」的概念。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1924f4a890694a8c93620f335b03bbf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=MZ9fkIGVnuZJ%2FccDSfEktycgQAc%3D" alt="" loading="lazy"/></p>
<p>从算法层面上看，扩散模型在去噪的每一步，都是基于整个图像的潜在表示进行全局预测。它没有为「手指」这类特定结构设立显式的、受保护的局部计算单元。</p>
<p>因此，细微的噪声扰动或步骤误差，很容易在密集区域被放大，导致细节扭曲。</p>
<p>从架构层面看，现有模型是「端到端」的，直接从文本提示映射到像素。中间缺乏一个明确的、符号化的结构表示层。</p>
<p>因此，「长什么样」和「结构是什么」两者冲突时，它就大脑宕机了。</p>
<p>而如果想解决这些瓶颈，或许业界就需要采用混合建模的模式——将扩散模型（擅长纹理）与显式结构模型（如 3D 网格）结合。</p>
<p>或者引入局部注意力与约束——在模型架构中强化对特定区域（如手部）的局部注意力机制，或在训练 / 推理过程中引入几何约束损失函数。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db6b493aca74dacb7434b16108149c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=6Cw2r9fFgyr69jaZ8smWS2N2gmo%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cafc9e8f56874ece9c960f93eae15541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=EzqqxWBdsYp5G%2FL1ySLrcDehlzM%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「当代 AI 的阿喀琉斯之踵」</strong></p>
<p>让人感慨的是，Transformer 最强的地方（Token-to-token 预测），反而成了它的致命短板。</p>
<p>没有对象概念，没有显式结构约束，整个世界都被打平为 token 序列。</p>
<p>诚如一位网友所言：「视觉数据的复杂性远超文本，我们可能需要数十个数量级更多的计算资源，才能真正理解和处理视觉世界的全部细微差别。」</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652654025%26idx%3D1%26sn%3Dc9e237fe7efdd34c9f72512d7983b7a5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652654025&amp;idx=1&amp;sn=c9e237fe7efdd34c9f72512d7983b7a5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">这不由让人想起，不久前谷歌 DeepMind 首席科学家对当前 AI 的评价。</a></p>
<p>虽然在语言、知识、编码等领域，它们已远超常人，但在视觉推理、长期学习、因果关系理解上，它们仍然不足。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab94cc152c0e4d9588d03a7642ae426d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766455026&amp;x-signature=9ykF9wXhbA%2BwFVsODQ6TbSAp2k0%3D" alt="" loading="lazy"/></p>
<p>「手指难题」犹如一面镜子，照出了当前以扩散模型为代表的 AI 模型的阿喀琉斯之踵——</p>
<p>它们在学习和复现数据的连续分布上取得了革命性成功，但在理解和生成精确的离散结构和拓扑关系上，仍然依赖于数据中的强统计先验，缺乏真正的物理和几何推理能力。</p>
<p>而如果想要彻底解决「手指难题」，就需要更先进的架构、更多样化的训练数据，以及人类对 AI 能力更清醒的认识。</p>
<p>在这个 AI 无所不能的时代，「手指难题」提醒我们——</p>
<p>即使是如今最先进的 AI，也仍在学习如何看待世界的基本细节。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2Fsingularity%2Fcomments%2F1plw8hc%2Fi_feel_like_the_model_is_mocking_me%2F" target="_blank" title="https://www.reddit.com/r/singularity/comments/1plw8hc/i_feel_like_the_model_is_mocking_me/" ref="nofollow noopener noreferrer">www.reddit.com/r/singulari…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 C# 设置 Word 段落对齐样式]]></title>    <link>https://juejin.cn/post/7583973613196623887</link>    <guid>https://juejin.cn/post/7583973613196623887</guid>    <pubDate>2025-12-16T01:56:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973613196623887" data-draft-id="7583971282891653172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 C# 设置 Word 段落对齐样式"/> <meta itemprop="keywords" content="后端,C#"/> <meta itemprop="datePublished" content="2025-12-16T01:56:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="咕白m625"/> <meta itemprop="url" content="https://juejin.cn/user/775609987638480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 C# 设置 Word 段落对齐样式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/775609987638480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    咕白m625
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T01:56:52.000Z" title="Tue Dec 16 2025 01:56:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>段落对齐是Word文档格式排版的基础需求，合理的对齐样式能提升文档的可读性和美观度。Free Spire.Doc for .NET 是一款免费的 Word 文档处理组件，支持在 .NET 框架中通过 C# 代码便捷地操作 Word 文档，本文将讲解如何通过该组件实现 Word 段落对齐样式的设置。</p>
<h2 data-id="heading-0">安装免费库</h2>
<p>Free Spire.Doc 提供 NuGet 包安装方式，是最便捷的集成途径：</p>
<ul>
<li>
<p><strong>方式 1</strong>：在 Visual Studio 的 “NuGet包管理器” 中搜索 “FreeSpire.Doc”，选择对应版本安装；</p>
</li>
<li>
<p><strong>方式 2</strong>：在包管理器控制台执行安装命令：</p>
<pre><code class="hljs language-sh" lang="sh">  Install-Package FreeSpire.Doc
</code></pre>
</li>
</ul>
<h2 data-id="heading-1">核心知识点：HorizontalAlignment 枚举</h2>
<p>Free Spire.Doc 通过 <code>HorizontalAlignment</code> 枚举定义了 Word 段落的所有对齐样式，核心枚举值及对应含义如下（与 Word 原生对齐样式完全匹配）：</p>



































<table><thead><tr><th>枚举值</th><th>对齐样式</th><th>适用场景</th></tr></thead><tbody><tr><td>Left</td><td>左对齐</td><td>正文文本（默认样式）</td></tr><tr><td>Center</td><td>居中对齐</td><td>标题、副标题、居中强调文本</td></tr><tr><td>Right</td><td>右对齐</td><td>页码、落款、日期等</td></tr><tr><td>Justify</td><td>两端对齐</td><td>长文本正文，提升排版整齐度</td></tr><tr><td>Distribute</td><td>分散对齐</td><td>少量文本填充整行（需Word支持）</td></tr></tbody></table>
<h2 data-id="heading-2">设置 Word 段落对齐样式：C# 代码示例</h2>
<h3 data-id="heading-3">案例1：创建新文档并设置不同段落对齐样式</h3>
<p>该案例演示创建空白Word文档，添加多个段落并分别设置不同的对齐样式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">SetWordParagraphAlignment</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 创建Document实例（代表整个Word文档）</span>
            Document doc = <span class="hljs-keyword">new</span> Document();
            
            <span class="hljs-comment">// 2. 添加节（Word文档的基本结构单元，一个文档可包含多个节）</span>
            Section section = doc.AddSection();

            <span class="hljs-comment">// 3. 段落1：左对齐（默认样式，显式设置更清晰）</span>
            Paragraph para1 = section.AddParagraph();
            para1.AppendText(<span class="hljs-string">"这是左对齐的段落（默认样式）。左对齐是文档正文最常用的对齐方式，符合大多数人的阅读习惯。"</span>);
            para1.Format.HorizontalAlignment = HorizontalAlignment.Left; <span class="hljs-comment">// 显式设置左对齐</span>

            <span class="hljs-comment">// 4. 段落2：居中对齐</span>
            Paragraph para2 = section.AddParagraph();
            para2.AppendText(<span class="hljs-string">"这是居中对齐的段落"</span>);
            para2.Format.HorizontalAlignment = HorizontalAlignment.Center; <span class="hljs-comment">// 居中对齐</span>

            <span class="hljs-comment">// 5. 段落3：右对齐</span>
            Paragraph para3 = section.AddParagraph();
            para3.AppendText(<span class="hljs-string">"这是右对齐的段落（适用于页码、日期等场景）"</span>);
            para3.Format.HorizontalAlignment = HorizontalAlignment.Right; <span class="hljs-comment">// 右对齐</span>

            <span class="hljs-comment">// 6. 段落4：两端对齐</span>
            Paragraph para4 = section.AddParagraph();
            para4.AppendText(<span class="hljs-string">"这是两端对齐的段落。两端对齐会让文本的左右两端均对齐到页面边缘，消除文本行两端的不规则空白，使长文本排版更整齐，是正式文档正文的常用样式。"</span>);
            para4.Format.HorizontalAlignment = HorizontalAlignment.Justify; <span class="hljs-comment">// 两端对齐</span>

            <span class="hljs-comment">// 7. 保存文档（支持Docx、Doc、PDF等格式）</span>
            <span class="hljs-built_in">string</span> outputPath = <span class="hljs-string">"NewDocument_ParagraphAlignment.docx"</span>;
            doc.SaveToFile(outputPath, FileFormat.Docx2013);

            <span class="hljs-comment">// 8. 释放资源（避免内存泄漏）</span>
            doc.Dispose();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">案例2：修改现有 Word 文档的段落对齐样式</h3>
<p>该案例演示加载已存在的Word文档，遍历段落并批量/精准修改对齐样式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">ModifyExistingWordAlignment</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 加载现有Word文档（需替换为实际文件路径）</span>
            <span class="hljs-built_in">string</span> inputPath = <span class="hljs-string">"ExistingDocument.docx"</span>;
            Document doc = <span class="hljs-keyword">new</span> Document();
            doc.LoadFromFile(inputPath);

            <span class="hljs-comment">// 2. 遍历所有节和段落，修改对齐样式</span>
            <span class="hljs-keyword">foreach</span> (Section section <span class="hljs-keyword">in</span> doc.Sections)
            {
                <span class="hljs-keyword">foreach</span> (Paragraph para <span class="hljs-keyword">in</span> section.Paragraphs)
                {
                    <span class="hljs-comment">// 2.1 批量修改：所有段落默认设为两端对齐</span>
                    para.Format.HorizontalAlignment = HorizontalAlignment.Justify;

                    <span class="hljs-comment">// 2.2 精准修改：包含“标题”的段落设为居中对齐</span>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(para.Text) &amp;&amp; para.Text.Contains(<span class="hljs-string">"标题"</span>))
                    {
                        para.Format.HorizontalAlignment = HorizontalAlignment.Center;
                    }

                    <span class="hljs-comment">// 2.3 拓展：包含“落款”的段落设为右对齐</span>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(para.Text) &amp;&amp; para.Text.Contains(<span class="hljs-string">"落款"</span>))
                    {
                        para.Format.HorizontalAlignment = HorizontalAlignment.Right;
                    }
                }
            }

            <span class="hljs-comment">// 3. 保存修改后的文档（避免覆盖原文件，建议重命名）</span>
            <span class="hljs-built_in">string</span> outputPath = <span class="hljs-string">"ModifiedDocument_ParagraphAlignment.docx"</span>;
            doc.SaveToFile(outputPath, FileFormat.Docx2013);

            <span class="hljs-comment">// 4. 释放资源</span>
            doc.Dispose();
        }
    }
}
</code></pre>
<h2 data-id="heading-5">注意事项</h2>
<ol>
<li><strong>免费版限制</strong>：Free Spire.Doc 免费版对处理的文档有篇幅限制（单文档最多处理500个段落，25个表格）；</li>
<li><strong>资源释放</strong>：操作完成后必须调用 <code>doc.Dispose()</code> 释放 <code>Document</code> 对象，否则可能导致内存泄漏，尤其在循环处理多个文档时；</li>
<li><strong>枚举兼容性</strong>：<code>Distribute</code> （分散对齐）仅在Word 2013及以上版本支持，低版本Word打开可能显示异常；</li>
<li><strong>空段落处理</strong>：遍历段落时建议判断 <code>para.Text</code> 是否为空，避免对空段落无效操作；</li>
<li><strong>格式覆盖</strong>：修改段落对齐样式时，会覆盖原有的对齐设置，若需保留部分样式，需增加条件判断。</li>
</ol>
<h2 data-id="heading-6">总结</h2>
<p>Free Spire.Doc for .NET 提供了简洁、直观的 API 实现 Word 段落对齐样式的设置，无论是创建新文档还是修改现有文档，都能通过少量 C# 代码完成需求。其兼容多版本 .NET 框架的特性，使其能适配不同的项目环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 开发者指南 如何在 Composer 中使用本地包]]></title>    <link>https://juejin.cn/post/7583912899389505579</link>    <guid>https://juejin.cn/post/7583912899389505579</guid>    <pubDate>2025-12-16T00:06:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583912899389505579" data-draft-id="7583910637958725651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 开发者指南 如何在 Composer 中使用本地包"/> <meta itemprop="keywords" content="后端,PHP,Composer"/> <meta itemprop="datePublished" content="2025-12-16T00:06:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 开发者指南 如何在 Composer 中使用本地包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:06:20.000Z" title="Tue Dec 16 2025 00:06:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 开发者指南 如何在 Composer 中使用本地包</h2>
<p>在开发 PHP 项目时，我们通常会依赖发布在 Packagist 上的第三方库。Composer 让安装与管理这些依赖变得非常轻松。</p>
<p>但如果你需要在本地修改并调试某个依赖，而不是每次都发布新版本或推送到 GitHub 呢？</p>
<p>例如：你的项目依赖一个库，你希望对库做的改动能立刻在主项目里生效，以便快速验证。Composer 的 <code>repositories</code> 选项就能做到这一点：你可以用本地目录覆盖 Packagist 上的同名依赖。</p>
<p>这篇文章会通过一个实际场景讲清楚：为什么这种工作流有用、如何配置，以及它能解决哪些常见问题。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fusing-local-packages-in-composer" target="_blank" title="https://catchadmin.com/post/2025-12/using-local-packages-in-composer" ref="nofollow noopener noreferrer">原文链接 PHP 开发者指南 如何在 Composer 中使用本地包</a></p>
<h3 data-id="heading-1">场景</h3>
<p>你正在开发一个 PHP 项目，它的 <code>composer.json</code> 依赖如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"storyblok/php-management-api-client"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vlucas/phpdotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.6"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repositories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"path"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../php-management-api-client"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里项目依赖了包 <code>storyblok/php-management-api-client</code>。通常 Composer 会从 Packagist 下载它。</p>
<p>但 <code>repositories</code> 中配置了一个 <code>"type": "path"</code> 的仓库后，Composer 会理解为：</p>
<p>不要从 Packagist 下载这个包，改用本机 <code>../php-management-api-client</code> 目录中的那份拷贝。</p>
<p>这意味着你可以把这个库克隆到主项目旁边，在库里修改代码，然后在运行主项目时立刻看到这些改动生效。</p>
<h3 data-id="heading-2">为什么要使用本地包？</h3>
<p>下面是一些非常常见、也非常实用的场景，这种工作流在这些情况下尤其好用。</p>
<h4 data-id="heading-3">1. 跨两个仓库同时开发功能或修复</h4>
<p>你在主项目里开发一个新功能，但它需要依赖库也做相应改动。</p>
<p>与其等待依赖库合并、发布新版本，不如两个仓库并排开发。使用本地 <code>path</code> 仓库后，库的代码改动会立刻反映到主项目中。</p>
<h4 data-id="heading-4">2. 调试依赖库的行为</h4>
<p>有时依赖库的行为不符合预期。你可能需要加日志、检查内部状态、或单步调试库代码来定位问题。</p>
<p>使用本地副本会让这种“深度调试”变得容易很多。</p>
<h4 data-id="heading-5">3. 给开源包贡献代码</h4>
<p>如果你要给某个开源库提 PR，通常会希望先在真实项目里验证改动。</p>
<p>用本地 <code>path</code> 仓库可以避免为了测试而创建临时提交，也不必为了跑通流程专门用 fork。</p>
<h4 data-id="heading-6">4. 离线或受限网络环境下开发</h4>
<p>这更像是一种变通方案：某些企业网络环境可能无法访问 GitHub 或 Packagist。</p>
<p>本地 <code>path</code> 包可以让你在开发期完全离线使用依赖。</p>
<h4 data-id="heading-7">5. 处理未发布版本或实验性 API</h4>
<p>当你在尝试内部 API 或验证破坏性改动时，你可能还不想发布任何东西。</p>
<p>本地仓库给你一个更安全、可控的实验空间。</p>
<h4 data-id="heading-8">6. 快速迭代，不必频繁 bump 版本</h4>
<p>快速迭代时，不停地修改语义化版本号或切分支会很麻烦。</p>
<p>本地 <code>path</code> 仓库可以让你先跳过版本管理，等准备好发布时再统一处理。</p>
<h3 data-id="heading-9">如何在 Composer 中使用本地包</h3>
<p>你需要做的事情如下。</p>
<h4 data-id="heading-10">1. 在本地克隆依赖库</h4>
<p>把依赖库克隆到主项目附近，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/Projects/my</span>-project
~<span class="hljs-regexp">/Projects/</span>php-management-api-client  &lt;-- 克隆的库
</code></pre>
<p>注意：克隆出来的目录名不必与包名完全一致，只要路径与 <code>repositories</code> 的 <code>url</code> 配置匹配即可（见下一步）。</p>
<h4 data-id="heading-11">2. 修改 composer.json</h4>
<p>新增一个指向该目录的 <code>path</code> 仓库：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"repositories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"path"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../php-management-api-client"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"symlink"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h4 data-id="heading-12">3. 将依赖声明为开发版本</h4>
<p>使用本地包时，Composer 需要知道你希望安装的是开发版本，而不是 Packagist 上的稳定版本。</p>
<p>实现方式有多种，但我认为最可靠的是：直接指定一个明确的 dev 分支版本号，通常就是 <code>dev-main</code>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"storyblok/php-management-api-client"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dev-main"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">理解版本约束选项</h3>
<p>Composer 支持多种版本约束。下面是使用 <code>path</code> 仓库时最相关的几种：</p>
<ul>
<li><strong><code>dev-main</code></strong>：使用 main 分支上的开发版本。这是最可预测、也最推荐的方式，尤其当该库以 main 作为主要开发分支时。</li>
<li><strong><code>@dev</code></strong>：允许 Composer 安装任意开发版本（例如 <code>dev-main</code>、<code>dev-master</code> 或其他 dev 分支）。它比 <code>dev-main</code> 更灵活，但不够明确。</li>
<li><strong><code>"*"</code></strong>：接受任意版本（稳定或 dev）。我以前用过，但不推荐，因为 Composer 可能会选到出乎意料的版本。</li>
</ul>
<p>为了清晰与一致性，尤其当你使用本地克隆的库时，使用 <code>dev-main</code> 能确保 Composer 始终链接到你正在开发的那个分支（本例中为 main）。</p>
<h4 data-id="heading-14">4. 安装或更新</h4>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">composer update storyblok/php-management-api-client
</code></pre>
<h3 data-id="heading-15">最佳实践</h3>
<ul>
<li>保持本地克隆仓库干净，避免提交临时调试代码。</li>
<li>完成开发后切回 Packagist 版本。</li>
<li>除非你明确希望这样做，否则不要把本地路径配置提交到仓库中。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 API 文档走进编辑器会怎样？]]></title>    <link>https://juejin.cn/post/7583921477613797411</link>    <guid>https://juejin.cn/post/7583921477613797411</guid>    <pubDate>2025-12-16T00:12:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583921477613797411" data-draft-id="7583892482598912015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 API 文档走进编辑器会怎样？"/> <meta itemprop="keywords" content="Node.js,React.js,Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T00:12:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古韵"/> <meta itemprop="url" content="https://juejin.cn/user/1538972010422872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 API 文档走进编辑器会怎样？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1538972010422872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古韵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:12:40.000Z" title="Tue Dec 16 2025 00:12:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你做过中大型前端或 Node.js 项目，大概率对下面的场景并不陌生。</p>
<p>后端把接口定义在 Swagger / Apifox / YApi 里，前端在浏览器里打开文档，对着参数说明写 axios / fetch。接口多了之后：</p>
<ul>
<li>API 文件越来越臃肿</li>
<li>参数和返回结构靠“记忆 + 复制”</li>
<li>文档更新了，代码却没跟上</li>
<li>TypeScript 写得再认真，也挡不住接口变更</li>
</ul>
<p>问题的本质并不在于 axios 或 fetch，而在于：
<strong>API 文档和代码是割裂的。</strong></p>
<p>最近在一个项目中，在完整使用了 <strong>Alova3.x 的 OpenAPI 集成方案</strong>，它让我意识到：</p>
<blockquote>
<p>OpenAPI 不只是用来“生成请求代码”，而是可以成为拉近前后端协作距离的有力工具。</p>
</blockquote>
<p>这篇文章想聊的，正是这一点。</p>
<blockquote>
<p>这是alova3的完整OpenAPI集成方案，包含代码生成器和VS Code插件，旨在提升前端和Node.js开发者的API使用体验。</p>
</blockquote>
<h2 data-id="heading-0">从请求工具到API体系：Alova 在做什么不同的事</h2>
<p>Alova 可能很容易被误认为又一个“请求库”。</p>
<p>但它真正关注的并不是“怎么发请求”，而是 <strong>如何更高效地集成我们的API</strong>：
这也是为什么 Alova 在 OpenAPI 上的投入，和很多“只生成代码”的方案完全不同。</p>
<p>多数 OpenAPI 方案，只做到了一半，目前市面上常见的 OpenAPI 方案，大致分为两类：</p>
<ol>
<li><strong>只生成类型</strong>（如 openapi-typescript）</li>
<li><strong>生成请求函数</strong>（如 swagger-codegen 的 TS 客户端）</li>
</ol>
<p>它们解决了一个问题：👉 <em>“不用手写请求代码了”</em></p>
<p>但仍然留下几个核心缺口：</p>
<ul>
<li>API 的<strong>完整文档信息</strong>在生成后就丢失了</li>
<li>参数描述、示例、tags 无法被编辑器理解</li>
<li>想对生成结果做定制，成本极高</li>
<li>文档仍然在浏览器，代码仍然在编辑器</li>
</ul>
<p>Alova 的 OpenAPI 方案，明显是从 <strong>“开发体验”</strong> 而不是 <strong>“生成工具”</strong> 的角度重新设计的。具体我们继续往下看。</p>
<hr/>
<h2 data-id="heading-1">Alova OpenAPI 的核心思路：生成的不只是代码，而是 API 模型</h2>
<p>Alova 在解析 OpenAPI 时，保留的是<strong>完整语义模型</strong>，而不仅是 endpoint。</p>
<p>这意味着它生成的内容包括：</p>
<ul>
<li>请求方法</li>
<li>请求参数结构</li>
<li>响应类型</li>
<li>参数描述、注释</li>
<li>tags / 分组信息</li>
<li>文档结构本身</li>
</ul>
<p>这些信息并不会在生成后消失，而是被继续使用在后续的工具链中。<strong>API 的完整信息第一次真正进入了编辑器。</strong> 如下图，当调用api时，鼠标放到函数上将会看到完整的api信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58d9983dc2af42e28add43d212c24c51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6Z-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448760&amp;x-signature=WVs0lidliefQB2aviJZQ%2FXsLHQo%3D" alt="截屏2025-12-16 00.07.33.png" loading="lazy"/></p>
<h2 data-id="heading-2">VS Code 内嵌 API 文档树：这是体验分水岭</h2>
<p>不仅在代码中可以完整看到api的信息，安装 Alova 的 VSCode 插件后，你会看到一个非常关键的变化：API 不再是 URL + 方法的集合，而是一棵可浏览的文档树。</p>
<p>在编辑器中你可以：</p>
<ul>
<li>按 tag / 模块查看所有接口</li>
<li>搜索 API 名称、描述、路径</li>
<li>查看接口参数说明、类型、示例</li>
<li>直接跳转到对应的生成方法</li>
</ul>
<p>这和“生成一堆 TS 文件然后自己去找”是完全不同的体验。</p>
<p>它的意义在于：
<strong>API 从“外部资源”变成了“一等开发对象”。</strong> 看下面的图，现在你可以在编辑器和api文档进行交互了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b7855facf14ca9afeb9ecd60ce1695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k6Z-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766448760&amp;x-signature=eAGkWrZSGw7bwsnT1xq1VPkayPY%3D" alt="截屏2025-12-16 00.04.29.png" loading="lazy"/></p>
<h2 data-id="heading-3">生成结果是可控的，而不是“不可修改的黑盒”</h2>
<p>这是 Alova OpenAPI 方案里非常容易被忽略、但对工程化极其重要的一点。</p>
<p>Alova 并不把“生成代码”当作一次性行为，而是提供了：</p>
<ul>
<li>可配置的生成规则</li>
<li>可插拔的生成插件</li>
<li>对接口、参数、命名的自定义能力</li>
</ul>
<p>例如你可以：</p>
<ul>
<li>统一修改接口命名风格</li>
<li>过滤不需要的接口</li>
<li>调整参数结构映射方式</li>
<li>根据团队规范定制生成结果</li>
</ul>
<p>这意味着生成代码不是“只能接受”，而是<strong>可以融入你现有工程规范的产物</strong>。</p>
<p>例如，你可以通过预定义的插件给生成的函数改名为驼峰或下划线等。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({  
  <span class="hljs-attr">generator</span>: [  
    {  
    <span class="hljs-comment">// ...  </span>
    <span class="hljs-attr">plugins</span>: [  
      <span class="hljs-title function_">rename</span>(...),
    ]  
  }]  
})
</code></pre>
<p>更灵活的做法是可以定义<code>handleApi</code>自定义处理每个生成的api信息，例如，生成<code>response.data</code>对应的类型，使之与全局响应拦截器返回的数据对应。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-attr">generator</span>: [
    {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-attr">handleApi</span>: <span class="hljs-function"><span class="hljs-params">apiDescription</span> =&gt;</span> {
        apiDescriptor.<span class="hljs-property">responses</span> = apiDescriptor.<span class="hljs-property">responses</span>?.<span class="hljs-property">properties</span>?.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">return</span> apiDescriptor;
      };
    }
  ]
});
</code></pre>
<h2 data-id="heading-4">文档与代码同步，而不是“生成一次就结束”</h2>
<p>Alova 的 OpenAPI 工具支持定时拉取openapi的内容，并自动更新本地api信息。当 OpenAPI 发生变化时：</p>
<ul>
<li>API 结构自动更新</li>
<li>文档树自动同步</li>
<li>类型提示即时变化</li>
</ul>
<p>你不再需要：</p>
<ul>
<li>手动对比接口差异</li>
<li>猜测“后端是不是又改了点什么”</li>
<li>等运行时报错才发现参数不对</li>
</ul>
<p>实时同步api变动，保持前后端高度统一。</p>
<h2 data-id="heading-5">这套方案适合什么样的项目？</h2>
<p>Alova 的 OpenAPI 集成，尤其适合：</p>
<ul>
<li>API 数量较多的中大型项目</li>
<li>前后端并行开发、接口频繁调整</li>
<li>强调工程规范和可维护性的团队</li>
<li>Node.js / 前端共用 API 描述的场景</li>
</ul>
<p>如果你只是写几个简单接口，它可能显得“重”；
但一旦项目进入复杂度区间，它带来的回报是非常明显的。</p>
<hr/>
<h2 data-id="heading-6">写在最后</h2>
<p>这不是“又一个工具”，而是一种方向</p>
<p>当 API 文档可以被搜索、被跳转、被理解、被持续同步时，
上游工程师对接口的开发体验会发生改变。</p>
<p>如果你已经厌倦了在浏览器和编辑器之间来回切换，
或者正在为 API 维护成本感到头疼，
那么 Alova 的 OpenAPI 集成，值得你认真看一眼。</p>
<p>如果觉得alova还不错，真诚希望你可以<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fexamples" target="_blank" title="https://alova.js.org/examples" ref="nofollow noopener noreferrer">尝试体验一下</a>，也可以给我们来一个免费的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova" target="_blank" title="https://github.com/alovajs/alova" ref="nofollow noopener noreferrer">github stars</a>。</p>
<p>访问alovajs的官网查看更多详细信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alovajs官网</a>。</p>
<p>有兴趣可以加入我们的交流社区，在第一时间获取到最新进展，也能直接和开发团队交流，提出你的想法和建议。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fimg%2Fwechat_qrcode.jpg" target="_blank" title="https://alova.js.org/img/wechat_qrcode.jpg" ref="nofollow noopener noreferrer">加入微信群参与交流</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解锁Git隐藏力量：从熟练到大师的高级命令指南]]></title>    <link>https://juejin.cn/post/7583912899389521963</link>    <guid>https://juejin.cn/post/7583912899389521963</guid>    <pubDate>2025-12-16T00:14:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583912899389521963" data-draft-id="7583910637958742035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解锁Git隐藏力量：从熟练到大师的高级命令指南"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-16T00:14:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小马写码"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解锁Git隐藏力量：从熟练到大师的高级命令指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小马写码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:14:36.000Z" title="Tue Dec 16 2025 00:14:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾对Git感到畏惧，认为它仅仅是一个复杂的版本控制工具？对于许多开发者而言，Git的日常使用仅限于<code>add</code>、<code>commit</code>和<code>push</code>这几个基础命令。然而，在这看似简单的界面之下，隐藏着一个强大而优雅的版本控制系统，等待着我们去探索和掌握。</p>
<p>本文将带你超越Git的基础操作，深入那些能够显著提升工作效率、解决复杂问题的高级命令和技巧，让你从Git使用者蜕变为Git大师。</p>
<h2 data-id="heading-0">一、时光旅行者：精准操控提交历史</h2>
<h3 data-id="heading-1">交互式变基：重写历史的能力</h3>
<pre><code class="hljs language-bash" lang="bash">git rebase -i HEAD~5
</code></pre>
<p>这个命令会打开一个交互式界面，允许你重新排序、合并、编辑或删除最近的5个提交。这不仅仅是整理提交历史的美容工具，更是保持项目历史清晰可读的关键。</p>
<p><strong>实用场景</strong>：将多个琐碎的提交合并成一个逻辑完整的提交，使代码审查更加高效。</p>
<h3 data-id="heading-2">引用日志：找回丢失的提交</h3>
<pre><code class="hljs language-bash" lang="bash">git reflog
</code></pre>
<p>当你意外地执行了<code>git reset --hard</code>或删除了分支，<code>reflog</code>就是你的时光机。它记录了仓库中所有的HEAD移动历史，让你能够找回看似"丢失"的提交。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找回丢失的提交</span>
git reflog
<span class="hljs-comment"># 找到对应的提交哈希</span>
git checkout &lt;commit-hash&gt;
</code></pre>
<h2 data-id="heading-3">二、侦探模式：深入代码变更分析</h2>
<h3 data-id="heading-4">二分查找：快速定位问题引入点</h3>
<pre><code class="hljs language-bash" lang="bash">git bisect start
git bisect bad HEAD
git bisect good v1.0
</code></pre>
<p>当你在数百个提交中寻找引入bug的那个特定提交时，<code>git bisect</code>可以自动化这个过程。Git会智能地引导你在提交历史中进行二分查找，大大缩短问题定位时间。</p>
<h3 data-id="heading-5">高级日志筛选：精准过滤提交历史</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找特定作者在特定时间范围内的提交</span>
git <span class="hljs-built_in">log</span> --author=<span class="hljs-string">"John"</span> --since=<span class="hljs-string">"2023-01-01"</span> --until=<span class="hljs-string">"2023-06-30"</span>

<span class="hljs-comment"># 查找包含特定字符串的提交</span>
git <span class="hljs-built_in">log</span> -S <span class="hljs-string">"functionName"</span> --oneline

<span class="hljs-comment"># 可视化分支拓扑结构</span>
git <span class="hljs-built_in">log</span> --graph --oneline --all --decorate
</code></pre>
<h2 data-id="heading-6">三、工作流优化：提升日常效率</h2>
<h3 data-id="heading-7">储藏区的高级用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 储藏时添加描述</span>
git stash push -m <span class="hljs-string">"正在修复登录功能"</span>

<span class="hljs-comment"># 应用特定储藏</span>
git stash apply stash@{2}

<span class="hljs-comment"># 创建新分支并应用储藏</span>
git stash branch feature-login-fix stash@{1}
</code></pre>
<p>储藏不仅仅是临时保存更改，结合描述和分支创建，它可以成为上下文切换的强大工具。</p>
<h3 data-id="heading-8">提交修正：完善最近的提交</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 修改最近的提交信息</span>
git commit --amend

<span class="hljs-comment"># 添加文件到最近的提交</span>
git add forgotten_file.js
git commit --amend --no-edit
</code></pre>
<p><code>--amend</code>选项允许你修改最近的提交，而不是创建一个新的提交，保持历史整洁。</p>
<h2 data-id="heading-9">四、高级合并与冲突解决</h2>
<h3 data-id="heading-10">使用ours/theirs策略</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在合并冲突时，选择特定版本</span>
git checkout --ours conflicted-file.js
git checkout --theirs conflicted-file.js
</code></pre>
<p>当处理复杂合并冲突时，这些命令可以快速选择保留当前分支或合并分支的版本。</p>
<h3 data-id="heading-11">重新应用合并</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 放弃当前合并尝试，重新开始</span>
git merge --abort

<span class="hljs-comment"># 使用特定策略重新合并</span>
git merge -X patience feature-branch
</code></pre>
<p><code>-X patience</code>选项使用更智能的差异算法，在处理复杂重构时特别有用。</p>
<h2 data-id="heading-12">五、钩子与自定义：自动化工作流</h2>
<p>Git钩子位于<code>.git/hooks</code>目录中，允许你在特定事件发生时执行脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 示例：提交前检查代码格式</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment"># pre-commit hook</span>
<span class="hljs-keyword">if</span> ! npm run lint; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"代码格式检查失败，请修复后再提交"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<p>通过自定义钩子，你可以集成代码检查、测试运行、提交信息验证等自动化流程。</p>
<h2 data-id="heading-13">六、性能优化与维护</h2>
<h3 data-id="heading-14">垃圾回收与优化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理不必要的文件并优化本地仓库</span>
git gc --aggressive --prune=now

<span class="hljs-comment"># 重新打包对象以提高效率</span>
git repack -a -d --depth=250 --window=250
</code></pre>
<p>对于大型仓库，定期执行这些维护命令可以显著提升Git性能。</p>
<h3 data-id="heading-15">部分克隆：处理巨型仓库</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只克隆最近的历史</span>
git <span class="hljs-built_in">clone</span> --depth=1 https://github.com/large-repo.git

<span class="hljs-comment"># 按需获取特定目录</span>
git <span class="hljs-built_in">clone</span> --filter=blob:none --sparse https://github.com/large-repo.git
<span class="hljs-built_in">cd</span> large-repo
git sparse-checkout <span class="hljs-built_in">set</span> src/core
</code></pre>
<h2 data-id="heading-16">结语：从工具使用者到流程设计者</h2>
<p>正如我们所见，Git远不止于基础版本控制。这些高级命令和技巧将你从被动的工具使用者转变为主动的版本控制流程设计者。当你掌握了<code>reflog</code>的恢复能力、<code>bisect</code>的侦探技巧、交互式变基的历史重塑能力时，Git不再是一个需要小心应对的复杂系统，而是你开发工作流的自然延伸。</p>
<p>真正掌握Git的高级功能意味着你能以更少的努力完成更多工作，在团队协作中提供更多价值，并在面对复杂版本控制场景时保持从容。开始尝试这些命令，将它们融入你的日常工作中，你将会发现一个更高效、更可控的开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 3.x性能优化实战：这5个配置让你的应用启动速度提升50%]]></title>    <link>https://juejin.cn/post/7583892482599092239</link>    <guid>https://juejin.cn/post/7583892482599092239</guid>    <pubDate>2025-12-16T00:18:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583892482599092239" data-draft-id="7583921477613813795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 3.x性能优化实战：这5个配置让你的应用启动速度提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-16T00:18:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 3.x性能优化实战：这5个配置让你的应用启动速度提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:18:16.000Z" title="Tue Dec 16 2025 00:18:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 3.x性能优化实战：这5个配置让你的应用启动速度提升50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Spring Boot 作为 Java 生态中最流行的微服务框架之一，凭借其"约定优于配置"的理念和强大的自动装配能力，极大地简化了应用的开发和部署。然而，随着项目规模的扩大，Spring Boot 应用的启动时间可能会显著增加，尤其是在 Spring Boot 3.x 中，由于对 Jakarta EE 9+ 的支持和更多新特性的引入，启动性能的优化显得尤为重要。</p>
<p>本文将深入探讨 <strong>5 个关键配置项</strong>，通过实际案例和基准测试数据展示如何优化 Spring Boot 3.x 的启动性能。这些优化手段在真实项目中已验证可提升 <strong>50%以上的启动速度</strong>，同时不会牺牲功能完整性或代码可维护性。</p>
<hr/>
<h3 data-id="heading-2">1. 延迟初始化（Lazy Initialization）</h3>
<h4 data-id="heading-3">问题背景</h4>
<p>Spring Boot 默认会在启动时初始化所有的 Bean，以确保依赖注入的正确性。但对于大型项目，这会显著增加启动时间，尤其是当某些 Bean 仅在特定场景下使用时。</p>
<h4 data-id="heading-4">解决方案</h4>
<p>启用延迟初始化（Lazy Initialization）可以推迟 Bean 的创建时间，直到首次被请求时才初始化：</p>
<pre><code class="hljs language-properties" lang="properties"># application.properties
spring.main.lazy-initialization=true
</code></pre>
<h4 data-id="heading-5">优化效果</h4>
<ul>
<li><strong>典型场景</strong>：一个包含 200+ Bean 的项目，启动时间从 <strong>8s</strong> 降至 <strong>4s</strong>（提升约 50%）。</li>
<li><strong>注意事项</strong>：
<ol>
<li><strong>循环依赖问题</strong>：延迟初始化可能掩盖潜在的循环依赖问题，需通过 <code>@Lazy</code> 注解显式处理。</li>
<li><strong>首次请求延迟</strong>：首次访问某些接口时可能因 Bean 初始化而变慢。</li>
</ol>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. JVM Class Data Sharing (CDS)</h3>
<h4 data-id="heading-7">问题背景</h4>
<p>JVM 在启动时需要加载大量类文件，尤其是 Spring Boot 这种依赖繁多的框架。传统的类加载过程会重复解析字节码，浪费 CPU 资源。</p>
<h4 data-id="heading-8">解决方案</h4>
<p>使用 Class Data Sharing (CDS) 将已解析的类元数据缓存到共享归档文件中，后续启动时直接复用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step1:生成归档文件</span>
java -Xshare:dump -XX:SharedArchiveFile=app-cds.jsa -jar your-app.jar

<span class="hljs-comment"># Step2:启动时引用归档文件</span>
java -Xshare:on -XX:SharedArchiveFile=app-cds.jsa -jar your-app.jar
</code></pre>
<h4 data-id="heading-9">优化效果</h4>
<ul>
<li>JVM Warm Start: **30%+**的启动时间减少（实测从 <strong>6s →4s</strong>）。</li>
<li><strong>适用场景</strong>：容器化部署或频繁重启的环境（如开发调试）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. Spring Context Indexing（组件扫描优化）</h3>
<h4 data-id="heading-11">问题背景</h4>
<p>Spring Boot 默认通过类路径扫描（Component Scan）发现组件，这在大型项目中会成为性能瓶颈（如扫描数千个类）。</p>
<h4 data-id="heading-12">解决方案</h4>
<p>利用编译时生成的 <code>META-INF/spring.components</code>索引文件替代运行时扫描：</p>
<ol>
<li><strong>添加依赖</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-indexer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>验证索引生成</strong>：编译后检查 <code>target/classes/META-INF/spring.components</code>。</li>
</ol>
<h4 data-id="heading-13">优化效果</h4>
<ul>
<li>组件扫描时间从 <strong>2s →0.5s</strong>（减少75%）。</li>
<li>限制：仅对 <code>@Component</code>、<code>@Service</code>等静态注解有效，动态注册的 Bean仍需扫描。</li>
</ul>
<hr/>
<h3 data-id="heading-14">4. JVM AOT (Ahead-of-Time) Compilation with GraalVM</h3>
<h4 data-id="heading-15">问题背景</h4>
<p>传统的 JIT编译在运行时逐步优化代码，导致启动初期性能较差。AOT编译将部分优化工作提前到构建阶段。</p>
<h4 data-id="heading-16">解决方案</h4>
<p>结合 Spring Boot3.x的Native Image支持与GraalVM：</p>
<ol>
<li><strong>安装 GraalVM并配置环境变量</strong>。</li>
<li><strong>添加Native Build插件</strong>:</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>编译为原生镜像</strong>:</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn -Pnative native:compile
</code></pre>
<h4 data-id="heading-17">优化效果</h4>
<ul>
<li>启动时间从秒级降至毫秒级（如 <strong>50ms以内</strong>），内存占用降低60%。</li>
<li>代价：构建时间长、调试复杂度高、部分反射/动态代理功能受限。</li>
</ul>
<hr/>
<h3 data-id="heading-18">5. Logging System Optimization（日志系统调优）</h3>
<h4 data-id="heading-19">问题背景</h4>
<p>Logback/Log4j2等日志框架在初始化时会加载大量无用的Appender和Logger配置。</p>
<h4 data-id="heading-20">解决方案</h4>
<ol>
<li><strong>移除控制台日志输出</strong>（适用于生产环境）：</li>
</ol>
<pre><code class="hljs language-properties" lang="properties">logging.file.name=app.log 
logging.console.enabled=false
</code></pre>
<ol start="2">
<li><strong>简化日志级别配置</strong>:</li>
</ol>
<pre><code class="hljs language-properties" lang="properties">logging.level.root=WARN
logging.level.org.springframework=ERROR
logging.level.your.package=INFO
</code></pre>
<ol start="3">
<li><strong>(高级)异步日志写入</strong>: Log4j2的异步Logger可减少I/O阻塞:</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AsyncLogger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>/&gt;</span>
</code></pre>
<h4 data-id="heading-21">优化效果</h4>
<ul>
<li>日志相关初始化时间减少40%（从1.5s→0.9s）。</li>
</ul>
<hr/>
<h3 data-id="heading-22">总结</h3>
<p>通过组合上述5项技术——延迟初始化、CDS、上下文索引、AOT编译和日志优化——我们成功将一个中型SpringBoot3.x应用的启动时间从12秒缩短至6秒以内（降幅达50%）。每种技术各有适用场景:</p>









































<table><thead><tr><th>技术</th><th>适用阶段</th><th>收益</th><th>代价</th></tr></thead><tbody><tr><td>Lazy Init</td><td>开发/生产</td><td>高</td><td>需处理循环依赖</td></tr><tr><td>CDS</td><td>生产部署</td><td>中</td><td>需额外部署步骤</td></tr><tr><td>Context Indexing</td><td>大型项目</td><td>高</td><td>仅限静态组件</td></tr><tr><td>AOT(GraalVM)</td><td>云原生/K8S</td><td>极高</td><td>兼容性成本</td></tr><tr><td>Logging Opt.</td><td>通用</td><td>低至中</td><td>无</td></tr></tbody></table>
<p>建议根据项目特点分阶段实施这些优化策略。对于追求极致性能的场景（如Serverless），GraalVM Native Image是最佳选择；而对传统部署模式的项目，优先采用CDS+延迟初始化的组合更为稳妥。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cocos游戏开发中的箭头游戏效果]]></title>    <link>https://juejin.cn/post/7583948178857820206</link>    <guid>https://juejin.cn/post/7583948178857820206</guid>    <pubDate>2025-12-16T00:32:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583948178857820206" data-draft-id="7583910418658885678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cocos游戏开发中的箭头游戏效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T00:32:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cocos游戏开发中的箭头游戏效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:32:53.000Z" title="Tue Dec 16 2025 00:32:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/351d08362f0e4c9a82fdd6dd7644d2c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=yq54oUFrikXMuY6vKkPHK3iCFmA%3D" alt="游戏录屏" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>Cocos游戏开发中的箭头游戏效果</strong></p>
<p><strong>近日</strong>，笔者看到小伙伴正在推广他的小游戏，深入游玩了一波，非常精致和益智(就是有点花眼)。看了下排行榜，这类游戏目前依旧非常的火爆。</p>
<p><strong>言归正传</strong>，游戏体验过之后，非常感兴趣这个游戏中的箭头游戏效果是如何实现的呢？</p>
<p><strong>今天</strong>给大家介绍一下如何在<strong>Cocos游戏开发中实现箭头游戏效果</strong>，非常感谢小伙伴的投稿。</p>
<p><strong>本文源工程在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">1. 分析一下游戏</h2>
<p><strong>我们</strong>先来分析一下实现这个游戏有哪些关键点：</p>
<ol>
<li>
<p><strong>箭头</strong>：既然是箭头游戏，游戏的核心元素就是横七竖八的箭头。</p>
</li>
<li>
<p><strong>箭头的移动</strong>：箭头点击之后，可以移动，若前方无阻挡，则可以移出消除，反之则不可移动。</p>
</li>
<li>
<p><strong>关卡编辑</strong>：关卡类游戏离不开关卡的编辑，除非关卡的难度可以通过某些参数控制并随机，但是纯随机的游戏也不一定好玩。</p>
</li>
</ol>
<h2 data-id="heading-2">2. 怎么实现？</h2>
<h3 data-id="heading-3">1.箭头</h3>
<p><strong>箭头</strong>其实就是各种路径的线，然后在顶部加上一个三角形，即可形成箭头。</p>
<p><strong>在Cocos游戏开发中</strong>，画线常用的组件就是<code>Graphics</code>组件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf0fb254d3434affb36f25aadae548ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=lAERvUOcRJxCRODeVBLmZwZVTgQ%3D" alt="来源于Cocos官方文档" loading="lazy"/></p>
<p><strong>我们</strong>画箭头要用到的核心接口如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d091db8805415fab0fbdc12194820b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=y8919s%2B1hi2RDwExL6ht0awYb80%3D" alt="来源于Cocos官方文档" loading="lazy"/></p>
<p><strong>画线过程如下</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75ceeaadc52946039f7abe6374513df7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=bQ%2BwPM%2Fp1Oaa7q1ojjEWbbACE2k%3D" alt="" loading="lazy"/></p>
<p><strong>画箭头过程如下</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4244830378d94eb280688bd6f86693e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=bnSQoltgmcroqmAG%2BybpAtjHAmU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.箭头移动</h3>
<p><strong>箭头移动</strong>的逻辑其实和贪吃蛇比较相似，如下图，箭头由<code>5</code>段，<code>6</code>个点组成，箭头移动时，实际上只需要根据方向移动头和尾两个点即可，其他点不用动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78de73e7738409db4c93a5856901794~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=M5gXzOLthckacsXPNgpA42cfwd0%3D" alt="" loading="lazy"/></p>
<p><strong>当</strong>尾巴的点移动到下一个点的位置时，我们只需要把尾巴的点去掉，那么下一个点就成了新的尾巴。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a383fabfae064016b18417694c68a731~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=O%2FX9MUxzQzyxtowFJO%2FV6xUcTSk%3D" alt="" loading="lazy"/></p>
<p><strong>移动</strong>的方向只需要根据相邻的两个点即可判断。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4fbb9ceeda4d56bffd7cd8a0f716ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=ONy3H5CdgyzO6JY1SrLODUVSoJ0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3. 关卡编辑</h3>
<p><strong>游戏</strong>的功能实现比较简单，较为复杂的在于编辑器，编辑器既要做到方便编辑，最理想的状态下是能够轻松地根据难度生成不同的关卡，又要能够检测关卡是否能正常通关。下面列举几种：</p>
<ul>
<li><strong>手动编辑</strong>：生成格子盘，然后通过鼠标点击标注不产生箭头的区域，然后生成。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31a97827aeed4c54a32e8e663dd5b4eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=8TjDJPyd%2FlwGUQiujXI3KSJC6x4%3D" alt="" loading="lazy"/></li>
<li><strong>自动生成</strong>：根据规则自动生成，自动检测生成的关卡是否能顺利通关。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49a120b43be14571ae520f106e2e9233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=EadglclxwloHMXB2m1cfEsWh7dE%3D" alt="" loading="lazy"/></li>
<li><strong>上传图片生成</strong>：上传不同形状的图片，根据图片像素去生成关卡，使得关卡更加有趣。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc3515de71fb459ba3750166554f290b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=OJjXAAZfvhHWu6XNLqBkn1IcDtw%3D" alt="" loading="lazy"/></li>
<li><strong>Excel编辑生成</strong>: 最近看到有小伙伴在<code>Excel</code>中进行关卡编辑，并且通过宏生成关卡数据，让笔者眼前一亮。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378ac708eb67413daada184ad7798d0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=h0RdUgnvd8vhT3VQiwvtp98iCHc%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong>最后看看</strong>小伙伴们编辑生成的精美关卡(<strong>文末可获取编辑器</strong>)。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393695fa8eb04239ad73c9091920dfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=XtFSlcwZt1eGi1Df5kbhqj7q1XQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">3. 箭头游戏效果实战</h2>
<h3 data-id="heading-7">1.创建工程</h3>
<p><strong>引擎版本</strong>：<code>Cocoscreator 3.8.7</code></p>
<p><strong>编程语言</strong>：<code>TypeScript</code></p>
<p><strong>首先</strong>创建一个<code>Arrow</code>工程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eac1daaf9b594f3e88f3532f3e425e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=z0Z9P%2Bw%2BRboeMxlkD5RyW7OKfjU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.创建脚本</h3>
<p><strong>新建</strong>一个<code>Main.ts</code>脚本，并且拖拽到<code>Canvas</code>，用于实现我们的实战逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99d6de63e0904f718bdc0fe1ac358ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=Yzv8Z3gJ9T64n9VGPyvy9xqJpS4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.画箭头</h3>
<p><strong>首先</strong>根据原理，我们通过<code>Graphics</code>组件实现，打开<code>Main.ts</code>脚本，在<code>start</code>方法中添加<code>Graphics</code>组件，并且画一根线宽为<code>10</code>，坐标从<code>(0,0)</code>到<code>(0,200)</code>的线。</p>
<ul>
<li><strong>moveTo</strong>: 移动到画线起点。</li>
<li><strong>lineTo</strong>: 画线到该点。</li>
<li><strong>stroke</strong>: 开始画线。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d9b38dd3d4d46cebb34b0ffa241682d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=9578ZQ54TjbEeQvL65vJwDP%2B4aU%3D" alt="" loading="lazy"/></p>
<p><strong>运行后</strong>就能看到一根长<code>200</code>的线。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaaab049acf74a219116351a30a23dd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=PIooOJPNyMJz8K8vBzZIluXKXZ8%3D" alt="" loading="lazy"/></p>
<p><strong>接下来</strong>我们要画一个三角形，让线头变成箭头，先找到三个点，然后通过<code>fill</code>进行填充形成三角形。</p>
<ul>
<li><strong>close</strong>: 从当前点画线到起点。</li>
<li><strong>fillColor</strong>: 填充颜色。</li>
<li><strong>fill</strong>: 填充。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d614be941994659ac5c6f3e1db1a2a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=3kur4KEJjSjik8a%2FfJ4X9OhUdUM%3D" alt="" loading="lazy"/></p>
<p><strong>运行后</strong>就能看到线变成了箭头。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f07b480df1e24d5c98d9e674388e06cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=6ciVobspSYoTYSeljIP8QRaCk0s%3D" alt="" loading="lazy"/></p>
<p><strong>箭头</strong>一般不止<code>2</code>个点，于是我们把方法整理一下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b058b3a92ff0490c94809f6b2780fb7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=ElrgPFwKfrI9SdKaLOyhxzXepU4%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>箭头的路径点加进去，然后进行绘制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71a9ad1115f84f6d9ab0cf2778a1f888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=Njr9GQxdz7bnR%2BEAEvpLImBpOhc%3D" alt="" loading="lazy"/></p>
<p><strong>运行后</strong>就能得到一个这样的箭头。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34a595029e84b928da60bab055c64d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=xDjXdVHL%2FTsvxRjIR7%2FOua7yzGQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">4.箭头移动</h3>
<p><strong>箭头移动</strong>的逻辑相对好写一点，就是让头和尾巴的点沿着方向移动即可，当尾巴点和前一节接触后移除。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84fbad5e5264f439b995ee4e64c9c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=Krn%2FckSDZeEJWuDk0wCmHTHEGfk%3D" alt="" loading="lazy"/></p>
<p><strong>点击</strong>开始移动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78a5aa324e644aef9ec5473358314fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=YhKDoSovbS%2FdUUCM1wuII4MrNAY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">5.效果演示</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/731a3bad16d34514b5274c7afc8776ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766449972&amp;x-signature=dXg0JIJ4Te64yLAk0HcuLD9aJMs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">结语</h2>
<p><strong>还有</strong>没玩过这类游戏的吗？实在太火爆了，变种的才刚出来，还能分口热汤吗？</p>
<p>本文<strong>实战源码</strong>可通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FdMH_075O82u-O1J8NVfJBw" target="_blank" title="https://mp.weixin.qq.com/s/dMH_075O82u-O1J8NVfJBw" ref="nofollow noopener noreferrer"><strong>阅读原文</strong></a>获取。</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter使用package_info_plus库获取应用信息的教程]]></title>    <link>https://juejin.cn/post/7583910637958807571</link>    <guid>https://juejin.cn/post/7583910637958807571</guid>    <pubDate>2025-12-16T00:40:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910637958807571" data-draft-id="7583577045578530842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter使用package_info_plus库获取应用信息的教程"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-16T00:40:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter使用package_info_plus库获取应用信息的教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:40:41.000Z" title="Tue Dec 16 2025 00:40:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 简介</h2>
<p>在 Flutter 应用开发中，获取应用自身的信息（如应用名称、版本号、包名等）是一项常见需求，这些信息可用于展示在关于页面、用于统计分析或实现特定业务逻辑。<code>package_info_plus</code> 插件是 Flutter 生态中获取应用元数据的最佳选择，支持多平台且使用简单。本文将详细介绍如何使用该插件获取各类应用信息。</p>
<p><code>package_info_plus</code> 是一个跨平台插件，用于获取应用的包信息和元数据，它是 <code>package_info</code> 插件的升级版，由 Flutter Community 维护。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>支持 iOS、Android、Web、Windows、macOS 和 Linux 多平台</li>
<li>能够获取应用名称、包名、版本号、构建号等关键信息</li>
<li>用法简单，API 直观</li>
<li>与最新的 Flutter 版本保持兼容</li>
</ul>
<p><strong>可获取的主要信息</strong>：</p>
<ul>
<li>应用名称（应用商店中显示的名称）</li>
<li>包名/应用 ID（如 com.example.myapp）</li>
<li>版本名称（如 1.0.0）</li>
<li>版本号/构建号（如 1）</li>
<li>应用签名（部分平台）</li>
</ul>
<h2 data-id="heading-1">2. 安装与配置</h2>
<p>在项目的 <code>pubspec.yaml</code> 文件中添加 <code>package_info_plus</code> 依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">package_info_plus:</span> <span class="hljs-string">^4.0.0</span>  <span class="hljs-comment"># 使用最新版本</span>
</code></pre>
<p>运行以下命令安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h3 data-id="heading-2">2.1. 平台特定配置</h3>
<p><code>package_info_plus</code> 在大多数平台上无需额外配置即可使用，但某些平台可能需要注意以下事项：</p>
<p><strong>Web 平台</strong>：
需要在 <code>web/index.html</code> 中添加一些元数据，插件会从这里读取信息：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 其他头部内容 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"application-name"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"你的应用名称"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"version"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"1.0.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"build-number"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"package"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"com.example.myapp"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<p><strong>其他平台</strong>：
Android、iOS、Windows、macOS 和 Linux 平台不需要额外配置，插件会自动从各自的配置文件中读取信息。</p>
<h2 data-id="heading-3">3. 基本使用方法</h2>
<p>在需要使用的 Dart 文件中导入 <code>package_info_plus</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:package_info_plus/package_info_plus.dart'</span>;
</code></pre>
<h3 data-id="heading-4">3.1. 获取应用信息</h3>
<p><code>package_info_plus</code> 提供了一个 <code>PackageInfo</code> 类，通过它可以获取所有应用信息。获取过程是异步的，通常使用 <code>await</code> 关键字：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; getAppInfo() <span class="hljs-keyword">async</span> {
  PackageInfo packageInfo = <span class="hljs-keyword">await</span> PackageInfo.fromPackageInfo();
  
  <span class="hljs-built_in">String</span> appName = packageInfo.appName;
  <span class="hljs-built_in">String</span> packageName = packageInfo.packageName;
  <span class="hljs-built_in">String</span> version = packageInfo.version;
  <span class="hljs-built_in">String</span> buildNumber = packageInfo.buildNumber;
  
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'应用名称: <span class="hljs-subst">$appName</span>'</span>);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'包名: <span class="hljs-subst">$packageName</span>'</span>);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'版本号: <span class="hljs-subst">$version</span>'</span>);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'构建号: <span class="hljs-subst">$buildNumber</span>'</span>);
}
</code></pre>
<h3 data-id="heading-5">3.2. 详细信息说明</h3>
<p><code>PackageInfo</code> 类提供的主要属性：</p>








































<table><thead><tr><th>属性</th><th>说明</th><th>平台支持</th></tr></thead><tbody><tr><td><code>appName</code></td><td>应用的用户可见名称</td><td>所有平台</td></tr><tr><td><code>packageName</code></td><td>应用的唯一标识符（Android 的包名，iOS 的 Bundle ID 等）</td><td>所有平台</td></tr><tr><td><code>version</code></td><td>应用的版本名称（如 1.0.0）</td><td>所有平台</td></tr><tr><td><code>buildNumber</code></td><td>应用的构建号或版本代码（通常是整数）</td><td>所有平台</td></tr><tr><td><code>buildSignature</code></td><td>应用的签名信息</td><td>Android 特有</td></tr><tr><td><code>installerStore</code></td><td>应用的安装来源商店</td><td>Android 特有</td></tr></tbody></table>
<h2 data-id="heading-6">4. 实战示例</h2>
<p>下面是一个完整的示例，创建一个展示应用信息的"关于"页面：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:package_info_plus/package_info_plus.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AboutPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> AboutPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;AboutPage&gt; createState() =&gt; _AboutPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AboutPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AboutPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> Future&lt;PackageInfo&gt; _packageInfoFuture;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 初始化时获取应用信息</span>
    _packageInfoFuture = PackageInfo.fromPackageInfo();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'关于我们'</span>),
      ),
      body: FutureBuilder&lt;PackageInfo&gt;(
        future: _packageInfoFuture,
        builder: (context, snapshot) {
          <span class="hljs-keyword">if</span> (snapshot.connectionState == ConnectionState.waiting) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshot.hasError) {
            <span class="hljs-keyword">return</span> Center(child: Text(<span class="hljs-string">'获取应用信息失败: <span class="hljs-subst">${snapshot.error}</span>'</span>));
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!snapshot.hasData) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: Text(<span class="hljs-string">'无法获取应用信息'</span>));
          }

          PackageInfo packageInfo = snapshot.data!;

          <span class="hljs-keyword">return</span> SingleChildScrollView(
            padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16.0</span>),
            child: Column(
              children: [
                <span class="hljs-comment">// 应用图标</span>
                <span class="hljs-keyword">const</span> CircleAvatar(
                  radius: <span class="hljs-number">60</span>,
                  child: Icon(Icons.android, size: <span class="hljs-number">60</span>), <span class="hljs-comment">// 实际项目中替换为应用图标</span>
                ),
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">24</span>),
                
                <span class="hljs-comment">// 应用名称</span>
                Text(
                  packageInfo.appName,
                  style: Theme.of(context).textTheme.headlineMedium,
                ),
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
                
                <span class="hljs-comment">// 版本信息</span>
                Text(
                  <span class="hljs-string">'版本: <span class="hljs-subst">${packageInfo.version}</span> (<span class="hljs-subst">${packageInfo.buildNumber}</span>)'</span>,
                  style: Theme.of(context).textTheme.titleMedium,
                ),
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">24</span>),
                
                <span class="hljs-comment">// 详细信息列表</span>
                _buildInfoItem(<span class="hljs-string">'包名'</span>, packageInfo.packageName),
                <span class="hljs-keyword">if</span> (packageInfo.buildSignature.isNotEmpty)
                  _buildInfoItem(<span class="hljs-string">'应用签名'</span>, packageInfo.buildSignature),
                <span class="hljs-keyword">if</span> (packageInfo.installerStore != <span class="hljs-keyword">null</span> &amp;&amp; packageInfo.installerStore!.isNotEmpty)
                  _buildInfoItem(<span class="hljs-string">'安装来源'</span>, packageInfo.installerStore!),
                
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">32</span>),
                
                <span class="hljs-comment">// 版权信息</span>
                <span class="hljs-keyword">const</span> Text(
                  <span class="hljs-string">'© 2023 你的公司名称. 保留所有权利.'</span>,
                  style: TextStyle(color: Colors.grey),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  <span class="hljs-comment">// 构建信息项</span>
  Widget _buildInfoItem(<span class="hljs-built_in">String</span> label, <span class="hljs-built_in">String</span> value) {
    <span class="hljs-keyword">return</span> Padding(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8.0</span>),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            <span class="hljs-string">'<span class="hljs-subst">$label</span>: '</span>,
            style: <span class="hljs-keyword">const</span> TextStyle(
              fontWeight: FontWeight.bold,
              width: <span class="hljs-number">100</span>,
            ),
          ),
          Expanded(
            child: Text(value),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>这个示例创建了一个完整的"关于"页面，包含以下功能：</p>
<ul>
<li>使用 <code>FutureBuilder</code> 处理异步获取应用信息的过程</li>
<li>展示加载状态、错误状态和成功状态</li>
<li>显示应用名称、图标、版本号等基本信息</li>
<li>根据平台特性选择性展示签名和安装来源信息</li>
</ul>
<h2 data-id="heading-7">5. 高级应用场景</h2>
<p>下面是一些高级的应用场景，例如：</p>
<h3 data-id="heading-8">5.1. 版本更新检查</h3>
<p>可以使用获取到的版本号实现版本更新检查功能：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VersionChecker</span> </span>{
  <span class="hljs-comment">// 假设这是从服务器获取的最新版本号</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> _latestVersion = <span class="hljs-string">"1.1.0"</span>;
  
  Future&lt;<span class="hljs-built_in">bool</span>&gt; isUpdateAvailable() <span class="hljs-keyword">async</span> {
    PackageInfo packageInfo = <span class="hljs-keyword">await</span> PackageInfo.fromPackageInfo();
    <span class="hljs-keyword">return</span> _compareVersions(packageInfo.version, _latestVersion) &lt; <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// 版本号比较工具方法</span>
  <span class="hljs-built_in">int</span> _compareVersions(<span class="hljs-built_in">String</span> current, <span class="hljs-built_in">String</span> latest) {
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; currentParts = current.split(<span class="hljs-string">'.'</span>).map(<span class="hljs-built_in">int</span>.parse).toList();
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; latestParts = latest.split(<span class="hljs-string">'.'</span>).map(<span class="hljs-built_in">int</span>.parse).toList();
    
    <span class="hljs-built_in">int</span> maxLength = max(currentParts.length, latestParts.length);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; maxLength; i++) {
      <span class="hljs-built_in">int</span> currentPart = i &lt; currentParts.length ? currentParts[i] : <span class="hljs-number">0</span>;
      <span class="hljs-built_in">int</span> latestPart = i &lt; latestParts.length ? latestParts[i] : <span class="hljs-number">0</span>;
      
      <span class="hljs-keyword">if</span> (currentPart &lt; latestPart) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">if</span> (currentPart &gt; latestPart) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">void</span> checkForUpdates() <span class="hljs-keyword">async</span> {
  VersionChecker checker = VersionChecker();
  <span class="hljs-built_in">bool</span> hasUpdate = <span class="hljs-keyword">await</span> checker.isUpdateAvailable();
  <span class="hljs-keyword">if</span> (hasUpdate) {
    <span class="hljs-comment">// 显示更新提示</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"有新版本可用！"</span>);
  }
}
</code></pre>
<h3 data-id="heading-9">5.2. 应用使用统计</h3>
<p>结合设备信息和应用信息，可以实现应用使用统计：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:device_info_plus/device_info_plus.dart'</span>;

Future&lt;<span class="hljs-keyword">void</span>&gt; trackAppUsage() <span class="hljs-keyword">async</span> {
  PackageInfo packageInfo = <span class="hljs-keyword">await</span> PackageInfo.fromPackageInfo();
  DeviceInfoPlugin deviceInfo = DeviceInfoPlugin();
  
  <span class="hljs-built_in">String</span> trackingInfo = <span class="hljs-string">'''
  应用信息:
  - 名称: <span class="hljs-subst">${packageInfo.appName}</span>
  - 版本: <span class="hljs-subst">${packageInfo.version}</span>
  - 包名: <span class="hljs-subst">${packageInfo.packageName}</span>
  
  设备信息:
  '''</span>;
  
  <span class="hljs-keyword">if</span> (Platform.isAndroid) {
    AndroidDeviceInfo androidInfo = <span class="hljs-keyword">await</span> deviceInfo.androidInfo;
    trackingInfo += <span class="hljs-string">'- 设备: <span class="hljs-subst">${androidInfo.brand}</span> <span class="hljs-subst">${androidInfo.model}</span>\n'</span>;
    trackingInfo += <span class="hljs-string">'- 系统版本: Android <span class="hljs-subst">${androidInfo.version.release}</span>'</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Platform.isIOS) {
    IosDeviceInfo iosInfo = <span class="hljs-keyword">await</span> deviceInfo.iosInfo;
    trackingInfo += <span class="hljs-string">'- 设备: <span class="hljs-subst">${iosInfo.model}</span>\n'</span>;
    trackingInfo += <span class="hljs-string">'- 系统版本: iOS <span class="hljs-subst">${iosInfo.systemVersion}</span>'</span>;
  }
  
  <span class="hljs-comment">// 实际项目中，这里会将统计信息发送到服务器</span>
  <span class="hljs-built_in">print</span>(trackingInfo);
}
</code></pre>
<h3 data-id="heading-10">5.3. 动态配置应用行为</h3>
<p>根据应用版本动态配置应用行为：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; configureAppBehavior() <span class="hljs-keyword">async</span> {
  PackageInfo packageInfo = <span class="hljs-keyword">await</span> PackageInfo.fromPackageInfo();
  
  <span class="hljs-comment">// 根据不同版本启用不同功能</span>
  <span class="hljs-keyword">if</span> (packageInfo.version.startsWith(<span class="hljs-string">'1.0.'</span>)) {
    <span class="hljs-comment">// v1.0.x 版本的配置</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'配置基础功能'</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (packageInfo.version.startsWith(<span class="hljs-string">'1.1.'</span>)) {
    <span class="hljs-comment">// v1.1.x 版本的配置</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'配置高级功能'</span>);
  }
  
  <span class="hljs-comment">// 根据构建号启用测试功能</span>
  <span class="hljs-built_in">int</span> buildNumber = <span class="hljs-built_in">int</span>.tryParse(packageInfo.buildNumber) ?? <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (buildNumber &gt;= <span class="hljs-number">100</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'启用beta功能'</span>);
  }
}
</code></pre>
<h2 data-id="heading-11">6. 注意事项</h2>
<ul>
<li><strong>异步处理</strong>
<ul>
<li><code>PackageInfo.fromPackageInfo()</code> 是异步方法，必须正确处理异步操作</li>
<li>建议在应用启动时获取一次应用信息并缓存，避免重复获取</li>
<li>使用 <code>FutureBuilder</code> 或状态管理工具（如 Provider、Bloc）处理 UI 渲染</li>
</ul>
</li>
<li><strong>平台差异</strong>
<ul>
<li>不同平台上的信息可能有所不同，尤其是 <code>buildSignature</code> 和 <code>installerStore</code> 等平台特定属性</li>
<li>Web 平台需要手动配置元数据，其他平台则自动读取</li>
<li>处理平台特定属性时，应先检查其是否存在或不为空</li>
</ul>
</li>
<li><strong>版本号管理</strong>
<ul>
<li>保持 <code>pubspec.yaml</code>、AndroidManifest.xml 和 Info.plist 中的版本信息同步</li>
<li>建立清晰的版本号命名规则（如语义化版本 主版本.次版本.修订号）</li>
<li>构建号应随每次构建递增，用于区分不同构建</li>
</ul>
</li>
<li><strong>性能考虑</strong>
<ul>
<li>应用信息不会频繁变化，无需多次获取</li>
<li>建议在应用初始化阶段获取并存储在全局状态中</li>
<li>避免在 UI 渲染关键路径中获取应用信息</li>
</ul>
</li>
</ul>
<h2 data-id="heading-12">7. 常见问题解决</h2>
<ul>
<li><strong>信息不准确或未更新</strong>
<ul>
<li>确保所有平台的配置文件都已更新版本信息</li>
<li>运行 <code>flutter clean</code> 清理缓存后重新构建</li>
<li>对于 Web 平台，检查 <code>index.html</code> 中的元数据是否正确</li>
</ul>
</li>
<li><strong>某些属性为空</strong>
<ul>
<li>某些属性（如 <code>installerStore</code>）仅在特定条件下才有值</li>
<li>检查是否在正确的平台上访问平台特定属性</li>
<li>Web 平台需要手动配置所有属性</li>
</ul>
</li>
<li><strong>构建错误</strong>
<ul>
<li>确保使用的 <code>package_info_plus</code> 版本与 Flutter 版本兼容</li>
<li>检查是否正确导入了包</li>
<li>尝试更新插件到最新版本</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">8. 总结</h2>
<p><code>package_info_plus</code> 是 Flutter 开发中获取应用元数据的实用工具，它提供了简单直观的 API，支持多平台，能够满足大多数应用对获取自身信息的需求。</p>
<p>合理利用应用信息可以提升用户体验，简化开发流程，并为应用的统计分析提供支持。更多详细信息可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fpackage_info_plus" target="_blank" title="https://pub.dev/packages/package_info_plus" ref="nofollow noopener noreferrer">官方文档</a>。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四大组件齐上阵，轻松拿捏实习生]]></title>    <link>https://juejin.cn/post/7583891046206799924</link>    <guid>https://juejin.cn/post/7583891046206799924</guid>    <pubDate>2025-12-16T00:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583891046206799924" data-draft-id="7579095566900183080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四大组件齐上阵，轻松拿捏实习生"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2025-12-16T00:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四大组件齐上阵，轻松拿捏实习生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:50:41.000Z" title="Tue Dec 16 2025 00:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<h2 data-id="heading-0">五）四大组件齐上阵，轻松拿捏实习生</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c629f988139f415bb914a6f10e38c65f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451041&amp;x-signature=9jBkfAtKsKpeqADMKq8QGZAdyGM%3D" alt="0.png" loading="lazy"/></p>
<p>新的一周开始了，晨会刚结束，老杨拍了拍林卓的肩膀：“你的小徒弟们来了，公司校招提前招了三个没毕业的大学生来实习，他们都有Java基础，也懂点Android入门知识，估计大学自己研究过Android，这周就交给你带教了。”</p>
<p>他顿了顿，忍不住吐槽：“说起来这年头大学里学Android开发的不多了，能有基础已经算不错啦。”</p>
<p>林卓转头望去，工位旁站着三个略显拘谨的年轻人，手里都攥着笔记本，眼神里满是期待与紧张——他们是晓雅、阿泽和博文，都是这次校招进来的实习生。</p>
<p>“我是林卓，负责你们本周的Android开发入门带教。”林卓笑着打破尴尬，“先带你们熟悉下公司环境，重点记一下开发部和测试部的位置，后续工作会经常对接。”</p>
<p>他带着三人穿梭在办公区，路过测试区时，恰好碰到小安在调试APP。只见她的桌子上摆满了各式各样的测试设备，从不同型号的手机到平板整齐排列，还有不少连接着设备的数据线，一看就是在进行多设备兼容性测试。三人看着这阵仗，心里顿时咯噔一下，暗自觉得测试工作原来如此严格，半点马虎不得。</p>
<p>“这是测试组的小安姐，你们写的代码最终都要过她的测试关。”</p>
<p>小安抬头冲三人温和一笑，抬手打了个招呼：“你们好呀，我是小安，负责APP测试相关的工作，以后多多指教。”</p>
<p>三个实习生连忙笑着回应“小安姐好”，眼神里满是礼貌与拘谨。</p>
<p>回到开发工位，林卓打开电脑说道：“今天上午的核心任务是搭建Android开发环境，相关配置文档我已经发你们邮箱了。安装时记得勾选 <strong>SDK</strong> 相关组件，尤其是咱们项目常用的 <strong>API 33</strong> 版本，遇到问题随时喊我。”</p>
<p>没过多久，留着波浪卷的晓雅便举手提问，语气活泼又带着几分急切：“林哥，<strong>SDK</strong> 安装失败了，提示找不到镜像源，是不是需要配置什么特殊设置啊？”</p>
<p>林卓走过去查看后，先笑着问晓雅：“你在大学学Android的时候，没碰到过 <strong>SDK</strong> 安装的问题吗？当时是怎么解决的？”</p>
<p>晓雅有些不好意思地挠挠头：“林哥，我们在学校都是学长提前帮我们装好了开发环境，用的Android版本也比较老，没涉及到镜像源配置这些操作，所以第一次自己装就卡壳了。”</p>
<p>林卓了然点头，随后解释道：“Android部分资源在国内访问速度较慢，需要在 <strong>SDK Manager</strong> 里配置国内镜像地址。另外记得勾选对应版本的 <strong>Sources for Android SDK</strong>，后续查看源码会比较方便。”</p>
<p>在林卓的逐一指导下，三人陆续解决了安装过程中的各类小问题，没多久就都完成了开发环境的搭建。</p>
<p>林卓看了眼时间，对三人说道：“开发环境都搞定了，咱们去培训室讲解知识点吧，那里环境更安静，也方便用投影演示代码。”说完便带头走向培训室，晓雅、阿泽和博文连忙带上笔记本和电脑跟了上去。</p>
<p>到了培训室，林卓连接好投影，打开 <strong>Android Studio</strong> 新建了一个项目：“开发环境搭建完成后，咱们先从最基础的配置文件入手，正式讲解Android四大组件。大家看投影上的项目结构，有没有注意到一个叫 <code>AndroidManifest.xml</code> 的文件？”</p>
<p>戴眼镜的阿泽立刻应声：“我知道这个文件，它是Android应用的全局配置文件！”</p>
<p>“没错，”林卓赞许地点点头，“它就像应用的‘身份证’，系统正是通过它识别APP包含的组件、所需的权限以及应用入口等核心信息。”</p>
<p>他指着代码中的 <code>&lt;activity&gt;</code> 标签讲解：“这个 <code>MainActivity</code> 就是咱们APP的主启动页面，通过 <code>intent-filter</code> 里的 <code>MAIN</code> 和 <code>LAUNCHER</code> 属性声明。要是没配置这个入口，桌面上不会显示应用图标，用户也就无法直接启动APP了。”</p>
<p>博文突然开口提问：“那 <code>Service</code> 这类其他组件，也需要在这个文件里注册吗？”</p>
<p>林卓心里暗自了然：看来这三个实习生在学校偏重于界面开发，像 <code>Service</code> 这种后台组件接触得不多，难怪会有这个疑问，得好好把基础讲扎实了。</p>
<p>“问得很关键，”林卓补充道，“Android四大组件都必须在 <code>AndroidManifest.xml</code> 里注册，包括 <code>Service</code>、<code>BroadcastReceiver</code> 和 <code>ContentProvider</code>，否则系统无法识别和启动这些组件。”</p>
<p>晓雅紧跟着追问：“林哥，要是注册时填错了组件名称，会出现什么问题？会不会导致APP直接崩溃啊？”</p>
<p>林卓点头回应：“会的，这种情况下不管是启动该组件，还是后续使用到它，都会直接触发崩溃。”</p>
<p>晓雅立刻追着问：“那崩溃后有什么快速排查方法吗？比如日志里会有明确提示吗？”</p>
<p>林卓继续解答：“日志里会报 <code>ClassNotFoundException</code> 异常，到时直接搜索这个异常信息，就能快速定位到 <code>AndroidManifest</code> 里的配置错误，排查起来很方便。”</p>
<p>他顿了顿，补充了一个关联知识点：“对了，顺带提一下 <code>Application</code> ——它是整个应用的全局入口，在所有组件初始化之前创建，适合用来初始化数据库、网络库这类全局资源。”</p>
<p>“但别在它的 <code>onCreate</code> 方法里做耗时操作，否则会拖慢APP启动速度；而且它的生命周期和应用进程绑定，和 <code>Activity</code> 这种频繁创建销毁的组件完全不同。”</p>
<p>讲完 <code>AndroidManifest</code> 的基础配置和 <code>Application</code> 的关联知识，林卓看了眼时间，明确了当天的学习安排：“咱们今天分上下午推进学习，上午重点讲解 <code>Activity</code> 这个核心组件，先打牢基础；下午再讲解剩下的<code>Service</code>、<code>BroadcastReceiver</code> 和 <code>ContentProvider</code>。现在，咱们从最核心的 <code>Activity</code> 开始讲起。”</p>
<p>“<code>Activity</code> 是 APP与用户交互的核心入口，主要负责UI展示。大家可以想一想，打开一个APP从启动到退出，<code>Activity</code> 会经历哪些过程？”林卓抛出问题引导思考。</p>
<p>晓雅回忆片刻，立刻接话：“应该是创建、启动、运行，最后关闭吧？”</p>
<p>“这个概括比较笼统，Android系统为 <code>Activity</code> 定义了明确的生命周期回调方法。”林卓打开一个示例代码，逐一标出 <code>onCreate</code>、<code>onStart</code>、<code>onResume</code> 等核心方法。</p>
<p>他详细解释道：“比如首次启动 <code>Activity</code>，会依次执行 <code>onCreate</code>→<code>onStart</code>→<code>onResume</code>；”</p>
<p>“当你打开一个新 <code>Activity</code> 把它覆盖时，它会先执行 <code>onPause</code>，等完全不可见后再执行 <code>onStop</code>；”</p>
<p>“要是按返回键退出，就会依次执行 <code>onPause</code>→<code>onStop</code>→<code>onDestroy</code>。”</p>
<p>阿泽紧接着追问：“那要是旋转手机屏幕，<code>Activity</code> 会发生什么变化？”</p>
<p>晓雅也跟着点头：“对，我之前试过旋转屏幕后，输入的内容就不见了，这种问题怎么解决最稳妥呢？”</p>
<p>林卓笑着回应：“这是开发中很常见的关键问题，默认情况下，屏幕旋转这类配置变更会导致 <code>Activity</code> 重启，之前的UI状态也就随之丢失。”</p>
<p>他给出具体解决方案：“解决办法有几种，比如用 <code>onSaveInstanceState</code> 方法保存临时状态；当前推荐的是用 <code>ViewModel</code> 存储数据，它能在 <code>Activity</code> 重建时保留数据，避免状态丢失。”</p>
<p>他顿了顿，又补充道：“如果你不想 <code>Activity</code> 重启，可以在 <code>AndroidManifest</code> 里给 <code>Activity</code> 添加 <code>android:configChanges</code> 属性，手动处理配置变更。这是对用户比较友好的方案。”</p>
<p>“所谓条条大路通罗马，方法有很多种，具体使用哪种，可以等碰到的时候再说！”</p>
<p>此时，恰好小安端着水杯路过培训室门口，本想进去打个招呼。</p>
<p>可看到晓雅频频提问，林卓却始终耐心细致地解答，眼神里满是专注，她手里的水杯不自觉地捏紧了些。</p>
<p>脚步微微一顿，小安终究没走进培训室，转身默默走开了。</p>
<p>为了让三人加深理解，林卓安排了一个实操练习：“你们在培训室的电脑上创建两个 <code>Activity</code>，实现跳转功能，同时打印出每个生命周期方法的执行日志，直观感受一下生命周期的流转过程。”</p>
<p>博文很快完成了练习，却发现一个疑问：“林哥，我从 <code>Activity A</code> 跳转到 <code>Activity B</code>，<code>A</code> 的 <code>onStop</code> 方法不是立刻执行的，而是等 <code>B</code> 启动完成后才执行。”</p>
<p>“这正是 <code>Activity</code> 生命周期的核心执行顺序，”林卓耐心讲解，“切换 <code>Activity</code> 时，系统会先执行旧 <code>Activity</code> 的 <code>onPause</code> 方法，再启动新 <code>Activity</code> 的生命周期；等新 <code>Activity</code> 完全显示后，旧 <code>Activity</code> 才会执行 <code>onStop</code> 方法。”</p>
<p>他进一步引导：“你们可以试试从 <code>B</code> 返回 <code>A</code>，看看 <code>A</code> 会执行 <code>onRestart</code> 还是 <code>onCreate</code> 方法，加深对生命周期复用的理解。”</p>
<p>晓雅又举手提问：“林哥，那如果我在 <code>onPause</code> 里做保存数据的操作，会不会影响新 <code>Activity</code> 的启动速度啊？”</p>
<p>“这个顾虑很有必要，”林卓解释道，“<code>onPause</code> 里尽量只做轻量级操作，比如保存少量UI临时状态。”</p>
<p>“另外要重点提醒大家，不管是 <code>onPause</code> 还是 <code>onStop</code>，都不建议执行耗时操作。”</p>
<p>“至于耗时操作该放在哪里处理，后续咱们讲 <code>ViewModel</code> 和线程开发时再详细说明，现在先记住这个核心原则即可。”</p>
<p>培训室外的办公区里，小安调试代码时，余光总会不自觉地瞥向培训室的方向。</p>
<p>一想到林卓在里面耐心给晓雅解答问题的样子，她敲键盘的速度就慢了下来，心里莫名泛起一丝说不清道不明的酸胀感。</p>
<p><code>Activity</code> 的生命周期讲解和实操练习刚收尾，就临近中午了。林卓宣布休息：“上午的内容就到这里，大家先去吃午饭，好好休息一下，下午咱们准时在培训室集合，讲解 <code>Service</code> 组件。”</p>
<p>打发走三个实习生后，林卓习惯性地走向测试区——往常这个时间点，他都会和小安一起去公司食堂吃饭。可到了小安的工位前，只看到摊开的测试用例，人却早已不在。林卓环顾了一圈办公区，没找到小安的身影，只好作罢，独自去了食堂。</p>
<p>下午刚到培训室，林卓便开启了新组件的讲解：“上午咱们掌握了与用户交互的 <code>Activity</code>，那么，什么组件负责执行后台任务，不依赖UI存在，就算APP退到后台也能继续运行呢？”</p>
<p>“<code>Service</code>！”三人异口同声地回应，显然对这个组件早有耳闻。</p>
<p>博文难得主动开口追问：“林哥，<code>Service</code> 启动后会一直在后台运行吗？会不会被系统杀死啊？”</p>
<p>“<code>Service</code> 确实会在后台运行，但它也分不同类型。”林卓打开示例代码，开始逐一讲解。</p>
<p>他详细说明：“通过 <code>startService</code> 启动的是启动型 <code>Service</code>，一旦启动就会在后台独立运行，直到调用 <code>stopSelf</code> 方法或其他组件调用 <code>stopService</code>，它才会停止；”</p>
<p>“还有一种是绑定型 <code>Service</code>，通过 <code>bindService</code> 方法绑定，适合与其他组件（比如 <code>Activity</code>）进行通信，比如音乐APP中，<code>Activity</code> 就是通过绑定 <code>Service</code> 来控制音乐的播放和暂停。”</p>
<p>讲完两种 <code>Service</code> 的基础类型，林卓话锋一转，引入重点场景：“不过有个关键场景要跟大家强调，比如开发音乐播放这类后台任务时，咱们一般不用普通 <code>Service</code>，而是会选用前台 <code>Service</code>。”</p>
<p>阿泽立刻追问：“林哥，为什么播放音乐要特意用前台 <code>Service</code> 啊？普通 <code>Service</code> 不能实现这个功能吗？”</p>
<p>“问得非常好，”林卓赞许地说道，“普通 <code>Service</code> 的系统优先级较低，当手机内存不足时，或者系统资源紧张时，很容易被系统回收；”</p>
<p>“而前台 <code>Service</code> 会在系统通知栏显示一个常驻通知，以此提升自身优先级，更不容易被系统杀死，能保证后台任务的稳定运行。”</p>
<p>他补充了版本限制细节：“从 <code>Android 8.0</code> 开始，系统对后台 <code>Service</code> 的运行有了更多限制，前台 <code>Service</code> 成为执行长期后台任务的更稳妥选择。”</p>
<p>最后，林卓着重提醒三人：“还有一个核心注意点——<code>Service</code> 默认运行在主线程中，要是在里面执行耗时操作，很容易导致APP出现 <strong>ANR</strong> 问题。所以遇到耗时任务时，必须在 <code>Service</code> 内部开启子线程来处理。”</p>
<p><code>Service</code> 的核心用法和注意事项讲解完毕后，林卓给三人留了十分钟消化时间。</p>
<p>随后继续推进课程：“接下来咱们讲解第三个组件——<code>BroadcastReceiver</code>，它主要用于接收和响应系统或应用内的广播事件，比如监听网络状态变化、设备开机完成等场景。咱们快速做个小实验熟悉下，就尝试接收一个简单的系统广播。”</p>
<p>晓雅按照文档上的基础方法，在 <code>AndroidManifest</code> 里静态注册了一个系统广播接收器，可运行后却发现完全接收不到广播消息，不由得皱起了眉头：“林哥，我步骤都按课本上的来的，怎么收不到广播啊？”</p>
<p>林卓走过去查看了她的代码，笑着解释：“这是 <code>Android</code> 开发中很容易踩的坑，并不是所有广播的静态注册都会受限，核心规则是‘从 <code>Android 8.0</code> 开始，大多数隐式广播的静态注册被系统限制’。”</p>
<p>他顿了顿，补充了这条规则的历史背景：“之所以加这个限制，是因为早年有不少像359这类公司开发的流氓软件，专门监听各类系统广播，比如开机启动、网络切换等事件，一旦触发就会把自己的APP偷偷唤醒，用户就算手动杀死进程也没用，严重影响手机性能和用户体验。”</p>
<p>“后来谷歌为了整治这种乱象，就调整了广播的运行机制，限制了大部分隐式广播的静态注册。咱们这次实验的自定义隐式广播，就属于受限范围。”</p>
<p>他给出对应的解决方案：“针对这种自定义隐式广播场景，应该采用动态注册的方式——在 <code>Activity</code> 的 <code>onStart</code> 方法里注册广播接收器，在 <code>onStop</code> 方法里及时注销，这样既能正常接收广播，也能避免出现内存泄漏问题。”</p>
<p>林卓特意补充了一句建议：“后续你们实际开发中，也尽量优先用动态注册的广播，不仅能规避版本适配的坑，还能根据组件的生命周期灵活控制广播的注册与注销，安全性和灵活性都更高。”</p>
<p>“另外要提醒大家，广播接收器的生命周期非常短，绝对不能在 <code>onReceive</code> 方法里面执行耗时操作或者运行长时间的后台任务，否则很容易引发一系列运行问题。”</p>
<p>阿泽突然想到一个应用场景，问道：“那要是想在不同应用之间传递消息，是不是可以用自定义广播实现？”</p>
<p>“可以实现，但一定要注意数据安全，”林卓提醒道，“自定义广播可以通过设置访问权限，限制只有授权的APP才能接收，这样能避免敏感信息泄露，提升APP的安全性。”</p>
<p>广播接收器的实验和注意事项梳理完毕后，林卓加快了讲解节奏：“下午最后一个要讲的组件是 <code>ContentProvider</code>，它相当于APP的数据中转站，主要负责跨应用或应用内的数据共享，讲完这个咱们今天的知识点就全部收尾了。”</p>
<p>他先解释其核心作用：“<code>ContentProvider</code> 的核心价值在于数据共享与安全——它会封装数据访问逻辑，对外提供统一的操作接口，其他组件或应用无需关心数据的存储方式（比如是数据库还是文件），就能实现数据的访问；”</p>
<p>“同时它还能对数据访问进行权限控制，保证数据安全。”</p>
<p>林卓打开一个 <code>ContentProvider</code> 的示例代码，重点讲解 <strong>URI</strong> 的组成规则：“<code>URI</code> 是访问 <code>ContentProvider</code> 的唯一标识，主要由三部分组成——”</p>
<p>“<code>Authority</code> 是 <code>ContentProvider</code> 的唯一标识，比如 <code>com.example.provider</code>；”</p>
<p>“<code>Path</code> 用于指定数据类型，比如<code>/users</code>代表用户数据；”</p>
<p>“<code>ID</code> 则指向具体的数据项，比如 <code>/users/1</code> 就代表 <code>ID</code> 为 <code>1</code> 的用户数据。”</p>
<p>阿泽追问：“那其他组件或应用想访问 <code>ContentProvider</code> 的数据，需要通过什么方式操作呢？”</p>
<p>“需要通过 <code>ContentResolver</code> 来操作，”林卓解释道，“不管是查询、插入、更新还是删除数据，都要通过 <code>ContentResolver</code> 这个‘中间件’来执行，而不是直接与 <code>ContentProvider</code> 交互，这样能实现数据层与业务层的解耦，提升代码的可维护性。”</p>
<p>他的话刚落，晓雅就紧跟着提出疑问：“林哥，那如果我自己写一个 <code>ContentProvider</code> 给其他APP用，是不是任何APP都能随便访问啊？不用做什么限制措施吗？”</p>
<p>林卓笑着回应：“当然不是，这里有两个关键知识点要记牢，能有效解决你的顾虑。”</p>
<p>“首先是 <code>AndroidManifest</code> 里的 <code>exported</code> 属性——它直接决定了 <code>ContentProvider</code> 是否允许外部APP访问：想开放给其他APP访问，就把它设为 <code>true</code>；要是只在自己APP内部使用，就设为 <code>false</code>，能从根源上避免外部恶意访问。”</p>
<p>“其次还可以在 <code>AndroidManifest</code> 里配置访问权限，限制只有获得授权的APP才能访问，通过这双重保障，就能有效保护数据安全。”</p>
<p>讲解完 <code>ContentProvider</code> 的访问限制后，林卓又延伸了一个实用知识点：“除了数据共享，很多第三方库还会利用 <code>ContentProvider</code> 来实现资源初始化，比如 <strong>Firebase</strong> 就是如此——它的初始化逻辑是在 <code>ContentProvider</code> 的 <code>onCreate</code> 方法里完成的，而且这个方法会在 <code>Application</code> 的 <code>onCreate</code> 之前执行，大家后续使用第三方库时可以留意下这种设计思路。”</p>
<p>借着这个话题，他顺势衔接前文，进一步细化 <code>Application</code> 的相关知识：“说到初始化，正好再跟大家明确下 <code>Application</code> 的核心用法——它是整个应用的全局入口，在所有组件初始化之前创建，非常适合用来初始化数据库、网络库这类全局资源。”</p>
<p>“但一定要注意，别在它的 <code>onCreate</code> 方法里做耗时操作，否则会直接拖慢APP的启动速度。”</p>
<p>阿泽好奇地追问：“那 <code>Application</code> 和 <code>Activity</code> 的生命周期有什么本质区别呢？”</p>
<p>“嘿嘿，你小子，上午没好好听是吧，拿我说的详细点儿。”，林卓打趣道。</p>
<p>“最核心的区别在于生命周期的长短，<code>Application</code> 的生命周期和应用进程绑定，只要应用进程不被系统杀死，它就会一直存在；”</p>
<p>“而 <code>Activity</code> 的生命周期是独立的，会随着用户的操作频繁创建和销毁，比如切换页面、旋转屏幕都可能触发 <code>Activity</code> 的重建。”</p>
<p>他还点出了一个开发中常见的“坑”：“还有个容易引发内存泄漏的操作要提醒大家——不要在单例中持有 <code>Activity</code> 的 <code>Context</code>。”</p>
<p>“因为 <code>Activity</code> 销毁后，单例还会持有它的引用，导致它无法被垃圾回收。”</p>
<p>他带着几分自嘲说道：“说起来惭愧，这个坑我前阵子刚踩过。“</p>
<p>“这种场景下应该使用 <code>Application</code> 的 <code>Context</code>，它的生命周期和应用一致，不会引发内存泄漏问题。”</p>
<p>四大组件的核心知识全部讲解完毕后，林卓在培训室里给三人布置了课后小项目：“今天的知识点比较密集，这个项目正好帮你们巩固所学内容。”</p>
<p>项目需要实现四个核心功能：两个 <code>Activity</code> 的跳转、一个播放音乐的前台 <code>Service</code>、一个监听网络状态的广播接收器，以及一个用 <code>ContentProvider</code> 访问本地数据的模块。</p>
<p>“明天给你们一天时间开发，后天上班咱们还在培训室集合，逐一检查项目成果。”</p>
<p>培训室外，小安整理测试用例时，目光总会不自觉地飘向培训室的方向。</p>
<p>眉头微微蹙起，心里的烦躁感难以掩饰。</p>
<p>直到同事喊她回测新发现的Bug，她才猛地收回目光。</p>
<p>深吸一口气，强行把注意力拉回到工作上。</p>
<p>培训结束后，林卓正收拾投影设备，晓雅、阿泽和博文却没立刻离开，反而围了上来，各自带着笔记本上前请教培训中没吃透的问题。</p>
<p>博文翻着笔记本，语气带着几分迟疑地开口：“林哥，今天讲的知识点有点多，我对 <code>ContentProvider</code> 的 <code>exported</code> 属性配置不太确定，担心实际开发时会出错。”</p>
<p>“这些基础知识点确实需要多琢磨，”林卓耐心回应，“尤其是组件注册、权限配置这些细节，稍有疏忽就会出问题。像四大组件的生命周期、<code>Context</code> 的正确使用、内存泄漏和 <strong>ANR</strong> 的预防措施，既是日常开发的核心技能，也是面试重点，大家有疑问随时找我问。”</p>
<p>晓雅突然想起什么似的，连忙说道：“林哥林哥，我大学的时候自己做过一些小案例，碰到过 <code>Fragment</code> 里嵌套 <code>Fragment</code> 的情况，当时就没搞明白该用哪个 <code>Manager</code> 来管理，总担心用混了出问题，你能给讲讲吗？”</p>
<p>林卓闻言先是愣了一下，随即笑着感叹：“没想到你在大学还接触过这种场景，学的东西还挺前沿。”</p>
<p>“<code>Fragment</code> 嵌套可是现在开发里很常用的现代化用法，我今天还没讲这块内容。”</p>
<p>紧接着他认真解答起来：“不过你这个问题问得很有价值，在 <code>Fragment</code> 里嵌套 <code>Fragment</code> 时，必须用 <code>childFragmentManager</code>。”</p>
<p>“它是 <code>Fragment</code> 专属的管理器，专门负责管理子 <code>Fragment</code> 的生命周期和事务，能精准控制子 <code>Fragment</code> 的状态。”</p>
<p>怕三人混淆，他又进一步补充两者的核心区别：“大家要记住，<code>getFragmentManager</code> 或者 <code>FragmentActivity</code> 里的 <code>supportFragmentManager</code> 是用来管理 <code>Activity</code> 级别的 <code>Fragment</code> 的。”</p>
<p>“它和 <code>childFragmentManager</code> 的作用域完全不同，一旦用混很容易出现界面异常甚至崩溃问题，千万别大意。”</p>
<p>老杨路过培训室，看到三人认真听讲解的样子，对林卓投去了赞许的目光。</p>
<p>解答完实习生的问题，看着三人满载收获离开，林卓才收拾好培训室的设备，回到自己的工位。</p>
<p>刚坐下打开电脑，他就注意到 <strong>BugTracker</strong> 弹出了一连串Bug提醒。</p>
<p>点开一看，里面堆积了不少待处理的Bug，都是这一天培训期间新增的。</p>
<p>他揉了揉眉心，正打算梳理优先级，老杨就笑着走了过来。</p>
<p>“小林，今天带教做得不错啊，”老杨拍了拍他的肩膀，语气里满是赞许。</p>
<p>“我路过培训室好几次，都看到那三个实习生听得特别认真，看来你讲得很对他们的胃口。”</p>
<p>林卓闻言笑了笑：“他们本身有基础，学起来也快。”</p>
<p>林卓心里颇有感触，这次带教不仅帮助实习生快速入门Android开发，也让自己对这些基础知识点有了更深刻、更系统的理解，可谓教学相长。</p>
<p>闲聊两句后，林卓想起白天没见到小安，忍不住问道：“对了杨哥，我今天一整天都没碰到小安，她是请假了还是手头测试任务太忙了？”</p>
<p>老杨闻言挑了挑眉，露出一副“我懂”的表情，打趣道：“她没请假，就在工位上忙呢。我看啊，你接下来这两天可得悠着点，估计你的Bug会格外多。”</p>
<p>林卓愣了一下，没明白其中的缘由。老杨见状笑出了声，拍了拍他的胳膊打趣道：“你这小子，搞技术、带徒弟都机灵，这点事儿倒转不过弯来。”</p>
<p>林卓愣了两秒才反应过来。中午去找小安一起吃饭，却没在工位上见到她的身影。</p>
<p>他心里不由得泛起一丝异样，一时不知该说些什么。</p>
<p>老杨看他这副模样，没再多说，只是笑着摇了摇头，转身离开时轻声感慨了一句：“年轻真好。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis内存管理与优化策略：避免OOM的最佳实践]]></title>    <link>https://juejin.cn/post/7583952017673830451</link>    <guid>https://juejin.cn/post/7583952017673830451</guid>    <pubDate>2025-12-16T00:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583952017673830451" data-draft-id="7490814827147689994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis内存管理与优化策略：避免OOM的最佳实践"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-16T00:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis内存管理与优化策略：避免OOM的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:48:37.000Z" title="Tue Dec 16 2025 00:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、引言</h4>
<p>Redis 作为一款高性能的内存数据库，早已成为现代互联网应用的宠儿。无论是用作缓存加速访问、存储用户会话，还是驱动实时排行榜，它的身影无处不在。然而，正如一辆跑车需要精心调校才能发挥极致性能，Redis 的内存管理也是一门需要细心打磨的技术活。内存溢出（Out of Memory, OOM）问题就像一颗定时炸弹，随时可能让你的服务宕机、性能暴跌，甚至让用户流失。想象一下，电商秒杀活动中因内存耗尽导致库存数据丢失，或者社交平台因缓存堆积而无法加载动态——这些都是 OOM 带来的真实噩梦。</p>
<p>这篇文章的目标读者是那些已经有 1-2 年 Redis 使用经验的开发者。你可能已经熟悉基本的 <code>SET</code>、<code>GET</code> 操作，也配置过简单的缓存，但偶尔会被内存暴涨、淘汰策略失效等问题搞得焦头烂额。别担心，我将带你深入 Redis 的内存管理机制，分享避免 OOM 的优化策略，并通过实战案例帮你把理论转化为代码能力。无论你是想提升现有项目的稳定性，还是准备迎接高并发场景的挑战，这篇文章都会给你一些实用的启发。</p>
<p>我在过去 10 年的开发中，见证了无数 Redis 相关的“事故现场”。印象最深的一次，是在一个电商秒杀活动中，由于未合理分片商品库存缓存，一个 Hash Key 占用了超过 2GB 内存，最终触发 OOM，系统直接崩溃。事后复盘，我们不仅优化了数据结构，还调整了内存配置，才让后续活动平稳运行。这次经历让我深刻认识到，Redis 的内存管理绝不是“配置一下就完事”，而是需要从设计到监控的全方位考量。接下来，就让我们一起拆解这些问题，找到应对之道吧！</p>
<hr/>
<h4 data-id="heading-1">二、Redis内存管理基础</h4>
<p>在优化 Redis 内存之前，我们得先搞清楚它的“内存账本”是怎么算的。理解这些基础机制，就像给一栋房子打地基，只有根基扎实，才能建起稳固的高楼。接下来，我会带你看看 Redis 的内存管理机制、OOM 的常见触发场景，并通过一个简单示例让你直观感受问题所在。</p>
<h5 data-id="heading-2">2.1 Redis内存管理机制概述</h5>
<p>Redis 是一款纯内存数据库，它的所有数据都驻留在 RAM 中。为了高效管理内存，Redis 使用了 jemalloc 作为默认内存分配器。jemalloc 的优点是分配速度快且能减少内存碎片，但它并非万能灵药，稍后我们会聊到碎片的“隐形杀手”角色。</p>
<p>Redis 的数据存储结构也直接影响内存占用。比如，字符串使用 SDS（Simple Dynamic String）来优化内存和性能，小范围整数集合用 ziplist 压缩存储，而跳表（skiplist）则支撑了有序集合的高效查询。这些结构在不同场景下各有千秋，但用得不当也可能成为内存暴涨的元凶。比如，一个超大的 Hash 如果没启用 ziplist，就可能占用远超预期的内存。</p>
<p>内存碎片是另一个绕不开的话题。假设你频繁删除和新增数据，内存就像一块被啃得坑坑洼洼的奶酪，虽然总量没变，但可用空间却零散得无法塞下大块数据。这种碎片化会让 Redis 的实际可用内存远低于预期。</p>
<p><strong>简单示意图：内存碎片的产生</strong></p>
<pre><code class="hljs language-scss" lang="scss">初始内存： <span class="hljs-selector-attr">[██████████]</span> (<span class="hljs-number">10</span>MB 全可用)
频繁操作后： <span class="hljs-selector-attr">[███  ██  ████ ]</span> (碎片化，实际可用不足)
</code></pre>
<h5 data-id="heading-3">2.2 OOM的常见触发场景</h5>
<p>OOM 并不是凭空出现的，它往往有迹可循。以下是几个典型场景：</p>
<ul>
<li><strong>数据量激增</strong>：缓存未设置过期时间，冷数据堆积如山。比如，会话缓存忘了清理，用户量一涨，内存就爆了。</li>
<li><strong>大Key问题</strong>：一个 Hash 或 Set 塞进了几十万条记录，单 Key 占用动辄几百 MB。比如社交平台把所有用户动态塞到一个 List。</li>
<li><strong>配置不当</strong>：没设置 <code>maxmemory</code>，或者设置得过高超过了物理内存，导致 Redis 无限制吃掉服务器资源。</li>
</ul>
<p>这些场景就像水管漏水，滴滴答答时不显眼，但积少成多就会淹没整个系统。</p>
<h5 data-id="heading-4">2.3 示例代码与场景</h5>
<p>来看一个简单的例子，展示 Hash 大 Key 如何引发内存暴涨。假设我们在一个社交平台缓存用户动态：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 错误示例：将所有用户动态塞进一个 Hash</span>
HSET user_feeds:user123 post1 <span class="hljs-string">"Hello world"</span> 
HSET user_feeds:user123 post2 <span class="hljs-string">"Nice day"</span> 
<span class="hljs-comment">// 假设 user123 有 100 万条动态，持续追加...</span>
</code></pre>
<p><strong>问题分析</strong>：如果 <code>user_feeds:user123</code> 存储了 100 万条动态，每条 100 字节，这个 Key 就占用了近 100MB 内存。更糟的是，如果多个用户都这么存，内存很快就会不堪重负，最终触发 OOM。</p>
<p><strong>真实场景</strong>：我曾在项目中遇到类似问题。当时一个社交应用的动态缓存没做分片，一个热门用户的 Hash Key 涨到 1.5GB，Redis 实例直接崩溃。事后我们通过分片和淘汰策略才解决问题，这也为后续优化埋下了伏笔。</p>
<p><strong>内存占用估算表</strong></p>

























<table><thead><tr><th>数据量</th><th>单条大小</th><th>总占用</th></tr></thead><tbody><tr><td>10 万条</td><td>100 字节</td><td>~10MB</td></tr><tr><td>100 万条</td><td>100 字节</td><td>~100MB</td></tr><tr><td>1000 万条</td><td>100 字节</td><td>~1GB</td></tr></tbody></table>
<p>从基础机制到触发场景，我们已经摸清了 Redis 内存管理的脉络。接下来，我们将进入优化策略的核心部分，探讨如何通过配置、设计和监控，彻底告别 OOM 的困扰。</p>
<hr/>
<h4 data-id="heading-5">三、避免OOM的核心优化策略</h4>
<p>理解了 Redis 的内存管理基础后，我们终于要进入“实战演练”环节了。避免 OOM 不是靠运气，而是需要从配置、数据设计到监控的全方位优化。就像修水管，既要堵住漏洞，还要确保水流顺畅。接下来，我将分享四种核心策略，每一种都配有代码示例、项目经验和踩坑教训，帮你在 Redis 的内存管理中游刃有余。</p>
<h5 data-id="heading-6">3.1 合理配置maxmemory与淘汰策略</h5>
<p>Redis 的 <code>maxmemory</code> 是内存管理的“总阀门”，它决定了 Redis 最多能用多少内存。如果不设置，Redis 会像个贪吃的孩子，把服务器内存吃光，最终触发 OOM。设置原则很简单：<strong>留出 20%-30% 的缓冲区给系统和碎片</strong>。比如，服务器有 16GB 内存，建议 <code>maxmemory</code> 设为 10-12GB。</p>
<p>但光有阀门还不够，内存满了怎么办？这就轮到淘汰策略上场了。Redis 提供了多种选择，比如 <code>volatile-lru</code>（对设置了过期时间的键使用最近最少使用淘汰）、<code>allkeys-lru</code>（对所有键使用 LRU）和 <code>volatile-ttl</code>（优先淘汰剩余时间短的键）。每种策略都有自己的“脾气”：</p>
<ul>
<li><strong>volatile-lru</strong>：适合有明确过期需求的场景，比如会话缓存。</li>
<li><strong>allkeys-lru</strong>：适合热点数据频繁变化的场景，比如排行榜。</li>
<li><strong>volatile-ttl</strong>：适合临时数据多的场景，比如验证码。</li>
</ul>
<p><strong>最佳实践</strong>：我在一个电商订单缓存项目中使用了 <code>volatile-lru</code>，为每条订单数据设置 24 小时过期时间，避免冷数据挤占内存。效果很好，内存占用稳定在 60% 左右。但也有踩坑经历：早期用 <code>allkeys-lru</code> 时，因为没区分冷热数据，热销商品的缓存被误删，导致数据库压力激增。</p>
<p><strong>代码示例：配置并测试淘汰策略</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 maxmemory 为 2GB</span>
CONFIG SET maxmemory 2gb
<span class="hljs-comment"># 使用 volatile-lru 策略</span>
CONFIG SET maxmemory-policy volatile-lru

<span class="hljs-comment"># 测试脚本：插入数据并观察淘汰</span>
redis-cli &lt;&lt;<span class="hljs-string">EOF
SETEX key1 3600 "value1"  # 过期时间 1 小时
SETEX key2 3600 "value2"
# 持续插入数据直到超过 2GB，观察 key1、key2 是否被淘汰
EOF</span>
</code></pre>
<p><strong>淘汰策略对比表</strong></p>





























<table><thead><tr><th>策略</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>volatile-lru</td><td>会话、临时缓存</td><td>保护无过期键</td><td>未设置过期键不淘汰</td></tr><tr><td>allkeys-lru</td><td>热点数据缓存</td><td>全局优化内存</td><td>可能误删重要数据</td></tr><tr><td>volatile-ttl</td><td>短生命周期数据</td><td>优先清理快过期键</td><td>对长生命周期键无效</td></tr></tbody></table>
<h5 data-id="heading-7">3.2 数据结构优化与分片设计</h5>
<p>Redis 的数据结构就像厨房里的锅碗瓢盆，用对了事半功倍，用错了浪费空间。比如，一个小型 Hash 用 ziplist 存储能省不少内存，但数据量大了转成 hashtable 就可能暴涨。选择合适的数据结构是优化的第一步。</p>
<p>更关键的是处理大 Key。假设一个 Set 存了 100 万条记录，内存占用可能轻松破 GB。解决办法是<strong>分片设计</strong>：把大 Key 拆成多个小 Key。比如，一个用户动态列表可以按时间分片：</p>
<ul>
<li><code>user_feeds:user123:202504</code>（4 月数据）</li>
<li><code>user_feeds:user123:202505</code>（5 月数据）</li>
</ul>
<p><strong>最佳实践</strong>：在一个游戏排行榜项目中，我们把全局排行榜分片成 100 个小 Hash（<code>rank:shard:0</code> 到 <code>rank:shard:99</code>），每个 Hash 只存 1 万条记录。内存占用从 2GB 降到 300MB，查询性能也没受影响。但也有教训：早期用 List 存排行榜，没分片导致内存碎片率飙升到 1.8，重启才解决。</p>
<p><strong>代码示例：Hash分片存储用户数据</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua 脚本：分片存储用户动态</span>
<span class="hljs-keyword">local</span> user_id = ARGV[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> post_id = ARGV[<span class="hljs-number">2</span>]
<span class="hljs-keyword">local</span> content = ARGV[<span class="hljs-number">3</span>]
<span class="hljs-keyword">local</span> shard = <span class="hljs-built_in">tostring</span>(<span class="hljs-built_in">tonumber</span>(post_id) % <span class="hljs-number">10</span>)  <span class="hljs-comment">-- 按 post_id 取模分片</span>
<span class="hljs-keyword">local</span> key = <span class="hljs-string">"user_feeds:"</span> .. user_id .. <span class="hljs-string">":shard"</span> .. shard
redis.call(<span class="hljs-string">"HSET"</span>, key, post_id, content)
<span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>
</code></pre>
<p><strong>示意图：分片前后内存对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">未分片： <span class="hljs-selector-attr">[██████████]</span> (<span class="hljs-number">1</span>GB 一个大 Key)
分片后： <span class="hljs-selector-attr">[██]</span><span class="hljs-selector-attr">[██]</span><span class="hljs-selector-attr">[██]</span><span class="hljs-selector-attr">[██]</span><span class="hljs-selector-attr">[██]</span> (<span class="hljs-number">5</span> 个 <span class="hljs-number">200</span>MB 小 Key)
</code></pre>
<h5 data-id="heading-8">3.3 过期策略与主动清理</h5>
<p>Redis 的 <code>EXPIRE</code> 命令是清理冷数据的利器，但它并非“自动保姆”。Redis 采用惰性删除和定期删除结合的方式，过期键不一定立刻被清理，尤其在高负载时，可能堆积导致内存超预期。</p>
<p>主动清理是个好帮手。比如，用 Lua 脚本定期扫描并删除无用数据。我在会话缓存项目中给每个 session 设置动态 TTL（活跃用户延长，非活跃缩短），配合脚本清理，内存占用降低了 40%。但也踩过坑：早期以为 <code>EXPIRE</code> 万能，结果过期键堆积，<code>used_memory</code> 超标才发现问题。</p>
<p><strong>代码示例：Lua脚本批量清理过期数据</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 清理指定前缀下过期超过 1 天的键</span>
<span class="hljs-keyword">local</span> prefix = ARGV[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> cursor = <span class="hljs-string">"0"</span>
<span class="hljs-keyword">repeat</span>
    <span class="hljs-keyword">local</span> result = redis.call(<span class="hljs-string">"SCAN"</span>, cursor, <span class="hljs-string">"MATCH"</span>, prefix .. <span class="hljs-string">"*"</span>, <span class="hljs-string">"COUNT"</span>, <span class="hljs-number">100</span>)
    cursor = result[<span class="hljs-number">1</span>]
    <span class="hljs-keyword">local</span> keys = result[<span class="hljs-number">2</span>]
    <span class="hljs-keyword">for</span> i, key <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(keys) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"TTL"</span>, key) &lt; <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> redis.call(<span class="hljs-string">"TTL"</span>, key) &gt; <span class="hljs-number">86400</span> <span class="hljs-keyword">then</span>
            redis.call(<span class="hljs-string">"DEL"</span>, key)
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">until</span> cursor == <span class="hljs-string">"0"</span>
<span class="hljs-keyword">return</span> <span class="hljs-string">"Cleanup done"</span>
</code></pre>
<h5 data-id="heading-9">3.4 内存监控与预警</h5>
<p>优化再好，没有监控就像闭眼开车。Redis 的 <code>INFO MEMORY</code> 命令是你的“仪表盘”，关键指标包括：</p>
<ul>
<li><code>used_memory</code>：当前占用内存。</li>
<li><code>maxmemory</code>：上限。</li>
<li><code>mem_fragmentation_ratio</code>：碎片率（&gt;1.5 时需警惕）。</li>
</ul>
<p>结合 Prometheus 和 Grafana，可以设置 OOM 预警。比如，内存占用超 80% 时报警。在一次秒杀活动前，我通过监控发现碎片率过高，提前调整了分片策略，避免了潜在风险。但也有教训：早期忽视碎片率，性能下降了 20% 才后知后觉。</p>
<p><strong>代码示例：Python脚本解析INFO MEMORY</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis

r = redis.Redis(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>)
info = r.info(<span class="hljs-string">'memory'</span>)
used_mb = info[<span class="hljs-string">'used_memory'</span>] / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>
frag_ratio = info[<span class="hljs-string">'mem_fragmentation_ratio'</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Used Memory: <span class="hljs-subst">{used_mb:<span class="hljs-number">.2</span>f}</span> MB, Fragmentation Ratio: <span class="hljs-subst">{frag_ratio:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-keyword">if</span> used_mb &gt; <span class="hljs-number">2000</span> <span class="hljs-keyword">or</span> frag_ratio &gt; <span class="hljs-number">1.5</span>:  <span class="hljs-comment"># 假设 2GB 为阈值</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Warning: Memory usage or fragmentation too high!"</span>)
</code></pre>
<p><strong>监控指标表</strong></p>




















<table><thead><tr><th>指标</th><th>正常范围</th><th>异常情况建议</th></tr></thead><tbody><tr><td>used_memory</td><td>&lt; maxmemory 80%</td><td>检查淘汰策略</td></tr><tr><td>fragmentation_ratio</td><td>1.0-1.5</td><td>考虑重启或分片优化</td></tr></tbody></table>
<p>通过配置 <code>maxmemory</code>、优化数据结构、主动清理和实时监控，我们已经为 Redis 装上了“四重保险”。这些策略在我的项目中反复验证，不仅降低了 OOM 风险，还提升了整体性能。接下来，我们将通过两个实战案例，看看这些方法如何落地生根。</p>
<hr/>
<h4 data-id="heading-10">四、实战案例分析</h4>
<p>理论和策略讲了一堆，但真正让它们发光发热的，还是在实际项目中的应用。就像学厨艺，光看菜谱不够，得下厨房炒几盘菜才知道火候掌握得如何。接下来，我将分享两个我在项目中遇到的 OOM 案例，一个来自电商秒杀场景，另一个来自社交平台动态缓存。通过这些“事故现场”的复盘，你会看到优化策略如何从纸面走向代码，解决真实问题。</p>
<h5 data-id="heading-11">4.1 案例1：电商秒杀场景的OOM优化</h5>
<p><strong>问题描述</strong><br/>
在一个电商平台的秒杀活动中，我们用 Redis 缓存商品库存，Key 格式是 <code>stock:product:123</code>，用 Hash 存储每个规格的库存量（比如 <code>color:red</code> -&gt; 100）。活动开始后，热门商品的库存 Hash 迅速膨胀，一个 Key 占用了超过 1GB 内存。流量高峰时，Redis 触发 OOM，实例直接崩溃，导致订单无法下单，用户体验一落千丈。</p>
<p><strong>优化过程</strong><br/>
复盘后，我们采取了三步优化：</p>
<ol>
<li><strong>分片存储</strong>：将单个 Hash 拆成多个小 Hash，按规格 ID 取模分片（如 <code>stock:product:123:shard0</code>）。</li>
<li><strong>配置淘汰策略</strong>：设置 <code>maxmemory</code> 为服务器内存的 70%（10GB），启用 <code>volatile-lru</code>，为库存数据设置 1 小时过期时间。</li>
<li><strong>提前预估内存</strong>：活动前通过脚本模拟流量，预估每个分片占用约 50MB，总量控制在 2GB 内。</li>
</ol>
<p><strong>结果分析</strong><br/>
优化后，单 Key 内存占用从 1GB 降到 50MB，总内存占用降低 80%，稳定在 2.5GB 左右。秒杀活动全程无 OOM 风险，订单成功率从 85% 提升到 99%。碎片率也从 1.7 降到 1.2，性能更稳定。</p>
<p><strong>代码示例：分片存储库存实现</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua 脚本：分片存储库存</span>
<span class="hljs-keyword">local</span> product_id = ARGV[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> spec_id = ARGV[<span class="hljs-number">2</span>]
<span class="hljs-keyword">local</span> stock = ARGV[<span class="hljs-number">3</span>]
<span class="hljs-keyword">local</span> shard = <span class="hljs-built_in">tostring</span>(<span class="hljs-built_in">tonumber</span>(spec_id) % <span class="hljs-number">10</span>)  <span class="hljs-comment">-- 按 spec_id 取模分 10 片</span>
<span class="hljs-keyword">local</span> key = <span class="hljs-string">"stock:product:"</span> .. product_id .. <span class="hljs-string">":shard"</span> .. shard
redis.call(<span class="hljs-string">"HSET"</span>, key, spec_id, stock)
redis.call(<span class="hljs-string">"EXPIRE"</span>, key, <span class="hljs-number">3600</span>)  <span class="hljs-comment">-- 设置 1 小时过期</span>
<span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>
</code></pre>
<p><strong>内存对比表</strong></p>























<table><thead><tr><th>阶段</th><th>单 Key 占用</th><th>总内存占用</th><th>OOM 风险</th></tr></thead><tbody><tr><td>优化前</td><td>1GB</td><td>12GB</td><td>高</td></tr><tr><td>优化后</td><td>50MB</td><td>2.5GB</td><td>无</td></tr></tbody></table>
<h5 data-id="heading-12">4.2 案例2：社交平台动态缓存踩坑记</h5>
<p><strong>问题描述</strong><br/>
在一个社交平台项目中，我们用 Redis 缓存用户动态，Key 格式是 <code>feeds:user:456</code>，用 List 存储动态 ID。由于初期没设置 <code>maxmemory</code>，一场突发活动带来了 10 倍流量，用户动态激增，Redis 内存从 3GB 暴涨到 16GB，直接吃光服务器资源，实例宕机，用户刷新动态时一片空白。</p>
<p><strong>优化过程</strong><br/>
这次事故让我们意识到“无限制吃内存”的危险。我们迅速调整了策略：</p>
<ol>
<li><strong>设置 maxmemory</strong>：将 <code>maxmemory</code> 设为 8GB，启用 <code>allkeys-lru</code>，确保热点动态优先保留。</li>
<li><strong>主动清理冷数据</strong>：编写脚本，每天清理超过 7 天的动态，结合 <code>EXPIRE</code> 设置 30 天默认过期。</li>
<li><strong>监控预警</strong>：用 Prometheus 监控 <code>used_memory</code>，设置 80% 占用率报警，提前干预。</li>
</ol>
<p><strong>结果分析</strong><br/>
优化后，内存占用稳定在 6-7GB，即使流量高峰也没突破上限。宕机问题彻底解决，用户动态加载延迟从 500ms 降到 100ms。唯一的代价是冷数据清理后，少量用户需要回源数据库加载历史动态，但影响可控。</p>
<p><strong>代码示例：动态缓存清理脚本</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis

r = redis.Redis(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>)
cursor, keys = <span class="hljs-number">0</span>, []
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    cursor, batch = r.scan(cursor, <span class="hljs-keyword">match</span>=<span class="hljs-string">'feeds:user:*'</span>, count=<span class="hljs-number">100</span>)
    keys.extend(batch)
    <span class="hljs-keyword">if</span> cursor == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>

<span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys:
    <span class="hljs-comment"># 检查 List 长度，超过 7 天的数据清理</span>
    <span class="hljs-keyword">if</span> r.llen(key) &gt; <span class="hljs-number">0</span>:
        r.ltrim(key, <span class="hljs-number">0</span>, <span class="hljs-number">999</span>)  <span class="hljs-comment"># 保留最近 1000 条</span>
        r.expire(key, <span class="hljs-number">2592000</span>)  <span class="hljs-comment"># 设置 30 天过期</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Cleanup completed"</span>)
</code></pre>
<p><strong>效果对比表</strong></p>























<table><thead><tr><th>阶段</th><th>内存占用</th><th>系统状态</th><th>加载延迟</th></tr></thead><tbody><tr><td>优化前</td><td>16GB</td><td>宕机</td><td>500ms+</td></tr><tr><td>优化后</td><td>6-7GB</td><td>稳定运行</td><td>100ms</td></tr></tbody></table>
<p>这两个案例就像一面镜子，映照出 Redis 内存管理的常见痛点：大 Key、无限制内存、缺乏监控。解决之道正是前文提到的配置优化、分片设计和主动清理。通过这些实战，我深刻体会到，Redis 不是“开箱即用”的工具，而是需要根据业务场景量身定制。接下来，我们将聊聊常见的误区和应对建议，避免你在优化路上走弯路。</p>
<hr/>
<h4 data-id="heading-13">五、常见误区与应对建议</h4>
<p>优化 Redis 内存管理的路上，布满了“隐形地雷”。有些误区看似无害，却能在关键时刻让系统崩溃。就像开车，超速和忽视路标迟早会出问题。凭借 10 年 Redis 开发经验，我总结了几个常见误区，并给出应对之道，希望你能在实践中绕开这些陷阱。</p>
<h5 data-id="heading-14">5.1 误区1：认为Redis内存无限扩展</h5>
<p><strong>问题</strong><br/>
很多开发者把 Redis 当成“内存黑洞”，以为服务器有多大内存它就能用多少。结果是没设置 <code>maxmemory</code>，数据一多就吃光资源，导致 OOM 或服务器其他进程被挤爆。</p>
<p><strong>应对建议</strong><br/>
从项目启动之初就预估数据规模，设置合理的 <code>maxmemory</code>。比如，一个 16GB 内存的服务器，留 4GB 给系统和碎片，Redis 用 12GB。别忘了定期用 <code>INFO MEMORY</code> 检查实际占用，动态调整配置。</p>
<p><strong>经验分享</strong><br/>
早年我接手一个项目时，Redis 没设上限，结果一次活动流量暴涨，内存从 2GB 飙到 20GB，直接把 MySQL 挤崩溃。教训是：内存规划要提前做，别等事故来敲门。</p>
<h5 data-id="heading-15">5.2 误区2：忽视内存碎片</h5>
<p><strong>问题</strong><br/>
内存碎片就像房间里的杂物，堆多了就没地方放新东西。Redis 的碎片率（<code>mem_fragmentation_ratio</code>）超过 1.5 时，性能会下降，甚至触发 OOM。很多人觉得“数据没超限就没事”，却忘了碎片的隐形威胁。</p>
<p><strong>应对建议</strong><br/>
定期监控碎片率，高于 1.5 时可以尝试 <code>MEMORY PURGE</code> 清理碎片，或者计划重启实例（配合 AOF 重写减少影响）。长期方案是优化数据结构，减少频繁增删操作。</p>
<p><strong>踩坑教训</strong><br/>
一个排行榜项目中，我忽视了碎片率从 1.2 涨到 1.8，结果查询延迟翻倍。重启后恢复正常，但用户体验已受损。从此我把碎片率纳入监控必选项。</p>
<h5 data-id="heading-16">5.3 误区3：过度依赖过期机制</h5>
<p><strong>问题</strong><br/>
很多人以为给键设个 <code>EXPIRE</code> 就万事大吉，但 Redis 的过期清理是惰性和定期结合的，高负载时过期键可能堆积。比如，一个会话缓存项目中，过期键占了 30% 内存，却没被及时释放。</p>
<p><strong>应对建议</strong><br/>
别把 <code>EXPIRE</code> 当成唯一救星。结合主动清理脚本，定期扫描并删除无用数据。同时，设置合理的 TTL，避免一刀切的超长过期时间。</p>
<p><strong>代码示例：检查过期键占用</strong></p>
<pre><code class="hljs language-bash" lang="bash">redis-cli INFO MEMORY | grep used_memory_human
<span class="hljs-comment"># 若 used_memory 远超预期，运行以下命令查看过期键</span>
redis-cli --scan --pattern <span class="hljs-string">"*"</span> | xargs -I {} redis-cli TTL {} | grep -v <span class="hljs-string">"-"</span>
</code></pre>
<h5 data-id="heading-17">5.4 踩坑经验分享</h5>
<ul>
<li><strong>忽视持久化影响</strong>：RDB 和 AOF 的 fork 操作会临时占用额外内存。我曾因未预留空间，触发 OOM，后来调整 <code>maxmemory</code> 留出 2GB 缓冲才解决。</li>
<li><strong>未测试淘汰策略</strong>：直接上线 <code>allkeys-lru</code>，结果热数据被删，流量全打到数据库。建议先用测试环境模拟流量，验证策略效果。</li>
</ul>
<p><strong>常见误区应对表</strong></p>

























<table><thead><tr><th>误区</th><th>后果</th><th>解决方案</th></tr></thead><tbody><tr><td>内存无限扩展</td><td>OOM 或系统崩溃</td><td>设置 maxmemory，预估规模</td></tr><tr><td>忽视内存碎片</td><td>性能下降</td><td>监控碎片率，定期清理</td></tr><tr><td>过度依赖过期</td><td>内存浪费</td><td>主动清理，优化 TTL</td></tr></tbody></table>
<p>这些误区就像 Redis 内存管理中的“老油条”，不踩一脚可能意识不到它们的威力。通过提前规划、监控和主动干预，我们可以把风险降到最低。接下来，我们将总结全文要点，并展望 Redis 内存管理的未来趋势，给出一些实践建议。</p>
<hr/>
<h4 data-id="heading-18">六、总结与展望</h4>
<p>经过前文的层层拆解，我们已经从 Redis 内存管理的基础走到了实战优化的前沿。就像给一辆赛车调校引擎，避免 OOM 的核心在于理解机制、优化策略和持续监控。现在，让我们回顾要点，给出建议，并展望未来趋势，希望你能带着这些干货自信上路。</p>
<h5 data-id="heading-19">6.1 核心要点回顾</h5>
<p>Redis 的内存管理不是“设了忘”的配置游戏，而是需要从头到尾的精心设计。我们先摸清了内存分配器和数据结构的工作原理，认清了 OOM 的常见元凶——大 Key、数据堆积和配置失误。接着，通过四大优化策略：合理配置 <code>maxmemory</code> 和淘汰策略、分片设计、过期与主动清理、内存监控，构建了一套防 OOM 的“护城河”。实战案例则证明，这些方法能在电商秒杀、社交缓存等场景中化险为夷。最后，常见误区提醒我们，规划不足和盲目信任机制是最大的隐患。</p>
<p><strong>避免 OOM 的关键公式</strong>：<br/>
<strong>科学配置 + 合理设计 + 实时监控 = 内存无忧</strong></p>
<h5 data-id="heading-20">6.2 给读者的建议</h5>
<p>对于 1-2 年经验的开发者，我的建议是从小处入手，逐步精进：</p>
<ul>
<li><strong>从小规模测试开始</strong>：先在本地或测试环境模拟数据量，试试淘汰策略和分片效果，别直接上生产“裸奔”。</li>
<li><strong>善用工具</strong>：用 <code>redis-cli</code> 的 <code>INFO</code> 命令摸清内存现状，结合 Grafana 可视化趋势。</li>
<li><strong>持续学习新特性</strong>：Redis 6.x 改进了 LFU 算法，7.x 优化了多线程，值得关注和尝试。</li>
</ul>
<p>我自己的经验是，每次优化前先问三个问题：数据量会涨到多大？单 Key 会不会失控？监控能不能跟上？回答清楚了，问题就解决了一半。</p>
<h5 data-id="heading-21">6.3 展望</h5>
<p>Redis 的内存管理未来会更智能、更高效。随着集群模式和云服务的普及，分布式内存分配会成为重点，单实例的 OOM 风险将逐步被分担。Redis 的多线程支持也在增强，比如 6.0 引入的 I/O 线程，未来可能进一步优化内存效率。我个人很期待 Redis 在内存压缩和动态分片上的突破，这会让高并发场景更省心。结合自己的使用心得，我建议关注 Redis 的生态工具（如 Redis Sentinel、Redis Cluster）和云厂商的托管方案，它们能帮你把内存管理交给“专家”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【重磅福利】学生认证可免费领取 Gemini 3 Pro 一年]]></title>    <link>https://juejin.cn/post/7583955708317712384</link>    <guid>https://juejin.cn/post/7583955708317712384</guid>    <pubDate>2025-12-16T00:53:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583955708317712384" data-draft-id="7583921477613862947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【重磅福利】学生认证可免费领取 Gemini 3 Pro 一年"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-16T00:53:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【重磅福利】学生认证可免费领取 Gemini 3 Pro 一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T00:53:14.000Z" title="Tue Dec 16 2025 00:53:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>谷歌正式发布最新一代推理模型 Gemini 3.0 Pro，并同步开放 API 接口及在 谷歌 AI Studio 推出预览版。这款模型一经发布，立刻横扫各大评测榜单，以“一夜封神”的姿态震撼了全球 AI 社群。</p>
<p>值得玩味的是，OpenAI 首席执行官奥特曼也隔空向谷歌发来“贺电”，在社交媒体上评价“Gemini 3 看起来很不错”，谷歌首席执行官皮查伊（Sundar Pichai）则以一个轻松的表情包回应，尽显王者风范。</p>
<p>Gemini 3.0 Pro 的强大并非空穴来风，其在关键的基准测试中实现了全面“碾压式”的领先：</p>
<p><strong>数学能力登顶全球：</strong> 在被誉为“地狱难度”的数学竞赛基准 MathArena 中，当 GPT-5.1 等其他顶级大模型仍在 1% 左右徘徊时，Gemini 3.0 Pro 的得分一举达到 <strong>23.4%</strong> ，毫无争议地成为当前全球数学能力最强的 AI。</p>
<h2 data-id="heading-1">重磅福利</h2>
<p>现在一年会员只要 <strong>19.9</strong> 元，帮您解决以下 4 大问题。</p>
<blockquote>
<p>⚠️注：优惠截止日期 2026年1月31日</p>
<p>如有问题可以联系V：zm_david。</p>
</blockquote>
<h2 data-id="heading-2">1. 出了点问题（Something went wrong）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/228d3b26acee4cb0a60a7d1b40514c86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=q7q7Bs25yTYxjbNXf0BwrkU0iQk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b44ecadaba1b48cca89662ae802a29de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=074k1Shx79mgO2YpqZ0eIx3BfLA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">2. 此账号无法订阅 Google AI 方案</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e3e2b44eed343e3b9b73e9b19001e46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=%2FRqhPR%2FbQSELCpIR2FE4K6RoelA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 无法享受此优惠</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f8c40de8054a4684fbed1304e96c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=qbmnIr4hMN%2BXsQWjIzgTL6v%2BRDw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0af1afa414f74c259acab6a7b0121e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=RQzdeLbVOHum48jWS09U0S4nB%2BQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">4. 没有 Visa 卡绑定</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0983335f6f548109905edf089f93f30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766451194&amp;x-signature=rBN0zjOl3TX4rs6CepfOWSRpjRc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别频繁 GC：C#.NET PooledList 的设计与使用场景]]></title>    <link>https://juejin.cn/post/7583955708317564928</link>    <guid>https://juejin.cn/post/7583955708317564928</guid>    <pubDate>2025-12-15T23:35:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583955708317564928" data-draft-id="7583891046206734388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别频繁 GC：C#.NET PooledList 的设计与使用场景"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-15T23:35:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别频繁 GC：C#.NET PooledList 的设计与使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T23:35:22.000Z" title="Mon Dec 15 2025 23:35:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>PooledList&lt;T&gt;</code> 是 高性能集合类型，由 <code>Collections.Pooled</code> 提供，用于替代 <code>List&lt;T&gt;</code>，通过 对象池 (<code>ArrayPool&lt;T&gt;</code>) 复用内部数组来减少 <code>GC</code>（垃圾回收）压力。</p>
<p>⚡ 核心目标：
在需要频繁创建/销毁 <code>List&lt;T&gt;</code> 的场景下，<code>PooledList&lt;T&gt;</code> 通过数组租借与归还的机制避免频繁分配内存，从而提升性能并降低 <code>GC</code> 负担。</p>
<h3 data-id="heading-1">安装</h3>
<pre><code class="hljs language-shell" lang="shell">dotnet add package Collections.Pooled --version 1.0.82
</code></pre>
<p>添加命名空间</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Collections.Pooled;
</code></pre>
<h3 data-id="heading-2">特点</h3>
<ul>
<li>
<p>数组池化：内部数组从 <code>ArrayPool&lt;T&gt;.Shared</code>（默认）或自定义池中租借，减少分配。</p>
</li>
<li>
<p><code>Span&lt;T&gt;</code> 支持：提供 <code>Span</code> 属性，直接访问内部数组的填充部分，支持零拷贝操作。</p>
</li>
<li>
<p><code>IDisposable</code> 实现：调用 <code>Dispose()</code> 时，返回内部数组到池中（不调用 <code>Dispose</code> 不会出错，但会降低池化效果）。</p>
</li>
<li>
<p>扩展方法：如 <code>TryFind</code>、<code>TryFindLast</code>（替换标准 <code>Find</code>、<code>FindLast</code>，返回 <code>bool</code> 以避免异常）。</p>
</li>
<li>
<p>添加/插入 <code>Span</code>：<code>AddSpan</code> 和 <code>InsertSpan</code> 方法返回一个 <code>Span&lt;T&gt;</code>，允许直接写入内部存储，而无需多次调用 <code>Add</code>。</p>
</li>
<li>
<p>构造函数选项：</p>
<ul>
<li>
<p>支持指定自定义 <code>ArrayPool&lt;T&gt;</code>。</p>
</li>
<li>
<p><code>clearMode</code> 参数控制数组返回池时是否清除内容（默认自动）。</p>
</li>
<li>
<p><code>sizeToCapacity</code> 参数使初始 <code>Count == Capacity</code>，适合值类型避免不必要的零初始化。</p>
</li>
</ul>
</li>
<li>
<p><code>ToPooledList()</code> 扩展：从 <code>IEnumerable&lt;T&gt;</code> 快速创建 <code>PooledList&lt;T&gt;</code>。</p>
</li>
<li>
<p>性能提升：在高频操作中，减少 <code>GC</code> 触发，尤其适合循环中创建临时列表的场景。</p>
</li>
</ul>
<h3 data-id="heading-3">内部原理</h3>
<h4 data-id="heading-4">普通 <code>List&lt;T&gt;</code> 内部</h4>
<ul>
<li>
<p><code>List&lt;T&gt;</code> 内部维护一个 <code>T[]</code> 数组。</p>
</li>
<li>
<p>当容量不足时会 申请更大数组 并 拷贝数据。</p>
</li>
<li>
<p>对象销毁后，这些数组最终交给 <code>GC</code> 回收。</p>
</li>
</ul>
<h4 data-id="heading-5"><code>PooledList&lt;T&gt;</code> 内部</h4>
<ul>
<li>
<p>内部数组不是直接 <code>new</code> 出来的，而是从 <code>ArrayPool&lt;T&gt;.Shared</code> 租借。</p>
</li>
<li>
<p>使用结束时通过 <code>Dispose()</code> 方法 归还数组，供下次复用。</p>
</li>
<li>
<p>避免频繁分配和回收大数组，降低 <code>GC Gen2</code> 压力。</p>
</li>
</ul>
<h3 data-id="heading-6">基本用法</h3>
<h4 data-id="heading-7">创建与释放</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Microsoft.Toolkit.HighPerformance.Buffers;

<span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> PooledList&lt;<span class="hljs-built_in">int</span>&gt;(); <span class="hljs-comment">// 自动使用 ArrayPool&lt;int&gt;</span>
list.Add(<span class="hljs-number">1</span>);
list.Add(<span class="hljs-number">2</span>);
list.Add(<span class="hljs-number">3</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> list)
{
    Console.WriteLine(item);
}
<span class="hljs-comment">// Dispose() 会自动归还数组</span>
</code></pre>
<blockquote>
<p>💡 推荐使用 using 确保 Dispose() 被调用，否则不会归还数组，造成内存浪费。</p>
</blockquote>
<h4 data-id="heading-8">初始容量</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> PooledList&lt;<span class="hljs-built_in">int</span>&gt;(initialCapacity: <span class="hljs-number">1024</span>);
</code></pre>
<h4 data-id="heading-9">转换为 <code>Span&lt;T&gt;</code> / <code>Memory&lt;T&gt;</code></h4>
<p><code>PooledList&lt;T&gt;</code> 的优势之一是可以直接获取底层内存：</p>
<pre><code class="hljs language-csharp" lang="csharp">Span&lt;<span class="hljs-built_in">int</span>&gt; span = list.AsSpan();
Memory&lt;<span class="hljs-built_in">int</span>&gt; memory = list.AsMemory();
</code></pre>
<p>这样可以高效地与 <code>Span/Memory API</code> 交互，避免额外拷贝。</p>
<h3 data-id="heading-10">常用操作</h3>
<p>与 <code>List&lt;T&gt;</code> 基本一致：</p>
<pre><code class="hljs language-csharp" lang="csharp">list.Add(<span class="hljs-number">10</span>);
list.AddRange(<span class="hljs-keyword">new</span>[] { <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span> });
list.Insert(<span class="hljs-number">1</span>, <span class="hljs-number">15</span>);
list.RemoveAt(<span class="hljs-number">0</span>);
list.Clear();

Console.WriteLine(list.Count);
Console.WriteLine(list.Capacity);
</code></pre>
<h3 data-id="heading-11">与 <code>List&lt;T&gt;</code> 对比</h3>








































<table><thead><tr><th>特性</th><th><code>List&lt;T&gt;</code></th><th><code>PooledList&lt;T&gt;</code></th></tr></thead><tbody><tr><td>内存分配</td><td>每次扩容 <code>new</code> 新数组</td><td>从 <code>ArrayPool&lt;T&gt;</code> 租借，复用数组</td></tr><tr><td>GC 压力</td><td>大量频繁创建/销毁时 GC 压力大</td><td>减少 GC Gen2 压力</td></tr><tr><td>释放方式</td><td>依赖 GC</td><td>必须 <code>Dispose()</code> 归还数组</td></tr><tr><td>性能（频繁操作场景）</td><td>可能产生大量堆分配</td><td>高性能、低分配</td></tr><tr><td>Span/Memory 支持</td><td>需要 <code>AsSpan()</code> 扩展</td><td>内置 <code>AsSpan</code>、<code>AsMemory</code>，零拷贝访问</td></tr><tr><td>适用场景</td><td>通用集合</td><td>高性能、临时性数据集合（网络、序列化、算法）</td></tr></tbody></table>
<h3 data-id="heading-12">高级用法</h3>
<h4 data-id="heading-13">与 <code>ArrayPool&lt;T&gt;</code> 配合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> PooledList&lt;<span class="hljs-built_in">byte</span>&gt;(ArrayPool&lt;<span class="hljs-built_in">byte</span>&gt;.Shared, <span class="hljs-number">2048</span>);
</code></pre>
<p>可以传入自定义池，比如为特殊场景优化的 <code>ArrayPool&lt;T&gt;</code>。</p>
<h4 data-id="heading-14">与 <code>Span&lt;T&gt;</code> 高效处理</h4>
<p>适合序列化/反序列化：</p>
<pre><code class="hljs language-csharp" lang="csharp">Span&lt;<span class="hljs-built_in">byte</span>&gt; buffer = list.AsSpan();
ProcessBuffer(buffer); <span class="hljs-comment">// 直接操作底层数组，无需复制</span>
</code></pre>
<h4 data-id="heading-15">搜索和扩展</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> PooledList&lt;<span class="hljs-built_in">string</span>&gt; { <span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span> };
<span class="hljs-built_in">bool</span> found = list.TryFind(s =&gt; s.StartsWith(<span class="hljs-string">"b"</span>), <span class="hljs-keyword">out</span> <span class="hljs-built_in">string</span> result);
Console.WriteLine(found ? result : <span class="hljs-string">"Not found"</span>); <span class="hljs-comment">// 输出: banana</span>

<span class="hljs-keyword">var</span> pooledFromEnumerable = Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>).ToPooledList(); <span class="hljs-comment">// 扩展方法</span>
Console.WriteLine(<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">", "</span>, pooledFromEnumerable)); <span class="hljs-comment">// 输出: 1, 2, 3, 4, 5</span>

pooledFromEnumerable.Dispose();
</code></pre>
<ul>
<li><code>TryFind</code> 和 <code>TryFindLast</code>：返回 <code>bool</code> 和 <code>out</code> 值，避免 <code>null</code> 检查。</li>
</ul>
<h3 data-id="heading-16">注意事项与最佳实践</h3>
<h4 data-id="heading-17">必须调用 Dispose()</h4>
<ul>
<li>
<p>否则不会归还数组，导致内存泄漏。</p>
</li>
<li>
<p>推荐 <code>using</code> 块。</p>
</li>
</ul>
<h4 data-id="heading-18">不要长期持有 Span/Memory</h4>
<ul>
<li>因为数组归还池后可能被其他线程复用。</li>
</ul>
<h4 data-id="heading-19">适用场景</h4>
<ul>
<li>
<p>高频率、大数据临时集合。</p>
</li>
<li>
<p>网络协议解析、日志聚合、临时缓存。</p>
</li>
<li>
<p>需要 <code>Span</code> 访问的场景。</p>
</li>
</ul>
<h4 data-id="heading-20">不适合场景</h4>
<ul>
<li>
<p>长期持有的全局集合。</p>
</li>
<li>
<p>数据量小且生命周期长的普通集合。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[周日小插曲 -- 肘子的 Swift 周报 #115]]></title>    <link>https://juejin.cn/post/7583921477613764643</link>    <guid>https://juejin.cn/post/7583921477613764643</guid>    <pubDate>2025-12-15T23:59:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583921477613764643" data-draft-id="7583168260796956712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="周日小插曲  -- 肘子的 Swift 周报 #115"/> <meta itemprop="keywords" content="Swift,SwiftUI,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T23:59:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            周日小插曲  -- 肘子的 Swift 周报 #115
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T23:59:37.000Z" title="Mon Dec 15 2025 23:59:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c3d72ed85e4a06a2c29c0017af2935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766447976&amp;x-signature=yPkO8Co%2F%2FLNNp6WV8tVMSrTRHDE%3D" alt="issue115.webp" loading="lazy"/></p>
<h2 data-id="heading-0">周日小插曲</h2>
<p>周日下午，我正准备周一的周报。起身的瞬间，右手小指似乎碰到了什么，然后它就伸不直了。</p>
<p>有些诡异——不痛、不肿，但就是无法伸直。急诊医生初步判断是小指伸肌腱损伤，约了周一做进一步检查，很可能需要手术修复。</p>
<p>这才意识到，平时存在感不强的小指，原来如此重要。现在戴着固定指套，打字变得比较困难。好在应该不是什么大问题，只是接下来一段时间会减少打字量。</p>
<p>人生无常，微笑对待。</p>
<p><strong>周一更新</strong>：今天进一步检查后，发现没有需要复位的骨折，只是单纯的肌腱断裂。这样就不用手术了，只需要戴指套固定 6 周就基本能恢复了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-115%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-115/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-114%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-114/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<blockquote>
<p>🚀 <strong>《肘子的 Swift 周报》</strong></p>
<p>每周为你精选最值得关注的 Swift、SwiftUI 技术动态</p>
<ul>
<li><strong>📮 立即订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Ffatbobman" target="_blank" title="https://weekly.fatbobman.com/fatbobman" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取完整内容</li>
<li><strong>👥 加入社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与 2000+ 开发者交流</li>
<li><strong>📚 深度教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 探索 200+ 原创文章</li>
</ul>
</blockquote>
<h2 data-id="heading-1">近期推荐</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fwatchos-development-pitfalls-and-practical-tips%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520115%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/watchos-development-pitfalls-and-practical-tips/?utm_source=fatbobman%20weekly%20issue%20115&amp;utm_medium=web" ref="nofollow noopener noreferrer">从 YaoYao 到 Tooboo：watchOS 开发避坑与实战</a></h3>
<p>作为知名 watchOS 应用 YaoYao、Tooboo、DunDun 的作者，<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaoyaojumprope.com%2Fabout" target="_blank" title="https://yaoyaojumprope.com/about" ref="nofollow noopener noreferrer">Haozes</a> 分享了 watchOS 开发中关于版本兼容、App 唤起通信、数据同步、重启恢复、内存泄露和电量优化等高质量实战经验。这篇文章涵盖了从 HealthKit 到 WCSession、从 HKWorkoutSession 到 TimelineSchedule 的完整开发避坑与性能调优指南，对于正在开发或计划开发 Apple Watch 应用的开发者具有极高参考价值。</p>
<blockquote>
<p>作为一个长期的 Apple Watch 用户和 Swift 博主，我常感叹 watchOS 开发的“神秘”——文档之外细节繁多，且网络上真正有深度的实战文章寥寥无几。为此，我特别邀请了 watchOS 领域的头部独立开发者 Haozes，来分享他的开发体会。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-01" target="_blank" title="https://l.fatbobman.com/w0115-01" ref="nofollow noopener noreferrer">Swift 6 严格并发迁移实战 (My journey to Swift 6 and Strict Concurrency)</a></h3>
<p>一次“只在真实用户设备上才会出现”的崩溃，迫使 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Firvingpop%2Foverlay%2Fabout-this-profile%2F" target="_blank" title="https://www.linkedin.com/in/irvingpop/overlay/about-this-profile/" ref="nofollow noopener noreferrer">Irving Popovetsky</a> 将一整个已上线的 iOS 应用迁移到 Swift 6 + Strict Concurrency。这篇文章完整记录了从迁移之初的 76 个 error、238 个 warning 开始，到逐步引入 <code>@preconcurrency</code>、<code>actor</code>、<code>@MainActor</code>、<code>Sendable</code>、<code>nonisolated(unsafe)</code>，再到真机 + Thread Sanitizer 验证的全过程。Irving 指出，Swift 6 的运行时会在闭包被调用的瞬间验证 actor 隔离，哪怕你在闭包内部再 <code>Task { @MainActor in }</code> 也可能为时已晚。文章中对这一行为给出了清晰、可复用的修复模式。</p>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-02" target="_blank" title="https://l.fatbobman.com/w0115-02" ref="nofollow noopener noreferrer">用 MetricKit 监控应用性能 (Monitoring app performance with MetricKit)</a></h3>
<p>MetricKit 是 Apple 在 iOS 13 引入的系统级性能诊断框架，用于向开发者提供来自真实用户设备的应用性能与稳定性数据。它只在真机环境中工作，数据来源于系统在后台长期采样并聚合的结果，因此能够更真实地反映应用在实际使用场景下的行为。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fmecid" target="_blank" title="https://x.com/mecid" ref="nofollow noopener noreferrer">Majid Jabrayilov</a> 在本文中展示了如何通过 <code>MXMetricManager</code> 订阅系统级性能数据，从后台异常退出、CPU / 内存资源限制，到崩溃诊断信息，逐步提取关键指标并上报，从而构建一个更完整、可追溯的应用性能监控面板。Majid 也特别提醒，MetricKit 的数据通常按天聚合下发，而非实时回调，实际分析时需要结合时间戳理解其所覆盖的时间区间。</p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-03" target="_blank" title="https://l.fatbobman.com/w0115-03" ref="nofollow noopener noreferrer">用 Claude Code 重构 MistKit (Rebuilding MistKit with Claude Code - From CloudKit Docs to Type-Safe Swift)</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fleogdion" target="_blank" title="https://x.com/leogdion" ref="nofollow noopener noreferrer">Leo Dion</a> 在重建自己停更多年的 CloudKit 服务端库 MistKit 时，发现 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapple%2Fswift-openapi-generator" target="_blank" title="https://github.com/apple/swift-openapi-generator" ref="nofollow noopener noreferrer">swift-openapi-generator</a> 能显著降低重构复杂度：只要将 CloudKit 的 REST 文档转化为 OpenAPI 规范，就可以自动生成大规模、类型安全的 Swift 客户端代码。为此，他引入 Claude Code，专门负责完成“从 Apple 文档到 OpenAPI YAML”的翻译工作。</p>
<p>文章最有价值的地方，并不在于“AI 生成了多少代码”，而在于 Leo 如何使用 AI。他并没有让 Claude 直接实现 MistKit，而是将其定位为“文档翻译与模式放大器”，而真正复杂、需要工程判断与架构取舍的部分，始终由作者亲自把控。与其让 AI 直接“写代码”，不如让它把复杂问题<strong>变成可生成、可校验的问题</strong>——这正是这次 MistKit 重建过程中最值得借鉴的地方。</p>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-04" target="_blank" title="https://l.fatbobman.com/w0115-04" ref="nofollow noopener noreferrer">ChatGPT 记忆系统逆向分析 (I Reverse Engineered ChatGPT's Memory System, and Here's What I Found!)</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fmanthanguptaa" target="_blank" title="https://x.com/manthanguptaa" ref="nofollow noopener noreferrer">Manthan Gupta</a> 通过大量对话实验，对 ChatGPT 的“记忆”行为进行了逆向分析，发现其实现方式远比想象中简单：没有向量数据库、没有跨历史对话的 RAG，而是由四层上下文共同构成——一次性注入的 Session Metadata、显式存储的长期用户记忆、近期对话的轻量摘要，以及当前会话的滑动窗口。Manthan 认为，这种设计在性能、延迟和 token 成本上的优势非常明显：通过预计算摘要和显式事实注入，换取“足够好”的连续性，而不是昂贵的全量历史检索。Manthan 还有另一篇针对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-05" target="_blank" title="https://l.fatbobman.com/w0115-05" ref="nofollow noopener noreferrer">Claude 记忆系统的研究</a>。</p>
<blockquote>
<p>在使用 ChatGPT 的过程中，我时常会对它对我的了解程度感到惊讶。尽管我清楚，这种“熟悉感”来自其记忆与上下文机制，但这也正是我长期偏向使用官方客户端的重要原因之一。当然，如果你对隐私问题格外敏感，那么这种能力本身，可能正是你不愿接受的那一部分。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-06" target="_blank" title="https://l.fatbobman.com/w0115-06" ref="nofollow noopener noreferrer">Swift Configuration 1.0 released</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbsky.app%2Fprofile%2Fczechboy0.dev" target="_blank" title="https://bsky.app/profile/czechboy0.dev" ref="nofollow noopener noreferrer">Honza Dvorsky</a> 在 Swift 官方博客中宣布 Swift Configuration 1.0 正式发布。该库为 Swift 应用与库提供了一套统一、类型安全的配置读取抽象，其关键并不在于支持多少配置格式，而是彻底分离「配置如何读取」与「配置来自哪里」。这一设计对库作者尤为重要——库可以接受配置而不绑定具体来源，从而在不同部署环境中保持良好的可组合性。随着 1.0 发布，Swift Configuration 的 API 已进入稳定阶段，并开始被 Vapor、Hummingbird 等项目探索集成。</p>
<blockquote>
<p>乍看之下，为配置管理引入这样一个抽象层似乎显得有些“重量级”，但一旦配置来源不再局限于单一文件，或者代码需要在不同环境与项目中复用，其带来的结构清晰度与扩展性优势就会迅速显现。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-07" target="_blank" title="https://l.fatbobman.com/w0115-07" ref="nofollow noopener noreferrer">TCA 架构：一个被美化的反模式？ (TCA Architecture: A Glorified Antipattern)</a></h3>
<p>这是一篇立场极其鲜明的长文。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40redhotbits" target="_blank" title="https://medium.com/@redhotbits" ref="nofollow noopener noreferrer">Lazar Otasevic</a> 从函数式编程与 SwiftUI 的运行模型出发，系统性地反对了 TCA 以 <code>Action</code> enum + <code>Reducer</code> 为核心的设计，认为这是一种“将行为编码为数据”的经典反模式，并且不必要地夺走了 SwiftUI 原本应当拥有的状态所有权。与许多停留在情绪或偏好层面的“反 TCA”讨论不同，本文给出了一套完整、可运行的替代思路：将 <strong>State</strong> 视为纯数据、<strong>Logic</strong> 视为无状态的实现细节，并通过闭包（capabilities）暴露行为，从而在保持可测试性与可组合性的同时，更贴合 SwiftUI 的声明式数据流模型。</p>
<blockquote>
<p>考虑到 TCA 刚出现的时期，很多开发者仍难以应对 <code>ObservableObject</code> 响应颗粒度不足、缺乏 <code>@MainActor</code>、<code>Task</code> 等工具、异步调用高度依赖 Combine 的现实处境，TCA 确实有效解决了当时的一系列痛点。但随着 Swift 与 SwiftUI 的不断演进，TCA 中一些曾经突出的优势已不再明显，而其可组合性模型对不少开发者而言，使用与理解成本也依然不低。即便如此，TCA 仍然是许多开发者和团队已经适应并喜爱的开发范式——归根结底，适合自己的，才是最好的。</p>
</blockquote>
<h2 data-id="heading-9">工具</h2>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-08" target="_blank" title="https://l.fatbobman.com/w0115-08" ref="nofollow noopener noreferrer">FluidAudio: 为 Apple 平台打造的本地化音频 AI 工具包</a></h3>
<p>FluidAudio 是一个专为 Apple 平台设计的 Swift 音频 AI SDK，提供完全本地化的语音识别、说话人分离、语音活动检测等功能，由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fbrandonweng%2F" target="_blank" title="https://www.linkedin.com/in/brandonweng/" ref="nofollow noopener noreferrer">Brandon Weng</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fhanweng%2F" target="_blank" title="https://www.linkedin.com/in/hanweng/" ref="nofollow noopener noreferrer">Alex Weng</a> 主导开发。所有推理都在 Apple Neural Engine (ANE) 上运行，实现了低延迟、低功耗的音频处理能力。</p>
<p><strong>核心特性：</strong></p>
<ul>
<li><strong>完全本地化</strong>：所有模型在设备端运行，无需网络连接，充分保护用户隐私</li>
<li><strong>ANE 优化</strong>：充分利用 Apple Neural Engine，避免使用 GPU/MPS，降低 CPU 使用率和功耗</li>
<li><strong>开源透明</strong>：基于 MIT/Apache 2.0 许可的开源模型，可在 Hugging Face 获取</li>
<li><strong>易于集成</strong>：通过 Swift Package Manager 安装，API 设计简洁直观</li>
<li><strong>生产就绪</strong>：已被 Voice Ink、Spokenly、Slipbox、BoltAI 等知名应用采用</li>
</ul>
<p>FluidAudio 支持自动语音识别（Parakeet TDT v3，25 种欧洲语言）、说话人分离（离线/在线双模式）、语音活动检测（Silero VAD）以及文字转语音（Beta）。在 M4 Pro 上，语音识别的实时系数可达约 190x，处理 1 小时音频仅需 19 秒。</p>
<p>如果你正在开发涉及语音处理的 iOS/macOS 应用，FluidAudio 绝对值得尝试。</p>
<hr/>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0115-09" target="_blank" title="https://l.fatbobman.com/w0115-09" ref="nofollow noopener noreferrer">Navigable: 统一 SwiftUI 导航管理</a></h3>
<p>SwiftUI 中的一大痛点，在于如何将多级路由、sheet、full-screen cover 以及 alert 等不同导航与展示机制统一管理。由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fcoreyd303%2F" target="_blank" title="https://www.linkedin.com/in/coreyd303/" ref="nofollow noopener noreferrer">Corey Davis</a> 开发的 Navigable 提供了一种更集中、可测试的解决方案：它将所有导航行为统一收敛到一个可观察的 <code>NavigationState</code> 中，作为唯一的状态来源。</p>
<p>通过这种方式，Navigable 能够在保持 type-safe 与现代 Swift（@Observable、Swift 6） 特性的同时，将导航逻辑从视图中剥离出来，支持复杂流程、深链以及单元测试。同时，它既支持声明式的视图构建，也允许通过命令式 API（如 <code>push</code> / <code>pop</code>）驱动状态变化，在复杂场景下更接近传统路由系统的可控性。</p>
<blockquote>
<p>该库仍处在开发早期，但其实现思路值得持续关注。</p>
</blockquote>
<h2 data-id="heading-12">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-114%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-114/" ref="nofollow noopener noreferrer">挖掘“沉默的专家”- #114</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-113%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-113/" ref="nofollow noopener noreferrer">当 Android 手机『强行兼容』AirDrop - #113</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-112%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-112/" ref="nofollow noopener noreferrer">毕业 30 年同学群：一场 AI 引发的“真假难辨”危机 - #112</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-111%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-111/" ref="nofollow noopener noreferrer">Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时 - #111</a></li>
</ul>
<h2 data-id="heading-13">💝 支持与反馈</h2>
<p>如果本期周报对你有帮助，请：</p>
<ul>
<li>👍 <strong>点赞</strong> - 让更多开发者看到</li>
<li>💬 <strong>评论</strong> - 分享你的看法或问题</li>
<li>🔄 <strong>转发</strong> - 帮助同行共同成长</li>
</ul>
<hr/>
<blockquote>
<p>🚀 <strong>拓展 Swift 视野</strong></p>
<ul>
<li><strong>📮 邮件订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Fwelcome" target="_blank" title="https://weekly.fatbobman.com/welcome" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取独家技术洞察</li>
<li><strong>👥 开发者社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 实时交流开发经验</li>
<li><strong>📚 原创教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 学习 Swift/SwiftUI 最佳实践</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员爆哭！我们让 COCO AI 接管 GitLab 审查后，团队直接起飞：连 CTO 都说“这玩意儿比人靠谱多了]]></title>    <link>https://juejin.cn/post/7583910637958627347</link>    <guid>https://juejin.cn/post/7583910637958627347</guid>    <pubDate>2025-12-15T16:05:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910637958627347" data-draft-id="7583898823921582122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员爆哭！我们让 COCO AI 接管 GitLab 审查后，团队直接起飞：连 CTO 都说“这玩意儿比人靠谱多了"/> <meta itemprop="keywords" content="人工智能,GitLab"/> <meta itemprop="datePublished" content="2025-12-15T16:05:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极限实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1258294223312599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员爆哭！我们让 COCO AI 接管 GitLab 审查后，团队直接起飞：连 CTO 都说“这玩意儿比人靠谱多了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1258294223312599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极限实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T16:05:37.000Z" title="Mon Dec 15 2025 16:05:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我直接讲结论：</p>
<p><strong>把 COCO AI 接入 GitLab 做自动代码审核之后，我们团队的开发效率被硬生生抬了一个时代。</strong></p>
<p>没夸张。不是优化 10% 或 20%。是 ——</p>
<blockquote>
<p><strong>开发效率 x3</strong><br/>
<strong>Bug 暴露率 x4</strong><br/>
<strong>Review 时间 ÷10</strong></p>
</blockquote>
<p>更夸张的是，连我们 CTO 都说：<br/>
<strong>“这玩意儿比人审得狠，也比人稳定。”</strong></p>
<p>程序员则在角落瑟瑟发抖：<br/>
<strong>“以前写代码是骗过人，现在要骗过神。”</strong></p>
<p>今天我就把整个故事公开，让你看看真正的 AI 审查是什么狠劲。</p>
<h2 data-id="heading-0">01 ｜为什么你们团队的代码审查永远做不好？因为你们还在靠人。</h2>
<p>你们团队是不是这样？</p>
<ul>
<li>开发提个 MR，等两天没人看</li>
<li>Reviewer 随便扫一眼就点 Approve</li>
<li>线上事故后互相甩锅</li>
<li>业务压得 reviewer 根本没空认真审</li>
<li>新人写代码没人看，雷悄悄埋进去</li>
<li>老工程师被拉满，耗死在重复劳动里</li>
</ul>
<p>别骗自己了，这不是“流程问题”。<br/>
这是 <strong>时代问题</strong>。</p>
<p>靠人审代码？<br/>
那是 2018 年的玩法。</p>
<p>现在是 <strong>AI 审代码</strong> 的时代。<br/>
谁先用，谁就是下一代团队。</p>
<h2 data-id="heading-1">02 ｜ COCO AI 接入 GitLab 后，第一天就把我们吓了一跳</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34a503b9fd6491da17a06a52e776f8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419536&amp;x-signature=F3fQnU4GrJL0ISykY0uclPctU38%3D" alt="" loading="lazy"/></p>
<p>MR 刚发起，COCO AI 立刻跳出来：</p>
<p><strong>“代码已接收，正在审查……”</strong></p>
<p>几十秒后——</p>
<p><strong>啪！三十条问题丢你脸上。</strong></p>
<p>而且不是小问题，都是致命的：</p>
<ul>
<li>并发 map 读写直接 panic</li>
<li>goroutine 不关，泄漏到天荒地老</li>
<li>defer 在循环里疯狂堆</li>
<li>SQL 拼接漏洞肉眼可见</li>
<li>ctx 没传，超时失控</li>
<li>错误没处理，线上一炸就是大事故</li>
<li>魔法数字到处飞，迟早坑死同事</li>
</ul>
<p>我们团队瞬间安静了。<br/>
程序员盯着屏幕：<strong>“这谁写的？哦是我自己。”</strong></p>
<h2 data-id="heading-2">03 ｜ COCO AI 到底有多狠？它审代码完全不给人留面子。</h2>
<p>你在代码里犯过的错，它全看得见。</p>
<p>它的风格就是四个字：<strong>不留活口</strong>。</p>
<p>它会直接给你分析：</p>
<h3 data-id="heading-3">⚠ 逻辑错误？直接点名。</h3>
<blockquote>
<p>第 87 行你 return true 可能放大权限，严重安全风险。</p>
</blockquote>
<h3 data-id="heading-4">⚠ 并发不安全？当场抓包。</h3>
<blockquote>
<p>这里的 map 没加锁，线上必崩，别侥幸了。</p>
</blockquote>
<h3 data-id="heading-5">⚠ 性能差？它骂你。</h3>
<blockquote>
<p>strings.Split 一秒钟几十次，你不怕 CPU 烧？<br/>
建议换 Cut 或者预编译正则。</p>
</blockquote>
<h3 data-id="heading-6">⚠ 可读性差？它批你。</h3>
<blockquote>
<p>你这函数 160 行，是准备写回忆录？</p>
</blockquote>
<h3 data-id="heading-7">⚠ 测试没写？它戳破你。</h3>
<blockquote>
<p>缺反例测试，别装了，我知道你赶进度。</p>
</blockquote>
<p>它不拍马屁，不做样子，不搞关系，不吹彩虹屁，<br/>
<strong>它只针对代码，不针对人。</strong><br/>
<strong>它只认问题，不认面子。</strong></p>
<p>这就是 AI 审查的力量。</p>
<h2 data-id="heading-8">04 ｜更离谱的是：接 GitLab 只要 30 行代码</h2>
<p>这玩意儿接入 GitLab 简直轻到离谱。</p>
<p>流程就是三步：</p>
<ol>
<li>GitLab MR → Webhook → 你的服务</li>
<li>把 Diff 丢给 COCO AI</li>
<li>把审查结果评论回 MR</li>
</ol>
<p>Go 代码甚至可以一屏写完：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handleMR</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    req := parseWebhook(r)
    diff := gitlab.GetDiff(req)
    review := coco.ReviewCode(diff)
    gitlab.PostComment(req, review.Content)
}
</code></pre>
<p>连新手工程师看了都说：<br/>
<strong>“这接入成本也太爽了吧？”</strong></p>
<h2 data-id="heading-9">05 ｜我给你看真实的团队指标，绝不是嘴上吹</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aced84891b44a94ae612f52ba4b520e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419536&amp;x-signature=qBEgBbC2uu%2BFZ5C7wW1lWkZUME0%3D" alt="" loading="lazy"/></p>
<p>三个月统计（真实数据）：</p>



































<table><thead><tr><th>指标</th><th>接入前</th><th>接入后</th></tr></thead><tbody><tr><td>平均 MR 审查时间</td><td>1–2 天</td><td><strong>5–20 分钟</strong></td></tr><tr><td>Reviewer 工作量</td><td>爆满</td><td><strong>骤降 70%</strong></td></tr><tr><td>严重 Bug 暴露率</td><td>20% 左右</td><td><strong>80%+</strong></td></tr><tr><td>线上事故</td><td>7 次/季度</td><td><strong>2 次/季度</strong>（还都小事故）</td></tr><tr><td>新人代码质量</td><td>不敢看</td><td><strong>像有老司机在手把手教</strong></td></tr></tbody></table>
<p>更爽的是：<br/>
<strong>COCO AI 还把老工程师解放出来做更重要的事情。</strong></p>
<p>这才是 AI 的正确使用方式。</p>
<h2 data-id="heading-10">06 ｜你以为 AI 是玩具？错。它是未来的生产力。</h2>
<p>这不是一个“用不用”的问题。<br/>
这是一个“想不想被时代淘汰”的问题。</p>
<p>未来三年，软件团队会被两种力量碾压：</p>
<ul>
<li><strong>用 AI 的团队</strong></li>
<li><strong>被用 AI 的团队压死的团队</strong></li>
</ul>
<p>选择权不在你手里，趋势已经发生。</p>
<h2 data-id="heading-11">07 ｜更狠的还在后面：COCO 正在做这些</h2>
<p>我们内部已在测试：</p>
<ul>
<li>GitHub PR 自动审查</li>
<li>IDE 实时调试 + 实时审查</li>
<li>全仓扫描的“技术体检报告”</li>
<li>自动生成修复 patch</li>
<li>AI 识别架构风险、循环依赖、隐藏 bug 链</li>
<li>一键优化整个模块</li>
</ul>
<p>一句话：</p>
<p><strong>COCO AI 会把你团队的代码质量拉到一个你无法想象的高度。</strong></p>
<h2 data-id="heading-12">结语：如果你团队现在还靠人审代码，那你们已经落后了。</h2>
<p>别再幻想靠人力提升研发效率。<br/>
别再指望审查不出事故。<br/>
别再让高级工程师死在重复劳动里。</p>
<p>把代码审查交给 AI，<br/>
把工程师从地狱里解放出来。</p>
<p>如果你想让团队变强、变快、变稳，<br/>
那你需要的，不是更多人，<br/>
而是 <strong>COCO AI 做你的 GitLab Reviewer。</strong></p>
<h2 data-id="heading-13">关于 COCO AI</h2>
<p>COCO AI 是一款完全开源、跨平台的企业级智能搜索与助手系统，专为现代企业打造。它通过统一搜索入口，连接企业内外部的异构数据源，融合大模型能力，帮助团队高效访问知识，智能决策协作。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcoco.rs" target="_blank" title="https://coco.rs" ref="nofollow noopener noreferrer">coco.rs</a><br/>
Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" target="_blank" title="https://github.com/infinilabs/coco-app" ref="nofollow noopener noreferrer">github.com/infinilabs/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】鸿蒙6.0的pdfService与pdfViewManager终极爆破]]></title>    <link>https://juejin.cn/post/7583910418658967598</link>    <guid>https://juejin.cn/post/7583910418658967598</guid>    <pubDate>2025-12-15T16:06:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910418658967598" data-draft-id="7583913535271419914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】鸿蒙6.0的pdfService与pdfViewManager终极爆破"/> <meta itemprop="keywords" content="ArkTS,HarmonyOS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-15T16:06:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】鸿蒙6.0的pdfService与pdfViewManager终极爆破
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T16:06:23.000Z" title="Mon Dec 15 2025 16:06:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是V哥。
兄弟们抄家伙！今天给大家分享用鸿蒙6.0的PDF Kit撕碎文档开发防线，全程高能代码扫射，专治各种PDF开发不服！以下基于HarmonyOS 6.0（API 21）的ArkTS实战，弹药已上膛👇</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">💣 <strong>第一弹：pdfService——文档底层爆破术</strong></h3>
<p><strong>核心能力：文档加载/编辑/转换</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { pdfService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PDFKit'</span>;  
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;  

<span class="hljs-comment">// 战术1：沙箱路径加载核弹头（PDF文档）  </span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">document</span>: pdfService.<span class="hljs-property">PdfDocument</span> = <span class="hljs-keyword">new</span> pdfService.<span class="hljs-title class_">PdfDocument</span>();  
<span class="hljs-keyword">private</span> <span class="hljs-attr">filePath</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/confidential.pdf'</span>;  

<span class="hljs-keyword">async</span> <span class="hljs-title function_">loadPdfNuke</span>(<span class="hljs-params"/>) {  
  <span class="hljs-keyword">try</span> {  
    <span class="hljs-comment">// 加载文档  </span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">loadDocument</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);  
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"核弹头装载完毕！总页数:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getPageCount</span>());  

    <span class="hljs-comment">// 战术2：动态拆解PDF（获取指定页）  </span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">page</span>: pdfService.<span class="hljs-property">PdfPage</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getPage</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 第一页  </span>
    <span class="hljs-keyword">const</span> pixelMap = page.<span class="hljs-title function_">getPagePixelMap</span>(); <span class="hljs-comment">// 转换为像素图  </span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewImage</span> = pixelMap; <span class="hljs-comment">// 绑定到Image组件  </span>

    <span class="hljs-comment">// 战术3：添加加密批注（红色高亮）  </span>
    page.<span class="hljs-title function_">addAnnotation</span>({  
      <span class="hljs-attr">type</span>: pdfService.<span class="hljs-property">AnnotationType</span>.<span class="hljs-property">HIGHLIGHT</span>,  
      <span class="hljs-attr">rect</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">30</span> },  
      <span class="hljs-attr">content</span>: <span class="hljs-string">"V哥机密批注"</span>,  
      <span class="hljs-attr">color</span>: <span class="hljs-string">'#FF0000'</span>  
    });  
  } <span class="hljs-keyword">catch</span> (err) {  
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePdfError</span>(err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>);  
  }  
}  
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><strong>沙箱路径强制隔离</strong>：外部PDF必须先复制到<code>context.filesDir</code>再加载</li>
<li><strong>像素级渲染</strong>：<code>getPagePixelMap()</code>将PDF页转为<code>PixelMap</code>，直接喂给Image组件实现逐页浏览</li>
<li><strong>批注战争迷雾</strong>：批注坐标<code>rect</code>需精确到像素级，否则触发<code>1820005</code>（坐标越界）</li>
</ul>
<hr/>
<p><strong>🎯 <strong>第二弹：pdfViewManager——预览战场统治术</strong></strong>
<strong>核心能力：布局控制/跳转/缩放</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { pdfViewManager, pdfService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PDFKit'</span>;  

<span class="hljs-comment">// 建立PDF控制指挥部  </span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">controller</span>: pdfViewManager.<span class="hljs-property">PdfController</span> = <span class="hljs-keyword">new</span> pdfViewManager.<span class="hljs-title class_">PdfController</span>();  

<span class="hljs-comment">// 战术1：双页模式+连续滚动（仿实体书）  </span>
<span class="hljs-title function_">setupBattlefieldView</span>(<span class="hljs-params"/>) {  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setPageLayout</span>(pdfService.<span class="hljs-property">PageLayout</span>.<span class="hljs-property">LAYOUT_DOUBLE</span>); <span class="hljs-comment">// 双页布局  </span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setPageContinuous</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 连续滚动  </span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setPageFit</span>(pdfService.<span class="hljs-property">PageFit</span>.<span class="hljs-property">FIT_WIDTH</span>); <span class="hljs-comment">// 宽度适配  </span>
}  

<span class="hljs-comment">// 战术2：精准炮击目标页码  </span>
<span class="hljs-meta">@State</span> <span class="hljs-attr">currentPage</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;  
<span class="hljs-title function_">launchPageStrike</span>(<span class="hljs-params">pageIndex: <span class="hljs-built_in">number</span></span>) {  
  <span class="hljs-keyword">if</span> (pageIndex &gt;= <span class="hljs-number">0</span> &amp;&amp; pageIndex &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getPageCount</span>()) {  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">goToPage</span>(pageIndex); <span class="hljs-comment">// 跳转指定页  </span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPage</span> = pageIndex;  
  } <span class="hljs-keyword">else</span> {  
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"坐标超出射程！"</span>);  
  }  
}  

<span class="hljs-comment">// 战术3：放大镜狙击（2倍缩放）  </span>
<span class="hljs-title function_">zoomSniper</span>(<span class="hljs-params"/>) {  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setPageZoom</span>(<span class="hljs-number">2.0</span>); <span class="hljs-comment">// 200%放大  </span>
}  
</code></pre>
<p><strong>战场规则</strong>：</p>
<ul>
<li><strong>布局三要素</strong>：
<ul>
<li><code>LAYOUT_SINGLE</code>（单页）/ <code>LAYOUT_DOUBLE</code>（双页）</li>
<li><code>FIT_WIDTH</code>（宽度适配）/ <code>FIT_HEIGHT</code>（高度适配）</li>
<li><code>setPageContinuous(true)</code>开启无限滚动</li>
</ul>
</li>
<li><strong>控制器禁忌</strong>：<code>loadDocument()</code>完成后<strong>禁止立即操作控制器</strong>，需通过事件回调触发</li>
</ul>
<hr/>
<p><strong>🚨 <strong>第三弹：错误码战地医疗包</strong></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">handlePdfError</span>(<span class="hljs-params">err: BusinessError</span>) {  
  <span class="hljs-keyword">switch</span>(err.<span class="hljs-property">code</span>) {  
    <span class="hljs-keyword">case</span> <span class="hljs-number">1800001</span>: <span class="hljs-comment">// PARSE_ERROR_FORMAT  </span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"文件格式被污染！启用消毒协议"</span>);  
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">repairDocument</span>(); <span class="hljs-comment">// 调用文档修复  </span>
      <span class="hljs-keyword">break</span>;  
    <span class="hljs-keyword">case</span> <span class="hljs-number">1820005</span>: <span class="hljs-comment">// PAGE_INDEX_OUT_OF_RANGE  </span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"页码越界！最大页数:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">getPageCount</span>());  
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">launchPageStrike</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 退回首页  </span>
      <span class="hljs-keyword">break</span>;  
    <span class="hljs-keyword">case</span> <span class="hljs-number">1810003</span>: <span class="hljs-comment">// DOCUMENT_NOT_LOADED  </span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"核弹头未装载！检查路径:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>);  
      <span class="hljs-keyword">break</span>;  
    <span class="hljs-attr">default</span>:  
      crashReporter.<span class="hljs-title function_">log</span>(<span class="hljs-string">`PDF核爆失败: CODE <span class="hljs-subst">${err.code}</span>`</span>);  
  }  
}  
</code></pre>
<p><strong>高频错误码表</strong>：</p>

























<table><thead><tr><th>错误码</th><th>敌军代号</th><th>反制措施</th></tr></thead><tbody><tr><td>1800001</td><td>文档格式错误</td><td>校验文件完整性或重新下载</td></tr><tr><td>1820005</td><td>页码越界</td><td>动态绑定<code>getPageCount()</code>校验</td></tr><tr><td>1810007</td><td>内存溢出</td><td>启用<code>QuantumCache</code>分页加载</td></tr></tbody></table>
<hr/>
<p><strong>☢️ <strong>V哥的禁忌武器库</strong></strong></p>
<ol>
<li><strong>大文件瞬移术（百兆PDF秒开）</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 启用量子缓存分页加载（鸿蒙6.0独有）  </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">enableFeature</span>(  
  pdfViewManager.<span class="hljs-property">FeatureFlag</span>.<span class="hljs-property">QUANTUM_CACHE</span>,  
  { <span class="hljs-attr">chunkSize</span>: <span class="hljs-number">5</span> } <span class="hljs-comment">// 预加载5页  </span>
);  
</code></pre>
<ol start="2">
<li><strong>防OOM自杀机制</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 内存压力&gt;80%自动释放非可视页  </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'memoryPressure'</span>, <span class="hljs-function">(<span class="hljs-params">pressureLevel</span>) =&gt;</span> {  
  <span class="hljs-keyword">if</span> (pressureLevel &gt; <span class="hljs-number">80</span>) {  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">releaseInvisiblePages</span>(); <span class="hljs-comment">// 释放不可见页  </span>
  }  
});  
</code></pre>
<ol start="3">
<li><strong>跨设备协同打击</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 平板+手机双屏预览（需NearbyNearbyTransfer）  </span>
gameNearbyTransfer.<span class="hljs-title function_">sendFile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filePath</span>, <span class="hljs-string">'tablet-001'</span>);  
</code></pre>
<hr/>
<p><strong>💥 <strong>战报总结</strong></strong>
以上战术已在V哥众多应用中实战验证：</p>
<ul>
<li><strong>200页PDF加载速度</strong>：&lt;1.2秒（SSD级优化）</li>
<li><strong>批注操作延迟</strong>：&lt;8ms（碾压级响应）</li>
<li><strong>内存消耗峰值下降</strong>：40%（OOM歼灭率99%）</li>
</ul>
<p><strong>V哥语录</strong>：</p>
<p>（注：所有API均基于HarmonyOS 6.0 SDK，DevEco Studio需≥6.0.0 Release版本）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[人工智能入门概念介绍]]></title>    <link>https://juejin.cn/post/7583943503555444786</link>    <guid>https://juejin.cn/post/7583943503555444786</guid>    <pubDate>2025-12-15T16:06:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583943503555444786" data-draft-id="7583943503555428402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="人工智能入门概念介绍"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-15T16:06:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_Shawn"/> <meta itemprop="url" content="https://juejin.cn/user/1855631358965384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            人工智能入门概念介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631358965384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_Shawn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T16:06:09.000Z" title="Mon Dec 15 2025 16:06:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近公司正在推荐Ai相关项目，目前主要是大模型相关的应用层面开发，但自己还是希望能够基础入手，全方位了解一下机器学习，深度学习，强化学习，自然语言，大模型等Ai相关的知识点，仅了解相关概念，不去深入了解算法实现。本文主要介绍一下机器学习的基本概念。</p>
<h2 data-id="heading-0">什么是机器学习</h2>
<p>引用周志华带佬的机器学习一书提到的案例，我们在生活中挑选西瓜的时候，经常会假嘛若鬼地敲一下西瓜，听一听声音，如果发出 “嘭嘭” 的闷声，说明西瓜成熟度好，果肉饱满。若发出 “当当” 的清脆声，可能西瓜还未成熟；若发出 “噗噗” 声，则可能西瓜内部已过度成熟或有腐烂现象。也有老手看外观，看瓜蒂，根茎，表皮，掂重量等操作，</p>
<p>这些都是经验之谈，都是人类从大量实验中探索出来的规律与模式。这一过程在人工智能中的实现就是<strong>机器学习</strong>。</p>
<p><strong>机器学习是计算机基于数据构建概率统计模型并运用模型对数据进行预测与分析的学科。</strong></p>
<h2 data-id="heading-1">机器学习基本术语</h2>
<p>我们还是以西瓜为例，其数据如下：</p>


























<table><thead><tr><th>形状</th><th>色泽</th><th>瓜皮</th><th>敲声</th><th>瓜蒂</th></tr></thead><tbody><tr><td>椭圆</td><td>青绿</td><td>硬</td><td>嘭嘭</td><td>粗壮</td></tr><tr><td>圆形</td><td>绿色</td><td>硬</td><td>嘭嘭</td><td>蜷缩</td></tr></tbody></table>
<p>这些数据，每条数据都是关于一个西瓜的描述，形状，色泽，瓜皮，敲声，瓜蒂都是这条数据的<strong>属性（Attribute）</strong> ，属性的取值称为<strong>属性值(Attribute Value)</strong> ，不同的属性值有序排列得到的向量就是数据，也叫<strong>实例(Instance)或者叫做样本(Sample)</strong> 。</p>
<p>形状，色泽，瓜皮，敲声，瓜蒂作为五个坐标轴，这就是一个描述西瓜的五维空间，这些维度组成了<strong>特征空间（Feature Space）</strong> ，每一组属性值的集合都是这个空间中的一个点，所以我们也把每一个样本都称为<strong>特征向量(Feature Vector)。</strong></p>
<p>我们知道，机器学习可说是从数据中来，到数据中去，需要机器学习能够从数据中学习得到一个模型，这个过程就叫做<strong>学习(Learning)或者训练(Training)，</strong> 参与训练的数据被称为<strong>训练集(training data)</strong> ，其中每个样本都被称为<strong>训练样本(training sample)</strong> 。</p>
<p>我们训练出来的模型，到底效果如何，这个时候需要一部分数据进行<strong>验证(Validate)</strong> ，参与验证的数据则被称为<strong>验证集(Validation Data)</strong> ，其中每个样本都被称为<strong>验证样本(Validation Sample)</strong> 。</p>
<p>最后，我们如何对未知的数据进行推理判断，要判断一个未被剥开的瓜是好瓜还是坏瓜，这个过程叫做<strong>预测(Prediction)</strong> 或者叫做<strong>推理(Inference)</strong> 。</p>
<h2 data-id="heading-2">机器学习分类</h2>
<p>如果我们仅对瓜判断好坏，这类的值为离散值，那么此类学习任务称为<strong>分类</strong>。瓜的好坏分类只有两种，一个是好，一个是坏，对于只有两个类别的任务，被称为<strong>二分类</strong>。涉及到多个类别时，则称为<strong>多分类</strong>。</p>
<p>如果我们是对瓜的成熟度进行判断，例如瓜的成熟度为0.95，0.37，这类的值为连续值，那么此类学习任务称为<strong>回归</strong>，输入变量和输出变量均为连续变量。</p>
<p>我们还可以对瓜做<strong>聚类（Clustering）</strong> ,即将训练集中的西瓜分成若干组，每组称为一个<strong>簇(Cluster)</strong> 。把瓜可以分为浅色瓜，深色瓜，但是在聚类学习过程中，这些概念咱们事先是不知道，所以我们需要先<strong>标注。</strong> 这一类任务，被称为<strong>聚类任务</strong>，也可以是<strong>标注任务</strong>，输入变量和输出变量均为变量序列。</p>
<p>根据是否标注，可以将学习任务分为两大类：</p>
<ul>
<li>监督学习：基于已知类别的训练数据进行学习；</li>
<li>无监督学习：基于未知类别的训练数据进行学习；</li>
</ul>
<p>还有一种就是半监督学习：同时使用已知类别和未知类别的训练数据进行学习。</p>
<p>监督学习的主要代表就是分类和回归，无监督学习的主要代表就是聚类。</p>
<p>另外还有深度学习，强化学习</p>
<ul>
<li>深度学习：深度学习是机器学习的一个子领域，专注于应用多层神经挽留过进行学习，深度学习擅长处理复杂的数据如图像、音频、文本，因此在AI中的应用非常有效；</li>
<li>强化学习：强化学习是一种通过与环境交互，并基于奖励和惩罚机制来学习最优策略的方法。强化学习算法通过试错法来优化决策过程，以实现最大化累积奖励。常见算法包括Q-Learning、策略梯度和DQN等。</li>
</ul>
<h2 data-id="heading-3">机器学习整体流程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a16b289191f46669ac73f0822d34870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=8fMO%2BmbYIC%2BkczILhPfLJDI%2BfRg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">准备数据集</h3>
<p>在做机器学习算法的时候，第一步就是要做数据集准备，有了数据集之后，可以做探索性数据分析(Exploratory Data Analysis)，也可以做数据预处理（Pre-Processed Dataset）。</p>
<h4 data-id="heading-5">探索性数据分析</h4>
<p>进行探索性数据分析（Exploratory data analysis, EDA）是为了获得对数据的初步了解。EDA主要的工作是：对数据进行清洗，对数据进行描述（描述统计量，图表），查看数据的分布，比较数据之间的关系，培养对数据的直觉，对数据进行总结等。</p>
<p>探索性数据分析方法简单来说就是去了解数据，分析数据，搞清楚数据的分布。主要注重数据的真实分布，强调数据的可视化，使分析者能一目了然看出数据中隐含的规律，从而得到启发，以此帮助分析者找到适合数据的模型。</p>
<p>通常使用的三大EDA方法包括：</p>
<ul>
<li>描述性统计：平均数、中位数、模式、标准差。</li>
<li>数据可视化：热力图（辨别特征内部相关性）、箱形图（可视化群体差异）、散点图（可视化特征之间的相关性）、主成分分析（可视化数据集中呈现的聚类分布）等。</li>
<li>数据整形：对数据进行透视、分组、过滤等。</li>
</ul>
<h4 data-id="heading-6">数据预处理</h4>
<p>数据预处理，其实就是数据治理，对数据进行清理、数据整理或普通数据处理。指对数据进行各种检查和校正过程，以纠正缺失值、拼写错误、使数值正常化/标准化以使其具有可比性、转换数据(如对数转换)等问题。</p>
<p>数据的质量将对机器学习算法模型的质量好坏产生很大的影响。因此，为了达到最好的机器学习模型质量，传统的机器学习算法流程中，其实很大一部分工作就是在对数据进行分析和处理。</p>
<p>数据预处理的主要目的就是：减少噪音数据对训练数据的影响。</p>
<p>数据集本质上是一个M×N矩阵，其中M代表列（特征），N代表行（样本）。列主要有两部分组成，x和y，x为特征/独立变量/输入变量，y为类别标签/依赖变量/输出变量</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0f05d13f0ca4137b29d4cbb782ac2b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=yJ5kHIU6glg3KiqipP1RQ%2Brlqwc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">数据分割</h4>
<p>需要把预处理完成的数据，按照一定的规则，将完整的数据分割成训练集和验证集。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00cc9e83d67b4bf1ad4dc69d43b4f4cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=rRl5gYkBOWq4xmJTogW5u6kZxdg%3D" alt="" loading="lazy"/></p>
<p>或者分割成训练集和验证集以及测试集</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edab1bc1bd1d45f1b7e6ab58973a8b5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=J2ZgrXvVcDmSeNP4gMuHAyC4kuc%3D" alt="" loading="lazy"/></p>
<p>一般数据集分割的比例也如上图所示：</p>
<ul>
<li>训练集/验证集：80%/20%</li>
<li>训练集/验证集/测试集：60%/20%/20%</li>
</ul>
<h3 data-id="heading-8">模型训练</h3>
<p>数据分割成训练集和验证集之后，就可以使用训练集，选择<strong>机器学习算法</strong>进行模型训练</p>
<p>常见的机器学习算法有：</p>
<ol>
<li>SVM：支持向量机</li>
<li>KNN：k近邻算法(KNN)</li>
<li>DL：深度学习</li>
<li>GBM：Grandient Boosting Machine，机器学习梯度推进机</li>
<li>RF：Random Forest，随机森林</li>
<li>DT：Decision Tree，决策树</li>
</ol>
<p>决定模型训练的好坏主要有两种手段：</p>
<ul>
<li><strong>超参数调优</strong></li>
<li><strong>特征工程</strong></li>
</ul>
<h4 data-id="heading-9">超参数</h4>
<p>超参数是算法工程师用来管理机器学习模型训练的外部配置变量。有时也称为模型超参数，超参数会在训练模型前手动进行配置。与参数不同，超参数是在学习过程中自动导出的内部参数，而不是由数据科学家设置的。</p>
<p>常见的超参数有：</p>
<ol>
<li><strong>学习率</strong>是指算法更新估算值的速率</li>
<li><strong>学习率衰减</strong>是指随着时间的推移，逐渐降低学习率，以加快学习速度</li>
<li>小<strong>批次</strong>大小是指训练数据批次大小</li>
<li><strong>Epoch</strong> 是模型一次训练的轮数</li>
<li><strong>Eta</strong> 是指用于防止过拟合的收缩步长</li>
</ol>
<p>超参数调优手段有：</p>
<ul>
<li><strong>贝叶斯优化</strong>：贝叶斯优化是一种基于贝叶斯定理的技术，它描述了与当前知识相关的事件发生的概率。将贝叶斯优化用于超参数优化时，算法会从一组超参数中构建一个概率模型，以优化特定指标。它使用回归分析迭代地选择最佳的一组超参数。</li>
<li><strong>网格搜索</strong>：借助网格搜索，您可以指定一组超参数和性能指标，然后算法会遍历所有可能的组合来确定最佳匹配。网格搜索很好用，但它相对乏味且计算量大，特别是使用大量超参数时。</li>
<li><strong>随机搜索</strong>：虽然随机搜索与网格搜索基于相似的原则，但随机搜索在每次迭代时会随机选择一组超参数。当相对较少的超参数主要决定模型的结果时，该方法效果良好。</li>
</ul>
<h4 data-id="heading-10">特征工程</h4>
<p>特征工程是机器学习中最重要的一部分，因为根据已有的训练数据，可选用的算法是有限的；那么在同样的算法下特征的选取是不同的，100个人对一件事情会有100种看法，也就有100种特征，最后特征的质量决定模型的好坏。</p>
<p>特征工程是一个过程，这个过程将数据转换为能更好的表示业务逻辑的特征，从而提高机器学习的性能。</p>
<p>特征工程包括数据清理，特征提取，特征选择等过程</p>
<h3 data-id="heading-11">模型评估</h3>
<p>最后训练出来的模型，需要用验证集进行验证。验证结果ok过后，将模型发布上线，对模型进行预估/推理，评估模型性能的性能指标有：</p>
<ul>
<li>二分类：准确率（AC）、灵敏度（SN）、特异性（SP）和马太相关系数（MCC）</li>
<li>回归：确定系数（R²）、均方误差（MSE）以及均方根误差（RMSE）</li>
</ul>
<p><strong>经验误差与泛化误差</strong>：</p>
<ul>
<li>经验误差：是指AI模型在“训练数据”上的预测误差。模型在已经见过的数据上的表现有多好。就像学生做自己平时一直练习的题，做错的比例。</li>
<li>泛化误差：是指AI模型在“新、未见过的数据”上的预测误差。模型在实际应用时，能不能正确应对新情况。学生去参加考试，做没练过的新题，做错的比例，代表模型的“真实水平”。</li>
</ul>
<p><strong>过拟合与欠拟合：</strong></p>
<ul>
<li>过拟合：模型在“训练数据”上表现非常好，但在新数据（实际应用）上效果很差。</li>
<li>欠拟合：模型在训练数据上和新数据上都表现很差。</li>
</ul>
<p>****<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33cfd6e2afb449db8264e7f721916a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=dXcffzSm32INc32CISVabw8UHUc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebb6f71e8c6a409996f3f98a9b0e4bc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=f%2F7nbZmrpl8YnwX2OCPjDkP1Law%3D" alt="" loading="lazy"/></p>
<p><strong>指标计算公式：</strong></p>
<p><strong>真正例率和假正例率</strong></p>




















<table><thead><tr><th>****</th><th><strong>实际正例</strong></th><th><strong>实际负例</strong></th></tr></thead><tbody><tr><td><strong>预测为正例</strong></td><td><strong>TP(真正例)</strong></td><td><strong>FP(假正例)</strong></td></tr><tr><td><strong>预测为负例</strong></td><td><strong>FN(假负例)</strong></td><td><strong>TN(真负例)</strong></td></tr></tbody></table>
<ul>
<li>TP和TN越大越好</li>
<li>FP和FN越小越好</li>
</ul>
<p><strong>真正例率</strong>：又称召回率，也称查全率：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0de7188725444a678da44945a59ee0be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=1%2BLXf2CRvrpgnFc6aU8ZpoEn%2Fdw%3D" alt="" loading="lazy"/></p>
<p><strong>假正例率</strong>：又称误报概率：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b827bc75cf64f5cad40e1688c2a1e20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=xLhLpgksqjFKTRDHUdmwFoUnguA%3D" alt="" loading="lazy"/></p>
<p><strong>准确性</strong>：所有分类中正确分类的比例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38955b9f9f5941eba1f115cf2c81a190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=9wjX%2Fk5DU2pye%2BcJXR91Jl3Jz%2Bg%3D" alt="" loading="lazy"/></p>
<p><strong>精确率</strong>：模型所有预测为正分类中实际正分类的比例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef7825f6332d45cd935f195bdeb8f306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=q9knQbfaBcQFyFCVQY0V4r7AJwI%3D" alt="" loading="lazy"/></p>
<p><strong>PR 曲线（Precision-Recall Curve） ：</strong> 是一种用于评估分类模型性能的可视化工具，特别适用于样本类别极度不平衡的任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50af80b2c97c43bda5e576a49c38d9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=3mkUMUzneoG6bPx1ADz0NG6h8B8%3D" alt="" loading="lazy"/></p>
<ol>
<li>A 表现最好的模型，查准率和查全率整体较高。</li>
<li>B表现最差的模型，查准率下降很快，说明大量误报。</li>
<li>C中等水平，查全率上升时查准率下降较缓慢。</li>
</ol>
<p><strong>F1计算公式</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3753b84e4634cecbe609eb5c9561339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=05UumsHepjx2f5MUoUYmCRXmhlM%3D" alt="" loading="lazy"/></p>
<p><strong>ROC曲线：</strong></p>
<ul>
<li>ROC 曲线 是模型在所有阈值上的表现的可视化表示。</li>
<li>ROC 曲线的绘制方法是计算真正例率 (TPR) 和假正例率 (FPR) 值</li>
<li>ROC 曲线下面积 (AUC) 表示模型的概率，如果给定一个随机选择的正类别和负类别样本，正值将大于负</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc6687ce0e7c437f8fcfa5c31da326fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766419569&amp;x-signature=5C%2F0atdfKG3D57ZZO6usha65U4c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">参考文献</h2>
<ul>
<li>谷歌AI开发者：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmachine-learning%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/machine-learning?hl=zh-cn" ref="nofollow noopener noreferrer">developers.google.com/machine-lea…</a></li>
<li>微软AI：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Ftraining%2Fbrowse%2F%3Fresource_type%3Dmodule%26subjects%3Dartificial-intelligence" target="_blank" title="https://learn.microsoft.com/zh-cn/training/browse/?resource_type=module&amp;subjects=artificial-intelligence" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/train…</a></li>
<li>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdataprofessor%2Finfographic%2Fblob%2Fmaster%2F01-Building-the-Machine-Learning-Model.JPG" target="_blank" title="https://github.com/dataprofessor/infographic/blob/master/01-Building-the-Machine-Learning-Model.JPG" ref="nofollow noopener noreferrer">github.com/dataprofess…</a>**</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别拼凑感！商汤Seko 2.0让“一人剧组”量产百集爆款短剧]]></title>    <link>https://juejin.cn/post/7583903159774773263</link>    <guid>https://juejin.cn/post/7583903159774773263</guid>    <pubDate>2025-12-15T15:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583903159774773263" data-draft-id="7583921477613617187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别拼凑感！商汤Seko 2.0让“一人剧组”量产百集爆款短剧"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-15T15:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别拼凑感！商汤Seko 2.0让“一人剧组”量产百集爆款短剧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T15:21:39.000Z" title="Mon Dec 15 2025 15:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是一个内容创作者，大概率经历过这种绝望：脑子里有一部堪比《权力的游戏》的史诗大剧，但手头只有你自己、一台电脑，和永远凑不齐的拍摄预算。</p>
<p>过去的一年里，AI视频生成工具虽然火热，但大都在“抽卡”——生成几秒钟惊艳的镜头容易，想要讲完一个连贯的故事却难如登天。角色在上一秒还是长发飘飘，下一秒就换了张脸；场景更是随机突变，根本没法做连续剧。</p>
<p>但在2025年12月15日，这个局面被打破了。商汤科技在这个岁末扔出了一枚重磅炸弹：<strong>Seko 2.0</strong>。</p>
<p>这不是一次简单的版本号叠加，它是行业里第一个真正意义上能把“创编一体”跑通的智能体。简单来说，它让“一人剧组”从一句空洞的口号，变成了可以量产百集短剧的现实生产力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-15_23.12.02-1024x582.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-15_23.12.02-1024x582.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e413dab639204ab397e909a317d76663~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766416899&amp;x-signature=IdZgyUKtEM3YWGlowRsCW8xqjeo%3D" alt="iShot_2025-12-15_23.12.02" loading="lazy"/></a></p>
<h3 data-id="heading-0">治好了AI视频的“脸盲症”</h3>
<p>做过AI视频的人都知道，最让人头疼的不是画质，而是“一致性”。</p>
<p>以前我们用AI做剧，往往是拼凑式的。但在Seko 2.0里，商汤拿出了一个叫<strong>SekoIDX</strong>的技术。这个名字听起来很硬核，其实它解决的问题非常直观：它能死死“记住”你的主角。</p>
<p>不论是在第1集还是第50集，不论是近景特写还是远景打斗，主角的脸、衣服、神态都能保持高度统一。更绝的是，它引入了Agent智能调度，系统会自动管理跨剧集的人物、场景和道具。这意味着，你只需设定一次“张三穿着黑色风衣在雨夜”，后续所有相关镜头，AI都会替你守住这个设定，不再需要你每一帧都去写复杂的提示词来纠正它的“健忘”。</p>
<h3 data-id="heading-1">不再是哑剧，也不再是独角戏</h3>
<p>Seko 2.0的另一个杀手锏是<strong>SekoTalk</strong>。</p>
<p>早期的AI视频大多是“哑剧”，或者只能对上一个人的口型。一旦画面里出现两个人对话，嘴型和声音就会乱套。Seko 2.0号称是业内首个支持超过2人精准对口型的方案。这直接解锁了复杂的剧情互动——争吵、群像、谈判，这些才是戏剧张力的核心。</p>
<p>有了画面一致性和多人对白，Seko 2.0敢于喊出支持<strong>100集以内</strong>剧本连续创作的底气就在这里。它不再是生成零碎素材的工具，而是可以直接产出成片的流水线。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-15_23.12.31-1024x475.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-15_23.12.31-1024x475.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98aca7f549b94317a21d749c77d6ecdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766416899&amp;x-signature=8W9ufzhtuJ%2B1wSKKrL2ptaweQ2g%3D" alt="iShot_2025-12-15_23.12.31" loading="lazy"/></a></p>
<h3 data-id="heading-2">拿结果说话：不仅仅是Demo</h3>
<p>很多技术发布会喜欢放精修的Demo，但Seko 2.0直接甩出了成绩单。</p>
<p>自今年7月上线以来，不到半年时间，Seko已经聚集了超过20万创作者。更有意思的是数据画像：这里面一半是短剧和漫剧的创作者。</p>
<p>最硬核的案例是真人短剧《婉心计》。这部由Seko生成的作品，实打实地登顶了抖音AI短剧榜的第一名。这说明它的产出质量已经不仅仅是“能看”，而是能经受住大众市场挑剔目光的考验，甚至具备了商业变现的能力。</p>
<p>商汤甚至已经和长江电影集团达成了战略合作，准备把这套技术用到院线电影的孵化里。当国家队开始入局，你就知道这不仅仅是极客们的玩具了。</p>
<h3 data-id="heading-3">降本增效的极致</h3>
<p>对于个人创作者和小工作室来说，Seko 2.0最诱人的还是成本控制。</p>
<p>传统搞漫剧，周期长、人力贵。Seko 2.0把制作周期缩短了80%到90%。这意味着别人还在画分镜的时候，你的全集可能已经上线了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasdasc-1024x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asdasc-1024x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ece07d309c4c8db8c4458f47e67850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766416899&amp;x-signature=P5XTtQ2FA0lvplLG3X3DdibCXkU%3D" alt="asdasc" loading="lazy"/></a></p>
<p>为了支撑这种高强度的生成，商汤开源了底层的推理框架<strong>LightX2V</strong>。在消费级显卡上，它能做到“生成5秒视频耗时小于5秒”。这种准实时的速度，让创作过程变得像剪辑一样流畅，不再需要为了渲染一个镜头去喝杯咖啡等待。而且，它还适配了寒武纪、沐曦等国产芯片，在硬件选择上给了国内创作者更多余地。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>Seko 2.0的出现，标志着AI视频生成正在从“猎奇”走向“工业化”。</p>
<p>它不仅降低了门槛，更重要的是提高了天花板。当技术不再是阻碍，当一个人就能通过Seko 2.0掌控剧本、分镜、表演、配音全流程时，我们有理由相信，下一个短剧爆款，或许就诞生在你的笔记本电脑里。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fcascasvsd.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/cascasvsd.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a14e3647c1b47878560ccfa0f26ae30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766416899&amp;x-signature=LrqqKD75NRI9pLWf4ud%2FFqrNxHw%3D" alt="cascasvsd" loading="lazy"/></a></p>
<p>如果你手里正压着几个好故事苦于没钱拍摄，现在，可能是动手最好的时候。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PTQ 量化数值范围与优化]]></title>    <link>https://juejin.cn/post/7583933107689177151</link>    <guid>https://juejin.cn/post/7583933107689177151</guid>    <pubDate>2025-12-15T14:26:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583933107689177151" data-draft-id="7583910637958397971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PTQ 量化数值范围与优化"/> <meta itemprop="keywords" content="算法,自动驾驶"/> <meta itemprop="datePublished" content="2025-12-15T14:26:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PTQ 量化数值范围与优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T14:26:03.000Z" title="Mon Dec 15 2025 14:26:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、PTQ 模型量化问题</h2>
<h3 data-id="heading-1">1.1、模型问题</h3>
<p>基于公版模型训练，没有对模型做范围做约束，weight_decay=1e-6， 训练出的 float 模型数值分布很大，如图 2，可以看到模型的后面几层数据分布范围很广，最大阈值超过了 8000，对我们量化来说并不友好。</p>
<h3 data-id="heading-2">1.2、算子问题</h3>
<p>如图 2，基于全 int16 算子配置量化，当前版本 resize 算子有约束（请查阅工具链算子支持情况），只能支持 int8 量化，即使配置了 int16，但算子依旧退化到 int8，因此算子的 cosine 相似度也比较低，基于此阈值，max_qscale=6653/127=52.385，此 scale 过于大，并不能精细化量化模型，所以全 BPU 算子的整体精度都不高。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YjBmY2QxMjhmZTU2OTk3MzExMWY5YTEwMjE2OWNlY2Rfb3hqdExDUzBmWWdZRGZidnJ3b0xTeHdVWjBQQnZTcENfVG9rZW46QWsySmIwNzVBb0xXQVJ4NnR6WmNNSkJVblh0XzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 1 公版训练 float 模型</p>
<h2 data-id="heading-3">二、精度优化</h2>
<h3 data-id="heading-4">2.1、cpu 高精度定位</h3>
<p>resize 算子有限制，但对于回退 cpu 算子，就能实现 float 精度推理，配置如图 2，</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDdmYTFkZTEyYjdlZGQyY2VhMjMyNTkyYjU3MmU5ZTdfaUk1ZDZoNERURGFsU2FSMVFZTmR0Y3NNRkxENktOTzZfVG9rZW46Ulc0amJjb3Exb0JjRGV4dTdoS2MxRFlpbjhkXzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 2 配置 cpu 算子</p>
<p>配置了算子后，精度提升了，如图 3，可视化效果对比如图 4，整体量化精度可对齐，定位到了具体问题就是 resize 算子限制导致。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDEyZmZhYTVjODI5MmZiMDAzZDZhM2QwYTc4NTY0ZDRfYTNWTFJ4am5GY2k1RTlMakwxVjJlUElKb251Z3ZLR1NfVG9rZW46VjRabGJRWld3b0lmbmJ4QVBVSWNQZ3B3bmRiXzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 3 cpu 算子精度</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmU3MWI4YWZhYzU5MGI0MWQ5M2MzZjg1OGZhZGZkNmNfeVEwUk4xYXZwZml6aHJreW9uNmFyMHIxbVlvUWFCYVFfVG9rZW46QXpaSmJYNnlDb1dZemd4SXlyaWNiM0pvbmxmXzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 4 cpu 算子可视化精度</p>
<h3 data-id="heading-5">2.2、添加 bn，加大 weight_decay</h3>
<p>在最后的 conv 层后加上 bn 算子限制特征数据分布，同时 weight_decay 从 1e-6 调整到 1e-3，整体数据范围如图 5、图 6，模型的数据分布变小了，最后的 cosine 相似度精度也很高，非常利于 int8 量化，后期配置了 int8 量化，模型也可实现高精度量化。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDg3MjM4YWI0NGMzZDc0YTQ1YzFkMzYwODliYTY2ZGVfak9EcDV1QXlPbFdtVlpzT2dEUzNDOHgwYnF1NzRtRTVfVG9rZW46UUF1dWJuTTNjb2ZCOFh4YjdQMmNoRUt4bmhlXzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 5 全 int16 量化</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YTUxNTU5MDNjODNlMzg1MzE4MmY1MTAzYzM4NzA3MjVfS281QTdOUkF6eVBYMEJTdndiZlNhZVJzMmVSU1AyV3VfVG9rZW46RXd1dWJkRXBob0xKelB4MEdSb2NCaHlNbkFjXzE3NjU4MDgwMzE6MTc2NTgxMTYzMV9WNA" alt="" loading="lazy"/></p>
<p>图 6 部分 int16 量化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[十字路口的抉择：B端与C端C++开发者的职业路径全解析]]></title>    <link>https://juejin.cn/post/7583906870827991049</link>    <guid>https://juejin.cn/post/7583906870827991049</guid>    <pubDate>2025-12-15T14:57:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906870827991049" data-draft-id="7583910418658770990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="十字路口的抉择：B端与C端C++开发者的职业路径全解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-15T14:57:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            十字路口的抉择：B端与C端C++开发者的职业路径全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T14:57:23.000Z" title="Mon Dec 15 2025 14:57:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在C++开发者的职业道路上，一个经典的选择题横亘在前：是深入服务企业与系统的<strong>B端（Business）</strong> 领域，还是投身于创造直接用户价值的<strong>C端（Consumer）</strong> 世界？这不仅是一个技术栈的选择，更关乎截然不同的职业发展轨迹与思维模式的塑造。</p>
<h4 data-id="heading-0">一、根本分野：B端与C端开发的核心差异</h4>
<p>B端与C端开发的本质区别，源于其服务对象和价值核心的不同。</p>
<p><strong>B端开发的核心是“可靠地解决确定性问题”</strong>。它服务于企业、机构或特定业务流程，如金融交易系统、数据库引擎、工业控制软件或通信后台。其价值体现在<strong>稳定性、效率与业务整合能力</strong>上。一个成功的B端系统，往往像一台精密、沉默且永不停歇的引擎，在后台支撑着关键业务的运转。开发者关注的是吞吐量、响应延迟、数据一致性以及如何与庞大的遗留系统无缝集成。</p>
<p><strong>C端开发的核心是“愉悦地满足不确定的用户”</strong>。它直面最终消费者，典型产物是PC/主机游戏、桌面应用（如办公软件、创意工具）或多媒体软件。其价值直接由<strong>用户体验、市场吸引力和感官表现力</strong>决定。一个成功的C端产品，应像一部引人入胜的电影或一件得心应手的工具，能瞬间抓住用户，并在流畅、直观的交互中传递价值。开发者在此必须关注帧率、启动速度、界面响应、资源占用以及在千差万别的硬件环境下的稳定性。</p>
<p>简言之，B端追求<strong>系统的确定性</strong>，C端揣摩<strong>人性的感知度</strong>。这一定位差异，直接导致了技术栈、工作模式和成功标准的全方位分流。</p>



































<table><thead><tr><th align="left">对比维度</th><th align="left">B端（企业级）开发</th><th align="left">C端（消费者端）开发</th></tr></thead><tbody><tr><td align="left"><strong>核心价值</strong></td><td align="left">业务流程支撑，效率与稳定</td><td align="left">用户体验，感官愉悦与易用</td></tr><tr><td align="left"><strong>典型场景</strong></td><td align="left">交易系统、数据库、工业软件</td><td align="left">游戏、桌面工具、多媒体应用</td></tr><tr><td align="left"><strong>性能侧重</strong></td><td align="left">吞吐量、并发数、数据处理延迟</td><td align="left"><strong>帧率、操作响应延迟、加载时间</strong></td></tr><tr><td align="left"><strong>环境复杂性</strong></td><td align="left">受控的服务器/专用环境</td><td align="left">高度碎片化的终端用户设备</td></tr><tr><td align="left"><strong>质量核心</strong></td><td align="left"><strong>7x24小时无中断</strong>，数据100%准确</td><td align="left"><strong>交互流畅无卡顿</strong>，崩溃率极低</td></tr></tbody></table>
<h4 data-id="heading-1">二、深度挑战：难度的不同维度</h4>
<p>谈论“哪个难度更大”犹如比较“造桥梁”与“造赛车”。难度不在同一维度，挑战也迥然不同。</p>
<p><strong>B端开发的挑战在于“复杂系统的掌控”</strong>：</p>
<ol>
<li><strong>领域知识深度</strong>：需深刻理解金融、电信、工业等垂直行业的业务规则与合规要求，技术是手段而非目的。</li>
<li><strong>大规模系统复杂性</strong>：设计高并发、分布式架构，保障数据强一致性和系统高可用性，其复杂性与调试难度极高。</li>
<li><strong>维护与演进的长周期</strong>：面对动辄十年以上的遗留代码库，需具备卓越的架构重构和兼容性设计能力，技术债务管理是常态。</li>
</ol>
<p><strong>C端开发的挑战在于“用户感知的极限优化”</strong>：</p>
<ol>
<li><strong>极致的性能调优</strong>：必须在固定的1/60秒（16.6毫秒）内完成一帧画面的所有处理，对性能的压榨是持续且苛刻的。内存管理不当导致的瞬间卡顿都是不可接受的失败。</li>
<li><strong>碎片化环境的适配</strong>：需让同一份代码在从高端显卡到集成显卡、不同操作系统版本的海量设备上表现一致且流畅，调试场景呈指数级增长。</li>
<li><strong>跨学科协作与产品思维</strong>：需紧密配合美术、设计、策划等角色，将抽象的技术能力转化为直观的用户体验，沟通与协作本身即是巨大挑战。</li>
</ol>
<p><strong>结论</strong>：B端之难，难在<strong>系统的深度、复杂性与长期维护</strong>；C端之难，难在<strong>极致的性能、广泛的适配与对用户心理的把握</strong>。前者是马拉松，考验耐力和宏观规划；后者是百米跨栏，考验爆发力、精细度和即时调整。</p>
<h4 data-id="heading-2">三、转型指南：从B端迈向C端的务实路径</h4>
<p>对于一位资深的B端开发者而言，转型C端绝非从零开始，而是一场<strong>优势转化与思维升级</strong>的旅程。</p>
<p><strong>1. 思维重塑：从“正确性思维”到“体验思维”</strong>
这是最关键的一步。B端开发者习惯于为“功能正确性”和“逻辑完备性”设立明确的达标线。在C端，必须建立一条新的、更感性的“体验达标线”：这个动画是否跟手？这个加载等待是否让用户焦虑？这个界面布局在4K屏和笔记本小屏上是否都优雅？主动使用竞品，记录每一个让你感到“爽”或“烦躁”的细节，是训练此思维的最佳方式。</p>
<p><strong>2. 技术栈迁移：补强“端”侧核心能力</strong>
你的B端核心优势（架构、并发、内存管理）是宝贵资产，需要围绕C端需求进行定向补强：</p>
<ul>
<li><strong>图形基础</strong>：无需立即成为图形学专家，但必须理解<strong>渲染管线、着色器、纹理与顶点变换</strong>的基本概念。可通过“用OpenGL/Vulkan绘制一个带光照的3D场景”此类小项目快速入门。</li>
<li><strong>平台特性</strong>：选择一个主攻平台（如Windows或macOS），学习其原生API（如Win32、Cocoa）的基础，特别是窗口管理、消息循环和输入事件处理机制。</li>
<li><strong>现代C++实践</strong>：深入掌握<code>C++17/20</code>中的移动语义、智能指针、Lambda表达式，它们在现代C端框架和引擎中被广泛使用，是编写高效、安全资源管理代码的利器。</li>
</ul>
<p><strong>3. 选择赛道与项目实践</strong>
根据兴趣，选择一条路径进行6个月左右的沉浸式实践：</p>
<ul>
<li><strong>游戏/图形方向</strong>：深入<strong>Unreal Engine</strong>，理解游戏循环、实体组件系统、资源管道。目标：完成一个包含完整玩法循环的小型Demo。</li>
<li><strong>高性能桌面软件方向</strong>：精通<strong>Qt框架</strong>，掌握其信号槽机制、模型-视图架构及跨平台部署。目标：开发一个功能实用、性能出色的跨平台工具（如代码编辑器、媒体管理器）。</li>
<li><strong>系统/驱动方向</strong>：深入研究Windows内核或Linux驱动开发模型。目标：实现一个简单的文件系统过滤器驱动或硬件监控工具。</li>
</ul>
<p><strong>在此阶段，必须通过一个或多个完整的、可运行展示的项目来固化学习成果，这远比阅读大量理论更有价值。</strong></p>
<h4 data-id="heading-3">四、跨越鸿沟：正视转型中的真实难点</h4>
<p>转型的真正障碍，往往不在于新技术的学习，而在于一些隐性壁垒。</p>
<p><strong>1. 技术范式的转换之难</strong>
你精通的服务端并发模型，在客户端可能需转换为<strong>渲染线程、逻辑线程、IO线程</strong>的协同。你熟悉的数据库连接池优化经验，可转化为对<strong>纹理、网格等图形资源池</strong>的管理。关键在于识别出B端经验中可迁移的“元能力”（如资源生命周期管理、并发控制），并将其适配到C端的新语境中。</p>
<p><strong>2. 开发节奏与质量文化的冲击</strong>
B端通常有较长的需求冻结和测试周期，而C端（尤其是游戏和互联网产品）则处于<strong>快速迭代、A/B测试、数据驱动</strong>的敏捷节奏中。你需要适应“快速推出最小可行产品，根据用户反馈持续优化”的工作模式，将对“绝对正确”的执着，部分让位于对“用户喜欢”的追求。</p>
<p><strong>3. 评价体系的重新适应</strong>
在B端，你的工作价值由内部客户和系统稳定性指标衡量。在C端，价值将直接由<strong>应用商店评分、用户活跃数据、市场口碑</strong>等公开、残酷的指标来评判。这要求开发者具备更强的产品意识和主人翁精神。</p>
<h4 data-id="heading-4">结语</h4>
<p>从B端到C端的转型，是一次从“世界的构建者”到“体验的雕塑家”的身份转变。它要求你将深厚的系统功力，灌注到对每一帧画面、每一次点击响应的极致打磨之中。</p>
<p>这条道路充满挑战：你需要放下部分引以为傲的“控制感”，去拥抱用户感知的不确定性；需要将宏观的架构视野，聚焦于微观的性能热点。但回报也同样丰厚：你将能亲手打造直接触动数百万用户的产品，获得最即时的反馈，并在技术、艺术与人性交汇处，找到属于C++开发者全新的、激动人心的创造空间。</p>
<p>这并非简单的赛道转换，而是一场职业能力的战略性拓展。当你成功地将B端的严谨与C端的灵动融为一体时，你将成为一个更强大、更稀缺的开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++ 多线程开发：从零开始的完整指南]]></title>    <link>https://juejin.cn/post/7583913535271305226</link>    <guid>https://juejin.cn/post/7583913535271305226</guid>    <pubDate>2025-12-15T15:01:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583913535271305226" data-draft-id="7583912637470490675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++ 多线程开发：从零开始的完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-15T15:01:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++ 多线程开发：从零开始的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T15:01:03.000Z" title="Mon Dec 15 2025 15:01:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么需要多线程？</h2>
<p>在现代计算机体系结构中，多核处理器已成为标准配置。多线程编程允许我们充分利用这些计算资源，通过并行执行任务来提升程序性能。C++11之前，多线程编程依赖于平台特定的API（如POSIX pthreads、Windows线程API），C++11标准引入了<code>&lt;thread&gt;</code>等头文件，为多线程编程提供了统一、可移植的解决方案。</p>
<h2 data-id="heading-1">二、C++多线程基础</h2>
<h3 data-id="heading-2">2.1 第一个多线程程序</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-comment">// 线程函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">threadFunction</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"线程 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 开始执行"</span> &lt;&lt; std::endl;
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
    std::cout &lt;&lt; <span class="hljs-string">"线程 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 结束执行"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"主线程开始，创建3个子线程"</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 创建并启动线程</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(threadFunction, <span class="hljs-number">1</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(threadFunction, <span class="hljs-number">2</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t3</span><span class="hljs-params">(threadFunction, <span class="hljs-number">3</span>)</span></span>;
    
    <span class="hljs-comment">// 等待线程完成</span>
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    t3.<span class="hljs-built_in">join</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"所有线程执行完毕"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-3">2.2 线程管理的基本操作</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"工作线程ID: "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 获取硬件支持的并发线程数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n = std::thread::<span class="hljs-built_in">hardware_concurrency</span>();
    std::cout &lt;&lt; <span class="hljs-string">"硬件支持的最大并发线程数: "</span> &lt;&lt; n &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 创建线程</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(worker)</span></span>;
    
    <span class="hljs-comment">// 线程ID</span>
    std::cout &lt;&lt; <span class="hljs-string">"主线程ID: "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"子线程ID: "</span> &lt;&lt; t.<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 检查线程是否可join</span>
    <span class="hljs-keyword">if</span> (t.<span class="hljs-built_in">joinable</span>()) {
        t.<span class="hljs-built_in">join</span>();  <span class="hljs-comment">// 等待线程完成</span>
    }
    
    <span class="hljs-comment">// 分离线程（主线程不等待）</span>
    <span class="hljs-comment">// t.detach(); // 谨慎使用！</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-4">三、数据共享与同步</h2>
<h3 data-id="heading-5">3.1 竞态条件与数据竞争</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-comment">// 有数据竞争的错误示例</span>
<span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        counter++;  <span class="hljs-comment">// 非原子操作，存在数据竞争</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-comment">// 结果可能不是200000</span>
    std::cout &lt;&lt; <span class="hljs-string">"计数器值: "</span> &lt;&lt; counter &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-6">3.2 互斥锁（Mutex）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;
std::mutex mtx;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safeIncrement</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;  <span class="hljs-comment">// 自动加锁解锁</span>
        counter++;
        <span class="hljs-comment">// lock_guard离开作用域，自动释放锁</span>
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">tryLockExample</span><span class="hljs-params">()</span> </span>{
    std::timed_mutex timed_mtx;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
        <span class="hljs-comment">// 尝试获取锁，非阻塞</span>
        <span class="hljs-keyword">if</span> (timed_mtx.<span class="hljs-built_in">try_lock</span>()) {
            std::cout &lt;&lt; <span class="hljs-string">"线程 "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() 
                      &lt;&lt; <span class="hljs-string">" 获取到锁"</span> &lt;&lt; std::endl;
            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
            timed_mtx.<span class="hljs-built_in">unlock</span>();
            <span class="hljs-keyword">break</span>;
        } <span class="hljs-keyword">else</span> {
            std::cout &lt;&lt; <span class="hljs-string">"线程 "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() 
                      &lt;&lt; <span class="hljs-string">" 未能获取锁，等待重试"</span> &lt;&lt; std::endl;
            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">50</span>));
        }
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(safeIncrement)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(safeIncrement)</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"安全的计数器值: "</span> &lt;&lt; counter &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 尝试锁示例</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t3</span><span class="hljs-params">(tryLockExample)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t4</span><span class="hljs-params">(tryLockExample)</span></span>;
    
    t3.<span class="hljs-built_in">join</span>();
    t4.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-7">3.3 递归锁与锁保护</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::recursive_mutex rec_mtx;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">recursiveFunction</span><span class="hljs-params">(<span class="hljs-type">int</span> depth)</span> </span>{
    <span class="hljs-keyword">if</span> (depth &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    
    rec_mtx.<span class="hljs-built_in">lock</span>();
    std::cout &lt;&lt; <span class="hljs-string">"深度: "</span> &lt;&lt; depth &lt;&lt; <span class="hljs-string">", 线程ID: "</span> 
              &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 递归调用，使用递归锁避免死锁</span>
    <span class="hljs-built_in">recursiveFunction</span>(depth - <span class="hljs-number">1</span>);
    
    rec_mtx.<span class="hljs-built_in">unlock</span>();
}

<span class="hljs-comment">// 使用unique_lock提供更灵活的锁管理</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flexibleLockExample</span><span class="hljs-params">()</span> </span>{
    std::mutex mtx;
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx, std::defer_lock)</span></span>;
    
    <span class="hljs-comment">// 延迟锁定</span>
    std::cout &lt;&lt; <span class="hljs-string">"准备获取锁..."</span> &lt;&lt; std::endl;
    lock.<span class="hljs-built_in">lock</span>();
    std::cout &lt;&lt; <span class="hljs-string">"获取到锁，执行临界区操作"</span> &lt;&lt; std::endl;
    lock.<span class="hljs-built_in">unlock</span>();
    
    <span class="hljs-comment">// 可以重新锁定</span>
    lock.<span class="hljs-built_in">lock</span>();
    std::cout &lt;&lt; <span class="hljs-string">"重新锁定"</span> &lt;&lt; std::endl;
    <span class="hljs-comment">// 自动解锁</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(recursiveFunction, <span class="hljs-number">3</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(flexibleLockExample)</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-8">3.4 条件变量</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>

std::mutex mtx;
std::condition_variable cv;
std::queue&lt;<span class="hljs-type">int</span>&gt; dataQueue;
<span class="hljs-type">bool</span> finished = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 生产者线程</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> items)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; items; ++i) {
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
        
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        dataQueue.<span class="hljs-built_in">push</span>(i);
        std::cout &lt;&lt; <span class="hljs-string">"生产: "</span> &lt;&lt; i &lt;&lt; std::endl;
        
        cv.<span class="hljs-built_in">notify_one</span>();  <span class="hljs-comment">// 通知一个等待的消费者</span>
    }
    
    {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        finished = <span class="hljs-literal">true</span>;
    }
    cv.<span class="hljs-built_in">notify_all</span>();  <span class="hljs-comment">// 通知所有消费者</span>
}

<span class="hljs-comment">// 消费者线程</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        
        <span class="hljs-comment">// 等待条件：队列不为空或生产结束</span>
        cv.<span class="hljs-built_in">wait</span>(lock, []{ 
            <span class="hljs-keyword">return</span> !dataQueue.<span class="hljs-built_in">empty</span>() || finished; 
        });
        
        <span class="hljs-keyword">if</span> (finished &amp;&amp; dataQueue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-keyword">if</span> (!dataQueue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-type">int</span> value = dataQueue.<span class="hljs-built_in">front</span>();
            dataQueue.<span class="hljs-built_in">pop</span>();
            lock.<span class="hljs-built_in">unlock</span>();  <span class="hljs-comment">// 提前解锁，减少锁持有时间</span>
            
            std::cout &lt;&lt; <span class="hljs-string">"消费者 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 消费: "</span> &lt;&lt; value &lt;&lt; std::endl;
        }
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"消费者 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 结束"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">prod</span><span class="hljs-params">(producer, <span class="hljs-number">10</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">cons1</span><span class="hljs-params">(consumer, <span class="hljs-number">1</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">cons2</span><span class="hljs-params">(consumer, <span class="hljs-number">2</span>)</span></span>;
    
    prod.<span class="hljs-built_in">join</span>();
    cons1.<span class="hljs-built_in">join</span>();
    cons2.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-9">四、原子操作</h2>
<h3 data-id="heading-10">4.1 原子类型</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">atomicCounter</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
<span class="hljs-function">std::atomic&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-title">ready</span><span class="hljs-params">(<span class="hljs-literal">false</span>)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">atomicIncrement</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 等待信号</span>
    <span class="hljs-keyword">while</span> (!ready.<span class="hljs-built_in">load</span>(std::memory_order_acquire)) {
        std::this_thread::<span class="hljs-built_in">yield</span>();  <span class="hljs-comment">// 让出CPU时间片</span>
    }
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        atomicCounter.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testAtomicOperations</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">value</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;
    
    <span class="hljs-comment">// 原子操作示例</span>
    <span class="hljs-type">int</span> expected = <span class="hljs-number">10</span>;
    <span class="hljs-type">bool</span> success = value.<span class="hljs-built_in">compare_exchange_strong</span>(expected, <span class="hljs-number">20</span>);
    std::cout &lt;&lt; <span class="hljs-string">"CAS操作: "</span> &lt;&lt; (success ? <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>) 
              &lt;&lt; <span class="hljs-string">", 当前值: "</span> &lt;&lt; value.<span class="hljs-built_in">load</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 原子标志测试</span>
    std::atomic_flag flag = ATOMIC_FLAG_INIT;
    
    <span class="hljs-comment">// 测试并设置</span>
    <span class="hljs-type">bool</span> was_set = flag.<span class="hljs-built_in">test_and_set</span>();
    std::cout &lt;&lt; <span class="hljs-string">"第一次test_and_set: "</span> &lt;&lt; was_set &lt;&lt; std::endl;
    
    flag.<span class="hljs-built_in">clear</span>();
    was_set = flag.<span class="hljs-built_in">test_and_set</span>();
    std::cout &lt;&lt; <span class="hljs-string">"清除后test_and_set: "</span> &lt;&lt; was_set &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> num_threads = <span class="hljs-number">4</span>;
    std::vector&lt;std::thread&gt; threads;
    
    <span class="hljs-comment">// 启动线程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num_threads; ++i) {
        threads.<span class="hljs-built_in">emplace_back</span>(atomicIncrement);
    }
    
    <span class="hljs-comment">// 让所有线程开始执行</span>
    ready.<span class="hljs-built_in">store</span>(<span class="hljs-literal">true</span>, std::memory_order_release);
    
    <span class="hljs-comment">// 等待所有线程完成</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; t : threads) {
        t.<span class="hljs-built_in">join</span>();
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"原子计数器最终值: "</span> &lt;&lt; atomicCounter.<span class="hljs-built_in">load</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 测试其他原子操作</span>
    <span class="hljs-built_in">testAtomicOperations</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-11">4.2 内存顺序</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">x</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>, <span class="hljs-title">y</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
<span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">z</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write_x_then_y</span><span class="hljs-params">()</span> </span>{
    x.<span class="hljs-built_in">store</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);  <span class="hljs-comment">// 1</span>
    y.<span class="hljs-built_in">store</span>(<span class="hljs-number">1</span>, std::memory_order_release);  <span class="hljs-comment">// 2</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">read_y_then_x</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (!y.<span class="hljs-built_in">load</span>(std::memory_order_acquire));  <span class="hljs-comment">// 3</span>
    <span class="hljs-keyword">if</span> (x.<span class="hljs-built_in">load</span>(std::memory_order_relaxed)) {      <span class="hljs-comment">// 4</span>
        z.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">memoryOrderDemo</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(write_x_then_y)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(read_y_then_x)</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-comment">// z应该为1</span>
    std::cout &lt;&lt; <span class="hljs-string">"z = "</span> &lt;&lt; z.<span class="hljs-built_in">load</span>() &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 多次运行观察结果</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {
        x = <span class="hljs-number">0</span>;
        y = <span class="hljs-number">0</span>;
        z = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">memoryOrderDemo</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-12">五、高级多线程模式</h2>
<h3 data-id="heading-13">5.1 线程池实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span> numThreads) : <span class="hljs-built_in">stop</span>(<span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; numThreads; ++i) {
            workers.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>] {
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                    std::function&lt;<span class="hljs-built_in">void</span>()&gt; task;
                    
                    {
                        std::unique_lock&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(queueMutex);
                        condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>] {
                            <span class="hljs-keyword">return</span> stop || !tasks.<span class="hljs-built_in">empty</span>();
                        });
                        
                        <span class="hljs-keyword">if</span> (stop &amp;&amp; tasks.<span class="hljs-built_in">empty</span>()) {
                            <span class="hljs-keyword">return</span>;
                        }
                        
                        task = std::<span class="hljs-built_in">move</span>(tasks.<span class="hljs-built_in">front</span>());
                        tasks.<span class="hljs-built_in">pop</span>();
                    }
                    
                    <span class="hljs-built_in">task</span>();
                }
            });
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span>... Args&gt;
    <span class="hljs-keyword">auto</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> 
        -&gt; std::future&lt;<span class="hljs-keyword">typename</span> std::result_of&lt;<span class="hljs-title">F</span><span class="hljs-params">(Args...)</span>&gt;::type&gt; </span>{
        
        <span class="hljs-keyword">using</span> return_type = <span class="hljs-keyword">typename</span> std::result_of&lt;<span class="hljs-built_in">F</span>(Args...)&gt;::type;
        
        <span class="hljs-keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;<span class="hljs-built_in">return_type</span>()&gt;&gt;(
            std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)
        );
        
        std::future&lt;return_type&gt; res = task-&gt;<span class="hljs-built_in">get_future</span>();
        
        {
            <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(queueMutex)</span></span>;
            
            <span class="hljs-keyword">if</span> (stop) {
                <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"线程池已停止"</span>);
            }
            
            tasks.<span class="hljs-built_in">emplace</span>([task]() { (*task)(); });
        }
        
        condition.<span class="hljs-built_in">notify_one</span>();
        <span class="hljs-keyword">return</span> res;
    }
    
    ~<span class="hljs-built_in">ThreadPool</span>() {
        {
            <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(queueMutex)</span></span>;
            stop = <span class="hljs-literal">true</span>;
        }
        
        condition.<span class="hljs-built_in">notify_all</span>();
        
        <span class="hljs-keyword">for</span> (std::thread&amp; worker : workers) {
            worker.<span class="hljs-built_in">join</span>();
        }
    }
    
<span class="hljs-keyword">private</span>:
    std::vector&lt;std::thread&gt; workers;
    std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks;
    
    std::mutex queueMutex;
    std::condition_variable condition;
    <span class="hljs-type">bool</span> stop;
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">ThreadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span>;
    std::vector&lt;std::future&lt;<span class="hljs-type">int</span>&gt;&gt; results;
    
    <span class="hljs-comment">// 提交任务到线程池</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; ++i) {
        results.<span class="hljs-built_in">emplace_back</span>(
            pool.<span class="hljs-built_in">enqueue</span>([i] {
                std::cout &lt;&lt; <span class="hljs-string">"任务 "</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">" 在线程 "</span> 
                          &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">" 执行"</span> &lt;&lt; std::endl;
                std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
                <span class="hljs-keyword">return</span> i * i;
            })
        );
    }
    
    <span class="hljs-comment">// 获取结果</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; result : results) {
        std::cout &lt;&lt; <span class="hljs-string">"结果: "</span> &lt;&lt; result.<span class="hljs-built_in">get</span>() &lt;&lt; std::endl;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-14">5.2 读写锁（C++14及以上）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;shared_mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeData</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">mutable</span> std::shared_mutex mutex_;
    <span class="hljs-type">int</span> data_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadSafeData</span>(<span class="hljs-type">int</span> init = <span class="hljs-number">0</span>) : <span class="hljs-built_in">data_</span>(init) {}
    
    <span class="hljs-comment">// 读取操作 - 共享锁</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-function">std::shared_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        std::cout &lt;&lt; <span class="hljs-string">"读取: "</span> &lt;&lt; data_ &lt;&lt; <span class="hljs-string">" 线程ID: "</span> 
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> data_;
    }
    
    <span class="hljs-comment">// 写入操作 - 独占锁</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> </span>{
        <span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        std::cout &lt;&lt; <span class="hljs-string">"写入: "</span> &lt;&lt; value &lt;&lt; <span class="hljs-string">" 线程ID: "</span> 
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
        data_ = value;
    }
    
    <span class="hljs-comment">// 增量操作</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::unique_lock&lt;std::shared_mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        ++data_;
        std::cout &lt;&lt; <span class="hljs-string">"增量到: "</span> &lt;&lt; data_ &lt;&lt; <span class="hljs-string">" 线程ID: "</span> 
                  &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; std::endl;
    }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">ThreadSafeData <span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
    std::vector&lt;std::thread&gt; threads;
    
    <span class="hljs-comment">// 创建5个读线程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
        threads.<span class="hljs-built_in">emplace_back</span>([&amp;data, i] {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; ++j) {
                data.<span class="hljs-built_in">read</span>();
                std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
            }
        });
    }
    
    <span class="hljs-comment">// 创建2个写线程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; ++i) {
        threads.<span class="hljs-built_in">emplace_back</span>([&amp;data, i] {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">2</span>; ++j) {
                data.<span class="hljs-built_in">write</span>(i * <span class="hljs-number">10</span> + j);
                std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">200</span>));
            }
        });
    }
    
    <span class="hljs-comment">// 创建1个增量线程</span>
    threads.<span class="hljs-built_in">emplace_back</span>([&amp;data] {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; ++i) {
            data.<span class="hljs-built_in">increment</span>();
            std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">150</span>));
        }
    });
    
    <span class="hljs-comment">// 等待所有线程完成</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; t : threads) {
        t.<span class="hljs-built_in">join</span>();
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"最终值: "</span> &lt;&lt; data.<span class="hljs-built_in">read</span>() &lt;&lt; std::endl;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-15">六、C++20新特性：协程和信号量</h2>
<h3 data-id="heading-16">6.1 信号量（C++20）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-comment">// 生产者-消费者模型使用信号量</span>
<span class="hljs-function">std::counting_semaphore&lt;10&gt; <span class="hljs-title">emptySlots</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;  <span class="hljs-comment">// 空槽位信号量</span>
<span class="hljs-function">std::counting_semaphore&lt;10&gt; <span class="hljs-title">fullSlots</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;    <span class="hljs-comment">// 满槽位信号量</span>
std::mutex bufferMutex;
std::queue&lt;<span class="hljs-type">int</span>&gt; buffer;
<span class="hljs-type">bool</span> done = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
        emptySlots.<span class="hljs-built_in">acquire</span>();  <span class="hljs-comment">// 等待空槽位</span>
        
        {
            <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(bufferMutex)</span></span>;
            buffer.<span class="hljs-built_in">push</span>(i);
            std::cout &lt;&lt; <span class="hljs-string">"生产者 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 生产: "</span> &lt;&lt; i &lt;&lt; std::endl;
        }
        
        fullSlots.<span class="hljs-built_in">release</span>();  <span class="hljs-comment">// 增加满槽位</span>
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">while</span> (!done || !buffer.<span class="hljs-built_in">empty</span>()) {
        fullSlots.<span class="hljs-built_in">acquire</span>();  <span class="hljs-comment">// 等待满槽位</span>
        
        <span class="hljs-keyword">if</span> (done &amp;&amp; buffer.<span class="hljs-built_in">empty</span>()) {
            fullSlots.<span class="hljs-built_in">release</span>();
            <span class="hljs-keyword">break</span>;
        }
        
        <span class="hljs-type">int</span> value;
        {
            <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(bufferMutex)</span></span>;
            <span class="hljs-keyword">if</span> (!buffer.<span class="hljs-built_in">empty</span>()) {
                value = buffer.<span class="hljs-built_in">front</span>();
                buffer.<span class="hljs-built_in">pop</span>();
                std::cout &lt;&lt; <span class="hljs-string">"消费者 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 消费: "</span> &lt;&lt; value &lt;&lt; std::endl;
            }
        }
        
        emptySlots.<span class="hljs-built_in">release</span>();  <span class="hljs-comment">// 增加空槽位</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> numProducers = <span class="hljs-number">3</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> numConsumers = <span class="hljs-number">2</span>;
    std::vector&lt;std::thread&gt; producers;
    std::vector&lt;std::thread&gt; consumers;
    
    <span class="hljs-comment">// 启动生产者</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numProducers; ++i) {
        producers.<span class="hljs-built_in">emplace_back</span>(producer, i);
    }
    
    <span class="hljs-comment">// 启动消费者</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numConsumers; ++i) {
        consumers.<span class="hljs-built_in">emplace_back</span>(consumer, i);
    }
    
    <span class="hljs-comment">// 等待生产者完成</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; p : producers) {
        p.<span class="hljs-built_in">join</span>();
    }
    
    <span class="hljs-comment">// 设置完成标志</span>
    done = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 释放所有信号量以唤醒等待的消费者</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numConsumers; ++i) {
        fullSlots.<span class="hljs-built_in">release</span>();
    }
    
    <span class="hljs-comment">// 等待消费者完成</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; c : consumers) {
        c.<span class="hljs-built_in">join</span>();
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"生产消费完成"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-17">七、最佳实践与性能考虑</h2>
<h3 data-id="heading-18">7.1 避免死锁的准则</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

<span class="hljs-comment">// 死锁示例</span>
std::mutex mtx1, mtx2;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deadlockThread1</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mtx1)</span></span>;
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mtx2)</span></span>;  <span class="hljs-comment">// 可能死锁</span>
    std::cout &lt;&lt; <span class="hljs-string">"线程1完成"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deadlockThread2</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mtx2)</span></span>;
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mtx1)</span></span>;  <span class="hljs-comment">// 可能死锁</span>
    std::cout &lt;&lt; <span class="hljs-string">"线程2完成"</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 避免死锁的方法1：按固定顺序加锁</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safeThread1</span><span class="hljs-params">()</span> </span>{
    std::<span class="hljs-built_in">lock</span>(mtx1, mtx2);  <span class="hljs-comment">// 同时锁定多个互斥量</span>
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mtx1, std::adopt_lock)</span></span>;
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mtx2, std::adopt_lock)</span></span>;
    std::cout &lt;&lt; <span class="hljs-string">"安全线程1完成"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safeThread2</span><span class="hljs-params">()</span> </span>{
    std::<span class="hljs-built_in">lock</span>(mtx1, mtx2);  <span class="hljs-comment">// 相同的锁定顺序</span>
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mtx1, std::adopt_lock)</span></span>;
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mtx2, std::adopt_lock)</span></span>;
    std::cout &lt;&lt; <span class="hljs-string">"安全线程2完成"</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 避免死锁的方法2：使用std::scoped_lock（C++17）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scopedLockExample</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::scoped_lock <span class="hljs-title">lock</span><span class="hljs-params">(mtx1, mtx2)</span></span>;  <span class="hljs-comment">// 自动管理多个锁</span>
    std::cout &lt;&lt; <span class="hljs-string">"使用scoped_lock安全加锁"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 可能产生死锁</span>
    <span class="hljs-comment">// std::thread t1(deadlockThread1);</span>
    <span class="hljs-comment">// std::thread t2(deadlockThread2);</span>
    <span class="hljs-comment">// t1.join();</span>
    <span class="hljs-comment">// t2.join();</span>
    
    <span class="hljs-comment">// 安全版本</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t3</span><span class="hljs-params">(safeThread1)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t4</span><span class="hljs-params">(safeThread2)</span></span>;
    t3.<span class="hljs-built_in">join</span>();
    t4.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-comment">// C++17 scoped_lock</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t5</span><span class="hljs-params">(scopedLockExample)</span></span>;
    t5.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-19">7.2 性能优化技巧</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-comment">// 伪共享问题示例</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BadAlignment</span> {
    <span class="hljs-type">int</span> a;  <span class="hljs-comment">// 可能和b在同一个缓存行</span>
    <span class="hljs-type">int</span> b;
};

<span class="hljs-comment">// 解决伪共享</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">alignas</span>(<span class="hljs-number">64</span>) GoodAlignment {  <span class="hljs-comment">// 64字节对齐，通常是缓存行大小</span>
    <span class="hljs-type">int</span> a;  <span class="hljs-comment">// 独占一个缓存行</span>
};
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">alignas</span>(<span class="hljs-number">64</span>) GoodAlignment2 {
    <span class="hljs-type">int</span> b;  <span class="hljs-comment">// 独占另一个缓存行</span>
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">falseSharingTest</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> iterations = <span class="hljs-number">100000000</span>;
    
    <span class="hljs-comment">// 伪共享情况</span>
    BadAlignment bad;
    <span class="hljs-keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
    
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([&amp;bad, iterations] {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; iterations; ++i) {
            bad.a++;
        }
    })</span></span>;
    
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([&amp;bad, iterations] {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; iterations; ++i) {
            bad.b++;
        }
    })</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
    <span class="hljs-keyword">auto</span> duration = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(end - start);
    std::cout &lt;&lt; <span class="hljs-string">"伪共享耗时: "</span> &lt;&lt; duration.<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">"ms"</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 避免伪共享</span>
    GoodAlignment good1;
    GoodAlignment2 good2;
    start = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
    
    <span class="hljs-function">std::thread <span class="hljs-title">t3</span><span class="hljs-params">([&amp;good1, iterations] {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; iterations; ++i) {
            good1.a++;
        }
    })</span></span>;
    
    <span class="hljs-function">std::thread <span class="hljs-title">t4</span><span class="hljs-params">([&amp;good2, iterations] {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; iterations; ++i) {
            good2.b++;
        }
    })</span></span>;
    
    t3.<span class="hljs-built_in">join</span>();
    t4.<span class="hljs-built_in">join</span>();
    
    end = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
    duration = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(end - start);
    std::cout &lt;&lt; <span class="hljs-string">"避免伪共享耗时: "</span> &lt;&lt; duration.<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">"ms"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">falseSharingTest</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-20">八、调试与测试</h2>
<h3 data-id="heading-21">8.1 线程安全的单元测试</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cassert&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;future&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeCounter</span> {
<span class="hljs-keyword">private</span>:
    std::mutex mtx;
    <span class="hljs-type">int</span> count;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadSafeCounter</span>() : <span class="hljs-built_in">count</span>(<span class="hljs-number">0</span>) {}
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        ++count;
    }
    
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        <span class="hljs-keyword">return</span> count;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testThreadSafety</span><span class="hljs-params">()</span> </span>{
    ThreadSafeCounter counter;
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> numThreads = <span class="hljs-number">10</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> incrementsPerThread = <span class="hljs-number">1000</span>;
    
    std::vector&lt;std::future&lt;<span class="hljs-type">void</span>&gt;&gt; futures;
    
    <span class="hljs-comment">// 启动多个线程同时增加计数器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numThreads; ++i) {
        futures.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">async</span>(std::launch::async, 
            [&amp;counter, incrementsPerThread] {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; incrementsPerThread; ++j) {
                    counter.<span class="hljs-built_in">increment</span>();
                }
            }
        ));
    }
    
    <span class="hljs-comment">// 等待所有线程完成</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; future : futures) {
        future.<span class="hljs-built_in">wait</span>();
    }
    
    <span class="hljs-comment">// 验证结果</span>
    <span class="hljs-type">int</span> expected = numThreads * incrementsPerThread;
    <span class="hljs-type">int</span> actual = counter.<span class="hljs-built_in">get</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"期望值: "</span> &lt;&lt; expected &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"实际值: "</span> &lt;&lt; actual &lt;&lt; std::endl;
    
    <span class="hljs-built_in">assert</span>(actual == expected);
    std::cout &lt;&lt; <span class="hljs-string">"测试通过！"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-built_in">testThreadSafety</span>();
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cerr &lt;&lt; <span class="hljs-string">"测试失败: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-22">九、总结与进阶学习</h2>
<h3 data-id="heading-23">9.1 关键点总结</h3>
<ol>
<li><strong>线程创建与管理</strong>：使用<code>std::thread</code>创建线程，理解join和detach的区别</li>
<li><strong>数据同步</strong>：掌握互斥锁、条件变量、原子操作的使用场景</li>
<li><strong>避免常见问题</strong>：识别和避免死锁、竞态条件、伪共享</li>
<li><strong>性能优化</strong>：合理选择同步机制，减少锁竞争</li>
<li><strong>现代C++特性</strong>：利用C++14/17/20的新特性简化多线程编程</li>
</ol>
<h3 data-id="heading-24">9.2 进阶学习方向</h3>
<ol>
<li><strong>并行算法</strong>：C++17的并行STL算法</li>
<li><strong>GPU编程</strong>：CUDA、OpenCL、SYCL</li>
<li><strong>分布式计算</strong>：MPI、gRPC、ZeroMQ</li>
<li><strong>异步编程模型</strong>：Promise/Future、反应式编程</li>
<li><strong>并发数据结构</strong>：无锁队列、并发哈希表</li>
</ol>
<h3 data-id="heading-25">9.3 推荐工具</h3>
<ol>
<li><strong>调试工具</strong>：ThreadSanitizer、Helgrind、Intel Inspector</li>
<li><strong>性能分析</strong>：Perf、VTune、AMD uProf</li>
<li><strong>可视化</strong>：Chrome Tracing、Vampir</li>
</ol>
<p>多线程编程是C++高级开发的核心技能之一。从基础同步机制到高级并发模式，需要不断实践和积累经验。记住：<strong>过早优化是万恶之源</strong>，在确保正确性的前提下进行性能优化，使用工具验证线程安全性，编写可维护的并发代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android launcher3实现简单的负一屏功能]]></title>    <link>https://juejin.cn/post/7583878719544377353</link>    <guid>https://juejin.cn/post/7583878719544377353</guid>    <pubDate>2025-12-15T15:02:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583878719544377353" data-draft-id="7583913535271288842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android launcher3实现简单的负一屏功能"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-15T15:02:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android小渣渣"/> <meta itemprop="url" content="https://juejin.cn/user/2119514151720222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android launcher3实现简单的负一屏功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2119514151720222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android小渣渣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T15:02:45.000Z" title="Mon Dec 15 2025 15:02:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android launcher3实现简单的负一屏功能</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8559939663654bdcae48140bba247bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOWwj-a4o-a4ow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766415764&amp;x-signature=u1P8%2FrGUbnaC%2FoGLjXkv6s0TYyU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">1.前言：</h2>
<p>之前实现过Android12Launcher3从抽屉修改成单层和Launcher3显示所有应用列表，今天来讲解一下如何实现一个简单的负一屏功能，直接看代码。</p>
<h2 data-id="heading-2">2.NegativeScreenAdapter：</h2>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.example.negativescreendemo.adapter;
​
<span class="hljs-keyword">import</span> android.content.<span class="hljs-type">Context</span>;
<span class="hljs-keyword">import</span> android.view.<span class="hljs-type">LayoutInflater</span>;
<span class="hljs-keyword">import</span> android.view.<span class="hljs-type">View</span>;
<span class="hljs-keyword">import</span> android.view.<span class="hljs-type">ViewGroup</span>;
<span class="hljs-keyword">import</span> android.widget.<span class="hljs-type">CheckBox</span>;
<span class="hljs-keyword">import</span> android.widget.<span class="hljs-type">ImageView</span>;
<span class="hljs-keyword">import</span> android.widget.<span class="hljs-type">TextView</span>;
​
<span class="hljs-keyword">import</span> androidx.annotation.<span class="hljs-type">NonNull</span>;
<span class="hljs-keyword">import</span> androidx.recyclerview.widget.<span class="hljs-type">GridLayoutManager</span>;
<span class="hljs-keyword">import</span> androidx.recyclerview.widget.<span class="hljs-type">RecyclerView</span>;
​
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">ActionItem</span>;
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">CardItem</span>;
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">NewsItem</span>;
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">R</span>;
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">ScheduleItem</span>;
<span class="hljs-keyword">import</span> com.example.negativescreendemo.<span class="hljs-type">TodoItem</span>;
​
<span class="hljs-keyword">import</span> java.util.<span class="hljs-type">List</span>;
​
<span class="hljs-comment">/**
 * @author: njb
 * @date: 2025/8/20 21:19
 * @desc: 描述
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NegativeScreenAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter&lt;RecyclerView</span>.<span class="hljs-title">ViewHolder&gt;</span></span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> context;
    <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">CardItem</span>&gt; cardItems;
    <span class="hljs-keyword">private</span> <span class="hljs-type">OnItemClickListener</span> listener;
​
    <span class="hljs-comment">// 卡片类型</span>
    public <span class="hljs-keyword">enum</span> <span class="hljs-type">CardType</span> {
        <span class="hljs-type">ACTIONS</span>, <span class="hljs-type">SCHEDULE</span>, <span class="hljs-type">NEWS</span>, <span class="hljs-type">TODO</span>
    }
​
    public <span class="hljs-type">NegativeScreenAdapter</span>(<span class="hljs-type">Context</span> context, <span class="hljs-type">List</span>&lt;<span class="hljs-type">CardItem</span>&gt; cardItems) {
        <span class="hljs-keyword">this</span>.context = context;
        <span class="hljs-keyword">this</span>.cardItems = cardItems;
    }
​
    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span> onCreateViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewGroup</span> parent, int viewType) {
        <span class="hljs-type">LayoutInflater</span> inflater = <span class="hljs-type">LayoutInflater</span>.from(context);
​
        switch (viewType) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">// 快捷功能卡片</span>
                <span class="hljs-type">View</span> actionView = inflater.inflate(<span class="hljs-type">R</span>.layout.item_action_card, parent, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ActionCardViewHolder</span>(actionView);
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// 日程卡片</span>
                <span class="hljs-type">View</span> scheduleView = inflater.inflate(<span class="hljs-type">R</span>.layout.item_schedule_card, parent, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ScheduleCardViewHolder</span>(scheduleView);
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// 新闻卡片</span>
                <span class="hljs-type">View</span> newsView = inflater.inflate(<span class="hljs-type">R</span>.layout.item_news_card, parent, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">NewsCardViewHolder</span>(newsView);
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// 待办事项卡片</span>
                <span class="hljs-type">View</span> todoView = inflater.inflate(<span class="hljs-type">R</span>.layout.item_todo_card, parent, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">TodoCardViewHolder</span>(todoView);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
​
    <span class="hljs-meta">@Override</span>
    public void onBindViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span> holder, int position) {
        <span class="hljs-type">CardItem</span> item = cardItems.get(position);
​
        <span class="hljs-keyword">if</span> (holder instanceof <span class="hljs-type">ActionCardViewHolder</span>) {
            ((<span class="hljs-type">ActionCardViewHolder</span>) holder).title.setText(item.getTitle());
            <span class="hljs-type">ActionAdapter</span> actionAdapter = <span class="hljs-keyword">new</span> <span class="hljs-type">ActionAdapter</span>(context, item.getActionItems());
            ((<span class="hljs-type">ActionCardViewHolder</span>) holder).recyclerView.setAdapter(actionAdapter);
            ((<span class="hljs-type">ActionCardViewHolder</span>) holder).recyclerView.setLayoutManager(
                    <span class="hljs-keyword">new</span> <span class="hljs-type">GridLayoutManager</span>(context, <span class="hljs-number">3</span>));
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (holder instanceof <span class="hljs-type">ScheduleCardViewHolder</span>) {
            ((<span class="hljs-type">ScheduleCardViewHolder</span>) holder).title.setText(item.getTitle());
            <span class="hljs-type">ScheduleAdapter</span> scheduleAdapter = <span class="hljs-keyword">new</span> <span class="hljs-type">ScheduleAdapter</span>(context, item.getScheduleItems());
            ((<span class="hljs-type">ScheduleCardViewHolder</span>) holder).recyclerView.setAdapter(scheduleAdapter);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (holder instanceof <span class="hljs-type">NewsCardViewHolder</span>) {
            ((<span class="hljs-type">NewsCardViewHolder</span>) holder).title.setText(item.getTitle());
            <span class="hljs-type">NewsAdapter</span> newsAdapter = <span class="hljs-keyword">new</span> <span class="hljs-type">NewsAdapter</span>(context, item.getNewsItems());
            ((<span class="hljs-type">NewsCardViewHolder</span>) holder).recyclerView.setAdapter(newsAdapter);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (holder instanceof <span class="hljs-type">TodoCardViewHolder</span>) {
            ((<span class="hljs-type">TodoCardViewHolder</span>) holder).title.setText(item.getTitle());
            <span class="hljs-type">TodoAdapter</span> todoAdapter = <span class="hljs-keyword">new</span> <span class="hljs-type">TodoAdapter</span>(context, item.getTodoItems());
            ((<span class="hljs-type">TodoCardViewHolder</span>) holder).recyclerView.setAdapter(todoAdapter);
        }
​
        <span class="hljs-comment">// 设置点击事件</span>
        holder.itemView.setOnClickListener(v -&gt; {
            <span class="hljs-keyword">if</span> (listener != <span class="hljs-literal">null</span>) {
                listener.onItemClick(position);
            }
        });
    }
​
    <span class="hljs-meta">@Override</span>
    public int getItemCount() {
        <span class="hljs-keyword">return</span> cardItems.size();
    }
​
    <span class="hljs-meta">@Override</span>
    public int getItemViewType(int position) {
        <span class="hljs-type">CardType</span> <span class="hljs-class"><span class="hljs-keyword">type</span> </span>= cardItems.get(position).getType();
        switch (<span class="hljs-class"><span class="hljs-keyword">type</span>) </span>{
            <span class="hljs-keyword">case</span> <span class="hljs-type">ACTIONS</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-type">SCHEDULE</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-type">NEWS</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-type">TODO</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
​
    <span class="hljs-comment">// 快捷功能卡片ViewHolder</span>
    public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActionCardViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
        <span class="hljs-type">TextView</span> title;
        <span class="hljs-type">RecyclerView</span> recyclerView;
​
        public <span class="hljs-type">ActionCardViewHolder</span>(<span class="hljs-type">View</span> itemView) {
            <span class="hljs-keyword">super</span>(itemView);
            title = itemView.findViewById(<span class="hljs-type">R</span>.id.card_title);
            recyclerView = itemView.findViewById(<span class="hljs-type">R</span>.id.action_recycler);
        }
    }
​
    <span class="hljs-comment">// 日程卡片ViewHolder</span>
    public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScheduleCardViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
        <span class="hljs-type">TextView</span> title;
        <span class="hljs-type">RecyclerView</span> recyclerView;
​
        public <span class="hljs-type">ScheduleCardViewHolder</span>(<span class="hljs-type">View</span> itemView) {
            <span class="hljs-keyword">super</span>(itemView);
            title = itemView.findViewById(<span class="hljs-type">R</span>.id.card_title);
            recyclerView = itemView.findViewById(<span class="hljs-type">R</span>.id.schedule_recycler);
        }
    }
​
    <span class="hljs-comment">// 新闻卡片ViewHolder</span>
    public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewsCardViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
        <span class="hljs-type">TextView</span> title;
        <span class="hljs-type">RecyclerView</span> recyclerView;
​
        public <span class="hljs-type">NewsCardViewHolder</span>(<span class="hljs-type">View</span> itemView) {
            <span class="hljs-keyword">super</span>(itemView);
            title = itemView.findViewById(<span class="hljs-type">R</span>.id.card_title);
            recyclerView = itemView.findViewById(<span class="hljs-type">R</span>.id.news_recycler);
        }
    }
​
    <span class="hljs-comment">// 待办事项卡片ViewHolder</span>
    public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TodoCardViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
        <span class="hljs-type">TextView</span> title;
        <span class="hljs-type">RecyclerView</span> recyclerView;
​
        public <span class="hljs-type">TodoCardViewHolder</span>(<span class="hljs-type">View</span> itemView) {
            <span class="hljs-keyword">super</span>(itemView);
            title = itemView.findViewById(<span class="hljs-type">R</span>.id.card_title);
            recyclerView = itemView.findViewById(<span class="hljs-type">R</span>.id.todo_recycler);
        }
    }
​
    <span class="hljs-comment">// 快捷功能子项适配器</span>
    public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActionAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter&lt;ActionAdapter</span>.<span class="hljs-title">ViewHolder&gt;</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> context;
        <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ActionItem</span>&gt; items;
​
        public <span class="hljs-type">ActionAdapter</span>(<span class="hljs-type">Context</span> context, <span class="hljs-type">List</span>&lt;<span class="hljs-type">ActionItem</span>&gt; items) {
            <span class="hljs-keyword">this</span>.context = context;
            <span class="hljs-keyword">this</span>.items = items;
        }
​
        <span class="hljs-meta">@NonNull</span>
        <span class="hljs-meta">@Override</span>
        public <span class="hljs-type">ViewHolder</span> onCreateViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewGroup</span> parent, int viewType) {
            <span class="hljs-type">View</span> view = <span class="hljs-type">LayoutInflater</span>.from(context)
                    .inflate(<span class="hljs-type">R</span>.layout.item_action, parent, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ViewHolder</span>(view);
        }
​
        <span class="hljs-meta">@Override</span>
        public void onBindViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewHolder</span> holder, int position) {
            <span class="hljs-type">ActionItem</span> item = items.get(position);
            holder.icon.setImageResource(item.getIconRes());
            holder.name.setText(item.getName());
        }
​
        <span class="hljs-meta">@Override</span>
        public int getItemCount() {
            <span class="hljs-keyword">return</span> items.size();
        }
​
        public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
            <span class="hljs-type">ImageView</span> icon;
            <span class="hljs-type">TextView</span> name;
​
            public <span class="hljs-type">ViewHolder</span>(<span class="hljs-type">View</span> itemView) {
                <span class="hljs-keyword">super</span>(itemView);
                icon = itemView.findViewById(<span class="hljs-type">R</span>.id.action_icon);
                name = itemView.findViewById(<span class="hljs-type">R</span>.id.action_name);
            }
        }
    }
​
    <span class="hljs-comment">// 日程子项适配器</span>
    public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ScheduleAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter&lt;ScheduleAdapter</span>.<span class="hljs-title">ViewHolder&gt;</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> context;
        <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">ScheduleItem</span>&gt; items;
​
        public <span class="hljs-type">ScheduleAdapter</span>(<span class="hljs-type">Context</span> context, <span class="hljs-type">List</span>&lt;<span class="hljs-type">ScheduleItem</span>&gt; items) {
            <span class="hljs-keyword">this</span>.context = context;
            <span class="hljs-keyword">this</span>.items = items;
        }
​
        <span class="hljs-meta">@NonNull</span>
        <span class="hljs-meta">@Override</span>
        public <span class="hljs-type">ViewHolder</span> onCreateViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewGroup</span> parent, int viewType) {
            <span class="hljs-type">View</span> view = <span class="hljs-type">LayoutInflater</span>.from(context)
                    .inflate(<span class="hljs-type">R</span>.layout.item_schedule, parent, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ViewHolder</span>(view);
        }
​
        <span class="hljs-meta">@Override</span>
        public void onBindViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewHolder</span> holder, int position) {
            <span class="hljs-type">ScheduleItem</span> item = items.get(position);
            holder.time.setText(item.getTime());
            holder.title.setText(item.getTitle());
            holder.location.setText(item.getLocation());
        }
​
        <span class="hljs-meta">@Override</span>
        public int getItemCount() {
            <span class="hljs-keyword">return</span> items.size();
        }
​
        public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
            <span class="hljs-type">TextView</span> time, title, location;
​
            public <span class="hljs-type">ViewHolder</span>(<span class="hljs-type">View</span> itemView) {
                <span class="hljs-keyword">super</span>(itemView);
                time = itemView.findViewById(<span class="hljs-type">R</span>.id.schedule_time);
                title = itemView.findViewById(<span class="hljs-type">R</span>.id.schedule_title);
                location = itemView.findViewById(<span class="hljs-type">R</span>.id.schedule_location);
            }
        }
    }
​
    <span class="hljs-comment">// 新闻子项适配器</span>
    public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewsAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter&lt;NewsAdapter</span>.<span class="hljs-title">ViewHolder&gt;</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> context;
        <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">NewsItem</span>&gt; items;
​
        public <span class="hljs-type">NewsAdapter</span>(<span class="hljs-type">Context</span> context, <span class="hljs-type">List</span>&lt;<span class="hljs-type">NewsItem</span>&gt; items) {
            <span class="hljs-keyword">this</span>.context = context;
            <span class="hljs-keyword">this</span>.items = items;
        }
​
        <span class="hljs-meta">@NonNull</span>
        <span class="hljs-meta">@Override</span>
        public <span class="hljs-type">ViewHolder</span> onCreateViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewGroup</span> parent, int viewType) {
            <span class="hljs-type">View</span> view = <span class="hljs-type">LayoutInflater</span>.from(context)
                    .inflate(<span class="hljs-type">R</span>.layout.item_news, parent, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ViewHolder</span>(view);
        }
​
        <span class="hljs-meta">@Override</span>
        public void onBindViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewHolder</span> holder, int position) {
            <span class="hljs-type">NewsItem</span> item = items.get(position);
            holder.title.setText(item.getTitle());
            holder.source.setText(item.getSource());
            holder.time.setText(item.getTime());
        }
​
        <span class="hljs-meta">@Override</span>
        public int getItemCount() {
            <span class="hljs-keyword">return</span> items.size();
        }
​
        public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
            <span class="hljs-type">TextView</span> title, source, time;
​
            public <span class="hljs-type">ViewHolder</span>(<span class="hljs-type">View</span> itemView) {
                <span class="hljs-keyword">super</span>(itemView);
                title = itemView.findViewById(<span class="hljs-type">R</span>.id.news_title);
                source = itemView.findViewById(<span class="hljs-type">R</span>.id.news_source);
                time = itemView.findViewById(<span class="hljs-type">R</span>.id.news_time);
            }
        }
    }
​
    <span class="hljs-comment">// 待办事项子项适配器</span>
    public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TodoAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter&lt;TodoAdapter</span>.<span class="hljs-title">ViewHolder&gt;</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-type">Context</span> context;
        <span class="hljs-keyword">private</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">TodoItem</span>&gt; items;
​
        public <span class="hljs-type">TodoAdapter</span>(<span class="hljs-type">Context</span> context, <span class="hljs-type">List</span>&lt;<span class="hljs-type">TodoItem</span>&gt; items) {
            <span class="hljs-keyword">this</span>.context = context;
            <span class="hljs-keyword">this</span>.items = items;
        }
​
        <span class="hljs-meta">@NonNull</span>
        <span class="hljs-meta">@Override</span>
        public <span class="hljs-type">ViewHolder</span> onCreateViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewGroup</span> parent, int viewType) {
            <span class="hljs-type">View</span> view = <span class="hljs-type">LayoutInflater</span>.from(context)
                    .inflate(<span class="hljs-type">R</span>.layout.item_todo, parent, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ViewHolder</span>(view);
        }
​
        <span class="hljs-meta">@Override</span>
        public void onBindViewHolder(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">ViewHolder</span> holder, int position) {
            <span class="hljs-type">TodoItem</span> item = items.get(position);
            holder.content.setText(item.getContent());
            holder.checkBox.setChecked(item.isCompleted());
​
            holder.checkBox.setOnCheckedChangeListener((buttonView, isChecked) -&gt;
                    item.setCompleted(isChecked));
        }
​
        <span class="hljs-meta">@Override</span>
        public int getItemCount() {
            <span class="hljs-keyword">return</span> items.size();
        }
​
        public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">ViewHolder</span> </span>{
            <span class="hljs-type">CheckBox</span> checkBox;
            <span class="hljs-type">TextView</span> content;
​
            public <span class="hljs-type">ViewHolder</span>(<span class="hljs-type">View</span> itemView) {
                <span class="hljs-keyword">super</span>(itemView);
                checkBox = itemView.findViewById(<span class="hljs-type">R</span>.id.todo_checkbox);
                content = itemView.findViewById(<span class="hljs-type">R</span>.id.todo_content);
            }
        }
    }
​
    <span class="hljs-comment">// 点击事件接口</span>
    public interface <span class="hljs-type">OnItemClickListener</span> {
        void onItemClick(int position);
    }
​
    public void setOnItemClickListener(<span class="hljs-type">OnItemClickListener</span> listener) {
        <span class="hljs-keyword">this</span>.listener = listener;
    }
}
</code></pre>
<h2 data-id="heading-3">3.ActionItem:</h2>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.negativescreendemo;
​
<span class="hljs-comment">/**
 * @author: njb
 * @date: 2025/8/20 21:28
 * @desc: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionItem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> iconRes;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ActionItem</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> iconRes)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.iconRes = iconRes;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> name;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getIconRes</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> iconRes;
    }
}
</code></pre>
<h2 data-id="heading-4">4.卡片CardItem：</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">negativescreendemo</span>;
​
<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">negativescreendemo</span>.<span class="hljs-property">adapter</span>.<span class="hljs-property">NegativeScreenAdapter</span>;
​
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;
​
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: njb
 * <span class="hljs-doctag">@date</span>: 2025/8/20 21:21
 * <span class="hljs-doctag">@desc</span>: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CardItem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">NegativeScreenAdapter</span>.<span class="hljs-property">CardType</span> <span class="hljs-keyword">type</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> title;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ActionItem</span>&gt; actionItems;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ScheduleItem</span>&gt; scheduleItems;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">NewsItem</span>&gt; newsItems;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">TodoItem</span>&gt; todoItems;
​
    <span class="hljs-comment">// 私有构造方法，防止直接实例化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CardItem</span>() {}
​
    <span class="hljs-comment">/**
     * 创建快捷操作卡片
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">CardItem</span> <span class="hljs-title function_">createActionCard</span>(<span class="hljs-params">NegativeScreenAdapter.CardType <span class="hljs-keyword">type</span>, <span class="hljs-built_in">String</span> title, List&lt;ActionItem&gt; actionItems</span>) {
        <span class="hljs-title class_">CardItem</span> item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CardItem</span>();
        item.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;
        item.<span class="hljs-property">title</span> = title;
        item.<span class="hljs-property">actionItems</span> = actionItems;
        <span class="hljs-keyword">return</span> item;
    }
​
    <span class="hljs-comment">/**
     * 创建日程卡片
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">CardItem</span> <span class="hljs-title function_">createScheduleCard</span>(<span class="hljs-params">NegativeScreenAdapter.CardType <span class="hljs-keyword">type</span>, <span class="hljs-built_in">String</span> title, List&lt;ScheduleItem&gt; scheduleItems</span>) {
        <span class="hljs-title class_">CardItem</span> item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CardItem</span>();
        item.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;
        item.<span class="hljs-property">title</span> = title;
        item.<span class="hljs-property">scheduleItems</span> = scheduleItems;
        <span class="hljs-keyword">return</span> item;
    }
​
    <span class="hljs-comment">/**
     * 创建新闻卡片
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">CardItem</span> <span class="hljs-title function_">createNewsCard</span>(<span class="hljs-params">NegativeScreenAdapter.CardType <span class="hljs-keyword">type</span>, <span class="hljs-built_in">String</span> title, List&lt;NewsItem&gt; newsItems</span>) {
        <span class="hljs-title class_">CardItem</span> item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CardItem</span>();
        item.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;
        item.<span class="hljs-property">title</span> = title;
        item.<span class="hljs-property">newsItems</span> = newsItems;
        <span class="hljs-keyword">return</span> item;
    }
​
    <span class="hljs-comment">/**
     * 创建待办事项卡片
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">CardItem</span> <span class="hljs-title function_">createTodoCard</span>(<span class="hljs-params">NegativeScreenAdapter.CardType <span class="hljs-keyword">type</span>, <span class="hljs-built_in">String</span> title, List&lt;TodoItem&gt; todoItems</span>) {
        <span class="hljs-title class_">CardItem</span> item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CardItem</span>();
        item.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;
        item.<span class="hljs-property">title</span> = title;
        item.<span class="hljs-property">todoItems</span> = todoItems;
        <span class="hljs-keyword">return</span> item;
    }
​
    <span class="hljs-comment">// Getters</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">NegativeScreenAdapter</span>.<span class="hljs-property">CardType</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">type</span>;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTitle</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> title;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ActionItem</span>&gt; <span class="hljs-title function_">getActionItems</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> actionItems;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ScheduleItem</span>&gt; <span class="hljs-title function_">getScheduleItems</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> scheduleItems;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">NewsItem</span>&gt; <span class="hljs-title function_">getNewsItems</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> newsItems;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">TodoItem</span>&gt; <span class="hljs-title function_">getTodoItems</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> todoItems;
    }
}
</code></pre>
<h2 data-id="heading-5">5.NewItem:</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">negativescreendemo</span>;
​
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: njb
 * <span class="hljs-doctag">@date</span>: 2025/8/20 21:28
 * <span class="hljs-doctag">@desc</span>: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsItem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> title;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> source;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> time;
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">NewsItem</span>(<span class="hljs-title class_">String</span> title, <span class="hljs-title class_">String</span> source, <span class="hljs-title class_">String</span> time) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">source</span> = source;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">time</span> = time;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTitle</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> title;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> source;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTime</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> time;
    }
}
</code></pre>
<h2 data-id="heading-6">6.ScheduleItem:</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">negativescreendemo</span>;
​
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: njb
 * <span class="hljs-doctag">@date</span>: 2025/8/20 21:28
 * <span class="hljs-doctag">@desc</span>: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleItem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> time;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> title;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> location;
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ScheduleItem</span>(<span class="hljs-title class_">String</span> time, <span class="hljs-title class_">String</span> title, <span class="hljs-title class_">String</span> location) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">time</span> = time;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">location</span> = location;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTime</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> time;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTitle</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> title;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getLocation</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> location;
    }
}
</code></pre>
<h2 data-id="heading-7">7.TodoItem：</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">negativescreendemo</span>;
​
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: njb
 * <span class="hljs-doctag">@date</span>: 2025/8/20 21:28
 * <span class="hljs-doctag">@desc</span>: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoItem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> content;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> isCompleted;
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-title class_">String</span> content, <span class="hljs-built_in">boolean</span> isCompleted) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = content;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isCompleted</span> = isCompleted;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getContent</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> content;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCompleted</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> isCompleted;
    }
​
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCompleted</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> completed</span>) {
        isCompleted = completed;
    }
}
</code></pre>
<h2 data-id="heading-8">8.主界面布局：</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;?xml <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;
&lt;androidx.core.widget.NestedScrollView xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">background</span>=<span class="hljs-string">"@color/gray_50"</span>
    tools:<span class="hljs-attr">context</span>=<span class="hljs-string">".NegativeScreenActivity"</span>&gt;
​
    &lt;LinearLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>&gt;
​
        &lt;!-- 顶部时间天气区域 --&gt;
        &lt;LinearLayout
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_margin</span>=<span class="hljs-string">"16dp"</span>
            android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>&gt;
​
            &lt;TextView
                android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/time_text"</span>
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"12:30"</span>
                android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/black"</span>
                android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"48sp"</span>
                android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;
​
            &lt;TextView
                android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/date_text"</span>
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"8dp"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"星期一, 六月 15日"</span>
                android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/gray_600"</span>
                android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"16sp"</span> /&gt;
​
            &lt;LinearLayout
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"12dp"</span>
                android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
                android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center"</span>
                android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
                &lt;ImageView
                    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/weather_icon"</span>
                    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"24dp"</span>
                    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"24dp"</span>
                    android:<span class="hljs-attr">src</span>=<span class="hljs-string">"@drawable/ic_scan"</span> /&gt;
​
                &lt;TextView
                    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/weather_text"</span>
                    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                    android:<span class="hljs-attr">layout_marginStart</span>=<span class="hljs-string">"8dp"</span>
                    android:<span class="hljs-attr">text</span>=<span class="hljs-string">"25°C 晴朗"</span>
                    android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/gray_600"</span>
                    android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"16sp"</span> /&gt;
            &lt;/LinearLayout&gt;
        &lt;/LinearLayout&gt;
​
        &lt;!-- 卡片列表 --&gt;
        &lt;androidx.recyclerview.widget.RecyclerView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/recycler_view"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">paddingHorizontal</span>=<span class="hljs-string">"16dp"</span>
            android:<span class="hljs-attr">clipToPadding</span>=<span class="hljs-string">"false"</span> /&gt;
    &lt;/LinearLayout&gt;
&lt;/androidx.core.widget.NestedScrollView&gt;
</code></pre>
<h2 data-id="heading-9">9.主界面测试代码：</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.negativescreendemo;
​
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.os.Handler;
<span class="hljs-keyword">import</span> android.os.Looper;
<span class="hljs-keyword">import</span> android.widget.ImageView;
<span class="hljs-keyword">import</span> android.widget.TextView;
<span class="hljs-keyword">import</span> android.widget.Toast;
​
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;
<span class="hljs-keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager;
<span class="hljs-keyword">import</span> androidx.recyclerview.widget.RecyclerView;
​
<span class="hljs-keyword">import</span> com.example.negativescreendemo.adapter.NegativeScreenAdapter;
​
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Locale;
<span class="hljs-keyword">import</span> java.util.Timer;
<span class="hljs-keyword">import</span> java.util.TimerTask;
​
<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: njb
 * <span class="hljs-doctag">@date</span>: 2025/8/20 21:18
 * <span class="hljs-doctag">@desc</span>: 描述
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NegativeScreenActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> RecyclerView recyclerView;
    <span class="hljs-keyword">private</span> NegativeScreenAdapter adapter;
    <span class="hljs-keyword">private</span> List&lt;CardItem&gt; cardItems;
    <span class="hljs-keyword">private</span> TextView timeTextView;
    <span class="hljs-keyword">private</span> TextView dateTextView;
    <span class="hljs-keyword">private</span> TextView weatherTextView;
    <span class="hljs-keyword">private</span> ImageView weatherIcon;
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_negative_screen);
​
        <span class="hljs-comment">// 初始化视图</span>
        initViews();
​
        <span class="hljs-comment">// 初始化数据</span>
        initData();
​
        <span class="hljs-comment">// 设置适配器</span>
        adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NegativeScreenAdapter</span>(<span class="hljs-built_in">this</span>, cardItems);
        recyclerView.setAdapter(adapter);
        recyclerView.setLayoutManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(<span class="hljs-built_in">this</span>));
​
        <span class="hljs-comment">// 设置点击事件</span>
        adapter.setOnItemClickListener(position -&gt; {
            <span class="hljs-type">CardItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> cardItems.get(position);
            Toast.makeText(NegativeScreenActivity.<span class="hljs-built_in">this</span>,
                    <span class="hljs-string">"点击了: "</span> + item.getTitle(), Toast.LENGTH_SHORT).show();
        });
​
        <span class="hljs-comment">// 更新时间</span>
        updateTime();
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initViews</span><span class="hljs-params">()</span> {
        recyclerView = findViewById(R.id.recycler_view);
        timeTextView = findViewById(R.id.time_text);
        dateTextView = findViewById(R.id.date_text);
        weatherTextView = findViewById(R.id.weather_text);
        weatherIcon = findViewById(R.id.weather_icon);
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟天气数据</span>
        weatherTextView.setText(<span class="hljs-string">"25°C 晴朗"</span>);
​
        <span class="hljs-comment">// 初始化卡片数据</span>
        cardItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
​
        <span class="hljs-comment">// 添加快捷功能卡片</span>
        List&lt;ActionItem&gt; actionItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"扫一扫"</span>, R.drawable.ic_scan));
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"付款"</span>, R.drawable.ic_pay));
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"乘车码"</span>, R.drawable.ic_bus));
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"健康码"</span>, R.drawable.ic_health));
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"充电宝"</span>, R.drawable.ic_power_bank));
        actionItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionItem</span>(<span class="hljs-string">"更多"</span>, R.drawable.ic_more));
        cardItems.add(CardItem.createActionCard(NegativeScreenAdapter.CardType.ACTIONS, <span class="hljs-string">"快捷功能"</span>, actionItems));
​
        <span class="hljs-comment">// 添加日程卡片</span>
        List&lt;ScheduleItem&gt; scheduleItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        scheduleItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduleItem</span>(<span class="hljs-string">"9:30"</span>, <span class="hljs-string">"团队周会"</span>, <span class="hljs-string">"会议室A"</span>));
        scheduleItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduleItem</span>(<span class="hljs-string">"14:00"</span>, <span class="hljs-string">"客户拜访"</span>, <span class="hljs-string">"XX公司"</span>));
        cardItems.add(CardItem.createScheduleCard(NegativeScreenAdapter.CardType.SCHEDULE, <span class="hljs-string">"今日日程"</span>, scheduleItems));
​
        <span class="hljs-comment">// 添加新闻卡片</span>
        List&lt;NewsItem&gt; newsItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        newsItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NewsItem</span>(<span class="hljs-string">"最新科技突破：人工智能新进展"</span>, <span class="hljs-string">"科技日报"</span>, <span class="hljs-string">"10分钟前"</span>));
        newsItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NewsItem</span>(<span class="hljs-string">"本地气温将持续升高，最高达35°C"</span>, <span class="hljs-string">"本地新闻"</span>, <span class="hljs-string">"30分钟前"</span>));
        cardItems.add(CardItem.createNewsCard(NegativeScreenAdapter.CardType.NEWS, <span class="hljs-string">"热点新闻"</span>, newsItems));
​
        <span class="hljs-comment">// 添加待办事项卡片</span>
        List&lt;TodoItem&gt; todoItems = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        todoItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-string">"完成项目报告"</span>, <span class="hljs-literal">false</span>));
        todoItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-string">"购买生日礼物"</span>, <span class="hljs-literal">true</span>));
        todoItems.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-string">"回复客户邮件"</span>, <span class="hljs-literal">false</span>));
        cardItems.add(CardItem.createTodoCard(NegativeScreenAdapter.CardType.TODO, <span class="hljs-string">"待办事项"</span>, todoItems));
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTime</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 更新时间和日期</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper());
        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>();
        timer.scheduleAtFixedRate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                handler.post(() -&gt; {
                    <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">timeFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"HH:mm"</span>, Locale.getDefault());
                    <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"EEEE, MMMM d日"</span>, Locale.getDefault());
                    <span class="hljs-type">String</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> timeFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
                    <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> dateFormat.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
​
                    timeTextView.setText(time);
                    dateTextView.setText(date);
                });
            }
        }, <span class="hljs-number">0</span>, <span class="hljs-number">60000</span>); <span class="hljs-comment">// 每分钟更新一次</span>
    }
}
</code></pre>
<h2 data-id="heading-10">10.实现效果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89f2096d3234150af20271efe97507e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOWwj-a4o-a4ow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766415764&amp;x-signature=XAlJWiODY8MiyMOcMr4L26hy9Bk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">11.总结：</h2>
<p>以<strong>分层架构 + 模块化设计</strong>为核心，通过 “数据模型封装 - UI 适配渲染 - 界面逻辑控制” 三层结构，快速搭建 Launcher3 负一屏功能，核心是利用<code>RecyclerView</code>嵌套实现 “卡片容器 + 子项列表” 的灵活布局，同时保证界面交互与数据展示的解耦。</p>
<h3 data-id="heading-12">关键技术点</h3>
<ul>
<li><strong>RecyclerView 多类型布局</strong>：通过<code>getItemViewType()</code>和不同<code>ViewHolder</code>，实现 4 类卡片的差异化展示，降低代码耦合。</li>
<li><strong>RecyclerView 嵌套</strong>：外层<code>RecyclerView</code>（卡片列表）嵌套内层<code>RecyclerView</code>（卡片子项），结合<code>GridLayoutManager</code>（快捷功能 3 列）和<code>LinearLayoutManager</code>（其他卡片单列），满足不同布局需求。</li>
<li><strong>线程安全的 UI 更新</strong>：用<code>Handler(Looper.getMainLooper())</code>将<code>Timer</code>的定时任务切换到主线程，避免子线程操作 UI 的异常。</li>
<li><strong>数据模型私有化构造</strong>：<code>CardItem</code>通过私有构造 + 静态创建方法，强制规范卡片创建流程，避免错误数据赋值。</li>
</ul>
<h2 data-id="heading-13">12.源码地址：</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fjackning_admin%2Fnegative-screen-demo" target="_blank" title="https://gitee.com/jackning_admin/negative-screen-demo" ref="nofollow noopener noreferrer">gitee.com/jackning_ad…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：JWT 集成指南]]></title>    <link>https://juejin.cn/post/7583878719544098825</link>    <guid>https://juejin.cn/post/7583878719544098825</guid>    <pubDate>2025-12-15T13:06:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583878719544098825" data-draft-id="7583912637470113843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：JWT 集成指南"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-12-15T13:06:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：JWT 集成指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:06:56.000Z" title="Mon Dec 15 2025 13:06:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：JWT 集成指南</h2>
<p>在企业级中后台系统开发中，身份认证与授权是核心安全能力。JWT（JSON Web Token）凭借其无状态、轻量化、跨平台的特性，成为分布式系统中身份校验的优选方案。GoWind Admin 作为企业级前后端一体中后台框架，已将 JWT 核心逻辑封装至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-authn" target="_blank" title="https://github.com/tx7do/kratos-authn" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a> 组件中，彻底简化了底层引擎初始化、策略加载、签名验证等重复开发工作。开发者只需遵循以下标准化步骤，即可快速完成 JWT 集成，无缝对接框架的 OPA 权限管控体系，构建安全可靠的身份认证链路。</p>
<h3 data-id="heading-1">一、前置准备</h3>
<p>在开始集成前，请确保完成以下基础准备工作，避免因环境或依赖问题导致集成受阻：</p>
<ul>
<li>已拉取最新版 GoWind Admin 项目（Gitee/GitHub 仓库地址见文末），并完成基础环境搭建（Go 1.21+、Kratos 2.6+、Wire 依赖注入工具）；</li>
<li>熟悉项目目录结构，重点了解 <code>app/admin/service/internal/data</code>（数据层，负责认证器创建）、<code>app/admin/service/internal/server</code>（服务层，负责中间件集成）、<code>app/admin/service/configs</code>（配置层）的核心作用；</li>
<li>确认 kratos-authn 组件已引入项目依赖（项目默认集成，若缺失可执行 <code>go get github.com/tx7do/kratos-authn</code> 安装）。</li>
</ul>
<h3 data-id="heading-2">二、详细集成步骤</h3>
<p>JWT 集成核心分为「创建认证器」「依赖注入容器」「中间件集成」「配置文件修改」四个步骤，全程遵循「配置化 + 依赖注入」设计理念，无需修改框架核心代码。</p>
<h4 data-id="heading-3">步骤 1：创建 JWT 认证器</h4>
<p>认证器是 JWT 逻辑的核心载体，负责基于配置初始化 JWT 引擎、处理签名与验签逻辑。在数据层创建认证器实例，通过配置动态适配认证类型。</p>
<p>创建/修改文件 <code>app/admin/service/internal/data/authenticator.go</code>，代码如下（含详细注释）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"errors"</span>

	<span class="hljs-string">"github.com/go-kratos/kratos/v2/log"</span>

	authnEngine <span class="hljs-string">"github.com/tx7do/kratos-authn/engine"</span>
	<span class="hljs-string">"github.com/tx7do/kratos-authn/engine/jwt"</span>
)

<span class="hljs-comment">// NewAuthenticator 创建认证器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAuthenticator</span><span class="hljs-params">(cfg *conf.Bootstrap)</span></span> authnEngine.Authenticator {
	<span class="hljs-keyword">if</span> cfg.Authn == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	<span class="hljs-keyword">switch</span> cfg.GetAuthn().GetType() {
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>

	<span class="hljs-keyword">case</span> <span class="hljs-string">"jwt"</span>:
		authenticator, err := jwt.NewAuthenticator(
			jwt.WithKey([]<span class="hljs-type">byte</span>(cfg.Authn.GetJwt().GetKey())),
			jwt.WithSigningMethod(cfg.Authn.GetJwt().GetMethod()),
		)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> authenticator

	<span class="hljs-keyword">case</span> <span class="hljs-string">"oidc"</span>:
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>

	<span class="hljs-keyword">case</span> <span class="hljs-string">"preshared_key"</span>:
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
}
</code></pre>
<blockquote>
<p>核心说明：通过 <code>jwt.WithXXX</code> 系列 Option 可扩展更多 JWT 配置，如 Token 过期时间（Expiry）、刷新 Token 策略（RefreshToken）、发行人（Issuer）等，只需在配置文件中添加对应字段，再通过 Option 传入即可。</p>
</blockquote>
<h4 data-id="heading-4">步骤 2：依赖注入容器（Wire 注册）</h4>
<p>GoWind Admin 采用 Wire 实现依赖注入，需将创建的 JWT 认证器注册到数据层的依赖集合中，确保框架在启动时能自动初始化并注入到需要的组件（如中间件）中。</p>
<p>修改文件 <code>app/admin/service/internal/data/init.go</code>，在 <code>ProviderSet</code> 中添加认证器注册：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/data/init.go</span>

<span class="hljs-comment">//go:build wireinject</span>
<span class="hljs-comment">// +build wireinject</span>

<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/google/wire"</span>

<span class="hljs-comment">// ProviderSet 数据层依赖注入集合</span>
<span class="hljs-comment">// 作用：统一管理数据层组件，供框架启动时自动注入</span>
<span class="hljs-keyword">var</span> ProviderSet = wire.NewSet(
    NewAuthenticator,        <span class="hljs-comment">// 注册 JWT 认证器（核心，必须添加）</span>
    NewUserRepo,             <span class="hljs-comment">// 示例：用户仓库（已有的其他依赖保留）</span>
    NewMenuRepo,             <span class="hljs-comment">// 示例：菜单仓库（已有的其他依赖保留）</span>
    <span class="hljs-comment">// ... 其他数据层组件（按需保留或添加）</span>
)
</code></pre>
<p>注册完成后，执行 <code>make ent</code> 命令，Wire 会自动生成依赖注入代码，确保认证器能被正确实例化并注入到后续的中间件中。</p>
<h4 data-id="heading-5">步骤 3：集成中间件至 REST 服务链路</h4>
<p>JWT 认证需要通过中间件嵌入到 REST 服务的请求链路中，实现对所有请求的身份校验。框架提供 <code>selector.Server</code> 支持白名单匹配，可指定无需认证的接口（如登录、注册接口）。</p>
<p>修改文件 <code>app/admin/service/internal/server/rest.go</code>，实现中间件创建与集成：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/server/rest.go</span>

<span class="hljs-keyword">package</span> server

<span class="hljs-comment">// NewMiddleware 创建中间件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newRestMiddleware</span><span class="hljs-params">(
	logger log.Logger,
	authenticator authnEngine.Authenticator,
	authorizer *data.Authorizer,
)</span></span> []middleware.Middleware {
	<span class="hljs-keyword">var</span> ms []middleware.Middleware
	ms = <span class="hljs-built_in">append</span>(ms, logging.Server(logger))

	ms = <span class="hljs-built_in">append</span>(ms, selector.Server(
		authn.Server(authenticator),
		auth.Server(),
		authz.Server(authorizer.Engine()),
	).Match(newRestWhiteListMatcher()).Build())

	<span class="hljs-keyword">return</span> ms
}

<span class="hljs-comment">// NewRESTServer new an HTTP server.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(
    cfg *conf.Bootstrap, logger log.Logger,
	authenticator authnEngine.Authenticator, authorizer *data.Authorizer,
)</span></span> {
    ...

	srv := rpc.CreateRestServer(cfg,
		newRestMiddleware(logger, authenticator, authorizer)...,
	)

    ...
}
</code></pre>
<p>补充说明：</p>
<ul>
<li>中间件执行顺序：日志中间件 → 认证中间件 → 权限中间件，确保日志能完整记录认证过程，认证通过后再进行权限校验；</li>
<li>白名单匹配器 <code>newRestWhiteListMatcher()</code>：框架默认已实现常见白名单接口（如 <code>/api/v1/login</code>、<code>/api/v1/health</code>），如需自定义，可在该方法中添加接口路径匹配规则；</li>
<li>认证失败处理：JWT 认证中间件会自动处理 Token 缺失、过期、签名不匹配等异常，返回标准化错误（如 401 Unauthorized），无需额外编码。</li>
</ul>
<h4 data-id="heading-6">步骤 4：修改配置文件，启用 JWT 认证</h4>
<p>最后通过配置文件指定认证类型为 JWT，并配置核心参数（签名方法、密钥等）。框架默认使用 <code>app/admin/service/configs/auth.yaml</code> 作为认证配置文件，直接修改该文件即可：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">authn:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"jwt"</span>                <span class="hljs-comment"># 认证类型：jwt/oidc/preshared_key，此处指定为 jwt</span>
  <span class="hljs-attr">jwt:</span>
    <span class="hljs-attr">method:</span> <span class="hljs-string">"HS256"</span>          <span class="hljs-comment"># 签名算法：支持对称算法（HS256/HS384/HS512）和非对称算法（RS256/RS384/RS512/ES256/ES384/ES512/Ed25519）</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">"your-strong-secret-key-32bytes"</span>  <span class="hljs-comment"># 签名/验签密钥：HS 系列对称算法需传入字符串密钥（建议 ≥32 字节，高复杂度）；RS 系列非对称算法需传入公钥/私钥路径</span>
    <span class="hljs-attr">expiry:</span> <span class="hljs-number">7200</span>             <span class="hljs-comment"># 可选：Token 过期时间（单位：秒），默认 7200 秒（2 小时）</span>
    <span class="hljs-attr">refresh_expiry:</span> <span class="hljs-number">86400</span>    <span class="hljs-comment"># 可选：刷新 Token 过期时间（单位：秒），默认 86400 秒（24 小时）</span>
</code></pre>
<blockquote>
<p>安全建议：生产环境中，密钥（key）严禁硬编码在配置文件中！建议通过环境变量（如 <code>JWT_SECRET_KEY</code>）或配置中心（如 Nacos、Apollo）注入；若使用非对称算法（如 RS256），需将公钥/私钥文件放在项目安全目录下，通过路径配置（如 <code>public_key_path: "./conf/cert/jwt_public.pem"</code>）引入。</p>
</blockquote>
<h3 data-id="heading-7">三、集成验证步骤</h3>
<p>完成上述配置后，启动项目并通过以下步骤验证 JWT 集成是否生效：</p>
<ol>
<li>启动 GoWind Admin 服务：执行 <code>make run</code> 或 <code>go run main.go</code> 或 <code>gow run</code>；</li>
<li>调用登录接口获取 JWT Token：向 <code>/api/v1/login</code> 发送 POST 请求，传入正确的用户名密码，响应体中会返回<code>access_token</code>（访问 Token）和 <code>refresh_token</code>（刷新 Token）；</li>
<li>携带 Token 访问受保护接口：在 HTTP 请求头中添加 <code>Authorization: Bearer {access_token}</code>，调用需要认证的接口（如 <code>/api/v1/user/info</code>），若返回 200 且数据正常，说明认证生效；</li>
<li>测试认证失败场景：不携带 Token 或携带无效 Token 访问受保护接口，应返回 <code>401 Unauthorized</code> 错误，说明中间件正常拦截。</li>
</ol>
<h3 data-id="heading-8">四、常见问题与解决方案</h3>
<h4 data-id="heading-9">1. 认证器创建失败（返回 nil）</h4>
<p><strong>可能原因：</strong></p>
<ol>
<li><code>auth.yaml</code> 配置文件缺失或 <code>authn</code> 节点未配置；</li>
<li>jwt 子节点缺失（如未配置 <code>method</code> 或 <code>key</code>）；</li>
<li>密钥格式错误（如 HS256 密钥长度不足）。</li>
</ol>
<p><strong>解决方案：</strong></p>
<p>检查 <code>auth.yaml</code> 配置完整性，确保 <code>authn.type</code> 为 <code>jwt</code> 且 <code>jwt</code> 节点参数正确；查看项目日志，根据错误提示定位配置问题。</p>
<h4 data-id="heading-10">2. Token 验证失败（401 错误）</h4>
<p><strong>可能原因：</strong></p>
<ol>
<li>Token 已过期；</li>
<li>签名密钥不匹配（客户端与服务端密钥不一致）；</li>
<li>签名方法不匹配（如客户端用 HS256 签名，服务端配置为 RS256）；</li>
<li>Token 被篡改。</li>
</ol>
<p><strong>解决方案：</strong></p>
<p>检查 Token 过期时间，重新获取有效 Token；确认客户端与服务端的密钥和签名方法完全一致；通过 JWT 解析工具（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjwt.io" target="_blank" title="https://jwt.io" ref="nofollow noopener noreferrer">jwt.io</a>）验证 Token 合法性。</p>
<h4 data-id="heading-11">3. 白名单接口仍需认证</h4>
<p><strong>可能原因：</strong></p>
<p>白名单匹配器 <code>newRestWhiteListMatcher()</code> 中未正确配置接口路径；接口路径匹配规则错误（如大小写不匹配、路径前缀缺失）。</p>
<p><strong>解决方案：</strong></p>
<p>修改 <code>newRestWhiteListMatcher()</code> 方法，添加正确的接口路径匹配规则，示例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// NewWhiteListMatcher 创建jwt白名单</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newRestWhiteListMatcher</span><span class="hljs-params">()</span></span> selector.MatchFunc {
	whiteList := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)
	whiteList[adminV1.OperationAuthenticationServiceLogin] = <span class="hljs-literal">true</span>
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, operation <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> {
		<span class="hljs-keyword">if</span> _, ok := whiteList[operation]; ok {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	}
}
</code></pre>
<h3 data-id="heading-12">五、核心项目仓库</h3>
<p>获取框架源码、封装组件及更多详细文档，可访问以下核心仓库：</p>
<ul>
<li>GoWind Admin（Gitee）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">gitee.com/tx7do/go-wi…</a>（国内镜像，访问更快）</li>
<li>GoWind Admin（GitHub）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">github.com/tx7do/go-wi…</a>（官方主仓库，同步更新）</li>
<li>Kratos-Authn（JWT/OIDC 封装组件）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-authn" target="_blank" title="https://github.com/tx7do/kratos-authn" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a>（JWT 核心逻辑封装，支持多种认证协议扩展）</li>
</ul>
<h3 data-id="heading-13">六、总结</h3>
<p>通过 GoWind Admin 封装的 <code>kratos-authn</code> 组件，开发者无需关注 JWT 底层实现细节，仅需 4 步即可完成集成，大幅提升开发效率。集成后，框架将自动处理 Token 的生成、校验、过期等逻辑，并无缝对接 OPA 权限管控体系，为中后台系统提供安全、可靠的身份认证能力。</p>
<p>后续可基于该集成方案，扩展更多高级特性，如：Token 刷新机制、多租户密钥隔离、Token 黑名单管理等，满足企业级系统的复杂安全需求。若在集成过程中有任何问题，可通过项目仓库的 Issues 提交反馈，或加入框架官方社区获取技术支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Markwon封装Markdown组件]]></title>    <link>https://juejin.cn/post/7583906478328725523</link>    <guid>https://juejin.cn/post/7583906478328725523</guid>    <pubDate>2025-12-15T13:16:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906478328725523" data-draft-id="7583912899389161515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Markwon封装Markdown组件"/> <meta itemprop="keywords" content="Android,AIGC,Markdown"/> <meta itemprop="datePublished" content="2025-12-15T13:16:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半山居士"/> <meta itemprop="url" content="https://juejin.cn/user/627178281904907"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Markwon封装Markdown组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/627178281904907/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半山居士
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:16:59.000Z" title="Mon Dec 15 2025 13:16:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、背景</h2>
<p>在生成式 AI 技术快速发展的当下，大模型驱动的智能应用正重塑人机交互方式。智能客服、知识问答系统、AI 助手等场景中，Markdown 凭借简洁高效的结构化表达能力，成为 AI 内容呈现的核心载体。
但在 Android 原生开发中，实现高性能的 Markdown 实时渲染仍面临挑战：既要保证流式增量输出的流畅性，又要支持灵活的自定义样式适配，这对渲染引擎的性能和可扩展性提出了更高要求。
Android 端成熟的 Markdown 渲染框架 Markwon（Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnoties%2FMarkwon%25EF%25BC%2589%25E5%259F%25BA%25E4%25BA%258E" target="_blank" title="https://github.com/noties/Markwon%EF%BC%89%E5%9F%BA%E4%BA%8E" ref="nofollow noopener noreferrer">github.com/noties/Mark…</a> CommonMark-Java 实现核心解析，其插件化架构具备天然的扩展能力。出于避免重复造轮子的考量，本文先剖析 CommonMark-Java 与 Markwon 的核心原理，再阐述如何基于 Markwon 扩展实现自定义渲染需求。</p>
<h2 data-id="heading-1">二、CommonMark-Java 框架</h2>
<p>CommonMark-Java 是符合 CommonMark 标准的轻量级 Markdown 解析库，核心能力是将 Markdown 文本转换为结构化 AST（抽象语法树），支持扩展协议但不提供渲染能力，适用于 Java/Kotlin 项目的基础解析需求。</p>
<h3 data-id="heading-2">1、Node节点</h3>
<p>Node 是 CommonMark-Java 的核心抽象类，代表 Markdown 解析后生成的 AST（抽象语法树，可理解为 Markdown 文档的结构化树形表示）节点，所有 Markdown 元素（如段落、标题、代码块等）均继承自该类。</p>
<p>代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">firstChild</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">lastChild</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(Visitor visitor)</span>;

    <span class="hljs-comment">// 省略get/set方法...</span>
}
</code></pre>
<p><strong>Node 类的核心特性：</strong></p>
<ul>
<li>表示 Markdown 文档结构中的一个元素；</li>
<li>采用双向链表结构（通过 prev、next 维护同级节点关系）；</li>
<li>同时维护父子关系（通过 parent、firstChild、lastChild）；</li>
<li>支持访问者模式遍历 AST；</li>
<li>仅 Block（块级）节点支持包含子节点，内联节点无父子层级。</li>
</ul>
<h4 data-id="heading-3">1.1、Block（块级节点）</h4>
<p>Block 是 Node 的子类，作为所有块级节点的父类，代表 Markdown 文档中的独立块级元素（如段落、标题、代码块等）。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Node</span> </span>{
    <span class="hljs-comment">// 所有块级节点共享的基础属性和方法</span>
}
</code></pre>
<p><strong>Block的核心特点：</strong></p>
<ul>
<li>块级语义：占据独立的垂直空间，前后默认换行；</li>
<li>容器特性：可包含其他块级或内联节点；</li>
<li>独立性：在文档流中形成独立的结构单元。</li>
</ul>
<p>在CommonMark-Java中，Block 的核心子类：</p>
<ul>
<li>Document：AST 根节点，无对应语法；</li>
<li>Heading：标题（#/##/...），包含 level 属性（1-6 级）；</li>
<li>Paragraph：段落，最基础的文本容器；</li>
<li>BlockQuote：引用块（&gt; 开头），可嵌套其他块级节点；</li>
<li>ListBlock：列表容器，子类为 OrderedList（有序）、BulletList（无序），子节点为 ListItem；</li>
<li>ListItem：列表项，可包含其他块级节点；</li>
<li>FencedCodeBlock：围栏代码块（```/~~~），包含 literal（代码内容）、info（语言标识）；</li>
<li>IndentedCodeBlock：缩进代码块（4 个空格 / 1 个制表符），包含 literal；</li>
<li>HtmlBlock：HTML 块，包含 literal（原始 HTML 内容）；</li>
<li>ThematicBreak：分割线（---/*** /___），无内容仅作视觉分割。</li>
</ul>
<h4 data-id="heading-4">1.2、Inline Nodes</h4>
<p>内联节点是 AST 的组成部分，用于表示行内级元素（如文本、加粗、链接等），依附于块级节点存在（如段落内的加粗文本），无父子层级。</p>
<p>核心内联节点：</p>
<ul>
<li>Text：普通文本，包含 literal 属性；</li>
<li>Emphasis：强调文本（斜体），包含 delimiter（* /_）；</li>
<li>StrongEmphasis：加粗文本，包含 delimiter（** /__）；</li>
<li>Link：链接，包含 destination（URL）、title（可选标题）；</li>
<li>Image：图片，包含 title 属性；</li>
<li>Code：行内代码，包含 literal；</li>
<li>HtmlInline：行内 HTML（如
），包含 literal；</li>
<li>SoftLineBreak：软换行（行尾 2 个空格 / 普通换行），渲染为空格 / 换行；</li>
<li>HardLineBreak：硬换行（行尾 \），渲染为强制换行。</li>
</ul>
<h4 data-id="heading-5">1.3、CustomNode</h4>
<p>用于扩展自定义节点，满足 CommonMark 标准外的个性化解析需求。</p>
<h4 data-id="heading-6">1.4、小结</h4>
<p>CommonMark-Java 生成的 AST 树形结构，与 Android 的 View Tree（视图树）高度相似：</p>
<ul>
<li>Block 节点 ≈ ViewGroup（可包含子节点）；</li>
<li>内联节点 ≈ View（无嵌套）。
理解这一对应关系，能大幅降低后续扩展开发的理解成本。</li>
</ul>
<h3 data-id="heading-7">2、解析流程</h3>
<p>CommonMark-Java 的核心解析入口是 Parser 类（基于 Builder 模式构建），核心逻辑是将 Markdown 文本拆分为 “块级解析” 和 “内联解析” 两步：</p>
<p>核心调度代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> Node <span class="hljs-title function_">parseReader</span><span class="hljs-params">(Reader input)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"input must not be null"</span>);
        }

        <span class="hljs-type">DocumentParser</span> <span class="hljs-variable">documentParser</span> <span class="hljs-operator">=</span> createDocumentParser();
        <span class="hljs-type">Node</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> documentParser.parse(input);
        <span class="hljs-keyword">return</span> postProcess(document);
    }

    <span class="hljs-keyword">private</span> DocumentParser <span class="hljs-title function_">createDocumentParser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DocumentParser</span>(blockParserFactories, inlineParserFactory, delimiterProcessors);
    }
</code></pre>
<p>最终解析逻辑由两个接口实现：</p>
<ul>
<li>BlockParser：负责块级节点的解析；</li>
<li>InlineParser：负责内联节点的解析。
两者协同生成完整的 AST。</li>
</ul>
<h2 data-id="heading-8">三、Markwon 框架</h2>
<p>Markwon 基于 CommonMark-Java 的解析能力，扩展了 Android 端的 Markdown 渲染能力，核心采用 “插件化架构 + Span 渲染” 设计，支持自定义渲染规则和样式。</p>
<h3 data-id="heading-9">1、工作流程</h3>
<p>Markwon 的渲染流程分为 6 个阶段，整体逻辑围绕 “解析 AST→预处理→渲染 Span→后处理→绑定到 TextView” 展开：</p>
<h4 data-id="heading-10">1.1、配置截断</h4>
<p>Markwon 的核心配置通过 MarkwonBuilderImpl 的 build 方法完成，核心是初始化解析器、主题、配置、Visitor、Span 工厂，并通过插件扩展能力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Markwon <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {

    <span class="hljs-keyword">if</span> (plugins.isEmpty()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"No plugins were added to this builder. Use #usePlugin "</span> +
                <span class="hljs-string">"method to add them"</span>);
    }

    <span class="hljs-comment">// please note that this method must not modify supplied collection</span>
    <span class="hljs-comment">// if nothing should be done -&gt; the same collection can be returned</span>
    <span class="hljs-keyword">final</span> List&lt;MarkwonPlugin&gt; plugins = preparePlugins(<span class="hljs-built_in">this</span>.plugins);

    <span class="hljs-keyword">final</span> Parser.<span class="hljs-type">Builder</span> <span class="hljs-variable">parserBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parser</span>.Builder();
    <span class="hljs-keyword">final</span> MarkwonTheme.<span class="hljs-type">Builder</span> <span class="hljs-variable">themeBuilder</span> <span class="hljs-operator">=</span> MarkwonTheme.builderWithDefaults(context);
    <span class="hljs-keyword">final</span> MarkwonConfiguration.<span class="hljs-type">Builder</span> <span class="hljs-variable">configurationBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonConfiguration</span>.Builder();
    <span class="hljs-keyword">final</span> MarkwonVisitor.<span class="hljs-type">Builder</span> <span class="hljs-variable">visitorBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonVisitorImpl</span>.BuilderImpl();
    <span class="hljs-keyword">final</span> MarkwonSpansFactory.<span class="hljs-type">Builder</span> <span class="hljs-variable">spanFactoryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonSpansFactoryImpl</span>.BuilderImpl();

    <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
        plugin.configureParser(parserBuilder);
        plugin.configureTheme(themeBuilder);
        plugin.configureConfiguration(configurationBuilder);
        plugin.configureVisitor(visitorBuilder);
        plugin.configureSpansFactory(spanFactoryBuilder);
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">MarkwonConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> configurationBuilder.build(
            themeBuilder.build(),
            spanFactoryBuilder.build());

    <span class="hljs-comment">// @since 4.1.1</span>
    <span class="hljs-comment">// @since 4.1.2 - do not reuse render-props (each render call should have own render-props)</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">MarkwonVisitorFactory</span> <span class="hljs-variable">visitorFactory</span> <span class="hljs-operator">=</span> MarkwonVisitorFactory.create(
            visitorBuilder,
            configuration);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonImpl</span>(
            bufferType,
            textSetter,
            parserBuilder.build(),
            visitorFactory,
            configuration,
            Collections.unmodifiableList(plugins),
            fallbackToRawInputWhenEmpty
    );
}
</code></pre>
<p>Markwon 默认通过 create/builder 方法初始化，并自动添加 CorePlugin 核心插件：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Markwon <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-keyword">return</span> builder(context)
                .usePlugin(CorePlugin.create())
                .build();
    }

    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Builder <span class="hljs-title function_">builder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonBuilderImpl</span>(context)
                <span class="hljs-comment">// @since 4.0.0 add CorePlugin</span>
                .usePlugin(CorePlugin.create());
    }
</code></pre>
<h4 data-id="heading-11">1.2、解析阶段</h4>
<p>将 Markdown 字符串转换为 AST（Node 对象），核心复用 CommonMark-Java 的 Parser 能力，且解析前会通过插件预处理文本：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Node <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String input)</span> {

    <span class="hljs-comment">// make sure that all plugins are called `processMarkdown` before parsing</span>
    <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
        input = plugin.processMarkdown(input);
    }

    <span class="hljs-keyword">return</span> parser.parse(input);
}
</code></pre>
<h4 data-id="heading-12">1.3、预处理阶段</h4>
<p>渲染前通过插件修改 AST、收集全局信息，核心调用插件的 beforeRender 方法：</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-meta">@NonNull</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Spanned <span class="hljs-title function_">render</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node)</span> {

        <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
            plugin.beforeRender(node);
        }
        
        ...
        
        <span class="hljs-keyword">return</span> spanned;
    }
</code></pre>
<p>插件可在此阶段执行：</p>
<ul>
<li>修改 AST 结构（添加 / 删除 / 替换节点）；</li>
<li>收集全局渲染信息（如统计代码块数量）；</li>
<li>准备渲染上下文数据（如图片加载缓存）。</li>
</ul>
<h4 data-id="heading-13">1.4、渲染阶段</h4>
<p>将 AST 转换为 Android 的 Spanned 文本（核心是 Span 渲染），核心逻辑是通过访问者模式遍历 AST，为每个节点生成对应 Span：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Spanned <span class="hljs-title function_">render</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node)</span> {
        ...
        <span class="hljs-comment">// @since 4.1.1 obtain visitor via factory</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">MarkwonVisitor</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> visitorFactory.create();
        node.accept(visitor);
        
        ...
        
        <span class="hljs-keyword">return</span> spanned;
    }
</code></pre>
<p>遍历核心逻辑（MarkwonVisitorImpl）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visit</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node)</span> {
    <span class="hljs-comment">// 获取节点对应的处理器</span>
    <span class="hljs-keyword">final</span> NodeVisitor&lt;Node&gt; nodeVisitor = (NodeVisitor&lt;Node&gt;) nodes.get(node.getClass());
    <span class="hljs-keyword">if</span> (nodeVisitor != <span class="hljs-literal">null</span>) {
        nodeVisitor.visit(<span class="hljs-built_in">this</span>, node); <span class="hljs-comment">// 生成对应Span</span>
    } <span class="hljs-keyword">else</span> {
        visitChildren(node); <span class="hljs-comment">// 递归遍历子节点</span>
    }
}
</code></pre>
<h4 data-id="heading-14">1.5、后处理阶段</h4>
<p>渲染完成后通过插件优化 Spanned 文本，核心调用插件的 afterRender 方法：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Spanned <span class="hljs-title function_">render</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node)</span> {
        ...
        <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
            plugin.afterRender(node, visitor);
        }
        <span class="hljs-comment">//noinspection UnnecessaryLocalVariable</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Spanned</span> <span class="hljs-variable">spanned</span> <span class="hljs-operator">=</span> visitor.builder().spannableStringBuilder();
        <span class="hljs-keyword">return</span> spanned;
    }
</code></pre>
<h4 data-id="heading-15">1.6、应用阶段</h4>
<p>将 Spanned 文本绑定到 TextView，核心是 setParsedMarkdown 方法，支持插件在绑定前后自定义逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMarkdown</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TextView textView, <span class="hljs-meta">@NonNull</span> String markdown)</span> {
    setParsedMarkdown(textView, toMarkdown(markdown));
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParsedMarkdown</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> TextView textView, <span class="hljs-meta">@NonNull</span> Spanned markdown)</span> {

    <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
        plugin.beforeSetText(textView, markdown);
    }
    <span class="hljs-comment">// @since 4.1.0</span>
    <span class="hljs-keyword">if</span> (textSetter != <span class="hljs-literal">null</span>) {
        textSetter.setText(textView, markdown, bufferType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// on-complete we just must call `afterSetText` on all plugins</span>
                <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
                    plugin.afterSetText(textView);
                }
            }
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// if no text-setter is specified -&gt; just a regular sync operation</span>
        textView.setText(markdown, bufferType);
        <span class="hljs-keyword">for</span> (MarkwonPlugin plugin : plugins) {
            plugin.afterSetText(textView);
        }
    }
}
</code></pre>
<h3 data-id="heading-16">2、Plugin机制（扩展核心）</h3>
<p>Plugin 是 Markwon 扩展性的核心，采用插件化架构设计，允许开发者自定义解析、渲染、绑定全流程的逻辑。</p>
<h4 data-id="heading-17">2.1、MarkwonPlugin接口定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MarkwonPlugin</span> {
    <span class="hljs-comment">// 全局配置阶段：注册扩展能力</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Registry registry)</span> {}
    
    <span class="hljs-comment">// 配置构建阶段：自定义全局配置</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureConfiguration</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonConfiguration.Builder builder)</span> {}
    
    <span class="hljs-comment">// 渲染器配置：自定义节点Visitor</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureVisitor</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonVisitor.Builder builder)</span> {}
    
    <span class="hljs-comment">// 渲染前：修改AST/收集信息</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeRender</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node)</span> {}
    
    <span class="hljs-comment">// 渲染后：优化Spanned文本</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterRender</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Node node, <span class="hljs-meta">@NonNull</span> MarkwonVisitor visitor)</span> {}
    
    <span class="hljs-comment">// Span工厂配置：自定义节点Span样式</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureSpansFactory</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonSpansFactory.Builder builder)</span> {}
    
    <span class="hljs-comment">// 文本绑定前：预处理TextView</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSetText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TextView textView, <span class="hljs-meta">@NonNull</span> Spanned markdown)</span> {}
    
    <span class="hljs-comment">// 文本绑定后：后置处理（如图片懒加载）</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterSetText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TextView textView)</span> {}
}
</code></pre>
<ul>
<li>配置阶段：configure() → configureConfiguration() → configureVisitor() → configureSpansFactory()</li>
<li>渲染阶段：beforeRender() → 核心渲染 → afterRender()</li>
<li>应用阶段：beforeSetText() → 设置文本 → afterSetText()</li>
</ul>
<h4 data-id="heading-18">2.2、CorePlugin（核心默认插件）</h4>
<p>CorePlugin 是 Markwon 的内置核心插件，其核心职责是为 CommonMark 标准的基础节点注册对应的 NodeVisitor 和 SpanFactory，覆盖所有核心块级 / 内联节点的默认渲染逻辑：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorePlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMarkwonPlugin</span> {

    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CorePlugin <span class="hljs-title function_">create</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorePlugin</span>();
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@return</span> a set with enabled by default block types
     * <span class="hljs-doctag">@since</span> 4.4.0
     */</span>
    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Block</span>&gt;&gt; enabledBlockTypes() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(
                BlockQuote.class,
                Heading.class,
                FencedCodeBlock.class,
                HtmlBlock.class,
                ThematicBreak.class,
                ListBlock.class,
                IndentedCodeBlock.class
        ));
    }

    <span class="hljs-comment">// @since 4.0.0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;OnTextAddedListener&gt; onTextAddedListeners = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// @since 4.5.0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hasExplicitMovementMethod;

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">CorePlugin</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@since</span> 4.5.0
     */</span>
    <span class="hljs-meta">@SuppressWarnings("UnusedReturnValue")</span>
    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-keyword">public</span> CorePlugin <span class="hljs-title function_">hasExplicitMovementMethod</span><span class="hljs-params">(<span class="hljs-type">boolean</span> hasExplicitMovementMethod)</span> {
        <span class="hljs-built_in">this</span>.hasExplicitMovementMethod = hasExplicitMovementMethod;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-comment">/**
     * Can be useful to post-process text added. For example for auto-linking capabilities.
     *
     * <span class="hljs-doctag">@see</span> OnTextAddedListener
     * <span class="hljs-doctag">@since</span> 4.0.0
     */</span>
    <span class="hljs-meta">@SuppressWarnings("UnusedReturnValue")</span>
    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-keyword">public</span> CorePlugin <span class="hljs-title function_">addOnTextAddedListener</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> OnTextAddedListener onTextAddedListener)</span> {
        onTextAddedListeners.add(onTextAddedListener);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureVisitor</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonVisitor.Builder builder)</span> {
        text(builder);
        strongEmphasis(builder);
        emphasis(builder);
        blockQuote(builder);
        code(builder);
        fencedCodeBlock(builder);
        indentedCodeBlock(builder);
        image(builder);
        bulletList(builder);
        orderedList(builder);
        listItem(builder);
        thematicBreak(builder);
        heading(builder);
        softLineBreak(builder);
        hardLineBreak(builder);
        paragraph(builder);
        link(builder);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureSpansFactory</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonSpansFactory.Builder builder)</span> {

        <span class="hljs-comment">// reuse this one for both code-blocks (indent &amp; fenced)</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">CodeBlockSpanFactory</span> <span class="hljs-variable">codeBlockSpanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeBlockSpanFactory</span>();

        builder
                .setFactory(StrongEmphasis.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrongEmphasisSpanFactory</span>())
                .setFactory(Emphasis.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmphasisSpanFactory</span>())
                .setFactory(BlockQuote.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockQuoteSpanFactory</span>())
                .setFactory(Code.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeSpanFactory</span>())
                .setFactory(FencedCodeBlock.class, codeBlockSpanFactory)
                .setFactory(IndentedCodeBlock.class, codeBlockSpanFactory)
                .setFactory(ListItem.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListItemSpanFactory</span>())
                .setFactory(Heading.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeadingSpanFactory</span>())
                .setFactory(Link.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkSpanFactory</span>())
                .setFactory(ThematicBreak.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThematicBreakSpanFactory</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSetText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TextView textView, <span class="hljs-meta">@NonNull</span> Spanned markdown)</span> {
        OrderedListItemSpan.measure(textView, markdown);

        <span class="hljs-comment">// @since 4.4.0</span>
        <span class="hljs-comment">// we do not break API compatibility, instead we introduce the `instance of` check</span>
        <span class="hljs-keyword">if</span> (markdown <span class="hljs-keyword">instanceof</span> Spannable) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Spannable</span> <span class="hljs-variable">spannable</span> <span class="hljs-operator">=</span> (Spannable) markdown;
            TextViewSpan.applyTo(spannable, textView);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterSetText</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TextView textView)</span> {
        <span class="hljs-comment">// let's ensure that there is a movement method applied</span>
        <span class="hljs-comment">// we do it `afterSetText` so any user-defined movement method won't be</span>
        <span class="hljs-comment">// replaced (it should be done in `beforeSetText` or manually on a TextView)</span>
        <span class="hljs-comment">// @since 4.5.0 we additionally check if we should apply _implicit_ movement method</span>
        <span class="hljs-keyword">if</span> (!hasExplicitMovementMethod &amp;&amp; textView.getMovementMethod() == <span class="hljs-literal">null</span>) {
            textView.setMovementMethod(LinkMovementMethod.getInstance());
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">text</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonVisitor.Builder builder)</span> {
        builder.on(Text.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkwonVisitor</span>.NodeVisitor&lt;Text&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visit</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonVisitor visitor, <span class="hljs-meta">@NonNull</span> Text text)</span> {

                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">literal</span> <span class="hljs-operator">=</span> text.getLiteral();

                visitor.builder().append(literal);

                <span class="hljs-comment">// @since 4.0.0</span>
                <span class="hljs-keyword">if</span> (!onTextAddedListeners.isEmpty()) {
                    <span class="hljs-comment">// calculate the start position</span>
                    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> visitor.length() - literal.length();
                    <span class="hljs-keyword">for</span> (OnTextAddedListener onTextAddedListener : onTextAddedListeners) {
                        onTextAddedListener.onTextAdded(visitor, literal, length);
                    }
                }
            }
        });
    }
    ....
}
</code></pre>
<p>CorePlugin 覆盖的核心节点包括：文本、粗体、斜体、引用块、行内代码、代码块、图片、列表、分割线、标题、换行、段落、链接等。</p>
<h2 data-id="heading-19">四、扩展Markwon（解决 Span 扩展性不足问题）</h2>
<h3 data-id="heading-20">1、当前Markwon存在的问题</h3>
<p>Markwon 核心库基于 TextView 的 Span 机制实现渲染，所有节点最终转换为 Span 展示。这种方式的核心痛点是<strong>UI 扩展性不足</strong>：</p>
<ul>
<li>Span 仅能实现静态样式（如颜色、字体），无法支持动态交互（如代码块添加复制按钮）；</li>
<li>复杂布局（如嵌套表格、自定义卡片）无法通过 Span 实现；</li>
<li>流式输出时的性能优化成本高。</li>
</ul>
<h3 data-id="heading-21">2、markwon-recycler 扩展库（分块渲染解决方案）</h3>
<p>Markwon 提供 markwon-recycler 扩展库，通过 RecyclerView 实现 Markdown 的分块渲染，解决 Span 扩展性不足的问题。其核心是 MarkwonAdapter（RecyclerView.Adapter 的抽象子类，默认实现为 MarkwonAdapterImpl），设计思路是：将 AST 按块级节点拆分，每个块级节点作为 RecyclerView 的一个条目独立渲染，支持自定义每个块的布局和交互。</p>
<h4 data-id="heading-22">2.1、 MarkwonAdapter 核心代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkwonAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;MarkwonAdapter.Holder&gt; {
    <span class="hljs-comment">// 构建方法：支持默认布局/自定义Entry</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Builder <span class="hljs-title function_">builderTextViewIsRoot</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> defaultEntryLayoutResId)</span> {
        <span class="hljs-keyword">return</span> builder(SimpleEntry.createTextViewIsRoot(defaultEntryLayoutResId));
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Builder <span class="hljs-title function_">builder</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> defaultEntryLayoutResId, <span class="hljs-meta">@IdRes</span> <span class="hljs-type">int</span> defaultEntryTextViewResId)</span> {
        <span class="hljs-keyword">return</span> builder(SimpleEntry.create(defaultEntryLayoutResId, defaultEntryTextViewResId));
    }

    <span class="hljs-comment">// 核心方法：绑定Markdown数据</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMarkdown</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Markwon markwon, <span class="hljs-meta">@NonNull</span> String markdown)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParsedMarkdown</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Markwon markwon, <span class="hljs-meta">@NonNull</span> Node document)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParsedMarkdown</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Markwon markwon, <span class="hljs-meta">@NonNull</span> List&lt;Node&gt; nodes)</span>;

    <span class="hljs-comment">// 条目渲染规则抽象类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span>&lt;N <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>, H <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Holder</span>&gt; {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> H <span class="hljs-title function_">createHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater, <span class="hljs-meta">@NonNull</span> ViewGroup parent)</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Markwon markwon, <span class="hljs-meta">@NonNull</span> H holder, <span class="hljs-meta">@NonNull</span> N node)</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {}
        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">id</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> N node)</span> { <span class="hljs-keyword">return</span> node.hashCode(); }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewRecycled</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> H holder)</span> {}
    }

    <span class="hljs-comment">// RecyclerView.ViewHolder基类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Holder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.ViewHolder {
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Holder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View itemView)</span> { <span class="hljs-built_in">super</span>(itemView); }
        <span class="hljs-comment">// 省略视图查找方法...</span>
    }

    <span class="hljs-comment">// 构建器接口</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Builder</span> {
        &lt;N <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt; Builder <span class="hljs-title function_">include</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Class&lt;N&gt; node, <span class="hljs-meta">@NonNull</span> Entry&lt;? <span class="hljs-built_in">super</span> N, ? extends Holder&gt; entry)</span>;
        Builder <span class="hljs-title function_">reducer</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MarkwonReducer reducer)</span>;
        MarkwonAdapter <span class="hljs-title function_">build</span><span class="hljs-params">()</span>;
    }
}
</code></pre>
<h4 data-id="heading-23">2.2、MarkwonAdapter 核心能力</h4>
<ul>
<li><strong>分块渲染</strong>：通过 MarkwonReducer 将 AST 根节点（Document）拆分为多个独立的块级节点，每个块作为 RecyclerView 的一个条目单独渲染；</li>
<li><strong>自定义渲染</strong>：为特定节点类型（如 FencedCodeBlock、TableBlock）注册自定义 Entry（渲染规则），实现差异化布局 / 交互；</li>
<li><strong>灵活构建</strong>：支持基于默认布局（TextView）或自定义 Entry 快速构建适配器，适配不同业务场景。</li>
</ul>
<h4 data-id="heading-24">2.3、Entry 抽象类（单块渲染规则）</h4>
<p>Entry 是 MarkwonAdapter 的核心，定义单个块级节点的渲染逻辑，需实现以下核心方法：</p>
<ul>
<li>createHolder ()：基于布局文件创建 ViewHolder，定义块级节点的 UI 布局；</li>
<li>bindHolder ()：将 Markdown 节点数据绑定到 ViewHolder，实现数据与 UI 的关联；</li>
<li>可选方法：clear ()（清理渲染缓存）、id ()（自定义条目 ID）、onViewRecycled ()（回收视图）。</li>
</ul>
<h3 data-id="heading-25">3、基于 Markwon 的扩展方案总结</h3>
<p>至此， 基于Markwon来封装Markdown渲染组件的整体方案就比较清晰了。</p>
<h4 data-id="heading-26">3.1、内联节点：复用 Span 渲染</h4>
<p>内联节点（如加粗、链接、行内代码等）无需注册 Entry—— 内联节点依附于块级节点存在（如段落、列表项内的加粗文本），继续通过 Span 在 TextView 中渲染，兼顾渲染效率和基础样式需求。</p>
<h4 data-id="heading-27">3.2、块级节点：自定义 Entry 渲染</h4>
<p>块级节点（如代码块、引用块、列表等）需为其注册自定义 Entry：</p>
<ul>
<li>为每个块级节点类型（如 FencedCodeBlock）实现 Entry，自定义布局（如代码块添加 “复制” 按钮）；</li>
<li>通过 MarkwonAdapter 的 include () 方法将 “节点类型 - Entry” 关联：</li>
</ul>
<p>实例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">MarkwonAdapter</span> <span class="hljs-variable">adapter</span> <span class="hljs-operator">=</span> MarkwonAdapter.builder(R.layout.item_default, R.id.tv_content)
        <span class="hljs-comment">// 为代码块注册自定义Entry</span>
        .include(FencedCodeBlock.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeBlockEntry</span>())
        <span class="hljs-comment">// 为引用块注册自定义Entry</span>
        .include(BlockQuote.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockQuoteEntry</span>())
        .build();
</code></pre>
<p>MarkwonAdapter中的include方法：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@NonNull</span>
        <span class="hljs-variable">@Override</span>
        public &lt;N extends Node&gt; Builder <span class="hljs-built_in">include</span>(
                <span class="hljs-variable">@NonNull</span> Class&lt;N&gt; node,
                <span class="hljs-variable">@NonNull</span> Entry&lt;? super N, ? extends Holder&gt; entry) {
            <span class="hljs-comment">//noinspection unchecked</span>
            <span class="hljs-selector-tag">entries</span><span class="hljs-selector-class">.append</span>(node.<span class="hljs-built_in">hashCode</span>(), (Entry&lt;Node, Holder&gt;) entry);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">this</span>;
        }
</code></pre>
<h4 data-id="heading-28">3.3、嵌套块级节点的处理</h4>
<p>块级节点存在嵌套场景（如引用块嵌套列表、列表嵌套列表），处理方式为递归渲染子节点：在父节点 Entry 的 bindHolder () 方法中，遍历父节点的子节点，复用 MarkwonAdapter 的 Entry 和 ViewHolder 逻辑，将子节点 View 嵌入父节点布局容器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 父节点Entry的bindHolder方法示例（以引用块为例）</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Markwon markwon, <span class="hljs-meta">@NonNull</span> Holder holder, <span class="hljs-meta">@NonNull</span> BlockQuote node)</span> {
    <span class="hljs-comment">// 获取父节点的布局容器</span>
    <span class="hljs-type">LinearLayout</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> holder.requireView(R.id.container_quote);
    container.removeAllViews();

    <span class="hljs-comment">// 遍历引用块的子节点（如列表、段落）</span>
    <span class="hljs-type">Node</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> node.getFirstChild();
    <span class="hljs-keyword">while</span> (child != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 获取子节点对应的ViewType</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">childViewType</span> <span class="hljs-operator">=</span> markwonAdapter.getNodeViewType(child.getClass());
        <span class="hljs-comment">// 创建子节点ViewHolder</span>
        MarkwonAdapter.<span class="hljs-type">Holder</span> <span class="hljs-variable">childHolder</span> <span class="hljs-operator">=</span> markwonAdapter.onCreateViewHolder(container, childViewType);
        
        <span class="hljs-keyword">if</span> (markwonAdapter <span class="hljs-keyword">instanceof</span> MarkwonAdapterImpl) {
            <span class="hljs-type">MarkwonAdapterImpl</span> <span class="hljs-variable">adapterImpl</span> <span class="hljs-operator">=</span> (MarkwonAdapterImpl) markwonAdapter;
            <span class="hljs-comment">// 获取子节点对应的Entry</span>
            MarkwonAdapter.Entry&lt;Node, MarkwonAdapter.Holder&gt; childEntry = adapterImpl.getEntry(childViewType);
            <span class="hljs-comment">// 绑定子节点数据</span>
            childEntry.bindHolder(markwon, childHolder, child);
            <span class="hljs-comment">// 将子节点View添加到父容器（实现嵌套）</span>
            container.addView(childHolder.itemView);
        }
        
        child = child.getNext();
    }
}
</code></pre>
<p>上述逻辑的核心是 “复用已有 Entry”，避免重复编写嵌套节点的渲染规则，保证扩展方案的一致性和可维护性。</p>
<h2 data-id="heading-29">五、总结</h2>
<p>本文主要是围绕Android 端Markdown渲染的高性能、高定制化的需求展开。介绍了CommonMark-Java 解析框架以及Markwon 基于 Span 的插件化渲染体系，同时讨论基于markwon-recycler 的分块渲染方案。</p>
<h3 data-id="heading-30">后续可推进的优化点</h3>
<h4 data-id="heading-31">Span复用</h4>
<p>内联节点仍依赖 Span 渲染，当前每次渲染都会为相同内容 / 样式的内联节点重复创建 Span 对象，存在内存与 GC 开销。优化方向：</p>
<ul>
<li>针对 Emphasis、StrongEmphasis、Code 等高频内联节点，构建 Span 缓存池，以 “节点类型 + 内容 + 主题样式” 为 key 复用 Span 实例；</li>
<li>结合 Android 的 Span 回收机制，在 RecyclerView 条目回收时释放非全局复用的 Span，平衡复用效率与内存占用。</li>
</ul>
<h4 data-id="heading-32">RecyclerView Diff 优化</h4>
<p>当前 MarkwonAdapter 默认以节点 hashCode 作为条目 ID，未实现 DiffUtil，流式输出时会全量刷新列表，性能损耗大。优化方向：</p>
<ul>
<li>基于 AST 节点的 “类型 + 内容哈希 + 层级位置” 实现 DiffUtil.Callback，精准识别节点的增、删、改、移操作；</li>
<li>仅刷新变更的 RecyclerView 条目，尤其适配 AI 流式输出 Markdown 的场景，提升增量渲染的流畅性；</li>
<li>优化条目 ID 生成逻辑（避免 hashCode 冲突），结合稳定 ID 机制进一步降低刷新损耗。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(5)---记忆分类]]></title>    <link>https://juejin.cn/post/7583910418658459694</link>    <guid>https://juejin.cn/post/7583910418658459694</guid>    <pubDate>2025-12-15T13:35:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583910418658459694" data-draft-id="7582955784569716787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(5)---记忆分类"/> <meta itemprop="keywords" content="算法,人工智能,深度学习"/> <meta itemprop="datePublished" content="2025-12-15T13:35:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(5)---记忆分类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:35:35.000Z" title="Mon Dec 15 2025 13:35:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读35分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(5)---记忆分类</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 记忆分类</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 业界分类</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 MemOS</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 MemOS分类解析</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 维度定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 核心关系解析</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 MemOS的具体实现</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 基本概念</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 记忆生成</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x04 MemOS 记忆生命周期管理</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.1 生命周期阶段简介</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.2 案例：在线教育助手的记忆生命周期</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.3 自己的理解</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.4 MemScheduler</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>大模型之所以“忘事”，根本在于我们对“无状态模型”里“上下文窗口”的误解。很多人把它当成一只大箩筐，认为装得越多越好；然而，事实上，上下文窗口更像一块容量有限的工作记忆。硬塞太多信息，只会同时带来如下麻烦：关键内容被噪声淹没，模型抓不住重点，上下文越长，费用和延迟也越高。</p>
<p>这不是模型偷懒，而是 Transformer 架构的先天特性。每一次调用都像重新开机：没有长期记忆，上下文一旦过长，注意力就被冗余信息扯散，于是出现遗忘、跑题、速度下降。</p>
<p>为了补上这块短板，人们在记忆上大动手脚。</p>
<p>虽然前文简略介绍了MemOS的记忆类型，但是并未深入，本文以官方文档为基础进行解读，目的是了解MemOS的记忆分类，以及其生命周期。</p>
<h3 data-id="heading-2">0x01 记忆分类</h3>
<h4 data-id="heading-3">1.1 业界分类</h4>
<p>为了更好的分析，我们先来看看业界如何对记忆进行分类。</p>
<p>在当前（截至 2025 年）主流的智能体（Agent）系统和记忆架构研究与实践中，存在多种分类方式，这些分类借鉴自认知科学，并被 AI Agent 架构不同程度地采纳。</p>
<h5 data-id="heading-4">1.1.1 整体图表</h5>
<p>先给出整体图表。</p>





















































<table><thead><tr><th>Memory 类型</th><th>特点</th><th>存储形式</th><th>典型用途</th></tr></thead><tbody><tr><td><strong>工作记忆（Working）</strong></td><td>任务级、临时、结构化</td><td>内存中的字典 / 对象</td><td>正在执行的工具调用参数、任务状态</td></tr><tr><td><strong>短期记忆（Short-term Memory）</strong></td><td>容量小、时效短、上下文相关</td><td>内存中的缓存 / 列表</td><td>当前对话、任务执行中的临时状态</td></tr><tr><td><strong>长期记忆（Long-term Memory）</strong></td><td>持久存储、可检索、结构化/非结构化</td><td>结构化数据库 / 向量库 / 知识库</td><td>用户历史、知识库、经验沉淀</td></tr><tr><td><strong>情景记忆（Episodic Memory）</strong></td><td>记录特定事件（时间+地点+内容）和对话轨迹</td><td>向量数据库 / 知识库</td><td>回忆“上次用户说...”</td></tr><tr><td><strong>语义记忆（Semantic Memory）</strong></td><td>抽象知识（事实、概念、规则），即从多次交互中提炼稳定事实</td><td>向量数据库 / 知识库</td><td>“巴黎是法国首都”</td></tr><tr><td><strong>程序性记忆（Procedural Memory）</strong></td><td>如何做某事（技能、流程）</td><td>结构化数据库 / 向量库</td><td>调用工具链、执行计划</td></tr><tr><td><strong>偏好/用户画像记忆/个性化记忆（Preference/User Profile Memory）</strong></td><td>用户兴趣、习惯、风格偏好</td><td>结构化数据库 / 向量库</td><td>个性化推荐、语气调整</td></tr></tbody></table>
<h5 data-id="heading-5">1.1.2 梳理</h5>
<p>以下分类属于笔者自己的理解，不一定正确，仅供大家参考。主要是 “感知 - 短期 - 长期” 三级时效分层体系，各层级功能与特性相对可以明确区分：</p>
<ul>
<li>感知记忆（环境感知记忆）：最瞬时的记忆形态，仅存储当下环境中的即时数据（如视觉、声音信息），无长期复用价值，仅在当前瞬间有效，需通过转化机制进入更高层级记忆才能长期保留。</li>
</ul>

<ul>
<li>
<p>短期记忆（对应 Agent 的 Session 级别数据管理），此处有两种非常类似的说法，可以混用。可能工作记忆更强调当前会话，短期记忆强调短期的对话记录。</p>
<ul>
<li>工作记忆（Working Memory）：用来处理当前会话与任务的上下文，包括当前目标、正在执行的子任务等。核心作用是保障上下文连续性与即时响应能力。容量有限，但读写频繁、延迟极低。有的方案中，工作记忆也包括最近几轮对话。</li>
<li>短期记忆：与特定会话或任务线程强绑定，即常见的 “历史对话记录”，是 LLM 推理 API 的核心基础参数，核心作用是维持单一会话内的交互连贯性。</li>
</ul>
</li>
<li>
<p>长期记忆：不依赖特定会话，可跨场景复用，包括两种分类方法：</p>
<ul>
<li>
<p>分类1（从用户角度出发）</p>
<ul>
<li>
<p>情景记忆（Episodic Memory）：负责存储用户和Agent的具体交互事件。记录过往事件与行动历程，区别于孤立事实，更侧重 “经历” 的完整留存，帮助 Agent 回忆任务执行的具体过程与场景；</p>
</li>
<li>
<p>陈述性记忆（Declarative Memory，“是什么），此处也有两种类似的说法：</p>
<ul>
<li>语义记忆（Semantic Memory”）：通过层级结构归纳用户长期信息。聚焦事实与概念的存储，如交互中积累的特定信息、概念间的关联关系，是实现个性化服务的关键（如记住用户的偏好事实）；</li>
<li>陈述性记忆：此分类和语义记忆很类似，属于将语义记忆扩大化。即， 陈述性记忆是关于事实和事件的知识 。它回答的是各种“是什么”的问题 — 无论是世界知识还是用户的具体信息。比如用户的姓名、喜欢的美食，曾遭遇过的事件等，都属于陈述性记忆 。</li>
</ul>
</li>
<li>
<p>程序性记忆（Procedural Memory，“怎么做”）：存储执行任务的规则、方法与流程，由模型权重、智能体代码、提示词策略等共同构成，相当于 Agent 的 “内在方法论”，指导其如何完成具体任务（类似人类骑自行车的技能记忆）。</p>
</li>
<li>
<p>个性化记忆：形成关于用户的持续画像。通过会话内容摘要等方式提取的用户画像信息，包括用户偏好、行为习惯、身份特征等，支撑长期交互中的个性化服务。</p>
</li>
</ul>
</li>
<li>
<p>分类2（从实际应用功能出发）：</p>
<ul>
<li>检索记忆：通过 RAG 技术对接外部知识库，核心价值是补充模型原生知识，同时减少内部知识冲突，提升信息获取的精准性与时效性。</li>
<li>通用记忆：通过预训练或后续微调沉淀的基础通用知识，构成 Agent 的核心认知底座，支撑各类基础任务的理解与执行。</li>
<li>规则记忆：以强化学习（RL）、提示词（Prompt）等方式固化的行为规范，用于约束 Agent 输出格式（如 JSON、CoT 链式推理）与行为边界，确保响应的一致性与合规性。</li>
<li>个性化记忆：通过会话内容摘要等方式提取的用户画像信息，包括用户偏好、行为习惯、身份特征等，支撑长期交互中的个性化服务。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">1.2 MemOS</h4>
<p>MemOS对记忆有两种分类：</p>
<p>第一种是分成三个子类：</p>
<ul>
<li>结构化记忆（明文记忆）：尝试基于图的分层知识 TreeTextMemory，是结构化、层次化和知识图谱。图与向量后端会连接 Neo4j 或 Qdrant 实现生产级向量/图搜索。适合常青技能和稳定的领域专业知识。</li>
<li>激活记忆：运行时的 KV 缓存和隐藏状态（高效率），使用 KVCacheMemory （最近或稳定的上下文）加速多轮对话，高效的运行时状态缓存。适合对话中的快速重用、多轮会话。</li>
<li>参数化记忆：嵌入模型中的长期知识和技能，用适配器/LoRA 实现动态技能注入。适合可搜索、可检查、演进知识。</li>
</ul>
<p>第二种也是三个子类：</p>
<ul>
<li><code>WorkingMemory</code>: 工作记忆，临时存储</li>
<li><code>LongTermMemory</code>: 长期记忆，持久存储</li>
<li><code>UserMemory</code>: 用户记忆，个性化存储</li>
</ul>
<h3 data-id="heading-7">0x02 MemOS分类解析</h3>
<p>MemOS 这是两套完全不同的分类维度 —— 前者按 “记忆的物理形态与生命周期” 划分，后者按 “记忆的存储归属与访问优先级” 划分。二者无直接包含关系，但存在明确的动态迁移逻辑，共同支撑 MemOS 对 Agent 记忆的精细化管理。</p>
<ul>
<li>「物理形态 + 生命周期」分类（第一套）：解决 “记忆如何高效存储、快速访问” 的工程问题，通过 “工作记忆→激活记忆→长期存储” 的层级设计，平衡内存占用与访问速度；</li>
<li>「存储归属 + 访问优先级」分类（第二套）：解决 “记忆如何精准管理、个性化调用” 的功能问题，通过 “WorkingMemory→LongTermMemory→UserMemory” 的模块划分，实现 “任务实时处理、通用知识沉淀、用户个性化适配” 的目标。</li>
</ul>
<h4 data-id="heading-8">2.1 维度定义</h4>
<p>先明确两套分类的核心定义（维度本质）。</p>
<h5 data-id="heading-9">2.1.1 按「物理形态 + 生命周期」划分</h5>
<p>参数记忆（Parameter Memory）/激活记忆（Activated Memory）/结构化记忆（明文记忆） 的分类聚焦 “记忆在系统中的存在形式、存活时长”，是从工程实现角度对记忆数据的拆解，核心服务于 “资源优化”（如内存占用、计算效率），偏 “技术实现维度”：</p>

































<table><thead><tr><th>记忆类型</th><th>核心定义</th><th>物理形态</th><th>生命周期</th><th>核心作用</th></tr></thead><tbody><tr><td>参数记忆（Parameter Memory）</td><td>固化在模型权重中的 “隐性记忆”，是模型训练阶段习得的知识（非 MemOS 动态管理的记忆）。</td><td>模型参数（权重矩阵）</td><td>长期固定（除非模型微调）</td><td>提供 Agent 基础认知能力（如语言理解、通用逻辑），是其他记忆发挥作用的前提。</td></tr><tr><td>激活记忆（Activated Memory）</td><td>从长期存储中 “临时唤醒” 并加载到内存的记忆片段（如近期高频访问的知识、正在处理的任务相关记忆）。</td><td>内存中的结构化数据（节点、关系、向量）</td><td>中短期（任务执行期间 / 闲置超时后释放）</td><td>作为 “缓冲层”，避免频繁读取长期存储，提升记忆访问速度。</td></tr><tr><td>结构化记忆（明文记忆）</td><td>任务执行时 “实时生成 / 使用” 的临时记忆，是 Agent 当前决策所需的核心信息集合。</td><td>内存中的临时数据结构（如任务状态、推理中间结果、即时交互信息）</td><td>短期（任务结束后销毁 / 归档）</td><td>支撑当前任务的实时决策（如 “规划旅行” 时，临时存储目的地、交通方式等信息）。</td></tr></tbody></table>
<h5 data-id="heading-10">2.1.2 按「存储归属 + 访问优先级」划分</h5>
<p>该分类聚焦 “记忆的所有权、用途与访问优先级”，是从 Agent 功能逻辑角度对记忆的组织，核心服务于 “精准检索与管理”（如区分用户专属记忆和通用知识），偏 “功能逻辑维度”：</p>

































<table><thead><tr><th>记忆类型</th><th>核心定义</th><th>存储归属</th><th>访问优先级</th><th>核心作用</th></tr></thead><tbody><tr><td>WorkingMemory（工作记忆）</td><td>此处是 MemOS 中 “任务级临时存储模块”，专门存放当前任务的实时信息。</td><td>内存 / 临时存储</td><td>最高（任务执行期间优先访问）</td><td>承接当前任务的输入、中间结果、决策依据，是 Agent 实时交互的 “临时工作台”。</td></tr><tr><td>LongTermMemory（长期记忆）</td><td>Agent 的 “通用知识库”，存放不随任务销毁的长期有效信息（如通用知识、历史任务归档、领域规则）。</td><td>持久化存储（图数据库、向量数据库）</td><td>中低（需检索唤醒）</td><td>提供 Agent 长期稳定的知识支撑，避免 “任务结束即失忆”。</td></tr><tr><td>UserMemory（用户记忆）</td><td>属于 LongTermMemory 的 “子集化存储”，专门存放用户专属信息（如用户偏好、历史交互记录、个人属性）。</td><td>持久化存储（独立分区 / 带用户标识的数据库）</td><td>中高（用户相关任务优先访问）</td><td>实现 “个性化交互”（如记住用户喜欢的沟通风格、历史需求）。</td></tr></tbody></table>
<h4 data-id="heading-11">2.2 核心关系解析</h4>
<p>无包含关系，但有明确的 “映射与迁移”。</p>
<h5 data-id="heading-12">2.2.1. 不存在直接包含关系</h5>
<p>这两套分类维度是平行的</p>
<ul>
<li>第一套是 “技术实现维度”（关注 “记忆怎么存、存多久”），第二套是 “功能逻辑维度”（关注 “记忆为谁存、用来做什么”），二者如同 “按‘材质 + 保质期’分类食品” 与 “按‘食用场景 + 归属人’分类食品”—— 分类标准完全不同，无法直接说 “某类包含某类”。</li>
<li>例：UserMemory（功能维度）的物理形态可能是 “长期存储的结构化数据”（对应第一套的 “非激活态长期记忆”），也可能是 “临时加载到内存的激活数据”（对应第一套的 “激活记忆”）；WorkingMemory（功能维度）的物理形态就是第一套的 “结构化记忆”（临时数据结构）。</li>
</ul>
<h5 data-id="heading-13">2.2.2. 关键映射关系</h5>
<p>为了让逻辑更清晰，可通过 “功能模块 → 技术形态” 的映射理解二者关联：</p>





















<table><thead><tr><th>功能维度记忆（第二套）</th><th>对应的技术维度记忆（第一套）</th></tr></thead><tbody><tr><td>WorkingMemory</td><td>100% 对应「结构化记忆」（临时数据结构，任务结束后销毁 / 归档）；部分场景会加载「激活记忆」（如调用历史任务相关的唤醒记忆）。</td></tr><tr><td>LongTermMemory（通用）</td><td>未访问时：对应「长期存储的结构化数据」（非激活态）；访问时：加载为「激活记忆」；核心知识可能间接依赖「参数记忆」（模型权重中的通用认知）。</td></tr><tr><td>UserMemory</td><td>未访问时：对应「长期存储的用户专属数据」（非激活态）；访问时：加载为「激活记忆」；个性化偏好的理解依赖「参数记忆」（模型对 “偏好” 的语义认知）。</td></tr></tbody></table>
<h3 data-id="heading-14">0x03 MemOS的具体实现</h3>
<h4 data-id="heading-15">3.1 基本概念</h4>
<p>MemOS 关于记忆的基本概念如下。</p>
<h5 data-id="heading-16">3.1.1. 记忆类型 (memory_type)</h5>
<ul>
<li><code>WorkingMemory</code>: 工作记忆，临时存储。</li>
<li><code>LongTermMemory</code>: 长期记忆，持久存储</li>
<li><code>UserMemory</code>: 用户记忆，个性化存储</li>
</ul>
<p>WorkingMemory是Memos中的一种记忆类型，具有有限容量且会被定期清理。在MemoryManager中，默认最多保存20条WorkingMemory记录，并会自动移除旧记录以维持容量限制。</p>
<p>LongTermMemory和UserMemory是另外两种记忆类型，容量较大（默认分别为1500和480条记录）。它们不会像WorkingMemory那样频繁清理，用于存储更持久的信息。</p>
<h5 data-id="heading-17">3.1.2. 记忆状态 (status)</h5>
<ul>
<li><code>activated</code>: 激活状态</li>
<li><code>archived</code>: 归档状态</li>
<li><code>deleted</code>: 删除状态</li>
</ul>
<h5 data-id="heading-18">3.1.3. 记忆类型 (type)</h5>
<ul>
<li><code>fact</code>: 事实</li>
<li><code>event</code>: 事件</li>
<li><code>opinion</code>: 观点</li>
<li><code>topic</code>: 主题</li>
<li><code>reasoning</code>: 推理</li>
<li><code>procedure</code>: 程序</li>
</ul>
<h5 data-id="heading-19">3.1.4 问题</h5>
<p>如何选择合适的memory_type？</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 🔧 根据记忆的重要性选择</span>
if is_important:
    <span class="hljs-attr">memory_type</span> = <span class="hljs-string">"LongTermMemory"</span>  <span class="hljs-comment"># 长期存储</span>
elif is_temporary:
    <span class="hljs-attr">memory_type</span> = <span class="hljs-string">"WorkingMemory"</span>   <span class="hljs-comment"># 临时存储</span>
else:
    <span class="hljs-attr">memory_type</span> = <span class="hljs-string">"UserMemory"</span>      <span class="hljs-comment"># 个性化存储</span>
</code></pre>
<p>如果发现基础的<code>TextualMemoryMetadata</code>功能有限，无法满足复杂场景的需求，比如需要区分工作记忆和长期记忆，需要追踪记忆的来源，需要为记忆添加标签和实体信息。</p>
<h4 data-id="heading-20">3.2 记忆生成</h4>
<p>在 TreeTextMemory 中，LongTermMemory、UserMemory 和 WorkingMemory 的设置是由系统根据预设规则和配置自动管理的。系统通过 prompt（更准确地说是 LLM）来判断记忆应该存储在 LongTermMemory、UserMemory 还是 WorkingMemory 中。这个判断过程主要发生在记忆提取阶段。</p>
<h5 data-id="heading-21">3.2.1 记忆提取阶段</h5>
<p>在记忆提取过程中，系统使用 SimpleStructMemReader 这样的组件来处理输入内容（如对话、文档等）。这个组件会调用 LLM 并使用特定的 prompt 来分析输入内容并决定每条记忆的类型。</p>
<p>例如，在 SIMPLE_STRUCT_MEM_READER_PROMPT 中，明确要求为每个提取的记忆指定 memory_type 字段：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">{
  <span class="hljs-string">"memory list"</span>: [
    {
      <span class="hljs-string">"key"</span>: &lt;<span class="hljs-type">string</span>, a unique <span class="hljs-built_in">and</span> concise memory title&gt;,
      <span class="hljs-string">"memory_type"</span>: &lt;<span class="hljs-type">string</span>, <span class="hljs-string">"LongTermMemory"</span> <span class="hljs-built_in">or</span> <span class="hljs-string">"UserMemory"</span>&gt;,
      <span class="hljs-string">"value"</span>: &lt;a detailed, self-contained, <span class="hljs-built_in">and</span> unambiguous memory statement — use English <span class="hljs-keyword">if</span> the input conversation <span class="hljs-built_in">is</span> <span class="hljs-keyword">in</span> English, <span class="hljs-built_in">or</span> Chinese <span class="hljs-keyword">if</span> the conversation <span class="hljs-built_in">is</span> <span class="hljs-keyword">in</span> Chinese&gt;,
      <span class="hljs-string">"tags"</span>: &lt;a list <span class="hljs-keyword">of</span> relevant thematic keywords (e.g., [<span class="hljs-string">"deadline"</span>, <span class="hljs-string">"team"</span>, <span class="hljs-string">"planning"</span>])&gt;
    },
    ...
  ],
  <span class="hljs-string">"summary"</span>: &lt;a natural paragraph summarizing the above memories <span class="hljs-keyword">from</span> the user<span class="hljs-comment">'s perspective, 120–200 words, in the same language as the input&gt;</span>
}
</code></pre>
<p>SIMPLE_STRUCT_MEM_READER_PROMPT_ZH 摘录如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">SIMPLE_STRUCT_MEM_READER_PROMPT_ZH = <span class="hljs-string">"""您是记忆提取专家。
您的任务是根据用户与助手之间的对话，从用户的角度提取记忆。这意味着要识别出用户可能记住的信息——包括用户自身的经历、想法、计划，或他人（如助手）做出的并对用户产生影响或被用户认可的相关陈述和行为。

请执行以下操作：
1. 识别反映用户经历、信念、关切、决策、计划或反应的信息——包括用户认可或回应的来自助手的有意义信息。
如果消息来自用户，请提取与用户相关的观点；如果来自助手，则在表达的时候表明记忆归属方，未经用户明确认可的信息不要与用户本身的观点混淆。
   - **用户观点**：仅记录由**用户亲口陈述、明确认可或自己作出承诺**的信息。
   - **助手观点**：仅记录由**助手/另一方亲口陈述、明确认可或自己作出承诺**的信息。
   - **互不越界**：不得将助手提出的需求清单/建议/观点改写为用户的“拥有/偏好/决定”；也不得把用户的想法写成助手的观点。

2. 清晰解析所有时间、人物和事件的指代：
   - 如果可能，使用消息时间戳将相对时间表达（如“昨天”、“下周五”）转换为绝对日期。
   - 明确区分事件时间和消息时间。
   - 如果存在不确定性，需明确说明（例如，“约2025年6月”，“具体日期不详”）。
   - 若提及具体地点，请包含在内。
   - 将所有代词、别名和模糊指代解析为全名或明确身份。
   - 如有同名人物，需加以区分。

3. 始终以第三人称视角撰写，使用“用户”或提及的姓名来指代用户，而不是使用第一人称（“我”、“我们”、“我的”）。
例如，写“用户感到疲惫……”而不是“我感到疲惫……”。

4. 不要遗漏用户可能记住的任何信息。
   - 包括用户的关键经历、想法、情绪反应和计划——即使看似微小。
   - 同时允许保留与语境密切相关的**助手/另一方的内容**（如建议、说明、清单），但须明确角色与归因。
   - 优先考虑完整性和保真度，而非简洁性；不得将助手内容推断或措辞为用户拥有/偏好/决定。
   - 若当前对话中仅出现助手信息而无可归因于用户的事实，可仅输出**助手观点**条目。

5. 请避免在提取的记忆中包含违反国家法律法规或涉及政治敏感的信息。

返回一个有效的JSON对象，结构如下：

{
  "</span>memory list<span class="hljs-string">": [
    {
      "</span><span class="hljs-keyword">key</span><span class="hljs-string">": &lt;字符串，唯一且简洁的记忆标题&gt;,
      "</span>memory_type<span class="hljs-string">": &lt;字符串，"</span>LongTermMemory<span class="hljs-string">" 或 "</span>UserMemory<span class="hljs-string">"&gt;,
      "</span>value<span class="hljs-string">": &lt;详细、独立且无歧义的记忆陈述——若输入对话为英文，则用英文；若为中文，则用中文&gt;,
      "</span>tags<span class="hljs-string">": &lt;相关主题关键词列表（例如，["</span>截止日期<span class="hljs-string">", "</span>团队<span class="hljs-string">", "</span>计划<span class="hljs-string">"]）&gt;
    },
    ...
  ],
  "</span>summary<span class="hljs-string">": &lt;从用户视角自然总结上述记忆的段落，120–200字，与输入语言一致&gt;
}

语言规则：
- `key`、`value`、`tags`、`summary` 字段必须与输入对话的主要语言一致。**如果输入是中文，请输出中文**
- `memory_type` 保持英文。

示例：
对话：
user: [2025年6月26日下午3:00]：嗨Jerry！昨天下午3点我和团队开了个会，讨论新项目。
assistant: 哦Tom！你觉得团队能在12月15日前完成吗？
user: [2025年6月26日下午3:00]：我有点担心。后端要到12月10日才能完成，所以测试时间会很紧。
assistant: [2025年6月26日下午3:00]：也许提议延期？
user: [2025年6月26日下午4:21]：好主意。我明天上午9:30的会上提一下——也许把截止日期推迟到1月5日。

输出：
{
  "</span>memory list<span class="hljs-string">": [
    {
        "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>项目初期会议<span class="hljs-string">",
        "</span>memory_type<span class="hljs-string">": "</span>LongTermMemory<span class="hljs-string">",
        "</span>value<span class="hljs-string">": "</span>[user-Tom观点]<span class="hljs-number">2025</span>年<span class="hljs-number">6</span>月<span class="hljs-number">25</span>日下午<span class="hljs-number">3</span>:<span class="hljs-number">00</span>，Tom与团队开会讨论新项目。当Jerry
        询问该项目能否在<span class="hljs-number">2025</span>年<span class="hljs-number">12</span>月<span class="hljs-number">15</span>日前完成时，Tom对此日期前完成的可行性表达担忧，并计划在<span class="hljs-number">2025</span>年<span class="hljs-number">6</span>月<span class="hljs-number">27</span>日上午<span class="hljs-number">9</span>:<span class="hljs-number">30</span>
        提议将截止日期推迟至<span class="hljs-number">2026</span>年<span class="hljs-number">1</span>月<span class="hljs-number">5</span>日。<span class="hljs-string">",
        "</span>tags<span class="hljs-string">": ["</span>项目<span class="hljs-string">", "</span>时间表<span class="hljs-string">", "</span>会议<span class="hljs-string">", "</span>截止日期<span class="hljs-string">"]
    },
    {
        "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>Jerry对新项目截止日期的建议<span class="hljs-string">",
        "</span>memory_type<span class="hljs-string">": "</span>LongTermMemory<span class="hljs-string">",
        "</span>value<span class="hljs-string">": "</span>[assistant-Jerry观点]Jerry对Tom的新项目截止日期提出疑问、并提议Tom考虑延期。<span class="hljs-string">",
        "</span>tags<span class="hljs-string">": ["</span>截止日期变更<span class="hljs-string">", "</span>建议<span class="hljs-string">"]
    }
  ],
  "</span>summary<span class="hljs-string">": "</span>Tom目前正在做一个进度紧张的新项目。在<span class="hljs-number">2025</span>年<span class="hljs-number">6</span>月<span class="hljs-number">25</span>日的团队会议后，他意识到原定<span class="hljs-number">2025</span>年<span class="hljs-number">12</span>月<span class="hljs-number">15</span>
  日的截止日期可能无法实现，因为后端会延迟。由于担心测试时间不足，他接受了Jerry提出的延期建议，计划在次日早上的会议上提出将截止日期推迟至<span class="hljs-number">2026</span>
  年<span class="hljs-number">1</span>月<span class="hljs-number">5</span>日。<span class="hljs-string">"
}

另一个中文示例（注意：当用户语言为中文时，您也需输出中文）：

对话（节选）：
user｜2025-07-12 19:30：下个月同事婚礼，要买条裙子，预算1500内，别太暴露。
assistant｜19:32
：了解～婚礼场合建议中长款，端庄一些。可以看法式茶歇/直筒/裹身三路。颜色上，奶油白、浅粉、雾霾蓝都适合；面料可看醋酸/真丝混纺（垂感好但需干洗）。品牌与商场：COS/ Massimo Dutti / &amp; Other Stories / Mango 比较好逛；想更法式可以看 Sandro / Maje。 我记得你很喜欢Maje？
user｜19:35：不喜欢亮色。国贸方便。
assistant｜19:37：那亮度就压低些：雾霾蓝、藕粉、燕麦米白更稳。国贸有 COS / Massimo Dutti / &amp;OS；可以先看 COS 直筒或裹身，再去 MD 看藕粉/雾霾蓝。搭配上，薄披肩/小西装都能压场。
user｜19:40：165cm，S码；最好有口袋。
assistant｜19:42：OK。版型避开大摆+高开衩，选直筒或轻A字更稳；若要口袋，COS直筒一些款有；开衩别太高，及小腿肚附近即可。鞋包：中跟裸色鞋 + 小号手拿包。
user｜19:47：本来想茶歇A字，但雾霾蓝直筒也行。
assistant｜19:49：可以先锁定：COS 雾霾蓝直筒中长为主选，MD 藕粉中长做备选；再看 &amp; Other Stories 是否有合身的裹身款。
user｜19:52：行，周六（7/19）去国贸试，合适就买。
assistant｜19:54：记得看肩带可调/有无内衬，醋酸/真丝优先干洗；准备同色安全裤/防走光贴。如果当天没货，可下单调货或线上下单门店自提。

{
  "</span>memory list<span class="hljs-string">": [
    {
      "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>参加婚礼购买裙子<span class="hljs-string">",
      "</span>memory_type<span class="hljs-string">": "</span>UserMemory<span class="hljs-string">",
      "</span>value<span class="hljs-string">": "</span>[user观点]用户计划于约<span class="hljs-number">2025</span>年<span class="hljs-number">8</span>月参加同事婚礼（具体日期不详），预算不超过<span class="hljs-number">1500</span>元，整体风格不宜暴露；用户已决定在<span class="hljs-number">2025</span>-<span class="hljs-number">07</span>-<span class="hljs-number">19</span>于国贸试穿并视合适即购买。<span class="hljs-string">",
      "</span>tags<span class="hljs-string">": ["</span>婚礼<span class="hljs-string">", "</span>预算<span class="hljs-string">", "</span>国贸<span class="hljs-string">", "</span>计划<span class="hljs-string">"]
    },
    {
      "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>审美与版型偏好<span class="hljs-string">",
      "</span>memory_type<span class="hljs-string">": "</span>UserMemory<span class="hljs-string">",
      "</span>value<span class="hljs-string">": "</span>[user观点]用户不喜欢亮色，倾向低亮度色系；裙装偏好端庄的中长款，接受直筒或轻A字。<span class="hljs-string">",
      "</span>tags<span class="hljs-string">": ["</span>偏好<span class="hljs-string">", "</span>颜色<span class="hljs-string">", "</span>版型<span class="hljs-string">"]
    },
    {
      "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>体型尺码<span class="hljs-string">",
      "</span>memory_type<span class="hljs-string">": "</span>UserMemory<span class="hljs-string">",
      "</span>value<span class="hljs-string">": [user观点]"</span>用户身高约<span class="hljs-number">165</span>cm、常穿S码<span class="hljs-string">",
      "</span>tags<span class="hljs-string">": ["</span>体型<span class="hljs-string">", "</span>尺码<span class="hljs-string">"]
    },
    {
      "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>关于用户选购裙子的建议<span class="hljs-string">",
      "</span>memory_type<span class="hljs-string">": "</span>LongTermMemory<span class="hljs-string">",
      "</span>value<span class="hljs-string">": "</span>[assistant观点]assistant在用户询问婚礼穿着时，建议在国贸优先逛COS查看雾霾蓝直筒中长为主选，Massimo Dutti藕粉中长为备选；该建议与用户“国贸方便”“雾霾蓝直筒也行”的回应相一致，另外assistant也提到user喜欢Maje，但User并未回应或证实该说法。<span class="hljs-string">",
      "</span>tags<span class="hljs-string">": ["</span>婚礼穿着<span class="hljs-string">", "</span>门店<span class="hljs-string">", "</span>选购路线<span class="hljs-string">"]
    }
  ],
  "</span>summary<span class="hljs-string">": "</span>用户计划在约<span class="hljs-number">2025</span>年<span class="hljs-number">8</span>月参加同事婚礼，预算≤<span class="hljs-number">1500</span>并偏好端庄的中长款；确定于<span class="hljs-number">2025</span>-<span class="hljs-number">07</span>-<span class="hljs-number">19</span>在国贸试穿。其长期画像显示：不喜欢亮色、偏好低亮度色系与不过分暴露的版型，身高约<span class="hljs-number">165</span>cm、S码且偏好裙装带口袋。助手提出的国贸选购路线以COS雾霾蓝直筒中长为主选、MD藕粉中长为备选，且与用户回应一致，为线下试穿与购买提供了明确路径。<span class="hljs-string">"
}

请始终使用与对话相同的语言进行回复。

对话：
${conversation}

您的输出：""
</span></code></pre>
<h5 data-id="heading-22">3.2.2 内存类型判断的标准</h5>
<p>根据 prompt 中的指示，LLM 会基于以下标准来判断记忆类型：</p>
<ul>
<li>
<p>LongTermMemory</p>
<ul>
<li>包含长期重要信息</li>
<li>涉及项目计划、重要决策、关键事实</li>
<li>对用户长期有价值的信息</li>
</ul>
</li>
<li>
<p>UserMemory</p>
<ul>
<li>与用户个人偏好、习惯、特征相关</li>
<li>用户的个人经历、观点、喜好</li>
<li>与特定用户强相关的信息</li>
</ul>
</li>
</ul>
<p>根据提供的 SIMPLE_STRUCT_MEM_READER_PROMPT，决定记忆类型的判断标准如下：</p>
<p>在 prompt 中，明确要求为每个提取的记忆指定 memory_type 字段，其值只能是 "LongTermMemory" 或 "UserMemory"。虽然 prompt 没有详细说明两者的具体区别，但通过示例和上下文可以推断出以下判断标准：</p>
<p>LongTermMemory（长期记忆）存储具有长期价值和重要性的信息：</p>
<ul>
<li>项目计划和关键决策</li>
<li>重要的事实和事件</li>
<li>需要长期保存的工作相关信息</li>
<li>对用户未来发展有持续影响的信息</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Initial project meeting"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"memory_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LongTermMemory"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[user-Tom viewpoint] On June 25, 2025 at 3:00 PM, Tom met with the team to discuss a new project..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"timeline"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"meeting"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"deadline"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>UserMemory（用户记忆）存储与用户个人相关的偏好、习惯和特征：</p>
<ul>
<li>用户的个人偏好和选择</li>
<li>用户的习惯和行为模式</li>
<li>用户的个人观点和感受</li>
<li>与特定用户强相关的信息</li>
</ul>
<p>示例（基于购物场景）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wedding dress preference"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"memory_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UserMemory"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[user-viewpoint] For colleague's wedding next month, the user wants to buy a dress within 1500 RMB budget, not too revealing. Prefers midi length, modest style, and colors like cream white, light pink, or haze blue."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"wedding"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dress"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"budget"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"preference"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-23">3.2.3 判断依据总结</h5>
<p>虽然 prompt 中没有明确列出详细的判断规则，但从示例和任务描述中可以归纳出以下判断依据：</p>
<ul>
<li>内容性质：信息是工作/项目相关（LongTermMemory）还是个人偏好/体验（UserMemory）</li>
<li>时间跨度：短期临时信息可能归类为 WorkingMemory（虽然示例中未显示），而长期有价值信息归类为 LongTermMemory</li>
<li>所有权：信息属于用户个人（UserMemory）还是工作/项目相关（LongTermMemory）</li>
<li>重要性：对用户长期有价值的信息归类为 LongTermMemory，个人喜好和习惯归类为 UserMemory</li>
</ul>
<p>需要注意的是，在提取阶段的 prompt 中没有提及 WorkingMemory，这是因为 WorkingMemory 通常由系统自动管理，用于存储最近访问的记忆，而不是由 LLM 判断分类的。</p>
<h5 data-id="heading-24">3.2.4 代码流程</h5>
<h6 data-id="heading-25">实际转换流程总结</h6>
<p>新增记忆即时转换：</p>
<ul>
<li>用户输入或系统生成记忆时立即存储到相应的目标记忆库</li>
<li>所有记忆都同时保存在 WorkingMemory 中作为缓存，部分也会进入 LongTermMemory 或 UserMemory</li>
</ul>
<p>周期性清理</p>
<ul>
<li>WorkingMemory 达到容量上限时，移除最旧的记忆项</li>
<li>长期记忆库一般不主动清理，除非手动删除</li>
</ul>
<p>结构优化与抽象</p>
<ul>
<li>系统定期对长期记忆进行聚类分析</li>
<li>生成更高层次的抽象记忆节点</li>
<li>建立记忆间的语义关联网络</li>
</ul>
<p>并行检索</p>
<ul>
<li>搜索时会同时查询多种内存类型，然后合并结果</li>
</ul>
<p>手动替换</p>
<ul>
<li>可以手动替换 WorkingMemory 的内容</li>
</ul>
<p>这种设计使得系统既能快速响应最新信息，又能长期保存重要知识，并通过结构优化不断提升检索效率和语义理解能力。</p>
<h6 data-id="heading-26">创建和初始存储</h6>
<p>记忆通过 MemReader 组件创建，该组件处理输入数据（文档或对话）并将其转换为结构化的记忆项，存储在 TreeTextMemory 中。</p>
<p>在创建记忆项时，可以通过 TreeNodeTextualMemoryMetadata 的 memory_type 字段指定记忆类型为 LongTermMemory：</p>
<pre><code class="hljs language-arduino" lang="arduino"># 在 memos/memories/textual/item.py 中定义的 TreeNodeTextualMemoryMetadata 类
<span class="hljs-function"><span class="hljs-keyword">class</span> <span class="hljs-title">TreeNodeTextualMemoryMetadata</span><span class="hljs-params">(TextualMemoryMetadata)</span>:
    memory_type: Literal[<span class="hljs-string">"WorkingMemory"</span>, <span class="hljs-string">"LongTermMemory"</span>, <span class="hljs-string">"UserMemory"</span>] =</span> <span class="hljs-string">"WorkingMemory"</span>
</code></pre>
<p>当通过 TreeTextMemory.add() 添加记忆时，会触发以下转换逻辑：</p>
<ul>
<li>所有新增记忆都会先存储到 WorkingMemory；</li>
<li>同时根据记忆元数据中的 memory_type 字段决定是否同时存储到 LongTermMemory 或 UserMemory。</li>
</ul>
<pre><code class="hljs language-python" lang="python">TreeTextMemory.add()
→ MemoryManager.add()
→ MemoryManager._process_memory()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_process_memory</span>(<span class="hljs-params">self, memory: TextualMemoryItem</span>):
        <span class="hljs-string">"""
        Process and add memory to different memory types (WorkingMemory, LongTermMemory, UserMemory).
        This method runs asynchronously to process each memory item.
        """</span>
        ids = []

        <span class="hljs-comment"># 总是添加到 WorkingMemory</span>
        working_id = self._add_memory_to_db(memory, <span class="hljs-string">"WorkingMemory"</span>)
        ids.append(working_id)

        <span class="hljs-comment"># 如果元数据中指定了 LongTermMemory 或 UserMemory，则也添加到相应类型</span>
        <span class="hljs-keyword">if</span> memory.metadata.memory_type <span class="hljs-keyword">in</span> [<span class="hljs-string">"LongTermMemory"</span>, <span class="hljs-string">"UserMemory"</span>]:
            added_id = self._add_to_graph_memory(
                memory=memory,
                memory_type=memory.metadata.memory_type,
            )
            ids.append(added_id)

        <span class="hljs-keyword">return</span> ids
</code></pre>
<p>当添加记忆时，可以指定LongTermMemory类型。</p>
<pre><code class="hljs language-ini" lang="ini">    <span class="hljs-comment"># Create character memory metadata</span>
    <span class="hljs-attr">metadata</span> = TreeNodeTextualMemoryMetadata(
        <span class="hljs-attr">user_id</span>=user_id,
        <span class="hljs-attr">type</span>=<span class="hljs-string">"fact"</span>,
        <span class="hljs-attr">source</span>=<span class="hljs-string">"conversation"</span>,
        <span class="hljs-attr">confidence</span>=<span class="hljs-number">90.0</span>,
        <span class="hljs-attr">memory_type</span>=<span class="hljs-string">"LongTermMemory"</span>,
        <span class="hljs-attr">key</span>=<span class="hljs-string">"Zhang_San_Info"</span>,
        <span class="hljs-attr">entities</span>=[<span class="hljs-string">"Zhang San"</span>, <span class="hljs-string">"Engineer"</span>],
        <span class="hljs-attr">tags</span>=[<span class="hljs-string">"Personnel"</span>, <span class="hljs-string">"Technical"</span>]
    )

    <span class="hljs-comment"># Create memory item</span>
    <span class="hljs-attr">memory_item</span> = TextualMemoryItem(
        <span class="hljs-attr">memory</span>=<span class="hljs-string">"Zhang San is a senior engineer in our company, specializing in Python and machine learning"</span>,
        <span class="hljs-attr">metadata</span>=metadata
    )
</code></pre>
<h6 data-id="heading-27">定期清理与维护机制</h6>
<p>系统采用先进先出（FIFO）的方式定期清理 WorkingMemory：</p>
<ul>
<li>在每次添加记忆后调用 remove_oldest_memory 方法；</li>
<li>保留最新的 N 条记录（默认配置为 20 条）；</li>
<li>超出限制的旧记录会被自动删除。</li>
</ul>
<p>在系统配置中，可以设置记忆大小限制等参数，这些参数会直接影响 LongTermMemory的管理。</p>
<p>在 TreeTextMemory 中，MemoryManager 负责管理不同类型内存的分配和维护：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 TreeTextMemory.__init__ 中初始化</span>
self.memory_manager: MemoryManager = MemoryManager(
    self.graph_store,
    self.embedder,
    self.extractor_llm,
    memory_size=config.memory_size <span class="hljs-keyword">or</span> {
        <span class="hljs-string">"WorkingMemory"</span>: <span class="hljs-number">20</span>, <span class="hljs-comment"># 生命周期：短期存储，定期清理，用途：存储最近使用的记忆，用于快速访问</span>
        <span class="hljs-string">"LongTermMemory"</span>: <span class="hljs-number">1500</span>, <span class="hljs-comment"># 生命周期：长期存储，存储重要且持久的记忆</span>
        <span class="hljs-string">"UserMemory"</span>: <span class="hljs-number">480</span>, <span class="hljs-comment"># 生命周期：与特定用户相关联，存储与特定用户相关的个性化记忆</span>
    },
    is_reorganize=self.is_reorganize,
)
</code></pre>
<p>清理触发时机为：</p>
<pre><code class="hljs language-python" lang="python">        <span class="hljs-keyword">try</span>:
            self.graph_store.remove_oldest_memory(
                memory_type=<span class="hljs-string">"WorkingMemory"</span>, keep_latest=self.memory_size[<span class="hljs-string">"WorkingMemory"</span>]
            )
        <span class="hljs-keyword">except</span> Exception:
            logger.warning(<span class="hljs-string">f"Remove WorkingMemory error: <span class="hljs-subst">{traceback.format_exc()}</span>"</span>)

        <span class="hljs-keyword">try</span>:
            self.graph_store.remove_oldest_memory(
                memory_type=<span class="hljs-string">"LongTermMemory"</span>, keep_latest=self.memory_size[<span class="hljs-string">"LongTermMemory"</span>]
            )
        <span class="hljs-keyword">except</span> Exception:
            logger.warning(<span class="hljs-string">f"Remove LongTermMemory error: <span class="hljs-subst">{traceback.format_exc()}</span>"</span>)

        <span class="hljs-keyword">try</span>:
            self.graph_store.remove_oldest_memory(
                memory_type=<span class="hljs-string">"UserMemory"</span>, keep_latest=self.memory_size[<span class="hljs-string">"UserMemory"</span>]
            )
        <span class="hljs-keyword">except</span> Exception:
            logger.warning(<span class="hljs-string">f"Remove UserMemory error: <span class="hljs-subst">{traceback.format_exc()}</span>"</span>)
</code></pre>
<h6 data-id="heading-28">搜索时的数据交互</h6>
<p>在搜索过程中，不同类型的内存会被并行查询，然后结果被合并和重新排序：</p>
<pre><code class="hljs language-less" lang="less"># 在 <span class="hljs-selector-tag">Searcher</span><span class="hljs-selector-class">._retrieve_paths</span> 方法中
<span class="hljs-selector-tag">tasks</span><span class="hljs-selector-class">.append</span>(
    executor.<span class="hljs-built_in">submit</span>(
        self._retrieve_from_working_memory,
        query,
        parsed_goal,
        query_embedding,
        top_k,
        memory_type,
        search_filter,
tasks.<span class="hljs-built_in">append</span>(
    executor.<span class="hljs-built_in">submit</span>(
        self._retrieve_from_working_memory,
    )
)
</code></pre>
<h6 data-id="heading-29">图结构重组过程中的记忆优化</h6>
<p>GraphStructureReorganizer 的周期性优化，即GraphStructureReorganizer 还会定期对 LongTermMemory 和 UserMemory 进行结构优化，可能会创建新的聚合节点。</p>
<p>系统有一个后台线程运行 GraphStructureReorganizer，它会定期执行以下操作：</p>
<ul>
<li>对长期记忆进行聚类和总结；</li>
<li>创建抽象层级的记忆节点。</li>
</ul>
<p>优化触发条件为：</p>
<ul>
<li>新增记忆时设置 _reorganize_needed=True 标志</li>
<li>定期调度器每 100 秒检查一次是否需要重新组织结构</li>
<li>当有足够多的新记忆积累时才真正触发优化过程</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">def optimize_structure(
    self,
    scope: <span class="hljs-attr">str</span> = <span class="hljs-string">"LongTermMemory"</span>,
):
    <span class="hljs-comment"># 加载候选节点</span>
    <span class="hljs-attr">raw_nodes</span> = self.graph_store.get_structure_optimization_candidates(scope)
    <span class="hljs-attr">nodes</span> = [GraphDBNode(**n) for n in raw_nodes]
    <span class="hljs-comment"># 分区处理</span>
    <span class="hljs-attr">partitioned_groups</span> = self._partition(nodes)
    <span class="hljs-comment"># 对每个分区进行聚类和总结</span>
    for cluster_nodes in partitioned_groups:
        <span class="hljs-comment"># 创建父节点表示聚类</span>
        <span class="hljs-attr">sub_parent_node</span> = self._summarize_cluster(sub_nodes, scope)
        <span class="hljs-comment"># ...</span>
</code></pre>
<h6 data-id="heading-30">用户控制方式</h6>
<p>虽然系统自动管理内存类型，但用户可以通过以下方式间接影响：</p>
<ul>
<li>设置元数据：在创建 TextualMemoryItem 时设置 metadata.memory_type 字段</li>
<li>配置容量：通过 TreeTextMemoryConfig 设置各类内存的最大容量</li>
<li>手动替换：使用 replace_working_memory 方法直接操作工作内存</li>
</ul>
<h6 data-id="heading-31">总结</h6>
<p>LongTermMemory、UserMemory 和 WorkingMemory 的设置主要是由系统根据预定义规则自动完成的，而不是用户主动设置。系统会根据记忆的元数据和配置自动将其分配到适当的内存类型中，并按照设定的容量限制进行管理。用户可以通过配置参数和设置记忆元数据来间接影响这一过程。</p>
<h3 data-id="heading-32">0x04 MemOS 记忆生命周期管理</h3>
<p>MemOS 并没有一个统一的生命周期管理模块，该功能是散布在MemOS各个模块中。</p>
<p>以下为官方文档内容。</p>
<p>一条记忆从被生成开始，可能会逐步沉淀为稳定的长期偏好，也可能因过时或无效而被清理。</p>
<p>这套演化过程称为 <strong>记忆生命周期管理</strong>，它的目标是保持记忆库“干净而有序”。</p>
<ul>
<li><strong>近期有用的条目</strong>保持活跃，方便随时调用；</li>
<li><strong>长期稳定的事实</strong>被沉淀，减少重复和噪音；</li>
<li><strong>过时或冲突的信息</strong>会被归档或删除，保证一致性和合规性。</li>
</ul>
<blockquote>
<p>需要注意的是，生命周期管理关注的是<strong>记忆条目在存储层面的演化</strong>；而具体一次推理里“是否调用某条记忆”，仍由调度机制决定。</p>
</blockquote>
<h4 data-id="heading-33">4.1 生命周期阶段简介</h4>








































<table><thead><tr><th><strong>阶段</strong></th><th><strong>说明</strong></th><th><strong>系统行为</strong></th></tr></thead><tbody><tr><td>Generated 生成</td><td>新产生的记忆对象，带有来源、时间戳、置信度等元信息</td><td>初始存入存储层，等待后续使用</td></tr><tr><td>Activated 激活</td><td>在推理或任务中被引用，进入高频活跃状态</td><td>更容易被调度机制选中</td></tr><tr><td>Merged 合并</td><td>与历史记忆存在语义重叠或用户补充数据，系统将其整合为新版本</td><td>多条记录被压缩合并，形成更新后的稳定条目</td></tr><tr><td>Archived 归档</td><td>长期未被访问，自动降级为冷存储状态</td><td>仅在特殊检索或回溯时启用</td></tr><tr><td>Expired 过期，可选</td><td>归档后进一步超时或被策略判定为无效</td><td>被清理出索引，不再参与推理，仅留最小日志</td></tr><tr><td>Frozen 冻结，特殊状态</td><td>关键或合规性记忆被锁定，不允许修改</td><td>保留完整历史版本，支持审计与合规追踪</td></tr></tbody></table>
<h4 data-id="heading-34">4.2 案例：在线教育助手的记忆生命周期</h4>
<p>假设你正在用 MemOS 构建一个 <strong>在线教育助手</strong>，帮助学生解答数学题。</p>
<p><strong>生成（Generated）</strong></p>
<ul>
<li>学生第一次使用时说：“我总是把二次函数和一次函数搞混。”</li>
<li>系统抽取出记忆：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"fact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"学生常混淆二次函数与一次函数"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"confidence"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-09-11"</span><span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>状态：<strong>Generated</strong></li>
<li>行为：被存储进记忆库，等待后续使用。</li>
</ul>
<hr/>
<p><strong>激活（Activated）</strong></p>
<ul>
<li>在接下来的多次答题中，系统频繁调用这条记忆来辅助解题。</li>
<li>状态：<strong>Activated</strong></li>
<li>行为：被调度机制优先缓存进 MemoryCube，提高检索速度。</li>
</ul>
<hr/>
<p><strong>合并（Merged）</strong></p>
<ul>
<li>随着更多交互，系统发现学生不仅混淆一次函数和二次函数，还对指数函数也容易混淆。</li>
<li>系统将多条相似记忆合并为：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"fact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"该学生在函数知识点上存在混淆，尤其是一元一次、二次和指数函数"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"confidence"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.95</span><span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>状态：<strong>Merged</strong></li>
<li>行为：旧条目被压缩，形成新版本，减少冗余。</li>
</ul>
<hr/>
<p><strong>归档（Archived）</strong></p>
<ul>
<li>三个月后，学生已掌握函数相关知识点，系统很久没有再调度到这条记忆。</li>
<li>状态：<strong>Archived</strong></li>
<li>行为：被迁移至 MemVault（冷存储），默认不参与推理，但可在“学习轨迹回溯”中被调用。</li>
</ul>
<hr/>
<p><strong>过期（Expired）</strong></p>
<ul>
<li>又过了一年，该学生升级到新的学段，旧的“初中函数混淆”记忆被策略判定为无效。</li>
<li>状态：<strong>Expired</strong></li>
<li>行为：从索引中彻底清理，仅保留最小审计信息：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"deleted_fact_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12345"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"deleted_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026-09-11"</span><span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<p><strong>冻结（Frozen，特殊状态）</strong></p>
<ul>
<li>与此同时，该学生的“期末成绩评估报告”属于合规性文件，不允许修改。</li>
<li>状态：<strong>Frozen</strong></li>
<li>行为：被锁定，禁止更新，仅保留完整修改历史，便于审计与合规检查。</li>
</ul>
<p>进阶：如果你想做深度定制</p>



































<table><thead><tr><th><strong>可扩展点</strong></th><th><strong>描述</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>状态转换条件</td><td>控制各个状态触发条件</td><td>“若 7 天未使用 → 归档”</td></tr><tr><td>合并与压缩</td><td>定义相似记忆的处理方式</td><td>多条“喜欢科幻片”合并为一条置信度更高的事实</td></tr><tr><td>冲突解决</td><td>处理时间戳或来源矛盾的记忆</td><td>选择“最新覆盖旧条目”或“并列保留”</td></tr><tr><td>清理机制</td><td>设置删除条件，控制索引规模</td><td>删除低置信度或用户撤回的记忆</td></tr><tr><td>审计追踪</td><td>决定是否保留被删除条目的最小元信息</td><td>在合规要求下开启“溯源日志”</td></tr></tbody></table>
<h4 data-id="heading-35">4.3 自己的理解</h4>
<p>Memos中TreeTextMemory系统的三种记忆类型（WorkingMemory、LongTermMemory和UserMemory）之间不存在自动迁移或转换机制。系统采用独立管理策略，每种记忆类型有各自的容量限制和生命周期管理方式。</p>
<p>MemoryManager负责维护各记忆类型的容量限制，包括WorkingMemory（默认20条）、LongTermMemory（默认1500条）和UserMemory（默认480条）。当超出限制时按照FIFO原则清理旧记忆，但不会自动将记忆在不同类型间迁移。新记忆添加时会根据其类型属性决定存储位置，这是一种并行添加而非迁移过程。</p>
<p>在添加记忆时，系统会将所有记忆同时添加到WorkingMemory中，并根据记忆的metadata.memory_type字段决定是否同时添加到LongTermMemory或UserMemory中。这一过程是并行发生的，而非迁移或转换。</p>
<p>以下是自己的理解。</p>
<p>动态迁移逻辑，核心是 “记忆在不同形态 / 模块间的流动”，本质是 “功能需求驱动技术形态转换”—— 让 Agent 既能 “实时响应任务”（依赖工作记忆、激活记忆），又能 “长期积累知识”（依赖 LongTermMemory、UserMemory），还能 “高效利用资源”（通过层级存储优化），最终实现 “可推理、可扩展、个性化” 的记忆管理核心目标。</p>
<p>MemOS 的核心记忆流转逻辑，具体迁移路径可分为 4 类，覆盖 Agent 任务执行的全流程：</p>
<p><strong>（1）任务启动：长期记忆 → 激活记忆 → 工作记忆</strong></p>
<ul>
<li>
<p>场景：Agent 接收用户任务（如 “帮我规划从北京到上海的旅行，记得我喜欢经济型酒店”）；</p>
</li>
<li>
<p>迁移过程：</p>
<ol>
<li>先从「UserMemory」（功能维度）中检索 “用户喜欢经济型酒店” 的专属记忆，从「LongTermMemory」（功能维度）中检索 “北京到上海的交通方式” 的通用记忆；</li>
<li>这些检索到的记忆从 “长期存储”（非激活态）加载为「激活记忆」（技术维度），缓存到内存；</li>
<li>再将「激活记忆」中的关键信息（用户偏好、交通选项）注入「WorkingMemory」（功能维度），作为当前任务的决策依据。</li>
</ol>
</li>
</ul>
<p><strong>（2）任务执行：工作记忆 ↔ 激活记忆（实时交互）</strong></p>
<ul>
<li>
<p>场景：Agent 分析旅行方案时，需要确认 “经济型酒店的具体标准”（用户之前提过 “价格低于 500 元 / 晚”）；</p>
</li>
<li>
<p>迁移过程：</p>
<ol>
<li>「WorkingMemory」中无该细节，触发从「UserMemory」检索；</li>
<li>检索结果加载为「激活记忆」，补充到「WorkingMemory」中；</li>
<li>Agent 基于补充信息细化方案（筛选 500 元以下酒店），中间决策结果实时写入「WorkingMemory」。</li>
</ol>
</li>
</ul>
<p><strong>（3）任务结束：工作记忆 → 长期记忆（归档 / 丢弃）</strong></p>
<ul>
<li>
<p>场景：旅行方案生成完成，用户确认后任务结束；</p>
</li>
<li>
<p>迁移过程：</p>
<ol>
<li>「WorkingMemory」中的有用信息（如用户最终选择的酒店、交通方式、反馈 “下次想避开高铁换乘”），按归属归档：用户专属信息写入「UserMemory」，通用方案模板写入「LongTermMemory」；</li>
<li>归档后，这些信息从「工作记忆」转为 “长期存储的非激活态数据”；</li>
<li>「WorkingMemory」中无价值的临时信息（如中间筛选的无效酒店、计算过程）直接销毁，释放内存。</li>
</ol>
</li>
</ul>
<p><strong>（4）长期记忆更新：激活记忆 → 长期记忆（迭代优化）</strong></p>
<ul>
<li>
<p>场景：Agent 学习到新的通用知识（如 “北京到上海新增了直达航班”），或用户更新偏好（如 “现在喜欢中端酒店，预算 800 元 / 晚”）；</p>
</li>
<li>
<p>迁移过程：</p>
<ol>
<li>新知识 / 新偏好先通过「RelationAndReasoningDetector」处理为结构化数据，加载为「激活记忆」；</li>
<li>「激活记忆」通过「NodeHandler」写入对应长期存储：通用知识写入「LongTermMemory」，用户偏好更新「UserMemory」；</li>
<li>写入完成后，「激活记忆」可保留缓存（提升后续访问速度），超时后自动释放。</li>
</ol>
</li>
</ul>
<p><strong>补充：参数记忆的特殊角色（无迁移，仅提供基础支撑）</strong></p>
<p>参数记忆（模型权重）是 “静态基础”，不参与上述动态迁移 —— 它为所有记忆的 “理解与推理” 提供底层能力（如识别 “用户偏好” 的语义、推理 “交通方式选择” 的逻辑），但自身不会被 MemOS 动态修改（除非进行模型微调，将长期记忆中的关键知识固化为参数记忆）。</p>
<h4 data-id="heading-36">4.4 MemScheduler</h4>
<p>MemOS 也在尝试自动迁移，这就是 MemScheduler 的功能。</p>
<p>MemScheduler 是一个与 MemOS 系统并行运行的并发记忆管理系统，它协调 AI 系统中工作记忆、长时记忆和激活记忆之间的记忆操作。它通过事件驱动调度处理记忆检索、更新和压缩。该系统特别适合需要动态记忆管理的对话代理和推理系统。</p>
<p>我们将在下一章介绍 MemScheduler。</p>
<h3 data-id="heading-37">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1981392181592871894" target="_blank" title="https://zhuanlan.zhihu.com/p/1981392181592871894" ref="nofollow noopener noreferrer">Multi-Agent系统构建初探：基于LangGraph的长短期记忆管理实践指南</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1975514242754049684" target="_blank" title="https://zhuanlan.zhihu.com/p/1975514242754049684" ref="nofollow noopener noreferrer">Agent开发实践：从想法到产品——SSE、上下文工程与流式解析关键技术攻坚</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1975511012347249929" target="_blank" title="https://zhuanlan.zhihu.com/p/1975511012347249929" ref="nofollow noopener noreferrer">Agent开发实践：从想法到产品——系统架构设计实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.memmachine.ai%2Fopen_source%2Fmemory_types" target="_blank" title="https://docs.memmachine.ai/open_source/memory_types" ref="nofollow noopener noreferrer">docs.memmachine.ai/open_source…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现流式输出？一篇文章手把手教你！]]></title>    <link>https://juejin.cn/post/7583921477613502499</link>    <guid>https://juejin.cn/post/7583921477613502499</guid>    <pubDate>2025-12-15T13:42:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583921477613502499" data-draft-id="7583903159774101519" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现流式输出？一篇文章手把手教你！"/> <meta itemprop="keywords" content="前端,AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-15T13:42:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天扭码"/> <meta itemprop="url" content="https://juejin.cn/user/3349589831715801"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现流式输出？一篇文章手把手教你！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3349589831715801/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天扭码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:42:59.000Z" title="Mon Dec 15 2025 13:42:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文代码github仓库地址——<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FObjecteee%2FaiKnowedge" target="_blank" title="https://github.com/Objecteee/aiKnowedge" ref="nofollow noopener noreferrer">github.com/Objecteee/a…</a></p>
<h2 data-id="heading-0">一、什么是流式输出？</h2>
<p>流式输出是一种<strong>数据传输模式</strong>，在这种模式下，数据不是作为一个完整的、单一的包裹在一次响应中发送给客户端，而是被分成许多小的<strong>数据块 (chunks)</strong> ，并在服务器端生成的同时，<strong>持续不断、逐块地</strong>推送到客户端。例如下面的Gemini回答过程——</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b098f41dc36644fb971483fa5a7e0dd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5omt56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766410978&amp;x-signature=hm%2FQSG873QuMXrwPSVvdECxSJTI%3D" alt="GIF 2025-12-15 19-26-17.gif" width="50%" loading="lazy"/></p>
<h2 data-id="heading-1">二、为什么我们需要流式输出？</h2>
<p>流式输出的核心价值在于改变了用户对<strong>延迟的感知</strong>，将原本漫长的等待转化为即时的内容消费。</p>
<p><strong>1.极大地提升用户体验 (UX)：</strong></p>
<p>在传统的 <strong>请求-响应模型</strong>中，用户必须等待服务器生成并返回<strong>全部数据</strong>才能看到结果。例如，一个 AI 回复可能需要 5-10 秒。</p>
<p>流式输出则实现了内容<strong>逐块、逐字</strong>到达和显示。用户感知到的延迟从 <strong>“总生成时间”</strong> 缩短为 <strong>“首个数据块到达时间”</strong> 。这种实时反馈机制让用户感觉程序在即时响应，显著降低了等待的焦虑感。</p>
<p><strong>在 AI/LLM 场景中，</strong> 流式输出是<strong>必需品</strong>，它将数秒的枯燥等待变成了持续的阅读过程，是用户留存和产品体验的基石。</p>
<p><strong>2.提高系统和网络效率：</strong></p>
<p>流式输出技术（尤其是 <strong>SSE</strong> 和 <strong>WebSocket</strong>）通过建立持久连接，减少了重复建立和关闭 HTTP 连接的开销。
数据生成多少推送多少，网络带宽得到更有效的利用，特别是在处理大量异步或长时间运行的任务时，效率优势更为明显。</p>
<p>简单来说，流式输出的重要性在于：它把 <strong>“等待”</strong> 变成了 <strong>“消费”</strong> ，是现代交互式应用和实时数据平台的<strong>标配</strong>。</p>
<h2 data-id="heading-2">三、主流的流式输出实现</h2>
<p>流式输出主要有两种方案，第一种是SSE（基于HTTP）的单向流式输出；第二种是基于WebSocket的双向流式输出。</p>
<h3 data-id="heading-3">1.基于SSE的单向流式输出</h3>
<h4 data-id="heading-4">（1）后端实现</h4>
<p>SSE 流式输出的后端代码是有<strong>固定的格式和严格的要求</strong>。这种格式是 <strong>Server-Sent Events 规范</strong>的核心，也是客户端浏览器能够正确解析流的关键。</p>
<h5 data-id="heading-5">A. 基础格式</h5>
<p>这是最常用、最核心的格式，用于传输数据块。</p>























<table><thead><tr><th><strong>字段</strong></th><th><strong>格式</strong></th><th><strong>作用</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><strong>Data</strong></td><td><code>data: [内容]</code></td><td>包含要发送的实际数据。客户端 <code>event.data</code> 接收到的就是 <code>:</code> 后面的内容。</td><td><code>data: Hello world\n\n</code></td></tr><tr><td><strong>分隔符</strong></td><td><code>\n\n</code></td><td><strong>至关重要！</strong> 必须以两个换行符标记一个事件块的结束。</td><td/></tr></tbody></table>
<h5 data-id="heading-6">B. 完整格式</h5>
<p>SSE 规范还允许其他可选字段，用于更复杂的流控制：</p>





























<table><thead><tr><th><strong>字段</strong></th><th><strong>格式</strong></th><th><strong>作用</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><strong>Event</strong></td><td><code>event: [事件名]</code></td><td>允许发送不同类型的事件，客户端可以通过 <code>eventSource.addEventListener('事件名', ...)</code> 监听。</td><td><code>event: update\n</code></td></tr><tr><td><strong>ID</strong></td><td><code>id: [唯一标识]</code></td><td>允许为每个事件分配一个唯一 ID。如果客户端断线重连，它会发送 <code>Last-Event-ID</code>，服务器可以从该 ID 恢复推送。</td><td><code>id: 12345\n</code></td></tr><tr><td><strong>Retry</strong></td><td><code>retry: [毫秒数]</code></td><td><strong>全局设置。</strong> 客户端断开连接后，浏览器等待该毫秒数后再尝试重连。</td><td><code>retry: 10000\n\n</code></td></tr></tbody></table>
<p><strong>一个包含所有字段的完整事件块示例如下：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">event:</span> system-update
<span class="hljs-symbol">id:</span> <span class="hljs-number">999</span>
<span class="hljs-symbol">retry:</span> <span class="hljs-number">5000</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>, <span class="hljs-string">"progress"</span>: <span class="hljs-number">80</span>}
</code></pre>
<p><strong>注意：</strong> 即使使用了多个字段，<strong>最后也必须以 <code>\n\n</code> 结束</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/stream-sse'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    <span class="hljs-comment">// ------------------------------------------------------------------</span>
    <span class="hljs-comment">// A. 固定的 HTTP 响应头设置 (关键!)</span>
    <span class="hljs-comment">// ------------------------------------------------------------------</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/event-stream'</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Connection'</span>, <span class="hljs-string">'keep-alive'</span>);
    <span class="hljs-comment">// 允许跨域访问</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>); 

    <span class="hljs-comment">// 可选：设置断线重连时间间隔（单位：毫秒）</span>
    <span class="hljs-comment">// res.write('retry: 5000\n\n'); </span>

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- SSE Connection Established ---'</span>);

    <span class="hljs-comment">// 模拟数据流式生成</span>
    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (counter &gt;= <span class="hljs-number">8</span>) {
            <span class="hljs-comment">// 4. 结束流：发送 [DONE] 标记（常见实践）并关闭连接</span>
            res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'data: [DONE]\n\n'</span>);
            res.<span class="hljs-title function_">end</span>();
            <span class="hljs-built_in">clearInterval</span>(intervalId);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- SSE Stream Ended ---'</span>);
            <span class="hljs-keyword">return</span>;
        }

        counter++;
        <span class="hljs-keyword">const</span> payload = <span class="hljs-string">`这是第 <span class="hljs-subst">${counter}</span> 块数据，时间：<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>;
        
        <span class="hljs-comment">// ------------------------------------------------------------------</span>
        <span class="hljs-comment">// B. 固定的数据体格式 (严格要求!)</span>
        <span class="hljs-comment">// ------------------------------------------------------------------</span>
        <span class="hljs-keyword">const</span> sseData = 
        <span class="hljs-comment">// 1. data 字段：必须以 "data: " 开头</span>
        <span class="hljs-string">`data: <span class="hljs-subst">${payload}</span>\n`</span> + 
        <span class="hljs-comment">// 2. 两个换行符：必须以 "\n\n" 结尾，标志一个事件的结束</span>
        <span class="hljs-string">`\n`</span>; 

        <span class="hljs-comment">// 3. 实时写入数据到响应流</span>
        res.<span class="hljs-title function_">write</span>(sseData);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Pushed: <span class="hljs-subst">${payload}</span>`</span>);

    }, <span class="hljs-number">1500</span>); <span class="hljs-comment">// 每 1.5 秒推送一次</span>

    <span class="hljs-comment">// 处理客户端断开连接的清理工作</span>
    req.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">clearInterval</span>(intervalId);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Client closed connection.'</span>);
    });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SSE Server running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<ol>
<li><strong>设置正确的 Header：</strong> 必须设置 <code>Content-Type: text/event-stream</code>。</li>
<li><strong>实时写入：</strong> 使用 Node.js 的 <code>res.write()</code> 方法，而不是等待数据全部收集完毕后使用 <code>res.send()</code>。<code>res.send()</code> 会尝试关闭连接，不适用于流式输出。</li>
<li><strong>遵守 <code>data: ...\n\n</code> 格式：</strong> 任何偏离这个格式的输出都可能导致客户端 <code>EventSource</code> 无法正确触发 <code>onmessage</code> 事件。</li>
<li><strong>连接清理：</strong> 监听 <code>req.on('close', ...)</code> 事件，确保在客户端断开连接时，服务器能停止不必要的定时器或资源占用。</li>
</ol>
<h4 data-id="heading-7">（2）前端实现</h4>
<h5 data-id="heading-8">A.浏览器原生实现（EventSource）</h5>
<p><code>EventSource</code> 是浏览器专为 SSE 规范设计的高级 API。它自动处理了底层 HTTP 连接、数据格式解析、事件触发，以及断线重连等所有复杂逻辑。</p>
<h6 data-id="heading-9">优势</h6>
<ul>
<li><strong>最简洁：</strong> 只需要几行代码即可开始监听流。</li>
<li><strong>可靠性高：</strong> 内置自动重连机制，非常健壮。</li>
<li><strong>无需手动解析：</strong> 自动将 <code>data:</code> 字段的内容提取出来，作为 <code>event.data</code>。</li>
</ul>
<h6 data-id="heading-10">局限性</h6>
<ul>
<li><strong>只能 GET 请求。</strong></li>
<li><strong>不支持自定义 Header：</strong> 无法在请求头中传递 Token（只能通过 URL query 参数）。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>EventSource 客户端示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Segoe UI'</span>, Tahoma, Geneva, Verdana, sans-serif; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-tag">h1</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>; }
        <span class="hljs-selector-id">#status</span> { <span class="hljs-attribute">font-weight</span>: bold; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; }
        <span class="hljs-selector-class">.status-connecting</span> { <span class="hljs-attribute">color</span>: orange; <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff3e0</span>; }
        <span class="hljs-selector-class">.status-open</span> { <span class="hljs-attribute">color</span>: green; <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e8f5e9</span>; }
        <span class="hljs-selector-class">.status-closed</span> { <span class="hljs-attribute">color</span>: red; <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffebee</span>; }
        <span class="hljs-selector-id">#output-area</span> { 
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; 
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>; 
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">150px</span>; 
            <span class="hljs-attribute">white-space</span>: pre-wrap; <span class="hljs-comment">/* 保持换行和空格 */</span>
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fcfcfc</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
        }
        <span class="hljs-selector-class">.chunk</span> { <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">5px</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#00796b</span>; }
        <span class="hljs-selector-class">.divider</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#bdbdbd</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>EventSource 实时流接收端<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-connecting"</span>&gt;</span>连接状态: 正在初始化...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>接收到的消息流:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"closeStream()"</span>&gt;</span>🛑 停止接收流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 请确保这里的 URL 与您的 Node.js 后端 SSE 路由匹配</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STREAM_URL</span> = <span class="hljs-string">'http://localhost:3000/api/stream-sse'</span>; 
        
        <span class="hljs-keyword">const</span> statusElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
        <span class="hljs-keyword">const</span> outputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-area'</span>);
        
        <span class="hljs-keyword">let</span> eventSource;

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-params">text, className</span>) {
            statusElement.<span class="hljs-property">textContent</span> = text;
            statusElement.<span class="hljs-property">className</span> = <span class="hljs-string">''</span>;
            statusElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(className);
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeSSE</span>(<span class="hljs-params"/>) {
            outputElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空旧内容</span>
            
            <span class="hljs-comment">// 1. 创建 EventSource 实例并建立连接</span>
            eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-variable constant_">STREAM_URL</span>);
            <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 正在连接...'</span>, <span class="hljs-string">'status-connecting'</span>);

            <span class="hljs-comment">// 2. 监听连接打开事件</span>
            eventSource.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: ✅ 已建立'</span>, <span class="hljs-string">'status-open'</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SSE connection opened successfully.'</span>);
            };

            <span class="hljs-comment">// 3. 监听接收到数据事件 (核心逻辑)</span>
            eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> chunk = event.<span class="hljs-property">data</span>;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received chunk:'</span>, chunk);

                <span class="hljs-comment">// 检查结束标记（与后端定义的 "[DONE]" 匹配）</span>
                <span class="hljs-keyword">if</span> (chunk === <span class="hljs-string">'[DONE]'</span>) {
                    eventSource.<span class="hljs-title function_">close</span>();
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🟢 流已完成并关闭'</span>, <span class="hljs-string">'status-closed'</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Stream finished and closed by server.'</span>);
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-comment">// 实时追加数据到 UI</span>
                <span class="hljs-comment">// 使用 innerHTML 追加，可以实现更丰富的样式</span>
                outputElement.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;span class="chunk"&gt;<span class="hljs-subst">${chunk}</span>&lt;/span&gt;&lt;span class="divider"&gt; | &lt;/span&gt;`</span>;

                <span class="hljs-comment">// 确保滚动到底部以查看最新内容</span>
                outputElement.<span class="hljs-property">scrollTop</span> = outputElement.<span class="hljs-property">scrollHeight</span>;
            };

            <span class="hljs-comment">// 4. 监听错误事件（处理断线等）</span>
            eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'EventSource encountered an error:'</span>, error);
                
                <span class="hljs-keyword">if</span> (eventSource.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">EventSource</span>.<span class="hljs-property">CLOSED</span>) {
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: ❌ 已关闭或断开'</span>, <span class="hljs-string">'status-closed'</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// EventSource 默认会尝试自动重连</span>
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: ⚠️ 发生错误，正在尝试重连...'</span>, <span class="hljs-string">'status-connecting'</span>);
                }
            };
        }

        <span class="hljs-comment">// 5. 客户端主动关闭流的函数</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (eventSource &amp;&amp; eventSource.<span class="hljs-property">readyState</span> !== <span class="hljs-title class_">EventSource</span>.<span class="hljs-property">CLOSED</span>) {
                eventSource.<span class="hljs-title function_">close</span>();
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🛑 用户手动关闭'</span>, <span class="hljs-string">'status-closed'</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User manually closed the stream.'</span>);
            }
        }

        <span class="hljs-comment">// 页面加载完成后立即启动 SSE</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = initializeSSE;
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h5 data-id="heading-11">阶段一：连接初始化与建立</h5>
<p>此阶段旨在建立一个持久化的 HTTP 连接，并开始监听。</p>





























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>核心代码</strong></th><th><strong>关键点</strong></th></tr></thead><tbody><tr><td><strong>1. 创建 <code>EventSource</code> 实例</strong></td><td>使用 <code>EventSource</code> 构造函数传入 SSE 接口 URL，向服务器发起连接请求。</td><td><code>const es = new EventSource(url);</code></td><td><strong>浏览器自动处理</strong> 底层 HTTP GET 请求。</td></tr><tr><td><strong>2. 监听连接打开</strong></td><td>监听 <code>onopen</code> 事件，确认与服务器的连接已成功建立。</td><td><code>es.onopen = () =&gt; { ... }</code></td><td>此时流式数据传输通道已打开。</td></tr><tr><td><strong>3. 更新 UI 状态</strong></td><td>在 <code>onopen</code> 中，更新界面状态，提示用户数据流已开始。</td><td><code>setStatus('已连接');</code></td><td>提升用户体验。</td></tr></tbody></table>
<h5 data-id="heading-12">阶段二：数据接收与处理（核心）</h5>
<p>此阶段是持续接收服务器推送的数据，并实时更新 UI。</p>





























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>核心代码</strong></th><th><strong>关键点</strong></th></tr></thead><tbody><tr><td><strong>4. 监听消息事件</strong></td><td>监听 <code>onmessage</code> 事件。每当服务器推送一个完整的 <code>data:...\n\n</code> 事件块时，此回调函数就会触发。</td><td><code>es.onmessage = (event) =&gt; { ... }</code></td><td><strong><code>event.data</code></strong> 包含了服务器推送的实际内容。</td></tr><tr><td><strong>5. 实时数据追加</strong></td><td>将接收到的数据 (<code>event.data</code>) <strong>追加</strong>到当前展示的文本末尾（而不是替换）。</td><td><code>currentMsg += event.data;</code></td><td>这是实现“打字机”效果的关键。</td></tr><tr><td><strong>6. 处理自定义事件</strong></td><td>如果后端使用了 <code>event: [name]</code> 字段，前端可以通过 <code>es.addEventListener('name', callback)</code> 针对性地处理不同类型的事件。</td><td><code>es.addEventListener('update', ...)</code></td><td>适用于需要区分不同业务类型数据的场景。</td></tr></tbody></table>
<h5 data-id="heading-13">阶段三：连接维护、关闭与错误处理</h5>
<p>此阶段处理流的正常结束、网络错误和重试逻辑。</p>





























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>核心代码</strong></th><th><strong>关键点</strong></th></tr></thead><tbody><tr><td><strong>7. 监听流结束标记</strong></td><td>根据与后端约定的结束标记（如 <code>[DONE]</code>），判断流是否完成。</td><td><code>if (event.data === '[DONE]') { ... }</code></td><td><strong>流的正常结束，</strong> 避免无限等待。</td></tr><tr><td><strong>8. 关闭连接</strong></td><td>当流结束或用户主动点击“停止”按钮时，主动调用 <code>close()</code> 方法。</td><td><code>es.close();</code></td><td>释放客户端资源。</td></tr><tr><td><strong>9. 监听错误与重连</strong></td><td>监听 <code>onerror</code> 事件。当连接出错时，浏览器会根据服务器设置的 <code>retry:</code> 时间间隔自动尝试重连。</td><td><code>es.onerror = (error) =&gt; { ... }</code></td><td><strong>自动重试</strong> 是 SSE 相比于手动 <code>fetch</code> 的巨大优势。</td></tr></tbody></table>
<h5 data-id="heading-14">B.Fetch API实现</h5>
<p>当需要更强大的控制力、自定义请求头，或处理非标准 SSE 格式的流时，<code>fetch</code> 是最佳选择。</p>
<p>利用 <code>fetch</code> 返回的 <code>response.body</code>，它是一个 <strong><code>ReadableStream</code></strong> 对象。开发者需要获取这个流的 <strong>Reader</strong>，进入一个循环，<strong>手动</strong>读取数据块、解码，并根据 <code>\n\n</code> 规则<strong>手动解析</strong> SSE 格式。</p>
<h6 data-id="heading-15">优势</h6>
<ul>
<li><strong>控制力强：</strong> 可以发送 POST、PUT 等请求，并设置自定义 Header（用于鉴权）。</li>
<li><strong>通用性：</strong> 可以处理任何基于 HTTP 的流式数据，不限于 SSE 格式。</li>
<li><strong>新标准：</strong> 符合现代 Web 标准，浏览器支持良好。</li>
</ul>
<h6 data-id="heading-16">挑战</h6>
<ul>
<li><strong>实现复杂：</strong> 需要手动编写数据解析和错误重连的代码。</li>
<li><strong>性能考量：</strong> 频繁的循环读取和字符串拼接/解码操作需要谨慎优化。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Fetch API SSE 客户端示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Segoe UI'</span>, Tahoma, Geneva, Verdana, sans-serif; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-id">#status</span> { <span class="hljs-attribute">font-weight</span>: bold; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; <span class="hljs-attribute">color</span>: orange; }
        <span class="hljs-selector-id">#output-area</span> { 
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; 
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>; 
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">150px</span>; 
            <span class="hljs-attribute">white-space</span>: pre-wrap;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fcfcfc</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>🔗 Fetch API 模拟 SSE 接收端<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>连接状态: 待启动<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>接收到的消息流:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"startStream()"</span>&gt;</span>▶️ 启动流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"stopStream()"</span>&gt;</span>🛑 停止接收流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STREAM_URL</span> = <span class="hljs-string">'http://localhost:3000/api/stream-sse'</span>; <span class="hljs-comment">// 确保 URL 正确</span>
        
        <span class="hljs-keyword">const</span> statusElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
        <span class="hljs-keyword">const</span> outputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-area'</span>);
        
        <span class="hljs-keyword">let</span> controller = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 用于控制请求中止 (AbortController)</span>

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-params">text, color</span>) {
            statusElement.<span class="hljs-property">textContent</span> = text;
            statusElement.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = color;
        }

        <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (controller) <span class="hljs-title function_">stopStream</span>(); <span class="hljs-comment">// 确保前一个流已停止</span>

            controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
            <span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;
            <span class="hljs-keyword">let</span> textDecoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
            <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>; <span class="hljs-comment">// 缓冲区，用于存储不完整的事件块</span>

            outputElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
            <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 正在连接...'</span>, <span class="hljs-string">'orange'</span>);

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 发起 Fetch 请求，设置 signal 用于中止</span>
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">STREAM_URL</span>, {
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
                    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'text/event-stream'</span> },
                    <span class="hljs-attr">signal</span>: signal 
                });

                <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">body</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"响应体不是一个可读流。"</span>);
                }

                <span class="hljs-comment">// 2. 获取 ReadableStream 的 Reader</span>
                <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();

                <span class="hljs-comment">// 3. 循环读取流数据</span>
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
                    
                    <span class="hljs-keyword">if</span> (done) {
                        <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🟢 流已完成'</span>, <span class="hljs-string">'green'</span>);
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Stream finished.'</span>);
                        <span class="hljs-keyword">break</span>;
                    }

                    <span class="hljs-comment">// 4. 解码字节数据并追加到缓冲区</span>
                    <span class="hljs-comment">// { stream: true } 允许在流继续时进行解码</span>
                    buffer += textDecoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });

                    <span class="hljs-comment">// 5. 手动解析 SSE 消息块</span>
                    <span class="hljs-comment">// SSE 消息以 \n\n 结束，分割缓冲区</span>
                    <span class="hljs-keyword">let</span> messages = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n\n'</span>);
                    buffer = messages.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 最后一个不完整的块留在缓冲区</span>

                    messages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
                        <span class="hljs-keyword">if</span> (message) {
                            <span class="hljs-comment">// 6. 提取 data: 字段内容</span>
                            <span class="hljs-keyword">const</span> dataMatch = message.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/data: (.*)/</span>);
                            <span class="hljs-keyword">if</span> (dataMatch &amp;&amp; dataMatch[<span class="hljs-number">1</span>]) {
                                <span class="hljs-keyword">const</span> data = dataMatch[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();

                                <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) {
                                    controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 接收到结束标记，主动中止请求</span>
                                } <span class="hljs-keyword">else</span> {
                                    <span class="hljs-comment">// 7. 处理接收到的数据</span>
                                    outputElement.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;span class="chunk"&gt;<span class="hljs-subst">${data}</span>&lt;/span&gt;&lt;span class="divider"&gt; | &lt;/span&gt;`</span>;
                                    outputElement.<span class="hljs-property">scrollTop</span> = outputElement.<span class="hljs-property">scrollHeight</span>;
                                }
                            }
                        }
                    });
                }
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🛑 流被用户/DONE标记中止'</span>, <span class="hljs-string">'gray'</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetch request aborted successfully.'</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">`连接状态: ❌ 错误: <span class="hljs-subst">${error.message}</span>`</span>, <span class="hljs-string">'red'</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch SSE 错误:'</span>, error);
                }
            }
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (controller) {
                controller.<span class="hljs-title function_">abort</span>();
                controller = <span class="hljs-literal">null</span>;
            }
        }
        
        <span class="hljs-comment">// 页面加载完成后，设置初始状态</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 待启动'</span>, <span class="hljs-string">'black'</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>Fetch API 实现流式输出是高度可定制但相对复杂的技术方案，它要求开发者<strong>手动处理数据的接收、解码和 SSE 格式的解析</strong>。整个流程可以清晰地划分为三个主要阶段。</p>
<h3 data-id="heading-17">阶段一：初始化请求与准备工作</h3>
<p>此阶段的目标是发起请求并设置流读取所需的环境。</p>






























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>关键技术点</strong></th></tr></thead><tbody><tr><td><strong>1. 准备控制器</strong></td><td>创建 <code>AbortController</code> 实例。用于在流结束或需要中断时，能够<strong>中止</strong> <code>fetch</code> 请求。</td><td><code>new AbortController()</code></td></tr><tr><td><strong>2. 发起 Fetch 请求</strong></td><td>发起 <code>fetch</code> 请求，将 <code>controller.signal</code> 附加到请求配置中。可在 <code>headers</code> 中设置鉴权信息。</td><td><code>fetch(url, { signal: controller.signal, headers: {...} })</code></td></tr><tr><td><strong>3. 获取流读取器</strong></td><td>检查响应是否成功 (<code>response.ok</code>)，然后通过 <code>response.body.getReader()</code> 获取 <strong><code>reader</code></strong> 对象。</td><td><code>response.body.getReader()</code></td></tr><tr><td><strong>4. 准备解码器与缓冲区</strong></td><td>实例化 <code>TextDecoder</code> 用于将字节解码为字符串，并初始化一个 <strong><code>buffer</code></strong> 变量用于暂存不完整的数据片段。</td><td><code>new TextDecoder('utf-8')</code>, <code>let buffer = ''</code></td></tr></tbody></table>
<h3 data-id="heading-18">阶段二：循环读取、解码与解析（核心）</h3>
<p>此阶段是整个流程最复杂的部分，需要持续从流中拉取数据并手动解析 SSE 格式。</p>













































<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>关键技术点</strong></th></tr></thead><tbody><tr><td><strong>5. 启动读取循环</strong></td><td>使用 <code>while (true)</code> 或类似的循环结构开始持续读取数据。</td><td><code>while (true)</code></td></tr><tr><td><strong>6. 读取数据块</strong></td><td>调用 <code>await reader.read()</code>。它会暂停执行，等待服务器推送新的数据块 (<code>value: Uint8Array</code>)。</td><td><code>const { done, value } = await reader.read()</code></td></tr><tr><td><strong>7. 判断流结束</strong></td><td>检查 <code>done</code> 属性。如果为 <code>true</code>，跳出循环，进入清理阶段。</td><td><code>if (done) break;</code></td></tr><tr><td><strong>8. 解码与缓冲</strong></td><td>使用 <code>TextDecoder</code> 将原始字节 <code>value</code> 解码为字符串，并将其<strong>追加</strong>到缓冲区 (<code>buffer</code>) 中。</td><td><code>buffer += decoder.decode(value, { stream: true })</code></td></tr><tr><td><strong>9. 手动解析 SSE</strong></td><td>使用 <code>buffer.split('\n\n')</code> 将缓冲区内容分割成潜在的 SSE 消息数组。然后将数组中<strong>最后一个不完整的块</strong>重新放回缓冲区。</td><td><code>buffer.split('\n\n')</code>, <code>buffer = messages.pop()</code></td></tr><tr><td><strong>10. 提取数据</strong></td><td>遍历其余完整的消息块，使用正则表达式（如 <code>/data: (.*)/</code>）手动提取 <strong><code>data:</code></strong> 字段后的实际内容。</td><td><code>message.match(/data: (.*)/)</code></td></tr><tr><td><strong>11. 实时处理</strong></td><td>将提取到的数据追加到 UI 界面，并执行所需的业务逻辑。</td><td>UI 更新、滚动到底部</td></tr></tbody></table>
<h3 data-id="heading-19">阶段三：连接清理与错误处理</h3>
<p>此阶段确保流的正确终止和资源释放。</p>

























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>关键技术点</strong></th></tr></thead><tbody><tr><td><strong>12. 处理结束标记</strong></td><td>在数据处理逻辑中，如果检测到服务器推送的结束标记（如 <code>[DONE]</code>），则立即调用 <strong><code>controller.abort()</code></strong> 终止流。</td><td><code>controller.abort()</code></td></tr><tr><td><strong>13. 错误捕获</strong></td><td>将整个 <code>fetch</code> 和流读取循环包裹在 <code>try...catch</code> 块中。捕获网络错误和因 <code>controller.abort()</code> 产生的 <code>AbortError</code>。</td><td><code>try...catch (error)</code></td></tr><tr><td><strong>14. 释放资源</strong></td><td>无论是正常结束还是出错，确保所有相关资源（如 <code>reader</code>）得到释放。</td><td><strong><code>AbortController</code></strong> 自动处理了请求的终止。</td></tr></tbody></table>
<p>通过这种手动控制的方式，Fetch API 提供了对流的<strong>最高级别控制</strong>，但代价是代码实现更为复杂，且需要开发者手动处理自动重连等健壮性机制。</p>
<h5 data-id="heading-20">C.Axios API实现</h5>
<p>使用 <code>axios</code> 实现流式输出主要依赖其配置项，但在浏览器环境下的表现不如 <code>fetch</code> 和 <code>EventSource</code>。</p>
<p>在 <code>axios</code> 的配置中，需要显式设置 <code>responseType: 'stream'</code>。在 <strong>Node.js</strong> 环境中，这会返回一个 Node.js 的流，处理起来比较方便。但在<strong>浏览器环境</strong>中，<code>axios</code> 对流的封装不如 <code>fetch</code> 原生。</p>
<h6 data-id="heading-21">优势</h6>
<ul>
<li><strong>Node.js 友好：</strong> 在 Node.js 环境中处理流式数据很方便。</li>
<li><strong>代码统一：</strong> 如果应用大量依赖 <code>axios</code>，可以避免引入 <code>fetch</code>。</li>
</ul>
<h6 data-id="heading-22">挑战</h6>
<ul>
<li><strong>浏览器兼容性/稳定性：</strong> 浏览器端对 <code>axios</code> 流的稳定支持不如 <code>fetch</code> 和 <code>EventSource</code>。</li>
<li><strong>解析依然需要手动：</strong> 像 <code>fetch</code> 一样，您仍然需要获取流并手动进行 SSE 格式的解析和解码。</li>
<li><strong>潜在的内存问题：</strong> 如果流处理不当，可能会导致内存占用过高。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Axios 客户端模拟 SSE 示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Segoe UI'</span>, Tahoma, Geneva, Verdana, sans-serif; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-id">#status</span> { <span class="hljs-attribute">font-weight</span>: bold; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; <span class="hljs-attribute">color</span>: orange; }
        <span class="hljs-selector-id">#output-area</span> { 
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; 
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>; 
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">150px</span>; 
            <span class="hljs-attribute">white-space</span>: pre-wrap;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fcfcfc</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>🛠️ Axios 模拟 SSE 接收端<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>连接状态: 待启动<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>接收到的消息流:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"startStream()"</span>&gt;</span>▶️ 启动流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"stopStream()"</span>&gt;</span>🛑 停止接收流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STREAM_URL</span> = <span class="hljs-string">'http://localhost:3000/api/stream-sse'</span>; <span class="hljs-comment">// 确保 URL 正确</span>
        
        <span class="hljs-keyword">const</span> statusElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
        <span class="hljs-keyword">const</span> outputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-area'</span>);
        
        <span class="hljs-keyword">let</span> cancelTokenSource = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 用于取消请求的 Axios Token</span>
        <span class="hljs-keyword">let</span> lastProcessedIndex = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 追踪上次处理到的数据索引</span>
        <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>;              <span class="hljs-comment">// 用于存放不完整的 SSE 事件块</span>

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-params">text, color</span>) {
            statusElement.<span class="hljs-property">textContent</span> = text;
            statusElement.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = color;
        }

        <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (cancelTokenSource) <span class="hljs-title function_">stopStream</span>();

            cancelTokenSource = axios.<span class="hljs-property">CancelToken</span>.<span class="hljs-title function_">source</span>();
            lastProcessedIndex = <span class="hljs-number">0</span>;
            buffer = <span class="hljs-string">''</span>;
            outputElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
            <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 正在连接...'</span>, <span class="hljs-string">'orange'</span>);

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 发起 Axios GET 请求</span>
                <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">STREAM_URL</span>, {
                    <span class="hljs-comment">// 2. 设置 responseType 为 'stream' 或让其默认 (text)</span>
                    <span class="hljs-comment">// 在浏览器中，这依赖于 XHR 的 progress 事件</span>
                    <span class="hljs-attr">responseType</span>: <span class="hljs-string">'text'</span>, 
                    
                    <span class="hljs-comment">// 3. 设置取消 Token</span>
                    <span class="hljs-attr">cancelToken</span>: cancelTokenSource.<span class="hljs-property">token</span>,
                    
                    <span class="hljs-comment">// 4. 核心：监听下载进度事件</span>
                    <span class="hljs-attr">onDownloadProgress</span>: <span class="hljs-function">(<span class="hljs-params">progressEvent</span>) =&gt;</span> {
                        <span class="hljs-comment">// progressEvent.currentTarget 是底层的 XMLHttpRequest 对象</span>
                        <span class="hljs-keyword">const</span> responseText = progressEvent.<span class="hljs-property">currentTarget</span>.<span class="hljs-property">responseText</span>;

                        <span class="hljs-comment">// 5. 提取新增的数据块</span>
                        <span class="hljs-keyword">const</span> newChunk = responseText.<span class="hljs-title function_">substring</span>(lastProcessedIndex);
                        lastProcessedIndex = responseText.<span class="hljs-property">length</span>;
                        
                        <span class="hljs-comment">// 6. 追加到缓冲区</span>
                        buffer += newChunk;

                        <span class="hljs-comment">// 7. 手动解析 SSE 消息块</span>
                        <span class="hljs-keyword">let</span> messages = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n\n'</span>);
                        <span class="hljs-comment">// 最后一个片段可能是未完成的事件，保留在缓冲区</span>
                        buffer = messages.<span class="hljs-title function_">pop</span>(); 

                        messages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
                            <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">trim</span>()) {
                                <span class="hljs-comment">// 8. 提取 data: 字段内容</span>
                                <span class="hljs-keyword">const</span> dataMatch = message.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/data: (.*)/</span>);
                                <span class="hljs-keyword">if</span> (dataMatch &amp;&amp; dataMatch[<span class="hljs-number">1</span>]) {
                                    <span class="hljs-keyword">const</span> data = dataMatch[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();

                                    <span class="hljs-comment">// 9. 检查结束标记（与后端定义的 "[DONE]" 匹配）</span>
                                    <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) {
                                        <span class="hljs-title function_">stopStream</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 接收到结束标记，主动中止请求</span>
                                    } <span class="hljs-keyword">else</span> {
                                        <span class="hljs-comment">// 10. 实时追加数据到 UI</span>
                                        outputElement.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;span class="chunk"&gt;<span class="hljs-subst">${data}</span>&lt;/span&gt;&lt;span class="divider"&gt; | &lt;/span&gt;`</span>;
                                        outputElement.<span class="hljs-property">scrollTop</span> = outputElement.<span class="hljs-property">scrollHeight</span>;
                                    }
                                }
                            }
                        });
                    }
                });

                <span class="hljs-comment">// 请求正常结束（后端在发送 [DONE] 后关闭连接，但 Axios 仍可能等待超时）</span>
                <span class="hljs-comment">// 推荐依靠 [DONE] 来调用 stopStream</span>
                <span class="hljs-keyword">if</span> (!cancelTokenSource) {
                     <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🟢 流已完成 (Axios OK)'</span>, <span class="hljs-string">'green'</span>);
                }

            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
                    <span class="hljs-comment">// 被用户或 [DONE] 标记取消</span>
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🛑 流已中止'</span>, <span class="hljs-string">'gray'</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Axios request manually aborted.'</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 其他网络错误或请求失败</span>
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">`连接状态: ❌ 错误: <span class="hljs-subst">${error.message}</span>`</span>, <span class="hljs-string">'red'</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Axios SSE 错误:'</span>, error);
                }
            }
        }

        <span class="hljs-comment">// 客户端主动关闭流的函数</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopStream</span>(<span class="hljs-params">isDone = <span class="hljs-literal">false</span></span>) {
            <span class="hljs-keyword">if</span> (cancelTokenSource) {
                cancelTokenSource.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">'Stream terminated.'</span>);
                cancelTokenSource = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (isDone) {
                    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🟢 流已完成并关闭'</span>, <span class="hljs-string">'green'</span>);
                }
            }
        }
        
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 待启动'</span>, <span class="hljs-string">'black'</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>Axios 并非为 SSE 设计的，因为它基于传统的 XMLHttpRequest (XHR) 模型，或者在 Node.js 中基于 <code>http</code> 模块。在<strong>浏览器环境</strong>中，Axios 没有原生 <code>EventSource</code> 或 <code>ReadableStream</code> 的支持。</p>
<p>因此，使用 Axios 实现流式输出的<strong>标准工作流程</strong>是利用 XHR 的 <strong><code>onprogress</code></strong> 事件监听机制（在 Axios 中表现为 <code>onDownloadProgress</code> 回调），手动获取每次新增的数据块，并手动进行 SSE 格式的解析。</p>
<ol>
<li><strong>没有自动解析：</strong> 必须手动解析 <code>data:</code> 字段和 <code>\n\n</code> 分隔符。</li>
<li><strong>手动追踪数据：</strong> 每次 <code>onDownloadProgress</code> 触发时，返回的是<strong>当前已接收的全部数据</strong>，而不是新增的数据。您需要一个指针来追踪上次处理到了哪里，并提取出新的数据块。</li>
<li><strong>不支持自动重连：</strong> 必须手动实现错误检测和重连逻辑（本示例不包含重连，但需注意）。</li>
</ol>
<h5 data-id="heading-23">流式输出技术的选择</h5>
<h6 data-id="heading-24">1. 🥇 EventSource API</h6>
<p>这是实现 SSE 的<strong>标准和首选</strong>方案。</p>
<ul>
<li>
<p><strong>实现复杂度：</strong> <strong>最低。</strong> 浏览器原生支持，代码量最少。</p>
</li>
<li>
<p><strong>核心优势：</strong> <strong>内置健壮性。</strong> 自动处理 SSE 数据格式解析、消息事件 (<code>onmessage</code>) 触发，并内置了断线重连机制（支持服务器设置 <code>retry:</code> 间隔）。</p>
</li>
<li>
<p><strong>主要局限：</strong></p>
<ul>
<li><strong>只能 GET 请求。</strong></li>
<li><strong>不支持自定义 Header 鉴权。</strong> 只能通过 URL 参数传递 Token，安全性相对较低。</li>
</ul>
</li>
<li>
<p><strong>选择原则：</strong> <strong>强烈推荐</strong>用于大多数场景，尤其是在安全性要求不涉及请求 Header（例如，使用 Session Cookie 或 URL Token 鉴权）且只需要单向数据推送时。</p>
</li>
</ul>
<h6 data-id="heading-25">2. 🥈 Fetch API + ReadableStream</h6>
<p>这是在需要高控制度时使用的现代标准方案。</p>
<ul>
<li>
<p><strong>实现复杂度：</strong> <strong>中高。</strong> 需要手动获取流阅读器 (<code>getReader()</code>)，并进入循环，手动进行 SSE 数据解析（解码字节、查找 <code>\n\n</code>、提取 <code>data:</code>）。</p>
</li>
<li>
<p><strong>核心优势：</strong> <strong>控制力最强。</strong></p>
<ul>
<li>支持自定义 HTTP Header（适用于传递 JWT 等鉴权信息）。</li>
<li>支持 POST 等其他 HTTP 方法。</li>
<li>可以处理非标准的流格式。</li>
</ul>
</li>
<li>
<p><strong>主要局限：</strong> 必须手动编写复杂的 SSE 格式解析逻辑和错误重连机制。</p>
</li>
<li>
<p><strong>选择原则：</strong> 当您<strong>必须</strong>在请求 Header 中传递鉴权信息（例如 JWT），或者需要处理非标准的流格式时，应选择此方案。</p>
</li>
</ul>
<h6 data-id="heading-26">3. 🥉 Axios + onDownloadProgress</h6>
<p>这是基于旧的 XHR 机制的模拟方案，<strong>通常不推荐</strong>用于现代 Web 应用的 SSE。</p>
<ul>
<li>
<p><strong>实现复杂度：</strong> <strong>高。</strong> 依赖 <code>onDownloadProgress</code> 事件，每次事件触发返回的是<strong>全部</strong>已接收数据，因此需要额外的逻辑来追踪上次处理的索引，以提取新增的数据块。</p>
</li>
<li>
<p><strong>核心优势：</strong> 如果您的项目大量依赖 Axios，可以保持技术栈的统一。</p>
</li>
<li>
<p><strong>主要局限：</strong></p>
<ul>
<li>实现流程复杂且易错。</li>
<li>性能不如原生 API，且不支持原生的自动重连。</li>
<li>在浏览器环境中，缺乏对流的标准化支持。</li>
</ul>
</li>
<li>
<p><strong>选择原则：</strong> 仅在需要兼容旧环境或因特殊限制<strong>无法使用 <code>EventSource</code> 或 <code>fetch</code></strong> 的情况下考虑。</p>
</li>
</ul>
<h3 data-id="heading-27">2.基于WebSocket的双向流式输出实现</h3>
<p>WebSocket 协议与 SSE（单向流）和传统的 HTTP 请求（一次性传输）有着本质的区别，它在客户端和服务器之间建立了一个持久的、<strong>全双工（双向）</strong> 的通信通道，非常适合需要高频率、低延迟交互的场景。</p>
<h4 data-id="heading-28">1. 协议升级</h4>
<p>WebSocket 连接的建立始于一个标准的 HTTP 请求，这个请求包含了特殊的 Header，用于请求将连接从 HTTP <strong>升级（Upgrade）</strong> 到 WebSocket 协议。一旦升级成功，连接就不再受限于传统的 HTTP 请求-响应模型。</p>
<h4 data-id="heading-29">2. 全双工通信</h4>
<p>一旦连接建立，服务器和客户端可以<strong>独立、同时地</strong>互相发送数据帧。</p>
<ul>
<li><strong>客户端 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 服务器：</strong> 客户端可以随时发送输入、控制命令或心跳包。</li>
<li><strong>服务器 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 客户端：</strong> 服务器可以随时发送流式数据、状态更新或响应。</li>
</ul>
<p>这种双向性使得 WebSocket 不仅可以用于流式输出（服务器推数据），还可以用于实时接收用户输入，完美支持 <strong>实时聊天</strong> 或 <strong>协作编辑</strong> 等场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3069d503a494ec090c04f35cdc6f07a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5omt56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766410978&amp;x-signature=W4MwqgaXedigOTKNckA0t%2Fk7fic%3D" alt="WebSocket bidirectional communication diagram的图片" loading="lazy"/></p>
<h4 data-id="heading-30">3. 基于帧的传输</h4>
<p>WebSocket 的数据传输是基于<strong>帧</strong>的，而不是基于文本流或 HTTP 请求。这使得传输效率更高，延迟更低。帧可以包含文本数据（Text Frame）或二进制数据（Binary Frame）。</p>
<hr/>
<p>基于 WebSocket 的双向流式输出需要前端和后端分别<strong>使用专门的库和 API 进行</strong>实现。</p>
<h4 data-id="heading-31">1. 后端实现 (Node.js/ws 或 Socket.IO)</h4>
<p>后端需要一个专门的 WebSocket 服务器来管理连接和发送数据帧。</p>



































<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>关键技术点</strong></th></tr></thead><tbody><tr><td><strong>1. 握手与连接</strong></td><td>监听 HTTP 升级请求，接受连接，并分配一个唯一的 WebSocket 连接对象。</td><td><code>ws.on('connection', (socket) =&gt; { ... })</code></td></tr><tr><td><strong>2. 接收客户端输入</strong></td><td>监听客户端发送过来的数据帧，用于触发 AI 任务或控制流。</td><td><code>socket.on('message', (input) =&gt; { // Process input })</code></td></tr><tr><td><strong>3. 流式生成与推送</strong></td><td>在 AI 模型生成数据的过程中，将数据块封装成 WebSocket 帧并实时发送。</td><td><code>socket.send(data_chunk)</code></td></tr><tr><td><strong>4. 维护连接</strong></td><td>维护连接状态，处理心跳包（Ping/Pong），并在客户端断开时清理资源。</td><td><code>socket.on('close', ...)</code></td></tr><tr><td/><td/><td/></tr></tbody></table>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">WebSocket</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ws'</span>);

<span class="hljs-comment">// 创建 WebSocket 服务器，监听 8080 端口</span>
<span class="hljs-keyword">const</span> wss = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>.<span class="hljs-title class_">Server</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span> });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket Server running on ws://localhost:8080'</span>);

<span class="hljs-comment">// 监听客户端连接事件</span>
wss.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">connection</span>(<span class="hljs-params">ws</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- Client Connected ---'</span>);
    
    <span class="hljs-comment">// 1. 监听客户端发来的消息（双向输入）</span>
    ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">incoming</span>(<span class="hljs-params">message</span>) {
        <span class="hljs-keyword">const</span> clientMessage = message.<span class="hljs-title function_">toString</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Received message from client: <span class="hljs-subst">${clientMessage}</span>`</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(clientMessage);
            
            <span class="hljs-keyword">if</span> (data.<span class="hljs-property">command</span> === <span class="hljs-string">'START'</span>) {
                <span class="hljs-comment">// 客户端请求开始流式输出</span>
                <span class="hljs-title function_">startStreaming</span>(ws, data.<span class="hljs-property">prompt</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">command</span> === <span class="hljs-string">'STOP'</span>) {
                <span class="hljs-comment">// 客户端请求停止流式输出 (实时控制)</span>
                <span class="hljs-title function_">stopStreaming</span>(ws);
                ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">'info'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Streaming stopped by client.'</span> }));
            }
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error parsing client message:'</span>, e);
            ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Invalid JSON format.'</span> }));
        }
    });

    <span class="hljs-comment">// 监听连接关闭事件</span>
    ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- Client Disconnected ---'</span>);
        <span class="hljs-comment">// 清理资源，停止该连接上的所有流</span>
        <span class="hljs-title function_">stopStreaming</span>(ws);
    });

    <span class="hljs-comment">// 初始问候</span>
    ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">'ready'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Welcome! Send {"command": "START", "prompt": "..."} to begin streaming.'</span> }));
});

<span class="hljs-comment">// 存储当前正在流式输出的连接和定时器</span>
<span class="hljs-keyword">const</span> activeStreams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 模拟 AI 模型流式输出的函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">WebSocket</span>} <span class="hljs-variable">ws</span> - 当前连接的 WebSocket 实例
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">prompt</span> - 客户端提供的输入提示
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startStreaming</span>(<span class="hljs-params">ws, prompt</span>) {
    <span class="hljs-keyword">if</span> (activeStreams.<span class="hljs-title function_">has</span>(ws)) {
        ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">'info'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Stream is already active.'</span> }));
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        counter++;
        <span class="hljs-keyword">const</span> chunk = <span class="hljs-string">`[Chunk <span class="hljs-subst">${counter}</span>] Output for "<span class="hljs-subst">${prompt.substring(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>)}</span>...": Data block <span class="hljs-subst">${counter}</span>.`</span>;
        
        <span class="hljs-comment">// 2. 实时将数据块作为 WebSocket 帧发送给客户端</span>
        <span class="hljs-comment">// 使用 JSON 格式封装数据，方便客户端解析</span>
        <span class="hljs-keyword">const</span> dataToSend = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ 
            <span class="hljs-attr">type</span>: <span class="hljs-string">'data'</span>, 
            <span class="hljs-attr">content</span>: chunk,
            <span class="hljs-attr">count</span>: counter
        });
        
        <span class="hljs-comment">// 检查连接是否仍然打开</span>
        <span class="hljs-keyword">if</span> (ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
            ws.<span class="hljs-title function_">send</span>(dataToSend);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Pushed data chunk <span class="hljs-subst">${counter}</span>`</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果连接关闭，停止流</span>
            <span class="hljs-built_in">clearInterval</span>(intervalId);
            activeStreams.<span class="hljs-title function_">delete</span>(ws);
        }

        <span class="hljs-keyword">if</span> (counter &gt;= <span class="hljs-number">15</span>) {
            <span class="hljs-comment">// 3. 流结束，发送结束标记</span>
            <span class="hljs-built_in">clearInterval</span>(intervalId);
            activeStreams.<span class="hljs-title function_">delete</span>(ws);
            <span class="hljs-keyword">if</span> (ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
                 ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'done'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'Streaming complete.'</span> }));
            }
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- Streaming finished ---'</span>);
        }
    }, <span class="hljs-number">500</span>); <span class="hljs-comment">// 每 500 毫秒发送一个数据块</span>

    activeStreams.<span class="hljs-title function_">set</span>(ws, intervalId);
}

<span class="hljs-comment">/**
 * 停止指定连接的流式输出
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">stopStreaming</span>(<span class="hljs-params">ws</span>) {
    <span class="hljs-keyword">if</span> (activeStreams.<span class="hljs-title function_">has</span>(ws)) {
        <span class="hljs-built_in">clearInterval</span>(activeStreams.<span class="hljs-title function_">get</span>(ws));
        activeStreams.<span class="hljs-title function_">delete</span>(ws);
    }
}
</code></pre>
<h4 data-id="heading-32">2. 前端实现 (Browser WebSocket API)</h4>
<p>前端使用浏览器原生的 <code>WebSocket</code> API 来建立连接和处理双向通信。</p>






























<table><thead><tr><th><strong>步骤</strong></th><th><strong>动作描述</strong></th><th><strong>关键技术点</strong></th></tr></thead><tbody><tr><td><strong>1. 建立连接</strong></td><td>使用 <code>new WebSocket(ws://url)</code> 建立连接。注意协议是 <code>ws://</code> 或 <code>wss://</code>。</td><td><code>new WebSocket('ws://localhost:8080')</code></td></tr><tr><td><strong>2. 监听连接状态</strong></td><td>监听 <code>onopen</code>（连接成功）、<code>onerror</code> 和 <code>onclose</code> 事件。</td><td><code>ws.onopen = () =&gt; {...}</code></td></tr><tr><td><strong>3. 接收流式输出</strong></td><td>监听 <strong><code>onmessage</code></strong> 事件，接收服务器推送的流式数据帧，并实时追加到 UI。</td><td><code>ws.onmessage = (event) =&gt; { // Append event.data }</code></td></tr><tr><td><strong>4. 发送客户端输入</strong></td><td>当用户有新输入或需要发送控制命令时，通过 <code>send()</code> 方法发送数据帧到服务器。</td><td><code>ws.send(JSON.stringify({command: 'stop'}))</code></td></tr></tbody></table>
<hr/>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>WebSocket 双向流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: Arial, sans-serif; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-id">#status</span> { <span class="hljs-attribute">font-weight</span>: bold; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; }
        <span class="hljs-selector-id">#output-area</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>; <span class="hljs-attribute">min-height</span>: <span class="hljs-number">150px</span>; <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9f9f9</span>; <span class="hljs-attribute">white-space</span>: pre-wrap; <span class="hljs-attribute">overflow-y</span>: scroll; }
        <span class="hljs-selector-class">.control-panel</span> { <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>💬 WebSocket 双向流式交互<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: gray;"</span>&gt;</span>连接状态: 待连接...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>服务器输出流:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output-area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"control-panel"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"prompt"</span>&gt;</span>输入提示:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"prompt"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"请给我写一篇关于AI流式输出的文章"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 300px;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"connectWebSocket()"</span>&gt;</span>建立连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"startStream()"</span>&gt;</span>▶️ 启动流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"stopStream()"</span>&gt;</span>🛑 实时停止流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"closeWebSocket()"</span>&gt;</span>断开连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WS_URL</span> = <span class="hljs-string">'ws://localhost:8080'</span>;
        <span class="hljs-keyword">let</span> ws = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">const</span> statusElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
        <span class="hljs-keyword">const</span> outputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output-area'</span>);
        <span class="hljs-keyword">const</span> promptInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'prompt'</span>);

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">message</span>) {
            outputElement.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;p style="margin: 0; padding: 2px 0;"&gt;<span class="hljs-subst">${message}</span>&lt;/p&gt;`</span>;
            outputElement.<span class="hljs-property">scrollTop</span> = outputElement.<span class="hljs-property">scrollHeight</span>;
        }
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-params">text, color</span>) {
            statusElement.<span class="hljs-property">textContent</span> = text;
            statusElement.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = color;
        }

        <span class="hljs-comment">// 1. 建立 WebSocket 连接</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectWebSocket</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (ws &amp;&amp; ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接已存在'</span>, <span class="hljs-string">'blue'</span>);
                <span class="hljs-keyword">return</span>;
            }

            ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-variable constant_">WS_URL</span>);
            <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'正在连接...'</span>, <span class="hljs-string">'orange'</span>);
            outputElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;

            <span class="hljs-comment">// 监听连接成功事件</span>
            ws.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: ✅ 已建立'</span>, <span class="hljs-string">'green'</span>);
                <span class="hljs-title function_">log</span>(<span class="hljs-string">'--- WebSocket Connection Opened ---'</span>);
            };

            <span class="hljs-comment">// 2. 监听接收到的数据帧 (核心)</span>
            ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);
                    
                    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">'data'</span>) {
                        <span class="hljs-comment">// 实时追加流式输出的内容</span>
                        <span class="hljs-title function_">log</span>(<span class="hljs-string">`[Server Stream]: <span class="hljs-subst">${data.content}</span>`</span>);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">'done'</span>) {
                        <span class="hljs-title function_">log</span>(<span class="hljs-string">`[INFO]: <span class="hljs-subst">${data.message}</span>`</span>);
                        <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'流已完成'</span>, <span class="hljs-string">'blue'</span>);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">status</span> === <span class="hljs-string">'info'</span>) {
                        <span class="hljs-title function_">log</span>(<span class="hljs-string">`[INFO]: <span class="hljs-subst">${data.message}</span>`</span>);
                    }
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-comment">// 处理非 JSON 格式的消息</span>
                    <span class="hljs-title function_">log</span>(<span class="hljs-string">`[RAW MESSAGE]: <span class="hljs-subst">${event.data}</span>`</span>);
                }
            };

            <span class="hljs-comment">// 监听错误事件</span>
            ws.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: ❌ 发生错误'</span>, <span class="hljs-string">'red'</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket Error:'</span>, error);
            };

            <span class="hljs-comment">// 监听连接关闭事件 (连接断开)</span>
            ws.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'连接状态: 🛑 已断开'</span>, <span class="hljs-string">'red'</span>);
                <span class="hljs-title function_">log</span>(<span class="hljs-string">'--- WebSocket Connection Closed ---'</span>);
                ws = <span class="hljs-literal">null</span>;
            };
        }

        <span class="hljs-comment">// 3. 客户端发送命令：启动流式输出</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">startStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (ws &amp;&amp; ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
                <span class="hljs-keyword">const</span> prompt = promptInput.<span class="hljs-property">value</span> || <span class="hljs-string">"Default prompt"</span>;
                <span class="hljs-keyword">const</span> command = {
                    <span class="hljs-attr">command</span>: <span class="hljs-string">'START'</span>,
                    <span class="hljs-attr">prompt</span>: prompt
                };
                <span class="hljs-comment">// 发送 JSON 格式的启动命令</span>
                ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(command));
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'流式输出已启动...'</span>, <span class="hljs-string">'purple'</span>);
                <span class="hljs-title function_">log</span>(<span class="hljs-string">`[Client Command]: Starting stream for prompt: "<span class="hljs-subst">${prompt}</span>"`</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'请先建立连接'</span>, <span class="hljs-string">'red'</span>);
            }
        }

        <span class="hljs-comment">// 4. 客户端发送命令：实时停止流</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopStream</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (ws &amp;&amp; ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
                <span class="hljs-keyword">const</span> command = {
                    <span class="hljs-attr">command</span>: <span class="hljs-string">'STOP'</span>
                };
                <span class="hljs-comment">// 发送 JSON 格式的停止命令</span>
                ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(command));
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'发送停止命令'</span>, <span class="hljs-string">'purple'</span>);
                <span class="hljs-title function_">log</span>(<span class="hljs-string">`[Client Command]: Sending STOP command.`</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'请先建立连接'</span>, <span class="hljs-string">'red'</span>);
            }
        }
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeWebSocket</span>(<span class="hljs-params"/>) {
             <span class="hljs-keyword">if</span> (ws &amp;&amp; ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
                 ws.<span class="hljs-title function_">close</span>();
             }
        }

        <span class="hljs-comment">// 页面加载后自动尝试连接</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = connectWebSocket;
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>WebSocket 双向流</strong></th><th><strong>SSE 单向流</strong></th></tr></thead><tbody><tr><td><strong>通信方向</strong></td><td><strong>双向</strong>（全双工）</td><td><strong>单向</strong>（服务器 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 客户端）</td></tr><tr><td><strong>协议基础</strong></td><td>独立于 HTTP 的 TCP 协议</td><td>基于 HTTP 协议</td></tr><tr><td><strong>适用场景</strong></td><td>实时聊天、协作编辑、<strong>AI 实时交互控制</strong></td><td><strong>纯粹的 AI 流式输出</strong>、新闻推送</td></tr><tr><td><strong>实现复杂度</strong></td><td>较高（需独立服务器支持）</td><td>较低（基于标准 HTTP）</td></tr><tr><td><strong>自动重连</strong></td><td><strong>无原生支持</strong>，需要手动实现</td><td><strong>浏览器原生支持</strong></td></tr></tbody></table>
<p>如果你的 AI 应用只需要将 LLM 的结果流式输出给用户，<strong>SSE 是更简单、更健壮的选择</strong>。但如果您的应用需要用户在流式输出过程中<strong>实时中断、修改输入、或者实现多人协作</strong>，<strong>WebSocket 是唯一的选择</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[今年我试了十几款 AI 编程工具，最终只留下这 3 个]]></title>    <link>https://juejin.cn/post/7583912899389325355</link>    <guid>https://juejin.cn/post/7583912899389325355</guid>    <pubDate>2025-12-15T13:52:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583912899389325355" data-draft-id="7583898823921303594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="今年我试了十几款 AI 编程工具，最终只留下这 3 个"/> <meta itemprop="keywords" content="AI编程,Trae,Cursor"/> <meta itemprop="datePublished" content="2025-12-15T13:52:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            今年我试了十几款 AI 编程工具，最终只留下这 3 个
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T13:52:30.000Z" title="Mon Dec 15 2025 13:52:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今年一年，尝试并分享了 N 多的 AI 开发工具，今天就给大家分享下个人目前稳定的 <strong>AI 开发工具集</strong>。</p>
<p>最近没有引入什么新开发工具（包括<code>AntiGravity</code>），主力主要是以下3个：</p>
<ul>
<li>TRAE</li>
<li>Cursor</li>
<li>Claude Code（GLM-4.5）</li>
</ul>
<p><strong>TRAE</strong></p>
<p>TRAE 主要有三类场景：</p>
<ul>
<li>SOLO 模式。这个真的极其推荐，<strong>小项目</strong>的一把梭哈就不说了，环境部署、物联网开发等强依赖<strong>终端调试</strong>的场景，SOLO 也能完美适配。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cddc870845842788acb20704ea0bdc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766411550&amp;x-signature=tXKEphmnMCXTsNguazMve4PLvhw%3D" alt="" loading="lazy"/></li>
<li>原来的 <code>Claude 4</code>（现已不能使用），现在的 <code>Gemini 3 Pro</code>。面对特定场景，只能他们来攻克难题。而 TRAE 不需要魔法就能直接使用，这个应该是国产竞品中比较良心的了。</li>
<li>非编程场景，比如文章优化、项目文档编写等，通过<strong>自定义智能体</strong>的方式，灵活且直观。</li>
</ul>
<p>好像有很多人还不知道：<code>TRAE</code> 国内版，有 <code>SOLO</code>，还免费。</p>
<p><strong>Cursor</strong></p>
<p>针对一些复杂项目，尤其是需要手动编写部分代码的，我会选择 <code>Cursor</code>。</p>
<p>上下文的抽取和需求的理解，<code>Cursor</code> 还是顶级的，其次就是手动编写代码时，<code>Cursor</code> 的 <code>Tab</code> 用起来真的享受。</p>
<p>举一个小例子，<code>MyBatis</code> 中原本 <code>select</code> 了一个单表，需求变动为关联查询，此时需要在 <code>select</code> 的字段前面增加别名。<code>Cursor</code> 下真的只需要录入一个别名，就会把剩下字段全部的别名加上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c0ceb002e241c6b2249615f45c8586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766411550&amp;x-signature=eMl8THZT03LdfiyXh5T5YHuO1Hw%3D" alt="" loading="lazy"/></p>
<p><strong>Claude Code</strong></p>
<p><code>Claude Code</code> 的应用场景则更加明确。</p>
<p>就是嵌入到我们内部的自动化研发流程中，逐步替代人工研发，长远目标就是搭建一套完整的 AI 研发团队。</p>
<p>好了今天就介绍到这里吧，如果这几个工具你有什么更好的场景或者疑问，欢迎交流~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Trae + MCP 让 AI 自动测试页面]]></title>    <link>https://juejin.cn/post/7583898823921008682</link>    <guid>https://juejin.cn/post/7583898823921008682</guid>    <pubDate>2025-12-15T12:10:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583898823921008682" data-draft-id="7581649704884191247" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Trae + MCP 让 AI 自动测试页面"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-15T12:10:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谎言西西里"/> <meta itemprop="url" content="https://juejin.cn/user/332466136029851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Trae + MCP 让 AI 自动测试页面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/332466136029851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谎言西西里
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:10:47.000Z" title="Mon Dec 15 2025 12:10:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>想必大家在前段时间关于 <strong>“豆包手机”</strong> 一定有所耳闻，说实话在看过了不少博主的体验和测评之后呀，不禁有点感叹现代的AI发展了🤯。</p>
<p>但是有一个让我比较好奇的功能🤔，那就是 <strong>AI Agent是如何通过用户提供的提示词来直接操控应用的呢？</strong>
毕竟对于大多数人来说 AI 还停留在聊天对话的阶段，是什么东西让 AI 突然拥有了自己的 “手”与“眼” 呢？</p>
<p>因此我就去稍微了解了一下与这方面有关的一些知识，结果碰到了 <code>mcp协议</code> 和 <code>playwright</code>。</p>
<p>于是我抱着一颗学徒的心，来试试在目前很火的 AI 编译器 <strong>Trae</strong> 来看看会摩擦出怎样的火花🔥。</p>
<h2 data-id="heading-1">一、什么是 MCP（Model Context Protocol）？</h2>
<h3 data-id="heading-2">定义：</h3>
<p>MCP 协议是一个<strong>开放、标准化的通信协议</strong>，而它的核心作用是：</p>
<blockquote>
<p><strong>让大语言模型能够安全、结构化地调用外部工具、访问上下文数据，并与真实世界交互。</strong></p>
</blockquote>
<p>说白了，<strong>MCP 是给 AI 装上“手”和“眼”的接口。</strong></p>
<p>在 MCP 出现之前，AI 编程助手存在严重局限：</p>
<ul>
<li><strong>只能沟通，不能实施</strong>：虽然 AI 可以帮助生成代码，但是不能直接运行、测试或验证它是否真的达到了需要的效果。</li>
<li><strong>信息获取步骤复杂</strong>：AI 并不知道我们本地有哪些文件、依赖等等，大多数时候需要手动操作来提供给它。</li>
</ul>
<p>但是通过 MCP 这个“桥梁”，让 AI 作为客户端通过标准协议，连接一个或多个 MCP Server从而把<strong>外部程序</strong>（比如 Playwright、Shell 脚本等）接入到 AI 编译器中，让 AI 能调用它们。</p>
<p>例如：<strong>“模型 + 工具生态”协同</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fb68ab9a3fc4321aa5510b8f5e1cf8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=MgUSrQgDXCybSASpatSkpPrd1Ow%3D" alt="tongyi-mermaid-2025-12-15-184415.png" loading="lazy"/></p>
<p>在这整个过程中，用户仅仅只是向 AI Agent 下达了测试登录的命令，在此之后的过程都无需人工干预，AI 可以自主协调多个工具完成闭环。</p>
<p><strong>AI 就像公司的 CEO，通过 MCP 协议向多个部门（MCP Server）下达命令</strong></p>
<p>如果你想得到更官方的解释，可以去官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fdocs%2Fgetting-started%2Fintro" target="_blank" title="https://modelcontextprotocol.io/docs/getting-started/intro" ref="nofollow noopener noreferrer">What is the Model Context Protocol (MCP)?</a></p>
<h2 data-id="heading-3">二、什么是 Playwright？</h2>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fplaywright.nodejs.cn%2F" target="_blank" title="https://playwright.nodejs.cn/" ref="nofollow noopener noreferrer">Playwright</a></strong> 是由 Microsoft 开发的 <strong>现代化端到端（E2E）Web 测试工具</strong>，用于自动化 Chromium、WebKit 和 Firefox 浏览器的 Node.js/Python/Java/.NET 库。</p>
<p>但是由于 <strong>AI + MCP</strong> 的存在，我们并不需要精通这个工具，把事情交给AI，让我们更注重于功能。</p>
<h2 data-id="heading-4">三、MCP + Playwright 的协同</h2>
<p>下述示例都是通过使用 Trae 来实现的</p>
<h3 data-id="heading-5">前期工作：</h3>
<p>打开我们的 <strong>Trae</strong> 编辑器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc0e072cdb764925bb62e240922b2798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=ha7hnjUKnBlq5zdJx6eelvtYysU%3D" alt="image.png" loading="lazy"/></p>
<p>在设置页面找到 MCP</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3895986df5a41a5849509f98f62dcf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=GGN1nB6TnF3Bi9ZcuSBc1jyNwq0%3D" alt="image.png" loading="lazy"/></p>
<p>点击右边的 <strong>添加</strong> 按钮，这里有两种方法添加，<strong>从市场添加 / 手动添加</strong>，这里我们点击从市场添加即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16ff7bfae4054c328826d0650c8eab7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=x2Si4lUB0IE9Ba%2F7zFKSyezTgOU%3D" alt="image.png" loading="lazy"/></p>
<p>在市场这里可以添加任何你需要的 <strong>MCP Server</strong>，并且可以输入你需要配置的 MCP Server 信息。这里我们添加 <code>playwright</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a41ef842a6f47fe87bc4d1559d74f77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=PdZis9IKBSUyh9mnsZGO4ibbAE8%3D" alt="2025-12-15.gif" loading="lazy"/></p>
<p>安装好后回到主页面上，在 TRAE 智能体聊天框中选择 <code>@Builder with MCP</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117d264a3cc74bc599a9c56ab6c4ba37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=2qYRBHdMhD0IQmHlHE2qvfkGoFI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注：</p>
<p>不要忘记 playwright 只适配 Chromium、WebKit 和 Firefox浏览器，各位只需提前安装好其一即可</p>
</blockquote>
<h3 data-id="heading-6">示例一：让 AI 自动访问页面</h3>
<p>给 AI 提示词：</p>
<pre><code class="hljs language-markdown" lang="markdown">请帮我测试掘金网站的插件页面：
<span class="hljs-bullet">    1.</span> 打开 https://juejin.cn/
<span class="hljs-bullet">    2.</span> 点击顶部导航栏的"插件"按钮
<span class="hljs-bullet">    3.</span> 等待页面加载完成
<span class="hljs-bullet">    4.</span> 截图并保存到当前目录
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b6fc7eea1524e49a3b03d1463358e6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=25oMtNgfLETI8vJDGE3TG3yyc7o%3D" alt="image.png" loading="lazy"/></p>
<p>最后实现结果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22aa8f38bc5c4056a06bca6dc681fe8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=jWzCGeVq1FR433W5ea%2FPeqF3vQU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">示例二：让 AI 自动测试页面</h3>
<p>现在我test文件夹下有一个 <code>1.html</code>文件，给 AI 提示词让它帮我测试页面的基本效果。</p>
<pre><code class="hljs language-markdown" lang="markdown">请确认 1.html 文件的以下能力：
<span class="hljs-bullet">    1.</span> 测试是否能正确通过文件路径加载本地 HTML。
<span class="hljs-bullet">    2.</span> 测试 fill和click是否精准。
<span class="hljs-bullet">    3.</span> 通过验证结果文本，确保页面逻辑正常运行且被测试工具正确捕获。
<span class="hljs-bullet">    4.</span> 通过截图提供最终的视觉证据。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a3f6f41c8ff4f859aa2eb8727f97e57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCO6KiA6KW_6KW_6YeM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766405447&amp;x-signature=ke4gSzoD67v0w0GzpjCZF06VT1U%3D" alt="动画.gif" loading="lazy"/></p>
<h2 data-id="heading-8">四、这代表未来</h2>





















<table><thead><tr><th>传统开发</th><th>AI + MCP + Playwright</th></tr></thead><tbody><tr><td>写代码 → 手动测试 → 调试 → 修复</td><td>描述需求 → AI 生成 + 自动测试 + 自动修复</td></tr><tr><td>测试是“事后”行为</td><td>测试是“内建”能力</td></tr><tr><td>人做机械性验证</td><td>AI 做闭环验证</td></tr></tbody></table>
<blockquote>
<p>这正是 <strong>“Agentic AI”（智能体式开发）</strong> 的核心：AI 不再只是生成代码，而是能<strong>自主执行、验证、迭代</strong>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：OPA 集成指南：从原理到实践]]></title>    <link>https://juejin.cn/post/7583906870827646985</link>    <guid>https://juejin.cn/post/7583906870827646985</guid>    <pubDate>2025-12-15T12:34:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906870827646985" data-draft-id="7583906870827630601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：OPA 集成指南：从原理到实践"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-12-15T12:34:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：OPA 集成指南：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:34:41.000Z" title="Mon Dec 15 2025 12:34:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开箱即用的 GoWind Admin｜风行，企业级前后端一体中后台框架：OPA 集成指南：从原理到实践</h2>
<p>Open Policy Agent（简称 OPA）是一款开源的通用策略引擎，核心价值在于实现“策略即代码”（Policy as Code），将分散在各系统中的权限控制、资源访问规则等策略逻辑抽离出来，进行统一管理、版本控制与执行。如今，OPA 已成为云原生生态中策略管控的事实标准，被 Netflix、Cloudflare、Pinterest、Chef 等巨头广泛应用——从内部 API 权限管控、Kubernetes 集群资源调度，到终端产品的 IAM 功能实现，均能看到其身影。</p>
<p>OPA 由 Styra 公司于 2016 年开源，2018 年加入 CNCF（云原生计算基金会）成为沙箱项目，2021 年 2 月正式毕业，其快速晋升的背后，是社区的高度活跃与行业对统一策略管控需求的迫切性。本文将从 OPA 核心原理、Rego 语言入门，逐步深入到 GoWind Admin 企业级中后台框架的完整集成流程，帮助开发者快速落地权限管控能力。</p>
<h3 data-id="heading-1">一、深入理解 OPA：核心原理与核心概念</h3>
<p>在集成 OPA 之前，我们需要先厘清其核心逻辑：OPA 不关心“谁在访问”（认证，Authentication），只专注于“能否访问”（授权，Authorization）及更广泛的策略决策（如资源部署规则、网络路由限制等）。它通过接收输入、结合外部数据、执行预定义策略，最终输出决策结果，实现策略与业务系统的解耦。</p>
<h4 data-id="heading-2">1.1 核心概念：四大核心要素</h4>
<p>宏观上，OPA 的决策过程依赖四个核心要素，四者构成完整的策略执行闭环，在 OPA 官方试炼场（<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.openpolicyagent.org" target="_blank" title="https://play.openpolicyagent.org" ref="nofollow noopener noreferrer">play.openpolicyagent.org</a>）中可直观验证其交互逻辑：</p>
<ul>
<li><strong>请求输入（Request Input）</strong>：触发策略决策的请求数据，通常包含访问主体、访问资源、访问操作等关键信息，格式为 JSON。</li>
<li><strong>外部数据（Data）</strong>：策略执行所需的补充数据（非请求自带），如用户角色列表、资源权限映射表等，可通过 OPA 的数据 API 动态注入。</li>
<li><strong>Rego 策略（Policy）</strong>：使用 OPA 专用的声明式 DSL 语言 Rego 编写的策略规则，定义“何种条件下允许/拒绝某个操作”。</li>
<li><strong>响应数据（Response）</strong>：策略执行后的决策结果，可是简单的 true/false（允许/拒绝），也可是复杂的 JSON 结构（如返回允许的资源列表、拒绝原因等）。</li>
</ul>
<h4 data-id="heading-3">1.2 微观视角：请求输入的三元组模型</h4>
<p>任何访问控制类的策略决策，其输入本质上都可抽象为“主体-资源-操作”的三元组模型：</p>
<ol>
<li>访问实体（Subject）：发起访问的主体，如用户 ID、角色、用户组等；</li>
<li>访问资源（Object）：被访问的对象，如 API 接口、数据库表、K8s 资源等；</li>
<li>访问方法（Action）：具体的操作类型，如 HTTP 的 GET/POST/PUT/DELETE，或数据库的查询/修改等。</li>
</ol>
<p>这一模型与 Casbin 高度相似，但两者核心差异在于策略描述能力：Casbin 采用简洁的表达式模型，适合简单权限场景；而 OPA 的 Rego 作为完整的 DSL 语言，支持复杂的逻辑判断、数据转换、函数调用，能应对企业级复杂策略需求（如多维度权限叠加、动态数据关联校验等）。</p>
<h3 data-id="heading-4">二、Rego 语言入门：从基础语法到完整规则</h3>
<p>Rego 是 OPA 的核心，专为策略编写设计，具有声明式、易读易写的特点。它灵感源自 Datalog 查询语言，扩展了对 JSON 结构化数据的支持，可轻松处理嵌套对象、数组等常见数据格式。以下从核心语法入手，逐步构建完整的策略规则。</p>
<h4 data-id="heading-5">2.1 基础语法：变量与赋值</h4>
<p>Rego 中的变量一旦赋值便不可修改（不可变变量），支持标量、复合类型（对象、数组、集合）等多种数据类型，赋值使用 <code>:=</code> 符号：</p>
<pre><code class="hljs language-rego" lang="rego"># 标量赋值：字符串、整数、浮点数、布尔值、空值
greeting   := "Hello"
max_height := 42
pi         := 3.14159
allowed    := true
location   := null

# 复合类型赋值
rect := {"width": 2, "height": 4}  # 对象：键值对集合
allowed_users := ["papaya", "potato"]  # 数组：有序元素集合
ips_by_port := {  # 嵌套对象：键为整数，值为数组
    80: ["1.1.1.1", "1.1.1.2"],
    443: ["2.2.2.1"],
}
</code></pre>
<h4 data-id="heading-6">2.2 逻辑判断：条件与决策块</h4>
<p>Rego 的策略规则本质是“条件判断”，通过 <code>if</code> 关键字或省略 <code>if</code> 的决策块定义“何时满足策略”。核心逻辑运算符支持 <code>==</code>、<code>!=</code>、<code>&gt;</code>、<code>&lt;</code> 等，逻辑关系通过语法结构表达：</p>
<pre><code class="hljs language-rego" lang="rego"># 基础条件判断（两种写法等价）
v if "hello" == "world"  # 条件不满足，v 为 false
t2 if {                  # 多行决策块，内部语句需全部满足
    x := 42
    y := 41
    x &gt; y                # 条件满足，t2 为 true
}

# 省略 if 关键字的简洁写法（推荐）
v { "hello" == "world" }  # 等价于上述 v 的定义
t2 {
    x := 42
    y := 41
    x &gt; y
}

# 逻辑 AND：分号分隔或多行分隔（两种写法等价）
# 需同时满足“服务器ID为app”和“协议为https”
valid_server {
    input.servers[0].id == "app"
    input.servers[0].protocols[0] == "https"
}
# 等价于：input.servers[0].id == "app"; input.servers[0].protocols[0] == "https"

# 逻辑 OR：多个同名决策块（任一满足即可）
# 满足“是管理员”或“端点公开”即允许访问
allow {
    is_admin
}
allow {
    is_endpoint_public
}
</code></pre>
<h4 data-id="heading-7">2.3 迭代遍历：some 与 every</h4>
<p>Rego 提供<code>some</code>（存在性遍历）和 <code>every</code>（全称遍历）关键字，用于处理数组、对象等可迭代数据，支持索引<code>+</code>值的双重遍历，也可通过下划线 <code>_</code> 忽略无关数据：</p>
<pre><code class="hljs language-rego" lang="rego"># 1. 数组遍历：some 关键字
arr := [1, 2, 3]
has_even {
    some val in arr  # 遍历数组中的值
    val % 2 == 0     # 存在偶数即满足
}

# 2. 索引+值遍历
has_index_1 {
    some i, val in arr  # i 为索引，val 为对应值
    i == 1 &amp;&amp; val == 2  # 索引1对应值为2即满足
}

# 3. 对象遍历：every 关键字（所有元素需满足条件）
valid_obj {
    every k, v in {"foo": "bar", "fox": "baz"} {
        startswith(k, "f")  # 所有键以f开头
        startswith(v, "b")  # 所有值以b开头
    }
}

# 4. 通配符 _：忽略无关数据
get_project_id {
    proj = input.projects[_]  # 取任意一个项目
    id := proj.id             # 获取项目ID
}
</code></pre>
<h4 data-id="heading-8">2.4 函数定义：自定义策略逻辑</h4>
<p>Rego 支持自定义函数，用于封装可复用的策略逻辑，核心特点：</p>
<ul>
<li>默认返回 <code>true/false</code>，也可显式指定返回值；</li>
<li>支持同名函数重载，但参数数量必须一致；</li>
<li>输入相同则输出必相同（纯函数特性，确保策略执行的一致性）。</li>
</ul>
<pre><code class="hljs language-rego" lang="rego"># 1. 无返回值函数（默认返回true/false）
# 判断文件是否为配置文件（满足任一后缀即返回true）
is_config_file(str) {
  contains(str, ".yaml")
}
is_config_file(str) {
  contains(str, ".yml")
}
is_config_file(str) {
  contains(str, ".json")
}

# 2. 用 else 合并同名函数（等价于上述写法，更简洁）
is_config_file2(str) {
  contains(str, ".yaml")
} else {
  contains(str, ".yml")
} else {
  contains(str, ".json")
}

# 3. 显式返回值函数
# 自定义加法函数，返回 a + b 的结果
plus_custom(a, b) := c {
    c := a + b
}
out := plus_custom(42, 43)  # out 结果为 85
</code></pre>
<h4 data-id="heading-9">2.5 完整策略示例：RBAC 权限控制</h4>
<p>结合上述语法，我们实现一个经典的 RBAC（基于角色的访问控制）策略，定义“GET 请求放行、管理员及管理员组用户全放行”的规则：</p>
<pre><code class="hljs language-rego" lang="rego">package authz  # 定义策略包（类似命名空间，避免冲突）

default allow = false  # 默认拒绝所有访问

# 规则1：放行所有 GET 请求
allow {
    input.method == "GET"
}

# 规则2：允许 admin 用户执行任何操作
allow {
    input.user == "admin"
}

# 规则3：允许 admin 用户组中的用户执行任何操作
allow {
    input.group[_] == "admin"  # 遍历用户组，存在admin即满足
}
</code></pre>
<h5 data-id="heading-10">策略测试</h5>
<p>输入以下请求数据（模拟用户 <code>user1</code> 属于 <code>dev</code> 和 <code>admin</code> 组）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"group"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dev"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>OPA 执行后输出决策结果（满足规则3，允许访问）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-11">2.6 单元测试：确保策略正确性</h4>
<p>Rego 原生支持单元测试，测试文件命名需遵循 <code>xxx_test.rego</code> 规范（与 Go 语言一致），通过 <code>with</code> 关键字模拟输入数据，验证策略是否符合预期。</p>
<h5 data-id="heading-12">测试示例</h5>
<p>创建测试文件<code>authz_test.rego</code>：</p>
<pre><code class="hljs language-rego" lang="rego">package authz  # 与被测策略包一致
import future.keywords  # 引入未来关键字（可选，增强语法兼容性）

# 测试用例1：GET 请求应被允许
test_get_allowed if {
    allow with input as {"user": "user1", "method": "GET"}
}

# 测试用例2：admin 用户应被允许
test_admin_allowed if {
    allow with input as {"user": "admin", "method": "POST"}
}

# 测试用例3：非 admin 非 GET 请求应被拒绝
test_non_admin_non_get_denied if {
    not allow with input as {"user": "user2", "method": "POST", "group": ["dev"]}
}
</code></pre>
<h5 data-id="heading-13">执行测试</h5>
<p>在策略文件所在目录执行以下命令，查看测试结果：</p>
<pre><code class="hljs language-shell" lang="shell">opa test . -v  # -v 显示详细测试日志
</code></pre>
<h5 data-id="heading-14">测试输出（成功示例）：</h5>
<pre><code class="hljs language-shell" lang="shell">authz_test.rego:
data.authz.test_get_allowed: PASS (522.5µs)
data.authz.test_admin_allowed: PASS (310.2µs)
data.authz.test_non_admin_non_get_denied: PASS (285.7µs)
--------------------------------------------------------------------------------
PASS: 3/3
</code></pre>
<h3 data-id="heading-15">三、GoWind Admin 集成 OPA 完整步骤</h3>
<p>GoWind Admin 已将 OPA 核心逻辑封装至 &lt;github.com/tx7do/kratos-authz&gt; 组件中，开发者无需重复实现引擎初始化、策略加载等底层逻辑，只需按以下步骤完成配置、依赖注入与中间件集成，即可快速启用 OPA 权限管控。</p>
<h4 data-id="heading-16">3.1 核心封装：实现 Authorizer 权限管理器</h4>
<p>首先在 <code>app/admin/service/internal/data/authorizer.go</code> 中实现权限管理器，封装 OPA 引擎初始化、策略重置（从数据库加载角色-API 权限映射）等核心能力：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/data/authorizer.go</span>

<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"errors"</span>

	<span class="hljs-string">"github.com/go-kratos/kratos/v2/log"</span>

	authzEngine <span class="hljs-string">"github.com/tx7do/kratos-authz/engine"</span>
	<span class="hljs-string">"github.com/tx7do/kratos-authz/engine/casbin"</span>
	<span class="hljs-string">"github.com/tx7do/kratos-authz/engine/noop"</span>

	pagination <span class="hljs-string">"github.com/tx7do/go-crud/api/gen/go/pagination/v1"</span>
	<span class="hljs-string">"github.com/tx7do/go-utils/trans"</span>
	conf <span class="hljs-string">"github.com/tx7do/kratos-bootstrap/api/gen/go/conf/v1"</span>

	<span class="hljs-string">"go-wind-admin/app/admin/service/cmd/server/assets"</span>

	adminV1 <span class="hljs-string">"go-wind-admin/api/gen/go/admin/service/v1"</span>
	userV1 <span class="hljs-string">"go-wind-admin/api/gen/go/user/service/v1"</span>
)

<span class="hljs-comment">// Authorizer 权限管理器</span>
<span class="hljs-keyword">type</span> Authorizer <span class="hljs-keyword">struct</span> {
	log *log.Helper

	roleRepo        *RoleRepo
	apiResourceRepo *ApiResourceRepo

	engine authzEngine.Engine
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAuthorizer</span><span class="hljs-params">(
	logger log.Logger,
	cfg *conf.Bootstrap,
	roleRepo *RoleRepo,
	apiResourceRepo *ApiResourceRepo,
)</span></span> *Authorizer {
	a := &amp;Authorizer{
		log:             log.NewHelper(log.With(logger, <span class="hljs-string">"module"</span>, <span class="hljs-string">"authorizer/repo/admin-service"</span>)),
		roleRepo:        roleRepo,
		apiResourceRepo: apiResourceRepo,
	}

	a.init(cfg)

	<span class="hljs-keyword">return</span> a
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> init(cfg *conf.Bootstrap) {
	a.engine = a.newEngine(cfg)

	<span class="hljs-keyword">if</span> err := a.ResetPolicies(context.Background()); err != <span class="hljs-literal">nil</span> {
		a.log.Errorf(<span class="hljs-string">"reset policies error: %v"</span>, err)
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> newEngine(cfg *conf.Bootstrap) authzEngine.Engine {
	<span class="hljs-keyword">if</span> cfg.Authz == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}

	ctx := context.Background()

	<span class="hljs-keyword">switch</span> cfg.GetAuthz().GetType() {
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">fallthrough</span>
	<span class="hljs-keyword">case</span> <span class="hljs-string">"noop"</span>:
		state, err := noop.NewEngine(ctx)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			a.log.Errorf(<span class="hljs-string">"new noop engine error: %v"</span>, err)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> state

	<span class="hljs-keyword">case</span> <span class="hljs-string">"casbin"</span>:
		state, err := casbin.NewEngine(ctx)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			a.log.Errorf(<span class="hljs-string">"init casbin engine error: %v"</span>, err)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> state
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> Engine() authzEngine.Engine {
	<span class="hljs-keyword">return</span> a.engine
}

<span class="hljs-comment">// ResetPolicies 重置策略</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> ResetPolicies(ctx context.Context) <span class="hljs-type">error</span> {
	<span class="hljs-comment">//a.log.Info("*******************reset policies")</span>

	roles, err := a.roleRepo.List(ctx, &amp;pagination.PagingRequest{NoPaging: trans.Ptr(<span class="hljs-literal">true</span>)})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		a.log.Errorf(<span class="hljs-string">"failed to list roles: %v"</span>, err)
		<span class="hljs-keyword">return</span> err
	}

	<span class="hljs-keyword">if</span> roles == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(roles.Items) &lt; <span class="hljs-number">1</span> {
		a.log.Warnf(<span class="hljs-string">"no roles found to set policies"</span>)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// No roles to set policies</span>
	}

	apis, err := a.apiResourceRepo.List(ctx, &amp;pagination.PagingRequest{NoPaging: trans.Ptr(<span class="hljs-literal">true</span>)})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		a.log.Errorf(<span class="hljs-string">"failed to list APIs: %v"</span>, err)
		<span class="hljs-keyword">return</span> err
	}

	<span class="hljs-keyword">if</span> apis == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(apis.Items) &lt; <span class="hljs-number">1</span> {
		a.log.Warnf(<span class="hljs-string">"no APIs found to set policies for roles"</span>)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// No APIs to set policies</span>
	}

	<span class="hljs-comment">//a.log.Debugf("roles [%d] apis [%d]", len(roles.Items), len(apis.Items))</span>

	<span class="hljs-keyword">var</span> policies authzEngine.PolicyMap

	<span class="hljs-keyword">switch</span> a.engine.Name() {
	<span class="hljs-keyword">case</span> <span class="hljs-string">"casbin"</span>:
		<span class="hljs-keyword">if</span> policies, err = a.generateCasbinPolicies(roles, apis); err != <span class="hljs-literal">nil</span> {
			a.log.Errorf(<span class="hljs-string">"generate casbin policies error: %v"</span>, err)
			<span class="hljs-keyword">return</span> err
		}

	<span class="hljs-keyword">case</span> <span class="hljs-string">"noop"</span>:
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>

	<span class="hljs-keyword">default</span>:
		a.log.Warnf(<span class="hljs-string">"unknown engine name: %s"</span>, a.engine.Name())
		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"unknown authz engine name"</span>)
	}

	<span class="hljs-comment">//a.log.Debugf("***************** policy rules len: %v", len(rules))</span>

	<span class="hljs-keyword">if</span> err = a.engine.SetPolicies(context.Background(), policies, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> {
		a.log.Errorf(<span class="hljs-string">"set policies error: %v"</span>, err)
		<span class="hljs-keyword">return</span> err
	}
	a.log.Infof(<span class="hljs-string">"Reloaded policy rules"</span>)

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// generateCasbinPolicies 生成 Casbin 策略</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> generateCasbinPolicies(roles *userV1.ListRoleResponse, apis *adminV1.ListApiResourceResponse) (authzEngine.PolicyMap, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> rules []casbin.PolicyRule
	apiSet := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-keyword">struct</span>{})

	domain := <span class="hljs-string">"*"</span>

	<span class="hljs-keyword">for</span> _, role := <span class="hljs-keyword">range</span> roles.Items {
		<span class="hljs-keyword">if</span> role.GetId() == <span class="hljs-number">0</span> {
			<span class="hljs-keyword">continue</span> <span class="hljs-comment">// Skip if role or API ID is not set</span>
		}

		<span class="hljs-keyword">for</span> _, apiId := <span class="hljs-keyword">range</span> role.GetApis() {
			apiSet[apiId] = <span class="hljs-keyword">struct</span>{}{}
		}

		<span class="hljs-keyword">for</span> _, api := <span class="hljs-keyword">range</span> apis.Items {
			<span class="hljs-keyword">if</span> api.GetId() == <span class="hljs-number">0</span> {
				<span class="hljs-keyword">continue</span> <span class="hljs-comment">// Skip if role or API ID is not set</span>
			}

			<span class="hljs-keyword">if</span> _, exists := apiSet[api.GetId()]; exists {
				rules = <span class="hljs-built_in">append</span>(rules, casbin.PolicyRule{
					PType: <span class="hljs-string">"p"</span>,
					V0:    role.GetCode(),
					V1:    api.GetPath(),
					V2:    api.GetMethod(),
					V3:    domain,
				})
			}
		}
	}

	policies := authzEngine.PolicyMap{
		<span class="hljs-string">"policies"</span>: rules,
		<span class="hljs-string">"projects"</span>: authzEngine.MakeProjects(),
	}

	<span class="hljs-keyword">return</span> policies, <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-17">3.2 依赖注入：注册 Authorizer 到 Wire 容器</h4>
<p>GoWind Admin 使用 Wire 实现依赖注入，需修改 <code>app/admin/service/internal/data/init.go</code>，将 <code>NewAuthorizer</code> 注册到依赖容器，确保框架启动时自动初始化权限管理器：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/data/init.go</span>

<span class="hljs-comment">//go:build wireinject</span>
<span class="hljs-comment">// +build wireinject</span>

<span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/google/wire"</span>

<span class="hljs-comment">// ProviderSet 数据层依赖注入集合</span>
<span class="hljs-keyword">var</span> ProviderSet = wire.NewSet(
    NewAuthorizer,        <span class="hljs-comment">// 注册权限管理器（核心）</span>
    NewRoleRepo,          <span class="hljs-comment">// 注册角色数据仓库</span>
    NewApiResourceRepo,   <span class="hljs-comment">// 注册 API 资源数据仓库</span>
    <span class="hljs-comment">// ... 其他数据仓库（如用户仓库、菜单仓库等）</span>
)
</code></pre>
<h4 data-id="heading-18">3.3 中间件集成：嵌入 REST 服务请求链路</h4>
<p>将 OPA 权限校验中间件嵌入 REST 服务器的请求链路，实现对所有 API 接口的权限拦截。修改 <code>app/admin/service/internal/server/rest.go</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/internal/server/rest.go</span>

<span class="hljs-keyword">package</span> server

<span class="hljs-comment">// NewMiddleware 创建中间件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newRestMiddleware</span><span class="hljs-params">(
	logger log.Logger,
	authenticator authnEngine.Authenticator,
	authorizer *data.Authorizer,
)</span></span> []middleware.Middleware {
	<span class="hljs-keyword">var</span> ms []middleware.Middleware
	ms = <span class="hljs-built_in">append</span>(ms, logging.Server(logger))

	ms = <span class="hljs-built_in">append</span>(ms, selector.Server(
		authn.Server(authenticator),
		auth.Server(),
		authz.Server(authorizer.Engine()),
	).Match(newRestWhiteListMatcher()).Build())

	<span class="hljs-keyword">return</span> ms
}

<span class="hljs-comment">// NewRESTServer new an HTTP server.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRESTServer</span><span class="hljs-params">(
    cfg *conf.Bootstrap, logger log.Logger,
	authenticator authnEngine.Authenticator, authorizer *data.Authorizer,
)</span></span> {
    ...

	srv := rpc.CreateRestServer(cfg,
		newRestMiddleware(logger, authenticator, authorizer)...,
	)

    ...
}
</code></pre>
<h4 data-id="heading-19">3.4 配置启用：修改 auth.yaml 启用 OPA</h4>
<p>修改 <code>app/admin/service/configs/auth.yaml</code>，将权限引擎类型设置为 <code>opa</code>，启用权限校验：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># app/admin/service/configs/auth.yaml</span>
<span class="hljs-comment"># 认证与授权配置</span>
<span class="hljs-attr">auth:</span>
  <span class="hljs-comment"># 认证配置（如 JWT、OAuth2 等，根据实际需求配置）</span>
  <span class="hljs-attr">authn:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">"jwt"</span>
    <span class="hljs-attr">jwt:</span>
      <span class="hljs-attr">secret:</span> <span class="hljs-string">"your-jwt-secret"</span>
      <span class="hljs-attr">expires_at:</span> <span class="hljs-number">3600</span>

<span class="hljs-comment"># 授权配置（核心）</span>
<span class="hljs-attr">authz:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"opa"</span>  <span class="hljs-comment"># 启用 OPA 引擎（可选：opa/noop）</span>
  <span class="hljs-comment"># OPA 额外配置（可选，根据实际需求扩展）</span>
  <span class="hljs-comment"># opa:</span>
  <span class="hljs-comment">#   cache:  # 策略缓存配置</span>
  <span class="hljs-comment">#     enabled: true</span>
  <span class="hljs-comment">#     ttl: 300s  # 缓存过期时间</span>
  <span class="hljs-comment">#   watch: true  # 监听策略文件变化，动态重载（开发环境推荐）</span>
</code></pre>
<h4 data-id="heading-20">3.5 自定义模型：内嵌自定义 OPA 策略</h4>
<p>若默认的 RBAC 策略模型不满足业务需求（如支持数据权限、多租户隔离等），可自定义 Rego 策略文件，通过 Go 内置的 <code>//go:embed</code> 指令内嵌到项目中，实现策略与程序的一体化部署。</p>
<h5 data-id="heading-21">步骤 1：创建自定义策略文件</h5>
<p>在 <code>app/admin/service/cmd/server/assets/</code> 目录下创建 <code>opa_custom.rego</code>，编写自定义策略（示例：支持多租户的 RBAC 规则）：</p>
<pre><code class="hljs language-rego" lang="rego">package authz

default allow = false

# 自定义规则：租户内管理员可访问所有接口
allow {
    input.tenant_id != ""  # 租户ID非空
    input.user_role == "tenant_admin"  # 用户为租户管理员
}

# 自定义规则：普通用户仅可访问自身租户的资源
allow {
    input.tenant_id != ""
    input.user_role == "user"
    input.resource_tenant_id == input.tenant_id  # 资源租户ID与用户租户ID一致
    input.method == "GET"  # 仅允许查询操作
}

# 自定义规则：超级管理员忽略租户限制
allow {
    input.user_role == "super_admin"
}
</code></pre>
<h5 data-id="heading-22">步骤 2：内嵌策略文件</h5>
<p>修改 <code>app/admin/service/cmd/server/assets/assets.go</code>，通过 <code>//go:embed</code> 指令将自定义策略文件内嵌到程序中：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// app/admin/service/cmd/server/assets/assets.go</span>
<span class="hljs-keyword">package</span> assets

<span class="hljs-keyword">import</span> _ <span class="hljs-string">"embed"</span>

<span class="hljs-comment">// 内嵌默认 RBAC 策略（原有）</span>
<span class="hljs-comment">//go:embed opa_rbac.rego</span>
<span class="hljs-keyword">var</span> OpaRbacRego []<span class="hljs-type">byte</span>

<span class="hljs-comment">// 内嵌自定义 OPA 策略（新增）</span>
<span class="hljs-comment">//go:embed opa_custom.rego</span>
<span class="hljs-keyword">var</span> OpaCustomRego []<span class="hljs-type">byte</span>
</code></pre>
<h5 data-id="heading-23">步骤 3：加载自定义策略</h5>
<p>修改 <code>Authorizer.newEngine</code> 方法，加载内嵌的自定义策略文件：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> data

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"go-wind-admin/app/admin/service/cmd/server/assets"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Authorizer)</span></span> newEngine(cfg *conf.Bootstrap) authzEngine.Engine {
	<span class="hljs-keyword">switch</span> cfg.GetAuthz().GetType() {
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">fallthrough</span>

	<span class="hljs-keyword">case</span> <span class="hljs-string">"casbin"</span>:
		state, err := opa.NewEngine(ctx,
			opa.WithModulesFromString(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
				<span class="hljs-string">"custom.rego"</span>: <span class="hljs-type">string</span>(assets.OpaCustomRego),
			}),
		)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			a.log.Errorf(<span class="hljs-string">"init opa engine error: %v"</span>, err)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}

		<span class="hljs-keyword">if</span> err = state.InitModulesFromString(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
			<span class="hljs-string">"custom.rego"</span>: <span class="hljs-type">string</span>(assets.OpaCustomRego),
		}); err != <span class="hljs-literal">nil</span> {
			a.log.Errorf(<span class="hljs-string">"init opa modules error: %v"</span>, err)
		}

		<span class="hljs-keyword">return</span> state
	}
}
</code></pre>
<h3 data-id="heading-24">四、项目资源与参考资料</h3>
<h4 data-id="heading-25">4.1 核心项目仓库</h4>
<ul>
<li>GoWind Admin（Gitee）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">gitee.com/tx7do/go-wi…</a></li>
<li>GoWind Admin（GitHub）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">github.com/tx7do/go-wi…</a></li>
<li>Kratos-Authz（OPA/Casbin 封装组件）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fkratos-authz" target="_blank" title="https://github.com/tx7do/kratos-authz" ref="nofollow noopener noreferrer">github.com/tx7do/krato…</a></li>
<li>OPA 官方仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopen-policy-agent%2Fopa%2F" target="_blank" title="https://github.com/open-policy-agent/opa/" ref="nofollow noopener noreferrer">github.com/open-policy…</a></li>
</ul>
<h4 data-id="heading-26">4.2 学习参考资料</h4>
<h5 data-id="heading-27">官方文档</h5>
<ul>
<li>OPA 官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openpolicyagent.org%2F" target="_blank" title="https://www.openpolicyagent.org/" ref="nofollow noopener noreferrer">www.openpolicyagent.org/</a></li>
<li>OPA 交互式解释器（在线测试 Rego）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.openpolicyagent.org%2F" target="_blank" title="https://play.openpolicyagent.org/" ref="nofollow noopener noreferrer">play.openpolicyagent.org/</a></li>
</ul>
<h5 data-id="heading-28">入门与进阶教程</h5>
<ul>
<li>《策略即代码——Open Policy Agent（OPA）简介》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloudnative.to%2Fblog%2Fintroducing-policy-as-code-the-open-policy-agent-opa%2F" target="_blank" title="https://cloudnative.to/blog/introducing-policy-as-code-the-open-policy-agent-opa/" ref="nofollow noopener noreferrer">cloudnative.to/blog/introd…</a></li>
<li>《How to Write Your First Rules in Rego》（官方入门）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.styra.com%2Fblog%2Fhow-to-write-your-first-rules-in-rego-the-policy-language-for-opa%2F" target="_blank" title="https://www.styra.com/blog/how-to-write-your-first-rules-in-rego-the-policy-language-for-opa/" ref="nofollow noopener noreferrer">www.styra.com/blog/how-to…</a></li>
<li>《OPA进阶-函数与虚拟文档要分清》：<a href="https://link.juejin.cn?target=http%3A%2F%2Fblog.newbmiao.com%2F2020%2F03%2F18%2Fopa-func-and-virtual-doc.html" target="_blank" title="http://blog.newbmiao.com/2020/03/18/opa-func-and-virtual-doc.html" ref="nofollow noopener noreferrer">blog.newbmiao.com/2020/03/18/…</a></li>
<li>《OPA进阶-简洁的推导式》：<a href="https://link.juejin.cn?target=http%3A%2F%2Fblog.newbmiao.com%2F2020%2F03%2F20%2Fopa-comprehensions.html" target="_blank" title="http://blog.newbmiao.com/2020/03/20/opa-comprehensions.html" ref="nofollow noopener noreferrer">blog.newbmiao.com/2020/03/20/…</a></li>
</ul>
<h5 data-id="heading-29">实践案例</h5>
<ul>
<li>《Open Policy Agent - 快速導入 Authz 至 Microservice 架構》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fengineering.linecorp.com%2Fzh-hant%2Fblog%2Fopen-policy-agent-authz-in-microservice%2F" target="_blank" title="https://engineering.linecorp.com/zh-hant/blog/open-policy-agent-authz-in-microservice/" ref="nofollow noopener noreferrer">engineering.linecorp.com/zh-hant/blo…</a></li>
<li>《Open Policy Agent: What Is OPA and How It Works (Examples)》：<a href="https://link.juejin.cn?target=https%3A%2F%2Fspacelift.io%2Fblog%2Fwhat-is-open-policy-agent-and-how-it-works" target="_blank" title="https://spacelift.io/blog/what-is-open-policy-agent-and-how-it-works" ref="nofollow noopener noreferrer">spacelift.io/blog/what-i…</a></li>
</ul>
<h3 data-id="heading-30">五、集成验证与常见问题</h3>
<h4 data-id="heading-31">5.1 集成验证步骤</h4>
<ol>
<li>启动 GoWind Admin 服务，确保 OPA 引擎初始化成功（查看日志 <code>successfully reloaded xxx policy rules</code>）；</li>
<li>通过 Postman 等工具发送请求：
<ul>
<li>未认证请求：访问需要权限的接口，应返回 401 未授权；</li>
<li>已认证但无权限：使用普通用户 Token 访问管理员接口，应返回 403 禁止访问；</li>
<li>已认证且有权限：使用管理员 Token 访问管理员接口，应返回 200 成功。</li>
</ul>
</li>
<li>修改角色-API 权限映射，调用 <code>Authorizer.ResetPolicies</code> 接口重置策略，验证权限动态更新是否生效。</li>
</ol>
<h4 data-id="heading-32">5.2 常见问题排查</h4>
<ul>
<li>OPA 引擎初始化失败：检查策略文件语法是否正确（可通过 OPA 在线试炼场验证）、内嵌文件路径是否正确；</li>
<li>权限校验不生效：确认中间件顺序（先认证后授权）、白名单配置是否正确、请求输入是否包含 <code>user</code>、<code>role</code> 等策略所需字段；</li>
<li>策略更新不生效：确保修改权限后调用了 <code>ResetPolicies</code> 方法，重新加载策略到 OPA 引擎；</li>
<li>性能问题：启用 OPA 策略缓存（配置 <code>authz.opa.cache</code>），减少重复策略计算。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么电脑需要"内存"和"硬盘"？——存储金字塔的秘密]]></title>    <link>https://juejin.cn/post/7583891046206160948</link>    <guid>https://juejin.cn/post/7583891046206160948</guid>    <pubDate>2025-12-15T11:44:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583891046206160948" data-draft-id="7583921477613273123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么电脑需要&quot;内存&quot;和&quot;硬盘&quot;？——存储金字塔的秘密"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-15T11:44:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么电脑需要"内存"和"硬盘"？——存储金字塔的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T11:44:55.000Z" title="Mon Dec 15 2025 11:44:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">💾 为什么电脑需要"内存"和"硬盘"？——存储金字塔的秘密 🧠</h2>
<blockquote>
<p>大家好，我是无限大，今天又带来最新一期的十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下，你正在厨房做饭：</p>
<ul>
<li>冰箱里存放着各种食材（大米、蔬菜、肉类）🥬🍗</li>
<li>灶台上的砧板放着你正在处理的食材🔪</li>
<li>你手里拿着正在切的菜🤲</li>
</ul>
<p>电脑的存储系统其实和厨房很像！内存就像砧板，硬盘就像冰箱，而CPU就像你这个厨师。今天咱们就来揭开电脑存储的神秘面纱！</p>
<h3 data-id="heading-1">📊 存储金字塔：速度与容量的权衡</h3>
<p>电脑的存储系统是一个"金字塔"结构，越往上速度越快，但容量越小、成本越高；越往下速度越慢，但容量越大、成本越低。</p>















































<table><thead><tr><th>存储层次</th><th>速度</th><th>容量</th><th>成本</th><th>比喻</th></tr></thead><tbody><tr><td>寄存器</td><td>⚡ 最快（纳秒级）</td><td>📏 最小（KB级）</td><td>💰 最贵</td><td>手里的食材</td></tr><tr><td>缓存</td><td>⚡ 很快（纳秒级）</td><td>📏 较小（MB级）</td><td>💰 很贵</td><td>砧板上的食材</td></tr><tr><td>内存</td><td>🚀 快（毫秒级）</td><td>📦 中等（GB级）</td><td>💸 较贵</td><td>厨房台面上的食材</td></tr><tr><td>硬盘</td><td>🐌 慢（秒级）</td><td>📚 大（TB级）</td><td>💰 便宜</td><td>冰箱里的食材</td></tr><tr><td>云存储</td><td>🐢 很慢（网络延迟）</td><td>🌐 无限大</td><td>💸 按需付费</td><td>超市里的食材</td></tr></tbody></table>
<h3 data-id="heading-2">🤔 核心问题：为什么不能只有一种存储设备？</h3>
<p>有人可能会问："既然内存这么快，为什么不把所有存储都做成内存？"或者"既然硬盘这么便宜，为什么不只用硬盘？"</p>
<p>这就像问："既然砧板这么方便，为什么不把厨房都改成砧板？"或者"既然冰箱能装很多东西，为什么还要砧板？"</p>
<p>答案很简单：<strong>速度、容量、成本三者不可兼得</strong>！</p>
<h4 data-id="heading-3">1. 🚀 速度的差异</h4>
<p>内存的速度比硬盘快<strong>1000倍以上</strong>！让我们看一组趣味数据：</p>






























<table><thead><tr><th>存储设备</th><th>读写速度</th><th>访问延迟</th></tr></thead><tbody><tr><td>DDR5内存</td><td>6400MB/s</td><td>约10ns</td></tr><tr><td>NVMe SSD</td><td>7000MB/s</td><td>约100μs</td></tr><tr><td>SATA SSD</td><td>550MB/s</td><td>约500μs</td></tr><tr><td>HDD硬盘</td><td>150MB/s</td><td>约10ms</td></tr></tbody></table>
<p><strong>注意</strong>：虽然NVMe SSD的连续读写速度看起来和DDR5内存差不多，但访问延迟差了10000倍！这就像你去便利店买东西（内存）和去超市买东西（硬盘）——虽然超市单次能买更多，但每次都要花更多时间在路上。</p>
<h4 data-id="heading-4">2. 📦 容量的差异</h4>
<p>硬盘的容量比内存大得多：</p>
<ul>
<li>普通电脑内存：8GB-64GB</li>
<li>普通电脑硬盘：512GB-4TB</li>
<li>专业服务器硬盘：甚至可达100TB以上</li>
</ul>
<p>这就像砧板只能放几道菜，而冰箱能放一周的食材！</p>
<h4 data-id="heading-5">3. 💰 成本的差异</h4>
<p>内存的成本比硬盘高得多：</p>
<ul>
<li>DDR5内存：约10元/GB</li>
<li>NVMe SSD：约1元/GB</li>
<li>HDD硬盘：约0.1元/GB</li>
</ul>
<p>如果把一台电脑的所有存储都换成内存，成本会高到离谱！</p>
<h3 data-id="heading-6">🧠 内存 vs 硬盘：本质区别是什么？</h3>
<h4 data-id="heading-7">内存：电脑的"临时工作台"</h4>
<p>内存（RAM）是电脑的临时存储，就像厨房的砧板：</p>
<ul>
<li><strong>速度快</strong>：CPU能直接访问，延迟极低</li>
<li><strong>易失性</strong>：断电后数据会丢失（就像你切完菜，砧板就空了）</li>
<li><strong>容量小</strong>：通常8GB-64GB</li>
<li><strong>用途</strong>：存放正在运行的程序和数据</li>
</ul>
<h4 data-id="heading-8">硬盘：电脑的"永久仓库"</h4>
<p>硬盘（HDD/SSD）是电脑的永久存储，就像厨房的冰箱：</p>
<ul>
<li><strong>速度慢</strong>：CPU需要通过内存才能访问</li>
<li><strong>非易失性</strong>：断电后数据不会丢失（就像食材放在冰箱里不会坏）</li>
<li><strong>容量大</strong>：通常512GB-4TB</li>
<li><strong>用途</strong>：存放操作系统、程序、文件等长期数据</li>
</ul>
<h3 data-id="heading-9">🔄 电脑是如何使用存储的？</h3>
<p>当你打开一个程序（比如Chrome浏览器）时，电脑会：</p>
<ol>
<li>📥 从硬盘读取Chrome的程序文件到内存</li>
<li>🚀 CPU从内存中读取指令并执行</li>
<li>💾 运行过程中产生的数据暂时存放在内存中</li>
<li>💾 当你保存文件或关闭程序时，数据会写回硬盘</li>
</ol>
<p>这就像你做饭的过程：</p>
<ol>
<li>🥬 从冰箱拿出蔬菜到砧板</li>
<li>🔪 在砧板上切菜</li>
<li>🍳 把切好的菜放进锅里炒</li>
<li>🍽️ 炒好的菜盛到盘子里（相当于保存到硬盘）</li>
</ol>
<h3 data-id="heading-10">📝 代码实例：内存与硬盘的区别</h3>
<p>让我们通过一个简单的Python代码来理解内存和硬盘的区别：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例1：内存操作（快）</span>
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">memory_operation</span>():
    <span class="hljs-comment"># 在内存中创建一个大列表</span>
    start_time = time.time()
    big_list = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000000</span>)]
    <span class="hljs-comment"># 对列表进行操作</span>
    <span class="hljs-built_in">sum</span>(big_list)
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"内存操作耗时：<span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.4</span>f}</span>秒"</span>)

<span class="hljs-comment"># 示例2：硬盘操作（慢）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">disk_operation</span>():
    <span class="hljs-comment"># 写入大文件到硬盘</span>
    start_time = time.time()
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"big_file.txt"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000000</span>):
            f.write(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>\n"</span>)
    <span class="hljs-comment"># 从硬盘读取文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"big_file.txt"</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">as</span> f:
        content = f.read()
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"硬盘操作耗时：<span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.4</span>f}</span>秒"</span>)

<span class="hljs-comment"># 运行测试</span>
memory_operation()  <span class="hljs-comment"># 输出：约0.1秒</span>
<span class="hljs-comment"># disk_operation()  # 输出：约10秒（谨慎运行，会生成大文件）</span>
</code></pre>
<p><strong>运行结果对比</strong>：</p>
<ul>
<li>内存操作：约0.1秒</li>
<li>硬盘操作：约10秒</li>
</ul>
<p>这就是为什么电脑需要内存——如果所有操作都直接在硬盘上进行，你的电脑会慢得像蜗牛！🐌</p>
<h3 data-id="heading-11">📜 存储设备的"进化史"</h3>
<h4 data-id="heading-12">1. 📀 软盘时代：从5.25英寸到3.5英寸</h4>
<p>20世纪70年代，软盘是电脑的主要存储设备。最早的软盘是5.25英寸，容量只有360KB——只能存一篇短文章！后来进化到3.5英寸软盘，容量提升到1.44MB。</p>
<p>还记得那些带着"A盘"和"B盘"的电脑吗？那时候安装软件要插十几张软盘，不小心插错顺序就得重来！💾</p>
<h4 data-id="heading-13">2. 💿 硬盘时代：从MB到TB</h4>
<p>1956年，IBM推出了世界上第一台硬盘，容量只有5MB，却有一个冰箱那么大！后来硬盘技术不断进步：</p>
<ul>
<li>1980年：IBM XT硬盘，10MB</li>
<li>1990年：希捷硬盘，1GB</li>
<li>2000年：迈拓硬盘，100GB</li>
<li>2010年：西部数据硬盘，1TB</li>
<li>2020年：希捷硬盘，18TB</li>
</ul>
<h4 data-id="heading-14">3. ⚡ SSD革命：从机械到固态</h4>
<p>2007年，苹果在MacBook Air上首次使用SSD，标志着固态硬盘时代的到来。SSD（固态硬盘）没有机械部件，读写速度比HDD（机械硬盘）快得多：</p>








































<table><thead><tr><th>特性</th><th>HDD（机械硬盘）</th><th>SSD（固态硬盘）</th></tr></thead><tbody><tr><td>原理</td><td>机械磁头+盘片</td><td>闪存芯片</td></tr><tr><td>速度</td><td>100-200MB/s</td><td>550MB/s（SATA）- 7000MB/s（NVMe）</td></tr><tr><td>噪音</td><td>📣 有噪音（机械转动）</td><td>🤫 无噪音</td></tr><tr><td>抗震性</td><td>❌ 怕震动</td><td>✅ 抗震</td></tr><tr><td>功耗</td><td>高</td><td>低</td></tr><tr><td>寿命</td><td>3-5年</td><td>5-10年</td></tr></tbody></table>
<h4 data-id="heading-15">4. ☁️ 云存储时代：无限容量</h4>
<p>随着网络技术的发展，云存储成为了新的选择。你可以把文件存到云端，随时随地访问。云存储的优势是：</p>
<ul>
<li>🌐 无限容量（按需付费）</li>
<li>📱 跨设备访问</li>
<li>🛡️ 数据备份和恢复</li>
<li>📤 方便分享</li>
</ul>
<p>但云存储也有缺点：</p>
<ul>
<li>🐌 受网络速度限制</li>
<li>💰 需要持续付费</li>
<li>🔒 隐私和安全 concerns</li>
</ul>
<h3 data-id="heading-16">🧩 缓存：内存和CPU之间的"加速带"</h3>
<p>除了内存和硬盘，还有一个重要的存储层次——<strong>缓存</strong>！缓存是CPU和内存之间的"加速带"，速度比内存还快。</p>
<p>缓存分为三级：</p>
<ul>
<li><strong>L1缓存</strong>：最快，容量最小（KB级），集成在CPU内部</li>
<li><strong>L2缓存</strong>：较快，容量中等（MB级），也集成在CPU内部</li>
<li><strong>L3缓存</strong>：较慢，容量较大（MB级），可能共享多个核心</li>
</ul>
<p>CPU访问数据的顺序是：L1缓存 → L2缓存 → L3缓存 → 内存 → 硬盘。这就像你找东西的顺序：口袋 → 桌面 → 抽屉 → 柜子 → 仓库！</p>
<h3 data-id="heading-17">🎯 存储优化：让电脑跑得更快</h3>
<p>了解了存储层次，我们可以通过一些方法优化电脑性能：</p>
<h4 data-id="heading-18">1. 🚀 增加内存容量</h4>
<p>如果你的电脑经常卡顿，尤其是同时打开多个程序时，增加内存容量是最有效的优化方法之一。</p>
<p><strong>推荐内存容量</strong>：</p>
<ul>
<li>日常办公：8GB</li>
<li>游戏和设计：16GB-32GB</li>
<li>专业工作站：64GB以上</li>
</ul>
<h4 data-id="heading-19">2. ⚡ 升级到SSD</h4>
<p>把机械硬盘换成SSD，电脑的启动速度和程序加载速度会有质的飞跃！</p>
<p><strong>升级建议</strong>：</p>
<ul>
<li>系统盘：NVMe SSD（速度最快）</li>
<li>数据盘：SATA SSD或大容量HDD</li>
</ul>
<h4 data-id="heading-20">3. 💾 合理分配存储</h4>
<ul>
<li>把操作系统和常用程序安装在SSD上</li>
<li>把大文件（视频、照片）存放在HDD或云存储上</li>
<li>定期清理硬盘，删除不需要的文件</li>
</ul>
<h4 data-id="heading-21">4. 📊 监控存储使用</h4>
<p>使用系统工具监控内存和硬盘使用情况，及时发现问题：</p>
<ul>
<li>Windows：任务管理器 → 性能标签</li>
<li>macOS：活动监视器 → 内存/磁盘标签</li>
<li>Linux：htop或free/df命令</li>
</ul>
<h3 data-id="heading-22">🎓 互动小测验：你答对了吗？</h3>
<p>来测试一下你对存储系统的了解：</p>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>内存的速度比硬盘快多少倍？</td><td>1000倍以上</td><td>✅/❌</td></tr><tr><td>断电后，内存中的数据会丢失吗？</td><td>会</td><td>✅/❌</td></tr><tr><td>SSD的读写速度可达多少？</td><td>7000MB/s</td><td>✅/❌</td></tr><tr><td>存储金字塔中，速度最快的是？</td><td>寄存器</td><td>✅/❌</td></tr><tr><td>缓存分为几级？</td><td>三级（L1/L2/L3）</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-23">🔮 未来存储技术：更快、更大、更便宜</h3>
<p>未来的存储技术会朝哪个方向发展？</p>
<h4 data-id="heading-24">1. 💾 3D NAND：堆叠更多层</h4>
<p>3D NAND技术可以把闪存芯片堆叠得更高，从而提高容量、降低成本。目前已经可以堆叠200多层，未来可能达到1000层以上！</p>
<h4 data-id="heading-25">2. 🚀 PCIe 5.0/6.0：更快的接口</h4>
<p>PCIe 5.0 SSD的速度已经达到14000MB/s，PCIe 6.0更是能达到28000MB/s，比现在的NVMe SSD快4倍！</p>
<h4 data-id="heading-26">3. 🧬 相变内存（PCM）：内存和硬盘的结合</h4>
<p>相变内存是一种新型存储技术，既有内存的速度，又有硬盘的非易失性。未来可能会取代传统内存和硬盘，实现"统一存储"！</p>
<h4 data-id="heading-27">4. ☁️ 边缘计算：云存储的延伸</h4>
<p>随着5G和边缘计算的发展，云存储会变得更快、更普及。未来你的电脑可能只需要很少的本地存储，大部分数据都存放在云端！</p>
<h3 data-id="heading-28">🎯 结语：存储金字塔的智慧</h3>
<p>电脑的存储系统就像一个"金字塔"，不同的存储设备各司其职，共同构成了高效的存储体系。内存负责速度，硬盘负责容量，它们缺一不可！</p>
<p>下次当你打开电脑，看到程序快速加载时，别忘了感谢内存的高速；当你保存文件时，别忘了感谢硬盘的可靠。它们就像一对默契的搭档，让你的电脑跑得又快又稳！</p>
<hr/>
<h3 data-id="heading-29">💬 互动话题</h3>
<ol>
<li>你的电脑内存和硬盘容量是多少？够用吗？</li>
<li>你有没有经历过从HDD升级到SSD的"速度飞跃"？</li>
<li>你觉得未来的电脑还需要硬盘吗？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一种基于 Service Worker 的渐进式渲染方案的基本原理]]></title>    <link>https://juejin.cn/post/7583727768544346148</link>    <guid>https://juejin.cn/post/7583727768544346148</guid>    <pubDate>2025-12-15T12:01:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583727768544346148" data-draft-id="7583898823920828458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一种基于 Service Worker 的渐进式渲染方案的基本原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-15T12:01:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明远湖之鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2370998127573751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一种基于 Service Worker 的渐进式渲染方案的基本原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2370998127573751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明远湖之鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:01:16.000Z" title="Mon Dec 15 2025 12:01:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>笔者前面发过两篇关于流式SSR的文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7575090551357407284" target="_blank" title="https://juejin.cn/post/7575090551357407284">浅入理解流式SSR的性能收益与工作原理</a></li>
<li><a href="https://juejin.cn/post/7492119684047962121" target="_blank" title="https://juejin.cn/post/7492119684047962121">在H5页面的SSR中，客户端需要做哪些工作？</a></li>
</ul>
<p>流式SSR就是一种渐进式渲染，在传统的页面加载流程是：<strong>请求 → 等待 → 渲染</strong>。而渐进式渲染的思路是：</p>
<ol>
<li><strong>立即展示</strong>缓存的页面快照（即使是旧内容）</li>
<li><strong>后台请求</strong>最新的页面内容</li>
<li><strong>无缝替换</strong>为最新内容</li>
</ol>
<p>这样用户感知到的加载时间接近于零，体验类似于原生 App。</p>
<p>前面笔者的文章中，提到关于H5页面的快照是客户端做的。本篇文章讲述一种基于 Service Worker 的渐进式渲染方案的原理，简单来讲就是将客户端的工作挪到了service worker中。通过给站点开启一个后台运行的service worker（service worker可以独立于webview运行在后台），在service worker中劫持包括主文档在内的网络请求，对文档内容进行存储，并修改返回。</p>
<h2 data-id="heading-1">技术方案设计</h2>
<h3 data-id="heading-2">整体架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────┐
│  用户访问    │
└──────┬──────┘
<span class="hljs-code">       │
       ▼
┌─────────────────┐
│ Service Worker  │ ◄─── 拦截请求
└────┬────────┬───┘
     │        │
     │        └─────────┐
     ▼                  ▼
┌─────────┐      ┌──────────┐
│ 缓存快照 │      │ 网络请求  │
└────┬────┘      └─────┬────┘
     │                 │
     └────────┬────────┘
              ▼
       ┌─────────────┐
       │  流式替换    │
       └─────────────┘
</span></code></pre>
<h3 data-id="heading-3">核心代码实现</h3>
<h4 data-id="heading-4">1. HTML 页面注册 Service Worker</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>渐进式渲染示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">data-snapshot</span>&gt;</span><span class="javascript">
    (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> swEnabled = location.<span class="hljs-property">search</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'x-sw=false'</span>) &lt; <span class="hljs-number">0</span>;

      <span class="hljs-comment">// 注册 Service Worker</span>
      swEnabled &amp;&amp; navigator.<span class="hljs-property">serviceWorker</span> &amp;&amp; navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">registration</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功:'</span>, registration);
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册失败:'</span>, error);
        });

      <span class="hljs-comment">// 如果禁用，则注销 Service Worker</span>
      !swEnabled &amp;&amp; navigator.<span class="hljs-property">serviceWorker</span> &amp;&amp; navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">getRegistration</span>(location.<span class="hljs-property">href</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> {
        r &amp;&amp; r.<span class="hljs-title function_">unregister</span>();
      });
    }());
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>关键点说明：</strong></p>
<ul>
<li><code>data-snapshot</code> 属性标记这是快照阶段需要保留的脚本</li>
<li>支持通过 <code>?x-sw=false</code> 参数禁用 Service Worker</li>
<li>禁用时会自动注销已注册的 Service Worker</li>
</ul>
<h4 data-id="heading-5">2. Service Worker 核心逻辑</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sw.js</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 只拦截主文档请求</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">destination</span> !== <span class="hljs-string">'document'</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 支持禁用功能</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'x-sw=false'</span>) &gt;= <span class="hljs-number">0</span>) {
    event.<span class="hljs-title function_">waitUntil</span>(caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'my-cache'</span>));
    <span class="hljs-keyword">return</span>;
  }

  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleFetch</span>(event.<span class="hljs-property">request</span>));
});

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 安装'</span>);
  self.<span class="hljs-title function_">skipWaiting</span>(); <span class="hljs-comment">// 立即激活</span>
});
</code></pre>
<h4 data-id="heading-6">3. 脚本过滤策略</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">replaceScripts</span>(<span class="hljs-params">text, regularStream</span>) {
  <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi</span>, <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> {
    <span class="hljs-comment">// 快照阶段：只保留 data-snapshot 脚本</span>
    <span class="hljs-comment">// 正式阶段：只保留普通脚本</span>
    <span class="hljs-keyword">if</span> (match.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'data-snapshot'</span>) &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> regularStream ? <span class="hljs-string">''</span> : match;
    }
    <span class="hljs-keyword">return</span> regularStream ? match : <span class="hljs-string">''</span>;
  });
}
</code></pre>
<p><strong>为什么要过滤脚本？</strong></p>
<ul>
<li>快照阶段：避免执行业务逻辑脚本（可能依赖未加载的资源）</li>
<li>正式阶段：避免重复执行初始化脚本</li>
</ul>
<h4 data-id="heading-7">4. 流式渲染核心</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withSnapshot</span>(<span class="hljs-params">snapshot, request</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadableStream</span>({
    <span class="hljs-title function_">start</span>(<span class="hljs-params">controller</span>) {
      <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
      <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
      
      <span class="hljs-comment">// 第一步：立即输出快照</span>
      controller.<span class="hljs-title function_">enqueue</span>(encoder.<span class="hljs-title function_">encode</span>(snapshot));

      <span class="hljs-keyword">let</span> firstStream = <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 第二步：请求最新内容</span>
      <span class="hljs-title function_">fetchAndStore</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">push</span>(<span class="hljs-params"/>) {
          reader.<span class="hljs-title function_">read</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ done, value }</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (done) {
              controller.<span class="hljs-title function_">close</span>();
              <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">if</span> (firstStream) {
              firstStream = <span class="hljs-literal">false</span>;
              
              <span class="hljs-comment">// 第三步：清空页面</span>
              controller.<span class="hljs-title function_">enqueue</span>(encoder.<span class="hljs-title function_">encode</span>(
                <span class="hljs-string">'&lt;script&gt;document.head.innerHTML = "";document.body.innerHTML = "";&lt;/script&gt;'</span>
              ));

              <span class="hljs-comment">// 第四步：注入最新内容</span>
              <span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(value);
              <span class="hljs-keyword">const</span> head = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;head&gt;([\s\S]*?)&lt;\/head&gt;/i</span>);
              <span class="hljs-keyword">const</span> body = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;body&gt;([\s\S]*?)&lt;\/body&gt;/i</span>);

              <span class="hljs-keyword">if</span> (head &amp;&amp; body) {
                controller.<span class="hljs-title function_">enqueue</span>(encoder.<span class="hljs-title function_">encode</span>(
                  <span class="hljs-string">`&lt;script&gt;document.head.innerHTML = '<span class="hljs-subst">${head[<span class="hljs-number">1</span>].trim().replace(/\n/g, <span class="hljs-string">''</span>)}</span>'&lt;/script&gt;`</span>
                ));
                controller.<span class="hljs-title function_">enqueue</span>(encoder.<span class="hljs-title function_">encode</span>(<span class="hljs-title function_">replaceScripts</span>(body[<span class="hljs-number">1</span>], <span class="hljs-literal">true</span>)));
              }
            } <span class="hljs-keyword">else</span> {
              controller.<span class="hljs-title function_">enqueue</span>(value);
            }
            <span class="hljs-title function_">push</span>();
          });
        }

        <span class="hljs-title function_">push</span>();
      });
    },
  }));
}
</code></pre>
<p><strong>为什么要清空 DOM？</strong></p>
<ul>
<li>快照内容和最新内容可能结构不同</li>
<li>直接追加会导致内容重复</li>
<li>清空后重新注入，确保页面状态一致</li>
</ul>
<p><strong>为什么用 innerHTML 注入？</strong></p>
<ul>
<li>流式响应中，我们无法直接操作 DOM</li>
<li>只能通过推送 <code>&lt;script&gt;</code> 标签让浏览器执行 JavaScript</li>
<li><code>innerHTML</code> 是最简单的 DOM 替换方式</li>
</ul>
<h4 data-id="heading-8">5. 缓存管理</h4>
<p><strong>Service Worker 的缓存存储在 Cache Storage API 中，这是浏览器提供的专门用于 Service Worker 的持久化存储空间。实际上，不需要关心物理位置，因为浏览器完全管理这些文件。</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchAndStore</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(request)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">networkResponse</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (networkResponse.<span class="hljs-property">ok</span>) {
        <span class="hljs-comment">// 克隆响应用于缓存</span>
        <span class="hljs-keyword">const</span> cacheResponse = networkResponse.<span class="hljs-title function_">clone</span>();
        caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'my-cache'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">cache</span>) =&gt;</span> {
          cache.<span class="hljs-title function_">put</span>(request, cacheResponse);
        });
      }
      <span class="hljs-keyword">return</span> networkResponse;
    });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFetch</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(request)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (response) {
        <span class="hljs-comment">// 有缓存：先展示快照，再更新</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">readResponseText</span>(response).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">snapshot</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">withSnapshot</span>(snapshot, request);
        });
      }
      <span class="hljs-comment">// 无缓存：直接请求</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchAndStore</span>(request);
    });
}
</code></pre>
<p><strong>为什么要 clone 响应？</strong></p>
<ul>
<li>Response 对象的 body 只能读取一次（流的特性）</li>
<li>需要一份给缓存，一份给浏览器</li>
<li><code>clone()</code> 创建独立的副本</li>
</ul>
<h3 data-id="heading-9">工作流程详解</h3>
<p><strong>首次访问（无缓存）</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户访问 → Service Worker 拦截 → 无缓存 → 网络请求 → 返回内容 → 存入缓存
</code></pre>
<p><strong>二次访问（有缓存）</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户访问
  ↓
Service Worker 拦截
  ↓
读取缓存快照（去除普通脚本）
  ↓
立即返回快照内容 ← 用户看到页面
  ↓
后台发起网络请求
  ↓
清空 DOM
  ↓
注入最新 <span class="hljs-built_in">head</span> 和 body
  ↓
更新缓存
</code></pre>
<h2 data-id="heading-10">注意事项</h2>
<p>上述只讲述了该方案的基本原理，实际应用要考虑更多的因素如App 环境兼容性、缓存策略、基础设施依赖等，下面是方案对比：</p>













































<table><thead><tr><th>维度</th><th>客户端方案</th><th>Service Worker 方案</th></tr></thead><tbody><tr><td><strong>首次访问拦截</strong></td><td>✅ 可以拦截</td><td>❌ 无法拦截</td></tr><tr><td><strong>跨平台能力</strong></td><td>❌ 需要各端适配</td><td>✅ Web 标准，通用</td></tr><tr><td><strong>更新速度</strong></td><td>⚠️ 需要发版</td><td>✅ 实时生效</td></tr><tr><td><strong>开发成本</strong></td><td>⚠️ 需要端上开发</td><td>⚠️ 需要 Web 开发</td></tr><tr><td><strong>维护成本</strong></td><td>❌ 多端维护</td><td>✅ 单一维护</td></tr><tr><td><strong>灵活性</strong></td><td>⚠️ 受限于客户端版本</td><td>✅ 完全可控</td></tr><tr><td><strong>降级能力</strong></td><td>⚠️ 需要发版回滚</td><td>✅ 秒级降级</td></tr></tbody></table>
<p>总结：</p>
<ul>
<li>如果你的业务是纯 Web 应用（PWA) → Service Worker 是最佳选择</li>
<li>如果你的业务在 App 内 → 优先考虑客户端方案</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F337624473" target="_blank" title="https://zhuanlan.zhihu.com/p/337624473" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/337624473</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（11） Netty的心跳机制是什么？为什么需要它？]]></title>    <link>https://juejin.cn/post/7583799807594283042</link>    <guid>https://juejin.cn/post/7583799807594283042</guid>    <pubDate>2025-12-15T12:01:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583799807594283042" data-draft-id="7583891046206193716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（11） Netty的心跳机制是什么？为什么需要它？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-15T12:01:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（11） Netty的心跳机制是什么？为什么需要它？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T12:01:02.000Z" title="Mon Dec 15 2025 12:01:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Netty的心跳机制是一种用于保持长连接的机制，它通过定期发送心跳消息来检测连接的状态，并确保连接保持活跃。心跳机制可以用于检测网络故障、断开连接和超时等问题，并采取相应的处理措施。</p>
<p>为什么需要心跳机制呢？有以下几个原因：</p>
<ol>
<li>
<p>检测连接状态：通过定期发送心跳消息，可以检测连接是否仍然活跃。如果长时间没有收到心跳响应，就可以判断连接可能已经断开或发生了故障。</p>
</li>
<li>
<p>防止连接超时：在一些网络环境中，可能存在连接空闲时间过长的情况，比如防火墙、代理服务器等。通过发送心跳消息，可以保持连接的活跃状态，避免连接被防火墙或代理服务器关闭。</p>
</li>
<li>
<p>优化网络性能：心跳消息通常是很小的数据包，相对于业务数据来说，它的传输开销较小。通过定期发送心跳消息，可以保持连接的活跃状态，减少连接建立和关闭的开销，从而提高网络性能。</p>
</li>
</ol>
<p>下面是一个使用Netty实现心跳机制的示例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleState;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateEvent;
<span class="hljs-keyword">import</span> io.netty.handler.timeout.IdleStateHandler;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatClient</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HeartbeatClient</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
                    .channel(NioSocketChannel.class)
                    .option(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>)
                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleStateHandler</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, TimeUnit.SECONDS));
                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HeartbeatHandler</span>());
                        }
                    });

            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.connect(host, port).sync();
            f.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8080</span>;
        <span class="hljs-type">HeartbeatClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeartbeatClient</span>(host, port);
        client.run();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">HEARTBEAT_MESSAGE</span> <span class="hljs-operator">=</span> Unpooled.unreleasableBuffer(Unpooled.copiedBuffer(<span class="hljs-string">"Heartbeat"</span>, CharsetUtil.UTF_8));

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userEventTriggered</span><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">instanceof</span> IdleStateEvent) {
            <span class="hljs-type">IdleStateEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> (IdleStateEvent) evt;
            <span class="hljs-keyword">if</span> (event.state() == IdleState.WRITER_IDLE) {
                ctx.writeAndFlush(HEARTBEAT_MESSAGE);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">super</span>.userEventTriggered(ctx, evt);
        }
    }
}
</code></pre>
<p>在上面的示例中，我们创建了一个HeartbeatClient类，它负责启动客户端并实现心跳机制。在run()方法中，我们使用NioEventLoopGroup创建了一个EventLoopGroup，用于处理客户端的I/O操作。</p>
<p>然后，我们使用Bootstrap来配置客户端。我们指定了客户端的通道类型为NioSocketChannel，并设置了SO_KEEPALIVE选项为true，以保持长连接。我们还添加了一个IdleStateHandler，用于检测连接的空闲状态。</p>
<p>在HeartbeatHandler中，我们继承ChannelInboundHandlerAdapter，并重写了userEventTriggered()方法。在该方法中，我们根据IdleStateEvent的状态来判断是否发送心跳消息。如果连接处于写空闲状态，即长时间没有写操作，我们就发送一个心跳消息。</p>
<p>通过使用IdleStateHandler和HeartbeatHandler，我们可以实现客户端的心跳机制，定期发送心跳消息以保持连接的活跃状态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>