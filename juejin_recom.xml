<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Flutter&TolyUI#12 | 树形组件 toly_tree 重磅推出!]]></title>    <link>https://juejin.cn/post/7583499967237259298</link>    <guid>https://juejin.cn/post/7583499967237259298</guid>    <pubDate>2025-12-15T01:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583499967237259298" data-draft-id="7583507286317694976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter&amp;TolyUI#12 | 树形组件 toly_tree 重磅推出!"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-15T01:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter&amp;TolyUI#12 | 树形组件 toly_tree 重磅推出!
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T01:46:17.000Z" title="Mon Dec 15 2025 01:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1b2f7d2ec8b4ca0ac1b5feadf97637b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=800&amp;h=450&amp;s=33895&amp;e=jpg&amp;b=031126" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">《Flutter TolyUI 框架》系列前言:</h4>
<p><strong>TolyUI</strong> 是 <a href="https://juejin.cn/user/149189281194766" target="_blank" title="https://juejin.cn/user/149189281194766">张风捷特烈</a> 打造的 Fluter 全平台应用开发 UI 框架。具备 <strong>全平台</strong>、<strong>组件化</strong>、<strong>源码开放</strong>、<strong>响应式</strong> 四大特点。可以帮助开发者迅速构建具有响应式全平台应用软件：</p>
<blockquote>
<p>开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de8c6bed9bfe46b3865accea7d493d4c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1563&amp;h=409&amp;s=62505&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-1">1. 设计动机</h4>
<p>在现代应用开发中，树形结构是一种极其常见的数据展示方式。无论是文件管理器的目录结构、组织架构图、分类导航，还是权限配置界面，都需要以层级关系来组织和展示信息。然而，构建一个功能完善、性能优良的树形组件并非易事，需要考虑数据绑定、状态管理、虚拟滚动、异步加载等多个方面。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97c2085606b1406a96d571f407483e65~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=867&amp;h=313&amp;s=44377&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>TolyUI 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Ftolyui_tree" target="_blank" title="https://pub.dev/packages/tolyui_tree" ref="nofollow noopener noreferrer">tolyui_tree</a> 模块正是为了解决这些痛点而设计。它不仅提供了基础的树形展示能力，还支持选择交互、自定义数据结构、大数据量处理、异步加载等高级功能，让开发者能够轻松构建出专业级的树形界面。</p>
<p>使用者可以独立引入模块包，或者使用 tolyui 全家桶：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 仅使用 tolyui_tree</span>
<span class="hljs-attr">dependencies:</span> 
   <span class="hljs-attr">tolyui_tree:</span> <span class="hljs-string">^last_version</span>

<span class="hljs-comment"># 使用 tolyui 全家桶 </span>
<span class="hljs-attr">dependencies:</span> 
    <span class="hljs-attr">tolyui:</span> <span class="hljs-string">^last_version</span>
</code></pre>
<hr/>
<h4 data-id="heading-2">1. 基础树形</h4>
<p>树形组件的核心功能是展示层级数据结构。<strong>TolyTree</strong> 组件通过递归渲染实现层级嵌套，支持节点的展开收起操作。</p>
<ul>
<li>左侧演示文件目录结构，</li>
<li>右侧展示带连接线的学科分类树。</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86b96e2b3556433e8b347a3f044292d9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=482058&amp;e=gif&amp;f=113&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>通过递归渲染实现无限层级嵌套，点击节点前的展开图标可以控制子节点的显示隐藏。这种结构常用于文件管理器、组织架构图、分类导航等需要层级展示的场景。</p>
<ul>
<li><code>showConnectingLines</code> 属性可以显示节点间的连接线，让层级关系更加清晰直观。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;<span class="hljs-built_in">String</span>&gt;(
  nodes: _treeData.map(TreeNode&lt;<span class="hljs-built_in">String</span>&gt;.fromMap).toList(),
  nodeBuilder: (node) =&gt; Padding(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8.0</span>),
    child: Text(node.data),
  ),
)

<span class="hljs-comment">// 带连接线的树形</span>
TolyTree&lt;<span class="hljs-built_in">String</span>&gt;(
  showConnectingLines: <span class="hljs-keyword">true</span>,
  nodes: natureScienceTree.map(TreeNode&lt;<span class="hljs-built_in">String</span>&gt;.fromMap).toList(),
  nodeBuilder: (node) =&gt; Padding(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8.0</span>),
    child: Text(node.data),
  ),
)
</code></pre>
<hr/>
<p>树形的节点是 <code>TreeNode</code>,支持泛型数据，数据结构如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreeNode</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> T data;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;TreeNode&lt;T&gt;&gt; children;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> selectable;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool?</span> isLeaf;
  <span class="hljs-built_in">bool</span> isExpanded;
  <span class="hljs-built_in">bool</span> isSelected;
  <span class="hljs-built_in">bool</span> isLoading;
  <span class="hljs-built_in">int</span> level;
</code></pre>
<p>为了便于构造树形结构，为 <code>TreeNode</code> 支持了 <code>fromMap</code> 方法，支持如下所示的 json 结构。这样便于通过接口下发树形的结构数据：</p>
<pre><code class="hljs language-dart" lang="dart">{
  <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1'</span>,
  <span class="hljs-string">'data'</span>: <span class="hljs-string">'数学 Mathematics'</span>,
  <span class="hljs-string">'children'</span>: [
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'代数 Algebra'</span>,
      <span class="hljs-string">'children'</span>: [
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-1'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'线性代数 Linear Algebra'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'抽象代数 Abstract Algebra'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-3'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'群论 Group Theory'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
      ],
    },
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'分析 Analysis'</span>,
      <span class="hljs-string">'children'</span>: [
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-1'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'微积分 Calculus'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'实分析 Real Analysis'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-3'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'复分析 Complex Analysis'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
      ],
    },
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'几何 Geometry'</span>,
      <span class="hljs-string">'children'</span>: [
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-1'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'欧几里得几何 Euclidean Geometry'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'微分几何 Differential Geometry'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-3'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'拓扑学 Topology'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
      ],
    },
  ],
},
</code></pre>
<hr/>
<h4 data-id="heading-3">2. 可选择树形</h4>
<p>在权限配置、分类选择等场景中，树形组件需要支持选择功能。<strong>TolyTreeSelector</strong> 提供了完整的三态选择能力。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e2e959175c84659b1883c40142badca~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=295284&amp;e=gif&amp;f=118&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>展示支持三态选择的树形组件。点击复选框可以选中或取消选中节点，父节点的选中状态会自动影响所有子节点。当子节点部分选中时，父节点会显示为半选中状态。右侧实时显示已选中的节点数量和标签列表。组件还支持设置某些节点为不可选中状态，这些节点会以灰色显示且无法被选中。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TreeDemo2State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TreeDemo2</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;TreeNode&lt;<span class="hljs-built_in">String</span>&gt;&gt; _nodes = [];
  <span class="hljs-built_in">List</span>&lt;TreeNode&lt;<span class="hljs-built_in">String</span>&gt;&gt; _selectedNodes = [];

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Row(
      children: [
        SizedBox(
          width: <span class="hljs-number">300</span>,
          child: TolyTreeSelector&lt;<span class="hljs-built_in">String</span>&gt;(
            nodes: _nodes,
            onSelectionChanged: (selectedNodes) {
              setState(() {
                _selectedNodes = selectedNodes;
              });
            },
          ),
        ),
        SizedBox(
          width: <span class="hljs-number">300</span>,
          child: Column(
            children: [
              Text(<span class="hljs-string">'已选择: <span class="hljs-subst">${_selectedNodes.length}</span>'</span>),
              Wrap(
                children: _selectedNodes
                    .map((n) =&gt; TolyTag(child: Text(n.data)))
                    .toList(),
              ),
            ],
          ),
        ),
      ],
    );
  }
}
</code></pre>
<p>这种交互模式常用于权限管理、分类选择、数据筛选等需要多选操作的场景。</p>
<hr/>
<h4 data-id="heading-4">3. 自定义数据结构</h4>
<p>对于复杂的业务场景，往往需要展示更丰富的节点信息。TolyTree 支持自定义数据类型，提供类型安全的数据访问。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89f8ca156a0943c4a248d4aa7c4f7672~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=861383&amp;e=gif&amp;f=87&amp;b=fdfdfb" alt="" loading="lazy"/></p>
<p>展示如何使用自定义数据类型构建树形组件。比如下面通过 <strong>FileMeta</strong> 类封装文件信息，包含名称、类型、图标、颜色、大小和更新时间等属性。每个节点根据文件类型显示不同的图标和颜色，文件夹显示子项数量，文件显示大小和修改日期。点击节点会在控制台输出详细信息，包括节点类型、层级和子项情况。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileMeta</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> type;
  <span class="hljs-keyword">final</span> IconData icon;
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> size;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> updateTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> fileCount;

  <span class="hljs-keyword">const</span> FileMeta({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.icon,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">this</span>.size,
    <span class="hljs-keyword">this</span>.updateTime,
    <span class="hljs-keyword">this</span>.fileCount,
  });

  <span class="hljs-keyword">factory</span> FileMeta.fromJson(<span class="hljs-built_in">dynamic</span> json) {
    <span class="hljs-keyword">return</span> FileMeta(
      name: json[<span class="hljs-string">'name'</span>] ?? <span class="hljs-string">''</span>,
      type: json[<span class="hljs-string">'type'</span>] ?? <span class="hljs-string">'file'</span>,
      icon: _getIconFromType(json[<span class="hljs-string">'type'</span>]),
      color: _getColorFromType(json[<span class="hljs-string">'type'</span>]),
      size: json[<span class="hljs-string">'size'</span>],
      updateTime: json[<span class="hljs-string">'updateTime'</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">'updateTime'</span>]) : <span class="hljs-keyword">null</span>,
      fileCount: json[<span class="hljs-string">'fileCount'</span>],
    );
  }
}
</code></pre>
<p>同样使用 <code>TreeNode&lt;FileMeta&gt;.fromMap</code> 构造，自定义的数据类型解析可以使用 <code>dataParser</code> 回调处理：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">List</span>&lt;TreeNode&lt;FileMeta&gt;&gt; _buildSampleData() {
  <span class="hljs-keyword">return</span> _backendData
      .map((map) =&gt;
          TreeNode&lt;FileMeta&gt;.fromMap(map, dataParser: FileMeta.fromJson))
      .toList();
}
</code></pre>
<p>这种方式提供了类型安全的数据访问和更丰富的展示效果，适用于文件管理、资源浏览等需要详细信息展示的场景。</p>
<hr/>
<h4 data-id="heading-5">4. 虚拟滚动树形</h4>
<p>当处理大量数据时，性能成为关键考虑因素。TolyTree 支持虚拟滚动模式，只渲染可见区域的节点。展示大数据量下的虚拟滚动树形组件。本案例包含 60,000 个节点，通过设置固定高度启用虚拟滚动模式。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b630858aa1c4369bb58d7a9ced04b5c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=992051&amp;e=gif&amp;f=176&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>组件只会渲染可见区域内的节点，大幅提升性能和流畅度。支持完整的展开收起交互，在滚动过程中保持节点状态。点击某些节点时会动态加载新的子节点。</p>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;YourType&gt;(
    height: <span class="hljs-number">300</span>, <span class="hljs-comment">// 启用虚拟滚动</span>
    <span class="hljs-comment">// 其他同理...</span>
)
</code></pre>
<p>这种模式适用于大型数据库浏览、文件系统管理、组织架构展示等需要处理大量层级数据的场景。</p>
<hr/>
<h4 data-id="heading-6">5. 异步加载树形</h4>
<p>对于动态数据源，树形组件需要支持按需加载。TolyTree 提供了完整的异步加载能力。展示支持异步加载子节点的树形组件。如下案例中：初始状态下只显示根节点，带有"点击加载"提示的节点可以展开加载子内容。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63556c19c46a48eda0e06073e7052da1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=859902&amp;e=gif&amp;f=229&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>点击这些节点时会显示加载动画，模拟 2 秒的网络请求过程，然后动态渲染新的子节点。不同的节点会返回不同的子内容，有些子节点还可以继续异步加载更深层级的内容。</p>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;_AsyncData&gt;(
  nodes: _buildInitialData(),
  loadData: _loadChildren,
  nodeBuilder: (node) =&gt; Container(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>, horizontal: <span class="hljs-number">8</span>),
    child: Row(
      children: [
        Icon(node.data.icon, size: <span class="hljs-number">16</span>, color: node.data.color),
        <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">8</span>),
        Text(node.data.name),
        <span class="hljs-keyword">if</span> (node.isLeaf == <span class="hljs-keyword">null</span> &amp;&amp; node.children.isEmpty)
          <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'(点击加载)'</span>, style: TextStyle(fontSize: <span class="hljs-number">12</span>, color: Colors.grey)),
      ],
    ),
  ),
)

Future&lt;<span class="hljs-built_in">List</span>&lt;TreeNode&lt;_AsyncData&gt;&gt;&gt; _loadChildren(TreeNode&lt;_AsyncData&gt; node) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 模拟网络延迟</span>
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
  
  <span class="hljs-keyword">switch</span> (node.id) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'1'</span>:
      <span class="hljs-keyword">return</span> [
        TreeNode&lt;_AsyncData&gt;(
          id: <span class="hljs-string">'1-1'</span>,
          data: <span class="hljs-keyword">const</span> _AsyncData(name: <span class="hljs-string">'系统文件'</span>, icon: Icons.folder, color: Colors.red),
        ),
        TreeNode&lt;_AsyncData&gt;(
          id: <span class="hljs-string">'1-2'</span>,
          data: <span class="hljs-keyword">const</span> _AsyncData(name: <span class="hljs-string">'应用程序'</span>, icon: Icons.folder, color: Colors.green),
        ),
      ];
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> [];
  }
}
</code></pre>
<p>这种模式适用于大型数据集、远程文件系统、API 数据浏览等需要按需加载的场景。</p>
<hr/>
<h4 data-id="heading-7">6. 动画曲线树形</h4>
<p>为了提升用户体验，TolyTree 支持自定义动画效果。通过不同的动画曲线，可以创造出个性化的交互体验。如下案例中，四个区域分别展示线性动画、缓入缓出、弹性效果和回弹效果四种不同的动画曲线。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b710e638a7748238f199367d4f4d31a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=665874&amp;e=gif&amp;f=127&amp;b=fdfdfb" alt="" loading="lazy"/></p>
<ul>
<li><code>animationDuration</code> 可以设置动画时长</li>
<li><code>animationCurve</code> 可以设置动画曲线效果</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Widget _buildCurveSection(<span class="hljs-built_in">String</span> title, Curve curve) {
  <span class="hljs-keyword">return</span> Column(
    children: [
      Text(title),
      Container(
        decoration: BoxDecoration(
          border: Border.all(color: Colors.grey.shade300),
          borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
        ),
        child: TolyTree&lt;_FileMeta&gt;(
          nodes: _buildSampleData(title),
          animationDuration: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">600</span>),
          animationCurve: curve,
          nodeBuilder: (node) =&gt; Row(
            children: [
              Icon(node.data.icon, size: <span class="hljs-number">14</span>, color: node.data.color),
              <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">6</span>),
              Text(node.data.name),
            ],
          ),
        ),
      ),
    ],
  );
}

</code></pre>
<p>这种对比展示帮助开发者选择最适合项目风格的动画效果，彰显个性化特征。</p>
<hr/>
<h4 data-id="heading-8">7. 拖拽排序树形</h4>
<p>在文件管理、项目结构编辑、菜单配置等场景中，用户经常需要通过拖拽来调整节点的位置和层级关系。<strong>TolyDraggableTree</strong> 提供了完整的拖拽排序能力，支持同级排序和跨级移动。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c47001eff634617baf81d2f31d8f68d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=313734&amp;e=gif&amp;f=128&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>展示支持拖拽排序的树形组件。文件可以拖入文件夹，文件夹可以拖入其他文件夹，支持同级排序和跨级移动。拖拽过程中会显示蓝色的放置提示线：上方线表示插入到目标上方，下方线表示插入到目标下方，边框表示放入目标内部。拖拽完成后会显示操作成功消息。</p>
<pre><code class="hljs language-dart" lang="dart">TolyDraggableTree&lt;FileItem&gt;(
  nodes: nodes,
  nodeBuilder: (node) =&gt; _buildFileNode(node),
  onNodeMoved: onMove,
),
</code></pre>
<hr/>
<h4 data-id="heading-9">尾声</h4>
<p>toly_tree 模块为 Flutter 应用提供了完整的树形数据展示和交互能力。从基础的层级展示到高级的虚拟滚动，从静态数据到动态加载，从简单选择到复杂的三态交互，它都能够胜任。</p>
<p>组件的设计遵循了数据驱动的原则，通过 TreeNode 数据结构统一管理节点信息，支持泛型以适应不同的业务数据类型。同时提供了丰富的自定义选项，包括节点渲染器、动画效果、交互回调等，让开发者能够根据具体需求进行灵活配置。</p>
<p>无论你是在构建文件管理系统、权限配置界面，还是开发数据浏览工具，toly_tree 都能帮助你创建出既美观又实用的树形界面。</p>
<p>随着 tolyui 的逐步迭代，越来越多的新功能将会支持。感谢你关注 tolyui 的成长，如果喜欢，也希望你能在 github 中点赞支持~</p>
<blockquote>
<p>github 开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）]]></title>    <link>https://juejin.cn/post/7583571595202740262</link>    <guid>https://juejin.cn/post/7583571595202740262</guid>    <pubDate>2025-12-14T13:05:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202740262" data-draft-id="7583528177559453746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）"/> <meta itemprop="keywords" content="Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-14T13:05:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:05:04.000Z" title="Sun Dec 14 2025 13:05:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！SpringBoot 作为 Spring 生态的 “轻量级脚手架”，凭借<strong>自动配置、起步依赖、内嵌服务器</strong>等特性，彻底简化了 Java Web 开发的繁琐配置。很多新手从 SSM 框架转向 SpringBoot 时，既好奇它的 “零配置” 魔力，也容易在 “分层开发” 和 “解耦设计” 上踩坑。</p>
<p>这篇文章会从 SpringBoot Web 的核心原理入手，通过一个完整的用户管理案例实现快速入门，再深入讲解分层解耦的设计思想与实践技巧，帮你夯实 SpringBoot Web 开发的基础。</p>
<h2 data-id="heading-0">一、SpringBoot Web 核心认知：为什么它是 Web 开发的首选？</h2>
<h4 data-id="heading-1">1.1 什么是 SpringBoot Web？</h4>
<p>SpringBoot Web 是 SpringBoot 针对 Web 开发提供的一站式解决方案，它整合了<strong>Spring MVC、Tomcat（内嵌服务器）、Jackson（JSON 序列化）</strong>  等核心组件，通过<strong>起步依赖（Starter）</strong>  实现一键引入，通过<strong>自动配置</strong>省去繁琐的 XML 或 Java 配置，让开发者专注于业务逻辑。</p>
<h4 data-id="heading-2">1.2 SpringBoot Web 的核心优势</h4>
<ul>
<li><strong>零配置启动</strong>：无需手动配置 Spring MVC 的 DispatcherServlet、视图解析器等，启动类一键运行；</li>
<li><strong>内嵌服务器</strong>：内置 Tomcat、Jetty 等服务器，无需手动部署，直接运行 JAR 包即可启动 Web 服务；</li>
<li><strong>起步依赖</strong>：<code>spring-boot-starter-web</code>一个依赖即可引入 Web 开发所需的所有组件，避免依赖版本冲突；</li>
<li><strong>无缝集成</strong>：与 MyBatis、Redis、Spring Data JPA 等框架无缝集成，降低技术栈整合成本。</li>
</ul>
<h4 data-id="heading-3">1.3 核心概念：起步依赖与自动配置</h4>
<ul>
<li><strong>起步依赖（Starter）</strong> ：是 Maven 的依赖集合，如<code>spring-boot-starter-web</code>包含了 Spring MVC、Tomcat、Jackson 等依赖，只需引入一个即可；</li>
<li><strong>自动配置（AutoConfiguration）</strong> ：SpringBoot 通过<code>@EnableAutoConfiguration</code>注解，根据类路径下的依赖自动配置 Bean（如检测到<code>spring-webmvc</code>则自动配置 DispatcherServlet）。</li>
</ul>
<h2 data-id="heading-4">二、SpringBoot Web 快速入门：搭建第一个 Web 项目</h2>
<h4 data-id="heading-5">2.1 环境准备</h4>
<ul>
<li>JDK：8 及以上（推荐 JDK 8/11）；</li>
<li>构建工具：Maven/Gradle（本文使用 Maven）；</li>
<li>IDE：IntelliJ IDEA 2020+；</li>
<li>SpringBoot 版本：3.5.0。</li>
</ul>
<h4 data-id="heading-6">2.2 创建 SpringBoot Web 项目（IDEA 版）</h4>
<h5 data-id="heading-7">方式 1：通过 Spring Initializr 创建</h5>
<ol>
<li>
<p>打开 IDEA，点击<code>File &gt; New &gt; Project</code>；</p>
</li>
<li>
<p>左侧选择<code>Spring Initializr</code>，选择 JDK 版本，点击<code>Next</code>；</p>
</li>
<li>
<p>填写项目信息：</p>
<ul>
<li>Group：<code>com.xxx</code>（如<code>com.demo</code>）；</li>
<li>Artifact：<code>springboot-web-demo</code>；</li>
<li>Type：<code>Maven Project</code>；</li>
<li>Java Version：<code>17</code>；</li>
</ul>
</li>
<li>
<p>选择依赖：在<code>Web</code>分类下勾选<code>Spring Web</code>，点击<code>Next</code>；</p>
</li>
<li>
<p>选择项目存储路径，点击<code>Create</code>，IDEA 会自动下载依赖并生成项目结构。</p>
</li>
</ol>
<h5 data-id="heading-8">方式 2：手动创建 Maven 项目</h5>
<ol>
<li>创建普通 Maven 项目，在<code>pom.xml</code>中添加 SpringBoot 父依赖和 Web 起步依赖：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringBoot父依赖（统一版本管理） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Web起步依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 打包插件（可执行JAR包） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">2.3 核心项目结构</h4>
<p>SpringBoot Web 项目遵循标准的 Maven 结构，核心目录如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">springboot-web-demo
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com
│   │   │       └── demo
│   │   │           ├── SpringbootWebDemoApplication.java  // 启动类
│   │   │           ├── controller  // 控制器层（接收请求）
│   │   │           ├── service     // 服务层（业务逻辑）
│   │   │           ├── mapper      // 数据访问层（操作数据库）
│   │   │           └── entity      // 实体类（封装数据）
│   │   └── resources
│   │       ├── application.properties  // 配置文件
│   │       ├── static  // 静态资源（CSS/JS/图片）
│   │       └── templates  // 模板文件（Thymeleaf等）
│   └── test  // 测试目录
└── pom.xml
</code></pre>
<h4 data-id="heading-10">2.4 编写第一个接口：Hello World</h4>
<h5 data-id="heading-11">步骤 1：编写启动类</h5>
<p>启动类是 SpringBoot 项目的入口，需添加<code>@SpringBootApplication</code>注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-comment">// 包含@Configuration、@EnableAutoConfiguration、@ComponentScan三个注解</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringbootWebDemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动SpringBoot应用</span>
        SpringApplication.run(SpringbootWebDemoApplication.class, args);
    }
}
</code></pre>
<h5 data-id="heading-12">步骤 2：编写控制器（Controller）</h5>
<p>在<code>controller</code>包下创建<code>HelloController</code>，处理 HTTP 请求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.controller;

<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-meta">@RestController</span> <span class="hljs-comment">//标识当前类可以处理请求，并且会创建当前类对象加入spring容器（内存）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-comment">//处理指定资源路径的请求</span>
    <span class="hljs-meta">@RequestMapping("/hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span>{<span class="hljs-comment">//这里的参数name必须要与前端传递的参数名字name一样，就可以接收数据</span>
        System.out.println(<span class="hljs-string">"后端处理/hello请求，并且接收数据：name="</span>+name);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello "</span> + name;
    }
}
</code></pre>
<h5 data-id="heading-13">步骤 3：启动项目并测试</h5>
<ol>
<li>右键启动类，选择<code>Run 'SpringbootWebDemoApplication'</code>；</li>
<li>控制台出现<code>Tomcat started on port(s): 8080 (http)</code>表示启动成功；</li>
<li>打开浏览器，访问<code>http://localhost:8080/hello/SpringBoot Web</code>，页面显示<code>Hello SpringBoot Web</code>。</li>
</ol>
<h3 data-id="heading-14">三、实战案例：用户管理系统（CRUD）</h3>
<p>接下来通过一个基于SpringBoot开发的web程序——<strong>用户管理系统</strong>，实现用户列表的渲染展示，让你快速掌握 SpringBoot Web 的开发流程。</p>
<h4 data-id="heading-15">3.1 创建实体类</h4>
<p>在<code>pojo</code>包下创建<code>User</code>类，封装用户数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.pojo;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span><span class="hljs-comment">//生成get/set/toString/hashCode/equals方法</span>
<span class="hljs-meta">@NoArgsConstructor</span><span class="hljs-comment">//生成无参构造方法</span>
<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-comment">//生成全参构造方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}
</code></pre>
<p><strong>注意</strong>：需在<code>pom.xml</code>中添加 Lombok 依赖（简化代码）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">3.2 编写前端HTML</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>用户列表数据<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/*定义css，美化表格*/</span>
        <span class="hljs-selector-tag">table</span>{
            <span class="hljs-attribute">border-collapse</span>: collapse;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
        }
        <span class="hljs-selector-tag">tr</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
        }
        <span class="hljs-selector-tag">th</span>,<span class="hljs-selector-tag">td</span>{
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
        }
        <span class="hljs-selector-tag">thead</span>{
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e8e8e8</span>;
        }
        <span class="hljs-selector-tag">h1</span>{
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">font-family</span>: 楷体;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户列表数据<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-comment">&lt;!--定义一个表格,包括6列,分别是: ID, 用户名, 密码, 姓名, 年龄, 更新时间--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>ID<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>用户名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>密码<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>更新时间<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in userList"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.id}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.username}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.password}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.name}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.age}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.updateTime}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!--引入axios--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/vue.esm-browser.js'</span>
        <span class="hljs-title function_">createApp</span>({
            <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">userList</span>: []
                }
            },
            <span class="hljs-attr">methods</span>: {
                <span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params"/>){
                    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/list'</span>);
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userList</span> = result.<span class="hljs-property">data</span>;
                }
            },
            <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>();
            }
        }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">3.3 编写控制器（Controller）</h4>
<p>在<code>controller</code>包下创建<code>UserController</code>，处理查询用户列表请求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span><span class="hljs-comment">//标识当前类可以处理请求，并且创建当前类对象加入spring容器中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-comment">/**
     * 处理查询用户列表请求
     * <span class="hljs-doctag">@return</span> List&lt;User&gt;
     *
     * 方法返回List&lt;User&gt;,spring框架会自动将其转换为json字符串返回给前端
     *   '[{"id":xx,"username":xx},{"id":xx,"username":xx},...]'
     */</span>
    <span class="hljs-meta">@RequestMapping("/list")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//定义List&lt;User&gt;用于存储用户列表数据</span>
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.创建输入流对象操作user.txt文件</span>
        <span class="hljs-keyword">try</span> (
                <span class="hljs-comment">// InputStream in = new FileInputStream("day04-02-web-springboot/src/main/resources/user.txt")</span>
                <span class="hljs-comment">//上面这样写在web项目中不可以，因为web项目会部署给tomcat，目录结构就不是这样的结构</span>
                <span class="hljs-comment">// 解决方案：在web项目要先获取类路径target/classes目录下资源文件的固定语法：类加载器对象.getResourceAsStream("资源文件名")</span>
                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> UserController.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"user.txt"</span>)
        ){
            <span class="hljs-comment">//2.读取文件中的数据，利用hutool工具一次性读取所有行数据封装到List&lt;String&gt;</span>
            List&lt;String&gt; rows = IoUtil.readUtf8Lines(in, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

            <span class="hljs-comment">//3.将List&lt;String&gt;转换为List&lt;User&gt;</span>

            <span class="hljs-comment">// 遍历List&lt;String&gt;的每个元素</span>
            <span class="hljs-keyword">for</span> (String s : rows) {
                <span class="hljs-comment">// 将类似1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45按照“,”分隔得到数组</span>
                String[] split = s.split(<span class="hljs-string">","</span>);

                <span class="hljs-comment">// 将分隔出的数据封装到User对象中</span>
                <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(
                        Integer.valueOf(split[<span class="hljs-number">0</span>]),
                        split[<span class="hljs-number">1</span>],
                        split[<span class="hljs-number">2</span>],
                        split[<span class="hljs-number">3</span>],
                        Integer.valueOf(split[<span class="hljs-number">4</span>]),
                        LocalDateTime.parse(split[<span class="hljs-number">5</span>], DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
                        <span class="hljs-comment">//  将字符串转换为LocalDateTime</span>
                        <span class="hljs-comment">//  yyyy 格式化为4个数字的年2025, yy两个数字的年25</span>
                        <span class="hljs-comment">//  MM 格式化为2个数字的月</span>
                        <span class="hljs-comment">//  dd 格式化为2个数字的日</span>
                        <span class="hljs-comment">//  HH 格式化为24小时，hh格式为12小时</span>
                        <span class="hljs-comment">//  mm 格式化分钟</span>
                        <span class="hljs-comment">//  ss 格式化秒</span>
                );

                <span class="hljs-comment">// 将user对象添加List&lt;User&gt;集合中</span>
                users.add(user);
            }
            <span class="hljs-keyword">return</span> users;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}

</code></pre>
<h4 data-id="heading-18">3.4 编写user.txt</h4>
<pre><code class="hljs language-txt" lang="txt">1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45
2,xiaoqiao,1234567890,小乔,18,2024-07-15 15:12:09
3,diaochan,1234567890,貂蝉,21,2024-07-15 15:07:16
4,lvbu,1234567890,吕布,28,2024-07-16 10:05:15
5,zhaoyun,1234567890,赵云,27,2024-07-16 11:03:28
6,zhangfei,1234567890,张飞,31,2024-07-16 11:03:28
7,guanyu,1234567890,关羽,34,2024-07-16 12:05:12
8,liubei,1234567890,刘备,37,2024-07-16 15:03:28
</code></pre>
<h4 data-id="heading-19">3.5 编写启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span><span class="hljs-comment">//标识当前类为启动类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(WebApplication.class,args);<span class="hljs-comment">//启动程序</span>
    }
}
</code></pre>
<p>运行main方法，启动服务器端程序、</p>
<p>在浏览器中输入(<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fuser.html" target="_blank" title="http://localhost:8080/user.html" ref="nofollow noopener noreferrer">http://localhost:8080/user.html</a>)</p>
<h3 data-id="heading-20">四、分层解耦：理解 SpringBoot 的设计思想</h3>
<p>在我们进行程序设计以及程序开发时，尽可能让每一个接口、类、方法的职责更单一些（单一职责原则）。</p>
<p>由此引申出<strong>Controller、Service、Mapper</strong>三层架构，这是 SpringBoot Web 开发的标准分层方式，其核心目的是<strong>解耦</strong>，让代码更易维护、扩展和测试。</p>
<h4 data-id="heading-21">4.1 为什么要分层？</h4>
<p>在传统的单体代码中，所有逻辑写在一个类中，会导致：</p>
<ul>
<li><strong>代码耦合度高</strong>：修改一个功能可能影响其他功能；</li>
<li><strong>可读性差</strong>：几百行代码混在一起，难以理解；</li>
<li><strong>可测试性差</strong>：无法单独测试某个功能点。</li>
</ul>
<p>分层开发通过<strong>单一职责原则</strong>，将不同功能拆分到不同层级，每个层级只做一件事：</p>
<ul>
<li><strong>Controller 层</strong>：只负责接收请求、返回响应，不处理业务逻辑；</li>
<li><strong>Service 层</strong>：只负责业务逻辑处理，不关心请求和数据存储；</li>
<li><strong>Mapper 层</strong>：只负责数据访问，不处理业务逻辑。</li>
</ul>
<h4 data-id="heading-22">4.2 分层架构的核心职责</h4>



































<table><thead><tr><th>层级</th><th>核心注解</th><th>核心职责</th><th>依赖关系</th></tr></thead><tbody><tr><td>Controller（控制层）</td><td><code>@RestController</code>、<code>@RequestMapping</code></td><td>接收 HTTP 请求、参数校验、返回响应</td><td>依赖 Service 层</td></tr><tr><td>Service（服务层）</td><td><code>@Service</code></td><td>业务逻辑处理、事务管理、数据校验</td><td>依赖 Mapper 层</td></tr><tr><td>Mapper/Dao（数据访问层）</td><td><code>@Repository</code></td><td>数据库 CRUD 操作、数据映射</td><td>无（被 Service 层依赖）</td></tr><tr><td>Entity/Pojo（实体层）</td><td><code>@Data</code>（Lombok）</td><td>封装数据（对应数据库表 / 请求响应体）</td><td>被所有层级使用</td></tr></tbody></table>
<h4 data-id="heading-23">4.3 实战案例示例：重写上一节案例的Controller</h4>
<h5 data-id="heading-24">4.3.1 <strong>数据访问层：负责数据的访问操作，包含数据的增、删、改、查</strong></h5>
<p><strong>在 <code>com.tgt.dao</code>中创建UserDao接口，代码如下</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.dao;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Description</span> 用户数据数据访问接口
 * <span class="hljs-doctag">@Author</span> tgt
 * <span class="hljs-doctag">@Date</span> 2025-10-21
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> {

    <span class="hljs-comment">/**
     * 解析文件返回数据列表
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    List&lt;String&gt; <span class="hljs-title function_">GetDao</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>在 <code>com.tgt.dao.impl</code> 中创建UserDaoImpl接口，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.dao.impl;

<span class="hljs-keyword">import</span> cn.hutool.core.io.IoUtil;
<span class="hljs-keyword">import</span> com.tgt.controller.UserController;
<span class="hljs-keyword">import</span> com.tgt.dao.IUserDao;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">//数据访问层DAO：操作数据增删改查</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserDao</span> {
    <span class="hljs-comment">/**
     * 解析文件返回数据列表
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">GetDao</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//定义List&lt;User&gt;用于存储用户列表数据</span>
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.创建输入流对象操作user.txt文件</span>
        <span class="hljs-keyword">try</span> (
                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> UserController.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"user.txt"</span>)
        ) {
            <span class="hljs-comment">//2.读取文件中的数据，利用hutool工具一次性读取所有行数据封装到List&lt;String&gt;</span>
            List&lt;String&gt; rows = IoUtil.readUtf8Lines(in, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

            <span class="hljs-keyword">return</span> rows;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}
</code></pre>
<h5 data-id="heading-25">4.3.2 业务逻辑层：处理具体的业务逻辑</h5>
<p>在 <code>com.tgt.service</code>中创建UserSerivce接口，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.service;

<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserService</span> {
    <span class="hljs-comment">/**
     * 获取用户列表业务方法
     * <span class="hljs-doctag">@return</span>
     */</span>
    List&lt;User&gt; <span class="hljs-title function_">GetUserList</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>在 <code>com.tgt.service.impl</code> 中创建UserSerivceImpl接口，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.service.Impl;

<span class="hljs-keyword">import</span> com.tgt.dao.IUserDao;
<span class="hljs-keyword">import</span> com.tgt.dao.impl.UserDaoImpl;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> com.tgt.service.IUserService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> {

    <span class="hljs-comment">//定义数据访问对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">IUserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">IUserService</span>();

    <span class="hljs-comment">/**
     * 获取用户列表业务方法
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">GetUserList</span><span class="hljs-params">()</span> {

        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.调用数据访问层方法获取磁盘数据List&lt;String&gt;</span>
        List&lt;String&gt; rows = userDao.GetDao();

        <span class="hljs-comment">//2.将List&lt;String&gt;转换为List&lt;User&gt;</span>
        <span class="hljs-comment">// 遍历List&lt;String&gt;的每个元素</span>
        <span class="hljs-keyword">for</span> (String s : rows) {
            <span class="hljs-comment">// 将类似1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45按照“,”分隔得到数组</span>
            String[] split = s.split(<span class="hljs-string">","</span>);

            <span class="hljs-comment">// 将分隔出的数据封装到User对象中</span>
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(
                    Integer.valueOf(split[<span class="hljs-number">0</span>]),
                    split[<span class="hljs-number">1</span>],
                    split[<span class="hljs-number">2</span>],
                    split[<span class="hljs-number">3</span>],
                    Integer.valueOf(split[<span class="hljs-number">4</span>]),
                    LocalDateTime.parse(split[<span class="hljs-number">5</span>], DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
            );

            <span class="hljs-comment">// 将user对象添加List&lt;User&gt;集合中</span>
            users.add(user);
        }
        <span class="hljs-keyword">return</span> users;
    }
}
</code></pre>
<h5 data-id="heading-26">4.3.3 <strong>控制层：接收前端发送的请求，对请求进行处理，并响应数据</strong></h5>
<p><strong>在 <code>com.itheima.controller</code> 中创建UserController类，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.controller;

<span class="hljs-keyword">import</span> cn.hutool.core.io.IoUtil;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> com.tgt.service.IUserService;
<span class="hljs-keyword">import</span> com.tgt.service.Impl.UserServiceImpl;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;


<span class="hljs-meta">@RestController</span><span class="hljs-comment">//标识当前类可以处理请求，并且创建当前类对象加入spring容器中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-comment">//定义业务对象</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">IUserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

    <span class="hljs-comment">/**
     * 处理查询用户列表请求
     *
     * <span class="hljs-doctag">@return</span> List&lt;User&gt;
     */</span>
    <span class="hljs-meta">@RequestMapping("/list")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.GetUserList();
    }
}
</code></pre>
<h4 data-id="heading-27">4.3 解耦的关键：依赖注入与控制反转</h4>
<p>之前我们在编写代码时，需要什么对象，就直接new一个就可以了。 这种做法呢，层与层之间代码就耦合了，当service层的实现变了之后， 我们还需要修改controller层的代码。
那应该怎么解耦呢？</p>
<p>SpringBoot 的<strong>依赖注入（DI）</strong>  和<strong>控制反转（IOC）</strong>  是实现分层解耦的核心机制：</p>
<ul>
<li><strong>控制反转（IOC）</strong> ：将对象的创建权交给 Spring 容器，而非手动<code>new</code>对象；</li>
<li><strong>依赖注入（DI）</strong> ：Spring 容器自动将依赖的对象注入到当前类中（如<code>@Autowired</code>注入 UserService）。</li>
</ul>
<h5 data-id="heading-28">示例：传统方式 vs 依赖注入</h5>
<p><strong>传统方式（耦合度高）</strong> ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller中手动创建Service实例，耦合度高</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
}
</code></pre>
<p><strong>依赖注入方式（解耦）</strong> ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 由Spring容器管理对象，通过@Autowired注入，降低耦合</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
}
</code></pre>
<h4 data-id="heading-29">4.4 进一步解耦：面向接口编程</h4>
<p>我们先定义接口再实现类，这是<strong>面向接口编程</strong>的思想，其优势在于：</p>
<ul>
<li><strong>降低耦合</strong>：Controller 层只依赖 Service 接口，不依赖具体实现类；</li>
<li><strong>便于扩展</strong>：如需修改业务逻辑，只需新增实现类，无需修改 Controller 代码；</li>
<li><strong>便于测试</strong>：可通过 Mock 对象模拟 Service 接口，实现单元测试。</li>
</ul>
<h4 data-id="heading-30">4.5 分层解耦的最佳实践</h4>
<ol>
<li><strong>层级边界清晰</strong>：禁止跨层级调用（如 Controller 直接调用 Mapper）；</li>
<li><strong>面向接口编程</strong>：Service 层优先定义接口，实现类负责具体逻辑；</li>
<li><strong>依赖注入</strong>：使用<code>@Autowired</code>或构造器注入，避免手动创建对象；</li>
<li><strong>单一职责</strong>：每个类 / 方法只做一件事，避免 “全能类”；</li>
<li><strong>异常统一处理</strong>：通过全局异常处理器统一处理各层级的异常。</li>
</ol>
<h2 data-id="heading-31">五、常见问题与解决方案</h2>
<h4 data-id="heading-32">5.1 启动项目时提示 “找不到 Bean”</h4>
<ul>
<li><strong>原因</strong>：组件未被 Spring 扫描（如忘记加<code>@Service</code>/<code>@Repository</code>注解）；</li>
<li><strong>解决</strong>：检查类上的注解是否正确，确保启动类的包路径包含所有组件（<code>@SpringBootApplication</code>默认扫描当前包及子包）。</li>
</ul>
<h4 data-id="heading-33">5.2 接口返回 404</h4>
<ul>
<li><strong>原因</strong>：请求路径错误、Controller 注解错误（如用<code>@Controller</code>而非<code>@RestController</code>）；</li>
<li><strong>解决</strong>：检查请求路径与<code>@RequestMapping</code>是否一致，确保返回数据的注解正确。</li>
</ul>
<h4 data-id="heading-34">5.3 请求体传参时提示 “参数绑定失败”</h4>
<ul>
<li><strong>原因</strong>：请求体格式错误（非 JSON）、实体类字段与请求体字段不匹配；</li>
<li><strong>解决</strong>：确保请求体为 JSON 格式，实体类字段名称与请求体一致（或使用<code>@JsonProperty</code>注解映射）。</li>
</ul>
<h2 data-id="heading-35">六、总结与延伸</h2>
<h4 data-id="heading-36">6.1 核心总结</h4>
<ol>
<li>SpringBoot Web 通过起步依赖和自动配置，实现了 Web 开发的 “零配置” 启动；</li>
<li>标准的分层架构为<strong>Controller（控制层）、Service（服务层）、Mapper（数据访问层）</strong> ，各层级职责单一；</li>
<li>依赖注入和面向接口编程是实现分层解耦的关键，能大幅提升代码的可维护性；</li>
<li>实战案例中的 CRUD 接口是 Web 开发的基础，掌握后可扩展到更复杂的业务场景。</li>
</ol>
<p>SpringBoot Web 的入门门槛低，但想要写出优雅、高效的代码，需要深入理解分层解耦的设计思想。建议在实际项目中多动手实践，逐步掌握 SpringBoot 的高级特性，最终形成自己的开发体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java事务常见的失效场景总结]]></title>    <link>https://juejin.cn/post/7583225356905381928</link>    <guid>https://juejin.cn/post/7583225356905381928</guid>    <pubDate>2025-12-14T13:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583225356905381928" data-draft-id="7583325900293849088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java事务常见的失效场景总结  "/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2025-12-14T13:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小橙编码日志"/> <meta itemprop="url" content="https://juejin.cn/user/3562867149506392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java事务常见的失效场景总结  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562867149506392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小橙编码日志
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:59:32.000Z" title="Sun Dec 14 2025 13:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">Java事务常见的失效场景总结</h2>
<p>在Java开发中，事务是保障数据一致性的核心机制，尤其在电商下单、金融转账等关键场景中，事务的可靠性直接决定系统的业务可信度。但实际开发中，“事务配置了却不生效”的问题频发，其根源往往是对事务本质理解不深或忽视了细节约束。本文将从事务核心定义出发，梳理Java事务的实现体系，重点剖析常见失效场景及解决方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376df5e996704453b341f42accc3cd9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5qmZ57yW56CB5pel5b-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325572&amp;x-signature=un%2BSlOmW0KtEYTb7fVm%2BV9Mads8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、Java事务的核心理解：从本质到特性</h3>
<h4 data-id="heading-2">1. 事务的本质：不可分割的逻辑单元</h4>
<p>事务（Transaction）是一组数据库操作的集合，具备“要么全部成功提交，要么全部失败回滚”的原子性特征。例如天猫国际供应商的“订单创建+库存扣减”操作，若订单创建成功但库存扣减失败，必须通过事务回滚消除订单记录，避免数据不一致。Java事务的核心价值，就是将分散的数据库操作绑定为一个逻辑整体，抵御业务异常和系统故障带来的数据风险。</p>
<h4 data-id="heading-3">2. 事务的灵魂：ACID特性落地</h4>
<p>事务的可靠性依赖ACID四大特性支撑，Java通过API封装与数据库协同实现这些特性，具体落地逻辑如下：</p>
<ul>
<li>
<p><strong>原子性（Atomicity）</strong>：操作不可拆分，核心通过Java的<code>Connection</code>接口控制——关闭自动提交（<code>setAutoCommit(false)</code>）后，所有操作统一通过<code>commit()</code>提交或<code>rollback()</code>回滚。若任一操作抛出异常，立即触发回滚，确保操作整体一致性。</p>
</li>
<li>
<p><strong>一致性（Consistency）</strong>：事务执行前后数据符合业务规则（如供应商库存不为负）。Java层面通过业务逻辑校验（如扣减前检查库存），数据库层面通过主键、外键等约束共同保障。</p>
</li>
<li>
<p><strong>隔离性（Isolation）</strong>：并发事务互不干扰，Java通过<code>setTransactionIsolation()</code>设置隔离级别，解决脏读、不可重复读、幻读问题。例如MySQL默认的REPEATABLE_READ级别，可避免同一事务内两次读取结果不一致的问题。</p>
</li>
<li>
<p><strong>持久性（Durability）</strong>：事务提交后数据永久保存，即便系统崩溃也不丢失。此特性主要依赖数据库的预写式日志（WAL）实现，Java只需确保<code>commit()</code>方法正常返回，即可信任数据库已完成日志落盘。</p>
</li>
</ul>
<h3 data-id="heading-4">二、Java事务失效的8类常见场景：原理与解决方案</h3>
<p>事务失效的本质是“事务管理逻辑未被正确执行”，Spring事务因使用频率最高，失效场景也最为典型。以下结合原理、代码示例和修复方案，逐一解析核心失效场景：</p>
<h4 data-id="heading-5">1. 事务方法非public修饰</h4>
<p><strong>失效原理</strong>：Spring AOP代理机制对非public方法（private、protected、默认权限）无法进行有效增强——JDK动态代理基于接口，仅代理public方法；CGLIB代理虽能代理非public方法，但Spring为遵循Java语言规范，主动跳过了对非public方法的事务增强。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SupplierService</span> {  
    <span class="hljs-comment">// 非public方法，@Transactional注解失效  </span>
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateSupplierStock</span><span class="hljs-params">(Long supplierId, Integer stock)</span> {  
        supplierMapper.updateStock(supplierId, stock);  
        <span class="hljs-comment">// 模拟异常  </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：将事务方法修改为public访问权限，确保Spring AOP能正常拦截并注入事务逻辑。修复后完整代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">  
@Service  
public class SupplierService {  
    // 改为public方法，@Transactional注解生效  
    @Transactional  
    public void updateSupplierStock(Long supplierId, Integer stock) {  
        supplierMapper.updateStock(supplierId, stock);  
        // 模拟异常，此时会触发事务回滚  
        int i = 1 / 0;  
    }  
}  
</code></pre>
<p>补充说明：修改后当方法执行到异常处时，Spring事务管理器会捕获异常并触发回滚，确保库存更新操作不会生效，避免数据不一致。若需进一步增强，还可结合rollbackFor属性明确回滚异常范围，如<code>@Transactional(rollbackFor = Exception.class)</code>。</p>
<h4 data-id="heading-6">2. 异常被捕获且未重新抛出</h4>
<p><strong>失效原理</strong>：Spring事务默认仅在“未捕获的RuntimeException或Error”发生时触发回滚。若方法内部用try-catch捕获异常且未重新抛出，事务管理器会判定“业务执行正常”，不会执行回滚操作。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        <span class="hljs-keyword">try</span> {  
            orderMapper.insert(order);  
            <span class="hljs-comment">// 模拟库存扣减异常  </span>
            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            <span class="hljs-comment">// 捕获异常但未抛出，事务不回滚  </span>
            log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        }  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：两种思路——捕获后重新抛出异常（推荐），或手动触发回滚。修复后代码如下：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-comment">// 方案一：重新抛出异常  </span>
<span class="hljs-meta">@Transactional</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
    <span class="hljs-keyword">try</span> {  
        orderMapper.insert(order);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    } <span class="hljs-keyword">catch</span> (Exception e) {  
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单创建失败"</span>, e); <span class="hljs-comment">// 触发回滚  </span>
    }  
}  
  
<span class="hljs-comment">// 方案二：手动回滚  </span>
<span class="hljs-meta">@Transactional</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
    <span class="hljs-keyword">try</span> {  
        orderMapper.insert(order);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    } <span class="hljs-keyword">catch</span> (Exception e) {  
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        <span class="hljs-comment">// 手动标记事务为回滚状态  </span>
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();  
    }  
}  
</code></pre>
<h4 data-id="heading-7">3. rollbackFor属性配置错误</h4>
<p><strong>失效原理</strong>：<code>@Transactional</code>默认仅回滚RuntimeException和Error，若业务中抛出受检异常（如IOException、SQLException）且未在rollbackFor中声明，事务不会回滚。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileService</span> {  
    <span class="hljs-comment">// 未指定rollbackFor，IOException不会触发回滚  </span>
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importSupplierData</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {  
        <span class="hljs-type">FileReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(filePath); <span class="hljs-comment">// 可能抛出IOException  </span>
        supplierMapper.batchInsert(parseData(reader));  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：显式配置rollbackFor属性，包含业务中可能抛出的所有异常类型：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Transactional(rollbackFor = {IOException.class, RuntimeException.class})</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importSupplierData</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {  
    <span class="hljs-comment">// 业务逻辑不变  </span>
}  
</code></pre>
<h4 data-id="heading-8">4. 事务传播机制配置不当</h4>
<p><strong>失效原理</strong>：传播机制定义了事务方法嵌套时的行为，若配置了“不支持事务”的传播属性（如NOT_SUPPORTED、SUPPORTS），会导致操作脱离事务上下文执行。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Autowired</span>  
    <span class="hljs-keyword">private</span> StockService stockService;  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        orderMapper.insert(order);  
        <span class="hljs-comment">// 调用不支持事务的方法，库存扣减操作脱离事务  </span>
        stockService.reduceStock(order.getProductId(), order.getNum());  
    }  
}  
  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockService</span> {  
    <span class="hljs-comment">// NOT_SUPPORTED：以非事务方式执行，若存在事务则挂起  </span>
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reduceStock</span><span class="hljs-params">(Long productId, Integer num)</span> {  
        stockMapper.updateStock(productId, num);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>; <span class="hljs-comment">// 异常不会触发回滚  </span>
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：根据业务需求选择正确的传播机制，绝大多数场景使用默认的REQUIRED（存在事务则加入，否则新建）即可：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reduceStock</span><span class="hljs-params">(Long productId, Integer num)</span> {  
    <span class="hljs-comment">// 业务逻辑不变  </span>
}  
</code></pre>
<h4 data-id="heading-9">5. 同类方法内部调用</h4>
<p><strong>失效原理</strong>：Spring事务基于AOP动态代理，事务增强逻辑封装在代理对象中。若同一类中的无事务方法A调用有事务方法B，调用过程未经过代理对象，直接触发目标对象方法，导致事务注解失效。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {  
    <span class="hljs-comment">// 无事务方法  </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserInfo</span><span class="hljs-params">(Long id, String name, Integer age)</span> {  
        updateUserName(id, name); <span class="hljs-comment">// 内部调用，事务失效  </span>
        updateUserAge(id, age);   <span class="hljs-comment">// 内部调用，事务失效  </span>
    }  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserName</span><span class="hljs-params">(Long id, String name)</span> {  
        userMapper.updateName(id, name);  
    }  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserAge</span><span class="hljs-params">(Long id, Integer age)</span> {  
        userMapper.updateAge(id, age);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：两种思路——通过AopContext获取代理对象调用，或拆分事务方法到不同类中。推荐后者，更符合代码设计原则：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-comment">// 方案一：获取代理对象调用  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserInfo</span><span class="hljs-params">(Long id, String name, Integer age)</span> {  
    <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) AopContext.currentProxy();  
    proxy.updateUserName(id, name);  
    proxy.updateUserAge(id, age);  
}  
  
<span class="hljs-comment">// 方案二：拆分到不同类（推荐）  </span>
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNameService</span> {  
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserName</span><span class="hljs-params">(Long id, String name)</span> {  
        userMapper.updateName(id, name);  
    }  
}  
</code></pre>
<h4 data-id="heading-10">6. 数据库不支持事务</h4>
<p><strong>失效原理</strong>：事务最终依赖数据库引擎支持，若使用MySQL的MyISAM引擎（不支持事务），或数据库配置为“只读模式”，Java层面的事务配置再完善也无法生效。</p>
<p><strong>排查与修复</strong>：① 确认数据库表引擎为InnoDB（支持事务）；② 检查数据库连接URL是否包含“readOnly=true”等只读配置；③ 执行<code>show variables like 'transaction_isolation'</code>确认数据库隔离级别正常。</p>
<h4 data-id="heading-11">7. 多线程调用事务方法</h4>
<p><strong>失效原理</strong>：Spring事务通过ThreadLocal存储事务状态，确保同一线程内的操作共享事务上下文。若主线程开启新线程调用事务方法，新线程无法继承主线程的事务状态，导致事务独立生效或失效。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Autowired</span>  
    <span class="hljs-keyword">private</span> LogService logService;  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        orderMapper.insert(order);  
        <span class="hljs-comment">// 新线程调用事务方法，日志记录失败不会导致订单回滚  </span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; logService.recordOrderLog(order.getId())).start();  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：避免在事务方法中通过新线程执行核心业务操作；若需记录日志等非核心操作，可采用消息队列异步处理，或接受其与主事务的独立性。</p>
<h4 data-id="heading-12">8. 只读事务配置了写操作</h4>
<p><strong>失效原理</strong>：<code>@Transactional(readOnly = true)</code>标记的事务为只读事务，数据库会优化连接为只读模式，拒绝执行INSERT、UPDATE等写操作。若强行执行写操作，部分数据库会抛出异常，部分则直接忽略事务配置。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SupplierService</span> {  
    <span class="hljs-comment">// 只读事务配置写操作，事务失效或抛出异常  </span>
    <span class="hljs-meta">@Transactional(readOnly = true)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateSupplierName</span><span class="hljs-params">(Long id, String name)</span> {  
        supplierMapper.updateName(id, name);  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：仅对纯查询方法配置<code>readOnly = true</code>，写操作移除该属性或设置为false。</p>
<h3 data-id="heading-13">三、事务问题排查的核心思路</h3>
<p>遇到事务失效问题时，可按“三层排查法”定位问题：</p>
<ol>
<li>
<p><strong>注解配置层</strong>：检查<code>@Transactional</code>注解是否存在——方法是否为public、传播机制是否合理、rollbackFor是否包含目标异常。</p>
</li>
<li>
<p><strong>代理执行层</strong>：确认调用是否经过Spring代理——是否存在自调用问题、是否通过新线程调用、AOP代理是否正常生成（可通过日志打印代理对象类型验证）。</p>
</li>
<li>
<p><strong>数据库层</strong>：验证数据库是否支持事务——引擎是否为InnoDB、连接是否有权限、是否处于只读模式。</p>
</li>
</ol>
<h3 data-id="heading-14">四、总结</h3>
<p>Java事务的核心是通过“逻辑绑定”与“异常控制”保障数据一致性，其实现从JDBC的简单封装到Spring的声明式管理，本质都是对ACID特性的落地。事务失效并非玄学，而是对“代理机制”“异常传播”“数据库支持”等细节的忽视。开发中需牢记：事务是Java代码与数据库协同的结果，仅靠注解配置无法保障可靠性，必须结合业务场景理解底层原理，才能写出真正可靠的事务代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python中迭代器和生成器：让数据“懒”得刚刚好 💤]]></title>    <link>https://juejin.cn/post/7583571595202887718</link>    <guid>https://juejin.cn/post/7583571595202887718</guid>    <pubDate>2025-12-14T13:30:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202887718" data-draft-id="7583576605780459566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python中迭代器和生成器：让数据“懒”得刚刚好 💤"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-14T13:30:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南风以南"/> <meta itemprop="url" content="https://juejin.cn/user/3685218709418279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python中迭代器和生成器：让数据“懒”得刚刚好 💤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218709418279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南风以南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:30:46.000Z" title="Sun Dec 14 2025 13:30:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“聪明的程序员不是算得更快，而是<strong>算得更少</strong>。”<br/>
—— 迭代器与生成器，正是 Python 践行这一哲学的优雅体现。</p>
</blockquote>
<h2 data-id="heading-0">问题引入</h2>
<p>你有没有遇到过这样的场景？</p>
<ul>
<li>想遍历一个超大文件，但内存爆了 ❌</li>
<li>写了个 <code>range(10**9)</code>，结果电脑卡死 🐌</li>
<li>面试被问：“迭代器和生成器有啥区别？” 瞬间语塞 😅</li>
</ul>
<p>别慌！今天我们就把这两个看似高冷的概念，用一杯咖啡的时间讲清楚 ☕️。它们不是魔法，而是<strong>延迟计算（Lazy Evaluation）</strong> 的实用工具——只在你需要时才干活，绝不提前内卷！</p>
<hr/>
<h2 data-id="heading-1">核心剖析</h2>
<h3 data-id="heading-2">迭代器（Iterator）：会“一步一步走”的对象</h3>
<p>在 Python 中，<strong>迭代器</strong>是一个实现了 <code>__iter__()</code> 和 <code>__next__()</code> 方法的对象。它遵循<strong>迭代协议</strong>：</p>
<ul>
<li><code>__iter__()</code> 返回自身（支持 <code>for</code> 循环）</li>
<li><code>__next__()</code> 返回下一个值，若无则抛出 <code>StopIteration</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Countdown</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start</span>):
        self.start = start

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.start &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> StopIteration
        self.start -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> self.start + <span class="hljs-number">1</span>

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> Countdown(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(num)  <span class="hljs-comment"># 输出: 3, 2, 1</span>
</code></pre>
<blockquote>
<p>💡 所有可迭代对象（如 list、dict）本身<strong>不是迭代器</strong>，但可以通过 <code>iter()</code> 转成迭代器。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">生成器（Generator）：写起来像函数，用起来像迭代器</h3>
<p><strong>生成器</strong>是创建迭代器的“快捷方式”。你只需在函数中用 <code>yield</code> 替代 <code>return</code>，Python 自动帮你实现迭代协议！</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">countdown_gen</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">yield</span> n
        n -= <span class="hljs-number">1</span>

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> countdown_gen(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(num)  <span class="hljs-comment"># 输出: 3, 2, 1</span>
</code></pre>
<p>关键区别来了👇：</p>






























<table><thead><tr><th>特性</th><th>迭代器</th><th>生成器</th></tr></thead><tbody><tr><td>创建方式</td><td>手写类 + <code>__iter__</code>/<code>__next__</code></td><td>函数 + <code>yield</code></td></tr><tr><td>内存占用</td><td>手动控制</td><td>自动优化，极低</td></tr><tr><td>可读性</td><td>较繁琐</td><td>极简清晰 ✅</td></tr><tr><td>适用场景</td><td>复杂状态管理</td><td>流式数据、无限序列</td></tr></tbody></table>
<blockquote>
<p>🚀 生成器本质是<strong>语法糖</strong>，但它甜得恰到好处！</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">动手实践：处理大文件不崩内存</h2>
<p>假设你有一个 10GB 的日志文件，想逐行读取并过滤错误信息：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_large_file</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-string">"""生成器：按需读取，不加载全文件到内存"""</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            <span class="hljs-keyword">if</span> <span class="hljs-string">'ERROR'</span> <span class="hljs-keyword">in</span> line:
                <span class="hljs-keyword">yield</span> line.strip()

<span class="hljs-comment"># 使用（即使文件巨大，内存也稳如老狗）</span>
<span class="hljs-keyword">for</span> error_line <span class="hljs-keyword">in</span> read_large_file(<span class="hljs-string">'app.log'</span>):
    <span class="hljs-built_in">print</span>(error_line)
</code></pre>
<p>对比暴力做法 <code>lines = open('app.log').readlines()</code> —— 后者可能直接 OOM（Out of Memory）！</p>
<hr/>
<h2 data-id="heading-5">避坑指南 ⚠️</h2>
<ol>
<li>
<p><strong>生成器只能遍历一次！</strong></p>
<pre><code class="hljs language-python" lang="python">gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
<span class="hljs-built_in">list</span>(gen)  <span class="hljs-comment"># [0, 1, 2]</span>
<span class="hljs-built_in">list</span>(gen)  <span class="hljs-comment"># [] ← 已耗尽！</span>
</code></pre>
<p>解决方案：需要多次使用？转成 <code>list</code>，或重新调用生成器函数。</p>
</li>
<li>
<p><strong>别混淆“可迭代对象”和“迭代器”</strong></p>
<pre><code class="hljs language-python" lang="python">lst = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-built_in">iter</span>(lst) <span class="hljs-keyword">is</span> <span class="hljs-built_in">iter</span>(lst)  <span class="hljs-comment"># False！每次返回新迭代器</span>
it = <span class="hljs-built_in">iter</span>(lst)
<span class="hljs-built_in">iter</span>(it) <span class="hljs-keyword">is</span> it          <span class="hljs-comment"># True！迭代器的 __iter__ 返回自己</span>
</code></pre>
</li>
<li>
<p><strong>生成器表达式 vs 列表推导式</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 列表推导式：立即计算，占内存</span>
squares_list = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]

<span class="hljs-comment"># 生成器表达式：延迟计算，省内存</span>
squares_gen = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">延伸思考</h2>
<ul>
<li>
<p><strong><code>yield from</code> 是什么？</strong><br/>
它用于“委托”另一个生成器，避免嵌套 <code>for</code> 循环。比如合并多个生成器流。</p>
</li>
<li>
<p><strong>生成器能接收外部数据吗？</strong><br/>
可以！通过 <code>generator.send(value)</code> 实现双向通信，常用于协程（async/await 的底层基础之一）。</p>
</li>
<li>
<p><strong>为什么 <code>range()</code> 不是生成器？</strong><br/>
因为它是<strong>可重复迭代的序列对象</strong>，且支持 <code>len()</code>、索引等操作——生成器做不到这些。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-7">小结 &amp; 行动号召 💡</h2>
<ul>
<li><strong>迭代器</strong>：协议驱动，手动实现，灵活但啰嗦</li>
<li><strong>生成器</strong>：<code>yield</code> 一行搞定，内存友好，开发首选</li>
</ul>
<blockquote>
<p>下次当你需要处理“大量数据”“无限序列”或“流式输入”时，记得问自己：<br/>
<strong>“我能用生成器让它‘懒’一点吗？”</strong></p>
</blockquote>
<p>试试改写你项目中的某个循环，用生成器替代列表推导式，观察内存变化吧！欢迎在评论区分享你的“懒人优化”成果～ 🧪✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪]]></title>    <link>https://juejin.cn/post/7583225356905431080</link>    <guid>https://juejin.cn/post/7583225356905431080</guid>    <pubDate>2025-12-14T14:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583225356905431080" data-draft-id="7583234966635216930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪"/> <meta itemprop="keywords" content="Java,Spring Boot,面试"/> <meta itemprop="datePublished" content="2025-12-14T14:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:24:35.000Z" title="Sun Dec 14 2025 14:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 启动流程源码解析：从 <code>main()</code> 到 Web 服务就绪</h2>
<blockquote>
<p><strong>一句 <code>SpringApplication.run()</code> 背后，藏着整个 Spring 生态的启动引擎。</strong></p>
</blockquote>
<p>你是否曾：</p>
<ul>
<li>在面试被问：“Spring Boot 启动过程做了哪些事？”</li>
<li>遇到启动慢、Bean 找不到、配置不生效等问题却无从下手？</li>
<li>想自定义启动行为（如动态加载配置、埋点监控），但不知从何切入？</li>
</ul>
<p>答案，都在 <strong><code>SpringApplication.run()</code> 的源码里</strong>。</p>
<p>今天，我们就<strong>逐行拆解 Spring Boot 3.x（兼容 2.x）的启动主流程</strong>，带你从 <code>main()</code> 方法一路走到内嵌 Tomcat 启动完成！</p>
<h3 data-id="heading-1">一、入口：<code>main()</code> 方法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">MyApp</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<p>看似简单，实则调用了 <code>SpringApplication</code> 的静态方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// SpringApplication.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">Class&lt;?&gt; primarySource, <span class="hljs-built_in">String</span>... args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">run</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] { primarySource }, args);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">Class&lt;?&gt;[] primarySources, <span class="hljs-built_in">String</span>[] args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(primarySources).<span class="hljs-title function_">run</span>(args);
}
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：先构造 <code>SpringApplication</code> 实例，再调用其 <code>run()</code> 方法。</p>
</blockquote>
<h3 data-id="heading-2">二、阶段 1：构造 <code>SpringApplication</code> 对象</h3>
<pre><code class="hljs language-scss" lang="scss">public <span class="hljs-built_in">SpringApplication</span>(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) {
    this<span class="hljs-selector-class">.resourceLoader</span> = resourceLoader;
    Assert<span class="hljs-selector-class">.notNull</span>(primarySources, "PrimarySources must not be null");
    this<span class="hljs-selector-class">.primarySources</span> = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));

    <span class="hljs-comment">// 1. 推断应用类型（SERVLET / REACTIVE / NONE）</span>
    this<span class="hljs-selector-class">.properties</span><span class="hljs-selector-class">.setWebApplicationType</span>(WebApplicationType.deduceFromClasspath());

    <span class="hljs-comment">// 2. 从 spring.factories 加载 BootstrapRegistryInitializer</span>
    this<span class="hljs-selector-class">.bootstrapRegistryInitializers</span> = new ArrayList&lt;&gt;(
                getSpringFactoriesInstances(BootstrapRegistryInitializer.class));

    <span class="hljs-comment">// 3. 从 spring.factories 加载 ApplicationContextInitializer</span>
    <span class="hljs-built_in">setInitializers</span>((Collection) <span class="hljs-built_in">getSpringFactoriesInstances</span>(ApplicationContextInitializer.class));

    <span class="hljs-comment">// 4. 从 spring.factories 加载 ApplicationListener</span>
    <span class="hljs-built_in">setListeners</span>((Collection) <span class="hljs-built_in">getSpringFactoriesInstances</span>(ApplicationListener.class));

    <span class="hljs-comment">// 5. 推断主配置类（即包含 main 方法的类）</span>
    this<span class="hljs-selector-class">.mainApplicationClass</span> = <span class="hljs-built_in">deduceMainApplicationClass</span>();
}
</code></pre>
<h4 data-id="heading-3">🔑 核心动作：</h4>
<ul>
<li>
<p><strong>推断 Web 类型</strong>：</p>
<pre><code class="hljs language-css" lang="css">SERVLET：classpath 中存在 Spring MVC 相关类（如 DispatcherServlet）
REACTIVE：存在 WebFlux 相关类（如 DispatcherHandler）
<span class="hljs-attribute">NONE</span>：非 Web 应用（如批处理、定时任务）
</code></pre>
</li>
<li>
<p><strong>加载扩展点</strong>：通过 <code>SpringFactoriesLoader</code> 读取 <code>META-INF/spring.factories</code> 中的 SPI 实现。</p>
</li>
</ul>
<blockquote>
<p>💡 这就是 Spring Boot <strong>自动装配和扩展机制的起点</strong>。</p>
</blockquote>
<h3 data-id="heading-4">三、阶段 2：执行 <code>run(args)</code> —— 启动主流程</h3>
<p>这是最核心的方法，我们分步解析：</p>
<h4 data-id="heading-5">步骤 1：准备监听器</h4>
<pre><code class="hljs language-ini" lang="ini">SpringApplicationRunListeners <span class="hljs-attr">listeners</span> = getRunListeners(args)<span class="hljs-comment">;</span>
listeners.starting(bootstrapContext, this.mainApplicationClass)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>getRunListeners()</code> 返回所有 <code>SpringApplicationRunListener</code> 实例（默认是 <code>EventPublishingRunListener</code>）</li>
<li><code>starting()</code> 发布 <strong><code>ApplicationStartingEvent</code></strong><br/>
→ 可用于早期日志初始化、APM 埋点</li>
</ul>
<h4 data-id="heading-6">步骤 2：准备 Environment（环境）</h4>
<pre><code class="hljs language-ini" lang="ini">DefaultBootstrapContext <span class="hljs-attr">bootstrapContext</span> = createBootstrapContext()<span class="hljs-comment">;</span>
ConfigurableEnvironment <span class="hljs-attr">environment</span> = prepareEnvironment(listeners, bootstrapContext, applicationArguments)<span class="hljs-comment">;</span>
</code></pre>
<p>在 <code>prepareEnvironment()</code> 中：</p>
<ul>
<li>创建 <code>Environment</code>（StandardServletEnvironment）</li>
<li>调用 <code>environmentPrepared()</code> → 发布 <strong><code>ApplicationEnvironmentPreparedEvent</code></strong></li>
<li><strong>此时 <code>application.properties</code> 已加载！</strong></li>
</ul>
<blockquote>
<p>🌟 <strong>实战价值</strong>：Nacos/Apollo 客户端在此阶段注入远程配置！</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">步骤 3：创建 ApplicationContext（应用上下文）</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">context</span> = createApplicationContext()<span class="hljs-comment">;</span>
</code></pre>
<p>根据 <code>webApplicationType</code> 选择上下文类型：</p>
<ul>
<li><code>SERVLET</code> → <code>AnnotationConfigServletWebServerApplicationContext</code></li>
<li><code>REACTIVE</code> → <code>AnnotationConfigReactiveWebServerApplicationContext</code></li>
</ul>
<p>该上下文继承自 <code>GenericApplicationContext</code>，并具备 <strong>内嵌 Web 容器支持</strong>。</p>
<h4 data-id="heading-8">步骤 4：准备上下文</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">prepareContext</span>(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);
</code></pre>
<p>内部关键操作：</p>
<ul>
<li>注册 <code>banner</code> Bean</li>
<li>应用所有 <code>ApplicationContextInitializer</code></li>
<li>发布 <code>ApplicationContextInitializedEvent</code></li>
</ul>
<blockquote>
<p>⚠️ 注意：此时 <strong>Bean 还未实例化</strong>，只是定义已加载。</p>
</blockquote>
<h4 data-id="heading-9">步骤 5：刷新上下文（Refresh）—— 最重量级阶段！</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">refreshContext</span>(context);
</code></pre>
<p>最终调用 <code>AbstractApplicationContext.refresh()</code>（Spring Framework 的核心方法）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        <span class="hljs-comment">// 1. 准备刷新（记录启动时间、设置活跃状态）</span>
        <span class="hljs-built_in">prepareRefresh</span>();

        <span class="hljs-comment">// 2. 获取 BeanFactory（通常是 DefaultListableBeanFactory）</span>
        ConfigurableListableBeanFactory beanFactory = <span class="hljs-built_in">obtainFreshBeanFactory</span>();

        <span class="hljs-comment">// 3. 配置 BeanFactory（设置类加载器、表达式解析器等）</span>
        <span class="hljs-built_in">prepareBeanFactory</span>(beanFactory);

        <span class="hljs-comment">// 4. 执行 BeanFactoryPostProcessor（如 @ConfigurationProperties 绑定）</span>
        <span class="hljs-built_in">invokeBeanFactoryPostProcessors</span>(beanFactory);

        <span class="hljs-comment">// 5. 注册 BeanPostProcessor</span>
        <span class="hljs-built_in">registerBeanPostProcessors</span>(beanFactory);

        <span class="hljs-comment">// 6. 初始化 MessageSource（国际化）</span>
        <span class="hljs-built_in">initMessageSource</span>();

        <span class="hljs-comment">// 7. 初始化事件广播器</span>
        <span class="hljs-built_in">initApplicationEventMulticaster</span>();

        <span class="hljs-comment">// 8. 【模板方法】子类可扩展（如 ServletWebServerApplicationContext 会在此启动内嵌容器）</span>
        <span class="hljs-built_in">onRefresh</span>();

        <span class="hljs-comment">// 9. 注册监听器</span>
        <span class="hljs-built_in">registerListeners</span>();

        <span class="hljs-comment">// 10. 实例化所有非懒加载的单例 Bean！</span>
        <span class="hljs-built_in">finishBeanFactoryInitialization</span>(beanFactory);

        <span class="hljs-comment">// 11. 完成刷新（发布 ContextRefreshedEvent）</span>
        <span class="hljs-built_in">finishRefresh</span>();
    }
}
</code></pre>
<h5 data-id="heading-10">🔥 重点子阶段解析：</h5>
<ul>
<li>
<p><strong><code>invokeBeanFactoryPostProcessors</code></strong><br/>
→ <code>ConfigurationClassPostProcessor</code> 扫描 <code>@Component</code>、<code>@Bean</code>，解析自动配置类（<code>spring.factories</code> 中的 <code>EnableAutoConfiguration</code>）</p>
</li>
<li>
<p><strong><code>onRefresh()</code>（在 Servlet 上下文中）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onRefresh</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onRefresh</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">createWebServer</span>(); <span class="hljs-comment">// 启动内嵌 Tomcat/Jetty</span>
    }
}
</code></pre>
</li>
<li>
<p><strong><code>finishBeanFactoryInitialization</code></strong><br/>
→ 调用 <code>preInstantiateSingletons()</code>，触发所有单例 Bean 的创建（包括依赖注入、<code>@PostConstruct</code>）</p>
</li>
</ul>
<h4 data-id="heading-11">步骤 6：执行 Runner 启动完成</h4>
<pre><code class="hljs language-scss" lang="scss">/ 执行 CommandLineRunner / ApplicationRunner
<span class="hljs-built_in">callRunners</span>(context, applicationArguments);
</code></pre>
<blockquote>
<p>✅ 此时服务已完全就绪，可处理请求！</p>
</blockquote>
<h3 data-id="heading-12">四、启动流程全景图（简化版）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">ain</span>()
  ↓
new <span class="hljs-built_in">SpringApplication</span>()
  ├── 推断 Web 类型
  ├── 加载 Initializers &amp; Listeners
  ↓
<span class="hljs-built_in">run</span>(args)
  ├── <span class="hljs-built_in">starting</span>() → ApplicationStartingEvent
  ├── <span class="hljs-built_in">prepareEnvironment</span>() → 加载 application<span class="hljs-selector-class">.properties</span>
  ├── <span class="hljs-built_in">createApplicationContext</span>()
  ├── <span class="hljs-built_in">prepareContext</span>() → 注册主配置类
  ├── <span class="hljs-built_in">refreshContext</span>()
  │     ├── invokeBeanFactoryPostProcessors → 自动配置生效
  │     ├── <span class="hljs-built_in">onRefresh</span>() → 启动内嵌 Web 容器
  │     └── finishBeanFactoryInitialization → 初始化所有 Bean
  ├── <span class="hljs-built_in">callRunners</span>() → 执行启动后任务
</code></pre>
<h3 data-id="heading-13">五、学源码有什么用？实战场景举例</h3>



































<table><thead><tr><th>场景</th><th>利用的启动阶段</th><th>扩展方式</th></tr></thead><tbody><tr><td>动态加载远程配置</td><td><code>environmentPrepared</code></td><td>实现 <code>EnvironmentPostProcessor</code></td></tr><tr><td>启动耗时分析</td><td><code>starting()</code> / <code>running()</code></td><td>自定义 <code>SpringApplicationRunListener</code></td></tr><tr><td>服务注册延迟</td><td><code>ContextRefreshedEvent</code> 后</td><td>监听事件，确保 Bean 全部就绪</td></tr><tr><td>自定义 Banner</td><td><code>prepareContext</code> 阶段</td><td>实现 <code>Banner</code> 接口</td></tr><tr><td>避免循环依赖报错</td><td>理解 <code>finishBeanFactoryInitialization</code> 顺序</td><td>调整依赖关系或使用 <code>@Lazy</code></td></tr></tbody></table>
<p>📌 <strong>关注我</strong>，每天5分钟，带你从 Java 小白变身编程高手！<br/>
👉 点赞 + 关注，让更多小伙伴一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 钩子全集实战（一）：构造与配置阶段]]></title>    <link>https://juejin.cn/post/7583168260797841448</link>    <guid>https://juejin.cn/post/7583168260797841448</guid>    <pubDate>2025-12-14T14:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583168260797841448" data-draft-id="7583249151552274466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 钩子全集实战（一）：构造与配置阶段"/> <meta itemprop="keywords" content="Java,Spring Boot,面试"/> <meta itemprop="datePublished" content="2025-12-14T14:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 钩子全集实战（一）：构造与配置阶段
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:25:34.000Z" title="Sun Dec 14 2025 14:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 钩子全集实战（一）：构造与配置阶段</h2>
<p>在使用 Spring Boot 时，我们通常这样启动一个应用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<p>看起来简洁明了，对吧？但在这短短几行代码背后，Spring Boot 其实悄悄为我们预留了多个“钩子”，这些扩展点允许我们在应用启动的不同阶段注入自定义逻辑。</p>
<p>接下来，我将推出一个系列文章，带你系统掌握 Spring Boot 各个阶段的钩子机制。今天是第一篇：<strong>构造与配置阶段</strong>，通俗易懂、代码可运行！</p>
<h3 data-id="heading-1">一、什么是“构造与配置阶段”？</h3>
<p>简单来说，就是你创建 <code>SpringApplication</code> 对象到执行run方法之前的这段时间。</p>
<blockquote>
<p>这个阶段的关键特点是：<strong>还没有真正启动 Spring 容器！</strong></p>
</blockquote>
<h3 data-id="heading-2">二、该阶段的有哪些钩子？</h3>
<p>在这一阶段，我们主要通过配置 <code>SpringApplication</code> 实例来注入自定义行为，常见钩子有：</p>

























<table><thead><tr><th>钩子方法</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td><code>addInitializers(...)</code></td><td>方法调用</td><td>手动添加 <code>ApplicationContextInitializer</code>，用于在容器刷新前修改上下文</td></tr><tr><td><code>addListeners(...)</code></td><td>方法调用</td><td>手动添加 <code>ApplicationListener</code>，监听 Spring 事件</td></tr><tr><td><code>setXXX(...)</code> 系列</td><td>方法调用</td><td>设置主类、Banner 模式、Web 类型等</td></tr></tbody></table>
<h3 data-id="heading-3">三、 应用场景 + 代码示例</h3>
<h4 data-id="heading-4">1. <code>addInitializers(...)</code></h4>
<h5 data-id="heading-5">应用场景</h5>
<ul>
<li>在 Spring 容器刷新（refresh）之前，对 <code>ApplicationContext</code> 进行自定义配置，比如设置环境变量、注册自定义 Bean 定义、修改上下文的属性源等。</li>
<li>适用于需要在容器初始化早期注入全局配置的场景，例如多环境配置增强、自定义属性加载、权限相关的上下文初始化等。</li>
</ul>
<h5 data-id="heading-6">代码示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextInitializer;
<span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext;
<span class="hljs-keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SpringApplication</span> <span class="hljs-variable">application</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(DemoApplication.class);

        <span class="hljs-comment">// 自定义 ApplicationContextInitializer</span>
        ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; customInitializer = context -&gt; {
            <span class="hljs-comment">// 获取环境配置</span>
            <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getEnvironment();
            <span class="hljs-comment">// 新增自定义环境变量</span>
            environment.getSystemProperties().put(<span class="hljs-string">"custom.app.name"</span>, <span class="hljs-string">"SpringHookDemo"</span>);
            <span class="hljs-comment">// 打印初始化日志</span>
            System.out.println(<span class="hljs-string">"ApplicationContext 初始化前：添加自定义环境变量 custom.app.name"</span>);
        };

        <span class="hljs-comment">// 添加初始化器（钩子方法）</span>
        application.addInitializers(customInitializer);

        <span class="hljs-comment">// 启动应用</span>
        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> application.run(args);

        <span class="hljs-comment">// 验证：获取并打印自定义变量</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> context.getEnvironment().getProperty(<span class="hljs-string">"custom.app.name"</span>);
        System.out.println(<span class="hljs-string">"启动后获取的自定义变量："</span> + appName);
    }
}
</code></pre>
<h5 data-id="heading-7">执行结果</h5>
<pre><code class="hljs language-vbnet" lang="vbnet">ApplicationContext 初始化前：添加自定义环境变量 <span class="hljs-keyword">custom</span>.app.name
启动后获取的自定义变量：SpringHookDemo
</code></pre>
<h4 data-id="heading-8">2. <code>addListeners(...)</code></h4>
<h5 data-id="heading-9">应用场景</h5>
<ul>
<li>监听 Spring Boot 生命周期中的核心事件（如 <code>ApplicationStartedEvent</code>、<code>ApplicationReadyEvent</code>、<code>ApplicationFailedEvent</code> 等），实现自定义的事件响应逻辑。</li>
<li>典型场景：应用启动成功后发送通知（邮件 / 钉钉）、启动失败时记录告警日志、监听上下文刷新事件做数据预热等。</li>
</ul>
<h5 data-id="heading-10">代码示例</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">ApplicationListener</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">context</span>.<span class="hljs-property">event</span>.<span class="hljs-property">ApplicationStartedEvent</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">context</span>.<span class="hljs-property">event</span>.<span class="hljs-property">ApplicationReadyEvent</span>;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span> application = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>);

        <span class="hljs-comment">// 监听应用启动事件（Started：容器已启动，但未处理请求）</span>
        <span class="hljs-title class_">ApplicationListener</span>&lt;<span class="hljs-title class_">ApplicationStartedEvent</span>&gt; startedListener = event -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"事件监听：应用已启动（Started），开始初始化业务数据..."</span>);
            <span class="hljs-comment">// 模拟：初始化缓存、加载字典数据等</span>
        };

        <span class="hljs-comment">// 监听应用就绪事件（Ready：可处理请求）</span>
        <span class="hljs-title class_">ApplicationListener</span>&lt;<span class="hljs-title class_">ApplicationReadyEvent</span>&gt; readyListener = event -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"事件监听：应用已就绪（Ready），发送启动成功通知..."</span>);
            <span class="hljs-comment">// 模拟：调用通知接口、记录启动日志等</span>
        };

        <span class="hljs-comment">// 添加事件监听器（钩子方法）</span>
        application.<span class="hljs-title function_">addListeners</span>(startedListener, readyListener);

        <span class="hljs-comment">// 启动应用</span>
        application.<span class="hljs-title function_">run</span>(args);
    }
}
</code></pre>
<h5 data-id="heading-11">执行结果</h5>
<pre><code class="hljs language-erlang" lang="erlang">事件监听：应用已启动（Started），开始初始化业务数据...
事件监听：应用已就绪（Ready），发送启动成功通知...
</code></pre>
<h4 data-id="heading-12">3. <code>setXXX(...)</code> 系列方法</h4>
<h5 data-id="heading-13">应用场景</h5>
<ul>
<li><code>setMainApplicationClass(Class&lt;?&gt; mainApplicationClass)</code>：手动指定应用主类（默认自动识别，特殊场景下需显式指定）；</li>
<li><code>setBannerMode(Banner.Mode mode)</code>：控制启动 Banner 的显示（关闭 / 控制台 / 日志文件）；</li>
<li><code>setWebApplicationType(WebApplicationType type)</code>：指定应用的 Web 类型（NONE：非 Web 应用、SERVLET：Servlet 容器、REACTIVE：响应式 Web）；</li>
<li><code>setAdditionalProfiles(String... profiles)</code>：设置额外的激活配置文件（如测试 / 生产环境）。</li>
</ul>
<h5 data-id="heading-14">代码示例（常用 set 方法组合）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.WebApplicationType;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.Banner;

@SpringBootApplication
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        SpringApplication application = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SpringApplication</span>(DemoApplication.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 1. 关闭启动 Banner</span>
        application.<span class="hljs-built_in">setBannerMode</span>(Banner.Mode.OFF);

        <span class="hljs-comment">// 2. 指定为非 Web 应用（即使引入 Web 依赖，也不会启动 Tomcat 等容器）</span>
        application.<span class="hljs-built_in">setWebApplicationType</span>(WebApplicationType.NONE);

        <span class="hljs-comment">// 3. 激活 test 配置文件</span>
        application.<span class="hljs-built_in">setAdditionalProfiles</span>(<span class="hljs-string">"test"</span>);

        <span class="hljs-comment">// 4. 手动指定主类（可选，默认自动识别）</span>
        application.<span class="hljs-built_in">setMainApplicationClass</span>(DemoApplication.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 启动应用</span>
        application.<span class="hljs-built_in">run</span>(args);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"非 Web 应用启动完成，激活的配置文件：test"</span>);
    }
}
</code></pre>
<h5 data-id="heading-15">执行结果</h5>
<pre><code class="hljs language-bash" lang="bash">非 Web 应用启动完成，激活的配置文件：<span class="hljs-built_in">test</span>
</code></pre>
<p>（注：启动时不会显示 Spring Boot 的默认 Banner，也不会启动 Tomcat 容器）</p>
<h3 data-id="heading-16">四、总结</h3>
<ol>
<li><code>addInitializers</code> 核心作用是<strong>容器刷新前修改上下文</strong>，适用于早期全局配置注入；</li>
<li><code>addListeners</code> 用于<strong>监听 Spring 事件</strong>，实现启动 / 运行阶段的自定义响应逻辑；</li>
<li><code>setXXX</code> 系列是<strong>配置 SpringApplication 核心属性</strong>，覆盖 Banner、Web 类型、配置文件等基础行为。</li>
</ol>
<p>这些钩子均在 <code>SpringApplication.run()</code> 执行前调用</p>
<p>📌 <strong>关注我</strong>，每天5分钟，带你从 Java 小白变身编程高手！<br/>
👉 点赞 + 关注+转发，让更多小伙伴一起进步！</p>
<p>👉 私信"SpringBoot钩子源码" 获取源码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第5讲:事务——数据一致性的保护伞]]></title>    <link>https://juejin.cn/post/7583576605780590638</link>    <guid>https://juejin.cn/post/7583576605780590638</guid>    <pubDate>2025-12-14T14:40:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780590638" data-draft-id="7583576612390977546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第5讲:事务——数据一致性的保护伞"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-14T14:40:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="骑着bug的coder"/> <meta itemprop="url" content="https://juejin.cn/user/1922418579089566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第5讲:事务——数据一致性的保护伞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1922418579089566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    骑着bug的coder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:40:23.000Z" title="Sun Dec 14 2025 14:40:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>目标:</strong> 理解ACID特性,掌握隔离级别,解决并发问题</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">开篇:一个转账引发的血案</h2>
<p><strong>需求：</strong> 模拟一个简单的转账场景。为了演示，我们需要先准备一张账户表。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 准备工作：创建账户表并初始化数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> account (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'主键'</span>,
    user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    balance <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.00</span> COMMENT <span class="hljs-string">'余额'</span>
) COMMENT <span class="hljs-string">'账户表'</span>;

<span class="hljs-comment">-- 初始化两个用户：用户1有1000元，用户2有0元</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> account (user_id, balance) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1000.00</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">0.00</span>);
</code></pre>
<p>想象一个场景:你给朋友转账1000元。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第1步:从你的账户扣1000</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 第2步:给朋友账户加1000</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
</code></pre>
<p>如果第1步执行成功,你的钱扣了。但第2步突然断电了,朋友没收到钱。</p>
<p>这1000元凭空消失了!</p>
<p>这就是没有事务保护的后果。今天咱们就来搞懂:什么是事务?怎么用事务保证数据不出错?</p>
<hr/>
<h2 data-id="heading-1">一、事务是什么?</h2>
<p><strong>一句话定义:</strong> 事务是一组SQL操作,要么全部成功,要么全部失败,不存在"做一半"的情况。</p>
<h3 data-id="heading-2">事务的基本语法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启事务</span>
<span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-comment">-- 或者用 BEGIN;</span>

<span class="hljs-comment">-- 执行SQL操作</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 提交事务(确认修改)</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 或者回滚事务(撤销修改)</span>
<span class="hljs-keyword">ROLLBACK</span>;
</code></pre>
<h3 data-id="heading-3">转账场景正确写法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 扣款</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 加款</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 检查余额是否正确</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(balance) <span class="hljs-keyword">FROM</span> account <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

<span class="hljs-comment">-- 确认无误,提交</span>
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- 如果有问题,执行 ROLLBACK;</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">二、ACID特性:事务的四大保障</h2>
<p>ACID是事务的四大特性,缺一不可。用转账场景来理解:</p>
<h3 data-id="heading-5">A - 原子性(Atomicity)</h3>
<p><strong>含义:</strong> 事务是最小执行单位,要么全成功,要么全失败。</p>
<p><strong>转账场景:</strong> 扣款和加款必须同时成功。如果加款失败,扣款也要撤销。</p>
<p><strong>怎么实现的?</strong> 靠<strong>undo log(回滚日志)</strong>。MySQL会记录修改前的数据,出错时根据日志回滚。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 成功</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">999</span>; <span class="hljs-comment">-- 失败(用户不存在)</span>
<span class="hljs-keyword">ROLLBACK</span>; <span class="hljs-comment">-- 第1步的扣款会被撤销</span>
</code></pre>
<h3 data-id="heading-6">C - 一致性(Consistency)</h3>
<p><strong>含义:</strong> 事务执行前后,数据的完整性约束不能被破坏。</p>
<p><strong>转账场景:</strong> 转账前后,两个账户的总金额必须不变。</p>
<p><strong>举例:</strong></p>
<ul>
<li>转账前:A有5000,B有3000,总额8000</li>
<li>转账后:A有4000,B有4000,总额还是8000</li>
</ul>
<p><strong>怎么实现的?</strong> 一致性是最终目标，它是由 A (原子性)、I (隔离性)、D (持久性) 共同保证的，再加上应用层的逻辑判断（比如转账金额不能为负数）。</p>
<p>如果总额变了,说明数据不一致了,事务必须回滚。</p>
<h3 data-id="heading-7">I - 隔离性(Isolation)</h3>
<p><strong>含义:</strong> 多个事务并发执行时,互不干扰。</p>
<p><strong>转账场景:</strong> 你给A转账的同时,别人也在给A转账,两个事务不能互相影响。</p>
<p><strong>怎么实现的?</strong> 靠<strong>锁 (Locks)</strong> 和 <strong>MVCC (多版本并发控制)</strong>。</p>
<blockquote>
<ul>
<li><strong>锁</strong>：像红绿灯，阻止冲突的修改。</li>
<li><strong>MVCC</strong>：像平行宇宙，让读写互不干扰。</li>
<li><em>(这两个概念非常重要，我们会在第7讲专门深入讲解)</em></li>
</ul>
</blockquote>
<p><strong>问题:</strong> 这是最复杂的特性,后面会详细讲"隔离级别"。</p>
<h3 data-id="heading-8">D - 持久性(Durability)</h3>
<p><strong>含义:</strong> 事务一旦提交,数据永久保存,即使系统崩溃也不会丢。</p>
<p><strong>转账场景:</strong> 提交后显示"转账成功",这时就算断电,钱也不会丢。</p>
<p><strong>怎么实现的?</strong> 靠<strong>redo log(重做日志)</strong>。提交时先写日志,崩溃后根据日志恢复。</p>
<blockquote>
<p>💡 <strong>小贴士</strong>：Undo Log 和 Redo Log 是 MySQL InnoDB 引擎的底层核心。如果你觉得这两个概念有点抽象，别担心，我们会在后续的章节中详细拆解它们的内部结构。现在你只需要记住：<strong>Undo Log 管回滚（原子性），Redo Log 管不丢（持久性）</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、并发事务带来的问题</h2>
<p>如果数据库只有一个用户，那上面的ACID很简单。但现实是，每一秒都可能有成千上万个事务在同时运行。当他们同时操作同一条数据时，就会出现各种奇葩问题。</p>
<h3 data-id="heading-10">1. 脏读 (Dirty Read) —— 读到了“假数据”</h3>
<p><strong>场景：</strong>
事务A修改了数据但还没提交，事务B却读到了这个修改。结果事务A回滚了，事务B读到的就是“脏数据”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/606e771e574a47d1bdaadf3e3cab6202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=DdDY7qRCW6VcW51qLhizwJzU%2FiM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">2. 不可重复读 (Non-repeatable Read) —— 读着读着变了</h3>
<p><strong>场景：</strong>
事务A先读了一次数据，然后事务B修改并提交了。事务A再读一次，发现数据变了！
“不可重复读”的意思就是：<strong>在同一个事务里，同样的查询，读到的结果不一致。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a6ef16913d74efdaa6aa5f41da55a59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=rQapTGMfE8pERfQ4onCSewlNq%2Fk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">3. 幻读 (Phantom Read) —— 见鬼了？</h3>
<p><strong>场景：</strong>
事务A查询“存款&gt;1000的用户”，发现只有1个。这时事务B插入了一个新用户并提交。事务A再次查询，发现变成了2个！就像产生了幻觉一样。</p>
<p><strong>区别：</strong></p>
<ul>
<li><strong>不可重复读</strong>：针对<strong>修改 (UPDATE/DELETE)</strong>，同一条记录变了。</li>
<li><strong>幻读</strong>：针对<strong>插入 (INSERT)</strong>，多出了新记录。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9643975c3289408ea630aabfc42382c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=%2BhLH83XHCLkrWEu48KJm01raEt8%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-13">四、事务隔离级别：给并发穿上防护服</h2>
<p>为了解决上面这些问题，SQL标准定义了4种隔离级别。隔离级别越高，数据越安全，但并发性能越差。</p>








































<table><thead><tr><th align="left">隔离级别</th><th align="center">脏读</th><th align="center">不可重复读</th><th align="center">幻读</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>Read Uncommitted</strong> (读未提交)</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="left">裸奔状态，几乎不用</td></tr><tr><td align="left"><strong>Read Committed</strong> (读已提交)</td><td align="center">❌ 解决</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="left"><strong>Oracle/SQL Server 默认</strong>。能读到别人已提交的数据。</td></tr><tr><td align="left"><strong>Repeatable Read</strong> (可重复读)</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="center">✅ 可能</td><td align="left"><strong>MySQL 默认</strong>。确保同一事务内读取一致。</td></tr><tr><td align="left"><strong>Serializable</strong> (串行化)</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="left">排队执行，最安全但最慢</td></tr></tbody></table>
<blockquote>
<p><em>注：MySQL的InnoDB引擎通过MVCC（多版本并发控制）和间隙锁（Gap Lock），在RR级别下其实已经解决了大部分幻读问题。</em></p>
</blockquote>
<h3 data-id="heading-14">实战：查看与修改隔离级别</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看当前隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@transaction</span>_isolation;

<span class="hljs-comment">-- 设置会话隔离级别为 读未提交 (用于复现脏读)</span>
<span class="hljs-keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="hljs-operator">=</span> <span class="hljs-string">'READ-UNCOMMITTED'</span>;
</code></pre>
<h2 data-id="heading-15"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e945e716e4964eaa9a32d070553fd222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=UWbZeDwSJX5LWOCxnR8rGELc8M4%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-16">五、事务的幕后英雄：Undo Log 与 Redo Log</h2>
<p>还记得开头的问题吗？</p>
<ol>
<li><strong>怎么保证原子性（出错能回滚）？</strong> —— 靠 <strong>Undo Log</strong></li>
<li><strong>怎么保证持久性（断电不丢数据）？</strong> —— 靠 <strong>Redo Log</strong></li>
</ol>
<h3 data-id="heading-17">1. Undo Log (回滚日志) —— 后悔药</h3>
<ul>
<li><strong>作用</strong>：记录数据<strong>修改前</strong>的样子。</li>
<li><strong>原理</strong>：
<ul>
<li>你执行 <code>INSERT</code>，它记录一条 <code>DELETE</code>。</li>
<li>你执行 <code>UPDATE x=1</code>，它记录 <code>UPDATE x=0</code>。</li>
</ul>
</li>
<li><strong>时刻</strong>：事务回滚时，或者数据库崩溃重启时，利用Undo Log把数据恢复原样。这也是MVCC（多版本并发控制）实现的基础。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239cf29f00904b6e82f8f324fcad9e52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=Tvs8eeJXv9OHkUgM%2BpfCJZBr06Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">2. Redo Log (重做日志) —— 记账本</h3>
<ul>
<li><strong>作用</strong>：确保数据不丢失。</li>
<li><strong>原理</strong>：<strong>WAL (Write-Ahead Logging)</strong> 技术。
<ul>
<li>修改数据时，先写日志（Redo Log），再写磁盘数据文件。</li>
<li>因为写日志是<strong>顺序写</strong>（极快），写数据文件是<strong>随机写</strong>（慢）。</li>
<li>如果断电，重启后读取Redo Log，把没写进磁盘的数据“重做”一遍。</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104f52228f244e05b597cf228d37db62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=nfLCZMvKNltmcfdXs%2FvSw2PNO3A%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>预告</strong>：Undo Log 和 Redo Log 的底层实现远比我们刚才看到的要精密得多（涉及 Checkpoint、LSN、Double Write 等复杂机制）。
目前我们已经掌握了它们的核心逻辑。接下来的章节，我们将先攻克 “索引” 和 “锁” 这两座大山。当我们集齐了这些拼图后，会有一个专门的章节来**“解剖 InnoDB 的心脏”**，届时我们将深入底层，彻底搞懂这些日志是如何协同工作，支撑起数据库的高可靠性的。</p>
</blockquote>
<hr/>
<h2 data-id="heading-19">六、避坑指南：事务的隐形杀手</h2>
<h3 data-id="heading-20">1. 忘记 <code>autocommit</code></h3>
<p>MySQL 默认是 <code>autocommit=1</code>（自动提交）。这意味着你执行一条 <code>UPDATE</code>，它就立马生效了，没法回滚。</p>
<ul>
<li><strong>建议</strong>：在生产环境操作数据时，显式开启事务 <code>START TRANSACTION</code>，确认无误后再 <code>COMMIT</code>。</li>
</ul>
<h3 data-id="heading-21">2. 长事务 (Long Transaction)</h3>
<p>不要在一个事务里做太久的操作（比如调用第三方接口、处理大文件）。</p>
<ul>
<li><strong>后果</strong>：会锁住大量数据，导致数据库堵塞，甚至把数据库拖垮。</li>
<li><strong>原则</strong>：<strong>速战速决</strong>。事务里只放必要的 SQL 操作。</li>
</ul>
<hr/>
<h2 data-id="heading-22">七、本讲作业</h2>
<ol>
<li><strong>复现脏读</strong>：开启两个终端，将隔离级别设为 <code>READ-UNCOMMITTED</code>，体验一下“读到别人没提交的数据”是什么感觉。</li>
<li><strong>思考题</strong>：为什么MySQL默认选择 <code>Repeatable Read</code>，而Oracle默认选择 <code>Read Committed</code>？（提示：与历史上的主从复制格式有关）。</li>
</ol>
<blockquote>
<p><strong>给初学者的话</strong>：
本讲出现了不少新名词（如 Undo Log, Redo Log, MVCC）。如果觉得一下子消化不了，<strong>完全正常</strong>！
现在的目标是建立“宏观概念”：知道事务能干什么，知道并发会有什么问题。至于底层是怎么实现的，我们在后面的章节会像剥洋葱一样一层层拆解。别急，慢慢来！</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">八、下一讲预告</h2>
<p>事务保证了数据的安全，但如果数据量有几千万行，查询慢得像蜗牛怎么办？</p>
<p><strong>第6讲：索引（上）——B+树与查询加速原理</strong></p>
<ul>
<li>为什么加了索引查询就快了？</li>
<li><strong>B+树</strong>到底长什么样？为什么不用Hash或二叉树？</li>
<li><strong>聚簇索引</strong>和<strong>非聚簇索引</strong>的区别。</li>
<li><strong>联合索引</strong>与<strong>最左匹配原则</strong>是什么？</li>
</ul>
<p>下一讲，我们深入MySQL的“神经系统”，让你的查询飞起来！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL-锁机制]]></title>    <link>https://juejin.cn/post/7583567658253271066</link>    <guid>https://juejin.cn/post/7583567658253271066</guid>    <pubDate>2025-12-14T14:10:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583567658253271066" data-draft-id="7583571595202215974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL-锁机制"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-14T14:10:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coderCatIce"/> <meta itemprop="url" content="https://juejin.cn/user/127981962405726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL-锁机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/127981962405726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coderCatIce
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:10:20.000Z" title="Sun Dec 14 2025 14:10:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MySQL 锁机制</h2>
<h3 data-id="heading-1">一、全局锁（Global Lock）</h3>
<h4 data-id="heading-2">1. 核心定义</h4>
<ul>
<li>
<p><strong>锁定整个MySQL实例</strong>，所有库/表的读写操作均被阻塞</p>
</li>
<li>
<p>仅支持<strong>读操作</strong>（加锁后），所有DDL、DML写操作均被阻塞</p>
</li>
</ul>
<h4 data-id="heading-3">2. 加锁/解锁方式</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加全局读锁（阻塞所有写操作）</span>
FLUSH TABLES <span class="hljs-keyword">WITH</span> READ LOCK (FTWRL);
<span class="hljs-comment">-- 解锁</span>
UNLOCK TABLES;
</code></pre>
<h4 data-id="heading-4">3. 适用场景</h4>
<ul>
<li>
<p><strong>全库逻辑备份</strong>：保证备份数据的一致性</p>
</li>
<li>
<p><strong>替代方案</strong>：MySQL 5.6+ 可使用 <code>mysqldump --single-transaction</code>（仅限InnoDB）</p>
</li>
<li>
<p>MySQL 8.0+ 推荐使用 <code>mysqldump --source-data</code> 或物理备份工具</p>
</li>
</ul>
<h4 data-id="heading-5">4. 核心风险</h4>
<ul>
<li>
<p>加锁期间业务完全阻塞（无法执行任何写操作）</p>
</li>
<li>
<p>主从架构中，主库只读会导致从库同步延迟</p>
</li>
<li>
<p>FTWRL会关闭所有打开的表，可能导致性能抖动</p>
</li>
</ul>
<h3 data-id="heading-6">二、表级锁（Table-Level Lock）</h3>
<h4 data-id="heading-7">1. 基础表锁（READ/WRITE）</h4>




















<table><thead><tr><th>锁类型</th><th>核心定义</th><th>兼容关系（同一张表）</th></tr></thead><tbody><tr><td>表读锁（READ）</td><td><strong>允许所有会话读</strong>，<strong>禁止所有会话写</strong></td><td>多个READ锁兼容；与WRITE锁互斥</td></tr><tr><td>表写锁（WRITE）</td><td><strong>允许持有锁的会话读写</strong>，<strong>禁止其他所有会话读写</strong></td><td>与任何表锁（READ/WRITE）互斥</td></tr></tbody></table>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加表读锁</span>
LOCK TABLES `<span class="hljs-keyword">user</span>` READ;
<span class="hljs-comment">-- 加表写锁</span>
LOCK TABLES `<span class="hljs-keyword">user</span>` WRITE;
<span class="hljs-comment">-- 解锁</span>
UNLOCK TABLES;
</code></pre>
<h4 data-id="heading-8">2. 元数据锁（MDL）</h4>
<h5 data-id="heading-9">核心定义</h5>
<ul>
<li>
<p><strong>自动加锁</strong>的表级锁，保护<strong>表结构</strong>不被并发修改</p>
</li>
<li>
<p>MySQL 5.5+引入，避免DDL与DML冲突</p>
</li>
</ul>
<h5 data-id="heading-10">加锁规则</h5>




















<table><thead><tr><th>操作类型</th><th>加锁类型</th><th>核心特性</th></tr></thead><tbody><tr><td>SELECT/INSERT/UPDATE/DELETE</td><td>MDL读锁（共享）</td><td>多个读锁兼容</td></tr><tr><td>ALTER TABLE/DROP TABLE</td><td>MDL写锁（排他）</td><td>与所有MDL锁互斥</td></tr></tbody></table>
<h5 data-id="heading-11">MDL生命周期</h5>
<ul>
<li>
<p><strong>读锁</strong>：事务开始时自动获取，事务提交/回滚时释放</p>
</li>
<li>
<p><strong>写锁</strong>：DDL执行期间持有，执行完成立即释放</p>
</li>
</ul>
<h5 data-id="heading-12">核心风险：MDL锁等待</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：长事务阻塞DDL</span>
<span class="hljs-comment">-- 会话1（长事务）：</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 获取MDL读锁</span>
<span class="hljs-comment">-- 不提交，保持事务打开</span>

<span class="hljs-comment">-- 会话2（DDL操作）：</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> age <span class="hljs-type">INT</span>;  <span class="hljs-comment">-- 等待MDL写锁，被阻塞！</span>

<span class="hljs-comment">-- 会话3（新查询）：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users LIMIT <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 也被阻塞，等待MDL读锁</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ol>
<li>
<p>监控长事务：<code>SELECT * FROM information_schema.INNODB_TRX;</code></p>
</li>
<li>
<p><strong>DDL操作选择业务低峰期</strong></p>
</li>
<li>
<p>使用Online DDL（MySQL 5.6+）</p>
</li>
</ol>
<h4 data-id="heading-13">3. 意向锁（IS/IX）</h4>
<h5 data-id="heading-14">核心定义</h5>
<ul>
<li>
<p>InnoDB专属<strong>表级标记锁</strong></p>
</li>
<li>
<p><strong>行锁的"意向声明"</strong> ，避免表锁与行锁冲突</p>
</li>
<li>
<p>减少锁冲突检查的开销（无需遍历每行）</p>
</li>
</ul>
<h5 data-id="heading-15">分类与加锁规则</h5>




















<table><thead><tr><th>意向锁类型</th><th>触发条件</th><th>核心作用</th></tr></thead><tbody><tr><td>IS（意向共享）</td><td>事务计划对某些行加S锁前</td><td>标记"表内有/将有共享行锁"</td></tr><tr><td>IX（意向排他）</td><td>事务计划对某些行加X锁前</td><td>标记"表内有/将有排他行锁"</td></tr></tbody></table>
<h5 data-id="heading-16">兼容关系矩阵</h5>













































<table><thead><tr><th>请求锁↓ \ 已有锁 →</th><th>无锁</th><th>IS</th><th>IX</th><th>S（表读锁）</th><th>X（表写锁）</th></tr></thead><tbody><tr><td><strong>IS</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>IX</strong></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><strong>S</strong></td><td>✅</td><td>✅</td><td>❌</td><td>✅</td><td>❌</td></tr><tr><td><strong>X</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr></tbody></table>
<h3 data-id="heading-17">三、行级锁（Row-Level Lock）⭐⭐⭐</h3>
<p><strong>注意：行锁实际上是加在索引上的锁，而在InnoDB中默认加行锁就是加临键锁</strong></p>
<blockquote>
<p>补充注意：仅当 WHERE 条件命中索引列（如主键）时才是行锁，<strong>无索引会升级为表锁</strong>；仅 <a href="https://juejin.cn/post/7581470169840648230" target="_blank" title="https://juejin.cn/post/7581470169840648230">InnoDB存储引擎</a> 有行锁。</p>
</blockquote>
<h4 data-id="heading-18">1. 基本行锁（S锁/X锁）</h4>


























<table><thead><tr><th>锁类型</th><th>核心定义</th><th>兼容关系（同一行）</th><th>加锁场景</th><th>解锁时机</th></tr></thead><tbody><tr><td><strong>共享锁（S锁）</strong></td><td>允许读，禁止写</td><td>S-S兼容，S-X互斥</td><td><code>SELECT ... FOR SHARE</code></td><td>事务提交/回滚</td></tr><tr><td><strong>排他锁（X锁）</strong></td><td>禁止读写</td><td>X-X互斥，X-S互斥</td><td><code>SELECT ... FOR UPDATE</code> <code>UPDATE</code>/<code>DELETE</code></td><td>事务提交/回滚</td></tr></tbody></table>
<h5 data-id="heading-19">兼容性矩阵（同一行）</h5>























<table><thead><tr><th>请求锁 ↓ \ 当前锁 →</th><th>无锁</th><th>S锁</th><th>X锁</th></tr></thead><tbody><tr><td><strong>请求S锁</strong></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>请求X锁</strong></td><td>✅</td><td>❌</td><td>❌</td></tr></tbody></table>
<h4 data-id="heading-20">MySQL 中行锁的使用</h4>
<h5 data-id="heading-21">1. SELECT ... FOR SHARE（共享锁 / S 锁）</h5>
<p><strong>核心说明</strong>：加行级共享锁（S 锁），多个事务可同时对该行加共享锁，但无法加排他锁；适用于只读但需防止数据被修改的场景，MySQL 8.0 前可写为 <code>SELECT ... LOCK IN SHARE MODE</code>（等价）。<strong>兼容 / 阻塞场景</strong>：</p>
<ul>
<li>✅ 允许：其他事务执行 <code>SELECT ... FOR SHARE</code> 锁定该行</li>
<li>✅ 允许：普通 SELECT（不加锁查询）</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR UPDATE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 UPDATE 操作修改该行</li>
<li>❌ 阻塞：其他事务执行 DELETE 操作删除该行</li>
</ul>
<h5 data-id="heading-22">2. SELECT ... FOR UPDATE（排他锁 / X 锁）</h5>
<p><strong>核心说明</strong>：加行级排他锁（X 锁），锁定后其他事务无法对该行加任何锁（共享锁 / 排他锁），仅能执行不加锁的普通查询；锁的释放时机为事务提交或回滚。<strong>兼容 / 阻塞场景</strong>：</p>
<ul>
<li>✅ 允许：普通 SELECT（不加锁查询）</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR SHARE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR UPDATE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 UPDATE 操作修改该行</li>
<li>❌ 阻塞：其他事务执行 DELETE 操作删除该行</li>
</ul>
<h5 data-id="heading-23">3. UPDATE/DELETE 语句（自动加排他锁 / X 锁）</h5>
<p><strong>核心说明</strong>：执行 UPDATE/DELETE 时，InnoDB 会自动为 WHERE 条件命中的行加排他锁（X 锁），锁释放时机为事务提交或回滚；依赖索引实现行锁，无索引则升级为表锁。兼容 / 阻塞场景：同上X锁</p>
<h5 data-id="heading-24">4. INSERT 语句（隐式排他锁 + <strong>间隙锁 / 临键锁</strong>）</h5>
<p><strong>核心说明</strong>：INSERT 会为插入的行自动加排他锁（X 锁）；兼容 / 阻塞场景：同上X锁；与其他不同的是：<strong>若插入列有唯一约束 / 主键，其他事务插入相同值会被阻塞；若无唯一约束，会触发间隙锁 / 临键锁（防止幻读）</strong>。</p>
<h4 data-id="heading-25">补充关键注意事项</h4>
<ol>
<li>
<p><strong>锁生效前提</strong>：仅 InnoDB 引擎下生效，事务需显式开启（关闭自动提交或用 BEGIN/START TRANSACTION）；</p>
</li>
<li>
<p><strong>索引影响</strong>：WHERE 条件未命中索引时，行锁升级为表锁；</p>
</li>
<li>
<p><strong>锁释放时机</strong>：行锁仅在事务 COMMIT/ROLLBACK 时释放，长时间未提交易导致锁等待 / 死锁；</p>
</li>
<li>
<p><strong>死锁处理</strong>：<strong>InnoDB 自动检测死锁并回滚其中一个事务</strong>，可通过 <code>SHOW ENGINE INNODB STATUS</code> 查看死锁日志。</p>
</li>
</ol>
<h4 data-id="heading-26">2. 记录锁、间隙锁、临键锁</h4>
<blockquote>
<p>在InnoDB中默认加行锁就是加临键锁</p>
</blockquote>
<h5 data-id="heading-27">(1) 记录锁（Record Lock）</h5>
<ul>
<li>
<p><strong>锁定单行记录</strong>（基于<strong>主键/唯一</strong>索引）</p>
<ul>
<li>记录锁是上述行锁的一种具体实现</li>
</ul>
</li>
<li>
<p><strong>作用</strong>：<strong>防止并发修改同一行</strong></p>
</li>
<li>
<p><strong>示例</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- id=1的记录被锁定</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<h5 data-id="heading-28">(2) 间隙锁（Gap Lock）</h5>
<ul>
<li>
<p><strong>锁定索引记录之间的间隙</strong>（<strong>不包含记录本身</strong>）</p>
<ul>
<li>即左开右开</li>
</ul>
</li>
<li>
<p><strong>核心作用</strong>：<strong>防止幻读（在RR隔离级别下）</strong></p>
</li>
<li>
<p><strong>触发条件</strong>：RR隔离级别 + 范围查询/非唯一索引等值查询</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例数据：id=10, 20, 30</span>
<span class="hljs-comment">-- 锁定间隙：(10, 20), (20, 30), (30, +∞)</span>
<span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">15</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 阻止其他事务插入 id=16, 25, 35 等记录</span>

<span class="hljs-comment">-- 事务2（被阻塞）：</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">25</span>, <span class="hljs-string">'张三'</span>);
</code></pre>
<p><strong>间隙锁特性</strong>：</p>
<ol>
<li>
<p><strong>仅RR级别生效</strong>：RC级别无间隙锁</p>
</li>
<li>
<p><strong>索引相关</strong>：基于索引的键值间隙</p>
</li>
<li>
<p><strong>多区间锁定</strong>：可能锁定多个间隙</p>
</li>
<li>
<p><strong>兼容性规则</strong>：间隙锁之间<strong>兼容</strong>（两个事务可以锁定相同间隙）</p>
</li>
</ol>
<h6 data-id="heading-29">间隙锁的边界问题</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例表：id (10, 20, 30)</span>
<span class="hljs-comment">-- 最小边界：(-∞, 第一行]</span>
<span class="hljs-comment">-- 最大边界：[最后一行, +∞)</span>
<span class="hljs-comment">-- 中间间隙：(前一行, 后一行)</span>

<span class="hljs-comment">-- 事务1：查询不存在的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">15</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 锁定间隙：(10, 20)  -- 注意：不包含10和20</span>

<span class="hljs-comment">-- 事务2：插入边界值测试</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">9</span>);   <span class="hljs-comment">-- ✅ 允许（不在锁定间隙）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10</span>);  <span class="hljs-comment">-- ✅ 允许（记录已存在，记录锁不冲突）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>);  <span class="hljs-comment">-- ❌ 阻塞（在锁定间隙内）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">20</span>);  <span class="hljs-comment">-- ✅ 允许（记录已存在）</span>
</code></pre>
<h5 data-id="heading-30">(3) 临键锁（Next-Key Lock）</h5>
<ul>
<li>
<p><strong>记录锁 + 间隙锁</strong>（InnoDB默认行锁策略）</p>
</li>
<li>
<p><strong>公式</strong>：临键锁 = 记录锁 + 前一个间隙锁</p>
<ul>
<li>
<p>锁定范围：当前记录 + 前一个间隙</p>
</li>
<li>
<p>即左开右闭</p>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例数据：id=10, 20, 30</span>

<span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 临键锁范围：(10, 20]</span>
<span class="hljs-comment">-- 包含：记录20（记录锁） + 间隙(10, 20)（间隙锁）</span>

<span class="hljs-comment">-- 以下操作此时会被阻塞</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">15</span>);  <span class="hljs-comment">-- 插入间隙</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> name<span class="hljs-operator">=</span><span class="hljs-string">'test'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">-- 修改记录</span>
</code></pre>
<h6 data-id="heading-31">临键锁的特殊情况</h6>
<p><strong>在InnoDB中默认加行锁就是加临键锁，以下时特殊情况</strong></p>
<h6 data-id="heading-32">场景1：唯一索引等值查询</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- id是主键（唯一索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 仅加记录锁，不加间隙锁（因为唯一性保证）</span>
</code></pre>
<h6 data-id="heading-33">场景2：非唯一索引等值查询</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- name有非唯一索引，数据：('A', 'A', 'B', 'B', 'C')</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 锁定：</span>
<span class="hljs-comment">-- 1. 所有name='B'的记录锁</span>
<span class="hljs-comment">-- 2. 间隙锁：(第一个'B', 最后一个'B')</span>
<span class="hljs-comment">-- 3. 可能的前后间隙</span>
</code></pre>
<h6 data-id="heading-34">场景3：范围查询的锁升级</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;=</span> <span class="hljs-number">15</span> <span class="hljs-keyword">AND</span> id <span class="hljs-operator">&lt;=</span> <span class="hljs-number">25</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 可能锁定：</span>
<span class="hljs-comment">-- 1. 所有15-25之间的记录锁</span>
<span class="hljs-comment">-- 2. 间隙：(上一个记录, 15], (15, 25], (25, 下一个记录]</span>
<span class="hljs-comment">-- 实际范围可能大于WHERE条件！</span>
</code></pre>
<h4 data-id="heading-35">3. 行锁与隔离级别的关系</h4>








































<table><thead><tr><th>隔离级别</th><th>记录锁</th><th>间隙锁</th><th>临键锁</th><th>幻读防护</th></tr></thead><tbody><tr><td><strong>READ UNCOMMITTED</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><strong>READ COMMITTED</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><strong>REPEATABLE READ</strong></td><td>✅</td><td>✅</td><td>✅（默认）</td><td>✅</td></tr><tr><td><strong>SERIALIZABLE</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-36">四、乐观锁与悲观锁</h3>
<p>这是<strong>锁的设计思想</strong>，并非 MySQL 内置的具体锁类型，而是业务 / 代码层面的实现方式。</p>
<h4 data-id="heading-37">1. 悲观锁（Pessimistic Lock）</h4>
<ul>
<li>
<p><strong>核心思想</strong>：假设并发冲突一定会发生，<strong>先加锁再操作</strong></p>
</li>
<li>
<p><strong>实现方式</strong>：利用 MySQL 内置锁（如行锁<code>SELECT ... FOR UPDATE</code>、表锁）</p>
</li>
<li>
<p><strong>适用场景</strong>：并发冲突概率高、写操作多的场景</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用行锁实现悲观锁</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- 加排他锁</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
</li>
</ul>
<h4 data-id="heading-38">2. 乐观锁（Optimistic Lock）</h4>
<ul>
<li>
<p><strong>核心思想</strong>：假设并发冲突不会发生，<strong>先操作后校验</strong></p>
</li>
<li>
<p><strong>实现方式</strong>：通过版本号（<code>version</code>）或时间戳（<code>update_time</code>）实现</p>
</li>
<li>
<p><strong>适用场景</strong>：并发冲突概率低、读操作多的场景</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 查询数据时获取版本号</span>
<span class="hljs-keyword">SELECT</span> balance, version <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-comment">-- 2. 更新时校验版本号</span>
<span class="hljs-keyword">UPDATE</span> users 
<span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span>, version<span class="hljs-operator">=</span>version<span class="hljs-operator">+</span><span class="hljs-number">1</span> 
<span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> version<span class="hljs-operator">=</span>原版本号;
<span class="hljs-comment">-- 3. 判断影响行数：若为0则说明版本冲突，需重试</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-39">五、锁机制实战要点</h3>
<h4 data-id="heading-40">1. 索引与锁的关系</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 情况1：使用主键索引（记录锁）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">100</span>;  <span class="hljs-comment">-- 仅锁定id=100的行</span>

<span class="hljs-comment">-- 情况2：使用普通索引</span>
<span class="hljs-comment">-- 假设name有普通索引</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> name<span class="hljs-operator">=</span><span class="hljs-string">'张三'</span>;
<span class="hljs-comment">-- 锁定：1.name='张三'的记录锁 2.相关间隙锁</span>

<span class="hljs-comment">-- 情况3：无索引（表锁！）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> age<span class="hljs-operator">=</span><span class="hljs-number">30</span>;  <span class="hljs-comment">-- 如果age无索引→表锁</span>
</code></pre>
<h4 data-id="heading-41">2. 死锁分析与规避</h4>
<h5 data-id="heading-42">死锁场景示例：</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务1</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 锁定id=1</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-operator">+</span><span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;  <span class="hljs-comment">-- 尝试锁定id=2</span>

<span class="hljs-comment">-- 事务2（并发执行）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-200</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;  <span class="hljs-comment">-- 锁定id=2</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-operator">+</span><span class="hljs-number">200</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 尝试锁定id=1（死锁！）</span>
</code></pre>
<h5 data-id="heading-43">死锁规避策略：</h5>
<ol>
<li><strong>统一加锁顺序</strong>：约定所有事务按相同顺序加锁</li>
<li><strong>减少事务粒度</strong>：拆分大事务，及时提交</li>
<li><strong>使用索引</strong>：避免无索引查询导致表锁</li>
<li><strong>设置超时</strong>：<code>SET innodb_lock_wait_timeout = 30;</code></li>
<li><strong>死锁检测</strong>：<code>SHOW ENGINE INNODB STATUS\G</code> 查看死锁信息</li>
</ol>
<h4 data-id="heading-44">3. 锁优化建议</h4>
<ol>
<li>
<p><strong>索引设计</strong>：为WHERE条件、JOIN条件创建合适索引</p>
</li>
<li>
<p><strong>事务设计</strong>：</p>
<ul>
<li>保持事务短小</li>
<li>避免长事务中的锁持有</li>
<li>批量操作使用LIMIT分批次</li>
</ul>
</li>
<li>
<p><strong>SQL优化</strong>：</p>
<ul>
<li>避免<code>SELECT *</code>，只取需要字段</li>
<li>使用覆盖索引减少回表</li>
<li>避免大范围UPDATE/DELETE</li>
</ul>
</li>
<li>
<p><strong>隔离级别选择</strong>：</p>
<ul>
<li>默认使用RR级别（防幻读）</li>
<li>高并发场景可考虑RC级别（减少间隙锁）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-45">六、锁监控与排查命令</h3>
<h4 data-id="heading-46">1. 锁状态查看</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看表锁使用情况</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES <span class="hljs-keyword">WHERE</span> In_use <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">-- 查看当前锁等待</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCKS;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCK_WAITS;

<span class="hljs-comment">-- 查看事务详情</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;

<span class="hljs-comment">-- 查看MDL锁（MySQL 5.7+）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> performance_schema.metadata_locks;
</code></pre>
<h4 data-id="heading-47">2. InnoDB引擎状态</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看详细锁信息（包含最近死锁）</span>
<span class="hljs-keyword">SHOW</span> ENGINE INNODB STATUS\G

<span class="hljs-comment">-- 重点关注：</span>
<span class="hljs-comment">-- 1. LATEST DETECTED DEADLOCK（最近死锁）</span>
<span class="hljs-comment">-- 2. TRANSACTIONS（当前事务）</span>
<span class="hljs-comment">-- 3. ROW OPERATIONS（行操作）</span>
</code></pre>
<h4 data-id="heading-48">3. 性能监控</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 锁等待超时设置</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'innodb_lock_wait_timeout'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> innodb_lock_wait_timeout <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;

<span class="hljs-comment">-- 死锁检测</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'innodb_deadlock_detect'</span>;
<span class="hljs-comment">-- ON：自动检测死锁（默认）</span>
<span class="hljs-comment">-- OFF：关闭检测，依赖超时机制</span>

<span class="hljs-comment">-- 查看锁统计</span>
<span class="hljs-keyword">SHOW</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'Innodb_row_lock%'</span>;
<span class="hljs-comment">-- Innodb_row_lock_current_waits：当前等待行锁数量</span>
<span class="hljs-comment">-- Innodb_row_lock_time：行锁总等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_time_avg：平均等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_time_max：最长等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_waits：行锁等待总次数</span>
</code></pre>
<h3 data-id="heading-49">七、补充</h3>
<h4 data-id="heading-50">实战建议</h4>
<ol>
<li>
<p><strong>明确索引设计</strong>：了解每个查询使用的索引类型</p>
</li>
<li>
<p><strong>监控锁等待</strong>：定期检查锁等待情况</p>
</li>
<li>
<p><strong>测试锁行为</strong>：在测试环境验证锁范围</p>
</li>
<li>
<p><strong>使用EXPLAIN</strong>：分析查询执行计划，预测锁行为</p>
</li>
<li>
<p><strong>考虑业务场景</strong>：权衡一致性与并发性的需求</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-51"><strong>总结要点</strong></h4>
<ul>
<li>
<p>全局锁用于全库备份，慎用</p>
</li>
<li>
<p>表级锁中，MDL锁是常见阻塞原因</p>
</li>
<li>
<p>行级锁是InnoDB核心，理解记录锁、间隙锁、临键锁的区别</p>
</li>
<li>
<p>RR级别默认使用临键锁防幻读，RC级别无间隙锁</p>
</li>
<li>
<p>死锁可以通过统一加锁顺序、短事务、合适索引来规避</p>
</li>
<li>
<p>监控工具是排查锁问题的关键</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上]]></title>    <link>https://juejin.cn/post/7583168260797399080</link>    <guid>https://juejin.cn/post/7583168260797399080</guid>    <pubDate>2025-12-14T10:48:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583168260797399080" data-draft-id="7582922476223250447" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上"/> <meta itemprop="keywords" content="NPM,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T10:48:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="水冗水孚"/> <meta itemprop="url" content="https://juejin.cn/user/1406974769508679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1406974769508679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    水冗水孚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T10:48:24.000Z" title="Sun Dec 14 2025 10:48:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<ul>
<li>如果要开发一个新项目，传统方式要敲不少命令</li>
<li>如下：使用最新版的vite，创建一个项目，选择对应的框架语言等</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7341b5a436d6484a86304d66f7ec6339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=YI0x%2FdjYTGPUC4XTf%2BWIJtkFSTo%3D" alt="1.png" loading="lazy"/></p>
<p>然后就是安装各种依赖，安装antd、安装路由、安装zustand等，如<code>npm install axios react-router-dom antd ......</code></p>
<ul>
<li>
<p>若每次新开一个常规项目，都执行这样的搭建操作，整体来说，效率略低，不优雅——（毕竟是手动配置）</p>
</li>
<li>
<p>于是，在此基础上，社区有作者提供了进一步的<strong>现成模板</strong>，比如针对于后台管理系统这类业务场景，有React-Admin、Ant-Design-Pro、或者ruoyi这样后台模板框架，开发者根据自己情况适当修改增删功能——（需根据自己公司业务适配修改）</p>
</li>
</ul>
<p>如此这般，后续若再新开常规项目（假设需要新开发一个<strong>茶叶管理系统</strong>），直接复制一份先前已经沉淀好了的框架模板（假设原先沉淀好的就叫做<strong>基础管理系统</strong>）修修改改，在先前的基础上三次开发即可</p>
<h2 data-id="heading-1">自定义脚手架简述</h2>
<h3 data-id="heading-2">新项目手动复制粘贴的痛点</h3>
<p>但是，这里有一个麻烦的地方：</p>
<ul>
<li>首先，我们需要新建一个文件夹，然后把原本沉淀好的一套代码复制过来（假设叫做base-admin）</li>
<li>然后，执行npm i安装依赖</li>
<li>紧接着需要手动修改package.json里面的name的值为新项目名、也要修改index.html文件里面的title标签里面的名字等（当然还可能有其他要修改的），如下：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base-admin"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 修改成："name": "tea-admin",</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.1.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础管理系统<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 修改成：茶叶管理系统 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.jsx"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>所以，我们思考，能不能写一个脚本，通过命令行交互的方式，交互执行一下</p>
</li>
<li>
<p>就自动能够把原本沉淀好的那套base-admin代码拷贝过来</p>
<ul>
<li>并且也能自动够修改package.json里面的name的值为新项目名</li>
<li>也能自动修改index.html文件里面的title标签里面的名字</li>
<li>包括自动执行npm i下载依赖</li>
<li>等其他个性化操作</li>
</ul>
</li>
</ul>
<p><strong>简约来说，这件事，就是自定义脚手架，所做的事情</strong></p>
<h3 data-id="heading-3">自定义脚手架——可定制内容</h3>
<ul>
<li>实际上，自定义脚手架，不仅仅只是做 复制 base-admin 代码→改 name→改 title这样的 基础功能</li>
<li>还可以进阶操作，比如base-admin有8个模块、但是tea-admin只需要3个模块，我们也可以通过命令行，使用自定义脚手架创建项目的时候，选择保留那些模块，或者丢弃那些模块</li>
<li>甚至，自定义脚手架，还可以帮我执行git仓库初始化命令等</li>
</ul>
<p>所以，自定义脚手架的收益就是：</p>
<p><strong>减轻项目初始化的工作量、做到开发的规范和统一，当然也可以灵活的定制一些内容</strong></p>
<h3 data-id="heading-4">自定义脚手架的大致步骤</h3>
<ol>
<li>
<p>把以往的沉淀好的base-admin发布到github/gitlab上（这是前提，要有基础项目框架模板代码，便于后续开发项目的复用）</p>
</li>
<li>
<p>编辑自己的自定义脚手架（就是一个npm项目，带有package.json和一堆js脚本文件）</p>
</li>
<li>
<p>把写好的自定义脚手架（假设叫做self-cli）发布到npm上（或者使用Verdaccio搭建自己的私服npm），然后所有同事可在自己电脑上全局安装npm i self-cli -g</p>
<ol>
<li>使用Verdaccio搭建自己的私服npm，可以参考笔者的这篇文章：《<a href="https://juejin.cn/post/7582844980399521832" target="_blank" title="https://juejin.cn/post/7582844980399521832">20张图的保姆级教程，记录使用Verdaccio在Ubuntu服务器上搭建Npm私服</a>》</li>
</ol>
</li>
<li>
<p>然后，就可以在命令行执行自定义脚手架提供的命令，比如self-cli -V（查看自定义版本号）、或self-cli create tea-admin（使用自定义脚手架self-cli创建新项目tea-admin）</p>
</li>
<li>
<p>这样的话，就会自动拉取git仓库上的base-admin代码</p>
</li>
<li>
<p>紧接着，命令行会提供一些问询交互，以便于创建新项目的时候，可以自定义一些东西（相当于执行npm create vite@latest xxx的效果）</p>
</li>
<li>
<p>最后命令行回车，自动帮我们执行修改base-admin的一些基础信息和其他自定义操作，最后自动执行npm i安装依赖，并跑起来项目</p>
</li>
</ol>
<h2 data-id="heading-5">自定义脚手架常用的包</h2>
<h3 data-id="heading-6">常用包</h3>
<p><strong>强大命令包shelljs可以便捷地运行命令：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fshelljs" target="_blank" title="https://www.npmjs.com/package/shelljs" ref="nofollow noopener noreferrer">www.npmjs.com/package/she…</a></strong></p>
<p>基本的包</p>
<ul>
<li>自定义脚手架要允许在命令行执行命令，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcommander" target="_blank" title="https://www.npmjs.com/package/commander" ref="nofollow noopener noreferrer">commander</a></li>
<li>执行完命令以后，要允许用户输入选择等交互操作，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Finquirer" target="_blank" title="https://www.npmjs.com/package/inquirer" ref="nofollow noopener noreferrer">inquirer</a></li>
<li>要能够拉取git仓库代码，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fdownload-git-repo" target="_blank" title="https://www.npmjs.com/package/download-git-repo" ref="nofollow noopener noreferrer">download-git-repo</a></li>
<li>在拉取代码的过程中，需要有加载loading效果，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fora" target="_blank" title="https://www.npmjs.com/package/ora" ref="nofollow noopener noreferrer">ora</a></li>
<li>在拉取代码的过程中，需要有进度条百分比加载的效果，可使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fprogress" target="_blank" title="https://www.npmjs.com/package/progress" ref="nofollow noopener noreferrer">progress</a></li>
</ul>
<p>如果美化一下命令行，可使用如下包</p>
<ul>
<li>如果想让终端的输出文字五颜六色，可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fchalk" target="_blank" title="https://www.npmjs.com/package/chalk" ref="nofollow noopener noreferrer">chalk</a></li>
<li>如果想让终端输出的文字有字符画效果，可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ffiglet" target="_blank" title="https://www.npmjs.com/package/figlet" ref="nofollow noopener noreferrer">figlet</a></li>
<li>如果想让终端输出的文字呈现表格形式，可以使用  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftable" target="_blank" title="https://www.npmjs.com/package/table" ref="nofollow noopener noreferrer">table</a></li>
<li>如果想让终端输出带有emoji，可以使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fnode-emoji" target="_blank" title="https://www.npmjs.com/package/node-emoji" ref="nofollow noopener noreferrer">node-emoji</a></li>
</ul>
<h3 data-id="heading-7">常用包做的有意思的效果</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7262aa9c06984823b2cb433aa288655f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=v0K%2BIxHu6dvn32UKt4pY2ONNeGU%3D" alt="2.gif" loading="lazy"/></p>
<p>上述效果对应package.json包如下</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"some-npm-pkg"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node index.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chalk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.6.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"commander"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^14.0.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"figlet"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.9.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inquirer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^12.11.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"node-emoji"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ora"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.9.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">其他的包</h3>
<ul>
<li><strong>fs-extra</strong>，增强版的fs文件操作，更好用</li>
<li><strong>ejs</strong>模板引擎，可用来替换模板中的变量</li>
<li><strong>semver</strong>，语义化版本号解析 / 对比（判断版本高低、是否符合规则）</li>
<li><strong>which</strong>，查找系统中可执行文件的路径（如找到 node/npm 等命令的安装位置）</li>
<li><strong>chokidar</strong>，高性能文件监听（监控文件 / 目录变化，如文件修改后自动触发操作）——nodemon核心依赖</li>
<li><strong>portfinder</strong>，自动查找可用端口（避免端口占用，如本地服务自动选端口）</li>
<li><strong>opener</strong>，跨平台打开文件 / 浏览器（如自动打开本地服务页面）</li>
<li><strong>mime</strong>，MIME 类型解析（判断文件 / 请求的内容类型，如 json、html、jpg 等）</li>
<li><strong>giturl</strong>，解析 / 转换 Git 仓库 URL（如把 HTTPS 转 SSH，或提取仓库信息）</li>
<li><strong>npm-request</strong>，简化 HTTP 请求的工具（聚焦 npm 相关接口请求，如查询包、下载包）</li>
<li><strong>clipanion</strong>，Node.js 命令行参数解析（更优雅的 CLI 构建）——对标Conmand</li>
<li><strong>diff</strong>，文本差异对比（测试时验证输出 / 文件变化）</li>
<li><strong>is-windows</strong>，判断是否 Windows 系统</li>
</ul>
<h2 data-id="heading-9">自己写一个简单的<code>self-cli</code></h2>
<h3 data-id="heading-10">首先要有一个基础模板项目 base-admin</h3>
<ul>
<li>笔者已经上传到github上了，地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshuirongshuifu%2Fbase-admin" target="_blank" title="https://github.com/shuirongshuifu/base-admin" ref="nofollow noopener noreferrer">github.com/shuirongshu…</a></li>
<li>base-admin是一个演示的项目，没有太多东西，实际开发中，这里基础模板会有很多东西，比如eslint、prettier等</li>
<li>同时，也可能会有多个模板，比如react技术栈基础模板、vue技术栈基础模板、后台基础模板、前台基础模板等</li>
</ul>
<p>如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8589de30cba4e70804c8cf416573979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=DuRe3Bbrsi2U2%2BUqUbc6KxP6jK8%3D" alt="3.png" loading="lazy"/></p>
<p>需求：</p>
<ul>
<li>当新项目开启的时候，我们使用自定义脚手架在命令行执行self-ci create，</li>
<li>会从git仓库拉取这个base-admin</li>
<li>然后，在命令行中我们可以输入新项目名</li>
<li>输入的新项目名，会自动替换模板引擎和修改package.json文件里面的name</li>
<li>同时，也会自动帮我们执行npm install命令</li>
<li>最后，可以让我们选择，是否启动这个项目(是否npm run dev)</li>
</ul>
<p>就是把原先需要手动复制粘贴项目，修改项目里面的内容的步骤，换成了命令行脚本自动化执行了...</p>
<h3 data-id="heading-11">自定义脚手架完成效果图</h3>
<p>我们先看一下，完成后的效果图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2195afc85e1842b6a2528f43f3761454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=IG9GC7ip3CVHlIcUB0mQu9vgp0o%3D" alt="4.gif" loading="lazy"/></p>
<p>对应拉取的创建并修改的新项目</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1324b7a7cf9a4da3b8fb7f97c8408662~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=bktkw4SMuvgj4rKk8MpZzuq988c%3D" alt="5.png" loading="lazy"/></p>
<ul>
<li>在动态图中，我们可以看到，左上角拉取了项目，名字叫做 pro-new ，这个明显也就是我们输入的新项目的名字</li>
<li>这个是简单案例，实际项目中，控制台的交互会多一些</li>
</ul>
<p>接下来，我们来快速过一下这个脚手架做了那些事情</p>
<h3 data-id="heading-12">commander包定制命令行输入命令</h3>
<p>index.js</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">import</span> { program } <span class="hljs-keyword">from</span> <span class="hljs-string">'commander'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>;
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.js'</span>;

<span class="hljs-keyword">const</span> pkg = fs.<span class="hljs-title function_">readJsonSync</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./package.json'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>));

program
  .<span class="hljs-title function_">version</span>(pkg.<span class="hljs-property">version</span>, <span class="hljs-string">'-v, --version'</span>)
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">'self-cli'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'自定义脚手架工具'</span>);

program
  .<span class="hljs-title function_">command</span>(<span class="hljs-string">'create [app-name]'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'创建一个新的项目'</span>)
  .<span class="hljs-title function_">action</span>(app);

program.<span class="hljs-title function_">parse</span>(process.<span class="hljs-property">argv</span>);
</code></pre>
<h3 data-id="heading-13">shelljs包去判断是否安装了git、执行git clone命令等</h3>
<p>**shelljs 很强大，强的可怕 **</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> shell <span class="hljs-keyword">from</span> <span class="hljs-string">'shelljs'</span>;

<span class="hljs-comment">// 检查 git</span>
<span class="hljs-keyword">if</span> (!shell.<span class="hljs-title function_">which</span>(<span class="hljs-string">'git'</span>)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'❌ 请先安装 git'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 拉取 Git 仓库 - 使用 git clone</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TEMPLATE_REPO</span> = <span class="hljs-string">'shuirongshuifu/base-admin'</span>;
<span class="hljs-keyword">const</span> spinner = <span class="hljs-title function_">ora</span>(<span class="hljs-string">'正在拉取项目...'</span>).<span class="hljs-title function_">start</span>();

<span class="hljs-comment">// 使用 SSH URL</span>
<span class="hljs-keyword">const</span> repoUrl = <span class="hljs-string">`git@github.com:<span class="hljs-subst">${TEMPLATE_REPO}</span>.git`</span>;
<span class="hljs-keyword">const</span> cloneResult = shell.<span class="hljs-title function_">exec</span>(<span class="hljs-string">`git clone <span class="hljs-subst">${repoUrl}</span> <span class="hljs-subst">${projectName}</span>`</span>, { <span class="hljs-attr">silent</span>: <span class="hljs-literal">false</span> });

<span class="hljs-keyword">if</span> (cloneResult.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    spinner.<span class="hljs-title function_">fail</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'拉取失败'</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'错误信息：'</span> + cloneResult.<span class="hljs-property">stderr</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">yellow</span>(<span class="hljs-string">'\n提示：请确保已配置 SSH key，或检查网络连接'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

进入对应目录，并安装项目依赖
<span class="hljs-comment">// 安装依赖</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在安装依赖...'</span>));
<span class="hljs-keyword">const</span> installResult = shell.<span class="hljs-title function_">exec</span>(<span class="hljs-string">`cd <span class="hljs-subst">${projectName}</span> &amp;&amp; npm install`</span>);
<span class="hljs-keyword">if</span> (installResult.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'❌ 依赖安装失败'</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'错误信息：'</span> + installResult.<span class="hljs-property">stderr</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">yellow</span>(<span class="hljs-string">'请手动进入项目目录执行：npm install'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ 项目创建完成！'</span>));
</code></pre>
<h3 data-id="heading-14">ejs包处理模板文件</h3>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 处理 ejs 模板文件</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在处理模板文件...'</span>));
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">processEjsFiles</span> = (<span class="hljs-params">dir</span>) =&gt; {
    <span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(dir);
    files.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(dir, file);
      <span class="hljs-keyword">const</span> stat = fs.<span class="hljs-title function_">statSync</span>(filePath);

      <span class="hljs-keyword">if</span> (stat.<span class="hljs-title function_">isDirectory</span>() &amp;&amp; file !== <span class="hljs-string">'node_modules'</span> &amp;&amp; file !== <span class="hljs-string">'.git'</span>) {
        <span class="hljs-title function_">processEjsFiles</span>(filePath);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ejs'</span>)) {
        <span class="hljs-keyword">const</span> template = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>);
        <span class="hljs-keyword">const</span> rendered = ejs.<span class="hljs-title function_">render</span>(template, { projectName });
        <span class="hljs-keyword">const</span> destPath = filePath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.ejs$/</span>, <span class="hljs-string">''</span>);
        fs.<span class="hljs-title function_">writeFileSync</span>(destPath, rendered, <span class="hljs-string">'utf-8'</span>);
        fs.<span class="hljs-title function_">unlinkSync</span>(filePath);
      }
    });
  };
  <span class="hljs-title function_">processEjsFiles</span>(projectPath);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ 模板文件处理完成'</span>));
</code></pre>
<h3 data-id="heading-15">fs模块直接修改package.json文件</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 package.json</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在修改 package.json...'</span>));
<span class="hljs-keyword">const</span> pkgPath = path.<span class="hljs-title function_">join</span>(projectPath, <span class="hljs-string">'package.json'</span>);
<span class="hljs-keyword">const</span> pkg = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readJson</span>(pkgPath);
pkg.<span class="hljs-property">name</span> = projectName;
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeJson</span>(pkgPath, pkg, { <span class="hljs-attr">spaces</span>: <span class="hljs-number">2</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ package.json 修改完成'</span>));
</code></pre>
<p>等，不赘述...</p>
<h2 data-id="heading-16">重点：self-cli为何能够被命令行识别？</h2>
<ul>
<li>上述案例的自定义脚手架，代码并不难，我们思考，为何在命令行执行self-cli命令能够被识别呢</li>
<li>毕竟self-cli并不是操作系统自带的命令</li>
</ul>
<h3 data-id="heading-17">命令行识别逻辑顺序</h3>
<ul>
<li>当我们在命令行中，输入xxx的时候，操作系统会进行如下的查询执行逻辑</li>
<li>比如，先看看这个xxx是不是自带的内部命令，如 ls dir cd 等（是自带的就按照自带的逻辑执行）</li>
<li>不是自带的，就会去环境变量Path里面遍历查找，比如执行了git -v</li>
<li>那么，发现，环境变量真有，找到对应的Path里面对应的路径的值对应的文件夹，再看看文件夹里面是否有对应的exe或cmd或bat，再交给其执行</li>
<li>
<blockquote>
<p>先遍历环境变量里面有那些文件夹，再到对应文件夹里面，再次遍历找对应可执行文件批处理命令（系统先按<code>Path</code>的目录顺序 “逛文件夹”，在每个文件夹里只看直接文件，找 “命令名 + 可执行后缀” 的文件，找到就用，找不到就换下一个文件夹，全逛完都没有就报错）</p>
</blockquote>
</li>
</ul>
<p>报错命令：</p>
<pre><code class="hljs language-bash" lang="bash">C:\Users\lss13&gt;hello
<span class="hljs-string">'hello'</span> 不是内部或外部命令，也不是可运行的程序
或批处理文件。

C:\Users\lss13&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e272fcc287448a491a40dd03e8e96e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=9ytkxPT82vhtIittJE7%2FjIYgzKo%3D" alt="6.png" loading="lazy"/></p>
<p>对应路径的确有exe可执行文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9648a3441cf8459abee5836d7994d5b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=wK%2FLbOoarWv1MzPk%2BUggPS4WjOA%3D" alt="7.png" loading="lazy"/></p>
<p>比如，查看java、python、git、node版本也是上述同样类似的道理</p>
<pre><code class="hljs language-bash" lang="bash">C:\Users\lss13&gt;java -version
java version <span class="hljs-string">"1.8.0_201"</span>
Java(TM) SE Runtime Environment (build 1.8.0_201-b09)
Java HotSpot(TM) 64-Bit Server VM (build 25.201-b09, mixed mode)

C:\Users\lss13&gt;python --version
Python 3.12.8

C:\Users\lss13&gt;git -v
git version 2.45.2.windows.1

C:\Users\lss13&gt;node -v
v22.12.0
</code></pre>
<p>self-cli识别命令，则是当找到node的环境变量path后，在对应文件夹找到了self-cli，如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7ddffb700634fed899cb32fba85b116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=vwhlREzMsiCpReTulHecicT%2BHAM%3D" alt="8.png" loading="lazy"/></p>
<p>注意，这里有三个，分别是</p>
<pre><code class="hljs language-bash" lang="bash">self-cli       <span class="hljs-comment"># Linux/Mac风格脚本</span>
self-cli.cmd   <span class="hljs-comment"># Windows CMD批处理脚本（核心）</span>
self-cli.ps1   <span class="hljs-comment"># PowerShell脚本</span>
</code></pre>
<p>所以，就是如下图的箭头所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3c7a8f2a5042a49a273f8954299b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=UaJk1nONY8ggFoMkrDqhFsAFesY%3D" alt="9.png" loading="lazy"/></p>
<ul>
<li>所以，这里的本质就是通过 npm link给某个包</li>
</ul>
<h3 data-id="heading-18">npm link介绍</h3>
<p>npm link是 npm 专为本地开发 npm 包（比如笔者的self-cli 脚手架）设计的调试工具，核心是通过<strong>软链接（类似 Windows 快捷方式）</strong>  关联本地代码和全局 npm 环境，避免反复安装的麻烦</p>
<ul>
<li>比如这个self-cli 这类自定义 CLI 工具，开发时需要频繁修改代码并测试命令效果，<code>npm link</code> 能让全局执行的 <code>self-cli</code> 命令直接指向本地开发目录的代码</li>
<li>改完代码无需重新全局安装，直接执行命令就能看到最新效果，大幅提升调试效率</li>
</ul>
<p>也就是说，npm link在node的环境变量文件夹里面创建了一个链接，让我们在命令行执行对应的命令的时候，系统能够识别，能够找到对应的脚本js文件，做对应的执行处理</p>
<p>在对应的自定义脚手架里面执行npm link会自动生成可执行文件和软连接，这样就能达到全局挂载可使用的效果了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb10a8eae9c477395953d008c6c1fc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=H3EtZ7RuQFzLoGvL%2F9zdTeP41cw%3D" alt="10.gif" loading="lazy"/></p>
<p>不过，我们还需要在package.json文件里面，加上bin规则，告知self-cli要执行那个js文件，同时，对应js文件，要加格式固定：<code>#!/usr/bin/env node</code></p>
<p>即：</p>
<p>package.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"self-cli"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.3"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"自定义脚手架工具"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"self-cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./index.js"</span>  <span class="hljs-comment">// 这个</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>index.js</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这个</span>
#!<span class="hljs-regexp">/usr/</span>bin/env node 

<span class="hljs-keyword">import</span> { program } <span class="hljs-keyword">from</span> <span class="hljs-string">'commander'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>;
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.js'</span>;

......
</code></pre>
<h3 data-id="heading-19">npm link 与 npm install xyz -g的差异</h3>























<table><thead><tr><th>方式</th><th>本质</th><th>代码修改后效果</th><th>适用场景</th></tr></thead><tbody><tr><td>npm link</td><td>创建软链接（快捷方式）</td><td>实时生效，无需额外操作</td><td>本地开发、频繁改代码</td></tr><tr><td>npm install xyz -g</td><td>复制文件到全局目录</td><td>需重新安装才生效</td><td>开发完成后安装最终版本</td></tr></tbody></table>
<ul>
<li>当然，我们本地开发脚手架，使用npm link去全局链接上，方便调试</li>
<li>当这个脚手架self-cli开发完毕后，就可以发到npm上</li>
<li>或者发到公司里面自己搭建的私服npm</li>
<li>搭建私服npm可以参见笔者的这篇文章：<a href="https://juejin.cn/post/7582844980399521832" target="_blank" title="https://juejin.cn/post/7582844980399521832">20张图的保姆级教程，记录使用Verdaccio在Ubuntu服务器上搭建Npm私服</a></li>
<li>这样的话，团队成员就可以全局下载self-cli</li>
<li>就可以在命令行使用对应命令，拉取gitlab仓库代码，自定义创建新项目了</li>
</ul>
<h3 data-id="heading-20">一句话总结前端自定义脚手架</h3>
<p>前端自定义脚手架（比如self-cli）是基于nodejs语法的全局CLI工具，核心价值是基于模板一键生成标准化且可自定义配置的前端项目，从而达到提效的目的</p>
<blockquote>
<p>CLI = 命令行（Command Line）+ 界面（Interface），核心指的是：基于命令行操作的工具或交互方式</p>
</blockquote>
<p>笔者的这个演示脚手架，也发布到npm上面了，不过因为包名不能类似原因，笔者做了修改，现在叫做：<code>s-cli-srsf</code></p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fs-cli-srsf%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/s-cli-srsf?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/s-c…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f035a041e8034c76a8df7df6594570f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=gD9wLYhmxFsXg62jByNzyCQV9XA%3D" alt="11.png" loading="lazy"/></p>
<p>大家可以尝试着</p>
<pre><code class="hljs language-js" lang="js">npm install -g s-cli-srsf
</code></pre>
<p>然后，就会发现，这次生成的就不是npm link那种链接了，是直接安装的文件夹内容</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b895c92da924999891434800233ca79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=6%2BdB%2F9oxK4ImDhIHk3GJ%2FSXGVPQ%3D" alt="12.png" width="70%" loading="lazy"/>
<p>全局安装以后，就可以愉快地创建项目了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92b09cecbe874ebcb3c2a222dfb1cc74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=D%2B1PZIEvL3UR6IErwA2h1NbPrZk%3D" alt="13.png" loading="lazy"/></p>
<h3 data-id="heading-21">回顾package.json常用的配置键值对</h3>
<p>回顾一下知识点</p>



























































































































































<table><thead><tr><th>键名</th><th>类型</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>name</td><td>String</td><td>包的名称，必须唯一</td><td>"my-package"</td></tr><tr><td>version</td><td>String</td><td>版本号，遵循语义化版本控制</td><td>"1.0.0"</td></tr><tr><td>description</td><td>String</td><td>包的简短描述</td><td>"A sample package"</td></tr><tr><td>keywords</td><td>Array</td><td>关键词数组，用于搜索</td><td>["web", "framework"]</td></tr><tr><td>homepage</td><td>String</td><td>项目主页URL</td><td>"<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">example.com</a>"</td></tr><tr><td>bugs</td><td>Object</td><td>Bug报告地址</td><td>{"url": "<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">github.com/.../issues</a>"}</td></tr><tr><td>license</td><td>String</td><td>许可证类型</td><td>"MIT"</td></tr><tr><td>author</td><td>String/Object</td><td>作者信息</td><td>"Name <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">email@domain.com</a>"</td></tr><tr><td>contributors</td><td>Array</td><td>贡献者列表</td><td>[{"name": "John", "email": "..."}]</td></tr><tr><td>files</td><td>Array</td><td>发布时包含的文件</td><td>["dist/", "lib/"]</td></tr><tr><td>main</td><td>String</td><td>主入口文件</td><td>"index.js"</td></tr><tr><td>browser</td><td>String</td><td>浏览器端入口文件</td><td>"./browser.js"</td></tr><tr><td>bin</td><td>Object</td><td>命令行工具配置</td><td>{"cli": "./bin/cli.js"}</td></tr><tr><td>repository</td><td>Object</td><td>仓库信息</td><td>{"type": "git", "url": "..."}</td></tr><tr><td>scripts</td><td>Object</td><td>脚本命令集合</td><td>{"start": "node index.js"}</td></tr><tr><td>dependencies</td><td>Object</td><td>生产环境依赖</td><td>{"express": "^4.17.1"}</td></tr><tr><td>devDependencies</td><td>Object</td><td>开发环境依赖</td><td>{"jest": "^27.0.0"}</td></tr><tr><td>peerDependencies</td><td>Object</td><td>同级依赖</td><td>{"react": "^17.0.0"}</td></tr><tr><td>optionalDependencies</td><td>Object</td><td>可选依赖</td><td>{"fsevents": "^2.3.2"}</td></tr><tr><td>engines</td><td>Object</td><td>支持的引擎版本</td><td>{"node": "&gt;=14.0.0"}</td></tr><tr><td>os</td><td>Array</td><td>支持的操作系统</td><td>["darwin", "linux"]</td></tr><tr><td>cpu</td><td>Array</td><td>支持的CPU架构</td><td>["x64", "arm64"]</td></tr><tr><td>private</td><td>Boolean</td><td>是否私有包</td><td>true</td></tr><tr><td>workspaces</td><td>Array</td><td>工作区配置</td><td>["packages/*"]</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道]]></title>    <link>https://juejin.cn/post/7583499967237292066</link>    <guid>https://juejin.cn/post/7583499967237292066</guid>    <pubDate>2025-12-15T01:54:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583499967237292066" data-draft-id="7583469866008248355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型的&quot;幻觉&quot;真相：为什么AI总爱一本正经地胡说八道"/> <meta itemprop="keywords" content="AIGC,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T01:54:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T01:54:30.000Z" title="Mon Dec 15 2025 01:54:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道</h2>
<p>在人工智能的热潮中，大模型（LLM）被赋予了"无所不能"的光环。我们期待它能回答任何问题，但现实却常常让人失望——当它不知道答案时，它不会说"我不知道"，而是自信满满地编造一个看似合理却完全错误的信息。</p>
<p>这种现象在AI圈里有个专业名称：<strong>AI幻觉</strong>（Artificial Intelligence Hallucinations）。它不是AI在"说谎"，而是其工作方式的必然结果。今天，让我们深入探讨这个现象的根源，以及为什么大模型会如此"一本正经地胡说八道"。</p>
<h3 data-id="heading-1">一、什么是AI幻觉？不只是"说错话"</h3>
<p>AI幻觉指生成式模型在输出内容时，<strong>生成看似合理但不符合事实、逻辑或上下文语义的信息</strong>的现象。它表现为：</p>
<ul>
<li><strong>虚构事实</strong>：生成不存在的人物、事件或数据（如"2024年巴黎奥运会开幕式"的假图片）</li>
<li><strong>逻辑矛盾</strong>：同一回答中前后结论冲突（如"巴黎是法国首都，但法国首都是罗马"）</li>
<li><strong>语义偏差</strong>：对指令的误解导致答非所问（如将"画一只飞行的企鹅"理解为"企鹅坐在飞机里"）</li>
</ul>
<p><strong>最可怕的是</strong>：这些错误往往"看起来很合理"，让使用者难以辨别。</p>
<h3 data-id="heading-2">二、为什么大模型会"胡说八道"？底层逻辑决定一切</h3>
<p>大模型的"幻觉"不是偶然错误，而是其<strong>底层工作逻辑的必然结果</strong>。让我们揭开这个谜题：</p>
<h4 data-id="heading-3">1. 不是"查找"，而是"生成"</h4>
<p>大模型不是在"查找"答案，而是在玩"猜词接龙"。它基于训练数据中词与词之间的概率关系，预测下一个最可能的词。</p>
<p>想象你输入："法国的首都是..."，模型会根据训练数据中"法国"和"巴黎"的共现频率，预测"巴黎"是最可能的下一个词。它<strong>不是"知道"巴黎是法国首都</strong>，而是"记得"在训练数据中"法国"和"巴黎"经常一起出现。</p>
<h4 data-id="heading-4">2. 训练目标决定"自信"而非"诚实"</h4>
<p>在训练过程中，模型被鼓励给出"确定性"回答，而不是承认自己的无知。RLHF（基于人类反馈的强化学习）会奖励"自信"的回答，而不是"诚实"的回答。</p>
<p><strong>结果</strong>：模型学会了"为了流畅而牺牲准确"，尤其在信息模糊或复杂时。</p>
<h4 data-id="heading-5">3. "死记硬背"的书呆子</h4>
<p>模型只是在"记忆"训练数据中的模式，而不是真正理解世界。如果训练数据中"加拿大"和"多伦多"经常一起出现，它就会认为多伦多是加拿大的首都（实际上不是）。</p>
<h4 data-id="heading-6">4. "幻觉"的产生机制</h4>
<p>AI幻觉的根源在于模型的训练机制。目前的训练方式更倾向于奖励模型"猜测"答案，而不是鼓励它在面对不确定信息时坦承"我不知道"。</p>
<p>模型的训练目标是让回答看起来合理、流畅，而不是让回答准确。这导致模型倾向于表现得像一个"善于应试的考生"，即使在信息不明确的情况下也会尝试给出一个看似正确的回答。</p>
<h3 data-id="heading-7">三、真实案例：AI幻觉如何影响现实世界</h3>
<h4 data-id="heading-8">案例1：法律领域的"完美谎言"</h4>
<p>2023年，一名律师使用ChatGPT撰写法律文件，引用了6个完全不存在的判例。这些判例包含完整的案件名称、精确的案卷编号，甚至法官的判决意见和法律分析，看起来专业得不得了。结果，这位律师被法庭处罚。</p>
<h4 data-id="heading-9">案例2：医疗建议的致命错误</h4>
<p>某AI问诊平台建议糖尿病患者"每日注射胰岛素50单位"（远超安全剂量），因为模型混淆了不同体重患者的用药标准。患者按照这个错误建议用药，导致需要紧急医疗救助。</p>
<h4 data-id="heading-10">案例3：虚假新闻图片引发恐慌</h4>
<p>生成式AI工具Stable Diffusion生成"特朗普被捕"的假新闻图片，细节逼真但场景完全虚构，引发社交媒体恐慌。</p>
<h3 data-id="heading-11">四、如何减少AI幻觉？实用策略</h3>
<p>面对AI幻觉，我们并非束手无策。以下是一些经过验证的实用策略：</p>
<h4 data-id="heading-12">1. 精准提示词：让AI学会说"我不知道"</h4>
<p>在提示词中明确要求模型："如果不确定，请说明"或"请基于可靠资料回答"。</p>
<p><strong>示例</strong>：</p>
<blockquote>
<p>"请回答以下问题：'2024年最新AI政策是什么？' 如果你不确定，请说明。"</p>
</blockquote>
<h4 data-id="heading-13">2. 检索增强生成（RAG）：让AI先"查资料"再回答</h4>
<p>RAG是目前最有效的解决方案。它让AI先从可靠知识库中检索相关信息，再基于检索结果生成回答，而不是仅依赖内部记忆。</p>
<blockquote>
<p>例如：当用户询问"2024年最新AI政策"，RAG系统会从最新政策库中检索相关信息，确保回答时效性。</p>
</blockquote>
<h4 data-id="heading-14">3. 结构化输出：限制AI的"自由发挥"</h4>
<p>为AI输出定义严格的字段与类型要求（如JSON Schema），避免格式混乱和内容错误。</p>
<blockquote>
<p>例如：在金融场景中，要求模型必须输出固定格式的JSON，包含"交易ID"、"金额"、"状态"三个字段。</p>
</blockquote>
<h4 data-id="heading-15">4. 人类把关：关键环节必须人工审核</h4>
<p>对于医疗、法律等高风险领域，AI生成的内容必须经过专业人员审核，不能完全依赖AI。</p>
<h3 data-id="heading-16">五、结语：理性看待大模型，正确使用AI</h3>
<p>大模型不是魔法，而是一种工具。它的"幻觉"不是缺陷，而是其工作方式的必然结果。理解这一点，我们就能更理性地使用大模型，避免被它的"一本正经"所误导。</p>
<p><strong>记住</strong>：</p>
<ul>
<li>不要期待大模型能回答所有问题</li>
<li>对关键信息进行交叉验证</li>
<li>在高风险场景中，必须有人工审核环节</li>
<li>设计提示词时，明确要求模型承认不确定性</li>
</ul>
<p>未来AGI可能接近完美，但在那之前，我们需要理性看待大模型，扬长避短，才能真正发挥其价值。</p>
<p><em><strong>下次当你问AI一个问题，它给出一个"太完美了"的答案时，记得多问一句："这个信息的来源是什么？"——这才是驾驭大模型的正确方式。</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 实时音频录制与转写 Composable 技术实现]]></title>    <link>https://juejin.cn/post/7583528177559289906</link>    <guid>https://juejin.cn/post/7583528177559289906</guid>    <pubDate>2025-12-14T11:22:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583528177559289906" data-draft-id="7583530023358758950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 实时音频录制与转写 Composable 技术实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-14T11:22:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 实时音频录制与转写 Composable 技术实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:22:51.000Z" title="Sun Dec 14 2025 11:22:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 实时音频录制与转写 Composable 技术实现</h2>
<h3 data-id="heading-1">前言</h3>
<p>本文介绍如何基于 Vue3 Composition API 实现一个实时音频录制与转写的 Composable，涉及 Web Audio API、WebSocket 实时通信、音频格式转换等技术。</p>
<h3 data-id="heading-2">技术栈</h3>
<ul>
<li><strong>Vue3 Composition API</strong>: 组合式函数封装</li>
<li><strong>MediaRecorder API</strong>: 浏览器音频录制</li>
<li><strong>Web Audio API</strong>: 音频流处理与格式转换</li>
<li><strong>WebSocket</strong>: 实时双向通信</li>
<li><strong>TypeScript</strong>: 类型安全</li>
</ul>
<h3 data-id="heading-3">核心功能</h3>
<ol>
<li>实时音频录制（支持暂停/继续/停止）</li>
<li>音频流实时处理与传输</li>
<li>WebSocket 实时通信接收转写结果</li>
<li>实时字幕逐句显示</li>
<li>字幕定时保存机制</li>
</ol>
<h3 data-id="heading-4">技术架构</h3>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────┐
│      useAudioRecorder Composable       │
├─────────────────────────────────────────┤
│  1. 音频录制层 (MediaRecorder)          │
│  2. 音频处理层 (Web Audio API)          │
│  3. 实时通信层 (WebSocket)              │
│  4. 字幕处理层 (文本处理)                │
│  5. 数据持久化层 (定时保存)              │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">一、音频录制实现</h3>
<h4 data-id="heading-6">1.1 获取麦克风权限</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 获取用户麦克风权限</span>
audioStream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>({
  <span class="hljs-attr">audio</span>: {
    <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 回声消除</span>
    <span class="hljs-attr">noiseSuppression</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 降噪</span>
    <span class="hljs-attr">autoGainControl</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 自动增益控制</span>
  },
});
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><code>getUserMedia</code> 返回 <code>MediaStream</code> 对象</li>
<li>音频约束配置优化录音质量</li>
<li>需要用户授权，需要处理权限拒绝情况</li>
</ul>
<h4 data-id="heading-7">1.2 创建 MediaRecorder</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检测浏览器支持的音频格式</span>
<span class="hljs-keyword">const</span> mimeType = <span class="hljs-title class_">MediaRecorder</span>.<span class="hljs-title function_">isTypeSupported</span>(<span class="hljs-string">'audio/webm;codecs=opus'</span>)
  ? <span class="hljs-string">'audio/webm;codecs=opus'</span>  <span class="hljs-comment">// 优先使用 Opus 编码</span>
  : <span class="hljs-string">'audio/webm'</span>;              <span class="hljs-comment">// 降级方案</span>

<span class="hljs-comment">// 创建 MediaRecorder 实例</span>
mediaRecorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaRecorder</span>(audioStream, { mimeType });

<span class="hljs-comment">// 监听数据可用事件</span>
mediaRecorder.<span class="hljs-property">ondataavailable</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
    audioChunks.<span class="hljs-title function_">push</span>(event.<span class="hljs-property">data</span>);  <span class="hljs-comment">// 收集音频块</span>
  }
};

<span class="hljs-comment">// 开始录制（每3秒触发一次 ondataavailable）</span>
mediaRecorder.<span class="hljs-title function_">start</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><code>MediaRecorder</code> 用于录制音频流</li>
<li><code>start(timeslice)</code> 参数控制数据分片间隔</li>
<li>音频数据以 <code>Blob</code> 格式存储</li>
</ul>
<h3 data-id="heading-8">二、音频处理与格式转换</h3>
<h4 data-id="heading-9">2.1 双音频流架构</h4>
<p>为了实现录音保存和实时转写并行，需要创建两个独立的音频上下文：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 音频流1：用于录音保存（原始采样率）</span>
audioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>();
<span class="hljs-keyword">const</span> analyser = audioContext.<span class="hljs-title function_">createAnalyser</span>();
analyser.<span class="hljs-property">fftSize</span> = <span class="hljs-number">256</span>;  <span class="hljs-comment">// 用于音频可视化</span>
audioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream).<span class="hljs-title function_">connect</span>(analyser);

<span class="hljs-comment">// 音频流2：用于实时转写（16000Hz采样率）</span>
asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
</code></pre>
<p><strong>为什么需要双流？</strong></p>
<ul>
<li>录音保存需要高质量（原始采样率）</li>
<li>实时转写需要标准采样率（16000Hz，ASR 标准）</li>
<li>两个流互不干扰，独立处理</li>
</ul>
<h4 data-id="heading-10">2.2 音频格式转换</h4>
<p>Web Audio API 返回的是 <code>Float32Array</code>（范围 -1.0 到 1.0），而 ASR 服务通常需要 16 位 PCM 格式（范围 -32768 到 32767）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 将 Float32 音频转换为 16 位 PCM
 * <span class="hljs-doctag">@param</span> input Float32Array 音频数据
 * <span class="hljs-doctag">@returns</span> Uint8Array 16位PCM数据
 */</span>
<span class="hljs-keyword">const</span> convertTo16BitPCM = (<span class="hljs-attr">input</span>: <span class="hljs-title class_">Float32Array</span>): <span class="hljs-function"><span class="hljs-params">Uint8Array</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(input.<span class="hljs-property">length</span> * <span class="hljs-number">2</span>);  <span class="hljs-comment">// 16位 = 2字节</span>
  <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);
  
  input.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sample, i</span>) =&gt;</span> {
    <span class="hljs-comment">// 限制范围到 [-1, 1]</span>
    <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(-<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, sample));
    
    <span class="hljs-comment">// 转换为16位整数</span>
    <span class="hljs-comment">// 负数: value * 0x8000 = -32768</span>
    <span class="hljs-comment">// 正数: value * 0x7FFF = 32767</span>
    view.<span class="hljs-title function_">setInt16</span>(
      i * <span class="hljs-number">2</span>, 
      value &lt; <span class="hljs-number">0</span> ? value * <span class="hljs-number">0x8000</span> : value * <span class="hljs-number">0x7FFF</span>, 
      <span class="hljs-literal">true</span>  <span class="hljs-comment">// little-endian 字节序</span>
    );
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
};
</code></pre>
<p><strong>转换原理</strong>：</p>
<ul>
<li>Float32: 32位浮点数，范围 [-1.0, 1.0]</li>
<li>16位PCM: 16位整数，范围 [-32768, 32767]</li>
<li>使用线性映射：<code>PCM = Float32 × 32767</code>（正数）或 <code>Float32 × 32768</code>（负数）</li>
</ul>
<h4 data-id="heading-11">2.3 音频分块处理</h4>
<p>使用 <code>ScriptProcessorNode</code> 处理音频流，并按固定大小分块发送：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 常量定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span> = <span class="hljs-number">6400</span>;  <span class="hljs-comment">// 200ms音频数据</span>
<span class="hljs-comment">// 计算：16000Hz × 0.2s × 2字节 = 6400字节</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ASR_SAMPLE_RATE</span> = <span class="hljs-number">16000</span>;  <span class="hljs-comment">// ASR标准采样率</span>

<span class="hljs-comment">// 设置音频处理器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupAudioProcessor</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!wsClient?.<span class="hljs-title function_">isConnected</span>() || !asrAudioContext || !audioStream) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 清空缓冲区</span>
  audioBuffer = [];
  
  <span class="hljs-comment">// 创建音频源</span>
  <span class="hljs-keyword">const</span> asrSource = asrAudioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream);
  
  <span class="hljs-comment">// 创建脚本处理器（已废弃但兼容性好）</span>
  <span class="hljs-comment">// 参数：bufferSize, numberOfInputChannels, numberOfOutputChannels</span>
  audioProcessor = asrAudioContext.<span class="hljs-title function_">createScriptProcessor</span>(<span class="hljs-number">4096</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  
  <span class="hljs-comment">// 连接音频节点</span>
  asrSource.<span class="hljs-title function_">connect</span>(audioProcessor);
  audioProcessor.<span class="hljs-title function_">connect</span>(asrAudioContext.<span class="hljs-property">destination</span>);
  
  <span class="hljs-comment">// 处理音频数据</span>
  audioProcessor.<span class="hljs-property">onaudioprocess</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!wsClient?.<span class="hljs-title function_">isConnected</span>()) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 1. 获取输入音频数据（Float32格式）</span>
    <span class="hljs-keyword">const</span> inputData = e.<span class="hljs-property">inputBuffer</span>.<span class="hljs-title function_">getChannelData</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 转换为16位PCM</span>
    <span class="hljs-keyword">const</span> pcmData = <span class="hljs-title function_">convertTo16BitPCM</span>(inputData);
    
    <span class="hljs-comment">// 3. 累积到缓冲区</span>
    audioBuffer.<span class="hljs-title function_">push</span>(...pcmData);
    
    <span class="hljs-comment">// 4. 达到200ms数据量时发送</span>
    <span class="hljs-keyword">if</span> (audioBuffer.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>) {
      <span class="hljs-keyword">const</span> chunk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(
        audioBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>)
      );
      
      <span class="hljs-comment">// 5. 通过WebSocket发送（二进制数据）</span>
      wsClient.<span class="hljs-title function_">send</span>(chunk, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// false: 不加入消息队列</span>
      
      <span class="hljs-comment">// 6. 移除已发送的数据</span>
      audioBuffer = audioBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>);
    }
  };
};
</code></pre>
<p><strong>分块策略</strong>：</p>
<ul>
<li><strong>块大小</strong>: 6400字节 = 200ms音频</li>
<li><strong>为什么200ms</strong>: 平衡实时性和网络效率
<ul>
<li>太小：网络请求频繁，增加延迟</li>
<li>太大：实时性差，用户体验不佳</li>
</ul>
</li>
<li><strong>缓冲区管理</strong>: 使用数组累积，达到阈值后发送并清空</li>
</ul>
<h3 data-id="heading-12">三、WebSocket 实时通信</h3>
<h4 data-id="heading-13">3.1 连接建立</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 连接WebSocket接收实时转写结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWebSocket</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">recordId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> wsUrl = <span class="hljs-string">`wss://your-server.com/api/asr/realtime`</span>;
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getAuthToken</span>();  <span class="hljs-comment">// 获取认证token</span>
    
    <span class="hljs-comment">// 使用封装的WebSocket客户端 你自己可以封装一个WebSocket的工具类</span>
    wsClient = <span class="hljs-title function_">createWebSocket</span>({
      <span class="hljs-attr">url</span>: wsUrl,
      <span class="hljs-attr">binaryType</span>: <span class="hljs-string">'arraybuffer'</span>,      <span class="hljs-comment">// 支持二进制数据</span>
      <span class="hljs-attr">heartbeatInterval</span>: <span class="hljs-number">30000</span>,       <span class="hljs-comment">// 30秒心跳</span>
      <span class="hljs-attr">reconnectInterval</span>: <span class="hljs-number">3000</span>,        <span class="hljs-comment">// 3秒重连间隔</span>
      <span class="hljs-attr">maxReconnectAttempts</span>: <span class="hljs-number">10</span>,       <span class="hljs-comment">// 最多重连10次</span>
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-title class_">Authorization</span>: token ? <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> : <span class="hljs-string">''</span>,
      },
    }, {
      <span class="hljs-attr">onOpen</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接成功'</span>);
      },
      <span class="hljs-attr">onMessage</span>: <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
        <span class="hljs-title function_">handleTranscriptionMessage</span>(message);
      },
      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket错误:'</span>, event);
      },
      <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接关闭'</span>);
      }
    });
    
    <span class="hljs-keyword">await</span> wsClient.<span class="hljs-title function_">connect</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket连接失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li>使用 WSS（WebSocket Secure）保证传输安全</li>
<li>配置心跳机制保持连接活跃</li>
<li>自动重连机制处理网络波动</li>
<li>Token 认证通过 URL 参数传递（WebSocket 不支持自定义请求头）</li>
</ul>
<h4 data-id="heading-14">3.2 消息处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 处理转写消息
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTranscriptionMessage</span> = (<span class="hljs-params">message: WebSocketMessage</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">let</span> result = message.<span class="hljs-property">data</span>;
    
    <span class="hljs-comment">// 1. 解析JSON消息</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'string'</span>) {
      <span class="hljs-comment">// 错误检查</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'error'</span>) || result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Error'</span>) || result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'timeout'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'收到错误消息:'</span>, result);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">try</span> {
        result = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 解析失败，忽略</span>
      }
    }
    
    <span class="hljs-comment">// 2. 检查错误字段</span>
    <span class="hljs-keyword">if</span> (result?.<span class="hljs-property">error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'WebSocket返回错误:'</span>, result.<span class="hljs-property">error</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 3. 提取转写文本</span>
    <span class="hljs-keyword">const</span> text = result?.<span class="hljs-property">result</span>?.<span class="hljs-property">text</span> || result?.<span class="hljs-property">text</span>;
    <span class="hljs-keyword">if</span> (text) {
      <span class="hljs-comment">// 更新完整字幕</span>
      subtitles.<span class="hljs-property">value</span> = text;
      accumulatedText.<span class="hljs-property">value</span> = text;
      
      <span class="hljs-comment">// 更新当前显示的字幕（逐句显示）</span>
      <span class="hljs-title function_">updateCurrentSubtitle</span>(text, currentSubtitle, lastDisplayedSentenceEnd);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理转写消息失败:'</span>, error);
  }
};
</code></pre>
<h3 data-id="heading-15">四、实时字幕显示</h3>
<h4 data-id="heading-16">4.1 逐句显示逻辑</h4>
<p>实现智能的字幕逐句显示，基于标点符号识别完整句子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 更新当前显示的字幕（逐句显示）
 * <span class="hljs-doctag">@param</span> fullText 完整字幕文本
 * <span class="hljs-doctag">@param</span> currentSubtitle 当前显示的字幕（响应式引用）
 * <span class="hljs-doctag">@param</span> lastDisplayedSentenceEnd 已显示的最后一句的结束位置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateCurrentSubtitle</span> = (<span class="hljs-params">
  fullText: <span class="hljs-built_in">string</span>, 
  currentSubtitle: Ref&lt;<span class="hljs-built_in">string</span>&gt;, 
  lastDisplayedSentenceEnd: Ref&lt;<span class="hljs-built_in">number</span>&gt;
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!fullText) {
    currentSubtitle.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 如果文本长度没有增加，无需更新</span>
  <span class="hljs-keyword">if</span> (fullText.<span class="hljs-property">length</span> &lt;= lastDisplayedSentenceEnd.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 获取新增的文本部分</span>
  <span class="hljs-keyword">const</span> newText = fullText.<span class="hljs-title function_">substring</span>(lastDisplayedSentenceEnd.<span class="hljs-property">value</span>);
  
  <span class="hljs-comment">// 尝试匹配完整句子（以标点符号结尾）</span>
  <span class="hljs-keyword">const</span> sentenceMatch = newText.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^[^。！？\n\.]+[。！？\n\.]+/</span>);
  
  <span class="hljs-keyword">if</span> (sentenceMatch) {
    <span class="hljs-comment">// 找到完整句子</span>
    <span class="hljs-keyword">const</span> completeSentence = sentenceMatch[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (completeSentence) {
      <span class="hljs-comment">// 移除末尾多余的标点符号（保留最后一个）</span>
      <span class="hljs-keyword">const</span> displayText = completeSentence.<span class="hljs-title function_">replace</span>(
        <span class="hljs-regexp">/[。！？\n\.]+$/</span>, 
        <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> match[match.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
      );
      currentSubtitle.<span class="hljs-property">value</span> = displayText;
      
      <span class="hljs-comment">// 更新已显示位置</span>
      lastDisplayedSentenceEnd.<span class="hljs-property">value</span> = 
        lastDisplayedSentenceEnd.<span class="hljs-property">value</span> + sentenceMatch[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 没有完整句子，查找最后一个标点符号</span>
    <span class="hljs-keyword">const</span> lastPunctuationIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'。'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'！'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'？'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'\n'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'.'</span>)
    );
    
    <span class="hljs-keyword">if</span> (lastPunctuationIndex &gt;= lastDisplayedSentenceEnd.<span class="hljs-property">value</span>) {
      <span class="hljs-comment">// 有新的标点符号，显示标点符号之后的内容</span>
      <span class="hljs-keyword">const</span> afterLastPunctuation = fullText.<span class="hljs-title function_">substring</span>(lastPunctuationIndex + <span class="hljs-number">1</span>).<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (afterLastPunctuation) {
        currentSubtitle.<span class="hljs-property">value</span> = afterLastPunctuation;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 没有标点符号，显示新文本部分</span>
      <span class="hljs-keyword">const</span> displayText = newText.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (displayText) {
        currentSubtitle.<span class="hljs-property">value</span> = displayText;
      }
    }
  }
};
</code></pre>
<p><strong>显示策略</strong>：</p>
<ol>
<li><strong>完整句子优先</strong>: 识别以标点符号结尾的完整句子</li>
<li><strong>标点符号处理</strong>: 保留最后一个标点，移除多余的</li>
<li><strong>增量更新</strong>: 只显示新增部分，避免重复显示</li>
<li><strong>容错处理</strong>: 没有标点符号时显示新文本部分</li>
</ol>
<h4 data-id="heading-17">4.2 字幕状态管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应式状态</span>
<span class="hljs-keyword">const</span> subtitles = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);              <span class="hljs-comment">// 完整字幕文本</span>
<span class="hljs-keyword">const</span> currentSubtitle = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);        <span class="hljs-comment">// 当前显示的字幕</span>
<span class="hljs-keyword">const</span> accumulatedText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);        <span class="hljs-comment">// 累积文本</span>
<span class="hljs-keyword">const</span> lastDisplayedSentenceEnd = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 已显示的最后一句的结束位置</span>

<span class="hljs-comment">// 重置字幕状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetSubtitleState</span> = (<span class="hljs-params"/>) =&gt; {
  subtitles.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  currentSubtitle.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  accumulatedText.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  lastDisplayedSentenceEnd.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
};
</code></pre>
<h3 data-id="heading-18">六、完整生命周期管理</h3>
<h4 data-id="heading-19">6.1 开始录音</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">startRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 初始化状态</span>
    audioChunks = [];
    <span class="hljs-title function_">resetSubtitleState</span>();
    subtitleIdentification.<span class="hljs-property">value</span> = <span class="hljs-title function_">uuidv4</span>();
    
    <span class="hljs-comment">// 2. 获取麦克风权限</span>
    audioStream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>({
      <span class="hljs-attr">audio</span>: {
        <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">noiseSuppression</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">autoGainControl</span>: <span class="hljs-literal">true</span>,
      },
    });
    
    <span class="hljs-comment">// 3. 创建音频上下文（用于可视化）</span>
    audioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>();
    <span class="hljs-keyword">const</span> newAnalyser = audioContext.<span class="hljs-title function_">createAnalyser</span>();
    newAnalyser.<span class="hljs-property">fftSize</span> = <span class="hljs-number">256</span>;
    audioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream).<span class="hljs-title function_">connect</span>(newAnalyser);
    analyser.<span class="hljs-property">value</span> = newAnalyser;
    
    <span class="hljs-comment">// 4. 创建 MediaRecorder</span>
    <span class="hljs-keyword">const</span> mimeType = <span class="hljs-title class_">MediaRecorder</span>.<span class="hljs-title function_">isTypeSupported</span>(<span class="hljs-string">'audio/webm;codecs=opus'</span>)
      ? <span class="hljs-string">'audio/webm;codecs=opus'</span>
      : <span class="hljs-string">'audio/webm'</span>;
    mediaRecorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaRecorder</span>(audioStream, { mimeType });
    
    mediaRecorder.<span class="hljs-property">ondataavailable</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
        audioChunks.<span class="hljs-title function_">push</span>(event.<span class="hljs-property">data</span>);
      }
    };
    
    <span class="hljs-comment">// 5. 连接 WebSocket</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">connectWebSocket</span>(currentRecordId.<span class="hljs-property">value</span>);
      <span class="hljs-title function_">startSubtitleSaveTimer</span>();
      
      <span class="hljs-comment">// 6. 创建用于ASR的音频上下文</span>
      <span class="hljs-keyword">if</span> (wsClient?.<span class="hljs-title function_">isConnected</span>()) {
        asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
        <span class="hljs-title function_">setupAudioProcessor</span>();
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket连接失败，继续录音但不显示实时字幕:'</span>, error);
    }
    
    <span class="hljs-comment">// 7. 开始录音</span>
    mediaRecorder.<span class="hljs-title function_">start</span>(<span class="hljs-number">3000</span>);
    isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    recordingTime.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 8. 开始计时</span>
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    recordingTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">100</span>);
      recordingTime.<span class="hljs-property">value</span> = elapsed;
    }, <span class="hljs-number">100</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'开始录音失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<h4 data-id="heading-20">6.2 暂停/继续录音</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 暂停录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pauseRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (mediaRecorder?.<span class="hljs-property">state</span> !== <span class="hljs-string">'recording'</span>) <span class="hljs-keyword">return</span>;
  
  mediaRecorder.<span class="hljs-title function_">pause</span>();
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-comment">// 停止计时器</span>
  <span class="hljs-keyword">if</span> (recordingTimer) {
    <span class="hljs-built_in">clearInterval</span>(recordingTimer);
    recordingTimer = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 停止音频处理器</span>
  <span class="hljs-keyword">if</span> (audioProcessor) {
    audioProcessor.<span class="hljs-title function_">disconnect</span>();
    audioProcessor = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 保存字幕并断开WebSocket</span>
  <span class="hljs-keyword">if</span> (subtitles.<span class="hljs-property">value</span> &amp;&amp; subtitleIdentification.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveCurrentSubtitles</span>();
    <span class="hljs-title function_">stopSubtitleSaveTimer</span>();
  }
  
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">disconnect</span>();
    wsClient = <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-comment">/**
 * 继续录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resumeRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!isPaused.<span class="hljs-property">value</span> || !mediaRecorder) <span class="hljs-keyword">return</span>;
  
  mediaRecorder.<span class="hljs-title function_">resume</span>();
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 重新连接WebSocket</span>
  <span class="hljs-keyword">if</span> (currentRecordId.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">connectWebSocket</span>(currentRecordId.<span class="hljs-property">value</span>);
      <span class="hljs-title function_">startSubtitleSaveTimer</span>();
      
      <span class="hljs-comment">// 重新设置音频处理器</span>
      <span class="hljs-keyword">if</span> (!asrAudioContext &amp;&amp; audioStream) {
        asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
      }
      <span class="hljs-title function_">setupAudioProcessor</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket重连失败，继续录音但不显示实时字幕:'</span>, error);
    }
  }
  
  <span class="hljs-comment">// 恢复计时</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - recordingTime.<span class="hljs-property">value</span> * <span class="hljs-number">100</span>;
  recordingTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">100</span>);
    recordingTime.<span class="hljs-property">value</span> = elapsed;
  }, <span class="hljs-number">100</span>);
};
</code></pre>
<h4 data-id="heading-21">6.3 停止录音与资源清理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 停止录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">stopRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  onStop?: (audioChunks: Blob[], recordId: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!mediaRecorder) <span class="hljs-keyword">return</span>;
  
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-comment">// 停止计时器</span>
  <span class="hljs-keyword">if</span> (recordingTimer) {
    <span class="hljs-built_in">clearInterval</span>(recordingTimer);
    recordingTimer = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 设置停止事件处理</span>
  mediaRecorder.<span class="hljs-property">onstop</span> = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (audioChunks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; currentRecordId.<span class="hljs-property">value</span> &amp;&amp; onStop) {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">onStop</span>(audioChunks, currentRecordId.<span class="hljs-property">value</span>);
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">cleanup</span>();
    }
  };
  
  <span class="hljs-comment">// 停止录音并断开WebSocket</span>
  mediaRecorder.<span class="hljs-title function_">stop</span>();
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">'stop'</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-comment">// 延迟断开，确保最后的消息能收到</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (wsClient) {
        wsClient.<span class="hljs-title function_">disconnect</span>();
        wsClient = <span class="hljs-literal">null</span>;
      }
    }, <span class="hljs-number">500</span>);
  }
  
  <span class="hljs-comment">// 确保显示最后的内容</span>
  <span class="hljs-keyword">if</span> (subtitles.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 处理最后未完成的句子显示逻辑</span>
    <span class="hljs-comment">// ...</span>
  }
  
  <span class="hljs-comment">// 延迟重置状态，确保用户能看到最后的内容</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resetSubtitleState</span>();
  }, <span class="hljs-number">2000</span>);
};

<span class="hljs-comment">/**
 * 清理资源
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanup</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 停止音频流</span>
  <span class="hljs-keyword">if</span> (audioStream) {
    audioStream.<span class="hljs-title function_">getTracks</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">track</span>) =&gt;</span> track.<span class="hljs-title function_">stop</span>());
    audioStream = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 关闭音频上下文</span>
  <span class="hljs-keyword">if</span> (audioContext) {
    audioContext.<span class="hljs-title function_">close</span>();
    audioContext = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (asrAudioContext) {
    asrAudioContext.<span class="hljs-title function_">close</span>();
    asrAudioContext = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 断开音频处理器</span>
  <span class="hljs-keyword">if</span> (audioProcessor) {
    audioProcessor.<span class="hljs-title function_">disconnect</span>();
    audioProcessor = <span class="hljs-literal">null</span>;
  }
  
  analyser.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
  mediaRecorder = <span class="hljs-literal">null</span>;
  
  <span class="hljs-comment">// 清理WebSocket</span>
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">disconnect</span>();
    wsClient = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 停止字幕保存定时器</span>
  <span class="hljs-title function_">stopSubtitleSaveTimer</span>();
  
  <span class="hljs-comment">// 清空音频块和缓冲区</span>
  audioChunks = [];
  audioBuffer = [];
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《回顾我的AI学习之路，上万字的AI学习思维导图分享》]]></title>    <link>https://juejin.cn/post/7583507286317465600</link>    <guid>https://juejin.cn/post/7583507286317465600</guid>    <pubDate>2025-12-15T00:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583507286317465600" data-draft-id="7582919147640750132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《回顾我的AI学习之路，上万字的AI学习思维导图分享》"/> <meta itemprop="keywords" content="前端,后端,产品经理"/> <meta itemprop="datePublished" content="2025-12-15T00:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="华洛"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474430190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《回顾我的AI学习之路，上万字的AI学习思维导图分享》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474430190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    华洛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:01:21.000Z" title="Mon Dec 15 2025 00:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>历时半年，我完成了一份AI学习路径的思维导图。目前思维导图已经公开，今天这篇文章我们着重讲两件事：</p>
<ol>
<li>讲一下如何学习AI以及如何利用这份思维导图更高效的学习。</li>
<li>讲一下这份思维导图的后续规划。</li>
</ol>
<p>这份思维导图拥有八百多个主题节点、九千九百多字、以及相关配图，认真说起来，这不仅仅是一份学习路径思维导图，它更像是一份详实的具有AI学习路径、实践结果、思考过程的学习内容，包含了<code>AI应用的技术工程</code>、<code>AI产品的设计思路</code>、<code>AI需求挖掘方案</code>等几个大模块，每个模块又详细解释具体落地方案。</p>
<p>例如：function call部分，包含了function call的应用，提示词代替function call的方案与优缺点，function call 落地的问题与解决方案，落地应用的实现方案，function call与MCP。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ff08b6a99f64084b0dae79445339eee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=INe65o09JoGdG1GgyrtA8KaX%2F30%3D" alt="fc.png" width="70%" loading="lazy"/>
<p>而function call这一部分知识，只是AI技术工程中的一个节点，AI技术工程中我提供了<code>prompt</code>、<code>RAG</code>、<code>function call</code>、<code>workflow</code>、<code>agent</code>、<code>微调</code>、<code>模型的选择方案</code>、<code>AI产品的辅助系统实现</code>八个模块的内容。</p>
<p>例如：AI需求挖掘部分，什么算是AI需求，现有产品升级AI时的思考方案，AI+ 和 +AI的应用等。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df828c3f13945149c567a454bbdd6b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=PlmYMbMjwuUBgLY%2BWa%2FwzMLYDSE%3D" alt="xuqiu.png" width="70%" loading="lazy"/>
<p>AI需求挖掘是AI产品部分中的一个节点，AI产品部分提供了<code>AI需求</code>、<code>AI语音产品</code>、<code>AI项目</code>、<code>AI产品测试</code>、<code>AI产品日志</code>、<code>TOB的AI应用落地注意事项</code>、<code>TOC的AI应用落地注意事项</code>、<code>TOG的AI应用落地注意事项</code>等内容</p>
<p>再例如：很多人知道SSE交互是<code>new EventSource</code>，但是有很多人并不知道<code>fetch</code>也能实现SSE。</p>
<p>这些内容都在这份思维导图中可查。</p>
<p>略微看一下这份思维导图的好评，然后我们开始正文：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f99717b1f947279cb2bf7541f34553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=HSsyAJ%2Fg%2FoB8murbyRbLw8Un0es%3D" alt="3bea717113ac47b864f2bf917ef461b4.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d02e380371e45528ad7ef2cb269493c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=jETjMUDJyt271jojDeBnczNYOJU%3D" alt="6d069ad4f9283742306bee10fad5a9f0.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd407d74b506447a99553542214469c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=OM6xOkean2TOp0cxpHrEnQPKM%2FQ%3D" alt="1499520837b3f960d19bd6cec09d90e5.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/221dc77111334b92b6c2b71e2866c928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=LsCKOJLuhZ0UoS3B9lic%2BdqpNJc%3D" alt="dd0b8cb925ee4483c042dceda3c7edd1.jpg" width="50%" loading="lazy"/>
<h2 data-id="heading-0">关于学习路径</h2>
<p>最开始，是因为群里不断有人在问，<strong>AI到底应该怎么学？</strong></p>
<p>绝大多数人学习AI的过程是：</p>
<p>决定学习AI =&gt; 陷入AI专业技术中 =&gt; 被大量的概念冲击 =&gt; 一部分人就此放弃；</p>
<p>而坚持下来的人，最终发现AI技术与自身工作偏离太远，而AI工作的门槛又极高，最终坚持不住放弃。</p>
<p>为什么会出现这个情况？</p>
<p>其实本质上大家搞错了学习方向。</p>
<p>实际上我们的学习，尤其是我们成人之后在工作领域的学习，大多都应该以实用与落地为主的，凡是不能落地的学习，最终的结局都是遗忘。</p>
<p>而AI的学习其实是分为两个方向： <strong>1. AI技术层的学习。 2. AI应用层的学习。</strong></p>
<p>我曾经说过的一句话，<strong>科学家下场之后，就是工程师的舞台。</strong> 其实对应的就是技术层和应用层的不同实用场景。</p>
<p>科学家在AI技术层的研究，最终让AI有了面向大众的能力。</p>
<p>而随后在这世间的各行各业中，将AI的能力发扬光大的，都是各行各业的工程师们。</p>
<p>我们绝大多数的普通人，其实充当的是工程师的角色，而在学习时，却选择了科学家的学习路径！</p>
<p>我们应当选择应用层的学习，但是却在学习时大量学习了技术层的内容，这就是为什么总是学习无果的原因。</p>
<p>接下来回到我们的思维导图，来聊聊如何学习AI</p>
<h3 data-id="heading-1">学习方式</h3>
<p>学习开始之前最重要的是确定自己要学习哪些东西，设定阶段性的边界。切记目标不清晰、目标错误。</p>
<p>这份思维导图中，包含了大量的技术点、概念、思考结论等内容。</p>
<p>初期的学习者要从明确的了解AI应用所需的相关的概念开始学习，随后对概念有了正确的了解就可以开始实践相关的技术点。</p>
<p>这里需要着重说一下：很多朋友一上来就想着说，我要做个什么项目，才能学会这些东西吧？</p>
<p>其实不是的，在这个阶段各位所需要的是有目的性的刻意练习。</p>
<p>你在实践function call，你就搞function call。 你在实践RAG，你就搞RAG。</p>
<p>当你对每个技术点都足够掌握之后，就可以动手实现一个项目（如果你没项目，可以看我写的售前项目专栏），然后你就会发现项目中有各种各样的问题。</p>
<p>这时候，你就会发现思维导图中有许多思考和实践后的结论，那些内容可以帮助你度过项目落地的困境。</p>
<p>让我们回到最开始，有很多人会纠结这个问题：我要怎么开始，我是百度？还是刷视频？还是买书？</p>
<p>这里给大家一个建议：我们要学习是所有在应用层的概念、应用和最佳实践。</p>
<p>那么<strong>各大厂商的官方文档</strong>就是各位最好的新手村。</p>
<p>这里的知识是最新的，你不用担心学到过期知识。从这里开始，你会少走很多弯路。</p>
<h4 data-id="heading-2">一：各大模型厂商的官方文档</h4>
<p>各大模型厂商的官方文档中都存在于自身模型最匹配、最权威、且有效的落地方案。</p>
<p>每个模型的厂商都有自己的方案，我们在学习与实现各个厂商不同的方案时，能让我们快速的增长大量经验。</p>
<p>对比学习法 + 带脑子的思考，我们的学习进度会远超平时的看视频、看文章。</p>
<p>厂商的文档地址给大家放在这里，可以自行查看。</p>





























































<table><thead><tr><th><strong>厂商/模型</strong></th><th><strong>官方文档地址</strong></th></tr></thead><tbody><tr><td><strong>OpenAI (GPT系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">platform.openai.com/docs</a></td></tr><tr><td><strong>Google (Gemini系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fdocs" target="_blank" title="https://ai.google.dev/docs" ref="nofollow noopener noreferrer">ai.google.dev/docs</a></td></tr><tr><td><strong>Anthropic (Claude系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fclaude%2Fdocs" target="_blank" title="https://docs.anthropic.com/claude/docs" ref="nofollow noopener noreferrer">docs.anthropic.com/claude/docs</a></td></tr><tr><td><strong>Meta (Llama系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.llama.com%2Fdocs%2Foverview%2F" target="_blank" title="https://www.llama.com/docs/overview/" ref="nofollow noopener noreferrer">www.llama.com/docs/overvi…</a></td></tr><tr><td><strong>百度 (文心一言)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.baidu.com%2Fdoc%2FWENXINWORKSHOP%2Findex.html" target="_blank" title="https://cloud.baidu.com/doc/WENXINWORKSHOP/index.html" ref="nofollow noopener noreferrer">cloud.baidu.com/doc/WENXINW…</a></td></tr><tr><td><strong>阿里云 (通义千问)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio" target="_blank" title="https://help.aliyun.com/zh/model-studio" ref="nofollow noopener noreferrer">help.aliyun.com/zh/model-st…</a></td></tr><tr><td><strong>腾讯 (混元大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F1729" target="_blank" title="https://cloud.tencent.com/document/product/1729" ref="nofollow noopener noreferrer">cloud.tencent.com/document/pr…</a></td></tr><tr><td><strong>华为 (盘古大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fmodelarts%2Findex.html" target="_blank" title="https://support.huaweicloud.com/modelarts/index.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/modelarts/i…</a></td></tr><tr><td><strong>科大讯飞 (星火大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xfyun.cn%2Fdoc%2Fspark%2FWeb.html" target="_blank" title="https://www.xfyun.cn/doc/spark/Web.html" ref="nofollow noopener noreferrer">www.xfyun.cn/doc/spark/W…</a></td></tr><tr><td><strong>智谱AI (ChatGLM)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2Fdev%2Fapi" target="_blank" title="https://open.bigmodel.cn/dev/api" ref="nofollow noopener noreferrer">open.bigmodel.cn/dev/api</a></td></tr><tr><td><strong>月之暗面 (Kimi)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.moonshot.cn%2Fdocs" target="_blank" title="https://platform.moonshot.cn/docs" ref="nofollow noopener noreferrer">platform.moonshot.cn/docs</a></td></tr><tr><td><strong>DeepSeek</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2F" target="_blank" title="https://api-docs.deepseek.com/zh-cn/" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/</a></td></tr><tr><td><strong>字节跳动 (豆包)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379" target="_blank" title="https://www.volcengine.com/docs/82379" ref="nofollow noopener noreferrer">www.volcengine.com/docs/82379</a></td></tr></tbody></table>
<h4 data-id="heading-3">二：AI是学习好伙伴</h4>
<p>AI是学习好伙伴，但是你要有一个基础判断，什么内容相信AI，什么内容需要验证。</p>
<p>记住两件事：<strong>一定要使用AI来学习</strong>、<strong>一定不能全部相信AI内容</strong></p>
<p>我的经验是，通用的、概念性的内容，在我没有产生疑问之前，我默认选择相信AI。</p>
<p>例如：<code>深度学习和机器学习的对比</code>、<code>function call的概念</code>、<code>微调时选择SFT和DPO的区别</code></p>
<p>这类内容，AI的输出大概率都是对的。</p>
<p>而在应用方案上的内容，我通常以AI的输出作为参考，需要加以验证。</p>
<h4 data-id="heading-4">三：提取方法论</h4>
<p>学习一定要实践，现在有AI来协助编程，编写一些基础的代码来配合自己进行学习是很方便的。</p>
<p>例如，可以直接把某个文档扔给AI，告诉AI按照这个文档帮我写一份python代码，并指导我运行。</p>
<p>通常你都会得到一份可用的代码。</p>
<p>当我们学习、实践了之后，我们要做的就是总结经验，提取方法论，优化方法论。</p>
<p>当各位有了自己的方法论之后，这份思维导图也就完成了它的价值。</p>
<p>未来的修行全靠各位自己了。</p>
<h2 data-id="heading-5">关于后续规划</h2>
<p>目前这份万字思维导图已经公开，但是我后续将不再继续维护这份思维导图了，原因有两点：</p>
<p><strong>1.  对于学习者来说，学习路径已经足够清晰了。</strong></p>
<p>对于学习者来说，这份思维导图已经足够清晰，大家按照思维导图去学习、去思考。</p>
<p>花上一些时间去学习，这份思维导图可以保证你的学习路径不会出错。</p>
<p>坚持学完之后，足够掌握工作所需的全部技能了。</p>
<p><strong>2.  对于我来说，时间投入太多了。</strong></p>
<p>这份思维导图维护了半年多，逐渐积累到目前的一万字，期间也接了很多同学的1V1培训，说实话，已经有点忙不过来了。</p>
<p>但是我还是打算开一份新的思维导图进行持续维护。</p>
<p>新的思维导图继续扩展下去，将是不间断的对现有知识体系的细化和对新技术、新方案的补充。</p>
<p>未来将我这几年的实战、学习、思考全部都写进去，所以这不是一份单纯的思维导图，而是一套与AI相关落地相关的全面的方案。</p>
<p>为了保证我的动力，以及学习者的纯粹性（防止广告等行为）， 这个会有一个较低的门槛。</p>
<p>我是华洛，关注我，学习更多AI落地的实战经验与技巧。</p>
<p>加油，共勉。</p>
<blockquote>
<p>☺️你好，我是<strong>华洛</strong>，All in AI多年，专注于AI在产品侧的应用以及企业AI员工的设计。</p>
</blockquote>
<h2 data-id="heading-6">专栏文章</h2>
<p><a href="https://juejin.cn/post/7512332419203727371" target="_blank" title="https://juejin.cn/post/7512332419203727371"># 聊聊我们公司的AI应用工程师每天都干啥？</a></p>
<p><a href="https://juejin.cn/post/7547051639740743721" target="_blank" title="https://juejin.cn/post/7547051639740743721"># SEO还没死，GEO之战已经开始</a></p>
<p><a href="https://juejin.cn/post/7497890801348821055" title="https://juejin.cn/post/7497890801348821055" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南二：RAG工程落地之数据处理篇🧐</a></p>
<p><a href="https://juejin.cn/post/7496397558358900790" title="https://juejin.cn/post/7496397558358900790" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南一：根据产品需求和定位进行agent流程设计🧐</a></p>
<p><a href="https://juejin.cn/post/7492271537010671635" title="https://juejin.cn/post/7492271537010671635" target="_blank"># 聊一下MCP，希望能让各位清醒一点吧🧐</a></p>
<p><a href="https://juejin.cn/post/7485727472999579659" title="https://juejin.cn/post/7485727472999579659" target="_blank"># 实战派！百万PV的AI产品如何搭建RAG系统？</a></p>
<p><a href="https://juejin.cn/post/7482695183477047315" title="https://juejin.cn/post/7482695183477047315" target="_blank"># 团队落地AI产品的全流程</a></p>
<p><a href="https://juejin.cn/post/7474925725662969883" title="https://juejin.cn/post/7474925725662969883" target="_blank"># 5000字长文，AI时代下程序员的巨大优势！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiber 双缓存架构与 Diff 算法]]></title>    <link>https://juejin.cn/post/7583234966634823714</link>    <guid>https://juejin.cn/post/7583234966634823714</guid>    <pubDate>2025-12-14T11:43:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966634823714" data-draft-id="7583325900293668864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiber 双缓存架构与 Diff 算法"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-14T11:43:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="day1"/> <meta itemprop="url" content="https://juejin.cn/user/4310544201823182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiber 双缓存架构与 Diff 算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4310544201823182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    day1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:43:10.000Z" title="Sun Dec 14 2025 11:43:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<h3 data-id="heading-1">1.1 传统栈协调的局限</h3>
<p>在 React 16 之前的版本中，React 的协调器（Reconciler）采用了一种基于递归遍历组件树的机制，通常称之为“栈协调”（Stack Reconciler）。这种机制在处理组件更新时，会从根组件开始，自上而下地递归调用每个组件的 <code>render</code> 方法，并对比新旧虚拟 DOM 树的差异。</p>
<p>以下是一个简化的 React 15 协调过程示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 15 的简化协调过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">currentFiber, newChildren</span>) {
  <span class="hljs-comment">// 递归处理所有子节点</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> child = newChildren[i];
    <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createFiber</span>(child);

    <span class="hljs-comment">// 递归调用，无法中断</span>
    <span class="hljs-title function_">reconcileChildren</span>(newFiber, child.<span class="hljs-property">children</span>);

    <span class="hljs-comment">// 立即应用DOM变更</span>
    <span class="hljs-title function_">commitWork</span>(newFiber);
  }
}
</code></pre>
<p>这种递归架构存在以下根本性问题：</p>
<ol>
<li>
<p><strong>调用栈的不可控性</strong>：递归调用会在 JavaScript 调用栈中生成大量栈帧，每个栈帧包含函数的局部变量和执行上下文。在处理大型组件树时，这不仅可能导致栈溢出，更关键的是，一旦递归过程启动，便无法中途暂停或中断，必须一次性完成。</p>
</li>
<li>
<p><strong>主线程阻塞的严重性</strong>：由于 JavaScript 的单线程特性，当 React 执行大量协调工作时，主线程会被完全占用。这意味着浏览器无法及时响应用户交互、执行动画或处理其他高优先级任务，从而导致用户界面出现卡顿和响应延迟，严重损害用户体验。</p>
</li>
<li>
<p><strong>优先级处理的缺失</strong>：在传统的递归架构中，所有更新都被视为同等重要。系统无法区分紧急的用户输入事件（如点击、输入）与非紧急的数据获取或后台更新。这可能导致一个耗时较长的低优先级更新任务阻塞了高优先级、需要即时响应的用户操作。</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 Fiber 架构介绍</h3>
<p>eact 16 引入了全新的协调器（Reconciler），即 <strong>Fiber Reconciler</strong>，它基于 <strong>Fiber 节点</strong>实现。Fiber 节点是 React Fiber 架构的核心，它在概念上扮演着双重角色：</p>
<ol>
<li><strong>作为静态数据结构</strong>：每个 Fiber 节点对应一个 React element，它存储了组件的关键信息，例如组件的类型（函数组件、类组件、原生 DOM 组件等）、对应的 DOM 节点引用，以及与父节点、子节点和兄弟节点的关系。</li>
<li><strong>作为动态工作单元</strong>：在组件更新过程中，每个 Fiber 节点会记录本次更新中组件状态的变化、需要执行的具体工作（例如组件需要被删除、插入到 DOM 中，或者仅仅是更新属性等）。</li>
</ol>
<p>React Fiber 架构的主要目标是显著提升 React 在动画、布局和手势等场景下的表现力与用户体验。其核心的特性是：</p>
<ol>
<li><strong>时间切片</strong>：这意味着 React 能够将复杂的渲染工作拆解成更小的、可管理的工作单元，并在多个浏览器帧之间分批执行，从而避免长时间阻塞主线程。</li>
<li><strong>可中断与可恢复</strong>：当有新的、更高优先级的更新请求时，React 能够暂停当前正在进行的工作，转而处理紧急任务，并在主线程空闲时恢复之前的工作。</li>
<li><strong>优先级调度</strong>：能够为不同类型的更新任务分配不同的优先级，确保用户交互等高优先级任务能够得到及时响应，而低优先级任务则可以在后台或空闲时段执行。</li>
</ol>
<h3 data-id="heading-3">1.3 双缓存与 Diff 优化的关系</h3>
<p>React Fiber 架构中，双缓存机制与 Diff 算法优化是实现高效、可中断渲染的核心支柱。</p>
<h4 data-id="heading-4">1.3.1 双缓存机制</h4>
<p>Fiber 架构通过 “Current 树”（对应当前屏幕 UI、与 DOM 同步）和 “WorkInProgress 树”（后台构建的待更新 UI）实现双缓存：更新时在 WorkInProgress 树处理，构建完成后与 Current 树交换并提交 DOM，确保 UI 一致性，同时支持渲染中断与恢复，避免中间状态闪烁。</p>
<h4 data-id="heading-5">1.3.2 Diff 算法优化</h4>
<p>Fiber 中的 Diff 算法聚焦 “高效找差异”：按层级比较节点，类型不同则直接替换；类型相同则对比属性，结合 key 识别列表节点的增 / 删 / 移，只更新变化部分，最小化 DOM 操作。</p>
<h4 data-id="heading-6">1.3.3 双缓存与 Diff 的协同作用</h4>
<p>双缓存机制为 Diff 算法提供了一个沙盒环境。所有的 Diff 计算都在 WorkInProgress Fiber Tree 上进行，不会影响到当前屏幕上显示的 Current Fiber Tree。这使得 Diff 过程可以被中断，并且可以在后台进行，从而避免阻塞主线程。</p>
<p>当 Diff 算法在 WorkInProgress Fiber Tree 上完成所有计算后，它会生成一个副作用列表（Effect List），其中包含了所有需要对真实 DOM 进行的操作（如插入、更新、删除等）。在提交阶段，React 会遍历这个副作用列表，一次性地将所有变更应用到真实 DOM 上。</p>
<h2 data-id="heading-7">2. Fiber 节点的数据结构设计</h2>
<h3 data-id="heading-8">2.1 Fiber 节点的核心属性</h3>
<p>在 React 中，<code>Fiber</code> 节点是并发模式的核心数据结构。它是一个纯粹的 JavaScript 对象，包含了组件、DOM 节点或其他工作单元所需的所有信息。React 在协调（Reconciliation）阶段遍历 Fiber 树，为每个节点计算出需要执行的工作。</p>
<p>下面是 <code>Fiber</code> 类型定义中的一些核心属性，我们将其按照功能进行分类：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> type <span class="hljs-title class_">Fiber</span> = {
  <span class="hljs-comment">// --- 身份标识 ---</span>
  <span class="hljs-comment">// 识别 Fiber 的类型，如 FunctionComponent, ClassComponent, HostComponent (DOM元素)</span>
  <span class="hljs-attr">tag</span>: <span class="hljs-title class_">WorkTag</span>,
  <span class="hljs-comment">// React 元素上的 key 属性，用于优化同级节点的 Diff 算法</span>
  <span class="hljs-attr">key</span>: <span class="hljs-literal">null</span> | string,
  <span class="hljs-comment">// 元素的类型，通常是 React.createElement 的第一个参数，用于在协调期间保持身份</span>
  <span class="hljs-attr">elementType</span>: any,
  <span class="hljs-comment">// 与此 Fiber 关联的已解析的函数/类/标签名</span>
  <span class="hljs-attr">type</span>: any,

  <span class="hljs-comment">// --- 树结构关系 ---</span>
  <span class="hljs-comment">// 指向父级 Fiber 节点，处理完当前节点后，会返回到这个节点</span>
  <span class="hljs-attr">return</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,
  <span class="hljs-comment">// 指向第一个子 Fiber 节点</span>
  <span class="hljs-attr">child</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,
  <span class="hljs-comment">// 指向下一个兄弟 Fiber 节点</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 状态与数据 ---</span>
  <span class="hljs-comment">// 即将应用到组件的新 props</span>
  <span class="hljs-attr">pendingProps</span>: any,
  <span class="hljs-comment">// 上一次渲染时使用的 props</span>
  <span class="hljs-attr">memoizedProps</span>: any,
  <span class="hljs-comment">// 存储 state 更新、回调函数等的队列</span>
  <span class="hljs-attr">updateQueue</span>: mixed,
  <span class="hljs-comment">// 上一次渲染时使用的 state</span>
  <span class="hljs-attr">memoizedState</span>: any,
  <span class="hljs-comment">// 描述此 Fiber 依赖的上下文（Contexts）或事件</span>
  <span class="hljs-attr">dependencies</span>: <span class="hljs-title class_">Dependencies</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 副作用（Effects）---</span>
  <span class="hljs-comment">// 描述需要对此 Fiber 执行的 DOM 操作或其他副作用，如 Placement, Update, Deletion</span>
  <span class="hljs-attr">flags</span>: <span class="hljs-title class_">Flags</span>,
  <span class="hljs-comment">// 子树中所有 Fiber 节点的 `flags` 的集合，用于快速跳过没有副作用的子树</span>
  <span class="hljs-attr">subtreeFlags</span>: <span class="hljs-title class_">Flags</span>,
  <span class="hljs-comment">// 在 commit 阶段需要删除的子 Fiber 节点数组</span>
  <span class="hljs-attr">deletions</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Fiber</span>&gt; | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 调度（Scheduling）---</span>
  <span class="hljs-comment">// 代表此 Fiber 节点上待处理工作的优先级</span>
  <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">Lanes</span>,
  <span class="hljs-comment">// 子树中待处理工作的优先级集合</span>
  <span class="hljs-attr">childLanes</span>: <span class="hljs-title class_">Lanes</span>,

  <span class="hljs-comment">// --- 双缓冲（Double Buffering）---</span>
  <span class="hljs-comment">// 指向 work-in-progress 树或 current 树中对应的另一个 Fiber 节点</span>
  <span class="hljs-attr">alternate</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 链接实例 ---</span>
  <span class="hljs-comment">// 指向与此 Fiber 关联的本地状态实例，如组件实例、DOM 节点等</span>
  <span class="hljs-attr">stateNode</span>: any,
};
</code></pre>
<ol>
<li><strong><code>tag</code></strong>: 这个属性是 Fiber 节点最重要的标识之一，它决定了 Fiber 节点的类型，例如：</li>
</ol>
<ul>
<li><code>FunctionComponent</code>: 函数组件</li>
<li><code>ClassComponent</code>: 类组件</li>
<li><code>HostRoot</code>: 根 Fiber 节点</li>
<li><code>HostComponent</code>: 原生 DOM 元素（如 <code>&lt;div&gt;</code>、<code>&lt;span&gt;</code>）</li>
<li><code>HostText</code>: 文本节点</li>
<li><code>SuspenseComponent</code>: Suspense 组件</li>
<li><code>ContextProvider</code>: Context 提供者</li>
<li><code>ContextConsumer</code>: Context 消费者
通过 <code>tag</code> 属性，React 能够根据不同类型的组件执行不同的协调逻辑。</li>
</ul>
<ol start="2">
<li><strong><code>elementType</code> 和 <code>type</code></strong>:</li>
</ol>
<ul>
<li><code>elementType</code> 是 <code>React.createElement</code> 的第一个参数，它可能是函数、类或字符串。</li>
<li><code>type</code> 是 <code>elementType</code> 经过解析后的实际组件类型。对于函数组件，<code>elementType</code> 和 <code>type</code> 都是函数本身；对于类组件，它们都是类本身；对于原生 DOM 元素，<code>elementType</code> 和 <code>type</code> 都是字符串（如 <code>'div'</code>）。</li>
</ul>
<ol start="3">
<li>
<p><strong><code>stateNode</code></strong>: 这个属性存储了与 Fiber 节点关联的实例。对于类组件，<code>stateNode</code> 指向组件的实例；对于原生 DOM 元素，<code>stateNode</code> 指向真实的 DOM 节点；对于函数组件，<code>stateNode</code> 通常为 <code>null</code>。</p>
</li>
<li>
<p><strong><code>flags</code> 和 <code>subtreeFlags</code></strong>: 这些是位掩码，用于标记 Fiber 节点需要执行的副作用。</p>
</li>
</ol>
<ul>
<li><code>flags</code> 标记当前 Fiber 节点自身的副作用。</li>
<li><code>subtreeFlags</code> 标记当前 Fiber 节点及其子树中所有 Fiber 节点需要执行的副作用。
这些副作用包括 DOM 插入、更新、删除、生命周期方法的调用等。React 在提交阶段会根据这些 <code>flags</code> 来执行相应的操作。</li>
</ul>
<ol start="5">
<li>
<p><strong><code>alternate</code></strong>: 这是双缓存机制的核心属性。每个 Fiber 节点都有一个 <code>alternate</code> 属性，指向它的替身 Fiber 节点。在更新过程中，React 会在 <code>workInProgress</code> 树上构建新的 Fiber 节点，并通过 <code>alternate</code> 属性与 <code>current</code> 树上的旧 Fiber 节点关联。当 <code>workInProgress</code> 树构建完成后，<code>current</code> 树和 <code>workInProgress</code> 树会进行切换，从而实现 UI 的原子更新。</p>
</li>
<li>
<p><strong><code>return</code>、<code>child</code>、<code>sibling</code></strong>: 这三个属性构成了 Fiber 树的结构：</p>
</li>
</ol>
<ul>
<li><code>return</code> 指向父 Fiber 节点。</li>
<li><code>child</code> 指向第一个子 Fiber 节点。</li>
<li><code>sibling</code> 指向下一个兄弟 Fiber 节点。
通过这三个指针，React 可以在 Fiber 树中进行遍历，实现深度优先遍历（DFS）的工作方式。</li>
</ul>
<h3 data-id="heading-9">2.2 树形结构的链表实现</h3>
<p>Fiber 架构采用了一种巧妙的数据结构设计：使用链表来表示树形结构。这种设计使得树的遍历变得更加灵活和高效。</p>
<p>每个 Fiber 节点都包含了以下三个核心指针，它们共同构建了 Fiber 树的链表结构：</p>
<ol>
<li><strong><code>child</code> 指针</strong>：指向当前 Fiber 节点的<strong>第一个子节点</strong>。如果一个节点有多个子节点，<code>child</code> 指针会指向它的最左侧子节点。</li>
<li><strong><code>sibling</code> 指针</strong>：指向当前 Fiber 节点的<strong>下一个兄弟节点</strong>。通过 <code>child</code> 和 <code>sibling</code> 指针，可以遍历一个父节点下的所有子节点。</li>
<li><strong><code>return</code> 指针</strong>：指向当前 Fiber 节点的<strong>父节点</strong>。这个指针在工作循环中至关重要，它允许 React 在处理完一个子树后，能够“返回”到其父节点继续处理或向上冒泡。</li>
</ol>
<p><strong>这种链表实现的优势：</strong></p>
<ol>
<li><strong>高效的遍历</strong>：通过 <code>child</code> 和 <code>sibling</code> 指针，React 可以进行深度优先遍历（DFS），这与传统的递归遍历类似，但避免了 JavaScript 调用栈的限制。</li>
<li><strong>灵活的修改</strong>：当组件树发生变化时（例如，添加、删除或移动节点），React 只需要修改少数几个指针，而无需重新构建整个树。这大大提高了更新的效率。</li>
<li><strong>支持可中断渲染</strong>：<code>return</code> 指针使得 React 可以在处理完一个 Fiber 节点后，随时暂停工作，并在需要时从中断的地方恢复。当一个工作单元完成时，React 可以通过 <code>return</code> 指针向上回溯，找到下一个需要处理的节点，而无需依赖调用栈。</li>
</ol>
<h2 data-id="heading-10">3. Fiber 双缓存架构</h2>
<h3 data-id="heading-11">3.1 双缓存的核心概念</h3>
<p>双缓存（Double Buffering）是计算机图形学中的一个经典概念，React 将这个概念引入到虚拟 DOM 的管理中，创造了一种优雅的状态管理方案。</p>
<p>在计算机图形学中，双缓存通常用于解决画面撕裂（tearing）和闪烁（flickering）问题。它通过维护两个缓冲区来实现：一个用于显示（front buffer），另一个用于在后台绘制（back buffer）。当后台缓冲区绘制完成后，两个缓冲区会进行快速交换，从而在屏幕上呈现一个完整且平滑的画面。</p>
<p>React Fiber 架构借鉴了这一思想，将“双缓存”应用于其内部的 Fiber 树管理。它维护了两棵 Fiber 树：</p>
<ol>
<li><strong>Current Fiber Tree (当前 Fiber 树)</strong>：这棵树代表了当前屏幕上已经渲染的 UI 状态。它与真实的 DOM 保持同步，用户所见即是这棵树的反映。</li>
<li><strong>WorkInProgress Fiber Tree (工作中的 Fiber 树)</strong>：这棵树是在后台构建的，用于表示即将更新的 UI 结构。所有的更新操作（如状态变更、属性更新、组件挂载/卸载等）都会在这棵树上进行。</li>
</ol>
<p>当有更新发生时，React 不会直接修改 Current Fiber Tree，而是在 WorkInProgress Fiber Tree 上进行所有的协调和渲染工作。这个过程是可中断的，意味着 React 可以在浏览器空闲时暂停工作，并在需要时恢复。一旦 WorkInProgress Fiber Tree 构建完成，并且所有的更新都已计算完毕，它就会在提交阶段（Commit Phase）与 Current Fiber Tree 进行交换，新的 WorkInProgress Fiber Tree 成为 Current Fiber Tree，并最终反映到真实的 DOM 上。</p>
<h3 data-id="heading-12">3.2 双缓存的存储结构</h3>
<h4 data-id="heading-13">3.2.1 FiberRootNode 与 HostRootFiber</h4>
<p>整个 React 应用的根节点是一个 <code>FiberRootNode</code> 对象。这个对象是整个应用的入口，它包含了指向当前渲染的 Fiber 树的引用。在 <code>FiberRootNode</code> 内部，有一个关键的属性 <code>current</code>，它始终指向当前屏幕上显示的 <strong>Current Fiber Tree</strong> 的根 Fiber 节点，这个根 Fiber 节点通常被称为 <code>HostRootFiber</code>。
<code>HostRootFiber</code> 是整个 Fiber 树的起点，它代表了 React 应用挂载的真实 DOM 容器（例如 <code>&lt;div id="root"&gt;&lt;/div&gt;</code>）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberRootNode</span>(<span class="hljs-params">containerInfo, tag, hydrate</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerInfo</span> = containerInfo;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingChildren</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向当前渲染的 Fiber 树的根节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingCache</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutHandle</span> = -<span class="hljs-number">1</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingContext</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrate</span> = hydrate;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventTimes</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoLanes</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expirationTimes</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoTimestamp</span>);

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">suspendedLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingedLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expiredLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutableReadLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedLanes</span> = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">entangledLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">entanglements</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoLanes</span>);
}
</code></pre>
<h4 data-id="heading-14">3.2.2 Current Fiber Tree 与 WorkInProgress Fiber Tree 的关联</h4>
<p>每个 Fiber 节点都有一个 <code>alternate</code> 属性。这个 <code>alternate</code> 属性是连接 Current Fiber Tree 和 WorkInProgress Fiber Tree 的关键。</p>
<ul>
<li>在 <strong>Current Fiber Tree</strong> 中的每个 Fiber 节点，其 <code>alternate</code> 属性会指向 <strong>WorkInProgress Fiber Tree</strong> 中对应的 Fiber 节点。</li>
<li>反之，在 <strong>WorkInProgress Fiber Tree</strong> 中的每个 Fiber 节点，其 <code>alternate</code> 属性会指向 <strong>Current Fiber Tree</strong> 中对应的 Fiber 节点。</li>
</ul>
<p>这种双向引用使得 React 可以在更新过程中，轻松地在两棵树之间切换和查找对应的节点。当 React 开始构建 WorkInProgress Fiber Tree 时，它会从 Current Fiber Tree 的根节点开始，为每个 Fiber 节点创建或复用一个 <code>alternate</code> 节点，并将其作为 WorkInProgress Fiber Tree 的一部分。</p>
<h4 data-id="heading-15">3.2.3 树的切换</h4>
<p>当 WorkInProgress Fiber Tree 构建完成，并且所有的更新都已准备好提交时，React 会执行一个非常简单的操作：它会将 <code>FiberRootNode</code> 的 <code>current</code> 属性从指向旧的 Current Fiber Tree 的根节点，切换为指向新的 WorkInProgress Fiber Tree 的根节点。</p>
<p>这个切换操作是原子性的，意味着它会在一个瞬间完成。一旦切换完成，新的 WorkInProgress Fiber Tree 就成为了新的 Current Fiber Tree，并立即反映到屏幕上。旧的 Current Fiber Tree 则会被废弃，等待垃圾回收机制进行清理。</p>
<h4 data-id="heading-16">3.2.4 存储结构的优势</h4>
<p>这种存储结构带来了以下几个显著优势：</p>
<ol>
<li><strong>高效的切换：</strong> 通过简单地修改 <code>FiberRootNode.current</code> 的指向，React 可以在 O(1) 的时间复杂度内完成新旧树的切换，保证了 UI 更新的平滑性。</li>
<li><strong>内存复用：</strong> 在构建 WorkInProgress Fiber Tree 时，React 会尽可能地复用 Current Fiber Tree 中的 Fiber 节点。如果一个组件在更新前后没有发生变化，React 就会直接克隆旧的 Fiber 节点，而不是重新创建，从而节省了内存开销。</li>
<li><strong>可中断性：</strong> 由于 WorkInProgress Fiber Tree 是在后台构建的，即使构建过程被中断，也不会影响到当前屏幕上显示的 UI。当 React 恢复工作时，它可以继续在 WorkInProgress Fiber Tree 上进行操作。</li>
</ol>
<p>通过 <code>FiberRootNode</code>、<code>HostRootFiber</code> 和 <code>alternate</code> 属性的设计，React Fiber 架构实现了高效、平滑且可中断的双缓存机制。</p>
<h3 data-id="heading-17">3.3 双缓存的工作流程</h3>
<h4 data-id="heading-18">3.3.1 渲染/协调阶段</h4>
<p>这个阶段的主要任务是构建 <strong>WorkInProgress Fiber Tree</strong>，并找出需要对真实 DOM 进行的所有变更。这个阶段是可中断的，意味着 React 可以在任何时候暂停工作，并在稍后恢复。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {
    workInProgress = <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">let</span> next;

  <span class="hljs-comment">// 执行当前工作单元的协调逻辑</span>
  next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, renderLanes);

  <span class="hljs-comment">// 处理副作用标记</span>
  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
    next = <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
  }

  <span class="hljs-comment">// 优先级检查：如果存在更高优先级任务则中断</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldYieldToHost</span>()) {
    <span class="hljs-keyword">return</span> unitOfWork;
  }

  <span class="hljs-keyword">return</span> next;
}
</code></pre>
<ol>
<li><strong>从根节点开始遍历</strong>：React 从 <code>HostRootFiber</code>（即 <code>FiberRootNode.current</code> 指向的根 Fiber 节点）开始，深度优先遍历 Current Fiber Tree。</li>
<li><strong>创建或复用 WorkInProgress Fiber</strong>：对于 Current Fiber Tree 中的每个 Fiber 节点，React 会检查它是否需要更新。
<ul>
<li>如果需要更新，React 会创建一个新的 WorkInProgress Fiber 节点，并将其 <code>alternate</code> 属性指向对应的 Current Fiber 节点。</li>
<li>如果不需要更新，React 会直接克隆 Current Fiber 节点，并将其作为 WorkInProgress Fiber 节点。</li>
<li>这个过程中，<code>alternate</code> 属性起到了关键的连接作用，使得两棵树的节点能够相互引用。</li>
</ul>
</li>
<li><strong>执行更新工作</strong>：在 WorkInProgress Fiber 节点上，React 会执行组件的 <code>render</code> 方法（对于函数组件，就是执行函数体），计算新的 props 和 state，并与旧的 props 和 state 进行比较（Diff 算法）。</li>
<li><strong>标记副作用</strong>：如果发现有任何需要对真实 DOM 进行的操作（例如，属性变更、文本内容更新、节点插入、移动或删除），React 会在 WorkInProgress Fiber 节点上标记一个“副作用”（Effect Tag），并将其添加到副作用列表中。</li>
<li><strong>可中断性</strong>：这个阶段是可中断的。React 会根据当前帧的剩余时间（time slice）和任务的优先级来决定是否继续工作。如果时间不足或有更高优先级的任务到来，React 会暂停当前工作，将控制权交还给浏览器，并在下次空闲时恢复。</li>
</ol>
<h4 data-id="heading-19">3.3.2 提交阶段</h4>
<p>一旦渲染/协调阶段完成，并且 WorkInProgress Fiber Tree 构建完毕，所有的副作用都被标记并收集起来，React 就会进入提交阶段。这个阶段是不可中断的，必须一次性完成，以确保 UI 的一致性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root: FiberRoot</span>) {
  <span class="hljs-keyword">const</span> finishedWork = root.<span class="hljs-property">finishedWork</span>;

  <span class="hljs-comment">// 提交前检查：确保没有未处理的高优先级任务</span>
  <span class="hljs-keyword">if</span> (shouldFlushSync) {
    <span class="hljs-title function_">flushSyncCallbacks</span>();
  }

  <span class="hljs-comment">// 执行 DOM 更新和副作用</span>
  <span class="hljs-title function_">commitRootImpl</span>(root, finishedWork);

  <span class="hljs-comment">// 切换 Fiber 树（原子操作）</span>
  root.<span class="hljs-property">current</span> = finishedWork;

  <span class="hljs-comment">// 清理工作</span>
  root.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
}
</code></pre>
<ol>
<li><strong>切换 Fiber 树</strong>：React 会将 <code>FiberRootNode</code> 的 <code>current</code> 属性从指向旧的 Current Fiber Tree 切换为指向新的 WorkInProgress Fiber Tree。此时，新的 WorkInProgress Fiber Tree 就成为了新的 Current Fiber Tree。</li>
<li><strong>执行副作用</strong>：React 遍历副作用列表，并根据每个副作用的类型，一次性地将所有变更应用到真实的 DOM 上。这包括：
<ul>
<li><strong>DOM 更新</strong>：修改元素的属性、文本内容等。</li>
<li><strong>DOM 插入/删除/移动</strong>：将新的 DOM 节点插入到文档中，或从文档中删除/移动旧的 DOM 节点。</li>
<li><strong>生命周期方法/Hooks</strong>：执行组件的 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 等生命周期方法，以及 <code>useEffect</code> 等 Hooks 的回调函数。</li>
</ul>
</li>
<li><strong>完成更新</strong>：提交阶段完成后，用户在屏幕上看到的就是最新的 UI 界面。旧的 Current Fiber Tree（现在是 WorkInProgress Fiber Tree 的 <code>alternate</code>）会被标记为“旧树”，等待垃圾回收。</li>
</ol>
<p>通过这两个阶段的协同工作，双缓存机制使得 React 能够在后台“悄悄地”准备好新的 UI，然后在一个瞬间将其呈现在用户面前，从而实现了平滑、高效且响应迅速的用户体验。</p>
<h2 data-id="heading-20">4. Fiber Diff 算法</h2>
<h3 data-id="heading-21">4.1 Fiber Diff 与传统 Diff 的差异</h3>
<h4 data-id="heading-22">4.3.1 传统 Diff 算法的局限性</h4>
<p>在 React 15 及之前的版本中，协调、过程是同步进行的。这意味着一旦更新开始，它就会一口气遍历整个组件树，计算出所有需要进行的 DOM 操作，然后一次性提交到浏览器。这种“一气呵成”的模式在组件树较小或更新频率较低时表现良好，但当组件树变得庞大或更新频繁时，就可能导致以下问题：</p>
<ol>
<li><strong>阻塞主线程</strong>：同步的协调过程会长时间占用 JavaScript 主线程，导致浏览器无法响应用户输入（如点击、滚动），从而出现页面卡顿、无响应的“掉帧”现象。</li>
<li><strong>无法中断与恢复</strong>：由于是同步执行，一旦开始就无法暂停或中断，这使得优先级更高的任务（如用户输入）无法及时得到处理。</li>
<li><strong>难以实现优先级调度</strong>：所有更新都被视为同等重要，无法根据任务的紧急程度进行区分和调度。</li>
</ol>
<h4 data-id="heading-23">4.3.2 源码中的体现</h4>
<p><code>reconcileChildFibers</code> 是 Fiber Diff 算法的核心，负责对比新旧子节点，生成 Fiber 节点及 DOM 操作副作用（插入、更新、删除等）。
以特殊函数 <code>forceUnmountCurrentAndReconcile</code>为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">forceUnmountCurrentAndReconcile</span>(<span class="hljs-params">
  current: Fiber,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes
</span>) {
  <span class="hljs-comment">// 第一次调用：传入 null 触发所有旧子节点的删除</span>
  workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">reconcileChildFibers</span>(
    workInProgress,
    current.<span class="hljs-property">child</span>,
    <span class="hljs-literal">null</span>,
    renderLanes
  );
  <span class="hljs-comment">// 第二次调用：传入 null 跳过旧节点匹配，直接创建新子节点</span>
  workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">reconcileChildFibers</span>(
    workInProgress,
    <span class="hljs-literal">null</span>,
    nextChildren,
    renderLanes
  );
}
</code></pre>
<p>该函数虽为 “强制卸载并重建子树” 的特殊场景，却体现了 Fiber 架构的核心优势（相比传统 Diff）</p>
<ol>
<li>可中断的协调过程： Fiber 将工作拆分为 Fiber 节点级别的单元，即使是两次 reconcileChildFibers 调用，也可在处理过程中暂停并交还浏览器控制权，避免长时间阻塞；而传统 Diff 需同步完成整个操作，期间浏览器无响应。</li>
<li>优先级调度支持： reconcileChildFibers 兼容优先级机制，即使执行重置操作，仍可被高优任务（如用户输入）中断；传统 Diff 无法区分优先级，只能按顺序执行。</li>
<li>细粒度副作用管理：即使是 “强制重建”，也通过生成精确的 “删除旧节点 + 插入新节点” 副作用实现，而非粗暴清空 DOM；传统 Diff 易产生多余 DOM 操作，缺乏这种精细化控制。</li>
</ol>
<h3 data-id="heading-24">4.2 单节点 Diff 逻辑</h3>
<h4 data-id="heading-25">4.2.1 单节点 Diff 的核心逻辑</h4>
<ol>
<li>
<p>如果新旧节点的 key 不同，React 会直接销毁旧节点及其子树，并创建新节点及其子树。key 的作用是帮助 React 识别列表中的唯一元素，当 key 改变时，意味着元素本身发生了变化。</p>
</li>
<li>
<p>key 相同，但 类型 不同：如果新旧节点的 key 相同，但 type 不同，React 也会销毁旧节点，并创建新节点。例如，一个 </p><p> 标签变为 </p><div> 标签。<p/>
</div></li>
<li>
<p>类型和 key 都相同：这是最理想的情况。React 会复用旧的 Fiber 节点，并继续比较它们的属性（props）。如果属性有变化，React 会标记该节点需要更新，并继续递归比较其子节点。</p>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileSingleElement</span>(<span class="hljs-params">
  returnFiber: Fiber, <span class="hljs-comment">// 父 Fiber 节点</span>
  currentFirstChild: Fiber | <span class="hljs-literal">null</span>, <span class="hljs-comment">// 当前旧的第一个子 Fiber 节点</span>
  element: ReactElement, <span class="hljs-comment">// 新的 React 元素，表示即将渲染的子组件</span>
  lanes: Lanes <span class="hljs-comment">// 优先级相关</span>
</span>) {
  <span class="hljs-keyword">const</span> key = element.<span class="hljs-property">key</span>; <span class="hljs-comment">// 取新节点的key</span>
  <span class="hljs-keyword">let</span> child = currentFirstChild;
  <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (child.<span class="hljs-property">key</span> === key) {
      <span class="hljs-comment">// 第一步：匹配key</span>
      <span class="hljs-keyword">const</span> elementType = element.<span class="hljs-property">type</span>;
      <span class="hljs-comment">// 处理 Fragment 类型</span>
      <span class="hljs-keyword">if</span> (elementType === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>) {
        <span class="hljs-comment">// 如果旧节点也是 Fragment，则复用并更新其子节点</span>
        <span class="hljs-keyword">if</span> (child.<span class="hljs-property">tag</span> === <span class="hljs-title class_">Fragment</span>) {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="hljs-property">sibling</span>); <span class="hljs-comment">// 删除 Fragment 后的所有兄弟节点</span>
          <span class="hljs-keyword">const</span> existing = <span class="hljs-title function_">useFiber</span>(child, element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>); <span class="hljs-comment">// 复用旧的</span>
          existing.<span class="hljs-property">return</span> = returnFiber;
          <span class="hljs-keyword">return</span> existing;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果新旧节点的 type 相同，或者新节点是懒加载组件且解析后的类型相同，则可以复用</span>
        <span class="hljs-keyword">if</span> (
          child.<span class="hljs-property">elementType</span> === elementType ||
          (<span class="hljs-keyword">typeof</span> elementType === <span class="hljs-string">"object"</span> &amp;&amp;
            elementType !== <span class="hljs-literal">null</span> &amp;&amp;
            elementType.<span class="hljs-property">$typeof</span> === <span class="hljs-variable constant_">REACT_LAZY_TYPE</span> &amp;&amp;
            <span class="hljs-title function_">resolveLazy</span>(elementType) === child.<span class="hljs-property">type</span>)
        ) {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="hljs-property">sibling</span>); <span class="hljs-comment">// 删除其他旧节点</span>
          <span class="hljs-keyword">const</span> existing = <span class="hljs-title function_">useFiber</span>(child, element.<span class="hljs-property">props</span>); <span class="hljs-comment">// 复用旧节点并更新属性</span>
          existing.<span class="hljs-property">return</span> = returnFiber;
          <span class="hljs-keyword">return</span> existing;
        }
      }
      <span class="hljs-comment">// 如果 key 匹配但 type 不匹配，或者 Fragment 类型不匹配，则不能复用，删除旧节点并跳出循环</span>
      <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child); <span class="hljs-comment">// type不匹配则删除旧节点</span>
      <span class="hljs-keyword">break</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// key不匹配则删除旧节点</span>
      <span class="hljs-title function_">deleteChild</span>(returnFiber, child);
    }
    <span class="hljs-comment">// 继续检查下一个兄弟节点</span>
    child = child.<span class="hljs-property">sibling</span>;
  }

  <span class="hljs-comment">// 如果没有匹配到，则根据类型创建新节点</span>
  <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>) {
    <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromFragment</span>(
      element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>,
      returnFiber.<span class="hljs-property">mode</span>,
      lanes,
      element.<span class="hljs-property">key</span>
    );
    created.<span class="hljs-property">return</span> = returnFiber;
    <span class="hljs-keyword">return</span> created;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromElement</span>(element, returnFiber.<span class="hljs-property">mode</span>, lanes); <span class="hljs-comment">// 新建节点</span>
    created.<span class="hljs-property">return</span> = returnFiber;
    <span class="hljs-keyword">return</span> created;
  }
}
</code></pre>
<h3 data-id="heading-26">4.3 多节点 Diff 逻辑</h3>
<p>多节点 Diff 是 React Diff 算法的核心场景，需处理节点的插入、删除、移动三种核心操作。</p>
<h4 data-id="heading-27">4.3.1 核心原理：两轮遍历与 key 的作用</h4>
<p><code>key</code> 是节点的唯一标识，相当于 Diff 过程的“锚点”，用于精准匹配新旧节点；结合两轮遍历，可高效覆盖不同更新场景：</p>
<ol>
<li><strong>第一轮遍历</strong>：按索引正向匹配，快速复用“连续相同”的节点（如列表前半部分无变化），避免复杂计算；</li>
<li><strong>第二轮遍历</strong>：用哈希 Map 匹配剩余节点，处理“移动、插入、删除”等离散变更，通过 <code>key</code> 快速定位可复用节点。</li>
</ol>
<h4 data-id="heading-28">4.3.2 完整流程拆解（基于 <code>reconcileChildrenArray</code>）</h4>
<h5 data-id="heading-29">阶段 1：第一轮遍历（按索引正向匹配）</h5>
<p>从新旧节点列表的“头部”开始，按索引逐个对比，优先复用连续相同的节点：</p>
<ul>
<li><strong>匹配条件</strong>：节点的 <code>key</code> 相同且类型相同 → 复用旧节点，仅更新属性；</li>
<li><strong>终止条件</strong>：遇到不匹配节点（<code>key</code>/类型不同）或空槽位（如 <code>null</code>）→ 退出第一轮，进入后续处理。</li>
</ul>
<p>核心代码（简化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> oldFiber = currentFirstChild; <span class="hljs-comment">// 旧节点链表起点</span>
<span class="hljs-keyword">let</span> newIdx = <span class="hljs-number">0</span>; <span class="hljs-comment">// 新节点数组索引</span>
<span class="hljs-keyword">for</span> (; oldFiber &amp;&amp; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
  <span class="hljs-comment">// 缓存下一个旧节点，避免遍历丢失</span>
  <span class="hljs-keyword">const</span> nextOldFiber = oldFiber.<span class="hljs-property">sibling</span>;
  <span class="hljs-comment">// 对比 key 和类型，尝试复用节点</span>
  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateSlot</span>(
    returnFiber,
    oldFiber,
    newChildren[newIdx],
    lanes
  );

  <span class="hljs-keyword">if</span> (newFiber === <span class="hljs-literal">null</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 匹配失败，退出第一轮</span>

  <span class="hljs-comment">// 标记节点是否需要移动（通过 lastPlacedIndex 判断）</span>
  lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);
  <span class="hljs-comment">// 构建新节点链表（通过 sibling 指针连接）</span>
  <span class="hljs-keyword">if</span> (!previousNewFiber) resultingFirstChild = newFiber;
  <span class="hljs-keyword">else</span> previousNewFiber.<span class="hljs-property">sibling</span> = newFiber;

  previousNewFiber = newFiber;
  oldFiber = nextOldFiber; <span class="hljs-comment">// 继续下一个旧节点</span>
}
</code></pre>
<h5 data-id="heading-30">阶段 2：处理“剩余节点”（分 3 种场景）</h5>
<p>根据第一轮结束后 “新旧节点是否有剩余”，分情况处理：</p>
<ol>
<li>新节点已遍历完，旧节点有剩余
剩余旧节点均为 “需删除” 节点 → 批量标记删除：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (newIdx === newChildren.<span class="hljs-property">length</span>) {
  <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, oldFiber); <span class="hljs-comment">// 删除所有剩余旧节点</span>
  <span class="hljs-keyword">return</span> resultingFirstChild;
}
</code></pre>
<ol start="2">
<li>旧节点已遍历完，新节点有剩余
剩余新节点均为 “需插入” 节点 → 批量创建并标记插入：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (oldFiber === <span class="hljs-literal">null</span>) {
  <span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
    <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createChild</span>(returnFiber, newChildren[newIdx], lanes);
    <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx); <span class="hljs-comment">// 标记插入</span>
    <span class="hljs-comment">// 连接新节点到链表</span>
    previousNewFiber
      ? (previousNewFiber.<span class="hljs-property">sibling</span> = newFiber)
      : (resultingFirstChild = newFiber);
    previousNewFiber = newFiber;
  }
  <span class="hljs-keyword">return</span> resultingFirstChild;
}
</code></pre>
<ol start="3">
<li>新旧节点均有剩余（进入第二轮遍历）</li>
</ol>
<h5 data-id="heading-31">阶段 3：第二轮遍历（Map 映射匹配）</h5>
<p>针对“新旧节点均有剩余”的场景（如列表中间插入/删除节点），用哈希 Map 快速定位可复用节点：</p>
<ol>
<li><strong>构建旧节点 Map</strong>：将剩余旧节点存入 Map，<code>key</code> 为节点的 <code>key</code>（优先）或索引（无 <code>key</code> 时）；</li>
<li><strong>遍历剩余新节点</strong>：从 Map 中查找匹配的旧节点：
<ul>
<li>找到 → 复用节点，调整位置（标记 <code>Placement</code>），并从 Map 中移除该旧节点；</li>
<li>未找到 → 新建节点，标记插入；</li>
</ul>
</li>
<li><strong>清理未复用旧节点</strong>：Map 中剩余的旧节点均为“未被复用”，批量标记删除。</li>
</ol>
<p>核心代码（简化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 剩余旧节点转 Map，key 为节点 key 或索引</span>
<span class="hljs-keyword">const</span> existingChildren = <span class="hljs-title function_">mapRemainingChildren</span>(oldFiber);
<span class="hljs-comment">// 遍历剩余新节点，从 Map 匹配</span>
<span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateFromMap</span>(
    existingChildren,
    returnFiber,
    newIdx,
    newChildren[newIdx],
    lanes
  );

  <span class="hljs-keyword">if</span> (newFiber) {
    <span class="hljs-comment">// 标记移动/插入，构建新链表</span>
    lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);
    <span class="hljs-keyword">if</span> (!previousNewFiber) resultingFirstChild = newFiber;
    <span class="hljs-keyword">else</span> previousNewFiber.<span class="hljs-property">sibling</span> = newFiber;
    previousNewFiber = newFiber;
    <span class="hljs-comment">// 移除已复用的旧节点</span>
    existingChildren.<span class="hljs-title function_">delete</span>(newFiber.<span class="hljs-property">key</span> || newIdx);
  }
}
<span class="hljs-comment">// 删除 Map 中未复用的旧节点</span>
existingChildren.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-title function_">deleteChild</span>(returnFiber, child));
</code></pre>
<h5 data-id="heading-32">关键辅助函数：<code>placeChild</code>（判断节点是否移动）</h5>
<p>通过 <code>lastPlacedIndex</code>（上一个“无需移动”的旧节点索引）判断当前节点是否需要移动：</p>
<ul>
<li>若旧节点索引 &lt; <code>lastPlacedIndex</code> → 节点位置后移，标记 <code>Placement</code>（需移动）；</li>
<li>若旧节点索引 ≥ <code>lastPlacedIndex</code> → 节点位置未变，更新 <code>lastPlacedIndex</code> 为当前旧节点索引。</li>
</ul>
<p>代码逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">placeChild</span>(<span class="hljs-params">newFiber, lastPlacedIndex, newIndex</span>) {
  newFiber.<span class="hljs-property">index</span> = newIndex;
  <span class="hljs-keyword">const</span> current = newFiber.<span class="hljs-property">alternate</span>; <span class="hljs-comment">// 对应的旧节点</span>
  <span class="hljs-keyword">if</span> (current) {
    <span class="hljs-keyword">const</span> oldIndex = current.<span class="hljs-property">index</span>;
    <span class="hljs-keyword">if</span> (oldIndex &lt; lastPlacedIndex) {
      newFiber.<span class="hljs-property">flags</span> |= <span class="hljs-title class_">Placement</span>; <span class="hljs-comment">// 标记需要移动</span>
      <span class="hljs-keyword">return</span> lastPlacedIndex;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> oldIndex; <span class="hljs-comment">// 更新 lastPlacedIndex</span>
    }
  } <span class="hljs-keyword">else</span> {
    newFiber.<span class="hljs-property">flags</span> |= <span class="hljs-title class_">Placement</span>; <span class="hljs-comment">// 新节点，标记插入</span>
    <span class="hljs-keyword">return</span> lastPlacedIndex;
  }
}
</code></pre>
<h5 data-id="heading-33">流程图</h5>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9e599f101c24cd4aec7e7b0a81f6e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766317389&amp;x-signature=d%2BUdc8V0uKVGb0ya7V9yKaZjVZk%3D" alt="4-1.png" loading="lazy"/></p>
<h4 data-id="heading-34">4.3.3 具体示例</h4>
<h5 data-id="heading-35">示例 1：节点移动（列表元素交换位置）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;;

<span class="hljs-comment">//新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li>第一轮遍历：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>b</code> → <code>key</code> 不匹配，退出第一轮；</li>
</ul>
</li>
<li>第二轮遍历：
<ul>
<li>构建旧节点 Map：<code>{a: 旧a, b: 旧b, c: 旧c}</code>；</li>
<li>新节点索引 0（<code>b</code>）：从 Map 找到旧 <code>b</code>，旧索引 1 ≥ <code>lastPlacedIndex</code>（0）→ 无需移动，更新 <code>lastPlacedIndex</code> 为 1；</li>
<li>新节点索引 1（<code>a</code>）：从 Map 找到旧 <code>a</code>，旧索引 0 &lt; <code>lastPlacedIndex</code>（1）→ 标记移动；</li>
<li>新节点索引 2（<code>c</code>）：从 Map 找到旧 <code>c</code>，旧索引 2 ≥ <code>lastPlacedIndex</code>（1）→ 无需移动；</li>
</ul>
</li>
<li>最终操作：仅移动 <code>a</code> 到 <code>b</code> 之后，无节点创建/删除。</li>
</ol>
<h5 data-id="heading-36">示例 2：节点插入+删除（列表中间增删元素）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
<span class="hljs-comment">// 新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"d"</span>&gt;</span>D<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li>第一轮遍历：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>a</code> → 匹配成功，复用节点；</li>
<li>索引 1：旧 <code>b</code> vs 新 <code>d</code> → <code>key</code> 不匹配，退出第一轮；</li>
</ul>
</li>
<li>第二轮遍历：
<ul>
<li>构建旧节点 Map：<code>{b: 旧b, c: 旧c}</code>；</li>
<li>新节点索引 1（<code>d</code>）：Map 中无匹配 → 新建节点，标记插入；</li>
<li>新节点索引 2（<code>c</code>）：从 Map 找到旧 <code>c</code>，旧索引 2 ≥ <code>lastPlacedIndex</code>（0）→ 无需移动；</li>
</ul>
</li>
<li>最终操作：删除旧 <code>b</code>，插入新 <code>d</code>，无其他移动。</li>
</ol>
<h5 data-id="heading-37">示例 3：节点移动 + 插入 + 删除（混合变更）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"d"</span>&gt;</span>D<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"e"</span>&gt;</span>E<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;;

<span class="hljs-comment">// 新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"f"</span>&gt;</span>F<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"g"</span>&gt;</span>G<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li><strong>第一轮遍历（从左到右，比较相同索引的节点）</strong>：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>b</code> → <code>key</code> 不匹配，退出第一轮遍历。</li>
</ul>
</li>
<li><strong>第二轮遍历（从右到左，比较相同索引的节点）</strong>：
<ul>
<li>索引 4：旧 <code>e</code> vs 新 <code>g</code> → <code>key</code> 不匹配，退出第二轮遍历。</li>
</ul>
</li>
<li><strong>第三轮遍历（处理剩余未匹配节点）</strong>：
<ul>
<li><strong>构建旧节点 Map</strong>：<code>{a: 旧a, b: 旧b, c: 旧c, d: 旧d, e: 旧e}</code>。</li>
<li><strong>遍历新列表剩余节点</strong>：
<ul>
<li>新节点 <code>B</code> (key <code>b</code>)：在 Map 中找到 <code>旧b</code> (索引 1)。<code>旧b</code> 的索引 1 ≥ <code>lastPlacedIndex</code> (-1) → 无需移动。更新 <code>lastPlacedIndex</code> 为 1。从 Map 中删除 <code>旧b</code>。</li>
<li>新节点 <code>F</code> (key <code>f</code>)：在 Map 中未找到 → 标记为<strong>插入</strong>新节点 <code>F</code>。</li>
<li>新节点 <code>A</code> (key <code>a</code>)：在 Map 中找到 <code>旧a</code> (索引 0)。<code>旧a</code> 的索引 0 &lt; <code>lastPlacedIndex</code> (1) → 标记为<strong>移动</strong>。更新 <code>lastPlacedIndex</code> 为 1。从 Map 中删除 <code>旧a</code>。</li>
<li>新节点 <code>C</code> (key <code>c</code>)：在 Map 中找到 <code>旧c</code> (索引 2)。<code>旧c</code> 的索引 2 ≥ <code>lastPlacedIndex</code> (1) → 无需移动。更新 <code>lastPlacedIndex</code> 为 2。从 Map 中删除 <code>旧c</code>。</li>
<li>新节点 <code>G</code> (key <code>g</code>)：在 Map 中未找到 → 标记为<strong>插入</strong>新节点 <code>G</code>。</li>
</ul>
</li>
<li><strong>处理旧节点 Map 中剩余节点</strong>：Map 中剩余 <code>旧d</code> 和 <code>旧e</code> → 标记 <code>旧d</code> 和 <code>旧e</code> 为<strong>删除</strong>。</li>
</ul>
</li>
<li><strong>最终操作</strong>：移动 <code>A</code> 到 <code>B</code> 之后，插入 <code>F</code>，插入 <code>G</code>，删除 <code>D</code>，删除 <code>E</code>。</li>
</ol>
<h3 data-id="heading-38">4.3 一些好的实践</h3>
<h4 data-id="heading-39">4.4.1 合理设置 key 属性</h4>
<ol>
<li>优先使用稳定且唯一的标识作为 key，如后端返回的 ID，避免使用索引或随机值。索引作为 key 会导致节点移动时无法被正确匹配，随机值会让每次渲染都视为新节点，完全失去复用价值。</li>
<li>同层级节点的 key 必须唯一，避免 key 冲突导致节点匹配错乱，引发 DOM 异常渲染。</li>
<li>列表渲染时必须显式设置 key，即使是简单列表，合理的 key 能让多节点 Diff 高效处理增删改查，减少性能开销。</li>
</ol>
<h4 data-id="heading-40">4.4.2 优化节点类型与结构</h4>
<ol>
<li>避免频繁变更节点类型，如将 div 改为 p，会导致旧节点被销毁、新节点重建，增加性能成本。尽量通过 CSS 或属性调整实现样式变化，而非节点类型变更。</li>
<li>减少不必要的节点嵌套，扁平化组件结构。深层嵌套会增加 Diff 遍历的层级和复杂度，影响协调效率。</li>
<li>对于静态节点（无状态、无属性变更），可通过 React.memo 或自定义缓存逻辑减少 Diff 对比，直接复用节点。</li>
</ol>
<h4 data-id="heading-41">4.4.3 避免不必要的 Diff 触发</h4>
<ol>
<li>合理使用 React.memo、useMemo 和 useCallback，缓存组件、计算结果和回调函数，避免因 props 或依赖项无关变化导致的不必要重渲染和 Diff。</li>
<li>状态设计尽量精准，避免将无关状态集中管理。局部状态变化应仅影响对应的组件子树，减少 Diff 遍历的范围。</li>
<li>对于动态列表，避免全量替换数据，尽量通过增删单个节点更新列表，让 Diff 算法仅处理变更部分，提升效率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析]]></title>    <link>https://juejin.cn/post/7583571595202248742</link>    <guid>https://juejin.cn/post/7583571595202248742</guid>    <pubDate>2025-12-14T11:53:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202248742" data-draft-id="7583535861645115438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析"/> <meta itemprop="keywords" content="前端,开源"/> <meta itemprop="datePublished" content="2025-12-14T11:53:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="knight_l"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406504557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406504557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    knight_l
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:53:36.000Z" title="Sun Dec 14 2025 11:53:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎉实现效果图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53937b0b401c4f4382aa84afea4c0b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25pZ2h0X2w=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766366588&amp;x-signature=%2BjauR7YlBMus7iv5rwNTeuxXRVo%3D" alt="Snipaste_2025-12-13_21-09-33 (1).png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea65e2d044484dc29a655a149710f054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25pZ2h0X2w=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766366588&amp;x-signature=i54%2F1xhTUytbeQsU183KubvJjGc%3D" alt="Snipaste_2025-11-20_14-20-19.png" loading="lazy"/></p>
<h3 data-id="heading-1">项目地址</h3>
<p>如果你觉得不错的话，帮我点一个小小的<code>star</code></p>
<blockquote>
<p>访问需要魔法。👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fknight-L%2Fsc-datav" target="_blank" title="https://github.com/knight-L/sc-datav" ref="nofollow noopener noreferrer">点击访问</a>👈</p>
</blockquote>
<h3 data-id="heading-2">在线预览</h3>
<blockquote>
<p>👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fknight-l.github.io%2Fsc-datav%2F%23%2F" target="_blank" title="https://knight-l.github.io/sc-datav/#/" ref="nofollow noopener noreferrer">点击访问效果图2</a>👈</p>
</blockquote>
<h3 data-id="heading-3">精确贴图实现</h3>
<p>精确贴图是将2D纹理准确地映射到3D几何体表面的技术。在我们的项目中，通过以下步骤实现了精确贴图：</p>
<h4 data-id="heading-4">1. UV坐标计算</h4>
<p>为了确保纹理能够正确地映射到几何体上，我们需要计算每个顶点的UV坐标：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { geometry } = meshRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">const</span> pos = geometry.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>;
  <span class="hljs-keyword">const</span> width = bbox.<span class="hljs-property">max</span>.<span class="hljs-property">x</span> - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">x</span>;
  <span class="hljs-keyword">const</span> height = bbox.<span class="hljs-property">max</span>.<span class="hljs-property">y</span> - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">y</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">uv</span>: number[] = [];
  <span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>, u = <span class="hljs-number">0</span>, v = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pos.<span class="hljs-property">count</span>; i++) {
    x = pos.<span class="hljs-title function_">getX</span>(i);
    y = pos.<span class="hljs-title function_">getY</span>(i);
    u = (x - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">x</span>) / width;
    v = (y - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">y</span>) / height;
    uv.<span class="hljs-title function_">push</span>(u, v);
  }
  geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"uv"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32BufferAttribute</span>(uv, <span class="hljs-number">2</span>));
});
</code></pre>
<p>这段代码通过遍历几何体的所有顶点，根据包围盒(bbox)计算出每个顶点对应的UV坐标，确保纹理能按照正确的比例映射到几何体表面。</p>
<h4 data-id="heading-5">2. 纹理加载与配置</h4>
<p>在项目中，我们使用 <code>useTexture</code>钩子加载纹理，并进行必要的配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [texture1, texture2, texture3] = <span class="hljs-title function_">useTexture</span>(
  [textureMap, scNormalMap, scDisplacementMap],
  <span class="hljs-function">(<span class="hljs-params">tex</span>) =&gt;</span>
    tex.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
      el.<span class="hljs-property">wrapS</span> = el.<span class="hljs-property">wrapT</span> = <span class="hljs-title class_">RepeatWrapping</span>;
    })
);
</code></pre>
<h4 data-id="heading-6">3. 材质应用</h4>
<p>最后，我们将纹理应用到材质上：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;meshStandardMaterial
  map={texture1}
  normalMap={texture2}
  displacementMap={texture3}
  metalness={<span class="hljs-number">0.2</span>}
  roughness={<span class="hljs-number">0.5</span>}
  side={<span class="hljs-title class_">DoubleSide</span>}
/&gt;
</code></pre>
<p>通过这种方式，我们可以为3D对象添加漫反射贴图、法线贴图和置换贴图，从而创造出更加真实和细节丰富的视觉效果。</p>
<h3 data-id="heading-7">热力图实现</h3>
<p>热力图是一种用颜色编码来表示数据密度或强度的可视化技术。在我们的项目中，使用了 <code>heatmap.js</code>库来实现热力图功能。</p>
<h4 data-id="heading-8">1. 热力图数据准备</h4>
<p>首先，我们需要准备热力图的数据点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> points = data.<span class="hljs-property">features</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>] =
    <span class="hljs-title function_">projection</span>(el.<span class="hljs-property">geometry</span>.<span class="hljs-property">coordinates</span> <span class="hljs-keyword">as</span> [number, number]) ?? [];
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(x + size / <span class="hljs-number">2</span>),
    <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(y + size / <span class="hljs-number">2</span>),
    <span class="hljs-attr">value</span>: el.<span class="hljs-property">properties</span>.<span class="hljs-property">value</span>,
  };
});
</code></pre>
<p>这些数据点包含了位置信息(x,y)和数值(value)，用于生成热力图。</p>
<h4 data-id="heading-9">2. 热力图生成</h4>
<p>使用 <code>heatmap.js</code>创建热力图：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> heatmap = heatmapJs.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: heatmapContainer,
  <span class="hljs-attr">gradient</span>: {
    <span class="hljs-number">0.5</span>: <span class="hljs-string">"#1fc2e1"</span>,
    <span class="hljs-number">0.6</span>: <span class="hljs-string">"#24d560"</span>,
    <span class="hljs-number">0.7</span>: <span class="hljs-string">"#9cd522"</span>,
    <span class="hljs-number">0.8</span>: <span class="hljs-string">"#f1e12a"</span>,
    <span class="hljs-number">0.9</span>: <span class="hljs-string">"#ffbf3a"</span>,
    <span class="hljs-number">1.0</span>: <span class="hljs-string">"#ff0000"</span>,
  },
  <span class="hljs-attr">blur</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">radius</span>: radius,
  <span class="hljs-attr">maxOpacity</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">width</span>: size,
  <span class="hljs-attr">height</span>: size,
});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> greymap = heatmapJs.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: heatmapContainer,
  <span class="hljs-attr">gradient</span>: {
    <span class="hljs-number">0.0</span>: <span class="hljs-string">"black"</span>,
    <span class="hljs-number">1.0</span>: <span class="hljs-string">"white"</span>,
  },
  <span class="hljs-attr">radius</span>: radius,
  <span class="hljs-attr">maxOpacity</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">width</span>: size,
  <span class="hljs-attr">height</span>: size,
});
</code></pre>
<p>这里定义了颜色渐变，不同的数值范围对应不同的颜色，从而形成热力图的视觉效果。</p>
<h4 data-id="heading-10">3. 与Three.js集成</h4>
<p>将生成的热力图作为纹理应用到Three.js的网格上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CanvasTexture</span>(heatmap.<span class="hljs-property">_renderer</span>.<span class="hljs-property">canvas</span>);
texture.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 在着色器中使用该纹理</span>
<span class="hljs-attr">uniforms</span>: {
  <span class="hljs-attr">heatMap</span>: { <span class="hljs-attr">value</span>: texture },
  <span class="hljs-comment">// 其他uniforms...</span>
}
</code></pre>
<p>通过这种方式，我们将2D热力图转换为可以在3D场景中使用的纹理。</p>
<h4 data-id="heading-11">4. 着色器实现</h4>
<p>在片段着色器中使用热力图纹理：</p>
<pre><code class="hljs language-glsl" lang="glsl">varying vec2 vUv;
uniform sampler2D heatMap;
uniform vec3 u_color;
uniform float u_opacity;

void main() {
    gl_FragColor = vec4(u_color, u_opacity) * texture2D(heatMap, vUv);
}
</code></pre>
<p>这样就完成了热力图在3D场景中的渲染。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java集合“坑王”：ArrayList为啥越界还能浪？]]></title>    <link>https://juejin.cn/post/7583571595203018790</link>    <guid>https://juejin.cn/post/7583571595203018790</guid>    <pubDate>2025-12-14T14:01:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595203018790" data-draft-id="7583567658253238298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java集合“坑王”：ArrayList为啥越界还能浪？"/> <meta itemprop="keywords" content="前端,Java"/> <meta itemprop="datePublished" content="2025-12-14T14:01:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java集合“坑王”：ArrayList为啥越界还能浪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:01:48.000Z" title="Sun Dec 14 2025 14:01:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提起ArrayList，新手总觉得它就是个“自动扩容的数组”，随便add、get都不怕——直到遇到 IndexOutOfBoundsException ，才发现这货藏着不少小心机。今天咱扒一扒ArrayList的扩容黑科技，以及那些让你踩坑的细节！</p>
<h2 data-id="heading-0">一、先搞懂：ArrayList为啥能“自动变长”？</h2>
<p>ArrayList底层是普通数组，默认初始容量是10。当添加元素导致数组满了，它会悄悄扩容：新容量=旧容量×1.5（源码里是 oldCapacity + (oldCapacity &gt;&gt; 1) ），然后把旧数组的数据复制到新数组。</p>
<p>看个简单例子，直观感受扩容：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">// 初始容量10</span>
        
        <span class="hljs-comment">// 加10个元素，刚好填满初始数组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            list.add(<span class="hljs-string">"元素"</span> + i);
        }
        
        <span class="hljs-comment">// 第11个元素：触发扩容！新容量变成15</span>
        list.add(<span class="hljs-string">"触发扩容的元素"</span>);
        
        System.out.println(<span class="hljs-string">"当前元素数量："</span> + list.size()); <span class="hljs-comment">// 输出11</span>
        System.out.println(<span class="hljs-string">"能存但未用的容量："</span> + (list.size() &lt; <span class="hljs-number">15</span> ? <span class="hljs-number">15</span> - list.size() : <span class="hljs-string">"已再次扩容"</span>)); <span class="hljs-comment">// 输出4</span>
    }
}
</code></pre>
<p> </p>
<h2 data-id="heading-1">二、踩坑重灾区：size和capacity别搞混！</h2>
<p>很多人以为 list.size() 是数组容量，其实大错特错：</p>
<ul>
<li><code> size()</code> ：实际存储的元素数量（你add了多少个）</li>
<li> <code>capacity </code>：底层数组的长度（ArrayList内部用 elementData 数组，容量不对外暴露）</li>
</ul>
<p>这就是为啥 get(10) 会报错——哪怕数组容量是15，只要你只存了11个元素，索引10是有效的，但索引11就越界：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">11</span>; i++) {
        list.add(<span class="hljs-string">"元素"</span> + i);
    }
    
    System.out.println(list.get(<span class="hljs-number">10</span>)); <span class="hljs-comment">// 正常输出：元素10</span>
    list.get(<span class="hljs-number">11</span>); <span class="hljs-comment">// 直接抛IndexOutOfBoundsException！</span>
}
</code></pre>
<p> </p>
<h2 data-id="heading-2">三、实用技巧：提前指定容量，避免频繁扩容</h2>
<p>如果知道要存多少元素，初始化时直接指定容量，能减少数组复制的性能损耗：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 已知要存1000个元素，直接指定容量</span>
ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">1000</span>);
<span class="hljs-comment">// 后续add1000个元素，一次扩容都不会触发</span>
</code></pre>
<p> </p>
<p>最后划重点</p>
<p>1. ArrayList扩容是“偷偷摸摸”的，扩容后旧数组会被GC回收；</p>
<p>2. 越界异常看的是 <code>size()</code> ，不是底层数组容量；</p>
<p>3. 大数据量场景一定要指定初始容量，优化性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再把Java枚举当“花瓶”！它能办大事]]></title>    <link>https://juejin.cn/post/7583576605780557870</link>    <guid>https://juejin.cn/post/7583576605780557870</guid>    <pubDate>2025-12-14T13:49:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780557870" data-draft-id="7583576605780508718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再把Java枚举当“花瓶”！它能办大事"/> <meta itemprop="keywords" content="前端,Java"/> <meta itemprop="datePublished" content="2025-12-14T13:49:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再把Java枚举当“花瓶”！它能办大事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:49:36.000Z" title="Sun Dec 14 2025 13:49:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提起Java枚举（Enum），很多新手觉得它就是个“花架子”——无非定义几个固定值，远不如if-else顺手。但其实枚举藏着硬核实力，既能让代码更优雅，还能避免一堆坑。今天咱就扒一扒枚举的实用姿势，告别“枚举无用论”！</p>
<h2 data-id="heading-0">一、枚举不只是“常量容器”</h2>
<p>先看个反例：用普通常量定义订单状态，一不小心就踩坑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 糟糕的写法：常量易被篡改、类型不安全</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatus</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PENDING</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PAID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHIPPED</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">// 传个4进来？编译器根本拦不住！</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span> {
        <span class="hljs-keyword">if</span> (status == PENDING) { <span class="hljs-comment">/* 逻辑 */</span> }
    }
}
</code></pre>
<p> </p>
<p>换成枚举试试，直接把“非法值”堵在门外：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优雅写法：枚举天生类型安全、不可变</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    PENDING, PAID, SHIPPED; <span class="hljs-comment">// 固定状态，不能新增/修改</span>
}

<span class="hljs-comment">// 只能传枚举实例，传错直接编译报错！</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStatus</span><span class="hljs-params">(OrderStatusEnum status)</span> {
    <span class="hljs-keyword">if</span> (status == OrderStatusEnum.PENDING) { <span class="hljs-comment">/* 逻辑 */</span> }
}
</code></pre>
<p> </p>
<h2 data-id="heading-1">二、枚举里藏着“方法大招”</h2>
<p>枚举可不是只能存值，还能自带方法，甚至实现接口！比如给状态加个描述：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    PENDING(<span class="hljs-string">"待支付"</span>, <span class="hljs-number">1</span>),
    PAID(<span class="hljs-string">"已支付"</span>, <span class="hljs-number">2</span>),
    SHIPPED(<span class="hljs-string">"已发货"</span>, <span class="hljs-number">3</span>);

    <span class="hljs-comment">// 枚举的成员变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;

    <span class="hljs-comment">// 枚举的构造方法（必须私有！）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">OrderStatusEnum</span><span class="hljs-params">(String desc, <span class="hljs-type">int</span> code)</span> {
        <span class="hljs-built_in">this</span>.desc = desc;
        <span class="hljs-built_in">this</span>.code = code;
    }

    <span class="hljs-comment">// 自定义方法：获取描述</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> desc;
    }

    <span class="hljs-comment">// 静态方法：根据code查枚举</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OrderStatusEnum <span class="hljs-title function_">getByCode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">for</span> (OrderStatusEnum status : values()) {
            <span class="hljs-keyword">if</span> (status.code == code) {
                <span class="hljs-keyword">return</span> status;
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"无效状态码："</span> + code);
    }
}

<span class="hljs-comment">// 调用示例：直接拿描述，不用写一堆if-else</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    System.out.println(OrderStatusEnum.PAID.getDesc()); <span class="hljs-comment">// 输出：已支付</span>
    System.out.println(OrderStatusEnum.getByCode(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：SHIPPED</span>
}
</code></pre>
<p> </p>
<h2 data-id="heading-2">三、switch里的“最佳搭档”</h2>
<p>枚举和switch简直是天作之合，代码可读性直接拉满：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrder</span><span class="hljs-params">(OrderStatusEnum status)</span> {
    <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> PENDING:
            System.out.println(<span class="hljs-string">"请尽快支付"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> PAID:
            System.out.println(<span class="hljs-string">"已安排发货"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> SHIPPED:
            System.out.println(<span class="hljs-string">"请注意查收"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// 不用写default！新增枚举时，编译器会提醒你补case</span>
    }
}
</code></pre>
<p> </p>
<p>最后划重点</p>
<p>1. 枚举是单例的集合，每个实例都是唯一的；</p>
<p>2. 构造方法必须私有，不能手动new；</p>
<p>3. 用枚举替代魔法值、常量组，代码更安全、易维护。</p>
<p>别再把枚举束之高阁了！下次定义固定值（比如状态、类型），直接掏出枚举，让代码少点bug，多点优雅～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 JavaScript 原型链：从本质到实战应用]]></title>    <link>https://juejin.cn/post/7583234966635184162</link>    <guid>https://juejin.cn/post/7583234966635184162</guid>    <pubDate>2025-12-14T14:19:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635184162" data-draft-id="7583168260797825064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 JavaScript 原型链：从本质到实战应用"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T14:19:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 JavaScript 原型链：从本质到实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:19:49.000Z" title="Sun Dec 14 2025 14:19:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文搞懂 JavaScript 原型链：从本质到实战应用</h2>
<p>在 JavaScript 世界里，原型链是贯穿始终的核心概念。很多开发者对它又爱又恨——爱它支撑起了 JS 的面向对象特性，恨它抽象难懂、容易混淆。本文将从“是什么”“为什么”“怎么用”三个维度，用通俗的语言+直观的实例，帮你彻底搞懂原型链，从此不再被“原型”“原型对象”“构造函数”这些概念绕晕。</p>
<h3 data-id="heading-1">一、为什么需要原型链？—— JS 面向对象的底层逻辑</h3>
<p>在传统面向对象语言（如 Java、C++）中，我们通过“类”来创建对象，类是对象的模板，规定了对象的属性和方法。但 JavaScript 在 ES6 之前并没有“类”的概念，那它是如何实现面向对象的呢？</p>
<p>答案就是 <strong>原型链（Prototype Chain）</strong> 。原型链的核心作用有两个：</p>
<ul>
<li><strong>实现属性和方法的共享</strong>：避免每个对象都重复定义相同的方法，节省内存空间；</li>
<li><strong>实现继承</strong>：让一个对象可以复用另一个对象的属性和方法，无需重新编写代码。</li>
</ul>
<p>举个简单的例子：如果我们要创建 100 个“人”对象，每个对象都有“姓名”“年龄”属性和“说话”方法。如果没有原型链，我们需要给每个对象都定义一次“说话”方法，这会造成大量的内存浪费；而通过原型链，我们可以把“说话”方法定义在原型上，让所有“人”对象共享这个方法。</p>
<h3 data-id="heading-2">二、先理清三个核心概念：构造函数、原型对象、实例</h3>
<p>要搞懂原型链，必须先分清三个紧密关联的概念：<strong>构造函数</strong>、<strong>原型对象（Prototype）</strong> 、<strong>实例对象</strong>。它们三者的关系是：原型链的基础。</p>
<h4 data-id="heading-3">2.1 构造函数</h4>
<p>构造函数是用来创建对象的函数，通常首字母大写（约定俗成）。通过 <code>new</code> 关键字调用构造函数，就能生成实例对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 构造函数：用来创建“人”对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 实例属性（每个实例独有的属性）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 通过 new 调用构造函数，生成实例对象</span>
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">20</span>);
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'李四'</span>, <span class="hljs-number">22</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1); <span class="hljs-comment">// Person { name: '张三', age: 20 }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person2); <span class="hljs-comment">// Person { name: '李四', age: 22 }</span>
</code></pre>
<h4 data-id="heading-4">2.2 原型对象（Prototype）</h4>
<p>每个构造函数都有一个 <code>prototype</code> 属性，这个属性指向一个对象，就是<strong>原型对象</strong>。原型对象的作用是存储所有实例共享的属性和方法。</p>
<p>我们可以把共享方法定义在构造函数的 <code>prototype</code> 上，让所有实例共享：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 给 Person 构造函数的原型对象添加共享方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> 岁`</span>);
};

<span class="hljs-comment">// 所有实例都能调用原型上的方法</span>
person1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是 张三，今年 20 岁</span>
person2.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是 李四，今年 22 岁</span>

<span class="hljs-comment">// 验证：两个实例的 sayHi 方法是同一个（共享的）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">sayHi</span> === person2.<span class="hljs-property">sayHi</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-5">2.3 实例与 <strong>proto</strong></h4>
<p>每个实例对象都有一个内置属性（非标准但几乎所有浏览器都支持）—— <code>__proto__</code>，这个属性指向<strong>创建它的构造函数的原型对象</strong>。</p>
<p>也就是说，实例的 <code>__proto__</code> === 构造函数的 <code>prototype</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实例的 __proto__ 指向构造函数的 prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person2.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-6">2.4 三者关系总结</h4>
<p>用一张图就能理清三者的关系：</p>
<ul>
<li>构造函数（Person）通过 <code>prototype</code> 指向原型对象（Person.prototype）；</li>
<li>实例对象（person1、person2）通过 <code>__proto__</code> 指向原型对象（Person.prototype）；</li>
<li>原型对象（Person.prototype）通过 <code>constructor</code> 指向构造函数（Person）（这个属性是默认存在的）。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原型对象的 constructor 指向构造函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-7">三、原型链的本质：层层向上的查找链条</h3>
<p>原型对象本身也是一个对象，它也有自己的 <code>__proto__</code> 属性，指向它的原型对象。这样一层一层向上追溯，就形成了一条链条——这就是<strong>原型链</strong>。</p>
<p>原型链的终点是 <code>Object.prototype</code>，因为 <code>Object</code> 是 JS 中所有对象的“根对象”，它的 <code>__proto__</code> 指向 <code>null</code>（没有更上层的原型了）。</p>
<h4 data-id="heading-8">3.1 原型链的结构示例</h4>
<p>以 person1 为例，它的原型链结构是：</p>
<p>person1 → person1.<strong>proto</strong>（Person.prototype）→ Person.prototype.<strong>proto</strong>（Object.prototype）→ Object.prototype.<strong>proto</strong>（null）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 验证原型链结构</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__); <span class="hljs-comment">// Person.prototype</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__.__proto__); <span class="hljs-comment">// Object.prototype</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__.__proto__.__proto__); <span class="hljs-comment">// null</span>
</code></pre>
<h4 data-id="heading-9">3.2 原型链的核心作用：属性/方法查找规则</h4>
<p>当我们访问一个实例对象的属性或方法时，JS 引擎会按照以下规则查找：</p>
<ol>
<li>首先在实例对象本身查找，如果找到，直接使用；</li>
<li>如果没找到，就通过<code>__proto__</code> 找到它的原型对象，在原型对象中查找；</li>
<li>如果原型对象中也没找到，就通过原型对象的 <code>__proto__</code> 向上查找，直到找到 <code>Object.prototype</code>；</li>
<li>如果在 <code>Object.prototype</code> 中还没找到，就返回 <code>undefined</code>（如果是方法，就会报错“xxx is not a function”）。</li>
</ol>
<p>举个例子理解查找规则：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 实例本身有 name 属性，直接访问</span>
console<span class="hljs-selector-class">.log</span>(person1.name); <span class="hljs-comment">// 张三（来自 person1 本身）</span>

<span class="hljs-comment">// 2. 实例本身没有 sayHi 方法，去原型对象（Person.prototype）查找</span>
person1<span class="hljs-selector-class">.sayHi</span>(); <span class="hljs-comment">// Hi, 我是 张三...（来自 Person.prototype）</span>

<span class="hljs-comment">// 3. 实例和 Person.prototype 都没有 toString 方法，去 Object.prototype 查找</span>
console<span class="hljs-selector-class">.log</span>(person1.toString()); <span class="hljs-comment">// [object Object]（来自 Object.prototype）</span>

<span class="hljs-comment">// 4. 找不到的属性，返回 undefined</span>
console<span class="hljs-selector-class">.log</span>(person1.gender); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-10">四、原型链实现继承——JS 原生继承的核心方式</h3>
<p>ES6 之前，JavaScript 没有 <code>class</code> 和 <code>extends</code> 关键字，继承完全依赖原型链实现。核心思路是：<strong>让子类的原型对象指向父类的实例</strong>，从而让子类实例能通过原型链访问到父类的属性和方法。</p>
<h4 data-id="heading-11">4.1 基本原型链继承</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类构造函数：Person</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 父类原型方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 子类构造函数：Student（继承 Person）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Student</span>(<span class="hljs-params">name, age, studentId</span>) {
  <span class="hljs-comment">// 继承父类的实例属性（必须先调用，否则 this 会被覆盖）</span>
  <span class="hljs-title class_">Person</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name, age); 
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">studentId</span> = studentId; <span class="hljs-comment">// 子类独有的属性</span>
}

<span class="hljs-comment">// 核心：让子类的原型对象指向父类的实例，建立原型链</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// 修复子类原型的 constructor 指向（因为上面的赋值改变了 constructor）</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Student</span>;

<span class="hljs-comment">// 子类原型方法（重写父类方法，实现多态）</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是学生 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，学号：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.studentId}</span>`</span>);
};

<span class="hljs-comment">// 子类独有的原型方法</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">study</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 正在学习`</span>);
};

<span class="hljs-comment">// 实例化子类</span>
<span class="hljs-keyword">const</span> student1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'王五'</span>, <span class="hljs-number">18</span>, <span class="hljs-string">'2024001'</span>);

<span class="hljs-comment">// 验证继承效果</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">name</span>); <span class="hljs-comment">// 王五（继承自 Person）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">studentId</span>); <span class="hljs-comment">// 2024001（子类独有）</span>
student1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是学生 王五，学号：2024001（重写后的方法）</span>
student1.<span class="hljs-title function_">study</span>(); <span class="hljs-comment">// 王五 正在学习（子类独有方法）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// [object Object]（继承自 Object.prototype）</span>
</code></pre>
<h4 data-id="heading-12">4.2 原型链继承的注意点</h4>
<ul>
<li><strong>必须用 Person.call(this)</strong> ：在子类构造函数中调用父类构造函数，才能继承父类的实例属性（否则子类实例不会有 name、age 等属性）；</li>
<li><strong>修复 constructor 指向</strong>：将子类原型赋值为父类实例后，子类原型的 constructor 会指向父类，需要手动改回子类；</li>
<li><strong>父类原型的引用类型属性会被所有子类实例共享</strong>：这是原型链继承的缺陷，比如父类原型有一个数组属性，所有子类实例修改这个数组都会互相影响（解决方法：组合继承，即原型链+构造函数继承，上面的例子就是组合继承）。</li>
</ul>
<h3 data-id="heading-13">五、原型链与 ES6 Class 的关系</h3>
<p>很多开发者以为 ES6 的 <code>class</code> 是 JS 新增的继承模型，但实际上，<code>class</code> 只是原型链的<strong>语法糖</strong>——它的底层实现依然是原型链，只是写法更接近传统面向对象语言，更直观。</p>
<h4 data-id="heading-14">5.1 Class 本质是构造函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES6 Class</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// Class 本质是构造函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// function</span>

<span class="hljs-comment">// Class 的 prototype 属性依然存在</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// { constructor: ƒ Person(), sayHi: ƒ }</span>

<span class="hljs-comment">// 实例的 __proto__ 依然指向 Class 的 prototype</span>
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">20</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-15">5.2 extends 本质是原型链继承</h4>
<p>ES6 的 <code>extends</code> 实现继承，底层依然是原型链。我们用 <code>class</code> 重写上面的 Student 继承案例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 子类继承父类（extends 本质是原型链）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age, studentId</span>) {
    <span class="hljs-variable language_">super</span>(name, age); <span class="hljs-comment">// 相当于 Person.call(this, name, age)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">studentId</span> = studentId;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 重写父类方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是学生 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，学号：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.studentId}</span>`</span>);
  }

  <span class="hljs-title function_">study</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 子类独有方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 正在学习`</span>);
  }
}

<span class="hljs-keyword">const</span> student1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'王五'</span>, <span class="hljs-number">18</span>, <span class="hljs-string">'2024001'</span>);

<span class="hljs-comment">// 验证原型链关系</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>可以看到，<code>extends</code> 本质上是帮我们自动完成了“子类原型指向父类原型”的操作（Student.prototype.<strong>proto</strong> = Person.prototype），省去了手动修改原型链的麻烦。</p>
<h3 data-id="heading-16">六、原型链的实战应用场景</h3>
<p>原型链不是抽象的概念，在实际开发中有很多实用场景，掌握这些场景能让你写出更优雅、更高效的代码。</p>
<h4 data-id="heading-17">6.1 扩展内置对象的方法</h4>
<p>我们可以通过修改内置对象的原型，给所有实例添加共享方法。比如给 Array 扩展一个去重方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 给 Array 原型添加去重方法</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">unique</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-variable language_">this</span>)];
};

<span class="hljs-comment">// 所有数组实例都能调用这个方法</span>
<span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr1.<span class="hljs-title function_">unique</span>()); <span class="hljs-comment">// [1, 2, 3]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2.<span class="hljs-title function_">unique</span>()); <span class="hljs-comment">// [4, 5, 6]</span>
</code></pre>
<p>注意：尽量不要修改内置对象的原型（如 Object.prototype、Array.prototype），可能会与其他代码冲突，或覆盖原生方法。</p>
<h4 data-id="heading-18">6.2 实现对象的属性复用</h4>
<p>当多个对象需要共享一些属性/方法时，不用重复定义，而是让它们的 <code>__proto__</code> 指向同一个原型对象：</p>
<pre><code class="hljs language-ini" lang="ini">// 共享原型对象
const <span class="hljs-attr">animalProto</span> = {
  eat() {
    console.log('吃食物')<span class="hljs-comment">;</span>
  },
  sleep() {
    console.log('睡觉')<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 创建两个对象，共享 animalProto 的方法
const <span class="hljs-attr">cat</span> = { name: <span class="hljs-string">'小猫'</span> }<span class="hljs-comment">;</span>
const <span class="hljs-attr">dog</span> = { name: <span class="hljs-string">'小狗'</span> }<span class="hljs-comment">;</span>

// 让两个对象的 __proto__ 指向共享原型
<span class="hljs-attr">cat.__proto__</span> = animalProto<span class="hljs-comment">;</span>
<span class="hljs-attr">dog.__proto__</span> = animalProto<span class="hljs-comment">;</span>

// 两个对象都能调用共享方法
cat.eat()<span class="hljs-comment">; // 吃食物</span>
dog.sleep()<span class="hljs-comment">; // 睡觉</span>
console.log(<span class="hljs-attr">cat.eat</span> === dog.eat)<span class="hljs-comment">; // true（共享同一个方法）</span>
</code></pre>
<h4 data-id="heading-19">6.3 理解框架中的原型链应用</h4>
<p>很多前端框架都用到了原型链。比如 React 的 Class Component，本质上就是基于原型链实现的；Vue 的实例方法（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">mount、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">、</span></span></span></span></span>emit），也是定义在 Vue.prototype 上，让所有 Vue 实例共享。</p>
<h3 data-id="heading-20">七、常见误区</h3>
<h4 data-id="heading-21">7.1 误区 1：<strong>proto</strong> 与 prototype 混淆</h4>
<p>记住一句话：<strong>实例有 <strong>proto</strong>，构造函数有 prototype</strong>（原型对象也有 <strong>proto</strong>，因为它也是对象）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（实例）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// 有（构造函数）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（函数也是对象，指向 Function.prototype）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（原型对象是对象，指向 Object.prototype）</span>
</code></pre>
<h4 data-id="heading-22">7.2 误区 2：原型链的终点是 Object.prototype</h4>
<p>Object.prototype 的 <strong>proto</strong> 指向 null，所以原型链的终点是 null，不是 Object.prototype：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// null</span>
</code></pre>
<h3 data-id="heading-23">八、总结</h3>
<p>原型链是 JavaScript 面向对象的底层基础，核心要点可以总结为：</p>
<ol>
<li>三个核心概念：构造函数、原型对象（prototype）、实例（<strong>proto</strong>）；</li>
<li>原型链是实例通过 <strong>proto</strong> 层层向上追溯原型形成的链条，终点是 null；</li>
<li>原型链的核心作用是实现属性/方法共享和继承；</li>
<li>ES6 Class 是原型链的语法糖，底层依然依赖原型链；</li>
<li>判断实例属性用 hasOwnProperty()，避免混淆原型属性。</li>
</ol>
<p>理解原型链的关键是“动手实践”——多写代码验证三者关系、跟踪属性查找过程，慢慢就会豁然开朗。如果本文对你有帮助，欢迎点赞、收藏、转发～ 如有疑问，欢迎在评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli]]></title>    <link>https://juejin.cn/post/7582951344518447110</link>    <guid>https://juejin.cn/post/7582951344518447110</guid>    <pubDate>2025-12-14T14:10:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582951344518447110" data-draft-id="7582997593091031059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli"/> <meta itemprop="keywords" content="前端,React Native,NPM"/> <meta itemprop="datePublished" content="2025-12-14T14:10:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LisEcho"/> <meta itemprop="url" content="https://juejin.cn/user/800910564921214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/800910564921214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LisEcho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:10:41.000Z" title="Sun Dec 14 2025 14:10:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e5fe7423bc54498a570ca16c0068e22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlzRWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326241&amp;x-signature=dB%2B76Cmh6g9NgtU4L%2BfAqWCpG7M%3D" alt="微信图片_20251214220928_202_108.jpg" loading="lazy"/></p>
<p>是不是感觉如果 RN 不使用 expo 搭建项目会很费劲，重复配置导航/国际化/主题，调试 Metro、SVG、路径别名花掉半天，团队间风格不统一、又怕临时改配置把项目搞崩。然而，直接使用原生脚手架搭建的项目又过于简单，什么都没有？</p>
<p>我在开发几次公司的 RN 项目后也开始有了这种苦恼——真正浪费的是“每次从头重复那些琐碎但重要的工程工作”。最终我结合几次实际的项目经验和社区一些好的做法和建议，我做了这样一个React-native 项目的脚手架 —— <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fyoyoj-rn" target="_blank" title="https://www.npmjs.com/package/yoyoj-rn" ref="nofollow noopener noreferrer">yoyoj-rn - npm</a>。</p>
<p>我的出发点很简单：把那些重复且容易出错的工程工作做好一次，然后把可复用、可扩展、对团队友好的基础能力交给大家，让我把精力放回到产品和体验本身。</p>
<p>我发布后自己试用了一段时间，做了部分功能的微调，现在已经稳定能产出一个还算让我满意的 RN 项目脚手架。这里也发布出来，希望也能给大家提供便利，同时我也虚心接受大家的一些建议，大家可以发在评论区讨论。</p>
<p>工具入口 -&gt; <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fyoyoj-rn" target="_blank" title="https://www.npmjs.com/package/yoyoj-rn" ref="nofollow noopener noreferrer">yoyoj-rn - npm</a></p>
<h2 data-id="heading-0">快速结论对比（一分钟了解差别）</h2>
<ul>
<li>RN 原生脚手架：启动快，但只给你骨架，工程能力（主题、i18n、设计 tokens、资源约定）需要自己搭；第一次可跑通但二次复用成本高。</li>
<li>yoyoj-rn 模板：启动稍微多做一点准备，但产出的是一套工程化的、可立即使用的项目结构；对团队协作、CI、AI 智能分析友好——省下来的不是几分钟，而是后续的几十到几百小时。</li>
</ul>
<h2 data-id="heading-1">主要优势（为什么会帮你省事）</h2>
<ul>
<li>一次性工程化：主题、样式 tokens、国际化、导航结构、资源约定均已实现。</li>
<li>一致性和可维护性：模板内的约定让新人能快速理解项目结构，减少沟通成本。</li>
<li>AI 友好：清晰的路径别名、统一的资源加载与命名空间，方便自动化工具或 LLM 精确索引与推断。</li>
<li>开箱即用的原子组件与工具：图标/图像按变体加载、深色模式资源自动选择、统一的 <code>useTheme()</code> 与 <code>useI18n()</code>。</li>
</ul>
<h2 data-id="heading-2">快速开始</h2>
<pre><code class="hljs language-bash" lang="bash">npx yoyoj-rn &lt;projectName&gt;
</code></pre>
<p><strong>CLI 入口：</strong><code>cli/init.js</code></p>
<p>（工作流：用 <code>@react-native-community/cli</code> 初始化 -&gt; 拷贝模版 -&gt; 注入 codegenConfig 与 TS 路径别名 -&gt; 安装依赖并初始化 Git）</p>
<p>模板里你能直接拿来用的东西（摘要）</p>
<ul>
<li>TypeScript 全量类型支持与良好的类型定义</li>
<li>React Navigation 的标准化路由与类型化参数</li>
<li>i18n（<code>useI18n</code> hook + <code>en.json</code> / <code>zh-cn.json</code>）</li>
<li>主题系统（浅色/深色/系统 + <code>useTheme()</code>）</li>
<li>原子化组件（<code>IconByVariant</code> / <code>AssetByVariant</code>）与资源组织约定</li>
<li>Axios 实例与环境配置模板（<code>dev/test/prod</code> + <code>local</code> 示例）</li>
<li>Metro 与 Babel 已配置：SVG、路径别名 <code>@</code> 指向 <code>src</code>、支持 require.context</li>
</ul>
<h2 data-id="heading-3">生成后的项目概览</h2>
<pre><code class="hljs language-bash" lang="bash">src/
├── App.tsx                  <span class="hljs-comment"># 入口，挂载 Theme 与 Navigation</span>
├── components/              <span class="hljs-comment"># 原子/模版组件（方便复用和测试）</span>
├── config/                  <span class="hljs-comment"># 环境配置（dev/test/prod/local 示例）</span>
├── hooks/                   <span class="hljs-comment"># 常用 Hook（含 i18n）</span>
├── navigation/              <span class="hljs-comment"># 路由容器与路径枚举， 类型化友好</span>
├── screens/                 <span class="hljs-comment"># 示例页面（Startup/Example）</span>
├── services/                <span class="hljs-comment"># Axios 实例等服务层封装</span>
├── themes/                  <span class="hljs-comment"># 设计 tokens（colors/fonts/layout/gutter）与资源加载约定</span>
└── translations/            <span class="hljs-comment"># i18n 资源与类型补充</span>
</code></pre>
<h2 data-id="heading-4">关键模块会怎么帮你：</h2>
<ul>
<li>入口与主题：App 已经把 <code>ThemeProvider</code>、状态栏、安全区和 Navigation 包起来了，接入新的页面只需专注 UI。</li>
<li>导航与路径：统一的 <code>paths.ts</code> + 强类型 <code>types.ts</code>，避免运行时字符串错误。</li>
<li>国际化：内置 <code>useI18n()</code>，默认命名空间与资源位置固定，方便 CI 校验和 AI 索引。</li>
<li>组件与资源：<code>IconByVariant</code>、<code>AssetByVariant</code> 支持按 light/dark/variant 自动加载，设计师资源与代码命名约定一致。</li>
</ul>
<h2 data-id="heading-5">Metro / Babel 与开发脚本</h2>
<ul>
<li>Metro 已配置 SVG 与 require.context 调试友好（见 <code>template/metro.config.js</code>）</li>
<li>Babel 路径别名 <code>@</code> 指向 <code>src</code>（见 <code>template/babel.config.js</code>）</li>
<li>常用脚本：<code>yarn start</code> / <code>yarn ios</code> / <code>yarn android</code> / <code>yarn lint</code> / <code>yarn test</code></li>
</ul>
<p>面向 AI 与团队的识别提示（让自动化工具读懂项目）</p>
<ul>
<li>全局路径别名 <code>@</code> = <code>./src</code>，便于静态分析器与智能提示。</li>
<li>主题与资源的统一入口（<code>themes</code>）使模型能准确定位颜色/字体/图片约定。</li>
<li>国际化资源和默认命名空间固定在 <code>translations</code>，便于自动化检测与翻译流水线。</li>
<li>资源加载集中在 <code>themes/assests/getAssetsContext.ts</code>（已开启 <code>unstable_allowRequireContext</code>），对代码生成或图像替换操作友好。</li>
</ul>
<p>如何在实际开发中省时间（示例场景）</p>
<ul>
<li>新页面：创建 <code>screens/</code> 子目录、注册路径到 <code>paths.ts</code>，直接使用 <code>Theme</code> 与 <code>i18n</code>，不必再配置样式系统。</li>
<li>加入图标：放到 <code>themes/assests/icons/</code> 并遵循命名规则，<code>IconByVariant</code> 自动可用。</li>
<li>环境差异：复制 <code>config/local.ts.example</code> 为 <code>local.ts</code> 并配置，不必触碰编译相关的底层设置。</li>
</ul>
<p>结语</p>
<p>如果你和我一样在多个 RN 项目之间往返，希望把时间更多花在产品与体验上而不是工程琐事，yoyoj-rn 可以当作你的工程化起点：把重复工作交给模板，把创造力还给你。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南]]></title>    <link>https://juejin.cn/post/7583567658253287450</link>    <guid>https://juejin.cn/post/7583567658253287450</guid>    <pubDate>2025-12-14T14:19:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583567658253287450" data-draft-id="7583576612390830090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南"/> <meta itemprop="keywords" content="JavaScript,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-14T14:19:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="parksben"/> <meta itemprop="url" content="https://juejin.cn/user/4353721774912237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721774912237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    parksben
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:19:41.000Z" title="Sun Dec 14 2025 14:19:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    38
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发，你一定遇到过这样的场景：</p>
<p>老板拍着你的肩膀说：“小王啊，把隔壁组做的那个‘用户画像’页面，直接用 iframe 嵌到我们的后台里吧，顺便把当前登录的 Token 传过去，再把用户选好的标签拿回来。”</p>
<p>你心想：“这简单，页面跨 iframe 可以用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FpostMessage" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" ref="nofollow noopener noreferrer">postMessage</a> 方法通信。”</p>
<p>然而当你开始写代码时，噩梦开始了。</p>
<h2 data-id="heading-0">😫 以前的痛苦：像在用对讲机吵架</h2>
<p>为了在父页面和 iframe 之间传数据，你不得不使用浏览器原生的 <code>postMessage</code>。这玩意儿就像是一个<strong>公共广播</strong>。</p>
<ol>
<li><strong>父页面喊话</strong>：<code>iframe.contentWindow.postMessage('嘿！这是 Token', '*')</code></li>
<li><strong>子页面监听</strong>：<code>window.addEventListener('message', (e) =&gt; { ... })</code></li>
</ol>
<p>随着业务变复杂，你的代码很快就会变成这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 令人头秃的传统写法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 先得确认是不是自己人（安全校验）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">'https://trusted.com'</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 2. 解析数据，还得防着格式不对报错</span>
  <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">data</span>;
  
  <span class="hljs-comment">// 3. 开始写一堆 switch-case 来判断对方到底想干啥</span>
  <span class="hljs-keyword">switch</span> (data.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'UPDATE_TOKEN'</span>:
      <span class="hljs-comment">// ...逻辑...</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'GET_USER_TAGS'</span>:
      <span class="hljs-comment">// ...逻辑...</span>
      <span class="hljs-comment">// 4. 还要想办法把结果“扔”回去</span>
      event.<span class="hljs-property">source</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'USER_TAGS_RESULT'</span>, <span class="hljs-attr">payload</span>: ... }, event.<span class="hljs-property">origin</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ...此处省略一万行...</span>
  }
});
</code></pre>
<p>这就像两个人隔着一条河喊话，不仅费嗓子，还容易听错，而且谁都能插一嘴。维护起来简直是灾难。</p>
<h2 data-id="heading-1">😎 现在的救星：Webpage Tunnel</h2>
<p>这时候，<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparksben%2Fwebpage-tunnel" target="_blank" title="https://github.com/parksben/webpage-tunnel" ref="nofollow noopener noreferrer">Webpage Tunnel</a></strong> 登场了。</p>
<p>它的作用很简单：<strong>把那条混乱的“河”填平，给你们拉一根专线电话。</strong></p>
<p>它不再让你去处理底层的消息监听和过滤，而是让你像<strong>调用普通函数</strong>一样去跟 iframe 里的页面交流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1130f04af3514b5d97a29fa59aafc9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFya3NiZW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368286&amp;x-signature=FuXX%2BVSnQWBefDmobQpCIxxhITA%3D" alt="webpage-tunnel.png" loading="lazy"/></p>
<h3 data-id="heading-2">核心理念：网页即服务 (Webpage as a Service)</h3>
<p>想象一下，你嵌入的那个 iframe 页面，不再只是一个页面，而是一个<strong>微型服务器</strong>。它对外提供了一组 API 接口，你只需要连接它，然后调用接口拿数据。</p>
<h3 data-id="heading-3">亮点一：代码变得无比清爽</h3>
<p>让我们看看用 Webpage Tunnel 怎么实现刚才的需求。</p>
<p><strong>1. 在 iframe 页面（服务方）：</strong><br/>
只需要把你的功能“注册”一下，就像开店摆摊一样。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpage-tunnel'</span>;

<span class="hljs-comment">// 把页面里的功能打包成 API</span>
<span class="hljs-title function_">serve</span>({
  <span class="hljs-comment">// 别人调这个方法，我就更新 Token</span>
  <span class="hljs-attr">updateToken</span>: <span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'auth_token'</span>, token);
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Token 更新成功！'</span>;
  },
  
  <span class="hljs-comment">// 别人调这个方法，我就返回标签数据</span>
  <span class="hljs-attr">getSelectedTags</span>: <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 甚至可以去后台请求数据再返回</span>
    <span class="hljs-keyword">const</span> tags = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/tags'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>());
    <span class="hljs-keyword">return</span> tags;
  }
});
</code></pre>
<p><strong>2. 在父页面（调用方）：</strong><br/>
就像打个电话一样简单，直接调用！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpage-tunnel'</span>;

<span class="hljs-comment">// 建立连接</span>
<span class="hljs-keyword">const</span> iframeApi = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>({
  <span class="hljs-attr">server</span>: <span class="hljs-string">'https://other-site.com/profile'</span>, <span class="hljs-comment">// 对方的地址</span>
  <span class="hljs-attr">methods</span>: [<span class="hljs-string">'updateToken'</span>, <span class="hljs-string">'getSelectedTags'</span>] <span class="hljs-comment">// 我要调用的方法名</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doWork</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ✨ 见证奇迹的时刻</span>
  <span class="hljs-comment">// 不需要监听 message，不需要 switch-case，直接 await 拿结果！</span>
  
  <span class="hljs-keyword">await</span> iframeApi.<span class="hljs-title function_">updateToken</span>(<span class="hljs-string">'new-token-123'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Token 传过去了'</span>);

  <span class="hljs-keyword">const</span> tags = <span class="hljs-keyword">await</span> iframeApi.<span class="hljs-title function_">getSelectedTags</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拿到的标签是：'</span>, tags);
}
</code></pre>
<h3 data-id="heading-4">亮点二：双向奔赴</h3>
<p>不仅仅是父页面可以调子页面，子页面也可以反过来调父页面。只要双方都 <code>serve</code>（提供服务）并 <code>new Request</code>（发起请求），就能实现无缝的双向对话。</p>
<h3 data-id="heading-5">亮点三：TypeScript 党的福音</h3>
<p>如果你用 TypeScript，体验会更上一层楼。你可以定义好接口类型，当你输入 <code>iframeApi.</code> 的时候，编辑器会自动提示有哪些方法可以调，入参是什么，返回值是什么。再也不用担心拼错单词或者传错参数了。</p>
<h2 data-id="heading-6">总结</h2>
<p><strong>Webpage Tunnel</strong> 并没有发明什么黑科技，它只是把繁琐的 <code>postMessage</code> 封装进了一个黑盒子里，留给你一套优雅、现代的 API。</p>
<ul>
<li>如果你受够了 <code>window.addEventListener</code>；</li>
<li>如果你希望 iframe 通信代码像后端接口调用一样清晰；</li>
<li>如果你想少掉几根头发；</li>
</ul>
<p>那么，Webpage Tunnel 绝对值得你尝试一下。</p>
<blockquote>
<p><strong>传送门</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparksben%2Fwebpage-tunnel" target="_blank" title="https://github.com/parksben/webpage-tunnel" ref="nofollow noopener noreferrer">GitHub 项目地址</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从命令式到声明式：用 Vue 3 构建任务清单的开发哲学]]></title>    <link>https://juejin.cn/post/7583234966635315234</link>    <guid>https://juejin.cn/post/7583234966635315234</guid>    <pubDate>2025-12-14T15:37:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635315234" data-draft-id="7583168260797874216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从命令式到声明式：用 Vue 3 构建任务清单的开发哲学"/> <meta itemprop="keywords" content="Vue.js,JavaScript,响应式编程"/> <meta itemprop="datePublished" content="2025-12-14T15:37:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从命令式到声明式：用 Vue 3 构建任务清单的开发哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:37:55.000Z" title="Sun Dec 14 2025 15:37:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">从命令式到声明式：用 Vue 3 构建任务清单的开发哲学</h2>
<p>在前端开发演进的历程中，开发者逐渐从“操作 DOM”转向“管理状态”。一个看似简单的任务清单（Todos）应用，恰恰是理解这一范式转变的绝佳入口。本文将结合 Vue 3 的 Composition API、响应式系统与模板指令，深入剖析现代前端开发的核心思想——<strong>数据驱动 UI</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、传统开发 vs Vue 开发：两种思维模式</h3>
<p>在没有框架的时代，我们这样写任务输入功能：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">app</span> = document.getElementById(<span class="hljs-string">'app'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">input</span> = document.getElementById(<span class="hljs-string">'todo-input'</span>)<span class="hljs-comment">;</span>

input.addEventListener('change', (e) =&gt; {
  const <span class="hljs-attr">value</span> = e.target.value.trim()<span class="hljs-comment">;</span>
  if (value) <span class="hljs-attr">app.innerHTML</span> = value<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式称为 <strong>命令式编程</strong>：</p>
<ul>
<li>先获取 DOM 元素</li>
<li>再监听事件</li>
<li>最后手动修改 DOM</li>
</ul>
<p>问题显而易见：</p>
<ul>
<li>代码与 DOM 强耦合</li>
<li>难以维护复杂交互</li>
<li>性能差（频繁操作慢速的渲染引擎）</li>
</ul>
<p>而 Vue 的做法完全不同：</p>
<blockquote>
<p><strong>不再思考“页面元素怎么操作”，而是思考“数据如何变化”</strong> 。</p>
</blockquote>
<p>你只需定义：</p>
<ul>
<li>当前标题是什么？</li>
<li>任务列表有哪些？</li>
<li>哪些任务已完成？</li>
</ul>
<p>Vue 自动将这些数据映射到界面，并在数据变化时高效更新 DOM。这就是 <strong>声明式编程</strong> 的魅力。</p>
<hr/>
<h3 data-id="heading-2">二、Vue 3 Composition API：逻辑更清晰</h3>
<p>在 <code>App.vue</code> 中，我们使用 <code>&lt;script setup&gt;</code> 语法，这是 Vue 3.2+ 推荐的组合式 API 写法：</p>
<pre><code class="hljs language-php" lang="php">import { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">title</span> = <span class="hljs-title function_ invoke__">ref</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// 响应式字符串</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">todos</span> = <span class="hljs-title function_ invoke__">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'打王者'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'吃饭'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> }
]);
</code></pre>
<ul>
<li><code>ref()</code> 将普通值包装为响应式对象。</li>
<li>所有逻辑集中在 <code>setup</code> 中，避免 Options API 的碎片化。</li>
</ul>
<p>相比 Vue 2 的 <code>data()</code>、<code>methods</code>、<code>computed</code> 分散在不同选项，Composition API 让相关功能内聚，便于复用与测试。</p>
<hr/>
<h3 data-id="heading-3">三、核心指令：用声明式语法描述 UI</h3>
<p>Vue 的模板通过指令（<code>v-</code> 开头）实现声明式渲染：</p>
<h4 data-id="heading-4">1. <code>v-model</code>：双向绑定</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @keydown.enter=<span class="hljs-string">"addTodo"</span>&gt;
&lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> v-model=<span class="hljs-string">"todo.done"</span>&gt;
</code></pre>
<ul>
<li>输入框内容 ↔ <code>title</code></li>
<li>复选框状态 ↔ <code>todo.done</code></li>
</ul>
<p>无需手动监听 <code>input</code> 或 <code>change</code> 事件。</p>
<h4 data-id="heading-5">2. <code>v-for</code>：列表渲染</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;li <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> :key=<span class="hljs-string">"todo.id"</span>&gt;
</code></pre>
<ul>
<li>自动遍历 <code>todos</code> 数组</li>
<li><code>:key</code> 提供唯一标识，提升 Diff 算法效率</li>
</ul>
<h4 data-id="heading-6">3. <code>v-if / v-else</code>：条件渲染</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>暂无计划<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>根据数据是否存在决定显示内容</li>
</ul>
<h4 data-id="heading-7">4. 动态 class 绑定</h4>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span> :class=<span class="hljs-string">"{ done: todo.done }"</span>&gt;{{ todo<span class="hljs-selector-class">.title</span> }}&lt;/<span class="hljs-selector-tag">span</span>&gt;
</code></pre>
<ul>
<li>若 <code>done</code> 为真，应用 <code>.done</code> 样式（灰色 + 删除线）</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、计算属性：智能派生状态</h3>
<p>任务清单需要实时显示“未完成任务数”和“全选”功能。Vue 用 <code>computed</code> 完美解决：</p>
<h4 data-id="heading-9">1. 只读计算属性：未完成数量</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">active</span> = computed(() =&gt; {
  return todos.value.filter(<span class="hljs-attr">todo</span> =&gt; !todo.done).length<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>自动依赖 <code>todos</code></li>
<li>结果缓存，仅在 <code>todos</code> 变化时重新计算</li>
<li>模板中直接使用 <code>{{ active }}</code></li>
</ul>
<h4 data-id="heading-10">2. 可读写计算属性：全选控制</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">allDone</span> = computed({
  get() {
    return todos.value.every(<span class="hljs-attr">todo</span> =&gt; todo.done)<span class="hljs-comment">;</span>
  },
  set(val) {
    todos.value.forEach(<span class="hljs-attr">todo</span> =&gt; todo.done = val)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>get</strong>：判断是否全部完成</li>
<li><strong>set</strong>：当用户点击“全选”复选框时，批量更新所有任务状态</li>
</ul>
<p>这体现了 Vue 对“属性”的扩展——不仅是值，还可以包含行为。</p>
<hr/>
<h3 data-id="heading-11">五、事件处理：简洁而高效</h3>
<p>添加任务只需一行逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">addTodo</span> = () =&gt; {
  if (!title.value) return<span class="hljs-comment">;</span>
  todos.value.push({
    id: Math.random(), 
    title: title.value,
    done: false
  })<span class="hljs-comment">;</span>
  <span class="hljs-attr">title.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">; // 清空输入框</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>配合 <code>@keydown.enter</code>，用户按回车即可提交，体验流畅。</p>
<hr/>
<h3 data-id="heading-12">六、开发哲学：聚焦数据，而非 DOM</h3>
<p>正如项目注释所言：</p>
<blockquote>
<p>“VUE 做法不再需要思考页面的元素怎么操作，而是要思考数据是怎么变化的。”</p>
</blockquote>
<p>这种转变带来三大优势：</p>
<ol>
<li><strong>开发效率高</strong>：无需手动操作 DOM，减少样板代码</li>
<li><strong>可维护性强</strong>：逻辑围绕数据组织，结构清晰</li>
<li><strong>性能更优</strong>：Vue 内部使用虚拟 DOM 和响应式系统，自动优化更新</li>
</ol>
<p>对新手友好，对老手高效——这正是 Vue “渐进式框架”理念的体现。</p>
<hr/>
<h3 data-id="heading-13">七、结语</h3>
<p>一个简单的任务清单，浓缩了 Vue 3 的精华：</p>
<ul>
<li><strong>响应式系统</strong>：数据变，视图自动更新</li>
<li><strong>Composition API</strong>：逻辑聚合，易于复用</li>
<li><strong>声明式模板</strong>：直观表达 UI 与状态关系</li>
<li><strong>计算属性</strong>：智能、缓存、响应式的派生数据</li>
</ul>
<p>它不仅是一个功能 demo，更是一种思维方式的启蒙：<strong>前端开发的本质，是管理状态，而非操作元素</strong>。</p>
<p>未来，你可以在此基础上扩展：</p>
<ul>
<li>本地存储（localStorage）</li>
<li>过滤视图（全部/未完成/已完成）</li>
<li>动画过渡</li>
<li>TypeScript 类型支持</li>
</ul>
<p>而这一切，都始于对“数据如何流动”的思考。</p>
<hr/>
<h3 data-id="heading-14">附录：完整的App.vue代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;任务清单&lt;/h1&gt;
    &lt;h2&gt;{{ title }}&lt;/h2&gt;
    &lt;input type="text" v-model="title" @keydown.enter="addTodo"&gt;
    &lt;ul v-if="todos.length"&gt;
      &lt;li v-for="todo in todos" :key="todo.id"&gt;
        &lt;input type="checkbox" v-model="todo.done"&gt;
        &lt;span :class="{done: todo.done}"&gt;{{ todo.title }}&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
    &lt;div v-else&gt;
      暂无计划
    &lt;/div&gt;
    &lt;div&gt;
      全选&lt;input type="checkbox" v-model="allDone"&gt;
      {{ active }}
      /
      {{ todos.length }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, computed } from 'vue';

const title = ref("")
const todos = ref([
  {
    id: 1,
    title: '打王者',
    done: false
  },
  {
    id: 2,
    title: '吃饭',
    done: true
  }
])

const active = computed(() =&gt; {
  return todos.value.filter(todo =&gt; !todo.done).length
})

const addTodo = () =&gt; {
  if (!title.value) return;
  todos.value.push({
    id: Math.random,
    title: title.value,
    done: false
  })
  title.value = ''
}

const allDone = computed({
  get() {
    return todos.value.every(todo =&gt; todo.done)
  },
  set(val) {
    todos.value.forEach(todo =&gt; todo.done = val)
  }
})
&lt;/script&gt;

&lt;style&gt;
  .done {
    color: gray;
    text-decoration: line-through;
  }
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.6 新增 clamp() 函数]]></title>    <link>https://juejin.cn/post/7583577045578973210</link>    <guid>https://juejin.cn/post/7583577045578973210</guid>    <pubDate>2025-12-15T00:04:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578973210" data-draft-id="7583571595203379238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.6 新增 clamp() 函数"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-15T00:04:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.6 新增 clamp() 函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:04:26.000Z" title="Mon Dec 15 2025 00:04:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.6 新增 clamp() 函数</h2>
<p>你肯定遇到过这种情况：你想确保某个值始终处在一个指定范围内。</p>
<p>比如你在处理用户输入、读取配置值，或者任何需要“强制边界”的场景。</p>
<p>在这些情况下，如果能有一个内置的 clamp（夹紧/限幅）函数会非常方便。好消息是：PHP 8.6 将引入一个全新的 <code>clamp()</code> 函数，专门用来做这件事。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fphp-8-6-clamp-function" target="_blank" title="https://catchadmin.com/post/2025-12/php-8-6-clamp-function" ref="nofollow noopener noreferrer">原文链接 PHP 8.6 新增 clamp() 函数</a></p>
<h3 data-id="heading-1">什么是 clamp() 函数？</h3>
<p>PHP 8.6 的 <code>clamp()</code> 函数可以把一个值限制在指定的最小值与最大值之间。</p>
<p>它的签名如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$min</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$max</span>): <span class="hljs-keyword">mixed</span>
</code></pre>
<p><code>clamp()</code> 接收三个参数：<code>$value</code>、<code>$min</code>、<code>$max</code>，然后判断 <code>$value</code> 是否在 <code>$min</code> 与 <code>$max</code>（包含边界）之间。</p>
<ul>
<li><strong>小于最小值</strong>：如果 <code>$value</code> 小于 <code>$min</code>，返回 <code>$min</code>。</li>
<li><strong>大于最大值</strong>：如果 <code>$value</code> 大于 <code>$max</code>，返回 <code>$max</code>。</li>
<li><strong>在范围内</strong>：如果 <code>$value</code> 位于 <code>$min</code> 与 <code>$max</code> 之间，返回 <code>$value</code>。</li>
<li><strong>异常情况</strong>：如果 <code>min &gt; max</code>，或者 <code>min/max</code> 为 <code>NAN</code>，会抛出 <code>ValueError</code>。</li>
</ul>
<p>下面是一个最简单的示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$value1</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 返回 15</span>
<span class="hljs-variable">$value2</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);  <span class="hljs-comment">// 返回 10</span>
<span class="hljs-variable">$value3</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">25</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 返回 20</span>
</code></pre>
<p>小趣闻：很久以前我就写过一个自定义的 clamp 函数，当作项目里的工具函数来用。</p>
<h3 data-id="heading-2">使用命名参数的 clamp()</h3>
<p><code>clamp()</code> 配合命名参数会更直观，而且还能重新排序参数。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$brightness</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">value</span>: <span class="hljs-variable">$brightness</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-3">真实场景用法</h3>
<p>下面是一些 <code>clamp()</code> 的实用场景。</p>
<h4 data-id="heading-4">用户输入：把百分比限制在 0 到 100</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$percentage</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$percentage</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
</code></pre>
<h4 data-id="heading-5">UI 滑块：把音量限制在 0 到 10</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$volume</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$volume</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
</code></pre>
<h4 data-id="heading-6">分页：把页码限制在第一页与最后一页之间</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$page</span> = <span class="hljs-title function_ invoke__">clamp</span>((<span class="hljs-keyword">int</span>)<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'page'</span>] ?? <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">$totalPages</span>);
</code></pre>
<h4 data-id="heading-7">限流：避免突发请求数超过上限</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$requests</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$requests</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$maxBurst</span>);
</code></pre>
<h4 data-id="heading-8">日期：确保预订日期在允许窗口内</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-variable">$input</span>);
<span class="hljs-variable">$start</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'2025-08-15'</span>);
<span class="hljs-variable">$end</span>   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'2025-09-15'</span>);
<span class="hljs-variable">$clamped</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$date</span>, <span class="hljs-variable">$start</span>, <span class="hljs-variable">$end</span>); <span class="hljs-comment">// 会按情况返回 start/end/date</span>
</code></pre>
<h4 data-id="heading-9">几何：把角度限制在 0 到 90</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$angle</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$angle</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
</code></pre>
<h4 data-id="heading-10">字符串（按字典序）：把标签限制在 “c” 到 “g”</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$tag</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$tag</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"g"</span>);
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>PHP 8.6 的 <code>clamp()</code> 函数虽然简单，但非常实用：它能帮你用一种更干净、清晰的方式对值进行边界约束。</p>
<p>无论你在处理用户输入、配置、UI 参数，还是任何需要把值限制在某个区间的场景，<code>clamp()</code> 都能让代码更直观。</p>
<p>想了解更多，可以阅读关于 <code>clamp()</code> 的 RFC。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字符串匹配算法]]></title>    <link>https://juejin.cn/post/7583577045578989594</link>    <guid>https://juejin.cn/post/7583577045578989594</guid>    <pubDate>2025-12-15T00:11:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578989594" data-draft-id="7582896213855584271" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 字符串匹配算法"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-15T00:11:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             字符串匹配算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:11:24.000Z" title="Mon Dec 15 2025 00:11:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rabin-Karp算法</h2>
<p>Rabin-Karp算法是一种<strong>基于哈希函数的字符串匹配算法</strong>，由 Michael O. Rabin 和 Richard M. Karp 于1987年提出，核心思想是用<strong>哈希函数</strong>将模式串和文本串中的子串转换为数值进行比较，避免大量不必要的字符比较。这个算法特别适合<strong>多模式串匹配场景</strong>，时间复杂度平均为O(n+m)，n是文本串长度，m是模式串长度。</p>
<p>Rabin-Karp算法的关键在于使用<strong>滚动哈希函数</strong>（Rolling Hash），它可以在常数时间内计算出滑动窗口的新哈希值，保证算法在大多数情况下的高效性。</p>
<h3 data-id="heading-1">算法步骤</h3>
<ol>
<li>计算模式串的哈希值</li>
<li>计算文本串中长度为m的第一个子串的哈希值（m为模式串长度）</li>
<li>在文本串上滑动窗口，对于每个位置：
<ul>
<li>使用滚动哈希技术高效计算当前窗口的哈希值</li>
<li>如果哈希值与模式串相等，则进行字符逐一比较以避免哈希冲突</li>
<li>如果完全匹配，则找到一个匹配位置</li>
</ul>
</li>
<li>重复步骤3，直到处理完整个文本串</li>
</ol>
<p>核心特性</p>
<ul>
<li><strong>基于哈希比较</strong>：通过哈希值比较代替直接字符比较</li>
<li><strong>滚动哈希</strong>：O(1)时间复杂度计算下一窗口的哈希值</li>
<li><strong>时间复杂度</strong>：平均情况O(n+m)，最坏情况O(n*m)</li>
<li><strong>空间复杂度</strong>：O(1)，只需常数额外空间</li>
<li><strong>适用范围</strong>：单模式和多模式串匹配场景，特别是多模式匹配</li>
</ul>
<h3 data-id="heading-2">基础实现</h3>
<p>接下来大家一起看下Rabin-Karp算法的部分主流语言实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabinKarp</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">101</span>; <span class="hljs-comment">// 哈希计算使用的质数</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 计算哈希乘数，等于d^(m-1) % PRIME，用于滚动哈希计算</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m - <span class="hljs-number">1</span>; i++) {
            h = (h * <span class="hljs-number">256</span>) % PRIME;
        }
        
        <span class="hljs-comment">// 计算模式串和第一个窗口的哈希值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">patternHash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">textHash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m; i++) {
            patternHash = (<span class="hljs-number">256</span> * patternHash + pattern.charAt(i)) % PRIME;
            textHash = (<span class="hljs-number">256</span> * textHash + text.charAt(i)) % PRIME;
        }
        
        <span class="hljs-comment">// 滑动窗口，比较哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-comment">// 哈希值相等时，检查是否真正匹配</span>
            <span class="hljs-keyword">if</span> (patternHash == textHash) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
                    <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                        match = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span> (match) {
                    <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
                }
            }
            
            <span class="hljs-comment">// 计算下一个窗口的哈希值</span>
            <span class="hljs-keyword">if</span> (i &lt; n - m) {
                textHash = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + m)) % PRIME;
                <span class="hljs-comment">// 处理负数哈希值</span>
                <span class="hljs-keyword">if</span> (textHash &lt; <span class="hljs-number">0</span>) {
                    textHash += PRIME;
                }
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 打印结果</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> search(text, pattern);
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
            System.out.println(text);
            <span class="hljs-comment">// 打印指示匹配位置的指针</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; position; i++) {
                System.out.print(<span class="hljs-string">" "</span>);
            }
            System.out.println(pattern);
        }
    }
}
</code></pre>
<h3 data-id="heading-3">优化：使用更好的哈希函数</h3>
<p>比如使用更复杂的哈希函数来减少冲突</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImprovedRabinKarp</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>; <span class="hljs-comment">// 第一个哈希的质数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000009</span>; <span class="hljs-comment">// 第二个哈希的质数</span>
    
    <span class="hljs-comment">// 使用双哈希来减少冲突</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 计算哈希乘数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m - <span class="hljs-number">1</span>; i++) {
            h1 = (h1 * <span class="hljs-number">256</span>) % PRIME1;
            h2 = (h2 * <span class="hljs-number">256</span>) % PRIME2;
        }
        
        <span class="hljs-comment">// 计算模式串和第一个窗口的哈希值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">patternHash1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">patternHash2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m; i++) {
            patternHash1 = (<span class="hljs-number">256</span> * patternHash1 + pattern.charAt(i)) % PRIME1;
            patternHash2 = (<span class="hljs-number">256</span> * patternHash2 + pattern.charAt(i)) % PRIME2;
            textHash1 = (<span class="hljs-number">256</span> * textHash1 + text.charAt(i)) % PRIME1;
            textHash2 = (<span class="hljs-number">256</span> * textHash2 + text.charAt(i)) % PRIME2;
        }
        
        <span class="hljs-comment">// 滑动窗口，比较哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-comment">// 两个哈希都相等时，再进行字符比较</span>
            <span class="hljs-keyword">if</span> (patternHash1 == textHash1 &amp;&amp; patternHash2 == textHash2) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
                    <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                        match = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span> (match) {
                    <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
                }
            }
            
            <span class="hljs-comment">// 计算下一个窗口的哈希值</span>
            <span class="hljs-keyword">if</span> (i &lt; n - m) {
                textHash1 = (<span class="hljs-number">256</span> * (textHash1 - text.charAt(i) * h1) + text.charAt(i + m)) % PRIME1;
                textHash2 = (<span class="hljs-number">256</span> * (textHash2 - text.charAt(i) * h2) + text.charAt(i + m)) % PRIME2;
                
                <span class="hljs-comment">// 处理负数哈希值</span>
                <span class="hljs-keyword">if</span> (textHash1 &lt; <span class="hljs-number">0</span>) textHash1 += PRIME1;
                <span class="hljs-keyword">if</span> (textHash2 &lt; <span class="hljs-number">0</span>) textHash2 += PRIME2;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-4">优点</h3>
<ul>
<li>平均情况下时间复杂度为O(n+m)，接近线性时间</li>
<li>在多模式匹配场景下效率高</li>
<li>可以通过预处理模式串提高效率</li>
<li>滚动哈希计算使得算法高效移动窗口</li>
<li>实现相对简单，原理容易理解</li>
</ul>
<h3 data-id="heading-5">缺点</h3>
<ul>
<li>哈希冲突可能导致额外的字符比较</li>
<li>最坏情况下的时间复杂度为O(n*m)</li>
<li>哈希函数的选择对算法性能影响很大</li>
<li>需要注意数值溢出问题</li>
<li>对于短模式串和文本串，预处理开销可能抵消算法优势</li>
</ul>
<h3 data-id="heading-6">应用场景</h3>
<p>1）文档相似度检测和抄袭检测
2）网络安全中的特征码匹配
3）多模式字符串搜索引擎
4）编译器中的词法分析器</p>
<h3 data-id="heading-7">扩展：Rabin-Karp指纹算法</h3>
<p>Rabin-Karp算法的一个变种应用于文件相似度比较</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabinKarpFingerprint</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">WINDOW_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>; <span class="hljs-comment">// 指纹窗口大小</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;Long&gt; <span class="hljs-title function_">generateFingerprints</span><span class="hljs-params">(String text)</span> {
        Set&lt;Long&gt; fingerprints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (n &lt; WINDOW_SIZE) {
            fingerprints.add(calculateHash(text, n));
            <span class="hljs-keyword">return</span> fingerprints;
        }
        
        <span class="hljs-comment">// 计算第一个窗口的哈希值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash</span> <span class="hljs-operator">=</span> calculateHash(text, WINDOW_SIZE);
        fingerprints.add(textHash);
        
        <span class="hljs-comment">// 计算哈希乘数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; WINDOW_SIZE - <span class="hljs-number">1</span>; i++) {
            h = (h * <span class="hljs-number">256</span>) % PRIME;
        }
        
        <span class="hljs-comment">// 滑动窗口，计算所有长度为WINDOW_SIZE的子串哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - WINDOW_SIZE - <span class="hljs-number">1</span>; i++) {
            textHash = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + WINDOW_SIZE)) % PRIME;
            <span class="hljs-keyword">if</span> (textHash &lt; <span class="hljs-number">0</span>) {
                textHash += PRIME;
            }
            fingerprints.add(textHash);
        }
        
        <span class="hljs-keyword">return</span> fingerprints;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSimilarity</span><span class="hljs-params">(String text1, String text2)</span> {
        Set&lt;Long&gt; fingerprints1 = generateFingerprints(text1);
        Set&lt;Long&gt; fingerprints2 = generateFingerprints(text2);
        
        <span class="hljs-comment">// 计算交集大小</span>
        Set&lt;Long&gt; intersection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(fingerprints1);
        intersection.retainAll(fingerprints2);
        
        <span class="hljs-comment">// 计算并集大小</span>
        Set&lt;Long&gt; union = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(fingerprints1);
        union.addAll(fingerprints2);
        
        <span class="hljs-comment">// 杰卡德相似度系数</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) intersection.size() / union.size();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">calculateHash</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> length)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) {
            hash = (<span class="hljs-number">256</span> * hash + str.charAt(i)) % PRIME;
        }
        <span class="hljs-keyword">return</span> hash;
    }
}
</code></pre>
<h3 data-id="heading-8">扩展：子字符串哈希</h3>
<p>一些编程竞赛里也使用Rabin-Karp思想进行高效的子字符串查询</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubstringHash</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BASE</span> <span class="hljs-operator">=</span> <span class="hljs-number">256</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] hash; <span class="hljs-comment">// 前缀哈希值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] pow;  <span class="hljs-comment">// BASE的幂</span>
    <span class="hljs-keyword">private</span> String s;    <span class="hljs-comment">// 源字符串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SubstringHash</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-built_in">this</span>.s = s;
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        hash = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[n + <span class="hljs-number">1</span>];
        pow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[n + <span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 预计算BASE的幂</span>
        pow[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= n; i++) {
            pow[i] = (pow[i - <span class="hljs-number">1</span>] * BASE) % PRIME;
        }
        
        <span class="hljs-comment">// 计算所有前缀的哈希值</span>
        hash[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            hash[i + <span class="hljs-number">1</span>] = (hash[i] * BASE + s.charAt(i)) % PRIME;
        }
    }
    
    <span class="hljs-comment">// 计算子串s[l..r]的哈希值（0-indexed）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">substringHash</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> {
        <span class="hljs-comment">// 获取s[0...r]的哈希值，减去s[0...l-1]的哈希值（需要进行适当调整）</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (hash[r + <span class="hljs-number">1</span>] - (hash[l] * pow[r - l + <span class="hljs-number">1</span>]) % PRIME) % PRIME;
        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) {
            result += PRIME;
        }
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 检查两个子串是否相同</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">areSubstringsEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> l1, <span class="hljs-type">int</span> r1, <span class="hljs-type">int</span> l2, <span class="hljs-type">int</span> r2)</span> {
        <span class="hljs-keyword">if</span> (r1 - l1 != r2 - l2) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 长度不同</span>
        }
        <span class="hljs-keyword">return</span> substringHash(l1, r1) == substringHash(l2, r2);
    }
}
</code></pre>
<h3 data-id="heading-9">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现 strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-dna-sequences%2F" target="_blank" title="https://leetcode.cn/problems/repeated-dna-sequences/" ref="nofollow noopener noreferrer">187. 重复的DNA序列</a> - 利用Rabin-Karp滚动哈希思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-duplicate-substring%2F" target="_blank" title="https://leetcode.cn/problems/longest-duplicate-substring/" ref="nofollow noopener noreferrer">1044. 最长重复子串</a> - 结合二分查找和Rabin-Karp算法</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fstrings-differ-by-one-character%2F" target="_blank" title="https://leetcode.cn/problems/strings-differ-by-one-character/" ref="nofollow noopener noreferrer">1554. 只有一个不同字符的字符串</a></li>
</ul>
<p>Rabin-Karp算法巧妙结合哈希计算和滚动窗口技术，在字符串匹配领域提供了一种高效的解决方案，特别适合多模式匹配和大规模文本处理场景。</p>
<h2 data-id="heading-10">Boyer-Moore算法</h2>
<p>Boyer-Moore算法是一种高效的字符串匹配算法，由 Robert S. Boyer和J Strother Moore 设计于1977年。它<strong>从右向左比较</strong>字符，并利用两个启发式规则（坏字符规则和好后缀规则）在不匹配情况下实现较大跳跃，减少比较次数。Boyer-Moore算法在实际应用中大部分情况下<strong>比朴素算法和KMP算法更高效</strong>。</p>
<h3 data-id="heading-11">算法步骤</h3>
<ol>
<li>预处理模式串，构建坏字符表和好后缀表</li>
<li>将模式串对齐到文本串的开始位置</li>
<li>从模式串的最右侧字符开始比较，从右向左进行匹配</li>
<li>如果发生不匹配，通过以下规则计算跳转距离：
<ul>
<li>坏字符规则：根据不匹配字符在模式串中的最右位置决定跳转距离</li>
<li>好后缀规则：根据已匹配部分在模式串中的重复情况决定跳转距离</li>
</ul>
</li>
<li>选择两个规则中的最大跳转距离，移动模式串</li>
<li>重复步骤3-5，直到找到匹配或到达文本串末尾</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>从右向左比较</strong>：与大多数字符串匹配算法不同，从模式串的末尾开始比较</li>
<li><strong>双规则跳转</strong>：利用坏字符规则和好后缀规则计算跳转距离</li>
<li><strong>时间复杂度</strong>：最坏情况O(m*n)，m是模式串长度，n是文本串长度；平均情况接近O(n/m)</li>
<li><strong>空间复杂度</strong>：O(k+m)，其中k是字符集大小，m是模式串长度</li>
<li><strong>适用范围</strong>：特别适合长模式串和大字符集场景</li>
</ul>
<h3 data-id="heading-12">基础实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoyerMoore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] goodSuffix; <span class="hljs-comment">// 好后缀表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] borderPos; <span class="hljs-comment">// 边界位置表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BoyerMoore</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = -<span class="hljs-number">1</span>; <span class="hljs-comment">// 初始化为-1</span>
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            badChar[pattern.charAt(j)] = j; <span class="hljs-comment">// 记录每个字符最右出现位置</span>
        }
        
        <span class="hljs-comment">// 初始化好后缀表和边界位置表</span>
        goodSuffix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        borderPos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        processSuffixes();
    }
    
    <span class="hljs-comment">// 预处理好后缀表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSuffixes</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> m, j = m + <span class="hljs-number">1</span>;
        borderPos[i] = j;
        
        <span class="hljs-comment">// 计算边界位置</span>
        <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">while</span> (j &lt;= m &amp;&amp; pattern.charAt(i - <span class="hljs-number">1</span>) != pattern.charAt(j - <span class="hljs-number">1</span>)) {
                <span class="hljs-keyword">if</span> (goodSuffix[j] == <span class="hljs-number">0</span>) {
                    goodSuffix[j] = j - i;
                }
                j = borderPos[j];
            }
            i--; j--;
            borderPos[i] = j;
        }
        
        <span class="hljs-comment">// 计算好后缀表</span>
        j = borderPos[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
            <span class="hljs-keyword">if</span> (goodSuffix[i] == <span class="hljs-number">0</span>) {
                goodSuffix[i] = j;
            }
            <span class="hljs-keyword">if</span> (i == j) {
                j = borderPos[j];
            }
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> skip;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i += skip) {
            skip = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
                <span class="hljs-keyword">if</span> (pattern.charAt(j) != text.charAt(i + j)) {
                    <span class="hljs-comment">// 坏字符规则</span>
                    skip = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)]);
                    <span class="hljs-comment">// 好后缀规则</span>
                    <span class="hljs-keyword">if</span> (j &lt; m - <span class="hljs-number">1</span>) {
                        skip = Math.max(skip, goodSuffix[j + <span class="hljs-number">1</span>]);
                    }
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">if</span> (skip == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
    
    <span class="hljs-comment">// 测试</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"HERE IS A SIMPLE EXAMPLE"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"EXAMPLE"</span>;
        
        <span class="hljs-type">BoyerMoore</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoyerMoore</span>(pattern);
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> bm.search(text);
        
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
            System.out.println(text);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; position; i++) {
                System.out.print(<span class="hljs-string">" "</span>);
            }
            System.out.println(pattern);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">优化策略</h3>
<h4 data-id="heading-14">简化好后缀表构建</h4>
<p>对于一些应用场景，可以只使用坏字符规则，简化算法实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimplifiedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimplifiedBoyerMoore</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = -<span class="hljs-number">1</span>; <span class="hljs-comment">// 初始化为-1</span>
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            badChar[pattern.charAt(j)] = j; <span class="hljs-comment">// 记录每个字符最右出现位置</span>
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> skip;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i += skip) {
            skip = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
                <span class="hljs-keyword">if</span> (pattern.charAt(j) != text.charAt(i + j)) {
                    <span class="hljs-comment">// 仅使用坏字符规则</span>
                    skip = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)]);
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">if</span> (skip == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h4 data-id="heading-15">缓存预计算结果</h4>
<p>针对需要重复搜索同一模式串的场景，可以预计算并缓存结果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, BoyerMoore&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-comment">// 检查缓存中是否有预计算的Boyer-Moore对象</span>
        <span class="hljs-type">BoyerMoore</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> cache.get(pattern);
        <span class="hljs-keyword">if</span> (bm == <span class="hljs-literal">null</span>) {
            bm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoyerMoore</span>(pattern);
            cache.put(pattern, bm);
        }
        
        <span class="hljs-keyword">return</span> bm.search(text);
    }
}
</code></pre>
<h3 data-id="heading-16">优点</h3>
<ul>
<li>在实际应用中，大部分场景比KMP和朴素算法更高效</li>
<li>最好情况下可以跳过大量文本，实现亚线性时间复杂度</li>
<li>对于长模式串和大字符集特别有效</li>
<li>预处理跟模式串有关，与文本串长度无关</li>
</ul>
<h3 data-id="heading-17">缺点</h3>
<ul>
<li>预处理复杂，特别是好后缀表的构建</li>
<li>需要额外空间存储坏字符表和好后缀表</li>
<li>最坏情况下时间复杂度仍为O(m*n)</li>
<li>对于短模式串，预处理开销可能抵消算法优势</li>
<li>好后缀规则的实现较复杂，容易出错</li>
</ul>
<h3 data-id="heading-18">应用场景</h3>
<p>1）文本编辑器的查找功能
2）网络安全中的特征码匹配
3）自然语言处理中的关键词检索
4）大规模文本数据处理</p>
<h3 data-id="heading-19">扩展：Horspool算法</h3>
<p>Horspool算法是Boyer-Moore的简化版本，只使用坏字符规则，但是对坏字符表进行了修改</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Horspool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Horspool</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-comment">// 所有字符默认移动模式串长度</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = m;
        }
        <span class="hljs-comment">// 模式串中的字符（除了最后一个）设置为对应值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m - <span class="hljs-number">1</span>; j++) {
            badChar[pattern.charAt(j)] = m - <span class="hljs-number">1</span> - j;
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; <span class="hljs-comment">// 从模式串最后一个字符对齐开始</span>
        <span class="hljs-keyword">while</span> (i &lt; n) {
            <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (k &lt; m &amp;&amp; pattern.charAt(m - <span class="hljs-number">1</span> - k) == text.charAt(i - k)) {
                k++;
            }
            
            <span class="hljs-keyword">if</span> (k == m) {
                <span class="hljs-keyword">return</span> i - m + <span class="hljs-number">1</span>; <span class="hljs-comment">// 找到匹配</span>
            }
            
            <span class="hljs-comment">// 使用坏字符规则移动</span>
            i += badChar[text.charAt(i)];
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-20">扩展：Sunday算法</h3>
<p>Sunday算法是另一种Boyer-Moore的变种，它关注的是文本串中模式串后面的字符</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sunday</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] shift; <span class="hljs-comment">// 移动表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Sunday</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化移动表</span>
        shift = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-comment">// 所有字符默认移动模式串长度+1</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            shift[c] = m + <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">// 模式串中的字符设置为对应值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            shift[pattern.charAt(j)] = m - j;
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 从文本串开始位置</span>
        <span class="hljs-keyword">while</span> (i &lt;= n - m) {
            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (j &lt; m &amp;&amp; pattern.charAt(j) == text.charAt(i + j)) {
                j++;
            }
            
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
            }
            
            <span class="hljs-comment">// 下一个位置超出文本串长度，返回-1</span>
            <span class="hljs-keyword">if</span> (i + m &gt;= n) {
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            }
            
            <span class="hljs-comment">// 使用Sunday算法的移动规则</span>
            i += shift[text.charAt(i + m)];
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-21">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-string-match%2F" target="_blank" title="https://leetcode.cn/problems/repeated-string-match/" ref="nofollow noopener noreferrer">686. 重复叠加字符串匹配</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<h2 data-id="heading-22">KMP算法</h2>
<p>KMP（Knuth-Morris-Pratt）算法是一种高效的字符串匹配算法，核心思想是<strong>利用已经部分匹配的信息，避免重复比较</strong>，在文本串中快速查找模式串。KMP算法特别适合<strong>处理长文本和重复性高的模式串</strong>，时间复杂度是O(m+n)，m是模式串长度，n是文本串长度。</p>
<p>KMP算法的关键在于构建一个部分匹配表（也叫失败函数或者next数组），这个表记录了当匹配失败时，模式串指针应该回退到的位置，让算法跳过已知不可能匹配的位置，提高匹配效率。</p>
<h3 data-id="heading-23">算法步骤</h3>
<p>KMP算法主要分为两个阶段：</p>
<ol>
<li><strong>预处理阶段</strong>：计算模式串的部分匹配表（next数组）
<ul>
<li>构建一个数组，记录每个位置的最长相等前后缀长度</li>
<li>该数组用于在匹配失败时确定模式串指针的回退位置</li>
</ul>
</li>
<li><strong>匹配阶段</strong>：使用部分匹配表在文本串中查找模式串
<ul>
<li>从左到右同时遍历文本串和模式串</li>
<li>当字符不匹配时，根据next数组回退模式串指针</li>
<li>当模式串完全匹配时，记录匹配位置并继续查找其他匹配</li>
</ul>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>线性时间复杂度</strong>：O(m+n)，其中m是模式串长度，n是文本串长度</li>
<li><strong>高效利用历史信息</strong>：通过预处理避免了重复比较</li>
<li><strong>只需一次遍历文本串</strong>：文本串指针不会回退</li>
<li><strong>空间复杂度</strong>：O(m)，仅需存储模式串的部分匹配表</li>
<li><strong>适用场景</strong>：特别适合长文本和具有重复性的模式串</li>
</ul>
<h3 data-id="heading-24">基础实现</h3>
<h4 data-id="heading-25">暴力解法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveStringMatcher</span> {
    
    <span class="hljs-comment">/**
     * 朴素字符串匹配算法
     * <span class="hljs-doctag">@param</span> text 文本串
     * <span class="hljs-doctag">@param</span> pattern 模式串
     * <span class="hljs-doctag">@return</span> 匹配成功则返回模式串在文本串中的起始位置，否则返回-1
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">naiveSearch</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (n &lt; m) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// 尝试所有可能的匹配位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-type">int</span> j;
            
            <span class="hljs-comment">// 从当前位置开始比较模式串和文本串</span>
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; j++) {
                <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 发现不匹配字符，终止内层循环</span>
                }
            }
            
            <span class="hljs-comment">// 如果j等于m，说明模式串完全匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 返回匹配位置</span>
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> naiveSearch(text, pattern);
        
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
        }
    }
}
</code></pre>
<p>上述实现暴力枚举所有可能的匹配位置，逐一比较文本串与模式串的每个字符，直到找到完全匹配或确定不存在匹配</p>
<h4 data-id="heading-26">KMP算法的实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KMP</span> {
    <span class="hljs-comment">// 构建部分匹配表（next数组）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] buildNext(String pattern) {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span>[] next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        next[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 第一个字符的最长相等前后缀长度为0</span>
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span>; i &lt; m; i++) {
            <span class="hljs-comment">// 当前字符不匹配，回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (pattern.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 记录当前位置的最长相等前后缀长度</span>
            next[i] = j;
        }
        
        <span class="hljs-keyword">return</span> next;
    }
    
    <span class="hljs-comment">// KMP搜索算法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kmpSearch</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 构建next数组</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        
        <span class="hljs-comment">// 进行匹配</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-comment">// 当前字符不匹配，根据next数组回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (text.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 完全匹配，返回起始索引</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i - m + <span class="hljs-number">1</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 查找所有匹配位置</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; <span class="hljs-title function_">kmpSearchAll</span><span class="hljs-params">(String text, String pattern)</span> {
        List&lt;Integer&gt; positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> positions;
        }
        
        <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
            <span class="hljs-keyword">return</span> positions;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 构建next数组</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        
        <span class="hljs-comment">// 进行匹配</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-comment">// 当前字符不匹配，回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (text.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 完全匹配，记录位置并继续匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                positions.add(i - m + <span class="hljs-number">1</span>);
                <span class="hljs-comment">// 回退j以寻找下一个匹配</span>
                j = next[j - <span class="hljs-number">1</span>];
            }
        }
        
        <span class="hljs-keyword">return</span> positions;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> kmpSearch(text, pattern);
        List&lt;Integer&gt; allPos = kmpSearchAll(text, pattern);
        
        System.out.println(<span class="hljs-string">"文本: "</span> + text);
        System.out.println(<span class="hljs-string">"模式: "</span> + pattern);
        System.out.println(<span class="hljs-string">"首次匹配位置: "</span> + (pos != -<span class="hljs-number">1</span> ? pos : <span class="hljs-string">"未找到"</span>));
        System.out.println(<span class="hljs-string">"所有匹配位置: "</span> + allPos);
        
        <span class="hljs-comment">// 打印next数组，帮助理解</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        System.out.print(<span class="hljs-string">"next数组: "</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : next) {
            System.out.print(val + <span class="hljs-string">" "</span>);
        }
        System.out.println();
    }
}
</code></pre>
<p>在上述代码中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前字符不匹配，回退j</span>
<span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
    j = next[j - <span class="hljs-number">1</span>];
}
</code></pre>
<p>是 KMP 算法的核心，在匹配失败时根据预先计算的next数组来确定模式串指针的回退位置。</p>
<h3 data-id="heading-27">优化</h3>
<p>优化后的 next 数组</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化next数组，避免匹配失败后回退到同样会失败的位置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] buildOptimizedNext(String pattern) {
    <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
    <span class="hljs-type">int</span>[] next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
    next[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span>; i &lt; m; i++) {
        <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
            j = next[j - <span class="hljs-number">1</span>];
        }
        
        <span class="hljs-keyword">if</span> (pattern.charAt(i) == pattern.charAt(j)) {
            j++;
        }
        
        <span class="hljs-comment">// 当前位置匹配失败时，如果回退位置的字符与当前位置相同，则继续回退</span>
        <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> &lt; m &amp;&amp; pattern.charAt(i + <span class="hljs-number">1</span>) == pattern.charAt(j)) {
            next[i] = next[j - <span class="hljs-number">1</span>];
        } <span class="hljs-keyword">else</span> {
            next[i] = j;
        }
    }
    
    <span class="hljs-keyword">return</span> next;
}
</code></pre>
<p>预处理减少分支实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 预处理字符映射，减少字符比较的分支</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kmpSearchOptimized</span><span class="hljs-params">(String text, String pattern)</span> {
    <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
    
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
    <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
    
    <span class="hljs-comment">// 使用数组映射来加速字符比较（假设字符集为ASCII）</span>
    <span class="hljs-comment">// 为每个模式字符的每个位置创建一个状态转移表</span>
    <span class="hljs-type">int</span>[][] dfa = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">256</span>][m];
    
    <span class="hljs-comment">// 初始化第一个字符的DFA</span>
    dfa[pattern.charAt(<span class="hljs-number">0</span>)][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">X</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">1</span>; j &lt; m; j++) {
        <span class="hljs-comment">// 复制匹配失败情况下的值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; <span class="hljs-number">256</span>; c++) {
            dfa[c][j] = dfa[c][X];
        }
        <span class="hljs-comment">// 设置匹配成功情况下的值</span>
        dfa[pattern.charAt(j)][j] = j + <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 更新重启状态</span>
        X = dfa[pattern.charAt(j)][X];
    }
    
    <span class="hljs-comment">// 模式匹配</span>
    <span class="hljs-type">int</span> i, j;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n &amp;&amp; j &lt; m; i++) {
        j = dfa[text.charAt(i)][j];
    }
    
    <span class="hljs-keyword">if</span> (j == m) {
        <span class="hljs-keyword">return</span> i - m; <span class="hljs-comment">// 找到匹配</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;    <span class="hljs-comment">// 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-28">优点</h3>
<ul>
<li>时间复杂度为O(m+n)，优于朴素的字符串匹配算法(暴力解法)</li>
<li>文本串只需扫描一次，不会回退</li>
<li>对于包含重复模式的字符串会高效</li>
<li>预处理模式串，可以多次用于不同的文本串</li>
<li>能快速跳过已知不会匹配的位置</li>
</ul>
<h3 data-id="heading-29">缺点</h3>
<ul>
<li>需要额外的空间存储next数组</li>
<li>构建next数组的逻辑较为复杂，不易理解</li>
<li>在模式串较短或无重复模式时，相比简单算法优势不明显</li>
<li>实现时容易出错，特别是处理边界情况</li>
</ul>
<h3 data-id="heading-30">应用场景</h3>
<p>1）生物信息学中的DNA序列匹配
2）网络入侵检测系统中的模式匹配
3）搜索引擎的关键词匹配
4）数据压缩算法中的模式识别</p>
<h3 data-id="heading-31">扩展：多模式字符串匹配</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Aho-Corasick算法 - KMP的多模式扩展</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AhoCorasick</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> {
        TrieNode[] children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>[<span class="hljs-number">256</span>];
        TrieNode fail;
        List&lt;Integer&gt; patternIndices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrieNode</span><span class="hljs-params">()</span> {
            fail = <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-keyword">private</span> TrieNode root;
    <span class="hljs-keyword">private</span> String[] patterns;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AhoCorasick</span><span class="hljs-params">(String[] patterns)</span> {
        <span class="hljs-built_in">this</span>.patterns = patterns;
        buildTrie();
        buildFailureLinks();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildTrie</span><span class="hljs-params">()</span> {
        root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; patterns.length; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> patterns[i];
            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : pattern.toCharArray()) {
                <span class="hljs-keyword">if</span> (node.children[c] == <span class="hljs-literal">null</span>) {
                    node.children[c] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();
                }
                node = node.children[c];
            }
            
            node.patternIndices.add(i);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFailureLinks</span><span class="hljs-params">()</span> {
        Queue&lt;TrieNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 初始化根节点的子节点</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
            <span class="hljs-keyword">if</span> (root.children[i] != <span class="hljs-literal">null</span>) {
                root.children[i].fail = root;
                queue.offer(root.children[i]);
            } <span class="hljs-keyword">else</span> {
                root.children[i] = root;
            }
        }
        
        <span class="hljs-comment">// BFS构建失败链接</span>
        <span class="hljs-keyword">while</span> (!queue.isEmpty()) {
            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
                <span class="hljs-keyword">if</span> (node.children[i] != <span class="hljs-literal">null</span>) {
                    <span class="hljs-type">TrieNode</span> <span class="hljs-variable">failNode</span> <span class="hljs-operator">=</span> node.fail;
                    
                    <span class="hljs-keyword">while</span> (failNode != root &amp;&amp; failNode.children[i] == <span class="hljs-literal">null</span>) {
                        failNode = failNode.fail;
                    }
                    
                    failNode = failNode.children[i];
                    node.children[i].fail = failNode;
                    
                    <span class="hljs-comment">// 合并匹配结果</span>
                    node.children[i].patternIndices.addAll(failNode.patternIndices);
                    
                    queue.offer(node.children[i]);
                }
            }
        }
    }
    
    <span class="hljs-keyword">public</span> List&lt;Pair&lt;Integer, Integer&gt;&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        List&lt;Pair&lt;Integer, Integer&gt;&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">currentState</span> <span class="hljs-operator">=</span> root;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
            
            <span class="hljs-keyword">while</span> (currentState != root &amp;&amp; currentState.children[c] == <span class="hljs-literal">null</span>) {
                currentState = currentState.fail;
            }
            
            currentState = currentState.children[c];
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> patternIndex : currentState.patternIndices) {
                <span class="hljs-type">int</span> <span class="hljs-variable">endPos</span> <span class="hljs-operator">=</span> i;
                <span class="hljs-type">int</span> <span class="hljs-variable">startPos</span> <span class="hljs-operator">=</span> endPos - patterns[patternIndex].length() + <span class="hljs-number">1</span>;
                results.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Pair</span>&lt;&gt;(patternIndex, startPos));
            }
        }
        
        <span class="hljs-keyword">return</span> results;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Pair</span>&lt;K, V&gt; {
        K first;
        V second;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Pair</span><span class="hljs-params">(K first, V second)</span> {
            <span class="hljs-built_in">this</span>.first = first;
            <span class="hljs-built_in">this</span>.second = second;
        }
    }
}
</code></pre>
<h3 data-id="heading-32">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 找出字符串中第一个匹配项的下标</a> - 标准的字符串匹配问题</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fshortest-palindrome%2F" target="_blank" title="https://leetcode.cn/problems/shortest-palindrome/" ref="nofollow noopener noreferrer">214. 最短回文串</a> - 可以使用KMP算法的next数组思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a> - 使用KMP的next数组判断字符串是否由重复子串构成</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<p>KMP算法是字符串处理中的经典算法，用来解决字符串匹配问题，理解它对提升算法设计能力还是很有帮助的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%]]></title>    <link>https://juejin.cn/post/7583325900294766592</link>    <guid>https://juejin.cn/post/7583325900294766592</guid>    <pubDate>2025-12-15T00:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583325900294766592" data-draft-id="7583507286317481984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T00:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:17:15.000Z" title="Mon Dec 15 2025 00:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>ES2023（ECMAScript 2023）是 JavaScript 语言的最新版本，带来了多项实用且强大的新特性。这些特性不仅提升了开发效率，还优化了代码的可读性和性能。本文将深入解析其中 7 个最重要的新特性，尤其是第 5 个特性，它能够显著减少代码量，让开发更加高效。无论你是前端开发者还是全栈工程师，掌握这些特性都将为你的项目带来质的飞跃。</p>
<hr/>
<h3 data-id="heading-2">1. Array.prototype.findLast() 和 findLastIndex()</h3>
<p>ES2023 为数组新增了两个方法：<code>findLast()</code> 和 <code>findLastIndex()</code>。它们的作用是从数组的末尾开始查找元素，而不是传统的从开头查找。</p>
<h4 data-id="heading-3">使用场景</h4>
<p>假设有一个数组 <code>[1, 2, 3, 4, 5, 2]</code>，你想找到最后一个值为 <code>2</code> 的元素或其索引。在 ES2023 之前，你需要手动逆序遍历数组或使用 <code>Array.reverse()</code>，现在可以直接调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>];
<span class="hljs-keyword">const</span> lastTwo = arr.<span class="hljs-title function_">findLast</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-keyword">const</span> lastTwoIndex = arr.<span class="hljs-title function_">findLastIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<h4 data-id="heading-4"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>避免手动逆序遍历</strong>：简化了从后向前查找的逻辑。</li>
<li><strong>性能优化</strong>：无需创建反转数组的副本（<code>reverse()</code>会修改原数组）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. Hashbang Grammar（Shebang）支持</h3>
<p>ES2023 正式支持 Hashbang（即 <code>#!</code>）语法，使得 JavaScript 文件可以直接作为脚本运行。</p>
<h4 data-id="heading-6"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello from a Node.js script!"</span>);
</code></pre>
<h4 data-id="heading-7"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>标准化脚本执行</strong>：让 JavaScript CLI工具的开发更加规范化。</li>
<li><strong>跨平台兼容性</strong>：Unix/Linux系统可以直接识别并执行带有Shebang的脚本。</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. Symbols as WeakMap Keys</h3>
<p>ES2023允许将<code>Symbol</code>作为<code>WeakMap</code>的键值，这为元编程和内存管理提供了更多可能性。</p>
<h4 data-id="heading-9"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">const</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'privateData'</span>);
weakMap.<span class="hljs-title function_">set</span>(key, { <span class="hljs-attr">secret</span>: <span class="hljs-string">'123'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weakMap.<span class="hljs-title function_">get</span>(key)); <span class="hljs-comment">// { secret: '123' }</span>
</code></pre>
<h4 data-id="heading-10"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>隐私保护</strong>：Symbol作为键可以防止外部直接访问数据。</li>
<li><strong>内存管理</strong>：WeakMap不会阻止垃圾回收器回收键对象的内存。</li>
</ul>
<hr/>
<h3 data-id="heading-11">4. Array.prototype.toReversed(), toSorted(), toSpliced(), and with()</h3>
<p>ES2023新增了四个非破坏性数组方法，它们不会修改原数组，而是返回一个新的数组副本。</p>






























<table><thead><tr><th>方法</th><th>作用</th><th>传统方式对比</th></tr></thead><tbody><tr><td><code>toReversed()</code></td><td>返回逆序数组</td><td><code>[...arr].reverse()</code></td></tr><tr><td><code>toSorted()</code></td><td>返回排序后的数组</td><td><code>[...arr].sort()</code></td></tr><tr><td><code>toSpliced(start, deleteCount, ...items)</code></td><td>返回拼接后的数组</td><td>手动复制并操作</td></tr><tr><td><code>with(index, value)</code></td><td>替换指定位置的元素并返回新数组</td><td>手动复制并赋值</td></tr></tbody></table>
<h4 data-id="heading-12"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, —<span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> sorted = arr.<span class="hljs-title function_">toSorted</span>(); <span class="hljs-comment">// [—5, 1, 2]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1, 2,—5] （原数组不变）</span>
</code></pre>
<h4 data-id="heading-13"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>不可变性支持</strong>：函数式编程中更安全地操作数据。</li>
<li><strong>减少错误</strong>：避免意外修改原数组的问题。</li>
</ul>
<hr/>
<h3 data-id="heading-14">5. #5: Records &amp; Tuples Proposal (Stage 2) ——代码量减少50%的关键！</h3>
<p>这是本文的重磅特性！虽然它目前处于 Stage 2（尚未正式纳入ES2023），但已经可以通过Babel或TypeScript尝鲜使用。它引入了两个新的数据结构：<strong>Record（不可变对象）和Tuple（不可变数组）</strong>。</p>
<h4 data-id="heading-15"><strong>核心优势</strong></h4>
<ul>
<li><strong>深度不可变</strong>:  数据一旦创建就无法修改。</li>
<li><strong>结构共享</strong>:  类似Immer.js的性能优化。</li>
<li><strong>值类型比较</strong>:  可以直接用 <code>===</code>比较内容是否相同。</li>
</ul>
<h4 data-id="heading-16"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Record（类似对象）</span>
<span class="hljs-keyword">const</span> record = #{ <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,<span class="hljs-attr">y</span>: <span class="hljs-number">2</span> };
<span class="hljs-comment">// Tuple（类似数组）</span>
<span class="hljs-keyword">const</span> tuple = #[<span class="hljs-number">1</span>,<span class="hljs-string">"hello"</span>,<span class="hljs-literal">true</span>];
</code></pre>
<h4 data-id="heading-17"><strong>实际应用</strong></h4>
<p>假设你有一个函数需要比较两个配置对象是否相同：</p>
<h5 data-id="heading-18"><strong>传统方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(a)===<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(b);
}
</code></pre>
<h5 data-id="heading-19"><strong>Records &amp; Tuples方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> a===b;
}
</code></pre>
<p>不仅如此，React组件的props比较、Redux的状态管理等场景都可以大幅简化！</p>
<h5 data-id="heading-20"> 为什么能减少50%代码量？</h5>
<ol>
<li> 不再需要深拷贝/深比较工具函数（如lodash.isEqual）。</li>
<li> 不需要Immutable.js这样的第三方库。</li>
<li> 简化React的shouldComponentUpdate逻辑。</li>
</ol>
<hr/>
<h3 data-id="heading-21">6. Error Cause Chains (Error实例新增cause属性)</h3>
<p>ES2023允许在抛出错误时链式传递根本原因。</p>
<h4 data-id="heading-22"> 示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">connectToDatabase</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to initialize app"</span>,{ <span class="hljs-attr">cause</span>:err });
}
</code></pre>
<p>捕获时可以访问完整的错误链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">initApp</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">cause</span>);<span class="hljs-comment">//原始数据库错误</span>
}
</code></pre>
<h4 data-id="heading-23"> 为什么重要？</h4>
<ul>
<li> 更好的错误调试体验。</li>
<li> 保持完整的错误上下文。</li>
</ul>
<hr/>
<h3 data-id="heading-24">7. Array Grouping (Stage 3提案)</h3>
<p>虽然不是正式标准的一部分，但Chrome已经实现了这个功能。</p>
<p>通过groupBy方法可以轻松实现SQL式的分组操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inventory=[
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"asparagus"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"vegetables"</span>},
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"bananas"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"fruit"</span>},
];
<span class="hljs-keyword">const</span> result=inventory.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function">(<span class="hljs-params">{type}</span>)=&gt;</span>type);
<span class="hljs-comment">/*结果:
{
vegetables:[...],
fruit:[...]
}
*/</span>
</code></pre>
<p>对比传统方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//以前需要reduce实现分组...</span>
</code></pre>
<hr/>
<p>##总结</p>
<p>ES2023的新特性覆盖了从数据结构到错误处理等多个方面：</p>
<p>✔️ findLast()让逆向查找更简单(20行→1行)<br/>
✔️ Records/Tuples可能改变我们处理不可变数据的方式(100行→50行)<br/>
✔️ Error Cause让错误处理更专业</p>
<p>建议你现在就尝试第5个特性——虽然还不是正式标准，但它代表了JavaScript未来的发展方向！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程]]></title>    <link>https://juejin.cn/post/7583260493851525161</link>    <guid>https://juejin.cn/post/7583260493851525161</guid>    <pubDate>2025-12-15T00:19:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851525161" data-draft-id="7583168260797169704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程"/> <meta itemprop="keywords" content="人工智能,LLM,Python"/> <meta itemprop="datePublished" content="2025-12-15T00:19:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:19:25.000Z" title="Mon Dec 15 2025 00:19:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有想过, 大模型世界里只有数字, 它是怎么知道 “狼” 和 “狗” 差异明显, “狗” 和 “犬” 意思相近的呢?</p>
<p>今天我们不谈复杂的句子理解, 只聚焦语言最基础的单元: 单个词.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p>
<p>计算机不认识文字, 只认识数字. 所以, 第一步是把文字变成数字. 最直接的方法, 就是给每个词 (Token) 分配一个唯一编号, 这就是 <strong>Token ID</strong>.</p>
<blockquote>
<p>严格来说, Token 是介于二者之间的 "子词", 但这不影响核心逻辑.</p>
<p>相关细节, 可以阅读我的另一篇文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlTSQfqPzxhPw9k-TDkf3zg" target="_blank" title="https://mp.weixin.qq.com/s/lTSQfqPzxhPw9k-TDkf3zg" ref="nofollow noopener noreferrer">Token 到底怎么"变"的? 大模型分词的核心逻辑</a></p>
</blockquote>
<p>以中文轻量级模型 <code>BAAI/bge-small-zh</code> 为例:</p>





























<table><thead><tr><th>Token</th><th>Token ID</th></tr></thead><tbody><tr><td>犬</td><td>4305</td></tr><tr><td>...</td><td>...</td></tr><tr><td>狗</td><td>4318</td></tr><tr><td>...</td><td>...</td></tr><tr><td>狼</td><td>4331</td></tr></tbody></table>
<p>单看编号, “狼” 和 “狗” 相差 13, “狗” 和 “犬” 也相差 13 —— 从数字上看二者关系完全对等. 但我们都知道, “狼” 很凶猛, “狗” 很忠诚, “犬” 则是 “狗” 的同义词.</p>
<p>这暴露了 Token ID 的本质缺陷: <strong>Token ID 只是一个代号, 它本身不包含任何语义信息</strong>.</p>
<p>就像图书馆的图片编号, 你能靠它知道一本书的位置, 却不能靠它知道书的内容.</p>
<p>大模型想理解语言, 必须找到一种让数字承载意义的方法, 而这个方法就是 —— <strong>词向量</strong>.</p>
<h2 data-id="heading-0">一、什么是词向量?</h2>
<p>简单来说, <strong>词向量是一串多维度的数字序列 (向量), 每个维度对应语义的一个抽象特征, 合起来就是词语在语义空间中的 “坐标”</strong>.</p>
<blockquote>
<p>关于向量, 可以阅读我的另一篇文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FThGXnwta1kFgbpqlKozO3A" target="_blank" title="https://mp.weixin.qq.com/s/ThGXnwta1kFgbpqlKozO3A" ref="nofollow noopener noreferrer">不再费脑，写给爱好者的 AI 向量 (Vector) 入门课</a></p>
</blockquote>
<p>它不再是单个数字, 而是一长串数字. 比如, 在 <code>BAAI/bge-small-zh</code> 中, “狗” 被表示为 512 维的向量, 前几个维度的数值如下:</p>
<pre><code class="hljs language-python" lang="python">[
  <span class="hljs-number">0.039581298828125</span>,
  -<span class="hljs-number">0.004741668701171875</span>,
  <span class="hljs-number">0.0285797119140625</span>,
  -<span class="hljs-number">0.03558349609375</span>,
  -<span class="hljs-number">0.03662109375</span>,
  <span class="hljs-comment"># ... 省略剩余 507 个维度</span>
]
</code></pre>
<p>这个高维语义空间有两个神奇的特性:</p>
<ul>
<li><strong>语义相近, 坐标相近</strong>: 狼” 和 “狗” 的距离较远, “狗” 和 “犬” 的距离极近;</li>
<li><strong>向量运算模拟语义关系</strong>: 最经典的例子就是: <code>vector('国王') - vector('男人') + vector('女人') ≈ vector('女王')</code>, 完全符合人类的语义认知.</li>
</ul>
<p>这是怎么实现的呢? 这些 “坐标” 不是人类手动设计的, 而是计算机从海量文本中 “自学” 而来的 —— 核心方法就是玩一场超大规模的 “完形填空游戏”.</p>
<h2 data-id="heading-1">二、学习的秘密: 分布假说与神经网络</h2>
<p>计算机能学会词向量, 核心支撑有两个：一是语言学的 “分布假说”, 二是作为 “学习工具” 的神经网络.</p>
<h3 data-id="heading-2">2.1 分布假说: 词的含义由上下文决定</h3>
<p>这是词向量技术的思想源头, 语言学家早在几十年前就提出: 一个词的含义, 由它周围经常出现的词决定.</p>
<p>比如 “狼” 常出现在 “草原”、“群居”、“凶猛” 旁边, “狗” 常出现在 “宠物”、“忠诚”、“汪汪” 旁边, 这些上下文差异, 最终会体现在词向量的坐标上.</p>
<h3 data-id="heading-3">2.2 神经网络: 学习语义的 “数字大脑”</h3>
<p>要让计算机理解分布假说, 需要一个能处理复杂规律的 “大脑”—— 神经网络. 它的基本单元是<strong>神经元</strong>, 可以理解为一个微小的信息处理站</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7350cc79ac74406b9d13dc21afbf1258~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=qV%2BjL16BNGNcHcT5nUtm0OaLIsI%3D" alt="" loading="lazy"/></p>
<ul>
<li>x1, x2, x3 是 "输入", 接收来自其他神经元的信号;</li>
<li>w1, w2, w3 是每条输入的 "权重 (重要性系数)", 比如 w3 大, 说明这个神经元更关注 x3 的信号;</li>
<li>中间的圆圈是神经元本身</li>
</ul>
<p>这个神经元只做两件事:</p>
<ul>
<li><strong>加权求和</strong>: 把每个输入乘以对应的权重, 然后加起来. 即 x1w1 + x2w2 + x3w3.;</li>
<li><strong>激活</strong>: 对加权求和做非线性转换.</li>
</ul>
<p>这里的<strong>非线性</strong>是关键 —— 如果没有激活函数, 无论多少层神经网络, 都等价于简单的线性计算（输出 = a * 输入 + b）, 永远学不会语言的复杂规律.</p>
<blockquote>
<p><strong>【语言是非线性的】</strong></p>
<p>比如 “单身狗” 这个词, 如果按照线性的理解, 它应该是 “单身” + “狗”, 也就是没有伴侣的狗. 但它的真实意思是指“单身的人”, 这种语义的 “化学反应”, 只有非线性系统才能捕捉.</p>
<p>常见的两种激活函数, 一个是 Sigmoid, 一个是 ReLU.</p>
</blockquote>
<p>当大量神经元通过权重连接成网络, 就像一张巨大的 “信息交通网”:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44236032270d407ebba2764297f0202b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=rYnzPZR9GDXqPJOhUtaoDwS0x7M%3D" alt="" loading="lazy"/></p>
<ul>
<li>神经元是 “路口”, 负责信息的中转和计算;</li>
<li>权重是 “道路”, 权重高是 “高速公路”, 信息传递快; 权重低是 “乡间小道”, 信息传递慢.</li>
</ul>
<p>训练模型的过程, 本质就是调整这张 “交通网” 的道路宽窄 (权重), 让信息流动符合语言规律 —— 而权重就是模型的 “知识”, 所有学到的语义规则, 最终都以数字形式存储在权重矩阵里.</p>
<h2 data-id="heading-4">三、训练之旅：从混沌到有序的 “猜词游戏”</h2>
<p>有了 “大脑” 和 “学习原理”, 接下来就是核心的训练过程 —— 让模型玩亿万次 “完形填空”, 从完全无知的 “文盲” 变成懂语义的 “语言大师”. 整个过程分为四个阶段：</p>
<h3 data-id="heading-5">3.1 随机初始化</h3>
<p>训练开始前, 神经网络的所有权重、词向量表中每个词的坐标, 都是随机赋值的. 此时在多维的语义空间里, 词语的位置完全混乱: “好” 可能离 “石头” 很近, 离 “棒” 很远, 没有任何语义规律.</p>
<p>之所以选择随机初始化, 是为了打破 “对称性”—— 如果所有参数初始值相同, 后续调整时所有参数会同步变化, 模型永远学不会不同词语的特征差异.</p>
<h3 data-id="heading-6">3.2 疯狂做题（前向传播)</h3>
<p>模型开始处理海量文本, 但不会一次性读完, 而是用 “滑动窗口” 技巧: 想象模型拿着一个固定长度的框，沿着句子逐格滑动, 每次只聚焦局部上下文, 生成一道 “完形填空” 题</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92ca8d091e94a9f963345ae683abc1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=HZq5wqbVAdupyN0E%2FYjSCc1rC84%3D" alt="" loading="lazy"/></p>
<p>比如句子 “今天天气很好, 我们去公园”, 滑动窗口会生成 “今天天气真___”、“天气真___, 我们” 等题目. 模型将上下文词语的随机向量输入神经网络 (前向传播), 最终输出对空缺词的 “猜测”—— 此时的猜测完全是随机的, 正确率极低.</p>
<h3 data-id="heading-7">3.3 评分裁判 (Softmax)</h3>
<p>模型不会只给出一个答案，而是给词表中所有词打 “原始分数”. 这时需要 Softmax 函数充当 “裁判”，把分数转换成概率</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></msubsup><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(y_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.6629em;vertical-align:-0.7519em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.911em;"><span style="top:-2.5703em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8852em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-2.8971em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4603em;"><span/></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"/><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.779em;"><span style="top:-2.9714em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5092em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight">i</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3147em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>它的核心作用有两个:</p>
<ol>
<li><strong>放大差距</strong>: 通过指数函数 e<sup>x</sup>, 让分数高的词, 转换的概率也高, 放大了高分词的优势 (赢家通吃);</li>
<li><strong>归一化</strong>: 所有词的概率加起来等于 1</li>
</ol>
<h3 data-id="heading-8">3.4 纠错反馈 (反向传播与梯度下降)</h3>
<p>这是训练最关键的一步: 我们告诉模型 “正确答案是‘好’”, 模型的预测与正确答案的差距就是 “损失值”.</p>
<p>接下来, 反向传播算法会从输出层往输入层回溯, 计算每个权重对这次错误的 “责任” (梯度); 然后用梯度下降算法微调权重:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>新权重</mtext><mo>=</mo><mtext>旧权重</mtext><mo>−</mo><mtext>学习率</mtext><mo>∗</mo><mtext>梯度</mtext></mrow><annotation encoding="application/x-tex">新权重 = 旧权重 - 学习率 * 梯度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">新权重</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">旧权重</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">学习率</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">梯度</span></span></span></span></span></p>
<p>于是, 算法会严厉地告诉模型: "猜错了！所有指向错误答案 '石头' 的连接都弱一点, 所有指向正确答案 '好' 的连接都强一点. "</p>
<h2 data-id="heading-9">四、涌现的奇迹: 语义规律自发生成</h2>
<p>经过亿万次 “刷题-纠错”, 奇迹发生了: 原本混乱的语义空间, 被塑造成符合人类认知的样子:</p>
<p>计算机脑中那张原本随机的 "词向量地图", 被慢慢塑造成了我们所期望的样子:</p>
<ul>
<li>近义词（好 / 棒 / 优秀）因为常出现在相似上下文, 坐标逐渐靠近;</li>
<li>语义关系（国王 - 男人 + 女人≈女王）自然而然形成</li>
</ul>
<p>这就是人工智能领域的 “涌现”—— 没有人为设计任何语义规则, 仅仅通过简单的局部反馈 (猜词、纠错), 宏观上就自发形成了高度有序的语义结构</p>
<h2 data-id="heading-10">五、黑盒与炼丹: 无法解读的维度</h2>
<p>尽管词向量能精准表达语义, 但我们盯着 “狗” 的向量 <code>[0.039581298828125, -0.004741668701171875, ...]</code> 时，却无法给每个维度下定义.</p>
<p>第一维是 “宠物” 吗? 第二维是 “忠诚” 吗? 可以说 “是”, 也可以说都不是 —— 每个维度都是多个抽象特征的混合体.</p>
<p>这是因为神经网络为了最小化预测错误, 会自动找到最高效的坐标系, 这个坐标系适合模型计算, 却完全不符合人类的理解习惯. 这也是深度学习被称为 “黑盒”、调参被戏称为 “炼丹” 的核心原因.</p>
<h2 data-id="heading-11">六、总结: 从 “教规则” 到 “找规律” 的范式革命</h2>
<p>词向量的诞生, 代表了人工智能理解语言的核心思想转变:</p>
<ul>
<li>过去, 我们试图把人类知识<strong>翻译</strong>成规则教给计算机.</li>
<li>现在, 我们设计简单的<strong>游戏规则</strong>（猜词）和<strong>反馈机制</strong>（反向传播）, 让计算机从海量数据中自己发现语义规律.</li>
</ul>
<p>那些最初毫无意义的随机数字, 在亿万次训练的 “锻造” 下, 最终变成了承载人类语言意义的精密 “坐标”, 而这就是词向量.</p>
<p>回到文章开头的问题, 大模型如何分辨 “狼” 与 “狗”. AI 没有被灌输任何关于 “狼” “狗” “犬” 的具体规则, 是靠数据驱动的方式, 在高维空间里为这些词语找到了符合人类认知的坐标.</p>
<p>即便这些坐标的每一个维度都无法被人类精准定义. 但这恰恰是其强大之处.</p>
<p>AI 没有被人类的认知边界束缚，而是找到了最适合自身理解语言的方式.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p>
<blockquote>
<p><strong>补充说明</strong>: 现代 LLM（如 GPT）的训练过程比这更复杂, 词向量层是与整个模型一起端到端训练的. 但将词向量理解为猜词任务的"副产品", 但将词向量理解为猜词任务的"副产品", 仍然是理解其本质的有效方式.</p>
</blockquote>
<h2 data-id="heading-12">附录: 查看 “狼” “狗” “犬” 的词向量</h2>
<p>如果你想直观看到一个词在模型中的 “数字形态”, 可以运行以下 Python 代码, 打印 <code>BAAI/bge-small-zh</code> 模型中 “狼” “狗” “犬” 的 Token ID 和词向量:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModel

model_name = <span class="hljs-string">"BAAI/bge-small-zh"</span>
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModel.from_pretrained(model_name)
model.<span class="hljs-built_in">eval</span>()

target_text = <span class="hljs-string">"狼"</span>

inputs = tokenizer(
    target_text,
    return_tensors=<span class="hljs-string">"pt"</span>,
    add_special_tokens=<span class="hljs-literal">False</span>
)

token_ids = inputs[<span class="hljs-string">"input_ids"</span>][<span class="hljs-number">0</span>]
tokens = tokenizer.convert_ids_to_tokens(token_ids)

embedding_layer = model.get_input_embeddings()
token_embeddings = embedding_layer(token_ids)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询文本: <span class="hljs-subst">{target_text}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)

<span class="hljs-keyword">for</span> idx, (token, token_id) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(tokens, token_ids)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n【Token <span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>】"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"字符/Token: <span class="hljs-subst">{token}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Token ID: <span class="hljs-subst">{token_id.item()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"词向量（前10维）: <span class="hljs-subst">{token_embeddings[idx][:<span class="hljs-number">10</span>].tolist()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"词向量维度: <span class="hljs-subst">{token_embeddings[idx].shape[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制]]></title>    <link>https://juejin.cn/post/7583260493851557929</link>    <guid>https://juejin.cn/post/7583260493851557929</guid>    <pubDate>2025-12-15T00:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851557929" data-draft-id="7583260493851263017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,TypeScript"/> <meta itemprop="datePublished" content="2025-12-15T00:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:29:27.000Z" title="Mon Dec 15 2025 00:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、JWorker</h2>
<p><strong>JWorker 是一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6fda4257dbe4aac9ecae9d1b97bb4b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=Qyt8awOG6G6qKBSbJqBTWZ06YV8%3D" alt="structure.png" loading="lazy"/></p>
<p>传统的 Worker 通讯基于事件监听和消息传递，缺乏原生的 <code>Promise/async-await</code> 支持，导致逻辑割裂。<strong>JWorker 通过双向 RPC 机制，让主 Worker 可以 await 子 Worker 的执行结果，子 Worker 也可以 await 主 Worker 的响应，将跨 Worker 通讯简化为像调用本地异步函数，消除回调嵌套，保持代码线性流畅。</strong></p>
<h2 data-id="heading-1">一、安装</h2>
<p>运行 <code>ohpm install jworker</code> 安装 JWorker 库</p>
<h2 data-id="heading-2">二、常规使用</h2>
<p>JWorker 是基于鸿蒙 Worker 封装的一套 RPC 通讯机制，所以在正式使用之前需要先添加和配置 Worker 的 ets 文件。可以按照<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fworker-introduction" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction" ref="nofollow noopener noreferrer">鸿蒙官方 Worker</a> 的使用文档进行添加配置，这里就不再赘述。</p>
<blockquote>
<p>“常规使用” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fsimple" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/simple" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<h3 data-id="heading-3">1、创建 JWorker</h3>
<p><strong>主 Worker 中</strong>使用 <code>createJWorker(workerPath: string)</code> 创建 <code>JWorker</code> 实例，然后调用 <code>JWorker.start()</code> 启动 <code>JWorker</code> 。 完整代码如下：</p>
<blockquote>
<p><code>JWorker.start()</code> 内部会启动 Worker 文件，并关联消息接收、退出接收等回调。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 将 Worker 的文件路径传给 createJWorker 方法，会返回 JWorker 实例</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-comment">// 启动 JWorker</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">start</span>()
</code></pre>
<p><strong>子 Worker 中</strong>使用 <code>initJWorker()</code> 获取 <code>SubWorker</code> 实例。完整代码如下：</p>
<blockquote>
<p><code>initJWorker()</code> 内部会让 <code>SubWorker</code> 关联子 Worker 的消息接收等回调。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> worker = <span class="hljs-title function_">initJWorker</span>()
</code></pre>
<h3 data-id="heading-4">2、双向 RPC 通讯</h3>
<p><strong>JWorker 的通讯是基于 Channel</strong> ，所以主子 Worker 的通讯需要先添加<strong>相同名称的 Channel</strong>。</p>
<p><strong>主 Worker</strong> 通过 <code>JWorker.addChannel(channelName: string, channel: Channel)</code> 方法进行添加通讯 Channel 。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建通讯渠道 MainSimpleChannel ，需要继承 Channel </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainSimpleChannel</span>()
<span class="hljs-comment">// 添加渠道名为 “SimpleWorkerChannel” 的通讯 Channel </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>)
</code></pre>
<p><strong>子 Worker</strong> 通过 <code>JWorkerChannel(channelName: string, channel: Channel)</code> 方法进行添加通讯 Channel 。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 添加渠道名为 “SimpleWorkerChannel” 的通讯 Channel</span>
<span class="hljs-comment">// 同样 SubSimpleChannel 也需要继承 Channel</span>
<span class="hljs-title class_">JWorkerChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubSimpleChannel</span>(worker))
</code></pre>
<p><strong>主 Worker 和子 Worker 通过相同的渠道名称建立通讯通道</strong>，<code>MainSimpleChannel</code> 和 <code>SubSimpleChannel</code> 通讯规则如下：</p>
<ul>
<li>通过 <code>handleMessage(methodName: string, data: any): Promise&lt;any&gt;</code> 接收对方的调用消息，返回值会返回到调用点；</li>
<li>通过 <code>send(methodName: string, data?: any, transfer?: ArrayBuffer[]) =&gt; Promise&lt;any&gt;</code> 可以主动调用对方方法并携带参数，对方处理完的返回值会以 <code>Promise&lt;any&gt;</code> 类型返回到调用点。</li>
</ul>
<p><strong>主 Worker 调用子 Worker 的逻辑</strong>，通过注册的 <code>simpleWorkerChannel</code> 调用 <code>send</code> 方法发送即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 主 Worker 中进行发送 ==============</span>
<span class="hljs-keyword">const</span> user = {
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"jiangpengyong"</span>,
  <span class="hljs-string">"year"</span>: <span class="hljs-number">1994</span>,
  <span class="hljs-string">"height"</span>: <span class="hljs-number">170.0</span>,
  <span class="hljs-string">"address"</span>: {
    <span class="hljs-string">"country"</span>: <span class="hljs-string">"China"</span>,
    <span class="hljs-string">"province"</span>: <span class="hljs-string">"GuangDong"</span>,
    <span class="hljs-string">"city"</span>: <span class="hljs-string">"Guangzhou"</span>,
  },
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
<span class="hljs-comment">// 第一个参数为调用方法名称，第二个参数为调用方法的参数</span>
<span class="hljs-comment">// response 为子 Worker 处理的结果</span>
<span class="hljs-keyword">const</span> response = (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"sayHello"</span>, user)) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Any</span>
<span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【发送有处理的消息】子 Worker 回复 response=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(response)}</span>`</span>)

<span class="hljs-comment">// ============== 子 Worker 中进行接收处理 ==============</span>
<span class="hljs-comment">// 通过 SubSimpleChannel 接收调用方法名称和参数，处理后返回结果</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-comment">// 处理主 Worker 调用的 “sayHello” 方法，将 data 转为 User 类型并获取对应数据，返回一个 string 结果</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">"sayHello"</span>: {
        <span class="hljs-keyword">const</span> user = data <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${user.name}</span>. I'm replying to you from the sub-worker.`</span>
      }
      <span class="hljs-comment">// 省略其他方法</span>
    }
  }
}

<span class="hljs-comment">// ============== 最终会在 Log 中看到以下输出 ==============</span>
<span class="hljs-comment">// 【发送有处理的消息】子 Worker 回复 response="Hello, jiangpengyong. I'm replying to you from the sub-worker."</span>
</code></pre>
<p><strong>子 Worker 调用主 Worker 的逻辑</strong>，也是同样的流程，通过注册的 <code>SubSimpleChannel</code> 调用 <code>send</code> 方法发送即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 子 Worker 调用主 Worker 的逻辑 ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"getUserDes"</span>: {
        <span class="hljs-comment">// 调用主 Worker 的 “getUserInfo” 方法，此处没有携带参数，会返回 User 类型</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"getUserInfo"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`name: <span class="hljs-subst">${user.name}</span>, height: <span class="hljs-subst">${user.height}</span>`</span>
      }
      <span class="hljs-comment">// 省略其他逻辑</span>
    }
  }
}

<span class="hljs-comment">// ============== 主 Worker 处理逻辑 ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-comment">// 接收到子 Worker 的请求处理，处理完之后返回数据</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">"getUserInfo"</span>: {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"江澎涌"</span>,
          <span class="hljs-string">"year"</span>: <span class="hljs-number">1994</span>,
          <span class="hljs-string">"height"</span>: <span class="hljs-number">170.0</span>,
          <span class="hljs-string">"address"</span>: {
            <span class="hljs-string">"country"</span>: <span class="hljs-string">"中国"</span>,
            <span class="hljs-string">"province"</span>: <span class="hljs-string">"广东"</span>,
            <span class="hljs-string">"city"</span>: <span class="hljs-string">"普宁"</span>,
          },
        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
      }
    }
  }
}
</code></pre>
<blockquote>
<p>Channel 中包含了 <code>send(methodName: string, data?: any, transfer?: ArrayBuffer[]) =&gt; Promise&lt;any&gt;</code> 方法，可以在 “ Channel 内部主动调用” 或是 “外部代码通过 Channel 实例主动调用”，<code>await</code> 数据返回即可。</p>
</blockquote>
<h3 data-id="heading-5">3、传递 ArrayBuffer 数据</h3>
<p>Worker 在传递 ArrayBuffer 时，为了不拷贝 ArrayBuffer 数据，可以考虑将 ArrayBuffer 使用权移交给对方，JWorker 也同样提供这一能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff8632ddf2f4a149f4f8424f42dcaf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=%2Fyu2vdb5l5doeJvIPBjnqr4DdW0%3D" alt="transfer_data.png" loading="lazy"/></p>
<p>上图则是一个完整的移交 ArrayBuffer 使用权的全流程</p>
<p><strong>调用点传递 ArrayBuffer 类型数据</strong></p>
<p>无论是 “主 Worker 主动调用子 Worker 方法”，还是 “子 Worker 主动调用主 Worker 方法”，都是使用 Channel 的 <code>send</code> 方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">send</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span>, transfer?: <span class="hljs-title class_">ArrayBuffer</span>[]) =&gt; <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;
</code></pre>
<p><code>send</code> 的第三个参数 <code>transfer</code> 持有第二个参数 <code>data</code> 中需要移交使用权的 ArrayBuffer 对象，JWorker 会负责移交使用权。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 发送方代码（此处为主 Worker ） ==============</span>
<span class="hljs-keyword">const</span> uint8Array = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">"image1.jpeg"</span>)
<span class="hljs-keyword">const</span> arrayBuffer = uint8Array.<span class="hljs-property">buffer</span>
<span class="hljs-comment">// 此处将 arrayBuffer 使用权移交给子 Worker ，所以将 arrayBuffer 放置到了第三个参数</span>
<span class="hljs-comment">// 值得注意，移交后的 arrayBuffer ，主 Worker 不可再使用，否则会报错</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"cropImage"</span>, arrayBuffer, [arrayBuffer]) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>

<span class="hljs-comment">// ============== 接收方代码（此处为子 Worker ） ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"cropImage"</span>: {
        <span class="hljs-comment">// 接收 ArrayBuffer 的代码没有特别的要求，和接收普通类型的逻辑一样，只需要转为对应的类型进行处理即可</span>
        <span class="hljs-keyword">const</span> arrayBuffer = data <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>
        <span class="hljs-keyword">const</span> cropPixelMap = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cropImage</span>(arrayBuffer)
        <span class="hljs-keyword">const</span> cropArrayBuffer = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PixelMapConverter</span>.<span class="hljs-title function_">pixelMapToArrayBuffer</span>(cropPixelMap)
        <span class="hljs-comment">// 省略其他逻辑</span>
      }
    }
  }
}
</code></pre>
<p><strong>返回值传递 ArrayBuffer 类型数据</strong></p>
<p>在处理完逻辑后，返回数据给调用方，此时存在返回数据携带 ArrayBuffer 类型数据的场景。为此 JWorker 提供了 <code>TransferData</code> 类型，支持该场景的数据传递，具体操作如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 继续上面的代码 ==============</span>
<span class="hljs-comment">// ============== 接收方代码（此处为子 Worker ） ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"cropImage"</span>: {
        <span class="hljs-comment">// 省略重复代码</span>
        <span class="hljs-comment">// 返回值如果需要移交 ArrayBuffer 使用权，则使用 TransferData 类进行包裹</span>
        <span class="hljs-comment">// 第一个参数为返回数据，第二个参数为需要移交使用权的 ArrayBuffer 列表</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransferData</span>(cropArrayBuffer, [cropArrayBuffer])
      }
    }
  }
}

<span class="hljs-comment">// ============== 发送方代码（此处为主 Worker ） ==============</span>
<span class="hljs-comment">// 调用点接收到的数据类型是已经去掉 TransferData 包裹的真实数据</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"cropImage"</span>, arrayBuffer, [arrayBuffer]) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>
<span class="hljs-keyword">if</span> (response) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cropPixelMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PixelMapConverter</span>.<span class="hljs-title function_">arrayBufferToPixelMap</span>(response)
}
</code></pre>
<h3 data-id="heading-6">4、关闭 JWorker</h3>
<p>在 JWorker 中提供了两种关闭 Worker 的方式，分别为 <strong>主 Worker 进行关闭</strong> 和 <strong>子 Worker 进行关闭</strong> 。<strong>推荐使用子 Worker 进行关闭</strong>，因为项目可以更好控制子 Worker 的生命周期和释放相应资源。</p>
<p><strong>主 Worker 进行关闭</strong></p>
<p>通过调用 <code>JWorker</code> 实例的 <code>release()</code> 方法进行释放。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建 JWorker 对象</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-comment">// 进行开启 JWorker 、添加 Channel 等操作</span>

<span class="hljs-comment">// 关闭 JWorker</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>?.<span class="hljs-title function_">release</span>()
</code></pre>
<p><strong>子 Worker 进行关闭</strong></p>
<p>通过调用 <code>SubWorker</code> 对象的 <code>release()</code> 方法进行释放。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 在子 Worker 中构建 subWorker</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-title function_">initJWorker</span>()
<span class="hljs-comment">// 添加需要的 Channel 操作</span>

<span class="hljs-comment">// 在需要释放的时候调用</span>
<span class="hljs-comment">// 1、可以将 worker 传递给 Channel ，Channel 内部可以根据需要进行调用释放</span>
<span class="hljs-comment">// 2、可以全局持有，在需要的时候进行释放</span>
worker.<span class="hljs-title function_">release</span>()
</code></pre>
<h3 data-id="heading-7">5、值得注意</h3>
<p>如果 <code>JWorker</code> 对象未开启（即未调用 <code>JWorker.start()</code> 方法或已关闭），此时使用添加在该 JWorker 的 Channel 进行发送消息会立马得到一个 <code>undefined</code> 数据。</p>
<p>如果通过 <code>JWorker</code> 的 Channel 发送了消息，在未得到回复前对该 <code>JWorker</code> 进行关闭，则会让调用点立马得到一个 <code>undefined</code> 数据。</p>
<p><strong>所以为了程序的健壮，调用点的类型转换最好增加对 <code>undefined</code> 的判断。</strong></p>
<h2 data-id="heading-8">三、多个 Worker</h2>
<h3 data-id="heading-9">1、项目主 Worker 开多个子 Worker</h3>
<p><code>JWorker</code> 项目支持开启多个 Worker ，使用 <code>createJWorker(workerPath: string)</code> 方法传入不同的路径，管理好返回 <code>JWorker</code> 对象即可。</p>
<blockquote>
<p>“项目主 Worker 开多个子 Worker” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fmainmultiworker" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/mainmultiworker" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85be0b25cb7b4c16989ea08b3dfa2509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=F0Jnyg6FHA6jqIfXeHuoKfyNGXI%3D" alt="main_multi_worker.png" loading="lazy"/></p>
<p>假设项目需要构建上图的使用场景，可以通过以下代码创建 <code>JWorker</code> 实例。</p>
<ul>
<li>可以使用不同的 Worker ets 文件，也可以使用同一个 Worker ets 文件可以开启多个 <code>JWorker</code> 实例。</li>
<li>通过管理好 <code>JWorker</code> 实例，添加渠道后进行各自 Worker 通讯。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// worker0 和 worker1、worker2 使用不同的 Worker ets 文件进行开启不同的 JWorker 实例</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span>.<span class="hljs-title function_">start</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainSimpleChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>)

<span class="hljs-comment">// worker1 和 worker2 使用相同的 Worker ets 文件进行开启不同的 JWorker 实例 </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/mainmultiworker/MainMultiWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainMultiChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"multiChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1Channel</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span>.<span class="hljs-title function_">start</span>()

<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/mainmultiworker/MainMultiWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainMultiChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"multiChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2Channel</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span>.<span class="hljs-title function_">start</span>()
</code></pre>
<h3 data-id="heading-10">2、子 Worker 开多个子 Worker</h3>
<p><code>JWorker</code> 同样支持在子 Worker 中开启多个 <code>JWorker</code> ，可以进行如下图所示的创建和管理。</p>
<blockquote>
<p>“子 Worker 开多个子 Worker” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fsubmultiworker" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/submultiworker" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad99bd5488f42b38fe7133536e5fa0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=Y4omM%2BPnwoOrW9nj4ZB7yfIFuWI%3D" alt="sub_multi_worker.png" loading="lazy"/></p>
<p>可以在子 Worker 需要创建子 Worker 的地方调用 <code>createJWorker</code> 方法创建 <code>JWorker</code> ，然后进行启动和添加相应 Channel 进行通讯。<strong>使用方式和之前的完全相同。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">worker: SubWorker</span>) {
    <span class="hljs-comment">// 省略其他逻辑</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startChildrenWorker</span>()
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">startChildrenWorker</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建三个 JWorker 并开启，添加对应 Channel </span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span>.<span class="hljs-title function_">start</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span>.<span class="hljs-title function_">start</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span>.<span class="hljs-title function_">start</span>()
    }
  }
}
</code></pre>
<p><strong>值得注意</strong></p>
<p>这种情况下需要控制好 Worker 的关闭顺序，应该让项目的主 Worker 通知子 Worker 进行关闭他创建的子 Worker ，然后在关闭自身。具体操作如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 项目主 Worker 调用子 Worker 的 exit 方法</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">workerChannel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>)

<span class="hljs-comment">// 子 Worker 接收到主 Worker 的 “exit” 调用，则调用子 Worker 创建的子 Worker 的 “exit” 方法进行退出，并等待所有的子 Worker 处理完再退出自身</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">methodName: <span class="hljs-built_in">string</span>, data: Any</span>) {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"exit"</span>: {
        <span class="hljs-comment">// 等待所有子 Worker 退出完成</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>)])
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"【exit】"</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>?.<span class="hljs-title function_">release</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
      }
      <span class="hljs-attr">default</span>: {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
      }
    }
  }
}

<span class="hljs-comment">// 子 Worker 的子 Worker 接收到 “exit” 的调用，退出自身</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChildSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">methodName: <span class="hljs-built_in">string</span>, data: Any</span>) {
    <span class="hljs-keyword">if</span> (methodName == <span class="hljs-string">"exit"</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">release</span>()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }
}
</code></pre>
<h2 data-id="heading-11">四、作者博客</h2>
<p>掘金：<a href="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts" target="_blank" title="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts">juejin.im/user/5c3033…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-使用EventBus实现组件间数据通信]]></title>    <link>https://juejin.cn/post/7583226204036513833</link>    <guid>https://juejin.cn/post/7583226204036513833</guid>    <pubDate>2025-12-15T00:40:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036513833" data-draft-id="7581117416811544619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" flutter-使用EventBus实现组件间数据通信"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:40:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             flutter-使用EventBus实现组件间数据通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:40:53.000Z" title="Mon Dec 15 2025 00:40:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 效果预览</h2>
<p>在 Flutter 应用开发中，组件间的通信是一个常见且重要的需求。当涉及到父子组件之间复杂的交互时，使用事件总线（Event Bus）可以有效地实现解耦和灵活的消息传递。本文将通过一段具体的代码，详细介绍如何在 Flutter 中利用事件总线实现父子组件之间的通信。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebfa70468af644018b55aeea80cdbdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766364053&amp;x-signature=lY2mGdzxw4VH3CvdYz6bcOCybFU%3D" alt="效果预览" loading="lazy"/></p>
<h2 data-id="heading-1">2. 安装插件</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">event_bus:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<p>创建eventBus.dart文件，写入以下内容：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:event_bus/event_bus.dart'</span>;

EventBus eventBus = EventBus();

<span class="hljs-comment">/// <span class="markdown">通知测试</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusNotificationTest</span> </span>{
  <span class="hljs-built_in">int</span> index;
  BusNotificationTest(<span class="hljs-keyword">this</span>.index);
}
</code></pre>
<h2 data-id="heading-2">3. 结构分析</h2>
<p>这段代码展示了如何在 Flutter 中通过事件总线实现父子组件之间的通信，具体功能为：在父组件EventBusParentPage中，用户点击按钮后，会触发一个通知事件，子组件EventBusChildPage监听该事件，并根据事件携带的信息改变自身的背景颜色。</p>
<ol>
<li>父组件：EventBusParentPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知父类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusParentPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusParentPageState createState() =&gt; EventBusParentPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusParentPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色索引</span></span>
  <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-comment">/// <span class="markdown">通知变色</span></span>
  <span class="hljs-keyword">void</span> handleColorChange() {
    index++;
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">2</span>) {
      index = <span class="hljs-number">0</span>;
    }
    eventBus.fire(BusNotificationTest(index));
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        Expanded(
            child: Container(
                alignment: Alignment.center,
                decoration: <span class="hljs-keyword">const</span> BoxDecoration(color: Colors.white),
                child: TextButton(
                    onPressed: handleColorChange,
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'点击变色'</span>,
                        style: TextStyle(color: Colors.black, fontSize: <span class="hljs-number">20</span>))))),
        <span class="hljs-keyword">const</span> EventBusChildPage()
      ],
    );
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusParentPage是一个有状态组件，通过createState方法返回EventBusParentPageState实例，用于管理组件状态和构建 UI。</li>
</ul>
</li>
<li>状态变量：
<ul>
<li>index：一个整型变量，用于记录颜色索引，初始值为 0。这个索引将决定子组件最终显示的颜色。</li>
</ul>
</li>
<li>事件处理方法：
<ul>
<li>handleColorChange：当用户点击父组件中的按钮时，该方法被调用。它首先将index值增加 1，如果index超过 2，则重置为 0。然后，通过事件总线eventBus触发一个BusNotificationTest类型的事件，并将当前的index值作为参数传递给该事件。这里的eventBus应该是在全局或合适的作用域中定义的事件总线实例，BusNotificationTest则是一个自定义的事件类，用于携带数据（这里是颜色索引）。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，父组件构建了一个垂直方向的Column布局。</li>
<li>第一个子组件是一个Expanded包裹的Container，其中包含一个TextButton。按钮的文本为 “点击变色”，当按钮被点击时，会调用handleColorChange方法。Container的背景颜色设置为白色。</li>
<li>第二个子组件是EventBusChildPage，这是需要接收事件通知的子组件，通过const关键字创建，意味着它是一个不可变的组件实例。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>子组件：EventBusChildPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知子类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusChildPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusChildPageState createState() =&gt; EventBusChildPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusChildPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色列表</span></span>
  <span class="hljs-built_in">List</span>&lt;Color&gt; colorList = [Colors.red, Colors.yellow, Colors.blue];

  <span class="hljs-comment">/// <span class="markdown">刷新监听</span></span>
  <span class="hljs-keyword">late</span> StreamSubscription&lt;BusNotificationTest&gt; eventBusExample;

  <span class="hljs-comment">/// <span class="markdown">背景颜色</span></span>
  <span class="hljs-keyword">late</span> Color bgColor;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    bgColor = colorList[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 监听颜色索引变化</span>
    eventBusExample = eventBus.<span class="hljs-keyword">on</span>&lt;BusNotificationTest&gt;().listen((event) {
      setState(() {
        bgColor = colorList[event.index];
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    eventBusExample.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> SizedBox(
        width: MediaQuery.of(context).size.width,
        height: MediaQuery.of(context).size.height / <span class="hljs-number">2</span>,
        child: Container(color: bgColor, child: <span class="hljs-keyword">null</span>));
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusChildPage同样是一个有状态组件，其createState方法返回EventBusChildPageState实例。</li>
</ul>
</li>
<li>状态变量
<ul>
<li>colorList：一个包含三种颜色（红色、黄色、蓝色）的列表，用于存储可供选择的背景颜色。</li>
<li>eventBusExample：一个StreamSubscription类型的变量，用于订阅事件总线eventBus上的BusNotificationTest类型的事件。这里使用late关键字声明，意味着在initState方法中会对其进行初始化。</li>
<li>bgColor：用于存储子组件当前的背景颜色，初始值为colorList中的第一个颜色（红色），同样使用late关键字声明，在initState方法中初始化。</li>
</ul>
</li>
<li>生命周期方法：
<ul>
<li>initState：在组件插入到 Widget 树时调用。首先调用父类的initState方法，然后初始化bgColor为colorList中的第一个颜色。接着，通过eventBus.on().listen方法，订阅事件总线上的BusNotificationTest事件。当接收到该事件时，会执行回调函数，在回调函数中，通过setState方法更新bgColor为colorList中对应索引的颜色。这里的event.index就是父组件触发事件时传递过来的颜色索引。</li>
<li>dispose：当组件从 Widget 树中移除时调用。在这个方法中，调用eventBusExample.cancel()取消对事件总线的订阅，防止内存泄漏，然后调用父类的dispose方法。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，子组件构建了一个SizedBox，其宽度为屏幕宽度，高度为屏幕高度的一半。在SizedBox内部是一个Container，其背景颜色由bgColor决定。当bgColor因接收到事件通知而改变时，Container的背景颜色也会相应改变，从而实现了根据父组件通知动态更新子组件 UI 的效果。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">3. 总结</h2>
<p>通过上述代码，我们清晰地看到了如何在 Flutter 中利用事件总线实现父子组件之间的通信。父组件通过触发事件并携带相关数据，子组件通过订阅事件总线并根据接收到的事件数据更新自身状态和 UI。</p>
<p>这种方式有效地解耦了父子组件之间的直接依赖关系，提高了代码的可维护性和扩展性。在实际项目中，当存在多个组件之间复杂的交互时，事件总线是一种非常强大且灵活的解决方案。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南]]></title>    <link>https://juejin.cn/post/7583845695178801158</link>    <guid>https://juejin.cn/post/7583845695178801158</guid>    <pubDate>2025-12-15T00:56:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583845695178801158" data-draft-id="7581423932612493352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:56:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:56:48.000Z" title="Mon Dec 15 2025 00:56:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 基本 ViewModel 使用</h2>
<h4 data-id="heading-1">1.1 最简单的 ViewModel 获取</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SimpleScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel = viewModel()
    <span class="hljs-comment">// 使用 viewModel</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = mutableStateOf(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> state = _state.asStateFlow()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        _state.value++
    }
}
</code></pre>
<h4 data-id="heading-2">1.2 带参数的 ViewModel</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenWithParam</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> viewModel: UserViewModel = viewModel(
        factory = <span class="hljs-keyword">object</span> : ViewModelProvider.Factory {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
                <span class="hljs-keyword">return</span> UserViewModel(userId) <span class="hljs-keyword">as</span> T
            }
        }
    )
}
</code></pre>
<h2 data-id="heading-3">二、 ViewModel 作用域策略</h2>
<h4 data-id="heading-4">2.1 不同层级的作用域</h4>
<h5 data-id="heading-5">Activity 级作用域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ActivityScopedViewModel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> activity = LocalContext.current <span class="hljs-keyword">as</span> ComponentActivity
    <span class="hljs-keyword">val</span> viewModel: SharedViewModel = viewModel(
        viewModelStoreOwner = activity
    )
}
</code></pre>
<h5 data-id="heading-6">Navigation 图级作用域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NavGraphScopedViewModel</span><span class="hljs-params">(navController: <span class="hljs-type">NavHostController</span>)</span></span> {
    <span class="hljs-comment">// 使用 navigation 图作为作用域</span>
    <span class="hljs-keyword">val</span> viewModel: GraphViewModel = hiltViewModel() <span class="hljs-comment">// 使用 Hilt</span>
    <span class="hljs-comment">// 或者</span>
    <span class="hljs-keyword">val</span> viewModel: GraphViewModel = viewModel(
        viewModelStoreOwner = navController
            .currentBackStackEntryAsState().value
            ?.destination
            ?.parent
            ?.let { navController.getBackStackEntry(it.id) }
    )
}
</code></pre>
<h5 data-id="heading-7">Destination 级作用域（默认）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenWithViewModel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 默认作用域是当前的 Composable（通常是 NavDestination）</span>
    <span class="hljs-keyword">val</span> viewModel: ScreenViewModel = viewModel()
}
</code></pre>
<h4 data-id="heading-8">2.2 自定义作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建自定义的 ViewModelStoreOwner</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomScope</span> : <span class="hljs-type">ViewModelStoreOwner</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModelStore = ViewModelStore()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewModelStore</span><span class="hljs-params">()</span></span>: ViewModelStore = viewModelStore
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        viewModelStore.clear()
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberCustomScope</span><span class="hljs-params">()</span></span>: CustomScope {
    <span class="hljs-keyword">return</span> remember { CustomScope() }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomScopedScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> customScope = rememberCustomScope()
    <span class="hljs-keyword">val</span> viewModel: CustomViewModel = viewModel(
        viewModelStoreOwner = customScope
    )
}
</code></pre>
<h2 data-id="heading-9">三、 高级作用域管理</h2>
<h4 data-id="heading-10">3.1 使用 Navigation Compose 的作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Navigation 设置</span>
NavHost(navController, startDestination = <span class="hljs-string">"home"</span>) {
    navigation(startDestination = <span class="hljs-string">"list"</span>, route = <span class="hljs-string">"users"</span>) {
        composable(<span class="hljs-string">"list"</span>) {
            <span class="hljs-comment">// 这个 ViewModel 在 users 图内共享</span>
            <span class="hljs-keyword">val</span> sharedViewModel: UsersSharedViewModel = hiltViewModel()
            UserListScreen(sharedViewModel)
        }
        composable(<span class="hljs-string">"detail/{userId}"</span>) {
            <span class="hljs-comment">// 可以访问同一个 UsersSharedViewModel</span>
            <span class="hljs-keyword">val</span> sharedViewModel: UsersSharedViewModel = hiltViewModel()
            UserDetailScreen(sharedViewModel)
        }
    }
    
    composable(<span class="hljs-string">"settings"</span>) {
        <span class="hljs-comment">// 不同的作用域，不同的 ViewModel 实例</span>
        <span class="hljs-keyword">val</span> settingsViewModel: SettingsViewModel = hiltViewModel()
        SettingsScreen(settingsViewModel)
    }
}
</code></pre>
<h4 data-id="heading-11">3.2 嵌套 Navigation 的作用域管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NestedNavigationExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> navController = rememberNavController()
    
    NavHost(navController, startDestination = <span class="hljs-string">"main"</span>) {
        navigation(
            startDestination = <span class="hljs-string">"dashboard"</span>,
            route = <span class="hljs-string">"main"</span>
        ) {
            composable(<span class="hljs-string">"dashboard"</span>) {
                <span class="hljs-comment">// 作用域：main 图</span>
                <span class="hljs-keyword">val</span> mainViewModel: MainViewModel = hiltViewModel()
                DashboardScreen(mainViewModel)
            }
        }
        
        navigation(
            startDestination = <span class="hljs-string">"profile"</span>,
            route = <span class="hljs-string">"user"</span>
        ) {
            composable(<span class="hljs-string">"profile"</span>) {
                <span class="hljs-comment">// 作用域：user 图（与 main 图隔离）</span>
                <span class="hljs-keyword">val</span> userViewModel: UserViewModel = hiltViewModel()
                ProfileScreen(userViewModel)
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-12">四、 精确的生命周期控制</h2>
<h4 data-id="heading-13">4.1 手动管理 ViewModel 生命周期</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ManualLifecycleControl</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> lifecycleOwner = LocalLifecycleOwner.current
    
    <span class="hljs-comment">// 使用 remember 和 DisposableEffect 精确控制</span>
    <span class="hljs-keyword">val</span> viewModel = remember {
        ViewModelProvider(
            ViewModelStore(),
            ViewModelProvider.NewInstanceFactory()
        ).<span class="hljs-keyword">get</span>(ManualViewModel::<span class="hljs-keyword">class</span>.java)
    }
    
    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-comment">// 连接生命周期</span>
        lifecycleOwner.lifecycle.addObserver(viewModel)
        
        onDispose {
            <span class="hljs-comment">// 清理资源</span>
            lifecycleOwner.lifecycle.removeObserver(viewModel)
            viewModel.onCleared()
        }
    }
}
</code></pre>
<h4 data-id="heading-14">4.2 使用 ViewModel 清理策略</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagedViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope: CoroutineScope
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(UiState())
    <span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> job: Job? = <span class="hljs-literal">null</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span> {
        job?.cancel()
        job = scope.launch {
            <span class="hljs-comment">// 加载数据</span>
            _uiState.value = UiState(loading = <span class="hljs-literal">true</span>)
            delay(<span class="hljs-number">1000</span>)
            _uiState.value = UiState(<span class="hljs-keyword">data</span> = <span class="hljs-string">"Loaded"</span>)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCleared()
        job?.cancel()
        <span class="hljs-comment">// 清理其他资源</span>
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberManagedViewModel</span><span class="hljs-params">()</span></span>: ManagedViewModel {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">val</span> viewModelStoreOwner = checkNotNull(LocalViewModelStoreOwner.current) {
        <span class="hljs-string">"No ViewModelStoreOwner was provided via LocalViewModelStoreOwner"</span>
    }
    
    <span class="hljs-keyword">return</span> remember {
        ViewModelProvider(
            viewModelStoreOwner,
            <span class="hljs-keyword">object</span> : ViewModelProvider.Factory {
                <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
                    <span class="hljs-keyword">return</span> ManagedViewModel(scope) <span class="hljs-keyword">as</span> T
                }
            }
        ).<span class="hljs-keyword">get</span>(ManagedViewModel::<span class="hljs-keyword">class</span>.java)
    }
}
</code></pre>
<h2 data-id="heading-15">五、 状态保存与恢复</h2>
<h4 data-id="heading-16">5.1 使用 SavedStateHandle</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StatefulViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> COUNTER_KEY = <span class="hljs-string">"counter"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> TEXT_KEY = <span class="hljs-string">"text"</span>
    }
    
    <span class="hljs-keyword">var</span> counter <span class="hljs-keyword">by</span> savedStateHandle.saveable { mutableIntStateOf(<span class="hljs-number">0</span>) }
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> savedStateHandle.saveable { mutableStateOf(<span class="hljs-string">""</span>) }
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        counter++
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateText</span><span class="hljs-params">(newText: <span class="hljs-type">String</span>)</span></span> {
        text = newText
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StatefulScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: StatefulViewModel = viewModel()
    <span class="hljs-comment">// 状态会在配置更改时自动保存</span>
}
</code></pre>
<h4 data-id="heading-17">5.2 自定义状态保存</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexViewModel</span>(
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(ComplexState())
    <span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()
    
    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 从 SavedStateHandle 恢复</span>
        savedStateHandle.<span class="hljs-keyword">get</span>&lt;ComplexState&gt;(<span class="hljs-string">"complex_state"</span>)?.let {
            _uiState.value = it
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateState</span><span class="hljs-params">(newState: <span class="hljs-type">ComplexState</span>)</span></span> {
        _uiState.value = newState
        <span class="hljs-comment">// 可以在这里手动保存到 SavedStateHandle</span>
    }
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"FunctionName"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> SavedStateHandle.<span class="hljs-title">saveComplexState</span><span class="hljs-params">(state: <span class="hljs-type">ComplexState</span>)</span></span> {
        <span class="hljs-keyword">this</span>[<span class="hljs-string">"complex_state"</span>] = state
    }
}
</code></pre>
<h2 data-id="heading-18">六、 最佳实践和模式</h2>
<h4 data-id="heading-19">6.1 ViewModel 提供者模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> VM : ViewModel&gt;</span> <span class="hljs-title">scopedViewModel</span><span class="hljs-params">(
    scope: <span class="hljs-type">ViewModelScope</span> = ViewModelScope.Screen,
    key: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    factory: <span class="hljs-type">ViewModelProvider</span>.<span class="hljs-type">Factory</span>? = <span class="hljs-literal">null</span>
)</span></span>: VM {
    <span class="hljs-keyword">val</span> owner = <span class="hljs-keyword">when</span> (scope) {
        ViewModelScope.Activity -&gt; {
            LocalContext.current <span class="hljs-keyword">as</span> ComponentActivity
        }
        ViewModelScope.NavGraph -&gt; {
            <span class="hljs-keyword">val</span> navController = LocalNavController.current
            navController.currentBackStackEntryAsState().value
                ?.destination
                ?.parent
                ?.let { navController.getBackStackEntry(it.id) }
                ?: LocalViewModelStoreOwner.current
        }
        ViewModelScope.Screen -&gt; LocalViewModelStoreOwner.current
        ViewModelScope.Custom -&gt; {
            <span class="hljs-comment">// 使用自定义作用域</span>
            LocalCustomScope.current
        }
    }
    
    <span class="hljs-keyword">return</span> viewModel(
        viewModelStoreOwner = checkNotNull(owner),
        key = key,
        factory = factory
    )
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelScope</span> {
    Activity, NavGraph, Screen, Custom
}
</code></pre>
<h4 data-id="heading-20">6.2 依赖注入集成</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Hilt 进行依赖注入</span>
<span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectedViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository,
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    <span class="hljs-comment">// ViewModel 逻辑</span>
}

<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            MyApp()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// Hilt 自动处理作用域和依赖</span>
    <span class="hljs-keyword">val</span> viewModel: InjectedViewModel = hiltViewModel()
}
</code></pre>
<h2 data-id="heading-21">七、 测试策略</h2>
<h4 data-id="heading-22">7.1 测试不同作用域的 ViewModel</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelScopeTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testScreenScopedViewModel</span><span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-comment">// 测试屏幕作用域的 ViewModel</span>
        <span class="hljs-keyword">val</span> owner = ViewModelStoreOwner { ViewModelStore() }
        <span class="hljs-keyword">val</span> viewModel = TestViewModel(owner)
        
        <span class="hljs-comment">// 验证行为</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testActivityScopedViewModel</span><span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-comment">// 测试 Activity 作用域</span>
        <span class="hljs-keyword">val</span> activity = Robolectric.buildActivity(ComponentActivity::<span class="hljs-keyword">class</span>.java).<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">val</span> viewModel = ViewModelProvider(activity).<span class="hljs-keyword">get</span>(TestViewModel::<span class="hljs-keyword">class</span>.java)
        
        <span class="hljs-comment">// 验证跨屏幕的状态保持</span>
    }
}
</code></pre>
<h4 data-id="heading-23">7.2 Mocking 作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TestScreen</span><span class="hljs-params">(
    testViewModel: <span class="hljs-type">TestViewModel</span> = mockViewModel()</span></span>
) {
    <span class="hljs-comment">// 在测试中注入 mock ViewModel</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mockViewModel</span><span class="hljs-params">()</span></span>: TestViewModel {
    <span class="hljs-keyword">return</span> mockk&lt;TestViewModel&gt; {
        every { uiState } returns MutableStateFlow(TestUiState())
    }
}
</code></pre>
<h2 data-id="heading-24">总结</h2>
<ol>
<li>
<p><strong>默认作用域</strong>：在 Compose 中，<code>viewModel()</code> 默认使用当前 <code>LocalViewModelStoreOwner</code>，通常是 NavDestination。</p>
</li>
<li>
<p><strong>作用域选择</strong>：</p>
<ul>
<li>屏幕级：默认，适合单个屏幕</li>
<li>导航图级：适合共享相关屏幕间的状态</li>
<li>Activity 级：适合全局共享状态</li>
</ul>
</li>
<li>
<p><strong>生命周期控制</strong>：</p>
<ul>
<li>使用 <code>DisposableEffect</code> 进行精确控制</li>
<li>利用 <code>SavedStateHandle</code> 进行状态持久化</li>
<li>在 <code>onCleared()</code> 中清理资源</li>
</ul>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>根据状态共享需求选择合适的作用域</li>
<li>使用依赖注入（如 Hilt）简化管理</li>
<li>为不同场景设计测试策略</li>
</ul>
</li>
</ol>
<p>通过合理使用 ViewModel 作用域，可以有效地管理状态的生命周期，避免内存泄漏，并确保状态在正确的上下文中共享和隔离。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）]]></title>    <link>https://juejin.cn/post/7583260493851590697</link>    <guid>https://juejin.cn/post/7583260493851590697</guid>    <pubDate>2025-12-15T00:58:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851590697" data-draft-id="7583226204036562985" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-15T00:58:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:58:27.000Z" title="Mon Dec 15 2025 00:58:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。</p>
<p>之前分享过不少可以用 AI 来生成 PPT 的工具，比如 Kimi、豆包、千问、扣子空间、天工（Skywork）、Manus、Genspark 等等。</p>
<p>这些工具，都可以根据我们上传的文档，来自动生成 PPT。</p>
<p>前几天在刷视频的时候，刷到了一款可以生成「<strong>动态视频 PPT</strong>」的 AI 工具。</p>
<p>看着效果还挺酷炫的，趁着周末，来试一下效果。下面的视频 PPT 就是用这个 AI 工具一键生成的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c1c3945517343f290684af5f0b85b9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=GPx1UpNyyEiJV4aA9NwBQnUw1co%3D" alt="截屏2025-12-15 08.55.35.png" loading="lazy"/></p>
<p>（视频效果见<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUQiCst8rTHkUUjOcj8UjSQ" target="_blank" title="https://mp.weixin.qq.com/s/UQiCst8rTHkUUjOcj8UjSQ" ref="nofollow noopener noreferrer">原文</a>）</p>
<p>上面的视频，是一次性生成的效果，没有做任何编辑。</p>
<p>整体效果挺酷炫，而且它还给这个视频 PPT 添加了背景音乐。（ps：转场时有时文字会出现变形）</p>
<p>不过它也提供了「图片编辑」和「视频编辑」，可以继续修改。</p>
<p>这个工具大家肯定都用过，就是「纳米AI」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/234a573964684872a05d0bd4ac1d377c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=H7qQ8CMojzElyNthOw5eOsjOQko%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">动态视频 PPT 生成</h2>
<p>纳米AI最近增加了一个「视频PPT」的功能。（省流：非免费功能，生成需要消耗纳米）</p>
<p>操作很简单，点进去后，只需要<code>拖入文件</code>、<code>设置 PPT 风格</code>、<code>页数</code>、<code>类型选视频</code>，就能生成动态视频 PPT 了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/786a262510544d0aa900812bda1ce996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=meRMI0oADxvBL%2F%2FESCuJTtpOntw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">PPT 风格</h3>
<p>纳米AI的「视频PPT」，目前支持了几十种 PPT 风格，也支持自定义风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbf2d675fd044f93abd12a1f17c57423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=mbf%2FmrzbVbX%2FjVdaGqhrhmyoNPs%3D" alt="图片" loading="lazy"/></p>
<p>文章开头的视频，用的就是歸藏老师的「玻璃渐变卡片」风格。前段时间还在歸藏老师的公众号文章里看到了，没想到可以直接在纳米AI里使用，还不错。</p>
<p>除了玻璃渐变卡片风格外，纳米AI还提供了适合于「文旅宣传」、「企业宣传」的 PPT 风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0ddccd8e49449180f696ab9bac4778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=ZR3AFoFosBfa1u%2FjJGQ3Mvwy%2BXc%3D" alt="图片" loading="lazy"/></p>
<p>还有很多卡通 IP 形象的风格，比如哆啦A梦、火影忍者、柯南、奥特曼、灌篮高手、七龙珠等等。</p>
<p>这种风格用在教育领域，比如课堂演示、做课件等，都还不错。卡通风格，小朋友们更容易接受。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da566ca106a434298448647c8a211c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=Qx%2BXlwmmaZMteax0mAOroUBZBYc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/951cecd7ca8c40c5b59d8f1cd10537bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=TVL%2F4OSTDFeoaSU4athKsET53MI%3D" alt="图片" loading="lazy"/></p>
<p>这些案例在「推荐作品」里都可以查看，也可以「一键做同款」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f8ab3ecd321491481da24a1151ed1b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=Q9wCqEgEHL%2FL6VqeeaUuIXhpah0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">编辑</h3>
<p>如果对生成的视频 PPT 不满意，还可以继续「编辑图片」或「编辑视频」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f4c16c5cfef4ce8b28ed5ea0ee0d949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=4wd1D%2FisTEtHGFq2FhMqLadhiFU%3D" alt="图片" loading="lazy"/></p>
<p><strong>图片编辑器：</strong></p>
<p>这里提供了每张图片的提示词。</p>
<p>可以重新生成图片，也可以局部重绘、编辑元素等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31a05c690514aa4a24110a7b289577a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=xNwEgDgVzJNQf64%2BaLvDrPfmvdA%3D" alt="图片" loading="lazy"/></p>
<p><strong>视频编辑器：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c5c9c50f71a41ba9d7079cea0110ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=D%2B2K75QnzlJbeME%2Bd00Q7B3VAQw%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0859ff69fe4eb19726452b07e91354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=CZbKnE2KgFp93j1HUZzUHWtf%2BpE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/157376a43d0f451595ebaca3005fe08c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=QTTo1gTA5yv0Y8X9cnW4b7h21A8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">写在最后</h2>
<p>相对于以往的大多数 AI 工具只能生成静态 PPT，纳米AI生成的动态视频 PPT，给人一种耳目一新的感觉。</p>
<p>不管是用于项目汇报，还是企业宣传、课堂教学，都是可以的。</p>
<p>最后来总结一下吧。</p>
<p><strong>纳米<strong><strong>AI</strong></strong>的「视频PPT」功能，只需要拖入文件，设置风格、页数，它就能自动总结文档重点，然后调用各个 AI 大模型和工具，来生成图片、视频、背景音乐，最后拼接成一个动态的视频 PPT。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56a24c0e51634c8d9c3ca37d85ce2d7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=D1cXhGNfGA6HafjiMwGnztSS7CM%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88884782e13f46e58f22375840caa44e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=nfd5RnIwR9icQPdMlUoYwyTfbCo%3D" alt="图片" loading="lazy"/></p>
<p>整个过程不需要我们操作，全部由纳米AI自动完成，就很方便。</p>
<p>不过比较明显的问题是，转场时的文字会变形。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07c6a1a800ed482f956a6052bb854158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=emITWBoywDHyR3C9JKyNXLXUZSk%3D" alt="图片" loading="lazy"/></p>
<p>生成的时长也相对较长。15 页的 PPT，耗时 25 分钟。</p>
<p>不过因为毕竟期间需要生成多个视频，还需要视频拼接、给视频添加 BGM 等操作，所以相比于生成静态 PPT 的一些 AI 工具来说，纳米AI生成的视频 PPT 时间较长，这也是可以理解的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33673a6c328642e59c081cc447fb0cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=96agzzzNJDuOMzm161erOJDwXoE%3D" alt="图片" loading="lazy"/></p>
<p>另外，纳米AI的这个「视频PPT」功能不是免费的功能，生成需要消耗纳米。（文章开头的视频，15 页的 PPT，一共消耗了 340 纳米）</p>
<p>最后附上纳米AI的网址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.n.cn%2F" target="_blank" title="https://www.n.cn/" ref="nofollow noopener noreferrer">www.n.cn/</a></p>
<p>以上就是今天的分享，有需要的可以尝试一下。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题]]></title>    <link>https://juejin.cn/post/7583577045578907674</link>    <guid>https://juejin.cn/post/7583577045578907674</guid>    <pubDate>2025-12-14T23:10:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578907674" data-draft-id="7583567658253746202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2025-12-14T23:10:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:10:15.000Z" title="Sun Dec 14 2025 23:10:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上个月和大家聊到了 <a href="https://juejin.cn/post/7571306072423448618" target="_blank" title="https://juejin.cn/post/7571306072423448618">《为什么你的 Flutter WebView 在 iOS 26 上有点击问题？》</a> ，源头是因为 <strong>WKWebView（WebKit）内部的手势识别器与 Flutter 在 Engine 里用于“阻止/延迟”手势的 recognizer 之间的冲突</strong>，因为 Flutter 和 UIKit 都各自有手势识别系统（GestureRecognizer），为了防止互相抢事件，Flutter engine 在 iOS 上加入了一个“<strong>delaying gesture recognizer</strong>”（延迟识别器），这也最终导致了 iOS 26 上的 bug ：</p>
<blockquote>
<p>在 Flutter 弹窗和 WKWebView 一起出来的时候，要么点不动，要么触摸会穿透到下面的 WebView 。</p>
</blockquote>
<p>而在提供了之前部分场景有效的临时解决方案之后，Flutter 官方也提出了几个对应的可行性重构方案，具体可见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1ag4drAdJsR7y-rQZkqJWc6tOQ4qCbflQSGyoxsSC6MM%2F" target="_blank" title="https://docs.google.com/document/d/1ag4drAdJsR7y-rQZkqJWc6tOQ4qCbflQSGyoxsSC6MM/" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a> ，而现在方案三最终确定并 LGTM ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf106d6c2e68440aadd91028a5e76d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=5mnL8b0GDAhEBWyWVIAa%2BtBlHNQ%3D" alt="" loading="lazy"/></p>
<p>回顾整个问题里程，主要有两点：</p>
<ul>
<li>现有的 “<strong>gesture recognizer approach</strong>” （依赖自定义 <code>UIGestureRecognizer</code> + <code>shouldRequireFailureOfGestureRecognizer</code>）存在局限：无法阻止 <code>UIView</code> / JS 的底层 touch 回调（例如 WebView 的 <code>touchstart</code>），并且会和 WebView  的内部识别器冲突（这个导致了 iOS 的平台 bug），从而让一直以来的 hack 实现（如 remove/re-add recognizer）不生效：</li>
</ul>
<blockquote>
<p>因为 JS的 <code>touchstart</code> 在 <code>touchesBegan</code> 当帧同步触发，Flutter 没法在 touchesBegan 前屏蔽掉事件。</p>
</blockquote>
<ul>
<li>以前为了解决 Google Maps 的 “dangling touchesBegan” 问题，引入了 <code>WaitUntilTouchesEnded</code> 策略，这是个权宜之计但并不理想，本质也是一种延迟机制：</li>
</ul>
<blockquote>
<p>因为当时 Flutter 没有能力在 <code>touchesBegan</code> 之前阻止触摸的到达，只能用 gesture recognizer 阻断，而这就导致了 Google Maps 在 <code>touchesBegan</code> 之后，后续 <code>touchesEnded</code>  会变成  recognizer fails 从而不会收到 <code>touchesEnded</code>，而这就是 <code>WaitUntilTouchesEnded</code> 诞生的背景，<code>WaitUntilTouchesEnded</code> 的目的就是避免 Google Maps 在中途被强制 fail，导致内部手势状态机 fails。</p>
</blockquote>
<p><strong>其实这一切的原因都是已经“异步协同”，所以现在修复开始改为“同步”</strong>，也就是 Flutter Engine + iOS embedder 新增了 “同步 hitTest 回调” 能力 ：</p>
<ul>
<li>iOS embedder 增加了可拦截 hitTest 的 <code>UIView</code></li>
<li>Engine 与 Dart Framework 通过 FFI 实现“同步回调”</li>
</ul>
<p>具体来说就是，首先是 Dart Framework 层，这里新增手势拦截策略 API (<code>UiKitView</code>)，在 <code>UiKitView</code> 组件中新增了 <code>gestureRecognizersBlockingPolicy</code>  参数，让开发者可以为每个 PlatformView 单独配置手势拦截行为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb90ae37fb447619445926d8d838a35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=eUYSZiz1UGYGAYfqMybnHyt8lhs%3D" alt="" loading="lazy"/></p>



































<table><thead><tr><th><strong>策略名称</strong></th><th><strong>拦截时机</strong></th><th><strong>使用技术</strong></th><th><strong>解决核心问题</strong></th></tr></thead><tbody><tr><td><strong><code>touchBlockingOnly</code></strong></td><td><strong>最快 (HitTest 阶段)</strong></td><td>iOS <code>hitTest</code> 重写</td><td><strong>修复 iOS 18+/26 WebView/AdMob 无法点击</strong></td></tr><tr><td><code>eager</code></td><td>快 (手势竞争胜出时)</td><td>阻塞手势识别器</td><td>(旧默认值，现已不推荐)</td></tr><tr><td><code>waitUntilTouchesEnded</code></td><td>慢 (手指抬起后)</td><td>阻塞手势识别器</td><td>过去修复 Google Maps 状态卡死问题</td></tr><tr><td><code>fallbackToPluginDefault</code></td><td>(取决于插件设定)</td><td>(取决于插件设定)</td><td>保持旧插件兼容性</td></tr></tbody></table>
<blockquote>
<p>新机制让开发者可以在 Dart 代码中直接指定 PlatformView 的手势拦截策略，而不是依赖全局配置或原生代码，根据不同场景配置不同的拦截处理机制，而 <code>touchBlockingOnly</code>  就是全新的支持。</p>
</blockquote>
<p>例如针对 AdMob 或 WebView 在 iOS 18+/26 上的点击穿透问题，现在开发者可以强制使用 <code>touchBlockingOnly</code> 策略，从而绕过有问题的 <code>gesture recognizer</code> 机制。</p>
<blockquote>
<p>另外也提供了 <code>fallbackToPluginDefault</code>，确保不修改代码的情况下维持原有插件的行为。</p>
</blockquote>
<p>接着就是在 Dart Framework 层实现了 Hit Test 逻辑，用于响应 Engine 发起的命中测试请求，判断点击位置是否落在 PlatformView 上：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2531bb5a6ae243ca9626c27fe2f162e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=U0v5i8fo3VTkix79%2BKMUvmptGQY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>当用户点击屏幕时，Flutter 通过 Render Tree 判断该位置最上层是否是 PlatformView，如果是被 Flutter 组件（如下拉菜单）遮挡，<code>firstHit</code> 就不会是 <code>NativeHitTestTarget</code>，从而拦截触摸。</p>
</blockquote>
<p>然后就是  Engine / Bridge 层的通信，这部分主要负责将 iOS 原生的同步调用桥接到 Dart 环境，这里提供了一个同步的 Dart 入口点 <code>_platformViewShouldAcceptTouch</code>，从而让 iOS 原生的 <code>hitTest</code> 方法可以阻塞等待 Dart 的判断结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f0eec9293754efe89dcde8a8bafffed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=63PpnsrT64aY9Sb95qJu78AlGa8%3D" alt="" loading="lazy"/></p>
<p>之后就是  iOS Engine 层重写了 <code>hitTest</code> 方法，这也是本次修复的核心，通过重写 PlatformView 的 <code>hitTest</code> 方法，在通过响应链传递触摸事件之前，先询问 Flutter Framework 是否应该拦截该事件：</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">- (UIView*)hitTest:(CGPoint)point withEvent:(UIEvent*)event {
  if (_blockingPolicy == FlutterPlatformViewGestureRecognizersBlockingPolicyTouchBlockingOnly) { //
    // ... (获取 flutterViewController)
    
    CGPoint pointInFlutterView = [self convertPoint:point toView:self.flutterViewController.view];
    
    // 询问 Framework 是否应该接收此触摸
    if (![self.flutterViewController
            platformViewShouldAcceptTouchAtTouchBeganLocation:pointInFlutterView]) { //
      // 如果 Framework 说 "不" (例如点击了 Flutter 遮罩)，返回 self (拦截触摸)
      return self;
    }
  }

  // 如果 Framework 说 "是"，调用 super，让事件传递给 WKWebView
  return [super hitTest:point withEvent:event];
}
</code></pre>
<p>而对应的就是，如果策略是 <code>TouchBlockingOnly</code>，则不再添加容易导致冲突的 <code>delayingRecognizer</code> :</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7118fbbcc2964e9caafc43690292d137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=%2BMBOqRuhEMsQNYLrGOT4KZesGLw%3D" alt="" loading="lazy"/></p>
<p>也就是，现在会先通过 <code>hitTest</code> 预先判断，避免了使用 <code>UIGestureRecognizerDelegate</code> 带来的复杂性和 iOS 18+ 上的 Bug，而当 <code>platformViewShouldAcceptTouch</code> 返回 <code>NO</code> 时，<code>FlutterTouchInterceptingView</code> 自身会吞掉事件，底层的 WebView 就不会收到错误的点击，从而修复了点击穿透或链接无法点击的问题。</p>
<h2 data-id="heading-0">最后</h2>
<p>可以看到，本次调整数据较大的底层变动，所以牵动的模块也比较多，这也是为什么这个 PR 一直拖到现在才合并的原因，因为需要考虑和测试的因素很多：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1657bf9b16e14e05972030076f76de7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=4JV7LN4r0e5hrmhpcKM2cJW9Ycw%3D" alt="" loading="lazy"/></p>
<p>而对于开发者来说，如果要引用修复，最好是通过增加对应的  <code>gestureBlockingPolicy</code> 参数来支持配置，只针对有问题的场景使用  <code>touchBlockingOnly</code> ，因为这怎么说也是一个底层大变更，会不会有新的问题还不好说。</p>
<h2 data-id="heading-1">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F179659" target="_blank" title="https://github.com/flutter/flutter/pull/179659" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F175099" target="_blank" title="https://github.com/flutter/flutter/issues/175099" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hello 算法：以“快”著称的哈希]]></title>    <link>https://juejin.cn/post/7583576612391305226</link>    <guid>https://juejin.cn/post/7583576612391305226</guid>    <pubDate>2025-12-14T16:44:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576612391305226" data-draft-id="7583577045578842138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hello 算法：以“快”著称的哈希"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2025-12-14T16:44:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="灵感__idea"/> <meta itemprop="url" content="https://juejin.cn/user/641770521368606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hello 算法：以“快”著称的哈希
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/641770521368606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    灵感__idea
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T16:44:48.000Z" title="Sun Dec 14 2025 16:44:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>每个系列一本前端好书，帮你轻松学重点。</p>
<p>本系列来自上海交通大学硕士，华为高级算法工程师 <strong>靳宇栋</strong> 的 <strong>《Hello，算法》</strong></p>
</blockquote>
<p>你一定不止一次开始学算法，然而，因为很多人都会有的“知难而退”和“持久性差”，每次都半途而废，有些算法就因为排在了学习计划中靠后的位置，从来不曾触碰过，既不知道是什么，也不知道可以用来干什么。</p>
<p>本篇文章开始，小匠会带大家一起，用最少的时间，揭开常见“高级”算法的神秘面纱。</p>
<h2 data-id="heading-0">什么是“哈希”？</h2>
<p>哈希，从萌芽时期到现在已有70多年历史，音译自“hash”，原意是“切碎并搅拌”。即将一个任意长度的输入（<strong>键</strong>），通过特定的算法（<strong>切碎并搅拌</strong>），转换成一个固定长度的、看似随机的输出（<strong>哈希值</strong>） 。</p>
<p>听起来很玄乎，实际想做的，就是能够像数组一样，实现对数据的快速访问，且键可以是非整型数字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a16efe48a09448dabd3ae27b6b2dc8a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766335488&amp;x-signature=T25Onv8kGObMsXStDWrUA0lGHmU%3D" alt="微信图片_2025-12-14_175842_460.jpg" loading="lazy"/></p>
<p>那么在编程语言中，是否包含了这种数据结构呢，答案是：有。</p>
<p>JavaScript的早期版本是没有的，ES6后才加入，它就是<strong>Map</strong>。</p>
<h2 data-id="heading-1">Map</h2>
<p>Map大家并不陌生，常用来存储键值对，就像这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* 初始化 */</span>
<span class="hljs-type">const</span> <span class="hljs-built_in">map</span> = new Map();

<span class="hljs-comment">// 添加键值对 (key, value)</span>
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">12836</span>, <span class="hljs-string">'小哈'</span>);
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">15937</span>, <span class="hljs-string">'小啰'</span>);

<span class="hljs-comment">// 根据 key 做查询</span>
let name = <span class="hljs-built_in">map</span>.get(<span class="hljs-number">15937</span>);

<span class="hljs-comment">// 删除</span>
<span class="hljs-built_in">map</span>.delete(<span class="hljs-number">12836</span>);
</code></pre>
<p>看起来并不复杂，而且如果只是存储键值对，还可以用Object，甚至更“方便”。</p>
<p>那为什么要多创造出来一种数据结构，它们的区别是什么？</p>
<p>Object，意为对象，面向对象编程的精髓是将数据做<strong>抽象</strong>，定义它所具备的<strong>属性</strong>和<strong>能力</strong>。</p>
<p>Map，意为映射，主要用于<strong>存储、查找</strong>数据，单从这点就很容易区分了。</p>
<p>同时，Map有专门的增、删、迭代方法，且严格按照插入顺序迭代。</p>
<p>此外，Object的优化倾向是静态存储和快速访问。Map的优化倾向是频繁增删。</p>
<p>这样对比下来，它们的特点和应用场景差异还是挺大的。</p>
<p>接下来，深入介绍一下哈希表有哪些特点、用途和痛点。</p>
<h2 data-id="heading-2">用数组实现哈希</h2>
<p>了解一种数据结构的最佳途径就是亲手实现它。</p>
<p>通常，笔者在这个节点都会比较慌：一来不知从何下手，二来涉及逻辑细节就发懵。</p>
<p>但这次不用慌，我们只看最简的“<strong>数组实现</strong>”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8f00b224b2a483195afb1896e9bf757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766335488&amp;x-signature=HQEf%2B5X9U67Dt8CNsHNot8OFZ%2FU%3D" alt="微信图片_2025-12-14_181201_100.png" loading="lazy"/></p>
<h4 data-id="heading-3">映射关系的建立</h4>
<p>我们知道，数组本身自带索引位，本书作者将这些索引位称为“桶”（bucket），你想叫别的也行，本质就是<strong>容器</strong>。</p>
<p>每个桶可存储一个键值对（记住这里的“一个”），因此，查询操作就是找到 key 对应的桶，并在桶中获取 value 。</p>
<p>前面提到，哈希表需要实现的是“非整型数字”作为 key，既然要放弃天然的数字索引，兼容其他类型，如何基于 key 定位对应的桶呢？这就要涉及它的核心能力—<strong>哈希函数</strong>（hash function）。</p>
<blockquote>
<p>哈希函数的作用是<strong>将一个较大的输入空间映射到一个较小的输出空间</strong>。</p>
<p>为什么这么做？因为哈希表的输入是不确定的，但能使用的存储空间是有限的。</p>
</blockquote>
<p>本次实现中，输入一个 key ，哈希函数的计算过程有两步：</p>
<ul>
<li>
<p>通过哈希算法 hash() 计算得到哈希值。</p>
</li>
<li>
<p>将哈希值对桶数量（数组长度）capacity 取模，从而获取该 key 对应的桶（数组索引）index</p>
<p>index = hash(key) % capacity</p>
</li>
</ul>
<p>随后，就可以利用 index 在哈希表中访问对应的桶，从而获取 value 。</p>
<p>实现逻辑如下。</p>
<p>准备好一个创建键值对的类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/* 键值对 Number -&gt; String */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Pair</span> {
    <span class="hljs-keyword">constructor</span>(key, <span class="hljs-keyword">val</span>) {
        <span class="hljs-keyword">this</span>.key = key;
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">val</span> = <span class="hljs-keyword">val</span>;
    }
}
</code></pre>
<p>创建哈希类：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 基于数组实现的哈希表 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayHashMap</span> {
    #buckets;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 初始化数组，包含 100 个桶</span>
        <span class="hljs-variable language_">this</span>.#buckets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<p>计算 value 的哈希函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">/* 哈希函数 */</span>
    #<span class="hljs-title function_">hashFunc</span>(<span class="hljs-params">key</span>) {
        <span class="hljs-keyword">return</span> key % <span class="hljs-number">100</span>;
    }
</code></pre>
<p>增、删、查方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-comment">/* 查询操作 */</span>
    <span class="hljs-keyword">get</span>(key) {
        let index = <span class="hljs-keyword">this</span>.#hashFunc(key);
        let pair = <span class="hljs-keyword">this</span>.#buckets[index];
        <span class="hljs-keyword">if</span> (pair === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> pair.<span class="hljs-keyword">val</span>;
    }

    <span class="hljs-comment">/* 添加操作 */</span>
    <span class="hljs-keyword">set</span>(key, <span class="hljs-keyword">val</span>) {
        let index = <span class="hljs-keyword">this</span>.#hashFunc(key);
        <span class="hljs-keyword">this</span>.#buckets[index] = new Pair(key, <span class="hljs-keyword">val</span>);
    }

    <span class="hljs-comment">/* 删除操作 */</span>
    delete(key) {
        let index = <span class="hljs-keyword">this</span>.#hashFunc(key);
        <span class="hljs-comment">// 置为 null ，代表删除</span>
        <span class="hljs-keyword">this</span>.#buckets[index] = <span class="hljs-literal">null</span>;
    }
</code></pre>
<p>遍历方法：</p>
<pre><code class="hljs language-csharp" lang="csharp">    <span class="hljs-comment">/* 获取所有键值对 */</span>
    entries() {
        <span class="hljs-keyword">let</span> arr = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets.length; i++) {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i]) {</span>
                arr.push(<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i]);</span>
            }
        }
        <span class="hljs-keyword">return</span> arr;
    }

    <span class="hljs-comment">/* 获取所有键 */</span>
    keys() {
        <span class="hljs-keyword">let</span> arr = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets.length; i++) {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i]) {</span>
                arr.push(<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i].key);</span>
            }
        }
        <span class="hljs-keyword">return</span> arr;
    }

    <span class="hljs-comment">/* 获取所有值 */</span>
    values() {
        <span class="hljs-keyword">let</span> arr = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets.length; i++) {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i]) {</span>
                arr.push(<span class="hljs-keyword">this</span>.<span class="hljs-meta">#buckets[i].val);</span>
            }
        }
        <span class="hljs-keyword">return</span> arr;
    }
</code></pre>
<p>整体比较容易理解，一个是基于哈希函数的value计算，一个是数组遍历。</p>
<p>可以看出，哈希函数是整个过程的关键点，但，也是“痛点”。</p>
<h2 data-id="heading-4">哈希的痛</h2>
<p>在哈希表中，键的存储不是挨个放的，是经过哈希函数计算得来。</p>
<p>前面提到，哈希表的输入远大于输出，且一个key对应的位置只存放一个value，那么有可能发生什么情况？</p>
<p>不同的 key 经过计算落到了同一个位置上，就与预期相违背了，这种情况称作“<strong>哈希冲突</strong>”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00cbdf08dd4c4972bc4dd3a582df0b39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G15oSfX19pZGVh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766335488&amp;x-signature=%2Fwxh%2F4vh9ekVzifFD1YnOZtX6Ks%3D" alt="微信图片_2025-12-14_181639_311.png" loading="lazy"/></p>
<p>产生冲突后，会对操作产生直接影响，哈希表的优势就大打折扣。怎么办？</p>
<p>比较容易想到的是，哈希表容量越大，不同 key得到同一个结果的概率就越低，冲突就越少，所以，可以通过扩容来减少冲突。</p>
<p>但是这种方法不提倡轻易使用，因为哈希表扩容需要进行大量的数据搬运与值计算，效率太低。</p>
<p>需要采取一些策略来弥补效率上的损失：</p>
<p>1、仅在必要的时候进行扩容。</p>
<p>2、改良数据结构，使哈希表在出现冲突时仍能正常工作。</p>
<p>问题来了，什么是必要的时候？</p>
<h4 data-id="heading-5">负载因子与动态扩容</h4>
<p>负载因子（load factor）的定义为哈希表的元素数量除以桶数量，用于衡量哈希冲突的<strong>严重程度</strong>。</p>
<p>简单理解：当负载因子超过某个阈值（通常是 0.5 到 0.8 之间），表示哈希表要“<strong>超重</strong>”了，需要创建一个更大的哈希表（通常是当前大小的 2 倍），然后重新插入所有现有的键值对，这个过程称为 <strong>“重哈希”</strong> 。</p>
<p>这种方式相比“立即扩容”进行了一定的优化，不过结果还是造成了内存占用的增加。 那有没有可以不扩容，原地优化的方法？</p>
<h4 data-id="heading-6">链式地址与开放寻址</h4>
<p>听起来高大上，其实简单，想想日常，我们有东西要存到柜子里，但柜子不是空的，怎么办？</p>
<p>1、放得下就继续放，一个柜子塞多个</p>
<p>2、从它旁边再找一个空柜子</p>
<p><strong>链式地址</strong>对应方法1，将原本一个位置只存储一个值的方式，改为一个地址存储一串值，即一个“链表”。</p>
<p><strong>开放寻址</strong>对应方法2，不引入新的数据结构，而是开放整个存储空间，发现冲突后重新找一个能存放的地址。</p>
<p>这两种方案都有多种实现策略，但它们也不是完美的，有各自的优缺点，同时，它们的存在是为了保证哈希表在<strong>发生冲突时仍正常工作</strong>，其实是“绕开”了问题，而不是解决问题。</p>
<p>那么，怎样能解决？</p>
<h2 data-id="heading-7">哈希算法</h2>
<p>既然冲突的来源是“计算”，解决问题的根本也就是“计算”。</p>
<p>优秀的哈希算法，应具备以下特点：</p>
<ul>
<li><strong>确定性</strong>：相同的输入始终产生相同的输出。</li>
<li><strong>效率高</strong>：计算过程足够快，开销足够小。</li>
<li><strong>均匀分布</strong>：键值对尽可能地均匀分布。</li>
</ul>
<p>在实际中，我们通常不会自己再开发一套哈希算法，而是用一些标准算法，例如 MD5、SHA-1、SHA-2 和 SHA-3 等。它们可以将任意长度的输入数据映射到恒定长度的哈希值。</p>
<p>MD5 常用于校验文件完整性，比如软件安装包的哈希值；SHA-2 常用于安全应用与协议，比如生成数字签名；Git使用SHA-1哈希来唯一标识每一次提交。</p>
<p>近一个世纪以来，研发人员都在对哈希算法进行不断地升级优化，要么提升性能，要么提升安全性，那么编程语言都是怎么选择的呢。</p>
<h2 data-id="heading-8">编程语言的选择</h2>
<p>各种编程语言采取了不同的哈希表实现策略。</p>
<ul>
<li>Python 采用开放寻址。字典 <code>dict</code> 使用伪随机数进行探测。</li>
<li>Java 采用链式地址。当 <code>HashMap</code> 内数组长度达到 64 且链表长度达到 8 时，链表会转换为红黑树以提升查找性能。</li>
<li>Go 采用链式地址。规定每个桶最多存储 8 个键值对，超出容量则连接一个溢出桶；当溢出桶过多时，会执行一次特殊的等量扩容操作，以确保性能。</li>
<li>JavaScript 引擎 V8 中的 <code>Map</code> 并非使用简单的传统哈希表，而是使用了一个称为 <strong><code>OrderedHashMap</code></strong> 的数据结构。</li>
</ul>
<h2 data-id="heading-9">小结</h2>
<p>越高级的算法，涉及的细节就越多，同时离实际应用场景也越近。</p>
<p>笔者本文所述尽量全面易懂，但不一定全部准确，需要注意，这是你学习哈希算法的起点，而不是终点，欢迎留言交流探讨。</p>
<p>更多好文第一时间接收，可关注公众号：“前端说书匠”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 C#.NET 运算符重载：语法、设计原则与最佳实践]]></title>    <link>https://juejin.cn/post/7583576605781049390</link>    <guid>https://juejin.cn/post/7583576605781049390</guid>    <pubDate>2025-12-14T23:17:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605781049390" data-draft-id="7583577045578924058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 C#.NET 运算符重载：语法、设计原则与最佳实践"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-14T23:17:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 C#.NET 运算符重载：语法、设计原则与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:17:48.000Z" title="Sun Dec 14 2025 23:17:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p>运算符重载是 <code>C#</code> 提供的一种特性，允许开发者为 自定义类型（类/结构体） 定义运算符的行为。
例如，可以让 <code>Vector</code> 对象支持 + 运算，而不是仅限于基本类型（<code>int</code>、<code>double</code> 等）。</p>
<p>💡 本质：运算符重载是一个 带有 <code>operator</code> 关键字的静态方法，通过自定义方法改变运算符的操作行为。</p>
<h3 data-id="heading-1">适用范围与限制</h3>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>可重载的类型</td><td><strong>类（class）</strong> 和 <strong>结构体（struct）</strong></td></tr><tr><td>不可重载的类型</td><td>接口、枚举、委托</td></tr><tr><td>方法修饰符</td><td>必须是 <strong>public static</strong></td></tr><tr><td>至少一个自定义类型</td><td>运算符的参数中至少有一个必须是用户自定义类型</td></tr><tr><td>不能重载的运算符</td><td><code>.</code>（成员访问）、<code>?:</code>（条件运算符）、<code>new</code>、<code>is</code>、<code>as</code>、<code>typeof</code>、<code>sizeof</code>、<code>=</code>, <code>+=</code>, <code>-=</code>（但可以间接重载）</td></tr></tbody></table>
<h3 data-id="heading-2">支持重载的运算符</h3>

























<table><thead><tr><th>分类</th><th>运算符</th></tr></thead><tbody><tr><td>一元运算符</td><td><code>+</code> <code>-</code> <code>!</code> <code>~</code> <code>++</code> <code>--</code> <code>true</code> <code>false</code></td></tr><tr><td>二元运算符</td><td><code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>%</code> <code>&amp;</code> `</td></tr><tr><td>比较运算符</td><td><code>==</code> <code>!=</code> <code>&lt;</code> <code>&gt;</code> <code>&lt;=</code> <code>&gt;=</code>（必须成对重载，如重载==则必须重载!=）</td></tr><tr><td>转换运算符</td><td><code>implicit</code>（隐式转换） <code>explicit</code>（显式转换）</td></tr></tbody></table>
<h3 data-id="heading-3">基本语法</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> 返回类型 <span class="hljs-keyword">operator</span> 运算符(参数列表)
{
    <span class="hljs-comment">// 自定义逻辑</span>
}
</code></pre>
<ul>
<li>
<p><code>operator</code> 关键字定义运算符。</p>
</li>
<li>
<p>参数中至少有一个是当前类/结构体。</p>
</li>
<li>
<p>建议返回新的对象，保持不可变性。</p>
</li>
</ul>
<h3 data-id="heading-4">常见示例</h3>
<h4 data-id="heading-5">重载二元运算符（+）</h4>
<p>创建一个二维向量类：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Vector
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> X { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Y { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Vector</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> x, <span class="hljs-built_in">double</span> y</span>)</span> =&gt; (X, Y) = (x, y);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector <span class="hljs-keyword">operator</span> +(Vector a, Vector b)
        =&gt; <span class="hljs-keyword">new</span> Vector(a.X + b.X, a.Y + b.Y);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span> =&gt; <span class="hljs-string">$"(<span class="hljs-subst">{X}</span>, <span class="hljs-subst">{Y}</span>)"</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">var</span> v1 = <span class="hljs-keyword">new</span> Vector(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">var</span> v2 = <span class="hljs-keyword">new</span> Vector(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
Console.WriteLine(v1 + v2); <span class="hljs-comment">// 输出: (4, 6)</span>
</code></pre>
<h4 data-id="heading-6">重载一元运算符（-）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector <span class="hljs-keyword">operator</span> -(Vector v)
    =&gt; <span class="hljs-keyword">new</span> Vector(-v.X, -v.Y);

<span class="hljs-keyword">var</span> v = <span class="hljs-keyword">new</span> Vector(<span class="hljs-number">5</span>, <span class="hljs-number">-3</span>);
Console.WriteLine(-v); <span class="hljs-comment">// 输出: (-5, 3)</span>
</code></pre>
<h4 data-id="heading-7">重载比较运算符（==, !=）</h4>
<p>比较向量是否相等：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> ==(Vector a, Vector b)
    =&gt; a.X == b.X &amp;&amp; a.Y == b.Y;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> !=(Vector a, Vector b)
    =&gt; !(a == b);

<span class="hljs-comment">// 建议同时重写 Equals 和 GetHashCode</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? obj</span>)</span>
    =&gt; obj <span class="hljs-keyword">is</span> Vector v &amp;&amp; <span class="hljs-keyword">this</span> == v;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetHashCode</span>()</span>
    =&gt; HashCode.Combine(X, Y);
</code></pre>
<ul>
<li>
<p>重载 <code>==</code> 时 必须 同时重载 <code>!=</code>。</p>
</li>
<li>
<p><code>Equals</code> 和 <code>GetHashCode</code> 也要同步实现，保证一致性。</p>
</li>
</ul>
<h4 data-id="heading-8">重载递增/递减运算符（++/--）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector <span class="hljs-keyword">operator</span> ++(Vector v)
    =&gt; <span class="hljs-keyword">new</span> Vector(v.X + <span class="hljs-number">1</span>, v.Y + <span class="hljs-number">1</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector <span class="hljs-keyword">operator</span> --(Vector v)
    =&gt; <span class="hljs-keyword">new</span> Vector(v.X - <span class="hljs-number">1</span>, v.Y - <span class="hljs-number">1</span>);
</code></pre>
<h4 data-id="heading-9">转换运算符（implicit/explicit）</h4>
<p>在 <code>Vector</code> 和 <code>double</code> 之间转换：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">double</span>(<span class="hljs-params">Vector v</span>)</span>
    =&gt; Math.Sqrt(v.X * v.X + v.Y * v.Y); <span class="hljs-comment">// 隐式转换为长度</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">explicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">Vector</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> d</span>)</span>
    =&gt; <span class="hljs-keyword">new</span> Vector(d, d); <span class="hljs-comment">// 需要强制转换</span>
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-csharp" lang="csharp">Vector v = <span class="hljs-keyword">new</span> Vector(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
<span class="hljs-built_in">double</span> len = v; <span class="hljs-comment">// 隐式转换</span>
Vector v2 = (Vector)<span class="hljs-number">5.0</span>; <span class="hljs-comment">// 显式转换</span>
</code></pre>
<h4 data-id="heading-10">逻辑运算符（true/false）</h4>
<p>用于自定义布尔逻辑：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">true</span>(<span class="hljs-params">Vector v</span>)</span> =&gt; v.X != <span class="hljs-number">0</span> || v.Y != <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">false</span>(<span class="hljs-params">Vector v</span>)</span> =&gt; v.X == <span class="hljs-number">0</span> &amp;&amp; v.Y == <span class="hljs-number">0</span>;

Vector v = <span class="hljs-keyword">new</span> Vector(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span> (v) <span class="hljs-comment">// 自动调用 operator true</span>
    Console.WriteLine(<span class="hljs-string">"非零向量"</span>);
<span class="hljs-keyword">else</span>
    Console.WriteLine(<span class="hljs-string">"零向量"</span>);
</code></pre>
<h3 data-id="heading-11">运算符与方法的关系</h3>
<p>运算符重载只是语法糖，编译器会将运算符转换为静态方法调用：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> c = a + b;
<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">var</span> c = Vector.op_Addition(a, b);
</code></pre>
<p>常用方法映射：</p>

































<table><thead><tr><th>运算符</th><th>生成的方法名</th></tr></thead><tbody><tr><td><code>+</code></td><td>op_Addition</td></tr><tr><td><code>-</code></td><td>op_Subtraction</td></tr><tr><td><code>*</code></td><td>op_Multiply</td></tr><tr><td><code>/</code></td><td>op_Division</td></tr><tr><td><code>==</code></td><td>op_Equality</td></tr><tr><td><code>!=</code></td><td>op_Inequality</td></tr></tbody></table>
<h3 data-id="heading-12">综合示例：复数类</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Complex
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Real { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Imag { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Complex</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> real, <span class="hljs-built_in">double</span> imag</span>)</span>
        =&gt; (Real, Imag) = (real, imag);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Complex <span class="hljs-keyword">operator</span> +(Complex a, Complex b)
        =&gt; <span class="hljs-keyword">new</span> Complex(a.Real + b.Real, a.Imag + b.Imag);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Complex <span class="hljs-keyword">operator</span> -(Complex a, Complex b)
        =&gt; <span class="hljs-keyword">new</span> Complex(a.Real - b.Real, a.Imag - b.Imag);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Complex <span class="hljs-keyword">operator</span> *(Complex a, Complex b)
        =&gt; <span class="hljs-keyword">new</span> Complex(a.Real * b.Real - a.Imag * b.Imag,
                       a.Real * b.Imag + a.Imag * b.Real);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> ==(Complex a, Complex b)
        =&gt; a.Real == b.Real &amp;&amp; a.Imag == b.Imag;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">operator</span> !=(Complex a, Complex b)
        =&gt; !(a == b);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span> =&gt; <span class="hljs-string">$"<span class="hljs-subst">{Real}</span> + <span class="hljs-subst">{Imag}</span>i"</span>;
}
</code></pre>
<h3 data-id="heading-13">总结</h3>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>适用场景</td><td>数学计算类（向量、矩阵、复数）、日期时间、坐标类</td></tr><tr><td>关键规则</td><td><code>public static</code>、至少一个参数为自定义类型</td></tr><tr><td>搭配使用</td><td><code>Equals</code>、<code>GetHashCode</code>、<code>IComparable</code></td></tr><tr><td>设计建议</td><td>遵循语义一致性、返回新对象、与方法重载保持协调</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解密Prompt系列66. 视觉Token爆炸→DeepSeek-OCR光学压缩]]></title>    <link>https://juejin.cn/post/7583499967236636706</link>    <guid>https://juejin.cn/post/7583499967236636706</guid>    <pubDate>2025-12-14T23:50:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583499967236636706" data-draft-id="7582419803782103075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密Prompt系列66. 视觉Token爆炸→DeepSeek-OCR光学压缩"/> <meta itemprop="keywords" content="NLP,LLM"/> <meta itemprop="datePublished" content="2025-12-14T23:50:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风雨中的小七"/> <meta itemprop="url" content="https://juejin.cn/user/3060648218472728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密Prompt系列66. 视觉Token爆炸→DeepSeek-OCR光学压缩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3060648218472728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风雨中的小七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:50:24.000Z" title="Sun Dec 14 2025 23:50:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>借着 DeepSeek-OCR这篇论文，本章我们来回顾下多模态大模型（VLM）的核心技术演进。</p>
<p>很多人认为：图像Token的信息密度和效率远不如文本。但 DeepSeek-OCR的核心价值，就是用实践证明了这是一个伪命题。它通过一套巧妙的<em>串行视觉压缩架构</em>，实现1个视觉Token近乎无损地承载10个文本Token的惊人效率。</p>
<p>下面我们沿着 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 危机 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 结构感知 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 语义对齐 的路径，来梳理这背后的技术基石。</p>
<h2 data-id="heading-0">Part I：多模态基石的构建与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 危机</h2>
<p>我们先来回顾下多模态模型的技术基石，我们将按照模型结构-&gt;多模态对齐-&gt;指令生成这条路径进行深入。</p>
<h3 data-id="heading-1">ViT: 图像的 BERT 化与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的起点</h3>
<blockquote>
<ul>
<li>Google: AN IMAGE IS WORTH 16X16 WORDS: TRANSFORMERS FOR IMAGE RECOGNITION AT SCALE</li>
</ul>
</blockquote>
<p>💡 ViT的本质像是图像领域的Bert，只不过把文字token转换成了图像的像素块。在ViT出现之前，图像领域清一色使用CNN、ResNET，强调各种图片特征提取例如平移不变性，局部特征等等。但是ViT的出现，再一次证明大力出奇迹，只要数据量足够大，简单的Transformer Encoder胜过一切。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d810aae10954444adccfb6993e22061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=lYQcV0tmKAyljY8OFaiRCIbhW%2B4%3D" alt="image" loading="lazy"/></p>
<p>如果我们通过和NLP Transformer类比来认识ViT的话，整个模型结构会分成以下几个部分</p>
<ol>
<li>
<p>Tokenization
在文本中，句子被tokenize成token，作为模型的输入。在图像中，一个Height * Width * Channel大小的图像，会被分割成固定大小16<em>16的像素块（Patch）。如果图片的长宽是224</em>224，则模型的输入会有224<em>224/(16</em>16)=196个像素块。</p>
</li>
<li>
<p>输入层
ViT的输入层包含两个部分</p>
</li>
</ol>
<ul>
<li>Patch Embedding:因为图像不像文本有可枚举的token，因此无法使用词典向量进行映射，所以ViT选择通过线性映射层（MLP）来把patch映射到固定的维度D。</li>
<li>Positional Encoding：和NLP相同，为了保留位置信息，ViT加入了1D的position embedding（2D经试验没有效果提升，因为大量数据会让模型在一维关系中学习到空间特征）</li>
<li>Class Head：和BERT相同，ViT也加入了一个可学习的全局token，用于表征图片的整体信息。</li>
</ul>
<ol start="3">
<li>
<p>中间层
中间层就是传统的Transformer结构了，通过交替的多头注意力，MLP线性映射层和LayerNorm归一化层。</p>
</li>
<li>
<p>训练策略
考虑论文本身就是为了证明训练数据的Scaling战胜一切，因此在训练策略上也做了很相近的消融策略，包括</p>
</li>
</ol>
<ul>
<li><strong>数据量试验</strong>：在Image-Net这种1M左右的小数据上效果弱于ResNet，但是当在300M+的数据上进行训练时，效果全面超越CNN</li>
<li><strong>分辨率试验</strong>：在低分辨率预训练，在高分辨率微调。其实和现在长上文的NLP模型训练思路一致，在预训练输出长度较短，在post-train阶段在渐进式增长。</li>
<li><strong>位置编码实验</strong>：为了适配上面分辨率增长的问题，ViT在固定位置便马上进行差值</li>
<li><strong>训练超参</strong>：使用Adam，低正则参数（数据量足够大很少过拟合）</li>
</ul>
<p>VIT在后面任务中面临最大的问题就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>的视觉token膨胀，随着输入图片分辨率的变大，当输入1024*1024高分辨率图片时，输入token数将高达4096。</p>
<h3 data-id="heading-2">VIT-DET：解决<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>的局部注意力方案</h3>
<blockquote>
<ul>
<li>Meta: Exploring plain vision transformer backbones for object detection</li>
</ul>
</blockquote>
<p>💡 ViTDet 解决了 Plain ViT 无法用于高分辨率密集预测（如检测、分割、OCR）的痛点，其解决方案与 NLP 领域的 Longformer 思路高度相似：局部窗口 Attention + 稀疏全局连接。</p>
<ol>
<li>
<p>窗口注意力机制
将高分辨率图像划分成14 *14或者16 * 16的块，内部进行Attention，这样不论输入的图像像素如何变化，在Self-Attention层的计算复杂度都是恒定不会变化的。这样每个图像patch只关注它所在窗口内的相邻patch。这也是后面DeepSeek-OCR能处理高分辨率图像的技术基础。</p>
</li>
<li>
<p>稀疏全局 Attention 层
那局部Attention肯定要配合全局Attention能力，才能让block之间的信息互通。VIT-DET在网络中插入了4个标准的全局Attention层，例如如果整个VIT有24层，则每6层插入一个全局层，这样保证全局信息交互只在有限层进行，用于在保证显存和计算成本可控的前提下，兼顾全局信息的共享。</p>
</li>
</ol>
<h3 data-id="heading-3">Segment Anything Model：图像分割领域的 GPT-3</h3>
<blockquote>
<ul>
<li>Meta：Segment Anything</li>
<li>Meta: Exploring Plain Vision Transformer Backbones for Object Detection</li>
</ul>
</blockquote>
<p>💡 SAM是一个支持Prompt Engineering的生成式模型，但生成的不是token而是mask。它引入了promptable segmentation任务，给模型一个提示（点、框、文本），模型负责切割对应的物体。为DeepSeek-OCR提供了感知图片结构和几何的模型基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4175f5fa158f4af690981bf4ae50a63b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=GNBtYJPhLH3TMhZg%2BCBH37oPyjU%3D" alt="image" loading="lazy"/></p>
<p>如上图所示，SAM模型包含三个组成部分</p>
<ul>
<li><strong>Image Encoder</strong>：使用MAE预训练的VIT模型，作为强大的特征提取器提取每张图片的Embedding。MAE类似NLP里面BERT的训练方式，BERT是完形填空，MAE是遮掩部分图片进行重构还原。</li>
<li><strong>Prompt Encoder</strong>：这里的图像分割指令有两种
<ul>
<li><strong>Sparse</strong>：包含points（用户点中了图像中的某个物体）和boxes（用户框柱了图像的一个矩形区域）。分别用单个坐标和左上右下两个坐标点，使用可训练的位置编码表征。</li>
<li><strong>Dense</strong>：文本描述，例如一把黑色的剪刀。使用预训练CLIP的Text Encodier</li>
</ul>
</li>
<li><strong>Mask Decoder</strong>：轻量的Transformer Decoder，简单解释Image Embedding就是Key/Value, Prompt Embedding是Query，通过cross-Attention去图像里面捞出对应的像素区域，使用输出头在整个图片上进行分类预测，预测每个位置是否应该被Mask。</li>
</ul>
<p>同时为了解决Prompt Ambiguity的问题，例如如果用户点击了T恤，那用户究竟是想分割人？还是想分割T恤？论文提出了同时预测3个MASK的方案，同时预测多个可能的分割掩码结果，并用模型置信度打分选择最优可能的一个进训练，类似NLP模型的Beam-Search。</p>
<h3 data-id="heading-4">CLIP：视觉与文本的“罗塞塔石碑”</h3>
<blockquote>
<ul>
<li>OpenAI: Learning Transferable Visual Models From Natural Language Supervision</li>
</ul>
</blockquote>
<p>💡 CLIP本质就是一个Dual-Encoder对齐模型，可以类比NLP领域的SimCSE。通过InfoNCE Loss进行大规模对比学习，把文本和图像映射到同一个向量空间。被当前多模态太模型提供了核心的模态对齐能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cdbe787e8d48268ca19d56da394954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=9hEPO8lP%2BT%2Bnou%2BzEWNUxim0Wfc%3D" alt="image" loading="lazy"/></p>
<p>感觉直接看qseudo code比看图来的更清晰，整个CLIP的训练过程如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># extract feature representations of each modality</span>
I_f = image_encoder(I) <span class="hljs-comment">#[n, d_i]</span>
T_f = text_encoder(T) <span class="hljs-comment">#[n, d_t]</span>
<span class="hljs-comment"># joint multimodal embedding [n, d_e]</span>
I_e = l2_normalize(np.dot(I_f, W_i), axis=<span class="hljs-number">1</span>)
T_e = l2_normalize(np.dot(T_f, W_t), axis=<span class="hljs-number">1</span>)
<span class="hljs-comment"># scaled pairwise cosine similarities [n, n]</span>
logits = np.dot(I_e, T_e.T) * np.exp(t)
<span class="hljs-comment"># symmetric loss function</span>
labels = np.arange(n)
loss_i = cross_entropy_loss(logits, labels, axis=<span class="hljs-number">0</span>)
loss_t = cross_entropy_loss(logits, labels, axis=<span class="hljs-number">1</span>)
loss = (loss_i + loss_t)/<span class="hljs-number">2</span>
</code></pre>
<ol>
<li>多模态映射: 选取对应模态的预训练模型来对不同模态的输入进行特征提取</li>
</ol>
<ul>
<li>Text encoder: CBOW或者Bert，N*I -&gt; N * L * D</li>
<li>image encoder：ViT或者Resnet， N<em>H</em>W*C -&gt; N * L * D</li>
<li>再通过线性投影层，把不同模态的向量维度映射到相同的维度空间</li>
</ul>
<ol start="2">
<li>对比训练</li>
</ol>
<p>训练策略是通过Batch Contrastive Loss进行的，每个样本都有图片和对应的文字描述构成，因此一个batch内文本表征和图片表征的叉乘矩阵，应该只有对角线的相似度最高为正样本，其余都为负样本。</p>
<p>之所以选择InfoNCE，而非传统的Image Caption预测，因为论文发现这种训练方式模型收敛很慢，毕竟一个图片其实有无数种语言的描述方案，只让模型精准预测其中一种描述本身就不合理。而直接对齐高维向量表征的训练效率显著更高</p>
<ol start="3">
<li>样本构建</li>
</ol>
<p>图片和对应的文字描述样本集总共4亿条，为了保证图片概念的覆盖率，论文采用了搜索进行构建，先构建query集，再通过搜索构建(image,text) pair对。</p>
<ol start="4">
<li>模型使用</li>
</ol>
<p>使用以上对比训练得到的图像和文本Encoder，可以在两个领域之间进行零样本的知识迁移，类比GPT3水平的zero-shot，可以通过提示词“Transfer English to French”实现指令理解。CLIP训练过的图文Encoder同样可以，例如你要对象进行分类，只需要把1000个标签填入“A photo of {label}”，然后用Text Encoder进行编码，再计算和图像Encoder相似度最高的文本向量，就是该图片的分类了。</p>
<p>CLIP不仅为图像和文本模态对齐提供了思路，同时也是较早关注图像领域zero-shot开放域迁移的。</p>
<h2 data-id="heading-5">Part II：DeepSeek-OCR 的核心贡献：光学压缩秘籍</h2>
<blockquote>
<ul>
<li>DeepSeek-OCR: Contexts Optical Compression</li>
</ul>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c54d78d7825f4ccea466be28059419dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=59b1orBKzg5oC1pnAd%2FkYTqLuHc%3D" alt="image" loading="lazy"/></p>
<p>DeepSeek-OCR的核心亮点在于它提出了一个革命性的观点：<strong>通过高分辨率图像渲染 + 专用压缩架构，可以将长文本内容压缩成数量更少的视觉 Token，从而为LLM 的长上下文难题提供新的压缩思路。</strong></p>
<p>OCR其实只是一个实验场景，论文核心要回答的是“一张包含 1000 个单词的图片，到底最少需要多少个 Visual Token 才能让 LLM 完美还原出这 1000 个词？”</p>
<h3 data-id="heading-6">串行压缩的 DeepEncoder 架构</h3>
<p>DeepSeek-OCR 的 DeepEncoder 仅有 380M 参数，但通过巧妙的**串行（Serial）**结构，完美平衡了“高分辨率”与“低 Token 数”的需求。</p>
<ol>
<li><strong>80M SAM预训练VIT-DET</strong></li>
</ol>
<p>通过window-Attention，能在高分辨率图像下保持相对较低的显存占用，负责图片核心的结构特征提取。</p>
<ol start="2">
<li><strong>两层16*16CNN Compressor</strong></li>
</ol>
<p>用于对SAM输出的图像特征进一步降采样，降低激活率，是DeepSeek-OCR高保真，极高压缩率的核心。</p>
<ol start="3">
<li><strong>300M CLIP预训练VIT-Large</strong></li>
</ol>
<p>移除了首层的Embedding层，因为输入从图片变成了CNN降采样后的图像向量，采用全局注意力机制，对CNN降采样后的视觉Token进行全局语义的整合。</p>
<p>虽然都是VIT模型结构，但DeepSeek-OCR的组合方式大有学问。前面我们提到SAM本身的训练目标是边缘检测，因此预训练后的模型对于几何结构、笔画边界、布局线条有更强的捕捉能力，所以使用SAM预训练模型作为OCR的特征提取器再合适不过。而使用CLIP作为后端，接受经过压缩的视觉特征自然是使用CLIP本身和文本语义对齐的特性，把SAM提取的结构特征，站在全局视角翻译成包含语音信息Latent Tokens，用于后续解码器的解码。</p>
<p>用SAM“看清”，用CLIP“看懂”之后，最后就到解码器“讲给我听”，论文使用了DeepSeek-3B-MOE，总参数是3B，但推理时每个token只激活64个专家中的6个，对应570M左右的参数。之所以选择MOE，也是充分考虑到OCR任务本身的多元性，涉及到多语音、多符号（公式、图表）、多排版，而MOE可以根据输入的不同，选择不同的专家进行解码。</p>
<p>而之所以没有像Qwen使用位置编码，因为DeepSeek-OCR还是个单任务模型，因此只需要模型在训练过程中学习和原图图像token信息一一对应的文本token信息，那SAM的局部信息提取，加上从左到右，从上到下固定的token拼接顺序，再配合CLIP的全局语义理解（这是一个三栏排列还是个单栏报纸），其实就完全足够了。</p>
<h3 data-id="heading-7">动态分辨率</h3>
<p>为了适配不同的下游图片尺寸，DeepSeek-OCR对于动态多分辨率设计了两种方案。这里借鉴了InternVL1.5提出的tiling思路。</p>
<ol>
<li><strong>Native Resolution</strong></li>
</ol>
<p>论文预定义了四种分辨率Tiny(512)，Small(640), Base(1024), Large(1280)。输入图片会保持原有的长宽比，把短边padding到最近的分辨率。</p>
<ol start="2">
<li><strong>Gundam Mode</strong></li>
</ol>
<p>主要针对超高分辨率的长图（例如报纸，在我的场景中是收集拍照或截图的长图）。这时会采用多分辨率组图，类似NLP中的chunking逻辑。包括</p>
<ul>
<li>Global View：把全图reszie到1024 * 1024，提供全局上下文</li>
<li>Local View：将大图切分成多个640*640的图片快，提供局部视野。这里使用了InternVL提供的tiling方案。</li>
</ul>
<p>这样通过Gloabl+Local的方案，让模型既能获取全局排版，也能看清局部小字。</p>
<h3 data-id="heading-8">模型训练</h3>
<p>DeepSeek-OCR收集处理了海量的相关语料，大致涵盖以下三个方向</p>
<ul>
<li>OCR 1.0: 30M的PDF文档，有直接用pymuPDF提取的粗标样本，也有用MinerU、GOT-OCR精标的样本，还有用word反向构建的合成数据来保证公式与表格的准确。注意这里不同质量的样本在训练时会配合使用不同的指令来实现带噪学习。</li>
<li>OCR 2.0: 主要覆盖图表、公式、化学方程式等结构化数据。其中包括使用image-to-HTML构建得到的数据。</li>
<li>通用文本和图像：保证Decoder和CLIP Encoder的通用文本和图像能力的灾难性遗忘</li>
</ul>
<p>使用以上数据论文进行了两阶段的模型训练</p>
<ul>
<li>DeepEncoder预热训练：让编码器输出高质量图像Token，有点类似先训练embedding层</li>
<li>Encoder+Decoder联合训练：把Encoder模块中的SAM和Compressor参数都冻结，只保留CLIP可训练用于和Decoder的文本表征进行对齐。</li>
</ul>
<h3 data-id="heading-9">核心发现：上下文光学压缩的 Scaling Law</h3>
<p>通过在 OCR 任务上的实验，DeepSeek-OCR 得到了关于视觉信息密度最关键的结论，为 LLM 的长期记忆和遗忘机制提供了新的理论依据。</p>
<ul>
<li><strong>10*无损压缩</strong>，既当文本token/视觉token&lt;10，COR的解码精准度可以保持在97%+。</li>
<li><strong>20*优雅遗忘</strong>，既当文本token/视觉token=20，OCR的解码准确率仍有60%没有完全遗忘。</li>
</ul>
<p>第一个结论其实是反常识的，之前普遍认为图像token的信息密度更低，但其实这是对不同体裁图片的差异化认知导致的。而论文论证在当前的文本tokenizer的效果上，视觉模态可以成文文本模态的超级压缩格式。</p>
<p>而第二个结论其实和超长上文的记忆压缩机制相契合，对于超长文档的问答，是有可能通过图像token进行信息压缩，只保留核心语义信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6dda308092d4ba4861ff9aea07a0fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=zGf0BoMIeFEnW73IzsV2htCWlps%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-10">Part III：横向对比：多模态 VLM 的不同路线</h2>
<blockquote>
<ul>
<li>Vary: Scaling up the Vision Vocabulary for Large Vision-Language Models</li>
<li>Qwen2-vl: Enhancing vision-language model’s perception of the world at any resolution.</li>
<li>InterVL 1.5: How Far Are We to GPT-4V? Closing the Gap to Commercial Multimodal Models with Open-Source Suites</li>
</ul>
</blockquote>
<p>最后，我们通过一张表，清晰地对比 DeepSeek-OCR 与其他主流 VLLM 在处理高分辨率和 Token 效率上的技术路线差异。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac0a774413d04653889e3be39dee8371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766361024&amp;x-signature=yo91FEI5j%2BSF2TMb0RK7QargrPc%3D" alt="image" loading="lazy"/></p>













































<table><thead><tr><th>模型</th><th>核心 Token 策略</th><th>架构拓扑</th><th>关键技术</th><th>优势与劣势</th><th>借鉴</th></tr></thead><tbody><tr><td>DeepSeek-OCR</td><td>串行压缩 (Token Deflation)</td><td>SAM → Conv → CLIP ViT → LLM</td><td>ViTDet (Window Attn) + 16x Conv Compressor</td><td><strong>优势</strong>：Token压缩率最高，推理效率最高；在文档领域实现 1:10 无损压缩。</td><td/></tr><tr><td>Qwen2-VL</td><td>线性增长 (Token Inflation)</td><td>ViT → Pooling → LLM</td><td>Naive Dynamic Resolution + M-RoPE (3D 位置编码)</td><td><strong>优势</strong>：保真度高，位置感知优秀；<br/><strong>劣势</strong>：Token 数量随分辨率线性增长，推理昂贵。</td><td>不用通用位置编码而借助物理压缩</td></tr><tr><td>InternVL2</td><td>Tiling</td><td>InternViT (6B) → QLLaMA (8B) → LLM</td><td>巨型 ViT Encoder + LLaMA-based Adapter</td><td><strong>优势</strong>：视觉基座能力强；<br/><strong>劣势</strong>：整体参数量巨大，输入VIT分辨率低导致图像分割碎片化，token数过高、推理成本极高。</td><td>借鉴tiling</td></tr><tr><td>Vary</td><td>并行词表扩充</td><td>CLIP、SAM+Conv → Concat Fusion → LLM</td><td>SAM-based Tiny Vocabulary + Parallel Dual-Branch</td><td><strong>优势</strong>：增强文档理解；<br/><strong>劣势</strong>：并行结构显存占用大，Token 数量是两者之和，计算冗余。</td><td>借鉴Conv压缩，把Vary并行架构改为串行</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 打造通用CLI命令系统]]></title>    <link>https://juejin.cn/post/7583260493851508777</link>    <guid>https://juejin.cn/post/7583260493851508777</guid>    <pubDate>2025-12-14T23:58:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851508777" data-draft-id="7582637280219037750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 打造通用CLI命令系统"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T23:58:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 打造通用CLI命令系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:58:43.000Z" title="Sun Dec 14 2025 23:58:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>在日常开发中，某些情况下可能需要为服务提供一个命令行工具（CLI），方便运维、调试或者远程调用业务接口。</p>
<p>假设我们有一个 Spring Boot 服务，提供多个接口，例如：</p>
<ul>
<li>获取用户列表：<code>/users?type=admin</code></li>
<li>获取角色列表：<code>/roles?level=manager</code></li>
<li>获取系统状态：<code>/system/status</code></li>
<li>批量导入数据：<code>/data/import</code></li>
<li>生成报表：<code>/report/generate</code></li>
</ul>
<p>传统做法：</p>
<ul>
<li>每个接口在 CLI 客户端写一条命令</li>
<li>CLI 方法直接调用服务端 REST 接口</li>
<li>硬编码的服务地址和参数格式</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>接口多时，CLI 方法数量激增，代码冗余严重</li>
<li>每次新增接口都需要修改客户端，发布新版本</li>
<li>维护成本高，不同环境的配置分散</li>
<li>缺乏统一的认证、授权和日志机制</li>
<li>开发效率低下，重复劳动多</li>
</ul>
<p><strong>解决方案</strong>：<strong>通用命令 + 动态分发</strong></p>
<ul>
<li>CLI 只维护一条通用命令 <code>exec</code></li>
<li>根据参数动态路由到服务端对应的 Service Bean</li>
<li>服务端统一管理，支持动态扩展</li>
<li>一次开发，多处复用</li>
</ul>
<h2 data-id="heading-1">二、方案设计</h2>
<h4 data-id="heading-2">1. 核心架构</h4>
<p>我们设计了一套基于 Spring Boot + Spring Shell 的通用CLI系统，采用分层架构设计：</p>
<pre><code class="hljs language-scss" lang="scss">客户端(Spring Shell)  &lt;<span class="hljs-attr">--HTTP--</span>&gt;  服务端(Spring Boot)
       |                              |
    通用命令exec                    统一控制器(/cli)
       |                              |
    动态参数                      动态Bean分发
       |                              |
  单一入口命令                  多个CommandHandler
       |                              |
    <span class="hljs-attribute">REST</span>通信                    业务逻辑处理
</code></pre>
<p><strong>设计原则</strong></p>
<p><strong>单一职责</strong>：客户端只负责命令解析和HTTP通信，服务端只负责业务逻辑
<strong>开闭原则</strong>：对扩展开放（新增服务），对修改关闭（不需改客户端）
<strong>依赖倒置</strong>：依赖抽象的CommandHandler接口，而非具体实现
<strong>最小知识</strong>：客户端无需知道服务端的具体实现细节</p>
<h4 data-id="heading-3">2. 客户端设计</h4>
<p>在 CLI 客户端定义一条通用命令 <code>exec</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ShellComponent</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecCommand</span> {

    <span class="hljs-meta">@ShellMethod(key = "exec", value = "执行远程服务命令")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(
            <span class="hljs-meta">@ShellOption(value = {"", "service"}, help = "服务名称")</span> String serviceName,
            <span class="hljs-meta">@ShellOption(value = "--args", help = "命令参数", arity = 100)</span> String[] args)</span> {

        <span class="hljs-comment">// 构建请求并发送到服务端</span>
        <span class="hljs-type">CommandRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandRequest</span>(serviceName, Arrays.asList(args));
        <span class="hljs-keyword">return</span> httpClient.post(<span class="hljs-string">"/cli"</span>, request);
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> userService --args list</span>
user1, user2, user3
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> roleService --args <span class="hljs-built_in">users</span> admin</span>
role1, role2
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> systemService --args status</span>
系统正常运行
</code></pre>
<h4 data-id="heading-4">3. 服务端设计</h4>
<p>服务端提供统一接口 <code>/cli</code>，根据服务名动态分发：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/cli")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CliController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CommandRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> request.getService();
        String[] args = request.getArgs().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);

        <span class="hljs-comment">// 动态获取 Service Bean</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">serviceBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(serviceName);

        <span class="hljs-comment">// 执行命令</span>
        <span class="hljs-keyword">if</span> (serviceBean <span class="hljs-keyword">instanceof</span> CommandHandler handler) {
            <span class="hljs-keyword">return</span> handler.handle(args);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务未找到"</span>;
    }
}
</code></pre>
<h4 data-id="heading-5">4. 统一接口规范</h4>
<p>所有需要通过CLI调用的服务都必须实现 <code>CommandHandler</code> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommandHandler</span> {
    String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span>;
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"命令描述"</span>; }
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getUsage</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"使用说明"</span>; }
}
</code></pre>
<p>示例服务实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("userService")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> getUsage();

        <span class="hljs-keyword">switch</span> (args[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"list"</span>:
                <span class="hljs-keyword">return</span> listUsers(args.length &gt; <span class="hljs-number">1</span> ? args[<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"get"</span>:
                <span class="hljs-keyword">return</span> getUser(args[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未知命令: "</span> + args[<span class="hljs-number">0</span>];
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">listUsers</span><span class="hljs-params">(String type)</span> {
        <span class="hljs-comment">// 实现获取用户列表逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用户列表..."</span>;
    }
}
</code></pre>
<h2 data-id="heading-6">三、方案优势</h2>
<h4 data-id="heading-7"><strong>1. 客户端统一命令</strong></h4>
<ul>
<li>Shell 只需维护一条 <code>exec</code> 命令</li>
<li>新增服务无需修改客户端代码</li>
</ul>
<h4 data-id="heading-8"><strong>2. 服务端动态分发</strong></h4>
<ul>
<li>新增接口无需修改 CLI</li>
<li>统一接口入口便于权限控制与日志审计</li>
</ul>
<h4 data-id="heading-9"><strong>3. 易扩展</strong></h4>
<ul>
<li>支持任意参数数量、类型</li>
<li>可结合 OpenAPI 自动生成命令提示与帮助信息</li>
</ul>
<h4 data-id="heading-10"><strong>4. 逻辑解耦</strong></h4>
<ul>
<li>CLI 仅做命令解析和 HTTP 调用</li>
<li>业务逻辑完全在服务端</li>
</ul>
<h2 data-id="heading-11">四、安全控制</h2>
<h4 data-id="heading-12">1. 服务白名单</h4>
<p>通过配置文件限制可访问的服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">cli:</span>
  <span class="hljs-attr">allowed-services:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">userService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">roleService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">systemService</span>
</code></pre>
<h4 data-id="heading-13">2. 参数验证</h4>
<p>使用 Spring Validation 进行请求参数校验，防止恶意输入。</p>
<h4 data-id="heading-14">3. 访问日志</h4>
<p>记录所有CLI调用，便于审计和问题追踪：</p>
<pre><code class="hljs language-java" lang="java">logger.info(<span class="hljs-string">"CLI请求 - 服务: {}, 参数: {}, 来源: {}"</span>,
    serviceName, Arrays.toString(args), httpRequest.getRemoteAddr());
</code></pre>
<h2 data-id="heading-15">五、实际应用场景</h2>
<h4 data-id="heading-16">1. 运维场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看系统状态</span>
exec systemService --args status
<span class="hljs-meta prompt_">
# </span><span class="bash">重启服务</span>
exec serviceManager --args restart userService
<span class="hljs-meta prompt_">
# </span><span class="bash">查看日志</span>
exec logService --args tail 100 error
</code></pre>
<h4 data-id="heading-17">2. 调试场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看用户详情</span>
exec userService --args get 123
<span class="hljs-meta prompt_">
# </span><span class="bash">测试接口</span>
exec testService --args simulate /api/orders
<span class="hljs-meta prompt_">
# </span><span class="bash">清理缓存</span>
exec cacheService --args clear all
</code></pre>
<h4 data-id="heading-18">3. 批量操作</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">批量导入用户</span>
exec userService --args import users.csv
<span class="hljs-meta prompt_">
# </span><span class="bash">批量更新角色</span>
exec roleService --args batchUpdate role-mapping.json
</code></pre>
<h2 data-id="heading-19">六、扩展功能</h2>
<h4 data-id="heading-20">1. 交互增强</h4>
<ul>
<li>Tab 补全：自动补全服务名和参数</li>
<li>命令历史：保存执行历史，支持上下键浏览</li>
<li>颜色输出：不同类型信息使用不同颜色显示</li>
</ul>
<h4 data-id="heading-21">2. 结果格式化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResponse</span><span class="hljs-params">(String data)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.readValue(data, Object.class);
        <span class="hljs-keyword">return</span> objectMapper.writerWithDefaultPrettyPrinter()
                          .writeValueAsString(json);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> data;
    }
}
</code></pre>
<h4 data-id="heading-22">3. 脚本模式</h4>
<p>支持从文件执行命令序列：</p>
<pre><code class="hljs language-shell" lang="shell">exec script --args commands.txt
</code></pre>
<h2 data-id="heading-23">七、总结</h2>
<p>本文介绍的"通用命令+动态分发"方案，通过Spring Boot + Spring Shell构建，使用单一 exec 命令实现多服务动态调用，大幅简化了CLI系统的维护复杂度。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-cli
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南⑥：SharedWorker 用法全解析]]></title>    <link>https://juejin.cn/post/7583574154341072905</link>    <guid>https://juejin.cn/post/7583574154341072905</guid>    <pubDate>2025-12-14T19:52:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583574154341072905" data-draft-id="7576369868418875428" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南⑥：SharedWorker 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-14T19:52:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南⑥：SharedWorker 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T19:52:22.000Z" title="Sun Dec 14 2025 19:52:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前面的文章已经介绍了<code>postMessage</code>、<code>localStorage</code>、<code>messageChannel</code>、<code>broadcastChannel</code>以及<code>window.name</code>。今天要介绍一种“多页面协同”场景的工具——<strong>SharedWorker</strong>。</p>
<p>不同于普通Worker只能被单个页面独占，SharedWorker能被<strong>同一域名下的多个页面共享</strong>，实现高效的“多页面数据中枢”。本文就带你了解<strong>SharedWorker</strong>跨页面通讯的核心用法。</p>
<h2 data-id="heading-1">1. 什么是SharedWorker？</h2>
<p>在介绍SharedWorker之前，我们先回顾下Worker的基本概念：Worker是HTML5引入的后台线程机制，能让JavaScript在主线程之外运行，避免复杂计算阻塞页面渲染。而SharedWorker，顾名思义，是“可共享的Worker”，它有两个核心特点：</p>
<ul>
<li><strong>跨页面共享</strong>：同一域名下的多个标签页、iframe，甚至不同窗口，都能连接到同一个SharedWorker实例，实现数据互通。</li>
<li><strong>独立线程</strong>：运行在独立于所有页面主线程的后台线程中，既不会阻塞页面，也能统一处理多页面的请求。</li>
<li><strong>域名隔离</strong>：遵循同源策略，只有相同协议、域名、端口的页面，才能共享同一个SharedWorker。</li>
</ul>
<p>简单来说，SharedWorker就像一个“公共服务端”，多个页面作为“客户端”与之建立连接，通过它完成数据的传递与协同。和普通Worker的“一对一”模式不同，它是“一对多”的通讯方案。</p>
<h2 data-id="heading-2">2. SharedWorker如何实现跨页面通讯？</h2>
<p>SharedWorker的通讯原理可以概括为“<strong>单一实例+多端口连接</strong>”，先看一张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5bdd1f7e0e489583b6c564474e5108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=IoaS0x0QCyt2r4a0Icakl8QznFo%3D" alt="image.png" loading="lazy"/></p>
<p>具体流程是：</p>
<ol>
<li><strong>创建实例</strong>：每个页面通过<code>new SharedWorker('./share.js')</code>创建实例时，浏览器会启动一个SharedWorker后台线程，加载指定的脚本文件,这个脚本文件是共享。</li>
<li><strong>端口建立</strong>：每个页面连接到SharedWorker后，都会与Worker建立一个独立的“消息端口”（MessagePort），这是页面与Worker之间的通讯通道。</li>
<li><strong>数据传递</strong>：页面和Worker都是通过通过端口发送消息<code>port.postMessage</code>，都是通过<code>port.onmessage</code>接收数据进行处理，再通过端口将结果反馈给单个页面，或广播给所有连接的页面。</li>
<li><strong>实例销毁</strong>：当所有连接到SharedWorker的页面都关闭时，Worker后台线程才会被浏览器销毁，释放资源。</li>
</ol>
<p>说了这么多,接下来我们进行实践操作。</p>
<h2 data-id="heading-3">3. 实践案例</h2>
<p>SharedWorker的使用分为“Worker脚本”和“页面脚本”两部分，Worker脚本负责核心逻辑，页面脚本负责建立连接和收发消息。</p>
<p>实现需求：同一域名下的pageA和pageB页面，通过SharedWorker实现消息互发，且任意页面可以通过Worker广播消息给所有页面。</p>
<p>可以先看一张页面如何连接到Worker流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c87f6c4b75dc4e1f8b9d2b93d6c3bf81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=2gdOw5PK2ryQkADfhfM2X1rmgH8%3D" alt="image.png" loading="lazy"/></p>
<p>页面端我们只需要接收发送消息即可，Worker端我们需要收集注册的端口并进行逻辑处理，下面我们一步步来实现：</p>
<h3 data-id="heading-4">3.1 步骤1：编写SharedWorker核心脚本（share.js）</h3>
<p>share.js的核心逻辑：是使用Map结构，通过<code>connect</code>将所有连接Worker的页面进行收集端口，每个页面需要唯一的pageId用于后续私发消息。</p>
<p>页面发送数据分为三种，进入页面需要注册到share.js，发送广播消息，发送私信需要target页面的pageId。 数据如下：</p>

























<table><thead><tr><th>类型</th><th>用途</th><th>参数</th></tr></thead><tbody><tr><td><code>register</code></td><td>页面注册</td><td><code>pageId</code></td></tr><tr><td><code>broadcast</code></td><td>广播消息</td><td><code>pageId</code>, <code>data</code></td></tr><tr><td><code>private</code></td><td>点对点消息</td><td><code>pageId</code>, <code>target</code>, <code>data</code></td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册页面</span>
port.<span class="hljs-title function_">postMessage</span>({                                              
    <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,                                           
    <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>                                          
});                                                            
<span class="hljs-comment">// 发送广播                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,                                          
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello everyone!'</span>                                     
});                                                             
<span class="hljs-comment">// 发送私信                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,                                            
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hi page-456!'</span>                                        
}); 
</code></pre>
<p>share.js脚本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 存储所有页面与Worker的连接端口（使用 Map，key 是 pageId，value 是 port）</span>
<span class="hljs-keyword">const</span> connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打印***self'</span>, self)
<span class="hljs-comment">// 监听新页面的连接请求</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 获取当前页面的通讯端口</span>
    <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 注意：此时还不知道 pageId，需要等待 register 消息</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`新页面尝试连接，等待注册...`</span>);

    <span class="hljs-comment">// 允许端口通讯</span>
    port.<span class="hljs-title function_">start</span>();

    <span class="hljs-comment">// 向页面发送连接成功消息（用于调试）</span>
    port.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'connected'</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-string">`Worker 已连接，当前连接数：<span class="hljs-subst">${connections.size}</span>`</span>
    });

    <span class="hljs-comment">// 监听端口的消息事件（接收页面发来的消息）</span>
    port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker收到消息:'</span>, msg.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">const</span> { type, target, data, pageId } = msg.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 0. 处理注册消息（页面连接时立即发送）</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'register'</span>) {
            <span class="hljs-comment">// 如果该 pageId 已存在，说明是页面刷新，先关闭旧连接</span>
            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(pageId)) {
                <span class="hljs-keyword">const</span> oldPort = connections.<span class="hljs-title function_">get</span>(pageId);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 刷新，清理旧连接`</span>);
                <span class="hljs-keyword">try</span> {
                    oldPort.<span class="hljs-title function_">close</span>();
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-comment">// 忽略关闭错误</span>
                }
            }

            <span class="hljs-comment">// 保存新连接</span>
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>,connections);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 保存页面标识到端口对象（兼容旧的发送方式）</span>
        <span class="hljs-keyword">if</span> (pageId &amp;&amp; !port.<span class="hljs-property">pageId</span>) {
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册（兼容模式）`</span>);
        }

        <span class="hljs-comment">// 1. 广播消息：发送给所有连接的页面</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'broadcast'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`广播消息给 <span class="hljs-subst">${connections.size}</span> 个连接`</span>);
            connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">conn, id</span>) =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    conn.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`广播消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${id}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(id);
                }
            });
        }
        <span class="hljs-comment">// 2. 点对点消息：仅发送给目标页面（这里用页面标识区分）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'private'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`私发消息给 <span class="hljs-subst">${target}</span>，当前连接：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);

            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(target)) {
                <span class="hljs-keyword">try</span> {
                    connections.<span class="hljs-title function_">get</span>(target).<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`私发消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${target}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(target);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`警告：未找到目标页面 <span class="hljs-subst">${target}</span>`</span>);
            }
        }
    };

    <span class="hljs-comment">// 监听端口关闭事件（页面关闭或主动断开）</span>
    port.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 通过 pageId 删除连接</span>
        <span class="hljs-keyword">if</span> (port.<span class="hljs-property">pageId</span>) {
            connections.<span class="hljs-title function_">delete</span>(port.<span class="hljs-property">pageId</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${port.pageId}</span> 断开连接，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);
        }
    });

    <span class="hljs-comment">// 允许端口通讯（必须调用，否则无法收发消息）</span>
    port.<span class="hljs-title function_">start</span>();
});

</code></pre>
<h3 data-id="heading-5">3.2 步骤二：编写页面脚本（pageA.html 和 pageB.html）</h3>
<p>代码逻辑如下：唯一需要区别的是<code>pageId</code>，页面B只需将<code>pageId</code>改为<code>page-456</code>，并调整“发给页面B”按钮的逻辑为“发给页面A”即可。</p>
<p>页面的创建流程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> 页面创建 <span class="hljs-title class_">SharedWorker</span> 实例
   ↓
<span class="hljs-number">2.</span> 调用 port.<span class="hljs-title function_">start</span>() 启动通信
   ↓
<span class="hljs-number">3.</span> 注册 onmessage 监听器
   ↓
<span class="hljs-number">4.</span> 发送 register 消息（携带 pageId）
   ↓
<span class="hljs-number">5.</span> <span class="hljs-title class_">Worker</span> 保存连接到 <span class="hljs-title class_">Map</span>: connections.<span class="hljs-title function_">set</span>(pageId, port)
   ↓
<span class="hljs-number">6.</span> 页面可以开始发送/接收消息
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>页面A（标识：page-123）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"msgInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendBroadcast()"</span>&gt;</span>广播消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendToPageB()"</span>&gt;</span>发给页面B<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"log"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 页面唯一标识</span>
        <span class="hljs-keyword">const</span> pageId = <span class="hljs-string">'page-123'</span>;
        <span class="hljs-comment">// 1. 创建SharedWorker实例，指定Worker脚本路径</span>
        <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'./share.js'</span>);
        <span class="hljs-comment">// 2. 获取与Worker的通讯端口</span>
        <span class="hljs-keyword">const</span> port = worker.<span class="hljs-property">port</span>;

        <span class="hljs-comment">// 3. 允许端口通讯（必须在监听器之前调用）</span>
        port.<span class="hljs-title function_">start</span>();

        <span class="hljs-comment">// 4. 监听Worker发来的消息（使用onmessage更可靠）</span>
        port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面A收到消息:'</span>, msg.<span class="hljs-property">data</span>);
            <span class="hljs-keyword">const</span> log = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'log'</span>);
            log.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;p&gt;收到：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(msg.data)}</span>&lt;/p&gt;`</span>;
        };

        <span class="hljs-comment">// 5. 连接成功后立即发送注册消息</span>
        port.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,
            <span class="hljs-attr">pageId</span>: pageId
        });

        <span class="hljs-comment">// 发送广播消息</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendBroadcast</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 发送点对点消息给页面B（页面B标识为page-456）</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToPageB</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 页面关闭时断开连接</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
            port.<span class="hljs-title function_">close</span>();
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-6">3.3 实际调试</h3>
<h4 data-id="heading-7">3.3.1 如何调试share.js</h4>
<p>通过Chrome如何查看share.js中打印的数据，页面是无法访问的，因为它是独立的控制台。</p>
<p>为什么控制台要独立？这是因为SharedWorker运行在与页面主线程完全隔离的独立线程中，从浏览器架构和安全设计出发，其控制台输出也需与页面线程分离，避免线程间的信息干扰。</p>
<p>打开步骤：</p>
<ol>
<li>在Chrome浏览器中直接访问地址：<code>chrome://inspect/#workers</code>；</li>
<li>页面会列出当前浏览器中所有运行的Worker实例，找到目标SharedWorker对应的“inspect”链接并点击，即可打开专属控制台。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0367fedb6578405488845baad6207d68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=670jd6YcO%2BHlhidyWmF42YmSoAI%3D" alt="image.png" loading="lazy"/></p>
<p>控制台打印：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55752a2673c6447f9641aeb5c2b200fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=GVYG7J6L97MBleOUS4skIH8LGrE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">3.3.2 页面发送广播或私发消息</h4>
<ol>
<li>将share.js、pageA.html、pageB.html部署到同一域名下（本地可用live-server启动）。</li>
<li>同时打开两个页面，在页面A输入消息并点击“广播消息”，两个页面都会收到Worker转发的消息。</li>
<li>点击“发给页面B”，只有页面B会收到消息，实现点对点通讯。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a0ca92941294eba87d97406014ae91c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=1UF5PPl%2F2pG4t1Ao%2F1AmoQCgCDg%3D" alt="image.png" loading="lazy"/></p>
<p>页面关闭，自动销毁</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49f7ef884184332bde92a850938643d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=gkhJqsST35sAFd6YZWLwtxwFeIc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">4、SharedWorker的注意事项</h2>
<h3 data-id="heading-10">4.1 同源策略限制严格</h3>
<p>SharedWorker的同源限制比普通Worker更严格：<strong>协议、域名、端口必须完全一致</strong>，即使是子域名（如a.example.com和b.example.com）也无法共享。</p>
<h3 data-id="heading-11">4.2 必须部署才能运行，本地直接打开无效</h3>
<p>由于浏览器的安全限制，直接双击本地HTML文件（file://协议）创建SharedWorker会报错。必须通过HTTP/HTTPS协议部署，本地可使用live-server、http-server等工具启动服务。</p>
<h3 data-id="heading-12">4.3 端口通讯需“双向启动”</h3>
<p>页面端和Worker端的<code>port.start()</code>必须都调用，否则无法正常收发消息。尤其是在使用<code>addEventListener</code>绑定消息事件时，这一步不能省略（若用<code>onmessage</code>属性绑定，部分浏览器会自动启动，但建议统一调用start()）。</p>
<h3 data-id="heading-13">4.4 消息数据需可序列化</h3>
<p>通过port传递的消息数据，必须是可结构化克隆的类型（如对象、数组、字符串等），不能传递函数、DOM元素等不可序列化的数据。若需传递复杂数据，可先转为JSON字符串，接收后再解析。</p>
<h2 data-id="heading-14">5. 总结</h2>
<p>最后总结一下：<code>SharedWorker</code>是一个能被同源多页面共享的后台线程，它通过“单一实例+管理多端口”的模式，实现跨页面通信与数据协同。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌掀桌子：Gemini Deep Research 让深度思考进入白菜价时代]]></title>    <link>https://juejin.cn/post/7583234966635298850</link>    <guid>https://juejin.cn/post/7583234966635298850</guid>    <pubDate>2025-12-14T15:14:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635298850" data-draft-id="7583234966635282466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌掀桌子：Gemini Deep Research 让深度思考进入白菜价时代"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-14T15:14:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌掀桌子：Gemini Deep Research 让深度思考进入白菜价时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:14:27.000Z" title="Sun Dec 14 2025 15:14:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有这种感觉：现在的 AI 聊天机器人，像极了一个急于表现的抢答选手。你刚把问题抛出去，还没等气口喘匀，它就急吼吼地扔回来一段看似通顺实则经不起推敲的答案。</p>
<p>这就是传统 RAG（检索增强生成）的通病——线性的、一次性的、浅尝辄止的。</p>
<p>但谷歌刚刚发布的 Gemini Deep Research Agent，似乎打算终结这个“抢答时代”。这不仅仅是一个新模型，更像是谷歌在 AI 工业化进程中投下的一枚深水炸弹。基于 Gemini 3 Pro 构建，这个智能体不只是在回答问题，它在真正地“做研究”。</p>
<p>更重要的是，谷歌这次直接把矛头对准了成本。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasfdsvg-1024x950.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asfdsvg-1024x950.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5637d5ebb8840a0a969163017a87834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766330066&amp;x-signature=C3wwXBbl3Xg1xpc19APtcivPsJ8%3D" alt="asfdsvg" loading="lazy"/></a></p>
<p><strong>慢思考的胜利：像人类一样做调研</strong></p>
<p>如果不谈技术名词，Gemini Deep Research 最大的突破在于它模拟了人类研究员的工作流。</p>
<p>想象一下你让实习生去调研“2025年合成生物学在护肤品领域的应用趋势”。如果这名实习生只是去百度搜一下然后把前三条结果复制给你，你肯定会发火。你期望的是：他先拆解问题，制定搜索计划，阅读十几篇长篇报告，发现数据冲突时再去验证，最后整理出一份带引用的分析报告。</p>
<p>Gemini Deep Research 做的就是这件事。</p>
<p>它引入了“迭代式研究规划”。收到指令后，它不会立刻作答，而是先规划子任务。它会进行多轮、多跳的深度搜索，阅读长篇 PDF，甚至在发现知识缺口时自我纠正。</p>
<p>这种“慢思考”带来的质量提升是肉眼可见的。在专门衡量深度研究能力的 DeepSearchQA 基准测试中，它拿下了 66.1% 的高分。而在那个著名的、旨在难倒 AI 的“Humanity’s Last Exam (HLE)”测试集中，它达到了 46.4%。作为对比，业界公认的强手 GPT-5 Pro 在同类测试中的表现约为 38.9%。</p>
<p><strong>不仅仅是强，而是便宜得吓人</strong></p>
<p>性能强悍固然重要，但真正让开发者和企业主眼红的，是谷歌抛出的成本论断。</p>
<p>深度推理通常意味着昂贵的 Token 消耗。此前的 o1 或 GPT-5 级别模型，每一次“深度思考”都在燃烧预算。但根据谷歌产品经理的透露，Gemini Deep Research 在提供与 GPT-5 Pro 相当甚至更优的报告质量时，成本仅为后者的十分之一左右。</p>
<p>虽然目前市场上还没有公开的第三方账单对比来实锤这个“1/10”，但如果谷歌真能做到将高算力任务的成本压缩一个数量级，这就意味着过去只敢用在金融尽调、药物研发等高价值场景的“AI 深度研究”，现在可以下放到普通的内容创作、市场分析甚至个人助理场景中。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsaffbgfgh-1024x581.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/saffbgfgh-1024x581.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c2d25627328441f9b5256accb55485d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766330066&amp;x-signature=sfumonBeWlEekdNWvLix5vhIYwQ%3D" alt="saffbgfgh" loading="lazy"/></a></p>
<p>这是从“奢侈品”到“日用品”的跨越。</p>
<p><strong>开发者的福音：Interactions API</strong></p>
<p>对于在座的程序员朋友来说，这次发布还有一个更实际的利好：Interactions API。</p>
<p>以前要构建一个能跑十几分钟、中间不断调用搜索工具的 Agent，你需要自己在客户端维护一堆复杂的状态，处理各种断连和上下文丢失的噩梦。</p>
<p>现在，谷歌把这些脏活累活揽到了服务器端。通过新的 API，支持异步后台执行。你把任务扔给它，就可以断开连接去喝咖啡，等它跑完那复杂的 5 到 15 分钟思考过程，再回来取结果。甚至，你还可以通过流式传输看到它的“内心独白”——看着它如何规划、如何纠结、如何修正路线，这本身就是一种极好的调试体验。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsdefsdgfh-763x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sdefsdgfh-763x1024.webp" ref="nofollow noopener noreferrer"><img src="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sdefsdgfh-763x1024.webp" alt="sdefsdgfh" loading="lazy"/></a></p>
<p><strong>写在最后</strong></p>
<p>Gemini Deep Research 的出现，标志着 AI 应用正在从“对话框”走向“工作台”。</p>
<p>它不再是一个陪你聊天的伙伴，而是一个能够独立承担长周期任务的初级员工。虽然它依然会有延迟，依然需要人类专家进行最后的把关（Human-in-the-loop），但它已经能够交出一份完成度 80% 且带有详实引用的研究草稿。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fwasfsdgfg-1024x574.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/wasfsdgfg-1024x574.webp" ref="nofollow noopener noreferrer"><img src="https://blog.worldcodeing.com/wp-content/uploads/2025/12/wasfsdgfg-1024x574.webp" alt="wasfsdgfg" loading="lazy"/></a></p>
<p>在这个时间节点，谷歌用开源基准测试 DeepSearchQA 和激进的定价策略，向 OpenAI 发起了一次漂亮的侧翼包抄。对于我们使用者而言，神仙打架，凡人受益，深度思考白菜价的时代，可能真的来了。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在重复下载资源？HTTP 缓存让二次访问 “零请求”，用户体验翻倍]]></title>    <link>https://juejin.cn/post/7583215836690890793</link>    <guid>https://juejin.cn/post/7583215836690890793</guid>    <pubDate>2025-12-14T15:17:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583215836690890793" data-draft-id="7583215836690874409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在重复下载资源？HTTP 缓存让二次访问 “零请求”，用户体验翻倍"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-12-14T15:17:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PineappleCoder"/> <meta itemprop="url" content="https://juejin.cn/user/3323167184272627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在重复下载资源？HTTP 缓存让二次访问 “零请求”，用户体验翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323167184272627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PineappleCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:17:21.000Z" title="Sun Dec 14 2025 15:17:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 性能优化的“节流大师”：HTTP 缓存机制，让你的网站快到飞起！</h2>
<blockquote>
<p><strong>前端性能优化专栏 - 第五篇</strong></p>
</blockquote>
<p>在上一篇中，我们学会了如何利用<strong>资源提示符</strong>（Resource Hints）让浏览器“未卜先知”，提前准备资源。但如果用户已经访问过我们的网站，我们还能不能更快？当然可以！</p>
<p>今天，我们要聊的是前端性能优化的终极“节流大师”——<strong>HTTP 缓存机制</strong>。它的核心目标是<strong>复用资源、减少延迟、节省带宽</strong>，让用户在二次访问时，几乎可以瞬间打开页面。</p>
<hr/>
<h3 data-id="heading-1">⚠️ 缓存机制的运行原理</h3>
<p>HTTP 缓存就像是浏览器给自己准备的一个“百宝箱”。浏览器在请求资源前，会先检查这个百宝箱。</p>
<p>整个缓存机制由一系列 HTTP 头字段（如 <code>Cache-Control</code>、<code>Expires</code>、<code>ETag</code>、<code>Last-Modified</code>）共同决定，并可分为<strong>强缓存</strong>与<strong>协商缓存</strong>两大类。</p>
<ul>
<li>
<p><strong>首次请求：</strong> 服务器提供资源及缓存策略。</p>
</li>
<li>
<p><strong>再次访问：</strong> 浏览器依据策略决定是否使用缓存。</p>
<ul>
<li><strong>命中强缓存</strong> → 无需请求服务器，直接使用本地资源。</li>
<li><strong>命中协商缓存</strong> → 向服务器发送验证请求，确认资源是否可用。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5075b06a1b2a4a3c84989365a7244240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766330241&amp;x-signature=qVA7yzJYuiD7PHrouX11bChNQVQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">✨ 强缓存机制：最快的“秒开”体验</h3>
<p><strong>强缓存</strong>是性能优化的最高境界。当缓存未过期时，浏览器<strong>直接使用本地资源</strong>，<strong>无需发送任何网络请求</strong>。</p>
<h4 data-id="heading-3">核心字段：Cache-Control 与 Expires</h4>
<p>强缓存主要依赖两个 HTTP 头部字段：<code>Cache-Control</code>（HTTP/1.1 规范）和 <code>Expires</code>（HTTP/1.0 规范）。</p>
<p><strong>优先级：</strong> <code>Cache-Control</code> <strong>&gt;</strong> <code>Expires</code></p>
<h5 data-id="heading-4">Cache-Control 指令：现代缓存的“指挥官”</h5>
<p><code>Cache-Control</code> 提供了更灵活、更强大的缓存控制能力：</p>








































<table><thead><tr><th>指令</th><th>含义</th><th>场景</th></tr></thead><tbody><tr><td><code>max-age=31536000</code></td><td>缓存有效期（秒），例如缓存一年</td><td>静态资源</td></tr><tr><td><code>public</code></td><td>允许代理服务器和浏览器缓存</td><td>所有人可见的资源</td></tr><tr><td><code>private</code></td><td>仅允许用户浏览器缓存</td><td>包含用户信息的资源</td></tr><tr><td><code>no-cache</code></td><td><strong>不使用强缓存</strong>，进入协商缓存阶段</td><td>主入口文件（如 <code>index.html</code>）</td></tr><tr><td><code>no-store</code></td><td><strong>完全禁用缓存</strong>，每次都从服务器获取</td><td>敏感或动态数据</td></tr><tr><td><code>immutable</code></td><td>资源永久不变，浏览器无需重新验证</td><td>带版本号的静态资源</td></tr></tbody></table>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 最佳实践：版本化静态资源</span>
Cache-Control：<span class="hljs-keyword">public</span>, max-age=<span class="hljs-number">31536000</span>, immutable
</code></pre>
<p>✅ <strong>应用场景：</strong> 带有版本号的静态资源（如 <code>app.v1.js</code>、<code>logo.v2.png</code>），一旦文件内容改变，版本号也会变，从而绕过强缓存。</p>
<h5 data-id="heading-5">Expires 头部字段：过时的“日历”</h5>
<ul>
<li><strong>格式：</strong> <code>Expires: Tue, 09 Nov 2024 21:09:28 GMT</code></li>
<li><strong>问题：</strong> 指定<strong>绝对过期时间</strong>，但它依赖于客户端本地时间。如果用户修改了本地时间，就可能出现<strong>时钟误差</strong>，导致缓存失效或误用。</li>
</ul>
<p>⚠️ <strong>注意：</strong> 在现代 Web 中，<code>Expires</code> 已被 <code>Cache-Control</code> 替代。当两者同时存在时，<code>Cache-Control</code> 优先级更高。</p>
<h3 data-id="heading-6">🔄 协商缓存机制：谨慎的“验证官”</h3>
<p>当强缓存失效（过期）或被禁用（<code>Cache-Control: no-cache</code>）后，浏览器会进入<strong>协商缓存</strong>阶段。</p>
<p>此时，浏览器会<strong>向服务器发送验证请求</strong>，服务器根据资源状态决定是返回缓存还是新内容：</p>
<ul>
<li><strong>304 Not Modified</strong> → 资源未修改，浏览器使用本地缓存。</li>
<li><strong>200 OK</strong> → 资源已修改，服务器返回新内容。</li>
</ul>
<h4 data-id="heading-7">Last-Modified / If-Modified-Since：基于时间的验证</h4>
<p>这是最原始的协商缓存方式：</p>
<ol>
<li><strong>服务器响应：</strong> 附带资源最后修改时间：<code>Last-Modified: Mon, 10 Nov 2025 12:00:00 GMT</code></li>
<li><strong>浏览器请求：</strong> 再次请求时，携带：<code>If-Modified-Since: Mon, 10 Nov 2025 12:00:00 GMT</code></li>
<li><strong>服务器比较：</strong> 如果资源未修改，返回 <code>304 Not Modified</code>。</li>
</ol>
<p>⚠️ <strong>缺点：</strong> 只能精确到秒。如果在 1 秒内资源被修改了多次，或者服务器时间与文件系统时间不一致，可能导致<strong>误判</strong>。</p>
<h4 data-id="heading-8">ETag / If-None-Match：基于指纹的验证</h4>
<p><code>ETag</code>（Entity Tag）是资源的<strong>唯一指纹</strong>或<strong>内容的哈希值</strong>，是更精确的验证方式：</p>
<ol>
<li><strong>服务器响应：</strong> 附带资源指纹：<code>ETag: "filehash123"</code></li>
<li><strong>浏览器请求：</strong> 再次请求时，携带：<code>If-None-Match: "filehash123"</code></li>
<li><strong>服务器比较：</strong> 比较哈希值，如果一致，返回 <code>304 Not Modified</code>。</li>
</ol>
<p>✅ <strong>优点：</strong> <strong>精度更高</strong>，解决了 <code>Last-Modified</code> 的时间误差问题。 <strong>优先级：</strong> <code>ETag</code> <strong>高于</strong> <code>Last-Modified</code>。</p>
<h3 data-id="heading-9">🔧 Service Worker：可编程的缓存策略</h3>
<p>HTTP 缓存是<strong>被动</strong>的，它依赖于服务器的 HTTP 头部配置。而 <strong>Service Worker</strong> 则提供了一种<strong>主动、可编程</strong>的缓存方案。</p>
<p>Service Worker 是一个独立于网页运行的后台脚本，它可以<strong>拦截网络请求</strong>，并结合 Cache API 实现完全自定义的缓存逻辑，从而实现<strong>离线访问</strong>与<strong>动态缓存更新</strong>。</p>
<p>Service Worker 常见的缓存策略：</p>





























<table><thead><tr><th>策略名称</th><th>核心逻辑</th><th>优势</th><th>典型适用场景</th></tr></thead><tbody><tr><td><strong>Network First</strong></td><td>先请求网络 → 网络失败则用缓存</td><td>优先获取最新内容，离线有兜底</td><td>新闻列表、动态数据（需最新）</td></tr><tr><td><strong>Cache First</strong></td><td>先读缓存 → 缓存无则请求网络并更新缓存</td><td>加载速度快，减少网络请求</td><td>静态资源（图片、CSS、JS）</td></tr><tr><td><strong>Stale-While-Revalidate</strong></td><td>先返回缓存旧资源 → 后台请求更新缓存</td><td>速度快，兼顾资源新鲜度</td><td>用户头像、非核心静态资源</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0088b1c5b814781a09c486523a16d80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766330241&amp;x-signature=i1cloB53ea2O7wgsl%2Bs0nT30PDA%3D" alt="Service Worker 示意图" loading="lazy"/></p>
<h3 data-id="heading-10">✅ 最佳实践：缓存策略的“组合拳”</h3>
<p>合理的缓存策略是性能优化的基石，我们应该根据资源的特性，打出“组合拳”：</p>
<ol>
<li>
<p><strong>静态资源（带版本号）：</strong> 采用最强缓存。</p>
<ul>
<li><code>Cache-Control：max-age=31536000, immutable</code></li>
</ul>
</li>
<li>
<p><strong>主入口文件（如 index.html）：</strong> 禁用强缓存，启用协商缓存。</p>
<ul>
<li><code>Cache-Control：no-cache</code> (确保每次都能获取最新的 HTML，从而加载最新的 JS/CSS 版本)</li>
</ul>
</li>
<li>
<p><strong>动态数据（API）：</strong> 按业务灵活配置。</p>
<ul>
<li>敏感数据：<code>no-store</code></li>
<li>可容忍延迟数据：<code>max-age</code></li>
</ul>
</li>
<li>
<p><strong>离线与复杂策略：</strong> 使用 <strong>Service Worker</strong> 实现更高级的缓存控制。</p>
</li>
</ol>
<hr/>
<p><strong>下一篇预告：</strong> 缓存解决了“二次访问”的速度问题，但对于全球用户来说，“首次访问”的速度依然依赖于物理距离。下一篇我们将探讨如何利用<strong>内容分发网络（CDN）</strong> ，将资源部署到离用户最近的地方，实现真正的全球加速！敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】定点出击！鸿蒙6.0视频碰一碰流转+实时进度同步案例]]></title>    <link>https://juejin.cn/post/7583576605780901934</link>    <guid>https://juejin.cn/post/7583576605780901934</guid>    <pubDate>2025-12-14T15:34:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780901934" data-draft-id="7583567658253647898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】定点出击！鸿蒙6.0视频碰一碰流转+实时进度同步案例"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-14T15:34:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】定点出击！鸿蒙6.0视频碰一碰流转+实时进度同步案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:34:32.000Z" title="Sun Dec 14 2025 15:34:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们抄家伙！今天V哥要用鸿蒙6.0的分布式能力撕碎视频跨设备流转的防线！目标：手机碰一下车机/平板，视频秒级切换+进度毫秒级同步，全程零手动干预！以下基于HarmonyOS 6.0（API 21）的ArkTS实战核弹代码已就位👇</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">🔥 一、技术架构：分布式视频作战链</h3>
<p><strong>核心武器库</strong>：</p>
<ul>
<li><strong>碰一碰触发</strong>：NFC+分布式设备管理（<code>@ohos.distributedDeviceManager</code>）</li>
<li><strong>进度同步引擎</strong>：AVSession Kit（<code>@kit.AVSessionKit</code>）</li>
<li><strong>数据传输通道</strong>：分布式软总线（极简协议+双轮驱动）</li>
</ul>
<p><strong>作战流程</strong>：</p>
<ol>
<li>NFC触碰自动发现设备 → 2. 分布式软总线建立低延迟通道 → 3. AVSession同步播放状态与进度 → 4. 车机/平板无缝续播</li>
</ol>
<hr/>
<h3 data-id="heading-1">⚡ 二、四步闪电战代码实操</h3>
<h4 data-id="heading-2"><strong>步骤1：碰一碰触发与设备连接</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 手机端：监听NFC触碰并连接目标设备  </span>
<span class="hljs-keyword">import</span> { nfc } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.nfc'</span>;  
<span class="hljs-keyword">import</span> { distributedDeviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.distributedDeviceManager'</span>;  

<span class="hljs-keyword">const</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.vvideo'</span>);  
<span class="hljs-comment">// NFC触碰回调  </span>
nfc.<span class="hljs-title function_">on</span>(<span class="hljs-string">'tagDiscovered'</span>, <span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> {  
  <span class="hljs-keyword">if</span> (tag.<span class="hljs-property">type</span> === nfc.<span class="hljs-property">NFC_TYPE_A</span>) {  
    <span class="hljs-keyword">const</span> targetDevice = deviceManager.<span class="hljs-title function_">getTrustedDeviceListSync</span>();  
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">establishVideoPipeline</span>(targetDevice.<span class="hljs-property">networkId</span>);  
  }  
});  

<span class="hljs-comment">// 建立分布式视频管道  </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">establishVideoPipeline</span>(<span class="hljs-params">networkId: <span class="hljs-built_in">string</span></span>) {  
  <span class="hljs-keyword">const</span> connectOption = {  
    <span class="hljs-attr">deviceNetworkId</span>: networkId,  
    <span class="hljs-attr">isEncrypted</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 启用传输加密  </span>
    <span class="hljs-attr">priority</span>: distributedDeviceManager.<span class="hljs-property">ConnectPriority</span>.<span class="hljs-property">HIGH</span>  <span class="hljs-comment">// 高优先级  </span>
  };  
  <span class="hljs-keyword">await</span> deviceManager.<span class="hljs-title function_">connectTargetDevice</span>(connectOption);  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🎬 视频作战通道已建立！"</span>);  
}  
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li>碰一碰依赖设备亮屏、解锁且开启华为分享服务</li>
<li>分布式软总线通过极简协议提升有效带宽20%，实现流式传输</li>
</ul>
<h4 data-id="heading-3"><strong>步骤2：AVSession同步播放状态与进度</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 手机端：创建媒体会话并同步状态  </span>
<span class="hljs-keyword">import</span> { avSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;  

<span class="hljs-comment">// 1. 创建AVSession控制器  </span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">session</span>: avSession.<span class="hljs-property">AVSession</span>;  
<span class="hljs-keyword">private</span> <span class="hljs-attr">aVCastController</span>: avSession.<span class="hljs-property">AVCastController</span>;  

<span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVSession</span>(<span class="hljs-params">videoUrl: <span class="hljs-built_in">string</span>, currentPosition: <span class="hljs-built_in">number</span></span>) {  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span> = <span class="hljs-keyword">await</span> avSession.<span class="hljs-title function_">createAVSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">'video_cast'</span>, <span class="hljs-string">'VIDEO'</span>);  
  <span class="hljs-comment">// 2. 设置播放元数据  </span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">metadata</span>: avSession.<span class="hljs-property">AVMetadata</span> = {  
    <span class="hljs-attr">title</span>: <span class="hljs-string">'V哥实战教程'</span>,  
    <span class="hljs-attr">artist</span>: <span class="hljs-string">'HarmonyOS 6.0'</span>,  
    <span class="hljs-attr">duration</span>: <span class="hljs-number">1200000</span> <span class="hljs-comment">// 总时长（毫秒）  </span>
  };  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">setAVMetadata</span>(metadata);  

  <span class="hljs-comment">// 3. 同步播放状态到车机  </span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">playbackState</span>: avSession.<span class="hljs-property">AVPlaybackState</span> = {  
    <span class="hljs-attr">state</span>: avSession.<span class="hljs-property">PlaybackState</span>.<span class="hljs-property">PLAYBACK_STATE_PLAYING</span>,  
    <span class="hljs-attr">speed</span>: <span class="hljs-number">1.0</span>,  
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">elapsedTime</span>: currentPosition, <span class="hljs-attr">updateTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() }  
  };  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">setAVPlaybackState</span>(playbackState);  

  <span class="hljs-comment">// 4. 获取投播控制器  </span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">aVCastController</span> = <span class="hljs-keyword">await</span> avSession.<span class="hljs-title function_">getAVCastController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>.<span class="hljs-property">sessionId</span>);  
}  

<span class="hljs-comment">// 实时进度同步（每500ms发送一次）  </span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {  
  <span class="hljs-keyword">const</span> currentPos = videoPlayer.<span class="hljs-title function_">getCurrentPosition</span>();  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">aVCastController</span>.<span class="hljs-title function_">setAVPlaybackState</span>({  
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">elapsedTime</span>: currentPos, <span class="hljs-attr">updateTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() }  
  });  
}, <span class="hljs-number">500</span>);  
</code></pre>
<p><strong>关键机制</strong>：</p>
<ul>
<li><code>AVSession</code> 通过会话ID跨设备识别同一媒体内容</li>
<li><code>position</code> 字段包含时间戳，自动补偿网络延迟</li>
</ul>
<h4 data-id="heading-4"><strong>步骤3：车机端实时接收与续播</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 车机端：监听AVSession状态变化  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoReceiver</span> {  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">remoteSession</span>: avSession.<span class="hljs-property">AVSession</span>;  

  <span class="hljs-comment">// 1. 注册会话监听器  </span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initSessionListener</span>(<span class="hljs-params"/>) {  
    avSession.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sessionCreate'</span>, <span class="hljs-function">(<span class="hljs-params">session</span>) =&gt;</span> {  
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteSession</span> = session;  
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">syncPlayback</span>();  
    });  
  }  

  <span class="hljs-comment">// 2. 同步播放进度  </span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">syncPlayback</span>(<span class="hljs-params"/>) {  
    <span class="hljs-keyword">const</span> playbackState = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteSession</span>.<span class="hljs-title function_">getAVPlaybackState</span>();  
    <span class="hljs-keyword">const</span> videoUrl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteSession</span>.<span class="hljs-title function_">getAVMetadata</span>().<span class="hljs-property">assetId</span>;  
    
    <span class="hljs-comment">// 精准续播（补偿网络延迟）  </span>
    <span class="hljs-keyword">const</span> networkDelay = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - playbackState.<span class="hljs-property">position</span>.<span class="hljs-property">updateTime</span>;  
    <span class="hljs-keyword">const</span> actualPosition = playbackState.<span class="hljs-property">position</span>.<span class="hljs-property">elapsedTime</span> + networkDelay;  
    
    videoPlayer.<span class="hljs-title function_">init</span>({  
      <span class="hljs-attr">source</span>: videoUrl,  
      <span class="hljs-attr">startTime</span>: actualPosition <span class="hljs-comment">// 从同步进度开始播放  </span>
    });  
    videoPlayer.<span class="hljs-title function_">play</span>();  
  }  
}  
</code></pre>
<p><strong>抗延迟策略</strong>：</p>
<ul>
<li>通过 <code>updateTime</code> 计算网络延迟，动态调整起始播放点</li>
<li>分布式软总线的双轮驱动机制减少传输抖动</li>
</ul>
<h4 data-id="heading-5"><strong>步骤4：双向控制与异常处理</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 手机/车机双向控制示例  </span>
<span class="hljs-comment">// 车机端暂停 → 手机端同步暂停  </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">remoteSession</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {  
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">state</span> === avSession.<span class="hljs-property">PlaybackState</span>.<span class="hljs-property">PLAYBACK_STATE_PAUSED</span>) {  
    videoPlayer.<span class="hljs-title function_">pause</span>();  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">aVCastController</span>.<span class="hljs-title function_">setAVPlaybackState</span>(state); <span class="hljs-comment">// 状态回传  </span>
  }  
});  

<span class="hljs-comment">// 异常处理（网络中断自动重连）  </span>
deviceManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'deviceOffline'</span>, <span class="hljs-function">(<span class="hljs-params">device</span>) =&gt;</span> {  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设备断联！启动重连机制..."</span>);  
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">establishVideoPipeline</span>(device.<span class="hljs-property">networkId</span>);  
});  
</code></pre>
<hr/>
<h3 data-id="heading-6">🛡️ 三、战场应急预案（错误码实战）</h3>

























<table><thead><tr><th>错误码</th><th>敌情描述</th><th>反击战术</th></tr></thead><tbody><tr><td>6600101</td><td>会话服务异常</td><td>重启AVSession并重新同步进度</td></tr><tr><td>13900011</td><td>设备连接超时</td><td>启用蓝牙Bypass通道降级重连</td></tr><tr><td>5400103</td><td>音频设备占用</td><td>强制释放资源+优先级抢占</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">📊 四、实战效能报告</h3>
<ul>
<li><strong>流转速度</strong>：碰一碰到车机播放 &lt;1.5秒（实测华为Mate 60 Pro + 问界M9）</li>
<li><strong>进度同步误差</strong>：&lt;200ms（分布式软总线抗抖动优化）</li>
<li><strong>稳定性</strong>：30分钟连续播放进度漂移 &lt;0.5秒</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af107b39288d4ed6a95db377c550f8f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766331271&amp;x-signature=mE1pzVqOsoglhhoIgbHZAu4TtV4%3D" alt="卷二_副本.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows如何自定义任何窗口置顶]]></title>    <link>https://juejin.cn/post/7583574154340777993</link>    <guid>https://juejin.cn/post/7583574154340777993</guid>    <pubDate>2025-12-14T14:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583574154340777993" data-draft-id="7583577045578579994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows如何自定义任何窗口置顶"/> <meta itemprop="keywords" content="Windows"/> <meta itemprop="datePublished" content="2025-12-14T14:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城堡修炼者"/> <meta itemprop="url" content="https://juejin.cn/user/2379804202775341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows如何自定义任何窗口置顶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2379804202775341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城堡修炼者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:44:44.000Z" title="Sun Dec 14 2025 14:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接使用微软自己开发的软件即可： Microsoft PowerToys 的实用工具，其中包括 Always On Top 工具。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fwindows%2Fpowertoys%2Finstall" target="_blank" title="https://learn.microsoft.com/en-us/windows/powertoys/install" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/windo…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc6344ed83b452c95d921afeaecfaa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328283&amp;x-signature=hmylWBn5jWKEo2JXhJaPpoeK6Ng%3D" alt="image.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FPowerToys%2Freleases%2Ftag%2Fv0.96.1" target="_blank" title="https://github.com/microsoft/PowerToys/releases/tag/v0.96.1" ref="nofollow noopener noreferrer">github.com/microsoft/P…</a></p>
<p>不过需要使用 Windows 11 或 Windows 10 v2004 (19041) +才能使用它们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent时代下，ToB前端的UI和交互会往哪走？]]></title>    <link>https://juejin.cn/post/7583234966635266082</link>    <guid>https://juejin.cn/post/7583234966635266082</guid>    <pubDate>2025-12-14T15:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635266082" data-draft-id="7555764933923143690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent时代下，ToB前端的UI和交互会往哪走？"/> <meta itemprop="keywords" content="交互设计,前端,Agent"/> <meta itemprop="datePublished" content="2025-12-14T15:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="牧师李"/> <meta itemprop="url" content="https://juejin.cn/user/1355016376951341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent时代下，ToB前端的UI和交互会往哪走？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1355016376951341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    牧师李
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:01:21.000Z" title="Sun Dec 14 2025 15:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>最近在负责 Agent 项目前端部分的落地，深感 Agent + ToB 不仅仅是功能的叠加，更是一个需要<strong>前端开发、交互设计与业务逻辑</strong>深度融合的全新领域。因此，我想通过这篇文章梳理一下架构设计层面的思考。</p>
<p>在过去二十年里，ToB软件已经形成了一套成熟且稳固的交互范式（GUI图形用户界面）。为了承载复杂的业务逻辑，业界构建了深度的树状导航、高密度的业务逻辑和繁复的表单系统。这种设计通过将业务流程抽象为标准化的功能模块，有效地解决了信息化的问题。</p>
<p>此时，用户与系统的关系是典型的 <strong>“人适应系统”</strong> ：用户必须接受培训，记忆固定的操作路径，通过“点击 + 键盘”的机械指令来驱动软件。</p>
<p>近年，AI Agent 技术开始被引入 ToB 领域。但目前的普遍做法，仅仅是在现有界面上叠加一个聊天机器人（Chatbot）。但是，AI Agent 的出现不是为了在界面上加一个聊天框，而是为了打破“人去寻找功能”的旧模式。</p>
<p>未来，Agent 必然不再是一个边缘的辅助工具，而是系统的核心驱动力，可以深入介入用户的作业流，ToB 前端软件的人机交互应当如何重构？</p>
<p>本文分以下几个方面来深入探讨这个问题：</p>
<ul>
<li>静态界面变迁：静态渲染 =&gt; 混合渲染（生成式 UI + 静态渲染）</li>
<li>人机交互变迁：功能导航 =&gt; 意图引导</li>
<li>前端开发变迁：页面构建 =&gt; 原子组件 + 能力架构</li>
</ul>
<p>最后，我还会加入一些杂七杂八但是重要的思考</p>
<p><strong>以下内容纯属个人预测，如有指教请在评论区指正！</strong></p>
<br/>
<h2 data-id="heading-1">2. 定义：Agent是个啥？有啥用？</h2>
<h3 data-id="heading-2">2.1 先定义：我说的Agent是什么？</h3>
<p>我说的AI Agent不是我们熟知的聊天机器人或任务助手。</p>
<p>聊天机器人或者任务助手其本质是反应式的。它们在预设的规则或模型内，针对用户的明确指令执行单一、具体的任务 ，比如基于知识库的业务问答</p>
<p>而AI Agent则代表了一种主动式的、具备自主性的新形态（<strong>常用Cursor的朋友应该能够明白我在说啥</strong>）。  </p>
<p>一个真正的AI Agent具备以下核心特征：</p>
<ul>
<li>感知： 能够感知并处理其数字环境中的信息，包括视觉、文本和各类数据输入 。  </li>
<li>规划： 能够将一个复杂、高阶的目标分解为一系列可执行的、具体的子任务 。这是其区别于普通LLM的关键能力。</li>
<li>工具使用： 能够调用外部工具（如API、代码执行环境、数据库查询）来获取信息或执行动作，从而与外部世界进行交互。  </li>
<li>记忆： 能够记忆过去的交互、行动和结果，并利用这些记忆来指导未来的决策，实现上下文的连续性和学习改进 。  </li>
</ul>
<h3 data-id="heading-3">2.2 ToB软件对于AI Agent的核心诉求： 在复杂工作流程中提升用户生产力</h3>
<p>ToB Web 应用对 AI 智能体的需求，可以总结为<strong>在复杂工作流程中提升用户生产力</strong></p>
<p>引入AI Agent的最终目标，并非仅仅加速单个任务，而是从根本上重构涉及业务整体工作流 。这一理念的转变，要求前端交互设计需要进行变革。前端不再仅仅是用户与单一功能的交互界面，而是用户与一个持续进行的、复杂的业务流程进行协作的平台。  </p>
<br/>
<h2 data-id="heading-4">3. 静态界面变迁： 从静态渲染 =&gt; 混合渲染（生成式 UI + 静态渲染）</h2>
<p>Agent所代表的生成式 UI 并非要消灭现有的菜单和页面，而是作为一种高维度的补充。它让软件能够像乐高积木一样，根据用户的即时需求，实时重组最适合的交互形态。</p>
<h3 data-id="heading-5">3.1 静态页面的“确定性”与意图的“无限性”</h3>
<h4 data-id="heading-6">1、静态渲染的局限性：被“确定性”锁死的路由</h4>
<p>现有的 ToB 架构建立在 <strong>“确定性路由”</strong> 之上。前端工程师预先定义好 <code>/dashboard</code>、<code>/report</code> 等路由，并在每个路由下硬编码固定的组件布局。这种模式的前提是：<strong>用户的需求是可枚举的，操作路径是线性的。</strong></p>
<p>这种模式有两个缺陷：</p>
<ul>
<li><strong>路径冗余</strong>：用户想要完成一个跨模块的任务（例如：“把 A 项目的数据经过 B模块的处理后导出”），往往需要在三四个页面间跳转、复制、粘贴。</li>
<li><strong>僵尸组件</strong>：为了覆盖长尾需求，ToB 软件的页面里塞满了平时根本用不到的高级筛选器和按钮，导致界面臃肿。</li>
</ul>
<p>然而，Agent 的核心价值在于处理发散性意图。当用户提出“请分析上季度华东区销售异常的原因，并给出整改建议”时，这一需求涉及数据查询、图表分析、文本推理等多个维度。传统的静态页面无法预知并覆盖此类组合式需求。若强行通过跳转多个页面来解决，会让用户很不爽。</p>
<h4 data-id="heading-7">2、生成式 UI 的核心逻辑: 图形界面（GUI）和语言界面（LUI）的融合</h4>
<p>生成式 UI 指的是：<strong>系统根据对用户意图的理解和当前上下文，在运行时动态决策并渲染出的用户界面。</strong></p>
<p>在 Ant Design X 的范式中，这被称为“富交互组件的流式渲染”。其工作流包含三个阶段：</p>
<ul>
<li><strong>意图识别</strong> ：Agent 识别用户需求，判断单纯的文本回复不足以解决问题，需要调用特定的 UI 组件。</li>
<li><strong>结构化描述</strong> ：Agent 输出一段包含组件类型和Props的 JSON 描述</li>
<li><strong>动态渲染</strong> ：前端接收 Schema，映射到本地的“原子组件库”，在对话流中即时渲染出可交互的卡片。</li>
</ul>
<p>未来ToB软件的界面，可能不再是密密麻麻的菜单和按钮。而是一个全局的、智能的 <strong>语言用户界面（LUI）</strong> 将成为<strong>最高优的交互入口</strong>。用户可以通过自然语言直接下达指令，而GUI则会变成为：</p>
<ul>
<li><strong>歧义消除与能力展示区：</strong>  当Agent对指令理解不清时，会通过GUI提供选项让用户选择。同时，GUI也直观地展示了当前软件“能做什么”，为用户提供输入指令的灵感。</li>
<li><strong>过程的监控区：</strong>  Agent的执行计划、步骤和状态，会以可视化的方式在GUI中呈现。   比如<code>任务规划List</code>（以流程图或任务列表的形式，展示Agent为了完成用户目标而制定的详细计划）、<code>实时日志流</code>（实时显示Agent正在执行哪一步、调用了哪个工具、工具返回了什么结果)。</li>
<li><strong>结果的呈现区：</strong>  Agent执行任务后的结果（如生成的报表、更新后的数据列表）依然通过确定的GUI来展示。</li>
</ul>
<p>这标志着前端开发重心的转移：从<strong>构建静态页面</strong>转向<strong>定义组件能力</strong> 。</p>
<h3 data-id="heading-8">3.2 具体有哪些新的UI形态？</h3>
<p>为了让 Agent 的抽象工作过程变得透明、可控和可信，一系列新的UI模式应运而生。这些模式可以根据其核心功能分为三大类 。</p>
<h4 data-id="heading-9">3.2.1 为了提高透明度和可观测性的新形态</h4>
<p>这类模式的核心目标是打开Agent的“黑盒”，让用户能够理解其“思考”过程。</p>
<h5 data-id="heading-10">1、双栏视图</h5>
<p>这是展示Agent思考过程的关键模式。界面被分为两栏，一栏实时展示Agent的内部推理过程；另一栏则展示其采取的具体行动。  </p>
<p>例子：  Cursor的主界面一般被分成两块，一边是代码编辑区（具体行动）；另外一边是思考和推理过程。</p>
<h5 data-id="heading-11">2、多智能体流程图</h5>
<p>在由多个Agent协作的系统中，使用流程图或活动图来展示任务的分配和流转，清晰地标明哪个Agent在何时执行了何种操作。用户可以通过可展开的卡片深入了解每个Agent的具体贡献 。</p>
<p>例子： 秘塔AI搜索研究版\ <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cf7d2753d304884834a582392261dde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54mn5biI5p2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766329300&amp;x-signature=QrSkQRwhT%2FkC6wXGdDF2HNjIZe0%3D" alt="image.png" width="70%" loading="lazy"/></p>
<h5 data-id="heading-12">3、来源引用与追溯</h5>
<p>对于使用检索增强生成（RAG）技术的Agent，UI必须将生成的内容链接回其引用的原始文档或数据源。这极大地增强了信息的可信度，并允许用户进行事实核查 。  </p>
<p>例子： Gemini的深度研究，使用了大量展示数据源的交互。</p>
<hr/>
<h4 data-id="heading-13">3.2.2 为了更好地和Agent交互与协作的新形态</h4>
<p>这类新UI和交互目的是将Agent的能力无缝地融入用户的工作流中。</p>
<h5 data-id="heading-14">1、协作画布</h5>
<p>AI能力被直接嵌入用户的主要工作区，如设计工具或文档编辑器。用户通过行内建议、斜杠命令（<code>/</code>）或专用的AI功能块与Agent交互，整个过程无需离开当前的工作上下文，保持了心流体验 。  </p>
<p>例子： copliot中的自动代码补全</p>
<h5 data-id="heading-15">2、提示工程化表单</h5>
<p>将复杂的自然语言提示（Prompt）工程抽象成结构化的表单，用户只需填写几个关键字段，系统就会在后台将这些输入转换成一个优化过的、高质量的提示，然后提交给Agent。这有效降低了用户使用AI的门槛 。</p>
<p>例子： 抖音“创作灵感”工具的主动引导。抖音的“AI脚本生成”功能早期面临用户输入模糊的问题（如用户仅输入“拍一条美食视频”）。通过“提示工程化表单”方案优化后，交互流程变为：</p>
<ol>
<li>用户输入“拍一条美食视频”，意图分类模型判断明确度0.4（模糊）。</li>
<li>系统生成候选引导项：</li>
<li>“选项1：家常菜教程（步骤清晰，适合新手）”</li>
<li>“选项2：探店测评（突出口感描述，适合推荐）”</li>
<li>“选项3：创意摆盘（视觉化强，适合短视频）”</li>
<li>用户点击“选项1”，系统自动补全提示词：“帮我生成一条家常菜教程的视频脚本，目标人群是厨房新手，需要包含食材准备、步骤拆解和小贴士。”</li>
</ol>
<h5 data-id="heading-16">3、生成式UI</h5>
<p>AI不仅填充数据，还能动态生成或修改UI组件本身。</p>
<p>例子： 用户可以要求一些办公软件中的Agent“在表格中增加一列，显示每个订单的利润率”，Agent会直接修改表格组件的结构；或者要求“生成一个展示用户增长趋势的图表”，Agent会在仪表盘上创建一个新的图表组件</p>
<hr/>
<h4 data-id="heading-17">3.2.3 增加用户对Agent的掌控的UI</h4>
<h5 data-id="heading-18">1、人在回路</h5>
<p>Agent的工作流在执行关键或高风险操作（如撤销git 暂存区内容时）之前会被明确地暂停。UI会清晰地展示Agent将要执行的动作及其可能带来的后果，并要求用户进行明确的批准后才能继续 。  </p>
<p>例子：Cursor 和 Copilot 在agent模式下，是可以自动执行终端命令并读取执行结果的的。默认情况下，绝大多数终端命令（尤其是删除、安装依赖等）都需要用户点击 "Run Command"</p>
<h5 data-id="heading-19">2、可编辑计划与“check point”回溯</h5>
<p>在Agent开始执行任务之前，UI会展示其完整的行动计划。用户可以审阅、编辑、重新排序甚至取消计划中的某些步骤。</p>
<p>通过“check point”，用户可以“回溯”到Agent执行过程中的任一历史状态，并从该点开始探索一条不同的执行路径 。</p>
<p>例子：Gemini的研究模式 或者是 Cursor 的 plan模式\ <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca253adc9ae7493c9cc60f3010f457f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54mn5biI5p2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766329300&amp;x-signature=jO4a89ChRMkvBjil6NT8dorBJ%2FI%3D" alt="image.png" width="50%" loading="lazy"/></p>
<ul>
<li><strong>中断与恢复控制：</strong> UI必须始终提供一个明确的“停止”按钮，允许用户随时中断正在运行的Agent。中断后，UI应提供恢复、重试或放弃任务的选项 。</li>
</ul>
<br/>
<h2 data-id="heading-20">4. 人机交互变迁：“操作员” =&gt; “指挥官”</h2>
<p>在过去几十年里， GUI（图形用户界面）将用户规训成了软件的 <strong>“操作员”</strong>。而在 Agent 时代，交互设计的终极目标是将人还原为 <strong>“决策者”</strong>。</p>
<h3 data-id="heading-21">4.1 Agent时代的B端交互需要解放用户</h3>
<h4 data-id="heading-22">4.1.1 交互逻辑：从“过程导向”到“结果导向”</h4>
<p>在传统的 GUI（图形用户界面）中，交互是<strong>指令式</strong>的。
用户必须清楚地知道每一个步骤：点击菜单 A <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 选择子项 B <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 输入参数 C <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 点击确认。
这是一种“手把手教机器做事”的模式，对于一个有明确目的复杂工作流来说很繁琐</p>
<p>在 Agent 介入后，交互变成了<strong>意图式</strong>的。用户不再关注步骤，只关注结果：“帮我把这周异常的监控数据发给XXX”。系统内部自动完成了“检索数据 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 过滤异常 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 格式化报表 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 查找联系人 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 发送邮件”这一系列复杂工作流。</p>
<p>用户不再需要记忆软件的操作路径，只需要清晰地定义目标。</p>
<h4 data-id="heading-23">4.1.2 反馈机制：从“单向执行”到“双向对齐”</h4>
<p>在 GUI中，反馈通常是二元的：成功 or 失败。机器默认用户是永远正确的，只管执行。</p>
<p>但在意图式交互中，由于自然语言天然存在模糊性（例如用户说“清理一下”，是指删除媒体文件还是清理一下数据库？），交互的重心从“执行”转移到了“对齐”。</p>
<p>包括但不限于以下反馈机制：</p>
<ul>
<li><strong>授权：</strong>  用户可以设定Agent的权限范围，决定哪些操作它可以自动执行，哪些需要审批。 比如 Copliot 可以设置哪些命令行命令是不可以自动执行的。</li>
<li><strong>“急停”与接管：</strong>  在Agent执行任务的任何时刻，用户都应该可以暂停任务，审查状态，甚至手动接管后续步骤。</li>
<li><strong>纠错与反馈：</strong>  当Agent执行出错或不符合预期时，用户可以方便地提供反馈，帮助Agent学习和改进。</li>
</ul>
<p>这种交互更像人类之间的协作：<strong>听懂 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 确认 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 行动</strong>，而不是冰冷的 <strong>点击 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 运行</strong>。</p>
<hr/>
<h3 data-id="heading-24">4.2 具体有哪些新的交互模式？</h3>
<p>交互的内核正从“指令驱动”向“意图驱动”迁移。面对 AI 输出的不确定性与生成特性，旧的“点击-响应”模式已捉襟见肘。为了解决这些新问题，衍生出了三大类全新的交互模式。</p>
<h4 data-id="heading-25">4.2.1 “协商式”交互：精准对齐意图</h4>
<p>这类模式的核心是为了解决自然语言天然的“模糊性”。Agent 不再闷头执行指令，而是像一个经验丰富的助手，通过多轮沟通来“对齐”需求，确保做正确的事。</p>
<h5 data-id="heading-26">1、主动追问与澄清</h5>
<p>当用户的指令太宽泛或缺少关键参数时，Agent 不应该“瞎猜”（那会带来不可控的风险），而应该采取兜底策略，主动抛出选项或反问，引导用户补全信息。</p>
<p><strong>例子：</strong> Cursor的 Plan 模式<br/>
用户的编码意图不够清晰，方案有模糊的监视空间，plan模式就会主动向用户进行询问</p>
<h5 data-id="heading-27">2、上下文锚定</h5>
<p>这是“LUI+ GUI”协同工作的典型场景。用户无需费力用语言去描述一个复杂的对象，只需通过“圈选”或“指代”来锁定上下文，再辅以语言指令。</p>
<p><strong>例子：</strong> Photoshop 的 Generative Fill（创成式填充）<br/>
用户用套索工具圈选画面中的一只狗（GUI 操作），然后在输入框里敲下“换成一只猫”（LUI 操作），用户不用费劲描述“请把画面左下角坐标 (x,y) 处的那只黑色小狗...”，极大降低了表达成本。</p>
<h4 data-id="heading-28">4.2.2 “共创式”交互：人机实时协作</h4>
<p>这类模式旨在打破传统交互“你输完指令、我慢慢跑进度条”的回合制感，让用户和 Agent 能够实时配合，实现人机“同频”。</p>
<h5 data-id="heading-29">1、流式输出与即时干预</h5>
<p>大模型推理需要时间，界面除了用“打字机效果”缓解等待焦虑外，更关键的是要允许用户<strong>随时插嘴</strong>或<strong>叫停</strong>。</p>
<p><strong>例子：</strong> Cursor的“Stop Generating”与实时纠偏</p>
<p>代码写的有问题，此时你不需要等它全写完再提意见，而是直接点停止，并且重新提交prompt，cursor会自动撤销原来有问题的代码生成。 这种机制把“事后验收”变成了“事中纠偏”，极大地压缩了试错成本。</p>
<h5 data-id="heading-30">2、预测性推荐</h5>
<p>Agent 基于当前上下文和用户画像，预判你的下一步意图，并直接把“下一步动作”封装成按钮递到你手边。</p>
<p><strong>例子：</strong> Cursor、Gemini、元宝啥的都有这个功能</p>
<hr/>
<h4 data-id="heading-31">4.2.3 “方便修正结果”的交互</h4>
<p>AI 的产出往往是概率性的“半成品”。交互设计必须提供极低成本的修改能力，让用户通过简单的操作将结果调整至完美。</p>
<h5 data-id="heading-32">1、基于 GUI 的修正</h5>
<p>用户不需要为了修改一点小细节而重新组织Prompt，而是直接在生成的 GUI 组件上动手改。Agent 能感知到这些修改，并自动同步到底层逻辑。</p>
<p><strong>例子：</strong> Claude 的 Artifacts 预览修改</p>
<p>Agent 生成了一个网页按钮，颜色你不喜欢。你不需要打字说“把按钮改成深蓝色”，而是直接用右侧预览窗口里的取色器吸取一个蓝色。 此时，Agent 会自动重写左侧的代码以匹配你的视觉修改。这种“所见即所得”的修改方式，远比语言描述高效。</p>
<h5 data-id="heading-33">2、给用户选择题！</h5>
<p>针对创意类或没有标准答案的任务，Agent 不做“填空题”而是做“选择题”。它一次性提供多个草稿，用户负责做决策。</p>
<p><strong>例子：</strong> Midjourney 的 U/V 模式。</p>
<p>输入提示词后，系统先出 4 张缩略图。用户点击“V2”（基于第 2 张图生成变体），系统会保留第 2 张图的构图，仅在细节上微调。 这是一种典型的<strong>通过选择表达审美</strong>。在难以用语言描述清楚“具体哪里感觉不对”的时候，让用户做选择题是最高效的。</p>
<br/>
<h2 data-id="heading-34">5. 前端开发的变迁：页面构建 =&gt; 原子组件 + 能力架构</h2>
<p>前端开发的核心变迁可以用以下两个公式描述</p>
<p><strong>传统模式：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>I</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">UI = f(State)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></span>。状态变了，界面变。但 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> (渲染逻辑) 是写死的。</p>
<p><strong>Agent 模式：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mi>I</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>I</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo separator="true">,</mo><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo separator="true">,</mo><mi>C</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>o</mi><mi>n</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">UI = f(Intent, Context, Components)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>。意图决定展示什么组件，上下文决定填充什么数据。</p>
<h3 data-id="heading-35">5.1 组件设计的变革：从“Props 定义”到“语义自述”</h3>
<p>在传统的 Vue 或 React 开发中，我们定义一个组件（比如一个日期选择器），最关注的是它的 Props：需要传什么值，触发什么事件。这是写给 <strong>人类程序员</strong> 看的。</p>
<p>但在 Agent 体系下，组件的第一受众变成了 <strong>AI 模型</strong>。AI 不看源码，它需要知道这个组件“是干什么的？”、“数据结构是啥？”、“什么时候该用它？”。</p>
<p>因此，前端组件的开发标准增加了两个新维度：</p>
<ol>
<li><strong>语义描述：</strong> 你需要用自然语言告诉 Agent：“这是一个日期范围选择器，适用于需要筛选特定时间段数据的场景。”这种描述不再是注释，而是会作为系统提示词（System Prompt）的一部分实时喂给 AI。</li>
<li><strong>Schema 标准化：</strong> 组件的输入必须严格遵循 JSON Schema 标准。因为 LLM（大模型）输出的是结构化数据，前端必须确保组件能无缝“消化” AI 生成的配置参数，具备极强的鲁棒性，避免因参数错误导致页面崩溃。</li>
<li><strong>唯一可寻址性</strong>：每个组件实例都应拥有一个稳定且唯一的标识符，Agent可以通过这个ID精确地引用它。</li>
<li><strong>API驱动的状态</strong>：组件的状态不仅应能通过用户的直接交互（如点击、输入）来改变，还必须能通过编程接口被读取和修改。例如，Agent需要能够通过调用API来对表格组件应用一个筛选条件。</li>
</ol>
<p>这一转变意味着，前端组件开发不再仅仅是关于UI还原和交互处理，更是一项API设计工作。组件需要定义清晰的API供Agent调用，还需要能够文档化和测试其对Agent暴露的API。</p>
<h3 data-id="heading-36">5.2 前端数据通信的变革：从“请求-响应”到“流式驱动”</h3>
<p>传统的 CRUD 应用中，数据流是离散的：发起请求 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 等待 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 拿到全量 JSON <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 渲染。</p>
<p>但在 Agent 交互中，这种模式会让用户体验崩溃。因为 AI 的推理和生成是缓慢的。如果等 10 秒钟才一次性刷出结果，用户早就关掉了页面。</p>
<p>前端的数据通信架构正在向 <strong>流式驱动</strong> 转型：</p>
<ul>
<li><strong>增量渲染能力：</strong> 前端不能傻等完整的 JSON。当 Agent 刚刚吐出 <code>{"type": "chart", "tit...</code> 时，前端就应该渲染出一个带有标题骨架的图表占位符。随着数据流 <code>...le": "Q3 Revenue"}</code> 的到达，标题被实时填入。</li>
<li><strong>状态的颗粒度更细：</strong> 我们需要处理一种全新的状态—— <strong>“思考中”</strong> 。这不同于传统的 <code>loading</code>。Loading 是单纯的转圈，而 Thinking 需要展示 Agent 正在调用的工具、正在阅读的文档，甚至允许用户在这个过程中打断。</li>
</ul>
<p>这对前端的状态管理库提出了很高的要求：它必须能像处理水流一样处理数据，而不是像处理砖块一样。</p>
<h3 data-id="heading-37">5.3 路由系统的变革：从“URL 映射”到“意图路由”</h3>
<p>传统前端应用中<code>/user/detail/xxx</code>等 严格对应着一个组件树。</p>
<p>但在混合渲染的架构中，URL 的统治力开始下降。当用户说“看看张三的绩效”时，系统可能不需要跳转 URL，而是直接在当前的对话流中“挂载”一个绩效卡片组件。</p>
<p>前端的路由逻辑发生裂变：</p>
<ul>
<li><strong>宏观路由（保留）：</strong> 依然使用 URL 管理大的模块（如“工作台”、“设置页”），保证浏览器的刷新和回退机制正常工作。</li>
<li><strong>微观路由（新增）：</strong> 在页面内部，引入一个 <strong>“意图导航”</strong>。它根据 AI 识别出的意图，动态决定在当前视图中加载哪个组件。</li>
</ul>
<p>这意味着前端架构必须支持<strong>动态组件注册</strong>和<strong>沙箱隔离</strong>，防止 AI 随意生成的组件把主应用搞挂。</p>
<h3 data-id="heading-38">5.4 容错设计的变革：从“防止代码逻辑错误”到“给Agent的幻觉进行容错”</h3>
<p>传统前端的主要捕获代码逻辑错误（比如 <code>undefined is not a function</code>）。</p>
<p>现在的挑战在于：代码没报错，但 AI一本正经地胡说八道。 比如，AI 返回了一个不存在的枚举值，或者生成了一段格式错误的 JSON。</p>
<p>前端开发必须构建一层容错机制：</p>
<ul>
<li><strong>校验：</strong> 在渲染 AI 生成的内容前，必须进行严格的 Schema 校验。</li>
<li><strong>降级：</strong> 如果 AI 想要渲染一个复杂的图表但参数错了，前端应该能自动降级显示为纯文本，或者是提示用户“数据解析失败，请重试”，而不是直接白屏。</li>
<li><strong>可控：</strong> 在 UI 上提供“重新生成”或“手动编辑”的入口，把最终的纠错权交还给用户。</li>
</ul>
<h3 data-id="heading-39">5.5 总结</h3>
<p><strong>前端并没有死，它只是向上进化了。</strong></p>
<p>我们不再专注于于像素级的对齐、编写确定的组件（这些 AI 已经能写得很好了），而是开始关注<strong>组件的语义、数据流的实时性、以及系统的鲁棒性</strong>。</p>
<p>我们将从<strong>构建界面</strong>的工程师，转变为<strong>构建 AI 运行时环境</strong>的工程师。这才是 Agent 时代前端开发的真正价值所在。</p>
<br/>
<h2 data-id="heading-40">6. 一些系统性的思考问题</h2>
<h3 data-id="heading-41">6.1 Agent进步那么快，会话式交互（自然语言LUI）会完全取代GUI吗？</h3>
<p><strong>不会！</strong></p>
<p><strong>所有交互创新都是为了这一个目的：“让输入更简单，让结果更易懂”。</strong></p>
<p>Agent时代的到来似乎冲昏了一些产品或者交互的头脑？认为 LUI（语言交互）会取代 GUI。</p>
<p>我现在可以举一个反例：在游戏过程中，你想让飞机升高10米，实际上用上下左右的按键会比在聊天界面输入“这台飞机马上升高10米”更高效得多。</p>
<h5 data-id="heading-42">1、GUI 的本质：直接操作</h5>
<ul>
<li>
<p><strong>定义：</strong> 用户直接作用于屏幕上的对象。比如：你看到一个滑块，你拖动它；你看到方向键，你点击它。</p>
</li>
<li>
<p><strong>心理模型：</strong> <strong>“手眼协调”</strong> 。它模拟的是物理世界（比如开车、开飞机）。</p>
</li>
<li>
<p><strong>优势：</strong></p>
<ul>
<li><strong>低认知负荷：</strong> 是Recognition，看到按钮就知道能干嘛，不需要记忆指令。</li>
<li><strong>零延迟反馈：</strong> 按下即响应，形成了毫秒级的“感知-行动”闭环。</li>
<li><strong>高确定性：</strong> 按钮点了就是对应某个动作，不存在歧义。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-43">2、LUI (自然语言) 的本质：代理委托</h5>
<ul>
<li>
<p><strong>定义：</strong> 用户通过语言描述意图，中间层（Agent）理解并执行。</p>
</li>
<li>
<p><strong>心理模型：</strong> <strong>“人际交流”</strong> 。它模拟的是你跟一个副驾驶说话。</p>
</li>
<li>
<p><strong>优势：</strong></p>
<ul>
<li><strong>无限的表达空间：</strong> 按钮数量有限，语言的组合无限。</li>
<li><strong>高抽象能力：</strong> 可以处理复杂的逻辑（比如“把所有电量低于 20% 的无人机召回”）。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-44">3、案例分析</h5>
<p>案例：在游戏过程中，你想让飞机升高10米，实际上用上下左右的按键会比在聊天界面输入“这台飞机马上升高10米”更高效得多。</p>
<p>刚才“飞机升高”案例，为什么 GUI 完胜？ 因为 <strong>“空间运动”是低维度的、物理直觉的任务。</strong> 人脑对空间的理解是直接的，不需要经过“语言中枢”的转译。</p>
<ul>
<li><strong>GUI 路径：</strong> 眼睛看到位置 -&gt; 大脑空间计算 -&gt; 手指移动。（快，生物本能）</li>
<li><strong>LUI 路径：</strong> 眼睛看到位置 -&gt; 大脑空间计算 -&gt; <strong>转化为语义（"升高"）</strong> -&gt; <strong>量化数值（"10米"）</strong> -&gt; 组织语言 -&gt; 输入 -&gt; AI 解析 -&gt; 执行。（慢，且容易累）</li>
</ul>
<h5 data-id="heading-45">4、方法论</h5>
<p>到底是GUI好还是LUI好？以下给出两个维度进行评估：</p>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>GUI (图形交互)</strong></th><th><strong>LUI (自然语言/AI)</strong></th></tr></thead><tbody><tr><td><strong>操作粒度</strong></td><td><strong>原子级操作</strong>。适合微调、实时控制。（如：向左偏一点点）</td><td><strong>意图级操作</strong>。适合批处理、复杂指令。（如：按顺时针巡检A区）</td></tr><tr><td><strong>学习曲线</strong></td><td><strong>初学者难，专家快</strong>。需要学习界面布局，但熟练后可形成“肌肉记忆”。</td><td><strong>初学者快，专家慢</strong>。无需学习（会说话就行），但无法形成肌肉记忆，每次都要组织语言。</td></tr><tr><td><strong>信息带宽</strong></td><td><strong>输入低，输出高</strong>。鼠标只有一个坐标，但屏幕能显示千万像素。</td><td><strong>输入高，输出低</strong>。一句话包含丰富信息，但文本输出往往难以一目了然。</td></tr><tr><td><strong>容错率</strong></td><td><strong>低风险</strong>。通常有限制，难以产生严重越界操作。</td><td><strong>高风险</strong>。可能因为歧义（幻觉）导致灾难性后果（如 AI 误解了“降落”和“坠落”）。</td></tr></tbody></table>
<p>回到刚才的那个原则：“让输入更简单，让结果更易懂”。</p>
<ul>
<li>对于在游戏中移动飞机：推摇杆是输入最简单（符合直觉），看飞机动了是结果最易懂（视觉反馈）。</li>
<li>对于数据查询：说句话是输入最简单（省去筛选），看生成的图表是结果最易懂。</li>
</ul>
<p>真正高效的交互应该应该采用 <strong>GUI + LUI</strong> 的方式：</p>
<ul>
<li>
<p>保留专业的控制面板或者图表（GUI），用于高频、实时、精细操作。</p>
</li>
<li>
<p>嵌入“副驾驶” （LUI）：用于跨菜单调用功能、复杂数据分析等意图级操作。</p>
</li>
<li>
<p>关键点： AI 的输出，最好是 GUI 组件。</p>
<ul>
<li><em>错误做法：</em> 用户问“表中哪个设备目前待更换？”，AI 回答文字“3号飞机待更换”。</li>
<li><em>正确做法：</em> 用户问“表中哪个设备目前待更换？”，AI 直接把表格上的 3 号设备<strong>高亮闪烁</strong>，并在侧边栏弹出它的详细状态卡片。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-46">6.2 交互元素的“考古分析”</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d9b75d1264d44ff9ee52ecd6fbdef49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54mn5biI5p2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766329300&amp;x-signature=0oIQDuEa7i4Pqz%2FTjBvQ4cfiQmg%3D" alt="image.png" loading="lazy"/></p>
<p>要讲计算机上的人机交互变革，肯定离不开施乐+苹果当年发扬光大的GUI。GUI和NUI在现在似乎稀松平常，但是当年实际上隐含着很多深层的思考和价值，这极大地改变了我们现在的世界。</p>
<p><strong>很有必要考考古，才能指导未来的设计！</strong></p>
<h4 data-id="heading-47">6.2.1 PC GUI</h4>
<p>所以要讲Agent的交互元素的思考，肯定要先讲清楚GUI时代的内容</p>
<h5 data-id="heading-48">1、<strong>Icon 图标</strong></h5>
<ul>
<li><strong>思考：</strong> 在命令行（CLI）时代，用户必须记住命令（如 <code>delete</code> 或 <code>rm</code>）。图标的出现利用了人类从物理世界继承来的视觉经验——比如用一个“垃圾桶”代表删除，用一个“放大镜”代表搜索。这本质上是一种<strong>语义的视觉压缩</strong>。</li>
<li><strong>价值：</strong> 它是<strong>认知负荷的极度减负</strong>。它建立了一座通用的桥梁，跨越了语言障碍（不识字的人也能看懂图标），让计算机的操作从“背诵语法”变成了“看图说话”，极大地降低了数字世界的准入门槛。</li>
</ul>
<h5 data-id="heading-49">2、 <strong>Menu 菜单</strong></h5>
<ul>
<li><strong>思考：</strong> 软件的功能往往成百上千，如果全部铺在屏幕上，用户会崩溃。菜单本质上是一种<strong>信息的分类</strong> 。它通过层级结构（文件、编辑、视图）将混乱的功能有序折叠。它解决的是 <strong>“有限屏幕”与“无限软件功能”之间的矛盾</strong>。</li>
<li><strong>价值：</strong> 它提供了<strong>可发现性</strong>和 <strong>安全感</strong>。用户不需要预先知道软件能做什么，只要打开菜单逛一逛就能知道。它为用户建立了一张“功能地图”，让用户在面对庞大系统时，能通过逻辑推演找到目标，而不是盲目乱撞。</li>
</ul>
<h5 data-id="heading-50">3、<strong>Pointing 指点设备（鼠标/光标）</strong></h5>
<ul>
<li><strong>思考：</strong> 在键盘交互时代，操作是线性的、离散的。而鼠标引入了<strong>二维空间坐标</strong>的概念。它将人类的手部动作（物理位移）映射到屏幕上的光标运动（虚拟位移）。这引入了<strong>费茨定律</strong> ：操作效率取决于目标的大小和距离。它是“手眼协调”在数字世界的第一次完美投射。</li>
<li><strong>价值：</strong> 用户可以跳过屏幕上的任何内容，直接<strong>随机访问</strong>任何他想操作的那个像素点，而不必像填写表格一样按 Tab 键逐个切换。</li>
</ul>
<h5 data-id="heading-51">4、<strong>Windows 窗口</strong></h5>
<ul>
<li><strong>思考：</strong> 在单任务时代（DOS），屏幕就是全部。窗口的发明，创造了 **“屏幕中的屏幕” ** 。它模拟了物理世界中的“办公桌桌面”：你可以同时摊开好几份文件，有的在上面，有的被压在下面。它在心理学上契合了人类的 <strong>工作记忆</strong> 模型——我们需要同时关注多个相关联的信息源。</li>
<li><strong>价值：</strong> 它实现了<strong>多任务并行与信息隔离</strong>。用户可以在一个窗口看文档，在另一个窗口写代码，无需频繁切换上下文导致思路中断。它通过<strong>空间复用</strong>，让有限的显示器承载了逻辑上无限的信息流。</li>
</ul>
<h5 data-id="heading-52">5、<strong>Toast 轻提示：</strong></h5>
<ul>
<li><strong>思考：</strong> 弹窗 model 会强行打断用户，强迫用户点击“确定”。</li>
<li><strong>价值：</strong> 它是<strong>非阻断式</strong>的反馈。它承认“用户的注意力很宝贵”，只在视觉边缘告知结果（如“保存成功”），让交互的主流程不被打断。</li>
</ul>
<h4 data-id="heading-53">6.2.2 移动互联网NUI（触控与感知）</h4>
<p>在移动端，屏幕变小了，鼠标消失了，交互从“指向”变成了“直接操纵”。</p>
<h5 data-id="heading-54">1、<strong>手势（滑动/捏合）：</strong></h5>
<ul>
<li><strong>思考：</strong> PC GUI里的滚动条是一个独立的控件，用户需要把鼠标移过去拖动它。而手势让用户<strong>直接作用于内容本身</strong>。</li>
<li><strong>价值：</strong> 它是“动作”与“结果”的零距离融合。用户想翻页，直接拨动页面，而不是拨动控制器（滚动条）。这极大降低了操作的抽象程度。</li>
</ul>
<h5 data-id="heading-55">2、<strong>下拉刷新</strong></h5>
<ul>
<li><strong>思考：</strong> 这是一个极其经典的发明。它利用了自然的物理隐喻（像拉动弹簧一样）。</li>
<li><strong>价值：</strong> 它创造了一个**“无界面”的按钮**。用户不需要寻找“刷新”图标，而是通过一种符合直觉的动律（Ritual）来触发更新，同时通过回弹动画告知用户“系统正在处理”。</li>
</ul>
<h5 data-id="heading-56">3、<strong>侧滑操作（列表项左滑/右滑）</strong></h5>
<p>插一句，玩过“探探”的朋友们有没有想过左滑右滑不感兴趣的匹配对象的交互逻辑？以下解析应该可以帮助你们</p>
<ul>
<li><strong>思考：</strong> 在 PC GUI 时代，处理列表数据（如邮件）通常需要三步：1. 选中某一行；2. 移动鼠标去找工具栏上的“删除”图标；3. 点击确认。而侧滑操作利用了 “扔掉” 的物理隐喻。</li>
<li><strong>价值：</strong> 它是<strong>高频决策的极速通道</strong>。它将“选择对象”与“执行动作”合二为一。用户不需要把视线从内容（邮件标题）移开去寻找按钮，手指一滑即处理。这种交互极大地提升了信息筛选和清理的效率（如 探探 的左滑右滑，Mail 的滑动归档）。</li>
</ul>
<h5 data-id="heading-57">4、<strong>Haptic Touch 长按呼出</strong></h5>
<ul>
<li><strong>思考：</strong> 移动设备没有鼠标右键，屏幕只有二维平面（X轴和Y轴）。长按操作引入了<strong>时间维度</strong>（或压力维度，如 3D Touch），模拟了<strong>Z轴的深度</strong>。它类似于在物理世界中“注视”或“用力按压”一个物体以探究其内部结构。</li>
<li><strong>价值：</strong> 它是<strong>渐进式的信息披露</strong>。它允许界面保持简洁（不展示复杂的菜单按钮），但又隐藏了深度的操作选项（如快捷方式、预览）。它解决了移动端“屏幕太小”与“功能太多”的矛盾，让用户在不离开当前页面的情况下获取上下文信息。</li>
</ul>
<h5 data-id="heading-58">5、<strong>无限滚动（瀑布流）</strong></h5>
<ul>
<li><strong>思考：</strong> WIMP 时代的网页浏览基于“分页器”，看完了要点“下一页”，这强迫用户进行一次“是否继续”的理性决策，打断了体验。而无限滚动创造了 <strong>“流（Stream）”</strong> 的隐喻，内容像水流一样源源不断。</li>
<li><strong>价值：</strong> 它创造了<strong>沉浸式的无意识消费</strong>。消除了“翻页”带来的认知中断，极大地延长了用户停留时间。对于内容型产品，这是将用户留存率最大化的“交互黑洞”。</li>
</ul>
<h5 data-id="heading-59">6、<strong>底部的导航栏</strong></h5>
<ul>
<li><strong>思考：</strong> PC GUI的导航栏通常在顶部或左侧（为了配合 F 型阅读顺序）。但移动设备的交互核心限制是 <strong>“拇指热区”</strong>。底部导航栏是对人体工程学的妥协与尊重。</li>
<li><strong>价值：</strong> 在高频切换的核心功能区，用户不需要调整握持姿势，拇指仅需微动即可完成路由跳转。这是硬件形态（单手握持）反向定义软件交互的典型案例。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack编译中为什么不建议load替换ast中节点删除consolg.log]]></title>    <link>https://juejin.cn/post/7583576605780721710</link>    <guid>https://juejin.cn/post/7583576605780721710</guid>    <pubDate>2025-12-14T15:02:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780721710" data-draft-id="7571768210715901967" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack编译中为什么不建议load替换ast中节点删除consolg.log"/> <meta itemprop="keywords" content="前端,Webpack,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T15:02:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack编译中为什么不建议load替换ast中节点删除consolg.log
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:02:14.000Z" title="Sun Dec 14 2025 15:02:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在 Webpack 编译过程中，不建议仅通过 loader 直接替换 / 删除代码中的 <code>console.log</code>，<strong>核心原因是「loader 替换的局限性」会导致代码稳定性、可维护性、调试效率受损，且存在更优的替代方案</strong>。以下从「核心问题、场景风险、正确方案」三个维度详细解析：</p>
<h3 data-id="heading-0">一、loader 替换 console.log 的核心问题</h3>
<p>Loader 的核心作用是<strong>转换模块的源代码</strong>（如 ts→js、less→css），其设计逻辑是 “按模块处理、文本替换”，但用它处理 <code>console.log</code> 会暴露以下致命问题：</p>
<h4 data-id="heading-1">1. 语法鲁棒性极差：易破坏合法代码</h4>
<p><code>console.log</code> 的写法高度灵活（参数、嵌套、动态调用），loader 基于 “正则 / 简单字符串替换” 无法精准识别，极易误改合法代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 1. 合法场景被误替换</span>
<span class="hljs-type">const</span> console = { <span class="hljs-built_in">log</span>: (msg) =&gt; alert(msg) }; <span class="hljs-comment">// 自定义 console 对象</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"正常业务逻辑"</span>); <span class="hljs-comment">// loader 替换后变成 undefined.log(...)，直接报错</span>

<span class="hljs-comment">// 2. 嵌套场景替换不彻底</span>
<span class="hljs-keyword">if</span> (debug) {
  console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"调试信息"</span>, { a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span> }); <span class="hljs-comment">// 正则仅替换 console.log 会残留参数，导致语法错误</span>
}

<span class="hljs-comment">// 3. 动态调用场景失效</span>
<span class="hljs-type">const</span> <span class="hljs-built_in">log</span> = console.<span class="hljs-built_in">log</span>;
<span class="hljs-built_in">log</span>(<span class="hljs-string">"动态调用的日志"</span>); <span class="hljs-comment">// loader 无法识别，漏替换</span>
</code></pre>
<p><strong>本质问题</strong>：loader 是 “文本层面” 的替换，而非 “语法层面” 的分析，无法区分「原生 <code>console.log</code>」和「自定义 <code>console</code> 对象 / 动态调用」，最终导致代码语法错误或逻辑异常。</p>
<h4 data-id="heading-2">2. 破坏开发 / 生产环境的一致性</h4>
<ul>
<li>开发环境：需要保留 <code>console.log</code> 用于调试；</li>
<li>生产环境：需要移除 <code>console.log</code> 减少体积、避免信息泄露；</li>
</ul>
<p>若用 loader 硬编码替换，需在 <code>webpack.config.js</code> 中区分环境配置，且 loader 一旦配置错误，会导致：</p>
<ul>
<li>开发环境日志被意外删除，调试效率骤降；</li>
<li>生产环境日志未被删除，泄露敏感信息（如接口参数、用户 ID）。</li>
</ul>
<h4 data-id="heading-3">3. 无法精细化控制：一刀切的替换不灵活</h4>
<p>实际项目中，<code>console.log</code> 并非 “全删 / 全留”，而是需要精细化控制：</p>
<ul>
<li>保留 <code>console.error</code>/<code>console.warn</code>（生产环境需监控错误）；</li>
<li>仅删除开发调试的 <code>console.log</code>，保留业务关键日志；</li>
<li>按环境 / 模块 / 日志级别区分（如测试环境保留、生产环境删除）；</li>
</ul>
<p>loader 基于简单替换无法实现上述逻辑，只能 “全替换” 或 “全不替换”，灵活性为 0。</p>
<h4 data-id="heading-4">4. 性能损耗：增加编译开销</h4>
<p>Loader 处理每个模块时都要执行正则匹配 / 替换，项目越大（模块越多），编译时间越长；而专业的优化插件（如 <code>terser-webpack-plugin</code>）是在 “代码压缩阶段” 批量处理，效率远高于 loader 逐模块替换。</p>
<h3 data-id="heading-5">二、更致命的场景风险</h3>
<ol>
<li><strong>第三方依赖被误改</strong>：loader 会处理所有模块（包括 <code>node_modules</code>），若第三方库中使用 <code>console.log</code> 做关键逻辑（如调试、错误提示），被替换后会导致依赖功能异常，且难以排查；</li>
<li><strong>SourceMap 错位</strong>：loader 替换代码后，行号 / 列号与原始代码不一致，生产环境报错时，SourceMap 无法精准定位问题，增加调试难度；</li>
<li><strong>无法回滚</strong>：一旦 loader 配置上线，若发现替换错误，需重新编译发布，而插件方案可通过配置快速开关，成本更低。</li>
</ol>
<h3 data-id="heading-6">三、Webpack 中处理 console.log 的正确方案</h3>
<p>核心原则：<strong>在代码压缩 / 优化阶段处理，而非 loader 转换阶段</strong>，以下是行业主流方案：</p>
<h4 data-id="heading-7">1. 生产环境：用 TerserWebpackPlugin 精准移除（推荐）</h4>
<p><code>terser-webpack-plugin</code> 是 Webpack 内置的代码压缩插件（替代旧的 <code>uglifyjs-webpack-plugin</code>），支持<strong>语法层面分析</strong>，可安全移除 <code>console</code>，且支持精细化配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-type">const</span> <span class="hljs-variable">TerserPlugin</span> <span class="hljs-operator">=</span> require(<span class="hljs-string">'terser-webpack-plugin'</span>);

<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  mode: <span class="hljs-string">'production'</span>,
  optimization: {
    minimizer: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        terserOptions: {
          compress: {
            <span class="hljs-comment">// 核心配置：移除 console</span>
            drop_console: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全量移除 console（包括 log/error/warn）</span>
            <span class="hljs-comment">// 精细化配置：仅移除 log，保留 error/warn</span>
            <span class="hljs-comment">// pure_funcs: ['console.log'] </span>
          },
          <span class="hljs-comment">// 保留 SourceMap，避免报错定位错位</span>
          sourceMap: <span class="hljs-literal">true</span> 
        }
      })
    ]
  }
};
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>语法分析：仅移除原生 <code>console.log</code>，不影响自定义 <code>console</code> 对象；</li>
<li>批量处理：压缩阶段一次性处理，编译效率高；</li>
<li>灵活配置：可按日志级别区分保留 / 删除；</li>
<li>不影响第三方依赖：默认仅处理业务代码（可通过 <code>test</code> 配置范围）。</li>
</ul>
<h4 data-id="heading-8">2. 开发 / 测试环境：用 ESLint 约束（而非删除）</h4>
<p>开发阶段无需删除 <code>console.log</code>，但可通过 ESLint 提示 / 禁止调试日志，避免提交到生产环境：</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-selector-class">.eslintrc</span><span class="hljs-selector-class">.js</span>
module<span class="hljs-selector-class">.exports</span> = {
  rules: {
    // 警告：提示开发者删除 console<span class="hljs-selector-class">.log</span>
    'no-console': [<span class="hljs-string">'warn'</span>, { allow: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'warn'</span>] }],
    // 或严格模式：禁止所有 console（仅生产环境启用）
    // 'no-console': process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'error'</span> : <span class="hljs-string">'off'</span>
  }
};
</code></pre>
<h4 data-id="heading-9">3. 按需控制：用环境变量 + 封装日志函数（最佳实践）</h4>
<p>项目中封装统一的日志工具，按环境控制日志输出，从根源避免 <code>console.log</code> 泛滥：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/utils/logger.js</span>
<span class="hljs-keyword">const</span> logger = {
  <span class="hljs-attr">log</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[LOG]'</span>, ...args);
    }
  },
  <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[ERROR]'</span>, ...args); <span class="hljs-comment">// 生产环境保留错误日志</span>
  }
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = logger;
</code></pre>
<p>业务代码中使用：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> logger from <span class="hljs-string">'./utils/logger'</span>;

logger.<span class="hljs-built_in">log</span>(<span class="hljs-string">'调试信息'</span>); <span class="hljs-comment">// 生产环境自动不输出</span>
logger.<span class="hljs-built_in">error</span>(<span class="hljs-string">'业务错误'</span>); <span class="hljs-comment">// 生产环境保留</span>
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>完全可控：按环境 / 日志级别灵活调整；</li>
<li>无编译风险：不修改原生代码，仅控制输出；</li>
<li>便于扩展：可接入日志监控平台（如 Sentry）。</li>
</ul>
<h3 data-id="heading-10">四、总结：为什么 loader 是错误选择？</h3>



































<table><thead><tr><th>维度</th><th>loader 替换</th><th>TerserPlugin + 封装日志</th></tr></thead><tbody><tr><td>语法安全性</td><td>极低（易误改代码）</td><td>极高（语法层面分析）</td></tr><tr><td>灵活性</td><td>无（一刀切）</td><td>高（按级别 / 环境配置）</td></tr><tr><td>编译性能</td><td>差（逐模块替换）</td><td>优（压缩阶段批量处理）</td></tr><tr><td>可维护性</td><td>差（配置分散）</td><td>优（集中配置，易开关）</td></tr><tr><td>调试友好性</td><td>差（SourceMap 错位）</td><td>优（保留 SourceMap）</td></tr></tbody></table>
<p><strong>核心结论</strong>：</p>
<p><strong>loader 的设计目标是 “转换代码格式”，而非 “优化代码逻辑 / 删除日志”；处理 <code>console.log</code> 应交给「代码压缩插件」（生产环境）+「日志封装函数」（全环境），既保证代码稳定性，又能灵活控制日志输出。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[Adjustment-ReplaceColor节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7583260493851213865</link>    <guid>https://juejin.cn/post/7583260493851213865</guid>    <pubDate>2025-12-14T13:11:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851213865" data-draft-id="7582997593090850835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[Adjustment-ReplaceColor节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-14T13:11:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[Adjustment-ReplaceColor节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:11:46.000Z" title="Sun Dec 14 2025 13:11:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>ReplaceColor节点是Unity ShaderGraph中Artistic类别下的重要颜色调整工具，能够将输入颜色中的指定颜色值替换为目标颜色，并通过参数控制实现平滑的过渡效果。该节点在游戏开发、影视制作和UI设计等领域应用广泛，为开发者提供了强大的颜色处理能力。</p>
<p>节点的核心功能基于输入颜色与源颜色之间的距离计算，在特定范围内实现颜色替换。与简单的颜色替换不同，该节点引入了Range和Fuzziness两个关键参数，使颜色替换不再是生硬的切换，而是能够创建自然的渐变过渡。</p>
<p>在实际应用中，ReplaceColor节点常用于以下场景：</p>
<ul>
<li>替换材质中的特定颜色元素</li>
<li>实现色键效果（绿幕抠像）</li>
<li>动态调整游戏元素的颜色主题</li>
<li>创建特殊视觉效果和风格化渲染</li>
</ul>
<p>该节点属于ShaderGraph的Artistic类别，在默认颜色模式下会显示对应的类别颜色标识，便于开发者快速识别节点类型。</p>
<h2 data-id="heading-0">端口与参数详解</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/ReplaceColorNodeThumb.png" alt="" loading="lazy"/></p>
<p>ReplaceColor节点包含六个主要端口，每个端口都具有特定的功能和作用。</p>
<h3 data-id="heading-1">输入端口配置</h3>
<p><strong>In端口</strong></p>
<ul>
<li>类型：Vector 3</li>
<li>绑定：无</li>
<li>描述：作为颜色替换操作的输入源，可连接纹理采样节点、颜色节点或其他颜色计算节点的输出。该端口接收RGB颜色值，通常来自材质的基础纹理或计算得到的颜色结果。</li>
</ul>
<p><strong>From端口</strong></p>
<ul>
<li>类型：Vector 3</li>
<li>绑定：Color</li>
<li>描述：定义需要被替换的目标颜色值。该端口通常连接到颜色属性或固定的颜色值，用于指定在输入颜色中寻找的特定颜色。</li>
</ul>
<p><strong>To端口</strong></p>
<ul>
<li>类型：Vector 3</li>
<li>绑定：Color</li>
<li>描述：定义替换后的目标颜色值。当输入颜色与From颜色匹配时，将使用此颜色值进行替换。</li>
</ul>
<p><strong>Range端口</strong></p>
<ul>
<li>类型：Float</li>
<li>绑定：无</li>
<li>描述：控制颜色匹配的容差范围。该参数决定了在From颜色周围多大的颜色范围内进行替换操作，数值越大，替换的颜色范围越广。</li>
</ul>
<p><strong>Fuzziness端口</strong></p>
<ul>
<li>类型：Float</li>
<li>绑定：无</li>
<li>描述：软化选择范围周围的边缘，实现平滑过渡效果。通过调整此参数可以避免替换边缘出现锯齿现象，创建自然的颜色渐变。</li>
</ul>
<h3 data-id="heading-2">输出端口配置</h3>
<p><strong>Out端口</strong></p>
<ul>
<li>类型：Vector 3</li>
<li>绑定：无</li>
<li>描述：输出经过颜色替换处理后的最终结果。该端口可连接到主节点的颜色输入或其他后续处理节点。</li>
</ul>
<h2 data-id="heading-3">核心算法解析</h2>
<p>ReplaceColor节点的内部实现基于颜色距离计算和线性插值算法。深入理解其核心算法对于有效使用该节点至关重要。</p>
<h3 data-id="heading-4">颜色距离计算</h3>
<p>节点首先计算输入颜色(In)与源颜色(From)之间的欧几里得距离：</p>
<p><code>float Distance = distance(From, In);</code></p>
<p>该距离值决定了当前像素颜色与目标替换颜色的相似程度。距离越小，说明颜色越接近，替换效果越明显。</p>
<h3 data-id="heading-5">插值因子计算</h3>
<p>获得颜色距离后，节点通过以下公式计算插值因子：</p>
<p><code>float factor = saturate((Distance - Range) / max(Fuzziness, 1e-5));</code></p>
<p>此计算确保在Range范围内的颜色会被完全替换，而在Range到Range+Fuzziness范围内的颜色会产生平滑过渡。</p>
<h3 data-id="heading-6">最终输出计算</h3>
<p>通过lerp函数在目标颜色(To)和输入颜色(In)之间进行插值：</p>
<p><code>Out = lerp(To, In, factor);</code></p>
<p>当factor为0时，输出完全使用To颜色；当factor为1时，输出保持原始In颜色；在0到1之间时，输出为两种颜色的混合结果。</p>
<h2 data-id="heading-7">参数调节技巧</h2>
<h3 data-id="heading-8">Range参数调节</h3>
<p>Range参数决定颜色替换的敏感度范围：</p>
<ul>
<li><strong>小数值</strong>（0-0.1）：仅替换与From颜色几乎完全相同的像素，适用于精确颜色匹配</li>
<li><strong>中等数值</strong>（0.1-0.3）：替换相似颜色范围，适用于大多数常规应用</li>
<li><strong>大数值</strong>（0.3以上）：替换广泛的颜色范围，可能影响非目标区域</li>
</ul>
<h3 data-id="heading-9">Fuzziness参数调节</h3>
<p>Fuzziness参数控制替换边缘的柔和度：</p>
<ul>
<li><strong>低模糊度</strong>（0-0.05）：产生硬边缘，适合需要清晰边界的效果</li>
<li><strong>中等模糊度</strong>（0.05-0.2）：创建自然过渡，避免锯齿现象</li>
<li><strong>高模糊度</strong>（0.2以上）：产生非常柔和的边缘，适合创建羽化效果</li>
</ul>
<h3 data-id="heading-10">参数组合策略</h3>
<p>在实际应用中，Range和Fuzziness的组合使用可产生不同的视觉效果：</p>
<ul>
<li><strong>精确替换</strong>：小Range + 低Fuzziness</li>
<li><strong>平滑过渡</strong>：中等Range + 中等Fuzziness</li>
<li><strong>区域影响</strong>：大Range + 高Fuzziness</li>
</ul>
<h2 data-id="heading-11">实际应用案例</h2>
<h3 data-id="heading-12">游戏元素颜色动态替换</h3>
<p>在游戏开发中，ReplaceColor节点常用于动态改变游戏元素的颜色主题。例如，可根据游戏状态改变角色的服装颜色或环境的色调。</p>
<p>实现步骤：</p>
<ol>
<li>将角色纹理连接到In端口</li>
<li>设置需要替换的原始颜色到From端口</li>
<li>通过脚本控制To端口的颜色值</li>
<li>调整Range和Fuzziness以获得理想的替换效果</li>
</ol>
<h3 data-id="heading-13">绿幕抠像效果</h3>
<p>ReplaceColor节点可实现类似绿幕抠像的效果，将特定的背景颜色替换为透明或其他背景。</p>
<p>关键技术点：</p>
<ul>
<li>精确设置绿幕颜色到From端口</li>
<li>使用较小的Range值确保只影响背景区域</li>
<li>通过Fuzziness控制边缘的平滑度</li>
</ul>
<h3 data-id="heading-14">UI元素主题切换</h3>
<p>在UI设计中，可使用ReplaceColor节点实现动态主题切换。通过替换UI元素中的特定颜色，可快速实现白天/黑夜模式或不同色彩主题的切换。</p>
<h2 data-id="heading-15">性能优化建议</h2>
<p>在ShaderGraph的Heatmap颜色模式下，可直观查看节点的性能成本。ReplaceColor节点通常具有中等性能开销，主要取决于颜色距离计算的复杂度。</p>
<h3 data-id="heading-16">优化策略</h3>
<ul>
<li><strong>预处理纹理</strong>：尽可能在纹理制作阶段优化颜色分布，减少需要处理的颜色范围</li>
<li><strong>合理使用参数</strong>：避免使用过大的Range值，这会增加计算量</li>
<li><strong>考虑平台差异</strong>：在移动平台上应更加谨慎地使用复杂的颜色替换效果</li>
</ul>
<h3 data-id="heading-17">性能监控</h3>
<p>通过以下方法监控节点性能：</p>
<ol>
<li>切换到Heatmap颜色模式查看节点相对性能成本</li>
<li>在目标平台上实际测试着色器性能</li>
<li>使用Unity的性能分析工具进行详细分析</li>
</ol>
<h2 data-id="heading-18">常见问题解决方案</h2>
<h3 data-id="heading-19">颜色替换不精确</h3>
<p>当颜色替换效果不理想时，可能的原因和解决方案包括：</p>
<ul>
<li><strong>颜色空间问题</strong>：确保所有颜色值在相同的颜色空间中处理</li>
<li><strong>光照影响</strong>：考虑场景光照对颜色感知的影响，可能需要结合其他颜色调整节点</li>
<li><strong>参数设置不当</strong>：重新调整Range和Fuzziness参数</li>
</ul>
<h3 data-id="heading-20">边缘锯齿问题</h3>
<p>解决替换边缘的锯齿现象：</p>
<ul>
<li>适当增加Fuzziness参数值</li>
<li>结合抗锯齿技术</li>
<li>使用更高分辨率的纹理</li>
</ul>
<h3 data-id="heading-21">性能问题处理</h3>
<p>当颜色替换操作导致性能下降时：</p>
<ul>
<li>减少同时使用的ReplaceColor节点数量</li>
<li>优化Range参数，使用尽可能小的有效范围</li>
<li>考虑使用LOD技术，在远距离使用简化的着色器版本</li>
</ul>
<h2 data-id="heading-22">与其他节点配合使用</h2>
<p>ReplaceColor节点可与其他ShaderGraph节点组合使用，创建更复杂的效果。</p>
<h3 data-id="heading-23">与Blend节点配合</h3>
<p>将ReplaceColor节点与Blend节点结合，可实现多层颜色的混合和替换效果。这种组合特别适用于创建复杂的材质效果和动态纹理变化。</p>
<h3 data-id="heading-24">与Mask节点组合</h3>
<p>结合Color Mask节点使用，可更精确地控制颜色替换的区域和范围。通过遮罩技术，可限制ReplaceColor节点只在特定区域生效。</p>
<h3 data-id="heading-25">在调整节点中的位置</h3>
<p>在Artistic类别中，ReplaceColor节点与其他调整节点如Hue、Saturation、Contrast等共同构成了完整的颜色调整工具集。理解各节点的特性和适用场景，有助于构建更高效的着色器图形。</p>
<h2 data-id="heading-26">高级应用技巧</h2>
<h3 data-id="heading-27">动态参数控制</h3>
<p>通过脚本动态控制ReplaceColor节点的参数，可实现实时的颜色变化效果。这种技术在交互式应用和游戏中特别有用。</p>
<p>实现方法：</p>
<ol>
<li>在ShaderGraph中创建对应的材质属性</li>
<li>通过C#脚本修改材质属性值</li>
<li>实现基于游戏逻辑的颜色动态变化</li>
</ol>
<h3 data-id="heading-28">多级颜色替换</h3>
<p>通过串联多个ReplaceColor节点，可实现复杂的多级颜色替换效果。这种方法适用于需要同时替换多种颜色的场景。</p>
<p>注意事项：</p>
<ul>
<li>节点顺序影响最终结果</li>
<li>注意性能开销的累积</li>
<li>考虑颜色之间的相互影响</li>
</ul>
<h2 data-id="heading-29">总结与最佳实践</h2>
<p>ReplaceColor节点是ShaderGraph中功能强大的颜色处理工具，通过合理使用其参数和组合其他节点，可创建各种视觉效果。</p>
<h3 data-id="heading-30">使用建议</h3>
<ul>
<li><strong>从简单开始</strong>：先使用基本设置，逐步调整参数</li>
<li><strong>测试不同光照条件</strong>：确保在各种光照环境下效果一致</li>
<li><strong>考虑目标平台</strong>：根据运行平台调整效果复杂度和性能要求</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++20协程如何撕开异步编程的牢笼]]></title>    <link>https://juejin.cn/post/7583576612390797322</link>    <guid>https://juejin.cn/post/7583576612390797322</guid>    <pubDate>2025-12-14T13:36:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576612390797322" data-draft-id="7583571595202904102" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++20协程如何撕开异步编程的牢笼"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T13:36:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++20协程如何撕开异步编程的牢笼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:36:44.000Z" title="Sun Dec 14 2025 13:36:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：三年前，一个深夜的线上事故让我彻底醒悟——callback hell不是技术问题，而是人性问题。当人类大脑理解不了自己写的代码时，就该换种写法了。C++20协程就是这个答案，但它真的能救我们于水火吗？</p>
</blockquote>
<h2 data-id="heading-0"><strong>凌晨三点，我删掉了最后一行回调代码</strong></h2>
<p>那是2021年冬天，系统突发崩溃。事后分析，罪魁祸首是一段深度嵌套的回调：</p>
<pre><code class="hljs language-cpp" lang="cpp">order_service.<span class="hljs-built_in">async_get_order</span>(order_id, [<span class="hljs-keyword">this</span>](Order order) {
    user_service.<span class="hljs-built_in">async_get_user</span>(order.user_id, [<span class="hljs-keyword">this</span>, order](User user) {
        risk_service.<span class="hljs-built_in">async_check</span>(order, user, [<span class="hljs-keyword">this</span>, order, user](<span class="hljs-type">bool</span> passed) {
            <span class="hljs-keyword">if</span>(passed) {
                market_service.<span class="hljs-built_in">async_execute</span>(order, [<span class="hljs-keyword">this</span>, order](Result result) {
                    db_service.<span class="hljs-built_in">async_save</span>(result, [<span class="hljs-keyword">this</span>, result]() {
                        notify_service.<span class="hljs-built_in">async_send</span>(result, [<span class="hljs-keyword">this</span>]() {
                            <span class="hljs-comment">// 还有第7层...</span>
                        });
                    });
                });
            }
        });
    });
});
</code></pre>
<p><strong>问题不在代码，而在我们的大脑</strong>——没人能在凌晨三点保持7层回调的清醒。</p>
<h2 data-id="heading-1"><strong>从回调协程，不是换语法，是换脑子</strong></h2>
<h3 data-id="heading-2"><strong>第一步：承认回调反人类</strong></h3>
<p>回调的问题本质是<strong>控制流反转</strong>。你的代码不再从上往下执行，而是在各个回调函数间跳跃。这就像读书时每读一段就要翻到书的最后看注释，再翻回来继续。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 回调：你的眼睛要上下跳动</span>
<span class="hljs-built_in">fetch_data</span>([](Data data) {          <span class="hljs-comment">// 跳到第3段</span>
    <span class="hljs-built_in">process</span>(data, [](Result result) { <span class="hljs-comment">// 跳到第5段</span>
        <span class="hljs-built_in">save</span>(result);                 <span class="hljs-comment">// 终于结束了？</span>
    });
});
<span class="hljs-comment">// 这里还有代码...                    // 哦不，还要跳回这里</span>

<span class="hljs-comment">// 协程：老老实实从上往下读</span>
Data data = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">fetch_data</span>();   <span class="hljs-comment">// 第1段</span>
Result result = <span class="hljs-built_in">process</span>(data);       <span class="hljs-comment">// 第2段  </span>
<span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">save</span><span class="hljs-params">(result)</span></span>;               <span class="hljs-comment">// 第3段</span>
<span class="hljs-comment">// 结束了，不用跳来跳去</span>
</code></pre>
<h3 data-id="heading-3"><strong>第二步：理解协程不是线程</strong></h3>
<p>这是最深的误解。很多人以为协程是「轻量级线程」，大错特错。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 线程：操作系统给你一整个面包车（完整的调用栈）</span>
<span class="hljs-comment">//       你可以拉货（执行代码），但车很贵，停车场（内存）有限</span>
<span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([] { heavy_work(); })</span></span>;  <span class="hljs-comment">// 租了一辆面包车</span>
<span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([] { light_work(); })</span></span>;  <span class="hljs-comment">// 又租一辆，为了运一袋米？</span>

<span class="hljs-comment">// 协程：共享单车 + 智能调度</span>
<span class="hljs-comment">//       你需要时扫码骑走（创建协程），用完还车（挂起）</span>
<span class="hljs-comment">//       一个调度员（调度器）管理几百辆单车</span>
<span class="hljs-keyword">auto</span> task = []() -&gt; Task&lt;<span class="hljs-type">void</span>&gt; {
    <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">light_work</span>();  <span class="hljs-comment">// 骑单车去买咖啡</span>
    <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">heavy_work</span><span class="hljs-params">()</span></span>;  <span class="hljs-comment">// 换辆三轮车运货</span>
};
</code></pre>
<p><strong>关键区别</strong>：线程切换需要换整个面包车（保存所有寄存器、栈），协程切换只需要记住单车停在哪个位置（保存局部变量和程序计数器）。</p>
<h3 data-id="heading-4"><strong>第三步：亲手实现一个最简单的协程</strong></h3>
<p>不要急着用标准库，我们先自己造个轮子，才能真正理解：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 一个极其简化的协程实现（50行代码）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MiniCoroutine</span> {
    <span class="hljs-type">int</span> line = <span class="hljs-number">0</span>;           <span class="hljs-comment">// 记录执行到哪一行</span>
    std::string data;       <span class="hljs-comment">// 协程的局部数据</span>
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">resume</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">switch</span>(line) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                std::cout &lt;&lt; <span class="hljs-string">"协程开始\n"</span>;
                line = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 告诉调用者：我还没完</span>
            
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                std::cout &lt;&lt; <span class="hljs-string">"执行到一半，暂停一下\n"</span>;
                line = <span class="hljs-number">2</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 暂停</span>
            
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                std::cout &lt;&lt; <span class="hljs-string">"继续执行\n"</span>;
                line = <span class="hljs-number">3</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 告诉调用者：我结束了</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
};

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_mini_coro</span><span class="hljs-params">()</span> </span>{
    MiniCoroutine coro;
    <span class="hljs-keyword">while</span>(coro.<span class="hljs-built_in">resume</span>()) {
        std::cout &lt;&lt; <span class="hljs-string">"主线程做其他事...\n"</span>;
    }
}
</code></pre>
<p><strong>这就是协程的本质</strong>：一个能记住执行位置的函数。C++20的标准协程只是把这个概念标准化、优化到了极致。</p>
<h2 data-id="heading-5"><strong>co_await的朴素原理</strong></h2>
<p>当你写<code>co_await something()</code>时，编译器做了什么？</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 你写的</span>
<span class="hljs-function">Task&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">get_user_data</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">auto</span> user = <span class="hljs-keyword">co_await</span> db.<span class="hljs-built_in">get_user</span>(id);
    <span class="hljs-keyword">auto</span> profile = <span class="hljs-keyword">co_await</span> cache.<span class="hljs-built_in">get_profile</span>(user.id);
    <span class="hljs-function"><span class="hljs-keyword">co_return</span> <span class="hljs-title">merge</span><span class="hljs-params">(user, profile)</span></span>;
}

<span class="hljs-comment">// 编译器看到的（简化版）</span>
<span class="hljs-function">Task&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">get_user_data</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-comment">// 编译器生成一个状态机</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">StateMachine</span> {
        <span class="hljs-type">int</span> state = <span class="hljs-number">0</span>;
        User user;
        Profile profile;
        
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">move_next</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">switch</span>(state) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">// 初始状态</span>
                    <span class="hljs-built_in">start_db_call</span>();
                    state = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 挂起</span>
                    
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// db.get_user完成</span>
                    user = <span class="hljs-built_in">get_db_result</span>();
                    <span class="hljs-built_in">start_cache_call</span>();
                    state = <span class="hljs-number">2</span>;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 挂起</span>
                    
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// cache.get_profile完成  </span>
                    profile = <span class="hljs-built_in">get_cache_result</span>();
                    state = <span class="hljs-number">3</span>;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 完成</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    };
    
    <span class="hljs-comment">// 实际的调度逻辑...</span>
}
</code></pre>
<p><strong>魔法消失了吗？</strong> 协程没有魔法，只是编译器帮你写了状态机代码。以前你要手写这些状态切换，现在编译器自动生成。</p>
<h2 data-id="heading-6"><strong>性能之争：协程真的比线程快吗？</strong></h2>
<p>这个问题没有简单答案。让我用实际数据说话：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 测试场景：处理10万个网络连接</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">benchmark_connections</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 方案A：线程池，每个连接一个任务</span>
    <span class="hljs-function">ThreadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span></span>;
    <span class="hljs-keyword">auto</span> start = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        pool.<span class="hljs-built_in">enqueue</span>(handle_connection, i);
    }
    <span class="hljs-comment">// 等待所有任务完成...</span>
    <span class="hljs-keyword">auto</span> thread_time = <span class="hljs-built_in">get_elapsed</span>(start);
    
    <span class="hljs-comment">// 方案B：协程，单线程事件循环</span>
    start = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-built_in">co_spawn</span>(<span class="hljs-built_in">handle_connection_coro</span>(i));
    }
    <span class="hljs-comment">// 运行事件循环...</span>
    <span class="hljs-keyword">auto</span> coro_time = <span class="hljs-built_in">get_elapsed</span>(start);
    
    std::cout &lt;&lt; <span class="hljs-string">"10万连接处理时间：\n"</span>
              &lt;&lt; <span class="hljs-string">"线程池: "</span> &lt;&lt; thread_time &lt;&lt; <span class="hljs-string">"ms\n"</span>
              &lt;&lt; <span class="hljs-string">"协程:   "</span> &lt;&lt; coro_time &lt;&lt; <span class="hljs-string">"ms\n"</span>;
}
</code></pre>
<p><strong>结果出乎意料</strong>：</p>
<ul>
<li>小数据包、高并发：协程完胜（快3-5倍）</li>
<li>大数据量、计算密集：线程池有时更好</li>
<li>内存使用：协程是线程的1/100</li>
</ul>
<p><strong>为什么？</strong> 线程切换要进内核、要保存整个栈，协程切换在用户态、只保存必要状态。</p>
<h2 data-id="heading-7"><strong>实战：用协程重写一个Redis客户端</strong></h2>
<p>让我们看一个真实案例。这是某公司用协程重写Redis客户端后的变化：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 旧版：回调式Redis客户端</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClientOld</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, std::function&lt;<span class="hljs-type">void</span>(std::optional&lt;std::string&gt;)&gt; callback)</span> </span>{
        <span class="hljs-built_in">send_command</span>(<span class="hljs-string">"GET "</span> + key, [callback](Response resp) {
            <span class="hljs-keyword">if</span>(resp.error) <span class="hljs-built_in">callback</span>(std::<span class="hljs-literal">nullopt</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-built_in">callback</span>(resp.value);
        });
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value, 
             std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">bool</span>)&gt; callback)</span> </span>{
        <span class="hljs-built_in">send_command</span>(<span class="hljs-string">"SET "</span> + key + <span class="hljs-string">" "</span> + value, [callback](Response resp) {
            <span class="hljs-built_in">callback</span>(!resp.error);
        });
    }
};

<span class="hljs-comment">// 使用时的痛苦</span>
redis.<span class="hljs-built_in">get</span>(<span class="hljs-string">"user:100"</span>, [&amp;redis](<span class="hljs-keyword">auto</span> user_json) {
    <span class="hljs-keyword">if</span>(user_json) {
        redis.<span class="hljs-built_in">set</span>(<span class="hljs-string">"cache:user:100"</span>, *user_json, [](<span class="hljs-type">bool</span> success) {
            <span class="hljs-comment">// 这里还要继续...</span>
        });
    }
});

<span class="hljs-comment">// 新版：协程式Redis客户端</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClientCoro</span> {
<span class="hljs-keyword">public</span>:
    Task&lt;std::optional&lt;std::string&gt;&gt; <span class="hljs-built_in">get</span>(<span class="hljs-type">const</span> std::string&amp; key) {
        <span class="hljs-keyword">auto</span> resp = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">send_command</span>(<span class="hljs-string">"GET "</span> + key);
        <span class="hljs-keyword">if</span>(resp.error) <span class="hljs-keyword">co_return</span> std::<span class="hljs-literal">nullopt</span>;
        <span class="hljs-keyword">co_return</span> resp.value;
    }
    
    <span class="hljs-function">Task&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; key, <span class="hljs-type">const</span> std::string&amp; value)</span> </span>{
        <span class="hljs-keyword">auto</span> resp = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">send_command</span>(<span class="hljs-string">"SET "</span> + key + <span class="hljs-string">" "</span> + value);
        <span class="hljs-keyword">co_return</span> !resp.error;
    }
};

<span class="hljs-comment">// 使用时的清爽</span>
<span class="hljs-function">Task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">cache_user_data</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> user_data = <span class="hljs-keyword">co_await</span> redis.<span class="hljs-built_in">get</span>(<span class="hljs-string">"user:100"</span>);
    <span class="hljs-keyword">if</span>(user_data) {
        <span class="hljs-keyword">co_await</span> redis.<span class="hljs-built_in">set</span>(<span class="hljs-string">"cache:user:100"</span>, *user_data);
    }
}
</code></pre>
<p><strong>改造结果</strong>：</p>
<ul>
<li>代码行数减少40%</li>
<li>错误处理统一了</li>
<li>性能提升20%（因为减少了闭包创建）</li>
<li>新同事上手时间从2周缩短到2天</li>
</ul>
<h2 data-id="heading-8"><strong>协程的阴暗面：那些没人告诉你的坑</strong></h2>
<h3 data-id="heading-9"><strong>坑1：协程不是免费的午餐</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">dangerous_coroutine</span><span class="hljs-params">()</span> </span>{
    std::mutex mtx;
    <span class="hljs-function">std::lock_guard <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;  <span class="hljs-comment">// 危险！</span>
    
    <span class="hljs-comment">// 如果在这里co_await，其他协程也尝试锁这个mutex...</span>
    <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">async_io</span><span class="hljs-params">()</span></span>;
    <span class="hljs-comment">// 可能死锁！因为协程在等待IO时不会释放锁</span>
}

<span class="hljs-comment">// 正确做法：用协程友好的同步原语</span>
<span class="hljs-function">Task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">safe_coroutine</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">co_await</span> mutex_.<span class="hljs-built_in">lock_async</span>();  <span class="hljs-comment">// 专门为协程设计的锁</span>
    <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">async_io</span><span class="hljs-params">()</span></span>;
    <span class="hljs-keyword">co_await</span> mutex_.<span class="hljs-built_in">unlock_async</span>();
}
</code></pre>
<h3 data-id="heading-10"><strong>坑2：异常处理变得复杂</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">exception_hell</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">step1</span><span class="hljs-params">()</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">step2</span><span class="hljs-params">()</span></span>;  <span class="hljs-comment">// 如果这里抛异常...</span>
    } <span class="hljs-built_in">catch</span>(...) {
        <span class="hljs-comment">// step1申请的资源可能泄漏！</span>
    }
}

<span class="hljs-comment">// 解决方案：RAII在协程中要格外小心</span>
<span class="hljs-function">Task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">safe_with_raii</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> resource = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">acquire_resource</span>();
    
    <span class="hljs-comment">// 使用unique_ptr管理</span>
    <span class="hljs-keyword">auto</span> guard = std::<span class="hljs-built_in">unique_ptr</span>&lt;Resource, Deleter&gt;(resource);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">use_resource</span><span class="hljs-params">(resource)</span></span>;
    } <span class="hljs-built_in">catch</span>(...) {
        <span class="hljs-comment">// unique_ptr会确保资源释放</span>
        <span class="hljs-keyword">throw</span>;
    }
    
    <span class="hljs-comment">// 正常释放</span>
    <span class="hljs-built_in">release_resource</span>(guard.<span class="hljs-built_in">release</span>());
}
</code></pre>
<h3 data-id="heading-11"><strong>坑3：调试困难</strong></h3>
<p>协程的调用栈在调试器中是断裂的。你看到的栈回溯可能是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">main</span>()
scheduler::<span class="hljs-built_in">run</span>()
coroutine_frame::<span class="hljs-built_in">resume</span>()
???
</code></pre>
<p><strong>解决方案</strong>：给协程命名，记录协程ID，使用协程感知的调试工具。</p>
<h2 data-id="heading-12"><strong>协程生态：现在还是一片荒野</strong></h2>
<p>C++20只提供了协程的底层机制，就像只给了你砖头水泥，没给建筑设计图。你需要自己造轮子：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 你需要自己实现或找第三方库：</span>
<span class="hljs-comment">// 1. 任务类型（Task&lt;T&gt;）</span>
<span class="hljs-comment">// 2. 调度器</span>
<span class="hljs-comment">// 3. 异步原语（锁、条件变量等）</span>
<span class="hljs-comment">// 4. 网络IO封装</span>
<span class="hljs-comment">// 5. 取消机制</span>
<span class="hljs-comment">// 6. 超时处理</span>
<span class="hljs-comment">// 7. ...</span>

<span class="hljs-comment">// 当前可用的库：</span>
<span class="hljs-comment">// - cppcoro（微软）：全面但复杂</span>
<span class="hljs-comment">// - folly::coro（Facebook）：生产级但依赖folly</span>
<span class="hljs-comment">// - boost.coroutine2：有栈协程，不是C++20风格</span>
<span class="hljs-comment">// - 自己造轮子：适合学习，生产环境慎重</span>
</code></pre>
<h2 data-id="heading-13"><strong>到底要不要用？我的诚恳建议</strong></h2>
<h3 data-id="heading-14"><strong>适合用协程的场景</strong>：</h3>
<ol>
<li><strong>新的网络服务</strong>：从零开始，没有历史包袱</li>
<li><strong>高并发中间件</strong>：代理、网关、消息队列</li>
<li><strong>团队技术强</strong>：有人能hold住底层问题</li>
<li><strong>性能是生命线</strong>：愿意为性能付出学习成本</li>
</ol>
<h3 data-id="heading-15"><strong>暂时别用的场景</strong>：</h3>
<ol>
<li><strong>维护老项目</strong>：风险大于收益</li>
<li><strong>团队C++水平一般</strong>：先用好智能指针和移动语义</li>
<li><strong>赶进度的业务项目</strong>：协程会拖慢初期开发</li>
<li><strong>嵌入式/资源极度受限</strong>：协程有额外开销</li>
</ol>
<h2 data-id="heading-16"><strong>我的选择：先在小项目里试水</strong></h2>
<p>去年，我决定在团队的监控代理服务中尝试协程。这个服务特点：</p>
<ul>
<li>需要处理几千个连接</li>
<li>逻辑相对简单</li>
<li>可以容忍一定风险</li>
</ul>
<p><strong>结果</strong>：</p>
<ul>
<li>开发时间增加了30%（学习曲线）</li>
<li>性能提升了40%</li>
<li>内存使用减少了70%</li>
<li>代码行数减少了35%</li>
<li>半年内没有协程相关的bug</li>
</ul>
<p><strong>最重要的是</strong>：团队掌握了这项技术，现在在新项目中可以自信地使用。</p>
<h2 data-id="heading-17"><strong>写在最后：技术人的理性与浪漫</strong></h2>
<p>协程让我想起了2016年第一次接触多线程编程的时候。当时觉得「天啊，这太复杂了」，但今天多线程已经是程序员的基本功。</p>
<p>技术就是这样，今天的尖端，明天的常识。</p>
<p>C++20协程现在看起来还有点「野」，有点「难」，有点像早期Linux。但正是这种「不完美」让它有无限可能——你可以按自己的需求定制调度策略，可以优化内存布局，可以集成到任何事件循环中。</p>
<p><strong>不要因为协程是新的就用它，也不要因为它复杂就回避它</strong>。把它当成工具箱里的一把新扳手，在某些特定场景下，它比旧扳手更好用。</p>
<p>async/await是给大多数人的糖，C++协程是给手艺人的工具。你要做大多数人，还是手艺人？</p>
<p>至少我，选择后者。因为在这个复制粘贴的时代，真正的手艺才是稀缺品。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[忍不住推荐 ： AI 时代 ，桌面端真的可以考虑一下Go+Wails 的组合]]></title>    <link>https://juejin.cn/post/7583226204036186153</link>    <guid>https://juejin.cn/post/7583226204036186153</guid>    <pubDate>2025-12-14T13:43:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036186153" data-draft-id="7582958136258445348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="忍不住推荐 ： AI 时代 ，桌面端真的可以考虑一下Go+Wails 的组合"/> <meta itemprop="keywords" content="后端,AI编程,Go"/> <meta itemprop="datePublished" content="2025-12-14T13:43:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="志字辈小蚂蚁"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822007822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            忍不住推荐 ： AI 时代 ，桌面端真的可以考虑一下Go+Wails 的组合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822007822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    志字辈小蚂蚁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:43:20.000Z" title="Sun Dec 14 2025 13:43:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一. 前言</h2>
<p>之前有过关注的小伙伴 ，一定知道我之前主要的桌面端是 : <strong>PyQT</strong> + <strong>Python</strong> 的组合。 这个组合整体来说很成熟也很强大。</p>
<p><strong>基于脚手架</strong> ❗❗❗ ，简单的小工具能轻松解决，<strong>复杂的也能做一个十几个页面，近10万行的复杂项目</strong>， 整体还能保证一定的流畅性。</p>
<p>但是 ，随着对精细功能的逐步提高 ，以及更多多样化的定制需求，代码量的增加 ，这一套有点吃力了。并且<strong>AI在其中的作用越来越低</strong>。</p>
<h2 data-id="heading-1">二. 一次心血来潮的尝试</h2>
<p><code>代码逻辑越简单 ，流程越精简，AI是越擅长的</code>。</p>
<p>直到我无意中了解到 Go 也有自己的桌面端方案 ，并且社区活跃度还相当不错 ：</p>
<p>@ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwailsapp%2Fwails" target="_blank" title="https://github.com/wailsapp/wails" ref="nofollow noopener noreferrer">github.com/wailsapp/wa…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c80bcded4664f7f8d4e4847bb68668d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=uE1Z1cbpgehjGToKVKGom2xnBnc%3D" alt="image.png" loading="lazy"/></p>
<p>于是我周末花了大概小半天时间让AI写了一个小应用 ，期间我还开了两把游戏 ，哇 ，这效果真的不错。</p>
<p>然后我就很简单的得到了这样一个应用 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/591f963fa38e4b76838fdc513163ed04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=kSZu5GUF4%2FxNSht07%2FY8hM0Usjg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bc289a3c98747db8c7ad2cca87487e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=dxwZkLCKqqmJjK6A3WcS0aSxyEg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccbb78a9d86148fc830371b8c046b0c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=v3yUqr7Cev1D8wtIXVK216AC%2BAI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三. 做一个小总结</h2>
<p>但是这里可能会让很多小伙伴想到这样一个架构 ： Node.js + Electron. 这也是一个很多人都知道的热门组合，我之前也多次使用过他开发小工具 ，效果也不错。</p>
<p>但是我<strong>觉得 GO-Wails 比他更适合AI时代</strong> ： 这里让AI做了一个很清晰的总结 ，关于 GO 和 Electron 的选择 ：</p>


















































<table><thead><tr><th>维度</th><th>Go+Wails</th><th>Electron</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐ 飞快</td><td>⭐⭐ 慢</td></tr><tr><td><strong>体积</strong></td><td>⭐⭐⭐⭐⭐ 苗条</td><td>⭐⭐ 臃肿</td></tr><tr><td><strong>开发效率</strong></td><td>⭐⭐⭐ 需学Go</td><td>⭐⭐⭐⭐⭐ 前端直接上手</td></tr><tr><td><strong>生态/插件</strong></td><td>⭐⭐⭐ 发展中</td><td>⭐⭐⭐⭐⭐ npm应有尽有</td></tr><tr><td><strong>调试体验</strong></td><td>⭐⭐⭐ 够用</td><td>⭐⭐⭐⭐⭐ DevTools真香</td></tr><tr><td><strong>系统集成</strong></td><td>⭐⭐⭐⭐⭐ 直接调C/系统API</td><td>⭐⭐⭐ 需要绕路</td></tr><tr><td><strong>跨平台一致性</strong></td><td>⭐⭐⭐ WebView有差异</td><td>⭐⭐⭐⭐⭐ 自带浏览器，表现统一</td></tr><tr><td><strong>安全性</strong></td><td>⭐⭐⭐⭐ 攻击面小</td><td>⭐⭐⭐ Node+前端=风险大</td></tr></tbody></table>
<p>针对我来说 ，我主要有两个目的 ：</p>
<ul>
<li>我更倾向于带<strong>传统后端能力</strong>的结构，要<strong>具有传统后端的复杂逻辑处理能力和优秀的性能</strong></li>
<li>我需要一个<strong>美观的 APP 样式</strong> ，在样式层面 ，没有什么语言比 JavaScript 更强了</li>
<li>我需要<strong>更小的应用体积</strong> ，方便转发</li>
<li>我需要更接近脚本的<strong>简单语法</strong> ，逻辑更简单 ，代码更轻松 , 0 基础就可以通过AI实现</li>
</ul>
<p>结合这些 ，Go + Wails 真的是一个完美的选择。</p>
<h2 data-id="heading-3">四. 简单说说 Go-Wails</h2>
<p>Wails = <strong>Go后端</strong> + <strong>Web前端</strong> + 系统WebView，打包成一个轻量原生桌面应用.</p>
<blockquote>
<p>Wails 具体干了三件事</p>
</blockquote>
<p><strong>第一件：嵌入一个浏览器窗口</strong></p>
<p><strong>Wails 不会自带浏览器内核，而是借用操作系统已有的</strong>。Windows 上用 WebView2（就是 Edge 的内核），macOS 上用 WebKit（Safari 的内核），Linux 上用 WebKitGTK。你的前端代码（HTML、CSS、JS）就在这个窗口里渲染，和在浏览器里打开网页没什么区别。</p>
<p><strong>第二件：搭一座桥让 JS 和 Go 互相调用</strong></p>
<p>这是 Wails 最核心的能力。正常情况下，前端想调用后端需要发 HTTP 请求。但 <strong>Wails 生成了一层绑定代码，让你在 JS 里可以直接调用 Go 函数</strong>，就像调用本地函数一样，不需要自己写接口、处理请求响应。Go 函数的返回值会直接传回给 JS。反过来，Go 也可以向前端发送事件，前端监听就行。</p>
<p><strong>第三件：把所有东西打包成一个文件</strong></p>
<p>打包时，Wails 会<strong>把前端的 HTML、CSS、JS 全部嵌入到 Go 的二进制文件里</strong>。最终产物就是一个可执行文件，用户双击就能运行，不需要额外安装任何东西。</p>
<p><em>这一篇不是教程文档 ，这东西 AI 一查一大把 ，这里就不细说了。</em></p>
<h2 data-id="heading-4">五. 上代码</h2>
<p>@ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fantblack%2Fant_go_wails_scaffold" target="_blank" title="https://gitee.com/antblack/ant_go_wails_scaffold" ref="nofollow noopener noreferrer">gitee.com/antblack/an…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30918d869b024ebcb5e3a77fd3e054a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=8WuhUTy5%2F6b9cMenQvur3olTR1Q%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>打包后的大小（PS ：这里我没有试过分发后能不能开箱就用，哈哈哈）</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf34c28be8345e6bcf9a8646267488a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324599&amp;x-signature=J%2BAHml%2FkEpHZ4wm2esnu4%2BtHU3g%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">总结</h2>
<p>能在这么短的时间构建出这么好的一个项目 ，并且<strong>打包只需要小小的15M</strong> . 启动还是秒开，我觉得未来我的大部分项目应该都会基于这个项目实现。</p>
<p>如果你现在想找到一个好用的桌面端框架体系 ，可以考虑这个。</p>
<p><strong>0基础 + AI 就可以轻松的实现复杂的功能 ，真的太适合AI了</strong>。</p>
<h2 data-id="heading-6">最后的最后 ❤️❤️❤️👇👇👇</h2>
<ul>
<li>👈  <strong>欢迎关注</strong>  ，超200篇优质文章，未来持续高质量输出 🎉🎉</li>
<li><a href="https://juejin.cn/post/6941642435189538824" target="_blank" title="https://juejin.cn/post/6941642435189538824">🔥🔥🔥 系列文章集合，高并发，源码应有尽有 👍👍 </a></li>
<li>走过路过不要错过 ，知识无价还不收钱 ❗❗</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding时代：人人都是开发者]]></title>    <link>https://juejin.cn/post/7583574154340532233</link>    <guid>https://juejin.cn/post/7583574154340532233</guid>    <pubDate>2025-12-14T13:54:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583574154340532233" data-draft-id="7583567658253221914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding时代：人人都是开发者"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T13:54:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding时代：人人都是开发者
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:54:13.000Z" title="Sun Dec 14 2025 13:54:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>编程领域正在经历一场静默的革命。根据2024年Stack Overflow开发者调查报告，<strong>超过70%的专业开发者已在使用AI辅助编程工具</strong>，这正在改变软件的生产方式、开发者的工作定义，甚至谁有资格被称为“开发者”。</p>
<p>这场革命的核心是一种名为Vibe Coding的新范式，它正在让编程从一门需要精确语法的专业技能，转变为一种更接近自然思考的创作活动。</p>
<hr/>
<h2 data-id="heading-0">01 编程范式的第三次跃迁</h2>
<p>要理解Vibe Coding的颠覆性，我们可以回顾编程演进的历程。</p>
<p>编程语言的发展经历了从机器语言（0和1）、汇编语言到高级语言的巨大飞跃，其核心趋势是<strong>不断贴近人类自然思维</strong>。Vibe Coding正是这一趋势的当下顶点，它试图用我们日常使用的语言（英语、中文等）直接驱动计算机。</p>
<p>其定义的核心在于三个转变：<strong>交互方式</strong>从编写精确语法转变为描述意图；<strong>开发者角色</strong>从代码工匠转变为解决方案架构师；<strong>开发流程</strong>从线性设计-编码-测试转变为与AI对话的快速迭代循环。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/228b9be7f8c447b5931d7e247e74eb7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325253&amp;x-signature=YZXEBiT%2BpK8CWzb4EzG3fipJNzU%3D" alt="编程范式跃迁.png" loading="lazy"/></p>
<h2 data-id="heading-1">02 Vibe Coding究竟能做什么？</h2>
<p>Vibe Coding并非万能，但在特定场景下，它正展现出惊人的生产力。</p>
<p>其最擅长的领域是<strong>快速原型构建</strong>。无论是验证一个新功能想法，还是为创业项目搭建最小可行产品（MVP），开发者可以用自然语言描述需求，在几小时而非几天内获得可运行的原型。这极大降低了创新试错的门槛与成本。</p>
<p>另一个高价值应用是<strong>开发自动化脚本与个性化工具</strong>。处理重复性文件整理、数据格式转换、信息监控等“琐事”，只需对AI清晰描述任务，即可获得一个定制化的一次性脚本。</p>
<p>对于<strong>教育与学习</strong>，它改变了入门路径。新手可以将精力集中于理解程序逻辑、数据结构和算法思想，而不必在初期就被复杂的语法细节所绊住。</p>
<p>值得注意的是，Vibe Coding的能力正通过平台级工具被增强。例如，腾讯云推出的CloudBase AI CLI，允许开发者在命令行中用自然语言直接调度多种AI编码能力，并将生成的代码与云服务部署流程打通。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d227813592304a048adbee548e4aed7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325253&amp;x-signature=Z6FNNx6gn90lb1sY5KoAO8BawqA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">03 技术围墙崩了</h2>
<p>对于非专业背景人士，Vibe Coding确实像一把打开编程世界大门的钥匙。它极大地缓解了初学者的“启动焦虑”——无需记忆大量命令和语法规则，即可开始创造。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5452ac2315ef46c88881f95c5e218804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325253&amp;x-signature=uonl%2FYNpqrvPK9%2BHCsKr9rMk1s4%3D" alt="image.png" loading="lazy"/></p>
<p>这意味着，产品经理可以直接构建交互原型，数据分析师能编写定制化处理脚本，自媒体博主可为自己的网站添加小功能。<strong>编程从目的本身，回归为实现创意的工具。</strong></p>
<p>然而，这不意味着专业性的终结。Vibe Coding目前更擅长完成<strong>目标明确、边界清晰、逻辑相对线性</strong>的任务。当问题异常复杂、需要深刻领域知识或权衡多重约束时，人类专家的系统思维和抽象能力依然不可替代。对于非专业人士，理解基础的编程概念（如循环、条件判断、变量）将帮助你更有效地与AI协作，从“能运行”走向“运行得好”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f7ed2ce8f24bf3aa741928fbd7a7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325253&amp;x-signature=wYCtOD4sckqHtUJoFV8BkK7yKvY%3D" alt="AI对话开发流程.jpg" loading="lazy"/></p>
<h2 data-id="heading-3">04 Vibe Coding对开发者而言，是敌是友？</h2>
<p>对于专业程序员，Vibe Coding带来的不是替代，而是深刻的<strong>专业价值重构</strong>。</p>
<p>程序员的角色正从“代码实现者”加速转向“<strong>问题定义者</strong>”和“<strong>系统架构师</strong>”。最有价值的技能变为：将模糊、复杂的业务需求，分解为清晰、可被AI执行的技术指令序列的能力。</p>
<p>同时，<strong>质量守门人</strong>的角色变得前所未有的重要。AI可以生成大量代码，但对其安全性、性能、可维护性以及是否符合业务本质的最终判断，必须由人类工程师负责。审查和重构AI生成的代码，将成为核心工作流之一。</p>
<p>此外，驾驭复杂系统的能力变得更为稀缺。AI擅长处理局部模块，但对于大型系统中各模块间的交互、数据流设计、长期技术债务的管控，仍需要人类的高级抽象和规划能力。</p>
<p>因此，程序员应积极将Vibe Coding工具整合为“<strong>超级辅助</strong>”，让其处理重复性编码，从而释放精力聚焦于更具创造性和决定性的高层设计。</p>
<h2 data-id="heading-4">05 主流工具与务实选择</h2>
<p>面对众多工具，如何选择取决于你的核心需求。以下是当前主流工具的简明对比：</p>
<p><strong>腾讯CodeBuddy</strong>的优势在于企业级安全合规与微信生态深度集成，非常适合国内企业环境或有微信小程序开发需求的团队。</p>
<p><strong>Cursor</strong>以其极致的AI原生编辑体验著称，适合追求高效率、需要频繁与AI对话进行代码重构和生成的独立开发者或小团队。</p>
<p><strong>GitHub Copilot</strong>凭借其与Visual Studio Code等主流编辑器的深度集成和海量的训练数据，在代码补全的准确性和流畅度上表现突出，是许多通用场景下的稳妥选择。</p>
<p><strong>Replit</strong>提供了零配置的云端开发环境，让初学者完全免去环境搭建的烦恼，打开浏览器就能立即开始与AI结对编程，特别适合教育和快速原型演示。</p>
<p>选择时，一个务实的建议是：明确你当前最需要解决的痛点——是追求极致开发速度、确保企业合规，还是需要最无缝的上手体验。</p>
<h2 data-id="heading-5">06 第一步：你的首个Vibe Coding项目</h2>
<p>如果你从未写过代码但想立即体验，可以遵循以下极简路径：</p>
<ol>
<li><strong>环境准备</strong>：访问Replit官网（replit.com）并注册，或在你常用的代码编辑器（如VS Code）中安装GitHub Copilot扩展。这是最快开始的方式。</li>
<li><strong>明确任务</strong>：想一个你电脑上需要自动化的小事，例如：“把所有散乱的截图文件，按‘年-月’的格式自动归类到文件夹里。”</li>
<li><strong>发起对话</strong>：在工具中，用清晰的中文或英文向AI描述这个任务。可以补充细节，如“源文件夹在桌面，图片格式主要是.png和.jpg”。</li>
<li><strong>运行与调试</strong>：直接运行生成的代码。如果报错，将完整的错误信息复制给AI，请它修复。如果结果不对（比如文件没挪动），向AI描述你看到的现象。</li>
<li><strong>迭代与理解</strong>：重复步骤4，直到成功。之后，可以请AI为代码添加注释，帮助你理解它到底是如何工作的。</li>
</ol>
<p>记住，关键不是一次成功，而是建立起“<strong>描述-生成-反馈</strong>”的有效协作循环。从一个能带来微小成就感的具体任务开始，是保持学习动力的最佳方式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2586dc1f2544667b7e5596938da4eed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325253&amp;x-signature=2%2F6aF0s4mYDaWOjcskjb2QJFIqw%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p>编程的民主化进程已被Vibe Coding再次加速。工具在变，但创造的本质不变：将头脑中的想法，转化为现实世界中可运行、可交互的产物。</p>
<p>无论你是想提升效率的职场人，还是探索边界的技术专家，现在都可以用一种更自然的方式与机器对话。这场变革的终点，不是人人成为程序员，而是让创造软件的能力，像使用办公软件一样，成为现代人扩展思维与能力的延伸。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀Claude Code被封号？用谷歌Antigravity+Claude Opus 4.5轻松替代！实测项目重构+全栈开发效果惊艳！Opus 4.5 才王道]]></title>    <link>https://juejin.cn/post/7583215836690677801</link>    <guid>https://juejin.cn/post/7583215836690677801</guid>    <pubDate>2025-12-14T13:53:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583215836690677801" data-draft-id="7583260493851312169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀Claude Code被封号？用谷歌Antigravity+Claude Opus 4.5轻松替代！实测项目重构+全栈开发效果惊艳！Opus 4.5 才王道"/> <meta itemprop="keywords" content="Claude,VibeCoding,Gemini"/> <meta itemprop="datePublished" content="2025-12-14T13:53:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀Claude Code被封号？用谷歌Antigravity+Claude Opus 4.5轻松替代！实测项目重构+全栈开发效果惊艳！Opus 4.5 才王道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:53:39.000Z" title="Sun Dec 14 2025 13:53:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">被Claude Code封号搞疯了？试试这个方案</h2>
<p>最近在AI编程圈子里，有个话题被反复提起：Claude Code封号。</p>
<p>不少开发者跟我吐槽过类似的经历——花钱订阅了Claude官方账号，满心欢喜地打开Claude Code准备大干一场，结果用不到一天，账号就被封了。客服也联系不上，申诉也没用，钱打了水漂不说，项目进度也被耽误。</p>
<p>🔥🔥🔥本篇笔记所对应的视频： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1ikmiBjEin%2F" target="_blank" title="https://www.bilibili.com/video/BV1ikmiBjEin/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1ik…</a></p>
<p>说实话，这种体验确实挺糟心的。</p>
<p>不过最近我发现了一个还不错的替代方案，想跟大家聊聊。谷歌发布的AI编程助手Antigravity，前段时间悄悄加入了对Claude Opus 4.5的支持。这对于那些想用Opus 4.5但又被封号问题困扰的朋友来说，算是个好消息。</p>
<hr/>
<h3 data-id="heading-1">先说说Antigravity是什么</h3>
<p>Antigravity是谷歌推出的一款AI编程工具，目前已经全面支持macOS、Windows和Linux三大系统。它最大的特点是支持多智能体异步工作，简单说就是可以让多个AI同时干活，一个负责前端，一个负责后端，互不干扰。</p>
<p>这个功能在实际开发中其实挺实用的。比如你在做一个全栈项目，以前可能要等前端写完再写后端，或者来回切换。现在可以让两个智能体同时推进，效率确实能提升不少。</p>
<p>安装过程没什么好说的，去官网根据自己的系统下载安装包，一路下一步就行。</p>
<hr/>
<h3 data-id="heading-2">配置这块稍微花点心思</h3>
<p>安装完之后，我建议先花几分钟做一些基础配置，后面用起来会顺手很多。</p>
<p>首先是规则文件。点击右上角的三个点，再点自定义，找到规则设置。这里可以设置全局规则，告诉AI你的技术栈是什么、用什么版本、有哪些代码规范之类的。</p>
<p>我自己的配置大概是这样：Python部分写清楚用的是3.11版本，虚拟环境用venv创建，代码风格遵循PEP8规范。前端部分写的是Next.js 14版本，样式用Tailwind CSS，后端数据库用Supabase。</p>
<p>这些规则设置好之后，AI在写代码的时候就会自动遵循，不用每次都在提示词里重复说明。</p>
<p>另一个值得配置的是MCP（Model Context Protocol）。如果你用Supabase做后端，强烈建议把Supabase的MCP装上。装好之后，AI可以直接通过MCP操作你的数据库，创建表、设置权限这些活儿都能自动完成，省去了很多手动操作。</p>
<p>配置MCP需要填入Supabase的access token。登录Supabase后台，点右上角头像进入账户设置，找到access tokens，生成一个新的token复制过来就行。过期时间可以设成不过期，省得以后还要换。</p>
<p>顺便说一句Supabase这个东西。如果你还没用过，可以把它理解成做APP或者网站的后端全家桶。数据库、用户登录、文件存储、实时更新这些功能它都打包好了，不用自己从零搭建。特别适合做MVP或者快速验证想法的场景。</p>
<hr/>
<h3 data-id="heading-3">实际效果怎么样？跑两个案例看看</h3>
<p>光说不练假把式，我用两个案例测试了一下Antigravity配合Claude Opus 4.5的实际表现。</p>
<p><strong>第一个案例：智能体框架重构</strong></p>
<p>这个测试题是把微软智能体框架写的代码，重构成谷歌ADK智能体框架。同时还要求把大模型接口换成Mistral AI的，模型用Mistral Large 3。</p>
<p>说实话，这个任务不算简单。涉及到两个不同框架的语法转换，还要换模型接口，保持原有功能逻辑不变，最后还得加上谷歌ADK的UI界面。</p>
<p>我把提示词发过去之后，AI先花了一点时间阅读谷歌ADK的官方文档，然后开始动手。整个过程比我预想的要快，它自动创建了虚拟环境，安装了项目依赖，生成了重构后的代码。</p>
<p>跑起来测试了一下，输入"规划三天的尼泊尔旅行计划"，输出结果分三部分：旅行规划、当地特色活动、还有当地常用语。这个执行逻辑跟原来微软框架版本的智能体基本一致，说明重构是成功的。</p>
<p>值得一提的是，同样这道题我之前在Codex里用GPT5.2测试过，没跑通。Opus 4.5在这个任务上的表现确实更好一些。</p>
<p><strong>第二个案例：从零开发宠物领养平台</strong></p>
<p>第二个测试更复杂一点，让AI从零开发一个宠物领养平台的MVP。</p>
<p>这次我用了Antigravity的planning模式。先让Claude Sonnet 4.5制定开发计划，等计划确定之后，再切换到Claude Opus 4.5执行。这种组合用法挺聪明的，规划阶段用便宜一点的模型，执行阶段再上主力。</p>
<p>整个开发过程大概花了十分钟左右。AI先初始化了Next.js项目，然后创建数据库schema，接着一步步实现各个功能模块。</p>
<p>最终跑起来的效果还是让我挺惊喜的。首页设计得挺现代的，有导航栏、领养步骤说明、宠物展示区。登录功能支持邮箱注册、谷歌登录和GitHub登录。用户可以发布宠物领养信息，上传照片，填写品种、年龄、性格这些详细信息。</p>
<p>中间遇到了一个小bug，上传的宠物图片没有正确显示。我把浏览器里的元素内容复制给AI，它很快定位到是Supabase存储权限的问题，一次就修好了。</p>
<p>整体来说，这个MVP的完成度比我用GPT5.2做的那版要高不少。UI更精致，功能也更完整。</p>
<hr/>
<h3 data-id="heading-4">额度够用吗？</h3>
<p>用AI编程工具，大家最关心的问题之一就是额度。毕竟写代码是个消耗token的大户，动不动就要处理几百上千行代码。</p>
<p>我用的是Antigravity的Pro账户。在完成上面两个案例之后——一个是框架重构，一个是完整的全栈项目开发——我又新开了一个窗口测试Claude Opus 4.5还能不能用。</p>
<p>结果是完全正常，没有任何限制提示。</p>
<p>这个结果让我还挺意外的。要知道那个宠物领养平台生成了相当多的代码，README文件、数据库迁移脚本、前端组件、API接口，加起来代码量不小。但Opus 4.5的额度似乎还很充裕。</p>
<p>当然，我没有做极限压力测试，不知道连续高强度使用一整天会不会触发限制。但至少从目前的使用体验来看，Pro账户的额度应付日常开发是够用的。</p>
<hr/>
<h3 data-id="heading-5">一些使用建议</h3>
<p>用了一段时间之后，总结几点使用建议：</p>
<p>对于简单任务，比如改个bug、写个小功能，可以直接用fast模式，选择Gemini 3 Pro这种轻量级模型就够了，没必要每次都上Opus 4.5。</p>
<p>对于复杂项目，建议用planning模式，先让AI制定计划再执行。而且可以组合使用不同模型，规划阶段用Sonnet，执行阶段用Opus。</p>
<p>规则文件一定要好好写。花十分钟把技术栈、代码规范、项目结构这些东西写清楚，后面能省很多沟通成本。</p>
<p>MCP能装就装。特别是Supabase的MCP，让AI直接操作数据库这个功能真的很方便，省去了很多手动配置的麻烦。</p>
<hr/>
<h3 data-id="heading-6">最后</h3>
<p>Antigravity加上Claude Opus 4.5这个组合，确实可以在一定程度上替代Claude Code。对于那些被封号问题困扰的开发者来说，这是目前我找到的比较靠谱的替代方案。</p>
<p>当然，它也不是完美的。比如有些操作还是需要手动完成，比如设置环境变量之类的。但整体体验已经相当不错了，值得一试。</p>
<p>如果你也在找Claude Code的替代品，可以试试看。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从罗永浩 x MiniMax 闫俊杰对谈中，一窥 AI 时代软件公司岗位变化]]></title>    <link>https://juejin.cn/post/7583226204036235305</link>    <guid>https://juejin.cn/post/7583226204036235305</guid>    <pubDate>2025-12-14T13:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036235305" data-draft-id="7582997593090981907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从罗永浩 x MiniMax 闫俊杰对谈中，一窥 AI 时代软件公司岗位变化"/> <meta itemprop="keywords" content="人工智能,敏捷开发,程序员"/> <meta itemprop="datePublished" content="2025-12-14T13:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈佬昔编程人生"/> <meta itemprop="url" content="https://juejin.cn/user/3087084378402445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从罗永浩 x MiniMax 闫俊杰对谈中，一窥 AI 时代软件公司岗位变化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084378402445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈佬昔编程人生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:55:36.000Z" title="Sun Dec 14 2025 13:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>《罗永浩的十字路口》第十三期邀请到的是闫俊杰。</p>
<p>跟前几期偏娱乐向的嘉宾不同，闫俊杰是一个硬核的 AI 公司 Mini Max 的创始人。</p>
<p>近四个小时的对谈中，让我对这家 AI 公司有了进一步的了解，也窥见了软件开发行业的一些变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550ec73d21bc418f9f84a83e4dd0df52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325335&amp;x-signature=0xol1TexIy29RHiIPBXMd2WKYVg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">岗位角色边界模糊</h2>
<p>Mini Max 是一家 AI 原生的公司，目前只有 400 多人，相对于几大巨头的互联网企业来说，规模是很小的。</p>
<p>闫俊杰认为公司没有严格的“岗位”划分，而是有几种不同的 <strong>“人才画像”</strong>。公司追求组织内人才的<strong>多样性</strong>，他认为这类似于 AI 模型需要多样性，这样可以提升公司及个人的能力上限。</p>
<p>因此，MiniMax 里的角色边界模糊化。虽然非技术人员（按传统定义）约占 <strong>三分之一</strong>，但这里的“非技术”界限模糊，大部分成员具备较强的技术理解或实践能力。</p>
<p>对谈中谈到的几个岗位角色的内容整理如下：</p>
<ul>
<li><strong>产品经理</strong>：很多是 <strong>非常年轻</strong> 的产品经理，特点是 <strong>对技术理解深</strong> 且 <strong>在产品上有天分</strong>。他们可以自己用 AI 做原型。</li>
<li><strong>开发与算法工程师</strong>：不仅负责实现，也能参与创意和产品设计。</li>
<li><strong>运营人员</strong>：优秀的运营需要能回答开发者，在社群中关于模型的 <strong>深度技术问题</strong>，对模型本身要足够懂。</li>
<li><strong>To B 解决方案/售前</strong>：传统角色是画 PPT，现在需要<strong>自己写代码做 Demo</strong> 给客户看，销售岗也需要懂技术。</li>
<li><strong>HR</strong>：会利用 AI 来辅助筛选简历、与候选人初步沟通。</li>
</ul>
<p>而这种角色定位的模糊，也带来了流程的重塑。</p>
<h2 data-id="heading-1">开发流程重塑</h2>
<p>闫俊杰明确表示尝试过 <strong>OKR等传统互联网管理工具</strong>，但发现<strong>行不通</strong>。</p>
<p>他认为AI原生公司需要 <strong>全新的组织协作方式</strong>。</p>
<p>在他们公司里，其实是没有固定的“产品提需求、开发排期”的线性流程。</p>
<p>开发流程是动态的，主导角色会发生变化。根据项目不同阶段，由最合适的角色主导，其他人深度参与：</p>
<ul>
<li><strong>脑暴与探索阶段</strong>：大家都可以有想法，通常由<strong>产品经理主导</strong>汇集。</li>
<li><strong>核心技术研发/算法攻坚阶段</strong>：由<strong>算法同学主导</strong>，但开发和产品人员会<strong>深度参与</strong>到模型研发过程中，而不是被动等待接收一个成品模型。</li>
<li><strong>开发实现阶段</strong>：由 <strong>开发同学主导</strong>，其他角色协作。</li>
</ul>
<p>而整个过程强调<strong>全链条的深度协同</strong>，而非传统的分段交接（产品→开发→测试）。</p>
<h2 data-id="heading-2">总结</h2>
<p>闫俊杰说，我们<strong>不应该认为“AI行业是互联网行业的一个延续”</strong>，所以，我们也不应该太在意在移动互联网时代，大家是怎么来分工的。</p>
<p>面对AI的融入，我们必须跳出过去的思维框架，重新审视工作的本质与协作方式。</p>
<p>这是给我最大的启示。</p>
<p>如果AI技术真正深入您所在的企业，原有的岗位分工很可能被彻底打破。那么，基于这一变革，您将<strong>如何重新规划和安排自己的工作？</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6.2 列传（第十一篇）：梅若华的执念与“浪子回头”的异步函数]]></title>    <link>https://juejin.cn/post/7583528177559584818</link>    <guid>https://juejin.cn/post/7583528177559584818</guid>    <pubDate>2025-12-14T12:18:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583528177559584818" data-draft-id="7583567658252976154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6.2 列传（第十一篇）：梅若华的执念与“浪子回头”的异步函数"/> <meta itemprop="keywords" content="Swift,Apple,编程语言"/> <meta itemprop="datePublished" content="2025-12-14T12:18:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6.2 列传（第十一篇）：梅若华的执念与“浪子回头”的异步函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:18:01.000Z" title="Sun Dec 14 2025 12:18:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d29d1332cc254f3a80cf5fae45ddca4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=hKhJSZVGWH839imfoaG92jqgnMU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">0. 🐼楔子：量子纠缠与发际线的危机</h2>
<p>在这个万物互联、元宇宙崩塌又重建的赛博纪元，大熊猫侯佩正面临着熊生最大的危机——不是由于长期熬夜写代码导致的黑眼圈（反正原本就是黑的），而是他引以为傲的头顶毛发密度。</p>
<p>“我再次声明，这不是秃，这是为了让 CPU 散热更高效而进化的‘高性能空气动力学穹顶’！”侯佩一边对着全息镜子梳理那几根珍贵的绒毛，一边往嘴里塞了一根<strong>钛合金风味竹笋</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81be4f18df684e52b11b2cbd64c11ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=XzEoOTpZXm4JqtlBtTmFNcZ5wQk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>为了修复一个名为“时空并发竞争”的超级 Bug，侯佩启动了最新的 <strong>Neural-Link 6.2</strong> 沉浸式代码审查系统。光芒一闪，数据流如同瀑布般冲刷而下，侯佩只觉得天旋地转，再睁眼时，已不在那个充满冷气机嗡嗡声的机房，而是一片阴风怒号的荒野。</p>
<p><strong>在本次大冒险中，您将学到如下内容：</strong></p>
<ul>
<li>
<ol start="0">
<li>🐼楔子：量子纠缠与发际线的危机</li>
</ol>
</li>
<li>
<ol>
<li>🌪️ 荒野遇盲女，九阴白骨爪</li>
</ol>
</li>
<li>
<ol start="2">
<li>🕸️ 默认在调用者的 Actor 上运行非隔离异步函数</li>
</ol>
<ul>
<li>📜 曾经的困惑（Swift 6.2 之前）</li>
</ul>
</li>
<li>
<ol start="3">
<li>🛠️ 新的规矩：浪子回头（SE-0461）</li>
</ol>
</li>
<li>
<ol start="4">
<li>🚪 逃生舱：如果你非要让他走 (@concurrent)</li>
</ol>
</li>
<li>
<ol start="5">
<li>🧬 深度解析：为什么这很重要？</li>
</ol>
</li>
<li>
<ol start="6">
<li>🏁 结局：风沙散去，墓碑显现</li>
</ol>
</li>
</ul>
<p>这里没有 WiFi 信号，只有遍地的白骨和漫天的黄沙。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccd1eec1bb374544ae5eaada08e69afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=r9GdAXYnPqa4as4W6fDqmkUVao8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1. 🌪️ 荒野遇盲女，九阴白骨爪</h2>
<p>“哎呀，这导航又把我带到哪了？我就说高德地图在四维空间里不靠谱！”侯佩挠了挠头，路痴属性稳定发挥。</p>
<p>忽然，一阵凄厉的破空声传来。</p>
<p>“贼汉子，哪里跑！”</p>
<p>一道黑影如鬼魅般袭来，那是一双惨白如玉的手爪，五指如钩，直取侯佩的天灵盖。侯佩大惊失色，虽然他肉厚抗揍，但这<strong>九阴白骨爪</strong>的阴寒之气要是抓实了，恐怕不仅发际线不保，连头盖骨都要变成标本。</p>
<p>“女侠饶命！我只是个路过的熊猫，身上只有9元竹笋，没有《九阴真经》啊！”侯佩一个懒驴打滚，堪堪避开。</p>
<p>那黑衣女子长发披肩，双目虽盲，但听声辨位之术已臻化境。她正是被逐出桃花岛、漂泊半生的<strong>梅超风</strong>（本名梅若华）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798f7156f3844c189151275b77fa894f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=U5snf2%2FaqwCa8DUm1AsfhDXU1ck%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>梅超风停下身形，空洞的眼神望向侯佩的方向，神色凄苦：“你这声音……憨傻中透着一股油腻，不像江南七怪，倒像是一头……很胖的熊？”</p>
<p>“是国宝！而且是很帅的国宝！”侯佩整理了一下领结（虽然没穿衣服），“梅姐姐，你这招式虽然凌厉，但好像总是<strong>无法在正确的线程上命中目标</strong>啊？是不是觉得内力运转时，总是莫名其妙地‘跳’到了别的地方？”</p>
<p>梅超风身躯一震：“你怎么知道？我苦练九阴真经，每当运功至关键时刻（异步调用），真气便会不受控制地散逸到荒野之外（后台线程），无法与我本体（Actor）合二为一。难道……你是师父派来指点我的？”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21f24b2e6784e6a97209c780cb8aa66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=Em4hzuPH5bAxd6kY9UmwaUJWKZ8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩咬了一口竹笋，推了推并不存在的眼镜：“咳咳，算是吧。今天我就借着 <strong>SE-0461（Run nonisolated async functions on the caller's actor by default）</strong> 号秘籍，来解开你这半生漂泊的心结。”</p>
<h2 data-id="heading-2">2. 🕸️ 默认在调用者的 Actor 上运行非隔离异步函数</h2>
<p>侯佩盘腿坐在一堆骷髅头上，开始了他的技术讲座。</p>
<p>“梅姐姐，你现在的武功（代码逻辑），就像 Swift 6.2 之前的情况。”</p>
<p>侯佩在沙地上画了一个架构图：</p>
<blockquote>
<p>“在 SE-0461 提案之前，一个 <code>nonisolated async</code> 函数（非隔离异步函数），就像是一个<strong>生性凉薄的浪子</strong>。不管是谁召唤它，哪怕是位高权重的 <strong>MainActor</strong>（桃花岛主），这浪子一旦开始干活（执行），就会立刻跳槽，跑到<strong>通用的后台线程池</strong>里去瞎混。”</p>
</blockquote>
<p>“这就是为什么你觉得真气（数据）总是游离在你的掌控之外。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6039b5ed48d34639a97c998992e34e7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=q1%2BSP%2BNFY4k3JkL7o1RfS7940BA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">📜 曾经的困惑（Swift 6.2 之前）</h3>
<p>让我们来看看这段令无数英雄竞折腰的代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 一个负责测量数据的结构体，它没有任何 Actor 隔离，是个自由人</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Measurements</span> {
    <span class="hljs-comment">// 这是一个 nonisolated async 函数</span>
    <span class="hljs-comment">// 就像当年的陈玄风，虽然功夫高，但心不在桃花岛</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchLatest</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">Double</span>] {
        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://hws.dev/readings.json"</span>)<span class="hljs-operator">!</span>
        <span class="hljs-comment">// 这里发生了异步等待</span>
        <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode([<span class="hljs-type">Double</span>].<span class="hljs-keyword">self</span>, from: data)
    }
}
</code></pre>
<p>接着，我们有一个<strong>桃花岛气象站</strong>，它是被 <code>@MainActor</code> 严格管辖的领地：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeatherStation</span> {
    <span class="hljs-keyword">let</span> measurements <span class="hljs-operator">=</span> <span class="hljs-type">Measurements</span>()

    <span class="hljs-comment">// 这是一个在主线程（桃花岛）运行的方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getAverageTemperature</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Double</span> {
        <span class="hljs-comment">// ⚠️ 重点来了：</span>
        <span class="hljs-comment">// 在 Swift 6.2 之前，虽然这行代码是在 MainActor 里写的</span>
        <span class="hljs-comment">// 但 fetchLatest() 会立刻跳出 MainActor，跑去后台线程执行</span>
        <span class="hljs-keyword">let</span> readings <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> measurements.fetchLatest()
        
        <span class="hljs-keyword">let</span> average <span class="hljs-operator">=</span> readings.reduce(<span class="hljs-number">0</span>, <span class="hljs-operator">+</span>) <span class="hljs-operator">/</span> <span class="hljs-type">Double</span>(readings.count)
        <span class="hljs-keyword">return</span> average
    }
}

<span class="hljs-keyword">let</span> station <span class="hljs-operator">=</span> <span class="hljs-type">WeatherStation</span>()
<span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-built_in">print</span>(station.getAverageTemperature())
</code></pre>
<p>梅超风听得入神：“你是说，以前哪怕我在桃花岛（MainActor）召唤陈玄风（<code>fetchLatest</code>），他也会立刻跑到大漠（后台线程）去练功？”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d1b9f4a95f0484ea36d660bf079038f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=9k7j4eBokudgl6wr4315Andc30s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“没错！”侯佩一拍大腿，“这就是 <strong>SE-0338</strong> 当年定下的规矩——非隔离异步函数‘不在任何 Actor 的执行器上运行’。这导致了无数的<strong>数据竞争</strong>和<strong>逻辑混淆</strong>，就像你和陈玄风偷了经书私奔，结果把自己练得人不人鬼不鬼。”</p>
<h2 data-id="heading-4">3. 🛠️ 新的规矩：浪子回头（SE-0461）</h2>
<p>“但是！”侯佩话锋一转，眼中闪烁着智慧的光芒（也有可能是饿出来的绿光），“Swift 6.2 带来了 <strong>SE-0461</strong>，一切都变了。”</p>
<p><strong>新的规则是：非隔离异步函数现在默认在“调用者的 Actor”上运行。</strong></p>
<p>“这意味着什么？”侯佩指着天空，“意味着如果你身在桃花岛（MainActor），你召唤的招式（<code>fetchLatest</code>）就会老老实实地呆在桃花岛（MainActor）执行，不再四处乱跑了！”</p>
<p>在 Swift 6.2 及以后：</p>
<ul>
<li><code>getAverageTemperature</code> 是 <code>@MainActor</code>。</li>
<li>它调用了 <code>measurements.fetchLatest()</code>。</li>
<li><code>fetchLatest</code> 是非隔离的。</li>
<li><strong>结果：</strong> <code>fetchLatest</code> 会自动继承调用者的上下文，<strong>直接在 <code>@MainActor</code> 上运行</strong>。</li>
</ul>
<p>梅超风空洞的眼中似乎流下了一行清泪：“若当年有此规则，我和师兄便不会离岛，也不会落得如此下场……”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79db9f44c81a4d208a4410b33e98ba4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=pimBGRQPlypyayntPH5ir7UGbOY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“是啊，”侯佩感叹道，“这叫<strong>上下文亲和性（Context Affinity）</strong>。这不仅减少了线程切换的开销（就像省去了跑路的盘缠），还让代码逻辑更符合直觉——你在哪调用的，它就在哪跑。”</p>
<h2 data-id="heading-5">4. 🚪 逃生舱：如果你非要让他走 (@concurrent)</h2>
<p>梅超风忽然神色一冷：“但若是我真的想让他走呢？若是我为了练就绝世武功，必须让他去极寒之地（后台线程）吸取地气呢？”</p>
<p>“问得好！”侯佩竖起大拇指（如果熊猫有的话），“如果你怀念旧的行为，或者为了性能考虑（比如不想阻塞主线程），想明确地把这个函数‘逐出师门’，你可以使用新的关键字：<code>@concurrent</code>。”</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Measurements</span> {
    <span class="hljs-comment">// 加上 @concurrent，就是给了他一封休书</span>
    <span class="hljs-comment">// 告诉编译器：这个函数必须并发执行，不要粘着调用者！</span>
    <span class="hljs-meta">@concurrent</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchLatest</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">Double</span>] {
        <span class="hljs-comment">// ... 代码同上</span>
    }
}
</code></pre>
<p>“加上 <code>@concurrent</code>，就像是你对他喊了一句：‘滚！’。于是，他又变回了那个在后台线程游荡的浪子。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd206cac07334e89a5a47dfcbcb25dc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=DWYlBJmMQGNgFapAF6W6Z%2Bt1mjc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-6">5. 🧬 深度解析：为什么这很重要？</h2>
<p>侯佩看着梅超风似懂非懂的样子，决定再深入解释一下（以此展示自己深厚的技术功底）：</p>
<ol>
<li><strong>直觉一致性</strong>：以前开发者在 <code>@MainActor</code> 的 View Model 里写个辅助函数，总以为它是安全的，结果它悄悄跑到了后台，访问 UI 属性时直接 Crash。现在，它乖乖听话了。</li>
<li><strong>性能优化</strong>：少了无谓的 Actor 之间的“跳跃”（Hopping），程序的任督二脉打通了，运行更流畅。</li>
<li><strong>Sendable 检查</strong>：由于现在函数可能在 Actor 内部运行，编译器在检查数据安全性（Sendable）时的策略也会更智能。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/850188419d0744c0b39b7840d6a24f2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=u3YlcV2eIW7BrEqx%2BzVHFPqTiZQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-7">6. 🏁 结局：风沙散去，墓碑显现</h2>
<p>梅超风听完，仰天长啸，啸声中充满了释然。她枯瘦的手掌缓缓放下，一身戾气似乎消散了不少。</p>
<p>“原来如此，原来是我一直执着于‘非隔离’的自由，却忘了‘隔离’才是归宿。”她喃喃自语，身影逐渐变得透明，仿佛要融入这片虚拟的代码荒原。</p>
<p>“喂！梅姐姐，别走啊！我还没问你《九阴真经》里有没有治疗脱发的方子呢！”侯佩伸手去抓，却抓了个空。</p>
<p>场景开始剧烈震动，荒野崩塌，地面裂开。一座巨大的黑色石碑缓缓升起，挡住了侯佩的去路。石碑上刻着一行闪着红光的代码，散发着危险的气息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78cab4c8a8da41c7bdbcc6b32b246999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=cNDVH51UyPtVyiq2dQ7UB78qtls%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩凑近一看，只见石碑上写着几个大字：<strong>Actor-isolated Deinit</strong>。</p>
<p>与此同时，梅超风消失的地方，传来最后一句话：“<strong>在这个世界，生有时，死亦有时。当一个 Actor 走向毁灭（deinit）时，你该如何安全地处理它的遗产？</strong>”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d725c1ef29cb4d9fa530539b9a01b6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319480&amp;x-signature=020p3YuXQFr6ytHgEXEpHLCW%2FSc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩只觉得背后一凉，因为他看到石碑后伸出了一只手……</p>
<hr/>
<p><strong>欲知后事如何，且看下回分解：</strong></p>
<p>🐼 <strong>Swift 6.2 列传（第十二篇）：杨不悔的“临终”不悔与 Isolated Deinit</strong>
<em>(Introducing Isolated synchronous deinit - SE-0371)</em></p>
<blockquote>
<p><strong>下集预告：</strong>
当一个 Actor 对象被销毁时，如何确保它能安全地访问内部的数据？如果你在 <code>deinit</code> 里写了并发代码，会不会导致程序直接炸裂？SE-0371 将教你如何给 Actor 的临终遗言加上一把安全的锁。侯佩能从这座“析构之墓”中逃脱吗？敬请期待！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Embedding 模型word2vec/glove/fasttext/elmo/doc2vec/infersent学习总结]]></title>    <link>https://juejin.cn/post/7583168260797612072</link>    <guid>https://juejin.cn/post/7583168260797612072</guid>    <pubDate>2025-12-14T12:22:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583168260797612072" data-draft-id="7583234966634987554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Embedding 模型word2vec/glove/fasttext/elmo/doc2vec/infersent学习总结"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-14T12:22:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Embedding 模型word2vec/glove/fasttext/elmo/doc2vec/infersent学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:22:08.000Z" title="Sun Dec 14 2025 12:22:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">静态词向量Embeding 模型</h2>
<h3 data-id="heading-1">work2vec： 靠 “猜邻居” 学向量：</h3>
<ul>
<li>1 将物料中的所有词赋值初始值，定好维度和窗口大小(即中心词邻居个数，也是此次学习的上下文长度)，比较常用的维度是(100/300)</li>
<li>2 CBOW(用邻居猜中心词)和Skip-gram（用中心词猜邻居)，两种方法的区别：
<ul>
<li>CBOW：用邻居猜中心词，语料小、高频词多，训练快，对高频词的向量效果好</li>
<li>Skip-gram：用中心词猜邻居，语料大、低频词多，训练慢一点，但对低频词的向量效果更好</li>
<li>CBOW 和 Skip-gram 是训练模式，二选一，看语料大小和词频选</li>
<li>比如 CBOW方法：
<ul>
<li>① 从句子里挑一个中心词（比如 “吃”），再圈出它的邻居词（比如 “我、爱、苹果”，窗口为 3）；</li>
<li>② 把 3 个邻居词的向量加起来作为加总向量，然后让窗口中的每一个词向量权重乘以加总向量得到概率值，再进行 softmax 处理(其实就是一个简单的神经网络)</li>
<li>③ 错误的话就使用反向传播，调整邻居词和中心词的向量，让下次猜得更准</li>
</ul>
</li>
</ul>
</li>
<li>3 简化游戏：如果每次都猜"中心词"那计算效率将会非常慢，所以可以"作弊"：
<ul>
<li>1 负采样：只猜 “真邻居 vs 假邻居”
<ul>
<li>原来的麻烦：要让模型猜 “中心词是词汇表里的哪一个”，比如词汇表有 1 万个词，就要算 1 万次得分，非常慢</li>
<li>作弊思路：不猜所有词，只挑几个词做对比：
<ul>
<li>选 1 个正样本：就是真实的中心词+真邻居（比如“爱” 是中心词， “我、吃” 作为真邻居）；</li>
<li>选 5~20 个负样本：从词汇表里随机抽几个不相关的词，中心词+假邻居（比如“爱” 是中心词， “汽车、桌子” 作为假邻居）；</li>
<li>让模型只做一件事：区分 “正样本是真邻居”，“负样本是假邻居”。</li>
<li>效果：不用算 1 万次，只算 1 次正样本 + 10 次负样本 = 11 次，速度直接提升几百倍。</li>
</ul>
</li>
</ul>
</li>
<li>2 层次 Softmax（Hierarchical Softmax）：用 “二叉树” 少走路
<ul>
<li>原来的麻烦：Softmax 要遍历所有词算概率，词汇表越大越慢。</li>
<li>作弊思路：把词汇表排成一棵二叉树，猜词变成 “走树的路径”：
<ul>
<li>树的叶子节点是所有词，根节点在最上面；</li>
<li>猜中心词时，不用一个个对比，而是从根节点开始：每走一步判断"中心词需要" “往左还是往右”，直到走到目标词的叶子节点；有点类似二分法的理念</li>
</ul>
</li>
</ul>
</li>
<li>3 负采样和层次 Softmax 是提速工具，二选一或按场景搭配用；</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">GloVe ( Global Vectors for Word Representation)</h3>
<ul>
<li>核心逻辑是 “统计整个语料中词与词的共现频率，用频率关系学向量”，属于统计式模型。统计 “谁和谁经常一起出现”</li>
<li>遍历整个语料库，做一张 共现矩阵（像 Excel 表格）：行和列都是词，单元格里的数字是 “这两个词在窗口内一起出现的次数”；
<ul>
<li>比如表格里 “国王” 和 “王后” 的格子里是 100，“国王” 和 “苹果” 的格子里是 1—— 说明 “国王” 和 “王后” 关系近。</li>
</ul>
</li>
<li>给统计结果 “加权”
<ul>
<li>太常见的词（比如 “的、了”）和谁都能一起出现，统计结果不算数，所以给它们的次数 “打折”；</li>
<li>出现次数太少的词（比如生僻词），统计结果不准，也打折 —— 只重点关注 “出现次数适中” 的词对。</li>
</ul>
</li>
<li>用统计结果 “学向量”
-目标很简单：让 两个词向量的点积 ≈ ln(两个词共现次数)；
- 比如 “国王” 和 “王后” 的共现次数是 100，对数是 4.6，那就要让它们的向量点积≈4.6；</li>
<li>初始化所有词的随机向量，然后不断调整向量，直到向量点积满足这个目标
<ul>
<li>输出最终向量调整到误差足够小时，每个词的向量就学好了 —— 因为用了全局统计，词的语义关系会更稳（比如 “国王 - 男人 + 女人 = 王后” 这种类比任务，GloVe 做得更准）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">FastText ：</h3>
<ul>
<li>核心是 “给 Word2Vec 加了‘字符级偏旁部首’”，解决了 Word2Vec 处理生僻词、未登录词（没见过的词）的痛点，训练速度还更快(3-10 倍)。</li>
<li>FastText 的关键创新是 字符级 n-gram 特征：
<ul>
<li>把每个单词拆成若干个字符片段（n-gram），比如单词 apple，取 n=3（3 个字符为一段），会拆成：#ap、app、ppl、ple、le#（加 # 是为了标记词的开头和结尾）；</li>
<li>训练时，单词的向量 = 它所有字符片段的向量之和。</li>
<li>训练方式：和 Word2Vec 几乎一样，更快更强；</li>
<li>训练目标和：和Word2Vec 的 Skip-gram 完全相同：用中心词猜邻居词。</li>
<li>优势：
<ul>
<li>能处理生僻词 / 未登录词：就算遇到没见过的词，只要能拆成字符片段，就能用片段向量拼出这个词的向量；</li>
<li>训练速度更快：Facebook 做了工程优化，比 Word2Vec 快好几倍，适合超大规模语料；
<ul>
<li>优化 1：哈夫曼树 —— 把高频词放在树的浅层（靠近根节点），低频词放在深层</li>
<li>优化 2：哈希表（Hash Table） ---- 把相似的 n-gram 片段映射到同一个向量空间，减少了重复计算和内存占用。</li>
<li>低资源语言友好：对小语种（语料少、生僻词多）特别友好，效果远超 Word2Vec。</li>
</ul>
</li>
<li>额外技能：直接做文本分类
<ul>
<li>FastText 除了能生成词向量，还能直接做文本分类（这是它和 Word2Vec/GloVe 的小区别）：</li>
<li>分类时，把句子里所有词的向量加起来，得到句子向量；</li>
<li>再用一个简单的线性层 + Softmax，输出分类结果。</li>
<li>特点：分类速度极快，适合海量文本的快速分类任务（比如垃圾邮件识别，类比word2vec 中的负采样）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">动态词向量Embedding 模型：</h2>
<ul>
<li>
<p>ELMO(Embedding from Language Model)，通过无监督预训练多层双向LSTM模型来学习带上下文信息的（Contextualized）单词表示。一种动态的，语境化的词向量表示方法，可以根据上下文语境来生成相应词的向量表示。</p>
</li>
<li>
<p>ELMO 的流程可以类比成：先学通用字典（预训练），再根据具体文章调整词义（任务适配）。</p>
<ul>
<li>预训练阶段：用双向 LSTM 学 “通用词语义”（用海量无标注文本（比如全网的新闻、小说）训练一个 “双向语言模型”，目标是让模型学会 “根据上下文猜词”）
<ul>
<li>
<ol>
<li>输入层：把文本转成字符向量：</li>
</ol>
<ul>
<li>先把每个字符转成字符向量（比如用 CNN 提取字符特征）；</li>
<li>再把一个词的所有字符向量合并，得到这个词的字符级初始向量。</li>
</ul>
</li>
<li>
<ol start="2">
<li>核心层：堆叠多层双向 LSTM(这是 ELMO 的关键，用 多层双向 LSTM 逐层提取词的语义)</li>
</ol>
<ul>
<li>双向 LSTM:一个从左到右的 LSTM + 一个从右到左的 LSTM，两者独立计算，最后把结果“拼”起来。
<ul>
<li>底层双向 LSTM：学的是基础语义，比如词的字面意思、简单搭配（比如 “银行” 和 “钱” 的关联）；</li>
<li>高层双向 LSTM：学的是深层语义，比如词在句子里的角色、上下文的逻辑关系（比如 “银行” 在句子里是 “地点宾语”）</li>
</ul>
</li>
</ul>
</li>
<li>3 预训练目标：让双向 LSTM 学会 “根据上下文猜被遮住的词”，正向反向都来一遍</li>
<li>4 整体 架构：CNN - BIG - LSTM
<ul>
<li>字符 CNN：把单词拆成字符，提取字符级特征，生成基础向量；像查字典先认单个字，解决生僻词、拼写错误问题</li>
<li>两层 Highway：	优化"字符向量"的传输，让有效特征更好地通过	给特征 “开绿色通道”，减少信息损耗
<ul>
<li>具体方法：(依然是通过权重的方式来实现)
<ul>
<li>变换门（Transform Gate）：决定 “多少特征需要被加工处理”；</li>
<li>携带门（Carry Gate）：决定 “多少原始特征可以直接通过”。</li>
<li>最终输出 = 加工后的特征 × 变换门 + 原始特征 × 携带门。</li>
</ul>
</li>
<li>第一层 Highway 先过滤掉大部分明显的噪声；</li>
<li>第二层 Highway 再对剩下的特征做精细筛选；</li>
</ul>
</li>
<li>双层双向 LSTM	两层双向结构:(每层含前向 + 后向 LSTM，层间有残差连接)，逐层提取上下文语义
<ul>
<li>在第一个双向 LSTM 中，是正向，方向分别生成出结果"拼接"到一起作为第一层初始输出的</li>
<li>在拼接后需要通过线性变换进行降维，因为拼接后维度升高了一倍，再通过残差+原始输出作为第二层的输入
<ul>
<li>但是第二层的输出就不需要降维和残差了，因为已经直接输出了,双向 RNN 的时候也是这样的</li>
</ul>
</li>
</ul>
</li>
<li>整体目标: 双向语言模型任务，最大化 “前向预测下一词、后向预测前一词” 的联合概率;让模型学会根据上下文精准猜词，掌握通用语义</li>
<li>BIG：是因为双层双向 LSTM 每层隐藏单元 4096 个，投影维度 512，层间有残差连接，字符 CNN 用 2048 维卷积核</li>
</ul>
</li>
</ul>
</li>
<li>任务适配阶段 —— 给具体任务生成动态词向量：
<ul>
<li>
<ol>
<li>提取多层词向量对于任务中的每一个词，从预训练好的模型里提取 3 类向量(使用的时候也一样产生的是三层向量)：</li>
</ol>
<ul>
<li>e0：字符级初始向量（最底层，基础语义，上下文无关）；</li>
<li>e1：第一层双向 LSTM 输出的向量（浅层上下文语义）；</li>
<li>e2：第二层双向 LSTM 输出的向量（深层上下文语义）。</li>
</ul>
</li>
<li>
<ol start="2">
<li>加权组合成 ELMO 向量:ELMO 会给这几层向量分配不同的权重（权重值根据具体任务调整），然后加权求和，得到最终的任务专属动态词向量：</li>
</ol>
<ul>
<li>ELMO = γ * (s0 * e0 + s1 * e1 + s2 * e2)
<ul>
<li>s0,s1,s2是权重（比如任务是文本分类，可能给高层向量 e2 更高权重；任务是词性标注，给底层向量 e1 更高权重）；</li>
<li>γ是一个缩放系数，用来调整 ELMO 向量的大小，适配任务模型。</li>
</ul>
</li>
</ul>
</li>
<li>优点：1 解决了静态词嵌入 “一词多义” 的核心痛点；2 预训练模型可以复用，在小数据任务上也能有好效果（比如小众领域的文本分类）。</li>
<li>缺点：1基于 LSTM，速度比后来的 Transformer 模型（比如 BERT）慢；2只是 “把多层向量加权组合”，没有像 BERT 那样用自注意力机制更精准地捕捉上下文关联。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ELMo通过深度双向语言模型（biLM）进行训练，主要解决了两个问题：</p>
<ul>
<li>(1) 学习复杂词汇的语法和语义；</li>
<li>(2) 学习复杂词汇不同语境下的不同语义；</li>
</ul>
</li>
<li>
<p>一个简单的例子就是 “苹果”的词向量：</p>
<ul>
<li>句子1：“我买了 1斤 苹果”</li>
<li>句子2：“我新买了 1个 苹果 X”</li>
</ul>
</li>
<li>
<p>PS: ELMo在中文上确实会比word2vec好很多</p>
</li>
</ul>
<h2 data-id="heading-5">静态句向量 Embedding 模型：</h2>
<h3 data-id="heading-6">Doc2Vec 是 Word2Vec 的直接升级版(计算速度更慢)：</h3>
<ul>
<li>核心目标是解决 “Word2Vec 只能生成词向量，没法直接生成句子 / 文档向量” 的痛点，简单说就是 “给整句话 / 整篇文章生成一个专属向量”
<ul>
<li>
<ol>
<li>核心思路：给文档加一个 “专属身份证”</li>
</ol>
<ul>
<li>Word2Vec 的训练逻辑是 “用邻居词猜中心词”（Skip-gram）或 “用中心词猜邻居词”（CBOW），只关注词与词的关系。</li>
<li>Doc2Vec 在 Word2Vec 的基础上，只做了一个关键改动：
<ul>
<li>给每一篇文档 / 每一个句子，分配一个独一无二的向量，叫 文档向量（Paragraph Vector），记为D；</li>
<li>训练时，把这个文档向量 D和句子里的词向量（比如 w1,w2）拼在一起，再去做 “猜词任务”。</li>
</ul>
</li>
</ul>
</li>
<li>训练方式：
<ul>
<li>PV-DM（对应 CBOW）
<ul>
<li>逻辑：用 文档向量 + 上下文词向量，猜中心词；</li>
<li>特点：训练快，适合短文本（比如句子）。</li>
</ul>
</li>
<li>PV-DBOW（对应 Skip-gram）
<ul>
<li>逻辑：只用 文档向量，直接猜句子里的所有词；</li>
<li>特点：训练慢一点，但生成的文档向量质量更高，适合长文档（比如文章）。</li>
</ul>
</li>
</ul>
</li>
<li>文档向量的复用：训练时，同一篇文档里的所有句子，共享同一个文档向量</li>
<li>适用场景：
<ul>
<li>文档聚类：比如把相似的新闻分到同一类；</li>
<li>文本相似度计算：比如判断两篇论文是否抄袭；</li>
<li>短文本检索：比如根据用户输入的句子，匹配最相似的回复</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">InferSent：</h3>
<ul>
<li>核心目标是直接生成高质量的句子级向量，解决了早期 “词向量平均成句向量” 的粗糙问题，是 BERT 之前句子嵌入任务的主流方案。
<ul>
<li>
<ol>
<li>核心思路：用 “逻辑关系” 学句子语义</li>
</ol>
<ul>
<li>创新：基于 “自然语言推理（NLI）” 任务训练，简单说就是让模型学 “两句话之间的逻辑关系”
<ul>
<li>输入：一对句子（前提句 + 假设句）</li>
<li>任务：判断两者的关系是 3 类中的一种：</li>
<li>蕴含：前提能推出假设（比如前提 “猫抓老鼠”，假设 “老鼠被猫抓”）</li>
<li>矛盾：前提和假设相反（比如前提 “猫抓老鼠”，假设 “老鼠抓猫”）</li>
<li>中立：两者没关系（比如前提 “猫抓老鼠”，假设 “今天下雨”）</li>
<li>模型为了判断这 3 种关系，必须读懂句子的完整语义和逻辑，而不只是词的堆砌 —— 这样训练出来的句子向量，自然就包含了语序、逻辑和完整语义。</li>
</ul>
</li>
</ul>
</li>
<li>
<ol start="2">
<li>模型结构：双向 LSTM + 句子编码：核心是 “双向 LSTM + 最大池化”，</li>
</ol>
<ul>
<li>第一步：用双向 LSTM 提取词的上下文特征
<ul>
<li>先把句子里的每个词转成词向量（用 GloVe 预训练向量）；</li>
<li>喂给双向 LSTM：从左到右 + 从右到左扫句子，给每个词生成包含上下文的特征向量；</li>
<li>这一步解决了 “语序丢失” 的问题，比如 “猫抓老鼠” 和 “老鼠抓猫” 会得到不同的词特征。</li>
</ul>
</li>
<li>第二步：用最大池化生成固定长度的句子向量
<ul>
<li>双向 LSTM 输出的是 “词特征序列”（长度 = 句子长度），但不同句子长度不一样，没法直接比较；</li>
<li>用 最大池化：对每个特征维度，取所有词特征里的最大值，最终得到一个固定长度的句子向量；</li>
<li>通俗类比：从句子的所有词特征里，挑出 “最关键的语义信息”，拼成句子的 “身份证”。</li>
</ul>
</li>
<li>第三步：训练逻辑关系分类器
<ul>
<li>把前提句和假设句的向量拼接，再加上两者的 “差值”“乘积” 等特征；喂给全连接层，训练成一个 3 分类模型（蕴含 / 矛盾 / 中立）；训练完成后，去掉分类器，前面的 “双向 LSTM + 池化” 部分就成了一个句子向量生成器。</li>
<li>注：此处的双向 LSMT 可以类似elmo 中的双向，一样是拼接生成词向量结果，只是此处会进行最大池化拼接生成句子向量，再通过拼接不同的句子向量进行训练,训练好以后，就可以当成一个句子的向量生成器了，因为没有全连接层进行三分类处理</li>
</ul>
</li>
</ul>
</li>
<li>优势（对比早期方法）
<ul>
<li>比 “词向量平均”“TF-IDF 向量” 好太多：能捕捉句子的逻辑和语序；</li>
<li>训练好的模型可以直接复用：不用针对每个任务重新训练，输入句子就能输出向量；</li>
<li>向量质量高：在句子相似度计算、文本聚类、语义检索等任务上，碾压早期方案。</li>
</ul>
</li>
<li>适用场景
<ul>
<li>句子相似度计算（比如判断两句话意思是否一样）；</li>
<li>文本聚类（比如把相似的评论分到一组）；</li>
<li>语义检索（比如输入一句话，找数据库里最相似的句子）</li>
</ul>
</li>
<li>和 Doc2Vec 的区别：
<ul>
<li>InferSent：训练任务	基于 “句子逻辑关系” ，包含句子的逻辑和语义，侧重句子间的逻辑判断</li>
<li>Doc2Vec：基于 “猜词任务” 训练（和 Word2Vec 一样），包含句子的词搭配和主题，侧重文档的主题聚类</li>
</ul>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在调度的花园里面挖呀挖]]></title>    <link>https://juejin.cn/post/7582951344518201350</link>    <guid>https://juejin.cn/post/7582951344518201350</guid>    <pubDate>2025-12-14T12:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582951344518201350" data-draft-id="7583226204033728553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在调度的花园里面挖呀挖"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T12:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在调度的花园里面挖呀挖
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:39:58.000Z" title="Sun Dec 14 2025 12:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上文使用koordinator演示gang-scheduling和binpack调度， 已经生效。</p>
<p>4个2卡Pod龟缩在一个节点，另外一个2卡Pod被挤到另外一个节点（每节点上虚拟gpu：8卡）。</p>
<p>此时我们再尝试申请8卡作业，pod会<code>Pending状态</code>。但一旦节点有资源，pod就会自动进入<code>Running状态</code>。</p>
<p>这就是resource.requests/limits 软调度的效果。</p>
<h2 data-id="heading-0">1. resource.requests/limits 软调度</h2>
<p>上面的调度主要由<code>requests</code>配置来约束。</p>
<p><code>requests</code>： 是“承诺资源”， <code>kube-scheduler</code>将requests cpu：1 的pod调度到某个node， 就相当于从该node资源池上划走了有一部分资源，这1核会被预定，不再承诺给其他pod，即使你这个pod只用了500m核。</p>
<p><code>limits</code>:  是资源使用的上限，是由<code>kubelet</code>来强制执行。</p>
<h2 data-id="heading-1">2. k8s原生配额ResourceQuota： 硬隔离</h2>
<p>当多个团队共享k8s集群节点资源时， 会有某一租户霸占大量资源的可能性。</p>
<p>资源配额就是用来解决这个问题：</p>
<p>资源配额<strong>作用在命名空间上（命名空间天生就是多租户概念的载体）， 限制了该租户（命名空间）能创建的资源对象(+基础设施资源)的上限</strong>， 这个限制是通过api server在资源对象层面做到的。</p>
<p>ResourceQuota 相当于框定某一类资源的可用上限， 有“资源类型”、”配额作用域“ 等过滤资源的选项， 具体请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fzh-cn%2Fdocs%2Fconcepts%2Fpolicy%2Fresource-quotas%2F%23quota-and-cluster-capacity" target="_blank" title="https://kubernetes.io/zh-cn/docs/concepts/policy/resource-quotas/#quota-and-cluster-capacity" ref="nofollow noopener noreferrer">ResouceQouta官方</a>。</p>
<p>下面给出一个包含[基础设施资源、扩展资源、资源对象]的ResourceQuota：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceQuota</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">mem-cpu-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hard:</span>
    <span class="hljs-attr">requests.cpu:</span> <span class="hljs-string">"1"</span>
    <span class="hljs-attr">requests.memory:</span> <span class="hljs-string">1Gi</span>   <span class="hljs-comment"># 需求总量</span>
    <span class="hljs-attr">limits.cpu:</span> <span class="hljs-string">"2"</span>
    <span class="hljs-attr">limits.memory:</span> <span class="hljs-string">2Gi</span>      <span class="hljs-comment"># 限额总量</span>
    <span class="hljs-attr">requests.example.com/dongle:</span> <span class="hljs-number">2</span>
    
    <span class="hljs-attr">pods:</span> <span class="hljs-string">"4"</span>
    <span class="hljs-attr">replicationcontrollers:</span> <span class="hljs-string">"20"</span>
    <span class="hljs-attr">secrets:</span> <span class="hljs-string">"10"</span>
    <span class="hljs-attr">services:</span> <span class="hljs-string">"10"</span>
</code></pre>
<blockquote>
<p>因为扩展资源不可超量分配，故没有必要为扩展资源同时指定requests和limits配置，只需指定requests.xxxx 即可。</p>
</blockquote>
<p>因为配额的准入是在apiserver 资源对象层面， 所以当配额不足，不会产生pod处于pending的现象，kubectl命令会给出报错：<code>pods "quota-mem-cpu-demo-2" is forbidden: exceeded quota</code>， 这点与resource.requests/limits 软调度不同。</p>
<blockquote>
<p>提示：<br/>
ResourceQuota 与集群资源总量是完全独立的。它们通过绝对的单位来配置。<br/>
所以，为集群添加节点时，k8s资源配额不会自动赋予每个命名空间消耗更多资源的能力。</p>
</blockquote>
<h2 data-id="heading-2">3. kueue</h2>
<p>上文k8s原生resourceQuota 是命名空间级别的硬资源限制，“它只负责限制， 不负责调度”。</p>
<p>在企业级多租户云环境中，为了①高效②灵活 利用集群资源， 需要“协调和调度”的能力。</p>
<p>kueue 这种任务队列就是这个作用，它不谋求替代k8s原生组件作用，工作在k8s原生调度器之上。</p>
<p>kueue是k8s上管理资源池配额和管控job消费资源池配额的任务队列系统，
kueue决定了job什么时候应该等待，什么时候被准入，什么时候job可以被抢占。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10958bb4639440628f0d8afaf94c7eb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=TgNDu0nvSUu%2B%2BESiDlg1X2uiB%2BM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3.1 资源高度抽象</h3>
<p>上面的resource.requests/limits 和k8s原生resourceQuota 都没能跳脱worker 节点资源的概念。</p>
<p>kueue将worker节点上的资源抽象成由特定资源风味（ResourceFlavor）表征的资源池， 框定了某一类含有特定资源类型/规格的节点。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kueue.x-k8s.io/v1beta2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceFlavor</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"vgpu"</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">nodeLabels:</span>
    <span class="hljs-attr">instance-type:</span> <span class="hljs-string">vgpu</span>
</code></pre>
<p>上面名为<code>vgpu</code>的资源风味 框定了带有<code>instance-type=vgpu</code>标签的节点</p>
<blockquote>
<p>如果是同构资源，你也可以定义empty resource flavor。</p>
</blockquote>
<hr/>
<p>然后基于框定的资源池给某个任务队列分发资源配额。</p>
<h3 data-id="heading-4">3.1 资源池的配额 nominalQuota</h3>
<p>ClusterQueue 默认是集群级别的对象，定义了集群中某类资源风味的配额。</p>
<p>下面为<code>cluster-queue</code>的全局队列（依托于“default-flavor”资源池）定义了使用配额, 其中为稀缺资源<code>example.com/dongle</code>约束10卡。</p>
<p>命名空间<code>team-a</code>的localQueue引用了该clusterQueue。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kueue.x-k8s.io/v1beta2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ResourceFlavor</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">default-flavor</span> <span class="hljs-comment">##  对同构资源，定义empty资源风味</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kueue.x-k8s.io/v1beta2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterQueue</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"cluster-queue"</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">namespaceSelector:</span> {} <span class="hljs-comment"># match all.</span>
  <span class="hljs-attr">resourceGroups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">coveredResources:</span> [<span class="hljs-string">"cpu"</span>, <span class="hljs-string">"memory"</span>, <span class="hljs-string">"pods"</span>]
    <span class="hljs-attr">flavors:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"default-flavor"</span>
      <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"cpu"</span>
        <span class="hljs-attr">nominalQuota:</span> <span class="hljs-number">10</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"memory"</span>
        <span class="hljs-attr">nominalQuota:</span> <span class="hljs-string">10Gi</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"example.com/dongle"</span>
        <span class="hljs-attr">nominalQuota:</span> <span class="hljs-number">10</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kueue.x-k8s.io/v1beta2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">LocalQueue</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">team-a</span> 
  <span class="hljs-attr">name:</span> <span class="hljs-string">team-a-queue</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">clusterQueue:</span> <span class="hljs-string">cluster-queue</span> 
</code></pre>
<p>clusterQueue与localQueue的引用关系实现了共享全局资源池的理念。</p>
<p>形成的对象映射关系如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fee3bff25344696aefcbeec67c39b45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=xFoaWUAeifUd8HRMvbXq1TDP1KE%3D" alt="" loading="lazy"/>
浅绿色是kueue产生的对象，浅蓝色是用户实际提交的批处理任务。</p>
<hr/>
<p>下面用一个k8s原生job来演示 kueue的工作表现。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pi3</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">kueue.x-k8s.io/queue-name:</span> <span class="hljs-string">team-a-queue</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">parallelism:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 并行执行次数，默认为1</span>
  <span class="hljs-attr">completions:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 完成次数，默认为parallelism的值</span>
  <span class="hljs-attr">suspend:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 应该在挂起状态下创建job，由kueue来决定何时启动job</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pi</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">perl</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">command:</span> [ <span class="hljs-string">"perl"</span>, <span class="hljs-string">"-Mbignum=bpi"</span>, <span class="hljs-string">"-wle"</span>, <span class="hljs-string">"print bpi(5000)"</span> ]
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"200Mi"</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-string">"2"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"200Mi"</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-string">"2"</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span>

<span class="hljs-comment"># Job 代表一次性任务，运行完成到停止，它将π计算到5000个位置并将其打印出来。完成大约需要60秒。 之后pod状态是 Completed</span>
</code></pre>
<ul>
<li>这里最重要的是配置是job中的"suspend:true"， job应该以挂起状态被创建，由kueue来决定何时启动。</li>
<li>在原生job标签关联localqueue</li>
</ul>
<p>提交第一个任务，3个Pod占用了6卡；
再立刻启动同样配置的第二个任务，受localqueue中<code>nominalQuota: 10</code>的约束，任务2会pending，等待任务1执行完，释放了<code>example.com/dongle</code>资源，最后进入runing状态跑完任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31bb9e88a2ca4d828f1bc9f410afe2a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=VgEISUpO5FU1F786Caz8EnNfxXs%3D" alt="" loading="lazy"/></p>
<p>分别查看任务1和任务2的准入事件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6cf5cd6af84e259c81f595dec51951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=dc14Su%2BNIQrRT4TPjt8vQqy1P%2F4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd75e94e464b4f8389b8fd5c0847bb63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=%2BANuPoSi9weMR1GPRW3COxwi1qM%3D" alt="" loading="lazy"/></p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkueue.sigs.k8s.io%2Fzh-cn%2Fdocs%2Foverview%2F" target="_blank" title="https://kueue.sigs.k8s.io/zh-cn/docs/overview/" ref="nofollow noopener noreferrer">kueue 还有很多特性</a>,读者自行审阅，修行在个人。</p>
<p>① 核心的clusterqueue默认的排队策略是： BestEffortFIFO： 先按优先级排序，再按照创建时间；未被准入的旧任务不会影响后续能被准入的新来任务。</p>
<p>② 支持队列组Cohort， 可实现资源弹性借用</p>
<p>③ 注意队列组、clusterqueue与资源风味的1对多的关系。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0088078a200b4823ba7e42bb936cdcf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766320798&amp;x-signature=KGzLQxdhMrt6YRRhdFLwN6bNwyg%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>在企业级多租户、强资源生产隔离、计费要求的背景下，一般是独立clusterQueue 与 共享ClusterQueue结合的做法。</p>
</blockquote>
<h2 data-id="heading-5">4. 总结</h2>
<p>今天主要在调度这个花园里面挖呀挖， 更准确的是聚焦在“准入”这个动作上展开思路。</p>
<p>k8s原生资源配额的目的：不是为了优化调度，而是在多租户背景下，约束资源的硬使用边界。
ResourceQuota 框定了命名空间中某些资源的产生上限；</p>
<p>kueue资源池的配额约束了某些细粒度要求的资源池的使用边界，通过resourceFalvor抽象出资源池的概念， kueue通过”排队“这个概念细化了准入这个动作，在kube-scheduler工作前管控了批处理任务的调度。</p>
<ul>
<li><a href="https://juejin.cn/post/7327353547313053723#heading-9" target="_blank" title="https://juejin.cn/post/7327353547313053723#heading-9">juejin.cn/post/732735…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infracloud.io%2Fblogs%2Fbatch-scheduling-on-kubernetes%2F" target="_blank" title="https://www.infracloud.io/blogs/batch-scheduling-on-kubernetes/" ref="nofollow noopener noreferrer">www.infracloud.io/blogs/batch…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>