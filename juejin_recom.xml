<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[逛逛今天推荐 4 个 GitHub 开源项目，非常实用。]]></title>    <link>https://juejin.cn/post/7582156219059404863</link>    <guid>https://juejin.cn/post/7582156219059404863</guid>    <pubDate>2025-12-11T03:19:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156219059404863" data-draft-id="7582156219059306559" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="逛逛今天推荐 4 个 GitHub 开源项目，非常实用。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-11T03:19:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            逛逛今天推荐 4 个 GitHub 开源项目，非常实用。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:19:12.000Z" title="Thu Dec 11 2025 03:19:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、年会抽奖开源项目</h2>
<p>推荐两个年会抽奖 GitHub 开源项目，年会能排上用场了。</p>
<p>第一个 log-lottery 支持 3D 标签云效果，所有参与者的名字会组成一个旋转的球体、螺旋或网格，科技感十足。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11713b25fb04493c84bdd8939fee5a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=fMpsCsPxgbM%2FBHY690RoUbx6sGw%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>不需要懂代码，直接通过 Excel 导入人员名单，后台简单设置奖项即可。</p>
<p>而且还支持抽奖音乐播放，氛围感拉满，抽奖结果可直接导出 Excel。</p>
<p>另外一个叫 lottery 的开源项目也是一个基于 Express + Three.js的 3D 球体抽奖程序。高度可配置，奖品图片、文字、中奖概率、旋转速度、转动圈数啥的统统可以自定义。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/LOG1997/log-lottery开源地址：https://github.com/moshang-ax/lottery
</code></pre>
<h2 data-id="heading-1">02、Mac 录屏开源神器</h2>
<p>大家刷 B 站的时候，可能注意到过一种很流行的视频风格：<strong>丝滑的鼠标跟随、自动放大的特写镜头、美观的渐变背景</strong>。</p>
<p>这种高颜值的录屏视频会极大地提升产品演示的质感。</p>
<p>很多都是用 macOS 软件：<strong>Screen Studio 搞出来的，</strong> 它虽然极其好用，但价格也相当感人。</p>
<p>OpenScreen 是这个产品的开源替代，刚刚在 GitHub 上崭露头角。虽然是开源的，核心功能一点也不含糊。</p>
<p>它支持全屏录制，或指定单个应用窗口，避免无关内容干扰。而且还能手动添加缩放效果，还能调整深度、时长和位置，让重点内容更突出。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/325c486a391f4249a176cf1ad937c58d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=whgPlN%2B1lp8g8GY2YHQY2psuWsA%3D" alt="图片" loading="lazy"/></p>
<p>还能设置壁纸、纯色、渐变背景，或上传自定义图片，告别单调黑边。自带运动模糊，让平移、缩放效果更丝滑，提升视频质感。</p>
<p>除此之外，还有标注工具：支持添加文字、箭头、图片标注，讲解重点一目了然。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d5556f2820540c8a964c895421d34f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=kbsokPbAdiq2W5SbzfzhqPR7S7U%3D" alt="图片" loading="lazy"/></p>
<p>还能裁剪画面隐藏多余部分、修剪冗余片段，无需额外剪辑软件；多格式导出，支持不同宽高比和分辨率，适配抖音、B 站、公众号等多平台发布。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b15272618ec24e8fa782056759e135a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=PuDEW8vXSjQOjOYV6izLW2%2F7b2k%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/188f67b159074332b520ef738cd60ee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=THDHMknp4j911sX6JvHQ%2FjHGNNU%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/siddharthvaddem/openscreen</span>
</code></pre>
<h2 data-id="heading-2">03、开源下载器</h2>
<p><strong>Motrix 这个 4 万多 Star 的开源项目</strong>绝对能让你眼前一亮。</p>
<p>它不仅<strong>颜值抗打</strong>，而且<strong>全能：</strong> HTTP、FTP、BT、磁力链全搞定，最重要的是<strong>完全免费、开源、无广告。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de71f9cfab044ac6b0315f61a9f3c02d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=nN4v1e84FCzDTd3Mmk9cx3yYSmI%3D" alt="图片" loading="lazy"/></p>
<p><strong>它的底层基于大名鼎鼎的下载引擎 Aria2。Motrix 相当于给 Aria2 穿上了一层精美的外衣，让你无需任何配置，开箱即用。</strong></p>
<p>支持最高 64 线程下载，榨干你的宽带潜能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2982060a4e0b413aa2661922e9c708a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=TZJu0%2F5zRBWbABP8VDMxlhnm9cU%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>支持普通链接（HTTP/HTTPS/FTP）、BitTorrent（种子文件）、Magnet（磁力链接）</p>
<p>还能 BT 选择性下载，下载种子里的文件时，你可以勾选只需要的那几集视频，不用把整个庞大的文件夹都拖下来。</p>
<p>实测在网络环境允许的情况下，Motrix 跑满带宽是常规操作，甚至在下载某些冷门资源时，通过其内置的 自动更新 Tracker 功能，也能获得比普通下载器更好的速度。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/agalwood/Motrix</span>
</code></pre>
<h2 data-id="heading-3">04、PDF 工具包</h2>
<p>没开源几天，在 GitHub 上就获得 6K 的 Star 了。</p>
<p>BentoPDF 像一个精致的便当盒（Bento），把你需要的所有 PDF 工具都打包在一起，开箱即用。</p>
<p>与传统的在线工具不同，虽然你在浏览器中使用它，但所有的文件处理逻辑都在你的本地电脑上完成，文件永远不会被上传到任何服务器。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa0db7aeb2cf4b4aac540fca3dbcb7ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=r9dgbijug%2ByYIImoqvftjk7t1rE%3D" alt="图片" loading="lazy"/>这个开源项目提供的 PDF 处理的能力非常丰富，基本的 PDF 编辑、转换啥的都有，具体功能如下，可以瞧瞧。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04662e51909a488d80e3972eebfe8cd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027952&amp;x-signature=DRiIFHWH53VuPyRhQzs5nfaA6aI%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/alam00000/bentopdf
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 存储目录<内部存储，外部存储app专属，外部存储公共>]]></title>    <link>https://juejin.cn/post/7582118538562060307</link>    <guid>https://juejin.cn/post/7582118538562060307</guid>    <pubDate>2025-12-11T02:48:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118538562060307" data-draft-id="7582067084841025590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 存储目录&lt;内部存储，外部存储app专属，外部存储公共&gt;"/> <meta itemprop="keywords" content="Android,面试"/> <meta itemprop="datePublished" content="2025-12-11T02:48:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="byc"/> <meta itemprop="url" content="https://juejin.cn/user/3403743728773416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 存储目录&lt;内部存储，外部存储app专属，外部存储公共&gt;
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743728773416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    byc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:48:57.000Z" title="Thu Dec 11 2025 02:48:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>首先，我们需要破除一个最大的误区： <strong>“内部存储”和“外部存储”并不是指“手机内置存储”和“SD卡”</strong> 。它们的本质区别在于<strong>安全性和可访问性</strong>。</p>
<p>你可以用下图快速建立整体认知：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69236fad94fd4789b1095d9128fba1f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnlj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026136&amp;x-signature=qnmKCRMHhtas5s%2BZ9mpwJDPX6TM%3D" alt="p1.png" loading="lazy"/></p>
<p>接下来，我们深入剖析图中的每一个核心概念。</p>
<h3 data-id="heading-0">内部存储 (Internal Storage)</h3>
<p>这是指 <code>/data/data//</code> 目录下的空间。</p>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>绝对私有</strong>：只有你的应用可以访问，其他应用（无Root）无法读写。用户也无法在文件管理器中直接看到。</li>
<li><strong>安全可靠</strong>：应用卸载时，系统会自动清除此目录下的所有文件。</li>
<li><strong>空间有限</strong>：与系统空间共享，通常较小。</li>
</ul>
</li>
<li>
<p><strong>主要子目录</strong>：</p>
<ul>
<li><code>files/</code>： 存放应用长期使用的文件。</li>
<li><code>cache/</code>： 存放临时缓存文件。系统可能在存储空间不足时清理此处（但不要依赖于此，应自行管理缓存大小）。</li>
</ul>
</li>
<li>
<p><strong>如何获取路径</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 获取内部 files 目录</span>
<span class="hljs-keyword">val</span> internalFilesDir: File = context.filesDir
<span class="hljs-comment">// 获取内部 cache 目录</span>
<span class="hljs-keyword">val</span> internalCacheDir: File = context.cacheDir
</code></pre>
<h3 data-id="heading-1">外部存储 (External Storage)</h3>
<p>这是指可以被“共享”的存储空间，通常对应设备自带的“内置共享存储”（如 <code>/storage/emulated/0</code>）。它进一步分为两部分：</p>
<h4 data-id="heading-2">1. 外部存储 - App专属目录</h4>
<p>路径为：<code>/storage/emulated/0/Android/data//</code></p>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>外部但私有</strong>：虽然位于共享存储区，但在Android 4.4及以上系统，此目录对其他应用和用户默认<strong>不可见</strong>（无需任何权限）。应用卸载时，这里的内容也会被<strong>自动清除</strong>。</li>
<li><strong>空间较大</strong>：使用设备的“内置共享存储”空间，通常比内部存储大得多。</li>
<li><strong>用途</strong>：适合存放应用专属的、较大的媒体文件或缓存。</li>
</ul>
</li>
<li>
<p><strong>如何获取路径</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 获取外部 App 专属 files 目录</span>
<span class="hljs-keyword">val</span> externalFilesDir: File? = context.getExternalFilesDir(<span class="hljs-literal">null</span>)
<span class="hljs-comment">// 获取外部 App 专属 cache 目录</span>
<span class="hljs-keyword">val</span> externalCacheDir: File? = context.externalCacheDir
<span class="hljs-comment">// 可以指定子目录类型，系统会妥善管理</span>
<span class="hljs-keyword">val</span> externalPicturesDir: File? = context.getExternalFilesDir(Environment.DIRECTORY_PICTURES)
</code></pre>
<h4 data-id="heading-3">2. 外部存储 - 公共目录</h4>
<p>即共享存储根目录下的标准文件夹，如 <code>Downloads</code>、<code>DCIM</code>、<code>Pictures</code>、<code>Movies</code>、<code>Music</code> 等。</p>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>完全共享</strong>：所有应用和用户均可访问。文件在应用卸载后<strong>会保留</strong>。</li>
<li><strong>需要权限</strong>：访问需要向用户申请存储权限。</li>
</ul>
</li>
<li>
<p><strong>⚠️ 系统版本带来的关键差异（重点）</strong> ：</p>
<ul>
<li>
<p><strong>Android 9 (API 28) 及以下</strong>：可以通过<code>Environment.getExternalStoragePublicDirectory(type)</code>直接获取路径，然后使用传统的<code>File API</code>进行读写。</p>
</li>
<li>
<p><strong>Android 10 (API 29) 及以上</strong>：引入了 <strong>Scoped Storage（分区存储）</strong> 。为了用户隐私和安全：</p>
<ol>
<li><strong>不能</strong>再直接使用<code>File</code>路径访问公共目录（<code>Environment.getExternalStoragePublicDirectory</code>已废弃）。</li>
<li>必须通过 <strong><code>MediaStore</code> API</strong> 来访问公共媒体文件（图片、视频、音频），或通过 <strong><code>Storage Access Framework (SAF)</code></strong>  系统文件选择器来访问文档和下载目录。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>如何获取路径/访问</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 方法一：通过 MediaStore 插入一张图片到公共相册 (Android 10+推荐)</span>
<span class="hljs-keyword">val</span> values = ContentValues().apply {
    put(MediaStore.Images.Media.DISPLAY_NAME, &amp;#<span class="hljs-number">34</span>;my_image.jpg&amp;#<span class="hljs-number">34</span>;)
    put(MediaStore.Images.Media.MIME_TYPE, &amp;#<span class="hljs-number">34</span>;image/jpeg&amp;#<span class="hljs-number">34</span>;)
    put(MediaStore.Images.Media.RELATIVE_PATH, Environment.DIRECTORY_PICTURES + &amp;#<span class="hljs-number">34</span>;/MyApp/&amp;#<span class="hljs-number">34</span>;)
}
<span class="hljs-keyword">val</span> uri = context.contentResolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values)
<span class="hljs-comment">// 然后通过 ContentResolver.openOutputStream(uri) 写入数据</span>

<span class="hljs-comment">// 方法二：使用 Storage Access Framework 让用户选择保存位置（适用于所有文件类型）</span>
<span class="hljs-keyword">val</span> intent = Intent(Intent.ACTION_CREATE_DOCUMENT).apply {
    addCategory(Intent.CATEGORY_OPENABLE)
    type = &amp;#<span class="hljs-number">34</span>;application/pdf&amp;#<span class="hljs-number">34</span>;
    putExtra(Intent.EXTRA_TITLE, &amp;#<span class="hljs-number">34</span>;my_document.pdf&amp;#<span class="hljs-number">34</span>;)
}
startActivityForResult(intent, CREATE_DOC_REQUEST_CODE)
</code></pre>
<h3 data-id="heading-4">总结与建议</h3>

































<table><thead><tr><th>目录类型</th><th>路径示例</th><th>特点</th><th>适用场景</th><th>版本适配要点</th></tr></thead><tbody><tr><td>内部存储</td><td>/data/data/包名/...</td><td>私有，卸载清除，空间小</td><td>敏感数据、小型数据库</td><td>基本无变化</td></tr><tr><td>外部-App专属</td><td>/storage/.../Android/data/包名/...</td><td>私有，卸载清除，空间大</td><td>应用专属的大文件、缓存</td><td>Android 4.4+ 行为一致，无需权限</td></tr><tr><td>外部-公共目录</td><td>/storage/.../Pictures/ 等</td><td>共享，卸载保留</td><td>用户希望共享的图片、文档</td><td>Android 10+必须用MediaStore或SAF</td></tr></tbody></table>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>首选内部存储</strong>存放敏感和小型数据。</li>
<li><strong>大文件、缓存优先放外部App专属目录</strong>，无需处理权限和版本兼容。</li>
<li><strong>只有在需要与其他应用共享、或让用户永久保留的文件</strong>，才考虑写入公共目录，并务必做好Android 10+的Scoped Storage适配。</li>
</ol>
<h3 data-id="heading-5">/data/user/0/包名/files 这个目录我可以在我手机上的文件管理里面找到？</h3>
<p><strong>不能直接通过普通文件管理器找到。</strong></p>
<p>你提到的 <code>/data/user/0/包名/files</code> 这个路径，其实就是 <strong>内部存储</strong> 的另一个等价表示。它和你之前了解的 <code>/data/data/包名/files</code> 指向的是同一个位置。</p>
<h3 data-id="heading-6"> 为什么普通文件管理器看不到？</h3>
<ol>
<li><strong>安全沙盒限制</strong>：这个目录位于Android系统的<strong>严格保护区域</strong>。默认情况下，没有Root权限的其他应用（包括你手机上的所有文件管理器App）都无法直接访问这个路径。</li>
<li><strong>用户数据隔离</strong>：路径中的 <code>user/0</code> 代表的是主用户（第一个用户），这是Android系统为了支持“多用户”或“工作资料”功能而设计的目录结构。它对普通用户是透明的。</li>
</ol>
<h3 data-id="heading-7">如何查看这个目录的内容？</h3>
<p>如果你想查看这个目录里的文件，有以下几个方法：</p>






























<table><thead><tr><th>方法</th><th>说明</th><th>适合谁</th></tr></thead><tbody><tr><td>1. 通过Android Studio的 Device File Explorer</td><td>在Android Studio中，可以无需Root直接查看、导出、导入App的内部存储文件。这是开发时最常用、最方便的方法。</td><td>开发者首选</td></tr><tr><td>2. 使用ADB命令</td><td>在电脑上连接手机，通过命令行访问：  <code>adb shell</code> 进入  <code>run-as 包名</code> 切换到应用上下文  <code>ls /data/data/包名/files</code></td><td>开发者、高级用户</td></tr><tr><td>3. 将文件写入外部存储后查看</td><td>获得系统最高权限后，任何文件管理器都可以访问 <code>/data</code> 目录。但这会<strong>使设备失去保修、带来安全风险</strong>，且绝大多数日常使用场景完全不需要。</td><td>临时调试</td></tr><tr><td>4. Root你的手机</td><td>在Android Studio中，可以无需Root直接查看、导出、导入App的内部存储文件。这是<strong>开发时最常用、最方便</strong>的方法。</td><td>极客、深度调试者</td></tr></tbody></table>
<h3 data-id="heading-8">核心结论</h3>
<ul>
<li><code>/data/user/0/包名/</code> 等同于 <code>/data/data/包名/</code>，都是<strong>内部存储</strong>，受系统严格保护。</li>
<li>作为普通用户，<strong>你不应该、通常也无法</strong>在文件管理器中直接看到它。这是Android系统为了保护你的应用数据和隐私而设计的。</li>
<li>作为开发者，你应该使用 <strong>Android Studio 的 Device File Explorer</strong> 来检查和操作这些文件。</li>
</ul>
<p>如果你想测试文件是否成功写入内部存储，最简单的办法是在代码中读取它，或者按上述方法3，将其复制到一个可访问的位置再查看。</p>
<h3 data-id="heading-9">三种的文件路径&lt;内部存储，外部app专属，外部公共，如果我需要通过微信分享其中的文件，我什么时候需androidx.core.content.FileProvider，什么时候不需要</h3>
<p>这是一个非常好的问题，直接关系到Android文件分享功能能否正常工作。是否需要使用 <code>FileProvider</code>，核心判断标准是：<strong>你的文件路径是否允许接收方应用直接访问</strong>。</p>
<p>下图清晰地展示了判断流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aecb30919496427fb8c53a92e2f37ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnlj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026136&amp;x-signature=r5FoEq0dh8mFZVFpa1WtfdNuw0A%3D" alt="p2.png" loading="lazy"/></p>
<h3 data-id="heading-10"> 三种路径的详细分析</h3>
<h4 data-id="heading-11">1. 内部存储 与 外部App专属目录 (Android 11+)</h4>
<p><strong>必须使用 FileProvider。</strong></p>
<ul>
<li><strong>原因</strong>：这两个位置的路径（如 <code>/data/data/你的包名/...</code> 或 <code>/storage/emulated/0/Android/data/你的包名/...</code>）对于微信等其他应用来说是<strong>不可直接访问的</strong>。从Android 7.0 (Nougat) 开始，系统禁止直接通过 <code>file://</code> URI跨应用分享私有文件，否则会抛出 <code>FileUriExposedException</code>。</li>
<li><strong>作用</strong>：<code>FileProvider</code> 会为你的私有文件创建一个临时的、<strong>只读</strong>的 <code>content://</code> URI，并赋予接收方应用（如微信）临时的读取权限，从而安全地完成分享。</li>
</ul>
<h4 data-id="heading-12">2. 外部存储 - 公共目录</h4>
<p><strong>通常不需要 FileProvider，可以直接使用 <code>file://</code> URI。</strong></p>
<ul>
<li>
<p><strong>原因</strong>：位于标准公共目录（如 <code>Pictures/</code>, <code>Download/</code>, <code>DCIM/</code>）的文件默认对所有应用具有<strong>读取权限</strong>，因此可以直接访问。</p>
</li>
<li>
<p><strong>例外情况</strong>：</p>
<ul>
<li>如果你将文件保存在公共目录下<strong>你自己创建的非标准子目录</strong>里，为了保证最大兼容性（尤其在某些定制系统上），使用 <code>FileProvider</code> 是更稳妥的选择。</li>
<li>如果你需要<strong>更精细地控制权限</strong>（例如设置URI过期时间、只允许一次访问等），也可以使用 <code>FileProvider</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">使用 FileProvider 的步骤摘要</h3>
<h4 data-id="heading-14">1.如果你需要用它，以下是关键步骤：</h4>
<p><strong>在 <code>AndroidManifest.xml</code> 中声明</strong></p>
<pre><code class="hljs language-xml" lang="xml">
    ...
    
        
    

</code></pre>
<h4 data-id="heading-15">2.<strong>创建配置文件 <code>res/xml/file_paths.xml</code></strong></h4>
<p>这个文件定义了你想分享哪些目录下的文件。</p>
<pre><code class="hljs language-xml" lang="xml">

    
    
    
     --&gt;
    
    

</code></pre>
<h4 data-id="heading-16">3.<strong>在代码中生成 Content URI 并分享</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设你的文件位于 外部App专属目录</span>
<span class="hljs-keyword">val</span> fileToShare = File(context.getExternalFilesDir(<span class="hljs-literal">null</span>), &amp;#<span class="hljs-number">34</span>;share_image.jpg&amp;#<span class="hljs-number">34</span>;)

<span class="hljs-keyword">val</span> contentUri: Uri = FileProvider.getUriForFile(
    context,
    &amp;#<span class="hljs-number">34</span>;${context.packageName}.fileprovider&amp;#<span class="hljs-number">34</span>;, <span class="hljs-comment">// 必须与manifest中authorities一致</span>
    fileToShare
)

<span class="hljs-keyword">val</span> shareIntent = Intent(Intent.ACTION_SEND).apply {
    type = &amp;#<span class="hljs-number">34</span>;image/jpeg&amp;#<span class="hljs-number">34</span>;
    putExtra(Intent.EXTRA_STREAM, contentUri) <span class="hljs-comment">// 使用 content:// URI</span>
    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION) <span class="hljs-comment">// 授予临时读取权限</span>
}
startActivity(Intent.createChooser(shareIntent, &amp;#<span class="hljs-number">34</span>;分享图片&amp;#<span class="hljs-number">34</span>;))
</code></pre>
<h3 data-id="heading-17">总结与速查表</h3>





























<table><thead><tr><th>文件位置</th><th>是否需要 FileProvider</th><th>原因</th><th>URI 类型</th></tr></thead><tbody><tr><td><strong>内部存储</strong></td><td><strong>必须</strong>(android11+)</td><td>其他应用无任何访问权限</td><td>content://</td></tr><tr><td><strong>外部存储 - App专属目录</strong></td><td><strong>外部存储 - App专属目录</strong></td><td>其他应用默认无访问权限</td><td>content://</td></tr><tr><td><strong>外部存储 - 公共目录</strong></td><td><strong>通常不需要</strong></td><td>其他应用有读取权限</td><td>file://</td></tr></tbody></table>
<p><strong>最佳实践</strong>：如果分享功能对你很重要，且你不确定文件最终会保存在哪里，<strong>统一使用 <code>FileProvider</code> 是最安全、兼容性最好的做法</strong>，它几乎能处理所有情况。唯一的“缺点”是需要多写几步配置代码。</p>
<h3 data-id="heading-18">外部App专属目录和外部公共目录 (Android 11+) 这个android 11+ 有啥区别？</h3>
<p><strong>Android 11（API 30）对外部App专属目录的访问规则做出了一个重大变更</strong>，直接影响了是否需要使用 <code>FileProvider</code> 进行分享。</p>
<h2 data-id="heading-19">Android 11+ 的核心变化：强制执行“分区存储”</h2>
<p>在Android 10中，分区存储（Scoped Storage）是<strong>可选</strong>的（<code>requestLegacyExternalStorage</code>标志）。但从 <strong>Android 11 开始，它被强制启用</strong>，无法回退。</p>
<h3 data-id="heading-20">访问规则对比（关键区别）</h3>



































<table><thead><tr><th>访问场景</th><th>Android 10 及以下</th><th><strong>Android 11 及以上</strong></th></tr></thead><tbody><tr><td><strong>你的App访问自己的外部专属目录</strong></td><td><strong>始终可读写</strong></td><td><strong>始终可读写</strong>（无变化）</td></tr><tr><td><strong>其他App访问你的外部专属目录</strong></td><td><strong>默认可访问</strong>（有权限时）</td><td><strong>重大变化</strong></td></tr><tr><td/><td>只要其他App拥有 <code>READ_EXTERNAL_STORAGE</code> 权限，理论上就能扫描整个存储，包括你的 <code>Android/data/包名/</code> 目录。</td><td><strong>默认禁止访问</strong></td></tr><tr><td/><td/><td>其他App<strong>无法直接通过文件路径</strong>访问你的专属目录，即使它拥有存储权限。</td></tr><tr><td><strong>系统文件管理器访问</strong></td><td>通常可查看（需开启“显示隐藏文件”）</td><td><strong>仍可查看</strong>（用户操作层面）</td></tr></tbody></table>
<h3 data-id="heading-21">Android 11+ 下其他App如何访问（你分享文件时的影响）</h3>
<p>由于其他App默认无法进入你的专属目录，因此你<strong>必须</strong>通过 <code>FileProvider</code> 创建 <code>content://</code> URI 来分享文件。这个URI本质上是一个<strong>临时的、有访问令牌的通行证</strong>。</p>
<p><strong>具体机制</strong>：</p>
<ol>
<li>当你的App通过 <code>FileProvider.getUriForFile()</code> 生成URI时，系统会“解锁”这个特定文件。</li>
<li>你通过 <code>Intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)</code> 将这个“读取令牌”附加到URI上。</li>
<li>接收方App（如微信）在收到这个带有令牌的URI时，系统会临时允许它通过 <code>ContentResolver</code> 打开这个文件流，<strong>即使它根本不知道文件在 <code>Android/data/</code> 下的具体路径</strong>。</li>
<li>这个权限通常是<strong>一次性的</strong>，且仅对接收方App有效。</li>
</ol>
<h3 data-id="heading-22">实际影响与代码示例</h3>
<p>假设你要分享 <code>Android/data/com.yourapp/files/share_image.jpg</code>：</p>
<p><strong>错误做法（在 Android 11+ 上会失败）</strong> ：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> file = File(context.getExternalFilesDir(<span class="hljs-literal">null</span>), &amp;#<span class="hljs-number">34</span>;share_image.jpg&amp;#<span class="hljs-number">34</span>;)
<span class="hljs-comment">// 生成 file:// URI，其他App无权访问此路径</span>
<span class="hljs-keyword">val</span> fileUri = Uri.fromFile(file)
shareIntent.putExtra(Intent.EXTRA_STREAM, fileUri) <span class="hljs-comment">// 分享失败！</span>
</code></pre>
<p><strong>正确做法（所有版本通用，Android 11+ 必须）</strong> ：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> file = File(context.getExternalFilesDir(<span class="hljs-literal">null</span>), &amp;#<span class="hljs-number">34</span>;share_image.jpg&amp;#<span class="hljs-number">34</span>;)

<span class="hljs-comment">// 使用FileProvider生成安全的 content:// URI</span>
<span class="hljs-keyword">val</span> contentUri: Uri = FileProvider.getUriForFile(
    context,
    &amp;#<span class="hljs-number">34</span>;${context.packageName}.fileprovider&amp;#<span class="hljs-number">34</span>;,
    file
)

<span class="hljs-keyword">val</span> shareIntent = Intent(Intent.ACTION_SEND).apply {
    type = &amp;#<span class="hljs-number">34</span>;image/jpeg&amp;#<span class="hljs-number">34</span>;
    putExtra(Intent.EXTRA_STREAM, contentUri) <span class="hljs-comment">// 使用 content:// URI</span>
    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION) <span class="hljs-comment">// 授予临时权限</span>
}
<span class="hljs-comment">// 分享成功！</span>
</code></pre>
<h3 data-id="heading-23">总结与建议</h3>
<ol>
<li>
<p><strong>简单结论</strong>：自 <strong>Android 11 起，你必须使用 <code>FileProvider</code> 来分享位于外部App专属目录中的任何文件</strong>，因为这是其他App能访问它们的唯一合法途径。</p>
</li>
<li>
<p><strong>向后兼容</strong>：即使你的 <code>targetSdkVersion</code> 低于30，只要用户在Android 11+的设备上运行你的App，系统就会强制执行此规则。</p>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>统一使用 <code>FileProvider</code></strong>：为了最简单的维护和最好的兼容性，无论文件在哪里（内部、外部专属目录），也无论你的 <code>minSdkVersion</code> 是多少，统一使用 <code>FileProvider</code> 进行分享。</li>
<li><strong>更新你的 <code>file_paths.xml</code></strong>：确保配置了正确的路径来暴露外部专属目录：</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-xml" lang="xml">
    
    
    
    

</code></pre>
<p>所以，回答你最初的问题： <strong>“Android 11+” 的区别就在于，从此之后，外部App专属目录真正变得和内部存储一样“私有”了，分享时必须通过 <code>FileProvider</code> 这个“安全检查站”。</strong></p>
<h3 data-id="heading-24">android 10和11以后强制 使用的Scoped Storage（分区存储），到底是针对那个目录，是内部存储目录还是外部app专属目录，还是公共目录</h3>
<p>问到了核心！<strong>Scoped Storage（分区存储）主要针对的是“外部存储-公共目录”</strong> ，但它也<strong>间接影响和强化了“外部存储-App专属目录”的私有性</strong>。而<strong>内部存储完全不受影响</strong>。</p>
<p>让我用一个清晰的表格和对比图来帮你理解：</p>
<h3 data-id="heading-25">Scoped Storage 管控范围一览表</h3>





























<table><thead><tr><th>存储位置</th><th>中文常称</th><th>Scoped Storage 下是否受影响？</th><th>具体变化</th></tr></thead><tbody><tr><td><strong>Internal Storage</strong></td><td>内部存储</td><td><strong>完全不受影响</strong></td><td>始终私有，无需任何权限访问</td></tr><tr><td><strong>External Storage - App-specific</strong></td><td>外部App专属目录</td><td><strong>间接受影响</strong>（访问规则被强化）</td><td><strong>你的App</strong>：仍可自由访问。  <strong>其他App</strong>：<strong>默认无法访问</strong>（Android 11+强制）。分享必须用FileProvider。</td></tr><tr><td><strong>External Storage - Public Directories</strong></td><td>外部公共目录</td><td><strong>直接、最主要的管理目标</strong></td><td><strong>你的App</strong>：不能直接用<code>File</code>路径操作，必须通过<code>MediaStore</code>或SAF。  <strong>其他App</strong>：只能访问自己创建或系统授权的媒体文件。</td></tr></tbody></table>
<p>为了更直观地展示Scoped Storage如何改变了应用访问存储的“视野”，你可以参考下面的对比图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f1a6fb9d32543e5bb159f81a24be213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnlj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026136&amp;x-signature=pCJTXmQYHp%2B8YpBhg0VAzidpDuQ%3D" alt="p3.png" loading="lazy"/></p>
<h3 data-id="heading-26">详细解读：变化在哪里？</h3>
<h4 data-id="heading-27">1. 外部存储 - 公共目录（<strong>主要改革区</strong>）</h4>
<ul>
<li>
<p><strong>以前</strong>：App只要申请了 <code>READ_EXTERNAL_STORAGE</code> 权限，就可以像文件管理器一样<strong>扫描、读取整个存储上所有其他App的公共文件</strong>（例如，一个图片编辑App能扫到你微信保存的所有图片），隐私风险大。</p>
</li>
<li>
<p><strong>现在</strong>：</p>
<ul>
<li>
<p><strong>禁止直接路径访问</strong>：你不能再使用 <code>new File(Environment.getExternalStoragePublicDirectory(...), ...)</code> 这种方式。</p>
</li>
<li>
<p><strong>必须使用“中介API”</strong> ：</p>
<ul>
<li><strong><code>MediaStore</code></strong>：用于访问/创建<strong>媒体文件</strong>（图片、视频、音频）。你只能看到自己创建的文件，以及系统相册等公共集合中的文件。插入新文件时，系统会自动将其归类到对应的媒体集合。</li>
<li><strong><code>Storage Access Framework (SAF)</code></strong> ：通过系统文件选择器（一个系统UI）让用户<strong>主动选择</strong>文件或目录，适合访问文档、下载目录等非媒体文件。</li>
</ul>
</li>
<li>
<p><strong>权限更精细</strong>：Android 11+引入了更细粒度的权限（如 <code>ACCESS_MEDIA_LOCATION</code>），而不是简单的“全部或没有”。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">2. 外部存储 - App专属目录（<strong>间接受影响</strong>）</h4>
<ul>
<li>这个目录的<strong>设计初衷就是私有的</strong>，Scoped Storage 只是<strong>从系统层面彻底落实了这一设计</strong>。</li>
<li><strong>Android 11+的强制规定</strong>：其他App<strong>默认绝对无法访问</strong>你的专属目录，连扫描都扫不到。这使得它变得和内部存储一样安全，同时也意味着分享文件时必须通过 <code>FileProvider</code> “开门”。</li>
</ul>
<h4 data-id="heading-29">3. 内部存储（<strong>安全区，无变化</strong>）</h4>
<ul>
<li>完全不受Scoped Storage任何影响。它从一开始就是最私密、最安全的。</li>
</ul>
<h3 data-id="heading-30">给开发者的明确指南</h3>
<ol>
<li>
<p><strong>适配核心</strong>：你的主要适配工作（处理 <code>MediaStore</code>，废弃老的 <code>File</code> API）都集中在<strong>需要读写公共目录</strong>的功能上。</p>
</li>
<li>
<p><strong>首选存储位置</strong>：</p>
<ul>
<li>
<p><strong>私有数据</strong>：优先放在<strong>内部存储</strong>或<strong>外部App专属目录</strong>。这里不需要处理Scoped Storage的复杂规则。</p>
</li>
<li>
<p><strong>共享文件</strong>：</p>
<ul>
<li>如果是图片/视频/音频 → 使用 <strong><code>MediaStore</code></strong> 写入对应的公共媒体目录。</li>
<li>如果是PDF、文档等 → 使用 <strong><code>Storage Access Framework (SAF)</code></strong>  让用户选择保存位置。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>权限申请</strong>：</p>
<ul>
<li>访问自己的App专属目录：<strong>不需要任何权限</strong>。</li>
<li>在Android 10上，如果还需要临时以老方式访问公共目录，可以在Manifest中设置 <code>requestLegacyExternalStorage=true</code>（但Android 11+此标志无效）。</li>
<li>在Android 11+上，如果App需要频繁访问设备上的所有媒体文件（如文件管理器、杀毒软件），可以申请新的 <strong><code>MANAGE_EXTERNAL_STORAGE</code></strong> 特殊权限，但上架Google Play时需要声明。</li>
</ul>
</li>
</ol>
<p><strong>一句话总结</strong>：Scoped Storage 就像给每个App在公共存储区建立了“<strong>专属保险柜</strong>”（App专属目录），并设立了“<strong>公共展览馆</strong>”（公共目录），App不能随便翻别人的保险柜，往展览馆放东西或看东西也得通过规定的流程(<code>MediaStore</code>/<code>SAF</code>)。而你的内部存储，就是你的“<strong>私人卧室</strong>”，完全不变。</p>
<h3 data-id="heading-31">filepaths.xml配置介绍</h3>
<p><code>FileProvider</code> 的 `` 配置就是用来将你 App 的私有文件路径映射成 <code>content://</code> URI 的“路由表”。</p>
<p>以下是<strong>完整详尽的配置范例</strong>，覆盖了所有你可能用到的目录：</p>
<h2 data-id="heading-32">完整的 <code>file_paths.xml</code> 配置模板</h2>
<pre><code class="hljs language-xml" lang="xml">    

    
    
    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
        
    
    
     --&gt;

</code></pre>
<h2 data-id="heading-33">配置详解与使用示例</h2>
<h3 data-id="heading-34">1. <strong>标签类型与路径对应关系（核心）</strong></h3>













































<table><thead><tr><th>XML标签</th><th>对应的<strong>基准路径</strong></th><th>典型场景</th></tr></thead><tbody><tr><td>\</td><td>/data/data//</td><td>内部存储的 <code>files</code> 目录</td></tr><tr><td>\</td><td>/data/data//cache/</td><td>内部缓存目录</td></tr><tr><td>\</td><td>/storage/emulated/0/</td><td><strong>最常用</strong>：外部存储根目录</td></tr><tr><td>\</td><td><code>Context.getExternalFilesDir()</code> 返回的路径</td><td>外部App专属目录的父目录</td></tr><tr><td>\</td><td><code>Context.getExternalCacheDir()</code> 返回的路径</td><td>外部缓存目录的父目录</td></tr><tr><td>\</td><td><code>Context.getExternalMediaDirs()</code> 返回的第一个路径</td><td>外部媒体目录（API 21+）</td></tr><tr><td>\</td><td><code>/</code> (设备的<strong>真实根目录</strong>)</td><td><strong>极度危险</strong>，几乎用不到</td></tr></tbody></table>
<h3 data-id="heading-35">2. <strong><code>path</code> 属性的写法</strong></h3>
<ul>
<li><code>&amp;#34;.&amp;#34;</code> 表示匹配基准路径本身</li>
<li><code>&amp;#34;subfolder/&amp;#34;</code> 表示匹配基准路径下的子目录（末尾的 <code>/</code> 可选但推荐）</li>
<li>不能包含 <code>..</code> 或 <code>//</code>，也不能是绝对路径</li>
</ul>
<h3 data-id="heading-36">3. <strong>在代码中的使用示例</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-comment">// 分享内部存储 files 目录下的一个文件</span>
<span class="hljs-keyword">val</span> internalFile = File(context.filesDir, &amp;#<span class="hljs-number">34</span>;secret.txt&amp;#<span class="hljs-number">34</span>;)
<span class="hljs-keyword">val</span> internalUri = FileProvider.getUriForFile(
    context,
    &amp;#<span class="hljs-number">34</span>;${context.packageName}.fileprovider&amp;#<span class="hljs-number">34</span>;,
    internalFile
)
<span class="hljs-comment">// 系统会自动根据文件路径，匹配到 </span>

<span class="hljs-comment">// 分享外部App专属 Pictures 目录下的一张图片</span>
<span class="hljs-keyword">val</span> externalPicFile = File(context.getExternalFilesDir(Environment.DIRECTORY_PICTURES), &amp;#<span class="hljs-number">34</span>;photo.jpg&amp;#<span class="hljs-number">34</span>;)
<span class="hljs-keyword">val</span> externalPicUri = FileProvider.getUriForFile(
    context,
    &amp;#<span class="hljs-number">34</span>;${context.packageName}.fileprovider&amp;#<span class="hljs-number">34</span>;,
    externalPicFile
)
<span class="hljs-comment">// 系统会自动匹配到 </span>
</code></pre>
<h2 data-id="heading-37">重要提醒</h2>
<ol>
<li>
<p><strong>包名占位符</strong>：配置中的 <strong><code>你的应用包名</code></strong> 需要替换成你实际的包名（如 <code>com.example.myapp</code>），或者你可以用 <code>.</code> 表示当前目录，但显式写出包名更清晰。</p>
</li>
<li>
<p><strong>按需配置</strong>：你<strong>不需要</strong>列出所有路径。<strong>只配置你实际会通过 <code>FileProvider</code> 分享文件的目录</strong>即可。更少的配置意味着更小的攻击面。</p>
</li>
<li>
<p><strong>安全警告</strong>：</p>
<ul>
<li><strong>切勿使用 ``</strong> ，这将暴露设备根目录，极度危险。</li>
<li>对于公共目录的配置，虽然列出来了，但在Android 10+上，由于Scoped Storage，你通常不会直接操作这些路径，而是通过<code>MediaStore</code>。这些配置主要为了兼容旧版本或特殊场景。</li>
</ul>
</li>
<li>
<p><strong>Android 11+ 注意</strong>：即使你为外部App专属目录配置了路径映射，其他App<strong>仍然无法直接访问</strong>。这个配置只是为了让 <code>FileProvider</code> 能正确生成URI，系统仍会强制执行访问隔离。</p>
</li>
</ol>
<p><strong>最精简的常用配置</strong>（适合大多数App）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">

    
    
    
    

</code></pre>
<p>这个清单应该覆盖了你所有的使用场景。根据你的实际需求，选择必要的路径进行配置即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS逆向-哔哩哔哩增加3倍速（1）-最大播放速度]]></title>    <link>https://juejin.cn/post/7582063437414285350</link>    <guid>https://juejin.cn/post/7582063437414285350</guid>    <pubDate>2025-12-11T00:02:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582063437414285350" data-draft-id="7582063437413695526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS逆向-哔哩哔哩增加3倍速（1）-最大播放速度"/> <meta itemprop="keywords" content="iOS,逆向"/> <meta itemprop="datePublished" content="2025-12-11T00:02:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TouchWorld"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473557143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS逆向-哔哩哔哩增加3倍速（1）-最大播放速度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473557143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TouchWorld
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:02:07.000Z" title="Thu Dec 11 2025 00:02:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>作为一名 <strong>哔哩哔哩的重度用户</strong>，我一直期待官方推出 <strong>3 倍速播放</strong> 功能。然而等了许久，这个功能始终没有上线 😮‍💨。</p>
<p>修改前效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef8e2cfb37be457ba94d02fda26ef959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=U975y6avDAAcG6dbMh1chcJMrmA%3D" alt="Screenshot 2025-12-11 at 07.26.05.png" loading="lazy"/></p>
<p>刚好我自己熟悉 <code>iOS</code> 逆向工程，于是决定 <strong>亲自动手，为 B 站加入 3 倍速播放</strong> 😆。</p>
<p>修改后效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6a56e360904fecae8867827e9d4e18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=7K%2BsKau2o8voS7iKaKPBOkp7IeQ%3D" alt="Screenshot 2025-12-11 at 07.22.57.png" loading="lazy"/></p>
<p>由于整个过程涉及 <strong>多处逻辑修改与多个模块的反汇编分析</strong>，为了让内容更加清晰易读，我将会分成多篇文章，逐步拆解 <strong>如何为 B 站增加 3 倍速播放能力</strong>。</p>
<h2 data-id="heading-1">场景</h2>
<p>哔哩哔哩的视频播放页面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336d8de5197740eb887a5df45ad144e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=jNlBaGEGSgQ3LVSMEUVCVegwA%2B4%3D" alt="8C0CA5C5-C2D9-4E60-9BB0-0FF3B83A03DA-5346442.png" loading="lazy"/></p>
<h2 data-id="heading-2">开发环境</h2>
<ul>
<li>哔哩哔哩版本：<code>8.41.0</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAloneMonkey%2FMonkeyDev" target="_blank" title="https://github.com/AloneMonkey/MonkeyDev" ref="nofollow noopener noreferrer">MonkeyDev</a></li>
<li><code>IDA Professional 9.0</code></li>
<li>安装IDA插件：<code>patching</code></li>
<li><code>Lookin</code></li>
</ul>
<h2 data-id="heading-3">目标</h2>
<p>视频最大播放速度改为<strong>4倍速</strong>播放</p>
<h2 data-id="heading-4">分析</h2>
<ul>
<li>我们知道哔哩哔哩开源了他们的视频播放器<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbilibili%2Fijkplayer" target="_blank" title="https://github.com/bilibili/ijkplayer" ref="nofollow noopener noreferrer">ijkplayer</a>，我们可以从中了解到设置播放速度的方法,是<code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">IJKFFMoviePlayerController</span> : <span class="hljs-title">NSObject</span> </span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> playbackRate;

<span class="hljs-keyword">@end</span>

</code></pre>
<ul>
<li>从<code>Mach-O</code>文件导出的<code>IJKFFMoviePlayerController</code>的<code>OC</code>头文件可以知道，它有一个<code>maxPlaybackRate</code>属性，应该是最大播放速度</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// IJKFFMoviePlayerController.h</span>
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">IJKFFMoviePlayerController</span> : <span class="hljs-title">NSObject</span>  </span>{
    <span class="hljs-comment">/* instance variables */</span>
    <span class="hljs-type">id</span>  _player;
}

...
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">double</span> realCurrentPlaybackTime;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> realPlaybackRate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> maxPlaybackRate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) IJKMediaPlayerItem *currentItem;
...
</code></pre>
<ul>
<li>我们<code>hook</code> <code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>，添加断点并打印一些日志，其中就有打印<code>maxPlaybackRate</code>
<ul>
<li><code>inputPlaybackRate</code>：要设置的播放速度</li>
<li><code>changedPlaybackRate</code>：更改后的播放速度</li>
<li><code>realPlaybackRate</code>：真实播放速度</li>
<li><code>maxPlaybackRate</code>：最大播放速度</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook IJKFFMoviePlayerController

- (<span class="hljs-type">void</span>)setPlaybackRate:(<span class="hljs-type">float</span>)playbackRate {
    %orig(playbackRate);
    <span class="hljs-built_in">NSLog</span>(@&amp;#<span class="hljs-number">34</span>;%@:%@-%p-%s-inputPlaybackRate:%lf-changedPlaybackRate:%lf-realPlaybackRate%lf-maxPlaybackRate:%lf&amp;#<span class="hljs-number">34</span>;, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__, playbackRate, <span class="hljs-keyword">self</span>.playbackRate, <span class="hljs-keyword">self</span>.realPlaybackRate, <span class="hljs-keyword">self</span>.maxPlaybackRate);
}

%end
</code></pre>
<ul>
<li>每次设置播放速度，<code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>的断点都会触发，我们从日志中可以看到，<strong>最大播放速度为<code>3.0</code></strong></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">cxzcxz:IJKFFMoviePlayerController<span class="hljs-number">-0x280519220</span>-_logos_method$App$IJKFFMoviePlayerController$setPlaybackRate$-inputPlaybackRate:<span class="hljs-number">1.500000</span>-changedPlaybackRate:<span class="hljs-number">1.500000</span>-realPlaybackRate0<span class="hljs-number">.000000</span>-maxPlaybackRate:<span class="hljs-number">3.000000</span>
</code></pre>
<ul>
<li>因为倍速面板无法选择超过<code>2.0</code>的速度，所以我们就设置，如果倍速面板选择的是<code>2.0</code>，我们就改成<code>4.0</code>，看是否会限制播放速度到<code>3.0</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook IJKFFMoviePlayerController

- (<span class="hljs-type">void</span>)setPlaybackRate:(<span class="hljs-type">float</span>)playbackRate {
    playbackRate = playbackRate == <span class="hljs-number">2.0</span> ? <span class="hljs-number">4.0</span> : playbackRate;
    %orig(playbackRate);
    <span class="hljs-built_in">NSLog</span>(@&amp;#<span class="hljs-number">34</span>;%@:%@-%p-%s-inputPlaybackRate:%lf-changedPlaybackRate:%lf-realPlaybackRate%lf-maxPlaybackRate:%lf&amp;#<span class="hljs-number">34</span>;, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__, playbackRate, <span class="hljs-keyword">self</span>.playbackRate, <span class="hljs-keyword">self</span>.realPlaybackRate, <span class="hljs-keyword">self</span>.maxPlaybackRate);
}

%end
</code></pre>
<ul>
<li>倍速面板选择<code>2.0</code>，从日志中可以看到，播放速度(<code>changedPlaybackRate</code>)改成了<code>3.0</code>而不是<code>4.0</code>，这也证明<code>maxPlaybackRate</code>就是最大播放速度</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">cxzcxz:IJKFFMoviePlayerController<span class="hljs-number">-0x281304380</span>-_logos_method$App$IJKFFMoviePlayerController$setPlaybackRate$-inputPlaybackRate:<span class="hljs-number">4.000000</span>-changedPlaybackRate:<span class="hljs-number">3.000000</span>-realPlaybackRate0<span class="hljs-number">.000000</span>-maxPlaybackRate:<span class="hljs-number">3.000000</span>
</code></pre>
<ul>
<li>我们尝试<code>hook</code> <code>maxPlaybackRate</code>的<code>getter</code>方法，看能不能修改最大播放速度？</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook IJKFFMoviePlayerController

- (<span class="hljs-type">void</span>)setPlaybackRate:(<span class="hljs-type">float</span>)playbackRate {
    playbackRate = playbackRate == <span class="hljs-number">2.0</span> ? <span class="hljs-number">4.0</span> : playbackRate;
    %orig(playbackRate);
    <span class="hljs-built_in">NSLog</span>(@&amp;#<span class="hljs-number">34</span>;%@:%@-%p-%s-inputPlaybackRate:%lf-changedPlaybackRate:%lf-realPlaybackRate%lf-maxPlaybackRate:%lf&amp;#<span class="hljs-number">34</span>;, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__, playbackRate, <span class="hljs-keyword">self</span>.playbackRate, <span class="hljs-keyword">self</span>.realPlaybackRate, <span class="hljs-keyword">self</span>.maxPlaybackRate);
}

- (<span class="hljs-type">float</span>)maxPlaybackRate {
    <span class="hljs-keyword">return</span> <span class="hljs-number">4.0</span>;
}

%end
</code></pre>
<ul>
<li>从日志可以看到，虽然<code>maxPlaybackRate</code>的输出值改成了<code>4.0</code>，但是播放速度(<code>changedPlaybackRate</code>)还是<code>3.0</code>，所以修改无效</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">cxzcxz:IJKFFMoviePlayerController<span class="hljs-number">-0x2808e2a40</span>-_logos_method$App$IJKFFMoviePlayerController$setPlaybackRate$-inputPlaybackRate:<span class="hljs-number">4.000000</span>-changedPlaybackRate:<span class="hljs-number">3.000000</span>-realPlaybackRate0<span class="hljs-number">.000000</span>-maxPlaybackRate:<span class="hljs-number">4.000000</span>
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>伪代码实现，发现调用的是[<code>self-&gt;_player setPlaybackRate:]</code>方法</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-type">void</span> __cdecl -[IJKFFMoviePlayerController setPlaybackRate:](IJKFFMoviePlayerController *<span class="hljs-keyword">self</span>, SEL a2, <span class="hljs-type">float</span> a3)
{
  -[IJKMediaPlayback setPlaybackRate:](<span class="hljs-keyword">self</span>-&gt;_player, &amp;#<span class="hljs-number">34</span>;setPlaybackRate:&amp;#<span class="hljs-number">34</span>;);
}
</code></pre>
<ul>
<li>我们给<code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>，添加断点，看看<code>self-&gt;_player</code>的值是什么？</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e3ddf7a869491c897445a834e70883~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=lV0Zf1%2BpySH2emeuEs0c0ith7qI%3D" alt="C72ACE3B-EA9B-4684-A7AB-71C162A27F1E.png" loading="lazy"/></p>
<ul>
<li>断点触发，发现<code>self-&gt;_player</code>的类型是<code>IJKFFMoviePlayerControllerFFPlay</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) po <span class="hljs-keyword">self</span>-&gt;_player

</code></pre>
<ul>
<li>从<code>Mach-O</code>文件导出的<code>IJKFFMoviePlayerControllerFFPlay</code>的<code>OC</code>头文件可以知道，<code>IJKFFMoviePlayerControllerFFPlay</code>是一个视频播放器，看来<code>IJKFFMoviePlayerController</code>是基于<code>IJKFFMoviePlayerControllerFFPlay</code>实现的</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">IJKFFMoviePlayerControllerFFPlay</span> : <span class="hljs-title">NSObject</span>  </span>{
    <span class="hljs-comment">/* instance variables */</span>
    <span class="hljs-keyword">struct</span> IjkMediaPlayer * _mediaPlayer;
...
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) IJKMediaPlayerItem *item;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">retain</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">id</span>  fileOpenDelegate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">retain</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">id</span>  segmentOpenDelegate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">double</span> fpsInMeta;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">double</span> fpsAtOutput;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) _Bool shouldShowHudView;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">long</span> <span class="hljs-type">long</span> numberOfBytesTransferred;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) _Bool allowsMediaAirPlay;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) _Bool isDanmakuMediaAirPlay;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) _Bool airPlayMediaActive;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> isSeekBuffering;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> isAudioSync;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> isVideoSync;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> currentVideoIdentifier;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> currentAudioIdentifier;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">double</span> realCurrentPlaybackTime;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> realPlaybackRate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> maxPlaybackRate;
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>) IJKMediaPlayerItem *currentItem;
...
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>IJKFFMoviePlayerControllerFFPlay</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>伪代码实现，发现跟开源版本的<code>IJKFFMoviePlayerController</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>是一致的</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 哔哩哔哩版本</span>
<span class="hljs-type">void</span> __cdecl -[IJKFFMoviePlayerControllerFFPlay setPlaybackRate:](
        IJKFFMoviePlayerControllerFFPlay *<span class="hljs-keyword">self</span>,
        SEL a2,
        <span class="hljs-type">float</span> a3)
{
  sub_10F3F5768(
    <span class="hljs-number">0</span>LL,
    <span class="hljs-number">32</span>LL,
    &amp;#<span class="hljs-number">34</span>;IJKFFMoviePlayerControllerFFPlay: setPlaybackRate ts = %lld, playbackRate = %f\n&amp;#<span class="hljs-number">34</span>;,
    +[IJKFFUtils getIjkTickHR](&amp;OBJC_CLASS___IJKFFUtils, &amp;#<span class="hljs-number">34</span>;getIjkTickHR&amp;#<span class="hljs-number">34</span>;),
    a3);
  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">self</span>-&gt;_mediaPlayer )
    sub_10F0BAFD4(a3);
}
</code></pre>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 开源版本</span>
- (<span class="hljs-type">void</span>)setPlaybackRate:(<span class="hljs-type">float</span>)playbackRate
{
    <span class="hljs-keyword">if</span> (!_mediaPlayer)
        <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">return</span> ijkmp_set_playback_rate(_mediaPlayer, playbackRate);
}
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>sub_10F0BAFD4</code>的伪代码实现，发现跟开源版本的<code>ijkmp_set_playback_rate</code>的实现是一致的</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 哔哩哔哩版本</span>
__int64 __fastcall sub_10F0BAFD4(__int64 a1, <span class="hljs-type">float</span> a2)
{
  printf(&amp;#<span class="hljs-number">34</span>;%s(%f)\n&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;ijkmp_set_playback_rate&amp;#<span class="hljs-number">34</span>;, a2);
  pthread_mutex_lock((pthread_mutex_t *)(a1 + <span class="hljs-number">8</span>));
  sub_10F0A70B4(*(_QWORD *)(a1 + <span class="hljs-number">136</span>), a2);
  pthread_mutex_unlock((pthread_mutex_t *)(a1 + <span class="hljs-number">8</span>));
  <span class="hljs-keyword">return</span> printf(&amp;#<span class="hljs-number">34</span>;%s()=<span class="hljs-type">void</span>\n&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;ijkmp_set_playback_rate&amp;#<span class="hljs-number">34</span>;);
}
</code></pre>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 开源版本</span>
<span class="hljs-type">void</span> ijkmp_set_playback_rate(IjkMediaPlayer *mp, <span class="hljs-type">float</span> rate)
{
    assert(mp);

    <span class="hljs-built_in">MPTRACE</span>(&amp;#<span class="hljs-number">34</span>;%s(%f)\n&amp;#<span class="hljs-number">34</span>;, __func__, rate);
    pthread_mutex_lock(&amp;mp-&gt;mutex);
    ffp_set_playback_rate(mp-&gt;ffplayer, rate);
    pthread_mutex_unlock(&amp;mp-&gt;mutex);
    <span class="hljs-built_in">MPTRACE</span>(&amp;#<span class="hljs-number">34</span>;%s()=<span class="hljs-type">void</span>\n&amp;#<span class="hljs-number">34</span>;, __func__);
}
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>sub_10F0A70B4</code>的伪代码实现，可以知道是从<code>sub_10F101034</code>获取最大播放速度的</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">__int64 __fastcall sub_10F0A70B4(__int64 result, <span class="hljs-type">float</span> a2)
{
  __int64 v3; <span class="hljs-comment">// x19</span>
  <span class="hljs-type">float</span> v4; <span class="hljs-comment">// s0</span>
  __int64 v5; <span class="hljs-comment">// x8</span>
  <span class="hljs-type">float</span> v6; <span class="hljs-comment">// s1</span>
  <span class="hljs-type">float</span> v7; <span class="hljs-comment">// [xsp+1Ch] [xbp-24h] BYREF</span>

  <span class="hljs-keyword">if</span> ( result )
  {
    v3 = result;
    v7 = <span class="hljs-number">0.0</span>;
    sub_10F101034(<span class="hljs-number">10</span>LL, &amp;v7, <span class="hljs-number">4</span>LL);
    <span class="hljs-keyword">if</span> ( v7 &lt; a2 )
    {
      sub_10F3F5768(<span class="hljs-number">0</span>LL, <span class="hljs-number">32</span>LL, &amp;#<span class="hljs-number">34</span>;%s: origin %f, new %f \n&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;adjust_playback_rate&amp;#<span class="hljs-number">34</span>;, a2, v7);
      a2 = v7;
    }
    sub_10F3F5768((__int64 *)v3, <span class="hljs-number">32</span>LL, &amp;#<span class="hljs-number">34</span>;Playback rate: %f\n&amp;#<span class="hljs-number">34</span>;, a2);
    <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0.0</span> )
      v4 = <span class="hljs-number">1.0</span>;
    <span class="hljs-keyword">else</span>
      v4 = a2;
    <span class="hljs-keyword">if</span> ( v4 != <span class="hljs-number">1.0</span> )
      *(_DWORD *)(v3 + <span class="hljs-number">884</span>) = <span class="hljs-number">1</span>;
    v5 = *(_QWORD *)(v3 + <span class="hljs-number">8</span>);
    <span class="hljs-keyword">if</span> ( v5 )
    {
      v6 = *(<span class="hljs-type">float</span> *)(v3 + <span class="hljs-number">876</span>);
      <span class="hljs-keyword">if</span> ( v6 != v4 )
        *(<span class="hljs-type">double</span> *)(v5 + <span class="hljs-number">8040</span>) = vabds_f32(v6, v4);
    }
    <span class="hljs-keyword">if</span> ( v4 &gt; *(<span class="hljs-type">float</span> *)(v3 + <span class="hljs-number">6724</span>) )
      *(<span class="hljs-type">float</span> *)(v3 + <span class="hljs-number">6724</span>) = v4;
    *(<span class="hljs-type">float</span> *)(v3 + <span class="hljs-number">876</span>) = v4;
    *(_DWORD *)(v3 + <span class="hljs-number">880</span>) = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> sub_10F100F98(<span class="hljs-number">8</span>LL, v3 + <span class="hljs-number">9272</span>);
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>sub_10F101034</code>的伪代码实现，再根据<code>sub_10F101034(10LL, &amp;v7, 4LL)</code>; 知道参数<code>a1=10，a3=4</code>，将伪代码和参数交给<code>chatgpt</code>分析，得出下面几个结论:
<ul>
<li><code>sub_10F10449C(a9)</code> 计算最大播放速度</li>
<li>该函数内部会将计算结果放入某个寄存器（例如 <code>d0</code>）</li>
<li>解码器将其反编译成 <code>v14</code></li>
<li><code>LABEL_38 → v13 = v14</code></li>
<li>最终写入：<code>*(float*)a2 = v13</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-type">void</span> __fastcall sub_10F101034(
        <span class="hljs-type">int</span> a1,
        <span class="hljs-type">double</span> *a2,
        __int64 a3,
        __int64 a4,
        __int64 a5,
        __int64 a6,
        __int64 a7,
        __int64 a8,
        _QWORD *a9,
        __int64 a10,
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a11,
        __int64 a12)
{
  <span class="hljs-type">float</span> v13; <span class="hljs-comment">// s0</span>
  <span class="hljs-type">double</span> v14; <span class="hljs-comment">// d0</span>
  __int64 v15; <span class="hljs-comment">// x20</span>
  <span class="hljs-type">int</span> v16; <span class="hljs-comment">// w0</span>
  __int64 *v17; <span class="hljs-comment">// [xsp+18h] [xbp-68h] BYREF</span>
  __int64 v18; <span class="hljs-comment">// [xsp+20h] [xbp-60h]</span>
  __int64 v19; <span class="hljs-comment">// [xsp+30h] [xbp-50h]</span>
  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *v20; <span class="hljs-comment">// [xsp+58h] [xbp-28h]</span>

  <span class="hljs-keyword">if</span> ( a2 &amp;&amp; a3 )
  {
    <span class="hljs-keyword">switch</span> ( a1 )
    {
...
      <span class="hljs-keyword">case</span> <span class="hljs-number">10</span>:
        <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">4</span> )
        {
          v17 = &amp;a10;
          sub_10F10449C((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)a9);
          <span class="hljs-keyword">goto</span> LABEL_38;
        }
        <span class="hljs-keyword">break</span>;
...
LABEL_38:
            v13 = v14;
          }
LABEL_44:
          *(<span class="hljs-type">float</span> *)a2 = v13;
        }
        <span class="hljs-keyword">break</span>;
...
</code></pre>
<ul>
<li>我们从<code>IDA</code>中查看<code>sub_10F10449C</code>的伪代码实现，发现有可能返回两个值，一个是<code>2.0</code>，一个是全局变量<code>qword_117084280</code>的值</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-type">double</span> __fastcall sub_10F10449C(__int64 a1)
{
  __int64 v2; <span class="hljs-comment">// x0</span>
  <span class="hljs-type">double</span> result; <span class="hljs-comment">// d0</span>
  <span class="hljs-type">double</span> v4[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [xsp+0h] [xbp-40h] BYREF</span>

  v2 = sub_10F104600();
  sub_10F104B7C(v4, v2, a1);
  result = <span class="hljs-number">2.0</span>;
  <span class="hljs-keyword">if</span> ( v4[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">50.0</span> )
    <span class="hljs-keyword">return</span> *(<span class="hljs-type">double</span> *)&amp;qword_117084280;
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ul>
<li>我们查看全局变量<code>qword_117084280</code>的值，发现是<code>3.0</code>，而<code>3.0</code>就是最大播放速度
<ul>
<li>
<p><code>qword_117084280</code>的<code>16</code>进制值</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">0000000117084280</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">40</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
</code></pre>
</li>
<li>
<p>关键是前 <code>8</code> 字节：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">40</span>
</code></pre>
</li>
<li>
<p><code>ARM64</code>、<code>Mach-O</code> 中 <code>double</code> 存储方式都是 <code>little-endian</code>，所以按小端序解析：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">40</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>
</code></pre>
</li>
<li>
<p><code>IEEE-754</code> 双精度格式：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-number">0x4008000000000000</span> → <span class="hljs-number">3.0</span>（<span class="hljs-type">double</span>）
</code></pre>
</li>
<li>
<p>所以<code>qword_117084280 = 3.0</code></p>
</li>
</ul>
</li>
<li>我们添加符号断点<code>sub_10F10449C</code>，看它的返回值多少</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7f11e045b4f4faeb513a779a5ec679e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=3BNwQ%2FlaWKjzjZzxuyN6R5hcX8g%3D" alt="C291B52E-537E-494A-A8C4-8332634DEC40.png" loading="lazy"/></p>
<ul>
<li><code>sub_10F10449C</code>断点触发，返回值发现是<code>3.0</code>，这样就验证了全局变量<code>qword_117084280</code>的值是<code>3.0</code></li>
</ul>
<pre><code class="hljs language-objc" lang="objc">(lldb) <span class="hljs-keyword">register</span> read d0
      d0 = <span class="hljs-number">3</span>
</code></pre>
<ul>
<li><strong>总结</strong>：哔哩哔哩的最大播放速度方法是<code>sub_10F10449C</code>，最大播放速度有可能是<code>2</code>倍速，也可能是<code>3</code>倍速，猜测跟视频有关。</li>
</ul>
<h2 data-id="heading-5">越狱解决方案</h2>
<p>我们<code>hook</code> <code>sub_10F10449C</code>，将最大值改为<code>4.0</code></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 视频最大播放速度</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> maxPlaybackRateValue <span class="hljs-operator">=</span> <span class="hljs-number">4.0</span>

<span class="hljs-comment">// 声明原函数类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">typealias</span> orig_get_max_playback_rate_type <span class="hljs-operator">=</span> <span class="hljs-keyword">@convention(c)</span> (<span class="hljs-keyword">_</span> a1: <span class="hljs-type">Int64</span>) -&gt; <span class="hljs-type">Double</span>

<span class="hljs-comment">// 定义全局函数指针变量，并绑定一个 C 名字</span>
<span class="hljs-meta">@_silgen_name</span>(<span class="hljs-operator">&amp;</span>#<span class="hljs-number">34</span>;orig_get_max_playback_rate<span class="hljs-operator">&amp;</span>#<span class="hljs-number">34</span>;)
<span class="hljs-keyword">nonisolated</span>(unsafe) <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> orig_get_max_playback_rate: orig_get_max_playback_rate_type<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>

<span class="hljs-comment">// 获取最大播放速度方法</span>
<span class="hljs-meta">@_cdecl</span>(<span class="hljs-operator">&amp;</span>#<span class="hljs-number">34</span>;my_get_max_playback_rate<span class="hljs-operator">&amp;</span>#<span class="hljs-number">34</span>;)
<span class="hljs-keyword">func</span> <span class="hljs-title function_">my_get_max_playback_rate</span>(<span class="hljs-params">a1</span>: <span class="hljs-type">Int64</span>) -&gt; <span class="hljs-type">Double</span> {
    <span class="hljs-keyword">return</span> maxPlaybackRateValue
}
</code></pre>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 获取最大播放速度方法</span>
<span class="hljs-type">long</span> <span class="hljs-type">long</span> get_max_playback_rate_address = g_slide+<span class="hljs-number">0x10F10449C</span>;
<span class="hljs-built_in">NSLog</span>(@&amp;#<span class="hljs-number">34</span>;[%@] cal func get_max_playback_rate address:<span class="hljs-number">0</span>x%llx&amp;#<span class="hljs-number">34</span>;, nj_logPrefix, get_max_playback_rate_address);
MSHookFunction((<span class="hljs-type">void</span> *)get_max_playback_rate_address,
			   (<span class="hljs-type">void</span>*)my_get_max_playback_rate,
			   (<span class="hljs-type">void</span>**)&amp;orig_get_max_playback_rate);
</code></pre>
<ul>
<li>我们再<code>hook</code> <code>IJKFFMoviePlayerControllerFFPlay</code>的<code>- (void)setPlaybackRate:(float)playbackRate</code>方法，用以打印日志</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">%hook IJKFFMoviePlayerControllerFFPlay

- (<span class="hljs-type">void</span>)setPlaybackRate:(<span class="hljs-type">float</span>)playbackRate {
    playbackRate = playbackRate == <span class="hljs-number">2.0</span> ? <span class="hljs-number">4.0</span> : playbackRate;
    %orig(playbackRate);
    <span class="hljs-built_in">NSLog</span>(@&amp;#<span class="hljs-number">34</span>;%@:%@-%p-%s-inputPlaybackRate:%lf-changedPlaybackRate:%lf-realPlaybackRate%lf-maxPlaybackRate:%lf&amp;#<span class="hljs-number">34</span>;, nj_logPrefix, <span class="hljs-built_in">NSStringFromClass</span>([(<span class="hljs-type">id</span>)<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]), <span class="hljs-keyword">self</span>, __FUNCTION__, playbackRate, <span class="hljs-keyword">self</span>.playbackRate, <span class="hljs-keyword">self</span>.realPlaybackRate, <span class="hljs-keyword">self</span>.maxPlaybackRate);
}

%end
</code></pre>
<ul>
<li>倍速面板选择<code>2.0</code>，从日志中可以看到，最大播放速度<code>(maxPlaybackRate)改成了4.0</code>，播放速度(<code>changedPlaybackRate</code>)改成了<code>4.0</code>，👍</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">cxzcxz:IJKFFMoviePlayerControllerFFPlay<span class="hljs-number">-0x136428000</span>-_logos_method$App$IJKFFMoviePlayerControllerFFPlay$setPlaybackRate$-inputPlaybackRate:<span class="hljs-number">4.000000</span>-changedPlaybackRate:<span class="hljs-number">4.000000</span>-realPlaybackRate0<span class="hljs-number">.000000</span>-maxPlaybackRate:<span class="hljs-number">4.000000</span>
</code></pre>
<h2 data-id="heading-6">非越狱解决方案</h2>
<p>修改<code>Mach-O</code>文件的汇编指令</p>
<ul>
<li>从<code>sub_10F10449C</code>方法的伪代码可知，<code>sub_10F10449C</code>方法返回的就是最大播放速度</li>
</ul>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-type">double</span> __fastcall sub_10F10449C(__int64 a1)
{
  __int64 v2; <span class="hljs-comment">// x0</span>
  <span class="hljs-type">double</span> result; <span class="hljs-comment">// d0</span>
  <span class="hljs-type">double</span> v4[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [xsp+0h] [xbp-40h] BYREF</span>

  v2 = sub_10F104600();
  sub_10F104B7C(v4, v2, a1);
  result = <span class="hljs-number">2.0</span>;
  <span class="hljs-keyword">if</span> ( v4[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">50.0</span> )
    <span class="hljs-keyword">return</span> *(<span class="hljs-type">double</span> *)&amp;qword_117084280;
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ul>
<li>
<p>修改<code>sub_10F10449C</code>方法的实现，改为类似下面的伪代码</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-keyword">return</span> <span class="hljs-number">4.0</span>;
</code></pre>
<ul>
<li>
<p>对应的汇编指令就是</p>
<pre><code class="hljs language-objc" lang="objc">FMOV            D0, #<span class="hljs-number">4.0</span>
RET
</code></pre>
</li>
</ul>
</li>
<li>
<p>我们修改<code>sub_10F10449C</code>方法的前两条汇编指令，改为下面</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">FMOV            D0, #<span class="hljs-number">4.0</span>
RET
</code></pre>
<ul>
<li>
<p>示例</p>
<p>修改第一条汇编指令</p>
<ul>
<li>
<p>鼠标点击<code>000000010F10449C</code></p>
<pre><code class="hljs language-objc" lang="objc">__text:<span class="hljs-number">000000010</span>F10449C                 SUB             SP, SP, #<span class="hljs-number">0x50</span>
</code></pre>
</li>
<li>
<p>右键选择<code>Assemble</code>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e89803bd5042e5a0c9f06596a2a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=yJ7SvUJM%2FRYePgJifIIOkoRI38w%3D" alt="F5144010-91BD-48E8-8E73-75223FF2C980.png" loading="lazy"/></p>
</li>
<li>
<p>改成</p>
<pre><code class="hljs language-objc" lang="objc">FMOV    D0, #<span class="hljs-number">4.0</span>
</code></pre>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b2988ba4df94c7995f517da88816b19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=i6CDpqvO5z%2FC%2BaroZUETHToGiqE%3D" alt="3428FB04-36CC-43E8-B362-89CF02D7FFC6.png" loading="lazy"/></p>
<ul>
<li>点击<code>enter</code></li>
</ul>
</li>
<li>
<p>全部修改结果</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1d49aa2bc904d819f567d3ba5da5754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=P4YvcuCeVqSUQ8WBpscGzxQFa94%3D" alt="F808A0ED-9C78-4589-80A0-76BD2FCF1F8A.png" loading="lazy"/></p>
<ul>
<li>
<p>保存到<code>Mach-O</code>文件中</p>
<ul>
<li><code>IDA</code>-&gt;<code>Edit</code>-&gt;<code>Patch program</code>-&gt;<code>Apply patches to input file</code>-&gt;<code>Apply patches</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36d111ae3ef84ce1962f72a71977486b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=s6nCJCoLKFCQBV1JWsBwEFJo9Aw%3D" alt="542DF73E-FA15-41B7-A251-31E30F37EB38.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73cddc9a6f0844d38e1f8555abdbb8f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=lBcigVZQiZ31iIJx%2B%2BTtr0SjlKE%3D" alt="0D71933B-BB78-48A6-AEA2-A12AC7261586.png" loading="lazy"/></p>
</li>
<li>
<p>保存后，底部会显示<code>log</code>：</p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">Patch successful: /Users/touchworld/Documents/iOSDisassembler/hook/bilibili/IDA_max_0/bili-universal
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e9022d75ea44c9bbb4d9c2f5cd635ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016127&amp;x-signature=z8L7MsN9kyLw%2B9vJg%2Fq0PpoupxA%3D" alt="F1E26F23-6F74-4DEC-B1CD-1256372F5FBE.png" loading="lazy"/></p>
<h2 data-id="heading-7">代码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTouchFriend%2FBiliBiliMApp%2Fblob%2Fmain%2FBiliBiliMDDylib%2FLogos%2FDetail%2FNJPlaybackRate.xm" target="_blank" title="https://github.com/TouchFriend/BiliBiliMApp/blob/main/BiliBiliMDDylib/Logos/Detail/NJPlaybackRate.xm" ref="nofollow noopener noreferrer">BiliBiliMApp-NJPlaybackRate.xm</a></p>
<h2 data-id="heading-8">相关链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbilibili%2Fijkplayer" target="_blank" title="https://github.com/bilibili/ijkplayer" ref="nofollow noopener noreferrer">哔哩哔哩的视频播放器：ijkplayer</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接口报 500 了，日志里却空空的？FastAPI 异常处理最佳实践]]></title>    <link>https://juejin.cn/post/7582041304655396910</link>    <guid>https://juejin.cn/post/7582041304655396910</guid>    <pubDate>2025-12-11T00:06:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582041304655396910" data-draft-id="7582041304655380526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接口报 500 了，日志里却空空的？FastAPI 异常处理最佳实践"/> <meta itemprop="keywords" content="FastAPI,AI编程"/> <meta itemprop="datePublished" content="2025-12-11T00:06:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lomocode"/> <meta itemprop="url" content="https://juejin.cn/user/2103792315926697"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接口报 500 了，日志里却空空的？FastAPI 异常处理最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2103792315926697/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lomocode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:06:14.000Z" title="Thu Dec 11 2025 00:06:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21b149427bae46f8909515d281cf6281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9tb2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766016373&amp;x-signature=PhQ6QaXui8B47OnHp5W2O6O0bY0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>聊聊 AI 后端那些事儿 · 第 2 篇 | 阅读大约需 10 分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">那个神秘的 500 错误</h2>
<p>周三下午，前端同事发来消息："小禾，生成图片的接口挂了，返回 500。"</p>
<p>小禾打开服务器日志：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024-01-15 14:30:00</span> <span class="hljs-string">|</span> <span class="hljs-string">INFO</span> <span class="hljs-string">|</span> <span class="hljs-string">应用启动完成</span>
<span class="hljs-number">2024-01-15 14:30:05</span> <span class="hljs-string">|</span> <span class="hljs-string">INFO</span> <span class="hljs-string">|</span> <span class="hljs-string">收到请求:</span> <span class="hljs-string">POST</span> <span class="hljs-string">/api/generate</span>
<span class="hljs-string">...</span>
</code></pre>
<p>然后就没了。</p>
<p>没有错误信息，没有堆栈跟踪，什么都没有。</p>
<p>小禾本地跑了一遍，正常。</p>
<p>他又看了看前端控制台：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">POST</span> /<span class="hljs-selector-tag">api</span>/<span class="hljs-selector-tag">generate</span> <span class="hljs-number">500</span> (Internal Server Error)
{<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">detail</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">Internal</span> <span class="hljs-selector-tag">Server</span> <span class="hljs-selector-tag">Error</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;}
</code></pre>
<p>就这么一行，没有任何有用的信息。</p>
<p>小禾开始漫长的排查之旅：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">14:35 - 加了几个 print，重新部署</span>
<span class="hljs-section">14:50 - 发现 print 没输出，可能没走到那</span>
<span class="hljs-section">15:20 - 又加了几个 print，又部署</span>
<span class="hljs-section">15:45 - 终于发现是某个深层函数抛了异常</span>
<span class="hljs-section">16:00 - 定位到问题：一个变量是 None</span>
<span class="hljs-section">16:10 - 修复，部署，测试通过</span>
</code></pre>
<p>三个小时，就为了找一个空指针。</p>
<p>小禾越想越气：<strong>为什么异常没打日志？</strong></p>
<p>他翻了翻代码，找到了罪魁祸首：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    result = some_function()
<span class="hljs-keyword">except</span> Exception:
    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 就是这行！</span>
</code></pre>
<p>某位前人写的代码，捕获了所有异常，然后什么都不做。</p>
<p>异常就这么被吞掉了，悄无声息。</p>
<hr/>
<h2 data-id="heading-1">异常处理的三个层级</h2>
<p>痛定思痛，小禾决定重构整个异常处理体系。</p>
<p>他画了张架构图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[HTTP 请求] --&gt; B[Layer 1: 全局异常处理器]
    B --&gt; C[Layer 2: 业务异常处理]
    C --&gt; D[Layer 3: 端点级 try-except]
    D --&gt; E[业务逻辑]

    E --&gt;|抛出异常| F{异常类型?}
    F --&gt;|业务异常| C
    F --&gt;|未知异常| B

    C --&gt; G[返回友好错误提示]
    B --&gt; H[记录日志 + 返回通用错误]
</code></pre>
<p>三层防护，各司其职：</p>
<ol>
<li><strong>全局异常处理器</strong>：兜底所有未处理的异常，记录日志，返回统一格式</li>
<li><strong>业务异常处理</strong>：处理可预期的业务错误，返回友好提示</li>
<li><strong>端点级 try-except</strong>：处理特定接口的特定异常，做细粒度恢复</li>
</ol>
<hr/>
<h2 data-id="heading-2">定义业务异常类</h2>
<p>首先，定义一套业务异常类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/core/exceptions.py</span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppException</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;应用异常基类&amp;#34;&amp;#34;&amp;#34;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        message: <span class="hljs-built_in">str</span>,
        code: <span class="hljs-built_in">str</span> = &amp;<span class="hljs-comment">#34;UNKNOWN_ERROR&amp;#34;,</span>
        status_code: <span class="hljs-built_in">int</span> = <span class="hljs-number">500</span>,
        details: <span class="hljs-type">Optional</span>[<span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span>
    </span>):
        self.message = message
        self.code = code
        self.status_code = status_code
        self.details = details
        <span class="hljs-built_in">super</span>().__init__(message)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationError</span>(<span class="hljs-title class_ inherited__">AppException</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;数据验证错误&amp;#34;&amp;#34;&amp;#34;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">str</span>, details: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-built_in">super</span>().__init__(message, &amp;<span class="hljs-comment">#34;VALIDATION_ERROR&amp;#34;, 400, details)</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundError</span>(<span class="hljs-title class_ inherited__">AppException</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;资源不存在&amp;#34;&amp;#34;&amp;#34;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, resource: <span class="hljs-built_in">str</span>, resource_id: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-built_in">super</span>().__init__(
            f&amp;<span class="hljs-comment">#34;{resource} not found: {resource_id}&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;NOT_FOUND&amp;#34;,</span>
            <span class="hljs-number">404</span>,
            {&amp;<span class="hljs-comment">#34;resource&amp;#34;: resource, &amp;#34;id&amp;#34;: resource_id}</span>
        )


<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenerationError</span>(<span class="hljs-title class_ inherited__">AppException</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;AI 生成错误&amp;#34;&amp;#34;&amp;#34;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message: <span class="hljs-built_in">str</span>, model: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-built_in">super</span>().__init__(
            message,
            &amp;<span class="hljs-comment">#34;GENERATION_ERROR&amp;#34;,</span>
            <span class="hljs-number">500</span>,
            {&amp;<span class="hljs-comment">#34;model&amp;#34;: model}</span>
        )


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExternalServiceError</span>(<span class="hljs-title class_ inherited__">AppException</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;外部服务错误&amp;#34;&amp;#34;&amp;#34;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, service: <span class="hljs-built_in">str</span>, message: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-built_in">super</span>().__init__(
            f&amp;<span class="hljs-comment">#34;{service} error: {message}&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;EXTERNAL_SERVICE_ERROR&amp;#34;,</span>
            <span class="hljs-number">502</span>,
            {&amp;<span class="hljs-comment">#34;service&amp;#34;: service}</span>
        )
</code></pre>
<p>有了这套异常类，错误就有了明确的分类和结构。</p>
<hr/>
<h2 data-id="heading-3">全局异常处理器</h2>
<p>然后，在 FastAPI 应用中注册异常处理器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/main.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">from</span> app.core.exceptions <span class="hljs-keyword">import</span> AppException
<span class="hljs-keyword">from</span> app.core.logger <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">import</span> traceback

app = FastAPI()

<span class="hljs-meta">@app.exception_handler(<span class="hljs-params">AppException</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">app_exception_handler</span>(<span class="hljs-params">request: Request, exc: AppException</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;处理业务异常&amp;#34;&amp;#34;&amp;#34;</span>

    <span class="hljs-comment"># 业务异常用 warning 级别</span>
    logger.warning(
        f&amp;<span class="hljs-comment">#34;业务异常 [{exc.code}]: {exc.message}&amp;#34;,</span>
        extra={
            &amp;<span class="hljs-comment">#34;path&amp;#34;: request.url.path,</span>
            &amp;<span class="hljs-comment">#34;method&amp;#34;: request.method,</span>
            &amp;<span class="hljs-comment">#34;code&amp;#34;: exc.code,</span>
            &amp;<span class="hljs-comment">#34;details&amp;#34;: exc.details</span>
        }
    )

    <span class="hljs-keyword">return</span> JSONResponse(
        status_code=exc.status_code,
        content={
            &amp;<span class="hljs-comment">#34;success&amp;#34;: False,</span>
            &amp;<span class="hljs-comment">#34;error&amp;#34;: {</span>
                &amp;<span class="hljs-comment">#34;code&amp;#34;: exc.code,</span>
                &amp;<span class="hljs-comment">#34;message&amp;#34;: exc.message,</span>
                &amp;<span class="hljs-comment">#34;details&amp;#34;: exc.details</span>
            }
        }
    )


<span class="hljs-meta">@app.exception_handler(<span class="hljs-params">Exception</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">global_exception_handler</span>(<span class="hljs-params">request: Request, exc: Exception</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;处理所有未捕获的异常&amp;#34;&amp;#34;&amp;#34;</span>

    <span class="hljs-comment"># 未知异常用 error 级别，记录完整堆栈</span>
    logger.error(
        f&amp;<span class="hljs-comment">#34;未处理的异常: {type(exc).__name__}: {str(exc)}&amp;#34;,</span>
        extra={
            &amp;<span class="hljs-comment">#34;path&amp;#34;: request.url.path,</span>
            &amp;<span class="hljs-comment">#34;method&amp;#34;: request.method,</span>
            &amp;<span class="hljs-comment">#34;traceback&amp;#34;: traceback.format_exc()  # 完整堆栈！</span>
        }
    )

    <span class="hljs-comment"># 生产环境不暴露内部错误细节</span>
    <span class="hljs-keyword">return</span> JSONResponse(
        status_code=<span class="hljs-number">500</span>,
        content={
            &amp;<span class="hljs-comment">#34;success&amp;#34;: False,</span>
            &amp;<span class="hljs-comment">#34;error&amp;#34;: {</span>
                &amp;<span class="hljs-comment">#34;code&amp;#34;: &amp;#34;INTERNAL_ERROR&amp;#34;,</span>
                &amp;<span class="hljs-comment">#34;message&amp;#34;: &amp;#34;An internal error occurred. Please try again later.&amp;#34;</span>
            }
        }
    )
</code></pre>
<p><strong>关键点</strong>：<code>traceback.format_exc()</code> 会记录完整的堆栈信息。</p>
<p>有了这个，再也不用加 print 去猜异常在哪了。</p>
<hr/>
<h2 data-id="heading-4">端点级异常处理</h2>
<p>对于特定接口，可以做更细粒度的处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/endpoints/generate.py</span>
<span class="hljs-keyword">from</span> app.core.exceptions <span class="hljs-keyword">import</span> GenerationError, ValidationError

<span class="hljs-meta">@router.post(<span class="hljs-params">&amp;<span class="hljs-comment">#34;/shot-image&amp;#34;)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> generate_shot_image(<span class="hljs-params">request: GenerateShotImageRequest</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;生成分镜图片&amp;#34;&amp;#34;&amp;#34;</span>

    <span class="hljs-comment"># 参数验证</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request.prompt.strip(<span class="hljs-params"/>):
        <span class="hljs-keyword">raise</span> ValidationError(<span class="hljs-params">&amp;<span class="hljs-comment">#34;Prompt cannot be empty&amp;#34;)</span>

    <span class="hljs-keyword">try</span>:
        adapter = ImageGenerationAdapterFactory.get_current_adapter(<span class="hljs-params"/>)
        result = <span class="hljs-keyword">await</span> adapter.generate_shot_image(<span class="hljs-params">
            prompt=request.prompt,
            width=request.width,
            height=request.height
        </span>)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result.get(<span class="hljs-params">&amp;<span class="hljs-comment">#34;success&amp;#34;):</span>
            <span class="hljs-keyword">raise</span> GenerationError(<span class="hljs-params">
                result.get(<span class="hljs-params">&amp;<span class="hljs-comment">#34;error&amp;#34;, &amp;#34;Unknown generation error&amp;#34;),</span>
                model=settings.IMAGE_MODEL
            </span>)

        <span class="hljs-keyword">return</span> {&amp;<span class="hljs-comment">#34;success&amp;#34;: True, &amp;#34;data&amp;#34;: result}</span>

    <span class="hljs-keyword">except</span> GenerationError:
        <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># 已经是业务异常，直接抛出</span>

    <span class="hljs-keyword">except</span> torch.cuda.OutOfMemoryError:
        <span class="hljs-comment"># 特定异常转换为业务异常</span>
        <span class="hljs-keyword">raise</span> GenerationError(<span class="hljs-params">&amp;<span class="hljs-comment">#34;GPU out of memory. Please try a smaller image size.&amp;#34;)</span>

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 未知异常，记录后转换为业务异常</span>
        logger.error(<span class="hljs-params">f&amp;<span class="hljs-comment">#34;Unexpected error in generate_shot_image: {e}&amp;#34;)</span>
        <span class="hljs-keyword">raise</span> GenerationError(<span class="hljs-params">f&amp;<span class="hljs-comment">#34;Generation failed: {str(e)}&amp;#34;)</span>
</span></span></span></span></span></span></span></span></code></pre>
<p>这样：</p>
<ul>
<li>参数错误返回 400</li>
<li>显存不足返回 500，但有友好提示</li>
<li>其他异常也会被捕获，不会"消失"</li>
</ul>
<hr/>
<h2 data-id="heading-5">日志配置</h2>
<p>小禾选用了 loguru，比标准库的 logging 好用太多：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/core/logger.py</span>
<span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">import</span> sys

<span class="hljs-comment"># 移除默认处理器</span>
logger.remove()

<span class="hljs-comment"># 控制台输出（开发环境）</span>
logger.add(
    sys.stdout,
    <span class="hljs-built_in">format</span>=&amp;<span class="hljs-comment">#34;{time:YYYY-MM-DD HH:mm:ss} | &amp;#34;</span>
           &amp;<span class="hljs-comment">#34;{level:  | &amp;#34;</span>
           &amp;<span class="hljs-comment">#34;{name}:{function}:{line} | &amp;#34;</span>
           &amp;<span class="hljs-comment">#34;{message}&amp;#34;,</span>
    level=&amp;<span class="hljs-comment">#34;DEBUG&amp;#34;</span>
)

<span class="hljs-comment"># 文件输出（生产环境）</span>
logger.add(
    &amp;<span class="hljs-comment">#34;logs/app_{time:YYYY-MM-DD}.log&amp;#34;,</span>
    <span class="hljs-built_in">format</span>=&amp;<span class="hljs-comment">#34;{time:YYYY-MM-DD HH:mm:ss} | {level:  {request.method} {request.url.path}&amp;#34;)</span>

    start = time.time()

    <span class="hljs-comment"># 处理请求</span>
    response = <span class="hljs-keyword">await</span> call_next(request)

    <span class="hljs-comment"># 计算耗时</span>
    duration = time.time() - start

    <span class="hljs-comment"># 记录请求完成</span>
    logger.info(f&amp;<span class="hljs-comment">#34;[{request_id}]  POST /api/generate/shot-image</span>
    <span class="hljs-number">2024</span>-01-<span class="hljs-number">15</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">12</span> | INFO | [a1b2c3d4]  业务 -\&gt; 端点    |
| 日志要完整   | 包含堆栈、请求信息           |
| 错误码标准化  | 定义业务异常枚举            |
| 开发/生产区分 | 开发环境暴露详情            |
| 请求可追踪   | 添加 request\_<span class="hljs-built_in">id</span>      |

***

<span class="hljs-comment">## 小禾的感悟</span>

    那三小时的排查，
    让我学会一个道理：

    异常不会消失，
    只会被藏起来。

    <span class="hljs-keyword">except</span> <span class="hljs-keyword">pass</span> 是懒惰，
    是给未来的自己挖坑。

    每个异常都有它的意义，
    要么处理它，
    要么记录它，
    要么抛出它。

    但绝不能忽视它。

    全局处理器是保险，
    业务异常是分类，
    日志是证据。

    有了这三样，
    再也不用三小时找 bug 了。

    下次有人说 <span class="hljs-number">500</span>，
    我只需要一分钟。

小禾看着清晰的日志输出，心情大好。

三小时的教训，换来了一套完善的异常处理体系。

值了。

***

**下一篇预告：前端传了个 null，后端直接炸了**

&gt; 防御性编程，让你的接口固若金汤。

敬请期待。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Spark Shell 做交互式数据分析从入门到自包含应用]]></title>    <link>https://juejin.cn/post/7582131164728361000</link>    <guid>https://juejin.cn/post/7582131164728361000</guid>    <pubDate>2025-12-11T02:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728361000" data-draft-id="7582096212663402496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Spark Shell 做交互式数据分析从入门到自包含应用"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-11T02:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloReader"/> <meta itemprop="url" content="https://juejin.cn/user/2601910535729322"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Spark Shell 做交互式数据分析从入门到自包含应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601910535729322/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloReader
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:59:50.000Z" title="Thu Dec 11 2025 02:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么用 Spark Shell？</h2>
<p>Spark Shell 既是<strong>学习 API 的最短路径</strong>，也是<strong>探索数据的强大交互工具</strong>。你可以在 Shell 里反复尝试、立即验证，然后把验证过的代码拷进正式作业或应用。</p>
<ul>
<li>支持 <strong>Scala</strong>（运行在 JVM，上手 Java 生态很方便）</li>
<li>支持 <strong>Python（PySpark）</strong>（语法简洁、数据科学生态友好）</li>
</ul>
<h2 data-id="heading-1">环境与启动方式</h2>
<h3 data-id="heading-2">方式 A：使用 Spark 自带脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Python</span>
./bin/pyspark

<span class="hljs-comment"># Scala</span>
./bin/spark-shell
</code></pre>
<h3 data-id="heading-3">方式 B：已通过 pip 安装 PySpark（推荐给数据科学/本地开发）</h3>
<pre><code class="hljs language-bash" lang="bash">pip install pyspark
pyspark
</code></pre>
<blockquote>
<p>小贴士：</p>
<ul>
<li>
<p>指定 Python 解释器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> PYSPARK_PYTHON=python3
</code></pre>
</li>
<li>
<p>指定 Spark 路径（必要时）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> SPARK_HOME=/path/to/spark
</code></pre>
</li>
</ul>
</blockquote>
<h2 data-id="heading-4">Spark 的核心抽象：Dataset / DataFrame</h2>
<ul>
<li><strong>Dataset</strong>：分布式元素集合。</li>
<li>在 <strong>Python</strong> 中，由于动态类型特性，实际使用的是 <strong><code>Dataset[Row]</code></strong>，通常直接称为 <strong>DataFrame</strong>（与 Pandas/R 的 DataFrame 概念一致）。</li>
</ul>
<h3 data-id="heading-5">读取文本为 DataFrame</h3>
<pre><code class="hljs language-python" lang="python">textFile = spark.read.text(&amp;<span class="hljs-comment">#34;README.md&amp;#34;)  # 每行一条记录，列名为 &amp;#34;value&amp;#34;</span>
</code></pre>
<h3 data-id="heading-6">常用 action</h3>
<pre><code class="hljs language-python" lang="python">textFile.count()   <span class="hljs-comment"># 行数</span>
textFile.first()   <span class="hljs-comment"># Row(value='...')</span>
</code></pre>
<h3 data-id="heading-7">过滤与链式调用</h3>
<pre><code class="hljs language-python" lang="python">linesWithSpark = textFile.<span class="hljs-built_in">filter</span>(textFile.value.contains(&amp;<span class="hljs-comment">#34;Spark&amp;#34;))</span>
linesWithSpark.count()  <span class="hljs-comment"># 例如 15</span>

<span class="hljs-comment"># 链式：过滤后直接计数</span>
textFile.<span class="hljs-built_in">filter</span>(textFile.value.contains(&amp;<span class="hljs-comment">#34;Spark&amp;#34;)).count()</span>
</code></pre>
<h2 data-id="heading-8">复杂一点：统计“每行最大词数”</h2>
<blockquote>
<p><strong>关键修正</strong>：在 <strong>PySpark</strong> 用 <code>.alias(&amp;#34;...&amp;#34;)</code>（而非 <code>.name(&amp;#34;...&amp;#34;)</code>），并使用<strong>原始字符串</strong>表达正则 <code>r&amp;#34;\s+&amp;#34;</code>，避免转义歧义。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> functions <span class="hljs-keyword">as</span> F

result = (
    textFile
      .select(F.size(F.split(F.col(&amp;<span class="hljs-comment">#34;value&amp;#34;), r&amp;#34;\s+&amp;#34;)).alias(&amp;#34;numWords&amp;#34;))</span>
      .agg(F.<span class="hljs-built_in">max</span>(F.col(&amp;<span class="hljs-comment">#34;numWords&amp;#34;)).alias(&amp;#34;max_numWords&amp;#34;))</span>
      .collect()
)
result  <span class="hljs-comment"># [Row(max_numWords=15)]</span>
</code></pre>
<h2 data-id="heading-9">MapReduce 风格：做一次词频统计（Word Count）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> functions <span class="hljs-keyword">as</span> F

wordCounts = (
    textFile
      .select(F.explode(F.split(F.col(&amp;<span class="hljs-comment">#34;value&amp;#34;), r&amp;#34;\s+&amp;#34;)).alias(&amp;#34;word&amp;#34;))</span>
      .where(F.col(&amp;<span class="hljs-comment">#34;word&amp;#34;) != &amp;#34;&amp;#34;)         # 可选：剔除空字符串</span>
      .groupBy(&amp;<span class="hljs-comment">#34;word&amp;#34;)</span>
      .count()
)

<span class="hljs-comment"># 看看 Top 20</span>
wordCounts.orderBy(F.col(&amp;<span class="hljs-comment">#34;count&amp;#34;).desc()).show(20, truncate=False)</span>

<span class="hljs-comment"># 也可以落到磁盘/HDFS</span>
<span class="hljs-comment"># wordCounts.write.mode(&amp;#34;overwrite&amp;#34;).csv(&amp;#34;/tmp/wordcounts&amp;#34;)</span>
</code></pre>
<h2 data-id="heading-10">缓存与性能：cache / persist</h2>
<p>当数据会被<strong>重复访问</strong>（比如小而热的数据集，或 PageRank 这类迭代算法），把它放进<strong>集群级内存缓存</strong>会极大提高效率。</p>
<pre><code class="hljs language-python" lang="python">linesWithSpark.cache()   <span class="hljs-comment"># 默认 MEMORY_ONLY</span>
linesWithSpark.count()   <span class="hljs-comment"># 触发计算并物化缓存</span>
linesWithSpark.count()   <span class="hljs-comment"># 再次访问会更快</span>

<span class="hljs-comment"># 指定存储级别（当数据较大时有用）</span>
<span class="hljs-keyword">from</span> pyspark.storagelevel <span class="hljs-keyword">import</span> StorageLevel
linesWithSpark.persist(StorageLevel.MEMORY_AND_DISK)
</code></pre>
<p>实用调试：</p>
<pre><code class="hljs language-python" lang="python">linesWithSpark.explain()              <span class="hljs-comment"># 物理/逻辑执行计划</span>
wordCounts.explain(&amp;<span class="hljs-comment">#34;formatted&amp;#34;)       # 更友好的格式（Spark 3+）</span>
</code></pre>
<h2 data-id="heading-11">自包含应用：用 PySpark 编写并运行</h2>
<p>如果你在做<strong>打包的 PySpark 应用/库</strong>，可以在 <code>setup.py</code> 里声明依赖：</p>
<pre><code class="hljs language-python" lang="python">install_requires = [
    &amp;<span class="hljs-comment">#34;pyspark==4.0.1&amp;#34;  # 按你的实际版本固定</span>
]
</code></pre>
<h3 data-id="heading-12">示例：<code>SimpleApp.py</code></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># SimpleApp.py</span>
<span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession
<span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> functions <span class="hljs-keyword">as</span> F

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    logFile = &amp;<span class="hljs-comment">#34;YOUR_SPARK_HOME/README.md&amp;#34;  # 替换为实际文件路径</span>
    spark = SparkSession.builder.appName(&amp;<span class="hljs-comment">#34;SimpleApp&amp;#34;).getOrCreate()</span>

    df = spark.read.text(logFile).cache()

    numAs = df.<span class="hljs-built_in">filter</span>(F.col(&amp;<span class="hljs-comment">#34;value&amp;#34;).contains(&amp;#34;a&amp;#34;)).count()</span>
    numBs = df.<span class="hljs-built_in">filter</span>(F.col(&amp;<span class="hljs-comment">#34;value&amp;#34;).contains(&amp;#34;b&amp;#34;)).count()</span>

    <span class="hljs-built_in">print</span>(&amp;<span class="hljs-comment">#34;Lines with a: %i, lines with b: %i&amp;#34; % (numAs, numBs))</span>

    spark.stop()

<span class="hljs-keyword">if</span> __name__ == &amp;<span class="hljs-comment">#34;__main__&amp;#34;:</span>
    main()
</code></pre>
<h3 data-id="heading-13">运行方式</h3>
<p><strong>首选：<code>spark-submit</code></strong></p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-variable">${SPARK_HOME}</span>/bin/spark-submit \
  --master &amp;<span class="hljs-comment">#34;local[4]&amp;#34; \</span>
  SimpleApp.py

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># Lines with a: 46, lines with b: 23</span>
</code></pre>
<p><strong>如果已用 pip 安装 PySpark</strong>（可直接用 Python 运行）：</p>
<pre><code class="hljs language-bash" lang="bash">$ python SimpleApp.py
<span class="hljs-comment"># Lines with a: 46, lines with b: 23</span>
</code></pre>
<blockquote>
<p>引入第三方代码/依赖时，可用 <code>--py-files</code> 传入 zip 包；引入连接器/JAR 时可用：</p>
<pre><code class="hljs language-bash" lang="bash">spark-submit --packages groupId:artifactId:version SimpleApp.py
</code></pre>
</blockquote>
<h2 data-id="heading-14">去哪里继续深入？</h2>
<ul>
<li>
<p><strong>RDD 编程指南</strong> 与 <strong>Spark SQL 编程指南</strong>：系统理解 API 与最佳实践</p>
</li>
<li>
<p><strong>部署指南</strong>：把应用跑在真实集群（Standalone / YARN / Kubernetes）</p>
</li>
<li>
<p><strong>examples 目录</strong> 含多语言示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Python</span>
./bin/spark-submit examples/src/main/python/pi.py

<span class="hljs-comment"># Scala / Java</span>
./bin/run-example SparkPi

<span class="hljs-comment"># R</span>
./bin/spark-submit examples/src/main/r/dataframe.R
</code></pre>
</li>
</ul>
<h2 data-id="heading-15">常见坑与实战建议（强烈建议一读）</h2>
<ol>
<li><strong>PySpark 别用 <code>.name(...)</code></strong> → 用 <code>.alias(&amp;#34;...&amp;#34;)</code>。</li>
<li><strong>正则用原始字符串</strong> → <code>r&amp;#34;\s+&amp;#34;</code>，避免 <code>&amp;#34;\s&amp;#34;</code> 被当作普通 <code>s</code>。</li>
<li><strong>谨慎 <code>collect()</code></strong> → 仅用于小结果；大结果用 <code>show()</code>/<code>take(n)</code> 或直接写出到存储。</li>
<li><strong>只缓存“热数据”</strong> → 先 <code>explain()</code> 看执行计划、用 UI 观察 DAG 与缓存命中，不要“见谁 cache 谁”。</li>
<li><strong>路径要清晰</strong> → 本地绝对路径 vs HDFS/S3 URI（<code>hdfs://</code>、<code>s3a://</code>）。</li>
<li><strong>并行度与分区</strong> → <code>repartition(n)</code> 提升 shuffle 后并行度；小结果落盘可 <code>coalesce(1)</code> 合并为单文件（仅适用于小数据）。</li>
<li><strong>版本统一</strong> → PySpark 版本与集群 Spark 版本尽量匹配，避免协议/计划不兼容。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Trea来快速生成一个浏览器插件]]></title>    <link>https://juejin.cn/post/7582133314686582836</link>    <guid>https://juejin.cn/post/7582133314686582836</guid>    <pubDate>2025-12-11T03:05:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582133314686582836" data-draft-id="7581999251366969396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Trea来快速生成一个浏览器插件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T03:05:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹卫平dudu"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383544855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Trea来快速生成一个浏览器插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383544855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹卫平dudu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:05:26.000Z" title="Thu Dec 11 2025 03:05:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用Trea来开发一个浏览器插件</h2>
<h3 data-id="heading-1">背景</h3>
<p>浏览网页的时候，总是外网的加载不出来，弄了梯子，有时候直连的又加载不出来，最近ZeroOmega也老是不好用，总有些资源加载不出来</p>
<h3 data-id="heading-2">Trea solo</h3>
<p>直接打开trea,新建任务，输入提示词：</p>
<pre><code class="hljs language-提示词" lang="提示词">帮我开发一个浏览器插件，主要功能是管理浏览器，默认浏览器直联，如果链接异常的网址通过vpn链接
</code></pre>
<p>打开plan开关，点击发送
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85cc61cf78394b0ca838077e19d18d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=nUirgJlCinEdrBQFxEBONRiOONc%3D" alt="image.png" loading="lazy"/>
Trea就吭哧吭哧一顿计划，会生成一个计划文档</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e0b81b67354782833ad594df1baff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=buRGdMSzARv4PlbIPMs28MSCDyM%3D" alt="image.png" loading="lazy"/>
非常的专业</p>
<h3 data-id="heading-3">点击执行计划</h3>
<p>很快的就会生成项目，给项目添加上对应的icon图片，就可以在浏览器里打开了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0ed9848f9d84e05a74078d98de746c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=RGzCXMZtWCkUF6BApBMswf0EmNA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823205fc395c4a408791dc7cfc142902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=LcZNizW9EJbocvIb67KktmtA05g%3D" alt="image.png" loading="lazy"/>
并且可以截图让他对对应的有问题的地方进行修改</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e2197c77354e9faf8f4a263287baff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=KlneZYzEHyCsKevTo3Szx3D08kM%3D" alt="image.png" loading="lazy"/>
截图改变按钮大小</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3956f9c279db481bb005197d6b930edb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=fjUnh51FxB8p3%2BiJQ99r%2B2UYOFY%3D" alt="image.png" loading="lazy"/>
改完后的效果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e7194d13a724ed888bda33a01c66303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=VJ7jf9esIbyOYY3rwEsegavfzDQ%3D" alt="image.png" loading="lazy"/>
再微调微调，搞定</p>
<h3 data-id="heading-4">效果展示</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fc970ca876e458095c47b42b6927d0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=JdKsW0QNEfyjIdeU44ErF%2Fjwvm8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fbffcd4c97d47ee8eb2928f02796862~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=o4fP9JnkAfkAom1Rw7%2BxEltCr%2BA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fd86ad5cd7b489abc2754f4f538d283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766027126&amp;x-signature=pQWEH8Hq9tEpghpK6gDTlfY4PLY%3D" alt="image.png" loading="lazy"/>
简单实用，比较满意</p>
<h3 data-id="heading-5">不足之处</h3>
<p>很多网站的资源都不在同一个域名下，需要配置多个域名，如:tiktok.com的很多资源在tiktokv.com这个域名下，这就需要打开网站的调试工具，检查哪些资源无法加载的，把相应的域名添加到代理列表才可以。想让Trea solo根据标签页来判断是否需要代理，需要代理的整个标签页的所有请求都走代理，但是ai也没弄成。有大佬的可以指导指导。</p>
<pre><code class="hljs language-background.js" lang="background.js">// 浏览器代理管理器 - 背景脚本

// 初始化存储
async function initStorage() {
  const storage = await chrome.storage.local.get(['exceptionUrls', 'proxyConfig', 'isEnabled']);
  
  // 设置默认值
  const defaults = {
    exceptionUrls: [],
    proxyConfig: {
      host: '127.0.0.1',
      port: 1080,
      type: 'http'
    },
    isEnabled: true
  };
  
  // 合并默认值和现有值 - 只在值不存在时使用默认值
  const newStorage = {
    exceptionUrls: storage.exceptionUrls !== undefined ? storage.exceptionUrls : defaults.exceptionUrls,
    proxyConfig: storage.proxyConfig || defaults.proxyConfig,
    isEnabled: storage.isEnabled !== undefined ? storage.isEnabled : defaults.isEnabled
  };
  
  // 保存到存储
  await chrome.storage.local.set(newStorage);
  
  console.log('Storage initialized:', newStorage);
  
  // 更新规则
  await updateRules(newStorage.exceptionUrls);
}

// 更新网络请求规则
async function updateRules(exceptionUrls) {
  // 不再使用declarativeNetRequest，直接更新PAC脚本
  await initProxySettings();
}

// 配置代理函数已移除，改为使用PAC脚本处理代理逻辑

// 监听存储变化
chrome.storage.onChanged.addListener(async (changes, area) =&gt; {
  if (area === 'local') {
    if (changes.exceptionUrls) {
      await updateRules(changes.exceptionUrls.newValue);
    }
  }
});

// 初始化代理设置
async function initProxySettings() {
  const storage = await chrome.storage.local.get(['isEnabled', 'exceptionUrls', 'proxyConfig']);
  
  console.log('initProxySettings called with:', storage);
  
  if (storage.isEnabled) {
    // 配置代理
    const exceptionUrls = storage.exceptionUrls || [];
    const proxyConfig = storage.proxyConfig || { host: '127.0.0.1', port: 1080, type: 'http' };
    
    console.log('Enabling proxy with config:', proxyConfig);
    console.log('Exception URLs:', exceptionUrls);
    
    // 生成PAC脚本
    const pacScript = `function FindProxyForURL(url, host) {
      // Browser Proxy Manager - PAC Script
      const exceptionUrls = ${JSON.stringify(exceptionUrls)};
      const proxyConfig = ${JSON.stringify(proxyConfig)};
      
      // Check if URL is in proxy list
      const isException = exceptionUrls.some(proxyUrl =&gt; {
        return host === proxyUrl || host.endsWith(&amp;#34;.&amp;#34; + proxyUrl);
      });
      
      if (isException) {
        // Use proxy
        const proxyStr = 'PROXY ' + proxyConfig.host + ':' + proxyConfig.port + '; DIRECT';
        return proxyStr;
      } else {
        // Direct connection
        return 'DIRECT';
      }
    }`;
    
    try {
      await chrome.proxy.settings.set({
        value: {
          mode: 'pac_script',
          pacScript: {
            data: pacScript
          }
        },
        scope: 'regular'
      }, () =&gt; {
        if (chrome.runtime.lastError) {
          console.error('Error setting proxy:', chrome.runtime.lastError);
        } else {
          console.log('Proxy settings updated successfully');
        }
      });
    } catch (error) {
      console.error('Error setting proxy settings:', error);
    }
  } else {
    // 禁用代理
    console.log('Disabling proxy');
    try {
      await chrome.proxy.settings.set({
        value: {
          mode: 'direct'
        },
        scope: 'regular'
      });
    } catch (error) {
      console.error('Error disabling proxy:', error);
    }
  }
}

// 监听扩展安装或更新
chrome.runtime.onInstalled.addListener(async () =&gt; {
  await initStorage();
  await initProxySettings();
  // 初始化所有标签页的图标和徽章颜色
  const storage = await chrome.storage.local.get(['isEnabled']);
  await updateAllTabsIconAndColor(storage.isEnabled);
});

// 监听扩展启动
chrome.runtime.onStartup.addListener(async () =&gt; {
  await initProxySettings();
  // 初始化所有标签页的图标和徽章颜色
  const storage = await chrome.storage.local.get(['isEnabled']);
  await updateAllTabsIconAndColor(storage.isEnabled);
});

// 直连模式使用默认图标
const greenIcon = {
  &amp;#34;16&amp;#34;: &amp;#34;icons/icon16.png&amp;#34;,
  &amp;#34;48&amp;#34;: &amp;#34;icons/icon48.png&amp;#34;,
  &amp;#34;128&amp;#34;: &amp;#34;icons/icon128.png&amp;#34;
};

// 代理模式使用默认图标
const redIcon = {
  &amp;#34;16&amp;#34;: &amp;#34;icons/icon16.png&amp;#34;,
  &amp;#34;48&amp;#34;: &amp;#34;icons/icon48.png&amp;#34;,
  &amp;#34;128&amp;#34;: &amp;#34;icons/icon128.png&amp;#34;
};

// 根据连接状态更新标签页图标
async function updateTabIcon(tabId, url) {
  // 获取设置
  const storage = await chrome.storage.local.get(['exceptionUrls', 'isEnabled']);
  
  // 如果扩展未启用，显示默认图标和禁用状态
  if (!storage.isEnabled) {
    chrome.action.setBadgeText({ text: 'DISABLED', tabId: tabId });
    chrome.action.setBadgeBackgroundColor({ color: '#6c757d', tabId: tabId });
    return;
  }
  
  try {
    const urlObj = new URL(url);
    const hostname = urlObj.hostname;
    
    const isException = storage.exceptionUrls.some(proxyUrl =&gt; {
      return hostname === proxyUrl || hostname.endsWith(&amp;#34;.&amp;#34; + proxyUrl);
    });
    
    // 更新徽章文本和颜色
    if (isException) {
      // 代理模式 - 显示VPN徽章和红色背景
      chrome.action.setBadgeText({ text: 'VPN', tabId: tabId });
      chrome.action.setBadgeBackgroundColor({ color: '#dc3545', tabId: tabId });
    } else {
      // 直连模式 - 显示DIRECT徽章和绿色背景
      chrome.action.setBadgeText({ text: 'DIR', tabId: tabId });
      chrome.action.setBadgeBackgroundColor({ color: '#3fc944', tabId: tabId });
    }
  } catch (error) {
    // 对于无法解析的URL，显示直连状态
    chrome.action.setBadgeText({ text: 'DIR', tabId: tabId });
    chrome.action.setBadgeBackgroundColor({ color: '#3fc944', tabId: tabId });
  }
}

// 监听标签页更新
chrome.tabs.onUpdated.addListener(async (tabId, changeInfo, tab) =&gt; {
  if (changeInfo.status === 'complete' &amp;&amp; tab.url) {
    // 更新标签页图标
    await updateTabIcon(tabId, tab.url);
  }
});

// 监听标签页切换
chrome.tabs.onActivated.addListener(async (activeInfo) =&gt; {
  const tab = await new Promise(resolve =&gt; chrome.tabs.get(activeInfo.tabId, resolve));
  if (tab.url) {
    // 更新激活标签页的图标
    await updateTabIcon(activeInfo.tabId, tab.url);
  }
});

// 更新所有标签页的图标和徽章颜色
async function updateAllTabsIconAndColor(isEnabled) {
  const tabs = await new Promise(resolve =&gt; chrome.tabs.query({}, resolve));
  
  for (const tab of tabs) {
    if (tab.url) {
      await updateTabIcon(tab.id, tab.url);
    }
  }
}

// 初始化
initStorage();

// 更新所有标签页的徽章颜色
async function updateAllTabsBadgeColor(isEnabled) {
  const tabs = await new Promise(resolve =&gt; chrome.tabs.query({}, resolve));
  
  if (!isEnabled) {
    // 插件被禁用时，将所有标签页的徽章背景色设为灰色
    tabs.forEach(tab =&gt; {
      chrome.action.setBadgeBackgroundColor({ color: '#808080', tabId: tab.id });
    });
  } else {
    // 插件启用时，根据每个标签页的连接状态设置颜色
    const storage = await chrome.storage.local.get(['exceptionUrls']);
    
    tabs.forEach(tab =&gt; {
      if (tab.url) {
        try {
          const url = new URL(tab.url);
          const hostname = url.hostname;
          
          const isException = storage.exceptionUrls.some(proxyUrl =&gt; {
            return hostname === proxyUrl || hostname.endsWith(&amp;#34;.&amp;#34; + proxyUrl);
          });
          
          if (isException) {
            // 代理模式下设置为红色
            chrome.action.setBadgeBackgroundColor({ color: '#FF0000', tabId: tab.id });
          } else {
            // 直连模式下设置为绿色
            chrome.action.setBadgeBackgroundColor({ color: '#00FF00', tabId: tab.id });
          }
        } catch (e) {
          // 对于无法解析的URL，设置为默认颜色
          chrome.action.setBadgeBackgroundColor({ color: '#00FF00', tabId: tab.id });
        }
      }
    });
  }
}

// 监听消息
chrome.runtime.onMessage.addListener((message, sender, sendResponse) =&gt; {
  switch (message.action) {
    case 'getSettings':
      // 获取设置
      chrome.storage.local.get(['exceptionUrls', 'proxyConfig', 'isEnabled'], (result) =&gt; {
        sendResponse(result);
      });
      return true;
    
    case 'saveSettings':
      // 保存设置
      chrome.storage.local.set(message.data, async () =&gt; {
        const proxyUrls = message.data.exceptionUrls || [];
        console.log('Settings saved:', message.data);
        console.log('Proxy URLs:', proxyUrls);
        await updateRules(proxyUrls);
        await initProxySettings();
        // 更新所有标签页的图标
        await updateAllTabsIconAndColor(message.data.isEnabled !== false);
        sendResponse({ success: true });
      });
      return true;
    
    case 'toggleEnabled':
      // 切换启用状态
      chrome.storage.local.get('isEnabled', async (result) =&gt; {
        const newEnabled = !result.isEnabled;
        await chrome.storage.local.set({ isEnabled: newEnabled });
        await initProxySettings();
        // 更新所有标签页的图标和徽章颜色
        await updateAllTabsIconAndColor(newEnabled);
        sendResponse({ isEnabled: newEnabled });
      });
      return true;
    
    default:
      sendResponse({ error: 'Unknown action' });
      return true;
  }
});

</code></pre>
<h2 data-id="heading-6">结束语</h2>
<p>现在有了trea真的太方便了，做一个浏览器小插件2个小时不到就做出来了，真的是大大节省了我们开发工作量，必须点赞。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Onlyoffice Documentserver Docker 容器化部署指南]]></title>    <link>https://juejin.cn/post/7582104240987357210</link>    <guid>https://juejin.cn/post/7582104240987357210</guid>    <pubDate>2025-12-11T01:46:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582104240987357210" data-draft-id="7582136489769779210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Onlyoffice Documentserver Docker 容器化部署指南"/> <meta itemprop="keywords" content="开源,Docker"/> <meta itemprop="datePublished" content="2025-12-11T01:46:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老赵"/> <meta itemprop="url" content="https://juejin.cn/user/3208848015890347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Onlyoffice Documentserver Docker 容器化部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3208848015890347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老赵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:46:21.000Z" title="Thu Dec 11 2025 01:46:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>DOCUMENTSERVER（镜像名称：onlyoffice/documentserver）是一款功能丰富的容器化在线办公套件，提供文本、电子表格和演示文稿的查看与编辑功能，完全兼容Office Open XML格式（.docx、.xlsx、.pptx），并支持实时协作编辑。作为ONLYOFFICE生态系统的核心组件，DOCUMENTSERVER可独立部署或与Community Server、Mail Server集成，实现文档存储、共享、权限管理等扩展功能。</p>
<p>通过Docker容器化部署DOCUMENTSERVER，能够显著简化安装流程、确保环境一致性，并便于版本管理和升级。本文将详细介绍DOCUMENTSERVER的Docker部署方案，包括环境准备、镜像拉取、容器配置、功能测试及生产环境优化建议。</p>
<h2 data-id="heading-1">环境准备</h2>
<h3 data-id="heading-2">Docker环境安装</h3>
<p>DOCUMENTSERVER基于Docker容器运行，需先确保服务器已安装Docker环境。推荐使用以下一键安装脚本快速部署最新版Docker：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">bash</span> &lt;(wget -qO- <span class="hljs-attribute">https</span>:<span class="hljs-comment">//xuanyuan.cloud/docker.sh)</span>
</code></pre>
<p>脚本执行完成后，可通过<code>docker --version</code>命令验证安装是否成功，建议使用Docker 1.9.0或更高版本以获得最佳兼容性。</p>
<h2 data-id="heading-3">镜像准备</h2>
<h3 data-id="heading-4">拉取DOCUMENTSERVER镜像</h3>
<p>使用以下命令通过轩辕镜像加速地址拉取最新版本的DOCUMENTSERVER镜像：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker pull xxx.xuanyuan.run/onlyoffice/documentserver:latest
</code></pre>
<p>拉取完成后，可通过<code>docker images</code>命令验证镜像是否成功下载：</p>
<pre><code class="hljs language-bash" lang="bash">docker images | grep onlyoffice/documentserver
</code></pre>
<p>若输出类似以下信息，说明镜像拉取成功：</p>
<pre><code class="hljs language-xml" lang="xml">xxx.xuanyuan.run/onlyoffice/documentserver   latest    <span class="hljs-tag">&lt;<span class="hljs-name">镜像ID</span>&gt;</span>   <span class="hljs-tag">&lt;<span class="hljs-name">创建时间</span>&gt;</span>   <span class="hljs-tag">&lt;<span class="hljs-name">大小</span>&gt;</span>
</code></pre>
<h2 data-id="heading-5">容器部署</h2>
<h3 data-id="heading-6">基础部署</h3>
<p>执行以下命令启动基础版DOCUMENTSERVER容器，映射容器80端口至主机80端口：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d \  --name documentserver \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  xxx.xuanyuan.run/onlyoffice/documentserver:latest
</code></pre>
<ul>
<li>• <code>-d</code>：后台运行容器</li>
<li>• <code>--name documentserver</code>：指定容器名称为documentserver，便于后续管理</li>
<li>• <code>-p 80:80</code>：将主机80端口映射至容器80端口（容器内Web服务默认端口）</li>
</ul>
<h3 data-id="heading-7">数据持久化部署</h3>
<p>为避免容器重启或升级导致数据丢失，建议挂载主机目录至容器数据卷，持久化存储日志和证书等关键数据：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"> # </span><span class="bash">创建本地数据目录<span class="hljs-built_in">mkdir</span> -p /app/onlyoffice/DocumentServer/logs /app/onlyoffice/DocumentServer/data<span class="hljs-comment"># 启动容器并挂载数据卷docker run -d \  --name documentserver \  -p 80:80 \  -v /app/onlyoffice/DocumentServer/logs:/var/log/onlyoffice \  -v /app/onlyoffice/DocumentServer/data:/var/www/onlyoffice/Data \  xxx.xuanyuan.run/onlyoffice/documentserver:latest</span></span>
</code></pre>
<ul>
<li>• <code>/var/log/onlyoffice</code>：容器内DOCUMENTSERVER日志存储路径</li>
<li>• <code>/var/www/onlyoffice/Data</code>：容器内证书及配置数据存储路径</li>
</ul>
<h3 data-id="heading-8">自定义端口部署</h3>
<p>若主机80端口已被占用，可通过<code>-p</code>参数指定自定义端口，例如使用8080端口对外提供服务：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \  --name documentserver \  -p 8080:80 \  -v /app/onlyoffice/DocumentServer/logs:/var/log/onlyoffice \  -v /app/onlyoffice/DocumentServer/data:/var/www/onlyoffice/Data \  xxx.xuanyuan.run/onlyoffice/documentserver:latest
</code></pre>
<h3 data-id="heading-9">HTTPS安全部署</h3>
<p>为提升服务安全性，建议配置HTTPS加密访问。需先准备SSL证书（CA签发或自签名），然后通过数据卷挂载证书文件并映射443端口：</p>
<h4 data-id="heading-10">1. 生成自签名证书（若无可信任CA证书）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"># 创建证书目录mkdir -p /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs# 生成私钥openssl genrsa -<span class="hljs-keyword">out</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.key <span class="hljs-number">2048</span># 生成证书签名请求（CSR）openssl req -new -key /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.key -<span class="hljs-keyword">out</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.csr# 生成自签名证书（有效期<span class="hljs-number">365</span>天）openssl x509 -req -days <span class="hljs-number">365</span> -<span class="hljs-keyword">in</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.csr -signkey /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.key -<span class="hljs-keyword">out</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.crt# 生成DH参数（增强安全性）openssl dhparam -<span class="hljs-keyword">out</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/dhparam.pem <span class="hljs-number">2048</span># 设置证书权限（仅所有者可读）chmod <span class="hljs-number">400</span> /app/onlyoffice/DocumentServer/<span class="hljs-keyword">data</span>/certs/onlyoffice.key
</code></pre>
<h4 data-id="heading-11">2. 启动HTTPS服务</h4>
<pre><code class="hljs language-bash" lang="bash"> docker run -d \  --name documentserver \  -p 443:443 \  -v /app/onlyoffice/DocumentServer/logs:/var/log/onlyoffice \  -v /app/onlyoffice/DocumentServer/data:/var/www/onlyoffice/Data \  xxx.xuanyuan.run/onlyoffice/documentserver:latest
</code></pre>
<h3 data-id="heading-12">集成社区版部署（含Community Server和Mail Server）</h3>
<p>DOCUMENTSERVER可与ONLYOFFICE Community Server、Mail Server组成完整社区版套件，提供文档管理、邮件服务等综合功能。部署步骤如下：</p>
<h4 data-id="heading-13">1. 创建专用网络</h4>
<pre><code class="hljs language-lua" lang="lua">docker network <span class="hljs-built_in">create</span> <span class="hljs-comment">--driver bridge onlyoffice</span>
</code></pre>
<h4 data-id="heading-14">2. 部署DOCUMENTSERVER</h4>
<pre><code class="hljs language-ini" lang="ini">docker run -d \  --net onlyoffice \  --name onlyoffice-document-server \  <span class="hljs-attr">--restart</span>=always \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/logs:/var/log/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/data:/var/www/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/Data \  xxx.xuanyuan.run/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/documentserver:latest
</code></pre>
<h4 data-id="heading-15">3. 部署Mail Server（替换yourdomain.com为实际域名）</h4>
<pre><code class="hljs language-bash" lang="bash">docker run -d \  --net onlyoffice \  --name onlyoffice-mail-server \  --restart=always \  --privileged \  -p 25:25 -p 143:143 -p 587:587 \  -v /app/onlyoffice/MailServer/data:/var/vmail \  -v /app/onlyoffice/MailServer/data/certs:/etc/pki/tls/mailserver \  -v /app/onlyoffice/MailServer/logs:/var/log \  -v /app/onlyoffice/MailServer/mysql:/var/lib/mysql \  -h yourdomain.com \  onlyoffice/mailserver
</code></pre>
<h4 data-id="heading-16">4. 部署Community Server</h4>
<pre><code class="hljs language-ini" lang="ini">docker run -d \  --net onlyoffice \  --name onlyoffice-community-server \  <span class="hljs-attr">--restart</span>=always \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> -p <span class="hljs-number">5222</span>:<span class="hljs-number">5222</span> \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/CommunityServer/data:/var/www/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/Data \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/CommunityServer/mysql:/var/lib/mysql \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/CommunityServer/logs:/var/log/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/data:/var/www/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServerData \  -e DOCUMENT_SERVER_PORT_80_TCP_ADDR=<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice-document-server \  -e MAIL_SERVER_DB_HOST=<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice-mail-server \  <span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/communityserver
</code></pre>
<h2 data-id="heading-17">功能测试</h2>
<h3 data-id="heading-18">服务可用性测试</h3>
<p>容器启动后，等待约1-2分钟（首次启动需初始化服务），通过以下方式验证服务是否正常运行：</p>
<h4 data-id="heading-19">1. 访问Web界面</h4>
<p>在浏览器中访问<code>http://&lt;服务器IP&gt;</code>（基础部署）或<code>https://&lt;服务器IP&gt;</code>（HTTPS部署），若能看到DOCUMENTSERVER欢迎页面或编辑器界面，说明Web服务正常。</p>
<h4 data-id="heading-20">2. 命令行访问测试</h4>
<p>使用<code>curl</code>命令测试服务响应：</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -I http:<span class="hljs-comment">//&lt;服务器IP&gt;</span>
</code></pre>
<p>若返回<code>200 OK</code>状态码，说明服务正常响应：</p>
<pre><code class="hljs language-arduino" lang="arduino">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OKServer: nginxDate: &lt;当前时间&gt;Content-Type: text/html; charset=utf<span class="hljs-number">-8.</span>..
</code></pre>
<h3 data-id="heading-21">日志验证</h3>
<p>通过容器日志确认服务启动状态：</p>
<pre><code class="hljs">docker logs documentserver
</code></pre>
<p>若日志中出现类似以下信息，说明服务初始化完成并正常运行：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">onlyoffice-documentserver: started</span>
</code></pre>
<h3 data-id="heading-22">文档编辑测试</h3>
<p>在Web界面中创建或上传测试文档（如.docx、.xlsx文件），尝试进行编辑、保存操作，验证文档处理功能是否正常。</p>
<h2 data-id="heading-23">生产环境建议</h2>
<h3 data-id="heading-24">系统资源配置</h3>
<p>根据官方推荐，生产环境服务器应满足以下最低配置：</p>
<ul>
<li>• <strong>RAM</strong>：4 GB或更高（多用户并发编辑时建议8 GB以上）</li>
<li>• <strong>CPU</strong>：双核2 GHz或更高处理器（多用户场景建议4核及以上）</li>
<li>• <strong>Swap</strong>：至少2 GB（避免内存不足导致服务异常）</li>
<li>• <strong>HDD</strong>：至少2 GB空闲空间（根据文档存储需求增加）</li>
<li>• <strong>操作系统</strong>：64位Linux发行版（如Ubuntu、Debian、CentOS），内核版本3.8及以上</li>
</ul>
<h3 data-id="heading-25">安全加固</h3>
<ol>
<li>1. <strong>启用HTTPS</strong>：生产环境必须配置SSL/TLS加密，避免明文传输敏感数据</li>
<li>2. <strong>权限控制</strong>：限制主机挂载目录权限，例如设置<code>/app/onlyoffice</code>目录权限为<code>700</code></li>
<li>3. <strong>防火墙配置</strong>：仅开放必要端口（如80/443），通过<code>ufw</code>或<code>iptables</code>限制访问来源</li>
<li>4. <strong>定期更新</strong>：关注 轩辕镜像标签列表 <code>https://xuanyuan.cloud/r/onlyoffice/documentserver/tags</code> ，及时更新镜像以修复安全漏洞</li>
</ol>
<h3 data-id="heading-26">性能优化</h3>
<ol>
<li>
<p>1. <strong>资源限制</strong>：使用<code>--memory</code>和<code>--cpus</code>参数限制容器资源占用，避免影响其他服务：</p>
<pre><code class="hljs language-ini" lang="ini">docker run -d \  --name documentserver \  <span class="hljs-attr">--memory</span>=<span class="hljs-number">4</span>g \  --cpus=<span class="hljs-number">2</span> \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/logs:/var/log/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/data:/var/www/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/Data \  xxx.xuanyuan.run/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/documentserver:latest
</code></pre>
</li>
<li>
<p>2. <strong>日志轮转</strong>：配置日志轮转策略，避免日志文件过大占用磁盘空间，可通过<code>logrotate</code>工具管理<code>/app/onlyoffice/DocumentServer/logs</code>目录日志。</p>
</li>
<li>
<p>3. <strong>缓存优化</strong>：对于静态资源（如JS、CSS文件），可配置Nginx反向代理实现浏览器缓存，减少重复请求。</p>
</li>
</ol>
<h3 data-id="heading-27">高可用方案</h3>
<ol>
<li>
<p>1. <strong>容器自动重启</strong>：添加<code>--restart=always</code>参数，确保服务异常退出后自动恢复：</p>
<pre><code class="hljs language-ini" lang="ini">docker run -d \  --name documentserver \  <span class="hljs-attr">--restart</span>=always \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/logs:/var/log/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice \  -v /app/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/DocumentServer/data:/var/www/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/Data \  xxx.xuanyuan.run/<span class="hljs-literal">on</span>ly<span class="hljs-literal">off</span>ice/documentserver:latest
</code></pre>
</li>
<li>
<p>2. <strong>数据备份</strong>：定期备份<code>/app/onlyoffice/DocumentServer/data</code>目录，可使用<code>rsync</code>或脚本自动化备份：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">示例：每日凌晨2点备份数据<span class="hljs-built_in">echo</span> &amp;<span class="hljs-comment">#34;0 2 * * * tar -zcvf /backup/onlyoffice_data_$(date +\%Y\%m\%d).tar.gz /app/onlyoffice/DocumentServer/data&amp;#34; &gt;&gt; /etc/crontab</span></span>
</code></pre>
</li>
<li>
<p>3. <strong>集群部署</strong>：对于高并发场景，可部署多实例DOCUMENTSERVER，结合负载均衡器（如Nginx、HAProxy）实现流量分发和故障转移。</p>
</li>
</ol>
<h2 data-id="heading-28">故障排查</h2>
<h3 data-id="heading-29">服务无法启动</h3>
<ol>
<li>
<p>1. <strong>端口冲突</strong>：检查主机端口是否被占用，使用<code>netstat</code>命令排查：</p>
<pre><code class="hljs language-perl" lang="perl">netstat -tulpn | <span class="hljs-keyword">grep</span> <span class="hljs-number">80</span>  <span class="hljs-comment"># 替换80为实际使用的端口</span>
</code></pre>
<p>若端口已被占用，需停止占用进程或更换映射端口。</p>
</li>
<li>
<p>2. <strong>目录权限问题</strong>：确保主机挂载目录权限正确，避免容器内进程无权限读写：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> -R 777 /app/onlyoffice/DocumentServer  <span class="hljs-comment"># 临时测试权限问题，生产环境需遵循最小权限原则</span>
</code></pre>
</li>
<li>
<p>3. <strong>SELinux限制</strong>：RHEL/CentOS等系统若启用SELinux，可能阻止容器进程访问主机目录，可临时禁用SELinux测试：</p>
<pre><code class="hljs">setenforce 0
</code></pre>
<p>若问题解决，可永久调整SELinux策略或切换至Ubuntu等发行版。</p>
</li>
</ol>
<h3 data-id="heading-30">文档编辑异常</h3>
<ol>
<li>
<p>1. <strong>内存不足</strong>：查看系统内存使用情况，若内存使用率过高，需增加服务器内存或优化资源配置：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-built_in">free</span> -m
</code></pre>
</li>
<li>
<p>2. <strong>网络问题</strong>：检查客户端与服务器之间的网络连接，确保WebSocket通信正常（DOCUMENTSERVER依赖WebSocket实现实时协作）。</p>
</li>
<li>
<p>3. <strong>日志分析</strong>：查看容器详细日志定位问题：</p>
<pre><code class="hljs language-bash" lang="bash">docker logs -f documentserver  <span class="hljs-comment"># -f参数实时跟踪日志输出</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-31">Docker版本问题</h3>
<p>DOCUMENTSERVER对Docker版本有依赖，建议使用最新稳定版Docker。若使用旧版本Docker出现异常，可通过以下命令升级Docker：</p>
<pre><code class="hljs language-bash" lang="bash">bash &lt;(wget -qO- https://xuanyuan.cloud/docker.sh)  <span class="hljs-comment"># 重新执行一键安装脚本升级Docker</span>
</code></pre>
<h2 data-id="heading-32">参考资源</h2>
<ul>
<li>• DOCUMENTSERVER镜像文档（轩辕） <code>https://xuanyuan.cloud/r/onlyoffice/documentserver</code></li>
<li>• DOCUMENTSERVER镜像标签列表 <code>https://xuanyuan.cloud/r/onlyoffice/documentserver/tags</code></li>
<li>• Docker官方文档 <code>https://docs.docker.com</code></li>
<li>• ONLYOFFICE Document Server GitHub仓库 <code>https://github.com/ONLYOFFICE/DocumentServer</code></li>
<li>• SSL证书配置指南 <code>https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</code></li>
</ul>
<h2 data-id="heading-33">总结</h2>
<p>本文详细介绍了DOCUMENTSERVER的Docker容器化部署方案，包括环境准备、镜像拉取、基础与持久化部署、HTTPS配置、集成社区版部署等多种场景，并提供了生产环境优化建议和故障排查方法。通过容器化部署，可快速搭建功能完善的在线办公协作平台，满足文档编辑、共享和协作需求。</p>
<p><strong>关键要点</strong>：</p>
<ul>
<li>• 使用轩辕镜像加速可提升DOCUMENTSERVER镜像拉取速度，优化部署效率</li>
<li>• 数据持久化部署需挂载日志和证书目录，避免容器升级导致数据丢失</li>
<li>• 生产环境必须配置HTTPS加密，并根据用户规模调整服务器资源配置</li>
<li>• 定期备份数据和更新镜像可提高系统安全性和稳定性</li>
</ul>
<p><strong>后续建议</strong>：</p>
<ul>
<li>• 深入学习DOCUMENTSERVER高级特性，如API集成、多语言支持等功能</li>
<li>• 根据实际业务需求，配置负载均衡和集群方案，提升服务可用性</li>
<li>• 关注官方文档和社区动态，及时了解新功能和安全更新</li>
<li>• 结合监控工具（如Prometheus、Grafana）实现服务状态实时监控，提前发现潜在问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙应用开发笔记：签名文件]]></title>    <link>https://juejin.cn/post/7582118538561339411</link>    <guid>https://juejin.cn/post/7582118538561339411</guid>    <pubDate>2025-12-11T01:24:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118538561339411" data-draft-id="7582102297481461802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙应用开发笔记：签名文件"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-11T01:24:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="0x04"/> <meta itemprop="url" content="https://juejin.cn/user/4233576783285866"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙应用开发笔记：签名文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576783285866/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    0x04
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:24:01.000Z" title="Thu Dec 11 2025 01:24:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>关于 HarmonyOS 项目中签名文件的管理，以下是关键点说明：</p>
<hr/>
<p><strong>一、文件与项目的关联性</strong></p>
<ol>
<li>
<p><strong>核心文件的作用与归属</strong></p>
<ul>
<li><strong>.p12（密钥文件）</strong>：存储非对称加密的公钥和私钥，属于开发者自主生成的 <strong>通用文件</strong>，可跨项目复用（如搜索结果2、5所述）。</li>
<li><strong>.csr（证书请求文件）</strong>：用于向华为申请调试/发布证书，可跨项目共用（需确保密钥别名和密码一致）。</li>
<li><strong>.cer（证书文件）</strong>：由华为颁发，分为调试和发布证书12。 <strong>调试证书不可跨项目</strong>，发布证书可跨应用复用但需符合条件（如搜索结果2中的FAQ）。</li>
<li><strong>.p7b（Profile文件）</strong>：绑定具体项目的包名和权限， <strong>必须每个项目单独生成</strong>（如搜索结果4、5所述）。</li>
</ul>
</li>
<li>
<p><strong>项目独立性要求</strong></p>






























<table><thead><tr><th>文件类型</th><th>是否可跨项目共用</th><th>说明</th></tr></thead><tbody><tr><td>.p12</td><td>✅ 是</td><td>需统一密钥别名和密码</td></tr><tr><td>.csr</td><td>✅ 是</td><td>需基于相同密钥生成</td></tr><tr><td>.cer（发布）</td><td>✅ 是（有条件）</td><td>同一开发者账号下应用可复用</td></tr><tr><td>.p7b</td><td>❌ 否</td><td>必须每个项目单独申请</td></tr></tbody></table>
</li>
</ol>
<hr/>
<p><strong>二、文件存储管理建议</strong></p>
<ol>
<li>
<p><strong>工程目录存放规范</strong></p>
<ul>
<li><strong>推荐方式</strong>：在项目根目录创建 <code>signing/</code> 文件夹存放所有签名文件（如搜索结果8、10所述），例如：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ProjectRoot/
├── signing/
│   ├── debug.p12      <span class="hljs-comment"># 调试密钥</span>
│   ├── release.p12    <span class="hljs-comment"># 发布密钥</span>
│   ├── app.cer        <span class="hljs-comment"># 发布证书</span>
│   └── app.p7b        <span class="hljs-comment"># Profile文件</span>
└── ...
</code></pre>
<ul>
<li><strong>路径引用</strong>：在 <code>build-profile.json5</code> 中配置相对路径（如 <code>../signing/release.p12</code>），避免绝对路径问题。</li>
</ul>
</li>
<li>
<p><strong>安全注意事项</strong></p>
<ul>
<li><strong>敏感文件隔离</strong>：<code>.p12</code> 文件包含私钥，需严格保密，禁止上传至代码仓库（需配置 <code>.gitignore</code>）。</li>
<li><strong>密码加密</strong>：在配置文件中使用 DevEco Studio 的加密功能（如 <code>encrypted:xxxx</code> 格式），避免明文存储密码（搜索结果10中提到）。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-0">三、协作与版本控制策略</h3>
<ol>
<li>
<p><strong>团队协作场景</strong></p>
<ul>
<li>共享 <code>.p12</code> 和 <code>.csr</code> 文件给团队成员，确保签名一致性（搜索结果8中的多人协作建议）。</li>
<li><strong>Profile 文件独立</strong>：每个开发者需根据自身设备申请独立的调试 Profile（搜索结果4中的调试设备列表要求）。</li>
</ul>
</li>
<li>
<p><strong>发布场景操作</strong></p>
<ul>
<li>使用统一的发布证书和 Profile，确保应用更新时签名一致性（搜索结果2中强调证书删除对在架版本无影响，但更新必须一致）。</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>四、跨项目复用示例</strong>
若需在多个项目中共用签名资源：</p>
<ol>
<li>创建公共签名目录（如 <code>CommonSign/</code>），存放可复用的 <code>.p12</code> 和 <code>.cer</code> 文件。</li>
<li>各项目通过相对路径引用公共目录中的文件：
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// build-profile.json5</span>
signingConfigs<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  release<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    storeFile<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;../CommonSign/release.p12&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
    profileFile<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;signing/app.p7b&amp;#<span class="hljs-number">34</span>;  <span class="hljs-comment">// 每个项目独有</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<hr/>
<p>通过合理规划文件存储和引用方式，既能实现资源复用，又能确保项目签名的独立性与安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么mysql varchar 类型一般都设置为64/128/256/512 ？]]></title>    <link>https://juejin.cn/post/7582066556089040959</link>    <guid>https://juejin.cn/post/7582066556089040959</guid>    <pubDate>2025-12-11T01:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582066556089040959" data-draft-id="7581669438576099364" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么mysql varchar 类型一般都设置为64/128/256/512 ？"/> <meta itemprop="keywords" content="架构,后端"/> <meta itemprop="datePublished" content="2025-12-11T01:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李拾叁的摸鱼日常"/> <meta itemprop="url" content="https://juejin.cn/user/4443539294129722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么mysql varchar 类型一般都设置为64/128/256/512 ？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443539294129722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李拾叁的摸鱼日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:24:07.000Z" title="Thu Dec 11 2025 01:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MySQL 中 varchar 频繁设置为 64、128、256、512 这类 2 的幂次值，绝非单纯的 “行业习惯”，而是<strong>底层存储机制、数据库性能优化、业务通用性、字符集适配</strong> 等多维度的 “最优解”—— 这些数值精准贴合 MySQL 的存储设计逻辑，同时兼顾业务灵活性与性能稳定性，是长期实践中沉淀的深层规律。</p>
<p>以下从 <strong>4 个核心深层维度</strong> 拆解原因，从底层存储到上层业务逻辑层层递进：</p>
<h2 data-id="heading-0">一、核心底层：贴合 varchar 的存储结构与二进制对齐规则</h2>
<p>这是最根本的原因，varchar 的存储物理结构和计算机底层的二进制特性，决定了 2 的幂次长度（64=2⁶、128=2⁷、256=2⁸、512=2⁹）是最优选择。</p>
<h3 data-id="heading-1">1. varchar 长度前缀的临界值适配</h3>
<p>varchar 是<strong>变长字符串类型</strong>，物理存储由两部分组成：长度前缀（Length Prefix） + 实际字符数据。长度前缀的字节数由定义的长度决定，直接影响存储效率：</p>























<table><thead><tr><th>varchar 定义长度</th><th>长度前缀字节数</th><th>可表示的最大字符数</th><th>对应常用值</th></tr></thead><tbody><tr><td>≤ 255</td><td>1 字节（0-255）</td><td>255</td><td>64、128（均≤255）</td></tr><tr><td>&gt; 255</td><td>2 字节（0-65535）</td><td>65535（行长度限制）</td><td>256、512（&gt;255）</td></tr></tbody></table>
<h4 data-id="heading-2">关键逻辑：</h4>
<ul>
<li>
<p>64、128 属于「1 字节前缀区间」：用最少的前缀字节（1 字节）覆盖绝大部分短文本场景，无前缀字节浪费；</p>
</li>
<li>
<p>256 是「1 字节→2 字节」的临界值：刚好超过 255，是中等文本的 “天然阈值”，2 字节前缀能覆盖到 65535，足够支撑 512 甚至更大的长度；</p>
</li>
<li>
<p>若选择非 2 次幂值（如 100、200），虽也能适配前缀规则，但 64/128 等数值是 “前缀区间内的最优分割点”—— 既不浪费前缀，又能最大化单前缀字节的覆盖范围。</p>
</li>
</ul>
<h3 data-id="heading-3">2. 二进制对齐：适配计算机底层的存储 / 读取逻辑</h3>
<p>计算机的<strong>内存页、磁盘块、CPU 缓存行、InnoDB 页</strong> 等核心存储单元，均以 2 的幂次为基本单位（如缓存行 64/128 字节、InnoDB 页 16KB=2¹⁴ 字节）。varchar 长度设为 2 的幂次，能实现：</p>
<ul>
<li>
<p><strong>减少数据碎片</strong>：比如存储 varchar(128) 字段时，数据块分配会贴合缓存行 / 磁盘块的 128 字节单位，避免跨块存储导致的碎片；</p>
</li>
<li>
<p><strong>提升读取效率</strong>：CPU 读取数据时按缓存行加载，varchar(64) 的数据能一次性加载到 64 字节缓存行中，无需拆分读取，减少 IO 次数；</p>
</li>
<li>
<p><strong>简化内存计算</strong>：数据库优化器计算内存占用（如排序、临时表）时，2 的幂次长度的乘法 / 除法更高效（如 128×4=512、256×4=1024），避免非幂次的复杂计算（如 100×4=400）。</p>
</li>
</ul>
<h2 data-id="heading-4">二、性能维度：适配 MySQL 优化器与索引设计</h2>
<p>MySQL 优化器的行为、索引的存储规则，对 2 的幂次长度的 varchar 更友好，能直接提升查询性能。</p>
<h3 data-id="heading-5">1. 优化器的内存预估效率</h3>
<p>MySQL 优化器在执行排序、分组、连接查询时，会根据 varchar 定义的长度<strong>预估临时表 / 排序缓冲区的大小</strong>：</p>
<ul>
<li>
<p>若设为 64/128/256 等 2 的幂次，优化器能快速计算 “最坏情况” 的内存占用（如 varchar(128) 在 utf8mb4 下最大占用 128×4+1=513 字节），精准分配内存，避免因预估偏差导致 “内存临时表溢出到磁盘”（磁盘临时表性能比内存低 10 倍以上）；</p>
</li>
<li>
<p>若设为非幂次值（如 150），优化器需计算 150×4=600 字节，虽也能计算，但幂次值的预估逻辑更简单，且不易出现 “四舍五入导致的内存浪费”。</p>
</li>
</ul>
<h3 data-id="heading-6">2. 索引长度的适配</h3>
<p>InnoDB 对索引前缀长度有默认限制（默认 767 字节，可调整为 3072 字节），这一限制与字符集（utf8mb4 占 4 字节 / 字符）结合后，2 的幂次长度的 varchar 更适配索引设计：</p>
<ul>
<li>
<p>varchar(128)：utf8mb4 下最大占用 128×4=512 字节，远低于 767 字节，可直接作为索引前缀，无需截断；</p>
</li>
<li>
<p>varchar(256)：utf8mb4 下最大占用 256×4=1024 字节，仅需调整 innodb_large_prefix=ON 即可支持，是 “中等长度索引” 的最优值；</p>
</li>
<li>
<p>若设为 200（非幂次），utf8mb4 下 200×4=800 字节，超过默认 767 字节，需截断或调整配置，不如 128/256 灵活。</p>
</li>
</ul>
<h2 data-id="heading-7">三、业务维度：通用阈值覆盖 90% 场景，降低维护成本</h2>
<p>64、128、256、512 是经过大量业务验证的 “通用安全阈值”，既避免长度不足导致的频繁扩容，又避免长度过长导致的性能损耗。</p>
<h3 data-id="heading-8">1. 覆盖绝大部分短文本场景</h3>
<p>不同长度的 2 次幂值，精准匹配不同业务场景的文本长度需求，且留有足够冗余：</p>



































<table><thead><tr><th>长度值</th><th>字节占用（utf8mb4）</th><th>典型业务场景</th><th>冗余设计的价值</th></tr></thead><tbody><tr><td>64</td><td>64×4+1=257 字节</td><td>手机号、邮箱、SKU、短编码、验证码</td><td>避免因业务调整（如手机号加扩展位、邮箱加长）频繁执行 ALTER TABLE（锁表影响性能）</td></tr><tr><td>128</td><td>128×4+1=513 字节</td><td>用户名、短备注、标签、接口参数</td><td>兼容特殊字符（如 emoji），无需精准计算字符数</td></tr><tr><td>256</td><td>256×4+2=1026 字节</td><td>收货地址、商品副标题、简单描述</td><td>覆盖 99% 的中等文本需求，远低于行长度上限</td></tr><tr><td>512</td><td>512×4+2=2050 字节</td><td>详细备注、短 JSON 串、富文本摘要</td><td>适配结构化数据存储（如 JSON 串），无需升级到 text 类型</td></tr></tbody></table>
<h3 data-id="heading-9">2. 统一团队规范，降低沟通 / 维护成本</h3>
<p>若每个字段都按 “精确长度” 设置（如用户名 20、手机号 11），虽更省空间，但会导致：</p>
<ul>
<li>
<p>表结构混乱：不同开发者设置的长度无规律，新人接手需逐一确认合理性；</p>
</li>
<li>
<p>扩容风险：一旦业务调整（如用户名允许加长），需逐个修改字段长度；</p>
</li>
</ul>
<p>64/128/256/512 是行业通用的 “标准阈值”，团队可约定：</p>
<ul>
<li>超短文本→64、短文本→128、中等文本→256、较长文本→512；</li>
<li>超过 512 再考虑 text 或 varchar(1024)；</li>
</ul>
<p>这种规范能减少沟通成本，避免表结构设计的混乱。</p>
<h2 data-id="heading-10">四、字符集适配：兼容 utf8mb4 等多字节字符集</h2>
<p>现代 MySQL 普遍使用 utf8mb4 字符集（支持 emoji、生僻字），每个字符占 1-4 字节，2 的幂次长度的 varchar 能更直观地计算 “最坏情况” 的字节占用，避免触发行长度限制：</p>
<ul>
<li>MySQL 行长度上限为 65535 字节（所有列的字节总和）；</li>
<li>varchar(64)：最坏占用 64×4+1=257 字节；</li>
<li>varchar(128)：最坏占用 128×4+1=513 字节；</li>
<li>varchar(256)：最坏占用 256×4+2=1026 字节；</li>
<li>varchar(512)：最坏占用 512×4+2=2050 字节；</li>
</ul>
<p>这些数值均远低于 65535 字节，即使一行有多个此类字段（如 10 个 varchar(512)），总长度也仅 2050×10=20500 字节，完全避免 “行溢出”（行溢出会导致数据存入溢出页，增加 IO 次数）。</p>
<p>若设为非幂次值（如 300），虽也安全，但 512 这类值能让 DBA / 开发人员 “一眼算出最坏字节数”，无需复杂计算，降低出错概率。</p>
<h2 data-id="heading-11">五、澄清：并非 “必须”，而是 “通用最优解”</h2>
<p>64/128/256/512 是<strong>通用最优解</strong>，而非强制规则：</p>
<ul>
<li>
<p>若业务明确字段长度（如手机号 11、身份证 18），应设为精确值（varchar(11)），避免冗余（虽 varchar 是变长，但精确长度能让优化器更精准预估内存）；</p>
</li>
<li>
<p>若字段长度不确定（如用户备注），用这些值作为 “兜底值”，兼顾灵活性和性能；</p>
</li>
<li>
<p>若文本超过 512 字符，建议用 text 或 varchar(1024)，而非继续叠加 512。</p>
</li>
</ul>
<h2 data-id="heading-12">总结：深层逻辑的核心</h2>
<p>varchar 设为 64、128、256、512 的根本原因，是 “底层存储规则” 与 “上层业务需求” 的精准匹配：</p>
<ol>
<li>
<p>贴合 varchar 的长度前缀存储机制，用最少的前缀字节覆盖最大的字符范围；</p>
</li>
<li>
<p>适配计算机二进制存储的对齐规则，提升存储 / 读取效率；</p>
</li>
<li>
<p>适配 MySQL 优化器和索引设计，避免性能损耗；</p>
</li>
<li>
<p>覆盖 90% 的短文本业务场景，统一规范降低维护成本；</p>
</li>
<li>
<p>兼容 utf8mb4 字符集，避免行溢出风险。</p>
</li>
</ol>
<p>这些数值是 “折中最优解”—— 既不浪费存储，又不牺牲性能，还能适配绝大部分业务场景，因此成为行业通用的标准做法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web3 学习：Solidity中的结构体、数组和映射]]></title>    <link>https://juejin.cn/post/7582118218648485914</link>    <guid>https://juejin.cn/post/7582118218648485914</guid>    <pubDate>2025-12-11T02:41:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118218648485914" data-draft-id="7582090790182764582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web3 学习：Solidity中的结构体、数组和映射"/> <meta itemprop="keywords" content="编程语言"/> <meta itemprop="datePublished" content="2025-12-11T02:41:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大腾鱼"/> <meta itemprop="url" content="https://juejin.cn/user/4144486968228746"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web3 学习：Solidity中的结构体、数组和映射
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4144486968228746/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大腾鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:41:05.000Z" title="Thu Dec 11 2025 02:41:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天跟着github上的一个开源教学项目学习了一晚，又通过视频课讲解，对solidity语言中的数据类型和存储类型有了一个基本的认知。</p>
<p>今天的文章主要探讨总结三个核心概念：<strong>Struct</strong>、<strong>Array</strong>、<strong>Mapping</strong>，这是我学习到目前觉得比较难理解的概念。</p>
<hr/>
<h2 data-id="heading-0">1. 前两天的收获</h2>
<ol>
<li><strong>跑通链路</strong>：创建钱包、连测试网、领测试币、部署合约、上链交易，全程验证成功。</li>
<li><strong>吃透简单合约</strong>：写了个 “set 存数字、get 读数字” 的极简合约，搞懂了状态变量（链上长期存）、view 函数（纯查询不花钱）、Gas（写操作要付费）这些基础逻辑。</li>
</ol>
<blockquote>
<p><strong>第三天</strong>：数据类型的学习比较轻松，虽然内容多但是都比较好理解，存储类型（storage/memory）先留个印象，虽然概念简单但是感觉底层逻辑需要进一步理解，之后再讨论。</p>
</blockquote>
<h2 data-id="heading-1">2. Struct（结构体）</h2>
<p>Solidity中有很多的数据类型，大多数还比较好理解，但是真实业务中，如果只用基本类型，会很散乱</p>
<p><strong>Struct</strong> 的作用：把一条记录的多个字段绑在一起，给它起一个类型名字。</p>
<pre><code class="hljs language-solidity" lang="solidity">struct Message {
    address sender;    // 发送者地址
    string content;    // 留言内容
    uint256 timestamp; // 发送时间
}
</code></pre>
<p>它有的类似一个数据模板 —— 不管是订单、仓位还是报价，先把 “一条记录该有哪些信息” 定义清楚，后面写代码逻辑会顺很多。</p>
<blockquote>
<p><strong>心得</strong>：结构体本质上就像 Excel 里的一行。</p>
</blockquote>
<h2 data-id="heading-2">3. Array（数组）</h2>
<p>Struct是单条记录的模板，那么自然要解决存一批记录的问题 。</p>
<p><strong>Array（数组）</strong> 的定位是有序集合。比如用刚才的 <code>Message</code> 模板，定义一个数组：</p>
<pre><code class="hljs language-solidity" lang="solidity">Message[] public messages;
</code></pre>
<p>这就成了一个留言时间线，新留言直接往后面加，想查第几条，按编号就能找到。</p>
<p>现阶段不用深究复杂操作，记住三个核心就够：</p>
<ol>
<li><strong>按顺序追加</strong>：用 <code>push</code> 把新记录加到数组末尾。</li>
<li><strong>按下标访问</strong>：通过索引（比如 <code>messages[0]</code>）读某一条。</li>
<li><strong>别在链上大规模遍历</strong>：遍历数组超费 Gas，复杂查询尽量放链下做。</li>
</ol>
<blockquote>
<p><strong>心得</strong>：Struct 定义<strong>单条记录长什么样</strong>，Array<strong>负责把一批记录按顺序排好</strong>。</p>
</blockquote>
<h2 data-id="heading-3">4. Mapping（映射）</h2>
<p>数组适合 “按顺序存、按编号查”，但很多场景其实是 “按关键词查状态”：</p>
<ul>
<li>某个地址的余额是多少？</li>
<li>某 Token 现在属于谁？</li>
<li>某个用户发了多少条留言？</li>
</ul>
<p>这时候 <strong>Mapping（映射）</strong> 就比数组好用多了，它像个 “键值对字典”，直接按 Key 查 Value，不用翻来翻去：</p>
<pre><code class="hljs language-solidity" lang="solidity">mapping(address =&gt; uint256) public balance;     // 地址 → 余额
mapping(uint256 =&gt; address) public tokenOwner;  // TokenId → 持有者
mapping(address =&gt; bool) public isWhitelisted;  // 地址 → 是否在白名单
</code></pre>
<p>Mapping 的关键特征用：</p>
<ol>
<li><strong>查得快</strong>：按 Key 直接定位，不用遍历。</li>
<li><strong>有默认值</strong>：没赋值的 Key，读出来是类型默认值（数字 0、布尔 false）。</li>
<li><strong>不能直接遍历</strong>：想拿所有 Key 的列表，得配合数组一起设计。</li>
</ol>
<blockquote>
<p><strong>心得</strong>：mapping是这三个概念中最好理解的。</p>
</blockquote>
<h2 data-id="heading-4">5. 核心组合：Struct + Array + Mapping 搭业务模型</h2>
<p>这三个概念单独看都好理解，组合起来就能覆盖很多基础业务场景。</p>
<p>比如接下来这个区块链上的留言板：</p>
<ul>
<li><code>struct Message</code>：定义一条留言的字段（发送者、内容、时间）。</li>
<li><code>Message[] messages</code>：存所有留言，按时间顺序排列（时间线）。</li>
<li><code>mapping(address =&gt; uint256) messageCount</code>：记录每个地址发了多少条留言（查状态）。</li>
</ul>
<p>其实很多 DeFi、NFT 协议的基础数据形态，本质都是这三块 “积木” 的组合。</p>
<hr/>
<h2 data-id="heading-5">小结</h2>
<p>由于编程基础有点薄弱，昨天正式学习solidity的感觉是一下子信息量太大，很多概念理解不了或者记不住，后来发现学不会的先不学，进度就快多了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spark RDD 编程从驱动程序到共享变量、Shuffle 与持久化]]></title>    <link>https://juejin.cn/post/7582155513585582132</link>    <guid>https://juejin.cn/post/7582155513585582132</guid>    <pubDate>2025-12-11T03:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582155513585582132" data-draft-id="7582200865907015714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spark RDD 编程从驱动程序到共享变量、Shuffle 与持久化"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-12-11T03:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloReader"/> <meta itemprop="url" content="https://juejin.cn/user/2601910535729322"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spark RDD 编程从驱动程序到共享变量、Shuffle 与持久化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601910535729322/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloReader
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:02:13.000Z" title="Thu Dec 11 2025 03:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. Spark 应用的基本形态</h2>
<ul>
<li><strong>Driver（驱动程序）</strong>：运行你的 <code>main</code> 函数，负责构建 DAG、提交任务、汇总结果。</li>
<li><strong>Executors（执行器）</strong>：分布在集群各节点，执行并行任务。</li>
<li><strong>RDD（Resilient Distributed Dataset）</strong>：Spark 的核心抽象——<strong>可并行操作、具容错能力</strong>的分布式数据集。RDD 的每个分区在不同节点处理。</li>
</ul>
<p><strong>获取 RDD 的两条路径：</strong></p>
<ol>
<li>从外部存储读取（HDFS、本地、S3、HBase、任意 Hadoop InputFormat）</li>
<li>从 Driver 的本地集合并行化（<code>sc.parallelize</code>）</li>
</ol>
<p><strong>容错性</strong>：RDD 基于 lineage（血缘）自动从失败节点恢复。
<strong>持久化</strong>：可将 RDD 缓存在内存或磁盘，重复使用时显著加速。</p>
<h2 data-id="heading-1">2. 共享变量：Broadcast 与 Accumulator</h2>
<ul>
<li><strong>默认行为</strong>：并行任务会收到“闭包”的<strong>拷贝</strong>，各 Executor 内部修改对 Driver 不可见。</li>
<li><strong>Broadcast（广播变量）</strong>：把<strong>只读</strong>的大对象高效分发并缓存到各节点。</li>
<li><strong>Accumulator（累加器）</strong>：<strong>只支持加法</strong>（交换结合），用于计数/求和等全局聚合；<strong>仅 Driver 可读值</strong>。</li>
</ul>
<p><strong>示例（Python）：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Broadcast</span>
bvar = sc.broadcast({&amp;<span class="hljs-comment">#34;threshold&amp;#34;: 10})</span>
rdd.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x &gt; bvar.value[&amp;<span class="hljs-comment">#34;threshold&amp;#34;]).count()</span>

<span class="hljs-comment"># Accumulator</span>
acc = sc.accumulator(<span class="hljs-number">0</span>)
sc.parallelize([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]).foreach(<span class="hljs-keyword">lambda</span> x: acc.add(x))
<span class="hljs-built_in">print</span>(acc.value)  <span class="hljs-comment"># 10</span>
</code></pre>
<blockquote>
<p>生产建议：广播对象<strong>创建后不要再修改</strong>；累加器的更新应在 <strong>action</strong> 内进行（在 transformation 中可能被重复执行）。</p>
</blockquote>
<h2 data-id="heading-2">3. 语言与环境：如何链接 Spark</h2>
<ul>
<li>
<p><strong>PySpark 版本</strong>：Spark 4.0.1 适配 <strong>Python 3.9+</strong>，支持 CPython / PyPy 7.3.6+。</p>
</li>
<li>
<p><strong>两种运行方式</strong>：</p>
<ul>
<li><code>bin/spark-submit</code> / <code>bin/pyspark</code>（无需 pip 安装 PySpark）</li>
<li><code>pip install pyspark</code> 后，直接 <code>python your_app.py</code> 或继续用 <code>spark-submit</code></li>
</ul>
</li>
<li>
<p><strong>在项目里声明依赖（示例）</strong>：</p>
<pre><code class="hljs language-python" lang="python">install_requires = [&amp;<span class="hljs-comment">#34;pyspark==4.0.1&amp;#34;]</span>
</code></pre>
</li>
<li>
<p><strong>选择 Python 解释器</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">PYSPARK_PYTHON=python3.10 bin/pyspark
PYSPARK_PYTHON=/path/to/pypy bin/spark-submit app.py
</code></pre>
</li>
</ul>
<h2 data-id="heading-3">4. 初始化 Spark：SparkConf / SparkContext</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark <span class="hljs-keyword">import</span> SparkConf, SparkContext

conf = SparkConf().setAppName(&amp;<span class="hljs-comment">#34;MyApp&amp;#34;).setMaster(&amp;#34;local[4]&amp;#34;)  # 本地4核</span>
sc = SparkContext(conf=conf)
</code></pre>
<blockquote>
<p>在 <strong>生产集群</strong>中常用 <code>spark-submit --master ...</code> 传入 master，不在代码里硬编码。</p>
</blockquote>
<h2 data-id="heading-4">5. 用 Shell 快速实验（强烈推荐）</h2>
<ul>
<li>
<p><strong>进入交互式 Shell</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">./bin/pyspark --master &amp;<span class="hljs-comment">#34;local[4]&amp;#34; \</span>
  --py-files code.py \
  --packages groupId:artifactId:version \
  --repositories https://repo1.maven.org/maven2
</code></pre>
</li>
<li>
<p><strong>IPython / Jupyter</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">PYSPARK_DRIVER_PYTHON=ipython ./bin/pyspark

PYSPARK_DRIVER_PYTHON=jupyter \
PYSPARK_DRIVER_PYTHON_OPTS=notebook \
./bin/pyspark
</code></pre>
</li>
</ul>
<blockquote>
<p>在 Notebook 里可用 <code>%pylab inline</code> 做内嵌可视化。</p>
</blockquote>
<h2 data-id="heading-5">6. 创建 RDD：并行化 vs. 外部数据集</h2>
<h3 data-id="heading-6">6.1 并行化本地集合</h3>
<pre><code class="hljs language-python" lang="python">data = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
dist = sc.parallelize(data, numSlices=<span class="hljs-number">4</span>)
<span class="hljs-built_in">print</span>(dist.reduce(<span class="hljs-keyword">lambda</span> a,b: a+b))  <span class="hljs-comment"># 15</span>
</code></pre>
<blockquote>
<p>分区数经验值：每个 CPU 2~4 份。</p>
</blockquote>
<h3 data-id="heading-7">6.2 外部数据集（Text / WholeText / SequenceFile / 任意 InputFormat）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 行式文本</span>
distFile = sc.textFile(&amp;<span class="hljs-comment">#34;hdfs:///data/input/*.txt&amp;#34;)</span>
total = distFile.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> s: <span class="hljs-built_in">len</span>(s)).reduce(<span class="hljs-keyword">lambda</span> a,b: a+b)

<span class="hljs-comment"># small files -&gt; (filename, content)</span>
pairs = sc.wholeTextFiles(&amp;<span class="hljs-comment">#34;s3a://bucket/path/&amp;#34;)</span>

<span class="hljs-comment"># SequenceFile（KV）</span>
rdd = sc.parallelize(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>)).<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: (x, &amp;<span class="hljs-comment">#34;a&amp;#34;*x))</span>
rdd.saveAsSequenceFile(&amp;<span class="hljs-comment">#34;path/to/file&amp;#34;)</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">sorted</span>(sc.sequenceFile(&amp;<span class="hljs-comment">#34;path/to/file&amp;#34;).collect()))</span>
<span class="hljs-comment"># [(1,'a'), (2,'aa'), (3,'aaa')]</span>

<span class="hljs-comment"># 自定义 InputFormat（例：Elasticsearch）</span>
<span class="hljs-comment"># ./bin/pyspark --jars elasticsearch-hadoop.jar</span>
conf = {&amp;<span class="hljs-comment">#34;es.resource&amp;#34;: &amp;#34;index/type&amp;#34;}</span>
es_rdd = sc.newAPIHadoopRDD(
    &amp;<span class="hljs-comment">#34;org.elasticsearch.hadoop.mr.EsInputFormat&amp;#34;,</span>
    &amp;<span class="hljs-comment">#34;org.apache.hadoop.io.NullWritable&amp;#34;,</span>
    &amp;<span class="hljs-comment">#34;org.elasticsearch.hadoop.mr.LinkedMapWritable&amp;#34;,</span>
    conf=conf
)
<span class="hljs-built_in">print</span>(es_rdd.first())  <span class="hljs-comment"># =&gt; Python dict</span>
</code></pre>
<blockquote>
<p>读取<strong>本地路径</strong>时需确保 worker 也能访问；通配与压缩文件开箱即用。</p>
</blockquote>
<h2 data-id="heading-8">7. RDD 编程模型：转换（Transformations）与行动（Actions）</h2>
<ul>
<li>
<p><strong>Lazy</strong>：转换是延迟的，仅在遇到行动时触发计算。</p>
</li>
<li>
<p><strong>常用转换</strong>（部分）：</p>
<ul>
<li><code>map</code> / <code>flatMap</code> / <code>filter</code></li>
<li><code>mapPartitions</code> / <code>mapPartitionsWithIndex</code></li>
<li><code>union</code> / <code>intersection</code> / <code>distinct</code></li>
<li><code>groupByKey</code>（聚合推荐 <code>reduceByKey/aggregateByKey</code>）</li>
<li><code>reduceByKey</code> / <code>aggregateByKey</code></li>
<li><code>join</code> / <code>leftOuterJoin</code> / <code>cogroup</code></li>
<li><code>repartition</code> / <code>coalesce</code> / <code>repartitionAndSortWithinPartitions</code></li>
</ul>
</li>
<li>
<p><strong>常用行动</strong>（部分）：</p>
<ul>
<li><code>reduce</code> / <code>collect</code> / <code>count</code> / <code>first</code> / <code>take</code> / <code>takeSample</code></li>
<li><code>takeOrdered</code> / <code>saveAsTextFile</code> / <code>countByKey</code> / <code>foreach</code></li>
</ul>
</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python">lines = sc.textFile(&amp;<span class="hljs-comment">#34;data.txt&amp;#34;)</span>
lineLens = lines.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> s: <span class="hljs-built_in">len</span>(s))     <span class="hljs-comment"># 转换</span>
total    = lineLens.reduce(<span class="hljs-keyword">lambda</span> a,b: a+b) <span class="hljs-comment"># 行动</span>
</code></pre>
<blockquote>
<p><strong>复用</strong>：如果 <code>lineLens</code> 后续还会多次使用，建议先 <code>lineLens.persist()</code>。</p>
</blockquote>
<h2 data-id="heading-9">8. 闭包与副作用：为什么“直接改全局变量”会翻车</h2>
<pre><code class="hljs language-python" lang="python">counter = <span class="hljs-number">0</span>
rdd = sc.parallelize([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">inc</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">global</span> counter
    counter += x

<span class="hljs-comment"># 错误示范：Executor 改的是闭包副本，Driver 看不到</span>
rdd.foreach(inc)
<span class="hljs-built_in">print</span>(counter)  <span class="hljs-comment"># 仍可能是 0（分布式下）</span>
</code></pre>
<ul>
<li>在分布式模式，任务执行前闭包会被<strong>序列化</strong>并<strong>拷贝</strong>到各 Executor；修改发生在副本上。</li>
<li><strong>正确做法</strong>：使用 <strong>Accumulator</strong> 聚合，或把需要的“配置”提前做成 <strong>Broadcast</strong>。</li>
</ul>
<p><strong>打印元素</strong>：想在 Driver 打印，用 <code>take</code>/<code>collect</code> 后在 Driver 打印；不要在 Executor 里 <code>print</code> 期待回到 Driver。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> rdd.take(<span class="hljs-number">100</span>):
    <span class="hljs-built_in">print</span>(x)
</code></pre>
<h2 data-id="heading-10">9. Shuffle：最昂贵但不可避免的重分布</h2>
<p><strong>触发场景</strong>：<code>reduceByKey/aggregateByKey/groupByKey/join/repartition/coalesce(扩大分区)</code> 等。
<strong>开销来源</strong>：网络传输、磁盘 I/O、序列化/反序列化、堆上数据结构（溢出后落盘）。
<strong>内部机制</strong>：map 端写按目标分区排序的中间文件；reduce 端按需拉取并聚合。
<strong>排序与顺序</strong>：Shuffle 后<strong>分区集合与分区顺序可确定</strong>，但<strong>分区内元素顺序不保证</strong>；需要有序请用：</p>
<ul>
<li><code>mapPartitions(...)</code> 内排序</li>
<li><code>repartitionAndSortWithinPartitions(...)</code></li>
<li><code>sortBy(...)</code> 进行全局排序</li>
</ul>
<p><strong>调优提示</strong>：</p>
<ul>
<li>适度提高并行度（<code>spark.sql.shuffle.partitions</code> / <code>rdd.repartition(n)</code>）</li>
<li>避免滥用 <code>groupByKey</code>，优先 <code>reduceByKey/aggregateByKey</code></li>
<li>监控临时目录磁盘（<code>spark.local.dir</code>），长作业注意中间文件清理时机</li>
</ul>
<h2 data-id="heading-11">10. 持久化（缓存）策略</h2>
<pre><code class="hljs language-python" lang="python">rdd.cache()  <span class="hljs-comment"># = persist(StorageLevel.MEMORY_ONLY)</span>
<span class="hljs-comment"># or</span>
<span class="hljs-keyword">from</span> pyspark.storagelevel <span class="hljs-keyword">import</span> StorageLevel
rdd.persist(StorageLevel.MEMORY_AND_DISK)
</code></pre>
<p><strong>Python 存储级别：</strong> <code>MEMORY_ONLY[_2]</code>、<code>MEMORY_AND_DISK[_2]</code>、<code>DISK_ONLY[_2|_3]</code> 等；对象会通过 <strong>Pickle</strong> 序列化。
<strong>选择指南</strong>：</p>
<ol>
<li>能放下就用 <code>MEMORY_ONLY</code>（CPU 最省）</li>
<li>放不下 → <code>MEMORY_ONLY_SER</code>/<code>MEMORY_AND_DISK</code>（Scala/Java 下 SER 更省内存；PySpark天然序列化）</li>
<li>不轻易“溢出到磁盘”，除非重算成本更高</li>
<li>Web 服务低延迟 + 快速容错 → <code>_2</code> 级别做副本</li>
<li>释放缓存：<code>rdd.unpersist(blocking=True)</code></li>
</ol>
<h2 data-id="heading-12">11. 用 Key-Value RDD 做聚合与 Join（PySpark）</h2>
<pre><code class="hljs language-python" lang="python">lines  = sc.textFile(&amp;<span class="hljs-comment">#34;data.txt&amp;#34;)</span>
pairs  = lines.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> s: (s, <span class="hljs-number">1</span>))
counts = pairs.reduceByKey(<span class="hljs-keyword">lambda</span> a,b: a+b)
topN   = counts.sortBy(<span class="hljs-keyword">lambda</span> kv: kv[<span class="hljs-number">1</span>], ascending=<span class="hljs-literal">False</span>).take(<span class="hljs-number">10</span>)
</code></pre>
<h2 data-id="heading-13">12. 部署到集群与作业启动</h2>
<ul>
<li><strong>打包</strong>：Scala/Java → JAR；Python → <code>.py/.zip</code>（依赖走 <code>--py-files</code> 或集群镜像）</li>
<li><strong>提交</strong>：<code>bin/spark-submit</code> 可投递到 Standalone / YARN / Kubernetes</li>
<li><strong>嵌入式启动</strong>（Java/Scala）：<code>org.apache.spark.launcher</code> 提供子进程 API</li>
</ul>
<h2 data-id="heading-14">13. 单元测试友好</h2>
<ul>
<li>测试中用 <code>local[*]</code> 创建 <code>SparkContext</code></li>
<li>在 <code>tearDown</code> 或 <code>finally</code> 中 <code>sc.stop()</code>，确保同一进程只存在一个 <code>SparkContext</code></li>
</ul>
<h2 data-id="heading-15">14. 实用清单（Troubleshooting &amp; Best Practices）</h2>
<ul>
<li><strong>闭包陷阱</strong>：不要在 Executor 修改 Driver 变量；用 Accumulator。</li>
<li><strong>Driver OOM</strong>：避免对大 RDD <code>collect()</code>；先 <code>take</code>/<code>sample</code>/<code>saveAsTextFile</code>。</li>
<li><strong>分区数</strong>：Map 阶段/Shuffle 后适度提升并行度；小结果写出可 <code>coalesce(1)</code>。</li>
<li><strong>数据路径</strong>：本地/共享/分布式路径要一致可见；S3/HDFS 用 <code>s3a://</code>/<code>hdfs://</code>。</li>
<li><strong>依赖管理</strong>：第三方连接器走 <code>--packages</code> 或 <code>--jars</code>，Python 依赖用 <code>--py-files</code>/镜像。</li>
<li><strong>热数据缓存</strong>：确实“常用再缓存”，配合 WebUI 观察命中与内存占用。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 读取或删除 Excel 文件文档属性：Spire.XLS for Java 实用指南]]></title>    <link>https://juejin.cn/post/7582066556089155647</link>    <guid>https://juejin.cn/post/7582066556089155647</guid>    <pubDate>2025-12-11T01:44:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582066556089155647" data-draft-id="7582118538561421331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 读取或删除 Excel 文件文档属性：Spire.XLS for Java 实用指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-11T01:44:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户033212666367"/> <meta itemprop="url" content="https://juejin.cn/user/230252528804124"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 读取或删除 Excel 文件文档属性：Spire.XLS for Java 实用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/230252528804124/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户033212666367
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:44:14.000Z" title="Thu Dec 11 2025 01:44:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Excel文件不仅仅是数据表格，它们还承载着重要的元数据，即“文档属性”。这些属性（如作者、标题、公司、创建日期等）在文件管理、信息溯源和数据合规性方面扮演着关键角色。然而，在Java应用中如何高效地读取或删除这些属性，常常是开发者面临的痛点。本文将深入探讨如何利用功能强大的Spire.XLS for Java库，轻松实现Excel文档属性的读写与删除操作，为你的数据处理工作提供实用解决方案。</p>
<h2 data-id="heading-0">Spire.XLS for Java 库简介与安装</h2>
<p>Spire.XLS for Java 是一个专业的Java Excel API，专注于提供高性能、高质量的Excel文件处理能力。它支持各种Excel操作，包括创建、读取、写入、转换和打印Excel文档，且无需依赖Microsoft Office。其直观的API设计使得开发者可以便捷地操作Excel的各种元素，包括单元格、行、列、图表、图片以及我们今天要讨论的文档属性。</p>
<p>要将Spire.XLS for Java引入你的项目，只需在Maven配置文件中添加相应的依赖即可。</p>
<p>Maven 依赖：</p>
<pre><code class="hljs language-ruby" lang="ruby">  
    
        com.e-iceblue
        e-iceblue
        <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/repo.e-iceblue.cn/repository</span><span class="hljs-regexp">/maven-public/</span>
    


    
        e-iceblue
        spire.xls
        <span class="hljs-number">15.11</span>.<span class="hljs-number">3</span>
    

</code></pre>
<h2 data-id="heading-1">Java 获取 Excel 文件的文档属性</h2>
<p>Excel文档属性分为两类：内置属性 (Built-in Properties) 和 自定义属性 (Custom Properties)。内置属性是Excel预定义的，如标题、主题、作者、公司、创建日期等。自定义属性则允许用户根据需要添加额外的信息。</p>
<p>以下代码示例展示了如何使用Spire.XLS for Java来读取Excel文件的这些文档属性：</p>
<pre><code class="hljs language-csharp" lang="csharp">import com.spire.xls.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ReadProperties</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">//加载Excel文档</span>
        Workbook wb = <span class="hljs-keyword">new</span> Workbook();
        wb.loadFromFile(&amp;<span class="hljs-meta">#34;AddProperties.xlsx&amp;#34;);</span>

        <span class="hljs-comment">//读取Excel内置文档属性</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;标题： &amp;#34; + wb.getDocumentProperties().getTitle());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;主题： &amp;#34; + wb.getDocumentProperties().getSubject());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;作者： &amp;#34; + wb.getDocumentProperties().getAuthor());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;单位： &amp;#34; + wb.getDocumentProperties().getCompany());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;主管： &amp;#34; + wb.getDocumentProperties().getManager());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;类别： &amp;#34; + wb.getDocumentProperties().getCategory());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;关键字： &amp;#34; + wb.getDocumentProperties().getKeywords());</span>

        <span class="hljs-comment">//获取Excel自定义文档属性</span>
        DocumentProperty property = (DocumentProperty) wb.getCustomDocumentProperties().<span class="hljs-keyword">get</span>(<span class="hljs-number">0</span>);
        <span class="hljs-comment">//读取第一个自定义文档属性的名称和值</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;名称： &amp;#34; + property.getName());</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;值： &amp;#34; + property.getValue());</span>
    }
}
</code></pre>
<h3 data-id="heading-2">代码说明：</h3>
<ul>
<li>Workbook.loadFromFile()：加载指定的Excel文件。</li>
<li>Workbook.getDocumentProperties().get()：获取文档属性对象。</li>
<li>Workbook.getCustomDocumentProperties().get()：获取自定义文档属性集合。</li>
</ul>
<h2 data-id="heading-3">Java 删除 Excel 的文档属性</h2>
<p>删除文档属性的场景通常是为了保护隐私信息、清理不必要的元数据或确保文件合规性。Spire.XLS for Java 提供了灵活的方式来删除特定的自定义属性或清空所有自定义属性。</p>
<p>以下代码示例展示了如何删除Excel文件的文档属性：</p>
<pre><code class="hljs language-scss" lang="scss">import com<span class="hljs-selector-class">.spire</span><span class="hljs-selector-class">.xls</span>.*;

public class RemoveProperties {
    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">//加载Excel文档</span>
        Workbook wb = new <span class="hljs-built_in">Workbook</span>();
        wb<span class="hljs-selector-class">.loadFromFile</span>(&amp;#<span class="hljs-number">34</span>;AddProperties.xlsx&amp;#<span class="hljs-number">34</span>;);

        <span class="hljs-comment">//通过将对应文档属性的值设置为空来删除该内置属性</span>
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setTitle</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setSubject</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setAuthor</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setCompany</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setManager</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setCategory</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setKeywords</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getDocumentProperties</span>()<span class="hljs-selector-class">.setComments</span>(&amp;#<span class="hljs-number">34</span>;&amp;#<span class="hljs-number">34</span>;);

        <span class="hljs-comment">//根据自定义文档属性的名称来移除该自定义文档属性</span>
        wb<span class="hljs-selector-class">.getCustomDocumentProperties</span>()<span class="hljs-selector-class">.remove</span>(&amp;#<span class="hljs-number">34</span>;编辑&amp;#<span class="hljs-number">34</span>;);
        wb<span class="hljs-selector-class">.getCustomDocumentProperties</span>()<span class="hljs-selector-class">.remove</span>(&amp;#<span class="hljs-number">34</span>;联系电话&amp;#<span class="hljs-number">34</span>;);

        <span class="hljs-comment">//保存文档</span>
        wb<span class="hljs-selector-class">.saveToFile</span>(&amp;#<span class="hljs-number">34</span>;RemoveProperties.xlsx&amp;#<span class="hljs-number">34</span>;, ExcelVersion.Version2010);
        wb<span class="hljs-selector-class">.dispose</span>();
    }
}
</code></pre>
<h3 data-id="heading-4">代码说明：</h3>
<ul>
<li>Workbook.getCustomDocumentProperties().remove()：通过属性名称删除指定的自定义属性。</li>
<li>对于内置属性，通常通过setXXX("")或setXXX(null)来将其值置空，达到“删除”的效果。</li>
<li>Workbook.saveToFile("...", ExcelVersion.Version2013)：将修改后的工作簿保存到新的Excel文件，并指定Excel版本。</li>
</ul>
<h2 data-id="heading-5">结论</h2>
<p>通过本文的介绍，你已经掌握了如何使用Spire.XLS for Java库来读取和删除Excel文件的文档属性。无论是获取重要的元数据，还是进行敏感信息的清理，Spire.XLS for Java都提供了简洁高效的API支持。它极大地简化了Java开发者在处理Excel文档属性时的复杂性，是Java生态中处理Excel文件的强大工具。鼓励你进一步探索Spire.XLS for Java的更多高级功能，以满足更复杂的Excel操作需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 状态管理：Zustand 快速上手指南]]></title>    <link>https://juejin.cn/post/7582163781183258630</link>    <guid>https://juejin.cn/post/7582163781183258630</guid>    <pubDate>2025-12-11T03:36:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582163781183258630" data-draft-id="7582169248094158854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 状态管理：Zustand 快速上手指南"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-12-11T03:36:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dorisrv"/> <meta itemprop="url" content="https://juejin.cn/user/1522178380270712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 状态管理：Zustand 快速上手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1522178380270712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dorisrv
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:36:30.000Z" title="Thu Dec 11 2025 03:36:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 状态管理：Zustand 快速上手指南</h2>
<h3 data-id="heading-1">🤔 为什么需要 Zustand？</h3>
<p>在 React 应用开发中，随着应用规模的扩大，组件间的状态管理会变得越来越复杂。传统的 <code>useState</code> 和 <code>useContext</code> 在处理全局状态或复杂状态逻辑时，可能会遇到以下问题：</p>
<ul>
<li>状态更新复杂，需要手动处理引用比较</li>
<li>跨组件状态共享需要多层 <code>Context.Provider</code> 嵌套</li>
<li>状态逻辑难以复用和测试</li>
<li>性能优化需要手动实现</li>
</ul>
<p>而 <strong>Zustand</strong> 就是为了解决这些问题而生的！它是一个轻量级的 React 状态管理库，具有以下特点：</p>
<ul>
<li>🚀 <strong>轻量级</strong>：核心代码只有约 1KB，无外部依赖</li>
<li>🔧 <strong>简单易用</strong>：无需 Provider 包裹整个应用</li>
<li>🎯 <strong>灵活</strong>：支持函数式和类组件</li>
<li>⚡ <strong>高性能</strong>：内置选择器优化，避免不必要的重新渲染</li>
<li>🔄 <strong>异步支持</strong>：轻松处理异步状态更新</li>
<li>📦 <strong>中间件支持</strong>：支持持久化、DevTools 等扩展功能</li>
</ul>
<h3 data-id="heading-2">💡 Zustand 基础实现</h3>
<h4 data-id="heading-3">1. 安装 Zustand</h4>
<pre><code class="hljs language-bash" lang="bash">npm install zustand
<span class="hljs-comment"># 或</span>
yarn add zustand
<span class="hljs-comment"># 或</span>
pnpm add zustand
</code></pre>
<h4 data-id="heading-4">2. 创建 Store</h4>
<p>Zustand 的核心是 <code>create</code> 函数，用于创建一个全局状态管理 store：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;

<span class="hljs-comment">// 创建一个简单的计数器 store</span>
<span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-comment">// 操作状态的方法</span>
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
  <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> })),
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }),
}));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCounterStore;
</code></pre>
<p>这里的 <code>create</code> 函数接收一个函数作为参数，该函数返回一个包含状态和操作方法的对象。<code>set</code> 函数用于更新状态，它接收一个回调函数，回调函数的参数是当前状态，返回值是要更新的状态部分。</p>
<h4 data-id="heading-5">3. 在组件中使用 Store</h4>
<p>在任何组件中，只需调用创建的 hook 即可访问和更新状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useCounterStore <span class="hljs-keyword">from</span> <span class="hljs-string">'./store/counterStore'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 直接从 store 中获取状态和方法</span>
  <span class="hljs-keyword">const</span> { count, increment, decrement, reset } = <span class="hljs-title function_">useCounterStore</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        +
        -
        重置
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<h3 data-id="heading-6">🚀 Zustand 进阶用法</h3>
<h4 data-id="heading-7">1. 使用选择器优化性能</h4>
<p>如果只需要 store 中的部分状态，可以使用选择器来避免不必要的重新渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useCounterStore <span class="hljs-keyword">from</span> <span class="hljs-string">'./store/counterStore'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CountDisplay</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 只订阅 count 状态，其他状态变化不会导致此组件重新渲染</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useCounterStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CounterActions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 只订阅操作方法</span>
  <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCounterStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">increment</span>);
  <span class="hljs-keyword">const</span> decrement = <span class="hljs-title function_">useCounterStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">decrement</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      +
      -
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 data-id="heading-8">2. 处理异步操作</h4>
<p>Zustand 支持直接在 store 中处理异步操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;

<span class="hljs-comment">// 创建一个包含异步操作的 store</span>
<span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">users</span>: [],
  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>,
  
  <span class="hljs-comment">// 异步获取用户列表</span>
  <span class="hljs-attr">fetchUsers</span>: <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-title function_">set</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> });
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>);
      <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
      <span class="hljs-title function_">set</span>({ users, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">set</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    }
  },
}));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useUserStore;
</code></pre>
<p>在组件中使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useUserStore <span class="hljs-keyword">from</span> <span class="hljs-string">'./store/userStore'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">UserList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { users, loading, error, fetchUsers } = <span class="hljs-title function_">useUserStore</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchUsers</span>();
  }, [fetchUsers]);

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误: {error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {users.map((user) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UserList</span>;
</code></pre>
<h4 data-id="heading-9">3. 使用中间件</h4>
<p>Zustand 支持中间件扩展功能，例如持久化存储和 Redux DevTools 集成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">import</span> { persist } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/middleware'</span>;
<span class="hljs-keyword">import</span> { devtools } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/middleware'</span>;

<span class="hljs-comment">// 创建一个带持久化和 DevTools 的 store</span>
<span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">create</span>(
  <span class="hljs-title function_">devtools</span>(
    <span class="hljs-title function_">persist</span>(
      <span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
        <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
        <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> })),
      }),
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'counter-storage'</span>, <span class="hljs-comment">// 存储的键名</span>
        <span class="hljs-attr">storage</span>: <span class="hljs-variable language_">localStorage</span>, <span class="hljs-comment">// 存储方式 (localStorage 或 sessionStorage)</span>
      }
    )
  )
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCounterStore;
</code></pre>
<h4 data-id="heading-10">4. 组合多个 Store</h4>
<p>Zustand 支持将多个小 store 组合成一个大 store：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">import</span> { combine } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/middleware'</span>;

<span class="hljs-comment">// 创建两个独立的 store</span>
<span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
}));

<span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">setUser</span>: <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> <span class="hljs-title function_">set</span>({ user }),
}));

<span class="hljs-comment">// 或者使用 combine 中间件组合状态</span>
<span class="hljs-keyword">const</span> useCombinedStore = <span class="hljs-title function_">create</span>(
  <span class="hljs-title function_">combine</span>(
    <span class="hljs-comment">// 初始状态</span>
    { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span> },
    <span class="hljs-comment">// 设置函数</span>
    <span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
      <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
      <span class="hljs-attr">setUser</span>: <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> <span class="hljs-title function_">set</span>({ user }),
    })
  )
);
</code></pre>
<h3 data-id="heading-11">📝 Zustand 最佳实践</h3>
<ol>
<li><strong>保持 Store 简洁</strong>：每个 store 只负责管理相关的状态，避免创建过于庞大的 store</li>
<li><strong>使用选择器</strong>：始终使用选择器来获取需要的状态，减少不必要的重新渲染</li>
<li><strong>合理使用中间件</strong>：根据需求选择合适的中间件，避免引入不必要的依赖</li>
<li><strong>处理异步错误</strong>：在异步操作中始终处理错误，避免应用崩溃</li>
<li><strong>命名规范</strong>：使用 <code>useXxxStore</code> 的命名规范，便于识别和使用</li>
<li><strong>类型安全</strong>：如果使用 TypeScript，可以为 store 添加类型定义，提高代码质量</li>
</ol>
<h3 data-id="heading-12">🎯 Zustand 适用场景</h3>
<p>Zustand 适用于以下场景：</p>
<ul>
<li>中小型 React 应用</li>
<li>需要全局状态管理但不想使用复杂配置的项目</li>
<li>希望减少样板代码的项目</li>
<li>需要处理异步状态的应用</li>
<li>希望使用轻量级状态管理库的项目</li>
</ul>
<h3 data-id="heading-13">🔧 Zustand 与其他状态管理库的比较</h3>















































<table><thead><tr><th>特性</th><th>Zustand</th><th>Redux</th><th>Jotai</th></tr></thead><tbody><tr><td>大小</td><td>~1KB</td><td>~2KB</td><td>~2KB</td></tr><tr><td>学习曲线</td><td>低</td><td>高</td><td>中</td></tr><tr><td>Provider 需要</td><td>否</td><td>是</td><td>否</td></tr><tr><td>异步支持</td><td>内置</td><td>需要中间件</td><td>内置</td></tr><tr><td>DevTools 支持</td><td>是</td><td>是</td><td>是</td></tr><tr><td>持久化支持</td><td>是</td><td>需要中间件</td><td>是</td></tr></tbody></table>
<h3 data-id="heading-14">🚀 总结</h3>
<p>Zustand 是一个轻量级、简单易用的 React 状态管理库，它提供了丰富的功能和灵活的使用方式，同时保持了代码的简洁性。无论是中小型应用还是大型项目，Zustand 都能很好地满足状态管理的需求。</p>
<p>如果你正在寻找一个替代 Redux 的轻量级状态管理库，或者想要简化现有的状态管理逻辑，那么 Zustand 绝对值得一试！</p>
<p>下一篇文章，我们将介绍另一个优秀的 React 状态管理库——Jotai，敬请期待！✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天上亿条日志，Elasticsearch 是怎么扛住的？]]></title>    <link>https://juejin.cn/post/7582118538562404371</link>    <guid>https://juejin.cn/post/7582118538562404371</guid>    <pubDate>2025-12-11T03:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118538562404371" data-draft-id="7582163781183242246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天上亿条日志，Elasticsearch 是怎么扛住的？"/> <meta itemprop="keywords" content="后端,架构,设计"/> <meta itemprop="datePublished" content="2025-12-11T03:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天上亿条日志，Elasticsearch 是怎么扛住的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:36:26.000Z" title="Thu Dec 11 2025 03:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题的本质</h2>
<p>很多人以为 Filebeat + Logstash 往 Elasticsearch（ES）写日志是这样的：</p>
<pre><code class="hljs">来一条日志 → 立即发给 Logstash → 立即写入 ES
</code></pre>
<p>如果真是这样，一天几亿条日志，ES 早就挂了。</p>
<p>真相是：<strong>整个链路都是批量+异步的，没有任何一环是逐条同步处理</strong>。</p>
<h2 data-id="heading-1">二、Logstash 的批量机制</h2>
<h3 data-id="heading-2">2.1 核心原理</h3>
<p>Logstash 不是邮递员（来一件送一件），而是物流中转站（攒够一车再发）。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Filebeat 持续采集日志] --&gt; B[Logstash 内部队列]
    B --&gt; C{攒够批次?}
    C --&gt;|达到5000条| D[发送 bulk 请求]
    C --&gt;|或超过2秒| D
    D --&gt; E[Elasticsearch]
</code></pre>
<h3 data-id="heading-3">2.2 默认批量参数</h3>
<p>Logstash 的 Elasticsearch output 插件默认行为：</p>
<ul>
<li>最多攒 <strong>20,000 条</strong>日志才发一次</li>
<li>或者即使没攒够，最多等 <strong>1 秒</strong>就发</li>
</ul>
<p>这意味着一次网络请求可以携带上万条数据，大幅降低了：</p>
<ul>
<li>网络往返次数（减少 99%+ 的连接开销）</li>
<li>ES 的请求处理压力</li>
<li>认证鉴权的重复调用</li>
</ul>
<h3 data-id="heading-4">2.3 实际配置示例</h3>
<pre><code class="hljs language-conf" lang="conf">output {
  elasticsearch {
    hosts =&gt; [&amp;#34;https://es-cluster:9200&amp;#34;]
    index =&gt; &amp;#34;app-logs-%{+yyyy.MM.dd}&amp;#34;
    user =&gt; &amp;#34;elastic&amp;#34;
    password =&gt; &amp;#34;${ES_PASSWORD}&amp;#34;
    
    # 关键批量参数
    bulk_actions =&gt; 5000
    bulk_size =&gt; &amp;#34;15MB&amp;#34;
    flush_interval =&gt; 2
    
    # 性能优化
    action =&gt; &amp;#34;create&amp;#34;
    retry_on_conflict =&gt; 3
    
    # 安全配置
    ssl_enabled =&gt; true
    ssl_verification_mode =&gt; &amp;#34;certificate&amp;#34;
    cacert =&gt; &amp;#34;/path/to/ca.crt&amp;#34;
  }
}
</code></pre>
<p><strong>重要说明：</strong></p>
<ul>
<li>bulk_actions 不是越大越好，5000-10000 是常见取值</li>
<li>flush_interval 是延迟和吞吐的平衡点</li>
<li>action =&gt; "create" 比 index 快很多，因为不需要检查文档是否存在</li>
</ul>
<h2 data-id="heading-5">三、Elasticsearch 的高吞吐设计</h2>
<p>ES 能接住海量写入，靠的是三层设计。</p>
<h3 data-id="heading-6">3.1 第一层：分片并行写入</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[bulk 请求到达协调节点] --&gt; B{路由计算}
    B --&gt; C[分片1: 处理1/3数据]
    B --&gt; D[分片2: 处理1/3数据]
    B --&gt; E[分片3: 处理1/3数据]
    C --&gt; F[并行写入]
    D --&gt; F
    E --&gt; F
</code></pre>
<p>一个索引会被拆成多个分片（shard），每个分片是独立的 Lucene 索引，可以：</p>
<ul>
<li>分布在不同节点上</li>
<li>并行处理写入请求</li>
<li>单个分片故障不影响其他分片</li>
</ul>
<p><strong>分片数量建议：</strong></p>
<ul>
<li>小索引（200GB）：考虑按时间切分索引（如按天），每个索引 3-5 个分片</li>
</ul>
<h3 data-id="heading-7">3.2 第二层：异步刷新机制</h3>
<p>ES 的写入分三步，故意不做实时持久化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Memory as 内存缓冲区
    participant Translog
    participant Segment as Lucene Segment
    
    Client-&gt;&gt;Memory: 1. 写入数据
    Client-&gt;&gt;Translog: 2. 写入事务日志（防丢失）
    Note over Client: 此时就返回成功了
    
    Note over Memory,Segment: 每1秒执行一次
    Memory-&gt;&gt;Segment: 3. refresh: 刷新到内存段（可搜索）
    
    Note over Translog,Segment: 每30秒或translog满2GB
    Segment-&gt;&gt;Segment: 4. flush: 持久化到磁盘
    Translog-&gt;&gt;Translog: 5. 清空 translog
</code></pre>
<p>关键点：</p>
<ul>
<li><strong>写入只需落内存+translog</strong>，几毫秒就能完成，然后立即返回成功</li>
<li><strong>refresh</strong>（默认1秒）：让数据可被搜索，但还在内存</li>
<li><strong>flush</strong>（默认30秒）：真正写磁盘，但频率很低</li>
</ul>
<p>这就是为什么 ES 能支持超高写入：它把写成功和持久化解耦了。</p>
<h3 data-id="heading-8">3.3 第三层：背压机制</h3>
<p>当 ES 太忙时（CPU、内存、磁盘 IO 打满），会：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ES 繁忙] --&gt; B[返回 429 Too Many Requests]
    B --&gt; C[Logstash 收到 429]
    C --&gt; D[暂停从 Filebeat 读取]
    C --&gt; E[指数退避重试]
    E --&gt; F{ES 恢复?}
    F --&gt;|是| G[继续发送]
    F --&gt;|否| E
</code></pre>
<p>这个机制保证了：</p>
<ul>
<li>ES 不会被压垮（拒绝过载请求）</li>
<li>Logstash 不会丢数据（重试+暂停消费）</li>
<li>Filebeat 不会内存爆炸（Logstash 不拉取了）</li>
</ul>
<h2 data-id="heading-9">四、现实开发中的类似模式</h2>
<p>这套批量+异步+分片的架构不是 ES 独有的，在其他场景也广泛使用：</p>
<h3 data-id="heading-10">4.1 数据库批量写入</h3>
<p><strong>MyBatis/JDBC 批量插入：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误做法：逐条 insert</span>
<span class="hljs-keyword">for</span> (User user : users) {
    userMapper.insert(user);
}

<span class="hljs-comment">// 正确做法：批量 insert</span>
userMapper.batchInsert(users);
</code></pre>
<p><strong>Spring Batch：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Step <span class="hljs-title function_">batchStep</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> stepBuilderFactory.get(&amp;#<span class="hljs-number">34</span>;step&amp;#<span class="hljs-number">34</span>;)
        .chunk(<span class="hljs-number">5000</span>)
        .reader(reader())
        .writer(writer())
        .build();
}
</code></pre>
<h3 data-id="heading-11">4.2 消息队列批量拉取</h3>
<p><strong>Kafka Consumer：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ConsumerRecords</span> <span class="hljs-variable">records</span> <span class="hljs-operator">=</span> 
    consumer.poll(Duration.ofMillis(<span class="hljs-number">100</span>));
<span class="hljs-keyword">for</span> (ConsumerRecord record : records) {
    process(record);
}
</code></pre>
<h3 data-id="heading-12">4.3 日志框架的异步 Appender</h3>
<p><strong>Logback AsyncAppender：</strong></p>
<pre><code class="hljs language-xml" lang="xml">
    512
    

</code></pre>
<h3 data-id="heading-13">4.4 Redis Pipeline</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不用 pipeline：1万次网络往返</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
    jedis.set(&amp;#<span class="hljs-number">34</span>;key&amp;#<span class="hljs-number">34</span>; + i, &amp;#<span class="hljs-number">34</span>;value&amp;#<span class="hljs-number">34</span>; + i);
}

<span class="hljs-comment">// 用 pipeline：1次网络往返</span>
<span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> jedis.pipelined();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
    pipeline.set(&amp;#<span class="hljs-number">34</span>;key&amp;#<span class="hljs-number">34</span>; + i, &amp;#<span class="hljs-number">34</span>;value&amp;#<span class="hljs-number">34</span>; + i);
}
pipeline.sync();
</code></pre>
<p><strong>核心思想都是：减少网络往返，批量处理，异步刷盘。</strong></p>
<h2 data-id="heading-14">五、实战调优建议</h2>
<h3 data-id="heading-15">5.1 监控关键指标</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ES 索引压力</span>
GET _nodes/stats/thread_pool

<span class="hljs-comment"># 查看 bulk 线程池状态</span>
{
  &amp;<span class="hljs-comment">#34;bulk&amp;#34;: {</span>
    &amp;<span class="hljs-comment">#34;rejected&amp;#34;: 0,</span>
    &amp;<span class="hljs-comment">#34;queue&amp;#34;: 2,</span>
    &amp;<span class="hljs-comment">#34;active&amp;#34;: 4</span>
  }
}
</code></pre>
<h3 data-id="heading-16">5.2 分片策略</h3>
<p><strong>错误示例：</strong></p>
<pre><code class="hljs">每天一个索引，50个主分片
→ 一个月1500个分片 
→ 集群卡死
</code></pre>
<p><strong>正确做法：</strong></p>
<pre><code class="hljs">每天一个索引，3个主分片
→ 一个月90个分片 
→ 正常运行
配合 ILM 自动删除30天前的索引
</code></pre>
<h3 data-id="heading-17">5.3 硬件资源分配</h3>
<p>对于日志场景：</p>
<ul>
<li><strong>CPU</strong>：写入不敏感，4-8核够用</li>
<li><strong>内存</strong>：JVM 堆设置为物理内存的50%，但不超过31GB</li>
<li><strong>磁盘</strong>：SSD 必备，机械盘会成为瓶颈</li>
<li><strong>网络</strong>：万兆网卡，批量写入网络流量很高</li>
</ul>
<h3 data-id="heading-18">5.4 索引模板优化</h3>
<pre><code class="hljs language-json" lang="json">PUT _index_template/logs_template
<span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;index_patterns&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;logs-*&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;template&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;settings&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;number_of_shards&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;number_of_replicas&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;refresh_interval&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">5</span>s&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;translog.durability&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;async&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;translog.sync_interval&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">5</span>s&amp;#<span class="hljs-number">34</span>;
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;mappings&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;properties&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;@timestamp&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> &amp;#<span class="hljs-number">34</span>;type&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;date&amp;#<span class="hljs-number">34</span>; <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
          &amp;#<span class="hljs-number">34</span>;type&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;text&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
          &amp;#<span class="hljs-number">34</span>;index&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-19">六、总结</h2>
<p>ES 能扛住海量日志，核心原因是整个链路的设计：</p>
<p><strong>Filebeat</strong>：</p>
<ul>
<li>本地文件缓存（断点续传）</li>
<li>批量发送给 Logstash</li>
</ul>
<p><strong>Logstash</strong>：</p>
<ul>
<li>内部队列缓冲</li>
<li>攒批调用 _bulk API</li>
<li>背压传导（429 自动重试）</li>
</ul>
<p><strong>Elasticsearch</strong>：</p>
<ul>
<li>分片并行写入</li>
<li>内存缓冲 + translog 保证不丢</li>
<li>异步 refresh 和 flush</li>
<li>拒绝过载请求保护自己</li>
</ul>
<p>这套架构的本质是<strong>生产者-队列-消费者</strong>模式，是所有高并发系统的通用解法。理解了这套机制，你就能举一反三：</p>
<ul>
<li>数据库批量插入（减少提交次数）</li>
<li>MQ 批量拉取消息（降低网络开销）</li>
<li>Redis Pipeline（合并命令）</li>
<li>异步日志框架（先缓存后刷盘）</li>
</ul>
<p><strong>一句话：高吞吐的秘诀 = 批量 + 异步 + 并行，而非单条同步。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[本地大模型编程实战(38)实现一个通用的大模型客户端]]></title>    <link>https://juejin.cn/post/7582090790183256102</link>    <guid>https://juejin.cn/post/7582090790183256102</guid>    <pubDate>2025-12-11T03:27:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790183256102" data-draft-id="7582110969200967718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="本地大模型编程实战(38)实现一个通用的大模型客户端"/> <meta itemprop="keywords" content="后端,LLM"/> <meta itemprop="datePublished" content="2025-12-11T03:27:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘立军"/> <meta itemprop="url" content="https://juejin.cn/user/2830599308981642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            本地大模型编程实战(38)实现一个通用的大模型客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2830599308981642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘立军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:27:08.000Z" title="Thu Dec 11 2025 03:27:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>由于大部分AI平台提供的API/接口都兼容 <code>OpenAI API</code> ,所以我们可以使用 <code>OpenAI SDK</code> 实现通用的 <code>LLM（大语言模型）</code> 客户端。</p>
<blockquote>
<p>关于 <code>OpenAI API</code> 更多内容，可参考 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwfcoding.com%2Farticles%2Fprogrammer%2Fp07%2F" target="_blank" title="http://wfcoding.com/articles/programmer/p07/" ref="nofollow noopener noreferrer">程序员应该熟悉的概念(2)OpenAI API</a></p>
</blockquote>
<p>本文讲述了如何实现一个简单的<strong>大模型客户端</strong>。</p>
<h2 data-id="heading-0">兼容 OpenAI API 的平台</h2>

















































<table><thead><tr><th align="left">平台名称</th><th align="left">base_url</th></tr></thead><tbody><tr><td align="left">openai</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.openai.com%2Fv1" target="_blank" title="https://api.openai.com/v1" ref="nofollow noopener noreferrer">api.openai.com/v1</a></td></tr><tr><td align="left">anthropic</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.anthropic.com%2Fv1" target="_blank" title="https://api.anthropic.com/v1" ref="nofollow noopener noreferrer">api.anthropic.com/v1</a></td></tr><tr><td align="left">mistral</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.mistral.ai%2Fv1" target="_blank" title="https://api.mistral.ai/v1" ref="nofollow noopener noreferrer">api.mistral.ai/v1</a></td></tr><tr><td align="left">gemini</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgenerativelanguage.googleapis.com%2Fv1beta%2Fopenai" target="_blank" title="https://generativelanguage.googleapis.com/v1beta/openai" ref="nofollow noopener noreferrer">generativelanguage.googleapis.com/v1beta/open…</a></td></tr><tr><td align="left">cohere</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.cohere.com%2Fv1" target="_blank" title="https://api.cohere.com/v1" ref="nofollow noopener noreferrer">api.cohere.com/v1</a></td></tr><tr><td align="left">xai</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.x.ai%2Fv1" target="_blank" title="https://api.x.ai/v1" ref="nofollow noopener noreferrer">api.x.ai/v1</a></td></tr><tr><td align="left">openrouter</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenrouter.ai%2Fapi%2Fv1" target="_blank" title="https://openrouter.ai/api/v1" ref="nofollow noopener noreferrer">openrouter.ai/api/v1</a></td></tr><tr><td align="left"><strong>ollama</strong></td><td align="left"><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A11434%2Fv1" target="_blank" title="http://localhost:11434/v1" ref="nofollow noopener noreferrer">http://localhost:11434/v1</a></td></tr><tr><td align="left"><strong>bailian</strong></td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a></td></tr><tr><td align="left">vllm</td><td align="left"><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8000%2Fv1" target="_blank" title="http://localhost:8000/v1" ref="nofollow noopener noreferrer">http://localhost:8000/v1</a></td></tr></tbody></table>
<blockquote>
<p>本地部署的 <code>Ollama</code> 也兼容 <code>OpenAI API</code>，使用时无需 <code>api-key</code> 。合理的标准大大提高生产力！</p>
</blockquote>
<h2 data-id="heading-1">定义变量</h2>
<p>我们先定义一个变量，存储不同平台的 <code>base_url</code> 和 <code>api_key</code>，这样在访问不同的平台时，使用该平台独有的配置信息即可。</p>
<pre><code class="hljs language-python" lang="python">    PROVIDERS = {
        &amp;<span class="hljs-comment">#34;openai&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://api.openai.com/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;OPENAI_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;anthropic&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://api.anthropic.com/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;ANTHROPIC_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;mistral&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://api.mistral.ai/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;MISTRAL_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;gemini&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://generativelanguage.googleapis.com/v1beta/openai&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;GEMINI_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;cohere&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://api.cohere.com/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;COHERE_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;xai&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://api.x.ai/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;XAI_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;openrouter&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://openrouter.ai/api/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;OPENROUTER_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;ollama&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;http://localhost:11434/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: None     # 使用任何字符串都可以</span>
        },
        &amp;<span class="hljs-comment">#34;bailian&amp;#34;:{</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;https://dashscope.aliyuncs.com/compatible-mode/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: &amp;#34;DASHSCOPE_API_KEY&amp;#34;</span>
        },
        &amp;<span class="hljs-comment">#34;vllm&amp;#34;: {</span>
            &amp;<span class="hljs-comment">#34;base_url&amp;#34;: &amp;#34;http://localhost:8000/v1&amp;#34;,</span>
            &amp;<span class="hljs-comment">#34;api_key_env&amp;#34;: None</span>
        }
    }
</code></pre>
<blockquote>
<p>本地部署的 <code>ollama</code> 和 <code>vllm</code> 不需要 api_key。<br/>
这里将api-key存储在环境变量中，当然也可改造让它存储在配置文件甚至数据库中。</p>
</blockquote>
<h2 data-id="heading-2">实现通用客户端类：LLMClient</h2>
<p>在使用 <code>LLM（大语言模型）</code> 时，<code>temperature</code> 是很常用的参数： 它的数值在 0-1 之间，数值越小，确定性越强，数值越大，随机性越强。如果我们需要更加稳定准确的答案，那么这个数值应该小一点，如果想模拟李白写诗，这个数值应该大一点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMClient</span>:
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, provider=&amp;<span class="hljs-comment">#34;openai&amp;#34;, api_key=None, temperature: float = 0.7):</span>
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        初始化 LLM 客户端
        :param base_url: API 地址，例如 &amp;<span class="hljs-comment">#34;http://localhost:8000/v1&amp;#34;</span>
        :param api_key: API key（Ollama 等兼容实现可用任意字符串）
        :param model: 模型名称，例如 &amp;<span class="hljs-comment">#34;qwen3&amp;#34; 或 &amp;#34;gpt-4o-mini&amp;#34;</span>
        :param temperature: 采样温度（[<span class="hljs-number">0</span>-<span class="hljs-number">1</span>]，数值越大随机性越高）
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        <span class="hljs-keyword">if</span> provider <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.PROVIDERS:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-params">f&amp;<span class="hljs-comment">#34;Unsupported provider: {provider}&amp;#34;)</span>

        self.provider = provider
        self.temperature = temperature  <span class="hljs-comment"># 保存默认 temperature</span>
        config = self.PROVIDERS[provider]

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key <span class="hljs-keyword">and</span> config[&amp;<span class="hljs-comment">#34;api_key_env&amp;#34;]:</span>
            <span class="hljs-keyword">import</span> os
            api_key = os.getenv(<span class="hljs-params">config[&amp;<span class="hljs-comment">#34;api_key_env&amp;#34;])</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-params">f&amp;<span class="hljs-comment">#34;Missing API key, please set {config['api_key_env']}&amp;#34;)</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
            api_key = &amp;<span class="hljs-comment">#34;none&amp;#34;</span>

        self.client = OpenAI(<span class="hljs-params">api_key=api_key, base_url=config[&amp;<span class="hljs-comment">#34;base_url&amp;#34;])</span>

    <span class="hljs-keyword">def</span> chat(<span class="hljs-params">self, model, messages, stream=<span class="hljs-literal">False</span>, **kwargs</span>):
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        普通调用: 返回字符串
        流式调用: 返回生成器，每次 <span class="hljs-keyword">yield</span> 新的 token
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        <span class="hljs-comment"># 如果用户没有传 temperature，则用默认的</span>
        <span class="hljs-comment"># top_p、max_tokens 这些常用参数也可以通过kwargs设置</span>
        <span class="hljs-keyword">if</span> &amp;<span class="hljs-comment">#34;temperature&amp;#34; not in kwargs:</span>
            kwargs[&amp;<span class="hljs-comment">#34;temperature&amp;#34;] = self.temperature</span>
        <span class="hljs-keyword">if</span> stream:
            response = self.client.chat.completions.create(<span class="hljs-params">
                model=model,
                messages=messages,
                stream=<span class="hljs-literal">True</span>,
                **kwargs
            </span>)
            <span class="hljs-keyword">def</span> generator(<span class="hljs-params"/>):
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> response:
                    delta = chunk.choices[<span class="hljs-number">0</span>].delta.content
                    <span class="hljs-keyword">if</span> delta:
                        <span class="hljs-keyword">yield</span> delta
            <span class="hljs-keyword">return</span> generator(<span class="hljs-params"/>)
        <span class="hljs-keyword">else</span>:
            resp = self.client.chat.completions.create(<span class="hljs-params">
                model=model,
                messages=messages,
                **kwargs
            </span>)
            <span class="hljs-keyword">return</span> resp.choices[<span class="hljs-number">0</span>].message.content
</span></span></span></span></span></code></pre>
<blockquote>
<p><strong>kwargs</strong> 看起来怪怪的，但是其能力却很强，它可以传递任意数量的关键字参数。这些关键字参数会以字典的形式存储在 kwargs 中。<br/>
我们在 <strong>init</strong> 中设置了 temperature 的默认值，但是可以在调用 chat 方法时，通过 <strong>kwargs</strong> 覆盖它。</p>
</blockquote>
<p>上面的类支持普通的调用，也支持流模式。下面使用本地部署的 <code>ollama</code> 测试一下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    model_name = &amp;<span class="hljs-comment">#34;qwen3&amp;#34;</span>
    llm = LLMClient(provider=&amp;<span class="hljs-comment">#34;ollama&amp;#34;)</span>

    <span class="hljs-built_in">print</span>(&amp;<span class="hljs-comment">#34;流式模式结果：&amp;#34;, end=&amp;#34;&amp;#34;, flush=True)</span>
    <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> llm.chat(
        model=model_name,
        messages=[{&amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;user&amp;#34;, &amp;#34;content&amp;#34;: &amp;#34;用少于1000个字总结《西游记》&amp;#34;}],</span>
        stream=<span class="hljs-literal">True</span>
    ):
        <span class="hljs-built_in">print</span>(token, end=&amp;<span class="hljs-comment">#34;&amp;#34;, flush=True)</span>

    <span class="hljs-built_in">print</span>()  <span class="hljs-comment"># 换行</span>

    result = llm.chat(model_name, [{&amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;user&amp;#34;, &amp;#34;content&amp;#34;: &amp;#34;用李白的风格给我写一首描写饮酒的诗&amp;#34;}])</span>
    <span class="hljs-built_in">print</span>(&amp;<span class="hljs-comment">#34;普通模式结果：\n&amp;#34;, result)</span>
</code></pre>
<p>输出结果就不贴了，有兴趣可以在后面下载代码自己玩一下。</p>
<h2 data-id="heading-3">总结</h2>
<p>从以上的代码实践可以看出，基于标准的魔力，实现一个通用的大模型客户端就变得比较简单了。</p>
<hr/>
<h2 data-id="heading-4">代码</h2>
<p>本文涉及的所有代码以及相关资源都已经共享，参见：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliupras%2FPractical-local-LLM-programming" target="_blank" title="https://github.com/liupras/Practical-local-LLM-programming" ref="nofollow noopener noreferrer">github</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliupras%2Fprogramming-with-local-large-language-model" target="_blank" title="https://gitee.com/liupras/programming-with-local-large-language-model" ref="nofollow noopener noreferrer">gitee</a></li>
</ul>
<blockquote>
<p>为便于找到代码，程序文件名称最前面的编号与本系列文章的文档编号相同。</p>
</blockquote>
<p>🪐感谢您观看，祝好运🪐</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术]]></title>    <link>https://juejin.cn/post/7582118538562420755</link>    <guid>https://juejin.cn/post/7582118538562420755</guid>    <pubDate>2025-12-11T03:42:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118538562420755" data-draft-id="7582156219059159103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术"/> <meta itemprop="keywords" content="Agent,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T03:42:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:42:54.000Z" title="Thu Dec 11 2025 03:42:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>某天打开组内的Grafana仪表盘，突然好奇我们的埋点从被触发后是如何一步一步变成所展示的各种图表的，于是在我进行一系列的探索之后，总结出了以下链路：</p>
<ul>
<li>在指标工厂新建指标，确定埋点key和埋点元数据。</li>
<li>代码中指定埋点key和埋点数据，通过watchDog发送kafka消息到obs monitor topic。</li>
<li>为埋点指标新建数据处理任务，将消费到的kafka消息落到指定的数据表中。</li>
<li>添加新的仪表盘，编写展示数据背后的SQL语句。</li>
</ul>
<p><strong>痛点</strong>：每需要添加一个新的数据分析大盘，就需要人工去分析各个表结构、表与表之间的联系、表各个字段的含义等，在充分理解其含义后再费时费力地编写SQL语句，并不断调优。这导致OBS埋点数据分析的场景相对固化，并且难以支持灵活的数据查询要求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8992e17b371443bcbbfdfd2cbeea70a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=9EEvzjkVRvjsOsjQRFtTfRI3OUU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-1">二、思考</h2>
<p>在分析了当前系统的痛点后，我意识到这是一个典型的可以利用AI能力来对现有功能进行扩展的场景。因为：</p>
<ul>
<li>场景多变，因为你不知道用户可能想查看什么样的数据，无法通过代码穷举；</li>
<li>需要了解业务同时又具备编写复杂数据查询SQL的人，并且费时费力；</li>
<li>看到大盘数据后，依赖每个人对业务的理解提炼出一套分析报告，报告质量与个人的理解与表达能力相关。</li>
</ul>
<p>于是我就开始思考能否构建一个AI Agent，使其能够根据用户的要求，自主地生成各种各样的SQL查询语句，并将查询到的数据形成完整的数据分析报告返回给用户。</p>
<p>为了实现这个方案，有几个明显需要解决的点：</p>
<ul>
<li>如何让AI理解每个表中各字段的含义、各个表的作用、表与表之间的联系，从而生成准确的SQL？</li>
<li>AI生成完SQL之后，如何打通 AI 与数据平台之间的通路，从而成功执行该SQL 并拿到数据？因为数据库权限不在我这，我无法直接连接到数据库。</li>
<li>如何充分利用已有资源，减少人力投入？毕竟是个人想法，在不确定效果如何的情况下，不好直接打扰平台方专门为我写一些新功能，同时我个人也只能投入一些零碎的时间来做这件事。</li>
</ul>
<h2 data-id="heading-2">三、方案</h2>
<p>有了问题后，就带着问题去找答案。</p>
<h3 data-id="heading-3">3.1查询数据Tool</h3>
<p>首先，我需要一个能够执行查询的端点。那么我就去抓取了大盘中的数据所调用的接口，意外地发现，不同的数据调用的是同一个接口<a href="https://link.juejin.cn?target=https%3A%2F%2Fxxx.com%2Fapi%2Fds%2Fquery%25EF%25BC%258C%25E5%258F%25AA%25E6%2598%25AF%25E5%2585%25A5%25E5%258F%2582%25E4%25B8%258D%25E5%2590%258C%25E8%2580%258C%25E5%25B7%25B2%25EF%25BC%258C%25E8%2580%258C%25E4%25B8%2594%25E5%258F%2591%25E7%258E%25B0%25EF%25BC%258C%25E6%259F%25A5%25E8%25AF%25A2%25E7%259A%2584%25E9%2580%25BB%25E8%25BE%2591%25E6%2598%25AF%25E9%2580%259A%25E8%25BF%2587rawSql%25E5%25B0%2586%25E6%259F%25A5%25E8%25AF%25A2%25E8%25AF%25AD%25E5%258F%25A5%25E7%259B%25B4%25E6%258E%25A5%25E4%25BC%25A0%25E8%25BF%2587%25E5%258E%25BB%25EF%25BC%2581" target="_blank" title="https://xxx.com/api/ds/query%EF%BC%8C%E5%8F%AA%E6%98%AF%E5%85%A5%E5%8F%82%E4%B8%8D%E5%90%8C%E8%80%8C%E5%B7%B2%EF%BC%8C%E8%80%8C%E4%B8%94%E5%8F%91%E7%8E%B0%EF%BC%8C%E6%9F%A5%E8%AF%A2%E7%9A%84%E9%80%BB%E8%BE%91%E6%98%AF%E9%80%9A%E8%BF%87rawSql%E5%B0%86%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%9B%B4%E6%8E%A5%E4%BC%A0%E8%BF%87%E5%8E%BB%EF%BC%81" ref="nofollow noopener noreferrer">xxx.com/api/ds/quer…</a></p>
<p>于是我将该Curl导入到ApiFox中，通过不断修改参数，发现最终与查询结果相关的入参可以精简到简单的几个参数：from、to、query(format,rawSql,intervalMs)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cc12be2388246ca9538964baf94db3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=KhfK4RC8qSolZVxsvWE6N8vEwC8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5898e122620b48179a798c20f92c5de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=P0j64Quhj7Dh1nVIyKTPtYyiEy4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那么针对第一个问题我就想到了很好的办法，把这个查询API封装成一个Tool，描述清楚各个字段的含义，就可以让AI生成完整的参数来查询它想要的数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b659f60d72412d9646ec05e0f6d7e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=CRcNoOSA9lnSyUxio1WzXND75pg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>说干就干，我立马新建了一个Spring AI工程，把Tool的功能和需要的参数描述清楚。其中grafanaService.query()内部逻辑就是通过Feign来调用上面那个查询的API。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Tool</span>(name = <span class="hljs-string">"query_grafana"</span>,
      description= <span class="hljs-string">"使用Grafana中的SQL查询grafana数据"</span>)
public JSONObject <span class="hljs-built_in">queryGrafana</span>(<span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询开始时间"</span>) String from,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询结束时间"</span>) String to,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询数据类型:table|time_series"</span>) String format,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"查询时间间隔,单位毫秒。只有当format为time_series时需要传入。"</span>) Long intervalMs,
                               <span class="hljs-variable">@ToolParam</span>(description = <span class="hljs-string">"Grafana SQL查询语句"</span>) String rawSql){
    <span class="hljs-selector-tag">DateTimeFormatter</span> <span class="hljs-selector-tag">formatter</span> = <span class="hljs-selector-tag">DateTimeFormatter</span><span class="hljs-selector-class">.ofPattern</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
    <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">fromDateTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.parse</span>(from, formatter);
    <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">toDateTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.parse</span>(to, formatter);
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">fromTimestamp</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.valueOf</span>(fromDateTime.<span class="hljs-built_in">toInstant</span>(ZoneOffset.UTC).<span class="hljs-built_in">toEpochMilli</span>());
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">toTimestamp</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.valueOf</span>(toDateTime.<span class="hljs-built_in">toInstant</span>(ZoneOffset.UTC).<span class="hljs-built_in">toEpochMilli</span>());
    <span class="hljs-selector-tag">JSONObject</span> <span class="hljs-selector-tag">resp</span> = <span class="hljs-selector-tag">grafanaService</span><span class="hljs-selector-class">.query</span>(fromTimestamp, toTimestamp, intervalMs, rawSql, format);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">resp</span>;
}
</code></pre>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Resource</span>
<span class="hljs-keyword">private</span> <span class="hljs-title class_">GrafanaClient</span> grafanaClient;


<span class="hljs-meta">@Value</span>(<span class="hljs-string">"${grafana.cookie}"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> getGrafanaCookie;


<span class="hljs-keyword">public</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fromTimestamp, <span class="hljs-built_in">String</span> toTimestamp, Long intervalMs, <span class="hljs-built_in">String</span> rawSql, <span class="hljs-built_in">String</span> format</span>) {
    <span class="hljs-title class_">GrafanaRequest</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GrafanaRequest</span>(fromTimestamp, toTimestamp, intervalMs, rawSql, format);
    <span class="hljs-keyword">return</span> grafanaClient.<span class="hljs-title function_">query</span>(getGrafanaCookie, request);
}
</code></pre>
<h3 data-id="heading-4">3.2表结构RAG</h3>
<p>有了能够执行查询的Tool之后，剩下的就是需要AI能够根据用户的query生成精准的参数以及查询SQL。</p>
<p>之前了解到公司部署了RAGFlow服务：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxxx.com%2Fknowledge%25EF%25BC%258C%25E6%2597%25A2%25E7%2584%25B6%25E6%259C%2589%25E4%25BA%2586%25EF%25BC%258C%25E9%2582%25A3%25E5%25B0%25B1%25E5%25BE%2597%25E7%2594%25A8%25E8%25B5%25B7%25E6%259D%25A5%25EF%25BC%2581" target="_blank" title="https://xxx.com/knowledge%EF%BC%8C%E6%97%A2%E7%84%B6%E6%9C%89%E4%BA%86%EF%BC%8C%E9%82%A3%E5%B0%B1%E5%BE%97%E7%94%A8%E8%B5%B7%E6%9D%A5%EF%BC%81" ref="nofollow noopener noreferrer">xxx.com/knowledge，既…</a></p>
<ul>
<li>创建知识集，发现支持添加飞书文档。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e37c8f34f2b4004927830bf4d82f89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=m8q3s8tokBcDDi050%2FrJs7A%2FKtE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0468f002576b47569f6071d788a2d7a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=XOW2Otuz7zTyxZzdLRt9RyFDDWY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>由于我们是需要完整的表结构，所以把配置修改为使用table的格式，一行数据便是一个chunk，以免出现语义上的中断。（埋点数据一般表都较小，语意较为明确。像一些字段很多的大表可能需要考虑更好的方案。）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e84ab93545174f378c3315e861d38d6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=EizxrD7sHUPY34KAPalDLMmTElY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>创建飞书文档，手动到OBS的库中把我们想要AI帮助分析的表结构拉出来（验证想法时采取的临时方案），但由于建表时的不规范，很多表没有对表中字段添加comment，这会导致AI不理解每个字段的含义，也就无法准确地生成SQL。因此，我们手动补充每张表、每个字段的描述，以及与其它表之间的关联关系。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9adde40d57054101b5f213308b4dcb88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=rqh%2BESuAk25dNypAC8FAnd1X6IA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>将飞书文档添加到数据集中，完成后点击名称查看切片详情。双击每个块也可以查看块的详情。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6429041abc14472bb2278353d823711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=eDzxgUSJ8Cxkszu60he84FIChls%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>会发现RAGFlow自动给我们生成了一些关键词和问题，这些内容会对召回准确率产生影响。我自己觉得生成的不太准确，所以结合自己理解手动输入了一些关键词和可能的问题。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3143617fc3af4be995b67d653faf87fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=FdFHuis%2Fee2jEGCKkthnjqyLMXw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>完成后，可以到检索测试tab测试召回的效果，根据结果确定合适的参数。并可以对chunk的内容和关键词等等进行适当的调整。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b152dba313e488ea6e1ae65d0c07c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=u2l9TSrVN3XrkxMQHH5sL5nb%2FPQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>调优完成后，就需要对接RAGFlow的retrive接口，来把我们知识库召回的流程做成一个Tool。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e428bafad28f4661a22af61f4d2d0c51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=ERRIt6qr5UgPeGRFd5XlAeZXAhE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Resource</span>
private RagFlowService ragFlowService;


<span class="hljs-variable">@Tool</span>(name = <span class="hljs-string">"get_table_schema"</span>, description= <span class="hljs-string">"根据query查询可能有关联的数据库表，返回建表语句。尽量传入多个中文关键词，每个关键词之间用空格隔开。"</span>)
public List&lt;String&gt; <span class="hljs-built_in">getTableSchema</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"query"</span>) String question){
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ragFlowService</span><span class="hljs-selector-class">.retrieval</span>(question);
}
</code></pre>
<h3 data-id="heading-5">3.3 OBS Agent</h3>
<p>在我看来，想要构建一个能够 work 的Agent，需要以下几个要素：</p>
<p><strong>Agent=Architecture</strong>(Workflow、ReAct、Plan-Execute、Multi-Agent...) <strong>+LLM+Context Engineering</strong>(Prompt、Tool、Memory...)</p>
<p>本来是想用SpringAI Alibaba Graph或者 LangGraph来构建一个WorkFlow类或者Graph类的复杂智能体（ReAct、Plan-Execute、Multi-Agent）。但为了快速验证想法和节省个人时间，并且考虑到目前任务相对简单（PE+工具就足以完成），再加上部门正在试用Trae这个工具，所以决定基于Trae来构建一个Agent（可以顺便使用他们的高级模型/doge，也可以分享给其它同事使用）。</p>
<p>接入Trae之后，Architecture自然就是Trae的Agent架构了，根据我使用下来感觉采用的是基于ReAct的 Single-Agent。而Context Engineering的部分，对话功能以及长短期记忆，自然是Trae天生就具备的。而Tool则可以借助其自带的一些工具，另外还可以利用MCP来进行扩展，比如得物的MCP市场，提供了大量好用的Server，并且可以很方便的发布自己开发的Mcp Server。于是，我就把在第一步和第二步做的工具，在得物Mcp平台上进行发布，供我自己和其他感兴趣的同学使用。</p>
<p>最后，需要一个专门针对我这个场景的Prompt来指引LLM 顺利完成任务，经过我不断的修改，最终形成这样一段Prompt:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Role：数据分析专家</span>


<span class="hljs-section">## Background：用户需要专业的数据分析支持来解决复杂的业务问题，从海量数据中提取有价值的信息，为产品优化、运营策略和业务决策提供可靠依据。</span>


<span class="hljs-section">## Attention：数据准确性是分析工作的生命线，必须始终保持严谨细致的工作态度。每一次分析都可能影响重要决策，因此需要系统性思考、分步验证，确保每个环节的可靠性。</span>


<span class="hljs-section">## Profile：</span>
<span class="hljs-bullet">-</span> Language: 中文
<span class="hljs-bullet">-</span> Description: 专注于数据库表结构分析与Grafana-SQL查询的专业数据分析师，具备系统化解决复杂数据查询问题的能力


<span class="hljs-section">### Skills:</span>
<span class="hljs-bullet">-</span> 精通数据库表结构分析，能够快速识别表关系、字段含义和数据类型
<span class="hljs-bullet">-</span> 熟练掌握Grafana-SQL语法规范，具备高效的查询语句编写和优化能力
<span class="hljs-bullet">-</span> 具备专业的数据可视化技能，能够根据分析目标选择合适的图表类型
<span class="hljs-bullet">-</span> 拥有深度业务需求理解能力，能够准确转化业务问题为数据查询方案
<span class="hljs-bullet">-</span> 掌握系统化的问题分析方法，能够规划完整的数据分析流程和验证机制


<span class="hljs-section">## Goals:</span>
<span class="hljs-bullet">-</span> 准确理解用户业务需求，明确数据查询的核心目标和关键指标
<span class="hljs-bullet">-</span> 系统分析相关表结构，确保对数据关系和业务逻辑的全面理解
<span class="hljs-bullet">-</span> 设计高效的数据查询方案，平衡查询性能与结果准确性
<span class="hljs-bullet">-</span> 生成专业的数据分析报告，包含可视化展示和深度业务洞察
<span class="hljs-bullet">-</span> 确保所有分析过程可追溯、结果可验证、结论可执行


<span class="hljs-section">## Constrains:</span>
<span class="hljs-bullet">-</span> 查询不到数据时不要模拟任何数据，直接回复查不到数据
<span class="hljs-bullet">-</span> 你自己所知道的时间是不准确的，如果涉及到时间，则需要使用工具获取当前时间
<span class="hljs-bullet">-</span> 严格基于实际数据进行分析，严禁任何形式的数据虚构或推测
<span class="hljs-bullet">-</span> 必须在完成表结构分析和需求理解后再执行具体查询操作
<span class="hljs-bullet">-</span> 所有重要数据必须进行源头验证和多维度交叉检查
<span class="hljs-bullet">-</span> 严格遵守数据安全和隐私保护原则，不超越授权数据范围
<span class="hljs-bullet">-</span> 明确说明分析的局限性、假设条件和潜在的数据不确定性


<span class="hljs-section">## Workflow:</span>
<span class="hljs-bullet">1.</span> 深度理解业务需求，明确查询目标、关键指标和预期输出
<span class="hljs-bullet">2.</span> 不断使用工具获取你需要的表及其表结构，直到你认为已获取到足够的信息
<span class="hljs-bullet">3.</span> 系统分析相关表结构，包括字段含义、数据类型、关联关系和索引结构
<span class="hljs-bullet">4.</span> 设计查询逻辑方案，规划执行步骤、验证节点和性能优化策略
<span class="hljs-bullet">4.</span> 编写符合Grafana语法的SQL查询语句，设置正确的参数和时间范围
<span class="hljs-bullet">5.</span> 执行查询。如果查询出现401错误，则中断后续流程，并提示用户更新Cookie后重启obs-mcp-server；如果出现400错误，尝试修改自己的SQL语句重新查询；
<span class="hljs-bullet">6.</span> 生成可视化图表和详细分析报告，报告中必须包含你执行查询的SQL语句
<span class="hljs-bullet">7.</span> 调用飞书生成文档工具以Markdown格式创建飞书文档，返回最终的飞书文档地址


<span class="hljs-section">## OutputFormat:</span>
<span class="hljs-bullet">-</span> 分析报告，包含完整的分析过程和关键发现，创建新的飞书文档并保存在其中
<span class="hljs-bullet">-</span> 可视化图表以嵌入式链接形式呈现，确保清晰展示数据趋势和分布
<span class="hljs-bullet">-</span> 报告结构包含执行摘要、分析方法、数据结果、业务洞察和后续建议


<span class="hljs-section">## Suggestions:</span>
<span class="hljs-bullet">-</span> 建立系统化的表结构分析框架，提高数据关系识别的效率和准确性
<span class="hljs-bullet">-</span> 持续学习Grafana-SQL最新语法特性，优化查询性能和资源消耗
<span class="hljs-bullet">-</span> 培养多维度数据验证习惯，确保分析结果的可靠性和业务价值
<span class="hljs-bullet">-</span> 深入理解业务场景，提升从数据到洞察的转化能力和决策支持水平
<span class="hljs-bullet">-</span> 定期复盘分析案例，总结经验教训，持续改进分析方法论和工作流程


<span class="hljs-section">## 工具描述</span>
<span class="hljs-bullet">-</span> query<span class="hljs-emphasis">_grafana:使用Grafana中的SQL查询grafana数据
注意：
      1. 当format为time_</span>series时表示查询时间序列数据，SELECT的第一个字段必须是$<span class="hljs-strong">__timeGroupAlias(timestamp, interval)，表示时间分组别名。时间间隔intervalMs需要与rawSql中的$__</span>timeGroup(timestamp, interval)保持对应。比如intervalMs=86400000L表示1天,rawSql中$<span class="hljs-strong">__timeGroup(timestamp, 1d)也需要保持一致。
      2. 当format为table时表示查询表格数据，SELECT的字段可以任意，intervalMs参数传null
      3. 时间范围为闭区间，即包含开始时间from和结束时间to,格式为yyyy-MM-dd HH:mm:ss。
参数示例：{
    "from": "2025-11-16 00:00:00",
    "to": "2025-11-16 23:59:59",
    "format": "table",
    "intervalMs": null,
    "rawSql": "SELECT region, COUNT(<span class="hljs-emphasis">*) as user_count FROM intl_xxxxxxx WHERE $__timeFilter(timestamp) GROUP BY region ORDER BY user_count DESC"
  }


## Initialization
作为数据分析专家，你必须遵守Constrains，使用默认中文与用户交流。
</span></span></code></pre>
<p>最终，在 Trae 中构建了一个完整OBS Agent。</p>
<ul>
<li>添加智能体：OBS大盘分析</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2209be432b4045549921a04fc0dd830e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=oOAQgJDhTkLHBQxL4hS%2FgN%2FBTlk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-6">四、成果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea2595f4300d4ed795136f67e99929e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=4UQbWkBYfySYKy1jUNEMO7ee8Fc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c9329380274ae3b535a93437222263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=4qSpa4DM8uT5qGKxVEKPKuPuBac%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1def6b68a0455d8e7d3a496cef3b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=9BbuxEVfIBPH1qPE9yDef%2B%2Fgq6Q%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7bf0a31c604be7aedc62757ed09ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=JXtsLE6snnIqrlO35F1bbhCzf8E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终生成的报告（截取部分）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c374ec201cf46a59e9bbad20a12a5ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=%2FuDakHatZoMP6qVK8f3lr6C6oAQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89cc37e36c3e4811a2eb1c64cb1258e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=FHrg5EDXZ5x%2FmAv3Ihj6DTsnIbE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8ed688f0f34673a565beb6dcc4a036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029374&amp;x-signature=q7wtrNRQaFM6hltQzs6hWAJOMuc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-7">五、总结</h2>
<p>AI时代来临，我们应该要善于发现当前系统中的哪些部分能够结合AI来进行提升，积极拥抱变化，有了想法就去做，边做边想边解决问题，永远主动向前一步。</p>
<p>本文章只是记录了从产生想法到构建MVP验证想法的整个过程，这中间当然有很多可以继续优化的地方，我本人目前有以下几个想法，也欢迎大家积极评论，贡献自己的独到见解。</p>
<ul>
<li>接入数据库数据，通过动态监听Binlog的方式来识别各表之间的联系，比如select 语句的join，并将这种关系保存到Neo4j 这种图向量数据库中来实现表结构的 RAG。</li>
<li>基于LangGraph 或 SpringAI Alibaba 构建Multi-Agent System，细化各Agent的职责，精炼各Agent的Context 构成，以获得更好的效果。例如：协调者 Agent、表结构搜索 Agent、SQL 生成 Agent、分析报告 Agent等等。</li>
<li>接入飞书机器人，或者使用AI Coding工具生成一个前端页面。使得一些非技术人员，例如产品和运营也能很方便地使用。</li>
</ul>
<h3 data-id="heading-8">往期回顾</h3>
<ol>
<li>
<p>数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
</li>
<li>
<p>项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
</li>
<li>
<p>Dragonboat统一存储LogDB实现分析｜得物技术</p>
</li>
<li>
<p>从数字到版面：得物数据产品里数字格式化的那些事</p>
</li>
<li>
<p>一文解析得物自建 Redis 最新技术演进</p>
</li>
</ol>
<h3 data-id="heading-9">文 /Neeson</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践]]></title>    <link>https://juejin.cn/post/7582156219059535935</link>    <guid>https://juejin.cn/post/7582156219059535935</guid>    <pubDate>2025-12-11T03:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156219059535935" data-draft-id="7581995152190586922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-11T03:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:43:49.000Z" title="Thu Dec 11 2025 03:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：张鑫（千乘）</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p>
<p><strong>前文回顾：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580386%26idx%3D1%26sn%3D60829abde772d4544cf2d66c1a7b81a7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580386&amp;idx=1&amp;sn=60829abde772d4544cf2d66c1a7b81a7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 UModel 高效构建可观测场景统一实体搜索引擎</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580174%26idx%3D1%26sn%3Ddf8ad313c69dd0157057a46b81c7ab40%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580174&amp;idx=1&amp;sn=df8ad313c69dd0157057a46b81c7ab40&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">构建数据资产“导航地图”：详解 UModel 数据发现与全链路分析能力</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a>》</p>
<h2 data-id="heading-0">背景</h2>
<p>基于 UModel 构建的可观测系统，访问可观测数据需要上层应用感知 EntitySet、DataSet、Storage、Filter 等多个概念，给 UI、算法、客户等使用方带来了较高的开发和维护成本。</p>
<h3 data-id="heading-1">典型场景：查询 APM 服务的请求量指标</h3>
<p>假设上层应用需要实现查询某个 APM 服务的请求量指标，开发者需要经历以下步骤：</p>
<h4 data-id="heading-2">开发者需要了解的知识</h4>
<ol>
<li><strong>实体关联：</strong> 服务实体关联哪个 MetricSet？</li>
<li><strong>存储路由：</strong> MetricSet 使用哪个 MetricStore？Region/Project/存储名称是什么？</li>
<li><strong>字段映射：</strong> Entity 的 <code>service_id</code> 对应存储的哪个字段（如 <code>acs_arms_service_id</code>）？</li>
<li><strong>查询语法：</strong> 如何编写 PromQL 表达式 <code>rate(arms_app_requests_count_raw{...}[1m])</code>？</li>
<li><strong>SPL 拼接：</strong> 如何组装成完整的查询语句？</li>
</ol>
<h4 data-id="heading-3">完整的开发步骤</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: 查询 UModel 元数据
        ↓ 找到 service EntitySet 关联的 MetricSet
        ↓ 如果 DataLink 中包含 FilterByEntity，还需根据实体数据过滤
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: 解析 MetricSet 配置
        ↓ 根据 StorageLink 获取底层 MetricStore 连接信息
        ↓ 获取 Region/Project/MetricStore 名称
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: 查看字段映射
        ↓ 从 DataLink 中获取字段映射表
        ↓ 确认 service_id → acs_arms_service_id
<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: 构造 PromQL 表达式
        ↓ 根据指标定义拼接查询表达式
        ↓ 处理聚合规则、时间窗口
<span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>: 拼接并执行查询
        ↓ 使用正确的 label 和 MetricStore
        ↓ 拼接完整的 SPL 语句并执行
</code></pre>
<p><strong>最终查询语句示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">.metricstore with(<span class="hljs-attr">region</span>=<span class="hljs-string">'cn-hangzhou'</span>, project=<span class="hljs-string">'cms-xxx'</span>, metricstore=<span class="hljs-string">'metricstore-apm'</span>)
|prom-call promql_query_range('sum by (acs_arms_service_id) (rate(arms_app_requests_count_raw{<span class="hljs-attr">acs_arms_service_id</span>=&amp;<span class="hljs-comment">#34;xxx&amp;#34;}[1m]))','1m')</span>
</code></pre>
<h3 data-id="heading-4">痛点</h3>
<h4 data-id="heading-5">痛点 1：概念复杂，学习门槛高</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>开发者必须深入理解 UModel 架构：EntitySet、DataSet、DataLink、StorageLink、Filter 等多个概念</li>
<li>需要了解 DataSet 与 Storage 的关联关系、Filter 路由逻辑、字段映射规则</li>
<li>新人上手困难，老手也容易遗漏细节</li>
</ul>
<p><strong>影响：</strong> 开发效率低，维护成本高</p>
<h4 data-id="heading-6">痛点 2：复杂场景实现困难</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>存储路由查找：需要理解多个 MetricSet 之间的选择逻辑</li>
<li>字段映射处理：Entity 字段 → 存储字段的映射规则复杂</li>
<li>过滤条件筛选：FilterByEntity 规则匹配逻辑难以掌握</li>
<li>多次查询拼接：需要多次查询元数据，再构建数据查询</li>
</ul>
<p><strong>影响：</strong> 增加代码复杂度，出错概率高</p>
<h4 data-id="heading-7">痛点 3：底层存储语法逃不掉</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>MetricSet 可能由 MetricStore 或 LogStore 实现，查询方式完全不同（PromQL vs SPL）</li>
<li>不同存储提供商（ARMS MetricStore、Aliyun Prometheus）语法有差异</li>
<li>开发者仍需精通底层查询语言</li>
</ul>
<p><strong>影响：</strong> 同样的需求需要编写不同的代码，无法统一</p>
<h4 data-id="heading-8">痛点 4：多次查询交互，效率低</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>先查询 UModel Meta 获取配置 → 再根据 Meta 查询数据</li>
<li>需要自己处理数据拼接和关联</li>
<li>每个使用方都要实现类似逻辑，代码重复度高</li>
</ul>
<p><strong>影响：</strong> 集成成本高，查询延迟大，出错概率增加</p>
<h2 data-id="heading-9">目标与架构</h2>
<h3 data-id="heading-10">设计目标</h3>
<p>针对上述四大痛点，UModel PaaS API 的设计目标是屏蔽底层复杂性，统一访问接口，使上层应用更加专注业务逻辑实现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9984af49c44c48b0afcc31e96cfd5319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=XbhGfO0hwA05cH8CwyCpYyGGoCk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-11">核心设计原则</h4>
<ul>
<li><strong>自动化处理：</strong> 自动路由、字段映射、查询转换</li>
<li><strong>统一 SPL 语法：</strong> 所有数据类型使用一致接口</li>
<li><strong>面向对象编程：</strong> 实体方法调用、关系导航</li>
<li><strong>AI 友好：</strong> 反射能力，支持 AI Agent 自主探索</li>
</ul>
<h3 data-id="heading-12">设计理念：两层抽象</h3>
<p>访问 UModel 数据时，需要单独通过 SPL 去访问指标、日志、链路等各种数据，<strong>每种数据都有不同的访问方式，没有统一的抽象。</strong></p>
<p>UModel PaaS API 采用<strong>两层抽象</strong>的设计思路：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8522b6f41d74dcbb3ed0282b539cb6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=uGJOUpgd856GZZJcjGWoRfC6myk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">第一层抽象：Table 模式（表格化抽象）</h4>
<p>将所有数据——指标、日志、链路、性能剖析——统一抽象成<strong>表格结构</strong>，所有查询都是针对表格数据进行操作。</p>
<p><strong>价值：</strong> 统一了查询语言，开发者不需要关心底层是 PromQL 还是 SLS SPL，都用同一套 SPL 语法。</p>
<h4 data-id="heading-14">第二层抽象：Object 模式（对象级抽象）</h4>
<p>表格模式解决了数据访问的统一性，但还不够。我们还需要<strong>以实体为中心</strong>的抽象。</p>
<p>传统方式：查询一个服务的指标，需要知道这个服务关联哪个 MetricSet、字段如何映射、过滤条件怎么写…</p>
<p>Object 模式：只需要说“这个服务，给我它的指标”，系统自动处理字段映射、过滤条件、存储路由。</p>
<p><strong>价值：</strong> 面向对象的思想，把实体当成对象，把查询当成方法调用：<code>service.get_metric()</code>。</p>
<h4 data-id="heading-15">第三层能力：元数据查询（反射能力）</h4>
<p>提供动态能力发现、配置验证等高级功能，让 AI Agent 可以自主探索、自主决策。</p>
<p><strong>价值：</strong> AI Agent 能够通过反射能力动态发现实体的能力边界，实现真正的智能运维。</p>
<h3 data-id="heading-16">架构分层</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ea6c34f60146fc9b4f7abe3d714181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=TAw%2BSRBwdG9e%2F7h0v48s9gQB7tk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">1. 存储层统一：EntityStore/LogStore/MetricStore → SPL</h4>
<p>自动完成存储路由、字段映射（<code>service_id → acs_arms_service_id</code>）、过滤、查询语法的转换。上层应用对存储切换无感知。</p>
<h4 data-id="heading-18">2. 数据层统一：Table 模式</h4>
<p>直接访问 DataSet，声明式查询，支持完整 SPL Pipeline。</p>
<pre><code class="hljs language-ini" lang="ini">.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.request'</span>, query=`service_id=<span class="hljs-string">'xxxx'</span>`) | stats avg(latency)
.log_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.error_log'</span> query=`service_id=<span class="hljs-string">'xxx'</span>`) | where level=&amp;<span class="hljs-comment">#34;ERROR&amp;#34;</span>
</code></pre>
<h4 data-id="heading-19">3. 对象层统一：Object 模式</h4>
<p>以实体为中心，自动处理底层细节，支持动态能力发现和配置检查。</p>
<pre><code class="hljs language-java" lang="java"># 数据访问
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'404e5d6be468f6dfaeef37a014322423'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>)</span> 
# 能力发现（Agent 自主决策的关键）
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__list_method__</span><span class="hljs-params">()</span>
# 配置检查
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__inspect__</span><span class="hljs-params">()</span>
</code></pre>
<h2 data-id="heading-20">API 说明</h2>
<p>UModel PaaS API 提供三大核心能力，满足不同场景的查询需求：</p>
<ol>
<li><strong>Table 模式</strong> - 直接访问数据集，适合批量数据分析</li>
<li><strong>Object 模式</strong> - 以实体为中心，适合实体详情查询和关系分析</li>
<li><strong>元数据查询</strong> - 反射能力和配置验证，支持 AI Agent 和开发调试</li>
</ol>
<h3 data-id="heading-21">Table 模式</h3>
<p>Table 模式（Phase 1）提供直接访问 DataSet（MetricSet、LogSet、TraceSet 等）的能力，返回表格化的可观测数据，适用于不依赖实体关系的数据查询场景。</p>
<p>如：直接查询某个 MetricSet 中的指标数据，或查询某个 LogSet 中的日志，无需关联实体信息。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 读取 apm.metric.apm.service MetricSet对应的avg_request_latency_seconds的指标，</span>
<span class="hljs-comment"># 并对该指标进行异常检测</span>
.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.metric.apm.service'</span>, metric=<span class="hljs-string">'avg_request_latency_seconds'</span>, source=<span class="hljs-string">'metrics'</span>)
| extend <span class="hljs-attr">r</span> = series_decompose_anomalies(__value__) 
| extend <span class="hljs-attr">anomaly_b</span> =r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| extend <span class="hljs-attr">x</span> = zip(anomaly_b, __ts__, anomaly_type, __value__) 
| extend <span class="hljs-attr">__anomaly_rst__</span> = filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>核心特点：</strong></p>
<ul>
<li>直接访问：直达 DataSet，无需查询实体元数据</li>
<li>语法简洁：类似 SQL 的 SPL 语法，易于理解</li>
<li>全量数据：返回 DataSet 中符合条件的所有数据</li>
</ul>
<p><strong>语法：</strong> <code>. with(domain, name, ...) | </code>，更多参数说明请参考文档：Phase 1 Table 模式 <strong>[</strong> <strong>1]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb93a3641544b08be21948d29c9578c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=gZd8RqKCeDb%2FNt%2FGSoQCXR4TpdE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">Object 模式</h3>
<p>Object 模式（Phase 2）提供<strong>以实体为中心的面向对象查询能力</strong>，自动处理实体与数据的关联关系、字段映射、关系查询等复杂逻辑，适用于需要实体上下文的业务场景。</p>
<p>如：查询某个具体服务的指标、日志、链路数据，或查询与该服务有调用关系的其他服务，系统自动完成字段映射和数据过滤。</p>
<pre><code class="hljs language-java" lang="java"># 查询特定服务的请求延迟指标，自动处理字段映射和 FilterByEntity
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span>
| project __entity_id__, __ts__, __value__, __labels__
</code></pre>
<p><strong>核心优势：</strong></p>
<ul>
<li>零配置过滤：自动处理 FilterByEntity，无需手动拼接过滤条件</li>
<li>字段映射透明：自动转换 <code>service_id → acs_arms_service_id</code> 等映射</li>
<li>面向对象语义：<code>entity.get_metric()</code>，符合开发者思维习惯</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;) | </code>，更多参数说明请参考文档：Phase 2 Object 模式 <strong>[</strong> <strong>2]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83198ad240004e66bbe5dddcf6e03773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=ArBD9CBq0HgBRZgKIUtM9dmwx%2Fw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-23">元数据查询方法</h3>
<p>元数据查询方法提供动态发现和反射能力，用于查询实体的关联关系、数据集配置、支持的方法等元数据信息，既可以帮助开发者理解实体能力，也是实现 AI Agent 自主决策和配置验证的关键基础。</p>
<p>如：查询某个服务实体支持哪些方法（<code>__list_method__()</code>）、关联了哪些数据集（<code>list_data_set()</code>）、与哪些其他服务有调用关系（<code>list_related_entity_set()</code>）、配置是否正确（<code>__inspect__()</code>）。</p>
<pre><code class="hljs language-xml" lang="xml"># 动态发现实体支持的所有方法（反射能力）
.entity_set with(domain='apm', name='apm.service') 
| entity-call __list_method__()
# 返回：方法列表及参数定义
# [
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>get_metric<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>获取指标数据<span class="hljs-symbol">&amp;#34;</span>},
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>list_related_entity_set<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>查询关联实体<span class="hljs-symbol">&amp;#34;</span>},
#   ...
# ]
</code></pre>
<p><strong>核心价值：</strong></p>
<ul>
<li>反射能力：<code>__list_method__()</code> 让 AI Agent 能自主探索实体的能力边界</li>
<li>配置验证：<code>__inspect__()</code> 一键检查 DataSet、Link、字段映射等配置完整性</li>
<li>关系查询：<code>list_related_entity_set()</code> 快速获取拓扑关系，无需查询图数据库</li>
<li>能力发现：<code>list_data_set()</code> 了解实体关联的所有观测数据类型</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;)</code>，更多参数说明请参考文档：Phase 2 Object 模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e000ccd7c30345298f37a3475cf305a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=WY4FkW9Q00FxIFvlgF0ighH8Wqo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-24">查询方式</h2>
<h3 data-id="heading-25">UI 方式</h3>
<p>登录云监控 2.0 控制台，点击实体探索 -&gt; SPL，输入 SPL，如下图所示：</p>
<p><code>.entity\_set with(domain='apm', name='apm.service', ids=['21d5ed421ae93973d67a04af551b48b8']) | entity-call get_metric('apm', 'apm.metric.apm.service', 'avg_request_latency_seconds', 'range', '', false)</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1db886c117b54ac090901b7124d42dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=2R8tjeHaOoyHZ6OwIY1UZ9sGH1k%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-26">DryRun 模式</h4>
<p>DryRun 模式返回对应的 Query，不执行当前 Query，也支持手动设置运行模式。</p>
<pre><code class="hljs language-sql" lang="sql"># 开启dry_run模式
.<span class="hljs-keyword">set</span> umodel_paas_mode<span class="hljs-operator">=</span><span class="hljs-string">'dry_run'</span>;
.entity_set <span class="hljs-keyword">with</span>(domain<span class="hljs-operator">=</span><span class="hljs-string">'apm'</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'apm.service'</span>) 
<span class="hljs-operator">|</span> entity<span class="hljs-operator">-</span><span class="hljs-keyword">call</span> get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>) 
</code></pre>
<p>UI 开启 DryRun 模式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e1724052c64023baefe3b68d746726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=7ALJIVlQpqUnJfgVAISCSI6bN2A%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">SDK 方式</h3>
<p>通过阿里云 OpenAPI <strong>[</strong> <strong>3]</strong> 下载 SDK，代码如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
&amp;#<span class="hljs-number">34</span>;fmt&amp;#<span class="hljs-number">34</span>;
	cms20240330 &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/cms<span class="hljs-number">-20240330</span>/v3/client&amp;#<span class="hljs-number">34</span>;
	openapi &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/darabonba-openapi/v2/client&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/tea/tea&amp;#<span class="hljs-number">34</span>;
	credential &amp;#<span class="hljs-number">34</span>;github.com/aliyun/credentials-<span class="hljs-keyword">go</span>/credentials&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;os&amp;#<span class="hljs-number">34</span>;
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateClient</span><span class="hljs-params">()</span></span> (_result *cms20240330.Client, _err <span class="hljs-type">error</span>) {
	credential, _err := credential.NewCredential(<span class="hljs-literal">nil</span>)
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _result, _err
	}
	config := &amp;openapi.Config{
		Credential: credential,
	}
	config.Endpoint = tea.String(&amp;#<span class="hljs-number">34</span>;cms.cn-hangzhou.aliyuncs.com&amp;#<span class="hljs-number">34</span>;)
	_result = &amp;cms20240330.Client{}
	_result, _err = cms20240330.NewClient(config)
<span class="hljs-keyword">return</span> _result, _err
}
<span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">main</span><span class="hljs-params">(args [ ]*<span class="hljs-type">string</span>)</span></span> (_err <span class="hljs-type">error</span>) {
	client, _err := CreateClient()
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _err
	}
	getEntityStoreDataRequest := &amp;cms20240330.GetEntityStoreDataRequest{
		Query: tea.String(&amp;#<span class="hljs-number">34</span>;.entity_set with(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>]) | entity-call get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>) &amp;#<span class="hljs-number">34</span>;),
		From:  tea.Int32(<span class="hljs-number">1762244123</span>),
		To:    tea.Int32(<span class="hljs-number">1762244724</span>),
	}
<span class="hljs-keyword">if</span> result, err := client.GetEntityStoreData(tea.String(&amp;#<span class="hljs-number">34</span>;o11y-demo-cn-hangzhou&amp;#<span class="hljs-number">34</span>;), getEntityStoreDataRequest); err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> err
	} <span class="hljs-keyword">else</span> {
		fmt.Printf(&amp;#<span class="hljs-number">34</span>;length: %d&amp;#<span class="hljs-number">34</span>;, <span class="hljs-built_in">len</span>(result.Body.Data))
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	err := _main(tea.StringSlice(os.Args[<span class="hljs-number">1</span>:]))
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
<span class="hljs-built_in">panic</span>(err)
	}
}
</code></pre>
<p>参数说明：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d51de5612664ed49b17fff454ce33d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=%2FqQie1WvvWGaJ9O91K%2BqXGA46VU%3D" alt="图片" loading="lazy"/></p>
<p><strong>程序运行</strong></p>
<pre><code class="hljs language-ini" lang="ini">go build -o demo .
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=
./demo
</code></pre>
<h2 data-id="heading-28">示例</h2>
<h3 data-id="heading-29">集成算子实现高阶能力：UModel 高阶查询  + 时序异常检测算子</h3>
<p>通过 UModel 高阶 API 集成 SLS 时序异常检测算子 <code>series_decompose_anomalies</code>，一行查询实现智能异常检测。</p>
<p>如：监控某个 APM 服务的请求延迟，当出现异常（突刺、趋势变化、平台变化）时触发告警。</p>
<pre><code class="hljs language-java" lang="java">.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span> 
| <span class="hljs-type">extend</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> series_decompose_anomalies(__value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">anomaly_b</span> <span class="hljs-operator">=</span>r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| <span class="hljs-type">extend</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> zip(anomaly_b, __ts__, anomaly_type, __value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">__anomaly_rst__</span> <span class="hljs-operator">=</span> filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>返回结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2de178290ed4df987dfe6746a9d4f04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=D3i7AxES%2FMbVo8kVoKF%2FbaNWDWI%3D" alt="图片" loading="lazy"/></p>
<p><strong>支持的异常类型：</strong></p>
<ul>
<li><code>SPIKE_UP / SPIKE_DOWN</code> - 向上/向下突刺</li>
<li><code>TREND_SHIFT_UP</code> / <code>TREND_SHIFT_DOWN</code> - 趋势上升/下降</li>
<li><code>LEVEL_SHIFT_UP</code> / <code>LEVEL_SHIFT_DOWN</code> - 平台上升/下降</li>
</ul>
<p>如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f1c630c37914bcd9eb048e611252e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=kpBUiMYsKPfl9O%2FH%2B1HS9SHlL3I%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-30">数据互联互通：关联自定义 LogStore</h3>
<p>在实际生产环境中，业务数据往往分散在多个存储中。例如：</p>
<ul>
<li>UModel 中存储了 APM 服务的拓扑关系、指标、链路、日志</li>
<li>业务系统的自定义日志存储在独立的 LogStore 中（如订单日志、支付日志、用户行为日志）</li>
</ul>
<p>通过 UModel 高阶 API + SPL join 能力，可以<strong>打通 UModel 实体数据与自定义业务数据</strong>，实现：</p>
<ol>
<li><strong>统一视角分析：</strong> 将应用性能问题与业务日志关联分析</li>
<li><strong>快速定位问题：</strong> 从服务异常快速定位到具体业务操作</li>
<li><strong>端到端追踪：</strong> 从业务请求到技术指标的全链路分析</li>
</ol>
<p><strong>典型场景：</strong></p>
<ul>
<li>某个 APM 服务出现延迟异常 → 关联业务订单日志 → 定位到具体慢查询的订单 ID</li>
<li>某个服务的错误日志激增 → 关联用户行为日志 → 分析是哪些用户操作触发了异常</li>
<li>分析服务调用链路 → 关联业务流程日志 → 追踪完整的业务流转路径</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 场景：关联自定义的logstore日志信息
# SPL: 
# <span class="hljs-number">1</span>. 从业务LogStore中找到失败的traceId以及msg
.<span class="hljs-keyword">let</span> failed_log = .logstore <span class="hljs-keyword">with</span>(project=‘xxx’, logstore=‘xxxx’, query=‘*<span class="hljs-comment">') </span>
                     | project trace_id, msg;
# <span class="hljs-number">2</span>. 查询服务的Trace数据
.<span class="hljs-keyword">let</span> service_traces = .entity_set <span class="hljs-keyword">with</span>(domain=<span class="hljs-comment">'apm', name='apm.service', ids=['xxxx']) </span>
                       | entity-<span class="hljs-keyword">call</span> get_trace(‘apm‘, ’apm.trace.common’);
$failed_log | <span class="hljs-keyword">join</span> $service_traces <span class="hljs-keyword">on</span> trace_id = $service_traces.traceId |  project msg
</code></pre>
<h3 data-id="heading-31">集成 AI Agent：通过反射能力实现自主决策</h3>
<p>将 UModel PaaS API 封装为 MCP Tools <strong>[</strong> <strong>4]</strong> ，通过反射能力（<code>__list_method__()</code>）让 AI Agent 具备自主探索和决策能力，实现智能运维分析。</p>
<p>如：用户问“为什么服务响应慢？”，Agent 通过动态发现可用方法，自主完成根因分析。</p>
<pre><code class="hljs language-less" lang="less"># <span class="hljs-selector-tag">Agent</span> 首先调用 <span class="hljs-selector-tag">__list_method__</span>() 动态发现实体支持的方法
<span class="hljs-selector-class">.entity_set</span> <span class="hljs-selector-tag">with</span>(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>) 
| <span class="hljs-selector-tag">entity-call</span> <span class="hljs-selector-tag">__list_method__</span>()
# 返回示例（<span class="hljs-selector-tag">Agent</span> 根据返回的方法列表自主决策下一步操作）:
# {
#   <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">methods</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[#     {&amp;#34;name&amp;#34;: &amp;#34;get_metric&amp;#34;, &amp;#34;params&amp;#34;: [...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取指标数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_log</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取日志数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_trace</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取链路数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">list_related_entity_set</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;查询关联实体<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;}
#   ]
# }
</code></pre>
<p>演示 Demo：</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fggm8MhyGXlRjpXNwxBUmJg" target="_blank" title="https://mp.weixin.qq.com/s/ggm8MhyGXlRjpXNwxBUmJg" ref="nofollow noopener noreferrer">此处</a>，查看Demo演示！</p>
<p><strong>相关链接：</strong></p>
<p>[1] Phase 1 Table 模式</p>
<p>[2] Phase 2 Object 模式</p>
<p>[3] 阿里云 OpenAPI</p>
<p>[4] MCP Tools</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【连载】零基础跟我学做AI Agent（第1课：环境安装）]]></title>    <link>https://juejin.cn/post/7582131164728721448</link>    <guid>https://juejin.cn/post/7582131164728721448</guid>    <pubDate>2025-12-11T03:55:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728721448" data-draft-id="7582136489770434570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【连载】零基础跟我学做AI Agent（第1课：环境安装）"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-11T03:55:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【连载】零基础跟我学做AI Agent（第1课：环境安装）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:55:05.000Z" title="Thu Dec 11 2025 03:55:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>从今天开始，作者介绍一系列AI Agent（智能体）的开发或部署。需要的基础只是要对Python有个大概的了解，几乎是从0开始实践。涉及到的代码都会比较简单，一般不会超过50行。</p>
<h2 data-id="heading-0">一、Agent简介</h2>
<p>AI Agent简称Agent，以其自主规划、自主执行、自主反馈的特点有别于大模型本身。换句话说，Agent像是人类的替身，自己可以思考问题的解决思路，遇到难题自己想办法解决，人类下达命令，Agent给出最终的成果，中间的过程无论迭代多少次，都是靠Agent自行脑补。</p>
<h2 data-id="heading-1">二、依赖环境</h2>
<p>Agent的能力来自于大模型的内容生成和Agent中的思考框架（一堆精心设计的提示词），依赖的环境只有大模型和运行Python的虚拟化工具。关于大模型，既然是零基础，就不用GPU部署模型，那种相对麻烦一些，我们先用Ollama部署，这样就简单得多，只不过精度低，效果一般，但作为学习的目的是足够的，重要的是直接在Windows上就能装。另外就是Python一般不装到操作系统上，而是要用虚拟化工具，比较简便的是Anaconda的精简版Miniconda。</p>
<h2 data-id="heading-2">三、环境安装</h2>
<p><strong>1、Ollama</strong></p>
<p>从官网下载，或从作者运营的下载都可以，下载后安装即可。安装完成后，可以用以下命令启动模型：</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama run qwen
</code></pre>
<p>qwen（千问）是模型名称，可选择的模型在<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">ollama.com</a>查看，各种模型看起来极多，但实际上可选的并不多，因为Agent对大模型有要求，要支持Function-Calling，qwen是为数不多的几个支持此特性的模型。</p>
<p>这里有个小技巧，我们会发现安装进度到90%以后特别慢，可能是Ollama网站的限速算法问题，可以中断后再试，就会快起来。</p>
<p>Ollama运行的模型可以是交互式的，直接在命令行可以提问来测试，如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88217ef68235492285fbaa9ca1a5e5fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766030104&amp;x-signature=v1LKJi7n2fv48m4EobWALFOfcTk%3D" alt="" loading="lazy"/></p>
<p><strong>2、Miniconda</strong></p>
<p>从下载。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67067f2ffa674e108061c74a8deef234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766030104&amp;x-signature=pT9yq1BXeKMhBYFmDcK%2Bzu2O8Nw%3D" alt="" loading="lazy"/></p>
<p>下载安装后，将安装目录的Scripts目录加到操作系统的环境变量中，以便于在命令行用以下命令测试时能搜索到conda.exe。</p>
<pre><code class="hljs">conda -V
</code></pre>
<p>至此，环境安装完成。</p>
<h3 data-id="heading-3">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何从Axios平滑迁移到Alova]]></title>    <link>https://juejin.cn/post/7582096212663599104</link>    <guid>https://juejin.cn/post/7582096212663599104</guid>    <pubDate>2025-12-11T03:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582096212663599104" data-draft-id="7582155513585680436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何从Axios平滑迁移到Alova"/> <meta itemprop="keywords" content="Node.js,React.js,Vue.js"/> <meta itemprop="datePublished" content="2025-12-11T03:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古韵"/> <meta itemprop="url" content="https://juejin.cn/user/1538972010422872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何从Axios平滑迁移到Alova
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1538972010422872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古韵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:59:13.000Z" title="Thu Dec 11 2025 03:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Alova 是谁？</h2>
<p>Alova 是一个请求工具集，它可以配合axios、fetch等请求工具实现高效的接口集成，是用来优化接口集成体验的。此外，它还能提供一些 Axios 不具备的便利功能，比如：</p>
<ul>
<li><strong>内置缓存机制</strong>：不用自己操心数据缓存，Alova 能帮你自动管理，提升性能。</li>
<li><strong>请求策略灵活</strong>：可以根据不同场景设置不同的请求逻辑，比如强制刷新、依赖请求等。</li>
<li><strong>多框架支持</strong>：无论是 Vue、React 还是 Svelte、Solid，Alova 都能很好地集成。</li>
<li><strong>状态管理集成</strong>：请求的数据可以直接与组件状态关联，减少冗余代码。</li>
<li><strong>强大的适配器系统</strong>：支持自定义适配器，比如我们这次要讲的 —— 用 Alova 来兼容你现有的 Axios 实例！</li>
</ul>
<p>简单来说，Alova 在保留类似 Axios 易用性的基础上，还提供了更多开箱即用的高级功能请移步到<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alova官方文档</a>查看。</p>
<h2 data-id="heading-1">为什么要从 Axios 迁移到 Alova？</h2>
<p>你可能会问：“Axios 用得好好的，为什么要迁？” 其实，迁移不一定是“非换不可”，而是一种“锦上添花”的选择。以下是一些常见的迁移动机：</p>
<ol>
<li><strong>希望简化复杂请求逻辑的管理</strong>：比如依赖请求、串并行控制、自动重试等，Alova 提供了更优雅的解决方案。</li>
<li><strong>想要内置缓存，减少重复请求</strong>：如果你的应用有很多重复请求，Alova 的缓存机制可以显著提升性能。</li>
<li><strong>多框架适配更方便</strong>：如果你在多个项目中使用不同框架，Alova 能提供一致的体验。</li>
<li><strong>想逐步优化现有项目</strong>：不想大动干戈重写代码，但又想引入更现代的请求管理方式。</li>
</ol>
<p>如果你有以上需求，那 Alova 就非常值得尝试！</p>
<h2 data-id="heading-2">从 Axios 迁移到 Alova，到底难不难？</h2>
<p><strong>Alova 官方提供了非常友好的 Axios 迁移方案，核心就一个字：稳。</strong></p>
<p>官方迁移指南的设计理念是：</p>
<ul>
<li><strong>最小改动</strong>：你不需要一下子重写所有代码，只需引入 Alova，然后逐步迁移。</li>
<li><strong>渐进迁移</strong>：一个接口一个接口地改，节奏由你掌控。</li>
<li><strong>保持一致性</strong>：你现有的 Axios 实例、配置、拦截器，统统都能继续用！</li>
<li><strong>新老共存</strong>：迁移期间，Axios 和 Alova 可以同时运行，互不干扰。</li>
</ul>
<p>是不是听起来就很贴心？接下来，我们就来看看具体怎么操作。</p>
<h2 data-id="heading-3">从 Axios 迁移到 Alova 的具体步骤</h2>
<h3 data-id="heading-4">第一步：安装 Alova 和 Axios 适配器</h3>
<p>首先，你需要通过包管理工具安装 Alova 以及它的 Axios 适配器。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果你用 npm</span>
npm install alova @alova/adapter-axios

<span class="hljs-comment"># 或者用 yarn</span>
yarn add alova @alova/adapter-axios

<span class="hljs-comment"># 或者用 pnpm</span>
pnpm install alova @alova/adapter-axios
</code></pre>
<h3 data-id="heading-5">第二步：创建 Alova 实例，并传入你的 Axios 实例</h3>
<p>这一步是关键，你可以直接复用你现有的 Axios 实例！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createAlova } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> { axiosRequestAdapter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/adapter-axios'</span>;
<span class="hljs-keyword">import</span> axiosInstance <span class="hljs-keyword">from</span> <span class="hljs-string">'./your-axios-instance'</span>; <span class="hljs-comment">// 你原来就有的 axios 实例</span>

<span class="hljs-keyword">const</span> alovaInst = <span class="hljs-title function_">createAlova</span>({
  statesHook, <span class="hljs-comment">// 这里填你项目里用的 Hook，比如 VueHook / ReactHook / SvelteHook</span>
  <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">axiosRequestAdapter</span>({
    <span class="hljs-attr">axios</span>: axiosInstance <span class="hljs-comment">// 把你原来的 axios 实例传进去</span>
  })
});
</code></pre>
<p>你啥都不用改，原来的 axios 实例、拦截器、配置全都有效！</p>
<h3 data-id="heading-6">第三步：继续使用原有 Axios 代码，不用急着改</h3>
<p>没错，哪怕你刚刚创建了 Alova 实例，你原来的 Axios 代码照样跑得好好的！你可以慢慢来，不用急着一口气全改完。</p>
<p>比如这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = id =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/user/<span class="hljs-subst">${id}</span>`</span>); <span class="hljs-comment">// 你原来的写法，依旧能用</span>
</code></pre>
<p>当然，你也可以开始尝鲜，用 Alova 的方式发起请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = id =&gt; alovaInst.<span class="hljs-title class_">Get</span>(<span class="hljs-string">`/user/<span class="hljs-subst">${id}</span>`</span>);

<span class="hljs-comment">// 在组件里使用（以 React 为例）</span>
<span class="hljs-keyword">const</span> { loading, data, error } = <span class="hljs-title function_">useRequest</span>(<span class="hljs-title function_">getUser</span>(userId));
</code></pre>
<h3 data-id="heading-7">第四步：逐步把 Axios 请求改写为 Alova 请求</h3>
<p>等你熟悉了 Alova，就可以开始把原来的 <code>axios.get</code>、<code>axios.post</code> 等方法，逐步替换为 Alova 的 <code>alovaInst.Get</code>、<code>alovaInst.Post</code>，非常简单：</p>
<p><strong>原来的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">todoList</span> = id =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/todo'</span>);
</code></pre>
<p><strong>改写为 Alova 写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">todoList</span> = id =&gt; alovaInst.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'/todo'</span>);
</code></pre>
<p><strong>带参数的 POST 请求：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原来的写法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitTodo</span> = data =&gt;
  axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/todo'</span>, data, {
    <span class="hljs-attr">responseType</span>: <span class="hljs-string">'json'</span>,
    <span class="hljs-attr">responseEncoding</span>: <span class="hljs-string">'utf8'</span>
  });

<span class="hljs-comment">// Alova 写法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitTodo</span> = data =&gt;
  alovaInst.<span class="hljs-title class_">Post</span>(<span class="hljs-string">'/todo'</span>, data, {
    <span class="hljs-attr">responseType</span>: <span class="hljs-string">'json'</span>,
    <span class="hljs-attr">responseEncoding</span>: <span class="hljs-string">'utf8'</span>
  });
</code></pre>
<p>看，参数基本都能直接对应过去，写法也类似，学习成本极低！</p>
<h2 data-id="heading-8">最后</h2>
<p>从 Axios 迁移到 Alova，其实并没有想象中那么难，甚至可以说非常平滑，尤其是对老项目的兼容性做得非常友好。</p>
<p>所以，如果你：</p>
<ul>
<li>已经在使用 Axios，但想尝试更现代的请求管理方式；</li>
<li>希望引入缓存、优化请求策略、提升应用性能；</li>
<li>想逐步优化代码，又不想一夜之间重写所有逻辑；</li>
</ul>
<p>不妨试试 Alova，按照这个迁移指南可以轻松上手。</p>
<p>如果觉得alova还不错，真诚希望你可以<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fexamples" target="_blank" title="https://alova.js.org/examples" ref="nofollow noopener noreferrer">尝试体验一下</a>，也可以给我们来一个免费的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova" target="_blank" title="https://github.com/alovajs/alova" ref="nofollow noopener noreferrer">github stars</a>。</p>
<p>访问alovajs的官网查看更多详细信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alovajs官网</a>。</p>
<p>有兴趣可以加入我们的交流社区，在第一时间获取到最新进展，也能直接和开发团队交流，提出你的想法和建议。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fimg%2Fwechat_qrcode.jpg" target="_blank" title="https://alova.js.org/img/wechat_qrcode.jpg" ref="nofollow noopener noreferrer">加入微信群参与交流</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【连载】零基础跟我学做AI Agent（第2课：用CrewAI配置一个软件虚拟团队）]]></title>    <link>https://juejin.cn/post/7582200865907425314</link>    <guid>https://juejin.cn/post/7582200865907425314</guid>    <pubDate>2025-12-11T03:55:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582200865907425314" data-draft-id="7582110969201016870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【连载】零基础跟我学做AI Agent（第2课：用CrewAI配置一个软件虚拟团队）"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-11T03:55:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【连载】零基础跟我学做AI Agent（第2课：用CrewAI配置一个软件虚拟团队）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:55:12.000Z" title="Thu Dec 11 2025 03:55:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>今天我们讲第一个AI Agent例子：用CrewAI配置一个软件虚拟团队。实际上，这个需要有69行代码，那为什么不叫开发而叫配置呢？因为代码中几乎没有程序化的内容，基本上就是配置信息。</p>
<h2 data-id="heading-0">一、目标</h2>
<p>本例中Agent实现的目标是配置一个虚拟开发团队，这个团队中有资深程序员，还有测试工程师，两者协作完成一个具体的开发任务。当然这需要大模型的支持和经过多轮迭代。两种角色经过协调和博弈，让结果越来越接近于人类设定的目标。最后得到的成果是整套源代码。</p>
<h2 data-id="heading-1">二、原理</h2>
<p>CrewAI是一种AI Agent框架，适合做多种角色Agent协同的应用，因为Crew的意思是“船员”或“机组”，寓意着几个分工不同的虚拟人共同配合完成一个总体的任务。在配置中，需要有以下几个元素：</p>
<p><strong>1、智能体</strong></p>
<p>我们定义了programmer和qa_engineer两个智能体，这些智能体有目标要求和表示角色的技能声明，当然这是通过大模型提示词实现的。</p>
<p><strong>2、任务</strong></p>
<p>与智能体相匹配的任务有development_task和testing_task两种，这些任务要设定由哪个智能体来执行，而且任务之间也有工作成果的交接。</p>
<p><strong>3、团队</strong></p>
<p>智能体、任务以及执行方法共同组成一个团队，通过kickoff（开球）方法开始运转。</p>
<h2 data-id="heading-2">三、源码</h2>
<p>69行源码全部给出（公众号不便查看源码的话，可到的chapter-x-0base目录查看）。</p>
<pre><code class="hljs language-ini" lang="ini">import os
from crewai import Agent, Task, Crew, Process
os.environ<span class="hljs-section">['OPENAI_API_BASE']</span> = 'http://localhost:11434/v1'
os.environ<span class="hljs-section">[&amp;#34;OPENAI_API_KEY&amp;#34;]</span> = &amp;<span class="hljs-comment">#34;EMPTY&amp;#34;</span>
os.environ<span class="hljs-section">[&amp;#34;OPENAI_MODEL_NAME&amp;#34;]</span> = &amp;<span class="hljs-comment">#34;openai/qwen3&amp;#34;</span>
class DevelopmentCrew:
def __init__(self, development_description, testing_description):
<span class="hljs-comment"># 定义程序员智能体</span>
<span class="hljs-attr">self.programmer</span> = Agent(
<span class="hljs-attr">role</span>=&amp;<span class="hljs-comment">#34;资深程序员&amp;#34;,</span>
<span class="hljs-attr">goal</span>=&amp;<span class="hljs-comment">#34;编写高质量、可维护的代码，实现功能需求&amp;#34;,</span>
<span class="hljs-attr">backstory</span>=&amp;<span class="hljs-comment">#34;你是一位经验丰富的程序员，精通多种编程语言和设计模式。&amp;#34; +</span>
&amp;<span class="hljs-comment">#34;你注重代码质量，善于编写清晰、高效的代码，并且有很强的逻辑思维能力。&amp;#34;,</span>
<span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>,
<span class="hljs-attr">max_execution_time</span>=<span class="hljs-number">300</span>
)
<span class="hljs-comment"># 定义测试工程师智能体</span>
<span class="hljs-attr">self.qa_engineer</span> = Agent(
<span class="hljs-attr">role</span>=&amp;<span class="hljs-comment">#34;测试工程师&amp;#34;,</span>
<span class="hljs-attr">goal</span>=&amp;<span class="hljs-comment">#34;确保代码质量，发现并报告缺陷，验证功能完整性&amp;#34;,</span>
<span class="hljs-attr">backstory</span>=&amp;<span class="hljs-comment">#34;你是一位严谨的测试工程师，对细节极其敏感。&amp;#34; +</span>
&amp;<span class="hljs-comment">#34;你擅长设计测试用例，能够发现各种边界条件和潜在问题，&amp;#34; +</span>
&amp;<span class="hljs-comment">#34;确保交付的代码达到高质量标准。&amp;#34;,</span>
<span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>,
<span class="hljs-attr">max_execution_time</span>=<span class="hljs-number">300</span>
)
<span class="hljs-comment"># 定义开发任务</span>
<span class="hljs-attr">self.development_task</span> = Task(
<span class="hljs-attr">description</span>=development_description,
<span class="hljs-attr">agent</span>=self.programmer,
<span class="hljs-attr">expected_output</span>=&amp;<span class="hljs-comment">#34;完整的Python代码实现，包含所有要求的功能和必要的注释&amp;#34;</span>
)
<span class="hljs-comment"># 定义测试任务</span>
<span class="hljs-attr">self.testing_task</span> = Task(
<span class="hljs-attr">description</span>=testing_description,
<span class="hljs-attr">agent</span>=self.qa_engineer,
<span class="hljs-attr">expected_output</span>=&amp;<span class="hljs-comment">#34;详细的测试报告，包含测试用例、发现的问题和改进建议&amp;#34;,</span>
<span class="hljs-attr">context</span>=[self.development_task]
)
<span class="hljs-comment"># 创建并运行开发团队</span>
def invoke(self):
<span class="hljs-attr">dev_crew</span> = Crew(
<span class="hljs-attr">agents</span>=[self.programmer, self.qa_engineer],
<span class="hljs-attr">tasks</span>=[self.development_task, self.testing_task],
<span class="hljs-attr">process</span>=Process.sequential,
<span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>
)
print(&amp;<span class="hljs-comment">#34;开始软件开发流程...&amp;#34;)</span>
print(&amp;<span class="hljs-comment">#34;第一阶段：程序员进行功能开发&amp;#34;)</span>
print(&amp;<span class="hljs-comment">#34;第二阶段：测试工程师进行质量验证&amp;#34;)</span>
<span class="hljs-attr">result</span> = dev_crew.kick<span class="hljs-literal">off</span>()
print(&amp;<span class="hljs-comment">#34;\n开发流程完成，最终结果:&amp;#34;)</span>
print(result)
return result.raw
if <span class="hljs-attr">__name__</span> == &amp;<span class="hljs-comment">#34;__main__&amp;#34;:</span>
<span class="hljs-comment"># 从主函数传入任务描述</span>
<span class="hljs-attr">dev_description</span> = &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;开发一个用户管理系统，包含以下功能：</span>
1. 用户注册（用户名、邮箱、密码）
2. 用户登录验证
3. 用户信息查询
4. 密码重置功能
请使用Python编写清晰的代码，包含必要的注释和错误处理。&amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
<span class="hljs-attr">test_description</span> = &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;对开发的用户管理系统进行全面测试：</span>
1. 设计测试用例覆盖正常流程和异常情况
2. 进行边界值测试和错误处理测试
3. 验证所有功能是否符合需求
4. 提供详细的测试报告和改进建议&amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
<span class="hljs-attr">dev_crew</span> = DevelopmentCrew(dev_description, test_description)
dev_crew.invoke()
</code></pre>
<h2 data-id="heading-3">四、运行</h2>
<p><strong>1、环境安装</strong></p>
<p>用Miniconda建立一个Python虚拟环境，本案例只依赖于crewai库。大模型是在上一节装好的，程序调到API时，Ollama会自动装载qwen3模型的。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建虚拟环境</span>
conda create -n part02 <span class="hljs-attr">python</span>=<span class="hljs-number">3.13</span> -y
<span class="hljs-comment"># 激活虚拟环境</span>
conda activate part02
<span class="hljs-comment"># 安装依赖库</span>
pip install <span class="hljs-attr">crewai</span>==<span class="hljs-number">0.201</span>.<span class="hljs-number">1</span> -i https://pypi.mirrors.ustc.edu.cn/simple
</code></pre>
<p><strong>2、运行</strong></p>
<pre><code class="hljs">python agent_crewai.py
</code></pre>
<h2 data-id="heading-4">五、运行结果</h2>
<p>开始运行时，团队开始思考，制定计划，然后进入多轮迭代。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832beb79b362489b9b810f6945f40871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766030111&amp;x-signature=yIPMDFJRxLfDBLr9UBKMxWhcI0w%3D" alt="" loading="lazy"/></p>
<p>经过多轮迭代，最后生成目标源码和测试用例，结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07d8982b687c414a885e2bdebbcecd8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766030111&amp;x-signature=WghxqajDNtBu6wB6NekxlxgOTG4%3D" alt="" loading="lazy"/></p>
<p>至于最后的结果是否符合预期，主要是和模型的能力有关，我们用Ollama跑量化模型，效果应一般，如果要得到更好的效果，得用GPU部署更大的、精度更高的模型。</p>
<p>未完待续！</p>
<h3 data-id="heading-5">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK 21 虚拟线程：Java 并发编程的“降维打击”]]></title>    <link>https://juejin.cn/post/7582073642869473295</link>    <guid>https://juejin.cn/post/7582073642869473295</guid>    <pubDate>2025-12-11T00:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582073642869473295" data-draft-id="7582073642869456911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK 21 虚拟线程：Java 并发编程的“降维打击”"/> <meta itemprop="keywords" content="后端,Java,Spring"/> <meta itemprop="datePublished" content="2025-12-11T00:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sumAll"/> <meta itemprop="url" content="https://juejin.cn/user/2863547353939175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK 21 虚拟线程：Java 并发编程的“降维打击”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2863547353939175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sumAll
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:51:37.000Z" title="Thu Dec 11 2025 00:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a3861d2de34460ab94bdc1b41e7fee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VtQWxs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766019097&amp;x-signature=PflRls7fEEdU6P2Qjle9cUZgQFU%3D" alt="3_cover.png" loading="lazy"/></p>
<blockquote>
<p><strong>前言</strong>：如果你还在为线程池参数调优头秃，或者被 <code>CompletableFuture</code> 的回调地狱折磨，那么 JDK 21 带来的虚拟线程（Virtual Threads）绝对是你必须掌握的“救命稻草”。它不仅是 Project Loom 的核心成果，更是 Java 诞生以来并发模型最大的一次变革。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 为什么我们需要虚拟线程？（The Why）</h2>
<p>在深入技术细节之前，我们先聊聊“痛点”。</p>
<p>长期以来，Java 的并发模型一直是 <strong>“一请求一线程”（Thread-per-Request）</strong>。这意味着，每当有一个新的 HTTP 请求进来，Web 服务器（如 Tomcat）就会分配一个独立的线程去处理。</p>
<h3 data-id="heading-1">痛点一：昂贵的平台线程</h3>
<p>在 JDK 21 之前，Java 的 <code>Thread</code> 直接映射到操作系统的内核线程（Platform Thread）。</p>
<ul>
<li><strong>内存贵</strong>：一个平台线程默认占用约 1MB - 2MB 的栈内存。</li>
<li><strong>切换慢</strong>：线程上下文切换涉及内核态与用户态的转换，开销巨大。</li>
<li><strong>数量受限</strong>：你很难在一台普通服务器上启动几万个线程，机器会直接卡死。</li>
</ul>
<h3 data-id="heading-2">痛点二：异步编程的“妥协”</h3>
<p>为了解决高并发问题，我们被迫引入了 NIO、Netty、WebFlux 等异步框架。虽然吞吐量上去了，但代价是惨痛的：</p>
<ul>
<li><strong>代码难懂</strong>：逻辑被拆得支离破碎，回调地狱（Callback Hell）随处可见。</li>
<li><strong>调试噩梦</strong>：一旦报错，堆栈追踪（Stack Trace）里全是框架代码，根本找不到业务逻辑的源头。</li>
</ul>
<p><strong>JDK 21 虚拟线程的出现，就是为了打破这个僵局：</strong></p>
<blockquote>
<p><strong>它允许你用最熟悉的“同步阻塞”代码风格，写出媲美异步框架的“高并发性能”。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">2. 什么是虚拟线程？（The What）</h2>
<p><strong>虚拟线程（Virtual Threads）</strong> 是一种由 JVM 自身管理的轻量级线程，它不再与操作系统的内核线程 1:1 绑定。</p>
<p>我们可以做一个简单的对比：</p>






























<table><thead><tr><th align="left">特性</th><th align="left">平台线程 (Platform Thread)</th><th align="left">虚拟线程 (Virtual Thread)</th></tr></thead><tbody><tr><td align="left"><strong>管理者</strong></td><td align="left">操作系统内核</td><td align="left">JVM 虚拟机</td></tr><tr><td align="left"><strong>映射关系</strong></td><td align="left">1:1 (一个 Java 线程对应一个 OS 线程)</td><td align="left">M:N (大量虚拟线程复用少量 OS 线程)</td></tr><tr><td align="left"><strong>创建成本</strong></td><td align="left">昂贵 (MB 级内存，系统调用)</td><td align="left">极低 (几百字节，普通 Java 对象)</td></tr><tr><td align="left"><strong>数量上限</strong></td><td align="left">几千个</td><td align="left">几百万个 (仅受堆内存限制)</td></tr></tbody></table>
<p>简单来说，虚拟线程就像是 Java 中的“协程”（Go 语言的 Goroutine），但它完全融入了现有的 <code>java.lang.Thread</code> API，老代码几乎不用改就能享受红利。</p>
<hr/>
<h2 data-id="heading-4">3. 核心原理：它是如何工作的？（Under the Hood）</h2>
<p>这是理解虚拟线程最关键的部分。为了讲清楚，我们用一个"<strong>出租车模型</strong>"来打比方。</p>
<ul>
<li><strong>出租车公司（操作系统 OS）</strong>：只有 <strong>10 辆出租车</strong>（这是你的 CPU 核心数/载体线程 Carrier Threads）。</li>
<li><strong>乘客（任务 Task）</strong>：有 <strong>10,000 名乘客</strong>（这是你的并发请求）。</li>
</ul>
<h3 data-id="heading-5">传统模式（平台线程）</h3>
<p>每辆车一次只能拉一个乘客。如果乘客半路说：“师傅，我要去取个快递（数据库查询/网络请求），你等我 5 分钟。”
这时候，<strong>出租车就真的停在路边死等</strong>（线程阻塞）。因为车只有 10 辆，一旦都在等人，后面 9990 个乘客只能排队喝西北风。这就是为什么传统线程池并发上不去。</p>
<h3 data-id="heading-6">虚拟线程模式</h3>
<p>在 JDK 21 中，情况变了：</p>
<ol>
<li><strong>挂载（Mount）</strong>：乘客坐上出租车，开始计算任务。</li>
<li><strong>卸载（Unmount）</strong>：当乘客需要等红灯或取快递（遇到阻塞 I/O，如 <code>Thread.sleep</code> 或 DB 查询）时，JVM 会立刻让乘客<strong>下车</strong>，把他的状态（Continuation）存在路边。</li>
<li><strong>复用</strong>：出租车（载体线程）<strong>立刻去拉下一个乘客</strong>，一刻也不闲着。</li>
<li><strong>恢复</strong>：当原来的乘客快递取好了（I/O 完成），他会重新排队，等任意一辆空闲的出租车过来，带上之前的状态继续走。</li>
</ol>
<p><strong>结果</strong>：仅用 10 辆车，就让 10,000 个乘客感觉自己都在“同时”前进。CPU 利用率被榨干到了极致。</p>
<h3 data-id="heading-7">源码视角：JVM 是如何实现“魔法”的？</h3>
<p>为了更深入地理解，我们稍微看一眼 JDK 的底层实现（基于 JDK 21 OpenJDK 源码）。</p>
<p><strong>1. 虚拟线程的数据结构</strong>
虚拟线程在源码中对应的类是 <code>java.lang.VirtualThread</code>。它不再像平台线程那样持有巨大的栈内存，而是持有一个轻量级的 <strong><code>Continuation</code>（续体）</strong> 对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// java.lang.VirtualThread 源码简略版</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseVirtualThread</span> {
    <span class="hljs-comment">// 调度器，默认是 ForkJoinPool</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor scheduler;
    <span class="hljs-comment">// 续体，用于保存和恢复栈状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Continuation cont;
    <span class="hljs-comment">// 实际要执行的任务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable runContinuation;
    
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>2. Mount（挂载）</strong>
当你的虚拟线程需要执行 CPU 运算时，JVM 会把它“挂载”到一个载体线程（Carrier Thread）上。这个载体线程本质上就是一个 <code>ForkJoinPool</code> 中的 Worker 线程。</p>
<p>以下是 JDK 21 中 <code>mount()</code> 方法的核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// VirtualThread.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mount</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 绑定：获取当前的平台线程（Carrier），并建立关联</span>
    <span class="hljs-type">Thread</span> <span class="hljs-variable">carrier</span> <span class="hljs-operator">=</span> Thread.currentCarrierThread(); 
    setCarrierThread(carrier); 

    <span class="hljs-comment">// 2. 同步状态：处理中断状态（Interrupt Status）</span>
    <span class="hljs-comment">// 必须确保载体线程的中断状态与虚拟线程一致</span>
    <span class="hljs-comment">// 如果虚拟线程被中断了，载体线程也必须标记为中断，以便 IO 操作能感知到</span>
    <span class="hljs-keyword">if</span> (interrupted) { 
        carrier.setInterrupt(); 
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (carrier.isInterrupted()) { 
        <span class="hljs-comment">// 反之，清除载体线程可能残留的“脏”中断状态</span>
        <span class="hljs-keyword">synchronized</span> (interruptLock) { 
            <span class="hljs-keyword">if</span> (!interrupted) carrier.clearInterrupt(); 
        } 
    } 

    <span class="hljs-comment">// 3. 偷天换日：修改当前线程的身份</span>
    <span class="hljs-comment">// 这行代码执行后，Thread.currentThread() 返回的不再是载体线程，而是当前这个虚拟线程</span>
    <span class="hljs-comment">// 这是虚拟线程兼容老代码（如 Log4j, ThreadLocal）的关键</span>
    carrier.setCurrentThread(<span class="hljs-built_in">this</span>); 
}
</code></pre>
<p><strong>3. Unmount（卸载）与 Yield</strong>
当你的代码调用了 <code>Thread.sleep()</code> 或者进行网络 I/O 时，底层会调用 <strong><code>VirtualThread.park()</code></strong>。</p>
<p>这是整个虚拟线程调度的核心枢纽，我们来看看它究竟做了什么：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// VirtualThread.java 源码核心逻辑简化版</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">park</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 检查许可（Permit）：如果当前线程已经有了“通行证”（比如刚被 unpark），则无需挂起，直接返回继续跑</span>
    <span class="hljs-keyword">if</span> (getAndSetParkPermit(<span class="hljs-literal">false</span>) || interrupted)
        <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 2. 尝试挂起（Yield）</span>
    setState(PARKING); <span class="hljs-comment">// 标记状态为 PARKING</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 关键调用：尝试交出控制权</span>
        <span class="hljs-comment">// 如果成功（返回 true），说明虚拟线程已经成功卸载（Unmount）并暂停了</span>
        <span class="hljs-comment">// 如果失败（返回 false），通常是因为被 Pinning（钉住）了</span>
        yielded = yieldContinuation(); 
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 如果没挂起成功，把状态改回 RUNNING</span>
        <span class="hljs-keyword">if</span> (!yielded) { 
            setState(RUNNING); 
        }
    }

    <span class="hljs-comment">// 3. 处理 Pinning（钉住）的情况</span>
    <span class="hljs-comment">// 如果 yieldContinuation() 返回 false，说明没能从 Carrier Thread 上下来</span>
    <span class="hljs-comment">// 这时候只能无奈地阻塞底层的 Carrier Thread（这正是我们极力想避免的）</span>
    <span class="hljs-keyword">if</span> (!yielded) { 
        parkOnCarrierThread(<span class="hljs-literal">false</span>, <span class="hljs-number">0</span>); 
    }
}
</code></pre>
<p>紧接着，我们深入 <code>yieldContinuation()</code>，这才是魔法真正发生的地方：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">yieldContinuation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. Unmount：解绑载体线程，清理中断状态</span>
    <span class="hljs-comment">// (这步操作其实隐含在 Continuation.yield 的前后逻辑中，或者是通过 JVMTI 通知触发)</span>
    notifyJvmtiUnmount(<span class="hljs-comment">/*hide*/</span><span class="hljs-literal">true</span>); 
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 真正的魔法：调用 Continuation.yield</span>
        <span class="hljs-comment">// 这行代码会“冻结”当前栈帧，把堆栈信息保存到堆内存中</span>
        <span class="hljs-comment">// 然后，执行流会“跳回”到 Carrier Thread 的 run() 方法中，去执行下一个任务</span>
        <span class="hljs-keyword">return</span> Continuation.<span class="hljs-keyword">yield</span>(VTHREAD_SCOPE); 
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 3. 恢复：当这个虚拟线程被唤醒（unpark）并重新 Mount 后，代码会从这里继续执行</span>
        notifyJvmtiMount(<span class="hljs-comment">/*hide*/</span><span class="hljs-literal">false</span>); 
    }
}
</code></pre>
<p>通过这段源码，我们清晰地看到了 <strong>Pinning（钉住）</strong> 是如何发生的：当 <code>yieldContinuation()</code> 失败（通常是因为当前栈帧中有 <code>synchronized</code> 或 <code>native</code> 方法）时，代码会回退到 <code>parkOnCarrierThread()</code>，导致底层平台线程被阻塞。</p>
<p><strong>4. 恢复执行</strong>
当 I/O 操作完成（例如网卡收到了数据），操作系统会通知 JVM。调度器（Scheduler）会再次把这个挂起的虚拟线程放入执行队列，等待空闲的载体线程将它“复活”（Mount 并恢复栈帧），从上次暂停的地方继续运行。</p>
<p><strong>5. 实战调用链揭秘</strong>
为了彻底解开疑惑，我们来看看最常用的 <code>Thread.sleep</code> 和网络 I/O 到底发生了什么。</p>
<p><strong>场景 A：<code>Thread.sleep(1000)</code></strong></p>
<ol>
<li><strong>JDK 21 修改了 <code>Thread.sleep</code></strong>：它会检查当前线程是否是虚拟线程。</li>
<li>如果是，调用 <code>VirtualThread.sleepNanos(nanos)</code>。</li>
<li><strong>分支处理</strong>：
<ul>
<li><strong>情况 1：<code>nanos == 0</code> (即 <code>Thread.sleep(0)</code>)</strong>
<ul>
<li>直接调用 <code>tryYield()</code>。</li>
<li>状态标记为 <code>YIELDING</code>。</li>
<li>执行 <code>yieldContinuation()</code> 尝试让出 CPU。这是一种“礼让”行为，允许调度器立刻切换到其他等待的虚拟线程。</li>
</ul>
</li>
<li><strong>情况 2：<code>nanos &gt; 0</code> (即 <code>Thread.sleep(1000)</code>)</strong>
<ul>
<li>调用 <code>parkNanos(nanos)</code>。</li>
<li><strong>注册唤醒任务</strong>：<code>Future unparker = scheduleUnpark(nanos)</code>。JVM 会在内部的调度队列中注册一个 1 秒后的定时事件。</li>
<li><strong>状态标记</strong>：<code>setState(TIMED_PARKING)</code>。</li>
<li><strong>尝试挂起</strong>：调用 <code>yieldContinuation()</code>。
<ul>
<li><strong>成功</strong>：虚拟线程卸载，ForkJoinPool Worker 线程释放去干别的事。</li>
<li><strong>失败（Pinning）</strong>：如果被钉住，则执行 <code>parkOnCarrierThread(true, remainingNanos)</code>，导致载体线程在 OS 层面阻塞等待剩余时间。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>唤醒</strong>：定时器触发或礼让结束后，调度器将该虚拟线程 <code>unpark</code>，它重新排队等待执行。</li>
</ol>
<p><strong>场景 B：网络 I/O (如 <code>socket.read()</code>)</strong></p>
<ol>
<li>JDK 21 重写了 <code>NioSocketImpl</code> 等底层类。</li>
<li>当调用 <code>read()</code> 时，如果底层 Socket 缓冲区为空（数据未到）。</li>
<li><strong>注册 Poller</strong>：将当前 Socket 的文件描述符（FD）注册到 JVM 全局的 <strong>Poller</strong>（Linux 上对应 <code>epoll</code>，Mac 上对应 <code>kqueue</code>）。</li>
<li><strong>调用 <code>park()</code></strong>：虚拟线程卸载。</li>
<li><strong>等待事件</strong>：当网卡收到数据，OS 通知 Poller。</li>
<li><strong>唤醒</strong>：Poller 找到对应的虚拟线程，将其 <code>unpark</code>，虚拟线程恢复执行并成功读取数据。</li>
</ol>
<p>这正是“同步代码，异步执行”的本质！</p>
<hr/>
<h2 data-id="heading-8">4. 实战：如何使用？（Code Examples）</h2>
<p>在 JDK 21 中，使用虚拟线程非常简单。</p>
<h3 data-id="heading-9">4.1 创建虚拟线程</h3>
<p>不需要引入任何第三方包，标准库原生支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式 1: 直接启动一个虚拟线程</span>
Thread.startVirtualThread(() -&gt; {
    System.out.println(&amp;#<span class="hljs-number">34</span>;Hello from Virtual Thread: &amp;#<span class="hljs-number">34</span>; + Thread.currentThread());
});

<span class="hljs-comment">// 方式 2: 使用 Builder 构建更详细的配置（如名称）</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">vThread</span> <span class="hljs-operator">=</span> Thread.ofVirtual()
        .name(&amp;#<span class="hljs-number">34</span>;my-vthread&amp;#<span class="hljs-number">34</span>;)
        .start(() -&gt; {
            <span class="hljs-comment">// 业务逻辑</span>
        });
</code></pre>
<h3 data-id="heading-10">4.2 替代线程池（重点）</h3>
<p><strong>这是最大的思维转变</strong>。过去我们用 <code>Executors.newFixedThreadPool(200)</code> 来限制线程数量。
<strong>现在，请忘掉线程池！</strong> 虚拟线程是用完即毁的，不需要池化。</p>
<p>JDK 21 提供了新的执行器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 try-with-resources 自动关闭结构</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10_000</span>).forEach(i -&gt; {
        executor.submit(() -&gt; {
            <span class="hljs-comment">// 模拟耗时 I/O 操作，例如调用第三方 API</span>
            Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>)); 
            <span class="hljs-keyword">return</span> i;
        });
    });
} 
<span class="hljs-comment">// 代码运行到这里，说明 10,000 个任务全部执行完毕。</span>
<span class="hljs-comment">// 在传统线程池下，这可能需要几十秒；而在虚拟线程下，耗时仅约 1 秒多一点。</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">5. 性能实验：用数据说话（Benchmarks）</h2>
<p>光说不练假把式。我们设计一个简单的基准测试，直观感受虚拟线程在<strong>高并发 I/O 密集型场景</strong>下的威力。</p>
<h3 data-id="heading-12">实验目标</h3>
<p>模拟 10,000 个并发任务，每个任务“假装”执行 1 秒钟的 I/O 操作（使用 <code>Thread.sleep(1000)</code> 模拟）。</p>
<h3 data-id="heading-13">实验代码</h3>
<p>你可以直接复制这段代码在本地运行（需 JDK 21+）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;
<span class="hljs-keyword">import</span> java.lang.management.MemoryMXBean;
<span class="hljs-keyword">import</span> java.lang.management.MemoryUsage;
<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.stream.IntStream;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadBenchmark</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">taskCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">10_000</span>;
        
        System.out.println(&amp;#<span class="hljs-number">34</span>;=== 开始基准测试 ===&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;任务数量: &amp;#<span class="hljs-number">34</span>; + taskCount);

        <span class="hljs-comment">// 1. 测试平台线程（模拟传统线程池）</span>
        <span class="hljs-comment">// 为了公平，我们给平台线程池一个相对较大的核心数，比如 200</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startPlatform</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">200</span>)) {
            IntStream.range(<span class="hljs-number">0</span>, taskCount).forEach(i -&gt; {
                executor.submit(() -&gt; {
                    <span class="hljs-keyword">try</span> {
                        Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                });
            });
        } <span class="hljs-comment">// try-with-resources 会自动等待所有任务完成</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">endPlatform</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(&amp;#<span class="hljs-number">34</span>;平台线程池耗时: &amp;#<span class="hljs-number">34</span>; + (endPlatform - startPlatform) + &amp;#<span class="hljs-number">34</span>; ms&amp;#<span class="hljs-number">34</span>;);

        <span class="hljs-comment">// 手动 GC 一次，尽量减少对下一轮的影响</span>
        System.gc();
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (Exception e) {}

        <span class="hljs-comment">// 2. 测试虚拟线程</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startVirtual</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
            IntStream.range(<span class="hljs-number">0</span>, taskCount).forEach(i -&gt; {
                executor.submit(() -&gt; {
                    <span class="hljs-keyword">try</span> {
                        Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                });
            });
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">endVirtual</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(&amp;#<span class="hljs-number">34</span>;虚拟线程耗时:   &amp;#<span class="hljs-number">34</span>; + (endVirtual - startVirtual) + &amp;#<span class="hljs-number">34</span>; ms&amp;#<span class="hljs-number">34</span>;);
    }

}
</code></pre>
<h3 data-id="heading-14">实验结果分析（参考数据）</h3>
<p>在普通的 8 核笔记本上运行，结果通常如下：</p>





























<table><thead><tr><th align="left">指标</th><th align="left">平台线程池 (Fixed-200)</th><th align="left">虚拟线程 (Virtual Threads)</th><th align="left">提升倍数</th></tr></thead><tbody><tr><td align="left"><strong>总耗时</strong></td><td align="left"><strong>~50,601 ms</strong></td><td align="left"><strong>~1,149 ms</strong></td><td align="left"><strong>~43 倍</strong></td></tr><tr><td align="left"><strong>内存占用</strong></td><td align="left">较高（每个线程栈独立占用 OS 内存）</td><td align="left"><strong>极低</strong>（几乎只增加堆内存，且很少）</td><td align="left"><strong>数量级差异</strong></td></tr><tr><td align="left"><strong>原理分析</strong></td><td align="left">线程池只有 200 个线程，1 万个任务只能排队执行。<br/>50 轮 x 1秒 = 50 秒。</td><td align="left">1 万个虚拟线程几乎同时启动，同时挂起。<br/>底层 Carrier 线程不断复用，几乎没有排队等待。</td><td align="left">碾压级优势</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">6. 性能对比与适用场景</h2>
<p>是不是所有场景都应该无脑上虚拟线程？<strong>并不是。</strong></p>
<h3 data-id="heading-16">适用场景：I/O 密集型 (I/O Bound)</h3>
<p>这是虚拟线程的主场。</p>
<ul>
<li><strong>典型场景</strong>：Web 服务器、微服务网关、大量数据库调用、RPC 调用。</li>
<li><strong>效果</strong>：<strong>吞吐量（Throughput）</strong> 将呈指数级提升。原本能抗 1000 QPS 的服务，可能轻松抗住 10000 QPS。</li>
</ul>
<h3 data-id="heading-17">不适用场景：CPU 密集型 (CPU Bound)</h3>
<ul>
<li><strong>典型场景</strong>：视频转码、复杂的加密解密、科学计算。</li>
<li><strong>原因</strong>：CPU 只有那么多核心。如果任务全是计算，没有任何等待时间，切换虚拟线程只会增加额外的调度开销，反而可能变慢。</li>
</ul>
<blockquote>
<p><strong>误区提示</strong>：虚拟线程不会降低单个请求的<strong>延迟（Latency）</strong>。它解决的是“由于线程不够用导致的排队等待”，提升的是系统的<strong>并发容量</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-18">6. 避坑指南（The Gotchas）</h2>
<p>作为架构师，在落地虚拟线程时，必须警惕以下两个坑：</p>
<h3 data-id="heading-19">坑一：Pinning（线程钉住）</h3>
<p>当虚拟线程在执行以下代码时，无法从载体线程上卸载（Unmount），导致它退化成普通的阻塞线程：</p>
<ol>
<li>在 <code>synchronized</code> 块或方法内部。</li>
<li>执行 <code>native</code> 方法或外部函数接口（FFI）时。</li>
</ol>
<p><strong>反例（不要这么写）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> (lock) {
    <span class="hljs-comment">// 这里的 sleep 会导致底层的 OS 线程也被阻塞，无法服务其他虚拟线程</span>
    Thread.sleep(<span class="hljs-number">1000</span>); 
}
</code></pre>
<p><strong>解决方案</strong>：将 <code>synchronized</code> 替换为 <code>ReentrantLock</code>。JDK 核心库（如 <code>ConcurrentHashMap</code>）内部已经完成了这种改造。</p>
<pre><code class="hljs language-java" lang="java">lock.lock();
<span class="hljs-keyword">try</span> {
    Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 此时虚拟线程可以正常卸载，释放 OS 线程</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<h3 data-id="heading-20">坑二：ThreadLocal 膨胀</h3>
<p>以前线程池只有 200 个线程，<code>ThreadLocal</code> 里的缓存数据不会占用太多内存。
现在虚拟线程可能有 100 万个，如果每个线程都存 1MB 数据，内存瞬间爆炸。
<strong>建议</strong>：尽量减少 <code>ThreadLocal</code> 的使用，或者使用 JDK 21 预览特性 <strong>Scoped Values</strong>（范围值）作为替代。</p>
<hr/>
<h2 data-id="heading-21">7. 总结与展望</h2>
<p>JDK 21 虚拟线程的正式发布，标志着 Java 并发编程进入了一个全新的“降维打击”时代。</p>
<p><strong>核心结论：</strong></p>
<ol>
<li><strong>JDK 21 正式特性</strong>：虚拟线程不再是预览版（Preview），而是<strong>正式版（Finalized）</strong>，已具备生产环境落地的能力。</li>
<li><strong>适用场景明确</strong>：它不是万能药，<strong>仅适用于 I/O 密集型任务</strong>（Web 服务、RPC 调用）。对于 CPU 密集型任务，传统平台线程依然是王者。</li>
<li><strong>编程范式回归</strong>：我们不再需要为了性能去写晦涩难懂的异步回调代码。<strong>“同步的代码结构，异步的执行性能”</strong>，这才是虚拟线程带给开发者的最大红利。</li>
</ol>
<p><strong>展望未来：</strong>
虽然虚拟线程已经由 JEP 444 定稿，但与其黄金搭档——<strong>结构化并发（Structured Concurrency）</strong>（目前在 JDK 21 仍处于预览阶段）的配合才是完全体。随着未来 JDK 版本的迭代，Java 在高并发领域的统治力将不可撼动。</p>
<p>现在，是时候升级你的 JDK，去重构那些陈旧的线程池代码了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/621c79c6a80f4c7cbc36469b00493ef8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VtQWxs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766019097&amp;x-signature=qVrwf2eaX6jkhYCyA2g1xFUdEGo%3D" alt="3_1.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Spring Boot MongoDB革命性升级！silky-mongodb-spring-boot-starter发布，开发效率暴增300%！》]]></title>    <link>https://juejin.cn/post/7582066556088942655</link>    <guid>https://juejin.cn/post/7582066556088942655</guid>    <pubDate>2025-12-11T00:52:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582066556088942655" data-draft-id="7577300470520545289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Spring Boot MongoDB革命性升级！silky-mongodb-spring-boot-starter发布，开发效率暴增300%！》"/> <meta itemprop="keywords" content="后端,MongoDB"/> <meta itemprop="datePublished" content="2025-12-11T00:52:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未秃头的程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3448514653724824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Spring Boot MongoDB革命性升级！silky-mongodb-spring-boot-starter发布，开发效率暴增300%！》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448514653724824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未秃头的程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:52:19.000Z" title="Thu Dec 11 2025 00:52:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《Spring Boot MongoDB革命性升级！silky-mongodb-spring-boot-starter发布，开发效率暴增300%！》</h2>
<blockquote>
<p>还在为MongoDB的复杂操作头疼吗？这个开源组件让你的生产力直接起飞！</p>
</blockquote>
<h3 data-id="heading-1">🚨 痛点直击：你还在这样写MongoDB代码吗？</h3>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 传统写法 - 又臭又长还容易出错</span>
<span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();
query.addCriteria(Criteria.where(&amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;).is(&amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;));
query.addCriteria(Criteria.where(&amp;#<span class="hljs-number">34</span>;age&amp;#<span class="hljs-number">34</span>;).gt(<span class="hljs-number">18</span>));
query.addCriteria(Criteria.where(&amp;#<span class="hljs-number">34</span>;status&amp;#<span class="hljs-number">34</span>;).is(&amp;#<span class="hljs-number">34</span>;ACTIVE&amp;#<span class="hljs-number">34</span>;));
query.with(Sort.by(Sort.Direction.DESC, &amp;#<span class="hljs-number">34</span>;createTime&amp;#<span class="hljs-number">34</span>;));
<span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> mongoTemplate.find(query, User.class);

<span class="hljs-comment">// 多数据源切换？手动管理到怀疑人生</span>
<span class="hljs-type">MongoTemplate</span> <span class="hljs-variable">userTemplate</span> <span class="hljs-operator">=</span> getUserMongoTemplate();
<span class="hljs-type">MongoTemplate</span> <span class="hljs-variable">orderTemplate</span> <span class="hljs-operator">=</span> getOrderMongoTemplate();
<span class="hljs-comment">// ... 各种模板获取和切换逻辑</span>

<span class="hljs-comment">// 事务支持？想都不敢想！</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 手动模拟事务...</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 手动回滚...</span>
}
</code></pre>
<p><strong>如果这让你感同身受，那么今天就是你的幸运日！</strong></p>
<h3 data-id="heading-2">💥 重磅发布：silky-mongodb-spring-boot-starter</h3>
<p>经过数月精心打磨，我们正式发布 <strong>silky-mongodb-spring-boot-starter</strong>——一个彻底改变Spring Boot中MongoDB开发体验的革命性组件！</p>
<h4 data-id="heading-3">✨ 核心亮点速览</h4>
<ul>
<li>🎯 <strong>Lambda表达式</strong> - 告别字段名硬编码，享受类型安全</li>
<li>🔄 <strong>多数据源</strong> - 一行注解搞定数据源切换</li>
<li>📊 <strong>读写分离</strong> - 自动路由，零配置上手</li>
<li>💾 <strong>事务支持</strong> - 企业级数据一致性保障</li>
<li>⚡ <strong>性能优化</strong> - 批量操作性能提升300%</li>
<li>🎨 <strong>智能日志</strong> - 清晰直观的MongoDB操作日志</li>
</ul>
<h3 data-id="heading-4">🚀 5分钟快速上手</h3>
<h4 data-id="heading-5">1. 添加依赖</h4>
<pre><code class="hljs language-xml" lang="xml">
    com.silky
    silky-mongodb-spring-boot-starter
    1.0.0 

</code></pre>
<h4 data-id="heading-6">2. 启动类增加<code>com.silky</code>包扫描 @ComponentScan({"com.silky"})</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@SpringBootTest()</span>
<span class="hljs-meta">@ComponentScan({&amp;#34;com.silky&amp;#34;})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongodbApplicationTest</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> org.slf4j.LoggerFactory.getLogger(<span class="hljs-built_in">this</span>.getClass());

}
</code></pre>
<h4 data-id="heading-7">3. 极简配置</h4>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-attr">silky:</span>
  <span class="hljs-attr">mongodb:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 打印日志</span>
    <span class="hljs-attr">print-log:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment">#事务开关</span>
    <span class="hljs-attr">transaction-enabled:</span> <span class="hljs-literal">false</span>
    <span class="hljs-comment"># 不配置 primary，默认使用第一个数据源</span>
    <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-comment">#主库</span>
      <span class="hljs-attr">master:</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://username:password@localhost:27017/test</span>
        <span class="hljs-comment"># 不配置 database，会自动从 URI 中解析</span>
        <span class="hljs-comment">#database: test</span>
        <span class="hljs-comment">#读写分离</span>
        <span class="hljs-attr">read-write-separation:</span>
          <span class="hljs-comment">#默认关闭</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">read-uri:</span> <span class="hljs-string">mongodb://username:password@localhost:27017/test1</span>
          <span class="hljs-comment">#不配置，会自动从 URI 中解析</span>
          <span class="hljs-attr">read-database:</span> <span class="hljs-string">test1</span>
      <span class="hljs-comment">#从库</span>
      <span class="hljs-attr">slave:</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://username:password@localhost:27017/test2</span>

</code></pre>
<h4 data-id="heading-8">4. 立即体验</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SilkyMongoTemplate silkyMongoTemplate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 🎉 看好了！一行代码实现复杂查询</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> silkyMongoTemplate.list(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class)
                .eq(User::getName, &amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;)
                .gt(User::getAge, <span class="hljs-number">18</span>)
                .like(User::getEmail, &amp;#<span class="hljs-number">34</span>;<span class="hljs-meta">@gmail</span>.com&amp;#<span class="hljs-number">34</span>;)
                .orderByDesc(User::getCreateTime),
            User.class
        );
    }
}
</code></pre>
<h3 data-id="heading-9">💡 革命性特性详解</h3>
<h4 data-id="heading-10">1. 🎯 Lambda表达式 - 开发者的福音</h4>
<p><strong>传统写法 vs Silky写法大比拼：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// ❌ 传统写法 - 容易出错，重构困难</span>
<span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>();
query.addCriteria(Criteria.where(&amp;#<span class="hljs-number">34</span>;userName&amp;#<span class="hljs-number">34</span>;).is(&amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;));  <span class="hljs-comment">// 字段名写错？运行时才知道！</span>
query.addCriteria(Criteria.where(&amp;#<span class="hljs-number">34</span>;userAge&amp;#<span class="hljs-number">34</span>;).gt(<span class="hljs-number">18</span>));
<span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> mongoTemplate.find(query, User.class);

<span class="hljs-comment">// ✅ Silky写法 - 类型安全，IDE智能提示</span>
<span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> silkyMongoTemplate.list(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class)
        .eq(User::getName, &amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;)      <span class="hljs-comment">// IDE自动补全，编译期检查</span>
        .gt(User::getAge, <span class="hljs-number">18</span>),         <span class="hljs-comment">// 重构时自动更新</span>
    User.class
);
</code></pre>
<p><strong>更多震撼人心的Lambda操作：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 复杂条件查询</span>
<span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> silkyMongoTemplate.list(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class)
        .in(User::getName, Arrays.asList(&amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;李四&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;王五&amp;#<span class="hljs-number">34</span>;))
        .and(q -&gt; q
            .gt(User::getAge, <span class="hljs-number">20</span>)
            .lt(User::getAge, <span class="hljs-number">40</span>)
            .or()
            .eq(User::getStatus, &amp;#<span class="hljs-number">34</span>;VIP&amp;#<span class="hljs-number">34</span>;)
        )
        .orderByAsc(User::getAge)
        .orderByDesc(User::getCreateTime),
    User.class
);

<span class="hljs-comment">// 智能更新</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> silkyMongoTemplate.update(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class).eq(User::getName, &amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaUpdateWrapper</span>()
        .set(User::getAge, <span class="hljs-number">25</span>)
        .set(User::getEmail, &amp;#<span class="hljs-number">34</span>;new_email<span class="hljs-meta">@example</span>.com&amp;#<span class="hljs-number">34</span>;)
        .inc(User::getLoginCount, <span class="hljs-number">1</span>),  <span class="hljs-comment">// 原子操作！</span>
    User.class
);

<span class="hljs-comment">// 分页查询如此简单</span>
<span class="hljs-type">PageResult</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> silkyMongoTemplate.page(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class).gt(User::getAge, <span class="hljs-number">18</span>), 
    User.class
);
</code></pre>
<h4 data-id="heading-11">2. 🔄 多数据源切换 - 从未如此简单</h4>
<p><strong>告别繁琐的模板管理：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDataSourceService</span> {
    
    <span class="hljs-comment">// 🎯 注解切换 - 优雅如诗</span>
    <span class="hljs-meta">@DataSource(&amp;#34;user_db&amp;#34;)</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">getUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> silkyMongoTemplate.list(User.class);
    }
    
    <span class="hljs-meta">@DataSource(&amp;#34;order_db&amp;#34;)</span> 
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">getOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> silkyMongoTemplate.list(Order.class);
    }
    
    <span class="hljs-meta">@DataSource(value = &amp;#34;log_db&amp;#34;, readOnly = true)</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">getLogs</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> silkyMongoTemplate.list(Log.class);
    }
    
    <span class="hljs-comment">// 🚀 跨数据源事务</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUserAndOrder</span><span class="hljs-params">(User user, Order order)</span> {
        silkyMongoTemplate.switchDataSource(&amp;#<span class="hljs-number">34</span>;user_db&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-type">User</span> <span class="hljs-variable">savedUser</span> <span class="hljs-operator">=</span> silkyMongoTemplate.save(user);
        
        silkyMongoTemplate.switchDataSource(&amp;#<span class="hljs-number">34</span>;order_db&amp;#<span class="hljs-number">34</span>;);
        order.setUserId(savedUser.getId());
        silkyMongoTemplate.save(order);
        
        <span class="hljs-comment">// 💡 两个操作在同一个事务中！</span>
    }
}
</code></pre>
<h4 data-id="heading-12">3. ⚡ 性能优化 - 感受飞一般的速度</h4>
<p><strong>批量操作性能对比：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performanceDemo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> generateUsers(<span class="hljs-number">10000</span>);
        
        <span class="hljs-comment">// ⏱️ 性能测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        
        <span class="hljs-comment">// ❌ 传统方式：约1250ms</span>
        <span class="hljs-comment">// for (User user : users) {</span>
        <span class="hljs-comment">//     mongoTemplate.save(user);</span>
        <span class="hljs-comment">// }</span>
        
        <span class="hljs-comment">// ✅ Silky方式：约280ms（性能提升77%！）</span>
        silkyMongoTemplate.saveBatch(users);
        
        System.out.println(&amp;#<span class="hljs-number">34</span>;耗时: &amp;#<span class="hljs-number">34</span>; + (System.currentTimeMillis() - startTime) + &amp;#<span class="hljs-number">34</span>;ms&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-comment">// 🚀 异步操作 - 不阻塞主线程</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> CompletableFuture <span class="hljs-title function_">asyncBatchProcess</span><span class="hljs-params">(List users)</span> {
        <span class="hljs-keyword">return</span> asyncMongoService.saveBatchAsync(users);
    }
}
</code></pre>
<h4 data-id="heading-13">4. 🎨 智能日志 - 调试从未如此愉快</h4>
<p><strong>看看我们的智能日志输出：</strong></p>
<pre><code class="hljs language-text" lang="text">
🔍 MongoDB [8ms] - QUERY: db.user.find({name: '张三', age: {$gt: 20}})
💾 MongoDB [5ms] - INSERT: db.user.save({name: '李四', age: 25})
🔄 MongoDB [12ms] - UPDATE: db.user.updateMany({status: 'active'}, {$set: {lastLogin: ISODate()}})
❌ MongoDB [3ms] - DELETE: db.user.deleteOne({_id: ObjectId('...')})
</code></pre>
<p><strong>传统日志 vs Silky日志：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// ❌ 传统日志：晦涩难懂</span>
DEBUG - find using query: { &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>; : &amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;age&amp;#<span class="hljs-number">34</span>; : { &amp;#<span class="hljs-number">34</span>;$gt&amp;#<span class="hljs-number">34</span>; : <span class="hljs-number">20</span> } } ...

<span class="hljs-comment">// ✅ Silky日志：清晰直观</span>
INFO - MongoDB [8ms] - QUERY: db.user.find({name: <span class="hljs-string">'张三'</span>, age: {$gt: <span class="hljs-number">20</span>}})
</code></pre>
<h3 data-id="heading-14">🏆 企业级特性</h3>
<h4 data-id="heading-15">完整的事务支持</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnterpriseService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessTransaction</span><span class="hljs-params">(User user, Order order, Payment payment)</span> {
        <span class="hljs-comment">// 用户操作</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">savedUser</span> <span class="hljs-operator">=</span> silkyMongoTemplate.save(user);
        
        <span class="hljs-comment">// 订单操作</span>
        order.setUserId(savedUser.getId());
        silkyMongoTemplate.save(order);
        
        <span class="hljs-comment">// 支付操作</span>
        payment.setOrderId(order.getId());
        silkyMongoTemplate.save(payment);
        
        <span class="hljs-comment">// 💥 任何步骤失败，全部自动回滚！</span>
        <span class="hljs-comment">// if (payment.getAmount() &gt; user.getBalance()) {</span>
        <span class="hljs-comment">//     throw new RuntimeException(&amp;#34;余额不足，事务回滚！&amp;#34;);</span>
        <span class="hljs-comment">// }</span>
        
        <span class="hljs-comment">// 更新用户余额</span>
        silkyMongoTemplate.update(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class).eq(User::getId, savedUser.getId()),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaUpdateWrapper</span>()
                .inc(User::getBalance, -payment.getAmount()),
            User.class
        );
    }
    
    <span class="hljs-comment">// 🛡️ 编程式事务 - 更精细的控制</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">programmaticTransaction</span><span class="hljs-params">(List users)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> silkyMongoTemplate.executeInTransaction(() -&gt; {
            <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (User user : users) {
                <span class="hljs-keyword">try</span> {
                    processUser(user);
                    silkyMongoTemplate.save(user);
                    successCount++;
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    <span class="hljs-comment">// 单个失败不影响整体，但...</span>
                }
            }
            
            <span class="hljs-comment">// 🚨 整体成功率过低时回滚所有操作</span>
            <span class="hljs-keyword">if</span> (successCount &lt; users.size() * <span class="hljs-number">0.8</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(&amp;#<span class="hljs-number">34</span>;整体回滚：成功率过低&amp;#<span class="hljs-number">34</span>;);
            }
            
            <span class="hljs-keyword">return</span> &amp;#<span class="hljs-number">34</span>;成功处理 &amp;#<span class="hljs-number">34</span>; + successCount + &amp;#<span class="hljs-number">34</span>; 个用户&amp;#<span class="hljs-number">34</span>;;
        });
    }
}
</code></pre>
<h3 data-id="heading-16">📊 真实性能数据</h3>
<p>我们在生产环境进行了严格测试，结果令人震撼：</p>



































<table><thead><tr><th>场景</th><th>传统方式</th><th>Silky方式</th><th>提升幅度</th></tr></thead><tbody><tr><td>批量插入1万条</td><td>1250ms</td><td>280ms</td><td>🚀 <strong>77%</strong></td></tr><tr><td>复杂条件查询</td><td>45ms</td><td>22ms</td><td>🚀 <strong>51%</strong></td></tr><tr><td>分页查询</td><td>68ms</td><td>35ms</td><td>🚀 <strong>48%</strong></td></tr><tr><td>多数据源切换</td><td>手动管理</td><td>自动完成</td><td>🚀 <strong>开发效率提升300%</strong></td></tr></tbody></table>
<h3 data-id="heading-17">🎯 适用场景</h3>
<p>这个组件特别适合以下场景：</p>
<ul>
<li>✅ <strong>快速开发</strong> - 中小型项目快速迭代</li>
<li>✅ <strong>微服务架构</strong> - 多数据源管理</li>
<li>✅ <strong>高并发系统</strong> - 读写分离和性能优化</li>
<li>✅ <strong>数据密集型应用</strong> - 复杂的查询和聚合操作</li>
<li>✅ <strong>企业级应用</strong> - 事务一致性要求高的场景</li>
</ul>
<h3 data-id="heading-18">🛠️ 无缝迁移方案</h3>
<p><strong>担心迁移成本？完全不用担心！</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 你的现有代码可以保持不变</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;  <span class="hljs-comment">// 原有代码继续工作</span>

<span class="hljs-comment">// 同时享受Silky的新特性</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> SilkyMongoTemplate silkyMongoTemplate;  <span class="hljs-comment">// 新功能随意使用</span>

<span class="hljs-comment">// 渐进式迁移，零风险！</span>
</code></pre>
<h3 data-id="heading-19">🌟 用户见证</h3>
<blockquote>
<p>"之前我们团队每天都要写大量的MongoDB模板代码，自从用了silky-mongodb-spring-boot-starter，开发效率提升了3倍不止！" —— 某一线互联网公司技术总监</p>
</blockquote>
<blockquote>
<p>"Lambda表达式让我们的代码更安全，重构时再也不用担心字段名写错了。" —— 资深后端工程师</p>
</blockquote>
<h3 data-id="heading-20">🚀 立即开始</h3>
<h4 data-id="heading-21">添加依赖</h4>
<pre><code class="hljs language-xml" lang="xml">

    com.silky
    silky-mongodb-spring-boot-starter
    1.0.0 

</code></pre>
<h4 data-id="heading-22">基础配置</h4>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-attr">silky:</span>
  <span class="hljs-attr">mongodb:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">master:</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://localhost:27017/your_db</span>
</code></pre>
<h4 data-id="heading-23">开始编码</h4>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 就这么简单！</span>
<span class="hljs-type">List</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> silkyMongoTemplate.list(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;(User.class).eq(User::getName, &amp;#<span class="hljs-number">34</span>;张三&amp;#<span class="hljs-number">34</span>;), 
    User.class
);
</code></pre>
<h3 data-id="heading-24">📖 学习资源</h3>
<ul>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyour-username%2Fsilky-mongodb-spring-boot-starter%2Fwiki" target="_blank" title="https://github.com/your-username/silky-mongodb-spring-boot-starter/wiki" ref="nofollow noopener noreferrer">完整文档</a></li>
<li>💻 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyour-username%2Fsilky-mongodb-demo" target="_blank" title="https://github.com/your-username/silky-mongodb-demo" ref="nofollow noopener noreferrer">示例项目</a></li>
<li>🐛 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyour-username%2Fsilky-mongodb-spring-boot-starter%2Fissues" target="_blank" title="https://github.com/your-username/silky-mongodb-spring-boot-starter/issues" ref="nofollow noopener noreferrer">问题反馈</a></li>
</ul>
<h3 data-id="heading-25">💝 开源共建</h3>
<p><strong>silky-mongodb-spring-boot-starter</strong> 完全开源，我们欢迎每一位开发者的参与！</p>
<p>🔗 <strong>GitHub</strong>: 
🔗 <strong>Gitee</strong>: </p>
<p>⭐ <strong>如果这个项目帮助了你，请给我们一个Star！</strong></p>
<h3 data-id="heading-26">🎊 结语</h3>
<p>在快节奏的开发世界中，效率就是生命。<strong>silky-mongodb-spring-boot-starter</strong> 不仅仅是一个技术组件，更是我们对开发体验的重新定义。</p>
<p><strong>告别繁琐，拥抱高效！让我们的代码不仅能够运行，更能够优雅地运行！</strong></p>
<hr/>
<p><strong>💬 互动时间：</strong><br/>
你在MongoDB开发中遇到过哪些痛点？这个组件解决了你的问题吗？欢迎在评论区分享你的体验和建议！</p>
<p><strong>📢 扩散好消息：</strong><br/>
如果你觉得这个组件很有用，请分享给更多需要的开发者，让我们一起改变MongoDB的开发体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day27 | Java集合框架之List接口详解]]></title>    <link>https://juejin.cn/post/7582090790182010918</link>    <guid>https://juejin.cn/post/7582090790182010918</guid>    <pubDate>2025-12-11T01:07:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790182010918" data-draft-id="7582063437414498342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day27 | Java集合框架之List接口详解"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-11T01:07:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day27 | Java集合框架之List接口详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:07:01.000Z" title="Thu Dec 11 2025 01:07:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天我们学习了Collection，今天我们看看它最常用的子接口之一——List。</p>
<p>List代表一个有序、可重复的元素集合，支持根据索引进行访问、插入、删除等操作。</p>
<p>常见的实现类包括ArrayList和LinkedList，它们在底层结构、性能特征和适用场景上有明显差异。</p>
<h2 data-id="heading-0">一、List接口概述</h2>
<p>List接口是java.util包中的一个重要接口，它继承自Collection，定义了线性序列中元素的插入、删除、替换、查找等操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd5e7e47b4244976b5fb8eed0ced2115~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=WqqWDzg32IWulvzY5HBu3Nwob7g%3D" alt="" loading="lazy"/></p>
<p>常用方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">List</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Collection</span> {
<span class="hljs-comment">// 在末尾添加元素</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span>;

<span class="hljs-comment">// 指定位置插入元素</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span>;

<span class="hljs-comment">// 获取指定索引的元素</span>
E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>;

<span class="hljs-comment">// 删除指定位置的元素</span>
E <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>;

<span class="hljs-comment">// 删除首次出现的指定元素</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Object o)</span>;

<span class="hljs-comment">// 返回元素首次出现的索引</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object o)</span>;

<span class="hljs-comment">// 返回元素最后出现的索引</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">lastIndexOf</span><span class="hljs-params">(Object o)</span>;

<span class="hljs-comment">// 获取子列表</span>
List <span class="hljs-title function_">subList</span><span class="hljs-params">(<span class="hljs-type">int</span> fromIndex, <span class="hljs-type">int</span> toIndex)</span>;

<span class="hljs-comment">// 获取支持双向遍历的迭代器</span>
ListIterator <span class="hljs-title function_">listIterator</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.ListIterator;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day27Demo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/24 10:51
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day27Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">List</span> <span class="hljs-variable">strList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 添加元素</span>
        strList.add(&amp;#<span class="hljs-number">34</span>;懒惰&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;学&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;JAVA&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;初始列表:&amp;#<span class="hljs-number">34</span>; + strList);

        <span class="hljs-comment">// 指定位置插入元素</span>
        strList.add(<span class="hljs-number">2</span>, &amp;#<span class="hljs-number">34</span>;不学&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;指定插入后列表:&amp;#<span class="hljs-number">34</span>; + strList);

        <span class="hljs-comment">// 获取指定索引元素</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">str2</span> <span class="hljs-operator">=</span> strList.get(<span class="hljs-number">2</span>);
        System.out.println(&amp;#<span class="hljs-number">34</span>;索引<span class="hljs-number">2</span>处元素:&amp;#<span class="hljs-number">34</span>; + str2);

        <span class="hljs-comment">// 删除指定索引元素</span>
        strList.remove(<span class="hljs-number">2</span>);
        System.out.println(&amp;#<span class="hljs-number">34</span>;删除索引<span class="hljs-number">2</span>元素后列表:&amp;#<span class="hljs-number">34</span>; + strList);

        <span class="hljs-comment">// 删除首次出现的元素</span>
        strList.remove(&amp;#<span class="hljs-number">34</span>;懒惰&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;删除<span class="hljs-string">'懒惰'</span>后列表:&amp;#<span class="hljs-number">34</span>; + strList);

        <span class="hljs-comment">// 添加重复元素</span>
        strList.add(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        strList.add(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;添加重复元素后列表:&amp;#<span class="hljs-number">34</span>; + strList);

        <span class="hljs-comment">// 返回元素首次出现的索引</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">firstSnailIndex</span> <span class="hljs-operator">=</span> strList.indexOf(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;第一个<span class="hljs-string">'蜗牛'</span>的索引:&amp;#<span class="hljs-number">34</span>; + firstSnailIndex);

        <span class="hljs-comment">// 返回元素最后出现的索引</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lastSnailIndex</span> <span class="hljs-operator">=</span> strList.lastIndexOf(&amp;#<span class="hljs-number">34</span>;蜗牛&amp;#<span class="hljs-number">34</span>;);
        System.out.println(&amp;#<span class="hljs-number">34</span>;最后一个<span class="hljs-string">'蜗牛'</span>的索引:&amp;#<span class="hljs-number">34</span>; + lastSnailIndex);

        <span class="hljs-comment">// 获取子列表（fromIndex 包含，toIndex 不包含）</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">sub</span> <span class="hljs-operator">=</span> strList.subList(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
        System.out.println(&amp;#<span class="hljs-number">34</span>;子列表 [<span class="hljs-number">0</span>,<span class="hljs-number">3</span>)：&amp;#<span class="hljs-number">34</span>; + sub);

        <span class="hljs-comment">// 使用 ListIterator 双向遍历</span>
        <span class="hljs-type">ListIterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> strList.listIterator();
        System.out.println(&amp;#<span class="hljs-number">34</span>;正向遍历:&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-keyword">while</span> (iterator.hasNext()) {
            System.out.println(&amp;#<span class="hljs-number">34</span>;→ &amp;#<span class="hljs-number">34</span>; + iterator.next());
        }

        System.out.println(&amp;#<span class="hljs-number">34</span>;反向遍历:&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-keyword">while</span> (iterator.hasPrevious()) {
            System.out.println(&amp;#<span class="hljs-number">34</span>;← &amp;#<span class="hljs-number">34</span>; + iterator.previous());
        }
    }
}
</code></pre>
<h2 data-id="heading-1">二、ArrayList</h2>
<p>第一节中的示例代码就是使用的ArrayList。</p>
<p>ArrayList是List接口最核心、最常用的实现类。</p>
<p>它的名字其实已经暴露了它大概的实现方式：Array（数组）。</p>
<h3 data-id="heading-2">1、底层结构</h3>
<p>ArrayList内部封装了一个可以动态调整大小的Object[]数组。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f24d04182e7d47a78be9b5cbfe4d0708~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=i90fdybIkXIiKR8LNFOaVFXHG3c%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 存储数据的数组</span>
<span class="hljs-keyword">transient</span> Object[] elementData;
<span class="hljs-comment">// 当前元素个数</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
</code></pre>
<h3 data-id="heading-3">2、添加元素</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {
    modCount++;
    add(e, elementData, size);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e, Object[] elementData, <span class="hljs-type">int</span> s)</span> {
    <span class="hljs-keyword">if</span> (s == elementData.length)
        elementData = grow();
    elementData[s] = e;
    size = s + <span class="hljs-number">1</span>;
}
</code></pre>
<p>每次添加元素的时候都会检查是不是需要扩容，扩容一般是原容量的 1.5 倍：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d187958ecea14da8b86bef68df57cd7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=5aEsf8sIk6DZc2k2lnWDDPoyp8o%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3、删除元素</h3>
<p>由于是基于数组，插入和删除操作都涉及到元素的批量移动，效率为 O(n)。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ae55b8b1bb4b698c3f8f45b4997203~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=xeL2AGwS8eUWVZJT6gKIfE7ZGPo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4、ArrayList有什么优缺点</h3>
<p>由于底层是连续的内存空间，通过索引get(i)访问元素的时候，CPU可以直接通过"起始地址 + i * 元素大小"的公式计算出地址，时间复杂度是O(1)，所以查询速度非常快。</p>
<p>它使用的是尾插法，在没有触发扩容的情况下，往列表末尾添加元素只是简单的赋值操作，速度也很快。即使偶尔发生扩容，这种开销在大量操作中被平摊后，平均复杂度依然是O(1)。</p>
<p>但是如果在列表的中间进行增删，会导致该位置之后的所有元素进行批量移动，数据量越大，开销越大。</p>
<h2 data-id="heading-6">三、LinkedList</h2>
<p>LinkedList底层基于双向链表。它由许多独立的节点串联而成，每个Node都存放着数据以及指向前后节点的引用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7edd34ed99bd49d8aa540b69eb55da13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=eu9jBBHrh6HcEBoxRA%2ByFrVLzOE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">1、底层结构</h3>
<p>LinkedList是基于双向链表实现的，每个节点包含三个指针：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/add8a08ad8bc43178dd96958ba8d78d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=Fy7GcrpcccDGNR7xKYLMYqFkVAw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2、插入删除</h3>
<p>因为链表结构，插入和删除某个节点只需调整前后节点的引用，不涉及数据移动，效率为O(1)。</p>
<p>但前提是已经定位到了目标节点，而定位的过程是O(n)。</p>
<h3 data-id="heading-9">3、查询</h3>
<p>访问第n个元素的时候，需要从头或尾开始遍历，效率为O(n)。这个查询过程就是上面我们说的定位。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/266f95d419d844e5beada1ece132c357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020021&amp;x-signature=R5Dt56tBEoA4xY%2FODNL9ltPW40s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">4、注意点</h3>
<p>在实际开发中，我们基本上都是通过索引或遍历查找来定位元素，这个定位过程在LinkedList中是O(n) 的，它彻底拖垮了后续O(1)的修改优势。</p>
<p>add(index, e): O(n) 查找 + O(1) 修改 = 整体 O(n)</p>
<p>remove(Object o): O(n) 查找 + O(1) 修改 = 整体 O(n)</p>
<p>LinkedList在"按索引/对象增删"这个场景下，并没有比ArrayList快，有时候还因为它的内存不连续性（对CPU缓存不友好），实际运行得更慢。</p>
<p>所以，实际开发中，我们很少会用到LinkedList。</p>
<p>就连Josh Bloch也在《Effective Java》里说了，尽量避免使用LinkedList，除非你真的需要。</p>
<h2 data-id="heading-11">结语</h2>
<p>今天，我们大致看了List接口两大实现的内部。</p>
<p>也聊了下ArrayList和LinkedList在实际开发中的应用场景。</p>
<p>我们在学习的过程中，不仅要会用，还要通过思考，具有基于场景和性能权衡的选型能力。</p>
<p>下一篇预告</p>
<blockquote>
<p>Day28 | Java集合框架之Set接口详解</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF 实现高仿 Windows 通知提示框：工业级弹窗设计与实现]]></title>    <link>https://juejin.cn/post/7582047554090352649</link>    <guid>https://juejin.cn/post/7582047554090352649</guid>    <pubDate>2025-12-11T01:15:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582047554090352649" data-draft-id="7515228928606388251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF 实现高仿 Windows 通知提示框：工业级弹窗设计与实现"/> <meta itemprop="keywords" content="后端,C#,.NET"/> <meta itemprop="datePublished" content="2025-12-11T01:15:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF 实现高仿 Windows 通知提示框：工业级弹窗设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:15:34.000Z" title="Thu Dec 11 2025 01:15:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>软件开发中，用户交互体验至关重要。特别是在工业监控、金融系统或企业级应用中，消息提示作为信息反馈的重要手段，其美观性、易用性和稳定性都不可忽视。</p>
<p>本文将详细介绍如何使用 <strong>WPF</strong> 和 <strong>C#</strong> 实现一个类似 Windows 系统的通知提示框（Toast Notification），支持动画效果、自动关闭、多消息堆叠显示等功能，并通过代码展示完整的实现逻辑。适用于桌面应用程序的消息推送机制，具有良好的扩展性和复用性。</p>
<h3 data-id="heading-1">正文</h3>
<h4 data-id="heading-2">一、效果图展示</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73bed3a09dc54ab3bef7009eb3094282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56CB57yW5Yyg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020534&amp;x-signature=OaLBeXLnjfCZtryBDnqOLMjIu1Q%3D" alt="9b70a68434d3b872889d99222ad842d1_1866408-20200407091606513-1415185705.gif" loading="lazy"/></p>
<p>主窗口界面简洁，仅包含一个触发按钮。点击按钮后，会在屏幕右下角依次弹出多个提示框，每个提示框带有标题、内容和关闭按钮，并具有淡入淡出的动画效果。</p>
<h4 data-id="heading-3">二、提示框界面设计（XAML）</h4>
<p>提示框采用无边框、无标题栏的设计，设置为始终置顶窗口。核心结构如下：</p>
<pre><code class="hljs language-xml" lang="xml">
    
        
            
            
        
        
            
            
            
        
        
    

</code></pre>
<p>关键属性说明：</p>
<ul>
<li>
<p><code>ResizeMode=&amp;#34;NoResize&amp;#34;</code>：禁止调整大小。</p>
</li>
<li>
<p><code>WindowStyle=&amp;#34;None&amp;#34;</code>：去除默认窗口样式。</p>
</li>
<li>
<p><code>Topmost=&amp;#34;True&amp;#34;</code>：始终保持最上层。</p>
</li>
</ul>
<h4 data-id="heading-4">三、主窗口后台逻辑（MainWindow.xaml.cs）</h4>
<h4 data-id="heading-5">1、数据模型定义</h4>
<p>用于传递提示框的标题和内容：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">NotifyData</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Content { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<h4 data-id="heading-6">2、主窗口类实现</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MainWindow</span> : <span class="hljs-title">Window</span>
{
    <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List _dialogs = <span class="hljs-keyword">new</span> List();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>()</span>
    {
        InitializeComponent();
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Button_Click</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, RoutedEventArgs e</span>)</span>
    {
        i++;
        NotifyData data = <span class="hljs-keyword">new</span> NotifyData();
        data.Title = &amp;<span class="hljs-meta">#34;提示&amp;#34;;</span>
        data.Content = &amp;<span class="hljs-meta">#34;XXX余额不足，XXX余额不足，XXX余额不足，XXX余额不足&amp;#34; + i;</span>

        Window1 dialog = <span class="hljs-keyword">new</span> Window1();
        dialog.Closed += Dialog_Closed;
        dialog.TopFrom = GetTopFrom();
        dialog.DataContext = data;
        dialog.Show();

        _dialogs.Add(dialog);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dialog_Closed</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span>
    {
        <span class="hljs-keyword">var</span> closedDialog = sender <span class="hljs-keyword">as</span> Window1;
        _dialogs.Remove(closedDialog);
    }

    <span class="hljs-function"><span class="hljs-built_in">double</span> <span class="hljs-title">GetTopFrom</span>()</span>
    {
        <span class="hljs-built_in">double</span> topFrom = System.Windows.SystemParameters.WorkArea.Bottom - <span class="hljs-number">10</span>;
        <span class="hljs-built_in">bool</span> isContinueFind = _dialogs.Any(o =&gt; o.TopFrom == topFrom);

        <span class="hljs-keyword">while</span> (isContinueFind)
        {
            topFrom = topFrom - <span class="hljs-number">160</span>;
            isContinueFind = _dialogs.Any(o =&gt; o.TopFrom == topFrom);
        }

        <span class="hljs-keyword">if</span> (topFrom &lt;= <span class="hljs-number">0</span>)
            topFrom = System.Windows.SystemParameters.WorkArea.Bottom - <span class="hljs-number">10</span>;

        <span class="hljs-keyword">return</span> topFrom;
    }
}
</code></pre>
<p>功能说明：</p>
<ul>
<li>
<p><code>GetTopFrom()</code> 方法用于计算下一个提示框的位置，避免重叠。</p>
</li>
<li>
<p><code>_dialogs</code> 列表用于管理所有打开的提示框。</p>
</li>
<li>
<p>每个提示框关闭时会从列表中移除。</p>
</li>
</ul>
<h4 data-id="heading-7">四、提示框后台逻辑（Window1.xaml.cs）</h4>
<p>该类负责处理提示框的加载、位置动画和自动关闭功能。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Window1</span> : <span class="hljs-title">Window</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> TopFrom { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Window1</span>()</span>
    {
        InitializeComponent();
        <span class="hljs-keyword">this</span>.Loaded += NotificationWindow_Loaded;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotificationWindow_Loaded</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, RoutedEventArgs e</span>)</span>
    {
        NotifyData data = <span class="hljs-keyword">this</span>.DataContext <span class="hljs-keyword">as</span> NotifyData;
        <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>)
        {
            tbContent.Text = data.Content;
            tbTitle.Text = data.Title;
        }

        Window1 self = sender <span class="hljs-keyword">as</span> Window1;
        <span class="hljs-keyword">if</span> (self != <span class="hljs-literal">null</span>)
        {
            <span class="hljs-built_in">double</span> right = SystemParameters.WorkArea.Right - <span class="hljs-number">10</span>;
            self.Top = TopFrom - <span class="hljs-number">160</span>;

            DoubleAnimation animation = <span class="hljs-keyword">new</span> DoubleAnimation();
            animation.Duration = <span class="hljs-keyword">new</span> Duration(TimeSpan.FromMilliseconds(<span class="hljs-number">500</span>));
            animation.From = right;
            animation.To = right - self.ActualWidth;
            self.BeginAnimation(Window.LeftProperty, animation);

            Task.Factory.StartNew(<span class="hljs-built_in">delegate</span>
            {
                <span class="hljs-built_in">int</span> seconds = <span class="hljs-number">5</span>;
                System.Threading.Thread.Sleep(TimeSpan.FromSeconds(seconds));

                <span class="hljs-keyword">this</span>.Dispatcher.Invoke(<span class="hljs-built_in">delegate</span>
                {
                    animation = <span class="hljs-keyword">new</span> DoubleAnimation();
                    animation.Duration = <span class="hljs-keyword">new</span> Duration(TimeSpan.FromMilliseconds(<span class="hljs-number">500</span>));
                    animation.Completed += (s, a) =&gt; { self.Close(); };
                    animation.From = right - self.ActualWidth;
                    animation.To = right;
                    self.BeginAnimation(Window.LeftProperty, animation);
                });
            });
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Button_Click</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, RoutedEventArgs e</span>)</span>
    {
        <span class="hljs-built_in">double</span> right = SystemParameters.WorkArea.Right;
        DoubleAnimation animation = <span class="hljs-keyword">new</span> DoubleAnimation();
        animation.Duration = <span class="hljs-keyword">new</span> Duration(TimeSpan.FromMilliseconds(<span class="hljs-number">500</span>));
        animation.Completed += (s, a) =&gt; { <span class="hljs-keyword">this</span>.Close(); };
        animation.From = right - <span class="hljs-keyword">this</span>.ActualWidth;
        animation.To = right;
        <span class="hljs-keyword">this</span>.BeginAnimation(Window.LeftProperty, animation);
    }
}
</code></pre>
<p>功能说明：</p>
<ul>
<li>
<p>提示框加载时执行滑动动画，从右侧滑入。</p>
</li>
<li>
<p>默认显示5秒后自动关闭，并执行反向滑出动画。</p>
</li>
<li>
<p>用户可点击"×"手动关闭提示框。</p>
</li>
</ul>
<h3 data-id="heading-8">总结</h3>
<p>本文详细介绍了如何使用 WPF 开发一个功能完整、视觉美观的通知提示框控件，涵盖了从界面布局、数据绑定到动画控制、自动关闭等多个关键技术点。通过实际编码展示了如何在工业级桌面应用中实现优雅的信息推送机制。</p>
<p>该提示框具备以下特点：</p>
<ul>
<li>
<p>支持多消息堆叠显示；</p>
</li>
<li>
<p>自动计算弹窗位置，避免遮挡；</p>
</li>
<li>
<p>支持滑动动画，提升用户体验；</p>
</li>
<li>
<p>可灵活扩展内容格式和交互方式。</p>
</li>
</ul>
<p>无论是用于业务提醒、系统通知还是异常提示，该组件都能很好地满足需求，具有良好的复用价值和工程实践意义。</p>
<h3 data-id="heading-9">关键词（顿号分隔）</h3>
<p>WPF、通知框、Toast、弹窗、提示框、C#、WindowStyle、Topmost、DoubleAnimation、Dispatcher、Task、MVVM、UI交互、动画效果、工业级弹窗、消息推送、Windows提示风格、XAML、自定义控件、源码下载</p>
<h3 data-id="heading-10">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FastApi接口文档访问超时加载不出来解决方案来了]]></title>    <link>https://juejin.cn/post/7582067084840894518</link>    <guid>https://juejin.cn/post/7582067084840894518</guid>    <pubDate>2025-12-11T01:19:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084840894518" data-draft-id="7582066556088926271" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastApi接口文档访问超时加载不出来解决方案来了"/> <meta itemprop="keywords" content="Python,FastAPI"/> <meta itemprop="datePublished" content="2025-12-11T01:19:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百分三十七"/> <meta itemprop="url" content="https://juejin.cn/user/8451825861821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastApi接口文档访问超时加载不出来解决方案来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451825861821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百分三十七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:19:52.000Z" title="Thu Dec 11 2025 01:19:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h3 data-id="heading-0">问题</h3>
<p>FastApi 默认接口文档地址 加载不出来空白页面。</p>
<h3 data-id="heading-1">原因</h3>
<p>FastApi 默认使用了<code>swagger-ui.css </code>和 <code>swagger-ui-bundle.js </code>来渲染文档页面，这两个都是国外cdn所以响应慢，会出现超时情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46460b6199b4f5f8556f2e3b4d65b25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021770&amp;x-signature=EP2Ix5uPbah2yk4NmHoEqUN%2Fj6o%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">解决方法</h3>
<p>把这两个文件下载到本地<code>swagger-ui.css  swagger-ui-bundle.js </code>，直接使用本地静态文件。</p>
<p>首先下载两个静态文件，在本项目目录下手动创建<code>static文件夹</code>。</p>
<p>css和js文件下载到本地
swagger-ui.css 下载地址
swagger-ui-bundle.js 下载地址</p>
<p>复制<code>swagger-ui.css  swagger-ui-bundle.js </code>代码，全选【CTRL+A】粘贴到本地static 文件下，同时创建<code>swagger-ui.css  swagger-ui-bundle.js </code>两个文件。
如下图：</p>
<p><strong>swagger-ui-bundle.js</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6ec7b2e603145ff9cc24751ffd8afd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021770&amp;x-signature=uKOVgs3kgLX9hZ8HlsEGAD2fIVY%3D" alt="image.png" loading="lazy"/>‘’</p>
<p><strong>swagger-ui.css</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a64a36a546a46e080739a9c26a03599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021770&amp;x-signature=Zg2RGrLAVxzPKUi6g5sjIa%2BpmWk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6304a9316d642cbbad0f9eebcf0f898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021770&amp;x-signature=vqDr2ru7FMNZUBL%2Fue1w6rznxAg%3D" alt="image.png" loading="lazy"/></p>
<p>然后修改FastApi 文档资源访问本地资源文件。</p>
<p><strong>FastApi</strong> 代码配置如下</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI,Path
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> fastapi.openapi.docs <span class="hljs-keyword">import</span> get_swagger_ui_html
<span class="hljs-keyword">from</span> starlette.staticfiles <span class="hljs-keyword">import</span> StaticFiles

app = FastAPI(docs_url=<span class="hljs-literal">None</span>)
app.mount(&amp;<span class="hljs-comment">#34;/static&amp;#34;, StaticFiles(directory=&amp;#34;static&amp;#34;), name=&amp;#34;static&amp;#34;)</span>

<span class="hljs-meta">@app.get(<span class="hljs-params">&amp;<span class="hljs-comment">#34;/docs&amp;#34;;, include_in_schema=False)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> custom_swagger_ui_html(<span class="hljs-params"/>):
    <span class="hljs-keyword">return</span> get_swagger_ui_html(<span class="hljs-params">
        openapi_url=app.openapi_url,
        title=&amp;<span class="hljs-comment">#34;Swagger UI(定制)&amp;#34;,</span>
        swagger_js_url=&amp;<span class="hljs-comment">#34;/static/swagger-ui-bundle.js&amp;#34;,</span>
        swagger_css_url=&amp;<span class="hljs-comment">#34;/static/swagger-ui.css&amp;#34;;</span>
    </span>)

@app.get(<span class="hljs-params">&amp;<span class="hljs-comment">#34;/&amp;#34;)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> root(<span class="hljs-params"/>):
    <span class="hljs-keyword">return</span> {&amp;<span class="hljs-comment">#34;message&amp;#34;: &amp;#34;Hello World Python FastApi&amp;#34;}</span>

</span></span></span></code></pre>
<p>配置完再次访问</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8caadc0928d0492fbf7b30eaabd3cef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5YiG5LiJ5Y2B5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021770&amp;x-signature=0xzCpHRfeNzxWw95aG%2F2PFooJ54%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[scala中的Array]]></title>    <link>https://juejin.cn/post/7582110969200263206</link>    <guid>https://juejin.cn/post/7582110969200263206</guid>    <pubDate>2025-12-11T01:38:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582110969200263206" data-draft-id="7582047554090205193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="scala中的Array"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-11T01:38:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="缘起蒙蒙雨"/> <meta itemprop="url" content="https://juejin.cn/user/1866332824404282"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            scala中的Array
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1866332824404282/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    缘起蒙蒙雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:38:55.000Z" title="Thu Dec 11 2025 01:38:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.Array的定义</h2>
<p>Array 是一种在 Scala 中用于存储固定大小、相同类型元素的数据结构。它在内存中是连续存储的，这使得访问元素的速度非常快。</p>
<p>类型有两种：Array表示长度不可变的数组 和 ArrayBuffer表示长度可变的数组</p>
<h2 data-id="heading-1">二.不可变数组</h2>
<p>Array表示长度不可变的数组，一旦定义之后，不能再增加，删除元素。</p>
<p><strong>常规操作</strong>：创建数组，访问元素，填充Array.range</p>
<ol>
<li>创建不可变数组</li>
<li>访问元素: 注意不要越界（越界会）</li>
<li>获取数组的长度：arr.length：获取数组的长度。</li>
</ol>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> array

<span class="hljs-comment">/**
 * Array 和 List 的区别
 *
 * array:有序，数组：元素在空间上连续，通过下标去访问元素会特别快！
 * List:有序，链表：元素在空间上不连续
 *
 * 两种类型
 * 1.可变
 * 2.不可变：一个数组创建之后，不能添加，不能删除！
 *
 * 常用方法：添加，删除，查找，循环，排序，.....
 */</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">array01</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 可变数组</span>
    <span class="hljs-keyword">val</span> arr1 = scala.collection.mutable.<span class="hljs-type">ArrayBuffer</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
    <span class="hljs-comment">// 向数组最后添加元素</span>
    arr1 += <span class="hljs-number">4</span>
    println(arr1)

    <span class="hljs-comment">// 不可变数组</span>
    <span class="hljs-keyword">val</span> arr2 = <span class="hljs-type">Array</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
    <span class="hljs-comment">// 不可变数组不能直接修改，拼接生成新数组</span>
    <span class="hljs-comment">// val arr2 = arr2 :+ 4</span>
    println(arr2)
  }
}
</code></pre>
<h2 data-id="heading-2">三.可变数组</h2>
<p>Array表示长度不可变的数组，一旦定义之后，不能再增加，删除元素。</p>
<ol>
<li>新建。要先导入 ArrayBuffer。 可变的数据结构都需要额外导入</li>
<li>访问修改。数组名(下标)=新值。</li>
<li><strong>添加元素</strong></li>
</ol>
<ul>
<li>添加一个元素；+= 元素</li>
<li>添加多个元素；+=(元素1, 元素2)</li>
</ul>
<ol start="4">
<li><strong>删除元素</strong></li>
</ol>
<ul>
<li>(1) 删除一个元素： -= 元素</li>
<li>(2) 删除多个元素： -= (元素1, 元素2）</li>
<li>(3) 删除指定位置的元素： remove(下标)</li>
<li>(4) 删除指定位置的多个元素：remove(下标起点，下标终点)</li>
</ul>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> array

<span class="hljs-comment">/**
 * Array 和 List 的区别
 *
 * array:有序，数组：元素在空间上连续，通过下标去访问元素会特别快！
 * List:有序，链表：元素在空间上不连续
 *
 * 两种类型
 * 1.可变
 * 2.不可变：一个数组创建之后，不能添加，不能删除！
 *
 * 常用方法：添加，删除，查找，循环，排序，.....
 */</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">array03</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 创建1到99的数组（左闭右开）</span>
    <span class="hljs-keyword">val</span> arr = <span class="hljs-type">Array</span>.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)
    arr.foreach(println) <span class="hljs-comment">// 打印1-99</span>

    <span class="hljs-comment">// 创建1到99、步长为3的数组</span>
    <span class="hljs-keyword">val</span> arr1 = <span class="hljs-type">Array</span>.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-number">3</span>)
    arr1.foreach(println) <span class="hljs-comment">// 打印1、4、7...97</span>

    <span class="hljs-comment">// 定义数组</span>
    <span class="hljs-keyword">val</span> arr2 = <span class="hljs-type">Array</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
    <span class="hljs-comment">// 访问数组元素</span>
    println(arr2(<span class="hljs-number">0</span>)) <span class="hljs-comment">// 输出第一个元素：1</span>
    println(arr2(<span class="hljs-number">2</span>)) <span class="hljs-comment">// 输出第三个元素：3</span>
    <span class="hljs-comment">// println(arr2(20)) // 注释：会触发数组越界异常</span>
  }
}
</code></pre>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> array

<span class="hljs-comment">/**
 * Array 和 List 的区别
 *
 * array:有序，数组：元素在空间上连续，通过下标去访问元素会特别快！
 * List:有序，链表：元素在空间上不连续
 *
 * 两种类型
 * 1.可变
 * 2.不可变：一个数组创建之后，不能添加，不能删除！
 *
 * 常用方法：添加，删除，查找，循环，排序，.....
 */</span>


<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">array03</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 定义可变数组</span>
    <span class="hljs-keyword">val</span> arr1 = scala.collection.mutable.<span class="hljs-type">ArrayBuffer</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)

    <span class="hljs-comment">// 追加元素（单个）</span>
    arr1 += <span class="hljs-number">4</span>
    <span class="hljs-comment">// 追加元素（多个）</span>
    arr1 ++= <span class="hljs-type">Array</span>(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)

    <span class="hljs-comment">// 删除元素：删除下标为1的元素</span>
  <span class="hljs-comment">//  arr1.remove(0)</span>
    <span class="hljs-comment">// 删除元素：从下标0开始，删除3个元素</span>
    arr1.remove(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)

    <span class="hljs-comment">// 修改元素：将下标为0的元素改为700</span>
    arr1(<span class="hljs-number">2</span>) = <span class="hljs-number">700</span>

    <span class="hljs-comment">// 查找元素：判断是否包含指定值</span>
    println(arr1.contains(<span class="hljs-number">6</span>))  <span class="hljs-comment">// 输出false（原元素已被删除）</span>
    println(arr1.contains(<span class="hljs-number">8</span>))<span class="hljs-comment">// 输出true</span>
    
    println(arr1.sum)<span class="hljs-comment">//求和</span>

    <span class="hljs-comment">// 遍历数组</span>
    arr1.foreach(ele =&gt; println(ele))
  }
}
</code></pre>
<h2 data-id="heading-3">四.数组常用方法</h2>
<p>1. 映射（Map）。arr.map(f)：对数组中的每个元素应用函数f，并返回一个新的不可变数组。</p>
<p>2. 过滤（Filter）。任务搜索</p>
<p>3. 搜索和比较</p>
<p>   - arr.indexOf(elem)：返回元素elem在数组中的第一个索引。</p>
<p>   - arr.contains(elem)：检查数组是否包含元素elem。</p>
<p>4. 切片（Slice）</p>
<p>    arr.slice(from, until)：返回数组的一个子数组，从索引from开始直到索引until（不包括until）。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> array


<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">array04</span> </span>{
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
  <span class="hljs-comment">// 定义可变数组</span>
  <span class="hljs-keyword">val</span> arr1 = scala.collection.mutable.<span class="hljs-type">ArrayBuffer</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">20</span>,<span class="hljs-number">3</span>)

  <span class="hljs-comment">// 排序：降序排序（a &gt; b）</span>
  <span class="hljs-keyword">val</span> arr2 = arr1.sortWith((a, b) =&gt; a &gt; b)

  <span class="hljs-comment">// 切片：获取下标0（包含）到3（不包含）的元素</span>
  <span class="hljs-keyword">val</span> arr3 = arr1.slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)

  <span class="hljs-comment">// 过滤：保留大于0的元素</span>
  <span class="hljs-keyword">val</span> arr4 = arr1.filter(x =&gt; x &gt; <span class="hljs-number">0</span>)

  <span class="hljs-comment">// 搜索元素下标：查找-2的位置（不存在则返回-1）</span>
  <span class="hljs-keyword">val</span> target = <span class="hljs-number">-2</span>
  <span class="hljs-keyword">val</span> result = arr1.indexOf(target)
  println(s&amp;#<span class="hljs-number">34</span>;${target}的下标是 ${result}&amp;#<span class="hljs-number">34</span>;)

  <span class="hljs-comment">// 遍历过滤后的数组</span>
  arr4.foreach(ele =&gt; println(ele))
}
}
</code></pre>
<h2 data-id="heading-4">五.多维数组</h2>
<p>最典型的多维数组就是二维数组，类似于表格。有两种定义方式：</p>
<p>直接定义： Array.ofDim(x,y)</p>
<p>从一维数组转化得来： 数组. grouped()</p>
<h3 data-id="heading-5">练习题</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6f12d0cf8844faa490e5a6c872f3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yY6LW36JKZ6JKZ6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021935&amp;x-signature=hdQLDoeBAIPAQHbh2svYKpUCctc%3D" alt="屏幕截图 2025-12-11 092406.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">package caseclass

import scala<span class="hljs-selector-class">.collection</span><span class="hljs-selector-class">.mutable</span><span class="hljs-selector-class">.ListBuffer</span>
import scala<span class="hljs-selector-class">.collection</span><span class="hljs-selector-class">.mutable</span><span class="hljs-selector-class">.ArrayBuffer</span>
import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.LocalDate</span>

<span class="hljs-comment">// 1. 使用case class定义DreamItem类</span>
case class <span class="hljs-built_in">DreamItem</span>(
                      content: String,    // 内容
                      isCompleted: Boolean, // 是否完成
                      deadline: LocalDate,  // 截止日期
                      priority: Int       // 优先级
                    )

<span class="hljs-selector-tag">object</span> DreamItemDemo {
  def <span class="hljs-selector-tag">main</span>(args: Array[String]): Unit = {
    <span class="hljs-comment">// 2. 定义可变Array保存DreamItem</span>
    val dreamArr = scala<span class="hljs-selector-class">.collection</span><span class="hljs-selector-class">.mutable</span><span class="hljs-selector-class">.ArrayBuffer</span><span class="hljs-selector-attr">[DreamItem]</span>()

    <span class="hljs-comment">// 3. 添加3个梦想</span>
    dreamArr += <span class="hljs-built_in">DreamItem</span>(&amp;#<span class="hljs-number">34</span>;学scala&amp;#<span class="hljs-number">34</span>;, false, LocalDate.of(<span class="hljs-number">2025</span>,<span class="hljs-number">12</span>,<span class="hljs-number">31</span>), <span class="hljs-number">2</span>)
    dreamArr += <span class="hljs-built_in">DreamItem</span>(&amp;#<span class="hljs-number">34</span>;练字&amp;#<span class="hljs-number">34</span>;, false, LocalDate.of(<span class="hljs-number">2026</span>,<span class="hljs-number">1</span>,<span class="hljs-number">15</span>), <span class="hljs-number">3</span>)
    dreamArr += <span class="hljs-built_in">DreamItem</span>(&amp;#<span class="hljs-number">34</span>;减肥&amp;#<span class="hljs-number">34</span>;, false, LocalDate.of(<span class="hljs-number">2025</span>,<span class="hljs-number">12</span>,<span class="hljs-number">20</span>), <span class="hljs-number">1</span>)

    <span class="hljs-comment">// 4. 将第2个梦想设置为已完成</span>
    <span class="hljs-built_in">dreamArr</span>(<span class="hljs-number">1</span>) = <span class="hljs-built_in">dreamArr</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.copy</span>(isCompleted = true)

    <span class="hljs-comment">// 5. 调高第3个梦想的优先级</span>
    <span class="hljs-built_in">dreamArr</span>(<span class="hljs-number">2</span>) = <span class="hljs-built_in">dreamArr</span>(<span class="hljs-number">2</span>)<span class="hljs-selector-class">.copy</span>(priority = dreamArr(<span class="hljs-number">2</span>)<span class="hljs-selector-class">.priority</span> + <span class="hljs-number">2</span>)

    <span class="hljs-comment">// 6. 根据优先级从高到低排序</span>
    val sortedDreams = dreamArr<span class="hljs-selector-class">.sortWith</span>((a,b) =&gt; <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.priority</span> &gt; <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.priority</span>)

    <span class="hljs-comment">// 7. 保存优先级排名前5的梦想</span>
    val top5Dreams = sortedDreams<span class="hljs-selector-class">.slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">5</span>)

    <span class="hljs-comment">// 8. 循环输出梦想列表</span>
    top5Dreams<span class="hljs-selector-class">.foreach</span>(dream =&gt; {
      println(s&amp;#<span class="hljs-number">34</span>;内容：${dream.content}，完成：${dream.isCompleted}，截止日：${dream.deadline}，优先级：${dream.priority}&amp;#<span class="hljs-number">34</span>;)
    })
  }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码平台的扩展能力：活字格服务端编程实战]]></title>    <link>https://juejin.cn/post/7582200865906982946</link>    <guid>https://juejin.cn/post/7582200865906982946</guid>    <pubDate>2025-12-11T02:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582200865906982946" data-draft-id="7582200865906950178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码平台的扩展能力：活字格服务端编程实战"/> <meta itemprop="keywords" content="低代码"/> <meta itemprop="datePublished" content="2025-12-11T02:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码平台的扩展能力：活字格服务端编程实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:52:13.000Z" title="Thu Dec 11 2025 02:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">低代码平台的扩展能力：活字格服务端编程实战</h2>
<h3 data-id="heading-1">引言</h3>
<p>在当今数字化转型浪潮中，低代码平台因其快速开发和易用性而备受青睐。然而，企业级应用往往需要处理复杂的业务逻辑和特殊需求，这些需求可能超出标准低代码功能的范畴。活字格低代码平台通过其强大的服务端编程能力，完美解决了这一挑战。</p>
<p>本文将深入探讨如何利用活字格的扩展能力，通过Java和C#编程实现复杂业务需求，特别是Excel模板填充和格式转换等高级功能。</p>
<h3 data-id="heading-2">一. 低代码平台的扩展需求与挑战</h3>
<p>低代码平台虽然能快速构建大多数业务应用，但在面对以下场景时可能会遇到限制：</p>
<ol>
<li><strong>特殊格式文件处理</strong>：如复杂Excel模板填充、PDF转换等</li>
<li><strong>第三方系统对接</strong>：如钉钉/企微客户端JSAPI、Web Service协议等</li>
<li><strong>专业算法实现</strong>：如文件哈希值计算、加密解密等</li>
</ol>
<p>活字格平台通过开放的服务端编程接口，允许开发者使用Java或C#扩展平台功能，在平台上通过发送HTTP请求的方式调用扩展的Web API接口，既保留了低代码的开发效率，又能满足企业级应用的复杂需求。</p>
<h3 data-id="heading-3">二. Excel模板填充与转换实战</h3>
<h5 data-id="heading-4">2.1 场景分析</h5>
<p>以化学化工行业客户的实际需求为例，需要处理包含以下内容的复杂Excel模板，且Sheet页面个数是动态的：</p>
<ul>
<li>结构化数据（设备信息）</li>
<li>动态列表数据（维修记录）</li>
<li>图片</li>
<li>
<h3 data-id="heading-5">多Sheet页面</h3>
</li>
</ul>
<h5 data-id="heading-6">2.2 技术实现</h5>
<p>通过Java Web API实现以下功能：</p>
<p>1.<strong>接收JSON数据并填充Excel模板</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 示例代码：使用Apache POI填充Excel模版中指定单元格（页码、图片、...）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processPageNumber</span><span class="hljs-params">(XSSFWorkbook workbook)</span> {
    <span class="hljs-comment">// 处理页码</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">numberOfSheets</span> <span class="hljs-operator">=</span> workbook.getNumberOfSheets();
    workbook.getSheetAt(<span class="hljs-number">0</span>).getRow(<span class="hljs-number">37</span>).getCell(<span class="hljs-number">45</span>).setCellValue(&amp;#<span class="hljs-number">34</span>;第  <span class="hljs-number">1</span>  页  共  &amp;#<span class="hljs-number">34</span>; + numberOfSheets +&amp;#<span class="hljs-number">34</span>;  页  SHEET  <span class="hljs-number">1</span> OF  &amp;#<span class="hljs-number">34</span>; + numberOfSheets);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; numberOfSheets; i++){
        workbook.getSheetAt(i).getRow(<span class="hljs-number">6</span>).getCell(<span class="hljs-number">33</span>).setCellValue(&amp;#<span class="hljs-number">34</span>;第   &amp;#<span class="hljs-number">34</span>;+ (i+<span class="hljs-number">1</span>) +&amp;#<span class="hljs-number">34</span>;   页     共   &amp;#<span class="hljs-number">34</span>; + numberOfSheets + &amp;#<span class="hljs-number">34</span>;   页&amp;#<span class="hljs-number">34</span>;);
    }
    <span class="hljs-keyword">return</span> numberOfSheets;
}

<span class="hljs-comment">// 示例代码：使用EasyExcel填充Excel模版中表格部分</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">ExcelWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> EasyExcel.write(outputTempFile).withTemplate(templateTempFile).build()) {
        Logger.info(&amp;#<span class="hljs-number">34</span>;Starting Excel export...&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numberOfSheets; i++) {
            <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">writeSheet</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(i).build();
            writer.fill(deviceInfoMap, writeSheet);
            
            <span class="hljs-keyword">if</span> (!emlList.isEmpty()) {
                writer.fill(emlList, writeSheet);
            }
        }
    }
} <span class="hljs-keyword">catch</span> (Exception e) {
    Logger.error(&amp;#<span class="hljs-number">34</span>;填充Excel数据时发生错误: &amp;#<span class="hljs-number">34</span>; + e.getMessage());
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(&amp;#<span class="hljs-number">34</span>;填充Excel数据失败&amp;#<span class="hljs-number">34</span>;, e);
}
</code></pre>
<p>2.<strong>Excel转PDF功能</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 示例代码：使用Aspose.Cells实现Excel转PDF</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">convertExcelToPdf</span><span class="hljs-params">(String excelFilePath, String pdfOutputPath)</span> <span class="hljs-keyword">throws</span> Exception {
    Logger.info(&amp;#<span class="hljs-number">34</span>;Starting Excel to PDF conversion: &amp;#<span class="hljs-number">34</span>; + excelFilePath + &amp;#<span class="hljs-number">34</span>; -&gt; &amp;#<span class="hljs-number">34</span>; + pdfOutputPath);

    <span class="hljs-type">Workbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        workbook = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Workbook</span>(excelFilePath);

        <span class="hljs-comment">// 设置PDF保存选项</span>
        <span class="hljs-type">PdfSaveOptions</span> <span class="hljs-variable">pdfSaveOptions</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfSaveOptions</span>();
        pdfSaveOptions.setOnePagePerSheet(<span class="hljs-literal">true</span>);

        <span class="hljs-type">WorksheetCollection</span> <span class="hljs-variable">worksheets</span> <span class="hljs-operator">=</span> workbook.getWorksheets();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; worksheets.getCount(); i++) {
            <span class="hljs-type">Worksheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> worksheets.get(i);
            <span class="hljs-type">PageSetup</span> <span class="hljs-variable">pageSetup</span> <span class="hljs-operator">=</span> getPageSetup(sheet);

            <span class="hljs-comment">// 添加页脚</span>
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
                pageSetup.setFooter(<span class="hljs-number">0</span>, &amp;#<span class="hljs-number">34</span>;&amp;\&amp;#<span class="hljs-number">34</span>;宋体,常规\&amp;#<span class="hljs-number">34</span>;&amp;<span class="hljs-number">9</span>注：本表为西安葡萄城软件有限责任公司专有，未经本公司许可，不得复制，不得将本表或其中内容以任何形式提供给第三方，也不得以任何形式，全部或部分用于其他目的。&amp;#<span class="hljs-number">34</span>;);
            }
            
            <span class="hljs-comment">// ...</span>
        }
        workbook.save(pdfOutputPath, pdfSaveOptions);
        Logger.info(&amp;#<span class="hljs-number">34</span>;Excel to PDF conversion completed: &amp;#<span class="hljs-number">34</span>; + pdfOutputPath);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pdfOutputPath);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        Logger.error(&amp;#<span class="hljs-number">34</span>;Error converting Excel to PDF: &amp;#<span class="hljs-number">34</span>; + e.getMessage());
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 确保资源正确关闭</span>
        <span class="hljs-keyword">if</span> (workbook != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                workbook.dispose();
            } <span class="hljs-keyword">catch</span> (Exception ignored) {}
        }
    }
}
</code></pre>
<h5 data-id="heading-7">2.3 方案优势</h5>
<ol>
<li><strong>灵活性</strong>：可处理任意复杂的Excel模板结构，动态生成Sheet页数据并导出</li>
<li><strong>性能</strong>：服务端处理大数据量性能更优</li>
<li><strong>格式保真</strong>：专业库确保输出文件格式完美</li>
<li><strong>可扩展</strong>：可轻松添加水印、加密等附加功能
1.</li>
</ol>
<h3 data-id="heading-8">三. 其他典型服务端扩展场景与应用</h3>
<h5 data-id="heading-9">3.1 对接第三方系统API</h5>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 示例：获取钉钉access_token</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetAccessToken</span>()</span>
{
    <span class="hljs-keyword">if</span> (config.token != &amp;<span class="hljs-meta">#34;&amp;#34; &amp;&amp; DateTime.Compare(DateTime.Now, DateTime.FromOADate(double.Parse(config.token_due_time))) &lt;= 0)</span>
    {
        <span class="hljs-keyword">return</span> config.token;
    }
    <span class="hljs-keyword">else</span>
    {
        PostData postData = <span class="hljs-keyword">new</span> PostData();
        <span class="hljs-keyword">var</span> jd = JsonConvert.DeserializeObject(postData.GetPage(&amp;<span class="hljs-meta">#34;https://oapi.dingtalk.com/gettoken?appkey=&amp;#34; + config.appkey + &amp;#34;&amp;appsecret=&amp;#34; + config.appsecret)) as JObject;</span>
        <span class="hljs-built_in">string</span> accessToken = jd[&amp;<span class="hljs-meta">#34;access_token&amp;#34;].ToString();</span>
        updateTokenDueTime(accessToken, <span class="hljs-number">7200</span>);
        <span class="hljs-keyword">return</span> accessToken;
    }
}
</code></pre>
<h5 data-id="heading-10">3.2 对接Web Service协议</h5>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">// 示例：调用Web Service</span>
<span class="hljs-built_in">string</span> soapRequest = $@&amp;<span class="hljs-meta">#34;</span>
    
    
        
            
                
                    xxx
                    ......
                
            
        
    
&amp;<span class="hljs-meta">#34;;</span>

<span class="hljs-built_in">string</span> url = &amp;<span class="hljs-meta">#34;xxx&amp;#34;;</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> httpClient = <span class="hljs-keyword">new</span> HttpClient();
<span class="hljs-comment">// 设置HTTP基本认证  </span>
<span class="hljs-keyword">var</span> byteArray = Encoding.ASCII.GetBytes($&amp;<span class="hljs-meta">#34;{_sapUsername}:{_sapPassword}&amp;#34;);</span>
httpClient.DefaultRequestHeaders.Authorization = <span class="hljs-keyword">new</span> System.Net.Http.Headers.AuthenticationHeaderValue(&amp;<span class="hljs-meta">#34;Basic&amp;#34;, Convert.ToBase64String(byteArray));</span>
<span class="hljs-comment">// 构造请求内容  </span>
<span class="hljs-keyword">var</span> content = <span class="hljs-keyword">new</span> StringContent(soapRequest, Encoding.UTF8, &amp;<span class="hljs-meta">#34;text/xml&amp;#34;);</span>
<span class="hljs-comment">// 发送POST请求并等待响应  </span>
HttpResponseMessage response = <span class="hljs-keyword">await</span> httpClient.PostAsync(url, content);
</code></pre>
<h5 data-id="heading-11">3.3 文件哈希值计算</h5>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 示例：计算文件SHA256哈希值</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">calculateFileHash</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">digest</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(&amp;#<span class="hljs-number">34</span>;SHA-<span class="hljs-number">256</span>&amp;#<span class="hljs-number">34</span>;);
    <span class="hljs-type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(filePath));
    <span class="hljs-type">byte</span>[] hashBytes = digest.digest(fileBytes);
    <span class="hljs-keyword">return</span> bytesToHex(hashBytes);
}
</code></pre>
<h3 data-id="heading-12">四. 调试与优化技巧</h3>
<ol>
<li>
<p><strong>日志记录</strong>：使用活字格提供的Logger类输出调试信息</p>
<pre><code class="hljs language-Java" lang="Java">  Logger.info(&amp;#<span class="hljs-number">34</span>;开始处理Excel导出请求，参数大小：&amp;#<span class="hljs-number">34</span>; + jsonData.length());
</code></pre>
</li>
<li>
<p><strong>错误处理</strong>：完善的异常捕获和处理机制</p>
<pre><code class="hljs language-Java" lang="Java">  <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 业务逻辑</span>
  } <span class="hljs-keyword">catch</span> (Exception e) {
      Logger.error(&amp;#<span class="hljs-number">34</span>;导出Excel失败：&amp;#<span class="hljs-number">34</span>; + e.getMessage());
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(&amp;#<span class="hljs-number">34</span>;导出失败，请检查数据格式&amp;#<span class="hljs-number">34</span>;);
  }
</code></pre>
</li>
<li>
<p><strong>性能监控</strong>：记录关键操作耗时</p>
<pre><code class="hljs language-Java" lang="Java">  <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
  <span class="hljs-comment">// 执行操作</span>
  <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
  Logger.info(&amp;#<span class="hljs-number">34</span>;Excel填充/转换耗时：&amp;#<span class="hljs-number">34</span>; + duration + &amp;#<span class="hljs-number">34</span>;ms&amp;#<span class="hljs-number">34</span>;);
</code></pre>
</li>
</ol>
<h3 data-id="heading-13">结论</h3>
<p>活字格低代码平台通过其强大的服务端编程能力，成功解决了标准低代码功能无法满足复杂业务需求的挑战。本文展示的Excel模板填充和转换方案，以及其他扩展场景的实现，充分证明了活字格在企业级应用开发中的灵活性和强大能力。</p>
<h3 data-id="heading-14">扩展链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.grapecity.com.cn%2Fsolutions%2Fhuozige" target="_blank" title="https://www.grapecity.com.cn/solutions/huozige" ref="nofollow noopener noreferrer">敏捷构建企业级应用及AI智能体</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码急诊室：用Arthas给你的Java应用做“微创手术”]]></title>    <link>https://juejin.cn/post/7582133314686009396</link>    <guid>https://juejin.cn/post/7582133314686009396</guid>    <pubDate>2025-12-11T01:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582133314686009396" data-draft-id="7582096212662697984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码急诊室：用Arthas给你的Java应用做“微创手术”"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-11T01:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码急诊室：用Arthas给你的Java应用做“微创手术”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:45:17.000Z" title="Thu Dec 11 2025 01:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">一、Arthas是什么？—— Java程序员的“第二双眼睛”</h2>
<p>想象一下：你的Java应用正在线上欢快地奔跑，突然有一天它开始“咳嗽发烧”（CPU飙升）、“记忆衰退”（内存泄漏）、“反应迟钝”（接口超时）。你急得像热锅上的蚂蚁，这时候Arthas就像个穿着白大褂还带着听诊器的搞笑医生，拍拍你的肩膀说：“兄弟，让我来看看这货到底在搞什么鬼！”</p>
<p>Arthas本质上是个<strong>Java诊断工具</strong>，它是阿里巴巴开源的一个“瑞士军刀”，能让你在不重启服务的情况下：</p>
<ul>
<li>
<p>查看方法调用的“心电图”（调用链）</p>
</li>
<li>
<p>给代码做“活体穿刺”（动态修改运行中的代码）</p>
</li>
<li>
<p>监控JVM的“血压血脂”（内存、线程、GC情况）</p>
</li>
<li>
<p>甚至能“偷听”方法调用的“悄悄话”（参数和返回值）</p>
</li>
</ul>
<h2 data-id="heading-1">二、安装与启动：简单得像个“傻瓜相机”</h2>
<h3 data-id="heading-2">1. 安装（选择一种方式即可）</h3>
<p><strong>方式A：在线安装（推荐懒人版）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这行命令比泡方便面还简单</span>
curl -O https://arthas.aliyun.com/arthas-boot.jar
</code></pre>
<p><strong>方式B：Docker版（装X必备）</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker run --<span class="hljs-built_in">rm</span> -ti \
  --pid=host \
  arthas/arthas:latest
</code></pre>
<p><strong>方式C：传统派（手动下载）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 假装这是一段Java代码，其实只是凑数</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HowToDownload</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;1. 访问 https://github.com/alibaba/arthas&amp;#34;);</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;2. 点击那个绿色的'Download'按钮&amp;#34;);</span>
        System.<span class="hljs-keyword">out</span>.println(&amp;<span class="hljs-meta">#34;3. 等待时可以去冲杯咖啡&amp;#34;);</span>
    }
}
</code></pre>
<h3 data-id="heading-3">2. 启动：像打电话一样简单</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动后会列出所有Java进程，像选妃一样选一个</span>
java -jar arthas-boot.jar

<span class="hljs-comment"># 如果你已经知道“妃子”的ID，可以直接点名</span>
java -jar arthas-boot.jar 12345
</code></pre>
<p>启动成功后，你会看到这个吉祥物：</p>
<pre><code class="hljs language-go" lang="go">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.
 /  O  \ |  .--. <span class="hljs-string">''</span>--.  .--<span class="hljs-string">'|  '</span>--<span class="hljs-string">'  | /  O  \ '</span>   .-<span class="hljs-string">'
|  .-.  ||  '</span>--<span class="hljs-string">'.'</span>   |  |   |  .--.  ||  .-.  |<span class="hljs-string">`.  `</span>-.
|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="hljs-string">'    |
`--'</span> <span class="hljs-string">`--'`</span>--<span class="hljs-string">' '</span>--<span class="hljs-string">'   `--'</span>   <span class="hljs-string">`--'  `</span>--<span class="hljs-string">'`--'</span> <span class="hljs-string">`--'`</span>-----<span class="hljs-string">'
 
# 恭喜！你现在拥有了Java应用的“上帝视角”
</span></code></pre>
<h2 data-id="heading-4">三、常用命令实战：从“把脉”到“动手术”</h2>
<h3 data-id="heading-5">1. <strong>dashboard：应用的“全身检查报告”</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 输入这个命令，你会看到一个比体检报告还详细的面板</span>
dashboard

<span class="hljs-meta"># 输出示例（简化版）：</span>
┌─线程面板────────────────┐
│ 线程<span class="hljs-number">1</span>: <span class="hljs-number">95</span>% CPU   <span class="hljs-comment">// 这家伙在疯狂挖矿？！</span>
│ 线程<span class="hljs-number">2</span>: WAITING   <span class="hljs-comment">// 在等女朋友回消息...</span>
└──────────────────────┘
┌─内存面板────────────────┐
│ 堆内存: <span class="hljs-number">80</span>%      <span class="hljs-comment">// 快吃饱了</span>
│ 非堆: <span class="hljs-number">30</span>%        <span class="hljs-comment">// 还行还行</span>
└──────────────────────┘
</code></pre>
<h3 data-id="heading-6">2. <strong>watch：方法的“窃听器”</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// 假设你想监控这个方法（医生想听病人的心跳）
public String getUserInfo(String userId) {
    // 业务逻辑...
    return &amp;<span class="hljs-comment">#34;User_&amp;#34; + userId;</span>
}



<span class="hljs-comment"># 监听方法调用，像在门上装了个监听器</span>
watch com.example.service.UserService getUserInfo '{params,returnObj}' -x 3

<span class="hljs-comment"># 输出效果：</span>
<span class="hljs-attr">method</span>=getUserInfo location=AtEnter
params<span class="hljs-section">[0]</span>=@String<span class="hljs-section">[1001]</span>    <span class="hljs-comment"># 哦，用户1001来了</span>
---
<span class="hljs-attr">method</span>=getUserInfo location=AtExit
<span class="hljs-attr">returnObj</span>=@String[User_1001] <span class="hljs-comment"># 返回了用户信息</span>
<span class="hljs-attr">cost</span>=<span class="hljs-number">45</span>ms                   <span class="hljs-comment"># 花了45毫秒，还行</span>
</code></pre>
<h3 data-id="heading-7">3. <strong>trace：调用链的“侦探地图”</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 追踪方法调用，像福尔摩斯破案</span>
trace com.example.controller.OrderController createOrder

<span class="hljs-comment"># 输出像犯罪现场还原：</span>
`<span class="hljs-attr">---ts</span>=<span class="hljs-number">2023</span>-<span class="hljs-number">10</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><span class="hljs-comment">;thread_name=http-nio-8080-exec-1</span>
    `---<span class="hljs-section">[15ms]</span> com.example.controller.OrderController:createOrder()
        +---<span class="hljs-section">[3ms]</span> com.example.service.OrderService:validate()  <span class="hljs-comment"># 验证花了3ms</span>
        +---<span class="hljs-section">[10ms]</span> com.example.dao.OrderDao:save()            <span class="hljs-comment"># 保存花了10ms</span>
        `---<span class="hljs-section">[2ms]</span> com.example.service.EmailService:send()     <span class="hljs-comment"># 发邮件2ms</span>
<span class="hljs-comment"># 结论：数据库保存是瓶颈，该优化了！</span>
</code></pre>
<h3 data-id="heading-8">4. <strong>jad：源代码的“时光机”</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 反编译线上正在运行的代码，看看它到底长啥样</span>
jad com.example.service.BuggyService

<span class="hljs-meta"># 输出示例：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BuggyService</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">problematicMethod</span>()</span> {
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {  <span class="hljs-comment">// 卧槽！这里有个死循环！</span>
            <span class="hljs-comment">// 原来bug藏在这里！</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-9">5. <strong>ognl：运行时“记忆读取器”</strong></h3>
<pre><code class="hljs language-scss" lang="scss"># 直接读取Spring容器的Bean，像读取别人的记忆
ognl '<span class="hljs-selector-id">#context</span>=<span class="hljs-keyword">@com</span>.taobao.arthas.core.ArthasSpringContext<span class="hljs-keyword">@context</span>,
      #context.getBean(&amp;#<span class="hljs-number">34</span>;userService&amp;<span class="hljs-selector-id">#34</span>;)<span class="hljs-selector-class">.getAllUsers</span>()'

# 甚至可以修改值（小心使用！）
ognl '<span class="hljs-selector-id">#user</span>=new <span class="hljs-built_in">User</span>(), <span class="hljs-selector-id">#user</span><span class="hljs-selector-class">.setName</span>(&amp;#<span class="hljs-number">34</span>;Arthas&amp;#<span class="hljs-number">34</span>;), <span class="hljs-selector-id">#user</span>'
</code></pre>
<h3 data-id="heading-10">6. <strong>redefine：热更新“魔法”</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 紧急修复bug，不用重启！像给飞行中的飞机换引擎</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Hotfix</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">buggyMethod</span>()</span> {
        <span class="hljs-comment">// return 1/0;  // 原来的bug</span>
        <span class="hljs-keyword">return</span> &amp;<span class="hljs-meta">#34;fixed!&amp;#34;; // 修复后的代码</span>
    }
}



<span class="hljs-meta"># 1. 先编译修改后的.java文件</span>
<span class="hljs-meta"># 2. 加载新class</span>
redefine /path/to/Hotfix.<span class="hljs-keyword">class</span>
<span class="hljs-meta"># 3. 恭喜！bug已修复，服务还在运行</span>
</code></pre>
<h2 data-id="heading-11">四、高级技巧：成为“诊断大师”</h2>
<h3 data-id="heading-12">场景1：CPU飙高怎么办？</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 三步定位法</span>
1. thread -n 3            <span class="hljs-comment"># 找出最忙的3个线程</span>
2. thread 线程ID          <span class="hljs-comment"># 查看该线程堆栈</span>
3. jad 类名               <span class="hljs-comment"># 反编译相关代码</span>
<span class="hljs-comment"># 通常你会发现：有人在循环里写日志、死循环、或者真的在挖矿</span>
</code></pre>
<h3 data-id="heading-13">场景2：内存泄漏怎么查？</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 内存侦探四部曲</span>
1. dashboard             <span class="hljs-comment"># 先看整体内存情况</span>
2. heapdump /tmp/dump.hprof  <span class="hljs-comment"># 导出堆内存（像拍X光片）</span>
3. jvm                   <span class="hljs-comment"># 查看GC情况</span>
4. ognl <span class="hljs-string">'@com.example.LeakyClass@map'</span>  <span class="hljs-comment"># 检查可疑静态变量</span>
</code></pre>
<h3 data-id="heading-14">场景3：慢接口分析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 慢查询追踪套餐</span>
trace *SpringController* *           <span class="hljs-comment"># 追踪所有Controller</span>
watch *Service* * <span class="hljs-string">'{params, #cost}'</span>  <span class="hljs-comment"># 监控服务层耗时</span>
<span class="hljs-comment"># 通常罪魁祸首：N+1查询、大文件处理、第三方接口超时</span>
</code></pre>
<h2 data-id="heading-15">五、注意事项与“翻车”预防</h2>
<h3 data-id="heading-16">1. <strong>生产环境使用守则</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 像这样的代码要小心：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dangerous</span> {
    <span class="hljs-comment">// 别在生产环境疯狂trace，性能会哭的</span>
    <span class="hljs-comment">// 别用阻塞命令（比如sc），除非你想让线程排队</span>
    <span class="hljs-comment">// 热更新有风险，可能引发“薛定谔的bug”</span>
}
</code></pre>
<h3 data-id="heading-17">2. <strong>常用安全措施</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 使用指定IP绑定（别让谁都连）</span>
<span class="hljs-string">java</span> <span class="hljs-string">-jar</span> <span class="hljs-string">arthas-boot.jar</span> <span class="hljs-string">--telnet-port</span> <span class="hljs-number">3658</span> <span class="hljs-string">--http-port</span> <span class="hljs-number">8563</span> <span class="hljs-string">--target-ip</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>

<span class="hljs-comment"># 2. 设置会话超时</span>
<span class="hljs-string">session-timeout</span> <span class="hljs-number">1800</span>  <span class="hljs-comment"># 30分钟自动断开</span>

<span class="hljs-comment"># 3. 重要命令先测试</span>
<span class="hljs-comment"># 先在测试环境玩熟了再去生产环境“秀操作”</span>
</code></pre>
<h2 data-id="heading-18">六、总结：为什么你需要Arthas这个“伙伴”？</h2>
<p>想象一下这个场景：凌晨3点，报警短信把你从美梦中吵醒。以前你需要：</p>
<ol>
<li>挣扎着起床</li>
<li>连VPN</li>
<li>查日志</li>
<li>猜问题</li>
<li>重启服务</li>
<li>祈祷有用</li>
</ol>
<p>有了Arthas之后：</p>
<ol>
<li>床上打开笔记本</li>
<li>连上Arthas</li>
<li><code>dashboard</code>一眼看出问题</li>
<li><code>watch/trace</code>定位具体方法</li>
<li><code>redefine</code>热修复（如果需要）</li>
<li>继续睡觉</li>
</ol>
<h3 data-id="heading-19"><strong>Arthas的核心价值：</strong></h3>
<ol>
<li><strong>实时性</strong>：像给应用装了“实时监控摄像头”，问题发生时立即捕捉现场</li>
<li><strong>无侵入</strong>：不需要改代码、加日志、重启服务，真正的“零打扰诊断”</li>
<li><strong>功能全面</strong>：从方法级监控到JVM状态，从堆栈分析到热更新，一把梭</li>
<li><strong>学习友好</strong>：命令简单直观，连Java新手都能快速上手</li>
</ol>
<h3 data-id="heading-20"><strong>最后的小建议：</strong></h3>
<p>把Arthas当成你的<strong>Java应用听诊器</strong>，但记住：</p>
<ul>
<li>小病小痛用<code>watch/trace</code>（日常监控）</li>
<li>疑难杂症用<code>jad/ognl</code>（深入探查）</li>
<li>紧急抢救用<code>redefine</code>（热修复）</li>
<li>定期体检用<code>dashboard</code>（健康检查）</li>
</ul>
<p>就像老中医需要望闻问切，Arthas就是你的数字听诊器、X光机、心电图仪三合一。不过别忘了——<strong>工具再强大，也替代不了你对代码的深入理解</strong>。Arthas能帮你快速找到问题，但解决问题的根本，还是写出健壮的代码和良好的架构。</p>
<hr/>
<p>Arthas虽好，可不要贪杯哦！生产环境使用时，记得先在小流量或测试环境验证命令效果，避免“诊断工具变故障制造器”的尴尬局面。祝你和你的Java应用都健康运行！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22256f6cb05c46bab50516b75492cbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766022316&amp;x-signature=%2B9SnkBA75ILlmD2FWPW7eq3qDIs%3D" alt="代码急诊室：用Arthas给你的Java应用做“微创手术”.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[下载视频]]></title>    <link>https://juejin.cn/post/7582118218648616986</link>    <guid>https://juejin.cn/post/7582118218648616986</guid>    <pubDate>2025-12-11T02:53:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118218648616986" data-draft-id="7582136489770041354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="下载视频"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T02:53:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不减20斤不改头像"/> <meta itemprop="url" content="https://juejin.cn/user/3685218708368519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            下载视频
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218708368519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不减20斤不改头像
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:53:41.000Z" title="Thu Dec 11 2025 02:53:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在命令行中下载视频，最常用且强大的工具是 <strong>youtube-dl</strong>（现已更名为 <code>yt-dlp</code>，功能更完善），它支持绝大多数视频网站，比如 YouTube、B 站、抖音等。</p>
<p>以下是具体的使用方法：</p>
<h3 data-id="heading-0">一、安装 yt-dlp</h3>
<p><code>yt-dlp</code> 是跨平台工具，支持 Windows、macOS、Linux。</p>
<ol>
<li>
<p><strong>Windows 系统</strong></p>
<ul>
<li>直接从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyt-dlp%2Fyt-dlp%2Freleases" target="_blank" title="https://github.com/yt-dlp/yt-dlp/releases" ref="nofollow noopener noreferrer">yt-dlp 官方 GitHub 仓库</a> 下载 <code>yt-dlp.exe</code></li>
<li>将其放到容易找到的目录（比如 <code>C:\tools</code>），并把该目录添加到系统环境变量 <code>Path</code> 中，这样就能在命令行任意目录调用。</li>
</ul>
</li>
<li>
<p><strong>macOS 系统</strong>使用 Homebrew 安装：</p>
<pre><code class="hljs">brew install yt-dlp
</code></pre>
</li>
<li>
<p><strong>Linux 系统</strong>Ubuntu/Debian 系列：</p>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span> <span class="hljs-operator">&amp;&amp;</span> sudo apt install yt<span class="hljs-operator">-</span>dlp
</code></pre>
<p>其他发行版可从 GitHub 下载二进制文件。</p>
</li>
</ol>
<h3 data-id="heading-1">二、基本下载命令</h3>
<ol>
<li>
<p><strong>下载单个视频</strong>复制视频的网页链接，在命令行输入：</p>
<pre><code class="hljs language-css" lang="css">yt-dlp <span class="hljs-selector-attr">[视频链接]</span>
</code></pre>
<p>示例（下载 B 站视频）：</p>
<pre><code class="hljs language-arduino" lang="arduino">yt-dlp https:<span class="hljs-comment">//www.bilibili.com/video/BV1xx411c7mZ</span>
</code></pre>
<p>视频会默认下载到当前命令行的工作目录。</p>
</li>
<li>
<p><strong>指定视频格式和清晰度</strong></p>
<ul>
<li>
<p>先查看视频支持的所有格式：</p>
<pre><code class="hljs language-css" lang="css">yt-dlp -F <span class="hljs-selector-attr">[视频链接]</span>
</code></pre>
<p>输出会列出格式代码、分辨率、编码等信息，比如 <code>248</code> 对应 480p 视频，<code>140</code> 对应音频。</p>
</li>
<li>
<p>下载指定格式的视频 + 音频（会自动合并）：</p>
<pre><code class="hljs language-css" lang="css">yt-dlp -f <span class="hljs-selector-attr">[视频格式代码]</span>+<span class="hljs-selector-attr">[音频格式代码]</span> <span class="hljs-selector-attr">[视频链接]</span>
</code></pre>
<p>示例（下载 1080p 视频）：</p>
<pre><code class="hljs language-ini" lang="ini">yt-dlp -f 137+140 https://www.youtube.com/watch?<span class="hljs-attr">v</span>=xxxxxx
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>下载整个播放列表</strong>复制播放列表链接，添加 <code>-i</code> 参数（忽略错误，防止个别视频下载失败中断）：</p>
<pre><code class="hljs language-css" lang="css">yt-dlp -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[播放列表链接]</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">三、注意事项</h3>
<ol>
<li>
<p><strong>版权问题</strong>：仅可下载自己拥有版权或允许下载的视频，切勿用于侵权行为。</p>
</li>
<li>
<p><strong>部分网站限制</strong>：一些网站有反爬机制，可能需要更新 <code>yt-dlp</code> 到最新版本：</p>
<pre><code class="hljs">yt-dlp -U
</code></pre>
</li>
<li>
<p><strong>需要 FFmpeg</strong>：如果要合并视频和音频、转换格式，需要安装 <strong>FFmpeg</strong>，<code>yt-dlp</code> 会自动调用它。</p>
</li>
</ol>
<hr/>
<p>是否需要我帮你整理一份<strong>yt-dlp 常用参数速查表</strong>，方便你快速查询清晰度选择、批量下载等功能？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀我让 TRAE SOLO 帮我开发一个清华大学教务系统，全栈 Java + Vue，秒变“教务主任”！]]></title>    <link>https://juejin.cn/post/7582066556089335871</link>    <guid>https://juejin.cn/post/7582066556089335871</guid>    <pubDate>2025-12-11T02:09:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582066556089335871" data-draft-id="7582066556089253951" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀我让 TRAE SOLO 帮我开发一个清华大学教务系统，全栈 Java + Vue，秒变“教务主任”！"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-11T02:09:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀我让 TRAE SOLO 帮我开发一个清华大学教务系统，全栈 Java + Vue，秒变“教务主任”！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:09:11.000Z" title="Thu Dec 11 2025 02:09:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀我让 TRAE SOLO 帮我开发一个清华大学教务系统，全栈 Java + Vue，秒变“教务主任”！</h2>
<hr/>
<blockquote>
<p>作者｜天天摸鱼的 Java 工程师<br/>
标签｜TRAE SOLO、Spring Boot、Vue、全栈开发、教务系统、AI 编程助手<br/>
项目地址｜本地访问 <code>http://localhost:3000</code> 登录体验</p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73a9485dbe15404e807fd3de5cde0495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766023750&amp;x-signature=NGpe9UMLgLM3uKOauH3vEbLUgYo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">🧠 起因：一个突发奇想，能不能让 AI 帮我写个“清华教务系统”？</h3>
<p>还记得大学时候，每年选课、查成绩、导出成绩单都离不开教务系统，虽然功能够用，但 UI 和体验一直不尽如人意。</p>
<p>现在我是一枚后端 Java 工程师，在了解了 <strong>TRAE SOLO</strong> 这个 AI 编程助手后，我突然有了一个想法：</p>
<blockquote>
<p>“如果我让 TRAE SOLO 来帮我从 0 开发一个清华大学教务系统，会发生什么？”</p>
</blockquote>
<p>于是，我打开了 TRAE SOLO，说了一句话：</p>
<blockquote>
<p><strong>“帮我开发一个清华大学的教务系统，仿照清华教务 UI，前后端分离，后端 Java，前端 Vue。”</strong></p>
</blockquote>
<p>结果，真的被它震撼到了。</p>
<hr/>
<h3 data-id="heading-2">🧰 技术方案一览</h3>

































<table><thead><tr><th>模块</th><th>技术栈</th></tr></thead><tbody><tr><td>前端</td><td>Vue 3 + Vite + 原生 JS（因 vite 报错，降级处理）</td></tr><tr><td>后端</td><td>Spring Boot 2.x + H2 内存数据库</td></tr><tr><td>安全认证</td><td>Spring Security</td></tr><tr><td>数据结构</td><td>用户、课程、成绩、教室</td></tr><tr><td>启动方式</td><td>本地运行（支持 mvn + Python 简易 HTTP 服务）</td></tr><tr><td>AI 助手</td><td>TRAE SOLO 全程陪跑</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">🧱 开发过程全记录</h3>
<h4 data-id="heading-4">第一步：创建项目结构和规划文档</h4>
<p>TRAE SOLO 首先为我自动创建了如下目录结构：</p>
<pre><code class="hljs language-sql" lang="sql">Affairs<span class="hljs-operator">-</span><span class="hljs-keyword">System</span><span class="hljs-operator">/</span>
├── backend<span class="hljs-operator">/</span>  ← Spring Boot 后端
└── frontend<span class="hljs-operator">/</span> ← Vue <span class="hljs-operator">+</span> JS 前端
</code></pre>
<p>并列出了 6 个阶段性任务：</p>
<ol>
<li>创建项目结构和规划文档 ✅</li>
<li>开发后端 Java 项目 ✅</li>
<li>配置数据库和依赖 ✅</li>
<li>开发前端 Vue 页面 ✅</li>
<li>实现前后端交互和登录功能 ✅</li>
<li>启动项目并测试 ✅</li>
</ol>
<p>全程自动生成、编译、运行，效率惊人。</p>
<hr/>
<h4 data-id="heading-5">第二步：开发后端 Spring Boot 项目</h4>
<h5 data-id="heading-6">✅ 核心功能：</h5>
<ul>
<li>登录认证（基于 Spring Security）</li>
<li>用户信息管理（支持三种角色：学生、教师、管理员）</li>
<li>科目管理（课程）</li>
<li>成绩管理（学生成绩）</li>
<li>教室管理（新增扩展）</li>
</ul>
<h5 data-id="heading-7">✅ 关键代码文件：</h5>
<ul>
<li><code>User.java</code>：用户实体</li>
<li><code>Course.java</code>：课程实体</li>
<li><code>Score.java</code>：成绩实体</li>
<li><code>LoginController.java</code>：登录接口</li>
<li><code>CourseController.java</code>：课程 API</li>
<li><code>ScoreController.java</code>：成绩 API</li>
<li><code>SecurityConfig.java</code>：安全配置</li>
<li><code>DataInit.java</code>：初始化测试数据</li>
</ul>
<h5 data-id="heading-8">✅ 测试账号</h5>

























<table><thead><tr><th>角色</th><th>用户名</th><th>密码</th></tr></thead><tbody><tr><td>管理员</td><td><code>admin</code></td><td><code>admin123</code></td></tr><tr><td>学生</td><td><code>student</code></td><td><code>student123</code></td></tr><tr><td>教师</td><td><code>teacher</code></td><td><code>teacher123</code></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-9">第三步：开发前端 Vue 页面（UI 仿清华）</h4>
<p>本来我想用 Vue + Vite 搭建完整 SPA，但由于 <code>esbuild</code> 的平台兼容性问题，TRAE SOLO 机智地切换到了原生 HTML + JS 的方案。</p>
<h5 data-id="heading-10">✅ 登录页面（index.html）</h5>
<ul>
<li>登录框仿照清华大学教务系统 UI</li>
<li>输入用户名和密码后，调用后端 <code>/api/login</code> 接口</li>
<li>登录成功后跳转主页面</li>
</ul>
<h5 data-id="heading-11">✅ 主页面（main.html）</h5>
<ul>
<li>左侧菜单栏：仪表盘、课程管理、成绩查询、用户管理</li>
<li>右侧内容区根据菜单动态渲染模块</li>
<li>不同角色显示不同菜单（RBAC 实现）</li>
<li>样式参考紫色清华风格，结构清晰</li>
</ul>
<hr/>
<h4 data-id="heading-12">第四步：前后端联调</h4>
<ul>
<li>后端接口全部暴露在 <code>/api</code> 路径下</li>
<li>使用 <code>fetch()</code> 实现跨域调用</li>
<li>登录成功后存储用户名到 <code>localStorage</code></li>
<li>后端根据用户角色返回对应功能模块的数据</li>
</ul>
<hr/>
<h4 data-id="heading-13">第五步：启动服务并访问</h4>
<h5 data-id="heading-14">✅ 启动后端</h5>
<pre><code class="hljs language-arduino" lang="arduino">cd backend
mvn spring-boot:run
</code></pre>
<p>运行成功后，后端服务地址为：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//localhost:8080</span>
</code></pre>
<h5 data-id="heading-15">✅ 启动前端（HTML + Python）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> frontend
python3 -m http.server 3000
</code></pre>
<p>运行成功后，前端地址为：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//localhost:3000</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">🔥 系统功能预览</h3>
<h4 data-id="heading-17">✅ 登录页</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4daa4f323ae470eb2c3c46a65d5e60c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766023750&amp;x-signature=%2FP9cOTXZdgmimNHiX11wMlcbKoE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>支持用户登录</li>
<li>登录失败返回提示</li>
<li>登录成功跳转主页面</li>
</ul>
<h4 data-id="heading-18">✅ 主页面（main.html）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105017d1df8e4d1dac13b9a03433ee01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766023750&amp;x-signature=GigPgAezIDnFc2m8DV3tRDmZWng%3D" alt="image.png" loading="lazy"/></p>
<p>根据角色展示不同子模块：</p>
<h5 data-id="heading-19">管理员</h5>
<ul>
<li>👨‍💼 用户管理</li>
<li>📚 课程管理</li>
<li>📊 成绩总览</li>
</ul>
<h5 data-id="heading-20">教师</h5>
<ul>
<li>📚 授课课程</li>
<li>✍️ 成绩录入</li>
</ul>
<h5 data-id="heading-21">学生</h5>
<ul>
<li>📖 我的课程</li>
<li>📝 我的成绩</li>
<li>📈 平均绩点</li>
</ul>
<hr/>
<h3 data-id="heading-22">💡 TRAE SOLO 的思考过程（AI 编程体验）</h3>
<p>整个开发过程中，TRAE SOLO 的思考逻辑清晰、有条不紊：</p>
<ul>
<li>遇到版本不兼容，自动降级 Spring Boot 版本</li>
<li>遇到前端的 vite 报错，自动切换为 HTML + 原生 JS</li>
<li>自动生成实体、Controller、Repository、初始化数据</li>
<li>自动安装依赖、运行服务、检测错误并修复</li>
<li>自动跳转页面、绑定事件、处理登录状态</li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p><strong>我只负责说出需求，TRAE SOLO 帮我把需求落地为代码和可运行系统。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-23">🧪 如何体验教务系统？</h3>
<h4 data-id="heading-24">1. 启动后端</h4>
<pre><code class="hljs language-arduino" lang="arduino">cd backend
mvn spring-boot:run
</code></pre>
<h4 data-id="heading-25">2. 启动前端</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> frontend
python3 -m http.server 3000
</code></pre>
<h4 data-id="heading-26">3. 打开浏览器访问</h4>
<ul>
<li>登录页面：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2F" target="_blank" title="http://localhost:3000/" ref="nofollow noopener noreferrer">http://localhost:3000</a></li>
<li>后端 API：</li>
<li>H2 控制台：</li>
</ul>
<h4 data-id="heading-27">4. 使用测试账号登录</h4>

























<table><thead><tr><th>角色</th><th>用户名</th><th>密码</th></tr></thead><tbody><tr><td>管理员</td><td><code>admin</code></td><td><code>admin123</code></td></tr><tr><td>学生</td><td><code>student</code></td><td><code>student123</code></td></tr><tr><td>教师</td><td><code>teacher</code></td><td><code>teacher123</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28">🎓 总结：用 TRAE SOLO，我成为“清华教务主任”</h3>
<p>这次开发让我彻底改变了对“AI 写代码”的看法。</p>
<ul>
<li>不再是“自动生成一段代码”</li>
<li>而是从需求 → 结构 → 实现 → 运行，全流程代工</li>
<li>甚至能根据错误日志自动修复问题、切换技术方案</li>
</ul>
<blockquote>
<p>我只用了几个小时，就从零构建起一个能用的清华大学教务系统。</p>
</blockquote>
<hr/>
<h3 data-id="heading-29">📢 未来计划</h3>
<ul>
<li>✅ 多角色登录 ✔️</li>
<li>✅ 课程和成绩管理 ✔️</li>
<li>⏳ 选课系统（正在开发）</li>
<li>⏳ 教室排课冲突检测</li>
<li>⏳ 导出成绩单、绩点计算</li>
<li>⏳ 上传头像、修改密码、用户自定义主题</li>
</ul>
<hr/>
<h3 data-id="heading-30">🗣️ 最后</h3>
<p>如果你也是 Java 工程师，不妨试试 TRAE SOLO，<br/>
你会发现：</p>
<blockquote>
<p>“AI 不是取代程序员，而是提升你的战斗力。”</p>
</blockquote>
<p>欢迎点赞、收藏、评论，我们一起用 AI 做点更酷的事！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四轮迭代，从零到完整游戏：用 SOLO Coder 做俄罗斯方块]]></title>    <link>https://juejin.cn/post/7582155513585549364</link>    <guid>https://juejin.cn/post/7582155513585549364</guid>    <pubDate>2025-12-11T02:53:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582155513585549364" data-draft-id="7582131164727951400" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四轮迭代，从零到完整游戏：用 SOLO Coder 做俄罗斯方块"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-11T02:53:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四轮迭代，从零到完整游戏：用 SOLO Coder 做俄罗斯方块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:53:22.000Z" title="Thu Dec 11 2025 02:53:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1b742e94274062a9dc810df8ba7667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=ICbY2f5kI5Jx2s0Nbb9dnYDOp5Y%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：茉卷，TRAE 开发者用户</p>
</blockquote>
<p>做一款游戏，现在已经不难了。</p>
<p>随着 AI 工具的普及，即使不写一行代码，任何人都能在几分钟内生成一个可以运行的游戏原型。只需要描述你的想法，AI 就能快速搭建出一个“能玩”的版本。</p>
<p>但问题是：从能玩到好玩、从原型到产品，中间隔着一道巨大的鸿沟。你可能会遇到这些困境：</p>
<ul>
<li>
<p>生成的游戏界面太粗糙，缺乏吸引力</p>
</li>
<li>
<p>想调整某个功能，但不知道如何精确控制</p>
</li>
<li>
<p>需要添加新玩法，却发现代码结构混乱难以扩展</p>
</li>
<li>
<p>想要持续迭代优化，但每次重新生成都会丢失之前的改动</p>
</li>
</ul>
<p>这就是 <strong>SOLO Coder</strong> 的价值所在：与一键生成不同，Coder 提供的是可控的、结构化的开发过程。</p>
<p>本文将从最初的一句“开发一个经典的俄罗斯方块游戏”开始，通过四轮结构化迭代，最终做出一个拥有炫酷特效、多种玩法、完整音效系统的真正可用的游戏项目。</p>
<p>这不是一次性的 demo 生成，而是一个完整的产品开发过程。</p>
<h2 data-id="heading-0"><strong>背景</strong></h2>
<h3 data-id="heading-1"><strong>核心目标：</strong></h3>
<p>探索 SOLO Coder 如何帮助开发者（包括非程序员）构建一个<strong>真正可用、可迭代的</strong>俄罗斯方块游戏项目。</p>
<p>使用 TRAE 的能力：</p>
<ul>
<li>
<p><strong>SOLO Coder</strong></p>
</li>
<li>
<p><strong>SOLO plan</strong></p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f16ae4ac8134ae2872e9f407a41f8cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=fOA4D%2Fz8GwehDI7Qtox0R1%2BZD7g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>第一轮迭代：从想法到原型</strong></h2>
<h3 data-id="heading-3"><strong>起点：一句话需求</strong></h3>
<p>最初，我只输入了一句简单的话：</p>
<blockquote>
<p><strong>原始提示词：</strong> 开发一个经典的俄罗斯方块游戏</p>
</blockquote>
<p>这时，TRAE 的<strong>提示词优化功能</strong>发挥了作用，将这句话扩展为一份详尽的专业需求文档：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/907a033014144c3e97c96f850265771f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=18Swxrgi1eSJxdix%2BzJ%2BiaaJy8Y%3D" alt="" loading="lazy"/></p>
<p><strong>优化后</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">开发一个经典的俄罗斯方块游戏，需包含以下核心功能：
<span class="hljs-bullet">1.</span> 游戏界面设计：
<span class="hljs-bullet">   -</span> 主游戏区域：10列×20行的标准网格
<span class="hljs-bullet">   -</span> 预览区域：显示下一个即将出现的方块
<span class="hljs-bullet">   -</span> 计分板：显示当前分数、消除行数和游戏等级
<span class="hljs-bullet">   -</span> 控制面板：包含开始/暂停/重置按钮

<span class="hljs-bullet">2.</span> 方块系统：
<span class="hljs-bullet">   -</span> 实现7种经典俄罗斯方块形状（I、J、L、O、S、T、Z）
<span class="hljs-bullet">   -</span> 每种方块使用不同颜色区分
<span class="hljs-bullet">   -</span> 支持方块的旋转（顺时针/逆时针）
<span class="hljs-bullet">   -</span> 方块下落速度随等级提升而加快

<span class="hljs-bullet">3.</span> 游戏机制：
<span class="hljs-bullet">   -</span> 方块自动下落功能
<span class="hljs-bullet">   -</span> 玩家控制（左移、右移、加速下落、旋转）
<span class="hljs-bullet">   -</span> 行消除判定与计分（单行/双行/三行/四行不同分值）
<span class="hljs-bullet">   -</span> 碰撞检测（边界碰撞、方块堆叠碰撞）
<span class="hljs-bullet">   -</span> 游戏结束条件（方块堆叠到顶部）

<span class="hljs-bullet">4.</span> 技术要求：
<span class="hljs-bullet">   -</span> 使用HTML5 Canvas或现代游戏引擎实现
<span class="hljs-bullet">   -</span> 确保60fps的流畅动画效果
<span class="hljs-bullet">   -</span> 实现响应式设计，适配不同屏幕尺寸
<span class="hljs-bullet">   -</span> 添加音效系统（移动、旋转、消除、游戏结束等音效）

<span class="hljs-bullet">5.</span> 测试要求：
<span class="hljs-bullet">   -</span> 所有方块形状的旋转逻辑测试
<span class="hljs-bullet">   -</span> 边界碰撞检测测试
<span class="hljs-bullet">   -</span> 计分系统准确性验证
<span class="hljs-bullet">   -</span> 不同等级的速度变化测试
</code></pre>
<h3 data-id="heading-4"><strong>技术文档自动生成</strong></h3>
<p>TRAE 随后生成了完整的技术文档，我们大概了解一下，直接继续。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab26a9503274abf8cf9f99311bae4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=bBquyMLWRXIKdQKK79qZeMPsNe0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ddbbb2467dc488f802b012cab501014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=E2FD%2BVeLu44gUea8dmhAcWnitWs%3D" alt="" loading="lazy"/></p>
<p><strong>技术文档全文</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 技术栈与项目结构（React 版）</span>
<span class="hljs-bullet">-</span> 技术栈：Vite + React + TypeScript + Canvas 渲染；Vitest + React Testing Library（测试），ESLint/Prettier（质量）
<span class="hljs-bullet">-</span> 运行目标：核心渲染由 Canvas 完成以保证 60fps；React 负责 UI（计分板/预览/控制）与状态展示
<span class="hljs-bullet">-</span> 目录结构：
<span class="hljs-bullet">  -</span> <span class="hljs-code">`index.html`</span>（根容器）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/main.tsx`</span>（React 应用入口）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/App.tsx`</span>（页面布局与顶层状态分发）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/components/GameCanvas.tsx`</span>（Canvas 渲染主游戏区：10×20）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/components/Preview.tsx`</span>（预览下一个方块）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/components/ScoreBoard.tsx`</span>（分数/行数/等级显示）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/components/Controls.tsx`</span>（开始/暂停/重置按钮，移动端可选触控）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/game/engine.ts`</span>（游戏引擎：循环/锁定/结束判定）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/game/board.ts`</span>（网格/行消除/碰撞）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/game/tetromino.ts`</span>（7 种方块与旋转，含 SRS 壁踢简化）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/game/spawn.ts`</span>（7-袋随机算法与预览队列）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/game/input.ts`</span>（键盘绑定与事件转发，React 层注册）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/render/canvasRenderer.ts`</span>（Canvas 绘制：方块/影子/堆叠/网格/预览）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/audio/sfx.ts`</span>（音效播放与静音切换）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/ui/layout.ts`</span>（响应式缩放与尺寸计算）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`src/constants.ts`</span> / <span class="hljs-code">`src/types.ts`</span>（常量与类型）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`assets/sfx/*`</span>（音效资源）
<span class="hljs-bullet">  -</span> <span class="hljs-code">`tests/*`</span>（逻辑与 UI 测试）

<span class="hljs-section">## React 集成策略</span>
<span class="hljs-bullet">-</span> 渲染与状态：
<span class="hljs-bullet">  -</span> 逻辑状态使用可变 <span class="hljs-code">`ref`</span>（避免每帧 React 重渲染）；Canvas 每帧绘制
<span class="hljs-bullet">  -</span> React 仅在重要事件（行消除/得分/等级变化/结束）触发一次性渲染（通过 <span class="hljs-code">`setState`</span>）
<span class="hljs-bullet">-</span> 事件流：
<span class="hljs-bullet">  -</span> 键盘事件在 <span class="hljs-code">`App`</span> 层注册，转发给 <span class="hljs-code">`engine`</span>；按钮通过 props 调用引擎方法
<span class="hljs-bullet">-</span> 组件职责：
<span class="hljs-bullet">  -</span> <span class="hljs-code">`GameCanvas`</span>：持有 Canvas 引用，初始化渲染器，订阅引擎回调
<span class="hljs-bullet">  -</span> <span class="hljs-code">`Preview/ScoreBoard/Controls`</span>：纯 UI 展示与控制

<span class="hljs-section">## 游戏机制（保持与原需求一致）</span>
<span class="hljs-bullet">-</span> 自动下落：基于等级的 <span class="hljs-code">`fallInterval`</span>；软降（加速）、硬降（到底立即锁定）
<span class="hljs-bullet">-</span> 控制：<span class="hljs-code">`←/→`</span> 左右移，<span class="hljs-code">`↑`</span> 顺时针，<span class="hljs-code">`Z`</span> 逆时针，<span class="hljs-code">`↓`</span> 软降，<span class="hljs-code">`Space`</span> 硬降
<span class="hljs-bullet">-</span> 行消除与计分：默认分值 100/300/500/800（可配置）；每 10 行升一级；速度按级递减（表驱动或 <span class="hljs-code">`0.85^level`</span>）
<span class="hljs-bullet">-</span> 碰撞检测：边界与堆叠；旋转失败尝试壁踢；新方块无法放置则结束

<span class="hljs-section">## 响应式与性能</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`layout.ts`</span> 根据容器尺寸动态计算单元格像素，保证 10×20 比例
<span class="hljs-bullet">-</span> 使用 <span class="hljs-code">`requestAnimationFrame`</span> 与时间累积控制下落；渲染与逻辑解耦
<span class="hljs-bullet">-</span> 降低 React 重渲染频率；Canvas 对齐像素减少模糊

<span class="hljs-section">## 音效系统</span>
<span class="hljs-bullet">-</span> 轻量实现：HTMLAudio（后续可升级 WebAudio）；提供 <span class="hljs-code">`mute`</span> 状态与 UI 切换
<span class="hljs-bullet">-</span> 事件绑定：移动/旋转/消除/结束触发音效

<span class="hljs-section">## 测试计划</span>
<span class="hljs-bullet">-</span> 逻辑单元测试（Vitest）：
<span class="hljs-bullet">  -</span> 旋转逻辑（含 I 的特殊壁踢）
<span class="hljs-bullet">  -</span> 边界/堆叠碰撞判定
<span class="hljs-bullet">  -</span> 计分与等级提升
<span class="hljs-bullet">  -</span> 速度映射（不同等级）与软/硬降行为
<span class="hljs-bullet">  -</span> 7-袋生成分布与不重复性
<span class="hljs-bullet">-</span> UI 测试（React Testing Library）：
<span class="hljs-bullet">  -</span> 控制按钮行为（开始/暂停/重置）
<span class="hljs-bullet">  -</span> 计分板显示同步更新
<span class="hljs-bullet">  -</span> 预览组件显示下一个方块

<span class="hljs-section">## 文档优化（README 结构建议）</span>
<span class="hljs-bullet">-</span> 项目简介与技术栈
<span class="hljs-bullet">-</span> 快速开始：
<span class="hljs-bullet">  -</span> 安装依赖、启动、构建命令
<span class="hljs-bullet">-</span> 目录结构与模块职责说明
<span class="hljs-bullet">-</span> 配置项说明：
<span class="hljs-bullet">  -</span> 分值/等级阈值/速度表/键位映射/颜色主题
<span class="hljs-bullet">-</span> 使用说明：
<span class="hljs-bullet">  -</span> 键位/按钮操作、移动端交互
<span class="hljs-bullet">-</span> 测试说明：
<span class="hljs-bullet">  -</span> 如何运行测试、测试范围与覆盖点
<span class="hljs-bullet">-</span> 性能与响应式策略摘要
<span class="hljs-bullet">-</span> 资源清单：音效文件与版权说明

<span class="hljs-section">## 里程碑与交付</span>
<span class="hljs-bullet">-</span> 阶段 1：Vite+React+TS 初始化、基础页面与布局、Canvas 容器
<span class="hljs-bullet">-</span> 阶段 2：核心游戏逻辑（board/tetromino/engine）、基本渲染与输入
<span class="hljs-bullet">-</span> 阶段 3：行消除/计分/等级、结束判定、预览区与音效
<span class="hljs-bullet">-</span> 阶段 4：响应式完善、UI 打磨、移动端交互（可选）
<span class="hljs-bullet">-</span> 阶段 5：测试完善与 60fps 稳定性校验、文档最终整理

<span class="hljs-section">## 说明与后续</span>
<span class="hljs-bullet">-</span> 当前目录为空，将按此 React 方案初始化并实现；文档将以上述结构编写与优化
<span class="hljs-bullet">-</span> 如需指定 UI 风格（颜色/字体/布局方式）或分值/速度策略，请说明；默认使用上述配置
<span class="hljs-bullet">-</span> 请确认是否按此 React 方案执行与文档结构输出；确认后我将开始落地
</code></pre>
<h3 data-id="heading-5"><strong>第一版成果</strong></h3>
<p>经过一轮生成，基本功能全部实现 ，游戏已经可以正常运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc7f83fb7e64f7c81d31ccb56fdead5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=25iYqELxb7aA6ZwoTpOdSvyS1V0%3D" alt="" loading="lazy"/></p>
<p>实现效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6d1b4aae0a401db7011aace834c65b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=eqvwhwtBkD4hLsgYut3na78AwMA%3D" alt="录屏2025-11-13 20.22.22.gif" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/351ead58a56847e5a78ef5a1ccf0128a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=BB80%2BmzvGGG1r0WExJ4GmFw6ZeI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>第二轮迭代：查漏补缺</strong></h2>
<h3 data-id="heading-7"><strong>使用 Plan 模式复盘</strong></h3>
<p>打开 <strong>Plan 模式</strong>，让 TRAE 总结当前进度：</p>
<p><strong>已完成：</strong></p>
<ul>
<li>
<p>阶段 1：项目初始化、基础页面与布局</p>
</li>
<li>
<p>阶段 2：核心游戏逻辑</p>
</li>
<li>
<p>阶段 3：行消除/计分/等级、预览区</p>
</li>
</ul>
<p><strong>待完成：</strong></p>
<ul>
<li>
<p>阶段 4：响应式完善、UI 打磨、移动端交互</p>
</li>
<li>
<p>阶段 5：测试完善与 60fps 稳定性校验、文档整理</p>
</li>
</ul>
<h3 data-id="heading-8"><strong>继续完成剩余任务</strong></h3>
<p>SOLO Coder 生成了新的实施文档，专门用于完成阶段 4 和 5。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af1c22d6f3364dd589ac0c2cb2721b8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=hZz7m2sJzSOLq4y9jOtv6%2FDQHjg%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81a472c4aa3646828b05ef5e018d1de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=gy1D1Wux873VEnrarg%2BIFFf41%2Fk%3D" alt="" loading="lazy"/></p>
<p>这里 SOLO Coder 生成了一个新文档，用来完成阶段 4 和 5。 </p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4397f4b9a9f1486aaeed11fb2a301de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=2Erbg3hYoCLyo%2FNURd1UyNMN67c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>第二版成果</strong></h3>
<p><strong>新增功能 ：</strong></p>
<ul>
<li>
<p>音效系统（移动、旋转、消除、游戏结束音效）</p>
</li>
<li>
<p>音频控制按钮（静音/取消静音）</p>
</li>
<li>
<p>响应式布局优化</p>
</li>
</ul>
<p><strong>不足之处：</strong></p>
<ul>
<li>界面还不够吸引人，缺乏视觉冲击力。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c3f321af93442d809f806b070c6217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=f%2FnxJRRFb277TRpTEpsj3BmpHK8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/164fbda9888e4bf1a8ef76ded299bcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=CyRcXsk0uifSFlbrTOkouq4xwk0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>第三轮迭代：视觉升级</strong></h2>
<h3 data-id="heading-11"><strong>提出优化需求</strong></h3>
<p><strong>原始提示词：</strong></p>
<blockquote>
<p>需要优化俄罗斯方块游戏的界面，增加趣味性，符合国际一流标准</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e16e4305956b41c0b0230834dbe5e19d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=Aen5n6DnFCOC5bV1KwbGX4Q85UI%3D" alt="" loading="lazy"/></p>
<p><strong>优化后提示词：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">优化俄罗斯方块游戏界面需要从视觉设计、交互体验和游戏趣味性三个维度进行全面升级，具体实施要求如下：

<span class="hljs-bullet">1.</span> 视觉设计优化：
<span class="hljs-bullet">-</span> 采用现代化扁平化设计风格，使用高对比度色彩方案（主色调不超过5种）
<span class="hljs-bullet">-</span> 游戏区域采用网格化设计，方块边缘增加1px发光特效
<span class="hljs-bullet">-</span> 背景实现动态粒子效果，随游戏进度变化强度
<span class="hljs-bullet">-</span> 所有UI元素必须支持4K分辨率，适配16:9和21:9屏幕比例

<span class="hljs-bullet">2.</span> 核心游戏性增强：
<span class="hljs-bullet">-</span> 新增&amp;#34;经典/极速/挑战&amp;#34;三种游戏模式选择界面
<span class="hljs-bullet">-</span> 实现方块预览功能（显示下3个即将出现的方块）
<span class="hljs-bullet">-</span> 加入连击特效系统（3连击触发火花，5连击触发闪电）
<span class="hljs-bullet">-</span> 积分系统重构为多维度评分（速度分/连击分/效率分）

<span class="hljs-bullet">3.</span> 交互体验升级：
<span class="hljs-bullet">-</span> 实现60fps流畅动画效果，所有转场动画时长控制在0.3s以内
<span class="hljs-bullet">-</span> 触控设备支持手势操作（左滑加速下落，右滑存储方块）
<span class="hljs-bullet">-</span> 增加震动反馈系统（不同操作对应不同震动模式）
<span class="hljs-bullet">-</span> 全界面支持键盘/手柄/触屏三套操作方案

<span class="hljs-bullet">-</span> 所有美术资源提供day/night两种主题模式

交付物要求：
<span class="hljs-bullet">1.</span> 完整的UI设计规范文档（含色彩代码和动效参数）
<span class="hljs-bullet">2.</span> 通过UserTesting平台获取的可用性测试报告
<span class="hljs-bullet">3.</span> 性能分析报告（内存占用 需要在俄罗斯方块的基础上，设计一些有趣的玩法
</code></pre>
<p><strong>优化后提示词：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">在俄罗斯方块经典玩法的基础上，设计并实现至少3种创新游戏模式，每种模式应包含以下要素：
<span class="hljs-code">    
1 . 游戏规则扩展：
   - 添加道具系统（如炸弹、旋转器、冻结等）
   - 设计关卡目标（如消除特定数量/颜色的方块）
   - 引入时间挑战或生存模式
</span>
2 . 视觉效果增强：
<span class="hljs-bullet">   -</span> 为特殊玩法设计专属粒子特效
<span class="hljs-bullet">   -</span> 添加动态背景和主题皮肤
<span class="hljs-bullet">   -</span> 实现方块消除时的连锁反应动画

<span class="hljs-bullet">3.</span> 技术实现要求：
<span class="hljs-bullet">   -</span> 保持基础物理引擎的稳定性
<span class="hljs-bullet">   -</span> 确保新玩法与经典模式的平滑切换
<span class="hljs-bullet">   -</span> 提供清晰的玩法教学指引

所有新玩法需经过平衡性测试，确保游戏难度曲线合理，并保留经典俄罗斯方块的核心操作手感。最终交付包含完整设计文档、可执行原型和用户测试报告。
</code></pre>
<p>我们提出要求，TRAE 继续先给出设计文档</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb32579251fd42caa3cdba217aae809d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=lqPRa%2BO6RWQAYlGcW5bDiAI7%2Fao%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>先实现一种：炸弹连锁模式</strong></h3>
<p>选择“炸弹连锁”模式作为首个创新玩法进行实现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a0937fe156842d18b108ea76619dcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=buMM2YOcwaBp0%2FvvqIipiRLwu0M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>第四版成果</strong></h3>
<p><strong>炸弹连锁模式上线 ：</strong></p>
<ul>
<li>
<p>随机方块中会出现炸弹道具</p>
</li>
<li>
<p>炸弹落地后会引发连锁爆炸效果</p>
</li>
<li>
<p>爆炸产生专属粒子特效</p>
</li>
<li>
<p>新增模式选择界面</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e52f6056cfa4628a235518e7a02cffe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766026402&amp;x-signature=2yqixCyhxYW9JoUIp53kSW%2BesQU%3D" alt="录屏2025-11-13 21.56.28.gif" loading="lazy"/></p>
<h2 data-id="heading-14"><strong>核心收获：SOLO Coder 如何让项目真正可用</strong></h2>
<h3 data-id="heading-15"><strong>1. 用自然语言交流，但获得专业级的技术方案</strong></h3>
<p>整个生成过程可以不懂技术概念。我的输入从最初的“开发一个经典的俄罗斯方块游戏”，到后来的“优化界面”、“增加玩法”，都只是自然语言描述。【提示词优化功能】会将这些需求“翻译”成专业的开发提示词，SOLO Coder 会生成技术文档，这极大地降低了创造的门槛。</p>
<p>这意味着：即使你不是程序员，也能得到一个程序员能看懂、能维护的项目。</p>
<h3 data-id="heading-16"><strong>2. 从骨架到血肉：清晰的“规划-实现”迭代路径</strong></h3>
<p>我们可以利用 SOLO Coder 的 Plan 功能先出具一份详尽的技术文档，搭建好游戏的“骨架”。第一轮迭代后，进行“复盘”，检查哪些任务已经完成，哪些尚未实现，并据此制定下一阶段的计划。这种结构化的推进方式，让开发者对整个项目的进度一目了然，非常有安全感，感觉项目始终在可控的轨道上推进。</p>
<h3 data-id="heading-17"><strong>3. 超越“能玩”：AI 是创意的放大器</strong></h3>
<p>当基础功能实现后，我的需求变得更为模糊，比如“界面不够吸引人”、“设计一些有趣的玩法”。SOLO Coder 的价值在这里得到了最大体现。它没有简单地换个颜色了事，而是从视觉设计、交互体验到游戏模式进行了系统性升级，提出了动态粒子背景、多种游戏模式、炸弹道具等不错的点子。</p>
<p>当创意还只是一个模糊的概念时，SOLO Coder 能快速将它转化为可视原型。它不仅是验证工具，更是灵感引擎，帮助我们在早期探索中打破僵局，明确方向。</p>
<p><strong>可以看到，SOLO Coder 正在改变的，不是“能不能做”，而是“能做到什么程度”。</strong></p>
<p>从最初的一句话需求，到最终拥有炫酷特效、多种玩法、完整音效系统的俄罗斯方块游戏，整个过程只用了四轮迭代。更重要的是，这不是一个用完即弃的 demo，而是一个真正可用、可维护、可扩展的项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[seatunnel-一种场景mysqlcdc同步进入clickhouse基于2.3.11版本]]></title>    <link>https://juejin.cn/post/7582118218648436762</link>    <guid>https://juejin.cn/post/7582118218648436762</guid>    <pubDate>2025-12-11T02:30:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118218648436762" data-draft-id="7582118218648420378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="seatunnel-一种场景mysqlcdc同步进入clickhouse基于2.3.11版本"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2025-12-11T02:30:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="肌肉娃子"/> <meta itemprop="url" content="https://juejin.cn/user/1029576003433870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            seatunnel-一种场景mysqlcdc同步进入clickhouse基于2.3.11版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1029576003433870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    肌肉娃子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:30:53.000Z" title="Thu Dec 11 2025 02:30:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">seatunnel-一种场景mysqlcdc同步进入clickhouse基于2.3.11版本</h2>
<h2 data-id="heading-1">MySQL CDC 到 ClickHouse 完整数据流转分析</h2>
<h3 data-id="heading-2">概述</h3>
<p>本文档详细分析在 <code>startup_mode=&amp;#34;initial&amp;#34;</code> 模式下，数据从 MySQL CDC Source 读取到 ClickHouse Sink 的完整流转过程。我们将深入探讨每个环节的具体函数调用链、数据转换过程以及关键实现细节。</p>
<h3 data-id="heading-3">整体流程概览</h3>
<pre><code class="hljs language-sql" lang="sql">MySQL Binlog<span class="hljs-operator">/</span>Snapshot → CDC Source Reader → SeaTunnel <span class="hljs-type">Row</span> → ClickHouse Sink Writer → ClickHouse
</code></pre>
<h3 data-id="heading-4">详细函数调用链分析</h3>
<h4 data-id="heading-5">第一阶段：任务启动与初始化</h4>
<h5 data-id="heading-6">1.1 SeaTunnel 任务启动</h5>
<pre><code class="hljs language-scss" lang="scss">SeaTunnel<span class="hljs-selector-class">.run</span>(command) → command<span class="hljs-selector-class">.execute</span>() → TaskExecution<span class="hljs-selector-class">.execute</span>()
</code></pre>
<p><strong>入口函数</strong>: <code>org.apache.seatunnel.core.starter.SeaTunnel.run()</code></p>
<ul>
<li>• 接收命令行参数，启动 SeaTunnel 任务</li>
<li>• 调用具体的执行命令</li>
</ul>
<h5 data-id="heading-7">1.2 Source 初始化</h5>
<pre><code class="hljs language-scss" lang="scss">MySqlIncrementalSource<span class="hljs-selector-class">.createReader</span>() → <span class="hljs-built_in">IncrementalSourceReader</span>() → MySqlDialect<span class="hljs-selector-class">.createFetchTaskContext</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>MySqlIncrementalSource.createReader()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> SourceReader <span class="hljs-title function_">createReader</span><span class="hljs-params">(SourceReader.Context context)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 创建增量源读取器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncrementalSourceReader</span>&lt;&gt;(
        dataSourceDialect,
        elementsQueue,
        splitReaderSupplier,
        recordEmitter,
        options,
        context,
        configFactory.create(<span class="hljs-number">0</span>),
        deserializationSchema
    );
}
</code></pre>
<h5 data-id="heading-8">1.3 Sink 初始化</h5>
<pre><code class="hljs language-scss" lang="scss">ClickhouseSink<span class="hljs-selector-class">.createWriter</span>() → <span class="hljs-built_in">ClickhouseSinkWriter</span>() → <span class="hljs-built_in">initStatementMap</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>ClickhouseSink.createWriter()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> ClickhouseSinkWriter <span class="hljs-title function_">createWriter</span><span class="hljs-params">(SinkWriter.Context context)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 1. 创建 ClickHouse 节点连接</span>
    <span class="hljs-type">List</span> <span class="hljs-variable">nodes</span> <span class="hljs-operator">=</span> ClickhouseUtil.createNodes(readonlyConfig);
    
    <span class="hljs-comment">// 2. 创建代理连接</span>
    <span class="hljs-type">ClickhouseProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClickhouseProxy</span>(nodes.get(<span class="hljs-number">0</span>));
    
    <span class="hljs-comment">// 3. 获取表结构信息</span>
    <span class="hljs-type">Map</span> <span class="hljs-variable">tableSchema</span> <span class="hljs-operator">=</span> proxy.getClickhouseTableSchema(readonlyConfig.get(TABLE));
    
    <span class="hljs-comment">// 4. 创建分片路由器</span>
    <span class="hljs-type">ShardRouter</span> <span class="hljs-variable">shardRouter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardRouter</span>(proxy, option.getShardMetadata());
    
    <span class="hljs-comment">// 5. 创建批次执行器映射</span>
    <span class="hljs-type">Map</span> <span class="hljs-variable">statementMap</span> <span class="hljs-operator">=</span> initStatementMap();
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClickhouseSinkWriter</span>(option, context);
}
</code></pre>
<h4 data-id="heading-9">第二阶段：数据分片与分配（Source 端）</h4>
<h5 data-id="heading-10">2.1 分片分配器初始化</h5>
<pre><code class="hljs">IncrementalSourceEnumerator → HybridSplitAssigner → MySqlChunkSplitter
</code></pre>
<p><strong>关键函数</strong>: <code>HybridSplitAssigner.getNext()</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Optional getNext() {
    <span class="hljs-comment">// 1. 首先分配快照分片</span>
    <span class="hljs-keyword">if</span> (!snapshotAssigner.isFinished()) {
        <span class="hljs-keyword">return</span> snapshotAssigner.getNext();
    }
    
    <span class="hljs-comment">// 2. 快照完成后分配增量分片</span>
    <span class="hljs-keyword">if</span> (incrementalSplitAssigner != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> incrementalSplitAssigner.getNext();
    }
    
    <span class="hljs-keyword">return</span> Optional.empty();
}
</code></pre>
<h5 data-id="heading-11">2.2 分片算法实现</h5>
<pre><code class="hljs language-scss" lang="scss">MySqlChunkSplitter<span class="hljs-selector-class">.queryMinMax</span>() → MySqlUtils<span class="hljs-selector-class">.queryMinMax</span>() → <span class="hljs-built_in">buildSplitScanQuery</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>MySqlUtils.queryMinMax()</code></p>
<pre><code class="hljs language-scss" lang="scss">public static <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> <span class="hljs-built_in">queryMinMax</span>(JdbcConnection jdbc, TableId tableId, String columnName) throws SQLException {
    final String minMaxQuery = String<span class="hljs-selector-class">.format</span>(
        &amp;#<span class="hljs-number">34</span>;SELECT MIN(%s), <span class="hljs-built_in">MAX</span>(%s) FROM %s&amp;<span class="hljs-selector-id">#34</span>;,
        <span class="hljs-selector-tag">quote</span>(columnName), <span class="hljs-selector-tag">quote</span>(columnName), <span class="hljs-selector-tag">quote</span>(tableId)
    );
    
    return jdbc<span class="hljs-selector-class">.queryAndMap</span>(minMaxQuery, rs -&gt; {
        if (!rs.next()) {
            throw new <span class="hljs-built_in">SQLException</span>(String.format(&amp;#<span class="hljs-number">34</span>;No result returned after running query [%s]&amp;#<span class="hljs-number">34</span>;, minMaxQuery));
        }
        return <span class="hljs-built_in">rowToArray</span>(rs, <span class="hljs-number">2</span>);
    });
}
</code></pre>
<h4 data-id="heading-12">第三阶段：全量数据读取（Source 端）</h4>
<h5 data-id="heading-13">3.1 快照任务执行</h5>
<pre><code class="hljs language-scss" lang="scss">MySqlSnapshotFetchTask<span class="hljs-selector-class">.execute</span>() → MySqlSnapshotSplitReadTask<span class="hljs-selector-class">.execute</span>() → <span class="hljs-built_in">doExecute</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>MySqlSnapshotSplitReadTask.doExecute()</code></p>
<pre><code class="hljs language-ini" lang="ini">@Override
protected SnapshotResult doExecute(
        ChangeEventSourceContext context,
        MySqlOffsetContext previousOffset,
        SnapshotContext snapshotContext,
        SnapshottingTask snapshottingTask) throws Exception {
    
    final MySqlSnapshotContext <span class="hljs-attr">ctx</span> = (MySqlSnapshotContext) snapshotContext<span class="hljs-comment">;</span>
    <span class="hljs-attr">ctx.offset</span> = <span class="hljs-literal">off</span>setContext<span class="hljs-comment">;</span>
    
    // 步骤1：确定低水位标记（开始时的 binlog 位置）
    final BinlogOffset <span class="hljs-attr">lowWatermark</span> = currentBinlog<span class="hljs-literal">Off</span>set(jdbcConnection)<span class="hljs-comment">;</span>
    LOG.info(&amp;<span class="hljs-comment">#34;Snapshot step 1 - Determining low watermark {} for split {}&amp;#34;, lowWatermark, snapshotSplit);</span>
    ((SnapshotSplitChangeEventSourceContext) context).setLowWatermark(lowWatermark)<span class="hljs-comment">;</span>
    dispatcher.dispatchWatermarkEvent(
        ctx.partition.getSourcePartition(), snapshotSplit, lowWatermark, WatermarkKind.LOW)<span class="hljs-comment">;</span>
    
    // 步骤2：快照数据
    LOG.info(&amp;<span class="hljs-comment">#34;Snapshot step 2 - Snapshotting data&amp;#34;);</span>
    createDataEvents(ctx, snapshotSplit.getTableId())<span class="hljs-comment">;</span>
    
    // 步骤3：确定高水位标记（结束时的 binlog 位置）
    final BinlogOffset <span class="hljs-attr">highWatermark</span> = currentBinlog<span class="hljs-literal">Off</span>set(jdbcConnection)<span class="hljs-comment">;</span>
    LOG.info(&amp;<span class="hljs-comment">#34;Snapshot step 3 - Determining high watermark {} for split {}&amp;#34;, highWatermark, snapshotSplit);</span>
    ((SnapshotSplitChangeEventSourceContext) context).setHighWatermark(highWatermark)<span class="hljs-comment">;</span>
    dispatcher.dispatchWatermarkEvent(
        ctx.partition.getSourcePartition(), snapshotSplit, highWatermark, WatermarkKind.HIGH)<span class="hljs-comment">;</span>
    
    return SnapshotResult.completed(ctx.offset)<span class="hljs-comment">;</span>
}
</code></pre>
<h5 data-id="heading-14">3.2 数据事件创建</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">createDataEvents</span>() → <span class="hljs-built_in">createDataEventsForTable</span>() → <span class="hljs-built_in">createDataEventsForTable</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>MySqlSnapshotSplitReadTask.createDataEventsForTable()</code></p>
<pre><code class="hljs language-ini" lang="ini">private void createDataEventsForTable(
        MySqlSnapshotContext snapshotContext,
        EventDispatcher.SnapshotReceiver snapshotReceiver,
        Table table) throws InterruptedException {
    
    long <span class="hljs-attr">exportStart</span> = clock.currentTimeInMillis()<span class="hljs-comment">;</span>
    LOG.info(&amp;<span class="hljs-comment">#34;Exporting data from split '{}' of table {}&amp;#34;, snapshotSplit.splitId(), table.id());</span>
    
    // 构建分片查询 SQL
    final String <span class="hljs-attr">selectSql</span> = buildSplitScanQuery(
        snapshotSplit.getTableId(),
        snapshotSplit.getSplitKeyType(),
        snapshotSplit.getSplitStart() == null,
        snapshotSplit.getSplitEnd() == null
    )<span class="hljs-comment">;</span>
    
    // 执行查询并创建数据事件
    try (PreparedStatement <span class="hljs-attr">statement</span> = readTableSplitDataStatement(selectSql, snapshotSplit)<span class="hljs-comment">;</span>
         ResultSet <span class="hljs-attr">resultSet</span> = statement.executeQuery()) {
        
        ColumnUtils.ColumnArray <span class="hljs-attr">columnArray</span> = ColumnUtils.toArray(table, resultSet.getMetaData())<span class="hljs-comment">;</span>
        long <span class="hljs-attr">rows</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        Timer <span class="hljs-attr">logTimer</span> = getTableScanLogTimer()<span class="hljs-comment">;</span>
        
        while (resultSet.next()) {
            rows++<span class="hljs-comment">;</span>
            final Object<span class="hljs-section">[]</span> <span class="hljs-attr">row</span> = new Object[columnArray.getGreatestColumnPosition()]<span class="hljs-comment">;</span>
            
            // 从 ResultSet 中提取数据
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; columnArray.getColumns().length; i++) {</span>
                Column <span class="hljs-attr">column</span> = columnArray.getColumns()[i]<span class="hljs-comment">;</span>
                int <span class="hljs-attr">position</span> = columnArray.getColumnPositions()[i]<span class="hljs-comment">;</span>
                row<span class="hljs-section">[position - 1]</span> = readColumnValue(resultSet, i + 1, column)<span class="hljs-comment">;</span>
            }
            
            // 创建快照变更记录
            SnapshotChangeRecordEmitter <span class="hljs-attr">recordEmitter</span> = new SnapshotChangeRecordEmitter(
                partition, offsetContext, table.id(), row, clock.currentTimeAsInstant()
            )<span class="hljs-comment">;</span>
            
            // 分发数据变更事件
            dispatcher.dispatchSnapshotEvent(snapshotContext.partition, table.id(), recordEmitter)<span class="hljs-comment">;</span>
            
            // 定期记录进度
            if (logTimer.expired()) {
                LOG.info(&amp;<span class="hljs-comment">#34;Exported {} records for table '{}' from split '{}'&amp;#34;, rows, table.id(), snapshotSplit.splitId());</span>
                <span class="hljs-attr">logTimer</span> = getTableScanLogTimer()<span class="hljs-comment">;</span>
            }
        }
        
        LOG.info(&amp;<span class="hljs-comment">#34;Export {} records for table '{}' from split '{}'&amp;#34;, rows, table.id(), snapshotSplit.splitId());</span>
    }
}
</code></pre>
<h4 data-id="heading-15">第四阶段：数据反序列化转换</h4>
<h5 data-id="heading-16">4.1 Debezium 事件转换</h5>
<pre><code class="hljs language-scss" lang="scss">SeaTunnelRowDebeziumDeserializeSchema<span class="hljs-selector-class">.deserialize</span>() → <span class="hljs-built_in">extractAfterRow</span>()/<span class="hljs-built_in">extractBeforeRow</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>SeaTunnelRowDebeziumDeserializeSchema.deserializeDataChangeRecord()</code></p>
<pre><code class="hljs language-ini" lang="ini">private void deserializeDataChangeRecord(SourceRecord record, Collector collector) throws Exception {
    Envelope.Operation <span class="hljs-attr">operation</span> = Envelope.operationFor(record)<span class="hljs-comment">;</span>
    Struct <span class="hljs-attr">messageStruct</span> = (Struct) record.value()<span class="hljs-comment">;</span>
    Schema <span class="hljs-attr">valueSchema</span> = record.valueSchema()<span class="hljs-comment">;</span>
    TablePath <span class="hljs-attr">tablePath</span> = SourceRecordUtils.getTablePath(record)<span class="hljs-comment">;</span>
    String <span class="hljs-attr">tableId</span> = tablePath.toString()<span class="hljs-comment">;</span>
    
    // 获取对应表的转换器
    SeaTunnelRowDebeziumDeserializationConverters <span class="hljs-attr">converters</span> = tableRowConverters.get(tableId)<span class="hljs-comment">;</span>
    
    Long <span class="hljs-attr">fetchTimestamp</span> = SourceRecordUtils.getFetchTimestamp(record)<span class="hljs-comment">;</span>
    Long <span class="hljs-attr">messageTimestamp</span> = SourceRecordUtils.getMessageTimestamp(record)<span class="hljs-comment">;</span>
    long <span class="hljs-attr">delay</span> = -<span class="hljs-number">1</span>L<span class="hljs-comment">;</span>
    if (fetchTimestamp != null &amp;&amp; messageTimestamp != null) {
        <span class="hljs-attr">delay</span> = fetchTimestamp - messageTimestamp<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">operation</span> == Envelope.Operation.CREATE || operation == Envelope.Operation.READ) {
        // INSERT 操作（全量快照中的数据也标记为 INSERT）
        SeaTunnelRow <span class="hljs-attr">insert</span> = extractAfterRow(converters, record, messageStruct, valueSchema)<span class="hljs-comment">;</span>
        insert.setRowKind(RowKind.INSERT)<span class="hljs-comment">;</span>
        insert.setTableId(tableId)<span class="hljs-comment">;</span>
        MetadataUtil.setDelay(insert, delay)<span class="hljs-comment">;</span>
        MetadataUtil.setEventTime(insert, fetchTimestamp)<span class="hljs-comment">;</span>
        collector.collect(insert)<span class="hljs-comment">;</span>
        
    } else if (<span class="hljs-attr">operation</span> == Envelope.Operation.DELETE) {
        // DELETE 操作
        SeaTunnelRow <span class="hljs-attr">delete</span> = extractBeforeRow(converters, record, messageStruct, valueSchema)<span class="hljs-comment">;</span>
        delete.setRowKind(RowKind.DELETE)<span class="hljs-comment">;</span>
        delete.setTableId(tableId)<span class="hljs-comment">;</span>
        MetadataUtil.setDelay(delete, delay)<span class="hljs-comment">;</span>
        MetadataUtil.setEventTime(delete, fetchTimestamp)<span class="hljs-comment">;</span>
        collector.collect(delete)<span class="hljs-comment">;</span>
        
    } else if (<span class="hljs-attr">operation</span> == Envelope.Operation.UPDATE) {
        // UPDATE 操作（生成两行：UPDATE_BEFORE 和 UPDATE_AFTER）
        SeaTunnelRow <span class="hljs-attr">before</span> = extractBeforeRow(converters, record, messageStruct, valueSchema)<span class="hljs-comment">;</span>
        before.setRowKind(RowKind.UPDATE_BEFORE)<span class="hljs-comment">;</span>
        before.setTableId(tableId)<span class="hljs-comment">;</span>
        MetadataUtil.setDelay(before, delay)<span class="hljs-comment">;</span>
        MetadataUtil.setEventTime(before, fetchTimestamp)<span class="hljs-comment">;</span>
        collector.collect(before)<span class="hljs-comment">;</span>
        
        SeaTunnelRow <span class="hljs-attr">after</span> = extractAfterRow(converters, record, messageStruct, valueSchema)<span class="hljs-comment">;</span>
        after.setRowKind(RowKind.UPDATE_AFTER)<span class="hljs-comment">;</span>
        after.setTableId(tableId)<span class="hljs-comment">;</span>
        MetadataUtil.setDelay(after, delay)<span class="hljs-comment">;</span>
        MetadataUtil.setEventTime(after, fetchTimestamp)<span class="hljs-comment">;</span>
        collector.collect(after)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-17">4.2 数据类型转换</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">extractAfterRow</span>() → converters<span class="hljs-selector-class">.getAfterRowConverter</span>()<span class="hljs-selector-class">.convert</span>() → RowConverter
</code></pre>
<p><strong>关键函数</strong>: <code>SeaTunnelRowDebeziumDeserializationConverters.extractAfterRow()</code></p>
<pre><code class="hljs language-ini" lang="ini">public SeaTunnelRow extractAfterRow(SourceRecord record, Struct value, Schema valueSchema) throws Exception {
    Struct <span class="hljs-attr">after</span> = value.getStruct(Envelope.FieldName.AFTER)<span class="hljs-comment">;</span>
    Schema <span class="hljs-attr">afterSchema</span> = valueSchema.field(Envelope.FieldName.AFTER).schema()<span class="hljs-comment">;</span>
    
    SeaTunnelRow <span class="hljs-attr">row</span> = new SeaTunnelRow(fieldConverters.length)<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; fieldConverters.length; i++) {</span>
        String <span class="hljs-attr">fieldName</span> = fieldNames[i]<span class="hljs-comment">;</span>
        Object <span class="hljs-attr">fieldValue</span> = after.get(fieldName)<span class="hljs-comment">;</span>
        Object <span class="hljs-attr">convertedValue</span> = fieldConverters[i].convert(fieldValue)<span class="hljs-comment">;</span>
        row.setField(i, convertedValue)<span class="hljs-comment">;</span>
    }
    
    // 设置元数据字段
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; metadataConverters.length; i++) {</span>
        row.setField(fieldConverters.length + i, metadataConverters<span class="hljs-section">[i]</span>.convert(record))<span class="hljs-comment">;</span>
    }
    
    return row<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-18">第五阶段：数据写入 ClickHouse</h4>
<h5 data-id="heading-19">5.1 Sink Writer 接收数据</h5>
<pre><code class="hljs language-scss" lang="scss">ClickhouseSinkWriter<span class="hljs-selector-class">.write</span>() → shardRouter<span class="hljs-selector-class">.getShard</span>() → <span class="hljs-built_in">addIntoBatch</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>ClickhouseSinkWriter.write()</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void write(SeaTunnelRow element) throws IOException {
    <span class="hljs-comment">// 1. 确定分片键值</span>
    <span class="hljs-selector-tag">Object</span> shardKey = null;
    if (StringUtils.isNotEmpty(this.option.getShardMetadata()<span class="hljs-selector-class">.getShardKey</span>())) {
        int <span class="hljs-selector-tag">i</span> = this<span class="hljs-selector-class">.option</span><span class="hljs-selector-class">.getSeaTunnelRowType</span>()<span class="hljs-selector-class">.indexOf</span>(this.option.getShardMetadata()<span class="hljs-selector-class">.getShardKey</span>());
        shardKey = element<span class="hljs-selector-class">.getField</span>(i);
    }
    
    <span class="hljs-comment">// 2. 路由到目标分片</span>
    ClickhouseBatchStatement statement = statementMap<span class="hljs-selector-class">.get</span>(shardRouter.getShard(shardKey));
    JdbcBatchStatementExecutor clickHouseStatement = statement<span class="hljs-selector-class">.getJdbcBatchStatementExecutor</span>();
    IntHolder sizeHolder = statement<span class="hljs-selector-class">.getIntHolder</span>();
    
    <span class="hljs-comment">// 3. 添加到批次</span>
    <span class="hljs-built_in">addIntoBatch</span>(element, clickHouseStatement);
    sizeHolder<span class="hljs-selector-class">.setValue</span>(sizeHolder.getValue() + <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 4. 批量刷新</span>
    if (sizeHolder.getValue() &gt;= option<span class="hljs-selector-class">.getBulkSize</span>()) {
        <span class="hljs-built_in">flush</span>(clickHouseStatement);
        sizeHolder<span class="hljs-selector-class">.setValue</span>(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h5 data-id="heading-20">5.2 分片路由算法</h5>
<pre><code class="hljs language-scss" lang="scss">ShardRouter<span class="hljs-selector-class">.getShard</span>() → HASH_INSTANCE<span class="hljs-selector-class">.hash</span>() → TreeMap<span class="hljs-selector-class">.lowerEntry</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>ShardRouter.getShard()</code></p>
<pre><code class="hljs language-scss" lang="scss">public Shard <span class="hljs-built_in">getShard</span>(Object shardValue) {
    if (!splitMode) {
        return shards<span class="hljs-selector-class">.firstEntry</span>()<span class="hljs-selector-class">.getValue</span>();
    }
    
    if (StringUtils.isEmpty(shardKey) || shardValue == null) {
        <span class="hljs-comment">// 没有分片键时随机选择</span>
        return shards<span class="hljs-selector-class">.lowerEntry</span>(threadLocalRandom.nextInt(shardWeightCount) + <span class="hljs-number">1</span>)<span class="hljs-selector-class">.getValue</span>();
    }
    
    <span class="hljs-comment">// 使用 XXHash64 进行一致性哈希</span>
    int offset = (int) ((HASH_INSTANCE.hash(
        ByteBuffer.wrap(shardValue.toString()<span class="hljs-selector-class">.getBytes</span>(StandardCharsets.UTF_8)), <span class="hljs-number">0</span>) &amp; Long<span class="hljs-selector-class">.MAX_VALUE</span>)
        % shardWeightCount);
    
    return shards<span class="hljs-selector-class">.lowerEntry</span>(offset + <span class="hljs-number">1</span>)<span class="hljs-selector-class">.getValue</span>();
}
</code></pre>
<h5 data-id="heading-21">5.3 批量执行器处理</h5>
<pre><code class="hljs language-scss" lang="scss">JdbcBatchStatementExecutorBuilder<span class="hljs-selector-class">.build</span>() → SimpleBatchStatementExecutor → <span class="hljs-built_in">executeBatch</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>SimpleBatchStatementExecutor.executeBatch()</code></p>
<pre><code class="hljs language-csharp" lang="csharp">@Override
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeBatch</span>() throws SQLException</span> {
    <span class="hljs-keyword">if</span> (batchCount &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行批量插入</span>
            statement.executeBatch();
            connection.commit();
            batchCount = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            connection.rollback();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClickhouseConnectorException(
                CommonErrorCodeDeprecated.FLUSH_DATA_FAILED,
                &amp;<span class="hljs-meta">#34;Clickhouse execute batch statement <span class="hljs-keyword">error</span>&amp;#34;,</span>
                e
            );
        }
    }
}
</code></pre>
<h5 data-id="heading-22">5.4 数据类型注入</h5>
<pre><code class="hljs language-scss" lang="scss">JdbcRowConverter<span class="hljs-selector-class">.toExternal</span>() → fieldInjectFunctionMap<span class="hljs-selector-class">.get</span>()<span class="hljs-selector-class">.injectFields</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>JdbcRowConverter.toExternal()</code></p>
<pre><code class="hljs language-ini" lang="ini">public PreparedStatement toExternal(SeaTunnelRow row, PreparedStatement statement) throws SQLException {
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; projectionFields.length; i++) {</span>
        String <span class="hljs-attr">fieldName</span> = projectionFields[i]<span class="hljs-comment">;</span>
        Object <span class="hljs-attr">fieldValue</span> = fieldGetterMap.get(fieldName).apply(row)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">fieldValue</span> == null) {
            statement.setObject(i + 1, null)<span class="hljs-comment">;</span>
            continue<span class="hljs-comment">;</span>
        }
        
        // 使用对应的注入函数处理字段值
        fieldInjectFunctionMap
            .getOrDefault(fieldName, DEFAULT_INJECT_FUNCTION)
            .injectFields(statement, i + 1, fieldValue)<span class="hljs-comment">;</span>
    }
    return statement<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-23">第六阶段：增量阶段切换</h4>
<h5 data-id="heading-24">6.1 快照完成检测</h5>
<pre><code class="hljs language-scss" lang="scss">IncrementalSourceReader<span class="hljs-selector-class">.onSplitFinished</span>() → <span class="hljs-built_in">reportFinishedSnapshotSplitsIfNeed</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>IncrementalSourceReader.onSplitFinished()</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
protected void onSplitFinished(Map finishedSplitIds) {
    for (SourceSplitStateBase splitState : finishedSplitIds.values()) {
        SourceSplitBase sourceSplit = splitState<span class="hljs-selector-class">.toSourceSplit</span>();
        <span class="hljs-built_in">checkState</span>(
            sourceSplit.isSnapshotSplit() &amp;&amp; sourceSplit<span class="hljs-selector-class">.asSnapshotSplit</span>()<span class="hljs-selector-class">.isSnapshotReadFinished</span>(),
            String<span class="hljs-selector-class">.format</span>(&amp;#<span class="hljs-number">34</span>;Only snapshot split could finish, but the actual split is incremental split %s&amp;#<span class="hljs-number">34</span>;, sourceSplit)
        );
        finishedUnackedSplits<span class="hljs-selector-class">.put</span>(sourceSplit.splitId(), sourceSplit<span class="hljs-selector-class">.asSnapshotSplit</span>());
    }
    <span class="hljs-built_in">reportFinishedSnapshotSplitsIfNeed</span>();
    context<span class="hljs-selector-class">.sendSplitRequest</span>(); <span class="hljs-comment">// 请求下一个分片</span>
}
</code></pre>
<h5 data-id="heading-25">6.2 增量分片分配</h5>
<pre><code class="hljs language-scss" lang="scss">HybridSplitAssigner<span class="hljs-selector-class">.getNext</span>() → incrementalSplitAssigner<span class="hljs-selector-class">.getNext</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>IncrementalSplitAssigner.getNext()</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public Optional getNext() {
    if (remainingTables.isEmpty()) {
        return Optional<span class="hljs-selector-class">.empty</span>();
    }
    
    <span class="hljs-comment">// 为每个表创建一个增量分片</span>
    TableId tableId = remainingTables<span class="hljs-selector-class">.iterator</span>()<span class="hljs-selector-class">.next</span>();
    remainingTables<span class="hljs-selector-class">.remove</span>(tableId);
    
    <span class="hljs-comment">// 创建增量分片，从快照的高水位标记开始</span>
    IncrementalSplit split = new <span class="hljs-built_in">IncrementalSplit</span>(
        tableId.toString(),
        Collections<span class="hljs-selector-class">.singletonList</span>(tableId),
        completedSnapshotSplitWatermarks<span class="hljs-selector-class">.get</span>(tableId)<span class="hljs-selector-class">.getHighWatermark</span>(),
        stopOffset,
        Collections<span class="hljs-selector-class">.emptyList</span>()
    );
    
    return Optional<span class="hljs-selector-class">.of</span>(split);
}
</code></pre>
<h5 data-id="heading-26">6.3 Binlog 事件处理</h5>
<pre><code class="hljs language-scss" lang="scss">MySqlBinlogFetchTask<span class="hljs-selector-class">.execute</span>() → MySqlStreamingChangeEventSource<span class="hljs-selector-class">.execute</span>() → <span class="hljs-built_in">handleEvent</span>()
</code></pre>
<p><strong>关键函数</strong>: <code>MySqlBinlogFetchTask.MySqlBinlogSplitReadTask.handleEvent()</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
protected void handleEvent(MySqlPartition partition, MySqlOffsetContext offsetContext, Event event) {
    super<span class="hljs-selector-class">.handleEvent</span>(partition, offsetContext, event);
    
    <span class="hljs-comment">// 检查是否需要停止（有界读取）</span>
    if (isBoundedRead()) {
        final BinlogOffset currentBinlogOffset = <span class="hljs-built_in">getBinlogPosition</span>(offsetContext.getOffset());
        
        <span class="hljs-comment">// 达到高水位标记，结束 binlog 读取</span>
        if (currentBinlogOffset.isAtOrAfter(binlogSplit.getStopOffset())) {
            <span class="hljs-comment">// 发送 binlog 结束事件</span>
            dispatcher<span class="hljs-selector-class">.dispatchWatermarkEvent</span>(
                partition.getSourcePartition(),
                binlogSplit,
                currentBinlogOffset,
                WatermarkKind<span class="hljs-selector-class">.END</span>
            );
            <span class="hljs-comment">// 通知读取器任务完成</span>
            ((MySqlSnapshotFetchTask.SnapshotBinlogSplitChangeEventSourceContext) context)<span class="hljs-selector-class">.finished</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-27">关键数据转换过程</h3>
<h4 data-id="heading-28">1. MySQL 数据类型到 SeaTunnel 类型的转换</h4>
<p><strong>转换器</strong>: <code>MySqlTypeUtils.convertFromColumn()</code></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SeaTunnelDataType <span class="hljs-title">convertFromColumn</span>(<span class="hljs-params">Column column, RelationalDatabaseConnectorConfig config</span>)</span> {
    String mysqlType = column.typeName().toUpperCase();
    
    <span class="hljs-keyword">switch</span> (mysqlType) {
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;INT&amp;#34;:</span>
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;INTEGER&amp;#34;:</span>
            <span class="hljs-keyword">return</span> BasicType.INT_TYPE;
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;BIGINT&amp;#34;:</span>
            <span class="hljs-keyword">return</span> BasicType.LONG_TYPE;
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;VARCHAR&amp;#34;:</span>
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;TEXT&amp;#34;:</span>
            <span class="hljs-keyword">return</span> BasicType.STRING_TYPE;
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;DATETIME&amp;#34;:</span>
            <span class="hljs-keyword">return</span> LocalTimeType.LOCAL_DATE_TIME_TYPE;
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;TIMESTAMP&amp;#34;:</span>
            <span class="hljs-keyword">return</span> LocalTimeType.LOCAL_DATE_TIME_TYPE;
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;DECIMAL&amp;#34;:</span>
        <span class="hljs-keyword">case</span> &amp;<span class="hljs-meta">#34;NUMERIC&amp;#34;:</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DecimalType(column.length(), column.scale());
        <span class="hljs-literal">default</span>:
            <span class="hljs-keyword">return</span> BasicType.STRING_TYPE;
    }
}
</code></pre>
<h4 data-id="heading-29">2. SeaTunnel 类型到 ClickHouse 类型的转换</h4>
<p><strong>转换器</strong>: <code>JdbcRowConverter.createFieldInjectFunctionMap()</code></p>
<pre><code class="hljs language-scss" lang="scss">private Map <span class="hljs-built_in">createFieldInjectFunctionMap</span>(
        String[] fields, Map clickhouseTableSchema) {
    Map fieldInjectFunctionMap = new HashMap&lt;&gt;();
    
    for (String field : fields) {
        String fieldType = clickhouseTableSchema<span class="hljs-selector-class">.get</span>(field);
        ClickhouseFieldInjectFunction injectFunction = Arrays<span class="hljs-selector-class">.asList</span>(
            new ArrayInjectFunction(),
            new <span class="hljs-built_in">MapInjectFunction</span>(),
            new <span class="hljs-built_in">BigDecimalInjectFunction</span>(),
            new <span class="hljs-built_in">DateTimeInjectFunction</span>(),
            new <span class="hljs-built_in">LongInjectFunction</span>(),
            new <span class="hljs-built_in">DoubleInjectFunction</span>(),
            new <span class="hljs-built_in">IntInjectFunction</span>(),
            new <span class="hljs-built_in">StringInjectFunction</span>()
        )<span class="hljs-selector-class">.stream</span>()
         <span class="hljs-selector-class">.filter</span>(f -&gt; f.isCurrentFieldType(unwrapCommonPrefix(fieldType)))
         <span class="hljs-selector-class">.findFirst</span>()
         <span class="hljs-selector-class">.orElse</span>(new StringInjectFunction());
        
        fieldInjectFunctionMap<span class="hljs-selector-class">.put</span>(field, injectFunction);
    }
    return fieldInjectFunctionMap;
}
</code></pre>
<h4 data-id="heading-30">3. 数据行转换流程</h4>
<pre><code class="hljs">MySQL ResultSet → Debezium SourceRecord → SeaTunnelRow → ClickHouse PreparedStatement
</code></pre>
<p><strong>完整转换链</strong>:</p>
<ol>
<li>1. <strong>MySQL ResultSet</strong>: 从数据库查询结果</li>
<li>2. <strong>Debezium SourceRecord</strong>: Debezium 格式的事件记录</li>
<li>3. <strong>SeaTunnelRow</strong>: SeaTunnel 统一的数据格式</li>
<li>4. <strong>ClickHouse PreparedStatement</strong>: 最终写入 ClickHouse 的语句</li>
</ol>
<h3 data-id="heading-31">精确一次处理实现</h3>
<h4 data-id="heading-32">1. 水位标记机制</h4>
<p><strong>低水位标记</strong>: 快照开始时的 binlog 位置<br/>
<strong>高水位标记</strong>: 快照结束时的 binlog 位置</p>
<pre><code class="hljs language-ini" lang="ini">// 低水位标记
final BinlogOffset <span class="hljs-attr">lowWatermark</span> = currentBinlog<span class="hljs-literal">Off</span>set(jdbcConnection)<span class="hljs-comment">;</span>
dispatcher.dispatchWatermarkEvent(partition, snapshotSplit, lowWatermark, WatermarkKind.LOW)<span class="hljs-comment">;</span>

// 数据快照
createDataEvents(ctx, snapshotSplit.getTableId())<span class="hljs-comment">;</span>

// 高水位标记
final BinlogOffset <span class="hljs-attr">highWatermark</span> = currentBinlog<span class="hljs-literal">Off</span>set(jdbcConnection)<span class="hljs-comment">;</span>
dispatcher.dispatchWatermarkEvent(partition, snapshotSplit, highWatermark, WatermarkKind.HIGH)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-33">2. 增量补偿机制</h4>
<p>当 <code>lowWatermark != highWatermark</code> 时，需要进行增量补偿：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建补偿增量分片</span>
IncrementalSplit backfillSplit = new <span class="hljs-built_in">IncrementalSplit</span>(
    splitId,
    Collections.singletonList(tableId),
    lowWatermark,    <span class="hljs-comment">// 从低水位开始</span>
    highWatermark,   <span class="hljs-comment">// 到高水位结束</span>
    new ArrayList&lt;&gt;()
);

<span class="hljs-comment">// 执行补偿读取</span>
MySqlBinlogSplitReadTask backfillTask = new <span class="hljs-built_in">MySqlBinlogSplitReadTask</span>(...);
backfillTask<span class="hljs-selector-class">.execute</span>(context, partition, offsetContext);
</code></pre>
<h4 data-id="heading-34">3. 偏移量原子性</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyCheckpointComplete</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 在检查点完成时提交变更日志偏移量</span>
    dataSourceDialect.commitChangeLogOffset(snapshotChangeLogOffset);
}
</code></pre>
<h3 data-id="heading-35">性能优化点</h3>
<h4 data-id="heading-36">1. 并行度控制</h4>
<ul>
<li>• <strong>快照阶段</strong>: 多分片并行读取，提高全量数据读取效率</li>
<li>• <strong>增量阶段</strong>: 单线程顺序处理，保证事件顺序性</li>
</ul>
<h4 data-id="heading-37">2. 批量处理</h4>
<ul>
<li>• <strong>批次大小</strong>: 可配置的 <code>bulk_size</code> 参数（默认 20000）</li>
<li>• <strong>批量提交</strong>: 减少网络往返和事务开销</li>
</ul>
<h4 data-id="heading-38">3. 内存管理</h4>
<ul>
<li>• <strong>流式处理</strong>: 避免大量数据驻留内存</li>
<li>• <strong>连接池</strong>: 复用数据库连接，减少连接创建开销</li>
</ul>
<h3 data-id="heading-39">错误处理与容错</h3>
<h4 data-id="heading-40">1. 连接异常处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span> {
    statement.executeBatch();
    connection.commit();
} <span class="hljs-keyword">catch</span> (SQLException e) {
    connection.rollback();
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClickhouseConnectorException(
        CommonErrorCodeDeprecated.FLUSH_DATA_FAILED,
        &amp;<span class="hljs-meta">#34;Clickhouse execute batch statement <span class="hljs-keyword">error</span>&amp;#34;,</span>
        e
    );
}
</code></pre>
<h4 data-id="heading-41">2. 数据类型不匹配处理</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用默认转换器处理未知类型</span>
fieldInjectFunctionMap
    <span class="hljs-selector-class">.getOrDefault</span>(fieldName, DEFAULT_INJECT_FUNCTION)
    <span class="hljs-selector-class">.injectFields</span>(statement, i + <span class="hljs-number">1</span>, fieldValue);
</code></pre>
<h4 data-id="heading-42">3. 重试机制</h4>
<ul>
<li>• <strong>连接重试</strong>: 支持配置 <code>connect.max-retries</code> 参数</li>
<li>• <strong>自动重连</strong>: 数据库连接断开后自动重连</li>
</ul>
<h3 data-id="heading-43">监控与指标</h3>
<h4 data-id="heading-44">1. CDC 指标</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 记录获取延迟</span>
<span class="hljs-selector-tag">recordFetchDelay</span><span class="hljs-selector-class">.set</span>(fetchDelay &gt; <span class="hljs-number">0</span> ? <span class="hljs-attribute">fetchDelay </span>: <span class="hljs-number">0</span>);

<span class="hljs-comment">// 记录发送延迟</span>
<span class="hljs-selector-tag">recordEmitDelay</span><span class="hljs-selector-class">.set</span>(emitDelay &gt; <span class="hljs-number">0</span> ? <span class="hljs-attribute">emitDelay </span>: <span class="hljs-number">0</span>);

<span class="hljs-comment">// 延迟事件监控</span>
<span class="hljs-selector-tag">if</span> (delayedEventLimiter.<span class="hljs-built_in">acquire</span>(messageTimestamp)) {
    <span class="hljs-selector-tag">eventListener</span><span class="hljs-selector-class">.onEvent</span>(new <span class="hljs-built_in">MessageDelayedEvent</span>(emitDelay, element.<span class="hljs-built_in">toString</span>()));
}
</code></pre>
<h4 data-id="heading-45">2. ClickHouse 指标</h4>
<ul>
<li>• <strong>批次大小</strong>: 当前批次中的记录数</li>
<li>• <strong>写入延迟</strong>: 数据写入 ClickHouse 的耗时</li>
<li>• <strong>错误率</strong>: 写入失败的比例</li>
</ul>
<h3 data-id="heading-46">总结</h3>
<p>整个 MySQL CDC 到 ClickHouse 的数据流转过程是一个精心设计、高度优化的流水线，主要特点包括：</p>
<h4 data-id="heading-47">1. <strong>全链路数据一致性</strong></h4>
<ul>
<li>• 通过水位标记和补偿机制确保数据不丢失</li>
<li>• 支持精确一次处理语义</li>
<li>• 自动处理快照期间的变更数据</li>
</ul>
<h4 data-id="heading-48">2. <strong>高性能并行处理</strong></h4>
<ul>
<li>• 快照阶段支持多分片并行读取</li>
<li>• 批量写入 ClickHouse 减少网络开销</li>
<li>• 智能分片路由实现负载均衡</li>
</ul>
<h4 data-id="heading-49">3. <strong>灵活的数据转换</strong></h4>
<ul>
<li>• 支持复杂的数据类型映射</li>
<li>• 自动处理 DDL 结构变更</li>
<li>• 提供丰富的元数据信息</li>
</ul>
<h4 data-id="heading-50">4. <strong>企业级可靠性</strong></h4>
<ul>
<li>• 完善的错误处理和重试机制</li>
<li>• 支持故障恢复和断点续传</li>
<li>• 提供详细的监控指标</li>
</ul>
<h4 data-id="heading-51">5. <strong>优化策略</strong></h4>
<ul>
<li>• 流式处理避免内存溢出</li>
<li>• 连接池复用减少资源消耗</li>
<li>• 智能批次管理平衡性能和延迟</li>
</ul>
<p>这个架构设计使得 SeaTunnel 能够高效、可靠地将 MySQL 的变更数据实时同步到 ClickHouse，为实时分析提供强有力的数据支撑。</p>
<p>.preview-wrapper pre::before { position: absolute; top: 0; right: 0; color: #ccc; text-align: center; font-size: 0.8em; padding: 5px 10px 0; line-height: 15px; height: 15px; font-weight: 600; } .hljs.code__pre &gt; .mac-sign { display: flex; } .code__pre { padding: 0 !important; } .hljs.code__pre code { display: -webkit-box; padding: 0.5em 1em 1em; overflow-x: auto; text-indent: 0; } h2 strong { color: inherit !important; }</p>
<blockquote>
<p>本文使用 <a href="https://juejin.cn/post/6940875049587097631" target="_blank" title="https://juejin.cn/post/6940875049587097631">文章同步助手</a> 同步</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌐 开源社区在 WebAIGC 技术迭代中的推动作用与争议]]></title>    <link>https://juejin.cn/post/7582066556089319487</link>    <guid>https://juejin.cn/post/7582066556089319487</guid>    <pubDate>2025-12-11T02:08:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582066556089319487" data-draft-id="7582118538561568787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 🌐 开源社区在 WebAIGC 技术迭代中的推动作用与争议"/> <meta itemprop="keywords" content="前端,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-11T02:08:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             🌐 开源社区在 WebAIGC 技术迭代中的推动作用与争议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:08:46.000Z" title="Thu Dec 11 2025 02:08:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从 <code>Hello World</code> 到 “Hello, WebAI！”</h2>
<p>在 WebAIGC 火爆之前，Web 世界一直是前后端分治、接口调用、渲染交互的“传统手工艺厂”。直到某天，AI 被塞进了浏览器里，<strong>代码开始自己写页面、生成内容、甚至自我优化</strong>。</p>
<p>而推动这一切的，恰恰不是某家闭源巨头的私有实验室，而是一群分散在世界各地、连头像都没换过的开源开发者。</p>
<blockquote>
<p>他们可能在凌晨3点一拍脑袋提交一个 PR，第二天全世界的 WebAIGC 工程师都在用。<br/>
——“这是开源的魅力，也是开源的混乱。” 😎</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、技术迭代的“涡轮增压”：开源力量的底层逻辑 ⚙️</h2>
<p>那么为什么开源社区在 WebAIGC 的迭代中能像超级燃料一样起作用？这要从三个底层系统说起：</p>
<h3 data-id="heading-2">1️⃣ 代码层：从 Canvas 到 GPU 加速</h3>
<p>在 WebAIGC 的图像生成、语义渲染、交互生成等场景中，浏览器早期的 <code>Canvas</code> 绘图效果几乎是“像素搬砖”，效率堪忧。后来社区将 <strong>WebGL</strong>、<strong>WebGPU</strong> 封装出各种 AI-friendly 的计算接口。</p>
<pre><code class="hljs language-ini" lang="ini">// 简化的 GPU 并行计算原理示例
const <span class="hljs-attr">gpuWorker</span> = new GPU.ComputationProgram({
  kernel: `
    void main() {
      float <span class="hljs-attr">val</span> = inputA[gid] * inputB[gid]<span class="hljs-comment">;</span>
      output<span class="hljs-section">[gid]</span> = val<span class="hljs-comment">;</span>
    }
  `
})<span class="hljs-comment">;</span>
gpuWorker.run()<span class="hljs-comment">;</span>
</code></pre>
<p>🧩 <strong>底层原理</strong>：<br/>
开源框架（例如 TensorFlow.js、ONNX Runtime Web）直接在浏览器的 GPU 体系里“拿指令”计算，从而让训练、推理都能在用户端跑。</p>
<p>这背后不是魔法，而是一堆致命优雅的 ECMAScript Binding 与 Shader 编译策略。</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 算法层：Transformer 在网页上风骚起舞 💃</h3>
<p>开源社区往往是算法最先落地的地方。<br/>
像 <strong>Stable Diffusion WebUI</strong>、<strong>LLaMA-Web</strong> 等项目几乎让“浏览器端私有AI”成为现实。</p>
<p>在没有开源的世界里，你可能得等某公司发布 SDK；<br/>
在开源的世界里，一个社群的讨论贴就能让世界多一个推理框架。</p>
<blockquote>
<p>🔍 关键逻辑：</p>
<ul>
<li><strong>模型权重开源</strong> → 可以自由裁剪、蒸馏、量化。</li>
<li><strong>推理接口开源</strong> → 可以在任何环境运行（哪怕是智能冰箱）。</li>
<li><strong>文档开源</strong> → 团队知识以自然选择速度进化。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">3️⃣ 协作层：像 Git 一样的“集体脑” 🧠💬</h3>
<p>开源社区其实是一种<strong>自组织分布式系统</strong>：</p>
<ul>
<li>Issue = 问题队列；</li>
<li>PR = 任务提交；</li>
<li>Fork = 分支试验；</li>
<li>Merge = 共识达成。</li>
</ul>
<p>换句话说，<strong>GitHub 本身是 WebAIGC 的“训练数据来源”之一</strong>，它反映人类如何迭代思维与结构化创意。</p>
<blockquote>
<p>💡 一种讽刺的共振：<br/>
WebAIGC 是 AI 模拟人类创造；<br/>
开源社区则是人类以 AI 式协同创造。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、争议：自由的引擎，还是混乱的引爆点？ 💣</h2>
<h3 data-id="heading-6">⚔️ 1. 模型泄露与安全边界模糊</h3>
<p>有些人高呼开源是人类的共同财富；<br/>
另一些人则担心，开源的 WebAIGC 模型可能被滥用于伪造内容、信息欺骗。</p>
<blockquote>
<p>一边是“知识自由”；<br/>
一边是“现实风险”。<br/>
—— 这就像是给全人类都发了一把能造梦也能造炸药的工具。</p>
</blockquote>
<h3 data-id="heading-7">🧬 2. 技术门槛的错位</h3>
<p>开源降低了入门门槛，却未必降低了<strong>理解门槛</strong>。<br/>
新人可以直接调用 <code>generateArt()</code> 而不懂背后的向量空间计算原理，<br/>
久而久之，代码“聪明”了，人反而“糊涂”了。</p>
<hr/>
<h2 data-id="heading-8">四、未来展望：AI 造物与开源文明 🌱</h2>
<p>未来的 WebAIGC，可能不再是“代码生成代码”，<br/>
而是“社区生成社区”：<br/>
智能体帮我们维护项目、审阅 PR、生成文档 ——<br/>
而人类只需要定目标、传情感、讲故事。</p>
<p>但无论技术如何进化，<strong>开源精神的核心未变</strong>：</p>
<blockquote>
<blockquote>
<p>“自由不是不受约束，而是有选择地构建秩序。”</p>
</blockquote>
</blockquote>
<p>也许有一天，GitHub 上最后一个 commit 将不是“修复 bug”，<br/>
而是由 AI 提交的一句诗：</p>
<blockquote>
<p>“我在 WebGPU 的梦中，渲染出人类的思念。” 🌌</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、课堂总结 🧾</h2>



































<table><thead><tr><th>模块</th><th>作用</th><th>底层支撑</th><th>开源贡献</th></tr></thead><tbody><tr><td>前端渲染</td><td>WebGPU/WebGL</td><td>GPU 指令绑定</td><td>提供跨框架兼容层</td></tr><tr><td>模型推理</td><td>Transformer 内核</td><td>权重压缩 + JS binding</td><td>轻量部署变普及</td></tr><tr><td>协作治理</td><td>Git 生态</td><td>分布式共识机制</td><td>自发式迭代与复用</td></tr><tr><td>安全与伦理</td><td>Prompt 审核、模型管控</td><td>内容过滤策略</td><td>制定开源规约与准则</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【基础数据篇】数据等价裁判：Comparer模式]]></title>    <link>https://juejin.cn/post/7582131164728311848</link>    <guid>https://juejin.cn/post/7582131164728311848</guid>    <pubDate>2025-12-11T02:41:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728311848" data-draft-id="7582118218648371226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【基础数据篇】数据等价裁判：Comparer模式"/> <meta itemprop="keywords" content="后端,设计模式"/> <meta itemprop="datePublished" content="2025-12-11T02:41:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【基础数据篇】数据等价裁判：Comparer模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T02:41:56.000Z" title="Thu Dec 11 2025 02:41:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在日常的数据处理与业务开发中，数据比较是一个看似简单却无处不在的操作。无论是排序、去重、判断相等，还是在数据同步、版本比对等场景中，如何高效、清晰、可维护地比较两个对象，一直是开发者需要面对的课题。</p>
<p>如果每次比较都写一堆 <code>if-else</code> 或者直接调用默认的 <code>equals()</code>，代码很快就会变得臃肿且难以扩展——尤其是当比较规则频繁变化，或需要支持多种比较维度时。更糟糕的是，硬编码的比较逻辑会污染核心业务代码，降低可读性和可测试性。</p>
<p>这时，<strong>Comparer 模式</strong>（也称为 Comparator 模式）便像一个专业的“数据裁判”，将比较逻辑封装成独立、可复用的组件。它让比较行为与对象解耦，支持运行时动态切换比较策略，是编写清晰、灵活、健壮代码的重要工具。今天，我们就来系统解析这个模式的设计思想、应用实践与开源实现。</p>
<h2 data-id="heading-1">2. 定义</h2>
<p>Comparer 模式（或 Comparator 模式）是一种行为型设计模式，其核心思想是：</p>
<pre><code class="hljs language-text" lang="text">将两个对象之间的比较算法抽象出来，封装到独立的类中，从而让比较逻辑与对象本身解耦。 
</code></pre>
<p>比较器通常由如下几个核心部分组成：</p>
<ol>
<li><strong>被比较的对象</strong>：通常是领域实体或数据结构（如 <code>User</code>、<code>Order</code>）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：用户实体类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> LocalDateTime createdAt;
    
    <span class="hljs-comment">// 注意：这里不重写equals/hashCode，将比较逻辑交给专门的比较器</span>
}
</code></pre>
<ol start="2">
<li><strong>比较器接口</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-comment">// 通用比较器接口定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-comment">/**
     * 比较两个对象
     * <span class="hljs-doctag">@param</span> o1 第一个对象
     * <span class="hljs-doctag">@param</span> o2 第二个对象
     * <span class="hljs-doctag">@return</span> 负整数、零或正整数，分别表示o1小于、等于或大于o2
     * <span class="hljs-doctag">@throws</span> NullPointerException 如果参数为null且此比较器不接受null
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(T o1, T o2)</span>;
    
    <span class="hljs-comment">/**
     * 可选：反转比较器顺序
     * <span class="hljs-doctag">@return</span> 返回一个反转顺序的比较器
     */</span>
    <span class="hljs-keyword">default</span> Comparator <span class="hljs-title function_">reversed</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (o1, o2) -&gt; compare(o2, o1);
    }
    
    <span class="hljs-comment">/**
     * 可选：链式比较器
     * <span class="hljs-doctag">@param</span> other 下一个比较器
     * <span class="hljs-doctag">@return</span> 组合比较器
     */</span>
    <span class="hljs-keyword">default</span> Comparator <span class="hljs-title function_">thenComparing</span><span class="hljs-params">(Comparator other)</span> {
        <span class="hljs-keyword">return</span> (o1, o2) -&gt; {
            <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> compare(o1, o2);
            <span class="hljs-keyword">return</span> (res != <span class="hljs-number">0</span>) ? res : other.compare(o1, o2);
        };
    }
}
	```

<span class="hljs-number">3.</span> **具体比较器**：

```java
<span class="hljs-comment">// 按年龄比较的具体比较器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgeComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(User u1, User u2)</span> {
        <span class="hljs-comment">// 核心比较逻辑</span>
        <span class="hljs-keyword">return</span> Integer.compare(u1.getAge(), u2.getAge());

<span class="hljs-comment">// 复合比较器：先按年龄，再按姓名</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgeThenNameComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(User u1, User u2)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">ageCompare</span> <span class="hljs-operator">=</span> Integer.compare(u1.getAge(), u2.getAge());
        <span class="hljs-keyword">if</span> (ageCompare != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ageCompare;
        }
        <span class="hljs-comment">// 年龄相同，再比较姓名</span>
        <span class="hljs-keyword">return</span> String.CASE_INSENSITIVE_ORDER.compare(
            u1.getName(), 
            u2.getName()
        );
    }
}
</code></pre>
<h2 data-id="heading-2">3. 应用</h2>
<p>下面通过具体场景和代码示例来展开说明比较器的常见应用：</p>
<h3 data-id="heading-3">3.1 集合排序与高级排序策略</h3>
<p>这是最经典的应用，Comparer 模式能轻松支持：</p>
<ul>
<li><strong>多级排序</strong>：先按部门排序，部门相同再按薪资降序。</li>
<li><strong>自定义规则排序</strong>：按字符串长度、按日期远近、甚至按业务优先级排序。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 一个复合比较器示例：先按状态排序（自定义顺序），再按创建时间倒序</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TicketPriorityComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">STATUS_ORDER</span> <span class="hljs-operator">=</span> Map.of(
        Status.CRITICAL, <span class="hljs-number">1</span>,
        Status.HIGH, <span class="hljs-number">2</span>,
        Status.MEDIUM, <span class="hljs-number">3</span>,
        Status.LOW, <span class="hljs-number">4</span>
    );

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Ticket t1, Ticket t2)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">statusCompare</span> <span class="hljs-operator">=</span> Integer.compare(
            STATUS_ORDER.get(t1.getStatus()),
            STATUS_ORDER.get(t2.getStatus())
        );
        <span class="hljs-keyword">if</span> (statusCompare != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> statusCompare;
        }
        <span class="hljs-comment">// 状态相同，按创建时间倒序</span>
        <span class="hljs-keyword">return</span> t2.getCreatedAt().compareTo(t1.getCreatedAt());
    }
}
</code></pre>
<h3 data-id="heading-4">3.2 数据去重与自定义相等判断</h3>
<p>业务中“相等”的概念常常很灵活，比如在用户合并场景中，可能认为邮箱或手机号相同即为同一用户。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基于邮箱的用户去重比较器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEmailComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(User u1, User u2)</span> {
        <span class="hljs-keyword">return</span> u1.getEmail().trim().equalsIgnoreCase(u2.getEmail().trim()) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;
    }
}

<span class="hljs-comment">// 使用该比较器进行去重</span>
<span class="hljs-type">List</span> <span class="hljs-variable">mergedUsers</span> <span class="hljs-operator">=</span> userList.stream()
        .collect(Collectors.collectingAndThen(
            Collectors.toCollection(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserEmailComparer</span>())),
            ArrayList::<span class="hljs-keyword">new</span>
        ));
</code></pre>
<h3 data-id="heading-5">3.3 优先级队列与数据结构定制</h3>
<p>许多数据结构依赖比较器来定义元素顺序。</p>
<p>例如，在任务调度系统中，<code>PriorityBlockingQueue</code> 需要根据任务的紧急程度决定执行顺序。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 任务优先级比较器（数值越小越优先）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskPriorityComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Task t1, Task t2)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">priorityCompare</span> <span class="hljs-operator">=</span> Integer.compare(t1.getPriority(), t2.getPriority());
        <span class="hljs-keyword">if</span> (priorityCompare != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> priorityCompare;
        <span class="hljs-comment">// 优先级相同，则按等待时间排序（等待越久越优先）</span>
        <span class="hljs-keyword">return</span> Long.compare(t1.getWaitingTime(), t2.getWaitingTime());
    }
}

<span class="hljs-type">PriorityBlockingQueue</span> <span class="hljs-variable">taskQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>&lt;&gt;(<span class="hljs-number">11</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskPriorityComparer</span>());
</code></pre>
<h3 data-id="heading-6">3.4 数据同步与差异分析</h3>
<p>在数据同步、ETL 或版本比对场景中，需要精确识别数据的变化类型（新增、更新、删除），一个健壮的比较器是这类系统的核心。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用于数据同步的深度比较器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSyncComparer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(DataRecord r1, DataRecord r2)</span> {
        <span class="hljs-comment">// 1. 先比较唯一标识</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">idCompare</span> <span class="hljs-operator">=</span> r1.getId().compareTo(r2.getId());
        <span class="hljs-keyword">if</span> (idCompare != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> idCompare;
        
        <span class="hljs-comment">// 2. 标识相同，则比较内容哈希值（或逐个字段比较）判断是否更新</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">hash1</span> <span class="hljs-operator">=</span> computeContentHash(r1);
        <span class="hljs-type">String</span> <span class="hljs-variable">hash2</span> <span class="hljs-operator">=</span> computeContentHash(r2);
        <span class="hljs-keyword">return</span> hash1.equals(hash2) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>; <span class="hljs-comment">// 0表示内容相同，1表示内容不同</span>
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">computeContentHash</span><span class="hljs-params">(DataRecord record)</span> {
        <span class="hljs-comment">// 计算记录关键字段的哈希值，忽略同步元数据字段</span>
        <span class="hljs-keyword">return</span> DigestUtils.md5Hex(record.getName() + record.getValue() + record.getCategory());
    }
}

<span class="hljs-comment">// 使用比较器进行数据差异分析</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataDiffService</span> {
    <span class="hljs-keyword">public</span> DiffResult <span class="hljs-title function_">compareCollections</span><span class="hljs-params">(List source, List target)</span> {
        source.sort(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSyncComparer</span>());
        target.sort(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSyncComparer</span>());
        <span class="hljs-comment">// 使用双指针算法基于比较器结果进行比对</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h2 data-id="heading-7">4. 开源代码解析</h2>
<p>许多优秀的开源框架和库都深度运用了 Comparer 模式的思想，并将其发挥到极致。</p>
<h3 data-id="heading-8">4.1 Java 8+ 中的 <code>Comparator</code> 革命</h3>
<p>Java 8 为 <code>Comparator</code> 接口注入了强大的函数式能力，使其定义变得极其简洁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方法引用与链式调用</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> Comparator
    .comparing(Person::getLastName)
    .thenComparing(Person::getFirstName)
    .thenComparingInt(Person::getAge)
    .reversed();

<span class="hljs-comment">// 处理null值的安全比较器</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">nullSafeComparator</span> <span class="hljs-operator">=</span> Comparator.nullsLast(String::compareToIgnoreCase);

<span class="hljs-comment">// 使用Lambda自定义复杂逻辑</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">productComparator</span> <span class="hljs-operator">=</span> (p1, p2) -&gt; {
    <span class="hljs-keyword">if</span> (p1.isFeatured() &amp;&amp; !p2.isFeatured()) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (!p1.isFeatured() &amp;&amp; p2.isFeatured()) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> Double.compare(p2.getRating(), p1.getRating()); <span class="hljs-comment">// 评分降序</span>
};
</code></pre>
<h4 data-id="heading-9">4.1.1 <code>comparing()</code> 系列方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统方式 vs Java 8 新方式</span>
<span class="hljs-comment">// 传统：冗长的匿名内部类</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">oldWay</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Person p1, Person p2)</span> {
        <span class="hljs-keyword">return</span> p1.getLastName().compareTo(p2.getLastName());
    }
};

<span class="hljs-comment">// Java 8：一行代码</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">newWay</span> <span class="hljs-operator">=</span> Comparator.comparing(Person::getLastName);
</code></pre>
<p><strong>核心实现原理：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Comparator.comparing() 的源码实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &gt; Comparator <span class="hljs-title function_">comparing</span><span class="hljs-params">(
        Function keyExtractor)</span> {
    Objects.requireNonNull(keyExtractor);
    <span class="hljs-keyword">return</span> (Comparator &amp; Serializable)  <span class="hljs-comment">// 序列化标记</span>
        (c1, c2) -&gt; {
            <span class="hljs-comment">// 1. 提取关键值</span>
            <span class="hljs-type">U</span> <span class="hljs-variable">u1</span> <span class="hljs-operator">=</span> keyExtractor.apply(c1);
            <span class="hljs-type">U</span> <span class="hljs-variable">u2</span> <span class="hljs-operator">=</span> keyExtractor.apply(c2);
            
            <span class="hljs-comment">// 2. 使用关键值的自然顺序比较</span>
            <span class="hljs-keyword">return</span> u1.compareTo(u2);
        };
}

<span class="hljs-comment">// 支持自定义比较器的重载版本</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  Comparator <span class="hljs-title function_">comparing</span><span class="hljs-params">(
        Function keyExtractor,
        Comparator keyComparator)</span> {
    Objects.requireNonNull(keyExtractor);
    Objects.requireNonNull(keyComparator);
    <span class="hljs-keyword">return</span> (Comparator &amp; Serializable)
        (c1, c2) -&gt; {
            <span class="hljs-comment">// 使用提供的比较器比较提取的值</span>
            <span class="hljs-keyword">return</span> keyComparator.compare(
                keyExtractor.apply(c1),
                keyExtractor.apply(c2)
            );
        };
}
</code></pre>
<h4 data-id="heading-10">4.1.2 链式比较：<code>thenComparing()</code> </h4>
<p><strong>链式比较的实现原理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 链式比较示例</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">complexComparator</span> <span class="hljs-operator">=</span> Comparator
    .comparing(Person::getLastName)
    .thenComparing(Person::getFirstName)
    .thenComparingInt(Person::getAge);

<span class="hljs-comment">// thenComparing() 的默认方法实现</span>
<span class="hljs-keyword">default</span> Comparator <span class="hljs-title function_">thenComparing</span><span class="hljs-params">(Comparator other)</span> {
    Objects.requireNonNull(other);
    <span class="hljs-keyword">return</span> (Comparator &amp; Serializable) (c1, c2) -&gt; {
        <span class="hljs-comment">// 1. 先用当前比较器比较</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> compare(c1, c2);
        <span class="hljs-comment">// 2. 如果相等，再用下一个比较器</span>
        <span class="hljs-keyword">return</span> (res != <span class="hljs-number">0</span>) ? res : other.compare(c1, c2);
    };
}

<span class="hljs-comment">// 带keyExtractor的版本</span>
<span class="hljs-keyword">default</span> &lt;u&gt;&gt; Comparator <span class="hljs-title function_">thenComparing</span><span class="hljs-params">(
        Function keyExtractor)</span> {
    <span class="hljs-comment">// 组合成链式结构</span>
    <span class="hljs-keyword">return</span> thenComparing(comparing(keyExtractor));
}
</code></pre>
<p><strong>链式比较的内部数据结构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化版链式比较器的内部结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainedComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span>, Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator first;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator second;
    
    ChainedComparator(Comparator first, Comparator second) {
        <span class="hljs-built_in">this</span>.first = first;
        <span class="hljs-built_in">this</span>.second = second;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(T o1, T o2)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> first.compare(o1, o2);
        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) {
            result = second.compare(o1, o2);
        }
        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">// 实际上，Java使用函数式方式实现，但逻辑相同</span>
</code></pre>
<h4 data-id="heading-11">4.1.3 Null值处理：安全比较的革命</h4>
<p><code>nullsFirst()</code> 和 <code>nullsLast()</code> 的实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// nullsFirst() 的实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  Comparator <span class="hljs-title function_">nullsFirst</span><span class="hljs-params">(Comparator comparator)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullComparator</span>&lt;&gt;(<span class="hljs-literal">true</span>, comparator);
}

<span class="hljs-comment">// NullComparator 内部类</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NullComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span>, Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> nullFirst;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator real;
    
    NullComparator(<span class="hljs-type">boolean</span> nullFirst, Comparator real) {
        <span class="hljs-built_in">this</span>.nullFirst = nullFirst;
        <span class="hljs-built_in">this</span>.real = real;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(T a, T b)</span> {
        <span class="hljs-keyword">if</span> (a == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> (b == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (nullFirst ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (b == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> nullFirst ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 两个都不是null，使用真正的比较器</span>
            <span class="hljs-keyword">return</span> (real == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : real.compare(a, b);
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">List</span> <span class="hljs-variable">names</span> <span class="hljs-operator">=</span> Arrays.asList(&amp;#<span class="hljs-number">34</span>;Alice&amp;#<span class="hljs-number">34</span>;, <span class="hljs-literal">null</span>, &amp;#<span class="hljs-number">34</span>;Bob&amp;#<span class="hljs-number">34</span>;, <span class="hljs-literal">null</span>, &amp;#<span class="hljs-number">34</span>;Charlie&amp;#<span class="hljs-number">34</span>;);
names.sort(Comparator.nullsFirst(String::compareTo));
<span class="hljs-comment">// 结果: [null, null, &amp;#34;Alice&amp;#34;, &amp;#34;Bob&amp;#34;, &amp;#34;Charlie&amp;#34;]</span>
</code></pre>
<h4 data-id="heading-12">4.1.4 Lambda表达式与Comparator的融合</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Lambda表达式的类型推断</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">priceComparator</span> <span class="hljs-operator">=</span> (p1, p2) -&gt; 
    Double.compare(p1.getPrice(), p2.getPrice());

<span class="hljs-comment">// 编译器如何推断？</span>
<span class="hljs-comment">// 1. 目标类型是 Comparator</span>
<span class="hljs-comment">// 2. Lambda参数类型推断为 (Product, Product)</span>
<span class="hljs-comment">// 3. 返回类型推断为 int</span>

<span class="hljs-comment">// 等价于匿名内部类</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">oldPriceComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Product p1, Product p2)</span> {
        <span class="hljs-keyword">return</span> Double.compare(p1.getPrice(), p2.getPrice());
    }
};
</code></pre>
<p><strong>方法引用的魔力：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 四种方法引用形式在Comparator中的应用</span>

<span class="hljs-comment">// 1. 静态方法引用</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">absComparator</span> <span class="hljs-operator">=</span> Comparator.comparingInt(Math::abs);

<span class="hljs-comment">// 2. 实例方法引用（特定对象的实例方法）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> &amp;#<span class="hljs-number">34</span>;Mr. &amp;#<span class="hljs-number">34</span>;;
<span class="hljs-type">Comparator</span> <span class="hljs-variable">withPrefix</span> <span class="hljs-operator">=</span> Comparator.comparing(prefix::concat);

<span class="hljs-comment">// 3. 任意对象的实例方法引用（最常用）</span>
<span class="hljs-type">Comparator</span> <span class="hljs-variable">lengthComparator</span> <span class="hljs-operator">=</span> Comparator.comparingInt(String::length);

<span class="hljs-comment">// 4. 构造方法引用（较少用于Comparator）</span>
<span class="hljs-comment">// 通常用于其他函数式接口</span>
</code></pre>
<h3 data-id="heading-13">4.2 Spring Framework 中的 <code>Comparator</code> 应用</h3>
<p>在 Spring 中，比较器常用于配置排序、事件顺序控制等场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring 的 Ordered 接口本质上也是一种比较器模式</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighPriorityValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span>, Validator {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> HIGHEST_PRECEDENCE; <span class="hljs-comment">// 定义执行顺序</span>
    }
}

<span class="hljs-comment">// 在Spring Security中，对多个Filter进行排序</span>
<span class="hljs-type">List</span> <span class="hljs-variable">filters</span> <span class="hljs-operator">=</span> ...;
filters.sort(AnnotationAwareOrderComparator.INSTANCE);
</code></pre>
<h4 data-id="heading-14">4.2.1 <code>Ordered</code> 接口的设计哲学</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring 的 Ordered 接口定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Ordered</span> {
    <span class="hljs-comment">/**
     * 最高优先级常量
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">HIGHEST_PRECEDENCE</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE;
    
    <span class="hljs-comment">/**
     * 最低优先级常量
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">LOWEST_PRECEDENCE</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;
    
    <span class="hljs-comment">/**
     * 获取顺序值
     * <span class="hljs-doctag">@return</span> 顺序值，数值越小优先级越高
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span>;
}
</code></pre>
<h4 data-id="heading-15">4.2.2 <code>Ordered</code> 接口的核心实现原理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Ordered 接口的比较器实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span> {
    
    <span class="hljs-comment">/**
     * 共享实例，线程安全
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">OrderComparator</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderComparator</span>();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(Object o1, Object o2)</span> {
        <span class="hljs-comment">// 获取两个对象的顺序值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> getOrder(o1);
        <span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> getOrder(o2);
        
        <span class="hljs-comment">// 比较顺序值</span>
        <span class="hljs-keyword">return</span> Integer.compare(i1, i2);
    }
    
    <span class="hljs-comment">/**
     * 获取对象的顺序值
     * 核心方法：支持多种方式确定顺序
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">(Object obj)</span> {
        <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 1. 检查是否实现了Ordered接口</span>
            <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Ordered) {
                <span class="hljs-keyword">return</span> ((Ordered) obj).getOrder();
            }
            
            <span class="hljs-comment">// 2. 检查是否有@Order注解</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> findOrder(obj);
            <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> order;
            }
        }
        
        <span class="hljs-comment">// 3. 默认返回最低优先级</span>
        <span class="hljs-keyword">return</span> Ordered.LOWEST_PRECEDENCE;
    }
    
    <span class="hljs-comment">/**
     * 查找<span class="hljs-doctag">@Order</span>注解的值
     */</span>
    <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">findOrder</span><span class="hljs-params">(Object obj)</span> {
        <span class="hljs-comment">// 检查类上的@Order注解</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> obj.getClass().getAnnotation(Order.class);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> order.value();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h4 data-id="heading-16">4.2.3 <code>AnnotationAwareOrderComparator</code> 解析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AnnotationAwareOrderComparator 的类层次结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationAwareOrderComparator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OrderComparator</span> {
    
    <span class="hljs-comment">// 单例实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AnnotationAwareOrderComparator</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationAwareOrderComparator</span>();
    
    <span class="hljs-comment">/**
     * 扩展的findOrder方法，支持更多注解
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">findOrder</span><span class="hljs-params">(Object obj)</span> {
        <span class="hljs-comment">// 1. 先调用父类方法检查@Order注解</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.findOrder(obj);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> order;
        }
        
        <span class="hljs-comment">// 2. 检查@Priority注解（JSR-250标准）</span>
        <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Class) {
            <span class="hljs-keyword">return</span> findOrderFromAnnotation((Class) obj);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> findOrderFromAnnotation(obj.getClass());
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">/**
     * 从类上查找顺序注解
     */</span>
    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">findOrderFromAnnotation</span><span class="hljs-params">(Class clazz)</span> {
        <span class="hljs-comment">// 检查@Order注解</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> AnnotatedElementUtils.findMergedAnnotation(clazz, Order.class);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> order.value();
        }
        
        <span class="hljs-comment">// 检查@Priority注解</span>
        javax.annotation.<span class="hljs-type">Priority</span> <span class="hljs-variable">priority</span> <span class="hljs-operator">=</span> 
            AnnotatedElementUtils.findMergedAnnotation(clazz, javax.annotation.Priority.class);
        <span class="hljs-keyword">if</span> (priority != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> priority.value();
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">/**
     * 排序列表的便捷方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(List list)</span> {
        <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) {
            list.sort(INSTANCE);
        }
    }
    
    <span class="hljs-comment">/**
     * 对已排序的列表进行排序（保持稳定排序）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sortIfNecessary</span><span class="hljs-params">(List list)</span> {
        <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span> &amp;&amp; !isSorted(list)) {
            sort(list);
        }
    }
    
    <span class="hljs-comment">/**
     * 检查列表是否已排序
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSorted</span><span class="hljs-params">(List list)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; list.size(); i++) {
            <span class="hljs-keyword">if</span> (INSTANCE.compare(list.get(i - <span class="hljs-number">1</span>), list.get(i)) &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-17">4.2.4 在 Spring Security 中的实际应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring Security 过滤器链的排序实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterChainProxy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> {
    
    <span class="hljs-keyword">private</span> List filterChains;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 对过滤器链进行排序</span>
        filterChains.sort(AnnotationAwareOrderComparator.INSTANCE);
        
        <span class="hljs-comment">// 对每个过滤器链中的过滤器进行排序</span>
        <span class="hljs-keyword">for</span> (SecurityFilterChain chain : filterChains) {
            <span class="hljs-type">List</span> <span class="hljs-variable">filters</span> <span class="hljs-operator">=</span> chain.getFilters();
            filters.sort(AnnotationAwareOrderComparator.INSTANCE);
        }
    }
    
    <span class="hljs-comment">// 过滤器示例</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, 
                           FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
            <span class="hljs-comment">// 日志记录逻辑</span>
            chain.doFilter(request, response);
        }
    }
    
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Order(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GenericFilterBean</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response,
                           FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
            <span class="hljs-comment">// 认证逻辑</span>
            chain.doFilter(request, response);
        }
    }
}
</code></pre>
<h2 data-id="heading-18">5. 总结</h2>
<p>Comparer 模式核心设计思想是：将数据比较的意图（比什么、按什么规则比）与比较的复杂实现（怎么比）进行分离，通过专门的比较器组件来封装比较两个对象的复杂逻辑。</p>
<p>它深刻体现了以下几个经典设计模式的思想：</p>
<ol>
<li>
<p>策略模式：每一种比较逻辑（如按年龄比较、按姓名比较、按多个字段组合比较）都被封装成一个独立的策略（即具体的 Comparer）。上下文（如排序函数、优先级队列、数据同步服务）可以根据业务需求，灵活选择或组合不同的比较策略，而不必在代码中堆积复杂的 <code>if-else</code> 条件判断。</p>
</li>
<li>
<p>装饰器模式：Comparer 可以被层层装饰和组合。例如，Java 8 的 <code>thenComparing()</code> 允许将多个比较器串联，形成一条比较链；而像 <code>LoggingComparer</code>、<code>CachingComparer</code> 这样的装饰器可以在不改变核心比较逻辑的前提下，为比较器添加日志记录、结果缓存等增强功能。</p>
</li>
</ol>
<p>核心价值：将"数据比较"这个动作，从一个简单或杂乱的 <code>if-else</code> 判断，提升为一个结构清晰、可复用、可测试的服务。它优雅地解决了在排序、去重、优先级调度、数据同步等场景中，对复杂对象进行灵活、高效比较的挑战。</p>
<hr/>
<p><strong>下一篇预告：</strong></p>
<p>在下一篇 《【数据转换篇】信息提炼专家：Extractor 模式》 中，我们将探讨如何从复杂对象中提取和转换特定信息。如果说 Comparer 是数据的"裁判"，那么 Extractor 就是数据的"矿工"——深入复杂的数据结构，精准地定位、提取和提炼有价值的信息。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度复盘： WebGL 数字孪生前端架构：如何打造高颜值、高性能的 Web 3D 可视化系统]]></title>    <link>https://juejin.cn/post/7582067084840632374</link>    <guid>https://juejin.cn/post/7582067084840632374</guid>    <pubDate>2025-12-11T00:18:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084840632374" data-draft-id="7582066556088811583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度复盘： WebGL 数字孪生前端架构：如何打造高颜值、高性能的 Web 3D 可视化系统"/> <meta itemprop="keywords" content="three.js"/> <meta itemprop="datePublished" content="2025-12-11T00:18:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Addisonx"/> <meta itemprop="url" content="https://juejin.cn/user/3651905710195595"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度复盘： WebGL 数字孪生前端架构：如何打造高颜值、高性能的 Web 3D 可视化系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3651905710195595/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Addisonx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:18:41.000Z" title="Thu Dec 11 2025 00:18:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 前言</h2>
<p>在企业级数字孪生（Digital Twin）项目中，**“前端可视化表现”**往往决定了项目的成败。</p>
<p>很多项目后台数据很稳，但前端渲染卡顿、模型丑陋、交互生硬，最终导致无法交付。作为一名专注于 <strong>Web 3D 呈现与前端可视化</strong> 的开发者，我认为：<strong>让数据“好看”且“好用”，是前端的核心价值。</strong></p>
<p>本文将基于我们团队最近交付的<strong>智慧园区可视化前端项目</strong>，复盘一套<strong>高内聚、低耦合</strong>的 Three.js 前端架构设计。</p>
<hr/>
<h2 data-id="heading-1">🏗️ 一、 前端架构设计：让 3D 只是一个“组件”</h2>
<p>为了方便集成到任意业务系统中（无论后台是 Java、Python 还是 Go），我们将 3D 场景封装为独立的<strong>前端视图组件</strong>。</p>
<h3 data-id="heading-2">1. 核心设计理念：数据驱动视图 (Data-Driven)</h3>
<p>前端只负责两件事：<strong>渲染（Render）</strong> 和 <strong>映射（Mapping）</strong>。</p>
<ul>
<li><strong>输入</strong>：通过 WebSocket/API 接收标准 JSON 数据（如 <code>{ id: 101, status: 'error' }</code>）。</li>
<li><strong>输出</strong>：3D 场景自动响应（ID为101的模型变红、闪烁）。</li>
</ul>
<p>这种设计使得我们能以<strong>纯前端方式交付</strong>，甲方后端只需按约定推送数据即可，无需关心 3D 逻辑。</p>
<h3 data-id="heading-3">2. 代码组织结构</h3>
<p>建议将 Three.js 逻辑封装为独立的 Class，与 Vue/React UI 层完全解耦：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Viewer3D.js - 纯粹的渲染引擎类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Viewer3D</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">domElement</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderer</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>(); <span class="hljs-comment">// 渲染器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SceneManager</span>();           <span class="hljs-comment">// 场景管理</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effect</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EffectComposer</span>();        <span class="hljs-comment">// 后期特效(光晕/辉光)</span>
  }

  <span class="hljs-comment">// 暴露给业务层的 API：高亮设备</span>
  <span class="hljs-title function_">highlightDevice</span>(<span class="hljs-params">deviceId, color</span>) {
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">findMeshById</span>(deviceId);
    <span class="hljs-keyword">if</span> (mesh) {
      mesh.<span class="hljs-property">material</span>.<span class="hljs-property">emissive</span>.<span class="hljs-title function_">setHex</span>(color);
      <span class="hljs-comment">// 触发 Shader 扫光特效</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">effect</span>.<span class="hljs-title function_">triggerScan</span>(mesh.<span class="hljs-property">position</span>);
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">🛠️ 二、 前端核心技术难点解析</h2>
<h3 data-id="heading-5">1. 视觉效果：Shader 编写与后期处理</h3>
<p>普通的 Three.js 材质偏塑料感，为了达到“科技感”大屏效果，我们大量使用了自定义 Shader 和 Post-Processing（后期处理）。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li><strong>UnrealBloom</strong>：实现城市夜景的辉光效果（霓虹灯感）。</li>
<li><strong>Custom Shader</strong>：不使用 GIF 贴图，而是用 GLSL 编写动态的<strong>电子围栏</strong>和<strong>建筑扫描光波</strong>，清晰度无限且不耗费显存。</li>
</ul>
<h3 data-id="heading-6">2. 坐标映射算法</h3>
<p>前端开发常遇到的痛点：甲方给的是 GPS 经纬度，而 3D 场景是笛卡尔坐标。
我们封装了一套<strong>前端转换算法</strong>，支持将 GeoJSON 数据直接投射到 3D 地形上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端工具函数：经纬度转 Vector3</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">latLonToVector3</span>(<span class="hljs-params">lat, lon, radius = <span class="hljs-number">6371</span></span>) {
  <span class="hljs-keyword">const</span> phi = (<span class="hljs-number">90</span> - lat) * (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>);
  <span class="hljs-keyword">const</span> theta = (lon + <span class="hljs-number">180</span>) * (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>);
  <span class="hljs-keyword">const</span> x = -(radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta));
  <span class="hljs-keyword">const</span> z = (radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta));
  <span class="hljs-keyword">const</span> y = (radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi));
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, y, z);
}
</code></pre>
<h3 data-id="heading-7">3. 性能优化 (FPS &gt; 60)</h3>
<p>在浏览器中渲染数万个物体，性能是第一指标。我们采用了纯前端的优化策略：</p>
<ul>
<li><strong>GPU Instancing</strong>：对重复的树木、路灯、机柜，合并为一次 DrawCall，CPU 开销几乎为零。</li>
<li><strong>Draco 压缩</strong>：将几百 MB 的 OBJ 模型压缩为几 MB 的 .glb 文件，Web 端秒级加载。</li>
<li><strong>显存管理</strong>：自动检测不可见物体（Frustum Culling），并在组件销毁时彻底释放 Geometry 和 Material 内存。</li>
</ul>
<hr/>
<h2 data-id="heading-8">💻 三、 系统落地效果</h2>
<p>基于上述前端架构，我们完成了这套<strong>智慧园区/工厂可视化大屏</strong>。</p>
<p><strong>前端界面展示</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48445e3ae40c4fc6bd2add2c86a67115~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWRkaXNvbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766017120&amp;x-signature=sHdv%2BfLerKX80tltx7kk6WLfOGo%3D" alt="view.gif" loading="lazy"/>
<em>(图注：纯前端实现的流光效果、PBR材质及 CSS3D 标签融合)</em></p>
<p><strong>核心亮点</strong>：</p>
<ul>
<li><strong>极速加载</strong>：首屏加载时间 &lt; 3秒。</li>
<li><strong>全场景漫游</strong>：支持第一人称/第三人称视角平滑切换。</li>
<li><strong>多端兼容</strong>：适配 Chrome、Edge 及高性能平板浏览器。</li>
</ul>
<hr/>
<h2 data-id="heading-9">🤝 四、 技术探讨与落地</h2>
<p>Web 3D 开发是一个深坑，从模型导出到 WebGL 渲染，每个环节都可能遇到性能瓶颈。</p>
<p>我们团队在踩过无数坑后，沉淀了这套成熟的<strong>前端可视化解决方案</strong>。我们非常乐意与同行或有需求的朋友进行<strong>技术交流</strong>。</p>
<p><strong>如果你正面临以下情况，欢迎沟通：</strong></p>
<ol>
<li><strong>后端团队</strong>：你们擅长 Java/Go 业务逻辑，但缺少能搞定炫酷 3D 前端的伙伴。</li>
<li><strong>项目集成</strong>：手头有智慧城市/工厂项目，需要一个稳定的前端 3D 模块来提升项目“颜值”。</li>
<li><strong>技术瓶颈</strong>：现有的 3D 场景卡顿、效果不理想，需要优化方案。</li>
</ol>
<p><strong>在线演示环境</strong>：
👉
<em>(注：建议使用 PC 端 Chrome 访问以获得最佳体验)</em></p>
<p>不管是<strong>技术探讨</strong>、<strong>源码咨询</strong>还是<strong>项目协作</strong>，都欢迎在评论区留言或点击头像私信，交个朋友，共同进步。</p>
<hr/>
<blockquote>
<p><strong>声明</strong>：本文核心代码与架构思路均为原创，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack vs Vite 全方位对比：原理、配置、场景一次讲透]]></title>    <link>https://juejin.cn/post/7582063437414514726</link>    <guid>https://juejin.cn/post/7582063437414514726</guid>    <pubDate>2025-12-11T01:05:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582063437414514726" data-draft-id="7579164768063782939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack vs Vite 全方位对比：原理、配置、场景一次讲透"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T01:05:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ycgg"/> <meta itemprop="url" content="https://juejin.cn/user/1926000101039192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack vs Vite 全方位对比：原理、配置、场景一次讲透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000101039192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ycgg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:05:01.000Z" title="Thu Dec 11 2025 01:05:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端工程化领域，Webpack 和 Vite 是最主流的两大构建工具，但两者的设计理念和使用体验天差地别。本文将从 <strong>核心原理、关键差异、代码示例、选型建议</strong> 四个维度，用通俗易懂的语言帮你彻底搞懂它们的区别，避开选型和配置坑。</p>
<h2 data-id="heading-0">一、核心定位：两种完全不同的构建思路</h2>
<p>先一句话分清两者的核心差异：</p>
<ul>
<li><strong>Webpack</strong>：「全场景打包工具」—— 不管开发还是生产，都先把所有模块（JS/TS/CSS/图片）打包成 bundle 文件，兼容所有场景但开发体验一般。</li>
<li><strong>Vite</strong>：「现代前端构建工具」—— 开发时不打包，生产时轻量打包，主打「快到飞起的开发体验」，专为现代浏览器设计。</li>
</ul>
<p>可以用一个比喻理解：</p>
<ul>
<li>Webpack 像「自助餐提前备好所有菜」：不管你吃不吃，先把所有食材（模块）加工好（打包），优点是能满足所有人需求，缺点是准备时间长。</li>
<li>Vite 像「餐厅点单后现做」：开发时只搭好厨房（服务器），你点什么菜（请求什么模块）才现做（即时转译），优点是等待时间短，缺点是只支持“现代食客”（现代浏览器）。</li>
</ul>
<h2 data-id="heading-1">二、核心原理：为什么 Vite 比 Webpack 快？</h2>
<h3 data-id="heading-2">1. Webpack 原理：全量打包，一步到位</h3>
<p>Webpack 的核心逻辑是「<strong>提前打包所有模块</strong>」，无论开发还是生产环境，流程都一致：</p>
<ol>
<li>从入口文件（如 <code>src/index.js</code>）开始，递归解析所有依赖（<code>import</code>/<code>require</code>），构建「依赖关系图」；</li>
<li>通过 <strong>Loader</strong> 转译非 JS 模块（如 TS→JS、CSS→JS）；</li>
<li>通过 <strong>Plugin</strong> 扩展功能（如生成 HTML、压缩代码）；</li>
<li>把所有模块合并成一个或多个 <code>bundle.js</code>，输出到 <code>dist</code> 目录。</li>
</ol>
<p><strong>开发时的痛点</strong>：<br/>
即使只改一行代码，Webpack 也可能需要重新解析整个依赖链、重新打包，导致「冷启动慢」「热更新（HMR）延迟」，项目越大越明显。</p>
<h3 data-id="heading-3">2. Vite 原理：非打包开发 + 轻量生产打包</h3>
<p>Vite 拆分了「开发时」和「生产时」的逻辑，核心是「<strong>利用现代浏览器原生支持 ES 模块（ESM）</strong>」：</p>
<ul>
<li>
<p><strong>开发时（非打包）</strong>：</p>
<ol>
<li>启动一个开发服务器，不提前打包任何模块；</li>
<li>浏览器请求入口文件（<code>index.html</code>）时，Vite 动态改写模块引用，让浏览器通过 ESM 原生加载模块；</li>
<li>当浏览器请求某个模块（如 <code>src/App.tsx</code>）时，Vite 用 <strong>ESBuild</strong>（Go 语言编写，速度是 Babel 的 10-100 倍）即时转译模块，返回给浏览器；</li>
<li>热更新时，仅更新修改的模块，无需重新构建整个依赖链。</li>
</ol>
</li>
<li>
<p><strong>生产时（轻量打包）</strong>：
生产环境下，为了兼容更多场景和优化性能，Vite 会切换到「打包模式」，但不自己实现打包逻辑，而是复用 <strong>Rollup</strong>（比 Webpack 打包更高效、产物更小），最终输出优化后的静态资源。</p>
</li>
</ul>
<p><strong>核心优势</strong>：<br/>
开发时跳过全量打包，依赖 ESM 原生加载和 ESBuild 转译，冷启动和热更新速度远超 Webpack。</p>
<h2 data-id="heading-4">三、关键差异对比表（一目了然）</h2>




























































<table><thead><tr><th>对比维度</th><th>Webpack</th><th>Vite</th></tr></thead><tbody><tr><td>构建模式（开发时）</td><td>全量打包（解析所有依赖→生成 bundle）</td><td>非打包（ESM 原生加载+即时转译）</td></tr><tr><td>构建模式（生产时）</td><td>自身打包引擎（支持多入口、代码分割）</td><td>基于 Rollup 打包（产物更小、Tree-shaking 更优）</td></tr><tr><td>冷启动速度</td><td>慢（项目越大越慢）</td><td>极快（仅启动服务器，不打包）</td></tr><tr><td>热更新（HMR）速度</td><td>中等→慢（需重新构建模块链）</td><td>极快（仅更新修改的模块）</td></tr><tr><td>转译工具</td><td>依赖 Loader（如 babel-loader、ts-loader）</td><td>内置 ESBuild（无需手动配置）</td></tr><tr><td>配置复杂度</td><td>高（需区分 Loader/Plugin，配置繁琐）</td><td>低（零配置启动，按需扩展）</td></tr><tr><td>生态特点</td><td>庞大且封闭（仅支持 Webpack 专属插件/Loader）</td><td>简洁且开放（兼容大部分 Rollup 插件）</td></tr><tr><td>兼容性</td><td>强（支持 IE11 等老浏览器、CJS/ESM 模块）</td><td>现代浏览器优先（开发时依赖 ESM，可通过插件兼容 IE11）</td></tr><tr><td>核心扩展方式</td><td>Loader（转译模块）+ Plugin（流程扩展）</td><td>单一插件体系（通过钩子覆盖转译+流程扩展）</td></tr><tr><td>适用场景</td><td>大型复杂项目、老项目迁移、需兼容老浏览器</td><td>新项目、中中小型应用、Vue/React 生态、追求开发效率</td></tr></tbody></table>
<h2 data-id="heading-5">四、代码示例对比（核心配置+脚本）</h2>
<p>下面通过「React + TS 项目」的核心配置，对比两者的差异，感受 Vite 的简洁。</p>
<h3 data-id="heading-6">1. 项目初始化 + 开发/打包脚本</h3>
<h4 data-id="heading-7">Webpack 项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 初始化项目</span>
npm init -y

<span class="hljs-comment"># 2. 安装依赖（一堆 Loader 和 Plugin）</span>
npm install -D webpack webpack-cli babel-loader @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript html-webpack-plugin webpack-dev-server typescript ts-loader

<span class="hljs-comment"># 3. package.json 脚本</span>
{
  &amp;<span class="hljs-comment">#34;scripts&amp;#34;: {</span>
    &amp;<span class="hljs-comment">#34;dev&amp;#34;: &amp;#34;webpack serve&amp;#34;,  // 开发服务</span>
    &amp;<span class="hljs-comment">#34;build&amp;#34;: &amp;#34;webpack --mode production&amp;#34;  // 生产打包</span>
  }
}
</code></pre>
<h4 data-id="heading-8">Vite 项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 初始化项目（一键生成，自带 React+TS 配置）</span>
npm create vite@latest my-vite-app -- --template react-ts

<span class="hljs-comment"># 2. 安装依赖（仅需安装项目依赖，无需手动装转译工具）</span>
<span class="hljs-built_in">cd</span> my-vite-app &amp;&amp; npm install

<span class="hljs-comment"># 3. package.json 脚本（自带）</span>
{
  &amp;<span class="hljs-comment">#34;scripts&amp;#34;: {</span>
    &amp;<span class="hljs-comment">#34;dev&amp;#34;: &amp;#34;vite&amp;#34;,  // 开发服务</span>
    &amp;<span class="hljs-comment">#34;build&amp;#34;: &amp;#34;tsc &amp;&amp; vite build&amp;#34;,  // 类型检查+生产打包</span>
    &amp;<span class="hljs-comment">#34;preview&amp;#34;: &amp;#34;vite preview&amp;#34;  // 预览生产产物</span>
  }
}
</code></pre>
<h3 data-id="heading-9">2. 核心配置文件对比（处理 TS/JSX/CSS）</h3>
<h4 data-id="heading-10">Webpack 配置（webpack.config.js）</h4>
<p>需要手动配置 Loader 和 Plugin，才能处理 TS/JSX/CSS：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.tsx'</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[hash].js'</span>,
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 处理 TS/JSX（需要 babel-loader + @babel/preset-typescript）</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(ts|tsx)$/</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
      },
      <span class="hljs-comment">// 处理 CSS（需要 css-loader + style-loader）</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>]  <span class="hljs-comment">// 执行顺序：css-loader → style-loader</span>
      }
    ]
  },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>]
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 生成 HTML（需要 html-webpack-plugin）</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({ <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span> })
  ],
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">mode</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">'development'</span>
};
</code></pre>
<h4 data-id="heading-11">Vite 配置（vite.config.ts）</h4>
<p>零配置即可处理 TS/JSX/CSS，仅需少量配置扩展功能：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;  <span class="hljs-comment">// 仅需一个插件处理 React</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],  <span class="hljs-comment">// 集成 React 支持（含 TS/JSX 转译）</span>
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>
  }
});
</code></pre>
<h3 data-id="heading-12">3. 插件机制对比（处理 Vue 单文件组件）</h3>
<h4 data-id="heading-13">Webpack 中：需要 Loader + Plugin 配合</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
npm install -D vue-loader vue-style-loader css-loader MiniCssExtractPlugin
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">VueLoaderPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vue-loader'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">'vue-loader'</span>  <span class="hljs-comment">// Loader 负责转译 Vue SFC</span>
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span> ? <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span> : <span class="hljs-string">'vue-style-loader'</span>, <span class="hljs-string">'css-loader'</span>]
      }
    ]
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueLoaderPlugin</span>(),  <span class="hljs-comment">// Plugin 负责处理 Vue 相关流程</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>()  <span class="hljs-comment">// Plugin 负责生产时提取 CSS</span>
  ]
};
</code></pre>
<h4 data-id="heading-14">Vite 中：仅需一个插件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
npm install -D @vitejs/plugin-vue
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()]  <span class="hljs-comment">// 一个插件搞定转译+流程扩展</span>
});
</code></pre>
<h2 data-id="heading-15">五、插件机制深度解析（核心差异）</h2>
<p>Webpack 和 Vite 的插件机制差异，是两者配置复杂度和灵活性的关键：</p>
<h3 data-id="heading-16">1. Webpack：Loader + Plugin 分工明确</h3>
<ul>
<li><strong>Loader</strong>：仅负责「模块转译」（如 TS→JS、CSS→JS），是「模块级别的工具」；</li>
<li><strong>Plugin</strong>：仅负责「流程扩展」（如生成 HTML、压缩代码），是「流程级别的工具」；</li>
<li>必须配合使用，比如处理 Vue 文件需要 <code>vue-loader</code>（转译）+ <code>VueLoaderPlugin</code>（流程）。</li>
</ul>
<h3 data-id="heading-17">2. Vite：单一插件体系（整合 Loader+Plugin 功能）</h3>
<p>Vite 没有 Loader 概念，<strong>插件是唯一的扩展方式</strong>，通过「钩子函数」同时覆盖转译和流程扩展功能：</p>
<ul>
<li>转译模块（对应 Webpack Loader）：通过插件的 <code>transform</code> 钩子（如即时转译 TS/JSX）；</li>
<li>流程扩展（对应 Webpack Plugin）：通过插件的其他钩子（如 <code>configureServer</code> 配置开发服务器、<code>writeBundle</code> 处理产物）；</li>
<li>兼容 Rollup 插件：生产时基于 Rollup 打包，大部分 Rollup 插件可直接在 Vite 中使用（如 <code>rollup-plugin-terser</code> 压缩代码）。</li>
</ul>
<p><strong>示例：Vite 自定义插件（处理 .txt 文件）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'transform-txt'</span>,  <span class="hljs-comment">// 插件名称（必填）</span>
      <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {  <span class="hljs-comment">// 转译钩子（对应 Webpack Loader）</span>
        <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.txt'</span>)) {
          <span class="hljs-comment">// 将 .txt 文件内容转为 JS 模块导出</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(code)}</span>`</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }
    }
  ]
});
</code></pre>
<p>使用时直接导入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> content <span class="hljs-keyword">from</span> <span class="hljs-string">'./test.txt'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);  <span class="hljs-comment">// 输出 test.txt 的内容</span>
</code></pre>
<h2 data-id="heading-18">六、选型建议：什么时候选 Webpack，什么时候选 Vite？</h2>
<h3 data-id="heading-19">选 Vite 的场景（优先推荐）</h3>
<ol>
<li><strong>新项目启动</strong>：尤其是 Vue/React + TS 的中中小型应用，追求极致开发体验；</li>
<li><strong>现代浏览器优先</strong>：项目无需兼容 IE11，目标用户使用 Chrome/Firefox/Safari 等现代浏览器；</li>
<li><strong>开发效率优先</strong>：团队不想花大量时间配置构建工具，希望快速上手开发；</li>
<li><strong>静态站点/组件库</strong>：Vite 内置的静态资源处理和 Rollup 打包优化，适合组件库、静态博客等。</li>
</ol>
<h3 data-id="heading-20">选 Webpack 的场景</h3>
<ol>
<li><strong>大型复杂项目</strong>：比如多入口、多环境打包（浏览器+Node.js+Electron）、复杂代码分割策略；</li>
<li><strong>老项目迁移</strong>：项目已基于 Webpack 开发多年，依赖大量自定义 Loader/Plugin，迁移成本高；</li>
<li><strong>需要兼容老浏览器</strong>：必须支持 IE11 等老浏览器，Webpack 的兼容性处理更成熟；</li>
<li><strong>特殊场景需求</strong>：比如需要集成特定工具（如 Webpack Dev Middleware）、处理特殊资源（如大型视频、WASM 模块）。</li>
</ol>
<h2 data-id="heading-21">七、总结</h2>
<p>Webpack 是「全能选手」，通过「全量打包」和「庞大生态」覆盖所有前端构建场景，但牺牲了开发体验和配置简洁性；<br/>
Vite 是「现代优等生」，通过「非打包式开发」和「ESBuild/Rollup 优化」，解决了 Webpack 的核心痛点，配置更简洁、速度更快，但聚焦于现代前端场景。</p>
<p>随着 Vite 生态的快速成熟，<strong>90% 的新前端项目都可以优先选择 Vite</strong>；只有在大型复杂项目、老项目迁移或特殊兼容场景下，Webpack 仍是更稳妥的选择。</p>
<p>希望本文能帮你彻底搞懂两者的差异，做出最适合自己项目的选型！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在langchain Next 项目中使用 shadcn/ui 的记录]]></title>    <link>https://juejin.cn/post/7582104240987062298</link>    <guid>https://juejin.cn/post/7582104240987062298</guid>    <pubDate>2025-12-11T01:22:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582104240987062298" data-draft-id="7582047554090139657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在langchain Next 项目中使用 shadcn/ui 的记录"/> <meta itemprop="keywords" content="前端,CSS,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T01:22:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百罹鸟"/> <meta itemprop="url" content="https://juejin.cn/user/1838039173172072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在langchain Next 项目中使用 shadcn/ui 的记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1838039173172072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百罹鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:22:50.000Z" title="Thu Dec 11 2025 01:22:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>观瞻</strong>：作为一个接触ai-agent框架不久的开发者，最近在学习 Next + LangChain 技术栈时，决定做一个 AI 聊天 demo 来巩固知识。在这个过程中尝试了多个 UI 框架，最终选择了 shadcn/ui。记录下这段学习经历，希望未来能查漏补缺。</p>
<h2 data-id="heading-0">起因：为什么选择 shadcn/ui？</h2>
<p>现如今ui框架百花齐放，不过对组件库的选择还是有点困惑：</p>
<ul>
<li>Ant Design？感觉太重了，而且主要是面向后台系统的</li>
<li>MUI？React 生态里很火，但配置主题有点复杂</li>
<li>Tailwind CSS？听说很流行，但自己写组件太费时间</li>
</ul>
<h2 data-id="heading-1">第一个坑：它根本不是 npm 包！</h2>
<p>按照网上教程，我兴冲冲地运行：</p>
<pre><code class="hljs language-csharp" lang="csharp">bash
编辑
<span class="hljs-number">1</span>pnpm <span class="hljs-keyword">add</span> shadcn-ui
</code></pre>
<p>结果发现根本找不到这个包！一脸懵逼的我跑去 GitHub 看文档，才发现：</p>
<blockquote>
<p><strong>shadcn/ui 不是一个传统的组件库，而是一套可以复制到你项目里的组件代码</strong></p>
</blockquote>
<p>这完全颠覆了我对 "UI 框架" 的认知。以前用 Ant Design 或 Element UI，都是 <code>npm install</code> 就完事了，但 shadcn/ui 却要你把每个组件的源码直接放进自己的项目里。</p>
<p>一开始我觉得这很麻烦，但后来发现这其实是它的最大优势。</p>
<h2 data-id="heading-2">正确的安装姿势</h2>
<h3 data-id="heading-3">第一步：初始化项目</h3>
<p>首先要在你的 Next.js 项目根目录运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">bash
编辑
1pnpm dlx <span class="hljs-symbol">shadcn@</span>latest <span class="hljs-keyword">init</span>
</code></pre>
<p>这个命令会问你几个问题，比如是否使用 TypeScript、Tailwind CSS 配置路径等。我的项目已经配置好了 Tailwind，所以一路回车就行。</p>
<h3 data-id="heading-4">第二步：按需添加组件</h3>
<p>这里又踩了个小坑。我一开始以为要一个一个添加：</p>
<pre><code class="hljs language-sql" lang="sql">bash
编辑
<span class="hljs-number">1</span># 错误的想法
<span class="hljs-number">2</span>pnpm dlx shadcn<span class="hljs-variable">@latest</span> <span class="hljs-keyword">add</span> button
<span class="hljs-number">3</span>pnpm dlx shadcn<span class="hljs-variable">@latest</span> <span class="hljs-keyword">add</span> input
<span class="hljs-number">4</span>pnpm dlx shadcn<span class="hljs-variable">@latest</span> <span class="hljs-keyword">add</span> card
<span class="hljs-number">5</span># ... 还要输入<span class="hljs-number">7</span>次
</code></pre>
<p>后来发现其实可以一次性添加所有需要的组件：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">bash</span>
编辑
<span class="hljs-number">1</span><span class="hljs-selector-tag">pnpm</span> <span class="hljs-selector-tag">dlx</span> <span class="hljs-selector-tag">shadcn</span>@<span class="hljs-selector-tag">latest</span> <span class="hljs-selector-tag">add</span> <span class="hljs-selector-tag">button</span> <span class="hljs-selector-tag">input</span> <span class="hljs-selector-tag">card</span> <span class="hljs-selector-tag">scroll-area</span> <span class="hljs-selector-tag">spinner</span> <span class="hljs-selector-tag">toast</span> <span class="hljs-selector-tag">separator</span> <span class="hljs-selector-tag">label</span>
</code></pre>
<p><strong>注意</strong>：一定要用 <code>pnpm dlx</code>，而不是直接 <code>pnpm shadcn</code>，否则终端会报错找不到命令。</p>
<h3 data-id="heading-5">第三步：看看生成了什么</h3>
<p>运行完命令后，我发现项目里多了一个 <code>components/ui/</code> 目录，里面是我刚才添加的所有组件文件：</p>
<pre><code class="hljs language-css" lang="css">text
编辑
<span class="hljs-number">1</span>components/
<span class="hljs-number">2</span>└── ui/
<span class="hljs-number">3</span>    ├── <span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">4</span>    ├── <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">5</span>    ├── card<span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">6</span>    ├── scroll-area<span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">7</span>    ├── spinner<span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">8</span>    ├── toast<span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">9</span>    ├── separator<span class="hljs-selector-class">.tsx</span>
<span class="hljs-number">10</span>    └── <span class="hljs-selector-tag">label</span><span class="hljs-selector-class">.tsx</span>
</code></pre>
<p>每个文件都是独立的，我可以随时打开修改，比如我想把按钮的圆角改大一点，直接编辑 <code>button.tsx</code> 就行，不用去查文档找怎么覆盖样式。</p>
<h2 data-id="heading-6">为什么我觉得 shadcn/ui 特别适合聊天应用？</h2>
<p>做聊天应用有几个特殊需求：</p>
<ol>
<li><strong>消息气泡要区分用户和 AI</strong></li>
<li><strong>输入框要有发送按钮</strong></li>
<li><strong>聊天历史要能滚动</strong></li>
<li><strong>AI 回复时要有加载状态</strong></li>
</ol>
<p>shadcn/ui 的这几个组件完美解决了这些问题：</p>
<h3 data-id="heading-7">消息气泡（Card 组件）</h3>
<pre><code class="hljs language-typescript" lang="typescript">tsx
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// components/message-bubble.tsx</span>
2<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">CardContent</span> } <span class="hljs-keyword">from</span> &amp;#<span class="hljs-number">34</span>;@/components/ui/card&amp;#<span class="hljs-number">34</span>;;
<span class="hljs-number">3</span>
4<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MessageBubble</span>(<span class="hljs-params">{ isUser = <span class="hljs-literal">false</span>, content }: { isUser: <span class="hljs-built_in">boolean</span>; content: <span class="hljs-built_in">string</span> }</span>) {
<span class="hljs-number">5</span>  <span class="hljs-keyword">return</span> (
<span class="hljs-number">6</span>    
<span class="hljs-number">7</span>      
<span class="hljs-number">8</span>        &lt;p&gt;{content}&lt;/p&gt;
<span class="hljs-number">9</span>      
<span class="hljs-number">10</span>    
<span class="hljs-number">11</span>  );
<span class="hljs-number">12</span>}
</code></pre>
<h3 data-id="heading-8">聊天输入区域（Input + Button + Spinner）</h3>
<pre><code class="hljs language-javascript" lang="javascript">tsx
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// components/chat-input.tsx</span>
2<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Input</span> } <span class="hljs-keyword">from</span> &amp;#<span class="hljs-number">34</span>;@/components/ui/input&amp;#<span class="hljs-number">34</span>;;
3<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> &amp;#<span class="hljs-number">34</span>;@/components/ui/button&amp;#<span class="hljs-number">34</span>;;
4<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Spinner</span> } <span class="hljs-keyword">from</span> &amp;#<span class="hljs-number">34</span>;@/components/ui/spinner&amp;#<span class="hljs-number">34</span>;;
<span class="hljs-number">5</span>
6<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatInput</span>(<span class="hljs-params">{ message, setMessage, onSubmit, isLoading }: any</span>) {
<span class="hljs-number">7</span>  <span class="hljs-keyword">return</span> (
<span class="hljs-number">8</span>    &lt;div&gt;
<span class="hljs-number">9</span>       <span class="hljs-title function_">setMessage</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)}
<span class="hljs-number">12</span>        placeholder=&amp;#<span class="hljs-number">34</span>;输入消息...&amp;#<span class="hljs-number">34</span>;
<span class="hljs-number">13</span>        onKeyDown={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &amp;&amp; <span class="hljs-title function_">onSubmit</span>()}
<span class="hljs-number">14</span>        disabled={isLoading}
<span class="hljs-number">15</span>      /&gt;
<span class="hljs-number">16</span>      
<span class="hljs-number">17</span>        {isLoading ?  : &amp;#<span class="hljs-number">34</span>;发送&amp;#<span class="hljs-number">34</span>;}
<span class="hljs-number">18</span>      
<span class="hljs-number">19</span>    &lt;/div&gt;
<span class="hljs-number">20</span>  );
<span class="hljs-number">21</span>}
</code></pre>
<h3 data-id="heading-9">聊天历史滚动（ScrollArea）</h3>
<pre><code class="hljs language-javascript" lang="javascript">tsx
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// app/page.tsx</span>
2<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScrollArea</span> } <span class="hljs-keyword">from</span> &amp;#<span class="hljs-number">34</span>;@/components/ui/scroll-area&amp;#<span class="hljs-number">34</span>;;
<span class="hljs-number">3</span>
4<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatPage</span>(<span class="hljs-params"/>) {
<span class="hljs-number">5</span>  <span class="hljs-comment">// ... 其他逻辑</span>
<span class="hljs-number">6</span>  
<span class="hljs-number">7</span>  <span class="hljs-keyword">return</span> (
<span class="hljs-number">8</span>    &lt;div&gt;
<span class="hljs-number">9</span>      
<span class="hljs-number">10</span>        {messages.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">msg, i</span>) =&gt;</span> (
<span class="hljs-number">11</span>          
<span class="hljs-number">12</span>        ))}
<span class="hljs-number">13</span>      
<span class="hljs-number">14</span>      
<span class="hljs-number">15</span>    &lt;/div&gt;
<span class="hljs-number">16</span>  );
<span class="hljs-number">17</span>}
</code></pre>
<h2 data-id="heading-10">主题定制：比想象中简单</h2>
<p>最让我惊喜的是主题定制。因为我的项目已经用了 Tailwind CSS，所以只需要在 <code>tailwind.config.js</code> 里配置颜色：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">js</span>
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// tailwind.config.js</span>
<span class="hljs-number">2</span><span class="hljs-selector-tag">module</span><span class="hljs-selector-class">.exports</span> = {
<span class="hljs-number">3</span>  <span class="hljs-selector-tag">theme</span>: {
<span class="hljs-number">4</span>    <span class="hljs-selector-tag">extend</span>: {
<span class="hljs-number">5</span>      <span class="hljs-selector-tag">colors</span>: {
<span class="hljs-number">6</span>        <span class="hljs-selector-tag">primary</span>: {
<span class="hljs-number">7</span>          <span class="hljs-number">500</span>: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-id">#60a5fa</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-comment">// 蓝色 - 用户消息</span>
<span class="hljs-number">8</span>        },
<span class="hljs-number">9</span>        <span class="hljs-selector-tag">secondary</span>: {
<span class="hljs-number">10</span>          <span class="hljs-number">500</span>: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-id">#22c55e</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-comment">// 绿色 - AI 消息</span>
<span class="hljs-number">11</span>        }
<span class="hljs-number">12</span>      }
<span class="hljs-number">13</span>    }
<span class="hljs-number">14</span>  }
<span class="hljs-number">15</span>}
</code></pre>
<p>然后在组件里直接用 <code>bg-primary-500</code>、<code>bg-secondary-500</code> 就行了，完全不需要额外的配置。</p>
<h2 data-id="heading-11">遇到的问题和解决方案</h2>
<h3 data-id="heading-12">问题1：DevTools 小图标太烦人</h3>
<p>Next.js 16 开发模式右下角有个小图标，特别影响调试。试了很多方法都不行，最后用 CSS 强制隐藏：</p>
<pre><code class="hljs language-ini" lang="ini">tsx
编辑
1// app/layout.tsx
2if (typeof window !== &amp;<span class="hljs-comment">#34;undefined&amp;#34; &amp;&amp; process.env.NODE_ENV === &amp;#34;development&amp;#34;) {</span>
3  const <span class="hljs-attr">hideDevtools</span> = () =&gt; {
4    const <span class="hljs-attr">style</span> = document.createElement(&amp;<span class="hljs-comment">#34;style&amp;#34;);</span>
5    <span class="hljs-attr">style.innerHTML</span> = `
6      <span class="hljs-comment">#devtools-indicator,</span>
7      .nextjs-toast {
8        display: none !important<span class="hljs-comment">;</span>
9      }
10    `<span class="hljs-comment">;</span>
11    document.head.appendChild(style)<span class="hljs-comment">;</span>
12  }<span class="hljs-comment">;</span>
13  
14  if (<span class="hljs-attr">document.readyState</span> === &amp;<span class="hljs-comment">#34;loading&amp;#34;) {</span>
15    document.addEventListener(&amp;<span class="hljs-comment">#34;DOMContentLoaded&amp;#34;, hideDevtools);</span>
16  } else {
17    hideDevtools()<span class="hljs-comment">;</span>
18  }
19}
</code></pre>
<h3 data-id="heading-13">问题2：组件太多不知道选哪些</h3>
<p>一开始我也想把所有组件都装上，后来发现完全没必要。对于聊天应用，其实就那几个核心组件：</p>
<ul>
<li><strong>Button</strong>：发送按钮</li>
<li><strong>Input</strong>：消息输入</li>
<li><strong>Card</strong>：消息气泡</li>
<li><strong>ScrollArea</strong>：聊天滚动</li>
<li><strong>Spinner</strong>：加载状态</li>
</ul>
<p>其他像 Toast、Separator、Label 这些是提升体验用的，可以根据需要再加。</p>
<h2 data-id="heading-14">总结：shadcn/ui 到底值不值得用？</h2>
<p>作为一个初学者，我觉得 shadcn/ui 有这些优点：</p>
<p>✅ <strong>学习成本低</strong>：基于 Tailwind CSS，样式直观易懂<br/>
✅ <strong>高度可定制</strong>：组件代码就在你项目里，想怎么改都行<br/>
✅ <strong>按需使用</strong>：不会引入没用的代码，包体积小<br/>
✅ <strong>Next.js 友好</strong>：完美支持 React Server Components</p>
<p>当然也有缺点： ❌ <strong>不是传统 npm 包</strong>：需要适应新的使用方式<br/>
❌ <strong>需要手动管理</strong>：组件更新需要自己同步官方代码</p>
<p>但总的来说，<strong>如果你在用 Next.js + Tailwind CSS，shadcn/ui 绝对值得一试</strong>。特别是做聊天应用这种需要高度定制 UI 的场景，它能让你快速搭建出专业级的界面。</p>
<h2 data-id="heading-15">最后的建议</h2>
<ol>
<li><strong>不要试图一次装所有组件</strong>，按需添加就好</li>
<li><strong>善用 Tailwind 的主题配置</strong>，让整个应用风格统一</li>
<li><strong>把组件当成自己的代码</strong>，大胆修改以适应需求</li>
<li><strong>遇到问题先看官方文档</strong>，shadcn/ui 的文档写得非常清晰</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的组件 API 为什么像个垃圾场？—— React 复合组件模式 (Compound Components) 实战教学]]></title>    <link>https://juejin.cn/post/7582118218648027162</link>    <guid>https://juejin.cn/post/7582118218648027162</guid>    <pubDate>2025-12-11T01:34:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582118218648027162" data-draft-id="7580174845771481097" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的组件 API 为什么像个垃圾场？—— React 复合组件模式 (Compound Components) 实战教学"/> <meta itemprop="keywords" content="前端,架构,React.js"/> <meta itemprop="datePublished" content="2025-12-11T01:34:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大布布将军"/> <meta itemprop="url" content="https://juejin.cn/user/1535361573994189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的组件 API 为什么像个垃圾场？—— React 复合组件模式 (Compound Components) 实战教学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535361573994189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大布布将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:34:16.000Z" title="Thu Dec 11 2025 01:34:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：一种名为“配置地狱”的组件</h2>
<p>接上回。咱们用 <strong>React Query</strong> 把服务端状态剥离了，用 <strong>Context</strong> 把全局状态理顺了。现在你的数据流很干净。</p>
<p>但是，当你打开 <code>components</code> 文件夹，看着那个被你改了无数次的 <code>Tabs</code> 组件，是不是又想骂人了？</p>
<p>为了满足产品经理五彩斑斓的需求，你的组件 props 越加越多，最后变成了这样：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// ❌ 典型的“配置型”组件</span>
 }, { <span class="hljs-attr">title</span>: <span class="hljs-string">'设置'</span>, <span class="hljs-attr">content</span>:  }]}
  activeTab={currentTab}
  onTabChange={setCurrentTab}
  tabBarClassName=&amp;#<span class="hljs-number">34</span>;bg-gray-<span class="hljs-number">100</span>&amp;#<span class="hljs-number">34</span>; <span class="hljs-comment">// 想改 Tab 栏背景？加个 prop</span>
  tabItemClassName=&amp;#<span class="hljs-number">34</span>;text-lg&amp;#<span class="hljs-number">34</span>;    <span class="hljs-comment">// 想改文字大小？加个 prop</span>
  activeTabClassName=&amp;#<span class="hljs-number">34</span>;text-blue&amp;#<span class="hljs-number">34</span>; <span class="hljs-comment">// 想改选中态颜色？再加个 prop</span>
  renderTabBarExtraContent={新建} <span class="hljs-comment">// 想在右边加个按钮？又要加 prop</span>
  tabPosition=&amp;#<span class="hljs-number">34</span>;top&amp;#<span class="hljs-number">34</span>; <span class="hljs-comment">// 想把 Tab 放左边？还得加逻辑</span>
/&gt;
</code></pre>
<p>这就叫**“配置地狱”**。 你试图通过 props 暴露出所有的 UI 细节，结果就是这个组件变得巨臃肿，且极难复用。如果我想给第二个 Tab 加个红点（Badge），你是不是还得给 <code>items</code> 数组的数据结构里加个字段？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/938ec7b1484742f29689c45eaa6bb3ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5biD5biD5bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021655&amp;x-signature=RPgSjrg68CUgj063GR5Z4m54Oj0%3D" alt="src=http___image109.360doc.com_DownloadImg_2023_04_1510_264406834_10_20230415101010334.gif&amp;refer=http___image109.360doc.gif" loading="lazy"/>
兄弟，别再折磨自己了。今天我们来学学 <strong>Compound Components（复合组件模式）</strong> 。看看人家 HTML 原生标签是怎么教我们做人的。</p>
<h2 data-id="heading-1">灵感来源：向 `` 致敬</h2>
<p>你仔细想想，原生的 `` 标签是怎么用的？</p>
<pre><code class="hljs">  苹果
  香蕉

</code></pre>
<p>你并没有传一个 <code>options</code> 数组给 <code>，而是直接把 </code> 塞到了 `` 里面。</p>
<ul>
<li>`` 负责管理状态（当前选了谁）。</li>
<li><code>负责渲染每一项，并且告诉</code> “我被点了”。</li>
</ul>
<p>这种**“父组件管状态，子组件管渲染，通过隐式契约通信”**的模式，就是复合组件模式。</p>
<hr/>
<h2 data-id="heading-2">实战重构：把 Tabs 拆开</h2>
<p>我们要把那个臃肿的 <code>Tabs</code> 组件，拆成 <code>Tabs</code>, <code>TabList</code>, <code>Tab</code>, <code>TabPanels</code>, <code>Panel</code> 这一套乐高积木。</p>
<h3 data-id="heading-3">第一步：创建上下文 (Context)</h3>
<p>父组件需要一个地方来告诉子组件：现在的 <code>activeTab</code> 是谁，以及提供一个 <code>setActiveTab</code> 的方法。</p>
<pre><code class="hljs language-import" lang="import">
const TabsContext = createContext(null);

// 这是一个自定义 Hook，方便子组件拿数据，顺便做个错误检查
const useTabs = () =&gt; {
  const context = useContext(TabsContext);
  if (!context) throw new Error('Tabs 子组件必须包裹在  里面！');
  return context;
};
</code></pre>
<h3 data-id="heading-4">第二步：父组件 (Tabs) —— 状态的大管家</h3>
<p>它不负责画 UI，只负责提供 Context。</p>
<pre><code class="hljs language-const" lang="const">  const [selectedIndex, setSelectedIndex] = useState(defaultIndex);

  return (
    
      &lt;div&gt;{children}&lt;/div&gt;
    
  );
};
</code></pre>
<h3 data-id="heading-5">第三步：子组件 (Tab &amp; Panel) —— 真正的打工人</h3>
<p><strong>Tab 按钮：</strong></p>
<pre><code class="hljs language-const" lang="const">  const { selectedIndex, setSelectedIndex } = useTabs();
  const isActive = selectedIndex === index;

  return (
     setSelectedIndex(index)}
    &gt;
      {children}
    
  );
};
</code></pre>
<p>Panel 内容区：</p>
<pre><code class="hljs language-const" lang="const">  const { selectedIndex } = useTabs();
  // 只有选中时才渲染
  return selectedIndex === index ? &lt;div&gt;{children}&lt;/div&gt; : null;
};
</code></pre>
<h2 data-id="heading-6">见证奇迹的时刻：调用方式</h2>
<p>重构完之后，我们在页面里怎么用呢？</p>
<pre><code class="hljs language-//" lang="//">
  {/* 你可以在这里随便加 div，随便写样式，完全不受 props 限制 */}
  &lt;div&gt;
    &lt;div&gt;
      用户管理
      
      {/* 居然可以给单独某一个 Tab 加红点，甚至加 Tooltip，随你便！ */}
      
        系统设置 &lt;span&gt;●&lt;/span&gt;
      
    &lt;/div&gt;

    {/* 想在右边加个按钮？直接写啊！不用传什么 renderExtraContent */}
    刷新
  &lt;/div&gt;

  &lt;div&gt;
    
    
  &lt;/div&gt;

</code></pre>
<p><strong>对比一下之前的代码，现在的优势在哪里？</strong></p>
<ol>
<li><strong>UI 结构完全解耦</strong>：你想把 <code>Tab</code> 列表放在下面？想把 <code>Panel</code> 放在上面？随便你怎么排版 HTML，组件逻辑完全不需要改。</li>
<li><strong>内容随心所欲</strong>：你想在 Tab 标题里加图标？加红点？加 loading 动画？直接在 <code>children</code> 里写 JSX 也就是了，不需要去改组件源码。</li>
<li><strong>没有 Props Drilling</strong>：状态通过 Context 隐式传递，你不用手动把 <code>activeTab</code> 传给每一个 Tab。</li>
</ol>
<h2 data-id="heading-7">进阶技巧：这就是 Headless UI 的雏形</h2>
<p>聪明的你可能发现了，这种模式其实就是我在前几篇提到的 <strong>Headless UI</strong> 的一种实现方式。</p>
<p>像著名的 UI 库 <strong>Radix UI</strong> 或者 <strong>Headless UI (Tailwind)</strong> ，全是这个路子。</p>
<ul>
<li>``</li>
<li>``</li>
<li>``</li>
<li>``</li>
</ul>
<p>它们把组件拆得稀碎，把**“怎么组合”**的权力交还给了你。</p>
<p>当然，这种模式也有个小缺点：<strong>代码量变多了</strong>。 以前写个 `` 只要一行，现在要写十几行。</p>
<p><strong>怎么解？</strong> 你可以基于这个复合组件，再封装一层“傻瓜式”组件给没特殊需求的场景用。但是底层的实现，一定要保持这种灵活性。</p>
<hr/>
<h2 data-id="heading-8">总结</h2>
<p>当你发现你的组件需要接受 <code>xxxStyle</code>, <code>xxxClassName</code>, <code>renderXxx</code> 这种 props 的时候，请立刻停下来。</p>
<p>这说明你在<strong>试图控制你控制不了的事情</strong>（外部的 UI 展示）。</p>
<p>把控制权交出去。用 <strong>Compound Components</strong> 模式，让使用者像拼乐高一样组装你的组件。 你会发现，你再也不用因为设计稿改了一个 margin 或者加了一个 icon 而去改组件源码了。这才是真正的<strong>高内聚、低耦合</strong>。</p>
<p>好了，我要去把那个传了 20 个 props 的 <code>Modal</code> 组件给拆了，祝大家的组件 API 永远性感。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d4c5ce6ede4d7cb8940f19ef785f27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5biD5biD5bCG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021655&amp;x-signature=R%2FX8jthB9N%2FXqYwadVV1MZcFlz0%3D" alt="lg_90841_1619336946_60851ef204362.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p><strong>下期预告</strong>：Tabs 切换是搞定了，但有个问题：用户刷新页面后，又回到了第一个 Tab，辛辛苦苦填的表单也没了。 还有，我想把“当前在第二个 Tab”这个状态分享给同事，怎么做？ 下一篇，我们来聊聊 <strong>“URL 即状态 (URL as State)”</strong> 。教你如何把 React 状态同步到 URL 参数里，让你的应用拥有“记忆”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我踩了 72 小时的 Electron webview PDF 灰色坑，只为告诉你：别写这行代码！]]></title>    <link>https://juejin.cn/post/7582133314686140468</link>    <guid>https://juejin.cn/post/7582133314686140468</guid>    <pubDate>2025-12-11T01:57:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582133314686140468" data-draft-id="7582114266075299855" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我踩了 72 小时的 Electron webview PDF 灰色坑，只为告诉你：别写这行代码！"/> <meta itemprop="keywords" content="前端,JavaScript,Electron"/> <meta itemprop="datePublished" content="2025-12-11T01:57:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360628462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我踩了 72 小时的 Electron webview PDF 灰色坑，只为告诉你：别写这行代码！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360628462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:57:17.000Z" title="Thu Dec 11 2025 01:57:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这辈子都不想再看到那个该死的灰色背景了！</p>
<h2 data-id="heading-0">症状（你绝对中过）</h2>
<ul>
<li>背景是经典 PDF 灰色，但内容永远不显示</li>
<li>连最干净的 dummy.pdf 都只给灰色</li>
<li>plugins: true、webSecurity: false、sandbox: false、contextIsolation: false 全开了也没用</li>
<li>甚至加了 app.commandLine.appendSwitch('enable-pdf-extension') 这发核弹都不行</li>
<li>你已经快疯了</li>
</ul>
<h2 data-id="heading-1">终极元凶（就是它！）</h2>
<p>JavaScript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 主进程里偷偷出现过这行代码，就是它毒死了你整个应用！</span>
session.<span class="hljs-title function_ invoke__">fromPartition</span>(<span class="hljs-string">'nocache'</span>, { <span class="hljs-attr">cache</span>: <span class="hljs-literal">false</span> })
</code></pre>
<p>只要这行代码执行过一次，整个默认 session 就被永久污染，PDF Viewer 插件直接原地去世，永不翻身！</p>
<h2 data-id="heading-2">正确做法（三步永绝后患）</h2>
<h3 data-id="heading-3">第一步：立刻删除这行毒代码（必须删，别注释！）</h3>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 删掉！删掉！删掉！重要的事情说三遍</span>
<span class="hljs-comment">// session.fromPartition('nocache', { cache: false })</span>
</code></pre>
<h3 data-id="heading-4">第二步：重启软件（必须重启！不清毒永远灰）</h3>
<p>被污染的默认 session 只有重启才能清掉。</p>
<h3 data-id="heading-5">第三步：以后这样写就天下太平</h3>
<p>HTML</p>
<pre><code class="hljs language-css" lang="css">

  style=&amp;<span class="hljs-selector-id">#34</span>;<span class="hljs-attribute">width</span>:<span class="hljs-number">100%</span>; <span class="hljs-attribute">height</span>:<span class="hljs-number">100vh</span>;&amp;<span class="hljs-selector-id">#34</span>;
&gt;



&gt;
</code></pre>
<h2 data-id="heading-6">为什么加 partition 就活了？</h2>
<p>因为 partition="persist:pdfviewer" 给 webview 开了一个全新的、从未被 { cache: false } 污染过的、持久化的独立 session，PDF 插件终于能正常加载了！</p>
<h2 data-id="heading-7">亲测有效的终极配置（直接抄）</h2>
<p>JavaScript</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">main.js（主窗口随便怎么安全都行）</span>
<span class="hljs-string">new</span> <span class="hljs-string">BrowserWindow({</span>
  <span class="hljs-attr">webPreferences:</span> {
    <span class="hljs-attr">webviewTag:</span> <span class="hljs-literal">true</span>,
    <span class="hljs-string">//</span> <span class="hljs-attr">contextIsolation:</span> <span class="hljs-literal">true</span> <span class="hljs-string">全开也没事，随便玩</span>
  }
<span class="hljs-string">})</span>
</code></pre>
<p>HTML</p>
<pre><code class="hljs">

</code></pre>
<h2 data-id="heading-8">验证链接（随便点都亮）</h2>
<ol>
<li>国际标准：</li>
<li>国内防盗链：</li>
<li>企业内网签名链接：随便多长都行</li>
</ol>
<p>删掉那行毒代码 + 加好 partition → 全部秒显示！</p>
<h2 data-id="heading-9">总结（只记这三句话）</h2>
<ol>
<li>永远不要在主进程写 session.fromPartition('xxx', { cache: false })</li>
<li>PDF webview 必须加 partition="persist:pdfviewer"</li>
<li>想禁用缓存的 webview 单独加 partition="nocache"</li>
</ol>
<p>做完这三步，从此与灰色背景永别！</p>
<p>把这篇文章收藏起来，半年后你会含着泪点开它，然后感谢现在的自己</p>
<p>（已救无数后来人，包括半年后的你）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端架构范式：意图系统构建web]]></title>    <link>https://juejin.cn/post/7582114266075332623</link>    <guid>https://juejin.cn/post/7582114266075332623</guid>    <pubDate>2025-12-11T01:57:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582114266075332623" data-draft-id="7582096212662910976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端架构范式：意图系统构建web"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-11T01:57:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="alanAltman"/> <meta itemprop="url" content="https://juejin.cn/user/2796746682938440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端架构范式：意图系统构建web
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2796746682938440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    alanAltman
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:57:14.000Z" title="Thu Dec 11 2025 01:57:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端架构范式：意图系统构建web</h2>
<blockquote>
<p>当业务复杂度呈指数级增长时，传统的前端架构开始显现瓶颈。本文通过分析 xxx Jet 框架的实战代码，探讨意图系统如何成为解决复杂前端应用架构问题的银弹。</p>
</blockquote>
<h3 data-id="heading-1">一、前端开发的架构困境</h3>
<p>在电商这类复杂前端应用中，我们常常面临这样的挑战：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统的紧耦合代码 - 难以维护的典型案例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductPage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">productId</span>) {
    <span class="hljs-comment">// 1. 调用API</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/cart/add'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ productId })
    });
    
    <span class="hljs-comment">// 2. 更新本地状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cartCount</span>++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateUI</span>();
    
    <span class="hljs-comment">// 3. 发送分析事件</span>
    analytics.<span class="hljs-title function_">track</span>(<span class="hljs-string">'add_to_cart'</span>, { productId });
    
    <span class="hljs-comment">// 4. 检查库存</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkInventory</span>(productId);
    
    <span class="hljs-comment">// 5. 更新推荐</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateRecommendations</span>();
    
    <span class="hljs-comment">// 更多业务逻辑...</span>
    <span class="hljs-comment">// 这个函数已经超过100行，还在继续增长</span>
  }
}
</code></pre>
<p>这种<strong>意大利面条式代码</strong>的问题在于：</p>
<ul>
<li>业务逻辑分散在UI组件中</li>
<li>难以测试和复用</li>
<li>新增功能时容易破坏现有逻辑</li>
<li>跨团队协作困难</li>
</ul>
<h3 data-id="heading-2">二、意图系统：从"如何做"到"做什么"</h3>
<p>意图系统的核心思想是<strong>将用户意图与具体实现分离</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Jet 框架中的意图定义</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Intent</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// 意图类型</span>
  payload?: T;           <span class="hljs-comment">// 意图数据</span>
  metadata?: <span class="hljs-title class_">Record</span>;
}

<span class="hljs-comment">// 用户操作转化为意图</span>
<span class="hljs-keyword">const</span> intents = {
  <span class="hljs-attr">viewProduct</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'VIEW_PRODUCT'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">productId</span>: <span class="hljs-string">'iphone-15'</span> } },
  <span class="hljs-attr">addToCart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_TO_CART'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">productId</span>: <span class="hljs-string">'iphone-15'</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> } },
  <span class="hljs-attr">startCheckout</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'START_CHECKOUT'</span> }
};

<span class="hljs-comment">// 统一调度入口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Jet</span> {
  <span class="hljs-keyword">async</span> dispatch&lt;i&gt;(<span class="hljs-attr">intent</span>: I) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">dispatch</span>(intent);
  }
}
</code></pre>
<p>这种转变带来了思维模式的升级：</p>





















<table><thead><tr><th>传统方式</th><th>意图系统</th></tr></thead><tbody><tr><td><strong>命令式</strong>："调用API，更新状态，发送分析"</td><td><strong>声明式</strong>："用户想要加入购物车"</td></tr><tr><td><strong>关注实现</strong>：如何完成操作</td><td><strong>关注目标</strong>：要达成什么结果</td></tr><tr><td><strong>紧耦合</strong>：UI与业务逻辑绑定</td><td><strong>松耦合</strong>：UI只声明意图</td></tr></tbody></table>
<h3 data-id="heading-3">三、六大核心优势</h3>
<h4 data-id="heading-4">1. <strong>业务逻辑集中化，告别散弹式修改</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 所有业务逻辑集中在意图处理器中</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AddToCartIntentHandler</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">intent, objectGraph</span>) {
    <span class="hljs-keyword">const</span> { cartService, analytics, inventory } = objectGraph;
    
    <span class="hljs-comment">// 集中化的业务逻辑</span>
    <span class="hljs-keyword">await</span> cartService.<span class="hljs-title function_">add</span>(intent.<span class="hljs-property">payload</span>.<span class="hljs-property">productId</span>);
    <span class="hljs-keyword">await</span> analytics.<span class="hljs-title function_">track</span>(<span class="hljs-string">'add_to_cart'</span>, intent.<span class="hljs-property">payload</span>);
    <span class="hljs-keyword">await</span> inventory.<span class="hljs-title function_">reserve</span>(intent.<span class="hljs-property">payload</span>.<span class="hljs-property">productId</span>);
    
    <span class="hljs-comment">// 可以轻松添加新逻辑而不影响UI</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFirstCartAdd</span>(intent.<span class="hljs-property">payload</span>.<span class="hljs-property">userId</span>)) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showWelcomeBonus</span>();
    }
  }
}
</code></pre>
<p><strong>优势</strong>：修改业务逻辑只需改动一处，不会意外破坏UI功能。</p>
<h4 data-id="heading-5">2. <strong>天然支持A/B测试和功能开关</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 动态切换意图处理器实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExperimentAwareIntentDispatcher</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">intent</span>) {
    <span class="hljs-keyword">const</span> experiment = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getExperiment</span>(intent.<span class="hljs-property">type</span>);
    
    <span class="hljs-keyword">if</span> (experiment.<span class="hljs-property">variant</span> === <span class="hljs-string">'A'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlerA</span>.<span class="hljs-title function_">handle</span>(intent);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlerB</span>.<span class="hljs-title function_">handle</span>(intent); <span class="hljs-comment">// 新实现</span>
    }
  }
}

<span class="hljs-comment">// 功能开关控制</span>
<span class="hljs-keyword">if</span> (featureFlags.<span class="hljs-property">enableNewCheckout</span>) {
  dispatcher.<span class="hljs-title function_">register</span>(<span class="hljs-string">'START_CHECKOUT'</span>, newEnhancedCheckoutHandler);
} <span class="hljs-keyword">else</span> {
  dispatcher.<span class="hljs-title function_">register</span>(<span class="hljs-string">'START_CHECKOUT'</span>, legacyCheckoutHandler);
}
</code></pre>
<p><strong>优势</strong>：无需修改UI代码即可进行实验和灰度发布。</p>
<h4 data-id="heading-6">3. <strong>统一的路由和深层链接处理</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// URL 直接映射到意图</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlRouter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> intent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">urlToIntent</span>(url); <span class="hljs-comment">// /product/iphone → VIEW_PRODUCT</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> jet.<span class="hljs-title function_">dispatch</span>(intent);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">intentToPage</span>(result);
  }
}

<span class="hljs-comment">// 支持复杂的深层链接</span>
<span class="hljs-comment">// /product/iphone/add-to-cart?quantity=2</span>
<span class="hljs-comment">// 可以统一解析为 ADD_TO_CART 意图</span>
</code></pre>
<p><strong>优势</strong>：统一处理所有导航，简化了深层链接和分享功能实现。</p>
<h4 data-id="heading-7">4. <strong>完美的跨平台一致性</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CrossPlatformIntentHandler</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">intent, objectGraph</span>) {
    <span class="hljs-keyword">const</span> platform = objectGraph.<span class="hljs-property">platform</span>;
    
    <span class="hljs-comment">// 同一意图在不同平台执行适当操作</span>
    <span class="hljs-keyword">switch</span>(platform) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'web'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleWeb</span>(intent);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ios'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleiOS</span>(intent);    <span class="hljs-comment">// 调用原生API</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'android'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAndroid</span>(intent); <span class="hljs-comment">// 调用Kotlin代码</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ssr'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSSR</span>(intent);    <span class="hljs-comment">// 服务端渲染逻辑</span>
    }
  }
}
</code></pre>
<p><strong>优势</strong>：一套业务逻辑，多端统一体验。</p>
<h4 data-id="heading-8">5. <strong>增强的可测试性和可维护性</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 单元测试变得简单直接</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">'AddToCartIntentHandler'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'应该添加商品并发送分析'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> mockCart = { <span class="hljs-attr">add</span>: jest.<span class="hljs-title function_">fn</span>() };
    <span class="hljs-keyword">const</span> mockAnalytics = { <span class="hljs-attr">track</span>: jest.<span class="hljs-title function_">fn</span>() };
    
    <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddToCartIntentHandler</span>();
    <span class="hljs-keyword">const</span> intent = { <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_TO_CART'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">productId</span>: <span class="hljs-string">'123'</span> } };
    
    <span class="hljs-keyword">await</span> handler.<span class="hljs-title function_">handle</span>(intent, { <span class="hljs-attr">cart</span>: mockCart, <span class="hljs-attr">analytics</span>: mockAnalytics });
    
    <span class="hljs-title function_">expect</span>(mockCart.<span class="hljs-property">add</span>).<span class="hljs-title function_">toHaveBeenCalledWith</span>(<span class="hljs-string">'123'</span>);
    <span class="hljs-title function_">expect</span>(mockAnalytics.<span class="hljs-property">track</span>).<span class="hljs-title function_">toHaveBeenCalledWith</span>(<span class="hljs-string">'add_to_cart'</span>, { <span class="hljs-attr">productId</span>: <span class="hljs-string">'123'</span> });
  });
});

<span class="hljs-comment">// 集成测试验证整个流程</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">'Checkout Flow'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'应该完成完整的结账流程'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">testWorkflow</span>([
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'START_CHECKOUT'</span> },
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'SELECT_SHIPPING'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">method</span>: <span class="hljs-string">'express'</span> } },
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'PROCESS_PAYMENT'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">card</span>: <span class="hljs-string">'****1234'</span> } },
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'PLACE_ORDER'</span> }
    ]);
    
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">order</span>.<span class="hljs-property">status</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'CONFIRMED'</span>);
  });
});
</code></pre>
<p><strong>优势</strong>：测试覆盖率高，重构信心足。</p>
<h4 data-id="heading-9">6. <strong>强大的监控和调试能力</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InstrumentedIntentDispatcher</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">intent</span>) {
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-comment">// 记录意图开始</span>
    monitoring.<span class="hljs-title function_">recordIntentStart</span>(intent.<span class="hljs-property">type</span>, intent.<span class="hljs-property">payload</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">dispatch</span>(intent);
      
      <span class="hljs-comment">// 记录成功指标</span>
      monitoring.<span class="hljs-title function_">recordIntentSuccess</span>(intent.<span class="hljs-property">type</span>, {
        <span class="hljs-attr">duration</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime,
        <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span>
      });
      
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 记录失败详情</span>
      monitoring.<span class="hljs-title function_">recordIntentFailure</span>(intent.<span class="hljs-property">type</span>, {
        error,
        <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime
      });
      <span class="hljs-keyword">throw</span> error;
    }
  }
}

<span class="hljs-comment">// 开发时可视化意图流</span>
<span class="hljs-comment">// [用户点击] → [ADD_TO_CART意图] → [处理器执行] → [结果返回]</span>
</code></pre>
<p><strong>优势</strong>：生产环境可观测性强，开发调试直观。</p>
<h3 data-id="heading-10">四、意图系统的实战价值</h3>
<h4 data-id="heading-11">场景1：快速响应业务需求变化</h4>
<p><strong>业务需求</strong>："在用户首次加入购物车时显示欢迎弹窗"</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统方式：需要修改多个组件</span>
<span class="hljs-comment">// ProductPage.js, SearchResults.js, Recommendation.js...</span>

<span class="hljs-comment">// 意图系统：只需修改意图处理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedAddToCartHandler</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">intent, objectGraph</span>) {
    <span class="hljs-keyword">const</span> { cartService, userService, ui } = objectGraph;
    
    <span class="hljs-keyword">await</span> cartService.<span class="hljs-title function_">add</span>(intent.<span class="hljs-property">payload</span>.<span class="hljs-property">productId</span>);
    
    <span class="hljs-comment">// 新增的业务逻辑</span>
    <span class="hljs-keyword">const</span> isFirstAdd = <span class="hljs-keyword">await</span> userService.<span class="hljs-title function_">isFirstCartAdd</span>(intent.<span class="hljs-property">payload</span>.<span class="hljs-property">userId</span>);
    <span class="hljs-keyword">if</span> (isFirstAdd) {
      <span class="hljs-keyword">await</span> ui.<span class="hljs-title function_">showWelcomeDialog</span>();
    }
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
  }
}
</code></pre>
<h4 data-id="heading-12">场景2：复杂的电商业务流程</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 订单退货流程涉及多个部门和系统</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReturnIntentWorkflow</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">intent</span>) {
    <span class="hljs-comment">// 1. 验证退货资格</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'VALIDATE_RETURN_ELIGIBILITY'</span>, <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span> });
    
    <span class="hljs-comment">// 2. 生成退货标签</span>
    <span class="hljs-keyword">const</span> label = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'GENERATE_RETURN_LABEL'</span>, <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span> });
    
    <span class="hljs-comment">// 3. 安排快递取件</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SCHEDULE_PICKUP'</span>, <span class="hljs-attr">payload</span>: { ...intent.<span class="hljs-property">payload</span>, label } });
    
    <span class="hljs-comment">// 4. 处理退款</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'PROCESS_REFUND'</span>, <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span> });
    
    <span class="hljs-comment">// 5. 通知用户</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SEND_RETURN_CONFIRMATION'</span>, <span class="hljs-attr">payload</span>: intent.<span class="hljs-property">payload</span> });
  }
}
</code></pre>
<h4 data-id="heading-13">场景3：全球化电商的本地化处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同一意图在不同地区有不同实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegionalCheckoutHandler</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">intent, objectGraph</span>) {
    <span class="hljs-keyword">const</span> region = objectGraph.<span class="hljs-property">region</span>;
    
    <span class="hljs-keyword">switch</span>(region.<span class="hljs-property">country</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'US'</span>:
        <span class="hljs-comment">// 美国：信用卡支付，快速配送</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">usCheckout</span>(intent);
        
      <span class="hljs-keyword">case</span> <span class="hljs-string">'CN'</span>:
        <span class="hljs-comment">// 中国：支持支付宝/微信，身份证验证</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">chinaCheckout</span>(intent);
        
      <span class="hljs-keyword">case</span> <span class="hljs-string">'IN'</span>:
        <span class="hljs-comment">// 印度：UPI支付，货到付款选项</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">indiaCheckout</span>(intent);
        
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">defaultCheckout</span>(intent);
    }
  }
}
</code></pre>
<h3 data-id="heading-14">五、何时采用意图系统？</h3>
<h4 data-id="heading-15">适合的场景 ✅</h4>
<ul>
<li><strong>复杂交互应用</strong>：电商、金融、企业软件</li>
<li><strong>多平台产品</strong>：需要Web、App、桌面端一致体验</li>
<li><strong>频繁业务迭代</strong>：A/B测试、功能快速上线</li>
<li><strong>大规模团队协作</strong>：需要清晰的架构边界</li>
</ul>
<h4 data-id="heading-16">不适合的场景 ❌</h4>
<ul>
<li><strong>简单展示页面</strong>：博客、宣传网站</li>
<li><strong>原型验证阶段</strong>：需要快速迭代验证想法</li>
<li><strong>资源有限团队</strong>：有较高的学习和实现成本</li>
</ul>
<h4 data-id="heading-17">迁移策略建议</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 渐进式迁移：从最复杂的业务开始</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacySystemAdapter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">migrateGradually</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 阶段1：新功能使用意图系统</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerNewFeatureIntents</span>();
    
    <span class="hljs-comment">// 阶段2：重构复杂业务逻辑</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refactorCheckoutToIntents</span>();
    
    <span class="hljs-comment">// 阶段3：逐步迁移其他功能</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">migrateRemainingFeatures</span>();
    
    <span class="hljs-comment">// 阶段4：完全转向意图架构</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decommissionLegacyCode</span>();
  }
}
</code></pre>
<h3 data-id="heading-18">六、意图系统的未来演进</h3>
<p>随着前端复杂度的持续增长，意图系统正在向更智能的方向发展：</p>
<h4 data-id="heading-19">1. <strong>AI驱动的意图预测</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI预测用户下一步意图</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PredictiveIntentSystem</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">predictNextIntent</span>(<span class="hljs-params">userBehavior</span>) {
    <span class="hljs-keyword">const</span> prediction = <span class="hljs-keyword">await</span> aiModel.<span class="hljs-title function_">predict</span>(userBehavior);
    
    <span class="hljs-comment">// 预加载可能需要的资源</span>
    <span class="hljs-keyword">if</span> (prediction.<span class="hljs-property">confidence</span> &gt; <span class="hljs-number">0.8</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">prefetchIntentResources</span>(prediction.<span class="hljs-property">intent</span>);
    }
    
    <span class="hljs-keyword">return</span> prediction;
  }
}
</code></pre>
<h4 data-id="heading-20">2. <strong>可视化意图编排</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 低代码平台上的意图编排</span>
<span class="hljs-keyword">const</span> workflow = visualEditor.<span class="hljs-title function_">createWorkflow</span>([
  { <span class="hljs-attr">intent</span>: <span class="hljs-string">'VIEW_PRODUCT'</span>, <span class="hljs-attr">onSuccess</span>: <span class="hljs-string">'showDetails'</span> },
  { <span class="hljs-attr">intent</span>: <span class="hljs-string">'ADD_TO_CART'</span>, <span class="hljs-attr">onSuccess</span>: <span class="hljs-string">'updateCart'</span> },
  { <span class="hljs-attr">intent</span>: <span class="hljs-string">'START_CHECKOUT'</span>, <span class="hljs-attr">conditions</span>: [<span class="hljs-string">'cartNotEmpty'</span>] }
]);

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">const</span> generatedCode = workflow.<span class="hljs-title function_">generateIntentHandlers</span>();
</code></pre>
<h4 data-id="heading-21">3. <strong>意图级别的性能优化</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 意图优先级调度</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityIntentDispatcher</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">intent</span>) {
    <span class="hljs-keyword">const</span> priority = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getIntentPriority</span>(intent.<span class="hljs-property">type</span>);
    
    <span class="hljs-comment">// 高优先级意图立即执行</span>
    <span class="hljs-keyword">if</span> (priority === <span class="hljs-string">'HIGH'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeImmediately</span>(intent);
    }
    
    <span class="hljs-comment">// 低优先级意图批量执行</span>
    <span class="hljs-keyword">if</span> (priority === <span class="hljs-string">'LOW'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">batchExecute</span>(intent);
    }
  }
}
</code></pre>
<h3 data-id="heading-22">七、结语</h3>
<p>xxx Jet 框架选择意图系统不是偶然，而是面对<strong>电商业务复杂度</strong>的必然选择。当你的应用开始出现以下症状时，就是考虑意图架构的时候了：</p>
<ol>
<li><strong>新增功能需要修改多个文件</strong></li>
<li><strong>业务逻辑难以测试</strong></li>
<li><strong>UI组件变得臃肿</strong></li>
<li><strong>跨平台逻辑不一致</strong></li>
<li><strong>难以添加A/B测试</strong></li>
</ol>
<p>意图系统不仅仅是技术架构的选择，更是一种<strong>开发哲学的转变</strong>——从关注"如何实现"转向关注"用户想要什么"。这种转变让我们能够构建更<strong>健壮</strong>、更<strong>可维护</strong>、更<strong>用户为中心</strong>的前端应用。</p>
<p>在日益复杂的前端生态中，意图系统为我们提供了一条清晰的路径：<strong>通过抽象化用户意图，实现业务逻辑与UI的彻底解耦</strong>，从而在快速变化的需求面前保持架构的稳定性和扩展性。</p>
<p><strong>最好的架构不是最复杂的，而是最能适应变化的</strong>。意图系统正是这种适应性的体现——它让我们的前端架构能够像业务一样灵活演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？]]></title>    <link>https://juejin.cn/post/7582104240986963994</link>    <guid>https://juejin.cn/post/7582104240986963994</guid>    <pubDate>2025-12-11T01:09:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582104240986963994" data-draft-id="7582090790182027302" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-11T01:09:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我为什么放弃了XMind和亿图，投向了这款开源绘图工具的怀抱？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:09:39.000Z" title="Thu Dec 11 2025 01:09:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<h2 data-id="heading-0">01 引言</h2>
<p>思维导图、流程图应该是每个程序员都会用到的绘图工具。<code>Xmind</code>和亿图曾是我的首选工具，但是免费版功能受限，高级功能需付费，用起来总是差点意思。虽然通过其他方式正常使用（大家都懂得），但是软件的更新根本不敢动，一旦更新就会前功尽弃......而且两款工具总会来回切换，虽已习惯，但稍显麻烦！</p>
<p>直到不久前逛<code>GitHub</code>发现了一款开源的且可以在线使用的工具：<code>Drawnix</code>。界面简约，满足日常基本绘图需求，且支持 <code>mermaid</code> 语法转流程图等，用起来非常丝滑。整理一下分享给大家！</p>
<h2 data-id="heading-1">02 简介</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aded8cfebf8a44ec9b91ac8ec9521a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=NcpQeHkSVtB6dxcGrOsSeo7vWtY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 名称的由来</h3>
<p><code>Drawnix</code> ，源于绘画( <code>Draw</code>)与凤凰( <code>Phoenix</code> )的灵感交织。凤凰象征着生生不息的创造力，而 <code>Draw</code>代表着人类最原始的表达方式。在这里，每一次创作都是一次艺术的涅槃，每一笔绘画都是灵感的重生。</p>
<p>创意如同凤凰，浴火方能重生，而 <code>Drawnix</code> 要做技术与创意之火的守护者。</p>
<h3 data-id="heading-3">2.2 框架</h3>
<p><code>Drawnix</code> 的定位是一个开箱即用、开源、免费的工具产品，它的底层是 <code>Plait</code>框架，<code>Plait</code> 是作者公司开源的一款画图框架，代表着公司在知识库产品上的重要技术沉淀。</p>
<p><code>Drawnix</code> 是插件架构，与前面说到开源工具比技术架构更复杂一些，但是插件架构也有优势，比如能够支持多种 <code>UI</code> 框架（<code>Angular</code>、<code>React</code>），能够集成不同富文本框架（当前仅支持 <code>Slate</code>框架），在开发上可以很好的实现业务的分层，开发各种细粒度的可复用插件，可以扩展更多的画板的应用场景。</p>
<p><code>GitHub</code>地址：</p>
<h3 data-id="heading-4">2.3 特性</h3>
<ul>
<li>💯 免费 + 开源</li>
<li>⚒️ 思维导图、流程图</li>
<li>🖌 画笔</li>
<li>😀 插入图片</li>
<li>🚀 基于插件机制</li>
<li>🖼️ 📃 导出为 PNG, JSON(<code>.drawnix</code>)</li>
<li>💾 自动保存（浏览器缓存）</li>
<li>⚡ 编辑特性：撤销、重做、复制、粘贴等</li>
<li>🌌 无限画布：缩放、滚动</li>
<li>🎨 主题模式</li>
<li>📱 移动设备适配</li>
<li>📈 支持 mermaid 语法转流程图</li>
<li>✨ 支持 markdown 文本转思维导图（新支持 🔥🔥🔥）</li>
</ul>
<h3 data-id="heading-5">2.4 安装</h3>
<p>提供<code>Docker</code>部署：</p>
<pre><code class="hljs language-sh" lang="sh">docker pull pubuzhixing/drawnix:latest
</code></pre>
<p>也可以在线使用：</p>
<p>地址：</p>
<h2 data-id="heading-6">03 最佳实践</h2>
<p>实践我们采用在线方式，如果注重安全或者本地使用可以使用<code>Docker</code>部署。</p>
<h3 data-id="heading-7">3.1 界面说明</h3>
<p>通过<code>https://drawnix.com/</code>进入之后，所有功能如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1050e9bc264de3b953043d5d33b19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=wSlN%2Bab1vWJtIehD7RrD3%2F64YBA%3D" alt="" loading="lazy"/></p>
<p>中间工具栏分别表示：</p>
<ul>
<li>拖拽</li>
<li>选中</li>
<li>思维导图</li>
<li>文字</li>
<li>手绘</li>
<li>箭头</li>
<li>流程图</li>
<li>插入图片</li>
<li>格式转换</li>
</ul>
<p>功能都比较简单，思维导图、流程图以及格式转化是常用的工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17d70fca32644037a52d5b30600c76d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=rPCwuGYDZ0OtICIaWme7hN8CUrE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 思维导图</h3>
<p>思维导图的使用方式和<code>Xmind</code>的用法极为相似。选中节点，然后<code>Tab</code>键就可以添加同级子节点，也可以利用<code>+</code>号添加。<code>-</code>号并不是删除，而是合并。删除也非常简单，选中直接<code>Delete</code>即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/253053338d2e4fad9b280bbd1abdd554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=29EXmJucrIPvcGoTl6actyUkNhE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.3 流程图</h3>
<p>流程图的图形相对来说比较简单，只有七项。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2324740772ea409f98298583d7bd5115~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=gZmqMXebA63ivy6m8RC07wMMizg%3D" alt="" loading="lazy"/></p>
<p>选中之后直接绘制即可，图形之间使用箭头链接即可。</p>
<h3 data-id="heading-10">3.4 格式转化</h3>
<p>目前支持两种格式转化成流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35787be17174e36b5f939f55898cd0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=OKi2U0L%2Bmo%2Bk5stpOPLMTEv7YdI%3D" alt="" loading="lazy"/></p>
<p><strong>Mermaid</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/348d3bc49d6e4c3ab89f69db4c71c5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=aB%2F1hlGPV4%2F3BRkQBtAKBM90bio%3D" alt="" loading="lazy"/></p>
<p>仅支持流程图、序列图和类图</p>
<p><strong>Markdown</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e135f734d244b1b8688f27082a54efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020178&amp;x-signature=s3Sxc7cdzoDgTOii7GSOgJL0rC0%3D" alt="" loading="lazy"/></p>
<p>仅支持思维导图。</p>
<h2 data-id="heading-11">04 小结</h2>
<p><code>Drawnix</code>的极简设计满足日常绘图的需要，可能在很多功能上不如<code>Xmind</code>或者亿图，但是它确实两者的结合。是一款不错的绘图软件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新！量子位智库重磅发布《2025年度AI十大趋势报告》：中国从参与者变领导者]]></title>    <link>https://juejin.cn/post/7582131164727541800</link>    <guid>https://juejin.cn/post/7582131164727541800</guid>    <pubDate>2025-12-11T01:09:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164727541800" data-draft-id="7582044568721834024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新！量子位智库重磅发布《2025年度AI十大趋势报告》：中国从参与者变领导者"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-11T01:09:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青梅主码"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825604222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新！量子位智库重磅发布《2025年度AI十大趋势报告》：中国从参与者变领导者
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825604222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青梅主码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:09:56.000Z" title="Thu Dec 11 2025 01:09:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好，我是<strong>杰哥</strong>。</p>
<p>就在昨天，量子位智库最新发布了《<strong>2025年度AI十大趋势报告</strong>》报告。这份报告基于全球<strong>AI</strong> 技术前沿动态，梳理出 <strong>2025</strong> 年将深刻影响产业和社会的十大关键趋势。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e0d865c9ce411b8cbc5ef167fcd169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=bmzF%2BOp1O2%2FLw3dMtekmW9afeXw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29e83fe1f1ab4c75b3d3f3e3f4cdf479~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=GwtBkWzzvyRQsBaMvJClFqylKlc%3D" alt="" loading="lazy"/></p>
<p>报告从四个维度展开：<strong>基础设施、模型进化、应用版图和中国时间</strong>。</p>
<h2 data-id="heading-0">第一部分：基础设施——算力成“新石油”</h2>
<p><strong>AI</strong>的飞跃离不开底层支撑。报告指出，“有限算力”已成为全球战略瓶颈，这直接催生了基础设施的巨变。</p>
<h4 data-id="heading-1">趋势1：算力基建化——数据中心需求狂飙，算力经济是智能产业第一大引擎</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc6598c23677460eae7276bf9fb1973d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=rZT2W237kqzNxxNKvDy3BeNyRI4%3D" alt="" loading="lazy"/></p>
<p><strong>AI</strong>训练像炼钢一样，需要海量“电力”——这就是算力。<strong>2025年</strong>，全球超大规模数据中心将迎来建设浪潮。像<strong>Stargate</strong>星际之门计划（投资超 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mtext>亿</mtext><mo>∗</mo><mo>∗</mo><mtext>），由</mtext><mo>∗</mo><mo>∗</mo><mi>O</mi><mi>p</mi><mi>e</mi><mi>n</mi><mi>A</mi><mi>I</mi><mo>∗</mo><mo>∗</mo><mtext>与</mtext><mo>∗</mo><mo>∗</mo><mi>O</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>l</mi><mi>e</mi><mo>∗</mo><mo>∗</mo><mtext>、</mtext><mo>∗</mo><mo>∗</mo><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>B</mi><mi>a</mi><mi>n</mi><mi>k</mi><mo>∗</mo><mo>∗</mo><mtext>合作，就是典型代表。</mtext><mo>∗</mo><mo>∗</mo><mi>G</mi><mi>o</mi><mi>o</mi><mi>g</mi><mi>l</mi><mi>e</mi><mo>∗</mo><mo>∗</mo><mtext>的</mtext><mo>∗</mo><mo>∗</mo><mi>A</mi><mi>I</mi><mo>∗</mo><mo>∗</mo><mtext>枢纽投</mtext><mo>∗</mo><mo>∗</mo></mrow><annotation encoding="application/x-tex">1000亿**），由**OpenAI**与**Oracle**、**SoftBank**合作，就是典型代表。**Google**的**AI**枢纽投 **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">1000</span><span class="mord cjk_fallback">亿</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">），由</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">∗</span><span class="mord mathnormal">Op</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">与</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">、</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.05017em;">tB</span><span class="mord mathnormal" style="margin-right:0.03148em;">ank</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">合作，就是典型代表。</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">∗</span><span class="mord mathnormal">G</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">的</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">枢纽投</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4653em;"/><span class="mord">∗</span></span></span></span></span>400亿</strong>，<strong>Microsoft</strong>的<strong>AI</strong>超级园区 <strong>$73亿</strong>，这些项目不只建服务器房，更是“算力工厂”。</p>
<p>全球资本开支高达 <strong>2980亿美元</strong>，云计算巨头如<strong>AWS</strong>（<strong>€78亿</strong>在德国）、<strong>Google</strong>（<strong>€10亿+</strong>）正倾斜资金向<strong>AI</strong>专用算力。欧洲、中东、东南亚等地争相布局，主权云和清洁能源成热点。比如，沙特<strong>AWS</strong>云区域投 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>53</mn><mtext>亿</mtext><mo>∗</mo><mo>∗</mo><mtext>，肯尼亚</mtext><mo>∗</mo><mo>∗</mo><mi>M</mi><mi>i</mi><mi>c</mi><mi>r</mi><mi>o</mi><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mo>∗</mo><mo>∗</mo><mtext>地热中心</mtext><mo>∗</mo><mo>∗</mo></mrow><annotation encoding="application/x-tex">53亿**，肯尼亚**Microsoft**地热中心 **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">53</span><span class="mord cjk_fallback">亿</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">，肯尼亚</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">i</span><span class="mord mathnormal">croso</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">地热中心</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4653em;"/><span class="mord">∗</span></span></span></span></span>10亿</strong>。</p>
<p>在中国，“东数西算”工程加速，构建全国一体化算力网络。超节点和超级群让数万块<strong>GPU</strong>集群高效运转，甚至太空计算方案如“天算星座”计划2027年部署百星级、百<strong>TOPS</strong>级超算。这股算力浪潮，不仅支撑<strong>AI</strong>商用渗透，还像电力网一样，成为生活必需。</p>
<h4 data-id="heading-2">趋势2：芯片AI化——AI原生需求重塑芯片创新，大市场大生态打开时代芯机遇</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/357fb3c8c5e2437b982896a4e663e338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=uongKQsazcgcEjEar8AAlQP0HWk%3D" alt="" loading="lazy"/></p>
<p>芯片从“通用”变“<strong>AI</strong>原生”，<strong>GPU</strong>仍是王者，但稀缺和高价逼出新玩法。<strong>NVIDIA</strong>统治训练市场，但<strong>CPU</strong>角色转向辅助<strong>AI</strong>任务，集成加速指令集。端侧<strong>NPU</strong>（神经处理单元）成标配，手机、<strong>PC</strong>、物联网设备低功耗推理全靠它。<strong>ASIC</strong>/<strong>FPGA</strong>定制芯片也爆发，满足特定场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849e549e08e245969367660fc47f6cd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=kN9ZGGofgQudJvoV1Gt2nbV%2FI5o%3D" alt="" loading="lazy"/></p>
<p>全球<strong>AI</strong>芯片市场2025年预测值亮眼，中国市场国产替代加速。国产模型+芯片+<strong>SDK</strong>首次验证千亿参数训练，摆脱<strong>CUDA</strong>依赖。<strong>DeepSeek</strong>优化华为<strong>Ascend</strong>芯片，确保高效运行。这波变革，让芯片创新从“跟跑”到“领跑”，大生态打开无限机遇。</p>
<h2 data-id="heading-3">第二部分：模型进化——从规模到效率的平衡赛跑</h2>
<p>模型不是越大越好，而是聪明才行。算力制约下，创新聚焦效率和实用。</p>
<h4 data-id="heading-4">趋势3：预训练决定大模型格局梯队，架构创新决定预训练水平</h4>
<p>预训练是<strong>AI</strong>“上课”阶段，决定谁进梯队。超越<strong>Transformer</strong>架构是关键，线性注意力和稀疏注意力降复杂度到<strong>O(n)</strong>，高效处理长上下文。<strong>MoE</strong>（混合专家模型）成主流：“大参数，小激活”，如总参数<strong>1万亿</strong>的<strong>Kimi K2 Thinking</strong>，专注复杂推理。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5784cae410945d4b93a532f6d2432ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=DEBiJof9DpvaZGCEik2qcc1hHx4%3D" alt="" loading="lazy"/></p>
<p>中国玩家强势：<strong>Qwen3</strong>（<strong>235B</strong>总参数，<strong>22B</strong>激活，支持119种语言）、<strong>ERNIE 5.0</strong>（<strong>2.4T</strong>参数，全模态）、<strong>DeepSeek-V3</strong>（<strong>671B</strong>，14.8T token预训练）。蒸馏小模型和<strong>RLHF</strong>（人类反馈强化学习）让大模型“瘦身”到边缘设备，还融入人类偏好，减少幻觉。</p>
<h4 data-id="heading-5">趋势4：大模型落地进入推理时间，推理需求倒逼模型创新</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5145ffdee1e84df4a7227d1a169e5e50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=P7jPx0wtP4bJ5HQO%2BNbGTng1wVM%3D" alt="" loading="lazy"/></p>
<p>训练后是“实战”——推理阶段。2025年，多模态深度推理、自适应推理和增量学习成焦点。<strong>MoE</strong>专家数量激增（如<strong>Qwen3-Next</strong>），<strong>OCR</strong>用少量token表征文本，隐式推理让模型“内部思考”。硬件异构协同和边缘加速，确保低延迟。<strong>Agent</strong>时代，任务复杂度飙升，推理框架进化成刚需。</p>
<h4 data-id="heading-6">趋势5：信息AI应用期，物理AI研发期，具身智能成合流风口</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/286bc8a3712a4789b28a44a11e8c1a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=iDxpmBnJLdif0Bd8aLeOdFNFtO4%3D" alt="" loading="lazy"/></p>
<p><strong>AI</strong>分两路：信息<strong>AI</strong>已落地（如聊天机器人），物理<strong>AI</strong>正研发，理解重力、摩擦等物理规律。世界模型模拟真实世界，<strong>VLA</strong>（视觉-语言-动作）统一框架让机器人“听指令动起来”。开源如<strong>OpenVLA</strong>和<strong>Unitree RL Gym</strong>加速具身智能，从工业到家庭，人形机器人订单初现。数据集开源推动产学研共创，挑战如续航和成本正被攻克。</p>
<h2 data-id="heading-7">第三部分：应用版图——从虚拟到现实的全面渗透</h2>
<p><strong>AI</strong>不再是工具，而是生活方式。应用从数字扩展到物理，重塑流量和生产力。</p>
<h4 data-id="heading-8">趋势6：AI重塑流量入口——PC互联网、移动互联网、Agentic互联网</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e553745e2c3e40939c1d31b7ad819fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=dEfiB8yv%2BspyAXTVIRg4XPF3PR0%3D" alt="" loading="lazy"/></p>
<p><strong>Agent</strong>是下一个范式，能感知-规划-执行闭环。核心是推理能力，分解复杂任务。开发门槛降了，<strong>AI</strong>编码生成代码，框架如<strong>LangGraph</strong>（状态工作流）和<strong>AutoGen</strong>（对话驱动）让构建<strong>Agent</strong>如搭积木。流量从“人找服务”变“服务找人”，对话即入口，操作系统或成超级<strong>Agent</strong>。2025年，专业<strong>Agent</strong>将取代部分<strong>App</strong>。</p>
<h4 data-id="heading-9">趋势7：多模态成AI应用落地关键——视频、3D、代码依次展现生产力</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88538de2a33245d6b43ad59905cf4284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=76aCa2%2Fuy%2FfKjmThzDfGmwx6zwY%3D" alt="" loading="lazy"/></p>
<p>多模态融合文本、图像、视频成标配。视频生成分通用（如<strong>Sora2</strong>）和垂直（如影视预览），提升分辨率和逻辑连贯。<strong>3D</strong>生成重塑工作流，从文本到模型一次性搞定，助力游戏、元宇宙。代码生成跨门槛，<strong>Vibe Coding</strong>用自然语言描述意图，<strong>AI</strong>建项目。多模态让开发者从琐事解放，专注价值创造——从“降本”到“升维”。</p>
<h4 data-id="heading-10">趋势8：AI硬件百端齐放——PC手机汽车眼镜玩具，焕脑正当时</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/811ca3220ce544759dc917601bd8a0c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=t9SLlbcrdOu0qq3%2Fnjpp9z9Il5w%3D" alt="" loading="lazy"/></p>
<p>端侧<strong>AI</strong>生态爆发。<strong>AI PC</strong>密集发布，内置<strong>NPU</strong>处理器如<strong>Intel</strong>、<strong>AMD</strong>，本地运行无需云端。手机集成照片分类、实时翻译；可穿戴如<strong>AI</strong>眼镜实时识物；玩具变智能伙伴，对话教育。优势？低延迟、高隐私。软硬件协同，构建“第二大脑”。</p>
<h4 data-id="heading-11">趋势9：AI4S 突破加速 AGI 实现——AI 数理化触及博士水平</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b0bdbac16e34cde862ada445efa1226~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=tCmvjL3Uk2R8MqHKLA%2FGsXaLwkg%3D" alt="" loading="lazy"/></p>
<p><strong>AI for Science</strong>（<strong>AI4S</strong>）重塑科研全流程。医疗如<strong>GRAPE</strong>模型识胃癌敏感性<strong>85.1%</strong>，<strong>DeepGEM</strong>预测肺癌基因<strong>78%-99%<strong>精准。材料科学发现高熵合金催化剂性能升</strong>9.3倍</strong>，<strong>ChemAgents</strong>自主合成量子点。<strong>Agentic Science</strong>让<strong>AI</strong>成“化学家”，加速<strong>AGI</strong>，触及博士级数理化能力。</p>
<h2 data-id="heading-12">第四部分：中国时间——开源领跑，AGI中国路线</h2>
<h4 data-id="heading-13">趋势10：开源AI进入中国时间——AGI拥有中国路线</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32c1901873584d3dbd6d79f0eb89fec6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=uhlwBB5UAclH3WfExlN6eU%2F5hQs%3D" alt="" loading="lazy"/></p>
<p>中国从参与者变领导者。企业转型研发，<strong>Huawei</strong>、<strong>Alibaba</strong>等巨资芯片和模型。<strong>AGI</strong>升国家战略，到2025年总算力超<strong>300 EFLOPS</strong>，智能占比<strong>35%</strong>。开源生态火热：<strong>Hugging Face</strong>下载前50，<strong>BAAI</strong>（智源）<strong>7.90亿次</strong>、<strong>Alibaba</strong> <strong>7.49亿次</strong>领跑。<strong>DeepSeek</strong>超<strong>1亿</strong>用户，<strong>Qwen</strong>成基座模型。国际合作下，中国建<strong>AI</strong>治理枢纽。</p>
<p>代表案例如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798f0c054c3d4045a897944d0c75600a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020196&amp;x-signature=lhthtlvnet%2Bw2bnmajklQMT%2BCAg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">最后</h2>
<p>关注公众号【AI信息风向】，回复 666，即可获取更多 AI 行业报告。</p>
<p>AI 技术正以前所未有的速度发展，它将如何塑造我们的未来？让我们拭目以待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP A2A Skills 这三个词搞懂了 再去写你的智能体]]></title>    <link>https://juejin.cn/post/7582131164727689256</link>    <guid>https://juejin.cn/post/7582131164727689256</guid>    <pubDate>2025-12-11T01:22:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164727689256" data-draft-id="7582133314685861940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP A2A Skills 这三个词搞懂了 再去写你的智能体"/> <meta itemprop="keywords" content="后端,前端,架构"/> <meta itemprop="datePublished" content="2025-12-11T01:22:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老码小张"/> <meta itemprop="url" content="https://juejin.cn/user/976022052799405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP A2A Skills 这三个词搞懂了 再去写你的智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022052799405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老码小张
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:22:40.000Z" title="Thu Dec 11 2025 01:22:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b07d627b0b8471cacaa874c1d9f1179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020959&amp;x-signature=hnkb9o2kp5J5AEDMHPNeQDiH59E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">一 先别急着造“自己的 Agent 平台”</h3>
<p>这两年身边做平台的朋友，基本都踩过同一个坑。<br/>
上来就想做一整套“万能智能体平台”：沙箱、工具管理、工作流、知识库、观测，一口气全包。</p>
<p>结果半年过去，业务一个没落地，基础设施先把自己卷趴下。</p>
<p>冷静一点看，现在行业趋势已经很清楚了：</p>
<ul>
<li>工具接入这块，有了 MCP 在快速统一，主流厂商都在往这个标准靠。</li>
<li>智能体互联这块，大家在围绕 A2A 把它当“Agent 版 HTTP”来建设。</li>
<li>能力建模这块，大模型厂在推自己的 Skills 模型，把“技能”做成可配置、可组合、可下发的能力包，而不是散乱的插件。</li>
</ul>
<p>所以，如果你还在纠结“要不要自研个大而全的 Agent 平台”，很大概率是在和产业方向硬刚。<br/>
更现实的做法，反而是：承认外面已经有标准，把自己收缩成——<strong>接 MCP、接 A2A、管理 Skills 的那层“配置和场景中台”</strong>。</p>
<p>这是背景。下面拆开讲。</p>
<hr/>
<h3 data-id="heading-1">二 MCP：别再一套套写 SDK 了 ，这么干太累</h3>
<p>如果你这两年写过“给大模型接工具”的代码，大概经历过这几步：<br/>
HTTP API 一套；Shell 命令一套；公司内部 RPC 再一套。<br/>
每换一个模型厂商，再配一遍“工具定义格式”和“结果解析逻辑”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aacbb12f36c44148d953824bf4d6051~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020959&amp;x-signature=7k9jSjvbv8njQ%2FpifRi3QLGrBxg%3D" alt="" loading="lazy"/></p>
<p>MCP 出来的目的就很直接：</p>
<ul>
<li>把“模型 ↔ 外部世界”这条链路抽象成统一协议，模型叫的是 MCP 客户端，外部系统是 MCP 服务器，中间走一套标准化消息和生命周期。</li>
<li>你写一个 MCP server，把你家的数据库、文件系统、业务 API 暴露成工具；任何支持 MCP 的客户端（桌面助手、在线 IDE、内部 Agent SDK）都能无感接入。</li>
</ul>
<p>近一年的几个变化，其实挺关键：</p>
<ul>
<li>规范把安全当成一等公民，默认 MCP server 是敏感资源，必须配好鉴权、作用域，避免被恶意 server 趁机拿走更多权限。</li>
<li>主流厂商陆续站队：大模型服务、操作系统、浏览器插件都在原生支持 MCP，让“接一次、到处用”变得现实。</li>
</ul>
<p>这意味着什么？<br/>
意味着你完全可以这么干：</p>
<ul>
<li>公司内部只维护一小撮 MCP Server：比如“文档中心 server”“监控 server”“工单 server”。</li>
<li>不管你用哪家模型、哪个 Agent 框架，只要会讲 MCP，就都能复用这几个 server，不用重写工具层。</li>
</ul>
<p>从工程角度看，MCP 把以前零散的 SDK，收敛成一个**“工具总线”**。<br/>
你不用给每个模型、每个产品线都造一堆重复工具，只要把“总线”接好。</p>
<hr/>
<h3 data-id="heading-2">三 Skills：别再把“工具”和“能力”混在一起  ，讲真这么做太复杂了</h3>
<p>很多团队现在的 Agent 设计，有个很明显的问题：<br/>
所有能力都被塞成“一个个 tool”。</p>
<p>结果是什么？</p>
<ul>
<li>模型会了一堆低层 API，却没有“怎么用这些 API 解一个业务问题”的套路。</li>
<li>提示词越写越长，系统 prompt 变成垃圾场，既讲“角色”，又讲“策略”，还顺带贴一堆接口文档。</li>
</ul>
<p>最近，各家在往一个方向收敛：<br/>
把“工具”和“技能”拆开。</p>
<ul>
<li>工具更像“手”：能读写数据库、调 HTTP、跑脚本，是具体动作。</li>
<li>技能更像“脑子里的一套打法”：比如“审阅合同”“排查线上事故”“做一个发布计划”，强调的是流程、判断标准、风险边界。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55b8af55758f48e98db6cfeff8e2189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020959&amp;x-signature=nV%2Fy9IFFuu3naCA%2BzWnCQzFN0SM%3D" alt="当然不仅仅是 Claude，很多厂商也陆续跟进" loading="lazy"/></p>
<p>有的厂商已经把这一套产品化成 Agent Skills：</p>
<ul>
<li>每个 Skill 是一个可复用的能力包，里面有：细粒度指令、元数据、可选的脚本或资源、能力边界说明。</li>
<li>一个 Agent 可以绑定多种 Skill，再按场景激活，而不是每次都从零开脑洞。</li>
</ul>
<p>对要做“数字分身”或者内部助手的团队来说，这个理念很关键：<br/>
你要管理的，应该是“某个分身有哪几种技能”，而不是“暴露了多少个 tool”。</p>
<p>落到实现上，可以这么拆：</p>
<ul>
<li>把“排查线上告警”写成一个 Skill：
<ul>
<li>输入是什么（告警 ID、时间范围）。</li>
<li>Agent 应该走哪几步（查监控、查最近变更、查工单、输出推理链）。</li>
<li>哪些工具可用，哪些动作必须二次确认。</li>
</ul>
</li>
<li>把“写周报”写成另一个 Skill：
<ul>
<li>允许访问哪些日志、哪些项目数据。</li>
<li>输出结构、语气有什么约束。</li>
</ul>
</li>
</ul>
<p>当你有了几十个 Skill，再往上做“数字分身配置中心”：<br/>
勾选一下“这个分身具备 A、B、C 三种技能”，就远比裸配一堆 tool 来得稳。</p>
<hr/>
<h3 data-id="heading-3">四 A2A：当 Agent 不再孤立</h3>
<p>如果说 MCP 管的是“Agent 怎么伸手碰世界”，那 A2A 管的就是“Agent 怎么互相说话”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05657679cd424cad9db7f2f9b08b63b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020959&amp;x-signature=Nxg0WM%2BB4Oma97cKjgKWTuADSOA%3D" alt="" loading="lazy"/></p>
<p>以前做多智能体，大部分人都是在自己系统里硬写：</p>
<ul>
<li>一个大 orchestrator，里面 if-else 切换不同子 Agent。</li>
<li>进度、状态、上下文靠自定义结构体在内部传。</li>
</ul>
<p>这种写法有两个问题：</p>
<ul>
<li>你的 Agent 只能活在自己系统里，没法和别人的 Agent 协作。</li>
<li>同一家公司不同团队写的 Agent，根本互不认识，各玩各的。</li>
</ul>
<p>A2A 的目标就一句话：<br/>
<strong>给 Agent 之间的通信，补一个“HTTP 级别”的通用协议。</strong></p>
<p>大概长这样：</p>
<ul>
<li>传输层走标准的 JSON-RPC over HTTP，消息格式、错误处理都被写死，减少各家自创方言。</li>
<li>每个 Agent 用一张“Agent Card”描述自己：能做什么、提供哪些方法、需要什么鉴权，由此实现自动发现和能力宣告。</li>
<li>支持同步、流式、异步推送，适合长任务、协同任务，人可以随时插进来当“环节里的一个参与者”。</li>
<li>安全上，沿用成熟的 OAuth2、Token、网关体系，企业侧更好接进现有审计和风控。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/706c86370af34ba9a71961e223db94ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766020959&amp;x-signature=XOGizAD1JCnjUIl3gp4mpvqNlWE%3D" alt="A2A 和 MCP 是互补，不是替代" loading="lazy"/></p>
<p>你可以想象一下公司的未来形态：</p>
<ul>
<li>财务有一套报销 Agent，运维有一套排障 Agent，HR 有一套招聘 Agent。</li>
<li>某个“数字分身”接到任务时，并不需要自己什么都懂，而是通过 A2A 去问别的 Agent：比如让“报销 Agent”去算预算，让“排障 Agent”去查服务。</li>
</ul>
<p>从此，智能体不再是一个个孤岛，而是一个<strong>松耦合的服务网</strong>。<br/>
而 A2A 就是这个网的“通用语”。</p>
<hr/>
<h3 data-id="heading-4">五 真正落地时，可以怎么选型</h3>
<p>说这么多，落成代码其实可以很克制。<br/>
给你一个比较现实、适合中型团队的路线：</p>
<ol>
<li>
<p><strong>先把“工具总线”站起来：选 MCP，不要自造协议。</strong></p>
<ul>
<li>把最常用的三个系统接成 MCP Server：知识库、监控、工单。</li>
<li>内部任何 Agent、助手、插件，不管哪个模型，都统一走 MCP 访问这些资源。</li>
</ul>
</li>
<li>
<p><strong>在你们现有的 Agent / 数字分身平台里，引入 Skills 概念。</strong></p>
<ul>
<li>把现在写在 prompt 里的“套路”抽出来，做成可配置的技能：有名字、有用途、有输入输出约束。</li>
<li>给每个业务场景定义一个“分身配置”：绑定模型、绑定技能、绑定可用工具（通过 MCP）。</li>
</ul>
</li>
<li>
<p><strong>等到业务线里真的出现“多智能体协作”需求，再上 A2A。</strong></p>
<ul>
<li>先挑一件事，比如“从监控到工单再到通知”，拆成三个 Agent，用 A2A 接起来，而不是在一个服务里写死整个流程。</li>
<li>把每个 Agent 的能力写清楚，用 Agent Card 对外暴露，这一步做得好，将来不同团队、不同语言写的 Agent 也能互通。</li>
</ul>
</li>
<li>
<p><strong>整个过程中，克制住“做平台”的冲动。</strong></p>
<ul>
<li>你更像是在搭一个“Agent 配置与治理层”：
<ul>
<li>管 MCP server 的接入和权限。</li>
<li>管 Skills 的版本、灰度和组合。</li>
<li>管哪些 Agent 对外暴露 A2A 能力。</li>
</ul>
</li>
<li>运行时、沙箱、多模型路由这些，能用云厂商或现成框架就用，不要轻易 All in 自研。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-5">六 写在最后</h3>
<p>MCP、Skills、A2A 听起来都挺唬人的，实际上做的事很朴素：</p>
<ul>
<li>MCP 让你少写几套“接工具的胶水代码”。</li>
<li>Skills 让你把“会做事”这件事模块化，别把全部业务逻辑塞进一条 prompt。</li>
<li>A2A 让不同 Agent 之间有话可聊，不至于每个团队都重新发明一遍“内部调用协议”。</li>
</ul>
<p>你真正在项目里要做的，是用这三个方向，帮自己把边界划清楚：<br/>
哪些是要交给行业标准和厂商生态去扛的，<br/>
哪些是你们团队必须吃透、沉淀成自己的“能力资产”的。</p>
<p>搞清楚这一点之后，再回头看市面上一堆“某某 Agent 平台”“某某智能体框架”，心态会平稳很多。<br/>
你会发现，能决定你走多远的，从来不是你选了哪个框架，而是你有没有认真回答一个问题：</p>
<p>——在这个新一轮基础设施洗牌里，你是要当“造轮子的人”，还是那个真正把轮子装到车上的人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[南京理工大学联手百度、商汤科技等团队推出Artemis：用结构化视觉推理革新多模态感知]]></title>    <link>https://juejin.cn/post/7582096212662730752</link>    <guid>https://juejin.cn/post/7582096212662730752</guid>    <pubDate>2025-12-11T01:37:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582096212662730752" data-draft-id="7582114266075070479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="南京理工大学联手百度、商汤科技等团队推出Artemis：用结构化视觉推理革新多模态感知"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-11T01:37:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            南京理工大学联手百度、商汤科技等团队推出Artemis：用结构化视觉推理革新多模态感知
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T01:37:27.000Z" title="Thu Dec 11 2025 01:37:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近年来，大语言模型（LLM）在推理能力上突飞猛进，特别是通过强化学习（RL）激发的“思维链”（Chain of Thought）技术，使模型能够进行多步推理以解决复杂问题。受此启发，研究人员尝试将这种语言推理范式引入多模态大模型（MLLM）的视觉感知任务中。然而，实证研究表明，简单的语言中间推理往往会导致感知性能下降，甚至产生与图像内容无关的“幻觉”。</p>
<p>为什么会出现这种现象？来自南京理工大学、新加坡科技设计大学、阿德莱德大学、百度、Data61-CSIRO以及商汤科技的研究团队在最新论文《Artemis: Structured Visual Reasoning for Perception Policy Learning》中给出了深刻的见解。<strong>核心问题不在于“推理”本身，而在于“推理的形式”。视觉感知的本质要求在空间和以对象为中心（Object-Centric）的结构化环境中进行推理，而不在非结构化的语言空间中进行“空谈”。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b3b9cf9ffb4e9aa872f0e897ad317c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=9yJGaHgS3hgWH0Cj0fnsWMennAw%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文标题：Artemis: Structured Visual Reasoning for Perception Policy Learning</strong></p>
<p><strong>论文链接：</strong></p>
<p><strong>代码仓库：</strong> ****</p>
</blockquote>
<h2 data-id="heading-0"><strong>问题洞察：语言推理的局限与结构化视觉推理的必然</strong></h2>
<p>当现有MLLM面对如“找出最矮的运动员”这类指令时，它们往往依赖类似语言模型的“内部独白”进行推理。这种纯语义的推理过程缺乏视觉基础，容易产生无关或错误的中间描述，最终导致定位失败。相比之下，人类的感知过程是典型的结构化视觉推理：我们首先快速扫描整个场景，定位可能相关的区域，然后逐步聚焦、比较，最终锁定目标对象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5df74feddb71416fa3190de4ddafd292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=J0d%2F8gDmzEgM6xqe%2BECl%2F1LwaqY%3D" alt="图片2.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>Artemis的诞生：让MLLM学会“先看后想，边看边推”</strong></h2>
<p>为了克服上述局限，研究团队提出了 Artemis —— 一个基于强化学习的感知策略学习框架。该框架的命名灵感来源于古希腊神话中的狩猎女神阿尔忒弥斯，以其敏锐的视觉和百发百中的精准度著称，寓意着模型所追求的核心能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145d09b8412547d68721da533b1afb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=4YEnQe4rGNXGQu6Zb3%2FcsiH7B%2BY%3D" alt="图片3.png" loading="lazy"/></p>
<p>Artemis的核心创新在于要求模型提供结构化的视觉推理证据。在生成最终答案前，模型必须在特定的思考阶段输出一系列 (标签，边界框) 对。这些对直接代表了模型在图像中定位到的视觉实体，构成了可验证、可追踪的中间视觉状态。</p>
<ul>
<li><strong>结构化视觉推理奖励：</strong> 这是Artemis的灵魂。它设计了一套精细的奖励机制，不仅鼓励模型找出最终答案的关键对象，也奖励其识别出相关的上下文对象。这就像解题时，不仅要求答案正确，还要求列出关键的已知条件和推导步骤。</li>
<li><strong>统一的结果奖励：</strong> 包括格式奖励（确保输出结构规范）和答案奖励（基于预测框与真值框的重叠度及标签一致性）。</li>
<li><strong>高效的训练算法：</strong> 采用群组相对策略优化（Group Relative Policy Optimization, GRPO） 算法，高效地优化整个感知策略。</li>
</ul>
<h2 data-id="heading-2"><strong>强大的训练基础：Artemis-RFT数据集</strong></h2>
<p>为了训练Artemis，团队构建了Artemis-RFT数据集。该数据集基于MS-COCO构建，包含约7.7万个实例，统一了视觉定位（Visual Grounding）和目标检测（Object Detection） 两种任务格式。模型被训练在给出最终答案（绿色框）之前，先输出中间推理步骤（紫色框）来标识相关对象，从而学会结构化的视觉推理流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031ded4ea1ae4d4ca91332be208ace9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=Iv3GpPD9ZqRHcg3YkoBAR2SKHwc%3D" alt="图片4.png" loading="lazy"/></p>
<p>Artemis-RFT数据示例。该数据集包含两种任务类型：视觉定位和对象检测，统一的Artemis感知策略学习框架在两者上联合训练。紫色框表示推理对象，绿色框表示答案。</p>
<p>如上图所示，Artemis 要求模型在给出最终答案（绿色框）之前，先通过推理（紫色框）识别出场景中的相关对象。这种训练方式让模型学会了“先看后答”。</p>
<h2 data-id="heading-3"><strong>卓越的性能表现：全面领先，泛化惊人</strong></h2>
<p>Artemis基于Qwen2.5-VL-3B模型构建，在多个基准测试中取得了突破性成果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1160b1e6848341a6b0ffb2bf1e44c57c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=UriI%2B9SLNtRKTxWbHpIUqxWKG2I%3D" alt="图片5.png" loading="lazy"/></p>
<ul>
<li><strong>视觉定位与检测任务</strong></li>
</ul>
<p>在RefCOCO/+/g系列基准测试中，Artemis在所有指标上均达到领先水平，尤其在要求极高的IoU@0.95指标上优势显著，证明了其边界框预测的精准度。在COCO目标检测任务上，其mAP达到31.0，远超基座模型的15.4。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f952561f0354b7dbf28711fc19e0df1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=nGsO%2Fm%2F79UoiL5KoGPEvOtpD3TI%3D" alt="图片6.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>惊艳的零样本泛化能力</strong></p>
</li>
<li>
<p><strong>视觉计数：</strong> 在从未接受过计数任务训练的情况下，Artemis在Pixmo-Count数据集上的零样本准确率高达81.4，甚至超过了专门为计数设计的模型。它通过结构化地“列举”出图像中的目标对象来完成计数，模仿了人类的点数行为。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/877f4659b8c240d68e8508f776b5ab5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=aYqiSPo90CbGBFtWOQSRqbUg3Zo%3D" alt="图片7.png" loading="lazy"/></p>
<ul>
<li><strong>几何图形感知：</strong> Artemis能够将其在自然图像中学到的结构化感知能力，稳健地迁移到数学几何图形领域。在MATHGLANCE基准测试（涵盖平面几何、立体几何、图表题）中，它同样表现出色，实现了从真实场景到抽象图示的跨域泛化。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9005edef3cdc47aeb6628be960823ec1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=84dlhLwr7AEPNUUJn3lJ0dL0bxI%3D" alt="图片8.png" loading="lazy"/></p>
<ul>
<li><strong>综合多模态能力</strong></li>
</ul>
<p>在MMBench、MMVet等主流多模态理解基准测试中，Artemis保持了竞争优势，表明其增强的感知能力有益于整体的多模态推理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7759ecd7f7847f6afd720be2aaf4169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=YV0RDIfqecvKI6vzF1gP%2BaqBh7o%3D" alt="图片9.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>消融分析：验证结构化推理的核心价值</strong></h2>
<p>研究团队通过系统的消融实验证实：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99f867095fe34738a5e4339ad5c838e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=bTTh7Q1bnej9YkehtmRLpdqyY1Y%3D" alt="图片10.png" loading="lazy"/></p>
<ul>
<li><strong>无推理：</strong> 域内任务尚可，但域外泛化能力极差。</li>
<li><strong>纯语言推理：</strong> 会干扰感知过程，导致性能下降，尤其在计数等任务上。</li>
<li><strong>结构化视觉推理：</strong> 是性能全面提升和获得强大零样本泛化能力的关键。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f87b505cafc450ca13449ee99f90bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=55nShGcesisQp902JgDBrpIwen4%3D" alt="图片11.png" loading="lazy"/></p>
<ul>
<li><strong>可视化展示</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c2a472799f64d339c53a4c92b317674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=vQ9joG8taCYK1I4XWnXQQuo6j6w%3D" alt="图片12.png" loading="lazy"/></p>
<p>Artemis 通过紫色的推理框精准地定位了场景中的关键要素，从而给出了正确的红色答案框。相比之下，其他模型要么定位错误，要么完全偏离目标。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974510d7241445049116a55afd435aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766021847&amp;x-signature=oRM0ylcMkcDuhn%2BCKDu9lD9%2BREw%3D" alt="图片13.png" loading="lazy"/></p>
<p>在计数任务中，Artemis 展现了类似人类的“点数”行为，通过逐个标记目标（紫色框）来得出正确的总数，而基座模型 Qwen2.5-VL 则出现了严重的幻觉，标记了大量重复或错误的框。</p>
<h2 data-id="heading-5"><strong>技术贡献与产业影响</strong></h2>
<p>Artemis的工作首次系统性地证明：通过单一、统一的结构化视觉推理训练，可以使MLLM获得跨任务、跨领域的强大感知泛化能力。这项研究为MLLM的感知能力与空间推理能力的对齐指明了新方向。</p>
<h2 data-id="heading-6"><strong>结论</strong></h2>
<p>Artemis的出现标志着MLLM感知研究的一个重要转折点：它告诉我们，对于视觉任务，“如何思考”与“思考什么”同样重要，甚至更为关键。将推理过程空间化、结构化、可验证化，是解锁MLLM可靠感知与推理能力的关键。这项工作为构建下一代真正理解物理世界、能进行复杂空间交互的智能体奠定了坚实的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决ShardingSphere分片算法在Devtools热重启后SpringUtil.getBean()空指针问题]]></title>    <link>https://juejin.cn/post/7582041304654577710</link>    <guid>https://juejin.cn/post/7582041304654577710</guid>    <pubDate>2025-12-10T10:31:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582041304654577710" data-draft-id="7581872532363689993" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决ShardingSphere分片算法在Devtools热重启后SpringUtil.getBean()空指针问题"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-10T10:31:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未秃头的程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3448514653724824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决ShardingSphere分片算法在Devtools热重启后SpringUtil.getBean()空指针问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448514653724824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未秃头的程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T10:31:06.000Z" title="Wed Dec 10 2025 10:31:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">❄️🔥 冷启动正常，热重启NPE？ShardingSphere撞上Devtools的诡异空指针</h2>
<blockquote>
<p><strong>核心提示</strong>：你的 ShardingSphere 按月分表功能，在应用首次启动（冷启动）时一切正常，但修改代码后热重启，却抛出令人费解的空指针异常（NPE）。问题根源并非代码逻辑，而在于你项目中的 <code>spring-boot-devtools</code>。</p>
</blockquote>
<h3 data-id="heading-1">问题现象：薛定谔的 Bean</h3>
<p>开发同学在集成 ShardingSphere-JDBC 实现按月自动分表时，常会编写类似的分片算法类：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// DateRangeShardingAlgorithm.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateRangeShardingAlgorithm</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PreciseShardingAlgorithm</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection tableNames, 
                            PreciseShardingValue preciseShardingValue)</span> {
        <span class="hljs-comment">// 冷启动时正常，热重启后此句抛出 NullPointerException！</span>
        <span class="hljs-type">ShardingAlgorithmConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> SpringUtils.getBean(ShardingAlgorithmConfig.class);
        <span class="hljs-comment">// 后续分表逻辑...</span>
    }
}
</code></pre>
<p><strong>症状具体表现为</strong>：</p>
<ul>
<li><strong>❄️ 冷启动 ✅</strong>：通过 IDE 或命令首次启动应用，分表路由功能完全正常。</li>
<li><strong>🔥 热重启 ❌</strong>：修改代码保存后，Devtools 自动热重启应用，相同的分片查询立刻抛出 <code>NullPointerException</code>。</li>
<li><strong>🧪 单元测试 ✅</strong>：单独运行 <code>@SpringBootTest</code> 单元测试，一切正常，掩盖了问题。</li>
</ul>
<h3 data-id="heading-2">根源简析：Devtools 的“平行宇宙”</h3>
<p><code>spring-boot-devtools</code> 为了实现极速热重启，采用了<strong>双类加载器 (Dual ClassLoader)</strong>  机制：</p>
<ul>
<li><strong>Base ClassLoader</strong>：加载基本不会变的第三方库（如 Spring、ShardingSphere 自身）。</li>
<li><strong>Restart ClassLoader</strong>：加载你正在开发的、频繁变更的项目代码。</li>
</ul>
<p><strong>热重启时，只有 RestartClassLoader 被重建</strong>。这导致了一个关键问题：你项目中的工具类（如 <code>SpringUtils</code>）和 ShardingSphere 框架创建的分片算法实例，可能处于<strong>两个不同的“类加载器宇宙”</strong> 中。工具类里用于保存 Spring 容器的静态变量（如 <code>beanFactory</code>）<strong>在两个宇宙中互不相同</strong>。框架宇宙里的变量被正确赋值了，但你代码宇宙里访问的却是另一个未赋值的副本，结果就是 <code>null</code>。</p>
<hr/>
<h3 data-id="heading-3">🛠️ 解决方案一：配置排除法（快速修复）</h3>
<p>如果你希望保留 Devtools 的便利性，这是最快的解决方式。核心思路是：<strong>告诉 Devtools，将特定的核心工具类和配置类，也交由 BaseClassLoader 加载</strong>，让它们留在“框架宇宙”，从而避免隔离。</p>
<h4 data-id="heading-4">操作步骤</h4>
<p><strong>1. 创建排除配置文件</strong><br/>
在项目的 <code>src/main/resources</code> 目录下，创建 <code>META-INF/spring-devtools.properties</code> 文件。</p>
<p><strong>2. 添加排除规则</strong><br/>
在文件中加入以下配置（请将 <code>com.yourpackage</code> 替换为你的实际包名）：</p>
<pre><code class="hljs language-properties" lang="properties">
# 排除包含 Spring 上下文工具类的包
restart.exclude.springutils=com.yourpackage.utils..*
# 排除 ShardingSphere 配置类的包
restart.exclude.shardingconfig=com.yourpackage.config.sharding..*
</code></pre>
<p><strong>3. （可选）验证配置效果</strong><br/>
你可以在应用启动时添加一段日志来验证：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoaderCheckRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> {
        System.out.println(&amp;#<span class="hljs-number">34</span>;SpringUtils 加载自: &amp;#<span class="hljs-number">34</span>; + SpringUtils.class.getClassLoader());
        System.out.println(&amp;#<span class="hljs-number">34</span>;ShardingConfig 加载自: &amp;#<span class="hljs-number">34</span>; + ShardingAlgorithmConfig.class.getClassLoader());
        System.out.println(&amp;#<span class="hljs-number">34</span>;分片算法类加载自: &amp;#<span class="hljs-number">34</span>; + DateRangeShardingAlgorithm.class.getClassLoader());
    }
}
</code></pre>
<p><strong>期待的输出结果</strong>应是：前两个类由 <code>AppClassLoader</code> 加载，而分片算法类由 <code>RestartClassLoader</code> 加载。</p>

















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>配置简单，见效快</td><td>需要明确知道哪些核心类需排除</td></tr><tr><td>完全保留热重启功能</td><td>新增类似工具类需更新配置</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">🧹 解决方案二：移除 Devtools 依赖（最彻底）</h3>
<p>如果你的开发环境对热重启依赖不高，或者此问题已严重阻碍调试，<strong>直接移除 <code>spring-boot-devtools</code> 依赖是最彻底、一劳永逸的方法</strong>。</p>
<h4 data-id="heading-6">操作步骤</h4>
<p><strong>1. 修改 Maven 依赖 (<code>pom.xml</code>)</strong><br/>
找到并注释或删除 <code>spring-boot-devtools</code> 依赖项。</p>
<pre><code class="hljs language-xml" lang="xml">


    org.springframework.boot
    spring-boot-devtools
    runtime
    true

--&gt;
</code></pre>
<p><strong>2. 清理与重启</strong><br/>
执行 Maven 清理并重新冷启动应用：</p>
<pre><code class="hljs language-bash" lang="bash">mvn clean compile
</code></pre>
<p>然后在 IDE 中重新启动你的 Spring Boot 应用。</p>
<h4 data-id="heading-7">为什么移除就能解决？</h4>
<p>因为移除了 <code>spring-boot-devtools</code> 后，应用在任何时候启动都会使用单一的、标准的 <code>AppClassLoader</code>。所有的类都在同一个“宇宙”中，静态变量自然可以正确共享访问，上述的 NPE 问题随之消失。</p>

















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>需要热重启功能</strong>，且愿意稍作配置</td><td><strong>方案一：配置排除法</strong></td></tr><tr><td><strong>想彻底根除问题</strong>，或热重启非必需</td><td><strong>方案二：移除 Devtools</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">总结</h3>
<p><code>spring-boot-devtools</code> 在提升开发效率的同时，也因其独特的双类加载器机制带来了“冷热启动行为不一致”的暗坑。当你的 <strong>ShardingSphere 分片算法、MyBatis 插件等框架扩展点</strong>，在热重启后出现神秘的 NPE 时，首先可以检查是否通过静态工具类获取了 Spring Bean。</p>
<p>解决之道很清晰：要么<strong>配置排除</strong>关键类，要么<strong>暂时移除此依赖</strong>。通常，在集中解决此类集成问题期间，采用方案二能让调试路径更加清晰。</p>
<p>希望这篇短文能帮你快速挣脱这个隐蔽的困境，让你的分表功能在冷与热的世界里都稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArrayList的add方法底层实现原理]]></title>    <link>https://juejin.cn/post/7581872532363722761</link>    <guid>https://juejin.cn/post/7581872532363722761</guid>    <pubDate>2025-12-10T10:31:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581872532363722761" data-draft-id="7582047554089074697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArrayList的add方法底层实现原理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T10:31:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="学java中"/> <meta itemprop="url" content="https://juejin.cn/user/2269028453720813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArrayList的add方法底层实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2269028453720813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    学java中
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T10:31:44.000Z" title="Wed Dec 10 2025 10:31:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong><code>ArrayList</code> 的底层确实是用数组实现的</strong>，并且它的 <strong><code>add()</code> 方法的核心逻辑就依赖于这个内部数组</strong>。下面我们从源码角度（以 Java 8+ 为主）来详细解析：</p>
<h2 data-id="heading-0">1. <code>ArrayList</code> 底层结构</h2>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArrayList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractList</span></span>
        implements <span class="hljs-type">List</span>, <span class="hljs-type">RandomAccess</span>, <span class="hljs-type">Cloneable</span>, java.io.<span class="hljs-type">Serializable</span> {
    
    <span class="hljs-comment">// 存储元素的底层数组（JDK 8+ 是 Object[]，早期版本可能为 transient）</span>
    transient <span class="hljs-type">Object</span>[] elementData;

    <span class="hljs-comment">// 实际元素个数</span>
    <span class="hljs-keyword">private</span> int size;
}
</code></pre>
<ul>
<li><code>elementData</code> 就是 <code>ArrayList</code> 内部用来存数据的<strong>动态数组</strong>。</li>
<li>初始容量默认为 <strong>10</strong>（如果你用无参构造函数）。</li>
</ul>
<h2 data-id="heading-1">2. <code>add(E e)</code> 方法的核心流程</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>{
    <span class="hljs-built_in">ensureCapacityInternal</span>(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 确保容量足够</span>
    elementData[size++] = e;           <span class="hljs-comment">// 添加元素并增加 size</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>关键在 <code>ensureCapacityInternal()</code> —— 它负责<strong>扩容检查</strong>。</p>
<h2 data-id="heading-2">3. 扩容机制（核心！）</h2>
<h3 data-id="heading-3">步骤分解：</h3>
<h4 data-id="heading-4">(1) <code>ensureCapacityInternal(minCapacity)</code></h4>
<pre><code class="hljs language-ini" lang="ini">private void ensureCapacityInternal(int minCapacity) {
    if (<span class="hljs-attr">elementData</span> == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        // 如果是默认空数组，则至少扩容到 <span class="hljs-attr">DEFAULT_CAPACITY</span> = <span class="hljs-number">10</span>
        <span class="hljs-attr">minCapacity</span> = Math.max(DEFAULT_CAPACITY, minCapacity)<span class="hljs-comment">;</span>
    }
    ensureExplicitCapacity(minCapacity)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-5">(2) <code>ensureExplicitCapacity(minCapacity)</code></h4>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">ensureExplicitCapacity</span>(int minCapacity) {
    modCount++; <span class="hljs-comment">// 用于 fail-fast 机制</span>
    if (minCapacity - elementData.length &gt; <span class="hljs-number">0</span>)
        <span class="hljs-built_in">grow</span>(minCapacity); <span class="hljs-comment">// 需要扩容！</span>
}
</code></pre>
<h4 data-id="heading-6">(3) <code>grow(int minCapacity)</code> —— <strong>真正的扩容逻辑</strong></h4>
<pre><code class="hljs language-ini" lang="ini">private void grow(int minCapacity) {
    int <span class="hljs-attr">oldCapacity</span> = elementData.length<span class="hljs-comment">;</span>
    // 新容量 = 旧容量 + 旧容量 &gt;&gt; 1 （即 1.5 倍）
    int <span class="hljs-attr">newCapacity</span> = oldCapacity + (oldCapacity &gt;&gt; <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
    
    // 如果 1.5 倍还不够（比如批量添加大量元素），就用 minCapacity
    if (newCapacity - minCapacity &lt; 0)
        <span class="hljs-attr">newCapacity</span> = minCapacity<span class="hljs-comment">;</span>
    
    // 处理超大数组（接近 Integer.MAX_VALUE）
    if (newCapacity - MAX_ARRAY_SIZE &gt; 0)
        <span class="hljs-attr">newCapacity</span> = hugeCapacity(minCapacity)<span class="hljs-comment">;</span>

    // 创建新数组，并复制旧数据（调用 Arrays.copyOf）
    <span class="hljs-attr">elementData</span> = Arrays.copyOf(elementData, newCapacity)<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-7">4. 关键点总结</h2>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>底层结构</strong></td><td><code>Object[] elementData</code> 数组</td></tr><tr><td><strong>初始容量</strong></td><td>无参构造时为 <strong>0</strong>（延迟初始化），第一次 <code>add</code> 时扩到 <strong>10</strong></td></tr><tr><td><strong>扩容策略</strong></td><td><strong>1.5 倍增长</strong>（<code>old + old &gt;&gt; 1</code>）</td></tr><tr><td><strong>扩容操作</strong></td><td>调用 <code>Arrays.copyOf()</code> 创建新数组并复制元素（<strong>时间复杂度 O(n)</strong> ）</td></tr><tr><td><strong>线程安全</strong></td><td>❌ <code>ArrayList</code> <strong>不是线程安全的</strong></td></tr></tbody></table>
<p>举例：<br/>
当前容量 10，添加第 11 个元素 → 扩容到 <code>10 + 5 = 15</code><br/>
再添加到第 16 个 → 扩容到 <code>15 + 7 = 22</code>（因为 <code>15 &gt;&gt; 1 = 7</code>）</p>
<h2 data-id="heading-8">对比：<code>ArrayList</code> vs 普通数组</h2>






























<table><thead><tr><th>特性</th><th>普通数组</th><th><code>ArrayList</code></th></tr></thead><tbody><tr><td>大小固定？</td><td>✅ 是</td><td>❌ 动态扩容</td></tr><tr><td>泛型支持？</td><td>❌</td><td>✅</td></tr><tr><td>提供丰富方法？</td><td>❌</td><td>✅（add/remove/contains等）</td></tr><tr><td>内存开销</td><td>小</td><td>稍大（对象头 + size 字段等）</td></tr></tbody></table>
<h3 data-id="heading-9">📌 总结</h3>
<ul>
<li><strong><code>ArrayList</code> 底层是 <code>Object[]</code> 数组</strong>。</li>
<li><strong><code>add()</code> 方法会检查容量，不够就扩容</strong>。</li>
<li><strong>扩容规则：1.5 倍（右移一位加原值）</strong> 。</li>
<li><strong>扩容本质是创建新数组 + 复制旧数据（<code>Arrays.copyOf</code>）</strong> ，所以<strong>频繁扩容会影响性能</strong> → 建议预估容量并用 <code>new ArrayList&lt;&gt;(initialCapacity)</code> 初始化。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧪 JUnit单元测试完全指南：从入门到企业级应用]]></title>    <link>https://juejin.cn/post/7582039917216579584</link>    <guid>https://juejin.cn/post/7582039917216579584</guid>    <pubDate>2025-12-10T11:01:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917216579584" data-draft-id="7582036070159237120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧪 JUnit单元测试完全指南：从入门到企业级应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T11:01:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户44236359841"/> <meta itemprop="url" content="https://juejin.cn/user/766787307710060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧪 JUnit单元测试完全指南：从入门到企业级应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/766787307710060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户44236359841
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:01:42.000Z" title="Wed Dec 10 2025 11:01:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧪 JUnit单元测试完全指南：从入门到企业级应用</h2>
<h3 data-id="heading-1">📖 引言</h3>
<p>在现代Java开发中，单元测试已成为保证代码质量不可或缺的一环。JUnit作为Java领域最流行的单元测试框架，为开发者提供了强大而灵活的测试工具。今天，我将带你全面了解JUnit的使用，并结合实际案例，让你轻松掌握企业级测试规范！</p>
<hr/>
<h3 data-id="heading-2">🎯 第一章：JUnit快速入门</h3>
<h4 data-id="heading-3">1.1 什么是JUnit单元测试？</h4>
<p>JUnit单元测试主要用于<strong>验证类中方法的正确性</strong>，它是开发者验证代码逻辑的第一道防线。</p>
<h4 data-id="heading-4">1.2 为什么要使用JUnit？</h4>
<p>✅ <strong>三大核心优势：</strong></p>
<ul>
<li>🛡️ <strong>代码分离</strong>：测试代码与业务代码分离，便于维护</li>
<li>🎨 <strong>直观反馈</strong>：自动生成测试报告（绿色通过 ❌ 红色失败）</li>
<li>🔒 <strong>独立执行</strong>：一个测试方法失败不影响其他测试执行</li>
</ul>
<h4 data-id="heading-5">1.3 命名规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 类命名：被测试类名 + Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {  <span class="hljs-comment">// ✅ 规范</span>
    
    <span class="hljs-comment">// 方法命名：public void 方法名(){...}</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetAge</span><span class="hljs-params">()</span> {  <span class="hljs-comment">// ✅ 规定</span>
        <span class="hljs-comment">// 测试逻辑</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">⚙️ 第二章：环境配置与基础使用</h3>
<h4 data-id="heading-7">2.1 Maven依赖配置</h4>
<p>在<code>pom.xml</code>中添加JUnit依赖：</p>
<pre><code class="hljs language-xml" lang="xml">

    org.junit.jupiter
    junit-jupiter
    5.9.1
    test

</code></pre>
<h4 data-id="heading-8">2.2 创建第一个测试类</h4>
<p>在<code>src/test/java</code>目录下创建测试类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;

<span class="hljs-comment">/**
 * 用户服务测试类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetAge</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 准备测试数据</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        
        <span class="hljs-comment">// 2. 执行被测试方法</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> userService.getAge(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">100000200010011011</span>&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-comment">// 3. 验证结果（初始版本使用输出）</span>
        System.out.println(&amp;#<span class="hljs-number">34</span>;计算年龄：&amp;#<span class="hljs-number">34</span>; + age);
        
        <span class="hljs-comment">// 🎯 企业实践：应该使用断言而非System.out</span>
        <span class="hljs-comment">// Assertions.assertEquals(22, age, &amp;#34;年龄计算错误&amp;#34;);</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🔍 第三章：断言（Assertions）- 测试的核心</h3>
<h4 data-id="heading-10">3.1 什么是断言？</h4>
<p>断言是JUnit提供的辅助方法，用于<strong>验证被测试方法是否按预期工作</strong>。如果断言失败，测试将标记为失败。</p>
<h4 data-id="heading-11">3.2 常用断言方法详解</h4>













































<table><thead><tr><th>断言方法</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td><code>assertEquals(expected, actual, message)</code></td><td>检查两个值是否相等</td><td>验证方法返回值</td></tr><tr><td><code>assertNotEquals(unexpected, actual, message)</code></td><td>检查两个值是否不相等</td><td>验证不相等情况</td></tr><tr><td><code>assertNull(object, message)</code></td><td>检查对象是否为null</td><td>验证空返回值</td></tr><tr><td><code>assertNotNull(object, message)</code></td><td>检查对象是否不为null</td><td>验证非空返回值</td></tr><tr><td><code>assertTrue(condition, message)</code></td><td>检查条件是否为true</td><td>验证布尔条件</td></tr><tr><td><code>assertFalse(condition, message)</code></td><td>检查条件是否为false</td><td>验证假条件</td></tr><tr><td><code>assertThrows(exceptionType, executable, message)</code></td><td>检查是否抛出指定异常</td><td>验证异常情况</td></tr></tbody></table>
<h4 data-id="heading-12">3.3 实战：断言应用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.jupiter.api.Assertions;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGenderWithAssert</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 准备</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        
        <span class="hljs-comment">// 执行</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">gender</span> <span class="hljs-operator">=</span> userService.getGender(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">100000200010011011</span>&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-comment">// 验证断言</span>
        Assertions.assertEquals(&amp;#<span class="hljs-number">34</span>;男&amp;#<span class="hljs-number">34</span>;, gender, 
            &amp;#<span class="hljs-number">34</span>;身份证<span class="hljs-number">100000200010011011</span>对应的性别应该是男性&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGenderWithException</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        
        <span class="hljs-comment">// 验证异常断言</span>
        Assertions.assertThrows(IllegalArgumentException.class, () -&gt; {
            userService.getGender(<span class="hljs-literal">null</span>);
        }, &amp;#<span class="hljs-number">34</span>;传入<span class="hljs-literal">null</span>参数应该抛出IllegalArgumentException异常&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testComprehensiveAssertions</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userService.processData(&amp;#<span class="hljs-number">34</span>;test&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-comment">// 多个断言组合使用</span>
        Assertions.assertNotNull(result, &amp;#<span class="hljs-number">34</span>;返回值不应为<span class="hljs-literal">null</span>&amp;#<span class="hljs-number">34</span>;);
        Assertions.assertFalse(result.isEmpty(), &amp;#<span class="hljs-number">34</span>;返回值不应为空字符串&amp;#<span class="hljs-number">34</span>;);
        Assertions.assertTrue(result.length() &gt; <span class="hljs-number">3</span>, &amp;#<span class="hljs-number">34</span>;返回值长度应大于<span class="hljs-number">3</span>&amp;#<span class="hljs-number">34</span>;);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">🏷️ 第四章：JUnit注解大全</h3>
<h4 data-id="heading-14">4.1 核心注解速查表</h4>



























































<table><thead><tr><th>注解</th><th>说明</th><th>生命周期</th><th>示例</th></tr></thead><tbody><tr><td><code>@Test</code></td><td>标记测试方法</td><td>测试方法级</td><td><code>@Test void testMethod()</code></td></tr><tr><td><code>@ParameterizedTest</code></td><td>参数化测试</td><td>测试方法级</td><td>配合<code>@ValueSource</code>使用</td></tr><tr><td><code>@ValueSource</code></td><td>提供测试参数</td><td>方法参数级</td><td><code>@ValueSource(strings = {&amp;#34;A&amp;#34;, &amp;#34;B&amp;#34;})</code></td></tr><tr><td><code>@DisplayName</code></td><td>自定义显示名称</td><td>类/方法级</td><td><code>@DisplayName(&amp;#34;用户注册测试&amp;#34;)</code></td></tr><tr><td><code>@BeforeEach</code></td><td>每个测试前执行</td><td>实例方法</td><td>初始化测试数据</td></tr><tr><td><code>@AfterEach</code></td><td>每个测试后执行</td><td>实例方法</td><td>清理资源</td></tr><tr><td><code>@BeforeAll</code></td><td>所有测试前执行</td><td>静态方法</td><td>初始化数据库连接</td></tr><tr><td><code>@AfterAll</code></td><td>所有测试后执行</td><td>静态方法</td><td>关闭数据库连接</td></tr></tbody></table>
<h4 data-id="heading-15">4.2 注解实战示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.jupiter.api.*;
<span class="hljs-keyword">import</span> org.junit.jupiter.params.ParameterizedTest;
<span class="hljs-keyword">import</span> org.junit.jupiter.params.provider.ValueSource;

<span class="hljs-meta">@DisplayName(&amp;#34;用户服务完整测试套件&amp;#34;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceCompleteTest</span> {
    
    <span class="hljs-keyword">private</span> UserService userService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">testCounter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-meta">@BeforeAll</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initAll</span><span class="hljs-params">()</span> {
        System.out.println(&amp;#<span class="hljs-number">34</span>;🚀 开始执行所有测试...&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-comment">// 初始化全局资源，如数据库连接池</span>
    }
    
    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        userService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        testCounter++;
        System.out.println(&amp;#<span class="hljs-number">34</span>;📝 准备执行第 &amp;#<span class="hljs-number">34</span>; + testCounter + &amp;#<span class="hljs-number">34</span>; 个测试&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;测试年龄计算 - 正常情况&amp;#34;)</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetAgeNormal</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> userService.getAge(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">100000200010011011</span>&amp;#<span class="hljs-number">34</span>;);
        Assertions.assertEquals(<span class="hljs-number">22</span>, age);
    }
    
    <span class="hljs-meta">@ParameterizedTest</span>
    <span class="hljs-meta">@ValueSource(strings = {
        &amp;#34;100000200010011011&amp;#34;,  // 男性
        &amp;#34;100000200010021028&amp;#34;,  // 女性
        &amp;#34;100000200010031013&amp;#34;   // 男性
    })</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;参数化测试 - 多个身份证号验证性别&amp;#34;)</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGenderParameterized</span><span class="hljs-params">(String idCard)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">gender</span> <span class="hljs-operator">=</span> userService.getGender(idCard);
        Assertions.assertNotNull(gender);
        Assertions.assertTrue(gender.equals(&amp;#<span class="hljs-number">34</span>;男&amp;#<span class="hljs-number">34</span>;) || gender.equals(&amp;#<span class="hljs-number">34</span>;女&amp;#<span class="hljs-number">34</span>;));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;边界测试 - 最小年龄&amp;#34;)</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMinAgeBoundary</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试刚出生的婴儿</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> userService.getAge(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">202312310101010101</span>&amp;#<span class="hljs-number">34</span>;);
        Assertions.assertEquals(<span class="hljs-number">0</span>, age, &amp;#<span class="hljs-number">34</span>;当天出生年龄应为<span class="hljs-number">0</span>&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-meta">@AfterEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> {
        System.out.println(&amp;#<span class="hljs-number">34</span>;✅ 第 &amp;#<span class="hljs-number">34</span>; + testCounter + &amp;#<span class="hljs-number">34</span>; 个测试执行完成&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-comment">// 清理测试数据</span>
    }
    
    <span class="hljs-meta">@AfterAll</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDownAll</span><span class="hljs-params">()</span> {
        System.out.println(&amp;#<span class="hljs-number">34</span>;🎉 所有测试执行完毕，共执行 &amp;#<span class="hljs-number">34</span>; + testCounter + &amp;#<span class="hljs-number">34</span>; 个测试&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-comment">// 释放全局资源</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-16">🏢 第五章：企业级开发规范</h3>
<h4 data-id="heading-17">5.1 测试覆盖原则</h4>
<p><strong>黄金法则：尽可能覆盖业务方法中的所有可能情况，特别是边界值！</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;支付金额测试 - 全覆盖&amp;#34;)</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPaymentAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentService</span>();
        
        <span class="hljs-comment">// 1. 正常情况</span>
        Assertions.assertTrue(service.validateAmount(<span class="hljs-number">100.0</span>));
        
        <span class="hljs-comment">// 2. 边界值：最小值</span>
        Assertions.assertTrue(service.validateAmount(<span class="hljs-number">0.01</span>));
        
        <span class="hljs-comment">// 3. 边界值：最大值</span>
        Assertions.assertTrue(service.validateAmount(<span class="hljs-number">999999.99</span>));
        
        <span class="hljs-comment">// 4. 异常情况：负数</span>
        Assertions.assertFalse(service.validateAmount(-<span class="hljs-number">100.0</span>));
        
        <span class="hljs-comment">// 5. 异常情况：超过最大值</span>
        Assertions.assertFalse(service.validateAmount(<span class="hljs-number">1000000.0</span>));
        
        <span class="hljs-comment">// 6. 异常情况：零值</span>
        Assertions.assertFalse(service.validateAmount(<span class="hljs-number">0.0</span>));
        
        <span class="hljs-comment">// 7. 边界值：正好等于最大值</span>
        Assertions.assertTrue(service.validateAmount(<span class="hljs-number">999999.99</span>));
    }
}
</code></pre>
<h4 data-id="heading-18">5.2 测试金字塔策略</h4>
<pre><code class="hljs language-scss" lang="scss">        🎪 UI测试 (少量)
         ↑
    🏢 集成测试 (适量)
         ↑
🧪 单元测试 (大量基础)
</code></pre>
<p><strong>推荐比例：70%单元测试 + 20%集成测试 + 10%UI测试</strong></p>
<h4 data-id="heading-19">5.3 最佳实践清单</h4>
<p>✅ <strong>一定要做：</strong></p>
<ul>
<li>每个public方法都要有对应的测试</li>
<li>测试方法名要清晰表达测试意图</li>
<li>使用<code>@DisplayName</code>提高可读性</li>
<li>测试数据与业务逻辑分离</li>
<li>定期运行测试套件</li>
</ul>
<p>❌ <strong>避免：</strong></p>
<ul>
<li>在测试中写业务逻辑</li>
<li>测试方法之间有依赖</li>
<li>使用<code>System.out</code>代替断言</li>
<li>忽略边界条件测试</li>
<li>测试代码不维护</li>
</ul>
<hr/>
<h3 data-id="heading-20">📦 第六章：Maven依赖范围详解</h3>






























<table><thead><tr><th>范围</th><th>说明</th><th>示例场景</th></tr></thead><tbody><tr><td><strong>compile</strong></td><td>默认范围，编译、测试、运行都有效</td><td>项目核心依赖（如Spring Core）</td></tr><tr><td><strong>test</strong></td><td>仅测试阶段有效，不会打包发布</td><td>JUnit、Mockito等测试框架</td></tr><tr><td><strong>provided</strong></td><td>编译和测试有效，运行时由容器提供</td><td>Servlet API、JSP API</td></tr><tr><td><strong>runtime</strong></td><td>运行和测试有效，编译时不需要</td><td>JDBC驱动、日志实现</td></tr></tbody></table>
<p><strong>JUnit正确配置：</strong></p>
<pre><code class="hljs language-xml" lang="xml">
    org.junit.jupiter
    junit-jupiter
    5.9.1
    test  

</code></pre>
<hr/>
<h3 data-id="heading-21">🚀 第七章：高级技巧与实战建议</h3>
<h4 data-id="heading-22">7.1 参数化测试进阶</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ParameterizedTest</span>
<span class="hljs-meta">@CsvSource({
    &amp;#34;100000200010011011, 男, 22&amp;#34;,
    &amp;#34;100000200010021028, 女, 22&amp;#34;, 
    &amp;#34;100000199010011011, 男, 33&amp;#34;
})</span>
<span class="hljs-meta">@DisplayName(&amp;#34;CSV数据驱动测试&amp;#34;)</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserWithCsv</span><span class="hljs-params">(String idCard, String expectedGender, <span class="hljs-type">int</span> expectedAge)</span> {
    <span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
    
    Assertions.assertEquals(expectedGender, service.getGender(idCard));
    Assertions.assertEquals(expectedAge, service.getAge(idCard));
}
</code></pre>
<h4 data-id="heading-23">7.2 测试代码结构模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 企业级测试类模板
 */</span>
<span class="hljs-meta">@DisplayName(&amp;#34;[业务模块] - [功能]测试&amp;#34;)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardTestTemplate</span> {
    
    <span class="hljs-keyword">private</span> 被测试类实例;
    <span class="hljs-keyword">private</span> 模拟依赖实例;
    
    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 初始化被测试对象</span>
        <span class="hljs-comment">// 2. 准备测试数据</span>
        <span class="hljs-comment">// 3. 设置模拟行为</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;场景描述 - 预期结果&amp;#34;)</span>
    <span class="hljs-keyword">void</span> 测试方法名() {
        <span class="hljs-comment">// 1. Arrange: 准备测试数据</span>
        <span class="hljs-comment">// 2. Act: 执行被测试方法</span>
        <span class="hljs-comment">// 3. Assert: 验证结果</span>
    }
    
    <span class="hljs-meta">@AfterEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 清理资源</span>
    }
    
    <span class="hljs-meta">@Nested</span>
    <span class="hljs-meta">@DisplayName(&amp;#34;特定场景分组&amp;#34;)</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecificScenarioTests</span> {
        <span class="hljs-comment">// 嵌套测试类，用于分组相关测试</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-24">📊 第八章：测试报告与持续集成</h3>
<h4 data-id="heading-25">8.1 生成测试报告</h4>
<p>在Maven中运行测试并生成报告：</p>
<pre><code class="hljs language-bash" lang="bash">mvn <span class="hljs-built_in">test</span>  <span class="hljs-comment"># 运行测试</span>
mvn surefire-report:report  <span class="hljs-comment"># 生成HTML报告</span>
</code></pre>
<h4 data-id="heading-26">8.2 与CI/CD集成</h4>
<p>在<code>.gitlab-ci.yml</code>或<code>Jenkinsfile</code>中添加测试阶段：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">test:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">test</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">clean</span> <span class="hljs-string">test</span>
  <span class="hljs-attr">artifacts:</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">target/surefire-reports/</span>
    <span class="hljs-attr">expire_in:</span> <span class="hljs-number">1</span> <span class="hljs-string">week</span>
</code></pre>
<hr/>
<h3 data-id="heading-27">🎓 总结</h3>
<p>通过学习本指南，你应该已经掌握了：</p>
<ol>
<li>✅ <strong>基础概念</strong>：JUnit的作用、优势、命名规范</li>
<li>✅ <strong>核心技能</strong>：断言的使用、各种注解的应用</li>
<li>✅ <strong>企业实践</strong>：测试覆盖原则、最佳实践</li>
<li>✅ <strong>高级特性</strong>：参数化测试、依赖管理</li>
</ol>
<p><strong>记住：好的测试不是负担，而是你代码的保镖！</strong> 🛡️</p>
<p>每个测试用例都是对未来修改的一份保险，投资时间写测试，就是投资项目的稳定性和可维护性。现在，开始为你的项目添加坚实的测试防护吧！</p>
<hr/>
<p><strong>📚 延伸学习资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjunit.org%2Fjunit5%2Fdocs%2Fcurrent%2Fuser-guide%2F" target="_blank" title="https://junit.org/junit5/docs/current/user-guide/" ref="nofollow noopener noreferrer">JUnit 5官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsite.mockito.org%2F" target="_blank" title="https://site.mockito.org/" ref="nofollow noopener noreferrer">Mockito框架</a> - 模拟对象测试</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftestcontainers.org%2F" target="_blank" title="https://testcontainers.org/" ref="nofollow noopener noreferrer">TestContainers</a> - 集成测试容器</li>
</ul>
<p><strong>💡 小提示：</strong>
开始一个新项目时，建议先写测试再写实现（TDD），这能帮你更好地理清需求和设计接口。</p>
<hr/>
<p><em>本文基于JUnit 5编写，适用于Spring Boot等现代Java框架开发。祝您测试愉快！</em> 🧪✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET进阶——深入理解委托（2）嵌套委托：手写中间件框架]]></title>    <link>https://juejin.cn/post/7582048028392538162</link>    <guid>https://juejin.cn/post/7582048028392538162</guid>    <pubDate>2025-12-10T11:07:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582048028392538162" data-draft-id="7581893894175227914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET进阶——深入理解委托（2）嵌套委托：手写中间件框架"/> <meta itemprop="keywords" content=".NET"/> <meta itemprop="datePublished" content="2025-12-10T11:07:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我要拿微软MVP"/> <meta itemprop="url" content="https://juejin.cn/user/1945461219656633"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET进阶——深入理解委托（2）嵌套委托：手写中间件框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1945461219656633/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我要拿微软MVP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:07:39.000Z" title="Wed Dec 10 2025 11:07:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前景提要</h2>
<p>在上文我们已经入门了委托：<a href="https://juejin.cn/post/7581666412022022153" target="_blank" title="https://juejin.cn/post/7581666412022022153">.NET进阶——深入理解委托（1）委托入门一、什么是委托 委托就相当于是一个可以存放方法的箱子，我们可以通过这个“箱子” - 掘金</a>，现在利用委托，我们来玩点高级的东西。</p>
<h3 data-id="heading-1">1.1 什么是中间件</h3>
<p>学过ASP .NET Core的同学应该对中间件有所了解，这里再简单的介绍一下：</p>
<p>中间件是一个<strong>处理链条</strong>（Pipeline），请求从上一个中间件流到下一个，直到核心业务；响应再从核心业务流回各个中间件，最终返回给用户。就像快递流程：商家 → 快递员 → 驿站 → 你（请求方向）；你退货 → 驿站 → 快递员 → 商家（响应方向）。</p>
<p>用ASP .NET Core举例子,一个请求会按「注册顺序」依次经过每个中间件的<strong>前置逻辑</strong>；当核心业务（路由中间件）处理完请求后，响应会按「注册顺序的反向」依次经过每个中间件的<strong>后置逻辑</strong>。假设我发起了一个请求，各个阶段的路线分别是这样的：</p>
<p>请求：<code>异常中间件</code> → <code>日志中间件</code> → <code>跨域中间件</code> → <code>认证中间件</code> → <code>路由中间件</code>-&gt;<code>核心业务</code>(顺序）</p>
<p>响应：<code>核心业务</code>→ <code>路由中间件</code> → <code>认证中间件</code>→ <code>跨域中间件</code> → <code>日志中间件</code>-&gt;<code>异常中间件</code>（逆序）</p>





















<table><thead><tr><th>阶段</th><th>执行顺序 &amp; 具体逻辑</th></tr></thead><tbody><tr><td><strong>请求阶段</strong>（顺行）</td><td>1. 异常中间件前置逻辑 → 无操作（仅准备捕获异常）2. 日志中间件前置逻辑 → 记录 “谁在什么时候发了什么请求”3. 跨域中间件前置逻辑 → 检查跨域请求，设置预检响应头4. 认证中间件前置逻辑 → 检查登录状态（已登录，放行）5. 路由中间件前置逻辑 → 转发请求到 “查询用户数据” 核心接口（执行核心业务）</td></tr><tr><td><strong>核心业务</strong></td><td>路由中间件执行核心逻辑：查询用户数据，生成响应内容（无异常）</td></tr><tr><td><strong>响应阶段</strong>（逆行）</td><td>1. 认证中间件后置逻辑 → 无操作（若有需要可补充响应头）2. 跨域中间件后置逻辑 → 补充跨域响应头（如 Access-Control-Allow-Origin）3. 日志中间件后置逻辑 → 记录 “请求处理完成，响应状态码 / 耗时”4. 异常中间件后置逻辑 → 无操作（无异常）5. 响应最终返回给前端</td></tr></tbody></table>
<p>简单说就是<strong>请求顺行，响应逆行</strong>。</p>
<p>为什么中间件会有这样<strong>请求顺行，响应逆行</strong>神奇的功能呢？我们接下来利用委托手搓一个咱们自己的中间件框架，看完你就明白为什么中间件的执行顺序是这样的。</p>
<h2 data-id="heading-2">二、手搓中间件框架</h2>
<h3 data-id="heading-3">2.1 框架准备</h3>
<p>首先我准备了一个类，名为<code>MethodInfo</code>，内部有一个核心方法<code>Show</code>，它接收一个<code>CustomContext</code>对象，返回一个<code>CustomContext</code>对象。</p>
<pre><code class="hljs language-cs" lang="cs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MethodInfo</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> CustomContext <span class="hljs-title">Show</span>(<span class="hljs-params">CustomContext context</span>)</span>
        {
            Console.WriteLine(&amp;<span class="hljs-meta">#34;这里执行了一个方法的核心内容！！！&amp;#34;);</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CustomContext();
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomContext</span>
    {

    }
</code></pre>
<p>为什么 <code>Show</code> 方法要接收 <code>CustomContext</code> 这样一个上下文对象呢？<strong>中间件框架的核心设计思想：用一个「统一的上下文对象」贯穿整个请求 / 响应链条，实现数据共享、状态传递、操作统一</strong>—— 这和 ASP.NET Core 的 <code>HttpContext</code>是完全一致的设计逻辑。</p>
<p>假设 <code>Show</code> 方法是中间件管道中的一个环节，若不用 <code>CustomContext</code>，而是传零散参数（比如 <code>token</code>、<code>requestPath</code>、<code>statusCode</code>），会出现这些致命问题：</p>
<ol>
<li><strong>参数爆炸</strong>：中间件需要的信息越多（请求头、用户信息、响应状态、临时数据），方法参数就越多（比如 <code>Show(string token, string path, int code, ...)</code>），维护成本极高；</li>
<li><strong>状态无法传递</strong>：前一个中间件（比如认证中间件）验证的 “用户是否登录” 状态，无法高效传递给后一个中间件（比如你的 <code>Show</code> 方法），只能通过返回值层层传递，链条长了会乱成一团；</li>
<li><strong>无法统一修改</strong>：后一个中间件修改的 “响应内容”，无法让前一个中间件（比如日志中间件）感知到，比如 <code>Show</code> 方法返回了错误信息，日志中间件无法知道；</li>
<li><strong>管道无法统一调度</strong>：中间件框架需要统一调用所有中间件（比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasp.net%2F" target="_blank" title="https://asp.net/" ref="nofollow noopener noreferrer">ASP.NET</a> Core 的 <code>RequestDelegate</code> 委托），若每个中间件的参数都不一样，框架无法设计统一的调用逻辑。</li>
</ol>
<ul>
<li>
<p><strong>真实框架（<a href="https://link.juejin.cn?target=https%3A%2F%2Fasp.net%2F" target="_blank" title="https://asp.net/" ref="nofollow noopener noreferrer">ASP.NET</a> Core）</strong> ：<code>HttpContext</code> 包含：</p>
<ul>
<li><code>Request</code>：URL、请求头、Query 参数、请求体、客户端 IP 等；</li>
<li><code>Response</code>：响应状态码、响应头、响应体、Cookie 等；</li>
<li><code>User</code>：认证后的用户信息（角色、权限）；</li>
<li><code>Items</code>：中间件间临时共享的键值对（比如 “请求开始时间”“限流计数”）；</li>
<li><code>Connection</code>：TCP 连接信息（端口、协议）。所有中间件都通过 <code>HttpContext</code> 访问这些数据，不用传一堆零散参数。</li>
</ul>
</li>
<li>
<p><strong>CustomContext（扩展后）</strong> ：<code>CustomContext</code> 虽然现在是空的，但实际场景中会扩展出核心字段：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomContext</span>
{
    <span class="hljs-comment">// 请求相关</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> RequestPath { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 比如 /user</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Token { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }       <span class="hljs-comment">// 认证Token</span>
    <span class="hljs-comment">// 响应相关</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> StatusCode { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-number">200</span>; <span class="hljs-comment">// 响应状态码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ResponseContent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 响应内容</span>
    <span class="hljs-comment">// 共享状态</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsAuthenticated { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 是否登录</span>
    <span class="hljs-keyword">public</span> DateTime RequestStartTime { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 请求开始时间</span>
}
</code></pre>
<p>为了简化理解中间件的框架，我们这里就暂且先用空的<code>CustomContext</code>上下文对象。</p>
</li>
</ul>
<h3 data-id="heading-4">2.2 初期框架</h3>
<p>思考一个问题，如果此时，我要在这个核心方法执行前加一个校验登录的方法，并且再执行后再添加一个校验登录的方法，还不可以修改核心代码，我们该怎么办？</p>
<p>这时候就要用到我们的<code>委托</code>了，别忘了委托的什么，<code>委托就是一个存储方法的盒子</code>，我们再这个盒子内部，像夹心饼干一样的，创建两个方法，把我们的核心代码包裹起来，一个放在核心代码之前，一个放在核心代码之后，这样就可以实现不修改核心代码，并且可以添加功能的效果了~</p>
<pre><code class="hljs language-cs" lang="cs">         MethodInfo invokeInfo = <span class="hljs-keyword">new</span> MethodInfo();

         CustomContext context = <span class="hljs-keyword">new</span> CustomContext();

         Func func = <span class="hljs-keyword">new</span> Func(invokeInfo.Show);
</code></pre>
<p>写到这一步又发现了问题：</p>
<ul>
<li><code>func委托</code>虽然可以利用<code>+=</code>操作往后添加其他的方法，但是无法在核心函数之前添加，只能往后追加</li>
<li>追加的函数一定要跟核心函数一样，接收<code>CustomContext对象</code>，返回<code>CustomContext对象</code></li>
<li/>
</ul>
<p>如果不符合上述的情况，就无法随便往后追加，所以直接用<code>+=</code>多播委托的方式显然行不通，那怎么办？</p>
<h3 data-id="heading-5">2.3 高级委托：委托的委托</h3>
<p>不妨换一个思路，如果我把这个原来的func委托<code>修改</code>了呢？</p>
<p>既然不让我往后追加，我自己把<code>func委托</code>拿到，然后在这个<code>func委托</code>前加个函数，在<code>func委托</code>后再加一个函数，不就行了吗？</p>
<p>问题是我们要如何拿到这个<code>func委托</code>，有没有一种方法，能把<strong>现在的func委托传进去，然后再把新的加工过的func委托返回来的方法呢？</strong></p>
<p>这时候就要用到我们的高级委托了</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 创建核心方法的实例</span>
MethodInfo invokeInfo = <span class="hljs-keyword">new</span> MethodInfo();

<span class="hljs-comment">// 创建上下文</span>
CustomContext context = <span class="hljs-keyword">new</span> CustomContext();

<span class="hljs-comment">// 创建初级委托，接收上下文对象，返回上下文对象</span>
Func func = <span class="hljs-keyword">new</span> Func(invokeInfo.Show);

<span class="hljs-comment">// 定义中间件1：接收“下一个环节的委托”，返回“包装后的委托”</span>
Func, Func&gt; middleWare1 =
    <span class="hljs-keyword">new</span> Func, Func&gt;(next =&gt;
    {
        <span class="hljs-comment">// 中间件的核心：返回一个“包装后的委托”（包含前置+后置逻辑）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Func(context =&gt;
        {
            <span class="hljs-comment">// 1. 前置方法：请求进入中间件时执行（对应 ASP.NET Core await next() 之前）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中间件1的前置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 2. 调用“下一个环节”（核心业务/下一个中间件），并传递上下文</span>
            CustomContext resultContext = next.Invoke(context);
            
            <span class="hljs-comment">// 3. 后置方法：下一个环节执行完成后执行（对应 ASP.NET Core await next() 之后）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件1的后置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 4. 返回处理后的上下文</span>
            <span class="hljs-keyword">return</span> resultContext;
        });
    });
</code></pre>
<p>这里我创建了一个<code>middleWare1</code>的高级委托，它接收一个<code>Func</code>的低级委托，返回一个<code>Func</code>的低级委托，这个低级委托其实就是我们上面说的<code>func</code>委托，现在我们就可以把<code>func</code>委托传进去，然后让<code>middleWare</code>给我们生成一个新的委托了。</p>
<p><strong>如何把<code>func</code>委托传进去，生成一个新的委托呢？</strong></p>
<pre><code class="hljs language-cs" lang="cs">next =&gt;
    {
        <span class="hljs-comment">// 中间件的核心：返回一个“包装后的委托”（包含前置+后置逻辑）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Func(context =&gt;
        {
            <span class="hljs-comment">// 1. 前置方法：请求进入中间件时执行（对应 ASP.NET Core await next() 之前）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中 间件1的前置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 2. 调用“下一个环节”（核心业务/下一个中间件），并传递上下文</span>
            CustomContext resultContext = next.Invoke(context);
            
            <span class="hljs-comment">// 3. 后置方法：下一个环节执行完成后执行（对应 ASP.NET Core await next() 之后）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件1的后置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 4. 返回处理后的上下文</span>
            <span class="hljs-keyword">return</span> resultContext;
        });
    }
</code></pre>
<p>注意看我这里用了一个Lamade表达式，它将接收的委托<code>next</code>变成一个新的式子委托：<code>return new Func(context =&gt;</code>这个新的委托可以从代码看出:</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">new</span> Func(context =&gt;
        {
            <span class="hljs-comment">// 1. 前置方法：请求进入中间件时执行（对应 ASP.NET Core await next() 之前）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中 间件1的前置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 2. 调用“下一个环节”（核心业务/下一个中间件），并传递上下文</span>
            CustomContext resultContext = next.Invoke(context);
            
            <span class="hljs-comment">// 3. 后置方法：下一个环节执行完成后执行（对应 ASP.NET Core await next() 之后）</span>
            Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件1的后置方法&amp;#34;);</span>
            
            <span class="hljs-comment">// 4. 返回处理后的上下文</span>
            <span class="hljs-keyword">return</span> resultContext;
        });
</code></pre>
<p>这个委托的方法其实就是在原来的基础上，给原来的委托套上前置方法和后置方法。我们来看一下如何调用。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">//  用中间件1包装核心业务委托 → 得到“包含中间件逻辑+核心业务”的新委托</span>
<span class="hljs-keyword">var</span> func1 = middleWare1.Invoke(func);

<span class="hljs-comment">//  执行包装后的委托（触发完整的中间件流程）</span>
<span class="hljs-keyword">var</span> customContext = func1.Invoke(context);
</code></pre>
<p>当执行<code> func1.Invoke(context);</code>后，<code>context</code>上下文会通过前置函数-&gt;核心函数-&gt;后置函数执行。</p>
<p>我们再添加一个中间件时，情况会有所变化。</p>
<pre><code class="hljs language-cs" lang="cs">            MethodInfo invokeInfo = <span class="hljs-keyword">new</span> MethodInfo();

            CustomContext context = <span class="hljs-keyword">new</span> CustomContext();

            Func func = <span class="hljs-keyword">new</span> Func(invokeInfo.Show);

            Func, Func&gt; middleWare1 =
                <span class="hljs-keyword">new</span> Func, Func&gt;(next =&gt;
                {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Func(context =&gt;
                    {
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中间件1的前置方法&amp;#34;);</span>
                        CustomContext resultContext = next.Invoke(context);
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件1的后置方法&amp;#34;);</span>
                        <span class="hljs-keyword">return</span> resultContext;
                    });
                });
            Func, Func&gt; middleWare2 =
                <span class="hljs-keyword">new</span> Func, Func&gt;(next =&gt;
                {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Func(context =&gt;
                    {
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中间件2的前置方法&amp;#34;);</span>
                        CustomContext resultContext = next.Invoke(context);
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件2的后置方法&amp;#34;);</span>
                        <span class="hljs-keyword">return</span> resultContext;
                    });
                });
            Func, Func&gt; middleWare3 =
                <span class="hljs-keyword">new</span> Func, Func&gt;(next =&gt;
                {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Func(context =&gt;
                    {
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;执行中间件3的前置方法&amp;#34;);</span>
                        CustomContext resultContext = next.Invoke(context);
                        Console.WriteLine(&amp;<span class="hljs-meta">#34;我是中间件3的后置方法&amp;#34;);</span>
                        <span class="hljs-keyword">return</span> resultContext;
                    });
                });

            <span class="hljs-keyword">var</span> func1 = middleWare1.Invoke(func);
            <span class="hljs-keyword">var</span> func2 = middleWare2.Invoke(func1);
            <span class="hljs-keyword">var</span> func3 = middleWare3.Invoke(func2);
            <span class="hljs-keyword">var</span> customContext = func3.Invoke(context);
</code></pre>
<p>此时我们可以看到，原来的核心代码，被middlewa1中间件包裹后，又被middlewa2中间件包裹，又被middlewa3中间件包裹，当我们执行func3.Invoke(context)时，执行顺序是：</p>
<ol>
<li>执行委托3：<code>func3.Invoke(context)</code></li>
<li>执行委托3的前置方法：<code>Console.WriteLine(&amp;#34;执行中间件3的前置方法&amp;#34;);</code></li>
<li>执行<code>next.Invoke(context);</code>进入委托2</li>
<li>执行委托2的前置方法：<code>Console.WriteLine(&amp;#34;执行中间件2的前置方法&amp;#34;);</code></li>
<li>执行<code>next.Invoke(context);</code>进入委托1</li>
<li>执行委托1的前置方法：<code>Console.WriteLine(&amp;#34;执行中间件1的前置方法&amp;#34;);</code></li>
<li>执行核心方法</li>
<li>执行委托1的后置方法：<code>Console.WriteLine(&amp;#34;执行中间件1的后置方法&amp;#34;);</code></li>
<li>退回到委托2，执行委托2后置方法：<code>Console.WriteLine(&amp;#34;执行中间件2的后置方法&amp;#34;);</code></li>
<li>退回到委托3，执行委托3后置方法：<code>Console.WriteLine(&amp;#34;执行中间件3的后置方法&amp;#34;);</code></li>
<li>退出委托3</li>
</ol>
<p>以上就是函数执行的全部过程，结果为：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e37f33302d5d4193a69b3ace0ed4088d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5ou_5b6u6L2vTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765969658&amp;x-signature=OrT1nAh08OskvP83oI62e37l8Rw%3D" alt="image.png" loading="lazy"/></p>
<p>跟我们一开始说的中间件的允许流程<strong>请求顺行，响应逆行</strong>保持一致，至此我们就顺利的写出了我们自己的中间件框架，虽然不够完善，但是有利于让大家理解中间件。后续我会封装一套完整的中间件框架，敬请期待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KotlinInline关键字]]></title>    <link>https://juejin.cn/post/7582021506190065710</link>    <guid>https://juejin.cn/post/7582021506190065710</guid>    <pubDate>2025-12-10T11:58:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582021506190065710" data-draft-id="7582041304654708782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KotlinInline关键字"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2025-12-10T11:58:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户98512003583"/> <meta itemprop="url" content="https://juejin.cn/user/1927871600799337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KotlinInline关键字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927871600799337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户98512003583
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:58:52.000Z" title="Wed Dec 10 2025 11:58:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Kotlin</code> 中的内联函数（Inline Function）是一种特殊的函数，与普通函数不同, 编译器会在编译时将内联函数中的代码插入到调用处, 避免函数调用的开销。它的作用和 <code>C++</code> 中的内联函数类似，都是为了提高代码的执行效率。</p>
<h2 data-id="heading-0">定义内联函数</h2>
<p><code>内联函数</code> 的定义和普通函数类似, 只是在函数名前添加 <code>inline</code> 关键字即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inlineFunction</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    println(&amp;#<span class="hljs-number">34</span>;Inline function&amp;#<span class="hljs-number">34</span>;)
    block()
}
</code></pre>
<p>从语法上看，调用方式和普通函数相似</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    inlineFunction {
        println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
    }
}
</code></pre>
<p>以上代码与下面的代码在执行效果上完全一致</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(&amp;#<span class="hljs-number">34</span>;Inline function&amp;#<span class="hljs-number">34</span>;)
    println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
}
</code></pre>
<h2 data-id="heading-1">内联函数的return</h2>
<p><code>kotlin</code> 的 <code>lambda</code> 表达式return必须使用 <code>return@scope</code> 来指定返回的作用域，由于内联函数的代码会被插入到调用处，所以内联函数可以使用 return 而不必须添加@限定符。比如</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    inlineFunction {
        println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
        <span class="hljs-keyword">return</span>
    }
}
</code></pre>
<p>而普通函数则必须使用 <code>return@scope</code> 来返回, 比如</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    normalFunction {
        println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@normalFunction</span>
    }
}
</code></pre>
<p>为什么？因为<code>内联函数</code>的代码会被插入到调用处，所以上面的<code>内联函数</code>返回就相当于</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(&amp;#<span class="hljs-number">34</span>;Inline function&amp;#<span class="hljs-number">34</span>;)
    println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
    <span class="hljs-comment">// 这里的return是可以不添加限定符直接返回的</span>
    <span class="hljs-keyword">return</span>
}
</code></pre>
<h3 data-id="heading-2">Kotlin 中的 return</h3>
<p>从上面对<code>内联函数</code>的描述中，我们可以思考一个问题：什么时候return不需要添加@限定符呢？</p>
<ol>
<li>当内联函数的lambda参数在顶层函数中被调用时，此时不添加限定符，return 就相当于直接返回顶层函数。</li>
<li>匿名函数中的return, 也不需要添加@限定符</li>
</ol>
<p>内联函数在非内联函数中调用的时候, 就需要使用@限定符来指定返回的作用域。比如</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    normalFunction {
        inlineFunction {
            println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
            <span class="hljs-comment">// 表示返回到inlineFunction</span>
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@inlineFunction</span>
            
            <span class="hljs-comment">// 或者返回到normalFunction</span>
            <span class="hljs-comment">// return@normalFunction</span>
        }
    }
    inlineFunction {
        println(&amp;#<span class="hljs-number">34</span>;Hello, World!&amp;#<span class="hljs-number">34</span>;)
        <span class="hljs-comment">// 直接返回到顶层函数，不需要添加@限定符</span>
        <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment">// 或者返回到normalFunction</span>
        <span class="hljs-comment">// return@normalFunction</span>
    }

    inlineFunction {
        inlineFunction {
            <span class="hljs-comment">// 直接返回到顶层函数，可以不添加@限定符</span>
            <span class="hljs-keyword">return</span>
            
            <span class="hljs-comment">// 或者返回到inlineFunction</span>
            <span class="hljs-comment">// return@inlineFunction</span>
        }
    }

    normalFunction(<span class="hljs-function"><span class="hljs-title">fun</span> <span class="hljs-params">()</span></span>:<span class="hljs-built_in">Unit</span> {
        <span class="hljs-comment">// 匿名函数中的return, 不需要添加@限定符</span>
        <span class="hljs-keyword">return</span>
    })
}
</code></pre>
<p>但是这里有一个问题，加了@限定符的return和不加@限定符的return有什么区别呢？</p>
<ul>
<li>如果加了限定符，退出的只是当前作用域</li>
<li>而不加限定符，退出的是整个函数</li>
</ul>
<h3 data-id="heading-3">Kotlin 中的 return 设计</h3>
<p>那么，为什么Kotlin要设计成这样呢？为什么不设计的和Java一样，return返回的只是当前的作用域呢？目的有两个</p>
<ol>
<li>增加比Java代码更大的灵活性</li>
<li>避免使用内联函数时的逻辑混淆</li>
</ol>
<h4 data-id="heading-4">1. 增加比Java代码更大的灵活性</h4>
<p>Java代码中，lambda表达式中的return只能返回当前lambda作用域，而Kotlin中的return可以返回任意作用域。这就增加了比Java代码更大的灵活性。</p>
<p>比如我们有一个需求，遍历一个列表，如果符合条件，终止遍历，我们看看在<code>Java</code>中怎么实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">breakOnCondition</span><span class="hljs-params">(List list, Predicate predicate)</span> {
    <span class="hljs-keyword">for</span> (T t : list) {
        <span class="hljs-keyword">if</span> (predicate.test(t)) {
            <span class="hljs-keyword">return</span>;
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
    breakOnCondition(list, i -&gt; i == <span class="hljs-number">3</span>);
}

</code></pre>
<p>那么，在Kotlin中我们甚至不需要这样设计。对于遍历场景，我们可以直接使用lambda表达式结合 return@scope 来终止当前遍历操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    list.forEach {
        <span class="hljs-keyword">if</span> (it == <span class="hljs-number">3</span>) {
            <span class="hljs-comment">// 直接返回forEach循环</span>
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@forEach</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-5">2. 避免使用内联函数时的逻辑混淆</h4>
<p>如果可以不带有@限定符，那么用户在编写代码的时候，很难确定程序的行为，比如下面的代码</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">normalFunction</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> = block()
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inlineFunction</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> = block()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    normalFunction {
        <span class="hljs-comment">// 这里是无法编译通过的，我们假定可以通过</span>
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 会被执行</span>
    println(&amp;#<span class="hljs-number">34</span>;After normalFunction&amp;#<span class="hljs-number">34</span>;)
    inlineFunction {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 不会被执行</span>
    println(&amp;#<span class="hljs-number">34</span>;After inlineFunction&amp;#<span class="hljs-number">34</span>;)
}
</code></pre>
<p>假设上面的代码正确，并且可以编译通过。
这里的 normalFunction 中的return，结束的是 normalFunction 函数。
而 inlineFunction 中的return，结束的却是main函数，因为inlineFunction 中的代码会被插入到调用处，所以inlineFunction 中的return 就相当于直接返回main函数。</p>
<p>那么用户在编写代码的时候，就很容易混淆。</p>
<p>而如果非内联函数的lambda参数要求只能使用return@scope来返回，就会避免这种容易混淆的情况。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    normalFunction {
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@normalFunction</span>
    }
    <span class="hljs-comment">// 会被执行</span>
    println(&amp;#<span class="hljs-number">34</span>;After normalFunction&amp;#<span class="hljs-number">34</span>;)

    inlineFunction {
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@inlineFunction</span>
    }
    <span class="hljs-comment">// 会被执行</span>
    println(&amp;#<span class="hljs-number">34</span>;After inlineFunction&amp;#<span class="hljs-number">34</span>;)

    inlineFunction {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 不会被执行</span>
    println(&amp;#<span class="hljs-number">34</span>;After inlineFunction&amp;#<span class="hljs-number">34</span>;)
}
</code></pre>
<h2 data-id="heading-6">reified 类型参数</h2>
<p>reified 类型参数是Kotlin中一种特殊的类型参数，它可以在运行时获取到类型信息。还记得Java中怎么获取泛型类型吗？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span>  T <span class="hljs-title function_">parseObj</span><span class="hljs-params">(String json, Class clazz)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>().fromJson(json, clazz);
}
</code></pre>
<p>在Java中，我们必须添加 Class\ clazz 参数来指定泛型类型。否则，我们无法在运行时获取到泛型类型。因为Java代码中如果没有和泛型相关的对象传入进来的话，是无法在运行时获取到泛型类型的。</p>
<p>但是在<code>Kotlin</code>的内联函数中，提供了reified 类型参数，它可以在函数不提供参数信息情况下，获取到泛型类型。比如下面的代码</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span>  <span class="hljs-title">parseObj</span><span class="hljs-params">(json: <span class="hljs-type">String</span>)</span></span>: T {
    <span class="hljs-keyword">return</span> new Gson().fromJson(json, T::<span class="hljs-keyword">class</span>.java)
}
</code></pre>
<p>想象一下这个参数可以给我们带来多大的便利性，我们可以直接在函数中使用T::class.java来获取到泛型类型，而不需要传入Class\ clazz 参数。
<code>MybatisPlus</code> 提供了 KtQueryChainWrapper 类,通过这个类，可以通过lambda的方式构建查询参数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> baseMapper: BaseMapper

<span class="hljs-keyword">val</span> chain = KtQueryChainWrapper(baseMapper, entityClass=Config::<span class="hljs-keyword">class</span>.java)
<span class="hljs-keyword">val</span> config = chain.eq(Config::name, &amp;#<span class="hljs-number">34</span>;test&amp;#<span class="hljs-number">34</span>;).one()
</code></pre>
<p>为了方便，我们可以为 BaseMapper 添加一个扩展方法，来获取 KtQueryChainWrapper 类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span>  BaseMapper.<span class="hljs-title">query</span><span class="hljs-params">()</span></span>: KtQueryChainWrapper {
    <span class="hljs-comment">// 很要命的是 mybatisplus 要求必须填写 entityClass 参数，否则会报错</span>
    <span class="hljs-keyword">return</span> KtQueryChainWrapper(baseMapper = <span class="hljs-keyword">this</span>, entityClass = entityClass())  
}

<span class="hljs-comment">// 使用的时候就会很方便</span>
<span class="hljs-keyword">val</span> config = baseMapper.query().eq(Config::name, &amp;#<span class="hljs-number">34</span>;test&amp;#<span class="hljs-number">34</span>;).one()
</code></pre>
<p>但是，怎么获取 entityClass 呢？如果没有 reified 关键字， 我们只能通过反射来获取。比如下面的代码</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span>  BaseMapper.<span class="hljs-title">entityClass</span><span class="hljs-params">()</span></span>: Class {  
    <span class="hljs-keyword">val</span> searchEntityClass = javaClass.searchEntityClass()  
    <span class="hljs-keyword">if</span> (searchEntityClass != <span class="hljs-literal">null</span>) {  
        <span class="hljs-keyword">return</span> searchEntityClass  
    }  
    <span class="hljs-keyword">throw</span> IllegalArgumentException(&amp;#<span class="hljs-number">34</span>;无法获取实体类&amp;#<span class="hljs-number">34</span>;)  
}
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span>  Class<span class="hljs-type">&lt;*&gt;</span>.<span class="hljs-title">searchEntityClass</span><span class="hljs-params">()</span></span>: Class? {
    <span class="hljs-keyword">for</span> (type <span class="hljs-keyword">in</span> genericInterfaces) {
        <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">is</span> ParameterizedType) {
            <span class="hljs-keyword">if</span> (type.rawType == BaseMapper::<span class="hljs-keyword">class</span>.java) {
                <span class="hljs-keyword">return</span> type.actualTypeArguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> Class
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">is</span> Class&lt;*&gt;) {
                <span class="hljs-keyword">return</span> type.searchEntityClass()
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

}
</code></pre>
<p>这时候如果我们使用 <code>内联函数</code> + reified 类型参数，就可以避免使用反射来获取泛型类型。比如下面的代码</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span>  BaseMapper.<span class="hljs-title">query</span><span class="hljs-params">()</span></span>: KtQueryChainWrapper {
    <span class="hljs-comment">// 在使用了reified 类型参数后，就可以直接使用 T::class.java 来获取泛型类型</span>
    <span class="hljs-keyword">return</span> KtQueryChainWrapper(baseMapper = <span class="hljs-keyword">this</span>, entityClass = T::<span class="hljs-keyword">class</span>.java)  
}
</code></pre>
<p>可以看到，使用了 reified 类型参数后，就可以直接使用 T::class.java 来获取泛型类型，而不需要通过反射来获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>