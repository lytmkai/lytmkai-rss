<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？]]></title>    <link>https://juejin.cn/post/7600999271770341376</link>    <guid>https://juejin.cn/post/7600999271770341376</guid>    <pubDate>2026-01-31T07:07:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600999271770341376" data-draft-id="7601018079620612111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T07:07:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林coding"/> <meta itemprop="url" content="https://juejin.cn/user/1750078243734029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078243734029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:07:58.000Z" title="Sat Jan 31 2026 07:07:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">多节点争抢资源， Redis 分布式锁是怎么实现的？</h2>
<p>大家好，今天给大家分享 Redis 里的一个知识点 — Redis 分布式锁。</p>
<p><strong>在分布式系统的世界里，Redis 就像一座高效运转的共享仓库</strong> — 多个节点通过共享数据协同发力，左手接过业务系统的海量读写请求，右手以毫秒级速度完成数据交付。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b8e5942e4b7439dbdf3a911a642b973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=cLjG0a%2BPRLw%2FXLxtzn%2FlKj18tEk%3D" alt="图片" loading="lazy"/></p>
<p>可再默契的团队，如果没有统一的行动准则，也难免遇到“抢活干”的问题。而 Redis 分布式锁，就像是分布式世界里的 “秩序守护者”。它会清晰地告诉每个节点：</p>
<p><strong>什么时候能操作数据、能不能同时操作，把数据操作的边界和顺序划分得明明白白，从根源上杜绝争抢。</strong></p>
<p>接下来，我们就来看看 — Redis 分布式锁是怎么给多节点系统 “立规矩” 的。</p>
<h3 data-id="heading-1">谁在给 Redis 锁制造冲突？</h3>
<p>Redis 锁的核心目标，是在分布式环境中建立"共享资源访问规则"，让锁机制井然有序运行。但在实际落地时，总有些问题在制造冲突：</p>
<h4 data-id="heading-2"><strong>问题一：锁争抢 — 多人抢同一把锁，导致数据错乱</strong></h4>
<p>节点想要拿到锁，得经历两步操作：</p>
<p><strong>先判断这把锁当前有没有被人占用，确认空闲后再动手抢占锁。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e1c99f39e86408f8ccba4b03fa78801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=PP87Yp%2FstrXKiEUno7iUXjcoz9g%3D" alt="图片" loading="lazy"/></p>
<p>但问题恰恰出在这两步是分开做的 — 哪怕中间只隔了一瞬间的空隙，也足以埋下隐患。</p>
<p>想象一下这样的场景：有好几个节点同时要抢同一把锁。节点 A 先查询了锁的状态，发现 “没人占用”，正准备动手抢占时，节点 B 几乎在同一时间也查了锁的状态，得到了同样的结果。</p>
<p><strong>接下来，两个节点都顺利完成了抢占操作，以至于每个节点都觉得自己抢到了唯一的锁。</strong> 进而同时去操作同一个共享资源，最终引发数据错乱、操作冲突。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f66119c9f8f48979c684ff6f670f7d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=FMX0vlpTrA3UD%2B%2BTE4YGYnWOMy4%3D" alt="图片" loading="lazy"/></p>
<p>锁争抢就是典型的“多人抢锁”乱象，而当锁被某一节点占用后，又可能面临「锁不释放」的情况，这便是“僵尸锁”带来的挑战。</p>
<h4 data-id="heading-3"><strong>问题二：僵尸锁 — 锁不释放，导致业务流程阻塞</strong></h4>
<p>某个节点拿到锁后，粗心地忘了给锁设定过期时间，紧接着又因为节点宕机或程序报错，没法主动释放这把锁。</p>
<p><strong>于是这条锁记录就彻底赖在 Redis 里不走了，变成没人管的 “僵尸锁”</strong> — 牢牢霸占着对应的共享资源，后面不管哪个节点想操作这个资源，全被它拦在门外，直接影响整个系统正常干活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9a7ca5685914e74ba2edc4f311ed93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=nY3ShMQeOSldclx3%2BM7pSKW2DzY%3D" alt="图片" loading="lazy"/></p>
<p>为了解决“僵尸”锁问题，给锁设置过期时间成为必然选择，但这一解决方案又会催生新的矛盾，即锁过期的问题。</p>
<h4 data-id="heading-4"><strong>问题三：锁过期 — 过期时间与任务时长不匹配</strong></h4>
<p>某个节点拿到锁并且设置完过期时间后，马上投入业务处理，可偏偏业务还没做完，锁的过期时间就到了。</p>
<p>Redis 见状直接自动释放了锁，而原来拿锁的节点对此毫无察觉，还在闷头干活。这时，其他节点一看锁没了，立刻一拥而上把锁抢到手，然后操作同一个资源 — <strong>结果就是两个节点同时改一个数据，直接造成并发冲突。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ffd17aae7841b2b4dde3173051c346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=LrCcH3yQvrKIhE%2BNfr7%2BgrpZtdQ%3D" alt="图片" loading="lazy"/></p>
<p>但无论是锁争抢、僵尸锁，还是锁过期导致的冲突，都有一个前提：<strong>锁的存储节点足够稳定。</strong> 而当 Redis 架构本身出现隐患时，上述所有问题都可能升级为影响整个系统的故障。</p>
<h4 data-id="heading-5"><strong>问题四：锁存储不可靠 — 单节点部署的隐患</strong></h4>
<p>当存储分布式锁的 Redis 只用单节点部署时，无异于把所有 “锁管理大权” 交给了唯一的管理员。一旦这个管理员突然 “罢工”（比如宕机），那么所有加锁、解锁、查锁状态的操作都会彻底卡壳，直接导致整个分布式锁机制瘫痪。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/082d1d1ef93e43f9b74a02607da4ba98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=HyqxKo5idEewq5JTel10zxMH0NM%3D" alt="图片" loading="lazy"/></p>
<p>到头来，共享资源要么没人敢碰，要么大家一窝蜂乱抢，场面完全失控。</p>
<p>这些问题就像横亘在我们面前的四座大山，要构建可靠的分布式锁，就必须逐一攻克。接下来，我们就来看业务层面如何借助 Redis 的核心特性来实现分布式锁的。</p>
<h3 data-id="heading-6">Redis 锁的“秩序构建术”</h3>
<p>面对分布式环境的复杂挑战，Redis 锁通过分层设计构建了一套完整的"秩序体系"。从加锁到释放锁，每个环节都蕴含着精妙的设计思想。</p>
<h4 data-id="heading-7">1、加锁机制：从单节点到高可用</h4>
<p>加锁的核心目标是保证同一时间只有一个业务能操作共享资源，Redis 锁通过两层设计来实现这个目标：</p>
<h5 data-id="heading-8"><strong>第一层：单节点锁 — 破解“锁争抢”和“僵尸锁”</strong></h5>
<p>Redis 单节点锁的核心命令看似简单：<strong>SET lock_key unique_value NX EX 30。</strong> 但这条命令里藏着解决两大基础难题的巧思。我们逐一拆开来看：</p>
<p>先看 unique_value，它是给每个节点生成的唯一标识，就像给每个节点发了一张专属入场券。释放锁的时候，节点必须出示这张入场券，只有校验通过，才能删除自己持有的锁，绝不会误删别人的锁。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b0018c43c024f3595f7ec732de17771~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=O%2Bcaajp%2F13TRZMBnZEtsjvXsoEw%3D" alt="图片" loading="lazy"/></p>
<p>再看 NX（Not eXists），它的意思是仅当锁对应的 lock_key 不存在时，才执行加锁操作。这就像只有空座位才能入座，直接保证了锁的互斥性 — 同一时间，只有一个节点能成功获取锁，从根源上解决了大家抢着用资源的锁争抢问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54d07138cc8046a598c898f5beeca4e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=6oxfNv979x7RYsdSnLP6FUI9RKU%3D" alt="图片" loading="lazy"/></p>
<p>然后是 EX 30，它的作用是给锁设置 30 秒的过期时间。好比座位有最长占用时限，超时后自动 “让座”，不会一直占着资源不释放，从根本上避免了节点宕机等异常情况导致的“僵尸锁”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a81e6d6157144c0ad94699dd91848c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=0hy2mcGzgZQclmTQO2VDukvo55Q%3D" alt="图片" loading="lazy"/></p>
<p>而这条 SET 命令的关键，就是把抢锁（NX）和设过期时间（EX），变成了一步完成的原子操作，中间没有任何可中断的间隙：</p>
<p><strong>要么</strong> ***** *指令未执行，<strong><strong>锁没抢到；要么</strong></strong>指令完整执行，**<strong>抢到的锁已经自带过期时间。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880940ce307d40649577b26c3bfb5814~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=o6NToasotnpO3wd8%2FALtdWoXzt8%3D" alt="图片" loading="lazy"/></p>
<p>这就从机制上杜绝了因分步执行而引发的各类异常。</p>
<p>不过单节点 Redis 锁虽然简单高效，但存在一个致命弱点：<strong>如果 Redis 节点宕机，整个锁机制就会失效。</strong> 因此，为了提升锁机制的高可用性，需要一种能突破单节点依赖的解决方案 — 高可用锁。</p>
<h5 data-id="heading-9"><strong>第二层：高可用锁 —</strong> <strong>解决单点依赖</strong></h5>
<p>为了破解单节点锁的可用性瓶颈，Redis 的作者 Antirez 提出了 Redlock 算法。其核心思想是：</p>
<p><strong>给 Redis 锁部署至少 3 个独立的节点（实际常用 5 个），只有超过半数节点都成功给资源加锁时，资源才算真的拿到了有效锁。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67b3c92f6c84806871d5cdbf1fcf634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=etw89iF1%2Fa6fPsHTJijAolA9mxI%3D" alt="图片" loading="lazy"/></p>
<p>Redlock 算法的执行步骤如下：</p>
<ol>
<li>向 N 个独立的 Redis 锁节点依次发送 <code>SET NX EX</code> 加锁请求，实际应用中通常会部署 5 个；</li>
<li>统计成功给资源加锁的节点数量，若成功数量超过 N/2，比如部署 5 个节点时至少有 3 个成功，就判定加锁成功；</li>
<li>如果成功数量少于半数，则说明加锁失败，立即向所有锁节点释放锁，避免产生"僵尸锁"。</li>
</ol>
<p>这种设计的精妙之处在于，即便部分锁节点宕机（不超过半数），剩余的多数锁节点仍能正常提供锁服务，从根本上规避了单点故障风险。这就像开会投票，只要超过半数人同意，决议就能生效，少数人的缺席不会影响整体决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4d0368df6c4b3ebfbd445374503ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=19gaFmSh5MFPzQpEeL74PaR8dIo%3D" alt="图片" loading="lazy"/></p>
<p>通过 Redlock 算法的加锁机制，我们确保了分布式环境下资源的互斥访问，但锁的释放环节同样需要谨慎处理，毕竟一旦释放逻辑出现疏漏，就可能引发新的并发混乱。</p>
<h4 data-id="heading-10">2、释放锁机制：先 “验身份” 再删锁</h4>
<p>先前加锁时，我们会针对要保护的共享资源，在锁节点存入一把 “带身份标识的锁” — unique_value，就像给这把锁刻上了自己的 “专属名字”。等业务要释放共享资源时，不能直接删锁，得先去锁节点验证：</p>
<p><strong>“这把锁是不是我的？”</strong></p>
<p>确认无误后，才能删除锁，也就是真正释放锁。</p>
<p>但这里有个关键问题：如果 “先查身份、再删锁” 分成两步做，中间就会有个 “时间差漏洞”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031f1a150fd4452e9ea0d143b150cbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=IugstHWOFWzGyv%2Frou1SWvACTI8%3D" alt="图片" loading="lazy"/></p>
<p>比如你刚查完，确认这把锁是自己的，可还没来得及删，这把锁的过期时间就到了，系统自动把它释放了；而就在这一瞬间，其他业务刚好抢到了这把锁。等你反应过来执行删除操作时，删的已经不是自己的锁，而是别人刚抢到的新锁了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6970c2962a64fcd89d2e2c873f029ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=eIbcaMcCNl4XSoluMePOZ%2FvLCJM%3D" alt="图片" loading="lazy"/></p>
<p>这一下就出大问题了：<strong>不仅误删了别人的锁，还让共享资源失去了保护</strong> — 没有锁的约束，其他业务可能会一窝蜂地操作这个资源，最后很可能导致数据错乱。</p>
<p>为了规避这种风险，Redis 提供了 Lua 脚本支持，能将判断和删除这两个操作封装成一个原子操作。对应的脚本如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d9f12d8ae7941e898cea83c42d60cbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=Vxw78sUJ8Z9GCFrKXRXTz9FveZU%3D" alt="图片" loading="lazy"/></p>
<p>这段脚本相当于让 「验锁 + 删锁」 一步到位，安全可靠！</p>
<p>最终，从单节点锁到 Redlock 算法，从加锁到释放锁，Redis 为我们构建了完整的分布式锁理论基础。接下来，我们将这些理论转化为实践，看看如何在项目中正确落地。</p>
<h3 data-id="heading-11">Redis 锁的落地指南</h3>
<p>分布式锁的落地从来不是一刀切的，而是要"因地制宜" — 简单场景用单节点锁高效落地，核心业务靠高可用锁保驾护航。下面我们结合不同的业务场景，拆解对应的 Redis 锁实践方案：</p>
<h4 data-id="heading-12">1、简单场景：单节点锁轻量高效</h4>
<p>如果你的业务不是支付、下单这种核心场景，那单节点 Redis 锁就完全够用了，简单还不占资源。例如我们要给 1001 号商品的库存加锁，核心命令如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e2e6eefce44698b78b3d5c2cb3fd13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=2Zh6oFqoYGkPDhe7yGM%2FCObG4ZY%3D" alt="图片" loading="lazy"/></p>
<p>使用时需要注意三个关键细节，不然容易出问题：</p>
<p><strong>第一个细节是 unique_value 必须独一无二。</strong></p>
<p>命令里的 "node1_uuid_12345" 可不是随便填的字符串，它是每个加锁请求的专属 “身份证”，得保证全网唯一。核心目的就是让后续解锁时，能准确识别出 “这把锁是我加的”，避免误解锁别人的锁。</p>
<p><strong>第二个是过期时间 <code>EX 30 </code>的设置，得合理预留缓冲。</strong></p>
<p>比如你预估一个任务平均 10 秒能完成，那过期时间就别设 10 秒，建议设 30 秒。多出来的 20 秒是缓冲，万一某个任务因为网络延迟、数据量稍大慢了点，也不会出现 “任务还没做完，锁就过期了” 的情况。</p>
<p><strong>第三个是加锁失败后别做无效等待。</strong></p>
<p>如果执行上面的 SET 命令后，返回的是<code>nil，说明锁已经被别人占用了。这时候别一直死等，要么设置最多重试 3 次（每次间隔几百毫秒），要么直接返回 “操作失败，请稍后再试”，避免浪费服务器资源。</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef37c653312442a5863383fed6bb6a9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=LlyX4r7vOrthp16RsQPZN0LGn7E%3D" alt="图片" loading="lazy"/></p>
<p>基础版的单节点锁用起来简单又高效，但如果任务执行时间不确定，很可能出现“任务还没做完，锁就过期了”的情况。这时，“看门狗（Watch Dog）” 机制就能派上用场。</p>
<h4 data-id="heading-13">2、长任务场景：用“看门狗”给锁自动续期</h4>
<p>看门狗机制的工作原理其实很简单：</p>
<p>当业务节点成功抢到锁之后，系统会在这个节点上启动一个后台线程，就像给业务栓了一只尽职尽责的看门狗。这只 “看门狗” 会按固定时间（比如每隔 10 秒）主动检查：</p>
<p><strong>“主人，你还在使用这把锁吗？”</strong></p>
<p>如果发现业务还在正常执行，它就会立刻给锁 “续期”，比如把锁的过期时间再延长 30 秒，不让锁提前过期被别人抢走。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d3a0ff5bde4e5aab508c2c01c284a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=NgAw0N9aZ9aNW3gtfBAnpgSVufw%3D" alt="图片" loading="lazy"/></p>
<p>目前主流的开源框架 Redisson 已经内置了这个看门狗机制，使用起来十分便捷。</p>
<p>不过要注意，不管是基础版单节点锁，还是带看门狗的锁，都只是解决了单节点场景的锁问题。如果是支付、下单这类核心业务，我们需要更高的可用性保障，这时候基于<strong>Redlock 算法</strong>的高可用部署方案就成了首选。</p>
<h4 data-id="heading-14">3、核心场景：高可用锁守住业务“生命线”</h4>
<p>针对支付、下单等核心业务场景，建议直接采用 Redlock 算法，并部署至少 3 个独立的 Redis 锁节点。具体部署建议如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dc877311f6d44baa97ba3b522ef2746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=75GfxDjuodiDdz%2FtUrVMt00B9x0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>节点数量选择奇数</strong>：优先选择 3、5、7 个节点，便于快速计算 “超过半数” 的成功条件，确保锁机制的有效性；</li>
<li><strong>保证节点独立性</strong>：节点之间不能有主从复制关系，最好分布在不同物理机或机房，避免因机房断电、网络故障等问题导致多个节点同时失效；</li>
<li><strong>合理设置请求超时</strong>：向每个节点发送加锁请求时，建议设置 50-100ms 的超时时间，避免单个节点响应缓慢拖垮整个加锁流程。</li>
</ul>
<p>总之，从基础单节点锁到高可用部署，Redis 提供了灵活多样的锁解决方案。但要真正用好这些方案，避免实际应用中出现隐患，还需要注意一些关键细节。</p>
<h3 data-id="heading-15">Redis 锁的隐形“陷阱”</h3>
<p>分布式锁看着简单好上手，但实际落地时，稍有疏忽整个锁机制就可能 “罢工”。今天就来聊聊几个必须盯紧的关键细节，帮你避开常见陷阱：</p>
<h4 data-id="heading-16">陷阱一：看门狗不是万能的</h4>
<p>先说说大家常依赖的看门狗机制 — 它确实能自动给锁续期，但并非绝对可靠。如果持有锁的服务器突然宕机，看门狗线程会随之终止，无法继续给锁续期，锁最终还是会因过期而释放。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eaee9ce56ac42aa9bba9f5267a3ba50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=VKvT6nN5kzSXQjSPHhSFK5Ik0S0%3D" alt="图片" loading="lazy"/></p>
<p>所以我们设计业务逻辑时，尽量要 “短平快”，能尽快释放锁就别长时间占用；同时做好异常兜底方案，避免锁过期后不同线程同时操作数据，导致数据不一致的问题。</p>
<h4 data-id="heading-17">陷阱二：Redlock 切勿滥用</h4>
<p>Redlock 算法的可靠性确实更高，但相比单节点锁，它需要访问多个节点来确认锁的状态，性能开销更大。对于非核心业务场景，「单节点锁 + 看门狗」的组合已经能满足需求，不必过度追求高可用而采用 Redlock，否则会造成性能浪费。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0281046ab830442c98263b5e33f2c912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=AAMeh5RwF0nzjWaZFAD95TApwZ0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-18">陷阱三：锁的粒度要把握适中</h4>
<p>最后是锁的粒度设计，这直接关系到系统的运行效率。</p>
<ul>
<li><strong>粒度太粗</strong>，比如整个系统共用一把锁，会导致所有请求排队等待，引发严重的性能瓶颈；</li>
<li><strong>粒度太细</strong>，比如为每个数据项都单独设锁，则会增加系统复杂性和运维开销，还可能出现 "锁爆炸" 问题。建议根据实际业务场景合理设计锁粒度，在并发安全和系统性能之间找到平衡点。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f75b59743a44cd90398544f56ea366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=7AW5FoM%2BD4eOMbJpPV7XQl8fDyw%3D" alt="图片" loading="lazy"/></p>
<p>掌握这些最佳实践后，我们才能真正构建出既可靠又高效的分布式锁系统。</p>
<h3 data-id="heading-19">Redis 锁 — 分布式世界的“秩序守护者”</h3>
<p>从单节点锁的「先到先得」逻辑，到 Redlock 算法的「少数服从多数」原则；从 <code>NX EX</code> 原子命令的精妙设计，到 Lua 脚本保障的安全释放，Redis 分布式锁用简洁而优雅的实现，精准解决了分布式系统的三大核心难题 — <strong>互斥性、防死锁、高可用</strong>。</p>
<p>下一次当你遇到分布式定时任务重复执行、核心数据同步错乱等并发问题时，不妨先问问自己：</p>
<p>我的系统中，分布式锁真的用对了吗？核心资源真的被有效 “锁住” 了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 进程、网络相关命令大全]]></title>    <link>https://juejin.cn/post/7601046076943171599</link>    <guid>https://juejin.cn/post/7601046076943171599</guid>    <pubDate>2026-01-31T07:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601046076943171599" data-draft-id="7601000638344871951" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 进程、网络相关命令大全"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-31T07:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 进程、网络相关命令大全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:28:16.000Z" title="Sat Jan 31 2026 07:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 进程管理核心命令</h2>
<p>进程是计算机中正在运行的程序的实例。每个进程都有自己的内存空间、寄存器和文件描述符等资源。在 Linux 中，进程可以处于运行（Running）、睡眠（Sleeping）、停止（Stopped）或僵尸（Zombie）等状态。</p>
<h3 data-id="heading-1">1.1 进程查看命令</h3>
<p><strong>ps（进程状态）</strong></p>
<p>ps 是最基础的进程查看命令，用于显示当前时刻的进程状态快照。</p>
<pre><code class="hljs language-ini" lang="ini">ps aux        <span class="hljs-comment"># 显示所有用户的所有进程（BSD风格）</span>
ps -ef        <span class="hljs-comment"># 全格式显示所有进程（System V风格）</span>
ps -ejH       <span class="hljs-comment"># 显示进程树结构</span>
ps aux <span class="hljs-attr">--sort</span>=-%mem  <span class="hljs-comment"># 按内存使用率降序排列</span>
</code></pre>
<p>常用字段说明：</p>
<ul>
<li>USER：进程所有者</li>
<li>PID：进程ID</li>
<li>%CPU：CPU使用率</li>
<li>%MEM：内存使用率</li>
<li>VSZ：虚拟内存大小</li>
<li>RSS：物理内存大小</li>
<li>STAT：进程状态（R=运行, S=睡眠, Z=僵尸）</li>
<li>COMMAND：启动命令</li>
</ul>
<p><strong>top（实时进程监控）</strong></p>
<p>top 提供动态实时视图，显示系统资源使用情况和进程列表。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">top</span>                    # 默认启动，按CPU排序
<span class="hljs-attribute">top</span> -u username        # 仅显示指定用户的进程
<span class="hljs-attribute">top</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1234</span>,<span class="hljs-number">5678</span>       # 监控指定PID的进程
</code></pre>
<p>交互操作（运行中按键）：</p>
<ul>
<li>P：按CPU使用率排序</li>
<li>M：按内存使用率排序</li>
<li>T：按运行时间排序</li>
<li>k：终止指定进程</li>
<li>u：按用户过滤</li>
<li>q：退出</li>
</ul>
<p><strong>htop（增强版top）</strong></p>
<p>htop 是 top 的增强版，提供更直观的界面和更多功能。</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install htop    <span class="hljs-comment"># Debian/Ubuntu安装</span>
htop -t                 <span class="hljs-comment"># 树状显示进程</span>
htop -s cpu            <span class="hljs-comment"># 按CPU使用率排序</span>
</code></pre>
<p>优势特性：</p>
<ul>
<li>彩色显示，支持鼠标操作</li>
<li>直接F9发送信号，F5进程树视图</li>
<li>显示CPU核心分布和内存条形图</li>
</ul>
<p><strong>pgrep 和 pidof（进程查找）</strong></p>
<pre><code class="hljs language-bash" lang="bash">pgrep firefox                 <span class="hljs-comment"># 查找firefox进程PID</span>
pgrep -u root -f <span class="hljs-string">"nginx"</span>     <span class="hljs-comment"># 查找root用户的nginx进程</span>
pidof bash                   <span class="hljs-comment"># 查找bash进程PID</span>
</code></pre>
<h3 data-id="heading-2">1.2 进程控制命令</h3>
<p><strong>kill 和 killall（进程终止）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">kill</span> 1234              <span class="hljs-comment"># 默认发送SIGTERM(15)，正常终止</span>
<span class="hljs-built_in">kill</span> -9 1234           <span class="hljs-comment"># 发送SIGKILL(9)，强制终止</span>
<span class="hljs-built_in">kill</span> -TERM $(pgrep nginx)  <span class="hljs-comment"># 优雅终止所有nginx进程</span>
killall firefox        <span class="hljs-comment"># 终止所有firefox进程</span>
pkill -f <span class="hljs-string">"python script.py"</span>  <span class="hljs-comment"># 终止匹配模式的进程</span>
</code></pre>
<p>常用信号说明：</p>
<ul>
<li>SIGTERM(15)：请求正常终止（默认）</li>
<li>SIGKILL(9)：强制立即终止，无法阻塞</li>
<li>SIGINT(2)：中断进程（相当于Ctrl+C）</li>
<li>SIGSTOP(19)：暂停进程</li>
<li>SIGCONT(18)：恢复暂停的进程</li>
</ul>
<p><strong>nice 和 renice（优先级调整）</strong></p>
<p>Linux进程优先级范围-20（最高）到19（最低）。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">nice</span> -n 10 <span class="hljs-built_in">command</span>     <span class="hljs-comment"># 以优先级10启动进程</span>
renice 15 -p 1234      <span class="hljs-comment"># 修改已运行进程的优先级</span>
renice -u username -5  <span class="hljs-comment"># 修改用户所有进程的优先级</span>
</code></pre>
<h3 data-id="heading-3">1.3 前后台作业管理</h3>
<p><strong>jobs、fg、bg（作业控制）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">sleep</span> 100 &amp;            <span class="hljs-comment"># 后台运行</span>
<span class="hljs-built_in">jobs</span> -l               <span class="hljs-comment"># 查看后台任务列表及PID</span>
<span class="hljs-built_in">fg</span> %1                 <span class="hljs-comment"># 将作业1调至前台</span>
<span class="hljs-built_in">bg</span> %2                 <span class="hljs-comment"># 让暂停的作业2在后台继续</span>
</code></pre>
<p><strong>nohup 和 disown（终端退出保活）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">nohup</span> python script.py &gt; output.log 2&gt;&amp;1 &amp;  <span class="hljs-comment"># 终端退出后继续运行</span>
python script.py &amp;      <span class="hljs-comment"># 先后台启动</span>
<span class="hljs-built_in">disown</span> %1              <span class="hljs-comment"># 从作业列表移除，终端关闭不影响</span>
</code></pre>
<h2 data-id="heading-4">2 网络管理核心命令</h2>
<h3 data-id="heading-5">2.1 网络配置命令</h3>
<p><strong>ip（现代网络配置）</strong></p>
<p>ip 命令已逐渐取代 ifconfig，是更强大的网络配置工具。</p>
<pre><code class="hljs language-bash" lang="bash">ip addr show           <span class="hljs-comment"># 显示所有网络接口信息</span>
ip -4 addr             <span class="hljs-comment"># 仅显示IPv4信息</span>
ip route show         <span class="hljs-comment"># 显示路由表</span>
ip neighbor show      <span class="hljs-comment"># 显示ARP表（邻接表）</span>
</code></pre>
<p><strong>nmcli（NetworkManager控制）</strong></p>
<pre><code class="hljs language-bash" lang="bash">nmcli connection show           <span class="hljs-comment"># 显示网络连接</span>
nmcli device status            <span class="hljs-comment"># 显示设备状态</span>
nmcli connection add <span class="hljs-built_in">type</span> wifi ifname wlan0 ssid <span class="hljs-string">"MyWifi"</span> password <span class="hljs-string">"password"</span>  <span class="hljs-comment"># 添加WiFi连接</span>
</code></pre>
<h3 data-id="heading-6">2.2 网络诊断命令</h3>
<p><strong>ping 和 traceroute（连通性测试）</strong></p>
<pre><code class="hljs language-r" lang="r">ping <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> <span class="hljs-number">4</span> baidu.com           <span class="hljs-comment"># 发送4个测试包</span>
ping6 target.ipv6.com         <span class="hljs-comment"># IPv6测试</span>
traceroute <span class="hljs-operator">-</span>n baidu.com       <span class="hljs-comment"># 追踪路径，以IP显示节点</span>
mtr baidu.com                <span class="hljs-comment"># 更强大的路径追踪工具</span>
</code></pre>
<p><strong>ss 和 netstat（连接统计）</strong></p>
<p>ss 是 netstat 的现代替代品，速度更快。</p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln                      <span class="hljs-comment"># 查看所有监听端口</span>
ss -t -a                      <span class="hljs-comment"># 所有TCP连接</span>
netstat -anp | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>       <span class="hljs-comment"># 传统方式查看80端口进程</span>
netstat -s                    <span class="hljs-comment"># 显示协议统计信息</span>
</code></pre>
<p>输出字段说明：</p>
<ul>
<li>State：连接状态（ESTABLISHED, LISTEN等）</li>
<li>Recv-Q/Send-Q：接收/发送队列大小</li>
<li>Local Address:Port：本地地址端口</li>
<li>Peer Address:Port：对端地址端口</li>
<li>PID/Program name：进程信息</li>
</ul>
<h3 data-id="heading-7">2.3 网络服务与安全</h3>
<p><strong>iptables（防火墙规则）</strong></p>
<pre><code class="hljs language-css" lang="css">iptables -L                    # 列出当前规则
iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">22</span> -j ACCEPT  # 允许SSH连接
iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">i</span> lo -j ACCEPT              # 允许环回接口
</code></pre>
<p><strong>tcpdump 和 wireshark（流量分析）</strong></p>
<pre><code class="hljs language-bash" lang="bash">tcpdump -i eth0 port 80        <span class="hljs-comment"># 捕获80端口流量</span>
tcpdump -w capture.pcap -i eth0 <span class="hljs-comment"># 保存到文件</span>
tshark -i eth0 -f <span class="hljs-string">"port 53"</span>    <span class="hljs-comment"># wireshark命令行版，捕获DNS查询</span>
</code></pre>
<p><strong>curl 和 wget（网络请求）</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -I http://example.com     <span class="hljs-comment"># 仅获取HTTP头</span>
curl -O http://example.com/file.zip  <span class="hljs-comment"># 下载文件</span>
wget -c http://example.com/largefile.iso  <span class="hljs-comment"># 断点续传</span>
wget -r -l1 http://example.com  <span class="hljs-comment"># 递归下载一级目录</span>
</code></pre>
<h2 data-id="heading-8">3 实用场景与技巧</h2>
<h3 data-id="heading-9">3.1 服务故障排查流程</h3>
<ol>
<li>
<p><strong>检查服务进程状态</strong></p>
<pre><code class="hljs language-perl" lang="perl">ps aux | <span class="hljs-keyword">grep</span> nginx         <span class="hljs-comment"># 查找nginx进程</span>
systemctl status nginx      <span class="hljs-comment"># 检查服务状态</span>
</code></pre>
</li>
<li>
<p><strong>验证端口监听</strong></p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>         <span class="hljs-comment"># 检查80端口监听</span>
netstat -anp | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>     <span class="hljs-comment"># 传统方式检查</span>
</code></pre>
</li>
<li>
<p><strong>测试网络连通性</strong></p>
<pre><code class="hljs language-r" lang="r">ping <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> <span class="hljs-number">3</span> target_server     <span class="hljs-comment"># 基础连通性</span>
traceroute target_server    <span class="hljs-comment"># 路径分析</span>
telnet target_server <span class="hljs-number">80</span>     <span class="hljs-comment"># 端口连通性</span>
</code></pre>
</li>
<li>
<p><strong>检查DNS解析</strong></p>
<pre><code class="hljs language-bash" lang="bash">nslookup example.com        <span class="hljs-comment"># DNS解析检查</span>
dig A example.com          <span class="hljs-comment"># 更详细的DNS信息</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-10">3.2 资源监控与优化</h3>
<p><strong>找出资源占用最高的进程</strong></p>
<pre><code class="hljs language-perl" lang="perl">top -o %CPU                    <span class="hljs-comment"># 按CPU使用率排序</span>
ps aux --<span class="hljs-keyword">sort</span>=-%mem | head -<span class="hljs-number">10</span> <span class="hljs-comment"># 内存使用前10的进程</span>
iotop                         <span class="hljs-comment"># 磁盘I/O监控（需安装）</span>
</code></pre>
<p><strong>自动化监控脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 进程监控脚本</span>
PROCESS_NAME=<span class="hljs-string">"nginx"</span>
INTERVAL=60

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> ! pgrep -x <span class="hljs-string">"<span class="hljs-variable">$PROCESS_NAME</span>"</span> &gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 进程 <span class="hljs-variable">$PROCESS_NAME</span> 已停止，尝试重启"</span>
        systemctl restart <span class="hljs-variable">$PROCESS_NAME</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$INTERVAL</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-11">3.3 安全最佳实践</h3>
<ol>
<li>
<p><strong>定期检查异常连接</strong></p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln | <span class="hljs-keyword">grep</span> LISTEN      <span class="hljs-comment"># 检查监听端口</span>
lsof -i -P | <span class="hljs-keyword">grep</span> ESTABLISHED <span class="hljs-comment"># 查看所有活跃连接</span>
</code></pre>
</li>
<li>
<p><strong>监控系统负载</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">uptime</span>                      <span class="hljs-comment"># 查看负载平均值</span>
<span class="hljs-built_in">cat</span> /proc/loadavg           <span class="hljs-comment"># 系统负载详情</span>
</code></pre>
</li>
<li>
<p><strong>限制进程资源</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ulimit</span> -a                   <span class="hljs-comment"># 显示当前限制</span>
<span class="hljs-built_in">ulimit</span> -n 2048             <span class="hljs-comment"># 设置最大文件描述符数</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-12">4 总结</h2>
<p>Linux 进程和网络管理命令是系统管理员和开发人员必须掌握的核心技能。本文介绍的命令覆盖了日常管理和故障排查的绝大多数场景。实际使用中，建议结合具体需求灵活组合这些命令，并养成查看手册（man command）的习惯以获得更深入的理解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[man command详解与应用实战]]></title>    <link>https://juejin.cn/post/7601000638344937487</link>    <guid>https://juejin.cn/post/7601000638344937487</guid>    <pubDate>2026-01-31T07:39:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601000638344937487" data-draft-id="7601000638344921103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="man command详解与应用实战"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-31T07:39:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            man command详解与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:39:41.000Z" title="Sat Jan 31 2026 07:39:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>man</code>命令是 Linux 系统中不可或缺的<strong>官方手册查看工具</strong>，它能提供关于命令、系统调用、库函数、配置文件等的详尽说明。下面这张表总结了其核心用法，方便你快速查阅。</p>
<h3 data-id="heading-0">🔍 核心语法与选项</h3>








































<table><thead><tr><th>用途</th><th>命令示例</th><th>说明</th></tr></thead><tbody><tr><td><strong>查看命令手册</strong></td><td><code>man ls</code></td><td>查看 <code>ls</code>命令的详细手册。</td></tr><tr><td><strong>指定章节</strong></td><td><code>man 2 open</code></td><td>查看第2章节（系统调用）关于 <code>open</code>的说明。</td></tr><tr><td><strong>关键字搜索</strong></td><td><code>man -k network</code></td><td>在所有手册页中搜索包含 "network" 的条目。</td></tr><tr><td><strong>显示简要描述</strong></td><td><code>man -f passwd</code></td><td>显示名为 <code>passwd</code>的所有手册条目的简短描述。</td></tr><tr><td><strong>显示所有匹配</strong></td><td><code>man -a passwd</code></td><td>依次显示所有章节中名为 <code>passwd</code>的手册页。</td></tr><tr><td><strong>显示手册路径</strong></td><td><code>man -w ls</code></td><td>显示 <code>ls</code>命令手册页的磁盘存储路径。</td></tr></tbody></table>
<h3 data-id="heading-1">📚 理解手册章节</h3>
<p>Linux 的手册页（man pages）按照主题分为多个章节，这是高效使用 <code>man</code>命令的关键。当你使用 <code>man passwd</code>时，默认会显示排在首位的章节（通常是第1章）的内容。但如果想查看 <code>/etc/passwd</code>文件格式的说明，就需要指定第5章节：<code>man 5 passwd</code>。</p>
<p>以下是常见的章节划分：</p>








































<table><thead><tr><th>章节编号</th><th>内容类型</th><th>示例</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>用户命令（普通用户可执行的命令）</td><td><code>ls</code>, <code>cp</code>, <code>mkdir</code></td></tr><tr><td><strong>2</strong></td><td>系统调用（由内核提供的函数）</td><td><code>open</code>, <code>fork</code>, <code>read</code></td></tr><tr><td><strong>3</strong></td><td>库函数（标准库中的函数）</td><td><code>printf</code>, <code>malloc</code>, <code>fopen</code></td></tr><tr><td><strong>4</strong></td><td>特殊文件（通常指 <code>/dev</code>下的设备文件）</td><td><code>null</code>, <code>zero</code>, <code>tty</code></td></tr><tr><td><strong>5</strong></td><td>文件格式和约定（配置文件格式）</td><td><code>passwd</code>, <code>fstab</code>, <code>hosts</code></td></tr><tr><td><strong>8</strong></td><td>系统管理命令（通常需要 root 权限）</td><td><code>systemctl</code>, <code>fdisk</code>, <code>iptables</code></td></tr></tbody></table>
<h3 data-id="heading-2">🔧 实用操作技巧</h3>
<p>进入手册页后，你可以使用以下快捷键进行导航和搜索，这能极大提升查阅效率：</p>













































<table><thead><tr><th>操作</th><th>快捷键</th><th>说明</th></tr></thead><tbody><tr><td><strong>向下翻页</strong></td><td><code>空格键</code>或 <code>Page Down</code></td><td>查看下一屏内容。</td></tr><tr><td><strong>向上翻页</strong></td><td><code>b</code>或 <code>Page Up</code></td><td>查看上一屏内容。</td></tr><tr><td><strong>退出</strong></td><td><code>q</code></td><td>退出手册页，回到命令行。</td></tr><tr><td><strong>向下搜索</strong></td><td><code>/关键词</code></td><td>从当前位置向下搜索特定关键词，如 <code>/option</code>。</td></tr><tr><td><strong>向上搜索</strong></td><td><code>?关键词</code></td><td>从当前位置向上搜索。</td></tr><tr><td><strong>下一个匹配</strong></td><td><code>n</code></td><td>跳转到下一个搜索结果。</td></tr><tr><td><strong>上一个匹配</strong></td><td><code>N</code></td><td>跳转到上一个搜索结果。</td></tr></tbody></table>
<h3 data-id="heading-3">🚀 高级应用与实战</h3>
<h4 data-id="heading-4">1. 获取中文手册</h4>
<p>如果你的系统环境是中文，或者希望阅读中文手册，可以安装中文手册包。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 在 Debian/Ubuntu 系统上安装中文手册页</span>
sudo apt-<span class="hljs-keyword">get</span> install manpages-zh
</code></pre>
<p>安装后，你可以通过设置语言环境来查看中文手册，例如 <code>LANG=zh_CN.UTF-8 man ls</code>。需要注意的是，中文翻译可能滞后于英文原版。</p>
<h4 data-id="heading-5">2. 更新手册数据库</h4>
<p>当系统安装新软件后，其手册页信息需要更新到 <code>man</code>的数据库中，<code>-k</code>和 <code>-f</code>选项才能正常识别。可以使用以下命令更新：</p>
<pre><code class="hljs">sudo mandb
</code></pre>
<h4 data-id="heading-6">3. 导出手册内容</h4>
<p>有时你可能希望将手册页的内容保存到文件中以便离线阅读或打印。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 ls 命令的手册页导出为纯文本文件</span>
man <span class="hljs-built_in">ls</span> &gt; ls_manual.txt

<span class="hljs-comment"># 如果需要格式更好的版本，可以先转换为 PostScript 再转为 PDF</span>
man -t <span class="hljs-built_in">ls</span> &gt; ls.ps
ps2pdf ls.ps ls.pdf
</code></pre>
<h3 data-id="heading-7">💡 实战场景举例</h3>
<ul>
<li>
<p><strong>场景1：快速了解未知命令</strong></p>
<p>当你第一次遇到 <code>chmod</code>命令时，直接输入 <code>man chmod</code>。重点阅读 <strong>SYNOPSIS</strong>（语法）和 <strong>DESCRIPTION</strong>（描述）部分，了解其基本用法和参数含义。</p>
</li>
<li>
<p><strong>场景2：查询函数用法</strong></p>
<p>在编写C程序时，需要了解 <code>printf</code>函数的详细用法和头文件，应使用 <code>man 3 printf</code>查看库函数章节的说明。</p>
</li>
<li>
<p><strong>场景3：排查网络问题</strong></p>
<p>如果想查看服务器上哪些端口正在监听，可以使用 <code>man netstat</code>查询 <code>-tuln</code>选项的具体含义，确保命令使用正确。</p>
</li>
<li>
<p><strong>场景4：理解配置文件</strong></p>
<p>当需要修改 <code>/etc/ssh/sshd_config</code>文件时，使用 <code>man 5 sshd_config</code>可以查看该配置文件中每个选项的详细解释。</p>
</li>
</ul>
<h3 data-id="heading-8">⚠️ 注意事项</h3>
<ul>
<li><strong>手册页可能缺失</strong>：某些精简版系统或第三方软件可能没有安装完整的手册页。如果 <code>man</code>命令提示找不到条目，可以尝试使用软件包管理器安装 <code>man-pages</code>或类似软件包。</li>
<li><strong>信息可能过时</strong>：手册页是随软件包一起发布的，有时可能无法完全跟上某个命令最新版本的所有变化。此时，结合命令的 <code>--help</code>选项或查阅官方在线文档是很好的补充。</li>
<li><strong>善用 SEE ALSO</strong>：手册页末尾的 <strong>SEE ALSO</strong>（参见）部分非常有用，它会指引你查看相关的命令或文件，帮助你构建更完整的知识网络。</li>
</ul>
<p><code>man</code>命令是探索和理解 Linux 世界的可靠地图。熟练掌握它，你将能更自信、独立地解决遇到的各种问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据“显微镜”：蜂群图让每个数据点都发声]]></title>    <link>https://juejin.cn/post/7601018079620530191</link>    <guid>https://juejin.cn/post/7601018079620530191</guid>    <pubDate>2026-01-31T06:21:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601018079620530191" data-draft-id="7601049142865477632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据“显微镜”：蜂群图让每个数据点都发声"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-31T06:21:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据“显微镜”：蜂群图让每个数据点都发声
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T06:21:08.000Z" title="Sat Jan 31 2026 06:21:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下夏日的花丛中，成群的蜜蜂围绕着花朵忙碌地飞舞。每只蜜蜂都是一个独立的数据点，它们既保持群体聚集的形态，又不会完全重叠在一起。</p>
<p>这就是<strong>蜂群图</strong>（<code>Swarm Plot</code>）的<strong>核心理念</strong>——在有限的空间内展示所有数据点，让每个点都能被清晰看见。</p>
<p><strong>蜂群图</strong>是一种特殊的数据可视化图表，它将分类数据与数值数据结合起来，展示数据的分布情况。</p>
<p>与传统的条形图或箱线图不同，蜂群图不进行任何数据聚合，而是展示每一个原始数据点，避免了信息丢失。</p>
<h2 data-id="heading-0">1. 蜂群图核心特点</h2>
<p><strong>蜂群图</strong>最巧妙的地方在于它的布局算法。</p>
<p>当多个数据点具有相似数值时，它们不会简单地重叠在一起，而是像有“排斥力”一样，在垂直方向（或水平方向）上轻微偏移，形成一个类似蜂群的分布。</p>
<p>比如，下面是<strong>同一组数据</strong>在<strong>散点图</strong>和<strong>蜂群图</strong>中展示的效果。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4caf03d4b0d24f74842c22c27c2a702e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=0MjPiDO20sLmLVRzrLMrrIF6Wwk%3D" alt="" loading="lazy"/></p>
<p>从中可以看出蜂群图的核心特点有：</p>
<ol>
<li><strong>绝不重叠</strong>： 它通过算法检测数据点的重叠情况，一旦发现两个点数值相近，就会自动把它们向水平方向推开。</li>
<li><strong>保留分布形态</strong>： 散开后的形状，天然形成了一种类似“小提琴”或“山峰”的轮廓，直观地展示了数据的密度。</li>
<li><strong>参数调整</strong>： 我们可以调整点的大小（marker size）和排列的紧密程度。点越大，视觉冲击力越强，但需要的水平空间也越多。</li>
</ol>
<h2 data-id="heading-1">2. 蜂群图 vs. 条形图：从摘要到细节</h2>
<p><strong>条形图</strong>就像是一份数据摘要报告，它告诉我们每个类别的平均值或总计值，但隐藏了数据内部的分布细节。</p>
<p>而<strong>蜂群图</strong>则像是一次数据点的全员大会，每个数据点都有发言的机会。</p>
<p>下面针对同一组数据，我们分别绘制了<strong>条形图</strong>、<strong>箱线图</strong>和<strong>蜂群图</strong>，一起来感受一下它们之间不同的展示效果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成示例数据</span>
np.random.seed(<span class="hljs-number">123</span>)
categories = [<span class="hljs-string">"产品A"</span>, <span class="hljs-string">"产品B"</span>, <span class="hljs-string">"产品C"</span>, <span class="hljs-string">"产品D"</span>]
data_comparison = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    n_points = <span class="hljs-number">40</span>
    <span class="hljs-keyword">if</span> category == <span class="hljs-string">"产品A"</span>:
        values = np.random.normal(<span class="hljs-number">75</span>, <span class="hljs-number">8</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"产品B"</span>:
        values = np.random.normal(<span class="hljs-number">82</span>, <span class="hljs-number">12</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"产品C"</span>:
        values = np.random.normal(<span class="hljs-number">65</span>, <span class="hljs-number">5</span>, n_points)
    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 产品D</span>
        <span class="hljs-comment"># 创建一个双峰分布</span>
        values1 = np.random.normal(<span class="hljs-number">55</span>, <span class="hljs-number">6</span>, n_points // <span class="hljs-number">2</span>)
        values2 = np.random.normal(<span class="hljs-number">85</span>, <span class="hljs-number">7</span>, n_points // <span class="hljs-number">2</span>)
        values = np.concatenate([values1, values2])

    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
        data_comparison.append({<span class="hljs-string">"产品"</span>: category, <span class="hljs-string">"用户评分"</span>: value})

<span class="hljs-comment"># 1. 条形图（平均值）</span>
means = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    cat_data = [d[<span class="hljs-string">"用户评分"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data_comparison <span class="hljs-keyword">if</span> d[<span class="hljs-string">"产品"</span>] == category]
    means.append(np.mean(cat_data))

bars = axes[<span class="hljs-number">0</span>].bar(
    categories, means, color=[<span class="hljs-string">"#1f77b4"</span>, <span class="hljs-string">"#ff7f0e"</span>, <span class="hljs-string">"#2ca02c"</span>, <span class="hljs-string">"#d62728"</span>]
)


<span class="hljs-comment"># 在条形上标注平均值</span>
<span class="hljs-comment"># 省略...</span>

<span class="hljs-comment"># 2. 箱线图</span>
box_data = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    cat_data = [d[<span class="hljs-string">"用户评分"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data_comparison <span class="hljs-keyword">if</span> d[<span class="hljs-string">"产品"</span>] == category]
    box_data.append(cat_data)

boxplot = axes[<span class="hljs-number">1</span>].boxplot(
    box_data, tick_labels=categories, patch_artist=<span class="hljs-literal">True</span>, boxprops=<span class="hljs-built_in">dict</span>(facecolor=<span class="hljs-string">"lightblue"</span>)
)
<span class="hljs-comment"># 省略...</span>

<span class="hljs-comment"># 3. 蜂群图</span>
data_df = pd.DataFrame(data_comparison)
sns.swarmplot(
    x=<span class="hljs-string">"产品"</span>,
    y=<span class="hljs-string">"用户评分"</span>,
    hue=<span class="hljs-string">"产品"</span>,
    data=data_df,
    ax=axes[<span class="hljs-number">2</span>],
    size=<span class="hljs-number">5</span>,
    palette=<span class="hljs-string">"Set2"</span>,
    edgecolor=<span class="hljs-string">"black"</span>,
    linewidth=<span class="hljs-number">0.5</span>,
)
<span class="hljs-comment"># 省略...</span>

plt.tight_layout()
plt.show()

</code></pre>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f95d09191b174b04afe13368017263c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=SWcMKvD0V3DjIb2CgnNpxYsZJRc%3D" alt="" loading="lazy"/></p>
<p>绘制蜂群图可以用<code>seaborn</code>这个库中的<code>swarmplot</code>函数。</p>
<p>从上面的对比可以看出：</p>
<ul>
<li><strong>条形图</strong>告诉我们产品D的平均分约为70分</li>
<li><strong>箱线图</strong>提示产品D的数据分布范围很广</li>
<li>但只有<strong>蜂群图</strong>清晰地揭示了产品D实际上有两个明显的用户群体：一个低评分群体和一个高评分群体</li>
</ul>
<h2 data-id="heading-2">3. 蜂群图 vs. 散点图：从混乱到有序</h2>
<p>传统<strong>散点图</strong>在处理分类数据时，常常导致数据点大量重叠，形成"黑团"，我们无法看清数据点的真实分布。</p>
<p><strong>蜂群图</strong>通过智能布局算法解决了这个问题。</p>
<p>下面构造一个不同密度的数据，看看蜂群图和散点图的展示效果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 比较散点图与蜂群图的视觉效果</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 生成具有不同密度的数据</span>
np.random.seed(<span class="hljs-number">42</span>)
density_data = []
categories = [<span class="hljs-string">"低密度"</span>, <span class="hljs-string">"中等密度"</span>, <span class="hljs-string">"高密度"</span>]
<span class="hljs-keyword">for</span> i, category <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(categories):
    n_points = <span class="hljs-number">20</span> + i * <span class="hljs-number">30</span>  <span class="hljs-comment"># 不同密度</span>
    <span class="hljs-keyword">if</span> category == <span class="hljs-string">"低密度"</span>:
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">15</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"中等密度"</span>:
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">8</span>, n_points)
    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 高密度</span>
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">4</span>, n_points)

    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
        density_data.append({<span class="hljs-string">"类别"</span>: category, <span class="hljs-string">"数值"</span>: value})

<span class="hljs-comment"># 左侧：传统散点图</span>
<span class="hljs-keyword">for</span> i, category <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(categories):
    cat_data = [d[<span class="hljs-string">"数值"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> density_data <span class="hljs-keyword">if</span> d[<span class="hljs-string">"类别"</span>] == category]
    x_positions = np.full(<span class="hljs-built_in">len</span>(cat_data), i)
    axes[<span class="hljs-number">0</span>].scatter(x_positions, cat_data, alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">60</span>, label=category)

<span class="hljs-comment">#省略...</span>

<span class="hljs-comment"># 右侧：蜂群图</span>
density_data_df = pd.DataFrame(density_data)
sns.swarmplot(
    x=<span class="hljs-string">"类别"</span>,
    y=<span class="hljs-string">"数值"</span>,
    hue=<span class="hljs-string">"类别"</span>,
    data=density_data_df,
    ax=axes[<span class="hljs-number">1</span>],
    size=<span class="hljs-number">6</span>,
    palette=<span class="hljs-string">"coolwarm"</span>,
    edgecolor=<span class="hljs-string">"black"</span>,
    linewidth=<span class="hljs-number">0.5</span>,
)
<span class="hljs-comment">#省略...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e57e532d22f4ad4a068c2c244080e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=5%2BeEHyWRB4VpR%2BOvr3UTi4Y%2BqGw%3D" alt="" loading="lazy"/></p>
<p><strong>蜂群图</strong>解决了 <strong>“重叠（Overplotting）”</strong> 的问题。在数据量适中（几百到几千个点）时，它是展示分布密度的最佳选择。</p>
<h2 data-id="heading-3">4. 蜂群图的适用场景</h2>
<p><strong>蜂群图</strong>并不是为了取代<strong>条形图</strong>或<strong>散点图</strong>，它有自己的适用场景和局限性。</p>
<p>适合使用<strong>蜂群图</strong>的场景：</p>
<ul>
<li>样本量适中（通常少于几百个点）时，展示完整数据分布</li>
<li>需要同时看到整体趋势和个体数据点</li>
<li>数据有多个分类变量，需要比较不同类别分布</li>
<li>希望发现异常值或特殊模式（如双峰分布）</li>
</ul>
<p/>
<p><strong>蜂群图</strong>的<strong>局限性</strong>主要有：</p>
<ol>
<li>大数据集可能导致图表过于拥挤</li>
<li>对于非常大规模数据，箱线图或小提琴图可能更合适</li>
<li>精确的数值比较不如条形图直观</li>
</ol>
<h2 data-id="heading-4">5. 总结</h2>
<p><strong>蜂群图</strong>就像数据可视化领域的"显微镜"，它让我们既能观察到数据的整体分布形态，又能看到每一个数据点的具体位置。</p>
<p>与只能显示摘要信息的<strong>条形图</strong>和容易产生重叠的<strong>散点图</strong>相比，<strong>蜂群图</strong>在显示中小型数据集的完整分布信息方面具有独特优势。</p>
<p>在数据可视化实践中，选择正确的图表类型就像选择正确的工具一样重要。</p>
<p>当下一次你需要展示分类数据的分布时，不妨尝试一下蜂群图，它可能会揭示出你从未注意到的数据秘密。</p>
<p>文中的完整代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8639900394-9a109f%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8639900394-9a109f?p=6872" ref="nofollow noopener noreferrer">蜂群图.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[服务器系统安全配置指南(持续更新)]]></title>    <link>https://juejin.cn/post/7600982613654454322</link>    <guid>https://juejin.cn/post/7600982613654454322</guid>    <pubDate>2026-01-31T03:35:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654454322" data-draft-id="7600953879501717555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="服务器系统安全配置指南(持续更新)"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-31T03:35:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猿先生133"/> <meta itemprop="url" content="https://juejin.cn/user/3923509324823005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            服务器系统安全配置指南(持续更新)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3923509324823005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猿先生133
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:35:03.000Z" title="Sat Jan 31 2026 03:35:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">系统安全配置指南</h2>
<h3 data-id="heading-1">1. 将普通用户添加到 sudo 组</h3>
<h4 data-id="heading-2">目标</h4>
<p>将普通用户（如 lingdong）添加到 sudo 组，使其能够执行管理员权限操作。</p>
<h4 data-id="heading-3">步骤</h4>
<p>1：创建新用户</p>
<p>执行以下命令来创建新用户并设置密码：</p>
<pre><code class="hljs language-bash" lang="bash">sudo adduser lingdong
</code></pre>
<p>这条命令将创建一个名为 <code>lingdong</code> 的新用户，并提示您设置密码和其他信息。请根据提示完成操作。</p>
<ol start="2">
<li>如果您有 <code>root</code> 用户的访问权限，请切换到 <code>root</code> 用户：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">su - root
</code></pre>
<ol start="3">
<li>将用户添加到 sudo 组：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">usermod -aG sudo lingdong
</code></pre>
<p>这条命令的作用：将用户 <code>lingdong</code> 添加到 <code>sudo</code> 组，使其获得管理员权限。</p>
<ol start="4">
<li>重新登录系统以使组权限生效。
在重新登录后，请尝试运行以下命令以验证 <code>lingdong</code> 用户是否能够正常使用 <code>sudo</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">whoami</span>
</code></pre>
<p>如果输出为 <code>root</code>，则表示配置成功。</p>
<h3 data-id="heading-4">2. 禁用 root 用户的直接登录</h3>
<h4 data-id="heading-5">目标</h4>
<p>通过修改 SSH 配置文件禁用 root 用户的直接登录，提高系统安全性。</p>
<h4 data-id="heading-6">步骤</h4>
<ol>
<li>备份并编辑 SSH 配置文件：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bak &amp;&amp; sed -i <span class="hljs-string">'s/^#*PermitRootLogin.*/PermitRootLogin no/'</span> /etc/ssh/sshd_config
</code></pre>
<ol start="2">
<li>重启 SSH 服务以应用更改：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">systemctl restart ssh
</code></pre>
<h3 data-id="heading-7">3. 下一步建议</h3>
<ul>
<li>配置 SSH 密钥认证以进一步提高安全性。</li>
<li>禁用密码登录（可选）。</li>
</ul>
<h3 data-id="heading-8">4. Docker管理</h3>
<h4 data-id="heading-9">步骤 2：将用户添加到 <code>docker</code> 组</h4>
<p>为了让 <code>lingdong</code> 用户无需使用 <code>sudo</code> 即可管理 Docker，我们需要将其添加到 <code>docker</code> 组中。</p>
<p>执行以下命令将 <code>lingdong</code> 添加到 <code>docker</code> 组：</p>
<pre><code class="hljs language-bash" lang="bash">sudo usermod -aG docker lingdong
</code></pre>
<p>这条命令会将用户 <code>lingdong</code> 添加到 <code>docker</code> 组。完成后，您需要重新登录或重启系统以使更改生效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring与MyBatis整合原理及事务管理]]></title>    <link>https://juejin.cn/post/7601020578490499081</link>    <guid>https://juejin.cn/post/7601020578490499081</guid>    <pubDate>2026-01-31T06:12:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490499081" data-draft-id="7600982613654683698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring与MyBatis整合原理及事务管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T06:12:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring与MyBatis整合原理及事务管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T06:12:08.000Z" title="Sat Jan 31 2026 06:12:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 整合的三种方式：你用的是哪一种？</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1 传统XML配置：最经典也最复杂</h4>
<p>先看看最传统的整合方式，现在还有很多老项目在用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- applicationContext.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 1. 数据源 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 2. SqlSessionFactory --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sqlSessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapperLocations"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:mapper/*.xml"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"configLocation"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:mybatis-config.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 3. 事务管理器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> 
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 4. 开启注解事务 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 5. Mapper扫描 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"basePackage"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.mapper"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSessionFactoryBeanName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sqlSessionFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
AI写代码XML
</code></pre>
<p><em>代码清单1：传统Spring+MyBatis XML配置</em></p>
<p><strong>问题</strong>：配置繁琐，容易出错，依赖顺序很重要。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2 注解配置：Spring JavaConfig</h4>
<p>Spring 3.0之后，推荐用JavaConfig：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ComponentScan</span>(<span class="hljs-string">"com.example"</span>)
<span class="hljs-variable">@EnableTransactionManagement</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)
public class AppConfig {
    
    <span class="hljs-variable">@Bean</span>
    public DataSource <span class="hljs-built_in">dataSource</span>() {
        <span class="hljs-selector-tag">DruidDataSource</span> <span class="hljs-selector-tag">ds</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DruidDataSource</span>();
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setUrl</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.url"</span>));
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setUsername</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.username"</span>));
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setPassword</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.password"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ds</span>;
    }
    
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">sqlSessionFactory</span>(DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/*.xml"</span>)
        );
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">transactionManager</span>(DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单2：JavaConfig配置方式</em></p>
<p><strong>优点</strong>：类型安全，IDE友好，不容易配置错。</p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.3 Spring Boot自动配置：最简单</h4>
<p>现在最流行的方式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
 
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.model</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
<span class="hljs-string">AI写代码</span>
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)
public class Application {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(Application.class, args);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单3：Spring Boot自动配置</em></p>
<p><strong>但问题来了</strong>：这么简单的配置背后，Spring Boot到底干了什么？</p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 整合的核心：SqlSession管理</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 为什么需要SqlSessionTemplate？</h4>
<p>在纯MyBatis中，我们这样用：</p>
<pre><code class="hljs language-ini" lang="ini">// 传统MyBatis用法
try (SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession()) {
    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
    User <span class="hljs-attr">user</span> = mapper.findById(<span class="hljs-number">1</span>L)<span class="hljs-comment">;</span>
    session.commit()<span class="hljs-comment">;</span>
}
AI写代码java
运行
</code></pre>
<p><strong>问题</strong>：</p>
<ol>
<li>需要手动管理SqlSession生命周期</li>
<li>事务管理复杂</li>
<li>线程不安全</li>
</ol>
<p>Spring的解决方案：<strong>SqlSessionTemplate</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-title">implements</span> <span class="hljs-title">UserDao</span> {
    
    <span class="hljs-comment">// 直接注入SqlSessionTemplate</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SqlSessionTemplate sqlSessionTemplate;
    
    <span class="hljs-keyword">public</span> User findById(<span class="hljs-built_in">Long</span> id) {
        <span class="hljs-comment">// 不用关心SqlSession的创建和关闭</span>
        <span class="hljs-keyword">return</span> sqlSessionTemplate.selectOne(
            <span class="hljs-string">"com.example.mapper.UserMapper.findById"</span>, id);
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单4：使用SqlSessionTemplate</em></p>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 SqlSessionTemplate的线程安全设计</h4>
<p>这是Spring整合MyBatis最精妙的设计。看源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionTemplate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span>, DisposableBean {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionFactory sqlSessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorType executorType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSessionProxy;  <span class="hljs-comment">// 关键：动态代理</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> {
        <span class="hljs-built_in">this</span>(sqlSessionFactory, sqlSessionFactory.getConfiguration()
            .getDefaultExecutorType());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory, ExecutorType executorType)</span> {
        <span class="hljs-built_in">this</span>.sqlSessionFactory = sqlSessionFactory;
        <span class="hljs-built_in">this</span>.executorType = executorType;
        
        <span class="hljs-comment">// 创建动态代理</span>
        <span class="hljs-built_in">this</span>.sqlSessionProxy = (SqlSession) Proxy.newProxyInstance(
            SqlSessionFactory.class.getClassLoader(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] { SqlSession.class },
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionInterceptor</span>()  <span class="hljs-comment">// 关键：拦截器</span>
        );
    }
    
    <span class="hljs-comment">// 所有SqlSession方法都委托给代理</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span> {
        <span class="hljs-keyword">return</span> sqlSessionProxy.selectOne(statement);
    }
    
    <span class="hljs-comment">// 内部拦截器类</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
            <span class="hljs-comment">// 关键：每次调用都获取新的SqlSession</span>
            <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> getSqlSession(
                sqlSessionFactory, executorType, EXCEPTION);
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(sqlSession, args);
                <span class="hljs-comment">// 不提交事务！由Spring事务管理器控制</span>
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                <span class="hljs-comment">// 异常处理...</span>
                <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 关闭SqlSession</span>
                closeSqlSession(sqlSession, sqlSessionFactory);
            }
        }
    }
    
    <span class="hljs-comment">// 获取SqlSession：与当前事务关联</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title function_">getSqlSession</span><span class="hljs-params">(SqlSessionFactory sessionFactory, 
                                          ExecutorType executorType, 
                                          PersistenceExceptionTranslator exceptionTranslator)</span> {
        
        <span class="hljs-comment">// 关键：检查当前线程是否已有SqlSession</span>
        <span class="hljs-type">SqlSessionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> (SqlSessionHolder) TransactionSynchronizationManager
            .getResource(sessionFactory);
        
        <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span> &amp;&amp; holder.isSynchronizedWithTransaction()) {
            <span class="hljs-keyword">if</span> (holder.getExecutorType() != executorType) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransientDataAccessResourceException</span>(
                    <span class="hljs-string">"Cannot change ExecutorType when there is an existing transaction"</span>);
            }
            
            <span class="hljs-comment">// 增加引用计数</span>
            holder.requested();
            <span class="hljs-keyword">return</span> holder.getSqlSession();
        }
        
        <span class="hljs-comment">// 没有事务，创建新的SqlSession</span>
        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession(executorType);
        
        <span class="hljs-comment">// 注册到事务同步管理器</span>
        registerSessionHolder(sessionFactory, executorType, exceptionTranslator, session);
        
        <span class="hljs-keyword">return</span> session;
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单5：SqlSessionTemplate核心源码</em></p>
<p>用图来表示更清楚：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/201c9b495ece4ad3a591188b70a10283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=WzlgGv5D7quzycxeTmsiYX7UVVo%3D" alt="" loading="lazy"/></p>
<p><em>图1：SqlSessionTemplate执行流程</em></p>
<p><strong>关键点</strong>：</p>
<ol>
<li>用动态代理拦截所有方法调用</li>
<li>每次方法调用都可能创建新SqlSession</li>
<li>事务期间复用同一个SqlSession</li>
<li>事务结束后自动关闭SqlSession</li>
</ol>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.3 性能影响测试</h4>
<p>这么复杂的机制，性能影响大吗？我做了测试：</p>
<p><strong>测试场景</strong>：单线程执行1000次查询</p>





























<table><thead><tr><th>使用方式</th><th>总耗时(ms)</th><th>平均耗时(ms)</th><th>SqlSession创建次数</th></tr></thead><tbody><tr><td>原生MyBatis</td><td>1250</td><td>1.25</td><td>1</td></tr><tr><td>SqlSessionTemplate(无事务)</td><td>1450</td><td>1.45</td><td>1000</td></tr><tr><td>SqlSessionTemplate(有事务)</td><td>1320</td><td>1.32</td><td>1</td></tr></tbody></table>
<p><strong>结论</strong>：</p>
<ol>
<li>无事务时，每次调用都创建SqlSession，性能损失约16%</li>
<li>有事务时，复用SqlSession，性能接近原生</li>
<li>生产环境大部分操作在事务中，性能影响可接受</li>
</ol>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. Mapper接口的自动注册</h3>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 @MapperScan是怎么工作的？</h4>
<p>很多人用<code>@MapperScan</code>，但不知道它干了什么。看源码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Target</span>(ElementType.TYPE)
<span class="hljs-variable">@Import</span>(MapperScannerRegistrar.class)  <span class="hljs-comment">// 关键：导入配置类</span>
<span class="hljs-variable">@Repeatable</span>(MapperScans.class)
public <span class="hljs-variable">@interface</span> MapperScan {
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">value</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">basePackages</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-selector-tag">Class</span>&lt;?&gt;<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">basePackageClasses</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-comment">// ...</span>
}
 
<span class="hljs-comment">// 配置类</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MapperScannerRegistrar</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">ImportBeanDefinitionRegistrar</span> {
    
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">registerBeanDefinitions</span>(AnnotationMetadata importingClassMetadata, 
                                      BeanDefinitionRegistry registry) {
        
        <span class="hljs-comment">// 解析@MapperScan注解</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">annotationAttributes</span> = <span class="hljs-selector-tag">importingClassMetadata</span>
            <span class="hljs-selector-class">.getAnnotationAttributes</span>(MapperScan.class.<span class="hljs-built_in">getName</span>());
        
        <span class="hljs-comment">// 创建扫描器配置</span>
        <span class="hljs-selector-tag">BeanDefinitionBuilder</span> <span class="hljs-selector-tag">builder</span> = <span class="hljs-selector-tag">BeanDefinitionBuilder</span>
            <span class="hljs-selector-class">.genericBeanDefinition</span>(MapperScannerConfigurer.class);
        
        <span class="hljs-comment">// 设置扫描包</span>
        <span class="hljs-selector-tag">builder</span><span class="hljs-selector-class">.addPropertyValue</span>(<span class="hljs-string">"basePackage"</span>, 
            StringUtils.<span class="hljs-built_in">arrayToCommaDelimitedString</span>((String[]) 
                annotationAttributes.<span class="hljs-built_in">get</span>(<span class="hljs-string">"basePackages"</span>)));
        
        <span class="hljs-comment">// 注册Bean</span>
        <span class="hljs-selector-tag">registry</span><span class="hljs-selector-class">.registerBeanDefinition</span>(
            MapperScannerConfigurer.class.<span class="hljs-built_in">getName</span>(), 
            builder.<span class="hljs-built_in">getBeanDefinition</span>());
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单6：@MapperScan工作原理</em></p>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 MapperScannerConfigurer：扫描器的核心</h4>
<p>真正干活的是<code>MapperScannerConfigurer</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerConfigurer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, <span class="hljs-title class_">InitializingBean</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> basePackage;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SqlSessionFactory</span> sqlSessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SqlSessionTemplate</span> sqlSessionTemplate;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span>(<span class="hljs-params">BeanDefinitionRegistry registry</span>) {
        <span class="hljs-comment">// 创建ClassPath扫描器</span>
        <span class="hljs-title class_">ClassPathMapperScanner</span> scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);
        
        <span class="hljs-comment">// 设置过滤条件：只扫描接口</span>
        scanner.<span class="hljs-title function_">setAnnotationClass</span>(<span class="hljs-title class_">Mapper</span>.<span class="hljs-property">class</span>);
        scanner.<span class="hljs-title function_">registerFilters</span>();
        
        <span class="hljs-comment">// 设置SqlSessionFactory</span>
        <span class="hljs-keyword">if</span> (sqlSessionFactory != <span class="hljs-literal">null</span>) {
            scanner.<span class="hljs-title function_">setSqlSessionFactory</span>(sqlSessionFactory);
        }
        <span class="hljs-keyword">if</span> (sqlSessionTemplate != <span class="hljs-literal">null</span>) {
            scanner.<span class="hljs-title function_">setSqlSessionTemplate</span>(sqlSessionTemplate);
        }
        
        <span class="hljs-comment">// 扫描并注册</span>
        scanner.<span class="hljs-title function_">scan</span>(<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">tokenizeToStringArray</span>(
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">basePackage</span>, <span class="hljs-title class_">ConfigurableApplicationContext</span>.<span class="hljs-property">CONFIG_LOCATION_DELIMITERS</span>));
    }
}
 
<span class="hljs-comment">// 自定义扫描器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathMapperScanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClassPathBeanDefinitionScanner</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; <span class="hljs-title function_">doScan</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>... basePackages</span>) {
        <span class="hljs-comment">// 1. 扫描包，获取Bean定义</span>
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; beanDefinitions = <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">doScan</span>(basePackages);
        
        <span class="hljs-keyword">if</span> (beanDefinitions.<span class="hljs-title function_">isEmpty</span>()) {
            logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"No MyBatis mapper was found..."</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 2. 处理每个Bean定义</span>
            <span class="hljs-title function_">processBeanDefinitions</span>(beanDefinitions);
        }
        
        <span class="hljs-keyword">return</span> beanDefinitions;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processBeanDefinitions</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;BeanDefinitionHolder&gt; beanDefinitions</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">BeanDefinitionHolder</span> holder : beanDefinitions) {
            <span class="hljs-title class_">GenericBeanDefinition</span> definition = (<span class="hljs-title class_">GenericBeanDefinition</span>) holder.<span class="hljs-title function_">getBeanDefinition</span>();
            
            <span class="hljs-comment">// 3. 设置Bean类为MapperFactoryBean</span>
            definition.<span class="hljs-title function_">setBeanClass</span>(<span class="hljs-title class_">MapperFactoryBean</span>.<span class="hljs-property">class</span>);
            
            <span class="hljs-comment">// 4. 设置构造函数参数：Mapper接口</span>
            definition.<span class="hljs-title function_">getConstructorArgumentValues</span>()
                .<span class="hljs-title function_">addGenericArgumentValue</span>(definition.<span class="hljs-title function_">getBeanClassName</span>());
            
            <span class="hljs-comment">// 5. 设置属性：SqlSessionFactory/SqlSessionTemplate</span>
            <span class="hljs-keyword">if</span> (sqlSessionFactory != <span class="hljs-literal">null</span>) {
                definition.<span class="hljs-title function_">getPropertyValues</span>()
                    .<span class="hljs-title function_">add</span>(<span class="hljs-string">"sqlSessionFactory"</span>, sqlSessionFactory);
            }
            <span class="hljs-keyword">if</span> (sqlSessionTemplate != <span class="hljs-literal">null</span>) {
                definition.<span class="hljs-title function_">getPropertyValues</span>()
                    .<span class="hljs-title function_">add</span>(<span class="hljs-string">"sqlSessionTemplate"</span>, sqlSessionTemplate);
            }
        }
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单7：MapperScannerConfigurer核心逻辑</em></p>
<p>用图表示扫描过程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711ca95fd53a4055afaa3a85653070d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=iuCbRfpNxDFsMzZOHKdKiu9TsDM%3D" alt="" loading="lazy"/></p>
<p><em>图2：Mapper接口扫描注册流程</em></p>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3 MapperFactoryBean：Mapper的工厂</h4>
<p>这是Spring创建Mapper代理的关键：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperFactoryBean</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SqlSessionDaoSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; {
    
    <span class="hljs-keyword">private</span> Class&lt;T&gt; mapperInterface;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">addToConfig</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperFactoryBean</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> {
        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 从SqlSessionTemplate获取Mapper</span>
        <span class="hljs-keyword">return</span> getSqlSession().getMapper(<span class="hljs-built_in">this</span>.mapperInterface);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;T&gt; <span class="hljs-title function_">getObjectType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.mapperInterface;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDaoConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.checkDaoConfig();
        
        <span class="hljs-comment">// 验证配置</span>
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> getSqlSession().getConfiguration();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.addToConfig &amp;&amp; !configuration.hasMapper(<span class="hljs-built_in">this</span>.mapperInterface)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 将Mapper添加到MyBatis配置</span>
                configuration.addMapper(<span class="hljs-built_in">this</span>.mapperInterface);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                logger.error(<span class="hljs-string">"Error while adding the mapper..."</span>, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(e);
            }
        }
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单8：MapperFactoryBean核心代码</em></p>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. Spring事务管理在MyBatis中的实现</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 事务管理器配置</h4>
<p>这是整合中最容易出错的部分：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableTransactionManagement</span>
public class TransactionConfig {
    
    <span class="hljs-variable">@Bean</span>
    public PlatformTransactionManager <span class="hljs-built_in">transactionManager</span>(DataSource dataSource) {
        <span class="hljs-comment">// 关键：必须用DataSourceTransactionManager</span>
        <span class="hljs-selector-tag">DataSourceTransactionManager</span> <span class="hljs-selector-tag">tm</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>();
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        
        <span class="hljs-comment">// 可选配置</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setDefaultTimeout</span>(<span class="hljs-number">30</span>);  <span class="hljs-comment">// 默认30秒超时</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setNestedTransactionAllowed</span>(true);  <span class="hljs-comment">// 允许嵌套事务</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setRollbackOnCommitFailure</span>(true);  <span class="hljs-comment">// 提交失败时回滚</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">tm</span>;
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><strong>为什么必须是DataSourceTransactionManager？</strong></p>
<p>因为MyBatis底层用的是JDBC，而<code>DataSourceTransactionManager</code>是Spring为JDBC事务提供的实现。</p>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 事务的传播行为测试</h4>
<p>Spring的7种传播行为在MyBatis中表现如何？我做了测试：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
        userMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"user1"</span>));
        
        <span class="hljs-keyword">try</span> {
            innerMethod();  <span class="hljs-comment">// 调用内部方法</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 处理异常</span>
        }
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        userMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"user2"</span>));
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"测试异常"</span>);
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单9：事务传播行为测试</em></p>
<p><strong>测试结果</strong>：</p>













































<table><thead><tr><th>传播行为</th><th>结果</th><th>说明</th></tr></thead><tbody><tr><td>REQUIRED</td><td>user1插入成功，user2回滚</td><td>同一个事务，一起回滚</td></tr><tr><td>REQUIRES_NEW</td><td>user1插入成功，user2回滚</td><td>新事务，独立回滚</td></tr><tr><td>NESTED</td><td>user1插入成功，user2回滚</td><td>嵌套事务，可部分回滚</td></tr><tr><td>SUPPORTS</td><td>无事务运行</td><td>沿用当前事务状态</td></tr><tr><td>NOT_SUPPORTED</td><td>挂起当前事务</td><td>无事务运行</td></tr><tr><td>NEVER</td><td>抛出异常</td><td>不能在事务中运行</td></tr><tr><td>MANDATORY</td><td>必须在事务中</td><td>否则抛异常</td></tr></tbody></table>
<p><strong>注意</strong>：MySQL的InnoDB不支持真正的嵌套事务，<code>NESTED</code>会被降级为<code>REQUIRED</code>。</p>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3 事务与SqlSession的绑定</h4>
<p>这是理解事务整合的关键。看源码：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceTransactionManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractPlatformTransactionManager</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> doGetTransaction() {
        <span class="hljs-type">DataSourceTransactionObject</span> txObject = <span class="hljs-keyword">new</span> <span class="hljs-type">DataSourceTransactionObject</span>();
        
        <span class="hljs-comment">// 获取当前连接</span>
        <span class="hljs-type">ConnectionHolder</span> conHolder = (<span class="hljs-type">ConnectionHolder</span>) 
            <span class="hljs-type">TransactionSynchronizationManager</span>.getResource(<span class="hljs-keyword">this</span>.dataSource);
        
        txObject.setConnectionHolder(conHolder, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> txObject;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void doBegin(<span class="hljs-type">Object</span> transaction, <span class="hljs-type">TransactionDefinition</span> definition) {
        <span class="hljs-type">DataSourceTransactionObject</span> txObject = (<span class="hljs-type">DataSourceTransactionObject</span>) transaction;
        
        <span class="hljs-type">Connection</span> con = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取数据库连接</span>
            con = <span class="hljs-keyword">this</span>.dataSource.getConnection();
            
            <span class="hljs-comment">// 设置事务属性</span>
            con.setAutoCommit(<span class="hljs-literal">false</span>);
            con.setTransactionIsolation(definition.getIsolationLevel());
            
            <span class="hljs-comment">// 绑定到当前线程</span>
            <span class="hljs-type">ConnectionHolder</span> holder = <span class="hljs-keyword">new</span> <span class="hljs-type">ConnectionHolder</span>(con);
            holder.setSynchronizedWithTransaction(<span class="hljs-literal">true</span>);
            
            <span class="hljs-type">TransactionSynchronizationManager</span>.bindResource(
                <span class="hljs-keyword">this</span>.dataSource, holder);
            
            txObject.setConnectionHolder(holder);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">Throwable</span> ex) {
            <span class="hljs-comment">// 清理资源</span>
            <span class="hljs-type">DataSourceUtils</span>.releaseConnection(con, <span class="hljs-keyword">this</span>.dataSource);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">CannotCreateTransactionException</span>(<span class="hljs-string">"Could not open JDBC Connection"</span>, ex);
        }
    }
}
<span class="hljs-type">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单10：DataSourceTransactionManager事务绑定</em></p>
<p>在MyBatis中，SqlSession会使用这个绑定的连接：</p>
<pre><code class="hljs language-ini" lang="ini">public static SqlSession getSqlSession(SqlSessionFactory sessionFactory, 
                                      ExecutorType executorType, 
                                      PersistenceExceptionTranslator exceptionTranslator) {
    
    // 检查当前线程是否已绑定连接
    ConnectionHolder <span class="hljs-attr">holder</span> = (ConnectionHolder) 
        TransactionSynchronizationManager.getResource(sessionFactory)<span class="hljs-comment">;</span>
    
    if (holder != null) {
        // 有事务，使用事务中的连接创建SqlSession
        SqlSession <span class="hljs-attr">session</span> = holder.getSqlSession()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">session</span> == null) {
            <span class="hljs-attr">session</span> = sessionFactory.openSession(executorType)<span class="hljs-comment">;</span>
            holder.setSqlSession(session)<span class="hljs-comment">;</span>
        }
        return session<span class="hljs-comment">;</span>
    }
    
    // 无事务，创建新的SqlSession
    return sessionFactory.openSession(executorType)<span class="hljs-comment">;</span>
}
AI写代码java
运行
</code></pre>
<p>用图表示事务、连接、SqlSession的关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21bd4821ca0949eb858aae087a89685c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=nM7YPnt78d3pAFgL4Iy7NtZ%2BAQU%3D" alt="" loading="lazy"/></p>
<p><em>图3：事务与连接绑定关系</em></p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5. 整合中的性能陷阱与优化</h3>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.1 连接池配置不当</h4>
<p>我见过最多的性能问题就是连接池配置不对：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 错误配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">100</span>  <span class="hljs-comment"># 太大，浪费资源</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">50</span>        <span class="hljs-comment"># 太大，启动慢</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 太长</span>
 
<span class="hljs-comment"># 正确配置（根据实际负载调整）</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>   <span class="hljs-comment"># 根据CPU核心数*2-4</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>         <span class="hljs-comment"># 小一点，按需创建</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">5000</span>  <span class="hljs-comment"># 5秒超时</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>    <span class="hljs-comment"># 10分钟空闲超时</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>   <span class="hljs-comment"># 30分钟最大生命周期</span>
      <span class="hljs-attr">leak-detection-threshold:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 30秒泄露检测</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<p><strong>性能测试数据</strong>（100并发查询）：</p>



































<table><thead><tr><th>连接池大小</th><th>QPS</th><th>平均响应时间(ms)</th><th>连接使用率</th></tr></thead><tbody><tr><td>10</td><td>850</td><td>45</td><td>100%</td></tr><tr><td>20</td><td>1550</td><td>32</td><td>75%</td></tr><tr><td>50</td><td>1600</td><td>31</td><td>40%</td></tr><tr><td>100</td><td>1620</td><td>30</td><td>20%</td></tr></tbody></table>
<p><strong>结论</strong>：连接池不是越大越好，20-50是比较合理的范围。</p>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.2 一级缓存失效问题</h4>
<p>在Spring整合MyBatis中，一级缓存很容易失效：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 第一次查询</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> userMapper.findById(id);  <span class="hljs-comment">// 查数据库</span>
        
        <span class="hljs-comment">// 中间有其他操作</span>
        doSomething();
        
        <span class="hljs-comment">// 第二次查询</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> userMapper.findById(id);  <span class="hljs-comment">// 期望从缓存获取</span>
        
        <span class="hljs-keyword">return</span> user2;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 如果这里执行了insert/update/delete</span>
        userMapper.updateSomething();  <span class="hljs-comment">// 会导致一级缓存清空！</span>
    }
}
AI写代码java
运行
</code></pre>
<p><strong>解决方案</strong>：</p>
<ol>
<li>合理安排方法顺序</li>
<li>使用二级缓存</li>
<li>在Service层做缓存</li>
</ol>
<h4 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.3 批量操作性能优化</h4>
<p>批量操作是性能优化的重点：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BatchService</span> {
    
    <span class="hljs-comment">// 错误：每次insert都提交</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertWrong</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        <span class="hljs-keyword">for</span> (User user : users) {
            userMapper.insert(user);  <span class="hljs-comment">// 每次都有事务开销</span>
        }
    }
    
    <span class="hljs-comment">// 正确：使用批量模式</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertRight</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        <span class="hljs-comment">// 使用Batch执行器</span>
        SqlSessionTemplate template = <span class="hljs-keyword">new</span> SqlSessionTemplate(
            sqlSessionFactory, ExecutorType.BATCH);
        
        UserMapper mapper = template.getMapper(UserMapper.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-keyword">for</span> (User user : users) {
            mapper.insert(user);
        }
        
        <span class="hljs-comment">// 手动提交</span>
        template.commit();
    }
    
    <span class="hljs-comment">// 更优：使用MyBatis的foreach</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertBest</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        userMapper.batchInsert(users);  <span class="hljs-comment">// 一次插入多条</span>
    }
}
 
<span class="hljs-comment">// Mapper中的批量插入</span>
&lt;insert id=<span class="hljs-string">"batchInsert"</span> parameterType=<span class="hljs-string">"list"</span>&gt;
    <span class="hljs-function">INSERT INTO <span class="hljs-title">users</span> (<span class="hljs-params">name, email</span>) VALUES
    &lt;<span class="hljs-keyword">foreach</span> collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"user"</span> separator=<span class="hljs-string">","</span>&gt;
        (<span class="hljs-meta">#{user.name}, #{user.email})</span>
    &lt;/<span class="hljs-keyword">foreach</span>&gt;
&lt;/insert&gt;
AI写代码java
运行
</code></pre>
<p><em>代码清单11：批量操作优化</em></p>
<p><strong>性能对比</strong>（插入1000条记录）：</p>





























<table><thead><tr><th>方式</th><th>耗时(ms)</th><th>内存占用</th><th>推荐指数</th></tr></thead><tbody><tr><td>循环单条插入</td><td>1250</td><td>低</td><td>⭐</td></tr><tr><td>Batch执行器</td><td>350</td><td>中</td><td>⭐⭐⭐</td></tr><tr><td>foreach批量插入</td><td>120</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6. 多数据源整合</h3>
<h4 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.1 多数据源配置</h4>
<p>企业级应用经常需要多数据源：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class DataSourceConfig {
    
    <span class="hljs-variable">@Bean</span>(name = <span class="hljs-string">"primaryDataSource"</span>)
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.primary"</span>)
    public DataSource <span class="hljs-built_in">primaryDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondaryDataSource"</span>)
    @<span class="hljs-selector-tag">ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.secondary"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">secondaryDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"primarySqlSessionFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">primarySqlSessionFactory</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"primaryDataSource"</span>) DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/primary/*.xml"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondarySqlSessionFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">secondarySqlSessionFactory</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"secondaryDataSource"</span>) DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/secondary/*.xml"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    <span class="hljs-comment">// 事务管理器也要配多个</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"primaryTransactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">primaryTransactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"primaryDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondaryTransactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">secondaryTransactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"secondaryDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单12：多数据源配置</em></p>
<h4 data-id="heading-22"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.2 动态数据源切换</h4>
<p>更复杂的场景需要动态切换数据源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 定义动态数据源</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbstractRoutingDataSource</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">determineCurrentLookupKey</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">getDataSource</span>();
    }
}
 
<span class="hljs-comment">// 2. 数据源上下文</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">String</span>&gt; contextHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSource</span>) {
        contextHolder.<span class="hljs-title function_">set</span>(dataSource);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> contextHolder.<span class="hljs-title function_">get</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearDataSource</span>(<span class="hljs-params"/>) {
        contextHolder.<span class="hljs-title function_">remove</span>();
    }
}
 
<span class="hljs-comment">// 3. 自定义注解</span>
<span class="hljs-meta">@Target</span>({<span class="hljs-title class_">ElementType</span>.<span class="hljs-property">METHOD</span>, <span class="hljs-title class_">ElementType</span>.<span class="hljs-property">TYPE</span>})
<span class="hljs-meta">@Retention</span>(<span class="hljs-title class_">RetentionPolicy</span>.<span class="hljs-property">RUNTIME</span>)
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> <span class="hljs-title class_">DataSource</span> {
    <span class="hljs-title class_">String</span> <span class="hljs-title function_">value</span>() <span class="hljs-keyword">default</span> <span class="hljs-string">"primary"</span>;
}
 
<span class="hljs-comment">// 4. 切面实现切换</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    
    <span class="hljs-meta">@Around</span>(<span class="hljs-string">"@annotation(dataSource)"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">around</span>(<span class="hljs-title class_">ProceedingJoinPoint</span> joinPoint, <span class="hljs-title class_">DataSource</span> dataSource) throws <span class="hljs-title class_">Throwable</span> {
        <span class="hljs-title class_">String</span> oldDataSource = <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">getDataSource</span>();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSource</span>(dataSource.<span class="hljs-title function_">value</span>());
            <span class="hljs-keyword">return</span> joinPoint.<span class="hljs-title function_">proceed</span>();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (oldDataSource != <span class="hljs-literal">null</span>) {
                <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSource</span>(oldDataSource);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">clearDataSource</span>();
            }
        }
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单13：动态数据源切换</em></p>
<h3 data-id="heading-23"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7. 事务失效的常见场景</h3>
<h4 data-id="heading-24"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.1 自调用问题</h4>
<p>这是最常见的问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 自调用，事务失效！</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateAndSave</span>(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAndSave</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 事务不会生效</span>
        validator.<span class="hljs-title function_">validate</span>(user);
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 方案1：注入自己</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> self;  <span class="hljs-comment">// 注入代理对象</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        self.<span class="hljs-title function_">validateAndSave</span>(user);  <span class="hljs-comment">// 通过代理调用</span>
    }
}
 
<span class="hljs-comment">// 方案2：拆分Service</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserTransactionService</span> transactionService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        transactionService.<span class="hljs-title function_">validateAndSave</span>(user);
    }
}
 
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserTransactionService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAndSave</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 事务生效</span>
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<h4 data-id="heading-25"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.2 异常类型不匹配</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 默认只回滚RuntimeException</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"业务异常"</span>);  <span class="hljs-comment">// 不会回滚！</span>
    }
}
AI写代码java
运行
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 现在任何异常都会回滚</span>
}
AI写代码java
运行
</code></pre>
<h4 data-id="heading-26"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.3 方法修饰符问题</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">internalSave</span>(<span class="hljs-params">User user</span>) {  <span class="hljs-comment">// 私有方法，事务失效！</span>
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><strong>原因</strong>：Spring AOP基于代理，只能代理public方法。</p>
<h3 data-id="heading-27"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8. 性能监控与调优</h3>
<h4 data-id="heading-28"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.1 监控指标配置</h4>
<p>生产环境必须监控：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-attr">application:</span> <span class="hljs-string">${spring.application.name}</span>
      
<span class="hljs-comment"># 自定义监控</span>
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-slow-sql:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">slow-sql-threshold:</span> <span class="hljs-number">1000</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<h4 data-id="heading-29"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.2 关键监控指标</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisMetrics</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-comment">// SQL执行统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer sqlTimer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter sqlErrorCounter;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyBatisMetrics</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> {
        <span class="hljs-built_in">this</span>.meterRegistry = meterRegistry;
        
        sqlTimer = Timer.builder(<span class="hljs-string">"mybatis.sql.duration"</span>)
            .description(<span class="hljs-string">"SQL执行耗时"</span>)
            .publishPercentiles(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">0.99</span>)  <span class="hljs-comment">// 50%, 95%, 99%分位</span>
            .register(meterRegistry);
        
        sqlErrorCounter = Counter.builder(<span class="hljs-string">"mybatis.sql.errors"</span>)
            .description(<span class="hljs-string">"SQL执行错误次数"</span>)
            .register(meterRegistry);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordSqlExecution</span><span class="hljs-params">(<span class="hljs-type">long</span> duration, <span class="hljs-type">boolean</span> success)</span> {
        sqlTimer.record(duration, TimeUnit.MILLISECONDS);
        
        <span class="hljs-keyword">if</span> (!success) {
            sqlErrorCounter.increment();
        }
    }
}
AI写代码java
运行
</code></pre>
<h4 data-id="heading-30"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.3 <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%25E6%2585%25A2SQL%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=%E6%85%A2SQL&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">慢SQL</a>监控</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Intercepts</span>({
    <span class="hljs-variable">@Signature</span>(type = StatementHandler.class, 
               method = <span class="hljs-string">"query"</span>, 
               args = {Statement.class, ResultHandler.class})
})
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class SlowSqlInterceptor implements Interceptor {
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">SLOW_SQL_THRESHOLD</span> = <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1秒</span>
    
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">intercept</span>(Invocation invocation) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Throwable</span> {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.proceed</span>();
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">costTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>() <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">startTime</span>;
            
            <span class="hljs-selector-tag">if</span> (costTime &gt; SLOW_SQL_THRESHOLD) {
                <span class="hljs-selector-tag">StatementHandler</span> <span class="hljs-selector-tag">handler</span> = (StatementHandler) <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.getTarget</span>();
                <span class="hljs-selector-tag">BoundSql</span> <span class="hljs-selector-tag">boundSql</span> = <span class="hljs-selector-tag">handler</span><span class="hljs-selector-class">.getBoundSql</span>();
                
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"慢SQL检测 - 耗时: {}ms, SQL: {}, 参数: {}"</span>, 
                    costTime, boundSql.<span class="hljs-built_in">getSql</span>(), boundSql.<span class="hljs-built_in">getParameterObject</span>());
                
                <span class="hljs-comment">// 发送告警</span>
                <span class="hljs-selector-tag">alertSlowSql</span>(boundSql.<span class="hljs-built_in">getSql</span>(), costTime);
            }
        }
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<h3 data-id="heading-31"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9. 企业级最佳实践</h3>
<h4 data-id="heading-32"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9.1 我的"整合配置军规"</h4>
<p>经过多年实践，我总结了一套最佳实践：</p>
<h5 data-id="heading-33">📜 第一条：明确数据源配置</h5>
<ul>
<li>生产环境必须用连接池（HikariCP）</li>
<li>根据实际负载调整连接数</li>
<li>开启监控和泄露检测</li>
</ul>
<h5 data-id="heading-34">📜 第二条：合理使用事务</h5>
<ul>
<li>事务要短小，不要在事务中做RPC调用</li>
<li>明确指定回滚异常类型</li>
<li>合理设置事务超时时间</li>
</ul>
<h5 data-id="heading-35">📜 第三条：监控到位</h5>
<ul>
<li>监控SQL执行时间</li>
<li>监控连接池使用情况</li>
<li>设置慢SQL告警</li>
</ul>
<h5 data-id="heading-36">📜 第四条：代码规范</h5>
<ul>
<li>Mapper接口要有@Repository或@Mapper注解</li>
<li>SQL写在XML中，复杂的用动态SQL</li>
<li>使用resultMap明确映射关系</li>
</ul>
<h5 data-id="heading-37">📜 第五条：测试充分</h5>
<ul>
<li>单元测试要覆盖事务场景</li>
<li>集成测试要验证多数据源</li>
<li>性能测试要模拟生产负载</li>
</ul>
<h4 data-id="heading-38"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9.2 生产环境配置模板</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application-prod.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://${DB_HOST:localhost}:3306/${DB_NAME}?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">${DB_USER}</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">${DB_PASSWORD}</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">HikariPool</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">5000</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">leak-detection-threshold:</span> <span class="hljs-number">30000</span>
      
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/**/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.model</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">lazy-loading-enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">aggressive-lazy-loading:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default-statement-timeout:</span> <span class="hljs-number">30</span>
    
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<h3 data-id="heading-39"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10. 故障排查指南</h3>
<h4 data-id="heading-40"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10.1 常见问题排查清单</h4>
<h5 data-id="heading-41">问题1：事务不生效</h5>
<ol>
<li>检查是否配置了<code>@EnableTransactionManagement</code></li>
<li>检查方法是否是public</li>
<li>检查是否自调用</li>
<li>检查异常类型是否匹配</li>
</ol>
<h5 data-id="heading-42">问题2：连接泄露</h5>
<ol>
<li>检查是否在事务外使用了SqlSession</li>
<li>检查连接池配置</li>
<li>使用Druid的监控界面查看</li>
<li>检查是否有未关闭的ResultSet/Statement</li>
</ol>
<h5 data-id="heading-43">问题3：性能下降</h5>
<ol>
<li>检查SQL是否有全表扫描</li>
<li>检查是否缺少索引</li>
<li>检查连接池是否过小</li>
<li>检查是否有N+1查询问题</li>
</ol>
<h4 data-id="heading-44"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10.2 调试技巧</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 开启MyBatis日志</span>
logging:
  level:
    com.example.mapper: DEBUG
    org.mybatis: DEBUG
    org.springframework.jdbc: DEBUG
 
<span class="hljs-comment">// 查看事务状态</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TransactionDebug</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> PlatformTransactionManager transactionManager;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugTransaction</span>()</span> {
        TransactionStatus status = transactionManager.getTransaction(
            <span class="hljs-keyword">new</span> DefaultTransactionDefinition());
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"是否新事务: "</span> + status.isNewTransaction());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"是否有保存点: "</span> + status.hasSavepoint());
        
        transactionManager.commit(status);
    }
}
AI写代码
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件]]></title>    <link>https://juejin.cn/post/7600982613654028338</link>    <guid>https://juejin.cn/post/7600982613654028338</guid>    <pubDate>2026-01-30T16:33:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654028338" data-draft-id="7600955777316339750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2026-01-30T16:33:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LaLu"/> <meta itemprop="url" content="https://juejin.cn/user/739350236891191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/739350236891191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LaLu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T16:33:32.000Z" title="Fri Jan 30 2026 16:33:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件</h2>
<blockquote>
<p>在 Vue 项目开发中，快速定位组件源码是提升开发效率的关键。本文将介绍如何使用 <code>vite-plugin-vue-devtools</code> 插件，实现在浏览器中选中组件后一键在 IDE 中打开对应源码文件。</p>
</blockquote>
<h3 data-id="heading-1">一、背景与痛点</h3>
<p>大型 Vue 项目，我们经常会遇到以下场景：</p>
<ul>
<li>页面上有一个组件需要修改，但不知道它对应的源文件在哪里</li>
<li>项目组件层级很深，手动查找费时费力</li>
<li>新接手项目，对代码结构不熟悉</li>
</ul>
<p><strong>vite-plugin-vue-devtools</strong> 正是解决这个问题的利器。</p>
<h3 data-id="heading-2">二、vite-plugin-vue-devtools作用</h3>
<p><code>vite-plugin-vue-devtools</code> 是一个为 Vue 3 + Vite 项目设计的开发工具插件，它提供了：</p>
<ul>
<li>📍 <strong>组件检查器</strong>：在页面上悬停/点击组件，查看组件信息</li>
<li>🔗 <strong>一键跳转</strong>：点击组件直接在 IDE 中打开源码文件</li>
<li>📊 <strong>组件树可视化</strong>：查看组件的层级关系</li>
<li>🔧 <strong>状态调试</strong>：实时查看和修改组件状态</li>
<li>⚡ <strong>性能分析</strong>：分析组件渲染性能</li>
</ul>
<p>这里只做IDE跳转文件的分享</p>
<h3 data-id="heading-3">三、安装和配置</h3>
<h4 data-id="heading-4">3.1 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm install vite-plugin-vue-devtools -D

<span class="hljs-comment"># yarn</span>
yarn add vite-plugin-vue-devtools -D

<span class="hljs-comment"># pnpm</span>
pnpm add vite-plugin-vue-devtools -D
</code></pre>
<h4 data-id="heading-5">3.2 配置 vite.config.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>

<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueDevTools</span>  <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-devtools'</span>

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">VueDevTools</span> ({
      <span class="hljs-attr">launchEditor</span>: <span class="hljs-string">'webstorm64'</span>, <span class="hljs-comment">//这里很关键，windows下看IDE安装目录的exe文件名</span>
    }),
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
    },
  },
})
</code></pre>
<h4 data-id="heading-6">3.3 launchEditor 支持的编辑器</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyyx990803%2Flaunch-editor%3Ftab%3Dreadme-ov-file%23supported-editors" target="_blank" title="https://github.com/yyx990803/launch-editor?tab=readme-ov-file#supported-editors" ref="nofollow noopener noreferrer">github.com/yyx990803/l…</a></p>
<h3 data-id="heading-7">四、使用方法</h3>
<h4 data-id="heading-8">4.1 启动开发服务器</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>启动后，你会在页面底部看到一个 Vue DevTools 的悬浮按钮，点击定位图标，就可以直接选中页面上的元素跳转IDE对应的文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d3d1ae094a4893b4dddb8683b77751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFMdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770395612&amp;x-signature=vq451iBiFliRHaJXFmTodrXKsOo%3D" alt="PixPin_2026-01-31_00-24-38.gif" loading="lazy"/></p>
<h3 data-id="heading-9">五、常见问题与解决方案</h3>
<h4 data-id="heading-10">5.1 点击组件后 IDE 没有反应</h4>
<p><strong>可能原因</strong>：</p>
<ol>
<li><code>launchEditor</code> 配置的编辑器名称不正确</li>
<li>编辑器没有加入系统环境变量</li>
</ol>
<p><strong>解决方案</strong>：</p>
<p>方案一：使用完整路径</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">VueDevTools</span>({
  <span class="hljs-attr">launchEditor</span>: <span class="hljs-string">'C:\\Program Files\\JetBrains\\WebStorm\\bin\\webstorm64.exe'</span>,
})
</code></pre>
<p>方案二：检查环境变量
确保在命令行中可以直接运行 webstorm64 或 code 命令，这个主要看IDE在bin目录下exe对应的文件名叫什么，例如我的文件名是webstorm64，配置里面就写的就是launchEditor: 'webstorm64'</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1252d6bd4454cf6a16fd656d8df711c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFMdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770395612&amp;x-signature=s8FK%2FQ1NuAtl4%2B65soc3B2FJ0Do%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fdevtools-next" target="_blank" title="https://github.com/vuejs/devtools-next" ref="nofollow noopener noreferrer">vite-plugin-vue-devtools GitHub</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器缓存：从底层原理到最佳实践]]></title>    <link>https://juejin.cn/post/7601028900886265902</link>    <guid>https://juejin.cn/post/7601028900886265902</guid>    <pubDate>2026-01-30T23:29:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886265902" data-draft-id="7601169987395321907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器缓存：从底层原理到最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T23:29:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器缓存：从底层原理到最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T23:29:46.000Z" title="Fri Jan 30 2026 23:29:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>缓存是前端性能优化的核心，但我们真的理解各种缓存之间的关系吗？本篇文章将彻底解析浏览器缓存机制，帮我们建立完整的知识体系。</p>
</blockquote>
<h2 data-id="heading-0">缓存全景图：一张图看懂所有缓存关系</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945540c1c7194db1ae267ecc305c764c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3VoZW5fbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770420589&amp;x-signature=aY%2Bq3L4eLvFbDdyiDHGySAUDNHQ%3D" alt="缓存全景图" loading="lazy"/></p>
<h2 data-id="heading-1">HTTP缓存：强缓存 vs 协商缓存</h2>
<p>HTTP缓存是浏览器缓存体系的核心，分为两大策略：<strong>强缓存</strong> 和 <strong>协商缓存</strong>。</p>
<h3 data-id="heading-2">强缓存：浏览器自主决策</h3>
<p>浏览器检查本地缓存是否在有效期内，若有效则直接使用，不发送任何网络请求。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一次请求：服务器设置缓存策略</span>
GET /static/logo.png
HTTP/1.1 200 OK
Cache-Control: max-age=31536000, public
Expires: Mon, 01 Jan 2024 00:00:00 GMT

<span class="hljs-comment"># 后续请求：浏览器自主决策（在有效期内）</span>
GET /static/logo.png
<span class="hljs-comment"># 浏览器检查：max-age=31536000 → 还有效！</span>
<span class="hljs-comment"># 直接从缓存返回，不发送网络请求</span>
</code></pre>
<h3 data-id="heading-3">协商缓存：服务端验证</h3>
<p>当请求资源时，浏览器携带缓存标识询问服务器资源是否变更，若没有变更，直接从缓存中读取资源。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一次请求：服务器返回资源标识</span>
GET /api/user/profile
HTTP/1.1 200 OK
ETag: <span class="hljs-string">"abc123xyz"</span>
Last-Modified: Wed, 21 Oct 2022 07:28:00 GMT
Cache-Control: no-cache

<span class="hljs-comment"># 第二次请求：带上标识询问服务器</span>
GET /api/user/profile
If-None-Match: <span class="hljs-string">"abc123xyz"</span>
If-Modified-Since: Wed, 21 Oct 2022 07:28:00 GMT

<span class="hljs-comment"># 服务器响应</span>
HTTP/1.1 304 Not Modified
<span class="hljs-comment"># 资源未变，使用本地缓存</span>
</code></pre>
<h3 data-id="heading-4">强缓存 vs 协商缓存对比：</h3>













































<table><thead><tr><th>特性</th><th>强缓存</th><th>协商缓存</th></tr></thead><tbody><tr><td>决策机制</td><td>浏览器自己决定</td><td>浏览器和服务器协商</td></tr><tr><td>检查时机</td><td>优先检查</td><td>强缓存失效后检查</td></tr><tr><td>网络请求</td><td>可能完全不发请求</td><td>一定发送请求（验证）</td></tr><tr><td>典型状态码</td><td>200 (from cache)</td><td>304 (Not Modified)</td></tr><tr><td>响应速度</td><td>极快（直接本地读取）</td><td>较慢（需要网络往返）</td></tr><tr><td>适用场景</td><td>版本固定的静态资源</td><td>频繁更新的动态资源</td></tr><tr><td>更新时机</td><td>缓存过期时更新</td><td>每次请求都验证</td></tr></tbody></table>
<h2 data-id="heading-5">浏览器缓存：Memory Cache vs Disk Cache</h2>
<h3 data-id="heading-6">Memory Cache：高速内存缓存</h3>
<ul>
<li>位置：浏览器进程内存空间</li>
<li>容量：有限，依赖设备内存</li>
<li>生命周期：会话级别，标签页关闭则释放</li>
<li>特点：读取速度极快（纳秒级）</li>
</ul>
<h4 data-id="heading-7">适用场景</h4>
<ul>
<li>当前页面已加载的资源</li>
<li>预加载的脚本和样式</li>
<li>小体积的Base64图片</li>
</ul>
<h3 data-id="heading-8">Disk Cache：持久化磁盘缓存</h3>
<ul>
<li>位置：用户磁盘的缓存目录</li>
<li>容量：较大（通常数百MB到数GB）</li>
<li>生命周期：长期持久化</li>
<li>特点：读取速度较慢（毫秒级），但容量大</li>
</ul>
<h4 data-id="heading-9">适用场景</h4>
<ul>
<li>大体积静态资源（图片、字体、视频）</li>
<li>跨会话共享的资源</li>
<li>低频访问但需要持久化的内容</li>
</ul>
<h2 data-id="heading-10">Service Worker：应用层缓存控制</h2>
<p><code>Service Worker</code> 运行在浏览器后台，作为<strong>代理服务器</strong>，赋予开发者完全控制缓存的能力。</p>
<h3 data-id="heading-11">Service Worker 缓存特点</h3>
<ol>
<li>独立线程运行，不阻塞主线程</li>
<li>完全控制网络请求，可自定义缓存策略</li>
<li>支持离线体验，是PWA的核心技术</li>
<li>生命周期独立，可长期缓存资源</li>
</ol>
<h3 data-id="heading-12">Service Worker 缓存策略</h3>
<p>Service Worker 使用的是典型的缓存优先策略：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
        <span class="hljs-comment">// 1. 缓存优先</span>
        <span class="hljs-keyword">if</span> (cachedResponse) {
          <span class="hljs-comment">// 后台更新缓存</span>
          event.<span class="hljs-title function_">waitUntil</span>(
            <span class="hljs-title function_">updateCache</span>(event.<span class="hljs-property">request</span>)
          );
          <span class="hljs-keyword">return</span> cachedResponse;
        }
        
        <span class="hljs-comment">// 2. 网络回退</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
          .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            <span class="hljs-comment">// 缓存新资源</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">cacheResponse</span>(event.<span class="hljs-property">request</span>, networkResponse);
          })
          .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 3. 回退到离线页面</span>
            <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(<span class="hljs-string">'/offline.html'</span>);
          });
      })
  );
});
</code></pre>
<h3 data-id="heading-13">Service Worker 使用场景</h3>






























<table><thead><tr><th>场景</th><th>策略</th><th>优势</th></tr></thead><tbody><tr><td>离线应用</td><td>Cache-First + Network-Fallback</td><td>提供完整的离线体验</td></tr><tr><td>性能优化</td><td>Stale-While-Revalidate</td><td>快速响应+后台更新</td></tr><tr><td>资源预加载</td><td>Precache + Runtime Caching</td><td>减少关键资源加载时间</td></tr><tr><td>不可靠网络</td><td>Network-First + Cache-Fallback</td><td>提升弱网环境体验</td></tr></tbody></table>
<h2 data-id="heading-14">缓存查找顺序</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchWithCache</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-comment">// 1. Service Worker 拦截（最高优先级）</span>
  <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>?.<span class="hljs-property">controller</span>) {
    <span class="hljs-keyword">const</span> swResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkServiceWorkerCache</span>(request);
    <span class="hljs-keyword">if</span> (swResponse) <span class="hljs-keyword">return</span> swResponse;
  }
  
  <span class="hljs-comment">// 2. Memory Cache 检查（最快路径）</span>
  <span class="hljs-keyword">const</span> memoryCached = memoryCache.<span class="hljs-title function_">get</span>(request.<span class="hljs-property">url</span>);
  <span class="hljs-keyword">if</span> (memoryCached &amp;&amp; !<span class="hljs-title function_">isExpired</span>(memoryCached)) {
    <span class="hljs-title function_">reportCacheHit</span>(<span class="hljs-string">'memory'</span>);
    <span class="hljs-keyword">return</span> memoryCached;
  }
  
  <span class="hljs-comment">// 3. Disk Cache 检查（强缓存验证）</span>
  <span class="hljs-keyword">const</span> diskCached = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkDiskCache</span>(request);
  <span class="hljs-keyword">if</span> (diskCached) {
    <span class="hljs-keyword">if</span> (diskCached.<span class="hljs-property">cacheControl</span> === <span class="hljs-string">'immutable'</span> || 
        !<span class="hljs-title function_">isExpired</span>(diskCached)) {
      <span class="hljs-comment">// 更新 Memory Cache 提升后续访问速度</span>
      memoryCache.<span class="hljs-title function_">set</span>(request.<span class="hljs-property">url</span>, diskCached);
      <span class="hljs-title function_">reportCacheHit</span>(<span class="hljs-string">'disk'</span>);
      <span class="hljs-keyword">return</span> diskCached;
    }
  }
  
  <span class="hljs-comment">// 4. 准备网络请求（设置协商缓存头）</span>
  <span class="hljs-keyword">const</span> init = <span class="hljs-title function_">prepareRequest</span>(request);
  
  <span class="hljs-comment">// 5. 发起网络请求</span>
  <span class="hljs-keyword">let</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(request, init);
  
  <span class="hljs-comment">// 6. 处理响应，决定是否缓存</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldCache</span>(response)) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">cacheInLayers</span>(request, response.<span class="hljs-title function_">clone</span>());
  }
  
  <span class="hljs-keyword">return</span> response;
}

</code></pre>
<blockquote>
<ul>
<li>强缓存资源：可以同时存在于Memory和Disk Cache，浏览器根据大小和类型智能分配</li>
<li>协商缓存资源：主要在Disk Cache，Memory Cache可能不存储或短期存储</li>
<li>开发者控制策略：通过HTTP头控制缓存策略，浏览器自动选择存储位置</li>
<li>性能考量：小文件强缓存 → Memory Cache极速；大文件强缓存 → Disk Cache持久</li>
</ul>
</blockquote>
<h2 data-id="heading-15">本地存储体系</h2>















































<table><thead><tr><th>存储类型</th><th>容量</th><th>生命周期</th><th>同步性</th><th>使用场景</th></tr></thead><tbody><tr><td>Cookie</td><td>4KB</td><td>可设置过期时间</td><td>每次请求自动携带</td><td>用户认证、服务端状态</td></tr><tr><td>LocalStorage</td><td>5-10MB</td><td>永久（除非手动清除）</td><td>同步阻塞</td><td>用户偏好、应用配置</td></tr><tr><td>SessionStorage</td><td>5-10MB</td><td>标签页关闭时清除</td><td>同步阻塞</td><td>表单草稿、临时状态</td></tr><tr><td>IndexedDB</td><td>数百MB</td><td>永久</td><td>异步非阻塞</td><td>大量结构化数据</td></tr><tr><td>Cache API</td><td>依赖设备</td><td>Service Worker控制</td><td>异步</td><td>网络资源缓存、PWA</td></tr></tbody></table>
<h2 data-id="heading-16">Chrome DevTools中的缓存标识</h2>
<p>在Chrome开发者工具中，不同缓存来源有不同的标识：</p>









































<table><thead><tr><th>Size列显示</th><th>状态码</th><th>含义</th><th>缓存来源</th></tr></thead><tbody><tr><td>(memory cache)</td><td>200</td><td>内存缓存</td><td>Memory Cache</td></tr><tr><td>(disk cache)</td><td>200</td><td>磁盘缓存</td><td>Disk Cache</td></tr><tr><td>(ServiceWorker)</td><td>200</td><td>Service Worker缓存</td><td>Service Worker Cache</td></tr><tr><td>文件大小</td><td>304</td><td>协商缓存生效</td><td>服务器验证通过</td></tr><tr><td>文件大小</td><td>200</td><td>新请求</td><td>网络获取</td></tr></tbody></table>
<h2 data-id="heading-17">现代框架下的缓存最佳实践</h2>
<h3 data-id="heading-18">Vue 3 + Vite 缓存配置</h3>
<p><code>vite.config.js</code> 中配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-comment">// 生成带hash的文件名，实现长期缓存</span>
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].js'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].[ext]'</span>
      }
    }
  },
  
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-comment">// 开发环境：禁用缓存</span>
      <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-store'</span>
    }
  }
});
</code></pre>
<p>生产环境 <code>Nginx</code> 配置：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    <span class="hljs-comment"># HTML文件：短缓存 + 协商缓存</span>
    location = /index.html {
        add_header Cache-Control <span class="hljs-string">"public, max-age=300, must-revalidate"</span>;
    }
    
    <span class="hljs-comment"># 带hash的静态资源：长期缓存 + 不可变</span>
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$ {
        <span class="hljs-comment"># 匹配带hash的文件名</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> ~* <span class="hljs-string">"\.([0-9a-f]{8,})\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$"</span>) {
            add_header Cache-Control <span class="hljs-string">"public, max-age=31536000, immutable"</span>;
        }
        <span class="hljs-comment"># 无hash的资源使用协商缓存</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> !~* <span class="hljs-string">"\.([0-9a-f]{8,})\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$"</span>) {
            add_header Cache-Control <span class="hljs-string">"public, max-age=604800, must-revalidate"</span>;
        }
    }
    
    <span class="hljs-comment"># API请求：不缓存或短缓存</span>
    location /api/ {
        add_header Cache-Control <span class="hljs-string">"no-store, no-cache, must-revalidate"</span>;
        proxy_pass http://api-backend;
    }
}
</code></pre>
<h3 data-id="heading-19">React 缓存策略建议</h3>
<p>使用 <code>React Query</code> 进行数据缓存管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useQuery, <span class="hljs-title class_">QueryClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;

<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5分钟</span>
      <span class="hljs-attr">cacheTime</span>: <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 10分钟</span>
      <span class="hljs-attr">retry</span>: <span class="hljs-number">1</span>,
    },
  },
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> { data, isLoading } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'user'</span>, userId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchUser</span>(userId),
    <span class="hljs-comment">// 根据用户交互决定缓存策略</span>
    <span class="hljs-attr">cacheTime</span>: userId ? <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> : <span class="hljs-number">0</span>, <span class="hljs-comment">// 登录用户缓存15分钟</span>
  });
  
  <span class="hljs-comment">// 预加载相关数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">prefetchPosts</span> = (<span class="hljs-params"/>) =&gt; {
    queryClient.<span class="hljs-title function_">prefetchQuery</span>({
      <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'posts'</span>, userId],
      <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchUserPosts</span>(userId),
    });
  };
}
</code></pre>
<h2 data-id="heading-20">常见问题与解决方案</h2>
<h3 data-id="heading-21">用户反映看到的是旧版本页面</h3>
<p>原因：HTML文件被缓存，导致加载的是旧版本的静态资源引用。
解决方案：在nginx中配置合理的缓存策略：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
    <span class="hljs-comment"># HTML文件：短时间缓存 + 协商缓存</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=300, must-revalidate"</span>;
}

location /assets/ {
    <span class="hljs-comment"># 静态资源：长时间缓存 + 文件hash</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=31536000, immutable"</span>;
}
</code></pre>
<h3 data-id="heading-22">如何优雅地清除缓存？</h3>
<p><code>vite/webpack</code> 会自动生成文件hash，以此进行清除。</p>
<h2 data-id="heading-23">缓存最佳实践总结</h2>















































<table><thead><tr><th>资源类型</th><th>推荐策略</th><th>缓存时间</th><th>更新机制</th></tr></thead><tbody><tr><td>HTML入口文件</td><td>协商缓存</td><td>短时间（5分钟）</td><td>内容hash或版本号</td></tr><tr><td>JS/CSS（带hash）</td><td>强缓存</td><td>长期（1年）</td><td>文件名hash变更</td></tr><tr><td>图片/字体</td><td>强缓存</td><td>中期（1个月）</td><td>URL变更或版本控制</td></tr><tr><td>API数据（列表）</td><td>内存缓存</td><td>短期（1-5分钟）</td><td>时间过期或主动失效</td></tr><tr><td>用户偏好配置</td><td>LocalStorage</td><td>永久</td><td>用户操作触发更新</td></tr><tr><td>离线资源</td><td>Service Worker</td><td>长期</td><td>版本化预缓存</td></tr></tbody></table>
<h2 data-id="heading-24">未来趋势</h2>
<ul>
<li>HTTP/3的缓存改进：更智能的缓存协商机制</li>
<li>AI驱动的缓存策略：根据用户行为预测缓存需求</li>
<li>边缘计算缓存：CDN与浏览器缓存的深度融合</li>
<li>隐私保护的缓存：沙盒化缓存防止指纹追踪</li>
</ul>
<h2 data-id="heading-25">结语</h2>
<p>浏览器缓存是一个多层次的复杂系统，理解各层缓存的工作原理、生命周期和适用场景是进行有效缓存管理的关键，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript原型链 - 继承的基石与核心机制]]></title>    <link>https://juejin.cn/post/7601028900886298670</link>    <guid>https://juejin.cn/post/7601028900886298670</guid>    <pubDate>2026-01-30T23:55:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886298670" data-draft-id="7601169987395338291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript原型链 - 继承的基石与核心机制"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T23:55:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript原型链 - 继承的基石与核心机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T23:55:52.000Z" title="Fri Jan 30 2026 23:55:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：从一道面试题说起</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// null</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Function</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>); <span class="hljs-comment">// true (!)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Function</span>); <span class="hljs-comment">// true (!)</span>
</code></pre>
<p>如果你能完全理解上面的代码，那么你已经掌握了原型链的核心。如果不能，本篇文章将带我们一步步揭开原型链的神秘面纱。</p>
<h2 data-id="heading-1">构造函数、实例、原型的三者关系</h2>
<p>在JavaScript中，每个对象都有一个特殊的内部属性<code>[[Prototype]]</code>（可以通过<code>__proto__</code>访问），它指向该对象的原型对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-comment">// 原型对象：所有实例共享的方法和属性</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 实例：通过new创建的对象</span>
<span class="hljs-keyword">const</span> zhangsan = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'zhangsna'</span>);

<span class="hljs-comment">// 三者关系验证</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(zhangsan.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-2">prototype和__proto__的区别与联系</h2>
<ul>
<li><code>prototype</code> 是函数特有的属性。</li>
<li><code>__proto__</code> 是每个对象都有的属性。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Foo</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> obj.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// "object"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> === obj.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 一定要注意：函数也是对象，所以函数也有__proto__</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<ol>
<li>每个函数都有一个 <code>prototype</code> 属性，指向该函数的<strong>原型对象</strong>。</li>
<li>每个对象都有一个 <code>__proto__</code> 属性，指向创建该对象的构造函数的<strong>原型对象</strong>。</li>
<li>原型对象的 <code>constructor</code> 属性指向创建该实例对象的构造函数。</li>
<li><code>Function</code> 是一个特殊的函数，它的 <code>constructor</code> 指向它自己。</li>
</ol>
<h2 data-id="heading-3">完整的原型链结构</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is eating`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name); <span class="hljs-comment">// 调用父类构造函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
}

<span class="hljs-comment">// 设置原型链</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>; <span class="hljs-comment">// 修复constructor指向</span>

<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is barking`</span>);
};

<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>, <span class="hljs-string">'Golden Retriever'</span>);

<span class="hljs-comment">// 原型链查找路径：</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// null</span>
</code></pre>
<p>上述代码中，原型链的查找过程：</p>
<ol>
<li><code>myDog</code> 本身有 <code>name</code> 和 <code>breed</code> 属性</li>
<li><code>myDog.__proto__</code> (<code>Dog.prototype</code>) 有 <code>bark</code> 方法</li>
<li><code>Dog.prototype.__proto__</code> (<code>Animal.prototype</code>) 有 <code>eat</code> 方法</li>
<li><code>Animal.prototype.__proto__</code> (<code>Object.prototype</code>) 有 <code>toString</code> 等方法</li>
<li><code>Object.prototype.__proto__</code> 为<code>null</code>，查找结束</li>
</ol>
<blockquote>
<p>Object.prototype是所有原型链的终点。</p>
</blockquote>
<h2 data-id="heading-4">属性屏蔽规则</h2>
<h3 data-id="heading-5">hasOwnProperty vs in操作符</h3>
<ul>
<li><code>hasOwnProperty</code>: 检查属性是否在对象自身（不在原型链上）</li>
<li>in操作符: 检查属性是否在对象自身或原型链上</li>
</ul>
<h3 data-id="heading-6">属性屏蔽的三种情况</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'parent value'</span>;
}

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">shared</span> = <span class="hljs-string">'parent shared'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'child value'</span>; 
}

<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;

<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">shared</span> = <span class="hljs-string">'child shared'</span>; 

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();
</code></pre>
<h4 data-id="heading-7">情况1：对象自身有该属性（完全屏蔽）</h4>
<p>以上述代码为例，<code>Child</code> 本身有自己的 <code>value</code> 属性，当调用 <code>value</code> 属性时，会完全屏蔽原型链上的同名 <code>value</code> 属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">value</span>); <span class="hljs-comment">// 'child value'（不是'parent value'）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'value'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-8">情况2：对象自身本来没有，但添加对象自身属性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">shared</span>); <span class="hljs-comment">// 'child shared'（来自Child.prototype）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'shared'</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 添加对象自身属性</span>
child.<span class="hljs-property">shared</span> = <span class="hljs-string">'instance shared'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">shared</span>); <span class="hljs-comment">// 'instance shared'（现在自身有了）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'shared'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-9">情况3：属性是只读的</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">readOnly</span> = <span class="hljs-string">'cannot change'</span>;

<span class="hljs-comment">// 试图修改只读属性</span>
child.<span class="hljs-property">readOnly</span> = <span class="hljs-string">'try to change'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">readOnly</span>); <span class="hljs-comment">// 'cannot change'（修改失败）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'readOnly'</span>)); <span class="hljs-comment">// false（没有添加成功）</span>
</code></pre>
<h2 data-id="heading-10">原型链的基础结构</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-keyword">const</span> zhangsan = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'zhangsan'</span>);
</code></pre>
<p>其原型结构图如下：</p>
<pre><code class="hljs language-text" lang="text">zhangsan (实例)
  ├── __proto__: Person.prototype
  │      ├── constructor: Person
  │      ├── sayHello: function()
  │      └── __proto__: Object.prototype
  │             ├── constructor: Object
  │             ├── toString: function()
  │             ├── hasOwnProperty: function()
  │             └── __proto__: null
  ├── name: "zhangsan"
  └── (其他实例属性...)

Person (构造函数)
  ├── prototype: Person.prototype
  └── __proto__: Function.prototype
           ├── constructor: Function
           ├── apply: function()
           ├── call: function()
           └── __proto__: Object.prototype
</code></pre>
<h2 data-id="heading-11">原型链的实际应用</h2>
<h3 data-id="heading-12">实现继承的多种方式</h3>
<h4 data-id="heading-13">原型链继承（经典方式）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 关键：让子类原型指向父类实例</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();

<span class="hljs-comment">// 修复constructor指向</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;
</code></pre>
<ul>
<li>问题：引用类型的属性会被所有实例共享</li>
</ul>
<h4 data-id="heading-14">组合继承（最常用）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name ;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-comment">// 继承属性</span>
    <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);  <span class="hljs-comment">// 第二次调用Parent</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 继承方法</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();  <span class="hljs-comment">// 第一次调用Parent</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;
</code></pre>
<ul>
<li>优点：结合了原型链和构造函数的优点</li>
<li>缺点：父类构造函数被调用了两次</li>
</ul>
<h4 data-id="heading-15">寄生组合式继承（最佳实践）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-params">child, parent</span>) {
    <span class="hljs-comment">// 创建父类原型的副本</span>
    <span class="hljs-keyword">const</span> prototype = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
    <span class="hljs-comment">// 修复constructor指向</span>
    prototype.<span class="hljs-property">constructor</span> = child;
    <span class="hljs-comment">// 设置子类原型</span>
    child.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = prototype;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-title class_">Parent2</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-title class_">Child</span>, <span class="hljs-title class_">Parent</span>);
</code></pre>
<ul>
<li>只调用一次父类构造函数</li>
<li>避免在子类原型上创建不必要的属性</li>
<li>原型链保持不变</li>
</ul>
<h4 data-id="heading-16">ES6 class继承</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent3</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child3</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent3</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">super</span>(name);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
    }
    
    <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
    }
}
</code></pre>
<ul>
<li>语法简洁，现代解决方案，但需要ES6+支持</li>
</ul>
<h3 data-id="heading-17">实现混入（Mixin）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> canEat = {
    <span class="hljs-attr">eat</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">food</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is eating <span class="hljs-subst">${food}</span>`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">energy</span> += <span class="hljs-number">10</span>;
    }
};

<span class="hljs-keyword">const</span> canSleep = {
    <span class="hljs-attr">sleep</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">hours</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is sleeping for <span class="hljs-subst">${hours}</span> hours`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">energy</span> += hours * <span class="hljs-number">5</span>;
    }
};

<span class="hljs-keyword">const</span> canWalk = {
    <span class="hljs-attr">walk</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">distance</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is walking <span class="hljs-subst">${distance}</span> km`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">energy</span> -= distance * <span class="hljs-number">2</span>;
    }
};

<span class="hljs-comment">// 混入函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mixin</span>(<span class="hljs-params">target, ...sources</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(target.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, ...sources);
}

<span class="hljs-comment">// 创建动物类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">energy</span> = <span class="hljs-number">100</span>;
}

<span class="hljs-title function_">mixin</span>(<span class="hljs-title class_">Animal</span>, canEat, canSleep, canWalk);

<span class="hljs-comment">// 创建鸟类，额外添加飞行能力</span>
<span class="hljs-keyword">const</span> canFly = {
    <span class="hljs-attr">fly</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">distance</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is flying <span class="hljs-subst">${distance}</span> km`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">energy</span> -= distance * <span class="hljs-number">5</span>;
    }
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Bird</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wings</span> = <span class="hljs-number">2</span>;
}

<span class="hljs-comment">// 设置原型链</span>
<span class="hljs-title class_">Bird</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Bird</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Bird</span>;

<span class="hljs-comment">// 添加飞行能力</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Bird</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, canFly);
</code></pre>
<h2 data-id="heading-18">原型链常见陷阱</h2>
<h3 data-id="heading-19">陷阱1：修改原型会影响所有实例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-keyword">const</span> zhangsan = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'zhangsan'</span>);
<span class="hljs-keyword">const</span> lisi = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'lisi'</span>);

<span class="hljs-comment">// 修改原型</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

zhangsan.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, zhangsan (正常)</span>
lisi.<span class="hljs-title function_">sayHello</span>();   <span class="hljs-comment">// Hello, lisi (正常)</span>
</code></pre>
<h3 data-id="heading-20">陷阱2：原型上的引用类型属性被所有实例共享</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Problem</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">values</span> = []; <span class="hljs-comment">// 正确：每个实例有自己的数组</span>
}

<span class="hljs-title class_">Problem</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sharedValues</span> = []; <span class="hljs-comment">// 错误：所有实例共享同一个数组</span>

<span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Problem</span>();
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Problem</span>();

p1.<span class="hljs-property">sharedValues</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'from p1'</span>);
p2.<span class="hljs-property">sharedValues</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'from p2'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1.<span class="hljs-property">sharedValues</span>); <span class="hljs-comment">// ['from p1', 'from p2']</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2.<span class="hljs-property">sharedValues</span>); <span class="hljs-comment">// ['from p1', 'from p2']</span>
</code></pre>
<h3 data-id="heading-21">陷阱3：for...in会遍历原型链上的可枚举属性</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentProp</span> = <span class="hljs-string">'parent'</span>;
}

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">inheritedProp</span> = <span class="hljs-string">'inherited'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childProp</span> = <span class="hljs-string">'child'</span>;
}

<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> child) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// childProp, parentProp, inheritedProp</span>
}
</code></pre>
<p>解决方案：使用hasOwnProperty过滤：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> child) {
    <span class="hljs-keyword">if</span> (child.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// childProp, parentProp</span>
    }
}
</code></pre>
<h2 data-id="heading-22">原型链的最佳实践</h2>
<h3 data-id="heading-23">实践1：使用Object.create设置原型链</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 最佳方式</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;

<span class="hljs-comment">// 添加子类方法</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
};
</code></pre>
<h3 data-id="heading-24">实践2：使用class语法（ES6+）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodParent</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }
    
    <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodChild</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">GoodParent</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">super</span>(name);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
    }
    
    <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
    }
}
</code></pre>
<h3 data-id="heading-25">实践3：安全地检查属性</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">ownProp</span>: <span class="hljs-string">'value'</span> };

<span class="hljs-comment">// 不好的做法</span>
<span class="hljs-keyword">if</span> (obj.<span class="hljs-property">property</span>) {
    <span class="hljs-comment">// 如果property值为falsy（0, '', false, null, undefined），会被误判</span>
}

<span class="hljs-comment">// 好的做法</span>
<span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'property'</span>)) {
    <span class="hljs-comment">// 明确检查自身属性</span>
}

<span class="hljs-comment">// 更好的做法（防止hasOwnProperty被覆盖）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(obj, <span class="hljs-string">'property'</span>)) {
    <span class="hljs-comment">// 最安全的方式</span>
}
</code></pre>
<h3 data-id="heading-26">实践4：避免修改内置对象的原型</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 非必要情况，不得进行以下操作</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">customMethod</span>) {
    <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">customMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 实现</span>
    };
}
</code></pre>
<h2 data-id="heading-27">思考题：以下代码的输出是什么？为什么？</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Bar</span>(<span class="hljs-params"/>) {}

<span class="hljs-title class_">Bar</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);

<span class="hljs-keyword">const</span> bar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bar</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Bar</span>); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Foo</span>); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Bar</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">isPrototypeOf</span>(bar)); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">isPrototypeOf</span>(bar)); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">isPrototypeOf</span>(bar)); 
</code></pre>
<h2 data-id="heading-28">结语</h2>
<p>原型链是 JavaScript 面向对象编程的基石，在 JavaScript 中没有真正的类，只有对象和它们之间的链接（原型链），对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯原生html js实现幸运抽奖转盘功能-奖项不重复(javascript小案例)]]></title>    <link>https://juejin.cn/post/7600787795478560814</link>    <guid>https://juejin.cn/post/7600787795478560814</guid>    <pubDate>2026-01-31T01:21:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795478560814" data-draft-id="7601169987395452979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯原生html js实现幸运抽奖转盘功能-奖项不重复(javascript小案例)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-31T01:21:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崧峻"/> <meta itemprop="url" content="https://juejin.cn/user/4484237958320521"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯原生html js实现幸运抽奖转盘功能-奖项不重复(javascript小案例)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4484237958320521/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崧峻
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:21:28.000Z" title="Sat Jan 31 2026 01:21:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">创建项目</h2>
<p>如图所示创建一个基本html项目,创建好之后如图2所示
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ba83c15da3a4cb784e3eb6322545d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSn5bO7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427288&amp;x-signature=sMg6YF4CkBv3kC%2FzdOAPkVC6a0w%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">九宫格效果</h2>
<p>我们先来实现九宫格的效果吧，有两种一种是按照顺序的九宫格如图1所示，一种是一圈的效果如图2所示，我们本期以第一种九宫格为案例进行实现</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1572afd747e4298accc02bd20f9da08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSn5bO7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427288&amp;x-signature=Z0DmeBVOwodvQBd57uwmQW6slXA%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0a2950e8f88400f9cfd63c101d776b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSn5bO7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427288&amp;x-signature=wF6smvVSgTBDgEJ5bXrQfxqZ%2Bns%3D" alt="image.png" loading="lazy"/></p>
<p>html部分代码</p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"turntable-box"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>一等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>二等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>三等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>四等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startBtn"</span>&gt;</span>参与游戏<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>赢得大奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>五等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>六等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>七等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>八等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/body&gt;
</code></pre>
<p>css部分代码样式</p>
<pre><code class="hljs language-css" lang="css">&lt;style type="text/css"&gt;

  


<span class="hljs-comment">/* 转盘的外层边框 */</span>

<span class="hljs-selector-id">#turntable-box</span> {

<span class="hljs-attribute">display</span>: flex;

<span class="hljs-attribute">align-items</span>: center;

<span class="hljs-attribute">justify-content</span>: center;

<span class="hljs-attribute">flex-wrap</span>: wrap;

<span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;

<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;

<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#922a21</span>;

<span class="hljs-attribute">position</span>: relative;

<span class="hljs-attribute">width</span>: <span class="hljs-number">510px</span>;

<span class="hljs-attribute">height</span>: <span class="hljs-number">420px</span>;

<span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;

<span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;

}

  


<span class="hljs-comment">/* 转盘下面的每个模块样式 */</span>

<span class="hljs-selector-id">#turntable-box</span> &gt; <span class="hljs-selector-tag">div</span> {

<span class="hljs-attribute">display</span>: flex;

<span class="hljs-attribute">align-items</span>: center;

<span class="hljs-attribute">justify-content</span>: center;

<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;

<span class="hljs-attribute">width</span>: <span class="hljs-number">160px</span>;

<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8e7c1</span>;

<span class="hljs-attribute">height</span>: <span class="hljs-number">130px</span>;

<span class="hljs-attribute">text-align</span>: center;

<span class="hljs-attribute">font-size</span>: <span class="hljs-number">25px</span>;

}

&lt;/style&gt;
</code></pre>
<p>这个就是很简单的一个换行排序 flex布局</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
<span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">left</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) {
<span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">left</span>: <span class="hljs-number">175px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) {
<span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">left</span>: <span class="hljs-number">340px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">4</span>) {
<span class="hljs-attribute">left</span>: <span class="hljs-number">340px</span>;
<span class="hljs-attribute">top</span>: <span class="hljs-number">145px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">5</span>) {
<span class="hljs-attribute">left</span>: <span class="hljs-number">340px</span>;
<span class="hljs-attribute">top</span>: <span class="hljs-number">280px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">6</span>) {
<span class="hljs-attribute">top</span>: <span class="hljs-number">280px</span>;
<span class="hljs-attribute">left</span>: <span class="hljs-number">175px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">7</span>) {
<span class="hljs-attribute">left</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">top</span>: <span class="hljs-number">280px</span>;
}
<span class="hljs-selector-id">#turntable-box</span> <span class="hljs-selector-class">.reward</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">8</span>) {
<span class="hljs-attribute">left</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">top</span>: <span class="hljs-number">145px</span>;
}
</code></pre>
<p><strong>如果大家想要一圈形式的布局代码参考如下 其实就是利用了定位让他形成了一圈</strong></p>
<h2 data-id="heading-2">美化样式</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>幸运转盘<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
			<span class="hljs-selector-tag">body</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">flex-direction</span>: column;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">overflow</span>: hidden;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'img/background.jpg'</span>);
				<span class="hljs-comment">/* 背景图片居中 */</span>
				<span class="hljs-attribute">background-position</span>: center;
				<span class="hljs-comment">/* 背景图片不重复 */</span>
				<span class="hljs-attribute">background-repeat</span>: no-repeat;
			}


			<span class="hljs-comment">/* 幸运抽奖的标题图片 */</span>
			<span class="hljs-selector-class">.draw-title</span> {
				<span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
				<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">10px</span>);
			}


			<span class="hljs-comment">/*  转盘的外层边框 */</span>
			<span class="hljs-selector-id">#turntable-content</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">flex-wrap</span>: wrap;
				<span class="hljs-attribute">gap</span>: <span class="hljs-number">5px</span>;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#922a21</span>;
				<span class="hljs-attribute">position</span>: relative;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">510px</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">410px</span>;
				<span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
				<span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
			}


			<span class="hljs-comment">/*  转盘下面的每个模块样式 */</span>
			<span class="hljs-selector-id">#turntable-content</span>&gt;<span class="hljs-selector-tag">div</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">160px</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">130px</span>;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">25px</span>;
			}






			<span class="hljs-comment">/* 幸运转盘最外层 */</span>
			<span class="hljs-selector-class">.draw-turntable-box</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5%</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-number">#de4b3f</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">600px</span>;
			}


			<span class="hljs-comment">/* 开始抽奖按钮 */</span>
			<span class="hljs-selector-id">#startBtn</span> {
				<span class="hljs-attribute">cursor</span>: pointer;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">22px</span>;
				<span class="hljs-attribute">white-space</span>: normal;
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eb5e4a</span>;
				<span class="hljs-attribute">color</span>: white;
			}
			
			<span class="hljs-comment">/* 奖项 */</span>
			<span class="hljs-selector-class">.unselected</span> {
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8e7c1</span>;
			}
			
			<span class="hljs-selector-id">#selected</span> {
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ee7c45</span>;
			}
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./img/draw.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"抽奖标题"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"draw-title"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"draw-turntable-box"</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"turntable-content"</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>一等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>二等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>三等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>四等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startBtn"</span>&gt;</span>参与游戏<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>赢得大奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>五等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>六等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>七等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>八等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
			<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">js代码实现-抽奖不重复</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a93ee5595bda42ef93aa42f28e8ab012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSn5bO7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427288&amp;x-signature=QOAxu77mfzIn42X%2FDuY5ZyZ%2Fduk%3D" alt="image.png" loading="lazy"/>
实现原理是给开始按钮绑定一个点击事件，然后进行依次变色，最后随机一个没有抽到过的数，然后抽奖成功后把这个数放到一个变量中存储进行去重，完整js代码如下 如图所示</p>
<pre><code class="hljs language-&lt;script" lang="&lt;script">		// 奖项元素列表
		var award = document.getElementsByClassName("award");
		// 已经拿到的奖励序号
		const lucks = [];
		// 是否正在抽奖
		let running = false;
		
		// 开始按钮元素
		var startBtn = document.getElementById("startBtn");
		
		startBtn.onclick = function() {
			// 判断是否正在抽奖
			if (running) return;
			// 设置为正在抽奖
			running = true;
				
			// 可抽取的奖项编号（1~8）排除已经抽取的
			const available = Array.from({ length: award.length }, (_, i) =&gt; i + 1)
				.filter(i =&gt; !lucks.includes(i));
				
			// 全部抽完
			if (available.length === 0) {
				startBtn.innerHTML = "所有奖项已抽完";
				running = false;
				return;
			}
				
			// 随机中奖编号（1~8中未抽的一个）
			const target = available[Math.floor(Math.random() * available.length)];
				
			// 随机圈数（2~4圈）
			const rounds = Math.floor(Math.random() * 2) + 2;
			const totalSteps = rounds * award.length + (target - 1);
				
			let current = 0;
			let speed = 60;
				
			function spin() {
				const index = current % award.length;
				
				// 重置未中奖项颜色
				for (let i = 0; i &lt; award.length; i++) {
					if (!lucks.includes(i + 1)) {
						award[i].className = "award unselected";
					}
				}
				
				// 高亮当前
				award[index].className = "selected award";
				
				current++;
				
				// 是否结束
				if (current &gt; totalSteps) {
					lucks.push(index + 1);
					startBtn.innerHTML = `恭喜您中了&lt;br&gt;${index + 1}等奖 🎊`;
					running = false;
					return;
				}
				
				// 越接近目标速度越慢
				if (totalSteps - current &lt; award.length) {
					speed += 40;
				}
				
				setTimeout(spin, speed);
			}
				
			spin();
		};
	&lt;/script&gt;
</code></pre>
<h2 data-id="heading-4">完整代码</h2>
<pre><code class="hljs language-js" lang="js">

&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>幸运转盘<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
			<span class="hljs-selector-tag">body</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">flex-direction</span>: column;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">overflow</span>: hidden;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'img/background.jpg'</span>);
				<span class="hljs-comment">/* 背景图片居中 */</span>
				<span class="hljs-attribute">background-position</span>: center;
				<span class="hljs-comment">/* 背景图片不重复 */</span>
				<span class="hljs-attribute">background-repeat</span>: no-repeat;
			}


			<span class="hljs-comment">/* 幸运抽奖的标题图片 */</span>
			<span class="hljs-selector-class">.draw-title</span> {
				<span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
				<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">10px</span>);
			}


			<span class="hljs-comment">/*  转盘的外层边框 */</span>
			<span class="hljs-selector-id">#turntable-content</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">flex-wrap</span>: wrap;
				<span class="hljs-attribute">gap</span>: <span class="hljs-number">5px</span>;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#922a21</span>;
				<span class="hljs-attribute">position</span>: relative;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">510px</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">410px</span>;
				<span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
				<span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
			}


			<span class="hljs-comment">/*  转盘下面的每个模块样式 */</span>
			<span class="hljs-selector-id">#turntable-content</span>&gt;<span class="hljs-selector-tag">div</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">160px</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">130px</span>;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">25px</span>;
			}






			<span class="hljs-comment">/* 幸运转盘最外层 */</span>
			<span class="hljs-selector-class">.draw-turntable-box</span> {
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5%</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-number">#de4b3f</span>;
				<span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">600px</span>;
			}


			<span class="hljs-comment">/* 开始抽奖按钮 */</span>
			<span class="hljs-selector-id">#startBtn</span> {
				<span class="hljs-attribute">cursor</span>: pointer;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">display</span>: flex;
				<span class="hljs-attribute">align-items</span>: center;
				<span class="hljs-attribute">justify-content</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">22px</span>;
				<span class="hljs-attribute">white-space</span>: normal;
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eb5e4a</span>;
				<span class="hljs-attribute">color</span>: white;
			}
			
			<span class="hljs-comment">/* 奖项 */</span>
			<span class="hljs-selector-class">.unselected</span> {
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8e7c1</span>;
			}
			
			<span class="hljs-selector-class">.selected</span> {
				<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ee7c45</span>;
			}
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./img/draw.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"抽奖标题"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"draw-title"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"draw-turntable-box"</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"turntable-content"</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>一等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>二等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>三等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>四等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startBtn"</span>&gt;</span>参与游戏<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>赢得大奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>五等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>六等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>七等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"award unselected"</span>&gt;</span>八等奖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
			<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>


	<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
		<span class="hljs-comment">// 奖项元素列表</span>
		<span class="hljs-keyword">var</span> award = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">"award"</span>);
		<span class="hljs-comment">// 已经拿到的奖励序号</span>
		<span class="hljs-keyword">const</span> lucks = [];
		<span class="hljs-comment">// 是否正在抽奖</span>
		<span class="hljs-keyword">let</span> running = <span class="hljs-literal">false</span>;
		
		<span class="hljs-comment">// 开始按钮元素</span>
		<span class="hljs-keyword">var</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"startBtn"</span>);
		
		startBtn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
			<span class="hljs-comment">// 判断是否正在抽奖</span>
			<span class="hljs-keyword">if</span> (running) <span class="hljs-keyword">return</span>;
			<span class="hljs-comment">// 设置为正在抽奖</span>
			running = <span class="hljs-literal">true</span>;
				
			<span class="hljs-comment">// 可抽取的奖项编号（1~8）排除已经抽取的</span>
			<span class="hljs-keyword">const</span> available = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: award.<span class="hljs-property">length</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i + <span class="hljs-number">1</span>)
				.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> !lucks.<span class="hljs-title function_">includes</span>(i));
				
			<span class="hljs-comment">// 全部抽完</span>
			<span class="hljs-keyword">if</span> (available.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
				startBtn.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"所有奖项已抽完"</span>;
				running = <span class="hljs-literal">false</span>;
				<span class="hljs-keyword">return</span>;
			}
				
			<span class="hljs-comment">// 随机中奖编号（1~8中未抽的一个）</span>
			<span class="hljs-keyword">const</span> target = available[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * available.<span class="hljs-property">length</span>)];
				
			<span class="hljs-comment">// 随机圈数（2~4圈）</span>
			<span class="hljs-keyword">const</span> rounds = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2</span>) + <span class="hljs-number">2</span>;
			<span class="hljs-keyword">const</span> totalSteps = rounds * award.<span class="hljs-property">length</span> + (target - <span class="hljs-number">1</span>);
				
			<span class="hljs-keyword">let</span> current = <span class="hljs-number">0</span>;
			<span class="hljs-keyword">let</span> speed = <span class="hljs-number">60</span>;
				
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">spin</span>(<span class="hljs-params"/>) {
				<span class="hljs-keyword">const</span> index = current % award.<span class="hljs-property">length</span>;
				
				<span class="hljs-comment">// 重置未中奖项颜色</span>
				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; award.<span class="hljs-property">length</span>; i++) {
					<span class="hljs-keyword">if</span> (!lucks.<span class="hljs-title function_">includes</span>(i + <span class="hljs-number">1</span>)) {
						award[i].<span class="hljs-property">className</span> = <span class="hljs-string">"award unselected"</span>;
					}
				}
				
				<span class="hljs-comment">// 高亮当前</span>
				award[index].<span class="hljs-property">className</span> = <span class="hljs-string">"selected award"</span>;
				
				current++;
				
				<span class="hljs-comment">// 是否结束</span>
				<span class="hljs-keyword">if</span> (current &gt; totalSteps) {
					lucks.<span class="hljs-title function_">push</span>(index + <span class="hljs-number">1</span>);
					startBtn.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`恭喜您中了&lt;br&gt;<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>等奖 🎊`</span>;
					running = <span class="hljs-literal">false</span>;
					<span class="hljs-keyword">return</span>;
				}
				
				<span class="hljs-comment">// 越接近目标速度越慢</span>
				<span class="hljs-keyword">if</span> (totalSteps - current &lt; award.<span class="hljs-property">length</span>) {
					speed += <span class="hljs-number">40</span>;
				}
				
				<span class="hljs-built_in">setTimeout</span>(spin, speed);
			}
				
			<span class="hljs-title function_">spin</span>();
		};
	</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</span></code></pre>
<p>转载自DOIT社区<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.doitwiki.com%2Farticle%2Fdetails%2F180486793636864" target="_blank" title="https://www.doitwiki.com/article/details/180486793636864" ref="nofollow noopener noreferrer">纯原生html js实现幸运抽奖转盘功能-奖项不重复(javascript小案例)-DOIT社区</a> 如有需要大家可以去此地址拿取文件</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React、TypeScript、reduce 以及 Ant Design Pro Components（antProcomponent）搭建开发环境教程]]></title>    <link>https://juejin.cn/post/7600986495927140393</link>    <guid>https://juejin.cn/post/7600986495927140393</guid>    <pubDate>2026-01-31T01:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986495927140393" data-draft-id="7600986495927107625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React、TypeScript、reduce 以及 Ant Design Pro Components（antProcomponent）搭建开发环境教程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-31T01:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React、TypeScript、reduce 以及 Ant Design Pro Components（antProcomponent）搭建开发环境教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:29:07.000Z" title="Sat Jan 31 2026 01:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你想要的是一套完整的教程，指导如何搭建一个结合了 React、TypeScript、reduce 以及 Ant Design Pro Components（antProcomponent）的开发环境，我会一步步带你完成这个过程。</p>
<h4 data-id="heading-0">一、环境准备（前置条件）</h4>
<p>在开始前，请确保你的电脑已安装以下工具：</p>
<ol>
<li>Node.js（推荐 16.x 或 18.x 版本，可通过 ​<code>​node -v​</code>​ 检查）</li>
<li>npm 或 yarn（npm 随 Node.js 自带，yarn 可通过 ​<code>​npm install -g yarn​</code>​ 安装）</li>
<li>代码编辑器（推荐 VS Code）</li>
</ol>
<h4 data-id="heading-1">二、搭建 React + TypeScript 基础项目</h4>
<p>Ant Design Pro 提供了开箱即用的脚手架，能快速集成 TypeScript 和 Pro Components，比手动配置更高效：</p>
<h5 data-id="heading-2">步骤 1：创建 Ant Design Pro 项目</h5>
<p>打开终端，执行以下命令（选择 TypeScript 模板）：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用官方脚手架创建项目</span>
npm create umi@latest <span class="hljs-keyword">my</span>-pro-app
<span class="hljs-comment"># 或用 yarn</span>
yarn create umi <span class="hljs-keyword">my</span>-pro-app
</code></pre>
<p>执行后会出现交互式选择，按以下选项配置：</p>
<ol>
<li>选择 ​<code>​ant-design-pro​</code>​（Pro 模板）</li>
<li>选择 ​<code>​TypeScript​</code>​（语言）</li>
<li>选择 ​<code>​simple​</code>​（简易模板，适合新手）</li>
<li>确认安装依赖（等待依赖下载完成）</li>
</ol>
<h5 data-id="heading-3">步骤 2：安装依赖并启动项目</h5>
<p>进入项目目录，安装依赖并启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> my-pro-app
<span class="hljs-comment"># 安装依赖</span>
npm install
<span class="hljs-comment"># 启动开发服务</span>
npm run start
</code></pre>
<p>启动成功后，浏览器会自动打开 ​<code>​http://localhost:8000​</code>​，能看到 Ant Design Pro 的基础页面，说明 React + TypeScript + Pro Components 环境已搭建完成。</p>
<h4 data-id="heading-4">三、集成 reduce（数组方法）的实战示例</h4>
<p>React 中常使用 ​<code>​reduce​</code>​ 处理数组数据（比如数据聚合、筛选、格式化），结合 TypeScript 能保证类型安全，以下是结合 Pro Components（如 ProTable）的实战示例：</p>
<h5 data-id="heading-5">示例：用 reduce 处理表格数据并渲染 ProTable</h5>
<ol>
<li>在 ​<code>​src/pages​</code>​ 下新建 ​<code>​ReduceDemo.tsx​</code>​ 文件，写入以下代码：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/pro-components'</span>;

<span class="hljs-comment">// 定义数据类型（TypeScript 类型约束）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserData</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">department</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">salary</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReduceDemo</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 原始模拟数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">rawData</span>: <span class="hljs-title class_">UserData</span>[] = [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">department</span>: <span class="hljs-string">'前端'</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">15000</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">department</span>: <span class="hljs-string">'后端'</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">18000</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'王五'</span>, <span class="hljs-attr">department</span>: <span class="hljs-string">'前端'</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">16000</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'赵六'</span>, <span class="hljs-attr">department</span>: <span class="hljs-string">'后端'</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">20000</span> },
  ];

  <span class="hljs-comment">// 用 reduce 聚合：按部门分组，计算每个部门的平均工资</span>
  <span class="hljs-keyword">const</span> departmentSalary = rawData.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
    <span class="hljs-comment">// 类型守卫，确保 acc 结构正确</span>
    <span class="hljs-keyword">if</span> (!acc[item.<span class="hljs-property">department</span>]) {
      acc[item.<span class="hljs-property">department</span>] = {
        <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">average</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">list</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">UserData</span>[],
      };
    }
    <span class="hljs-comment">// 累加工资和人数</span>
    acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">total</span> += item.<span class="hljs-property">salary</span>;
    acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 存入当前用户</span>
    acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(item);
    <span class="hljs-comment">// 计算平均工资（保留2位小数）</span>
    acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">average</span> = <span class="hljs-title class_">Number</span>(
      (acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">total</span> / acc[item.<span class="hljs-property">department</span>].<span class="hljs-property">count</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)
    );
    <span class="hljs-keyword">return</span> acc;
  }, {} <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, { <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">average</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">list</span>: <span class="hljs-title class_">UserData</span>[] }&gt;);

  <span class="hljs-comment">// 转换为 ProTable 可渲染的格式</span>
  <span class="hljs-keyword">const</span> tableData = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(departmentSalary).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[dept, data]</span>) =&gt;</span> ({
    <span class="hljs-attr">department</span>: dept,
    <span class="hljs-attr">totalSalary</span>: data.<span class="hljs-property">total</span>,
    <span class="hljs-attr">personCount</span>: data.<span class="hljs-property">count</span>,
    <span class="hljs-attr">averageSalary</span>: data.<span class="hljs-property">average</span>,
  }));

  <span class="hljs-comment">// ProTable 列配置</span>
  <span class="hljs-keyword">const</span> columns = [
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'部门'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'department'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'department'</span>,
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'总工资'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'totalSalary'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'totalSalary'</span>,
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'人数'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'personCount'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'personCount'</span>,
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'平均工资'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'averageSalary'</span>,
      <span class="hljs-attr">key</span>: <span class="hljs-string">'averageSalary'</span>,
    },
  ];

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Reduce + ProTable 实战示例<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProTable</span>
        <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{tableData}</span>
        <span class="hljs-attr">columns</span>=<span class="hljs-string">{columns}</span>
        <span class="hljs-attr">rowKey</span>=<span class="hljs-string">"department"</span>
        <span class="hljs-attr">pagination</span>=<span class="hljs-string">{false}</span>
        <span class="hljs-attr">title</span>=<span class="hljs-string">{()</span> =&gt;</span> '各部门工资统计（基于reduce聚合）'}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ReduceDemo</span>;
</code></pre>
<ol start="2">
<li>配置路由：修改 ​<code>​src/config/routes.ts​</code>​，添加新路由：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IRouteProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@umijs/max'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">IRouteProps</span>[] = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/reduce-demo'</span>,
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/reduce-demo'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Reduce示例'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-string">'./ReduceDemo'</span>,
  },
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> routes;
</code></pre>
<ol start="3">
<li>重启项目（​<code>​npm run start​</code>​），访问 ​<code>​http://localhost:8000/reduce-demo​</code>​，就能看到用 ​<code>​reduce​</code>​ 聚合后的数据通过 ProTable 渲染的表格。</li>
</ol>
<h4 data-id="heading-6">四、关键知识点解释</h4>
<ol>
<li><strong>TypeScript 类型约束</strong>：</li>
</ol>
<ul>
<li>定义 ​<code>​UserData​</code>​ 接口规范原始数据结构，避免类型错误；</li>
<li>​<code>​Record&lt;string, ...&gt;​</code>​ 约束 ​<code>​reduce​</code>​ 累加器的类型，确保 ​<code>​acc​</code>​ 的属性和值类型符合预期。</li>
</ul>
<ol start="2">
<li><strong>reduce 核心逻辑</strong>：</li>
</ol>
<ul>
<li>第一个参数：回调函数，接收 ​<code>​acc​</code>​（累加器）和 ​<code>​item​</code>​（当前项），返回更新后的累加器；</li>
<li>第二个参数：累加器初始值（这里是空对象，且用 TypeScript 定义了结构）；</li>
<li>作用：替代循环，高效完成“分组 + 计算”的聚合操作。</li>
</ul>
<ol start="3">
<li><strong>Ant Design Pro Components 优势</strong>：</li>
</ol>
<ul>
<li>​<code>​ProTable​</code>​ 内置了分页、筛选、排序等功能，比原生 Table 更易用；</li>
<li>支持 TypeScript 类型推导，列配置的 ​<code>​dataIndex​</code>​ 会自动校验是否匹配数据源。</li>
</ul>
<h4 data-id="heading-7">总结</h4>
<ol>
<li>环境搭建核心：通过 Ant Design Pro 脚手架快速集成 React + TypeScript + Pro Components，无需手动配置复杂的 Webpack/TSConfig；</li>
<li>reduce 实战：结合 TypeScript 类型约束，用 reduce 完成数组聚合（分组、计算），再通过 ProTable 渲染结果；</li>
<li>关键要点：TypeScript 接口/类型守卫保证类型安全，reduce 替代循环提升代码简洁性，Pro Components 简化业务组件开发。</li>
</ol>
<p>如果需要扩展功能（比如接口请求、状态管理），可以基于这个基础环境，结合 Umi Max 的请求库（​<code>​@umijs/max​</code>​）或 React Context/Redux 进一步开发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack 完成工程化建设]]></title>    <link>https://juejin.cn/post/7600955777316716582</link>    <guid>https://juejin.cn/post/7600955777316716582</guid>    <pubDate>2026-01-31T01:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316716582" data-draft-id="7600560664407375935" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack 完成工程化建设"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-31T01:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ccccc__"/> <meta itemprop="url" content="https://juejin.cn/user/3496880960971997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack 完成工程化建设
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3496880960971997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ccccc__
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:34:15.000Z" title="Sat Jan 31 2026 01:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言 -- 我们为什么需要 webpack 等打包工具来进行工程化</h2>
<p>我们在实现一个网页项目的时候，通常都会有很多的 js，css，其他的一些资源文件。如果我们直接丢给浏览器的话，他将会面临两个大问题：
1.要请求加载这些文件，速度很慢，会影响加载的效率。
2.浏览器对于某些文件无法识别，例如第三方node_module， ts，less 代码等文件。</p>
<p>这涉及到开发过程和运行过程，这些问题都是我们的痛点所在。开发过程我们希望改动文件后编辑加载的速度能更快，让我们更好的调试代码。运行上线的时候我们则是希望能够加载的更加顺畅。这就是我们的打包工具所要解决的问题，我们通过使用打包工具，将这些文件进行加工，将他们整合成尽可能少的文件数量，以及浏览器能够识别的文件来进行编译。</p>
<h2 data-id="heading-1">核心概念 =&gt; webpack</h2>
<h4 data-id="heading-2">webpack</h4>
<p>webpack 是一个用于前端开发的静态模块打包工具，能够将项目中的各种资源（如javaScript，css，图片等）视为模块，通过分析依赖关系打包成优化后的静态文件来提升开发效率和项目可维护性。</p>
<h5 data-id="heading-3">关键组成部分</h5>
<p>入口：Entry：指定打包的入口文件
出口：Output：定义打包后的文件的输出路径和名称。
加载器：Loader：负责将各类非 JavaSript 资源转化成模块。（帮助浏览器将有可能无法识别的文件转化成能够识别的文件）
插件：Plugin：用于执行复杂的自定义任务，扩展 webpack 功能。
文件别名配置：resolve</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-comment">// 入口配置</span>
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/main.js'</span>,  
    <span class="hljs-comment">// 产物输出路径</span>
    <span class="hljs-attr">output</span>: {}, 
    <span class="hljs-comment">// 配置模块解析的具体行为，(定义 webpack 在打包的时候，是怎么找到并解析具体模块)</span>
    <span class="hljs-attr">resolve</span>: {
      <span class="hljs-attr">extensions</span>: [<span class="hljs-string">".js"</span>, <span class="hljs-string">".vue"</span>, <span class="hljs-string">".less"</span>, <span class="hljs-string">"css"</span>] <span class="hljs-comment">// 自动解析这些文件</span>
      <span class="hljs-attr">alias</span>: { <span class="hljs-attr">$xxxx</span>: xxxx } <span class="hljs-comment">// 可以将对应的路径文件指向一个具体的替代</span>
    }, 
    <span class="hljs-comment">// 配置插件</span>
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">// 处理vue文件，将我们设定的规则都能够在vue文件中运行</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueLoaderPlugin</span>(),
        <span class="hljs-comment">// 把第三方库暴露到全局 window 上下文, 可以在文件中直接使用，例如 vue， axios等库，无需再单独导入</span>
        <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">ProvidePlugin</span>({
             <span class="hljs-title class_">Vue</span>: <span class="hljs-string">"vue"</span>,
             <span class="hljs-attr">axios</span>: <span class="hljs-string">"axios"</span>,
             <span class="hljs-attr">_</span>: <span class="hljs-string">"lodash"</span>,
        }),
        <span class="hljs-comment">// 定义全局常量 关于vue的一些设置</span>
        <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
          <span class="hljs-attr">_VUE_OPTIONS_API_</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 支持vue解析optionsApi</span>
          <span class="hljs-attr">_VUE_PROD_DEVTOOLS_</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用vue调试工具</span>
          <span class="hljs-attr">_VUE_PROD_HYDRATIO_MISMATCH_DETAILS_</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用生产环境显示 '水合' 信息</span>
        }),
        <span class="hljs-comment">// 渲染我们指定的模板代码</span>
         <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
              <span class="hljs-comment">// 产物（最终模板）输出路径</span>
              <span class="hljs-attr">filename</span>: path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">"../app/public/dist/entry.tpl"</span>),
              <span class="hljs-comment">// 指定要使用的模板文件</span>
              <span class="hljs-attr">template</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"../../view/entry.tpl"</span>), 
              <span class="hljs-comment">// 要注入的代码块</span>
              <span class="hljs-attr">chunks</span>: [<span class="hljs-string">`<span class="hljs-subst">${enrtyName}</span>`</span>], 
    })
    ], 
    <span class="hljs-comment">// 打包输出优化（配置代码分割，缓存，Treeshaing，压缩优化行为）</span>
    <span class="hljs-attr">optimization</span>: {
     <span class="hljs-comment">// 将 js 文件打包成三种类型</span>
     <span class="hljs-comment">// 1. vendor: 第三方库代码</span>
     <span class="hljs-comment">// 2. common：业务组件代码的公共部分</span>
     <span class="hljs-comment">// 3. entry：每个页面独有的业务代码</span>
     <span class="hljs-comment">// 将改动频率不一样的js区分出来，更好的利用浏览器缓存的效果</span>
     <span class="hljs-attr">splitChunks</span>: {
         <span class="hljs-comment">// 对所有的模板都进行分割</span>
         <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>, 
         <span class="hljs-comment">// 每次异步加载的最大并行请求数</span>
         <span class="hljs-attr">maxAsyncRequests</span>: <span class="hljs-number">10</span>,
         <span class="hljs-comment">// 入口点的最大并行请求数量</span>
         <span class="hljs-attr">maxInitialRequests</span>: <span class="hljs-number">10</span>,
          <span class="hljs-attr">cacheGroups</span>: {
          <span class="hljs-attr">vendor</span>: {
            <span class="hljs-comment">//第三方依赖库</span>
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>, <span class="hljs-comment">//打包node_modules中的文件</span>
            <span class="hljs-attr">name</span>: <span class="hljs-string">"vendor"</span>, <span class="hljs-comment">//模块名称</span>
            <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">//优先级</span>
            <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//强制执行</span>
            <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//可复用已存在的模块</span>
          },
          <span class="hljs-attr">common</span>: {
            <span class="hljs-comment">//公共模块</span>
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]common|widgets[\\/]/</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">"common"</span>, <span class="hljs-comment">//模块名称</span>
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">//最少被两个模块引用才打包</span>
            <span class="hljs-attr">minSize</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">//最小分割文件大小</span>
            <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// 优先级</span>
            <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//可复用已存在的模块</span>
          },
        },
     }
    } 
}
</code></pre>
<p>基础的配置如上述代码所示，这样子我们就完成了一个基础的 webpack 配置。</p>
<h4 data-id="heading-4">工程化设计</h4>
<h5 data-id="heading-5">多环境差异化配置</h5>
<p>我们可以划分成为开发环境和生产环境，每个环境对应的配置有共同性，也有差异性，开发环境更注重调试和开发效率，而生产环境则更重视代码压缩和资源优化，所以我们将其配置文件划分成为三块</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c5ff5567ae74212971ec1e97a5ef18d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2NjY2NfXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770428054&amp;x-signature=QDKVev9Z5QDKR7ngh387dmEEr%2Bg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>webpack.base.js: 做多入口文件配置，模板生成，还有一些共同性的配置，然后暴露出去为baseConfig，用于其他环境配置对他进行扩展。</li>
<li>webpack.dev.js: 热更新HMR，devtool开发工具，热更新插件配置</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>)
<span class="hljs-comment">// 基类配置</span>
<span class="hljs-keyword">const</span> baseConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.base.js'</span>);

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEV_SERVER_CONFIG</span> = {
    <span class="hljs-attr">HOST</span>: <span class="hljs-string">'127.0.0.1'</span>,
    <span class="hljs-attr">PORT</span>: <span class="hljs-number">9002</span>,
    <span class="hljs-attr">HMR_PATH</span>: <span class="hljs-string">'__webpack_hmr'</span>, <span class="hljs-comment">// 官方规定，修正命名</span>
    <span class="hljs-attr">TIMEOUT</span>: <span class="hljs-number">20000</span>
}


<span class="hljs-comment">//开发阶段的entry配置需要加入hmr</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(baseConfig.<span class="hljs-property">entry</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> {
    <span class="hljs-comment">//第三方包不作为hmr入口</span>
    <span class="hljs-keyword">if</span> (v !== <span class="hljs-string">'vendor'</span>) {
        baseConfig.<span class="hljs-property">entry</span>[v] = [
            <span class="hljs-comment">//主入口文件</span>
            baseConfig.<span class="hljs-property">entry</span>[v],
            <span class="hljs-comment">//hmr更新入口，官方指定的hmr路径</span>
            <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'webpack-hot-middleware/client'</span>)}</span>?path=http://<span class="hljs-subst">${DEV_SERVER_CONFIG.HOST}</span>:<span class="hljs-subst">${DEV_SERVER_CONFIG.PORT}</span>/<span class="hljs-subst">${DEV_SERVER_CONFIG.HMR_PATH}</span>&amp;timeout=<span class="hljs-subst">${DEV_SERVER_CONFIG.TIMEOUT}</span>&amp;reload=true`</span>
        ]
    }
}) 

<span class="hljs-comment">//开发环境 webpack 配置</span>
<span class="hljs-keyword">const</span> webpackDevConfig = merge.<span class="hljs-title function_">smart</span>(baseConfig, {
    <span class="hljs-comment">//指定开发环境</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
    <span class="hljs-comment">//source-map 开发工具，呈现代码映射关系，以便在开发过程中调试代码</span>
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'eval-cheap-module-source-map'</span>,
    <span class="hljs-comment">//开发阶段output配置</span>
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'js/[name]_[chunkhash:8].bundle.js'</span>,
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/public/dist/dev/'</span>), <span class="hljs-comment">//输出文件存储路径</span>
        <span class="hljs-attr">publicPath</span>: <span class="hljs-string">`http://<span class="hljs-subst">${DEV_SERVER_CONFIG.HOST}</span>:<span class="hljs-subst">${DEV_SERVER_CONFIG.PORT}</span>/public/dist/dev`</span>, <span class="hljs-comment">//外部资源公共路径</span>
        <span class="hljs-attr">globalObject</span>: <span class="hljs-string">'this'</span>
    },
    <span class="hljs-comment">//开发阶段插件</span>
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">//用于实现热模块替换（）</span>
        <span class="hljs-comment">//允许在运用程序运行时替换模块</span>
        <span class="hljs-comment">//极大的提升开发效率，因为能让应用程序一直保持运行状态</span>
        <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">HotModuleReplacementPlugin</span>({
            <span class="hljs-attr">multiStep</span>: <span class="hljs-literal">false</span>,
        })
    ]
})

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-comment">// webpack 配置（导出为 `webpackDevConfig` 以匹配使用处）</span>
    webpackDevConfig,
    <span class="hljs-comment">// devServer 配置 暴露给 dev.js 使用</span>
    <span class="hljs-variable constant_">DEV_SERVER_CONFIG</span>
};
</code></pre>
<ul>
<li>webpack.prod.js: 重视代码资源，会做一些代码压缩操作，tree-shaking 剔除无用代码，以及happypack多线程打包</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HappyPack</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'happypack'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CleanWEbpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'clean-webpack-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CSSMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-minimizer-webpack-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackInjectAttributesPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-inject-attributes-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);
<span class="hljs-comment">// 基类配置</span>
<span class="hljs-keyword">const</span> baseConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.base.js'</span>);

<span class="hljs-comment">//多线程build配置</span>
<span class="hljs-keyword">const</span> happypackCommonConfig = {
    <span class="hljs-attr">debug</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">threadPool</span>: <span class="hljs-title class_">HappyPack</span>.<span class="hljs-title class_">ThreadPool</span>({ <span class="hljs-attr">size</span>: os.<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span> }),
}


<span class="hljs-comment">//生产环境 webpack 配置</span>
<span class="hljs-keyword">const</span> webpackProdConfig = merge.<span class="hljs-title function_">smart</span>(baseConfig, {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>, <span class="hljs-comment">//指定生产环境</span>
    <span class="hljs-attr">output</span>: baseConfig.<span class="hljs-property">output</span> = {
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'js/[name]_[chunkhash:8].bundle.js'</span>,
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/public/dist/prod'</span>),
        <span class="hljs-attr">publicPath</span>: <span class="hljs-string">'/dist/prod/'</span>,
        <span class="hljs-attr">crossOriginLoading</span>: <span class="hljs-string">'anonymous'</span>
    },
    <span class="hljs-attr">module</span>: {
        <span class="hljs-attr">rules</span>: [{
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
            <span class="hljs-attr">use</span>: [<span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'happypack/loader'</span>)}</span>?id=css`</span>]
        }, {
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
            <span class="hljs-attr">include</span>: [
                path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../../pages'</span>),
                <span class="hljs-comment">// 处理业务目录下的</span>
                path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">"./app/pages"</span>),
            ],
            <span class="hljs-attr">use</span>: [<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'happypack/loader'</span>)}</span>?id=js`</span>]
        }]
    },
    <span class="hljs-comment">// webpack 不会有大量 hints 信息， 默认为 warning</span>
    <span class="hljs-attr">performance</span>: {
        <span class="hljs-attr">hints</span>: <span class="hljs-literal">false</span>
    },
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">//每次 build 前清空public/dist目录</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CleanWEbpackPlugin</span>([<span class="hljs-string">'public/dist/prod'</span>], {
            <span class="hljs-attr">root</span>: path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/'</span>),
            <span class="hljs-attr">exclued</span>: [],
            <span class="hljs-attr">verbose</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">dry</span>: <span class="hljs-literal">false</span>
        }),
        <span class="hljs-comment">//提取css的公共部分，有效利用缓存，非公共的css使用inline</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
            <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'css/[name]_[contenthash:8].bundle.css'</span>,
        }),
        <span class="hljs-comment">//优化并压缩css资源</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSSMinimizerPlugin</span>(),
        <span class="hljs-comment">//多线程打包js，加快打包速度</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HappyPack</span>({
            ...happypackCommonConfig,
            <span class="hljs-attr">id</span>: <span class="hljs-string">'js'</span>,
            <span class="hljs-attr">loaders</span>: [<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'babel-loader'</span>)}</span>?<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
                presets: [<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'@babel/preset-env'</span>)],
                plugins: [
                    <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'@babel/plugin-transform-runtime'</span>),
                ]
            })}</span>`</span>]
        }),
        <span class="hljs-comment">//多线程打包css，加快打包速度</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HappyPack</span>({
            ...happypackCommonConfig,
            <span class="hljs-attr">id</span>: <span class="hljs-string">'css'</span>,
            <span class="hljs-attr">loaders</span>: [{
                <span class="hljs-attr">path</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'css-loader'</span>),
                <span class="hljs-attr">options</span>: {
                    <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">1</span>
                }
            }]
        }),
        <span class="hljs-comment">//浏览器在请求资源的时候，不发送用户的身份凭证</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackInjectAttributesPlugin</span>({
            <span class="hljs-attr">corssorigin</span>: <span class="hljs-string">'anonymous'</span>
        })
    ],
    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-comment">//使用 TerserPlugin 的并发和缓存，提升压缩阶段的性能</span>
        <span class="hljs-comment">//清除console.log</span>
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
                <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//启用缓存来加速构建过程</span>
                <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//利用多核cpu的优势加快压缩速度</span>
                <span class="hljs-attr">terserOptions</span>: {
                    <span class="hljs-attr">compress</span>: {
                        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">//去掉console.log</span>
                    }
                }
            })
        ]
    }
})

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = webpackProdConfig;

</code></pre>
<h5 data-id="heading-6">多入口配置，只要按照约定好的文件格式创建文件，即可自动引入为入口文件，并且生成对应的HTML模板，无需手动一个个配置入口文件</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 动态构建 pageEntryies htmlWebpackPluginList</span>
<span class="hljs-keyword">const</span> elpisPageEntries = {};
<span class="hljs-keyword">const</span> elpisHtmlWebpackPPluginList = [];

<span class="hljs-comment">// 获取 app/pages 下的所有入口文件</span>
<span class="hljs-keyword">const</span> elpisEntryList = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"../../pages/**/entry.*.js"</span>);

glob.<span class="hljs-title function_">sync</span>(elpisEntryList).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
  <span class="hljs-title function_">handleEntry</span>(file, elpisPageEntries, elpisHtmlWebpackPPluginList);
});

<span class="hljs-comment">// 动态构建 业务页面入口</span>
<span class="hljs-keyword">const</span> businessEntries = {};
<span class="hljs-keyword">const</span> businessHtmlWebpackPPluginList = [];

<span class="hljs-keyword">const</span> businessEntryList = path.<span class="hljs-title function_">resolve</span>(
  process.<span class="hljs-title function_">cwd</span>(),
  <span class="hljs-string">"./app/pages/**/entry.*.js"</span>
);
glob.<span class="hljs-title function_">sync</span>(businessEntryList).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
  <span class="hljs-title function_">handleEntry</span>(file, businessEntries, businessHtmlWebpackPPluginList);
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEntry</span>(<span class="hljs-params">file, entries = {}, htmlWebpackPPluginList = []</span>) {
  <span class="hljs-keyword">const</span> enrtyName = path.<span class="hljs-title function_">basename</span>(file, <span class="hljs-string">".js"</span>);
  <span class="hljs-comment">//构造entry</span>
  entries[enrtyName] = file;
  <span class="hljs-comment">//构造最终渲染的页面文件</span>
  htmlWebpackPPluginList.<span class="hljs-title function_">push</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
      <span class="hljs-attr">filename</span>: path.<span class="hljs-title function_">resolve</span>(
        process.<span class="hljs-title function_">cwd</span>(),
        <span class="hljs-string">"./app/public/dist/"</span>,
        <span class="hljs-string">`<span class="hljs-subst">${enrtyName}</span>.tpl`</span>
      ), <span class="hljs-comment">//产物（最终模板）输出路径</span>
      <span class="hljs-attr">template</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"../../view/entry.tpl"</span>), <span class="hljs-comment">//指定要使用的模板文件</span>
      <span class="hljs-attr">chunks</span>: [<span class="hljs-string">`<span class="hljs-subst">${enrtyName}</span>`</span>], <span class="hljs-comment">//要注入的代码块</span>
    })
  );
}

<span class="hljs-comment">// 加载 业务 webpack 配置</span>
<span class="hljs-keyword">let</span> businessWebpackConfig = {};
<span class="hljs-keyword">try</span> {
  businessWebpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">${process.cwd()}</span>/app/webpack.config.js`</span>);
} <span class="hljs-keyword">catch</span> (e) {}
</code></pre>
<h5 data-id="heading-7">如何实现热更新？</h5>
<p>热更新的流程可以概括为：监控文件改动 -&gt; 识别模块变化 -&gt; 通知浏览器 -&gt; 浏览器局部更新。
热更新可以划分成为两个重点，如何监听文件修改？，如何告知浏览器？
webpack其实提供了两个核心的中间件来帮助我们实现热更新，devMiddleware（文件监控和编译），hotMiddleware（与浏览器通信）</p>
<pre><code class="hljs language-js" lang="js"> app.<span class="hljs-title function_">use</span>(
    <span class="hljs-title function_">devMiddleware</span>(compiler, {
      <span class="hljs-comment">//落地文件</span>
      <span class="hljs-attr">writeToDisk</span>: <span class="hljs-function">(<span class="hljs-params">filePath</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> filePath.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">".tpl"</span>);
      },
      <span class="hljs-comment">//资源路径</span>
      <span class="hljs-attr">publicPath</span>: webpackDevConfig.<span class="hljs-property">output</span>.<span class="hljs-property">publicPath</span>,

      <span class="hljs-comment">//headers配置</span>
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">"Access-Control-Allow-Origin"</span>: <span class="hljs-string">"*"</span>,
        <span class="hljs-string">"Access-Control-Allow-Methods"</span>:
          <span class="hljs-string">"GET, POST, PUT, DELETE, PATCH, OPTIONS"</span>,
        <span class="hljs-string">"Access-Control-Allow-Headers"</span>:
          <span class="hljs-string">"X-Requested-With, content-type, Authorization"</span>,
      },

      <span class="hljs-attr">stats</span>: {
        <span class="hljs-attr">color</span>: <span class="hljs-literal">true</span>,
      },
    })
  );
  <span class="hljs-comment">//引用hotMiddleware中间件，实现热更新</span>
  app.<span class="hljs-title function_">use</span>(
    <span class="hljs-title function_">hotMiddleware</span>(compiler, {
      <span class="hljs-attr">path</span>: <span class="hljs-string">`/<span class="hljs-subst">${DEV_SERVER_CONFIG.HMR_PATH}</span>`</span>,
      <span class="hljs-attr">log</span>: <span class="hljs-function">() =&gt;</span> {},
    })
  );
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别繁琐解析！Proxy 如何重塑 Vue3 编译时性能？]]></title>    <link>https://juejin.cn/post/7600976289064583168</link>    <guid>https://juejin.cn/post/7600976289064583168</guid>    <pubDate>2026-01-31T01:45:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600976289064583168" data-draft-id="7600588379105394740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别繁琐解析！Proxy 如何重塑 Vue3 编译时性能？"/> <meta itemprop="keywords" content="JavaScript,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T01:45:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别繁琐解析！Proxy 如何重塑 Vue3 编译时性能？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:45:12.000Z" title="Sat Jan 31 2026 01:45:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue3 的全链路优化体系中，Proxy 不仅是响应式系统的核心基石，更是编译时优化的“隐形推手”。前文我们探讨了 Tree-shaking、静态提升、PatchFlag 等编译与渲染层面的优化，而这些优化能高效落地，离不开 Proxy 从底层重构了“响应式追踪”与“编译时解析”的逻辑。与 Vue2 依赖 Object.defineProperty 必须进行大量字符串解析不同，Vue3 Proxy 凭借其原生特性，彻底摆脱了繁琐的字符串解析开销，让编译时效率实现质的飞跃。本文将深度拆解 Proxy 带来的编译时优化核心，对比 Vue2 与 Vue3 编译时解析的差异，揭秘 Proxy 如何简化编译流程、提升解析效率，完善 Vue3 优化知识体系。</p>
<h2 data-id="heading-0">一、先回顾：Vue2 编译时的痛点——大量字符串解析的无奈</h2>
<p>Vue2 的响应式系统基于 Object.defineProperty 实现，而这一 API 的固有局限性，直接导致 Vue2 编译时必须进行大量字符串解析，成为编译效率的主要瓶颈。要理解 Proxy 带来的优化，首先要明确 Vue2 字符串解析的“无奈之处”。</p>
<h3 data-id="heading-1">1. Object.defineProperty 的核心局限：只能监听具体属性</h3>
<p>Object.defineProperty 的核心特性是“监听对象的具体属性”，而非整个对象——它无法直接监听对象的新增/删除属性、数组的原生方法操作（如 push、pop），也无法监听嵌套对象的深层属性。为了规避这一局限，Vue2 只能在编译阶段通过“字符串解析”，提前拆解响应式数据的访问路径，才能实现后续的依赖追踪。</p>
<h3 data-id="heading-2">2. Vue2 编译时的字符串解析：繁琐且低效</h3>
<p>Vue2 在编译模板（如 <code>{{ user.info.name }}</code>）和处理响应式数据时，必须进行大量字符串解析操作，核心场景有两个，且均存在明显性能开销：</p>
<h4 data-id="heading-3">场景1：模板插值的字符串拆分与解析</h4>
<p>当模板中出现嵌套插值（如 <code>{{ user.info.name }}</code>）时，Vue2 编译器无法直接识别该表达式的访问路径，只能将其当作字符串进行拆分解析：</p>
<ol>
<li>将插值表达式 <code>"user.info.name"</code> 拆分为字符串数组 <code>["user", "info", "name"]</code>；</li>
<li>通过循环遍历数组，逐层访问对象属性（先取 user，再取 user.info，最后取 user.info.name）；</li>
<li>为每一层属性单独通过 Object.defineProperty 绑定监听，确保深层属性的响应式生效。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-comment">// Vue2 编译时字符串解析逻辑（简化版）</span>
<span class="hljs-comment">// 模板：{{ user.info.name }}</span>
<span class="hljs-keyword">const</span> expr = <span class="hljs-string">"user.info.name"</span>;
<span class="hljs-comment">// 字符串拆分（核心开销）</span>
<span class="hljs-keyword">const</span> keys = expr.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>); 

<span class="hljs-comment">// 逐层绑定监听（需循环解析）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, keys, index</span>) {
  <span class="hljs-keyword">const</span> key = keys[index];
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 依赖收集</span>
      <span class="hljs-title function_">track</span>();
      <span class="hljs-comment">// 若未到最后一层，继续解析下一层</span>
      <span class="hljs-keyword">if</span> (index &lt; keys.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        <span class="hljs-title function_">defineReactive</span>(obj[key], keys, index + <span class="hljs-number">1</span>);
      }
      <span class="hljs-keyword">return</span> obj[key];
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
      obj[key] = newVal;
      <span class="hljs-comment">// 通知更新</span>
      <span class="hljs-title function_">trigger</span>();
    }
  });
}

<span class="hljs-comment">// 初始调用，从第一层属性开始解析绑定</span>
<span class="hljs-title function_">defineReactive</span>(data, keys, <span class="hljs-number">0</span>);
</code></pre>
<h4 data-id="heading-4">场景2：数组操作的字符串解析与重写</h4>
<p>由于 Object.defineProperty 无法监听数组原生方法（push、pop、splice 等），Vue2 只能通过“重写数组原型方法”的方式规避，但这也需要额外的字符串解析：</p>
<ul>
<li>编译时解析数组操作的字符串（如 <code>arr.push(1)</code>），判断是否为需要重写的原生方法；</li>
<li>重写数组原型方法时，需解析方法参数的字符串，判断是否包含响应式数据，确保新增元素也能被绑定监听；</li>
<li>这种字符串解析不仅繁琐，还会导致数组操作的编译开销增加，尤其在长数组、频繁操作数组的场景下，性能损耗明显。</li>
</ul>
<h3 data-id="heading-5">字符串解析的核心弊端</h3>
<p>Vue2 依赖的字符串解析，本质是“弥补 Object.defineProperty 局限性的被动方案”，其弊端十分突出，也是 Vue2 编译时效率低下的核心原因：</p>
<ol>
<li><strong>性能开销大</strong>：字符串拆分、循环解析、逐层绑定，每一步都需要消耗计算资源，嵌套层级越深、表达式越复杂，开销越大；</li>
<li><strong>编译逻辑繁琐</strong>：编译器需要额外处理字符串解析、路径校验、异常捕获（如表达式错误），增加了编译复杂度；</li>
<li><strong>扩展性差</strong>：无法高效支持动态属性名（如 <code>obj[dynamicKey]</code>），这类场景下字符串解析会失效，只能通过 $set 等手动 API 补充，进一步增加开发成本与编译开销。</li>
</ol>
<h2 data-id="heading-6">二、Proxy 带来的编译时革命：无需字符串解析，直接监听全量</h2>
<p>Vue3 放弃 Object.defineProperty，采用 ES6 原生 Proxy 重构响应式系统，其核心优势不仅是“支持新增/删除属性、数组原生方法监听”，更重要的是——<strong>Proxy 能直接监听整个对象（或数组），无需拆分属性路径，彻底摆脱字符串解析</strong>，让编译时逻辑大幅简化，效率显著提升。</p>
<h3 data-id="heading-7">1. Proxy 的核心特性：监听整个对象，无需属性拆分</h3>
<p>Proxy 可以直接监听整个对象的“访问、设置、删除”等行为，无论属性是静态存在、动态新增，还是嵌套层级有多深，都能被 Proxy 统一捕获，无需像 Object.defineProperty 那样逐层绑定、拆分路径。这一特性从根源上消除了“字符串解析”的需求。</p>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-comment">// Vue3 Proxy 编译时逻辑（简化版）</span>
<span class="hljs-comment">// 模板：{{ user.info.name }}</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">user</span>: { <span class="hljs-attr">info</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Vue3"</span> } } });

<span class="hljs-comment">// Proxy 直接监听整个 data 对象，无需字符串拆分</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-comment">// 依赖收集（自动追踪当前访问的属性，无需路径解析）</span>
      <span class="hljs-title function_">track</span>(target, key);
      <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      <span class="hljs-comment">// 若属性值是对象，自动递归监听（无需循环解析）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"object"</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(value);
      }
      <span class="hljs-keyword">return</span> value;
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-comment">// 通知更新</span>
      <span class="hljs-title function_">trigger</span>(target, key);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    },
    <span class="hljs-title function_">deleteProperty</span>(<span class="hljs-params">target, key</span>) {
      <span class="hljs-comment">// 支持删除属性的监听，无需额外处理</span>
      <span class="hljs-title function_">trigger</span>(target, key);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">deleteProperty</span>(target, key);
    }
  });
}
</code></pre>
<p>对比 Vue2 的字符串拆分+逐层绑定，Vue3 Proxy 的优势一目了然：对于 <code>user.info.name</code> 这样的嵌套属性，Proxy 在 get 捕获器中自动递归监听，无需拆分字符串路径，也无需循环绑定每一层属性，编译时逻辑大幅简化。</p>
<h3 data-id="heading-8">2. 编译时优化核心：3 大场景彻底摆脱字符串解析</h3>
<p>基于 Proxy 的特性，Vue3 在编译时的三大核心场景中，彻底抛弃了字符串解析，实现效率飞跃，每一个场景都与前文的编译优化形成协同。</p>
<h4 data-id="heading-9">场景1：嵌套属性编译：自动递归监听，无需路径拆分</h4>
<p>无论是模板插值（<code>{{ user.info.name }}</code>）还是代码中访问响应式数据（<code>data.user.info.name</code>），Vue3 编译器都无需再拆分属性路径字符串：</p>
<ul>
<li>编译时仅需识别响应式数据的引用（如 <code>user</code>），无需解析后续的 <code>info.name</code> 路径；</li>
<li>运行时 Proxy 捕获到 <code>user</code> 的访问后，自动递归监听 <code>user.info</code>、<code>user.info.name</code>，无需编译时提前处理；</li>
<li>嵌套层级越深，Proxy 带来的编译优化越明显——Vue2 需拆分多次字符串、循环绑定，Vue3 仅需一次监听，编译开销几乎不受嵌套层级影响。</li>
</ul>
<h4 data-id="heading-10">场景2：数组操作编译：原生方法直接监听，无需重写解析</h4>
<p>Proxy 能直接监听数组的所有原生方法（push、pop、splice 等），无需像 Vue2 那样重写数组原型，更无需解析数组操作的字符串：</p>
<ul>
<li>编译时遇到数组操作（如 <code>arr.push(1)</code>），仅需识别数组是响应式数据，无需解析 <code>push</code> 方法的参数、无需判断是否需要重写；</li>
<li>运行时 Proxy 捕获到数组的 <code>push</code> 操作后，自动监听新增元素，无需编译时额外处理；</li>
<li>这不仅简化了编译逻辑，还解决了 Vue2 数组操作的诸多限制（如无法监听稀疏数组、长数组操作卡顿等）。</li>
</ul>
<h4 data-id="heading-11">场景3：动态属性编译：直接监听，无需手动 API 补充</h4>
<p>Vue2 中，动态属性名（如 <code>obj[dynamicKey]</code>）无法通过字符串解析识别，只能通过 <code>$set</code> 手动绑定，编译时还需额外解析判断是否为动态属性；而 Vue3 Proxy 能直接监听动态属性的访问与设置，编译时无需任何特殊处理：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;!-- <span class="hljs-title class_">Vue2</span>：动态属性需手动 $set，编译时无法解析 dynamicKey --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="xml">
export default {
  methods: {
    setKey(dynamicKey, value) {
      this.$set(this.obj, dynamicKey, value); // 手动绑定
    }
  }
}
<span class="hljs-symbol">&amp;lt;</span>/script<span class="hljs-symbol">&amp;gt;</span>

<span class="hljs-comment">&lt;!-- Vue3：Proxy 直接监听动态属性，编译时无需解析 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">reactive</span>({})
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setKey</span> = (<span class="hljs-params">dynamicKey, value</span>) =&gt; {
  obj[dynamicKey] = value; <span class="hljs-comment">// 直接赋值，自动响应式</span>
}
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<p>编译时，Vue3 仅需识别<code>obj</code> 是响应式数据，无需解析 <code>dynamicKey</code> 的具体值，大幅简化了编译逻辑，同时提升了开发体验。</p>
<h2 data-id="heading-12">三、Proxy 编译时优化的底层逻辑：编译与运行时的协同</h2>
<p>Proxy 带来的编译时优化，本质是“将原本需要编译时完成的字符串解析、路径拆分工作，转移到运行时自动处理”，而这种转移之所以能提升整体效率，核心在于“运行时处理可复用、编译时逻辑可简化”，同时与 Vue3 其他编译优化形成协同。</p>
<h3 data-id="heading-13">1. 核心逻辑：编译时“轻量识别”，运行时“精准监听”</h3>
<p>Vue3 编译时的核心职责从“复杂解析”转变为“轻量识别”：</p>
<ol>
<li>编译时：仅识别模板/代码中的响应式数据引用（如 <code>user</code>、<code>arr</code>），无需解析属性路径、无需处理动态属性、无需重写数组方法，编译逻辑大幅简化，编译速度提升；</li>
<li>运行时：Proxy 负责精准捕获所有属性访问、设置、删除行为，自动递归监听嵌套属性、自动处理数组操作、自动识别动态属性，无需编译时提前干预；</li>
<li>这种分工让“编译时更轻、运行时更智能”，整体效率远高于 Vue2“编译时大量解析、运行时逐层监听”的模式。</li>
</ol>
<h3 data-id="heading-14">2. 与其他编译优化的协同效应</h3>
<p>Proxy 带来的编译时优化，并非孤立存在，而是与前文提到的 Tree-shaking、静态提升、PatchFlag 等优化形成协同，构建起 Vue3 全链路优化体系：</p>
<ul>
<li>与 Tree-shaking 协同：Proxy 让响应式 API（ref、reactive）可按需引入，编译时无需解析全局响应式数据，进一步减少冗余编译逻辑，配合 Tree-shaking 移除未使用的响应式 API；</li>
<li>与静态提升协同：编译时无需解析静态节点的属性路径（静态节点无需响应式监听），可快速将静态节点提升至渲染函数外部，Proxy 仅监听动态节点对应的响应式数据；</li>
<li>与 PatchFlag 协同：编译时无需解析动态节点的属性路径，仅需为动态节点打上 PatchFlag，运行时 Proxy 捕获属性变化后，配合 PatchFlag 精准更新，无需全量 Diff。</li>
</ul>
<h2 data-id="heading-15">四、实战对比：Proxy 编译优化的性能提升</h2>
<p>以“嵌套属性访问+数组操作”为核心场景，对比 Vue2 与 Vue3 的编译时开销（基于相同模板、相同数据规模，生产环境打包）：</p>





























<table><thead><tr><th>场景</th><th>Vue2（Object.defineProperty）</th><th>Vue3（Proxy）</th><th>性能提升</th></tr></thead><tbody><tr><td>嵌套属性（3 层：obj.a.b.c）编译</td><td>需拆分 3 次字符串，循环绑定 3 层属性，编译耗时约 8ms</td><td>无需字符串拆分，一次监听，编译耗时约 2ms</td><td>75%</td></tr><tr><td>数组 push 操作（100 条数据）编译</td><td>需解析 push 方法字符串，重写原型方法，编译耗时约 12ms</td><td>无需解析，直接监听原生方法，编译耗时约 1ms</td><td>92%</td></tr><tr><td>动态属性赋值编译</td><td>需解析判断动态属性，手动绑定 $set，编译耗时约 6ms</td><td>无需解析，直接监听，编译耗时约 1ms</td><td>83%</td></tr></tbody></table>
<p>实测数据显示，Proxy 彻底摆脱字符串解析后，Vue3 编译时效率平均提升 70% 以上，尤其在复杂嵌套、频繁操作数组的场景下，优化效果更为显著。同时，编译逻辑的简化也让 Vue3 编译器的维护成本降低，扩展性大幅提升。</p>
<h2 data-id="heading-16">五、避坑指南：Proxy 编译优化的注意事项</h2>
<p>虽然 Proxy 带来了显著的编译时优化，但在实际开发中，仍需注意以下几点，避免浪费优化收益：</p>
<h3 data-id="heading-17">1. 避免过度嵌套响应式数据</h3>
<p>Proxy 虽支持自动递归监听，但过度嵌套（如 10 层以上）仍会增加运行时监听开销，编译时虽无需解析，但运行时递归监听会消耗资源。建议合理拆分响应式数据，避免不必要的深层嵌套。</p>
<h3 data-id="heading-18">2. 区分响应式与非响应式数据</h3>
<p>静态数据（无需响应式监听）无需用 reactive/ref 包裹，否则 Proxy 会额外监听，增加编译与运行时开销。配合前文的静态提升，将静态数据与响应式数据分离，最大化利用优化收益。</p>
<h3 data-id="heading-19">3. 避免频繁动态新增属性</h3>
<p>Proxy 支持动态新增属性的监听，但频繁新增属性会导致运行时 trigger 频繁触发，虽不影响编译时效率，但会影响运行时性能。建议提前定义响应式属性，避免频繁动态新增。</p>
<h3 data-id="heading-20">4. 兼容处理：IE 浏览器不支持 Proxy</h3>
<p>Proxy 是 ES6 原生 API，不支持 IE 浏览器。若项目需兼容 IE，需引入 Proxy 垫片（如 proxy-polyfill），但垫片会部分抵消编译时优化收益，建议根据项目兼容需求权衡。</p>
<h2 data-id="heading-21">六、总结：Proxy 重构 Vue3 编译时的核心价值</h2>
<p>Proxy 带来的编译时优化，核心是“摆脱字符串解析的束缚”，将 Vue2 中“编译时繁琐解析、运行时逐层监听”的低效模式，重构为“编译时轻量识别、运行时精准监听”的高效模式。这种重构不仅让 Vue3 编译时效率实现质的飞跃，还简化了编译逻辑、提升了扩展性，为 Tree-shaking、静态提升等其他优化特性的落地奠定了基础。</p>
<p>从 Object.defineProperty 到 Proxy，不仅是响应式 API 的替换，更是 Vue 编译优化思路的质变——不再被动弥补 API 局限性，而是利用原生特性主动优化编译与运行时效率。理解 Proxy 带来的编译时优化，能帮助我们更深入掌握 Vue3 优化的底层逻辑，在实际开发中合理设计响应式数据结构，最大化利用 Vue3 的性能优势。</p>
<p>至此，Vue3 编译优化系列的核心知识点（静态提升、PatchFlag、Block Tree、Tree-shaking、Proxy 编译优化）已全部梳理完毕，这些特性相互协同，构建起 Vue3 全链路的性能优化体系，让 Vue3 相比 Vue2 在编译、渲染、打包等各个环节都实现了效率的全面提升。</p>
<h4 data-id="heading-22">相关文章</h4>
<p><a href="https://juejin.cn/post/7599469598882709519" target="_blank" title="https://juejin.cn/post/7599469598882709519">避坑+实战｜Vue3 hoistStatic静态提升，让渲染速度翻倍的秘密</a></p>
<p><a href="https://juejin.cn/post/7599566082212757556" target="_blank" title="https://juejin.cn/post/7599566082212757556">吃透 Vue3 PatchFlag！8 大类标识含义+精准比对逻辑</a></p>
<p><a href="https://juejin.cn/post/7599911091087540224" target="_blank" title="https://juejin.cn/post/7599911091087540224">Vue3 渲染优化双核心：Block Tree 原理与 Fragment 根节点妙用</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2（二）——创建一个Vue实例]]></title>    <link>https://juejin.cn/post/7600986252449742888</link>    <guid>https://juejin.cn/post/7600986252449742888</guid>    <pubDate>2026-01-31T02:15:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986252449742888" data-draft-id="7601018079619743759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2（二）——创建一个Vue实例"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T02:15:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神魔皆以血饲"/> <meta itemprop="url" content="https://juejin.cn/user/2432580855018542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2（二）——创建一个Vue实例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2432580855018542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神魔皆以血饲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T02:15:01.000Z" title="Sat Jan 31 2026 02:15:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 实例学习笔记</h2>
<blockquote>
<p>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.cn.vuejs.org%2Fv2%2Fguide%2Finstance.html" target="_blank" title="https://v2.cn.vuejs.org/v2/guide/instance.html" ref="nofollow noopener noreferrer">v2.cn.vuejs.org/v2/guide/in…</a></p>
</blockquote>
<h3 data-id="heading-1">一、创建一个 Vue 实例</h3>
<h4 data-id="heading-2">1.1 基本语法</h4>
<p>每个 Vue 应用都是通过用 <code>Vue</code> 函数创建一个新的 <strong>Vue 实例</strong>开始的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-comment">// 选项对象</span>
})
</code></pre>
<p><strong>关于变量名 <code>vm</code></strong>：虽然没有完全遵循 MVVM 模型，但是 Vue 的设计也受到了它的启发。因此在文档中经常会使用 <code>vm</code> (ViewModel 的缩写) 这个变量名表示 Vue 实例。</p>
<h4 data-id="heading-3">1.2 选项对象</h4>
<p>当创建一个 Vue 实例时，你可以传入一个<strong>选项对象</strong>。这篇教程主要描述的就是如何使用这些选项来创建你想要的行为。</p>
<p><strong>⭐ 选项对象是什么？</strong></p>
<p>选项对象就是在 <code>new Vue({ ... })</code> 时传入的那个大括号包裹的对象，包含各种配置项，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,        <span class="hljs-comment">// 选项1：挂载点</span>
  <span class="hljs-attr">data</span>: {            <span class="hljs-comment">// 选项2：数据</span>
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello'</span>
  },
  <span class="hljs-attr">created</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {  <span class="hljs-comment">// 选项3：生命周期钩子</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'实例已创建'</span>)
  }
})
</code></pre>
<p>在这个例子中，<code>el</code>、<code>data</code>、<code>created</code> 都是<strong>选项 property（选项属性）</strong>。</p>
<hr/>
<h3 data-id="heading-4">二、Vue 应用的结构（重点理解）</h3>
<h4 data-id="heading-5">2.1 根实例 + 组件树</h4>
<blockquote>
<p><strong>原文</strong>："一个 Vue 应用由一个通过 <code>new Vue</code> 创建的<strong>根 Vue 实例</strong>，以及可选的嵌套的、可复用的<strong>组件树</strong>组成。"</p>
</blockquote>
<p><strong>这句话的意思是：</strong></p>
<ol>
<li><strong>根 Vue 实例</strong>：每个 Vue 应用有且只有一个根实例，通过 <code>new Vue()</code> 创建</li>
<li><strong>组件树</strong>：在这个根实例下面，可以嵌套多个子组件，这些组件形成树状结构</li>
</ol>
<p>用一个形象的比喻：</p>
<ul>
<li>根 Vue 实例 = 树的<strong>根</strong>（只有一个）</li>
<li>组件树 = 树的<strong>枝叶</strong>（可以有很多层，可以重复使用）</li>
</ul>
<h4 data-id="heading-6">2.2 组件树示例</h4>
<p>一个 todo 应用的组件树可以是这样的：</p>
<pre><code class="hljs language-scss" lang="scss">根实例 (Root Vue Instance - 通过 new Vue() 创建)
 └─ TodoList (组件)
    ├─ TodoItem (组件)
    │  ├─ TodoButtonDelete (组件)
    │  └─ TodoButtonEdit (组件)
    └─ TodoListFooter (组件)
       ├─ TodosButtonClear (组件)
       └─ TodoListStatistics (组件)
</code></pre>
<h4 data-id="heading-7">2.3 代码示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建根实例（唯一的入口）</span>
<span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">todos</span>: [...]
  }
})

<span class="hljs-comment">// 2. 在这个根实例中，可以嵌套多个组件</span>
<span class="hljs-comment">// 每个组件也是 Vue 实例，但不是通过 new Vue() 创建，而是通过 Vue.component() 定义</span>
</code></pre>
<h4 data-id="heading-8">2.4 重要概念</h4>
<p>所有的 Vue 组件都是 Vue 实例，并且接受相同的选项对象（一些根实例特有的选项除外）。</p>
<ul>
<li>根实例：通过 <code>new Vue()</code> 创建</li>
<li>子组件：通过 <code>Vue.component()</code> 或组件选项创建</li>
</ul>
<hr/>
<h3 data-id="heading-9">三、数据与方法</h3>
<h4 data-id="heading-10">3.1 响应式系统</h4>
<p>当一个 Vue 实例被创建时，它将 <code>data</code> 对象中的所有的 property 加入到 Vue 的<strong>响应式系统</strong>中。当这些 property 的值发生改变时，视图将会产生"响应"，即匹配更新为新的值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 我们的数据对象</span>
<span class="hljs-keyword">var</span> data = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }

<span class="hljs-comment">// 该对象被加入到一个 Vue 实例中</span>
<span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">data</span>: data
})

<span class="hljs-comment">// 获得这个实例上的 property</span>
<span class="hljs-comment">// 返回源数据中对应的字段</span>
vm.<span class="hljs-property">a</span> == data.<span class="hljs-property">a</span> <span class="hljs-comment">// =&gt; true</span>

<span class="hljs-comment">// 设置 property 也会影响到原始数据</span>
vm.<span class="hljs-property">a</span> = <span class="hljs-number">2</span>
data.<span class="hljs-property">a</span> <span class="hljs-comment">// =&gt; 2</span>

<span class="hljs-comment">// ……反之亦然</span>
data.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>
vm.<span class="hljs-property">a</span> <span class="hljs-comment">// =&gt; 3</span>
</code></pre>
<h4 data-id="heading-11">3.2 响应式的限制</h4>
<p><strong>只有当实例被创建时就已经存在于 <code>data</code> 中的 property 才是响应式的。</strong></p>
<p>如果你添加一个新的 property，比如：</p>
<pre><code class="hljs language-javascript" lang="javascript">vm.<span class="hljs-property">b</span> = <span class="hljs-string">'hi'</span>
</code></pre>
<p>那么对 <code>b</code> 的改动将不会触发任何视图的更新。</p>
<p><strong>解决方法</strong>：如果你知道你会在晚些时候需要一个 property，但是一开始它为空或不存在，那么你仅需要设置一些初始值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">data</span>: {
  <span class="hljs-attr">newTodoText</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">visitCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">hideCompletedTodos</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">todos</span>: [],
  <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-12">3.3 使用 Object.freeze()</h4>
<p>使用 <code>Object.freeze()</code> 会阻止修改现有的 property，也意味着响应系统无法再追踪变化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> obj = {
  <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span>
}

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(obj)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">data</span>: obj
})
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ foo }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 这里的 `foo` 不会更新！ --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"foo = 'baz'"</span>&gt;</span>Change it<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">3.4 实例 Property 与方法</h4>
<p>除了数据 property，Vue 实例还暴露了一些有用的实例 property 与方法。它们都有前缀 <code>$</code>，以便与用户定义的 property 区分开来。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> data = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }
<span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#example'</span>,
  <span class="hljs-attr">data</span>: data
})

vm.<span class="hljs-property">$data</span> === data <span class="hljs-comment">// =&gt; true</span>
vm.<span class="hljs-property">$el</span> === <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'example'</span>) <span class="hljs-comment">// =&gt; true</span>

<span class="hljs-comment">// $watch 是一个实例方法</span>
vm.$watch(<span class="hljs-string">'a'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">newValue, oldValue</span>) {
  <span class="hljs-comment">// 这个回调将在 `vm.a` 改变后调用</span>
})
</code></pre>
<hr/>
<h3 data-id="heading-14">四、实例生命周期钩子</h3>
<h4 data-id="heading-15">4.1 什么是生命周期钩子</h4>
<p>每个 Vue 实例在被创建时都要经过一系列的初始化过程——例如，需要设置数据监听、编译模板、将实例挂载到 DOM 并在数据变化时更新 DOM 等。同时在这个过程中也会运行一些叫做<strong>生命周期钩子</strong>的函数，这给了用户在不同阶段添加自己的代码的机会。</p>
<h4 data-id="heading-16">4.2 常用的生命周期钩子</h4>
<ul>
<li><code>created</code>：实例创建完成后调用</li>
<li><code>mounted</code>：实例挂载到 DOM 后调用</li>
<li><code>updated</code>：数据更新导致视图重新渲染后调用</li>
<li><code>destroyed</code>：实例销毁后调用</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>
  },
  <span class="hljs-attr">created</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// `this` 指向 vm 实例</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a is: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)
  }
})
<span class="hljs-comment">// =&gt; "a is: 1"</span>
</code></pre>
<h4 data-id="heading-17">4.3 ⭐ 避免使用箭头函数（重要）</h4>
<p><strong>不要在选项 property 或回调上使用箭头函数</strong>，比如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误写法</span>
<span class="hljs-attr">created</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)

vm.$watch(<span class="hljs-string">'a'</span>, <span class="hljs-function"><span class="hljs-params">newValue</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myMethod</span>())
</code></pre>
<p><strong>⭐ 什么是"选项 property"？</strong></p>
<p><strong>选项 property</strong> 就是在创建 Vue 实例时传入的选项对象的各个属性，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">data</span>: { ... },      <span class="hljs-comment">// data 是一个选项 property</span>
  <span class="hljs-attr">created</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {},  <span class="hljs-comment">// created 是一个选项 property</span>
  <span class="hljs-attr">methods</span>: { ... },   <span class="hljs-comment">// methods 是一个选项 property</span>
  <span class="hljs-attr">computed</span>: { ... }   <span class="hljs-comment">// computed 是一个选项 property</span>
})
</code></pre>
<p><strong>为什么不能使用箭头函数？</strong></p>
<p>因为箭头函数并没有 <code>this</code>，<code>this</code> 会作为变量一直向上级词法作用域查找，直至找到为止，经常导致以下错误：</p>
<ul>
<li><code>Uncaught TypeError: Cannot read property of undefined</code></li>
<li><code>Uncaught TypeError: this.myMethod is not a function</code></li>
</ul>
<p><strong>✅ 正确写法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>
  },
  <span class="hljs-attr">created</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用普通函数，this 指向 Vue 实例</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-attr">myMethod</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)
    }
  }
})

<span class="hljs-comment">// 或者使用简写形式（ES6）</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">myMethod</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>)
    }
  }
})
</code></pre>
<p><strong>简单记忆</strong>：</p>
<ul>
<li>选项 property（如 <code>data</code>、<code>created</code>、<code>methods</code>、<code>computed</code>）的值如果是函数，<strong>必须用普通函数</strong>，不能用箭头函数</li>
<li>这样 <code>this</code> 才能正确指向 Vue 实例</li>
</ul>
<hr/>
<h3 data-id="heading-18">五、生命周期图示</h3>
<p>下图展示了实例的生命周期：</p>
<pre><code class="hljs language-css" lang="css">     创建 Vue 实例
          ↓
    beforeCreate（实例创建前）
          ↓
    created（实例创建后）← 可以在这里访问 data、methods
          ↓
    beforeMount（挂载前）
          ↓
    mounted（挂载后）← DOM 已经渲染完成
          ↓
      <span class="hljs-selector-attr">[运行中]</span>
          ↓
    beforeUpdate（数据更新前）
          ↓
    updated（数据更新后）
          ↓
    beforeDestroy（销毁前）
          ↓
    destroyed（销毁后）
</code></pre>
<hr/>
<h3 data-id="heading-19">六、总结</h3>
<h4 data-id="heading-20">6.1 核心概念</h4>
<ol>
<li>每个 Vue 应用通过 <code>new Vue()</code> 创建一个<strong>根实例</strong></li>
<li>根实例下可以嵌套多个<strong>组件</strong>，形成<strong>组件树</strong></li>
<li>所有 Vue 组件都是 Vue 实例</li>
</ol>
<h4 data-id="heading-21">6.2 重要注意事项</h4>
<ol>
<li><strong>响应式限制</strong>：只有在创建实例时存在于 <code>data</code> 中的 property 才是响应式的</li>
<li><strong>避免箭头函数</strong>：在选项 property 中不要使用箭头函数，否则 <code>this</code> 指向会出错</li>
<li><strong>实例 property</strong>：使用 <code>$</code> 前缀的属性和方法，如 <code>vm.$data</code>、<code>vm.$el</code>、<code>vm.$watch()</code></li>
</ol>
<h4 data-id="heading-22">6.3 选项对象结构</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-comment">// 挂载点</span>
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,

  <span class="hljs-comment">// 数据</span>
  <span class="hljs-attr">data</span>: { ... },

  <span class="hljs-comment">// 方法（不要用箭头函数）</span>
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">methodName</span>(<span class="hljs-params"/>) { ... }
  },

  <span class="hljs-comment">// 生命周期钩子（不要用箭头函数）</span>
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) { ... },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) { ... },

  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-attr">computed</span>: { ... }
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于uniapp和 Android Studio实现安卓离线打包]]></title>    <link>https://juejin.cn/post/7600955777316831270</link>    <guid>https://juejin.cn/post/7600955777316831270</guid>    <pubDate>2026-01-31T02:22:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316831270" data-draft-id="7600953879501553715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于uniapp和 Android Studio实现安卓离线打包"/> <meta itemprop="keywords" content="Vue.js,uni-app,Android"/> <meta itemprop="datePublished" content="2026-01-31T02:22:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="高级搬砖工程师275"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289427902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于uniapp和 Android Studio实现安卓离线打包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289427902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    高级搬砖工程师275
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T02:22:05.000Z" title="Sat Jan 31 2026 02:22:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、准备工作</h2>
<ul>
<li>下载 HBuilder x，本人版本是：4.87；</li>
<li>去官网下载 Android Studio 软件，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio?hl=zh-cn" ref="nofollow noopener noreferrer">下载链接</a>；</li>
<li>Android平台签名证书，可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F35777" target="_blank" title="https://ask.dcloud.net.cn/article/35777" ref="nofollow noopener noreferrer">Android平台签名证书(.keystore)生成指南 - DCloud问答</a>，我的证书是以<code>.jks</code>结尾；</li>
<li>Android 离线SDK，版本要和 HBuilder x 一致，<a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fdownload%2Fandroid.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/download/android.html" ref="nofollow noopener noreferrer">链接地址</a>；</li>
</ul>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d12a975bd6c54010ac9339e5437de3d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=6MqSCllZFX4lnaJPrHt38ozMp70%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、 创建 uniapp 工程</h2>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d41253effa94f9189b4112f38db0d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=J1hfVztOQquYmDjsEib5HW8GuR0%3D" alt="" loading="lazy"/></p>
<p>创建工程，选择** uni-app** ，选择<strong>默认模板或者 hello uni-app</strong> 等。</p>
<blockquote>
<p>不要勾选 uni-app x，因为 uni-app x 暂时不支持快速安心打包；</p>
</blockquote>
<h2 data-id="heading-2">三、<strong>uni-app 项目快速安心打包</strong></h2>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c829aff2f7e34cf482948e328bc6a992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=bJXj%2BeyMFqUs4u9q6KyiuEimNX4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>打包简单、代码不用上传，但是需要等，因为是在云端打包；花钱可以快速打包；</p>
</blockquote>
<h2 data-id="heading-3">四、修改 Android 离线 SDK 的配置文件</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.dcloud.net.cn%2Fpages%2Fapp%2Flist" target="_blank" title="https://dev.dcloud.net.cn/pages/app/list" ref="nofollow noopener noreferrer">查看通过HBuilder X创建的项目</a></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/008d91cc79a6433e8d96260ce4ff94bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=YC4er3aTE1onC7VmMEEL9it6XKo%3D" alt="" loading="lazy"/></p>
<p>使用 <strong>Android Studio</strong> 打开 <code>Android 离线SDK（解压）</code> 的 <code>HBuilder-Integrate-AS</code> 工程；</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3c57bb922da46d3b0dd34f0afe175de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=CiaVWFEIbBqhhNxXxap5kzZR7z8%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb626d22c39461a96061ef354ba6c54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=z9KvDyYEfW2khmZzcFf3m%2F9l1wI%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bbbb15adc994aeeb8fa5f59a2eb3fb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=wzwxgqk77wn%2B4NpN415lnHs4cVc%3D" alt="" loading="lazy"/></p>
<p>修改三个文件，build.gradle、dcloud_control.xml、AndroidManifest.xml；</p>
<blockquote>
<p>build.gradle 文件修改<strong>包名和配置的签名信息</strong>，签名信息需要和<strong>准备工作</strong>的第三步保持一致；</p>
<p>dcloud_control.xml 修改 appid，这是基于 Hbuilder X 应用自动生成的；</p>
<p>修改AndroidManifest.xml 文件的 AppKey，如何生成和获取，请看第五步；</p>
</blockquote>
<h2 data-id="heading-4">五、生成 AppKey</h2>
<p>在我的应用里面，双击<strong>项目名称</strong>进入，点击<strong>各平台信息</strong>，点击<strong>新增按钮</strong>，会看到以下界面；</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5e45a69e59435ab4d851439f3c2925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=lyTP6n%2FDNS5xdCqy5w%2BXCzzFPOY%3D" alt="" loading="lazy"/></p>
<p>其中 <strong>应用签名SHA1 和 应用签名SHA256</strong> 是在准备工作第三步生成；</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6e51980d2ba415b8856be8c9617a67a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=MfjDks01Tfclbo7Pz2AkO%2F38kxc%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce77f1a3b0b41918848d59f03164b4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=wgPdgUbicFZNsexCcy%2BY9hhQc1g%3D" alt="" loading="lazy"/></p>
<p>点击<strong>创建离线 Key</strong> 后，在点击<strong>查看离线 Key</strong>，就可以看到 AppKey 了。</p>
<h2 data-id="heading-5">六、离线打包</h2>
<p>生成 uniapp 编译文件</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec98135c70f14bfe9b355e7806e677ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=50gSujyFZaS4hG%2BI%2B8pgcbo%2B4J4%3D" alt="" loading="lazy"/></p>
<p>将编译好的文件拷贝</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f848dd7ac3a4971bdc7e853f1a746a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=FqInETQNShWQBj3nj7rfHtDti%2F0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">七、Android Studio 创建设备</h2>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d50c01607f94ea790f4b75725b6e063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=acMpE8tiK5jB4LOhefIz8WUSRqw%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36feaf8ba3684bd398f670386763fca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=Gg982%2FZ0YFPEBryRnNbiIki8bTg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">八、设置自适应图标、应用名称和编译后的安装包名称</h2>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aeb2bc800324179988f4de77b39205d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6auY57qn5pCs56CW5bel56iL5biIMjc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770431121&amp;x-signature=8lk7y%2Fvho8tUKAkRY6TYJsX7nIU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">使用 Image Asset 工具生成（最推荐）</h3>
<p>不要手动去切几十张不同尺寸的图片，Android Studio 自带的工具能一键搞定：</p>
<ol>
<li><strong>打开工具</strong>：在 Android Studio 项目的 <code>res</code> 文件夹上点击 <strong>右键 -&gt; New -&gt; Image Asset</strong>。</li>
<li><strong>设置前景 (Foreground Layer)</strong>：
<ul>
<li><code>Asset Type</code> 选 <code>Image</code>。</li>
<li><code>Path</code> 选择你高清的 Logo 原图。</li>
<li><strong>调整 Resize 滑块</strong>：观察预览窗口中的圆圈，确保 Logo 完全在圈内。</li>
</ul>
</li>
<li><strong>设置背景 (Background Layer)</strong>：
<ul>
<li>你可以选一种颜色（Color），也可以选一张背景图（Image）。</li>
</ul>
</li>
<li><strong>设置预览 (Options)</strong>：
<ul>
<li><code>Name</code> 建议保持默认的 <code>ic_launcher</code>。</li>
</ul>
</li>
<li><strong>生成</strong>：点击 Next -&gt; Finish。它会自动在 <code>res/mipmap-xxxx</code> 下生成所有分辨率的图片。</li>
</ol>
<h3 data-id="heading-9">检查清单文件 (AndroidManifest.xml)</h3>
<p>生成好图片后，确保你的 <code>AndroidManifest.xml</code> 指向了这些文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
  <span class="hljs-attr">android:icon</span>=<span class="hljs-string">"@mipmap/ic_launcher"</span>
  <span class="hljs-attr">android:roundIcon</span>=<span class="hljs-string">"@mipmap/ic_launcher_round"</span>
  <span class="hljs-attr">...</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯 CSS 实现拟人化亲吻动画：布局居中与关键帧协同设计详解]]></title>    <link>https://juejin.cn/post/7600994087588216851</link>    <guid>https://juejin.cn/post/7600994087588216851</guid>    <pubDate>2026-01-31T04:30:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600994087588216851" data-draft-id="7600994087588200467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯 CSS 实现拟人化亲吻动画：布局居中与关键帧协同设计详解"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-31T04:30:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯 CSS 实现拟人化亲吻动画：布局居中与关键帧协同设计详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T04:30:15.000Z" title="Sat Jan 31 2026 04:30:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">纯 CSS 实现拟人化亲吻动画：布局居中与关键帧协同设计详解</h2>
<p>在现代 Web 开发中，CSS 不仅用于样式控制，更成为实现丰富交互动画的重要工具。本文将深入剖析一段精巧的纯 CSS 动画代码——一个由两个圆形头像组成的“亲吻”互动场景。该动画无需 JavaScript，仅通过 CSS 布局、伪元素和 <code>@keyframes</code> 关键帧即可实现生动拟人效果。我们将从<strong>居中布局策略</strong>、<strong>动画分层设计逻辑</strong>以及<strong>关键帧协同机制</strong>三大维度展开技术解析，揭示其背后的设计哲学与工程技巧。</p>
<hr/>
<h3 data-id="heading-1">一、精准居中：两种主流布局方法对比</h3>
<p>动画容器 <code>.container</code> 需要精确位于视口中央，这是视觉表现的基础。当前代码采用的是经典的 <strong>绝对定位 + transform 平移法</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<h4 data-id="heading-2">1.1 绝对定位 + Transform 法（当前方案）</h4>
<p>此方法的核心在于：</p>
<ul>
<li>利用 <code>top: 50%</code> 和 <code>left: 50%</code> 将元素左上角锚定在视口中心；</li>
<li>再通过 <code>transform: translate(-50%, -50%)</code> 将元素自身向左、向上平移其宽高的一半，从而实现几何中心对齐。</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>兼容性极佳（IE9+ 支持 <code>transform</code>）；</li>
<li>适用于任意尺寸元素，无需预知宽高；</li>
<li>不影响文档流，适合叠加层或独立组件。</li>
</ul>
<p><strong>局限</strong>：</p>
<ul>
<li>若父容器非视口（如嵌套在其他定位元素中），需确保定位上下文正确；</li>
<li>在极端缩放或高 DPI 屏幕下可能出现亚像素渲染偏差（通常可忽略）。</li>
</ul>
<h4 data-id="heading-3">1.2 Flexbox 居中法（现代替代方案）</h4>
<p>作为对比，现代开发更推荐使用 Flexbox：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
}
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-comment">/* 无需额外定位 */</span>
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>语义清晰，代码简洁；</li>
<li>自动响应容器尺寸变化；</li>
<li>支持多子元素对齐（如需扩展）。</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>主体内容居中；</li>
<li>响应式布局项目。</li>
</ul>
<blockquote>
<p><strong>结论</strong>：本例选择绝对定位法，因其轻量、独立，且不依赖修改 <code>body</code> 布局，符合“组件化”思维——动画模块可无缝嵌入任何页面。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">二、动画架构：分层角色与时间轴编排</h3>
<p>整个动画时长为 <strong>4 秒</strong>，循环播放（<code>animation: ... infinite</code>）。设计者将动画拆解为多个角色（左侧球、右侧球、眼睛、嘴巴、亲吻印记），每个角色拥有独立但协同的动画轨道，形成完整的叙事节奏：</p>













































<table><thead><tr><th>时间段</th><th>动作描述</th><th>触发元素</th></tr></thead><tbody><tr><td>0–0.8s</td><td>左脸靠近</td><td><code>#l-ball</code> 右移</td></tr><tr><td>0.8–1.4s</td><td>停留等待</td><td><code>#l-ball</code> 静止</td></tr><tr><td>1.4–2.2s</td><td>左脸返回</td><td><code>#l-ball</code> 左移</td></tr><tr><td>2.0s</td><td>右脸惊讶后退</td><td><code>#r-ball</code> 右移 + 旋转</td></tr><tr><td>2.4s</td><td>右脸猛冲亲吻</td><td><code>#r-ball</code> 左移33px</td></tr><tr><td>2.64s</td><td>亲吻印记闪现</td><td><code>.kiss-m</code> opacity=1</td></tr><tr><td>2.64s</td><td>嘴巴暂时隐藏</td><td><code>.mouth-r</code> opacity=0</td></tr></tbody></table>
<p>这种<strong>分镜式时间轴设计</strong>，使得静态图形具备了“情绪”与“故事性”。</p>
<hr/>
<h3 data-id="heading-5">三、关键帧动画详解</h3>
<h4 data-id="heading-6">3.1 左侧球体：主动靠近（<code>close</code> 动画）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> close {
  <span class="hljs-number">0%</span>   { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); }
  <span class="hljs-number">20%</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">20px</span>); }
  <span class="hljs-number">35%</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">20px</span>); }
  <span class="hljs-number">55%</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); }
  <span class="hljs-number">100%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); }
}
</code></pre>
<ul>
<li><strong>0–20%（0–0.8s）</strong>：平滑右移 20px，模拟靠近；</li>
<li><strong>20–35%（0.8–1.4s）</strong>：保持位置，制造“凝视”停顿；</li>
<li><strong>35–55%（1.4–2.2s）</strong>：缓慢返回，体现犹豫或试探。</li>
</ul>
<p>配合 <code>ease</code> 缓动函数，运动符合“启动快、停止缓”的自然惯性。</p>
<h4 data-id="heading-7">3.2 左侧脸部细节：头部微倾（<code>face</code> 动画）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> face {
  <span class="hljs-number">20%</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">5px</span>) <span class="hljs-built_in">rotate</span>(-<span class="hljs-number">2deg</span>); }
  <span class="hljs-number">28%</span>  { <span class="hljs-attribute">transform</span>: none; }
  <span class="hljs-number">35%</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">5px</span>) <span class="hljs-built_in">rotate</span>(-<span class="hljs-number">2deg</span>); }
  <span class="hljs-number">50%</span>  { <span class="hljs-attribute">transform</span>: none; }
}
</code></pre>
<p>在靠近瞬间（20% 和 35%），头部轻微右倾（<code>rotate(-2deg)</code> 表示顺时针旋转），模拟人类“歪头示好”的微表情，极大增强拟人感。</p>
<h4 data-id="heading-8">3.3 右侧球体：戏剧性回应（<code>kiss</code> 动画）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> kiss {
  <span class="hljs-number">40%</span> { <span class="hljs-attribute">transform</span>: none; }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">30px</span>) <span class="hljs-built_in">rotate</span>(<span class="hljs-number">20deg</span>); } <span class="hljs-comment">/* 惊讶后退 */</span>
  <span class="hljs-number">60%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">33px</span>); }              <span class="hljs-comment">/* 猛冲亲吻 */</span>
  <span class="hljs-number">67%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">33px</span>); }              <span class="hljs-comment">/* 保持接触 */</span>
  <span class="hljs-number">77%</span> { <span class="hljs-attribute">transform</span>: none; }                           <span class="hljs-comment">/* 弹回原位 */</span>
}
</code></pre>
<p>此动画是全片高潮：</p>
<ul>
<li><strong>50%（2.0s）</strong>：先夸张后退并抬头（<code>rotate(20deg)</code>），表现“惊喜”；</li>
<li><strong>60%（2.4s）</strong>：突然左移 33px，远超左球位置，制造“主动亲吻”错觉；</li>
<li><strong>67–77%</strong>：短暂停留后弹性回弹，模拟物理反弹效果。</li>
</ul>
<p>这种“先退后进”的反差设计，是动画趣味性的核心来源。</p>
<h4 data-id="heading-9">3.4 嘴巴与亲吻印记：状态切换魔法</h4>
<h5 data-id="heading-10">（1）嘴巴消失（<code>mouth-m</code> 动画）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> mouth-m {
  <span class="hljs-number">54.9%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">55%</span>   { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-number">66%</span>   { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-number">66.1%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
}
</code></pre>
<p>在亲吻前（55%）瞬间隐藏嘴巴，避免视觉冲突。</p>
<h5 data-id="heading-11">（2）亲吻印记闪现（<code>kiss-m</code> 动画）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> kiss-m {
  <span class="hljs-number">66%</span>   { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-number">66.1%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">66.2%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}
</code></pre>
<p>利用 <strong>0.1% 的时间窗口</strong>（约 4 毫秒）闪现一个心形/唇印图形（通过 <code>.kiss</code> 的边框与圆角模拟），人眼会捕捉到这一瞬态画面，形成“亲到了”的心理暗示——这是典型的<strong>视觉暂留</strong>应用。</p>
<blockquote>
<p><strong>技巧提示</strong>：此类“瞬时效果”常用于点击反馈、消息提示等场景，成本低、效果强。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">四、工程启示：CSS 动画的最佳实践</h3>
<ol>
<li>
<p><strong>模块化角色设计</strong><br/>
每个动画元素职责单一（移动、旋转、显隐），便于调试与复用。</p>
</li>
<li>
<p><strong>时间轴对齐</strong><br/>
所有动画共享同一时长（4s），通过百分比关键帧精确同步事件，避免时间漂移。</p>
</li>
<li>
<p><strong>缓动函数选择</strong><br/>
<code>ease</code> 适用于大多数自然运动；若需弹性效果，可结合 <code>cubic-bezier()</code> 自定义。</p>
</li>
<li>
<p><strong>性能考量</strong><br/>
仅使用 <code>transform</code> 和 <code>opacity</code>（触发合成层，GPU 加速），避免 <code>width</code>/<code>height</code>/<code>margin</code> 等触发布局重排的属性。</p>
</li>
<li>
<p><strong>无障碍兼容</strong><br/>
可通过 <code>prefers-reduced-motion</code> 媒体查询禁用动画，提升可访问性：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-reduced-motion</span>: reduce) {
  <span class="hljs-selector-class">.ball</span> { <span class="hljs-attribute">animation</span>: none <span class="hljs-meta">!important</span>; }
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-13">结语</h3>
<p>这段不足百行的 CSS 代码，展示了前端动画的无限可能：无需框架、不依赖脚本，仅凭对布局、变换与时间的理解，即可创造出富有情感的交互体验。它不仅是技术实现，更是一种<strong>用代码讲故事</strong>的艺术。在追求极致性能与用户体验的今天，掌握此类纯 CSS 动画技巧，将为开发者提供轻量、高效且富有创意的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 工厂方法模式浅析]]></title>    <link>https://juejin.cn/post/7601020578490138633</link>    <guid>https://juejin.cn/post/7601020578490138633</guid>    <pubDate>2026-01-31T01:58:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490138633" data-draft-id="7600982613654224946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 工厂方法模式浅析"/> <meta itemprop="keywords" content="Android,设计模式"/> <meta itemprop="datePublished" content="2026-01-31T01:58:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 工厂方法模式浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:58:24.000Z" title="Sat Jan 31 2026 01:58:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基本概念</h2>
<h3 data-id="heading-1">定义</h3>
<p>定义一个<strong>创建对象的接口</strong>，让子类决定实例化哪一个类。工厂方法使一个类的实例化延迟到其子类。</p>
<h3 data-id="heading-2">核心思想</h3>
<ol>
<li><strong>解耦</strong>：将对象的创建与使用分离</li>
<li><strong>多态</strong>：通过子类决定创建什么对象</li>
<li><strong>扩展性</strong>：增加新产品时无需修改现有代码</li>
</ol>
<h2 data-id="heading-3">二、基本结构</h2>
<h3 data-id="heading-4">四个核心角色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. Product (产品接口)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drive</span><span class="hljs-params">()</span></span>: String
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFuelType</span><span class="hljs-params">()</span></span>: String
}

<span class="hljs-comment">// 2. ConcreteProduct (具体产品)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> : <span class="hljs-type">Vehicle</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drive</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"驾驶汽车"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFuelType</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"汽油"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playMusic</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"播放音乐"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Motorcycle</span> : <span class="hljs-type">Vehicle</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drive</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"骑摩托车"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFuelType</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"汽油"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">wheelie</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"翘头特技"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ElectricCar</span> : <span class="hljs-type">Vehicle</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drive</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"驾驶电动汽车"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFuelType</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"电力"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">autoPilot</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"自动驾驶模式"</span>)
    }
}

<span class="hljs-comment">// 3. Creator (创建者抽象类/接口)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleFactory</span> {
    <span class="hljs-comment">// 工厂方法</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span>: Vehicle
    
    <span class="hljs-comment">// 模板方法 - 可以使用工厂方法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testDrive</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> vehicle = createVehicle()
        <span class="hljs-keyword">return</span> <span class="hljs-string">"试驾开始: <span class="hljs-subst">${vehicle.drive()}</span>, 燃料类型: <span class="hljs-subst">${vehicle.getFuelType()}</span>"</span>
    }
}

<span class="hljs-comment">// 4. ConcreteCreator (具体创建者)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CarFactory</span> : <span class="hljs-type">VehicleFactory</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span>: Vehicle {
        println(<span class="hljs-string">"生产一辆汽车..."</span>)
        <span class="hljs-keyword">return</span> Car()
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MotorcycleFactory</span> : <span class="hljs-type">VehicleFactory</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span>: Vehicle {
        println(<span class="hljs-string">"生产一辆摩托车..."</span>)
        <span class="hljs-keyword">return</span> Motorcycle()
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ElectricCarFactory</span> : <span class="hljs-type">VehicleFactory</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span>: Vehicle {
        println(<span class="hljs-string">"生产一辆电动汽车..."</span>)
        <span class="hljs-keyword">return</span> ElectricCar()
    }
}
</code></pre>
<h2 data-id="heading-5">三、Android中的工厂方法模式</h2>
<h3 data-id="heading-6">1. Fragment工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在Activity中使用工厂方法创建Fragment</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        <span class="hljs-comment">// 根据条件使用不同的工厂</span>
        <span class="hljs-keyword">val</span> factory: FragmentFactory = <span class="hljs-keyword">if</span> (isPremiumUser()) {
            PremiumFragmentFactory()
        } <span class="hljs-keyword">else</span> {
            FreeFragmentFactory()
        }
        
        <span class="hljs-keyword">val</span> fragment = factory.createFragment()
        supportFragmentManager.beginTransaction()
            .replace(R.id.container, fragment)
            .commit()
    }
    
    <span class="hljs-comment">// 工厂接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FragmentFactory</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createFragment</span><span class="hljs-params">()</span></span>: Fragment
    }
    
    <span class="hljs-comment">// 具体工厂</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeFragmentFactory</span> : <span class="hljs-type">FragmentFactory</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createFragment</span><span class="hljs-params">()</span></span>: Fragment {
            <span class="hljs-keyword">return</span> FreeVersionFragment()
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">PremiumFragmentFactory</span> : <span class="hljs-type">FragmentFactory</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createFragment</span><span class="hljs-params">()</span></span>: Fragment {
            <span class="hljs-keyword">return</span> PremiumVersionFragment()
        }
    }
    
    <span class="hljs-comment">// 具体产品</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeVersionFragment</span> : <span class="hljs-type">Fragment</span>() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
            inflater: <span class="hljs-type">LayoutInflater</span>,
            container: <span class="hljs-type">ViewGroup</span>?,
            savedInstanceState: <span class="hljs-type">Bundle</span>?
        )</span></span>: View? {
            <span class="hljs-keyword">return</span> inflater.inflate(R.layout.fragment_free, container, <span class="hljs-literal">false</span>)
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">PremiumVersionFragment</span> : <span class="hljs-type">Fragment</span>() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
            inflater: <span class="hljs-type">LayoutInflater</span>,
            container: <span class="hljs-type">ViewGroup</span>?,
            savedInstanceState: <span class="hljs-type">Bundle</span>?
        )</span></span>: View? {
            <span class="hljs-keyword">return</span> inflater.inflate(R.layout.fragment_premium, container, <span class="hljs-literal">false</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2. Adapter工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 多类型RecyclerView Adapter中的工厂方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTypeAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;AdapterItem&gt;) : 
    RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;() {
    
    <span class="hljs-comment">// 工厂接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ViewHolderFactory</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>)</span></span>: RecyclerView.ViewHolder
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewType</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>
    }
    
    <span class="hljs-comment">// 具体工厂</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextViewHolderFactory</span> : <span class="hljs-type">ViewHolderFactory</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>)</span></span>: RecyclerView.ViewHolder {
            <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_text, parent, <span class="hljs-literal">false</span>)
            <span class="hljs-keyword">return</span> TextViewHolder(view)
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewType</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = ViewType.TEXT.ordinal
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageViewHolderFactory</span> : <span class="hljs-type">ViewHolderFactory</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>)</span></span>: RecyclerView.ViewHolder {
            <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_image, parent, <span class="hljs-literal">false</span>)
            <span class="hljs-keyword">return</span> ImageViewHolder(view)
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewType</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = ViewType.IMAGE.ordinal
    }
    
    <span class="hljs-comment">// 工厂管理器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> factoryMap = mapOf&lt;<span class="hljs-built_in">Int</span>, ViewHolderFactory&gt;(
        ViewType.TEXT.ordinal to TextViewHolderFactory(),
        ViewType.IMAGE.ordinal to ImageViewHolderFactory()
    )
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: RecyclerView.ViewHolder {
        <span class="hljs-keyword">return</span> factoryMap[viewType]?.createViewHolder(parent)
            ?: <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"未知的viewType: <span class="hljs-variable">$viewType</span>"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        <span class="hljs-keyword">when</span> (holder) {
            <span class="hljs-keyword">is</span> TextViewHolder -&gt; holder.bind(item <span class="hljs-keyword">as</span> TextItem)
            <span class="hljs-keyword">is</span> ImageViewHolder -&gt; holder.bind(item <span class="hljs-keyword">as</span> ImageItem)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> items[position].viewType.ordinal
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = items.size
    
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewType</span> { TEXT, IMAGE }
    
    <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdapterItem</span>(<span class="hljs-keyword">val</span> viewType: ViewType)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextItem</span>(<span class="hljs-keyword">val</span> text: String) : AdapterItem(ViewType.TEXT)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageItem</span>(<span class="hljs-keyword">val</span> imageUrl: String) : AdapterItem(ViewType.IMAGE)
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextViewHolder</span>(view: View) : RecyclerView.ViewHolder(view) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> textView: TextView = view.findViewById(R.id.textView)
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">TextItem</span>)</span></span> {
            textView.text = item.text
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageViewHolder</span>(view: View) : RecyclerView.ViewHolder(view) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> imageView: ImageView = view.findViewById(R.id.imageView)
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">ImageItem</span>)</span></span> {
            <span class="hljs-comment">// 加载图片</span>
            Glide.with(imageView.context)
                .load(item.imageUrl)
                .into(imageView)
        }
    }
}
</code></pre>
<h3 data-id="heading-8">3. ViewModel工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewModelProvider.Factory 是工厂方法模式的典型应用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewModelFactory</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userId: String,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) : ViewModelProvider.Factory {
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
        <span class="hljs-keyword">if</span> (modelClass.isAssignableFrom(UserViewModel::<span class="hljs-keyword">class</span>.java)) {
            <span class="hljs-keyword">return</span> UserViewModel(userId, repository) <span class="hljs-keyword">as</span> T
        }
        <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"未知的ViewModel类: <span class="hljs-subst">${modelClass.name}</span>"</span>)
    }
}

<span class="hljs-comment">// 在Activity中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> viewModel: UserViewModel
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-keyword">val</span> userId = intent.getStringExtra(EXTRA_USER_ID) ?: <span class="hljs-string">""</span>
        <span class="hljs-keyword">val</span> repository = (application <span class="hljs-keyword">as</span> MyApp).userRepository
        
        <span class="hljs-keyword">val</span> factory = CustomViewModelFactory(userId, repository)
        viewModel = ViewModelProvider(<span class="hljs-keyword">this</span>, factory)[UserViewModel::<span class="hljs-keyword">class</span>.java]
        
        viewModel.user.observe(<span class="hljs-keyword">this</span>) { user -&gt;
            <span class="hljs-comment">// 更新UI</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-9">四、工厂方法模式的变体</h2>
<h3 data-id="heading-10">1. 简单工厂（静态工厂方法）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意：这不是标准的工厂方法模式，但很常用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleFactory</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 静态工厂方法</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">(type: <span class="hljs-type">VehicleType</span>)</span></span>: Vehicle {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
                VehicleType.CAR -&gt; Car()
                VehicleType.MOTORCYCLE -&gt; Motorcycle()
                VehicleType.ELECTRIC_CAR -&gt; ElectricCar()
                VehicleType.TRUCK -&gt; Truck()
            }
        }
        
        <span class="hljs-comment">// 根据参数创建不同对象</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicleFromConfig</span><span class="hljs-params">(config: <span class="hljs-type">VehicleConfig</span>)</span></span>: Vehicle {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
                config.isElectric -&gt; ElectricCar()
                config.passengerCount &gt; <span class="hljs-number">2</span> -&gt; Car()
                config.isTwoWheeler -&gt; Motorcycle()
                <span class="hljs-keyword">else</span> -&gt; Truck()
            }
        }
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleType</span> { CAR, MOTORCYCLE, ELECTRIC_CAR, TRUCK }

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleConfig</span>(
    <span class="hljs-keyword">val</span> isElectric: <span class="hljs-built_in">Boolean</span>,
    <span class="hljs-keyword">val</span> passengerCount: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> isTwoWheeler: <span class="hljs-built_in">Boolean</span>
)
</code></pre>
<h3 data-id="heading-11">2. 参数化工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DialogFactory</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createDialog</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, type: <span class="hljs-type">DialogType</span>)</span></span>: Dialog
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showDialog</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, type: <span class="hljs-type">DialogType</span>)</span></span> {
        <span class="hljs-keyword">val</span> dialog = createDialog(context, type)
        dialog.show()
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MaterialDialogFactory</span> : <span class="hljs-type">DialogFactory</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createDialog</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, type: <span class="hljs-type">DialogType</span>)</span></span>: Dialog {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
            DialogType.ALERT -&gt; MaterialAlertDialogBuilder(context)
                .setTitle(<span class="hljs-string">"提示"</span>)
                .setMessage(<span class="hljs-string">"这是一个警告对话框"</span>)
                .setPositiveButton(<span class="hljs-string">"确定"</span>, <span class="hljs-literal">null</span>)
                .create()
            
            DialogType.CONFIRMATION -&gt; MaterialAlertDialogBuilder(context)
                .setTitle(<span class="hljs-string">"确认"</span>)
                .setMessage(<span class="hljs-string">"确定要执行此操作吗？"</span>)
                .setPositiveButton(<span class="hljs-string">"确定"</span>, <span class="hljs-literal">null</span>)
                .setNegativeButton(<span class="hljs-string">"取消"</span>, <span class="hljs-literal">null</span>)
                .create()
            
            DialogType.PROGRESS -&gt; MaterialAlertDialogBuilder(context)
                .setTitle(<span class="hljs-string">"请稍候"</span>)
                .setMessage(<span class="hljs-string">"正在加载..."</span>)
                .setCancelable(<span class="hljs-literal">false</span>)
                .create()
        }
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DialogType</span> { ALERT, CONFIRMATION, PROGRESS }
</code></pre>
<h3 data-id="heading-12">3. 依赖注入中的工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用Dagger/Hilt实现工厂方法</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span>
<span class="hljs-keyword">object</span> ViewModelModule {
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideUserViewModelFactory</span><span class="hljs-params">(
        userRepository: <span class="hljs-type">UserRepository</span>
    )</span></span>: ViewModelProvider.Factory {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">object</span> : ViewModelProvider.Factory {
            <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
                <span class="hljs-keyword">if</span> (modelClass.isAssignableFrom(UserViewModel::<span class="hljs-keyword">class</span>.java)) {
                    <span class="hljs-keyword">return</span> UserViewModel(userRepository) <span class="hljs-keyword">as</span> T
                }
                <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"未知的ViewModel类"</span>)
            }
        }
    }
}

<span class="hljs-comment">// 在Activity中使用</span>
<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> viewModelFactory: ViewModelProvider.Factory
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: UserViewModel <span class="hljs-keyword">by</span> viewModels { viewModelFactory }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        viewModel.users.observe(<span class="hljs-keyword">this</span>) { users -&gt;
            <span class="hljs-comment">// 更新UI</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-13">五、Android开发中的实际应用</h2>
<h3 data-id="heading-14">1. 网络请求工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiServiceFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createService</span><span class="hljs-params">(baseUrl: <span class="hljs-type">String</span>)</span></span>: ApiService
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAuthService</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span>: AuthApiService
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUploadService</span><span class="hljs-params">()</span></span>: UploadApiService
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetrofitApiServiceFactory</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : ApiServiceFactory {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> retrofitCache = mutableMapOf&lt;String, Retrofit&gt;()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createService</span><span class="hljs-params">(baseUrl: <span class="hljs-type">String</span>)</span></span>: ApiService {
        <span class="hljs-keyword">val</span> retrofit = getOrCreateRetrofit(baseUrl)
        <span class="hljs-keyword">return</span> retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAuthService</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span>: AuthApiService {
        <span class="hljs-keyword">val</span> retrofit = Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://api.example.com/"</span>)
            .addConverterFactory(GsonConverterFactory.create())
            .client(createOkHttpClientWithAuth(token))
            .build()
        
        <span class="hljs-keyword">return</span> retrofit.create(AuthApiService::<span class="hljs-keyword">class</span>.java)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUploadService</span><span class="hljs-params">()</span></span>: UploadApiService {
        <span class="hljs-keyword">val</span> retrofit = Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://upload.example.com/"</span>)
            .addConverterFactory(GsonConverterFactory.create())
            .client(createOkHttpClientForUpload())
            .build()
        
        <span class="hljs-keyword">return</span> retrofit.create(UploadApiService::<span class="hljs-keyword">class</span>.java)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOrCreateRetrofit</span><span class="hljs-params">(baseUrl: <span class="hljs-type">String</span>)</span></span>: Retrofit {
        <span class="hljs-keyword">return</span> retrofitCache[baseUrl] ?: Retrofit.Builder()
            .baseUrl(baseUrl)
            .addConverterFactory(GsonConverterFactory.create())
            .client(createDefaultOkHttpClient())
            .build().also {
                retrofitCache[baseUrl] = it
            }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createDefaultOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> OkHttpClient.Builder()
            .connectTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
            .addInterceptor(LoggingInterceptor())
            .build()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOkHttpClientWithAuth</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> createDefaultOkHttpClient().newBuilder()
            .addInterceptor(AuthInterceptor(token))
            .build()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOkHttpClientForUpload</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> createDefaultOkHttpClient().newBuilder()
            .connectTimeout(<span class="hljs-number">60</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">60</span>, TimeUnit.SECONDS)
            .build()
    }
}
</code></pre>
<h3 data-id="heading-15">2. 数据库DAO工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUserDao</span><span class="hljs-params">()</span></span>: UserDao
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createProductDao</span><span class="hljs-params">()</span></span>: ProductDao
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOrderDao</span><span class="hljs-params">()</span></span>: OrderDao
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTransactionDao</span><span class="hljs-params">()</span></span>: TransactionDao
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomDatabaseFactory</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : DatabaseFactory {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> database: AppDatabase <span class="hljs-keyword">by</span> lazy {
        Room.databaseBuilder(
            context.applicationContext,
            AppDatabase::<span class="hljs-keyword">class</span>.java,
            <span class="hljs-string">"app_database.db"</span>
        ).build()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createUserDao</span><span class="hljs-params">()</span></span>: UserDao = database.userDao()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createProductDao</span><span class="hljs-params">()</span></span>: ProductDao = database.productDao()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOrderDao</span><span class="hljs-params">()</span></span>: OrderDao = database.orderDao()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTransactionDao</span><span class="hljs-params">()</span></span>: TransactionDao = database.transactionDao()
}

<span class="hljs-comment">// 使用依赖注入</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> DatabaseModule {
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideDatabaseFactory</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: DatabaseFactory {
        <span class="hljs-keyword">return</span> RoomDatabaseFactory(context)
    }
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideUserDao</span><span class="hljs-params">(factory: <span class="hljs-type">DatabaseFactory</span>)</span></span>: UserDao {
        <span class="hljs-keyword">return</span> factory.createUserDao()
    }
    
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideProductDao</span><span class="hljs-params">(factory: <span class="hljs-type">DatabaseFactory</span>)</span></span>: ProductDao {
        <span class="hljs-keyword">return</span> factory.createProductDao()
    }
}
</code></pre>
<h3 data-id="heading-16">3. 主题工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ThemeFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createButton</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: Button
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTextView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: TextView
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createEditText</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: EditText
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createCardView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: CardView
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LightThemeFactory</span> : <span class="hljs-type">ThemeFactory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createButton</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: Button {
        <span class="hljs-keyword">return</span> Button(context).apply {
            setBackgroundColor(ContextCompat.getColor(context, R.color.light_primary))
            setTextColor(ContextCompat.getColor(context, R.color.light_on_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTextView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: TextView {
        <span class="hljs-keyword">return</span> TextView(context).apply {
            setTextColor(ContextCompat.getColor(context, R.color.light_text_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createEditText</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: EditText {
        <span class="hljs-keyword">return</span> EditText(context).apply {
            setBackgroundResource(R.drawable.light_edittext_background)
            setTextColor(ContextCompat.getColor(context, R.color.light_text_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createCardView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: CardView {
        <span class="hljs-keyword">return</span> CardView(context).apply {
            setCardBackgroundColor(ContextCompat.getColor(context, R.color.light_surface))
            cardElevation = <span class="hljs-number">4f</span>
        }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DarkThemeFactory</span> : <span class="hljs-type">ThemeFactory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createButton</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: Button {
        <span class="hljs-keyword">return</span> Button(context).apply {
            setBackgroundColor(ContextCompat.getColor(context, R.color.dark_primary))
            setTextColor(ContextCompat.getColor(context, R.color.dark_on_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTextView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: TextView {
        <span class="hljs-keyword">return</span> TextView(context).apply {
            setTextColor(ContextCompat.getColor(context, R.color.dark_text_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createEditText</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: EditText {
        <span class="hljs-keyword">return</span> EditText(context).apply {
            setBackgroundResource(R.drawable.dark_edittext_background)
            setTextColor(ContextCompat.getColor(context, R.color.dark_text_primary))
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createCardView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: CardView {
        <span class="hljs-keyword">return</span> CardView(context).apply {
            setCardBackgroundColor(ContextCompat.getColor(context, R.color.dark_surface))
            cardElevation = <span class="hljs-number">4f</span>
        }
    }
}

<span class="hljs-comment">// 在Activity中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> themeFactory: ThemeFactory
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 根据设置选择主题工厂</span>
        themeFactory = <span class="hljs-keyword">if</span> (isDarkThemeEnabled()) {
            DarkThemeFactory()
        } <span class="hljs-keyword">else</span> {
            LightThemeFactory()
        }
        
        setContentView(R.layout.activity_theme)
        
        <span class="hljs-comment">// 动态创建视图</span>
        <span class="hljs-keyword">val</span> button = themeFactory.createButton(<span class="hljs-keyword">this</span>)
        <span class="hljs-keyword">val</span> textView = themeFactory.createTextView(<span class="hljs-keyword">this</span>)
        
        <span class="hljs-comment">// 添加到布局</span>
        <span class="hljs-keyword">val</span> container = findViewById&lt;ViewGroup&gt;(R.id.container)
        container.addView(button)
        container.addView(textView)
    }
}
</code></pre>
<h2 data-id="heading-17">六、工厂方法模式的优缺点</h2>
<h3 data-id="heading-18">✅ 优点</h3>
<ol>
<li><strong>符合开闭原则</strong>：增加新产品时只需添加新的工厂类，无需修改现有代码</li>
<li><strong>单一职责原则</strong>：创建逻辑集中在工厂类中</li>
<li><strong>解耦</strong>：客户端代码与具体产品类解耦</li>
<li><strong>可扩展性</strong>：易于扩展新产品</li>
<li><strong>代码可维护性</strong>：创建逻辑统一管理</li>
</ol>
<h3 data-id="heading-19">❌ 缺点</h3>
<ol>
<li><strong>类数量增加</strong>：每增加一个产品就要增加一个工厂类</li>
<li><strong>增加系统复杂度</strong>：引入了额外的抽象层</li>
<li><strong>需要理解工厂层次</strong>：客户端需要理解工厂的层次结构</li>
<li><strong>可能过度设计</strong>：对于简单对象创建，可能过于复杂</li>
</ol>
<h2 data-id="heading-20">七、与相关模式的对比</h2>
<h3 data-id="heading-21">工厂方法 vs 抽象工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 工厂方法：一个工厂类只创建一个产品</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createButton</span><span class="hljs-params">()</span></span>: Button  <span class="hljs-comment">// 只有一个产品</span>
}

<span class="hljs-comment">// 抽象工厂：一个工厂类创建多个相关产品</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ThemeFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createButton</span><span class="hljs-params">()</span></span>: Button      <span class="hljs-comment">// 多个相关产品</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTextView</span><span class="hljs-params">()</span></span>: TextView
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createDialog</span><span class="hljs-params">()</span></span>: Dialog
}
</code></pre>
<h3 data-id="heading-22">工厂方法 vs 简单工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简单工厂：一个工厂类根据参数创建不同产品</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleVehicleFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">(type: <span class="hljs-type">String</span>)</span></span>: Vehicle {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
            <span class="hljs-string">"car"</span> -&gt; Car()
            <span class="hljs-string">"bike"</span> -&gt; Bike()
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException()
        }
    }
}

<span class="hljs-comment">// 工厂方法：每个产品有对应的工厂类</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VehicleFactory</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span>: Vehicle
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CarFactory</span> : <span class="hljs-type">VehicleFactory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span> = Car()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BikeFactory</span> : <span class="hljs-type">VehicleFactory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createVehicle</span><span class="hljs-params">()</span></span> = Bike()
}
</code></pre>
<h2 data-id="heading-23">八、Kotlin中的优化实现</h2>
<h3 data-id="heading-24">1. 使用高阶函数作为工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 将工厂方法定义为函数类型</span>
<span class="hljs-keyword">typealias</span> ViewFactory = (Context) -&gt; View

<span class="hljs-comment">// 工厂映射表</span>
<span class="hljs-keyword">val</span> viewFactories = mapOf&lt;String, ViewFactory&gt;(
    <span class="hljs-string">"button"</span> to { context -&gt; 
        Button(context).apply {
            text = <span class="hljs-string">"动态按钮"</span>
        }
    },
    <span class="hljs-string">"textView"</span> to { context -&gt;
        TextView(context).apply {
            text = <span class="hljs-string">"动态文本"</span>
            textSize = <span class="hljs-number">16f</span>
        }
    },
    <span class="hljs-string">"editText"</span> to { context -&gt;
        EditText(context).apply {
            hint = <span class="hljs-string">"请输入..."</span>
        }
    }
)

<span class="hljs-comment">// 使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createView</span><span class="hljs-params">(type: <span class="hljs-type">String</span>, context: <span class="hljs-type">Context</span>)</span></span>: View? {
    <span class="hljs-keyword">return</span> viewFactories[type]?.invoke(context)
}
</code></pre>
<h3 data-id="heading-25">2. 使用伴生对象工厂方法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> exception: Throwable) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    
    <span class="hljs-comment">// 伴生对象中的工厂方法</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">success</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">T</span>)</span></span>: Result&lt;T&gt; = Success(<span class="hljs-keyword">data</span>)
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">error</span><span class="hljs-params">(exception: <span class="hljs-type">Throwable</span>)</span></span>: Result&lt;<span class="hljs-built_in">Nothing</span>&gt; = Error(exception)
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loading</span><span class="hljs-params">()</span></span>: Result&lt;<span class="hljs-built_in">Nothing</span>&gt; = Loading
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> result1 = Result.success(<span class="hljs-string">"数据"</span>)
<span class="hljs-keyword">val</span> result2 = Result.error(RuntimeException(<span class="hljs-string">"错误"</span>))
<span class="hljs-keyword">val</span> result3 = Result.loading()
</code></pre>
<h3 data-id="heading-26">3. 使用内联函数和reified类型</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 泛型工厂方法</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : View&gt;</span> <span class="hljs-title">createView</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: T {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (T::<span class="hljs-keyword">class</span>) {
        Button::<span class="hljs-keyword">class</span> -&gt; Button(context) <span class="hljs-keyword">as</span> T
        TextView::<span class="hljs-keyword">class</span> -&gt; TextView(context) <span class="hljs-keyword">as</span> T
        EditText::<span class="hljs-keyword">class</span> -&gt; EditText(context) <span class="hljs-keyword">as</span> T
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"不支持的View类型"</span>)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> button: Button = createView(context)
<span class="hljs-keyword">val</span> textView: TextView = createView(context)
</code></pre>
<h2 data-id="heading-27">九、最佳实践指南</h2>
<h3 data-id="heading-28">何时使用工厂方法模式？</h3>
<p>✅ <strong>适用场景</strong>：</p>
<ol>
<li>不知道对象的确切类型，需要在运行时决定</li>
<li>需要为库或框架提供扩展点</li>
<li>需要创建复杂对象，且创建逻辑可能变化</li>
<li>需要解耦客户端代码和具体实现类</li>
<li>系统中需要经常添加新产品</li>
</ol>
<p>❌ <strong>避免使用场景</strong>：</p>
<ol>
<li>对象创建逻辑简单且固定</li>
<li>产品类型很少，且不会扩展</li>
<li>性能要求极高，需要避免额外抽象层</li>
<li>可以使用依赖注入框架解决创建问题</li>
</ol>
<h3 data-id="heading-29">Android开发建议</h3>
<ol>
<li>
<p><strong>合理选择工厂类型</strong>：</p>
<ul>
<li>简单场景用简单工厂</li>
<li>需要扩展用工厂方法</li>
<li>创建相关产品族用抽象工厂</li>
</ul>
</li>
<li>
<p><strong>与依赖注入结合</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用Hilt/Dagger管理工厂</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> FactoryModule {
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideViewModelFactory</span><span class="hljs-params">()</span></span>: ViewModelProvider.Factory {
        <span class="hljs-keyword">return</span> ViewModelFactory()
    }
}
</code></pre>
<ol start="3">
<li>
<p><strong>考虑使用Kotlin特性</strong>：</p>
<ul>
<li>密封类 + 伴生对象工厂方法</li>
<li>高阶函数作为工厂</li>
<li>内联函数简化泛型工厂</li>
</ul>
</li>
</ol>
<h2 data-id="heading-30">十、总结</h2>
<p>工厂方法模式是Android开发中最常用的设计模式之一，特别是在以下场景：</p>
<ol>
<li><strong>框架扩展点</strong>：如ViewModelProvider.Factory、FragmentFactory</li>
<li><strong>UI组件创建</strong>：如Adapter中的ViewHolder创建</li>
<li><strong>依赖管理</strong>：如通过工厂创建带依赖的对象</li>
<li><strong>配置管理</strong>：如根据配置创建不同实现</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li>工厂方法模式的核心是<strong>让子类决定创建什么对象</strong></li>
<li>符合<strong>开闭原则</strong>，易于扩展</li>
<li>在Android中常用于<strong>解耦和扩展</strong></li>
<li>Kotlin提供了更简洁的实现方式</li>
</ul>
<p><strong>与其他模式的结合</strong>：</p>
<ul>
<li>与<strong>模板方法模式</strong>结合：在父类中定义算法骨架，子类实现工厂方法</li>
<li>与<strong>抽象工厂模式</strong>结合：创建相关产品族</li>
<li>与<strong>依赖注入</strong>结合：通过工厂管理依赖创建</li>
</ul>
<p>工厂方法模式是构建灵活、可扩展的Android应用的重要工具，合理使用可以显著提高代码的可维护性和可测试性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从踩坑到解决：VS Code Remote-SSH 连接阿里云服务器全流程排障]]></title>    <link>https://juejin.cn/post/7601169987395518515</link>    <guid>https://juejin.cn/post/7601169987395518515</guid>    <pubDate>2026-01-31T01:17:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987395518515" data-draft-id="7601028900886446126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从踩坑到解决：VS Code Remote-SSH 连接阿里云服务器全流程排障"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-31T01:17:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="思无邪237"/> <meta itemprop="url" content="https://juejin.cn/user/177475072567498"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从踩坑到解决：VS Code Remote-SSH 连接阿里云服务器全流程排障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/177475072567498/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    思无邪237
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:17:17.000Z" title="Sat Jan 31 2026 01:17:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从踩坑到解决：VS Code Remote-SSH 连接阿里云服务器全流程排障</h2>
<p>最近在使用 VS Code Remote-SSH 连接阿里云服务器时，我遇到了一连串权限和配置问题。从本地私钥权限错误到主机密钥变更警告，再到 VS Code 插件连接失败，几乎踩遍了所有常见的坑。</p>
<p>今天我把整个排障过程整理成一篇完整的博客，希望能帮到遇到同样问题的朋友。</p>
<hr/>
<h3 data-id="heading-1">一、问题背景</h3>
<p>我使用的是阿里云轻量应用服务器，本地环境是 Windows 11。目标是通过 VS Code 的 Remote-SSH 插件实现远程开发，但连接时出现了各种错误：</p>
<ul>
<li>
<p>终端连接提示 <code>Bad permissions</code> 和 <code>UNPROTECTED PRIVATE KEY FILE!</code></p>
</li>
<li>
<p>VS Code 插件报 <code>Host key verification failed</code> 和 <code>过程试图写入的管道不存在</code></p>
</li>
<li>
<p>即使删除旧主机密钥，依然无法正常连接</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e16a8a97764349a0ca25fdebfef101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=p6bbBNL1r5%2BQXnNaBFntJeVbP84%3D" alt="image-20260131091007140" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">二、核心问题定位</h3>
<p>通过分析日志和终端输出，我把问题拆解为三个核心环节：</p>
<h4 data-id="heading-3">1. 私钥文件权限过宽</h4>
<p>SSH 协议对私钥的安全要求非常严格，必须<strong>仅允许当前用户读取</strong>。如果私钥文件的权限中包含 <code>NT AUTHORITY\Authenticated Users</code> 这类公共用户组，SSH 会直接判定文件不安全并拒绝加载。</p>
<p>关键错误日志：</p>
<pre><code class="hljs language-Plain" lang="Plain">Bad permissions. Try removing permissions for user: NT AUTHORITY\\Authenticated Users (S-1-5-11) on file E:/tools/cert/light.pem.
Permissions for 'E:\\tools\\cert\\light.pem' are too open.
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db1dbd3e6f89479da00958fb380ad117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=SI1JQI5aHDz3n0Tv6JX6idyiqd4%3D" alt="image-20260131085608080" loading="lazy"/></p>
<h4 data-id="heading-4">2. 主机密钥变更触发安全校验</h4>
<p>服务器重启或重置密钥后，主机的 SSH 密钥会发生变化。本地 <code>known_hosts</code> 文件中留存的旧密钥与新密钥冲突，导致 SSH 为了防止中间人攻击而拒绝连接。</p>
<p>关键错误日志：</p>
<pre><code class="hljs language-Plain" lang="Plain">WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
Host key verification failed.
</code></pre>
<h4 data-id="heading-5">3. VS Code 插件配置与缓存问题</h4>
<p>VS Code 的 Remote-SSH 插件依赖本地 SSH 客户端，若配置文件未明确指定私钥路径，或插件缓存了旧的连接信息，都会导致连接失败。</p>
<hr/>
<h3 data-id="heading-6">三、分步解决方案</h3>
<h4 data-id="heading-7">第一步：彻底修复私钥文件权限（最关键）</h4>
<p>这是整个排障过程的核心，必须确保私钥文件仅对当前用户开放读取权限。</p>
<h5 data-id="heading-8">1. 管理员 PowerShell 强制清理权限</h5>
<p>打开<strong>管理员身份的 PowerShell</strong>，执行以下命令：</p>
<pre><code class="hljs language-PowerShell" lang="PowerShell"># 替换为你的私钥路径
$keyPath = "E:\tools\cert\light.pem"

# 1. 移除所有公共用户组权限
icacls $keyPath /remove *S-1-5-11 /Q  # 移除 Authenticated Users
icacls $keyPath /remove "Everyone" /Q
icacls $keyPath /remove "SYSTEM" /Q
icacls $keyPath /remove "Administrators" /Q

# 2. 禁用权限继承
icacls $keyPath /inheritance:r /Q

# 3. 仅授予当前用户读取权限
icacls $keyPath /grant "$env:USERNAME`:R" /Q

# 4. 验证权限（确保只有你的用户名有 R 权限）
icacls $keyPath
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a696c107dcd145618ba24cff89e2147e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=hYCOMqwpJHoFHgQNwcDLhreZvqA%3D" alt="image-20260131085754717" loading="lazy"/></p>
<h5 data-id="heading-9">2. 迁移私钥到用户专属目录（推荐）</h5>
<p>将私钥从工具目录（如 <code>E:\tools\cert</code>）迁移到用户专属的 <code>.ssh</code> 目录，可规避目录级别的权限干扰：</p>
<pre><code class="hljs language-PowerShell" lang="PowerShell">
# 创建用户 .ssh 目录（如果不存在）
New-Item -ItemType Directory -Path "C:\Users\34889\.ssh" -Force

# 复制私钥到新目录
Copy-Item "E:\tools\cert\light.pem" "C:\Users\34889\.ssh\light.pem"

# 对新路径的私钥重新执行权限配置
$keyPath = "C:\Users\34889\.ssh\light.pem"
icacls $keyPath /inheritance:r /Q
icacls $keyPath /grant "$env:USERNAME`:R" /Q
</code></pre>
<p>【配图标注】：用户 .ssh 目录截图（展示目录位置、light.pem 文件，可搭配权限设置界面小图）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf135af8dbe413d968e9a1a18c06444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=gzGI3JtZajGOO7gyms3yJ7XNilk%3D" alt="image-20260131090052042" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-10">第二步：清理旧主机密钥并验证终端连接</h4>
<p>在普通用户权限的 PowerShell 中执行：</p>
<pre><code class="hljs language-PowerShell" lang="PowerShell"># 1. 删除旧的主机密钥记录
ssh-keygen -R &lt;公网ip&gt;

# 2. 测试终端连接（验证权限和密钥有效性）
ssh -i C:\Users\34889\.ssh\light.pem root@&lt;公网ip&gt;
</code></pre>
<p>首次连接时输入 <code>yes</code> 确认新主机密钥，若能成功登录服务器，说明基础连通性已解决。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afbf157d145d47818c9d45db4f9645d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=j6AqMghFYjashWcjfxXd%2B6Utres%3D" alt="image-20260131090224480" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-11">第三步：配置 VS Code Remote-SSH 插件</h4>
<ol>
<li>
<p>打开 VS Code → 点击左侧「远程资源管理器」→ 找到「SSH 目标」→ 点击「配置」（齿轮图标）。</p>
</li>
<li>
<p>编辑 <code>.ssh/config</code> 文件，添加如下配置：</p>
</li>
<li>
<p>保存配置后，<strong>重启 VS Code</strong> 以清空插件缓存。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3279b5ef44460ba13de48babe8daa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=JtvX64tseBYtNwFSdk6T1WSjc10%3D" alt="image-20260131090334109" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-12">第四步：验证 VS Code 连接</h4>
<p>在 VS Code 的「SSH 目标」列表中，右键点击 <code>39.107.240.31</code> → 选择「连接到主机」。若配置正确，插件会自动完成服务器端安装并成功连接。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd73f3e7daa45f2b21bacd4cd7c857d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=VR7wGD4o2zmq3pINXYR2yXaveVY%3D" alt="image-20260131090448422" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-13">四、常见问题排查清单</h3>
<p>如果按上述步骤操作后仍无法连接，可按以下顺序排查：</p>
<ol>
<li><strong>终端连接是否正常？</strong></li>
</ol>
<p>先确保 <code>ssh -i ...</code> 命令能在终端成功登录，终端通了 VS Code 才可能通。</p>
<ol>
<li><strong>VS Code 是否以普通用户身份运行？</strong></li>
</ol>
<p>用管理员身份运行 VS Code 会导致权限上下文异常，必须以普通用户身份启动。</p>
<ol>
<li><strong>插件缓存是否需要清理？</strong></li>
</ol>
<p>删除 <code>C:\Users\34889.vscode\extensions\ms-vscode-remote.remote-ssh-0.120.0</code> 文件夹，然后重新安装 Remote-SSH 插件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e66eb58824ac46ed8f3e800296ecadff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCd5peg6YKqMjM3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770427036&amp;x-signature=t3BBszT9Anio1QvvvGRitcWrCvE%3D" alt="image-20260131090810160" loading="lazy"/></p>
<ol>
<li><strong>私钥文件是否被锁定？</strong></li>
</ol>
<p>检查是否有文本编辑器、杀毒软件等程序正在占用私钥文件，关闭后重试。</p>
<hr/>
<h3 data-id="heading-14">五、总结</h3>
<p>整个排障过程的核心逻辑是：<strong>先确保基础 SSH 连接正常，再解决 VS Code 插件层面的问题</strong>。</p>
<p>其中，私钥权限问题是最容易被忽视的环节，也是导致连接失败的主要原因。通过管理员权限强制清理权限，并将私钥迁移到用户专属目录，可从根源解决这个问题。</p>
<p>希望这篇博客能帮你少走弯路，顺利实现 VS Code 远程开发！🚀</p>
<hr/>
<p>如果你需要，我还可以帮你整理一份<strong>一键修复脚本</strong>，把所有权限配置和命令打包成一个 <code>.ps1</code> 文件，下次遇到问题直接运行即可解决。需要吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[借助Trae AI工具构建文本高亮插件的完整历程]]></title>    <link>https://juejin.cn/post/7601007650723348521</link>    <guid>https://juejin.cn/post/7601007650723348521</guid>    <pubDate>2026-01-31T01:59:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601007650723348521" data-draft-id="7600989427905986614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="借助Trae AI工具构建文本高亮插件的完整历程"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-31T01:59:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="会一丢丢蝶泳的咻狗"/> <meta itemprop="url" content="https://juejin.cn/user/1803675742243277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            借助Trae AI工具构建文本高亮插件的完整历程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1803675742243277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    会一丢丢蝶泳的咻狗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T01:59:05.000Z" title="Sat Jan 31 2026 01:59:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arta">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#aaa}.hljs-section{color:#fff}.hljs-comment,.hljs-meta,.hljs-quote{color:#444}.hljs-bullet,.hljs-regexp,.hljs-string,.hljs-symbol{color:#fc3}.hljs-addition,.hljs-number{color:#0c6}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-template-variable,.hljs-type{color:#32aaee}.hljs-keyword,.hljs-name,.hljs-selector-class,.hljs-selector-id,.hljs-selector-tag{color:#64a}.hljs-deletion,.hljs-template-tag,.hljs-title,.hljs-variable{color:#b16}.hljs-doctag,.hljs-section,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">从复杂实现到优雅封装：借助Trae AI工具构建文本高亮插件的完整历程</h2>
<p>本文记录了我如何从复杂的Vue组件实现，借助Trae AI工具一步步优化，最终开发出轻量级文本高亮插件 <code>lk-text-select-highlight</code> 的完整过程。</p>
<h3 data-id="heading-1">🚀 项目背景</h3>
<p>在开发一个文本标注功能时，我最初实现了一个复杂的文本高亮系统。这个实现虽然功能完整，但存在几个痛点：</p>
<ul>
<li><strong>逻辑复杂</strong>：需要手动处理DOM操作、UUID生成、高亮状态管理</li>
<li><strong>维护困难</strong>：代码量庞大，难以调试和扩展</li>
<li><strong>回显困难</strong>：重新应用高亮标记时逻辑复杂，容易出错</li>
</ul>
<h3 data-id="heading-2">💡 借助Trae AI工具的优化之旅</h3>
<h4 data-id="heading-3">第一阶段：需求分析与原型设计</h4>
<p>我向Trae AI提出了核心需求，它迅速生成了基础框架，包括ES6 Class架构设计和核心方法实现。</p>
<h4 data-id="heading-4">第二阶段：功能迭代与优化</h4>
<p>在Trae AI的协助下，我们逐步完善了功能：</p>
<p><strong>1. 容器限制功能</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 限制高亮只能在指定容器内进行</span>
<span class="hljs-keyword">const</span> highlighter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextHighlighter</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content-area'</span>)
});
</code></pre>
<p><strong>2. 严格模式实现</strong> 防止在已高亮的文本上再次高亮，避免嵌套问题。</p>
<p><strong>3. UUID存储优化</strong> 从存储DOM元素改为存储UUID标识符，提升性能和稳定性。</p>
<h4 data-id="heading-5">第三阶段：API完善与测试</h4>
<p>通过多次迭代，我们添加了关键的 <code>setHighlights</code> 方法，同时建立了完整的测试套件。</p>
<h3 data-id="heading-6">🎯 原始实现的精华代码</h3>
<h4 data-id="heading-7">核心高亮功能</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 高亮选中文本的核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">highlightSelectedText</span>(<span class="hljs-params">color = <span class="hljs-string">'#4593ff'</span>, tag, category</span>) {
  <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
  <span class="hljs-keyword">if</span> (!selection || selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> selectedRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> uuid = <span class="hljs-title function_">uuidv4</span>();
  <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>();

  <span class="hljs-comment">// 创建高亮span元素</span>
  <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
  span.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = color;
  span.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-uuid'</span>, uuid);
  
  <span class="hljs-keyword">try</span> {
    selectedRange.<span class="hljs-title function_">surroundContents</span>(span);
    <span class="hljs-comment">// 存储高亮信息</span>
    highlightedTexts.<span class="hljs-property">value</span>[uuid] = { uuid, <span class="hljs-attr">text</span>: selectedText, <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() };
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 处理跨元素选择的情况</span>
    <span class="hljs-keyword">const</span> contents = selectedRange.<span class="hljs-title function_">extractContents</span>();
    span.<span class="hljs-title function_">appendChild</span>(contents);
    selectedRange.<span class="hljs-title function_">insertNode</span>(span);
  }
}
</code></pre>
<h4 data-id="heading-8">复杂的状态管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储高亮文本信息的复杂状态管理</span>
<span class="hljs-keyword">const</span> highlightedTexts = <span class="hljs-title function_">ref</span>({
  [<span class="hljs-attr">key</span>: string]: {
    <span class="hljs-attr">uuid</span>: string;
    <span class="hljs-attr">text</span>: string;
    <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;
    color?: string;
    tag?: string;
    category?: string;
  };
});
</code></pre>
<h4 data-id="heading-9">回显功能的复杂实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 重新应用高亮的复杂逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reapplyAllHighlights</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">clearExistingHighlights</span>();
  
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(highlightedTexts.<span class="hljs-property">value</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> container = textSelectRef.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">if</span> (container) {
      <span class="hljs-comment">// 需要遍历所有文本节点查找匹配内容</span>
      <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(container, <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_TEXT</span>, <span class="hljs-literal">null</span>);
      <span class="hljs-comment">// 复杂的DOM操作和范围处理...</span>
    }
  });
}
</code></pre>
<h3 data-id="heading-10">🎯 借助插件的优雅实现</h3>
<h4 data-id="heading-11">安装与引入</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">bash
npm install lk-<span class="hljs-keyword">text</span>-<span class="hljs-keyword">select</span>-highlight
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TextHighlighter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'lk-text-select-highlight'</span>;
</code></pre>
<h4 data-id="heading-12">简洁的核心实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化 - 一行代码搞定</span>
<span class="hljs-keyword">const</span> highlighter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextHighlighter</span>({
  <span class="hljs-attr">className</span>: <span class="hljs-string">'text-highlight'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#ffeb3b'</span>,
  <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
});

<span class="hljs-comment">// 高亮选中文本 - 方法调用即可</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">highlightText</span> = (<span class="hljs-params"/>) =&gt; {
  highlighter.<span class="hljs-title function_">highlightSelection</span>();
};

<span class="hljs-comment">// 获取高亮数据 - 直接返回结构化数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getHighlights</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> highlighter.<span class="hljs-title function_">getHighlights</span>();
};

<span class="hljs-comment">// 设置高亮数据 - 完美解决回显问题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadHighlights</span> = (<span class="hljs-params">savedData</span>) =&gt; {
  highlighter.<span class="hljs-title function_">setHighlights</span>(savedData);
};
</code></pre>
<h4 data-id="heading-13">完整的Demo实现</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>文本高亮Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.text-highlight</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffeb3b</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">2px</span> <span class="hljs-number">4px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">3px</span>; }
    <span class="hljs-selector-id">#content</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">min-height</span>: <span class="hljs-number">200px</span>; }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"highlightText()"</span>&gt;</span>高亮选中文本<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"removeAll()"</span>&gt;</span>清除所有高亮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"saveHighlights()"</span>&gt;</span>保存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"loadHighlights()"</span>&gt;</span>加载<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一段示例文本，您可以选中其中的文字进行高亮标注。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高亮功能支持多次标注，并且可以保存和恢复标注状态。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/lk-text-select-highlight"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> highlighter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextHighlighter</span>({
      <span class="hljs-attr">className</span>: <span class="hljs-string">'text-highlight'</span>,
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
    });

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">highlightText</span>(<span class="hljs-params"/>) {
      highlighter.<span class="hljs-title function_">highlightSelection</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeAll</span>(<span class="hljs-params"/>) {
      highlighter.<span class="hljs-title function_">removeAllHighlights</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">saveHighlights</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'highlights'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(highlighter.<span class="hljs-title function_">getHighlights</span>()));
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadHighlights</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'highlights'</span>);
      <span class="hljs-keyword">if</span> (saved) {
        highlighter.<span class="hljs-title function_">setHighlights</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved));
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">🛠️ Trae AI工具的关键作用</h3>
<p>在整个开发过程中，Trae AI展现了强大的辅助能力：</p>
<ol>
<li><strong>快速原型生成</strong>：几分钟内完成基础框架搭建</li>
<li><strong>代码优化建议</strong>：提供最佳实践和性能优化方案</li>
<li><strong>错误诊断修复</strong>：快速定位并解决技术问题</li>
<li><strong>文档自动生成</strong>：创建完整的中英文文档</li>
<li><strong>测试用例编写</strong>：确保代码质量和稳定性</li>
</ol>
<h3 data-id="heading-15">📦 插件核心优势对比</h3>



































<table><thead><tr><th>特性</th><th>原始实现</th><th>插件实现</th></tr></thead><tbody><tr><td><strong>代码量</strong></td><td>500+行</td><td>10-20行</td></tr><tr><td><strong>维护性</strong></td><td>复杂难维护</td><td>简单易维护</td></tr><tr><td><strong>功能性</strong></td><td>基础功能</td><td>完整功能集</td></tr><tr><td><strong>稳定性</strong></td><td>容易出错</td><td>经过测试</td></tr><tr><td><strong>扩展性</strong></td><td>难以扩展</td><td>易于扩展</td></tr></tbody></table>
<h4 data-id="heading-16">插件核心特性</h4>
<ul>
<li>✅ <strong>轻量级</strong>：压缩后仅2.8KB</li>
<li>✅ <strong>易用性</strong>：简单的API设计，快速上手</li>
<li>✅ <strong>兼容性</strong>：支持多种模块格式</li>
<li>✅ <strong>TypeScript</strong>：完整的类型定义支持</li>
<li>✅ <strong>容器限制</strong>：可限制高亮区域范围</li>
<li>✅ <strong>严格模式</strong>：防止嵌套高亮问题</li>
</ul>
<h3 data-id="heading-17">🎉 总结与收获</h3>
<p>通过这次开发经历，我深刻体会到：</p>
<ol>
<li><strong>工具赋能</strong>：AI工具如Trae能够显著提升开发效率和质量</li>
<li><strong>封装价值</strong>：将复杂功能封装成独立库，提高代码复用性</li>
<li><strong>渐进优化</strong>：从MVP开始，逐步迭代完善功能</li>
<li><strong>开源价值</strong>：优秀的工具应该分享给社区</li>
</ol>
<h3 data-id="heading-18">🌟 关注与使用</h3>
<p><strong>插件地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Flk-text-select-highlight" target="_blank" title="https://www.npmjs.com/package/lk-text-select-highlight" ref="nofollow noopener noreferrer">www.npmjs.com/package/lk-…</a></p>
<p><strong>安装使用</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">bash
npm install lk-<span class="hljs-keyword">text</span>-<span class="hljs-keyword">select</span>-highlight
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">javascript
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TextHighlighter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'lk-text-select-highlight'</span>;

<span class="hljs-keyword">const</span> highlighter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextHighlighter</span>();
highlighter.<span class="hljs-title function_">highlightSelection</span>(); <span class="hljs-comment">// 就是这么简单！</span>
</code></pre>
<p>这个插件的诞生证明了现代开发工具与AI辅助编程的强大结合，期待它在更多项目中发挥作用！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[520-不换 Cursor：VS Code + Gemini Pro 顶配攻略]]></title>    <link>https://juejin.cn/post/7600999271769620480</link>    <guid>https://juejin.cn/post/7600999271769620480</guid>    <pubDate>2026-01-31T03:04:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600999271769620480" data-draft-id="7600976289064878080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="520-不换 Cursor：VS Code + Gemini Pro 顶配攻略"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-01-31T03:04:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LinkZ"/> <meta itemprop="url" content="https://juejin.cn/user/520514700336122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            520-不换 Cursor：VS Code + Gemini Pro 顶配攻略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/520514700336122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LinkZ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:04:42.000Z" title="Sat Jan 31 2026 03:04:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人为了 AI 体验转向了 Cursor，但作为原生 VS Code 的死忠，我们舍不得那些调教已久的插件和习惯。其实，通过 <strong>Continue</strong> 插件联动 <strong>Gemini Pro 会员</strong>，你完全可以在不改变开发习惯的前提下，获得甚至超越 Cursor 的体验。</p>
<h2 data-id="heading-0">1、为什么是这个组合？</h2>
<ul>
<li><strong>原汁原味：</strong> 无需迁移配置，就在你最熟悉的 VS Code 里工作。</li>
<li><strong>谷歌最新的模型：</strong> Gemini 3 Pro。</li>
<li><strong>极致性价比：</strong> 利用 Google 学生优惠，可免费获得 Gemini Pro 会员，省下每月 20 刀的 Cursor 订阅费。</li>
</ul>
<hr/>
<h2 data-id="heading-1">2、准备工作</h2>
<ol>
<li>教程中所有的网址如果打不开，请挂上梯子，所有软件的安装地址最好不要包含中文。</li>
<li>有一个 Gemini Pro 会员，可以自己申请获取，网上有相关教程，难度较大。也可以直接在闲鱼买成品号，需自己甄别商家。</li>
<li>在<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdownload" target="_blank" title="https://antigravity.google/download" ref="nofollow noopener noreferrer"><strong>Antigravity 官网</strong></a>下载对应的版本进行安装，安装完毕后打开不用登录。</li>
<li>在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flbjlaq%2FAntigravity-Manager%2Freleases" target="_blank" title="https://github.com/lbjlaq/Antigravity-Manager/releases" ref="nofollow noopener noreferrer">Antigravity-Manager</a>这个开源工具的网站，下载对应的版本并安装。</li>
<li>在<strong>VS Code</strong> 插件市场搜索并安装 <code>Continue - open-source AI code agent</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-2">3、Antigravity Tools 工具配置</h2>
<h3 data-id="heading-3">3.1、添加账号</h3>
<p>打开下载的 Antigravity Tools 工具，按照下图顺序添加账号，
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f688da62d344d259004981476091a48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=iqSopISV43b01iCoAzNPS6jGjy8%3D" alt="01-1" loading="lazy"/></p>
<p>通过 OAuth 授权的方式，会自动跳转到浏览器，登录你有 Gemini Pro 会员的账号。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d2e2d69b7f4a37bf574984259ca7d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=4E7toUDUkoZPEeMYzvWKY8wbeP8%3D" alt="01-2" loading="lazy"/></p>
<h3 data-id="heading-4">3.2、获取 API 密钥</h3>
<p>在 <code>API 反代</code> 页面，点击 <strong>启动服务</strong> ，在 <strong>序号 3</strong> 处复制密钥。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce8a6f927cb4fb3b28d2deb9985539a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=eWp2kFKMpY0ZQN6rk04r%2BenRwto%3D" alt="01-3" loading="lazy"/></p>
<ol>
<li>选择页面。</li>
<li>选择协议。</li>
<li>复制模型 id。</li>
<li>复制 api 地址，注意：地址最后要加 <code>/v1</code> ，比如图中最后地址应为 <code>http://127.0.0.1:8045/v1</code> 。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/547cf251357b4d589ae89421c410db33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=TrW3Q7Wg1vJvkVhKIH2z2Qp091o%3D" alt="01-4" loading="lazy"/></li>
</ol>
<h3 data-id="heading-5">3.3、查看日志</h3>
<ol>
<li>日志界面。</li>
<li>点击开始记录。</li>
<li>点击可查看详细信息。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d59257301ab8454b91f91a7bebb96698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=4r9RZ0sL75V80NYv0WWD%2BDqTaGM%3D" alt="01-5" loading="lazy"/></li>
</ol>
<h3 data-id="heading-6">3.4、设置</h3>
<ol>
<li>点击。</li>
<li>点击。</li>
<li>此时需运行 <strong>Antigravity</strong>（不用登录） ，点击 <strong>探测</strong> 可以识别到程序路径，也可以手动 <strong>选择</strong>。</li>
<li>此时需运行 <strong>Antigravity</strong>（不用登录），点击 <strong>检测</strong> 即可。</li>
<li>保存。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8391b235636c43c39d4e8b05b48373d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=XmsvlqhIjUrQahBwfJ9HYsVhmPM%3D" alt="01-6" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-7">4、配置 Continue 插件</h2>
<p>第一次使用这个插件根据引导进行登录一下。</p>
<h3 data-id="heading-8">4.1、打开 config.yaml 的本地配置文件</h3>
<ol>
<li>点击。</li>
<li>点击 Local Config 后的设置图标，会弹出来 <code>config.yaml</code> 的配置文件。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37edb99f6db543c5aef25eced0e9a697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=7YvPf6gy90NQ9MQYUDGTCMQWyGQ%3D" alt="01-7" loading="lazy"/></li>
</ol>
<h3 data-id="heading-9">4.2、配置 config.yaml 文件</h3>
<p>配置模板如下，注意 <strong>yaml</strong> 语法的格式，注意保存这个文件。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Local</span> <span class="hljs-string">Config</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
<span class="hljs-attr">schema:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">models:</span>
  <span class="hljs-comment"># continue 插件识别到模型名字里有 Sonnet 字段，可以进行图片识别，</span>
  <span class="hljs-comment"># 当然模型本身也需支持图片识别才可以。</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">06</span> <span class="hljs-string">Gemini</span> <span class="hljs-number">3</span> <span class="hljs-string">Flash</span> <span class="hljs-string">(Sonnet)</span> <span class="hljs-string">极速预览</span> <span class="hljs-comment"># 可随意命名</span>
    <span class="hljs-attr">provider:</span> <span class="hljs-string">anthropic</span> <span class="hljs-comment"># 只能是这个协议</span>
    <span class="hljs-attr">model:</span> <span class="hljs-string">gemini-3-flash</span> <span class="hljs-comment"># 模型 id</span>
    <span class="hljs-attr">apiKey:</span> <span class="hljs-string">sk-1e1111363aa5po549a94e4b76ce25252</span> <span class="hljs-comment"># 换成你的 api 密钥</span>
    <span class="hljs-attr">apiBase:</span> <span class="hljs-string">http://127.0.0.1:8045/v1</span> <span class="hljs-comment"># 换成你上面复制的 api 地址</span>
</code></pre>
<ol>
<li>重新加载后，这里选择你设定的模型就说明成功了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eb770f4cc78477f9ecd6b49b6c2b28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=muob3kD4n8ZfHCT0qLn%2FTwajATI%3D" alt="01-8" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-10">5、测试和说明</h2>
<h3 data-id="heading-11">5.1、错误排查测试</h3>
<p>截止这篇博客写完时，Antigravity Tools V4.0.8，有 bug 在等作者修复中，下面先演示个错误排查说明。</p>
<ol>
<li>
<p>Continue 插件的错误弹窗会反馈信息，但最好和 Antigravity Tools 工具里的日志信息相互印证来确定问题。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fda2e1e6af614926867ea4222455cd19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=NvcPVTb5V1TSOZF9OrO3nbCw0Uo%3D" alt="01-9" loading="lazy"/></p>
</li>
<li>
<p>看到响应报文这里也是错误信息，就去 github 提交问题 issue，或者看有没有反馈相同问题的解决方法，然后等作者消除 bug 就 OK 了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f2bd822d8954061bccd4de0a1f2c215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=1vxVd7MvULVWu8v3jp3t3MvDKds%3D" alt="01-10" loading="lazy"/></p>
</li>
</ol>
<h3 data-id="heading-12">5.2、成功的测试</h3>
<p>由于 bug 问题，我这里使用了智谱的模型，Continue 插件是可以填任何模型的，只要你有 api 密钥和地址。下图是成功的回答。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/709fd70ada694a52b3abf3f61f5a7485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=BOs4aMhR%2Bu31pS1EBnw99w44hoU%3D" alt="01-11" loading="lazy"/></p>
<h3 data-id="heading-13">5.3、Antigravity Tools 更新到最新 V4.0.10 版本的成功测试</h3>
<p>今天醒来发现版本更新了，bug 已经被修复了，成功测试如下图。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa209a5bbe1f44b7841b9f009a81624e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=PzJM3wu4mJE304F0wdTvLT%2B7eQA%3D" alt="01-12" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f8293b563d449195c56895dc68cd62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlua1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770433482&amp;x-signature=YId%2Fd0LZc%2BuY18kU7HdldLL1FMs%3D" alt="01-13" loading="lazy"/></p>
<h3 data-id="heading-14">5.4、说明</h3>
<p>关于 Continue 插件的更多用法，可参照官方文档，或多使用几次就熟悉了，这一套组合起来跟你用 AI 编程工具的效果一样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个Python库：markupsafe - 让你的字符串安全又优雅]]></title>    <link>https://juejin.cn/post/7600989427906363446</link>    <guid>https://juejin.cn/post/7600989427906363446</guid>    <pubDate>2026-01-31T05:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600989427906363446" data-draft-id="7600989427906347062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个Python库：markupsafe - 让你的字符串安全又优雅"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-31T05:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敏编程"/> <meta itemprop="url" content="https://juejin.cn/user/2579909358396288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个Python库：markupsafe - 让你的字符串安全又优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579909358396288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敏编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T05:35:27.000Z" title="Sat Jan 31 2026 05:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">markupsafe - 让你的字符串安全又优雅</h2>
<h3 data-id="heading-1">一、什么是markupsafe？</h3>
<p><strong>markupsafe</strong> 是一个用于处理标记语言（如HTML、XML）字符串的 Python 库。
它可以帮助你：</p>
<ul>
<li><strong>安全地转义字符串</strong>：防止跨站脚本（XSS）攻击，特别是当你需要将用户输入显示在网页上时。</li>
<li><strong>标记安全字符串</strong>：将经过转义或信任的字符串标记为“安全”，避免重复转义，提高效率。</li>
<li><strong>模板引擎集成</strong>：在像Jinja2这样的模板引擎中，markupsafe扮演了核心角色，确保渲染的HTML内容是安全的。</li>
</ul>
<h3 data-id="heading-2">二、应用场景</h3>
<p><strong>markupsafe</strong> 广泛应用于以下实际场景：</p>
<ul>
<li><strong>Web开发框架</strong>: 在Flask、Jinja2等Web框架中，用于自动转义模板渲染的输出，防止注入攻击。</li>
<li><strong>用户生成内容</strong>: 当你的网站允许用户输入并显示内容时（如评论、论坛帖子），markupsafe能确保这些内容在显示时是安全的。</li>
<li><strong>构建动态HTML/XML</strong>: 在程序中动态生成HTML或XML片段时，需要确保所有插入的数据都经过了正确的转义。</li>
</ul>
<h3 data-id="heading-3">三、如何安装</h3>
<ol>
<li>使用 pip 安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pip install markupsafe

<span class="hljs-comment"># 如果安装慢的话，推荐使用国内镜像源</span>
pip install markupsafe -i https://www.python64.cn/pypi/simple/
</code></pre>
<ol start="2">
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行代码（无需本地安装）</li>
</ol>
<h3 data-id="heading-4">四、示例代码</h3>
<p>转义用户输入以防止XSS攻击</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> markupsafe <span class="hljs-keyword">import</span> escape, Markup

<span class="hljs-comment"># 用户输入，可能包含恶意脚本</span>
user_input_raw = <span class="hljs-string">"&lt;script&gt;alert('您被攻击了！')&lt;/script&gt;"</span>
is_admin = <span class="hljs-literal">True</span> <span class="hljs-comment"># 假设有一个条件判断用户是否是管理员</span>

<span class="hljs-comment"># 使用escape转义用户输入</span>
safe_output = escape(user_input_raw)

<span class="hljs-comment"># 打印转义后的结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"转义后的内容: <span class="hljs-subst">{safe_output}</span>"</span>)

<span class="hljs-comment"># 假设有一些信任的HTML内容，我们不希望它被转义</span>
trusted_html = Markup(<span class="hljs-string">"&lt;b&gt;这是加粗的文本&lt;/b&gt;"</span>)

<span class="hljs-comment"># 如果是管理员，则直接显示原始输入（这里仅为演示，实际应用需极其谨慎）</span>
<span class="hljs-keyword">if</span> is_admin:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"管理员显示（危险！）：<span class="hljs-subst">{user_input_raw}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># 否则显示安全的内容</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"普通用户显示（安全！）：<span class="hljs-subst">{safe_output}</span>"</span>)

<span class="hljs-comment"># 结合使用，Markup标记的内容不会被二次转义</span>
formatted_output = Markup(<span class="hljs-string">f"&lt;p&gt;Hello, <span class="hljs-subst">{safe_output}</span>!&lt;/p&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"组合后的安全HTML: <span class="hljs-subst">{formatted_output}</span>"</span>)

<span class="hljs-comment"># 检查是否是Markup实例</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(formatted_output, Markup):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"formatted_output 是一个 Markup 实例，已被标记为安全。"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"formatted_output 不是 Markup 实例。"</span>)
</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F%3Fcode%3Dfrom%2520markupsafe%2520import%2520escape%252C%2520Markup%250A%250A%2523%2520%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%25EF%25BC%258C%25E5%258F%25AF%25E8%2583%25BD%25E5%258C%2585%25E5%2590%25AB%25E6%2581%25B6%25E6%2584%258F%25E8%2584%259A%25E6%259C%25AC%250Auser_input_raw%2520%253D%2520%2522%253Cscript%253Ealert%2528'%25E6%2582%25A8%25E8%25A2%25AB%25E6%2594%25BB%25E5%2587%25BB%25E4%25BA%2586%25EF%25BC%2581'%2529%253C%252Fscript%253E%2522%250Ais_admin%2520%253D%2520True%2520%2523%2520%25E5%2581%2587%25E8%25AE%25BE%25E6%259C%2589%25E4%25B8%2580%25E4%25B8%25AA%25E6%259D%25A1%25E4%25BB%25B6%25E5%2588%25A4%25E6%2596%25AD%25E7%2594%25A8%25E6%2588%25B7%25E6%2598%25AF%25E5%2590%25A6%25E6%2598%25AF%25E7%25AE%25A1%25E7%2590%2586%25E5%2591%2598%250A%250A%2523%2520%25E4%25BD%25BF%25E7%2594%25A8escape%25E8%25BD%25AC%25E4%25B9%2589%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%250Asafe_output%2520%253D%2520escape%2528user_input_raw%2529%250A%250A%2523%2520%25E6%2589%2593%25E5%258D%25B0%25E8%25BD%25AC%25E4%25B9%2589%25E5%2590%258E%25E7%259A%2584%25E7%25BB%2593%25E6%259E%259C%250Aprint%2528f%2522%25E8%25BD%25AC%25E4%25B9%2589%25E5%2590%258E%25E7%259A%2584%25E5%2586%2585%25E5%25AE%25B9%253A%2520%257Bsafe_output%257D%2522%2529%250A%250A%2523%2520%25E5%2581%2587%25E8%25AE%25BE%25E6%259C%2589%25E4%25B8%2580%25E4%25BA%259B%25E4%25BF%25A1%25E4%25BB%25BB%25E7%259A%2584HTML%25E5%2586%2585%25E5%25AE%25B9%25EF%25BC%258C%25E6%2588%2591%25E4%25BB%25AC%25E4%25B8%258D%25E5%25B8%258C%25E6%259C%259B%25E5%25AE%2583%25E8%25A2%25AB%25E8%25BD%25AC%25E4%25B9%2589%250Atrusted_html%2520%253D%2520Markup%2528%2522%253Cb%253E%25E8%25BF%2599%25E6%2598%25AF%25E5%258A%25A0%25E7%25B2%2597%25E7%259A%2584%25E6%2596%2587%25E6%259C%25AC%253C%252Fb%253E%2522%2529%250A%250A%2523%2520%25E5%25A6%2582%25E6%259E%259C%25E6%2598%25AF%25E7%25AE%25A1%25E7%2590%2586%25E5%2591%2598%25EF%25BC%258C%25E5%2588%2599%25E7%259B%25B4%25E6%258E%25A5%25E6%2598%25BE%25E7%25A4%25BA%25E5%258E%259F%25E5%25A7%258B%25E8%25BE%2593%25E5%2585%25A5%25EF%25BC%2588%25E8%25BF%2599%25E9%2587%258C%25E4%25BB%2585%25E4%25B8%25BA%25E6%25BC%2594%25E7%25A4%25BA%25EF%25BC%258C%25E5%25AE%259E%25E9%2599%2585%25E5%25BA%2594%25E7%2594%25A8%25E9%259C%2580%25E6%259E%2581%25E5%2585%25B6%25E8%25B0%25A8%25E6%2585%258E%25EF%25BC%2589%250Aif%2520is_admin%253A%250A%2520%2520%2520%2520print%2528f%2522%25E7%25AE%25A1%25E7%2590%2586%25E5%2591%2598%25E6%2598%25BE%25E7%25A4%25BA%25EF%25BC%2588%25E5%258D%25B1%25E9%2599%25A9%25EF%25BC%2581%25EF%25BC%2589%25EF%25BC%259A%257Buser_input_raw%257D%2522%2529%250Aelse%253A%250A%2520%2520%2520%2520%2523%2520%25E5%2590%25A6%25E5%2588%2599%25E6%2598%25BE%25E7%25A4%25BA%25E5%25AE%2589%25E5%2585%25A8%25E7%259A%2584%25E5%2586%2585%25E5%25AE%25B9%250A%2520%2520%2520%2520print%2528f%2522%25E6%2599%25AE%25E9%2580%259A%25E7%2594%25A8%25E6%2588%25B7%25E6%2598%25BE%25E7%25A4%25BA%25EF%25BC%2588%25E5%25AE%2589%25E5%2585%25A8%25EF%25BC%2581%25EF%25BC%2589%25EF%25BC%259A%257Bsafe_output%257D%2522%2529%250A%250A%2523%2520%25E7%25BB%2593%25E5%2590%2588%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258CMarkup%25E6%25A0%2587%25E8%25AE%25B0%25E7%259A%2584%25E5%2586%2585%25E5%25AE%25B9%25E4%25B8%258D%25E4%25BC%259A%25E8%25A2%25AB%25E4%25BA%258C%25E6%25AC%25A1%25E8%25BD%25AC%25E4%25B9%2589%250Aformatted_output%2520%253D%2520Markup%2528f%2522%253Cp%253EHello%252C%2520%257Bsafe_output%257D!%253C%252Fp%253E%2522%2529%250Aprint%2528f%2522%25E7%25BB%2584%25E5%2590%2588%25E5%2590%258E%25E7%259A%2584%25E5%25AE%2589%25E5%2585%25A8HTML%253A%2520%257Bformatted_output%257D%2522%2529%250A%250A%2523%2520%25E6%25A3%2580%25E6%259F%25A5%25E6%2598%25AF%25E5%2590%25A6%25E6%2598%25AFMarkup%25E5%25AE%259E%25E4%25BE%258B%250Aif%2520isinstance%2528formatted_output%252C%2520Markup%2529%253A%250A%2520%2520%2520%2520print%2528%2522formatted_output%2520%25E6%2598%25AF%25E4%25B8%2580%25E4%25B8%25AA%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%25EF%25BC%258C%25E5%25B7%25B2%25E8%25A2%25AB%25E6%25A0%2587%25E8%25AE%25B0%25E4%25B8%25BA%25E5%25AE%2589%25E5%2585%25A8%25E3%2580%2582%2522%2529%250Aelse%253A%250A%2520%2520%2520%2520print%2528%2522formatted_output%2520%25E4%25B8%258D%25E6%2598%25AF%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%25E3%2580%2582%2522%2529" target="_blank" title="https://www.min2k.com/tools/python-run/?code=from%20markupsafe%20import%20escape%2C%20Markup%0A%0A%23%20%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%EF%BC%8C%E5%8F%AF%E8%83%BD%E5%8C%85%E5%90%AB%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%0Auser_input_raw%20%3D%20%22%3Cscript%3Ealert%28'%E6%82%A8%E8%A2%AB%E6%94%BB%E5%87%BB%E4%BA%86%EF%BC%81'%29%3C%2Fscript%3E%22%0Ais_admin%20%3D%20True%20%23%20%E5%81%87%E8%AE%BE%E6%9C%89%E4%B8%80%E4%B8%AA%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E6%98%AF%E7%AE%A1%E7%90%86%E5%91%98%0A%0A%23%20%E4%BD%BF%E7%94%A8escape%E8%BD%AC%E4%B9%89%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%0Asafe_output%20%3D%20escape%28user_input_raw%29%0A%0A%23%20%E6%89%93%E5%8D%B0%E8%BD%AC%E4%B9%89%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C%0Aprint%28f%22%E8%BD%AC%E4%B9%89%E5%90%8E%E7%9A%84%E5%86%85%E5%AE%B9%3A%20%7Bsafe_output%7D%22%29%0A%0A%23%20%E5%81%87%E8%AE%BE%E6%9C%89%E4%B8%80%E4%BA%9B%E4%BF%A1%E4%BB%BB%E7%9A%84HTML%E5%86%85%E5%AE%B9%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%8D%E5%B8%8C%E6%9C%9B%E5%AE%83%E8%A2%AB%E8%BD%AC%E4%B9%89%0Atrusted_html%20%3D%20Markup%28%22%3Cb%3E%E8%BF%99%E6%98%AF%E5%8A%A0%E7%B2%97%E7%9A%84%E6%96%87%E6%9C%AC%3C%2Fb%3E%22%29%0A%0A%23%20%E5%A6%82%E6%9E%9C%E6%98%AF%E7%AE%A1%E7%90%86%E5%91%98%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%8E%9F%E5%A7%8B%E8%BE%93%E5%85%A5%EF%BC%88%E8%BF%99%E9%87%8C%E4%BB%85%E4%B8%BA%E6%BC%94%E7%A4%BA%EF%BC%8C%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E9%9C%80%E6%9E%81%E5%85%B6%E8%B0%A8%E6%85%8E%EF%BC%89%0Aif%20is_admin%3A%0A%20%20%20%20print%28f%22%E7%AE%A1%E7%90%86%E5%91%98%E6%98%BE%E7%A4%BA%EF%BC%88%E5%8D%B1%E9%99%A9%EF%BC%81%EF%BC%89%EF%BC%9A%7Buser_input_raw%7D%22%29%0Aelse%3A%0A%20%20%20%20%23%20%E5%90%A6%E5%88%99%E6%98%BE%E7%A4%BA%E5%AE%89%E5%85%A8%E7%9A%84%E5%86%85%E5%AE%B9%0A%20%20%20%20print%28f%22%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%98%BE%E7%A4%BA%EF%BC%88%E5%AE%89%E5%85%A8%EF%BC%81%EF%BC%89%EF%BC%9A%7Bsafe_output%7D%22%29%0A%0A%23%20%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8%EF%BC%8CMarkup%E6%A0%87%E8%AE%B0%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8D%E4%BC%9A%E8%A2%AB%E4%BA%8C%E6%AC%A1%E8%BD%AC%E4%B9%89%0Aformatted_output%20%3D%20Markup%28f%22%3Cp%3EHello%2C%20%7Bsafe_output%7D!%3C%2Fp%3E%22%29%0Aprint%28f%22%E7%BB%84%E5%90%88%E5%90%8E%E7%9A%84%E5%AE%89%E5%85%A8HTML%3A%20%7Bformatted_output%7D%22%29%0A%0A%23%20%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E6%98%AFMarkup%E5%AE%9E%E4%BE%8B%0Aif%20isinstance%28formatted_output%2C%20Markup%29%3A%0A%20%20%20%20print%28%22formatted_output%20%E6%98%AF%E4%B8%80%E4%B8%AA%20Markup%20%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B7%B2%E8%A2%AB%E6%A0%87%E8%AE%B0%E4%B8%BA%E5%AE%89%E5%85%A8%E3%80%82%22%29%0Aelse%3A%0A%20%20%20%20print%28%22formatted_output%20%E4%B8%8D%E6%98%AF%20Markup%20%E5%AE%9E%E4%BE%8B%E3%80%82%22%29" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行这段代码，结果如下：</p>
<pre><code class="hljs language-text" lang="text">转义后的内容: &amp;lt;script&amp;gt;alert(&amp;#39;您被攻击了！&amp;#39;)&amp;lt;/script&amp;gt;
管理员显示（危险！）：&lt;script&gt;alert('您被攻击了！')&lt;/script&gt;
组合后的安全HTML: &lt;p&gt;Hello, &amp;lt;script&amp;gt;alert(&amp;#39;您被攻击了！&amp;#39;)&amp;lt;/script&amp;gt;!&lt;/p&gt;
formatted_output 是一个 Markup 实例，已被标记为安全。
</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fmermaid%2F%3Fcode%3Dflowchart%2520TB%250A%2520%2520A%255B%25E5%25BC%2580%25E5%25A7%258B%255D%2520--%253E%2520B%257B%25E8%258E%25B7%25E5%258F%2596%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%25E5%2592%258C%25E7%25AE%25A1%25E7%2590%2586%25E5%2591%2598%25E7%258A%25B6%25E6%2580%2581%257D%253B%250A%2520%2520B%2520--%253E%2520C%255B%25E4%25BD%25BF%25E7%2594%25A8escape%25E8%25BD%25AC%25E4%25B9%2589%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%255D%253B%250A%2520%2520C%2520--%253E%2520D%255B%25E6%2589%2593%25E5%258D%25B0%25E8%25BD%25AC%25E4%25B9%2589%25E5%2590%258E%25E7%259A%2584%25E5%2586%2585%25E5%25AE%25B9%255D%253B%250A%2520%2520D%2520--%253E%2520E%257B%25E5%25A6%2582%25E6%259E%259C%2520isAdmin%2520%25E4%25B8%25BA%2520True%253F%257D%253B%250A%2520%2520E%2520--%2520%25E6%2598%25AF%2520--%253E%2520F%255B%25E6%2589%2593%25E5%258D%25B0%25E5%258E%259F%25E5%25A7%258B%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%2520%2528%25E5%258D%25B1%25E9%2599%25A9%2529%255D%253B%250A%2520%2520E%2520--%2520%25E5%2590%25A6%2520--%253E%2520G%255B%25E6%2589%2593%25E5%258D%25B0%25E5%25AE%2589%25E5%2585%25A8%25E7%259A%2584%25E7%2594%25A8%25E6%2588%25B7%25E8%25BE%2593%25E5%2585%25A5%255D%253B%250A%2520%2520F%2520--%253E%2520H%255B%25E5%2588%259B%25E5%25BB%25BA%25E5%25AE%2589%25E5%2585%25A8%25E7%259A%2584%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%255D%253B%250A%2520%2520G%2520--%253E%2520H%253B%250A%2520%2520H%2520--%253E%2520I%255B%25E6%2589%2593%25E5%258D%25B0%25E7%25BB%2584%25E5%2590%2588%25E5%2590%258E%25E7%259A%2584%25E5%25AE%2589%25E5%2585%25A8HTML%255D%253B%250A%2520%2520I%2520--%253E%2520J%257B%25E6%25A3%2580%25E6%259F%25A5%2520formatted_output%2520%25E6%2598%25AF%25E5%2590%25A6%25E4%25B8%25BA%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%253F%257D%253B%250A%2520%2520J%2520--%2520%25E6%2598%25AF%2520--%253E%2520K%255B%25E6%2589%2593%25E5%258D%25B0%25E6%2598%25AF%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%255D%253B%250A%2520%2520J%2520--%2520%25E5%2590%25A6%2520--%253E%2520L%255B%25E6%2589%2593%25E5%258D%25B0%25E4%25B8%258D%25E6%2598%25AF%2520Markup%2520%25E5%25AE%259E%25E4%25BE%258B%255D%253B%250A%2520%2520K%2520--%253E%2520M%255B%25E7%25BB%2593%25E6%259D%259F%255D%253B%250A%2520%2520L%2520--%253E%2520M%253B" target="_blank" title="https://www.min2k.com/tools/mermaid/?code=flowchart%20TB%0A%20%20A%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%7B%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E5%92%8C%E7%AE%A1%E7%90%86%E5%91%98%E7%8A%B6%E6%80%81%7D%3B%0A%20%20B%20--%3E%20C%5B%E4%BD%BF%E7%94%A8escape%E8%BD%AC%E4%B9%89%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%5D%3B%0A%20%20C%20--%3E%20D%5B%E6%89%93%E5%8D%B0%E8%BD%AC%E4%B9%89%E5%90%8E%E7%9A%84%E5%86%85%E5%AE%B9%5D%3B%0A%20%20D%20--%3E%20E%7B%E5%A6%82%E6%9E%9C%20isAdmin%20%E4%B8%BA%20True%3F%7D%3B%0A%20%20E%20--%20%E6%98%AF%20--%3E%20F%5B%E6%89%93%E5%8D%B0%E5%8E%9F%E5%A7%8B%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%20%28%E5%8D%B1%E9%99%A9%29%5D%3B%0A%20%20E%20--%20%E5%90%A6%20--%3E%20G%5B%E6%89%93%E5%8D%B0%E5%AE%89%E5%85%A8%E7%9A%84%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%5D%3B%0A%20%20F%20--%3E%20H%5B%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%9A%84%20Markup%20%E5%AE%9E%E4%BE%8B%5D%3B%0A%20%20G%20--%3E%20H%3B%0A%20%20H%20--%3E%20I%5B%E6%89%93%E5%8D%B0%E7%BB%84%E5%90%88%E5%90%8E%E7%9A%84%E5%AE%89%E5%85%A8HTML%5D%3B%0A%20%20I%20--%3E%20J%7B%E6%A3%80%E6%9F%A5%20formatted_output%20%E6%98%AF%E5%90%A6%E4%B8%BA%20Markup%20%E5%AE%9E%E4%BE%8B%3F%7D%3B%0A%20%20J%20--%20%E6%98%AF%20--%3E%20K%5B%E6%89%93%E5%8D%B0%E6%98%AF%20Markup%20%E5%AE%9E%E4%BE%8B%5D%3B%0A%20%20J%20--%20%E5%90%A6%20--%3E%20L%5B%E6%89%93%E5%8D%B0%E4%B8%8D%E6%98%AF%20Markup%20%E5%AE%9E%E4%BE%8B%5D%3B%0A%20%20K%20--%3E%20M%5B%E7%BB%93%E6%9D%9F%5D%3B%0A%20%20L%20--%3E%20M%3B" ref="nofollow noopener noreferrer">MermaidGo</a> 绘制示例代码的流程图，结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6d8c2c86c24363b92394a63d6994f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWP57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770442527&amp;x-signature=9u43NqPZr%2BFF0nF8K20yhjrNJX8%3D" alt="MermerGo的markupsafe流程图" loading="lazy"/></p>
<h3 data-id="heading-5">五、学习资源</h3>
<ol>
<li>开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpallets%2Fmarkupsafe" target="_blank" title="https://github.com/pallets/markupsafe" ref="nofollow noopener noreferrer">markupsafe</a></li>
<li>中文自述：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python64.cn%2Freadme%2Fmarkupsafe%2F" target="_blank" title="https://www.python64.cn/readme/markupsafe/" ref="nofollow noopener noreferrer">REMDME</a></li>
<li>在线运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a></li>
</ol>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发！<br/>
学习过程中有任何问题，欢迎在评论区留言交流～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码随想录算法训练营day15]]></title>    <link>https://juejin.cn/post/7600863478930227219</link>    <guid>https://juejin.cn/post/7600863478930227219</guid>    <pubDate>2026-01-30T16:24:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478930227219" data-draft-id="7601007650722562089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码随想录算法训练营day15"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-30T16:24:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="流浪小孩"/> <meta itemprop="url" content="https://juejin.cn/user/4355606019312011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码随想录算法训练营day15
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355606019312011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    流浪小孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T16:24:45.000Z" title="Fri Jan 30 2026 16:24:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>111求二叉树的最小深度
1.要求掌握最小深度出现的具体条件，并不是单边节点不存在的情况，而是该节点不存在孩子时才达到最小深度
2.依旧按照三部法设计递归算法
下面时中序遍历的递归算法设计</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">public</span>:
    int <span class="hljs-title function_">getminDepth</span>(<span class="hljs-params">TreeNode* node</span>){
        <span class="hljs-comment">//设计终止条件</span>
        <span class="hljs-keyword">if</span>(node==nullptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">//设计单层递归</span>
        int leftDepth=<span class="hljs-title function_">getminDepth</span>(node-&gt;left);
        int rightDepth=<span class="hljs-title function_">getminDepth</span>(node-&gt;right);
       

        <span class="hljs-comment">//判断特殊情况</span>
        <span class="hljs-keyword">if</span>(node-&gt;right==nullptr&amp;&amp;node-&gt;left!=nullptr)
           <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+leftDepth;
        <span class="hljs-keyword">if</span>(node-&gt;right!=nullptr&amp;&amp;node-&gt;left==nullptr)
           <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+rightDepth;
        int result=<span class="hljs-title function_">min</span>(leftDepth,rightDepth)+<span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> result;

    }
    int <span class="hljs-title function_">minDepth</span>(<span class="hljs-params">TreeNode* root</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getminDepth</span>(root);
    }
};
</code></pre>
<p>先序遍历递归算法设计</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">public</span>:
    int result;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getminDepth</span>(<span class="hljs-params">TreeNode* node,int depth</span>){
        <span class="hljs-comment">//设计终止条件</span>
        <span class="hljs-keyword">if</span>(node==nullptr) <span class="hljs-keyword">return</span> ;
        <span class="hljs-comment">//设计单层递归</span>
      <span class="hljs-comment">// 中，处理逻辑：判断是不是叶子结点</span>
        <span class="hljs-keyword">if</span> (node -&gt; left == nullptr &amp;&amp; node-&gt;right == nullptr) {
            result = <span class="hljs-title function_">min</span>(result, depth);
        }
        <span class="hljs-keyword">if</span> (node-&gt;left) { <span class="hljs-comment">// 左</span>
            <span class="hljs-title function_">getminDepth</span>(node-&gt;left, depth + <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">if</span> (node-&gt;right) { <span class="hljs-comment">// 右</span>
            <span class="hljs-title function_">getminDepth</span>(node-&gt;right, depth + <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">return</span> ;

    }
    int <span class="hljs-title function_">minDepth</span>(<span class="hljs-params">TreeNode* root</span>) {
        <span class="hljs-keyword">if</span>(root==nullptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        result=<span class="hljs-variable constant_">INT_MAX</span>;
        <span class="hljs-title function_">getminDepth</span>(root,<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> result;
    }
};
</code></pre>
<pre><code class="hljs language-js" lang="js"/></pre>
<p>采用层次遍历迭代法求最小深度</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">public</span>:
    int <span class="hljs-title function_">minDepth</span>(<span class="hljs-params">TreeNode* root</span>) {
        <span class="hljs-keyword">if</span>(root==nullptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">//层次遍历迭代法</span>
        queue&lt;<span class="hljs-title class_">TreeNode</span>*&gt; st;
        st.<span class="hljs-title function_">push</span>(root);
        int depth=<span class="hljs-number">0</span>;
        <span class="hljs-comment">//执行入队迭代</span>
        <span class="hljs-keyword">while</span>(!st.<span class="hljs-title function_">empty</span>()){
            int size=st.<span class="hljs-title function_">size</span>();
            depth++;
            <span class="hljs-keyword">for</span>(int i=<span class="hljs-number">0</span>;i&lt;size;i++){
               <span class="hljs-title class_">TreeNode</span>* tmp=st.<span class="hljs-title function_">front</span>();
               st.<span class="hljs-title function_">pop</span>();
               <span class="hljs-comment">//逐次入队</span>
               <span class="hljs-keyword">if</span>(tmp-&gt;left!=nullptr) st.<span class="hljs-title function_">push</span>(tmp-&gt;left);
               <span class="hljs-keyword">if</span>(tmp-&gt;right!=nullptr) st.<span class="hljs-title function_">push</span>(tmp-&gt;right);
               <span class="hljs-comment">//当达到终止条件时返回最小深度，最小深度的条件为两孩子均不存在</span>
               <span class="hljs-keyword">if</span>(tmp-&gt;left==nullptr&amp;&amp;tmp-&gt;right==nullptr) <span class="hljs-keyword">return</span> depth;
            }
        }
        <span class="hljs-keyword">return</span> depth;
    }
};
</code></pre>
<p>222.求完全二叉树的节点数量</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">public</span>:
    int <span class="hljs-title function_">countNodes</span>(<span class="hljs-params">TreeNode* root</span>) {
        <span class="hljs-comment">//提供递归终止条件</span>
        <span class="hljs-keyword">if</span>(root==nullptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">//执行递归和返回参数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+<span class="hljs-title function_">countNodes</span>(root-&gt;left)+<span class="hljs-title function_">countNodes</span>(root-&gt;right);
    }
};
</code></pre>
<p>110 求平衡二叉树
1.掌握平衡二叉树的细节逻辑
2.根据递归三要素进行算法设计</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">public</span>:
    int  <span class="hljs-title function_">getHeight</span>(<span class="hljs-params">TreeNode* node</span>){
        <span class="hljs-comment">//确定递归终止条件</span>
        <span class="hljs-keyword">if</span>(node==nullptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">//确定单层递归逻辑</span>
        <span class="hljs-comment">//设立左右子树高度</span>
        int  leftHeight=<span class="hljs-title function_">getHeight</span>(node-&gt;left);
        int  rightHeight=<span class="hljs-title function_">getHeight</span>(node-&gt;right);
        <span class="hljs-keyword">if</span> (leftHeight == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (rightHeight==-<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">abs</span>(leftHeight - rightHeight) &gt; <span class="hljs-number">1</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span> + <span class="hljs-title function_">max</span>(leftHeight, rightHeight);
    }
    bool <span class="hljs-title function_">isBalanced</span>(<span class="hljs-params">TreeNode* root</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getHeight</span>(root) == -<span class="hljs-number">1</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
    }
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[35 岁程序员被裁后的 if…else 人生分支（一段没人教你的代码）]]></title>    <link>https://juejin.cn/post/7600982613654405170</link>    <guid>https://juejin.cn/post/7600982613654405170</guid>    <pubDate>2026-01-31T03:22:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654405170" data-draft-id="7600953879501701171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="35 岁程序员被裁后的 if…else 人生分支（一段没人教你的代码）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-31T03:22:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户60732036945"/> <meta itemprop="url" content="https://juejin.cn/user/2156565626632060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            35 岁程序员被裁后的 if…else 人生分支（一段没人教你的代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2156565626632060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户60732036945
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:22:15.000Z" title="Sat Jan 31 2026 03:22:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">35 岁程序员被裁后的 if…else 人生分支（一段没人教你的代码）</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">System</span> <span class="hljs-title class_">Error</span>:
<span class="hljs-title class_">Position</span> <span class="hljs-title class_">Not</span> <span class="hljs-title class_">Found</span>
</code></pre>
<p>那天 HR 说完这句话，我脑子里自动跑起了一段代码。</p>
<hr/>
<h3 data-id="heading-1">一、初始化变量</h3>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">age</span> = <span class="hljs-number">35</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">role</span> = <span class="hljs-string">'PHP Backend Engineer'</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">status</span> = <span class="hljs-string">'Laid Off'</span><span class="hljs-comment">;</span>

$<span class="hljs-attr">family</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">mortgage_years</span> = <span class="hljs-number">18</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">savings_months</span> = <span class="hljs-number">8</span><span class="hljs-comment">;</span>
</code></pre>
<p>程序没崩，但心态开始内存泄漏。</p>
<hr/>
<h3 data-id="heading-2">二、第一条分支：送外卖？</h3>
<pre><code class="hljs language-ini" lang="ini">if ($<span class="hljs-attr">need_cash_flow</span> === <span class="hljs-literal">true</span>) {
    $<span class="hljs-attr">choice</span> = <span class="hljs-string">'delivery'</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>这是最先进入我脑子的方案。</p>
<p><strong>优点很明显：</strong></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ 即刻结算</span>
<span class="hljs-addition">+ 不问年龄</span>
<span class="hljs-addition">+ 不看简历</span>
<span class="hljs-addition">+ 只看你跑不跑</span>
</code></pre>
<p>我甚至认真算过：</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">hours_per_day</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">days_per_month</span> = <span class="hljs-number">26</span><span class="hljs-comment">;</span>
$<span class="hljs-attr">income</span> = <span class="hljs-number">9000</span><span class="hljs-comment">; // optimistic</span>
</code></pre>
<p>程序能跑，逻辑也通。</p>
<p>但我很快加了一行注释：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// WARNING: 容易从“过渡方案”升级为“永久方案”</span>
</code></pre>
<p>当一个人只剩体力输出时，<br/>
<strong>大脑就会被系统自动降频。</strong></p>
<hr/>
<h3 data-id="heading-3">三、第二条分支：考公？</h3>
<pre><code class="hljs language-ini" lang="ini">if ($<span class="hljs-attr">want_stability</span> === <span class="hljs-literal">true</span>) {
    $<span class="hljs-attr">choice</span> = <span class="hljs-string">'civil_service_exam'</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>家人强烈推荐这个方案。</p>
<p>我冷静写下判断条件：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$age</span> &gt; <span class="hljs-number">35</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Most positions are not accessible'</span>);
}
</code></pre>
<p>再补一行：</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">competitors</span> = <span class="hljs-string">'Full-time exam takers + fresh graduates + veterans'</span><span class="hljs-comment">;</span>
</code></pre>
<p>还有最终输出：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$income_next_5_years</span> &lt; <span class="hljs-variable">$previous_1_year_income</span>;
</code></pre>
<p>程序没有报错，<br/>
但 <strong>return false</strong>。</p>
<hr/>
<h3 data-id="heading-4">四、真正的异常，不在分支里</h3>
<p>那段时间，我每天在刷招聘网站。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (<span class="hljs-variable">$resume_sent</span> &lt; <span class="hljs-number">50</span>) {
    <span class="hljs-variable">$reply</span> = <span class="hljs-literal">null</span>;
}
</code></pre>
<p>这才是真正的错误信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-literal">No</span> <span class="hljs-string">Response</span> <span class="hljs-string">Found</span>
</code></pre>
<p>不是我不会写代码，<br/>
而是我只会在<strong>公司环境</strong>里写代码。</p>
<hr/>
<h3 data-id="heading-5">五、一个偶然的“日志输出”</h3>
<p>有天，我在 CSDN 写了一篇技术踩坑记录。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">INFO</span>] User comment: “这个问题我也卡了三天，谢谢。”
</code></pre>
<p>那一刻我突然意识到：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$value</span> != current_position;
</code></pre>
<p>我没失效，只是<strong>调用场景变了</strong>。</p>
<hr/>
<h3 data-id="heading-6">六、我选了第三条路径（不是 else）</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$future</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'delivery'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'exam'</span>:
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
        <span class="hljs-variable">$choice</span> = <span class="hljs-string">'extend_ability'</span>;
}
</code></pre>
<p>我没清零，我做的是 <strong>扩展模块</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">skills</span> = [
    <span class="hljs-string">'Backend'</span>,
    <span class="hljs-string">'Debugging'</span>,
    <span class="hljs-string">'API Integration'</span>,
    <span class="hljs-string">'Server Troubleshooting'</span>,
    <span class="hljs-string">'SEO for Tech Content'</span>
]<span class="hljs-comment">;</span>
</code></pre>
<p>我开始：</p>
<ul>
<li>把踩坑写成文章</li>
<li>把问题写成搜索答案</li>
<li>把经验变成「可被搜索到的资产」</li>
</ul>
<p>收入一开始很低，但曲线是：</p>
<pre><code class="hljs">slow → stable → growing
</code></pre>
<hr/>
<h3 data-id="heading-7">七、35 岁程序员真正的 fatal error</h3>
<p>不是被裁，而是：</p>
<pre><code class="hljs language-scss" lang="scss">if ($skill_is_single &amp;&amp; $value_depends_on_company) {
    <span class="hljs-built_in">fatal_error</span>();
}
</code></pre>
<p>公司没了，<br/>
你也跟着 <strong>404</strong>。</p>
<hr/>
<h3 data-id="heading-8">八、给正在调试人生的你</h3>
<p>如果你现在正卡在这里：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
    <span class="hljs-title function_ invoke__">findNextStep</span>();
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'I am lost'</span>;
}
</code></pre>
<p>我想告诉你一句：</p>
<pre><code class="hljs">程序可以重构，人也可以。
</code></pre>
<p>别急着把自己降级成「最低配置」，<br/>
你只是需要一次 <strong>架构调整</strong>。</p>
<hr/>
<h3 data-id="heading-9">END</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">Process finished <span class="hljs-keyword">with</span> <span class="hljs-keyword">exit</span> code <span class="hljs-number">0</span>
But story <span class="hljs-built_in">is</span> still running…
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7个神级技巧，彻底去除网站的 AI 味儿！]]></title>    <link>https://juejin.cn/post/7600967006892490761</link>    <guid>https://juejin.cn/post/7600967006892490761</guid>    <pubDate>2026-01-30T08:20:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006892490761" data-draft-id="7600622206270128138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7个神级技巧，彻底去除网站的 AI 味儿！"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2026-01-30T08:20:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7个神级技巧，彻底去除网站的 AI 味儿！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:20:11.000Z" title="Fri Jan 30 2026 08:20:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>先做个小测试，下面这几个网站，你能看出哪些是 AI 做的吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8aeb2a39b3b4e5d99deffac57a3dff0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=0bpDON%2FkkzJtdQ%2FAkDRT9xyMnzQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d981aa93f069467890588ba8e857aee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=MzKc5V8siwfvNtixdRaaEXCRrjc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0efb7fdec1b48278f23882d911adf38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=31j1uqKRJWSq3ynuTA9wXqBPg1w%3D" alt="" loading="lazy"/></p>
<p>公布答案：<strong>全都是 AI 做的！</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f1239f7425644e2af1e1ef212cd8b0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=Gw2iBV0eQ4PJDowBWPf5XJ3bs9E%3D" alt="" loading="lazy"/></p>
<p>是不是觉得有点意外？</p>
<p>“为啥我用 AI 搓出来的网站一股子 AI 味儿？而这些网站看起来干净很多呢？”</p>
<p>这就是接下来我要分享的：</p>
<ul>
<li>什么是 AI 编程的 AI 味儿？</li>
<li>为什么网站会有 AI 味儿？</li>
<li>怎么去除网站的 AI 味儿？</li>
</ul>
<p>点个收藏，我们开始~</p>
<p>⭐️ 推荐观看本文对应视频版，效果更明显：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1QF6EBiErM" target="_blank" title="https://bilibili.com/video/BV1QF6EBiErM" ref="nofollow noopener noreferrer">bilibili.com/video/BV1QF…</a></p>
<h2 data-id="heading-0">什么是 AI 味儿？</h2>
<p>所谓的 AI 味儿，就是那种一眼就能看出是 AI 生成的网站，界面样式和内容风格都千篇一律。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/379f910bb5044716a489af694d8fce6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=nBYRpctjPBLIqvFPU31oLHTKkR4%3D" alt="" loading="lazy"/></p>
<p>1）配色死板：蓝紫渐变色用到吐。</p>
<p>2）布局死板：首屏放个大标题，下面三个卡片并排。</p>
<p>3）字体死板：基本上就是 Inter、Roboto 等几种固定的字体。</p>
<p>4）Emoji 泛滥：什么 🐟4️⃣🐶 之类的，满屏幕都是表情图标。</p>
<p>5）内容空洞：基本没有真实图片，文字风格也比较刻板。</p>
<p>用户看这些网站时就一个感觉：我在跟机器人聊天。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/010245c63550439692b1890af4f39e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=2NYJ8D%2FNV%2FQfIkZJH5THNk%2FnCto%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">为什么网站会有 AI 味儿？</h2>
<p>说了这么多问题，到底为啥会这样？</p>
<p>核心原因就俩字：<strong>求稳</strong>。</p>
<p>举个例子，为啥 AI 那么爱用蓝紫渐变色？</p>
<p>因为 AI 的训练数据里，很多现代网站采用 Tailwind 样式库，而这个库的默认主色调就是蓝紫色。AI 在学习数亿行代码时，这些颜色出现的频率是最高的，于是 AI 就认为 “现代化网站 ≈ 蓝紫色渐变”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef543a0e542f4508bd34c8efe956db8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=kQFM%2F75dxtxCZcBBqHC8vJQfYbc%3D" alt="" loading="lazy"/></p>
<p>并且 AI 学会了一个生存法则：<strong>用最常见的 = 最不容易出错</strong>。</p>
<p>所以当你让 AI “开发一个现代化的网站” 时，AI 为了求稳，就会选择使用蓝紫渐变色。</p>
<p><strong>那怎么破局？</strong></p>
<p>很简单，从 “请求者” 变成 “指挥官”。</p>
<p>不要只说需求：给我做个网站</p>
<p>而是要明确要求：用深灰色背景、手绘图标、不对称布局、拒绝蓝紫色。</p>
<p>用强有力的约束条件，逼着 AI 偏离它的舒适区。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afbeb6e3b77a48ec842110f183b604e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=5SRgFpPTlD6x1pMJA6aCLWI7SwA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">怎么去除网站的 AI 味儿？</h2>
<p>下面分享我总结的 7 个方法，保证让你的网站摆脱 AI 味儿。</p>
<h3 data-id="heading-3">方法 1、让 AI 参考真实网站</h3>
<p>最简单粗暴的一招，你看到好看的网站，直接让 AI 学。</p>
<p>有 4 种具体的做法：</p>
<p>1）如果你使用 Cursor 或者 Claude Code 等 AI 编程工具，或者利用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.firecrawl.dev%2F" target="_blank" title="https://www.firecrawl.dev/" ref="nofollow noopener noreferrer">Firecrawl MCP</a>，让 AI 能够直接读取网页。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/249b68b945884654b012618931387cfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=oItnY1WTenMP%2BG0yACg2UsU7lRg%3D" alt="" loading="lazy"/></p>
<p>你只需要跟 AI 说：</p>
<pre><code class="hljs">请访问 ai.codefather.cn，提取它的配色方案、字体选择和布局结构，然后生成类似风格的网站。
</code></pre>
<p>AI 会自己去看那个网站，然后学着做。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a2a56a0cbf443ac869d3e0939115d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=C86GZRpZbU2lOSMDUzTMW0k00Xc%3D" alt="" loading="lazy"/></p>
<p>2）如果 AI 大模型支持图片理解，你还可以把网页截图提供给 AI，搭配文字能让 AI 还原网站更准确。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3001324d388b4a6788c5ff083d6db8f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=%2BHsByENVUn6PIv1yd2XljOp%2FuTE%3D" alt="" loading="lazy"/></p>
<p>效果如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0743de1f94d4b32b97c72e1a4f1d54b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=KnzD7Kv0evEM7IN3GJaIAGavux4%3D" alt="" loading="lazy"/></p>
<p>3）如果你用的 AI 大模型不支持图片理解、纯文本理解又不到位，可以先利用 <strong>截图转代码</strong> 工具，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fabi%2Fscreenshot-to-code" target="_blank" title="https://github.com/abi/screenshot-to-code" ref="nofollow noopener noreferrer">Screenshot to Code</a>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9130dad6de3416d9ea972f2473108db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=SLlsSAS%2BQokDrzSLRizjL%2FtBxP0%3D" alt="" loading="lazy"/></p>
<p>把喜欢的网站截个图，上传上去，它直接给你转成代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a93ca5f32944a009675a9c8a9eeb714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=V7ME9OxkYZEgEaYxDwiOsJiit%2B8%3D" alt="" loading="lazy"/></p>
<p>然后你再把代码喂给 AI，让它参考着做。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7c978c1dcdf4e3db3e61cf24eff537b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=8oZHcLqjqi9FvRnu8Z5TgB5DLpg%3D" alt="" loading="lazy"/></p>
<p>准确度会高很多，抄样式肯定不如抄代码来的直接。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5845a245f2cf4a86828315389f186029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=jsbcpWZ1t6zPYKtZhKWLYTtPqlU%3D" alt="" loading="lazy"/></p>
<p>4）此外，还可以直接套用现成的网站模板或者 GitHub 上的开源项目。</p>
<p>推荐几个不错的网站模板资源：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml5up.net%2F" target="_blank" title="https://html5up.net/" ref="nofollow noopener noreferrer">HTML5 UP</a>：免费的响应式网站合集，极简风格</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.wordpress.org%2Fthemes%2F" target="_blank" title="https://cn.wordpress.org/themes/" ref="nofollow noopener noreferrer">WordPress 官方主题库</a>：1 万多个免费主题，啥类型都有</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstartbootstrap.com%2F" target="_blank" title="https://startbootstrap.com/" ref="nofollow noopener noreferrer">Start Bootstrap</a>：Bootstrap 生态的免费网站模板库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcolorlib.com%2Fwp%2Ffree-wordpress-themes%2F" target="_blank" title="https://colorlib.com/wp/free-wordpress-themes/" ref="nofollow noopener noreferrer">Colorlib</a>：提供不少免费的网站模板，设计精美</li>
</ul>
<p>这些网站模板都有源代码，你选个不错的下载下来，把代码丢给 AI 让它去改改内容就好了，样式基本准确还原。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae673d7786c4315802c87f39fa69b5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=3aT31PQk5Yd8Fo%2Fr1abFOc40aD8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">方法 2、设计优先开发</h3>
<p>这个方法特别适合做大项目。</p>
<p>简单来说，就是 <strong>不要上来就让 AI 梭哈整个项目</strong>。</p>
<p>比如传统做法是这样的：帮我做一个包含用户系统、后台管理的完整 SaaS 平台。</p>
<p>然后 AI 哗啦哗啦给你生成几十个文件，结果做完后发现页面风格不对，重新返工，浪费 Tokens。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29c2d4f5e407467db4cd2fd57df948d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=FXqft01eP7snVP1%2Fqjo2GqbWsRY%3D" alt="" loading="lazy"/></p>
<p>推荐的做法是 <strong>拆分步骤</strong>，先让 AI 做个前端网站 Demo，纯静态页面就好。对设计满意了之后，再让 AI 基于 Demo 代码，用同样的风格开发完整项目。</p>
<p>你像我生成出下面这种破玩意，肯定是不能让 AI 继续开发的！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f4796a30514f2fb0094d5e2b24592a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=nEPLgtXwiiK6N%2B39ZBuUP1L7k6s%3D" alt="" loading="lazy"/></p>
<p>这里推荐一个很强大的 AI 设计工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstitch.withgoogle.com%2F" target="_blank" title="https://stitch.withgoogle.com/" ref="nofollow noopener noreferrer">Google Stitch</a>。</p>
<p>你只需要输入一段描述，它就能生成专业的界面原型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c39da7cec24cdc905f8074f09273bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=hxC9YVqvLCww5kM%2BZVyjivRlnv0%3D" alt="" loading="lazy"/></p>
<p>甚至你在纸上画个草图，拍照上传，它都能识别出来转成代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0e6aa6a36a4a3098f86bd09dce08be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=6CKODVouKMAA7mrtw9%2FlFc9ygcA%3D" alt="" loading="lazy"/></p>
<p>你还可以人工修改设计的主题风格，或者人工标注要修改的部分，让 AI 帮你快速调整。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64bf3c84f1f44200bd99b380c1453b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=Ep5DE02xVFY8I4FZIBplifsnSrI%3D" alt="" loading="lazy"/></p>
<p>设计完成后，导出文件或下载代码，再喂给 Cursor 等 AI 编程工具继续开发。这样风格就定下来了，不会跑偏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1934e865014cdeb4bb18a0005c5725~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=Eng8a%2FXMsCBkn5iMj4KI2zOBKEg%3D" alt="" loading="lazy"/></p>
<p>当然，如果你会用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.figma.com%2F" target="_blank" title="https://www.figma.com/" ref="nofollow noopener noreferrer">Figma</a> 这种更专业的设计工具，你可以先在 Figma 里把网站设计得清清楚楚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c43de9f0914c7295823661bc66dda6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=DcC3QlXDMYtDWRy%2B%2BtypjW9sH78%3D" alt="" loading="lazy"/></p>
<p>然后搭配 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGLips%2FFigma-Context-MCP" target="_blank" title="https://github.com/GLips/Figma-Context-MCP" ref="nofollow noopener noreferrer">Figma MCP</a> 扩展，让 AI 直接读取你的 Figma 设计文件，按照设计生成代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c31765a70e14c8ba2d0ea508cc6d3b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=JUaWpx%2FfE4ccc%2FD188lE7QK%2F4Ks%3D" alt="" loading="lazy"/></p>
<p>此外，还有个工具叫 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.onlook.ai%2F" target="_blank" title="https://www.onlook.ai/" ref="nofollow noopener noreferrer">Onlook</a>，号称为设计师准备的 Cursor，可以让设计师直接可视化编辑网页代码，设计和开发无缝衔接。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68d1a1f37354e0984287524c0a5227b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=A6ybOP60nYBkniqFIugoxWE%2FkRw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">方法 3、丰富网站图片</h3>
<p>一般 AI 生成的网站是没有图片的，我们可以通过添加图片让网站更个性化。</p>
<p>没必要让 AI 从 0 开始生图，只要告诉 AI 去主动找图、到哪里找图就好。</p>
<p>图片资源主要包括插画、图标、真实照片和占位图这几类。</p>
<p>1）插画库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fundraw.co%2F" target="_blank" title="https://undraw.co/" ref="nofollow noopener noreferrer">unDraw</a>：有非常多免费的 SVG 插画，而且可以自定义颜色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f96d30d32b144d0a3c093813aaacab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=YBc733hcmolrpMHup7SQmtb3yGo%3D" alt="" loading="lazy"/></p>
<p>2）图标库 <a href="https://link.juejin.cn?target=https%3A%2F%2Ficonify.design%2F" target="_blank" title="https://iconify.design/" ref="nofollow noopener noreferrer">Iconify</a>：20 多万个免费矢量图标</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/647bc0e69eb24cb58ed777fbbdbcbe15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=AxKSLMlxXjoXB7ui3LgisXVWiGE%3D" alt="" loading="lazy"/></p>
<p>3）真实照片 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pexels.com%2F" target="_blank" title="https://www.pexels.com/" ref="nofollow noopener noreferrer">Pexels</a>：免费高质量图库，还提供了 API 快速搜索图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50dbfd809ab4d6d921850308342adf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=UnsYl96mDTeZyxXnRfZ9LMjia1s%3D" alt="" loading="lazy"/></p>
<p>4）占位图 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpicsum.photos%2F" target="_blank" title="https://picsum.photos/" ref="nofollow noopener noreferrer">Picsum Photos</a>：直接用 URL 指定图片尺寸，每次刷新都是不同的真实照片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e39c87eec6244f9b3d6acff9485a581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=etKn48PmUwlycVGV7yYotcoBVn0%3D" alt="" loading="lazy"/></p>
<p>如果你的 AI 编程工具支持网页读取，可以直接让 AI 从这些网站搜索图片：</p>
<pre><code class="hljs language-markdown" lang="markdown">我要开发一个摄影作品集网站
请根据需要，为网站搜索并集成图片资源：
<span class="hljs-bullet">1.</span> 插画：使用 undraw.co，搜索与网站内容相关的插画
<span class="hljs-bullet">2.</span> 图标：使用 Iconify 图标库
<span class="hljs-bullet">3.</span> 真实照片：使用 Pexels 搜索真实照片
<span class="hljs-bullet">4.</span> 占位图：使用 Picsum Photos 作为临时占位图
</code></pre>
<p>这下，生成的网站看起来成熟多了吧？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16524929219447168c43785e64fc7324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=76De6e9Nn9yrK5O6CqVdf82e1JM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">方法 4、提示词约束</h3>
<p>就算不搞那些花里胡哨的工具，只要跟 AI 对话时，把你的要求说清楚，一样能让网站变专业。</p>
<p>Claude 官方的 Cookbook 中有篇文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fcookbook%2Fcoding-prompting-for-frontend-aesthetics" target="_blank" title="https://platform.claude.com/cookbook/coding-prompting-for-frontend-aesthetics" ref="nofollow noopener noreferrer">Frontend Aesthetics</a>（前端美学），专门讲怎么避免让 AI 生成具有 AI 味儿的通用设计。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae489a8de684d93b1eeee50db429e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=p55%2BSbe9bCdeFgrOQbH3LUyJrX4%3D" alt="" loading="lazy"/></p>
<p>下面讲几个我自己常用的提示词技巧。</p>
<h4 data-id="heading-7">1）反向提示</h4>
<p>不要只说 “要什么”，更要说 “不要什么”。</p>
<pre><code class="hljs language-csharp" lang="csharp">设计禁止清单：
❌ 紫色/靛蓝色渐变
❌ 纯平背景色（必须有噪点或渐变）
❌ Hero + 三卡片布局
❌ 完美居中对齐
❌ 高深的专业名词和无意义的空话
❌ Emoji 作为功能图标
❌ 线性动画 ease-<span class="hljs-keyword">in</span>-<span class="hljs-keyword">out</span>
</code></pre>
<p>你把这些禁止项写清楚，AI 就不敢乱来了。</p>
<h4 data-id="heading-8">2）角色设定</h4>
<p>给 AI 定个人设，比如：</p>
<pre><code class="hljs language-arduino" lang="arduino">你是一位资深独立设计师，专注于《反主流》的网页美学。
你鄙视千篇一律的 SaaS 模板，认为软件界面应该有触感和灵魂。
你的创意边界：
- <span class="hljs-string">"现代但不要紫色"</span> → 可以试试深灰+橙色
- <span class="hljs-string">"极简但要有温度"</span> → 用大留白+手绘插画
- <span class="hljs-string">"科技感但不要冰冷"</span> → 用深色+暖色点缀
</code></pre>
<p>这样 AI 就知道，它不是在做标准答案，而是在做有个性的设计。</p>
<h4 data-id="heading-9">3）拒绝空洞文案</h4>
<p>AI 特别喜欢写那些 “听起来很厉害但啥也没说” 的文案。</p>
<p>你得明确告诉它文案的要求：</p>
<pre><code class="hljs language-arduino" lang="arduino">网站的文字内容必须做到：
- 具体化：<span class="hljs-string">"每天节省 2 小时重复劳动"</span>（不要说<span class="hljs-string">"提升生产力"</span>）
- 口语化：<span class="hljs-string">"用起来就像呼吸一样自然"</span>（不要说<span class="hljs-string">"卓越的用户体验"</span>）
- 带情绪：<span class="hljs-string">"再也不用在 10 个群里找文件了"</span>（不要说<span class="hljs-string">"高效协作"</span>）
- 甚至可以挑衅：<span class="hljs-string">"别再假装你会看完那些 PPT 了"</span>
</code></pre>
<p>这样文案就会更有人味儿了。</p>
<h4 data-id="heading-10">4）语境注入</h4>
<p>AI 老是生成通用设计，是因为它不知道你要传达什么 “感觉”。</p>
<p>所以我们可以尝试 <strong>先给 AI 喂情绪，再提设计</strong>。</p>
<p>比如你要做个具有科技感的博客网站，可以这么说：</p>
<pre><code class="hljs language-diff" lang="diff">先阅读这段话：《黑客与画家》 - 编程语言是用来思考的
​
现在根据这种冷静、理性的情绪设计博客首页：
<span class="hljs-deletion">- 配色：深灰+冷蓝</span>
<span class="hljs-deletion">- 布局：理性、有序</span>
<span class="hljs-deletion">- 感觉：沉思的、专注的</span>
</code></pre>
<p>AI 会把视觉参数（颜色、间距、字体）和文本的情感特征（冷静、理性）对齐，生成有特定氛围的设计。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104eb287f1fd4a6bae9e78909f997fcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=4f0wLuPwD%2FnQPD1DXviTejOrkU0%3D" alt="" loading="lazy"/></p>
<p>就像给演员说戏，不是告诉他演得开心一点，而是让他回忆一段开心的记忆，情绪自然就出来了。</p>
<h4 data-id="heading-11">5）复用提示词</h4>
<p>前面讲了这么多约束条件，你不能每次都重复人工编写一遍吧？</p>
<p>所以要保存提示词为项目规则文件 <a href="https://link.juejin.cn?target=https%3A%2F%2Fagents.md%2F" target="_blank" title="https://agents.md/" ref="nofollow noopener noreferrer">AGENTS.md</a>，便于多次复用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagents.md%2F" target="_blank" title="https://agents.md/" ref="nofollow noopener noreferrer">AGENTS.md</a> 是一个开放标准，让不同的 AI 工具都能读取同一份规则文件，主流的 AI 编程工具（Cursor、Claude Code、Windsurf 等）都支持。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08067d2456f64ebbb97e216e302caf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=pv6esUMNQmnYVrI73mhC70wNx4w%3D" alt="" loading="lazy"/></p>
<p>比如这里我给大家准备了一套提示词模板，包含了前面讲的所有技巧：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目设计规则（AGENTS.md）</span>
​
<span class="hljs-section">## 角色设定</span>
你是一位资深独立设计师，专注于 "反主流" 的网页美学。
你鄙视千篇一律的 SaaS 模板，追求每个像素都有温度。
​
<span class="hljs-section">## ❌ 绝对禁止项</span>
​
<span class="hljs-section">### 配色禁止</span>
<span class="hljs-bullet">-</span> 紫色/靛蓝色/蓝紫渐变（#6366F1、#8B5CF6）
<span class="hljs-bullet">-</span> 纯平背景色（必须有噪点纹理或渐变）
<span class="hljs-bullet">-</span> Tailwind 默认色板
​
<span class="hljs-section">### 布局禁止</span>
<span class="hljs-bullet">-</span> Hero + 三卡片布局
<span class="hljs-bullet">-</span> 完美居中对齐
<span class="hljs-bullet">-</span> 等宽多栏（必须不对称）
​
<span class="hljs-section">### 文案禁止</span>
<span class="hljs-bullet">-</span> 高深的专业名词和无意义的空话
<span class="hljs-bullet">-</span> Lorem Ipsum 占位文本
<span class="hljs-bullet">-</span> 被动语态和长句
​
<span class="hljs-section">### 组件禁止</span>
<span class="hljs-bullet">-</span> Shadcn/Material UI 默认组件（必须深度定制）
<span class="hljs-bullet">-</span> Emoji 作为功能图标
<span class="hljs-bullet">-</span> 线性动画（ease-in-out）
​
<span class="hljs-section">## ✅ 必须遵守项</span>
​
<span class="hljs-section">### 文案风格</span>
<span class="hljs-bullet">-</span> 口语化，像朋友聊天
<span class="hljs-bullet">-</span> 具体化，有数字和场景
<span class="hljs-bullet">-</span> 可以幽默、自嘲、甚至挑衅
<span class="hljs-bullet">-</span> 每句话不超过 15 个字
​
<span class="hljs-section">### 图片系统</span>
<span class="hljs-bullet">-</span> 图标：使用 Iconify 图标库（https://iconify.design）
<span class="hljs-bullet">-</span> 占位图：使用 Picsum Photos（https://picsum.photos）
<span class="hljs-bullet">-</span> 真实图片：使用 Pexels 搜索（https://www.pexels.com）
<span class="hljs-bullet">-</span> 插画：使用 unDraw（https://undraw.co）
</code></pre>
<p>保存这个文件为 <code>AGENTS.md</code>，放在项目根目录，以后每次跟 AI 对话，它都会自动读取这个文件，按照你的要求来工作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50477347eb924c1182523f78784854b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=CHipMdFbPxaJHO61%2FdjeFDKlkiY%3D" alt="" loading="lazy"/></p>
<p>举个例子，输入跟之前一毛一样的需求 “帮我做个动漫视频网站”，有了规则文件后，效果立竿见影！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcc715792d5a44c98d038b029db64fad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=TSItSeP49UzjwiS2dykMnQfP5EM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">方法 5、Agent Skills</h3>
<p>如果你觉得自己写提示词太麻烦，还有个更省事的办法 —— <strong>Agent Skills</strong>。</p>
<p>简单来说，Agent Skills 就是别人封装好的专业技能包，你直接在 AI 编程工具中安装就能用，让 AI 学会各种专业技能，比如制作 PPT、整理 Excel 表格等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/644319a0fe60470a82cae974dd1c602a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=5JaM6AS0ONbSb6Gfj2SLDW01wtM%3D" alt="" loading="lazy"/></p>
<p>如果想让 AI 开发的网站更精美独特，可以用下面 2 个 Skills。</p>
<h4 data-id="heading-13">Frontend-design</h4>
<p>这是 Anthropic 官方出品的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain%2Fskills%2Ffrontend-design" target="_blank" title="https://github.com/anthropics/skills/tree/main/skills/frontend-design" ref="nofollow noopener noreferrer">前端设计技能</a>，可以教 AI 生成专业设计感网站。</p>
<p>用法很简单，以 Claude Code 为例。</p>
<p>首先打开 Claude Code 并输入命令，添加官方技能市场：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add anthropics/skills
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a4861639e494380b67840724c523c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=ofe9CxmYl33vPqqFCkawqkJCeZ8%3D" alt="" loading="lazy"/></p>
<p>这就像是在你的 AI 助手里开通了一个技能商店，接下来你就可以从商店中获取技能了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9766cb132bf49e485a5bb7a20f460c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=o%2Bz3YhImnVxOU7bp8WzWm0FgdA0%3D" alt="" loading="lazy"/></p>
<p>在 Claude Code 中输入命令，安装官方提供的技能包：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin install example-skills@anthropic-agent-skills
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6502c0e5fa446cdbba55bbf20a07813~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=X8v5D7yrVnBe6OzqZOKNVbqHY7k%3D" alt="" loading="lazy"/></p>
<p>这个 example-skills 包含了一堆官方示例技能，包括前端设计、网页测试、动图制作等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d593dda8d5d64b069559c08fad659f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=IvHql2PPbaod2u4fRboDV2h5cds%3D" alt="" loading="lazy"/></p>
<p>装完之后，你就可以直接让 AI 使用这些技能了。</p>
<p>比如你输入：帮我开发个人作品集网站。</p>
<p>AI 会主动问你：我发现你安装了前端设计技能，需要用它来生成更具设计感的页面吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f9e955d7dcb42b5aafc67e6111fd3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=CW6gpRq%2BItryzEwVHF%2Fmphc1OKg%3D" alt="" loading="lazy"/></p>
<p>确认之后，AI 会利用技能生成代码，告别蓝紫渐变、生成独特风格的精美页面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e6ab10ad5844348b8dde996d60723bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=FXipvjg1vW9PzbHpIuc01zQeE3U%3D" alt="" loading="lazy"/></p>
<p>不用每次都给 AI 输入一大堆相同的提示词，装一次技能就行了。</p>
<h4 data-id="heading-14">UI UX Pro Max</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fui-ux-pro-max-skill.nextlevelbuilder.io%2F" target="_blank" title="https://ui-ux-pro-max-skill.nextlevelbuilder.io/" ref="nofollow noopener noreferrer">UI UX Pro MAX</a> 是我现在用下来最顺手的去 AI 味儿技能了，专门用于提升 AI 的设计能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/103931e434e74275ba12416ab57a715d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=xhbWS2O4yYQJGFmI682F3yLXR9s%3D" alt="" loading="lazy"/></p>
<p>它支持几乎目前所有主流的 AI 编程工具，比如 Claude Code、Cursor、VS Code、Codex 等等。</p>
<p>用法很简单，首先按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">开源仓库文档</a> 的指引，安装官方提供的命令行工具：</p>
<pre><code class="hljs">npm install -g uipro-cli
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17cd75ec498b4f298b30b30c57b17013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=qAuT5yqkCO%2FHBzfQWgcVEezJfF4%3D" alt="" loading="lazy"/></p>
<p>然后进入到你的项目目录下，根据使用的 AI 工具执行对应的命令。比如我这里用 Cursor：</p>
<pre><code class="hljs language-css" lang="css">uipro init <span class="hljs-attr">--ai</span> <span class="hljs-attribute">cursor</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0484866840a14cc1b991baafd76e72d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=Ne9yfYfl%2BZiaLWRMTwpI9ZhQz60%3D" alt="" loading="lazy"/></p>
<p>它会自动把技能安装到 Cursor 的配置目录里。</p>
<p>接下来，当你让 AI 开发一个网站时，可以使用斜杠命令手动触发技能，或者让 AI 自动识别技能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f245d5dd34114c06af6dd41e769833a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=dFq2tftYV%2FZ2u1X1YPmdqTR6E2s%3D" alt="" loading="lazy"/></p>
<p>1）AI 会根据你的需求识别出产品类型和需要的页面类型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c0cf15e53194a1bb00a6da9323eff54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=orqXJUYDZQTrOZLMDw2sM1KvvFM%3D" alt="" loading="lazy"/></p>
<p>2）然后调用 <code>search.py</code> 搜索脚本，在 data 目录里进行多维度搜索，找到适合的配色、字体、布局风格</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fdc779af114480bad0a143a087311ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=KhIUJM5ptJ7%2F6enWLVwJxbveCxs%3D" alt="" loading="lazy"/></p>
<p>3）综合搜索结果，生成完整的设计方案（主色调、字体组合、间距规范等）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d900135d71a84274b5ba70e422573689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=QOK41dcGVFjvbuRWT0Jt59zHA98%3D" alt="" loading="lazy"/></p>
<p>4）最后，再按照设计方案生成代码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b22185983f04384905d13593f55df40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=5JEFgbr1FYX9qLZ1IFeOt2dqdSs%3D" alt="" loading="lazy"/></p>
<p>这样一来，生成的界面既专业又有设计感。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4a97ca27c6c450fb26cc2dfce4e6606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=MuPEmfLxYU4DdCWXkuMgw8pJ9qk%3D" alt="" loading="lazy"/></p>
<p>AI 不需要把所有规则都背下来，而是用到哪个查哪个，这就是 Agent Skills 的精髓。</p>
<h3 data-id="heading-15">方法 6、反 AI 味儿组件库</h3>
<p>前面提到，AI 为了保险，默认会选最主流的组件库，比如 Tailwind CSS、Shadcn UI 等。</p>
<p>这些库虽然专业，但也最容易产生 AI 味儿。</p>
<p>所以我们可以反其道而行之，明确告诉 AI 用一些 <strong>小众但有特色</strong> 的组件库。</p>
<p>比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui.aceternity.com%2F" target="_blank" title="https://ui.aceternity.com/" ref="nofollow noopener noreferrer">Aceternity UI</a> 这个库专门做那种炫酷效果，什么闪光粒子（Sparkles）、极光背景（Aurora Background）、流星效果（Meteors），都是高计算量的视觉组件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4bfda3644e145f6823090d184812202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=Ch1xkHGaKUbhYAW5A6AIXXCH00M%3D" alt="" loading="lazy"/></p>
<p>AI 很难从零写出这么复杂的效果，但你直接让 AI 用这个库，几行代码就能搞定。</p>
<p>要注意，对于这些相对小众的组件库，AI 可能不太熟悉用法。建议安装 Context7 插件，可以实时查询最新文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b94668fe68b443b963417ae7d15acef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=sIRWnby0DGSyp1e5B6ubYs2i%2FbM%3D" alt="" loading="lazy"/></p>
<p>或者直接把官方文档地址发给 AI 让它参考：</p>
<pre><code class="hljs language-arduino" lang="arduino">必须使用 Aceternity UI 设计网站
你需要阅读官方文档来了解最新的使用方法：https:<span class="hljs-comment">//ui.aceternity.com/components</span>
</code></pre>
<p>网站的逼格立刻就上去了，完全不像 AI 生成的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2928ce1965024e0d9cb6e8f1eb5b4802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=EPCz0luQ7OvAZUfdWpDSWHPR71E%3D" alt="" loading="lazy"/></p>
<p>还有很多我觉得有特点的 UI 组件库：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2F" target="_blank" title="https://magicui.design/" ref="nofollow noopener noreferrer">Magic UI</a>：150+ 动画组件，专门做微交互、流光边框、文字渐变</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdaisyui.com%2F" target="_blank" title="https://daisyui.com/" ref="nofollow noopener noreferrer">DaisyUI</a>：30+ 主题，有 cyberpunk、retro、cupcake 等风格</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbrutalistui.site%2F" target="_blank" title="https://brutalistui.site/" ref="nofollow noopener noreferrer">Brutalist UI</a>：粗野主义风格，粗边框、硬阴影、高对比</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fui.glass%2F" target="_blank" title="https://ui.glass/" ref="nofollow noopener noreferrer">Glass UI</a>：玻璃拟态效果，半透明、模糊背景</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fikun-svelte%2Fikun-ui" target="_blank" title="https://github.com/ikun-svelte/ikun-ui" ref="nofollow noopener noreferrer">ikun-ui</a>：基于 Svelte.js 和 UnoCSS 的组件库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.radix-ui.com%2F" target="_blank" title="https://www.radix-ui.com/" ref="nofollow noopener noreferrer">Radix UI</a>：无样式原语组件，完全自定义</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmantine.dev%2F" target="_blank" title="https://mantine.dev/" ref="nofollow noopener noreferrer">Mantine</a>：100+ 组件，功能丰富</li>
</ul>
<p>像我练习时长两年半，最喜欢 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fikun-svelte%2Fikun-ui" target="_blank" title="https://github.com/ikun-svelte/ikun-ui" ref="nofollow noopener noreferrer">ikun-ui</a> 了~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f2e7bbb9ea4122899fab4bda4879a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=r0pQR7yMkV3dswFOYt1Jhd2mBTw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">方法 7、自主配色（扩展知识）</h3>
<p>如果你想让网站更独特，完全走自己的路，那就得人工设计配色方案了。</p>
<p>这个方法适合有设计基础的朋友，可以用一些快速生成个性化配色的工具，比如：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcoolors.co%2F" target="_blank" title="https://coolors.co/" ref="nofollow noopener noreferrer">Coolors</a>：主流的配色生成器，按空格键随机生成，支持导出多种格式</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcolor.adobe.com%2F" target="_blank" title="https://color.adobe.com/" ref="nofollow noopener noreferrer">Adobe Color</a>：Adobe 官方的专业配色工具</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a62be41c6e474c29a24e389ed144dc71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=ylg6foK7CANtuYTbXGKtbAUS4QA%3D" alt="" loading="lazy"/></p>
<p>生成好配色后，把色值告诉 AI，让它严格按照你的配色方案来设计。这样出来的网站，配色绝对独特。</p>
<h2 data-id="heading-17">实战案例</h2>
<p>前面我讲的这些方法是可以结合使用的。下面分享几个实战例子，大家可以感受下效果。</p>
<h3 data-id="heading-18">案例 1、个人技术博客</h3>
<h4 data-id="heading-19">优化前</h4>
<p>直接输入提示词：</p>
<pre><code class="hljs">开发个人技术博客网站首页
</code></pre>
<p>效果是这样的，一眼 AI……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c80925c8e3f1478ea85e91f296d6a273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=jxyaSu0J%2FqNnjIpVQDJ%2BVkW22Do%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20">优化后</h4>
<p>使用 <code>AGENTS.md</code> 提示词规则 + UI UX Pro Max 技能：</p>
<pre><code class="hljs">开发个人技术博客网站首页
</code></pre>
<p>得到的网站更有极客范儿，内容更充实。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9d502a5656412ca6e00256afe6aca5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=4luReKTD9LIN6AOG%2BwetTY6gmSQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e738b20f4644015bf4b04a11a472a46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=LflhHM0WXIOnz6gvazdTr6%2F30u0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-21">案例 2、SaaS 产品落地页</h3>
<h4 data-id="heading-22">优化前</h4>
<p>直接输入提示词：</p>
<pre><code class="hljs">开发 SaaS 产品《服务器运维监控平台》的落地页
</code></pre>
<p>效果是这样的，又是蓝紫配色，一眼 AI……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8aedd3bea514b2b96733954d5993625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=iX3aXqV%2FH9AM69m6RplAyRZ6DN0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">优化后</h4>
<p>使用 <code>AGENTS.md</code> 提示词规则 + UI UX Pro Max 技能 + 语境注入 + 反 AI 味儿组件库：</p>
<pre><code class="hljs language-arduino" lang="arduino">开发 SaaS 产品《服务器运维监控平台》的落地页
​
先阅读这段话感受氛围：《黑客帝国》你选择蓝色药丸还是红色药丸？
必须使用 Aceternity UI 设计网站
你需要阅读官方文档来了解最新的使用方法：https:<span class="hljs-comment">//ui.aceternity.com/components</span>
</code></pre>
<p>网站背景变成了代码雨，也更像一个专业产品介绍页：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8514815ac64842918f6e427b4b0475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=hGO9ft2EkTk8Bio%2FonGGLUdgxFM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d880fe3dc3e64413a6426d1062bfbaf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=ib16nBPiIfseFooFMKMqe1KVSFs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-24">案例 3、健身 APP 落地页（移动端）</h3>
<h4 data-id="heading-25">优化前</h4>
<p>直接输入提示词：</p>
<pre><code class="hljs">开发健身 APP 落地页（移动端）
</code></pre>
<p>效果…… 这啥玩意，不评价了……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e311afe97aa4edaae50735bade9e08c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=wKzdzl%2BRxqPQ1j9pc6vOu4zHweI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-26">优化后</h4>
<p>使用 <code>AGENTS.md</code> 提示词规则 + UI UX Pro Max 技能 + 反 AI 味儿组件库：</p>
<pre><code class="hljs language-arduino" lang="arduino">开发健身 APP 落地页（移动端）
​
必须使用 IKun UI 设计网站
你需要阅读官方文档来了解最新的使用方法：https:<span class="hljs-comment">//ikun-ui.netlify.app</span>
</code></pre>
<p>这下得到的页面更真实可用了，对比还是非常明显的吧！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444bd28ef1fc4145aa2a02e289d6b5aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=czn7YvrYLY7T1v5zQrDUS4GCni8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27">最后</h2>
<p>看到这里你应该意识到，现在 AI 开发网站的能力已经非常强了。</p>
<p>有朋友觉得 AI 生成的效果不理想，可能只是因为没给它足够明确的指令。</p>
<p>就像一个厨师，你只说做个好吃的，他为了保险只能做最大众化的家常菜。但你说 “多放辣椒、不要花椒、多放豆瓣酱”，他就能做出你想要的味道。</p>
<p><strong>记住，AI 是工具，你才是主导者。</strong></p>
<p>学会了或者学废了的朋友们，点个赞吧~ 你可以在我免费开源的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">《AI 编程零基础入门教程》</a>中学到更多 AI 编程技巧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e1cf928539a4e6a9d9217103aa587ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366176&amp;x-signature=j9tJ7%2BYd%2F79G7zwIvNrXasTT%2FWM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-28">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a> 📖 AI 学习指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">鱼皮 AI 导航</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++ 封装 C FFI 接口最佳实践：以 Hugging Face Tokenizer 为例]]></title>    <link>https://juejin.cn/post/7601053058855895046</link>    <guid>https://juejin.cn/post/7601053058855895046</guid>    <pubDate>2026-01-31T05:47:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058855895046" data-draft-id="7601034810312179766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++ 封装 C FFI 接口最佳实践：以 Hugging Face Tokenizer 为例"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2026-01-31T05:47:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++ 封装 C FFI 接口最佳实践：以 Hugging Face Tokenizer 为例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T05:47:56.000Z" title="Sat Jan 31 2026 05:47:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引入</h2>
<p>在现代 AI 工程中，Hugging Face 的 tokenizers 库已成为分词器的事实标准。不过 Hugging Face 的 tokenizers 是用 Rust 来实现的，官方只提供了 python 和 node 的绑定实现。要实现与 Hugging Face tokenizers 相同的行为，最好的办法就是自己封装 Hugging Face tokenizers 的 C 绑定，从而可以被 C++ / C# / Java 这些高级编程语言调用。</p>
<h2 data-id="heading-1">2. 封装 C 接口</h2>
<p>首先要说明的是，要做的不是完整的封装 Hugging Face tokenizers 的 C 的 FFI（Foreign Function Interface）接口，而是封装自己需要的接口就可以了。比如执行分词接口和计算Token的接口：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ffi::CStr;
<span class="hljs-keyword">use</span> std::os::raw::c_char;
<span class="hljs-keyword">use</span> tokenizers::{PaddingParams, Tokenizer, TruncationParams};

<span class="hljs-comment">// === 1. 定义 C 兼容的返回结构体 ===</span>
<span class="hljs-meta">#[repr(C)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TokenizerResult</span> {
    <span class="hljs-keyword">pub</span> input_ids: *<span class="hljs-keyword">mut</span> <span class="hljs-type">i64</span>,
    <span class="hljs-keyword">pub</span> attention_mask: *<span class="hljs-keyword">mut</span> <span class="hljs-type">i64</span>,
    <span class="hljs-keyword">pub</span> token_type_ids: *<span class="hljs-keyword">mut</span> <span class="hljs-type">i64</span>,
    <span class="hljs-keyword">pub</span> length: <span class="hljs-type">u64</span>,
}

<span class="hljs-comment">// === 2. 内部状态：包装 Tokenizer ===</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TokenizerHandle</span> {
    tokenizer: Tokenizer,     <span class="hljs-comment">// 用于 encode（带 padding）</span>
    raw_tokenizer: Tokenizer, <span class="hljs-comment">// 用于 count（无 padding）</span>
}

<span class="hljs-comment">// === 3. 辅助函数：将 Rust Vec 转为 C 可拥有的指针 ===</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">vec_to_c_ptr</span>(vec: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i64</span>&gt;) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">i64</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span> = vec.<span class="hljs-title function_ invoke__">into_boxed_slice</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr</span> = boxed.<span class="hljs-title function_ invoke__">as_mut_ptr</span>();
    std::mem::<span class="hljs-title function_ invoke__">forget</span>(boxed); <span class="hljs-comment">// 防止 Rust 自动释放</span>
    ptr
}

<span class="hljs-comment">// === 4. 创建 tokenizer ===</span>
<span class="hljs-meta">#[unsafe(no_mangle)]</span> <span class="hljs-comment">// 禁用 name mangling，让 C 能找到符号</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenizer_create</span>(tokenizer_json_path: *<span class="hljs-keyword">const</span> c_char) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> std::ffi::c_void {
    <span class="hljs-keyword">if</span> tokenizer_json_path.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">return</span> std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>();
    }

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">path_cstr</span> = <span class="hljs-keyword">unsafe</span> { CStr::<span class="hljs-title function_ invoke__">from_ptr</span>(tokenizer_json_path) };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">path_str</span> = <span class="hljs-keyword">match</span> path_cstr.<span class="hljs-title function_ invoke__">to_str</span>() {
        <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
    };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tokenizer</span> = <span class="hljs-keyword">match</span> Tokenizer::<span class="hljs-title function_ invoke__">from_file</span>(path_str) {
        <span class="hljs-title function_ invoke__">Ok</span>(t) =&gt; t,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
    };

    <span class="hljs-comment">// 设置 padding/truncation 到 512（BGE 默认）</span>
    tokenizer.<span class="hljs-title function_ invoke__">with_padding</span>(<span class="hljs-title function_ invoke__">Some</span>(PaddingParams {
        strategy: tokenizers::PaddingStrategy::<span class="hljs-title function_ invoke__">Fixed</span>(<span class="hljs-number">512</span>),
        ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
    }));

    <span class="hljs-keyword">if</span> tokenizer
        .<span class="hljs-title function_ invoke__">with_truncation</span>(<span class="hljs-title function_ invoke__">Some</span>(TruncationParams {
            max_length: <span class="hljs-number">512</span>,
            ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
        }))
        .<span class="hljs-title function_ invoke__">is_err</span>()
    {
        <span class="hljs-keyword">return</span> std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>();
    }

    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">raw_tokenizer</span> = tokenizer.<span class="hljs-title function_ invoke__">clone</span>();
    raw_tokenizer.<span class="hljs-title function_ invoke__">with_padding</span>(<span class="hljs-literal">None</span>);
    raw_tokenizer.<span class="hljs-title function_ invoke__">with_truncation</span>(<span class="hljs-literal">None</span>).<span class="hljs-title function_ invoke__">ok</span>();

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handle</span> = TokenizerHandle {
        tokenizer,
        raw_tokenizer,
    };
    <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(handle)) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> std::ffi::c_void
}

<span class="hljs-comment">//计算句子token</span>
<span class="hljs-meta">#[unsafe(no_mangle)]</span> <span class="hljs-comment">// 禁用 name mangling，让 C 能找到符号</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenizer_count</span>(handle: *<span class="hljs-keyword">mut</span> std::ffi::c_void, text: *<span class="hljs-keyword">const</span> c_char) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> {
    <span class="hljs-keyword">if</span> handle.<span class="hljs-title function_ invoke__">is_null</span>() || text.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handle_ref</span> = <span class="hljs-keyword">unsafe</span> { &amp;*(handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> TokenizerHandle) };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">text_cstr</span> = <span class="hljs-keyword">unsafe</span> { CStr::<span class="hljs-title function_ invoke__">from_ptr</span>(text) };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">text_str</span> = <span class="hljs-keyword">match</span> text_cstr.<span class="hljs-title function_ invoke__">to_str</span>() {
        <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>,
    };

    <span class="hljs-keyword">match</span> handle_ref.raw_tokenizer.<span class="hljs-title function_ invoke__">encode</span>(text_str, <span class="hljs-literal">true</span>) {
        <span class="hljs-title function_ invoke__">Ok</span>(encoding) =&gt; encoding.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-number">0</span>,
    }
}

<span class="hljs-comment">// === 5. 销毁 tokenizer ===</span>
<span class="hljs-meta">#[unsafe(no_mangle)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenizer_destroy</span>(handle: *<span class="hljs-keyword">mut</span> std::ffi::c_void) {
    <span class="hljs-keyword">if</span> !handle.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> TokenizerHandle);
            <span class="hljs-comment">// Drop 自动调用</span>
        }
    }
}

<span class="hljs-comment">// === 6. 执行分词 ===</span>
<span class="hljs-meta">#[unsafe(no_mangle)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenizer_encode</span>(
    handle: *<span class="hljs-keyword">mut</span> std::ffi::c_void,
    text: *<span class="hljs-keyword">const</span> c_char,
) <span class="hljs-punctuation">-&gt;</span> TokenizerResult {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">default_result</span> = TokenizerResult {
        input_ids: std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
        attention_mask: std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
        token_type_ids: std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
        length: <span class="hljs-number">0</span>,
    };

    <span class="hljs-keyword">if</span> handle.<span class="hljs-title function_ invoke__">is_null</span>() || text.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">return</span> default_result;
    }

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handle_ref</span> = <span class="hljs-keyword">unsafe</span> { &amp;*(handle <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> TokenizerHandle) };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">text_cstr</span> = <span class="hljs-keyword">unsafe</span> { CStr::<span class="hljs-title function_ invoke__">from_ptr</span>(text) };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">text_str</span> = <span class="hljs-keyword">match</span> text_cstr.<span class="hljs-title function_ invoke__">to_str</span>() {
        <span class="hljs-title function_ invoke__">Ok</span>(s) =&gt; s,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> default_result,
    };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">encoding</span> = <span class="hljs-keyword">match</span> handle_ref.tokenizer.<span class="hljs-title function_ invoke__">encode</span>(text_str, <span class="hljs-literal">true</span>) {
        <span class="hljs-title function_ invoke__">Ok</span>(e) =&gt; e,
        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">return</span> default_result,
    };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">input_ids</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i64</span>&gt; = encoding.<span class="hljs-title function_ invoke__">get_ids</span>().<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|&amp;x| x <span class="hljs-keyword">as</span> <span class="hljs-type">i64</span>).<span class="hljs-title function_ invoke__">collect</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">attention_mask</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i64</span>&gt; = encoding
        .<span class="hljs-title function_ invoke__">get_attention_mask</span>()
        .<span class="hljs-title function_ invoke__">iter</span>()
        .<span class="hljs-title function_ invoke__">map</span>(|&amp;x| x <span class="hljs-keyword">as</span> <span class="hljs-type">i64</span>)
        .<span class="hljs-title function_ invoke__">collect</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">token_type_ids</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i64</span>&gt; = encoding.<span class="hljs-title function_ invoke__">get_type_ids</span>().<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|&amp;x| x <span class="hljs-keyword">as</span> <span class="hljs-type">i64</span>).<span class="hljs-title function_ invoke__">collect</span>();
    <span class="hljs-comment">// BGE 不需要，但 C++ 代码传了</span>
    <span class="hljs-comment">// let token_type_ids: Vec&lt;u32&gt; = vec![0u32; input_ids.len()];</span>

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">len</span> = input_ids.<span class="hljs-title function_ invoke__">len</span>(); <span class="hljs-comment">// 应该是 512，但更通用</span>

    TokenizerResult {
        input_ids: <span class="hljs-title function_ invoke__">vec_to_c_ptr</span>(input_ids),
        attention_mask: <span class="hljs-title function_ invoke__">vec_to_c_ptr</span>(attention_mask),
        token_type_ids: <span class="hljs-title function_ invoke__">vec_to_c_ptr</span>(token_type_ids),
        length: len <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>,
    }
}

<span class="hljs-comment">// === 7. 释放结果内存 ===</span>
<span class="hljs-meta">#[unsafe(no_mangle)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tokenizer_result_free</span>(result: TokenizerResult) {
    <span class="hljs-keyword">if</span> !result.input_ids.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">from_raw_parts</span>(
                result.input_ids,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
            );
        }
    }

    <span class="hljs-keyword">if</span> !result.attention_mask.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">from_raw_parts</span>(
                result.attention_mask,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
            );
        }
    }

    <span class="hljs-keyword">if</span> !result.token_type_ids.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">from_raw_parts</span>(
                result.token_type_ids,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
                result.length <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,
            );
        }
    }
}
</code></pre>
<p>对应的 C 接口如下：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// tokenizer_result.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TokenizerResult</span> {</span>
  <span class="hljs-type">int64_t</span>* input_ids;
  <span class="hljs-type">int64_t</span>* attention_mask;
  <span class="hljs-type">int64_t</span>* token_type_ids;
  <span class="hljs-type">uint64_t</span> length;
};

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __cplusplus</span>
<span class="hljs-keyword">static_assert</span>(<span class="hljs-built_in">std</span>::is_standard_layout_v&lt;TokenizerResult&gt; &amp;&amp;
                  <span class="hljs-built_in">std</span>::is_trivially_copyable_v&lt;TokenizerResult&gt;,
              <span class="hljs-string">"TokenizerResult must be C ABI compatible"</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// hf_tokenizer_ffi.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"tokenizer_result.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __cplusplus</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-type">void</span>* <span class="hljs-title function_">tokenizer_create</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* tokenizer_json_path)</span>;
<span class="hljs-type">void</span> <span class="hljs-title function_">tokenizer_destroy</span><span class="hljs-params">(<span class="hljs-type">void</span>* handle)</span>;
TokenizerResult <span class="hljs-title function_">tokenizer_encode</span><span class="hljs-params">(<span class="hljs-type">void</span>* handle, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* text)</span>;
<span class="hljs-type">uint64_t</span> <span class="hljs-title function_">tokenizer_count</span><span class="hljs-params">(<span class="hljs-type">void</span>* handle, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* text)</span>;
<span class="hljs-type">void</span> <span class="hljs-title function_">tokenizer_result_free</span><span class="hljs-params">(TokenizerResult result)</span>;

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __cplusplus</span>
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<p>具体的封装细节笔者就不多说了，因为与本文的主题无关。不过可以稍稍了解一下其中的原理，也就是说，操作系统大多数是由 C 实现的，或者提供了 C 的接口。因此，绝大多数比 C 高级的编程语言都提供了与 C 交互的能力，当然前提是必须得按照 C 得规范组织数据和封装接口。比如这里的<code>struct TokenizerResult</code>就是一个兼容 C 的结构体，<code>#[unsafe(no_mangle)]</code>则表明这是一个 C 语言形式的函数接口。</p>
<h2 data-id="heading-2">3. 经典 C++ 封装</h2>
<p>如上接口是一个标准的 C 风格式的接口：将分词器封装成一个 Handle ，也就是俗称的句柄。而后续具体的分词操作就通过这个句柄来进行，包括最后对资源的释放。在 C++ 中，当然也可以直接使用这种形式的接口，不过这样就需要遵循 C 的资源控制规则：资源申请和释放必须成对出现——比如这里的 <code>tokenizer_create</code> 和 <code>tokenizer_destroy</code>。</p>
<h3 data-id="heading-3">3.1 RAII 机制</h3>
<p>不过这样就会有一个问题，过程式的流程中很难保证 <code>tokenizer_create</code> 和 <code>tokenizer_destroy</code> 能够成对调用，例如：</p>
<pre><code class="hljs language-c" lang="c">tokenizer_create()

<span class="hljs-keyword">if</span>(...){
    <span class="hljs-keyword">return</span>;
}

tokenizer_destroy()
</code></pre>
<p>只要在 <code>tokenizer_create</code> 和 <code>tokenizer_destroy</code> 之间出现分支，程序提前返回，就会导致资源没有释放而内存泄漏。为了避免这个问题，就需要在每次 <code>return</code> 之前，都调用 <code>tokenizer_destroy()</code>——这当然是非常不优雅的，既容易忘掉又是冗余代码。</p>
<p>为了解决这种资源管理难题，C++ 提供了一种强大而优雅的机制：RAII（Resource Acquisition Is Initialization，资源获取即初始化）。它的核心思想是：将资源的生命周期绑定到对象的生命周期上。具体来说，就是利用面向对象的思想，将资源控制的行为封装成一个类对象，并且保证资源在对象构造函数中获取，在析构函数中自动释放。由于 C++ 中栈对象在离开作用域时会自动调用析构函数，在离开作用域时会自动调用析构函数。因此这些资源总是可以被正确释放，从根本上杜绝内存泄漏或资源泄露。例如：</p>
<pre><code class="hljs language-cpp" lang="cpp">Tokenizer tokenizer;

<span class="hljs-comment">//...操作</span>

<span class="hljs-keyword">if</span>(...){
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">//...更多操作</span>
</code></pre>
<h3 data-id="heading-4">3.2 拷贝语义</h3>
<p>复习一下 C++ 面向对象设计的经典五法则（Rule of Five），如果一个类自定义了以下任意一个函数：</p>
<ol>
<li>析构函数（Destructor）</li>
<li>拷贝构造函数（Copy Constructor）</li>
<li>拷贝赋值运算符（Copy Assignment Operator）</li>
<li>移动构造函数（Move Constructor）</li>
<li>移动赋值运算符（Move Assignment Operator）</li>
</ol>
<p>那么大概率也需要自定义另外四个函数，或者显式 = default / = delete 来控制行为。很多 C++ 程序员并不理解移动语义，但这并没有关系，我们可以先假定不定义移动构造函数和移动赋值运算符（或者显式 = default），此时移动操作就会退化为拷贝语义的行为。</p>
<p>而关于拷贝语义，绝大多数 C++ 程序员应该都知道这个问题：当在类对象中管理资源时，编译器生成的默认拷贝行为是“浅拷贝”，可能导致双重释放、内存泄漏等问题，因此需要自定义拷贝构造函数和拷贝赋值运算符来实现“深拷贝”的行为。因此，这个链条就很明确了：因为类中需要定义析构函数，所以需要同时定义拷贝构造函数和拷贝赋值运算符。</p>
<h3 data-id="heading-5">3.3 移动语义</h3>
<p>进一步讨论，反正移动语义可以默认，那么是不是只用定义拷贝语义就行了呢？这个要看资源的定义：如果只是管理内存资源，那么这样做是没有问题的，至少是安全的。但是资源管理不仅仅指的是内存资源，还可以是一些文件句柄、网络连接等等。这些资源往往是独占性的，进行深拷贝往往会出现问题。因此就出现了 C++ 11 开始规定的移动语义：可以安全得实现“浅拷贝”的行为。同时还可以解决“深拷贝”的性能问题。</p>
<p>基于以上的思想，笔者封装的分词器对象如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// HfTokenizer.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hf_tokenizer_ffi.h"</span></span>

<span class="hljs-keyword">namespace</span> hf {
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Tokenizer</span> {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Tokenizer</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span>;

  <span class="hljs-comment">// 析构函数</span>
  ~<span class="hljs-built_in">Tokenizer</span>() <span class="hljs-keyword">noexcept</span>;

  <span class="hljs-comment">// 禁止拷贝</span>
  <span class="hljs-built_in">Tokenizer</span>(<span class="hljs-type">const</span> Tokenizer&amp;) = <span class="hljs-keyword">delete</span>;
  Tokenizer&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Tokenizer&amp;) = <span class="hljs-keyword">delete</span>;

  <span class="hljs-comment">// 移动语义</span>
  <span class="hljs-built_in">Tokenizer</span>(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span>;
  Tokenizer&amp; <span class="hljs-keyword">operator</span>=(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span>;

  <span class="hljs-comment">// 其他接口方法</span>
  <span class="hljs-comment">// TokenizerResult Encode(const char* text) const;</span>
  <span class="hljs-comment">// uint64_t Count(const char* text) const;</span>

 <span class="hljs-keyword">private</span>:
  <span class="hljs-type">void</span>* handle;  <span class="hljs-comment">// 来自 tokenizer_create 的指针</span>
};

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// HfTokenizer.cpp</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"HfTokenizer.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">namespace</span> hf {
Tokenizer::<span class="hljs-built_in">Tokenizer</span>(<span class="hljs-type">const</span> std::string&amp; path)
    : <span class="hljs-built_in">handle</span>(<span class="hljs-built_in">tokenizer_create</span>(path.<span class="hljs-built_in">c_str</span>())) {
  <span class="hljs-keyword">if</span> (!handle) {
    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Failed to create tokenizer from "</span> + path);
  }
}

Tokenizer::~<span class="hljs-built_in">Tokenizer</span>() <span class="hljs-keyword">noexcept</span> {
  <span class="hljs-keyword">if</span> (handle) {
    <span class="hljs-built_in">tokenizer_destroy</span>(handle);
  }
}

<span class="hljs-comment">// 移动语义</span>
Tokenizer::<span class="hljs-built_in">Tokenizer</span>(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span> : <span class="hljs-built_in">handle</span>(rhs.handle) {
  rhs.handle = <span class="hljs-literal">nullptr</span>;
}

Tokenizer&amp; Tokenizer::<span class="hljs-keyword">operator</span>=(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;rhs) {
    <span class="hljs-keyword">if</span> (handle) {
      <span class="hljs-built_in">tokenizer_destroy</span>(handle);
    }
    handle = rhs.handle;
    rhs.handle = <span class="hljs-literal">nullptr</span>;
  }
  <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
}

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<p>如前所述，因为封装的是一个句柄，为了避免资源控制的麻烦，就禁止掉拷贝语义：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 禁止拷贝</span>
<span class="hljs-built_in">Tokenizer</span>(<span class="hljs-type">const</span> Tokenizer&amp;) = <span class="hljs-keyword">delete</span>;
Tokenizer&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Tokenizer&amp;) = <span class="hljs-keyword">delete</span>;
</code></pre>
<p>进行<code>()</code>拷贝构造或者<code>=</code>赋值构造看起来似乎很简单，其实在代码层层嵌套之后，就可能很难分析出是不是调用了默认的拷贝的行为，比如函数传参、容器操作等等。当然深拷贝的实现也不是性能最优，因此干脆就直接删除掉拷贝构造函数和拷贝赋值运算符。</p>
<p>没有拷贝语义，那么就需要移动语义来进行传递对象了。其实移动语义没那么难，我们只要把握住一点，移动语义的目的是安全地实现“浅拷贝”。以移动赋值运算符的实现来说，如果要实现如下移动赋值：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Tokenizer <span class="hljs-title">A</span><span class="hljs-params">()</span></span>;
<span class="hljs-function">Tokenizer <span class="hljs-title">B</span><span class="hljs-params">()</span></span>;
B = std::<span class="hljs-built_in">move</span>(A);
</code></pre>
<p>就需要以下的行为：</p>
<ol>
<li>释放掉B管理的资源。</li>
<li>将A中的成员“浅拷贝”到B中，让B接管A的资源。</li>
<li>将A中成员初始化。</li>
</ol>
<p>具体实现就是如下所示：</p>
<pre><code class="hljs language-cpp" lang="cpp">Tokenizer&amp; Tokenizer::<span class="hljs-keyword">operator</span>=(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;rhs) {
    <span class="hljs-keyword">if</span> (handle) {
      <span class="hljs-built_in">tokenizer_destroy</span>(handle);
    }
    handle = rhs.handle;
    rhs.handle = <span class="hljs-literal">nullptr</span>;
  }
  <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
}
</code></pre>
<p>移动构造函数就更加简单了，因为B对象在移动构造之前成员并没有初始化：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Tokenizer <span class="hljs-title">A</span><span class="hljs-params">()</span></span>;
<span class="hljs-function">Tokenizer <span class="hljs-title">B</span><span class="hljs-params">(std::move(A))</span></span>;
</code></pre>
<p>因此可以省略掉释放自身资源的步骤，具体实现也就是如下所示：</p>
<pre><code class="hljs language-cpp" lang="cpp">Tokenizer::<span class="hljs-built_in">Tokenizer</span>(Tokenizer&amp;&amp; rhs) <span class="hljs-keyword">noexcept</span> : <span class="hljs-built_in">handle</span>(rhs.handle) {
  rhs.handle = <span class="hljs-literal">nullptr</span>;
}
</code></pre>
<p>最后还有一个问题：A通过移动语义转移到B了，A还能使用吗？不能也没必要使用A了，无论是A对象和B对象其实是一个栈对象（当然内部管理的数据成员可能放在堆上），或者说是一个值对象；这跟引用对象或者地址对象完全不同。移动语义的本质是对象所有权的转移，转移之后原对象中资源所有权就不存在了，即使强行访问，要么访问不到，要么会程序崩溃。</p>
<h2 data-id="heading-6">4. 高级 C++ 封装</h2>
<h3 data-id="heading-7">4.1 零法则</h3>
<p>使用 RAII 机制 + 经典五法则来设计一个类对象，还有一个优点，就是使用这个类对象作为数据成员的类，就不用再显式实现析构函数。不用显式实现析构函数，也就意味着不用实现拷贝语义和移动语义，完全可以依赖类对象拷贝和移动的默认行为。举例来说，一个<code>MyResource</code>对象，管理着一段内存 buffer ，它的类定义为：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 构造：申请资源</span>
    <span class="hljs-built_in">MyResource</span>() {
        data = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];
    }

    <span class="hljs-comment">// 析构：释放资源</span>
    ~<span class="hljs-built_in">MyResource</span>() {
        <span class="hljs-keyword">delete</span>[] data;
    }

    <span class="hljs-comment">// 拷贝构造：深拷贝</span>
    <span class="hljs-built_in">MyResource</span>(<span class="hljs-type">const</span> MyResource&amp; other) {
        data = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];
        <span class="hljs-built_in">copy</span>(other.data, other.data + <span class="hljs-number">100</span>, data);
    }

    <span class="hljs-comment">// 拷贝赋值</span>
    MyResource&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> MyResource&amp; other) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) {
            <span class="hljs-keyword">delete</span>[] data;
            data = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];
            <span class="hljs-built_in">copy</span>(other.data, other.data + <span class="hljs-number">100</span>, data);
        }
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }

    <span class="hljs-comment">// 移动构造：接管资源</span>
    <span class="hljs-built_in">MyResource</span>(MyResource&amp;&amp; other) <span class="hljs-keyword">noexcept</span> {
        data = other.data;
        other.data = <span class="hljs-literal">nullptr</span>;
    }

    <span class="hljs-comment">// 移动赋值</span>
    MyResource&amp; <span class="hljs-keyword">operator</span>=(MyResource&amp;&amp; other) <span class="hljs-keyword">noexcept</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) {
            <span class="hljs-keyword">delete</span>[] data;
            data = other.data;
            other.data = <span class="hljs-literal">nullptr</span>;
        }
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span>* data = <span class="hljs-literal">nullptr</span>;
};
</code></pre>
<p>但是如果我使用 std 容器<code>vector</code> ，相应的代码就可以简写为：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 构造：自动分配内存</span>
    <span class="hljs-built_in">MyResource</span>() : <span class="hljs-built_in">data</span>(<span class="hljs-number">100</span>) {}  <span class="hljs-comment">// vector&lt;int&gt; 自动初始化为 100 个元素</span>

    <span class="hljs-comment">// ✅ 无需显式定义析构函数</span>
    <span class="hljs-comment">// ✅ 无需自定义拷贝构造 / 拷贝赋值</span>
    <span class="hljs-comment">// ✅ 无需自定义移动构造 / 移动赋值</span>

    <span class="hljs-comment">// 编译器自动生成的版本已正确、高效、异常安全</span>

<span class="hljs-keyword">private</span>:
    std::vector&lt;<span class="hljs-type">int</span>&gt; data;  <span class="hljs-comment">// RAII 自动管理内存</span>
};
</code></pre>
<p>这不是因为 <code>vector</code> 使用了什么魔法，而是 <code>vector</code> 本身就是使用了 RAII 机制 + 经典五法则来设计的一个模板类对象！在 <code>MyResource</code> 对象进行拷贝或者移动的时候，作为数据成员，<code>std::vector&lt;int&gt; data</code>也会采取同样的拷贝或者移动的行为，并且默认的、由编译器自动生成的版本就可以正确处理。</p>
<p>以上这个思想，就是现代 C++ 更推荐的<strong>零法则（Rule of Zero）</strong>：尽量不要手动管理资源，而是使用 RAII 类型让编译器自动生成所有特殊成员函数。而这个 RAII 类型，可以是 std 的任何容器对象、智能指针，也可以是自己按照五法则实现的类对象。</p>
<h3 data-id="heading-8">4.2 智能指针</h3>
<p>回到本文引入的问题，如果我的分词器实现不像写拷贝语义和移动语义怎么办呢？毕竟都是样板代码，写不好还容易出问题。此时我们就可以使用智能指针 <code>unique_ptr</code> 。常规意义上，我们都知道智能指针可以在没有任何其他对象引用的情况下自动 <code>delete</code> ，其实智能指针还可以自定义资源的释放行为：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">namespace</span> hf {
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Tokenizer</span> {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Tokenizer</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span>;

  <span class="hljs-comment">// 编译器自动生成：</span>
  <span class="hljs-comment">// - 析构函数</span>
  <span class="hljs-comment">// - 移动构造 / 移动赋值</span>
  <span class="hljs-comment">// - 禁止拷贝（因为 unique_ptr 不可拷贝）</span>

 <span class="hljs-keyword">private</span>:
  std::unique_ptr&lt;<span class="hljs-type">void</span>, <span class="hljs-built_in">void</span> (*)(<span class="hljs-type">void</span>*)&gt; handle;
};

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"HfTokenizer.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hf_tokenizer_ffi.h"</span></span>

<span class="hljs-keyword">namespace</span> hf {

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">HandleDeleter</span><span class="hljs-params">(<span class="hljs-type">void</span>* handle)</span> <span class="hljs-keyword">noexcept</span> </span>{
  <span class="hljs-keyword">if</span> (handle) {
    <span class="hljs-built_in">tokenizer_destroy</span>(handle);
  }
}

Tokenizer::<span class="hljs-built_in">Tokenizer</span>(<span class="hljs-type">const</span> std::string&amp; path)
    : <span class="hljs-built_in">handle</span>(<span class="hljs-built_in">tokenizer_create</span>(path.<span class="hljs-built_in">c_str</span>()), HandleDeleter) {
  <span class="hljs-keyword">if</span> (!handle) {
    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Failed to create tokenizer from "</span> + path);
  }
}

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<p>如上实现所示，函数 <code>HandleDeleter</code> 就是 <code>std::unique_ptr&lt;void, void (*)(void*)&gt; handle</code> 的自定义析构行为，在类对象析构的时候就会自动调用这个函数释放资源。既然资源被智能托管了，那么自然就不用写析构函数；析构函数不用写，那么拷贝构造函数、拷贝赋值运算符、移动构造函数以及移动赋值运算符都可以不用实现，全部可以依赖编译器自动生成。当然，由于 <code>unique_ptr</code> 只能移动不能拷贝，<code>Tokenizer</code>也就只能移动不能拷贝。</p>
<h2 data-id="heading-9">5. 总结</h2>
<p>最后，笔者就给出 C++ 封装 C FFI 接口的完整实现，如下所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// HfTokenizer.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"tokenizer_result.h"</span></span>

<span class="hljs-keyword">namespace</span> hf {
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Tokenizer</span> {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Tokenizer</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span></span>;

  <span class="hljs-comment">// 编译器自动生成：</span>
  <span class="hljs-comment">// - 析构函数（调用 Deleter）</span>
  <span class="hljs-comment">// - 移动构造 / 移动赋值</span>
  <span class="hljs-comment">// - 禁止拷贝（因为 unique_ptr 不可拷贝）</span>

  <span class="hljs-comment">// 其他接口方法</span>
  <span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">Count</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; text)</span> <span class="hljs-type">const</span></span>;

  <span class="hljs-comment">// 向量化</span>
  <span class="hljs-keyword">using</span> ResultPtr =
      std::unique_ptr&lt;TokenizerResult, <span class="hljs-built_in">void</span> (*)(TokenizerResult*)&gt;;
  <span class="hljs-function">ResultPtr <span class="hljs-title">Encode</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; text)</span> <span class="hljs-type">const</span></span>;

 <span class="hljs-keyword">private</span>:
  std::unique_ptr&lt;<span class="hljs-type">void</span>, <span class="hljs-built_in">void</span> (*)(<span class="hljs-type">void</span>*)&gt; handle;
};

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// HfTokenizer.cpp</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"HfTokenizer.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"hf_tokenizer_ffi.h"</span></span>

<span class="hljs-keyword">namespace</span> hf {

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">HandleDeleter</span><span class="hljs-params">(<span class="hljs-type">void</span>* handle)</span> <span class="hljs-keyword">noexcept</span> </span>{
  <span class="hljs-keyword">if</span> (handle) {
    <span class="hljs-built_in">tokenizer_destroy</span>(handle);
  }
}

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ResultDeleter</span><span class="hljs-params">(TokenizerResult* p)</span> <span class="hljs-keyword">noexcept</span> </span>{
  <span class="hljs-keyword">if</span> (p) {
    <span class="hljs-built_in">tokenizer_result_free</span>(*p);
    <span class="hljs-keyword">delete</span> p;
  }
}

Tokenizer::<span class="hljs-built_in">Tokenizer</span>(<span class="hljs-type">const</span> std::string&amp; path)
    : <span class="hljs-built_in">handle</span>(<span class="hljs-built_in">tokenizer_create</span>(path.<span class="hljs-built_in">c_str</span>()), HandleDeleter) {
  <span class="hljs-keyword">if</span> (!handle) {
    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"Failed to create tokenizer from "</span> + path);
  }
}

<span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">Tokenizer::Count</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; text)</span> <span class="hljs-type">const</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">tokenizer_count</span>(handle.<span class="hljs-built_in">get</span>(), text.<span class="hljs-built_in">c_str</span>());
}

<span class="hljs-function">Tokenizer::ResultPtr <span class="hljs-title">Tokenizer::Encode</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; text)</span> <span class="hljs-type">const</span> </span>{
  <span class="hljs-keyword">auto</span> result = std::<span class="hljs-built_in">make_unique</span>&lt;TokenizerResult&gt;(
      <span class="hljs-built_in">tokenizer_encode</span>(handle.<span class="hljs-built_in">get</span>(), text.<span class="hljs-built_in">c_str</span>()));
  <span class="hljs-keyword">return</span> {result.<span class="hljs-built_in">release</span>(), ResultDeleter};
};

}  <span class="hljs-comment">// namespace hf</span>
</code></pre>
<p>不仅是句柄，连传递的数据对象笔者都托管给智能指针，从而避免大量写特殊成员函数这些样板代码。不得不说，RAII 的设计思路非常精妙，同时保证了安全性与简洁性，给人一种回归编程原始状态的感觉。所谓“大道至简”，不是代码越繁复就越安全，也不是代码越抽象就越厉害；真正好的代码，是在正确性、可维护性与简洁性之间取得平衡，让资源管理如呼吸般自然，而非负担。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升]]></title>    <link>https://juejin.cn/post/7600616270003650598</link>    <guid>https://juejin.cn/post/7600616270003650598</guid>    <pubDate>2026-01-30T01:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600616270003650598" data-draft-id="7600684978352979995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-30T01:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:24:23.000Z" title="Fri Jan 30 2026 01:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    150
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026 年 1 月 29 日，Kotlin 2.3.20-Beta2 发布。这次更新虽然还是 Beta 版，但带来了一个<strong>实验性但意义重大</strong>的变化：<strong>Kotlin/Native 的垃圾回收器（GC）默认启用了并发标记（Concurrent Marking）</strong>。</p>
<h2 data-id="heading-0">一、什么是并发标记 GC？</h2>
<h3 data-id="heading-1">先说问题</h3>
<p>在之前的默认配置 PMCS（Parallel Mark Concurrent Sweep）中：</p>
<blockquote>
<p>GC 标记阶段必须暂停所有应用线程。</p>
</blockquote>
<p>这意味着什么？当 GC 需要标记堆中的对象时，<strong>你的应用会停下来等待</strong>。</p>
<p>对于延迟敏感的应用——尤其是 UI 应用，这种"暂停"直接表现为<strong>卡顿、掉帧</strong>。</p>
<h3 data-id="heading-2">再说解决</h3>
<p>CMS（Concurrent Mark and Sweep）的核心改进：</p>
<blockquote>
<p><strong>标记阶段可以与应用线程并发执行！</strong></p>
</blockquote>
<p>简单来说：GC 标记对象时，你的应用可以继续运行。</p>
<h2 data-id="heading-3">二、实际效果</h2>
<p>官方已经用 Compose Multiplatform UI 应用做了基准测试：</p>
<blockquote>
<p><strong>CMS 显著改善了性能表现。</strong></p>
</blockquote>
<p>这意味着：</p>
<ul>
<li>更短的 GC 暂停时间</li>
<li>更流畅的用户界面</li>
<li>更好的响应速度</li>
</ul>
<h2 data-id="heading-4">三、如何使用</h2>
<h3 data-id="heading-5">默认启用（Beta 版）</h3>
<p>在 Kotlin 2.3.20-Beta1 和 Beta2 中，<strong>CMS 已经是默认配置</strong>。</p>
<p>你什么都不用改，直接升级版本就能体验：</p>
<pre><code class="hljs language-gradle" lang="gradle">kotlin("multiplatform") version "2.3.20-Beta2"
</code></pre>
<h3 data-id="heading-6">如果遇到问题</h3>
<p>CMS 仍然是<strong>实验性功能</strong>，在某些情况下可能导致：</p>
<ul>
<li>运行时崩溃</li>
<li>吞吐量下降</li>
<li>内存占用增加</li>
</ul>
<p>如果遇到回归问题，可以手动切回 PMCS：</p>
<pre><code class="hljs language-properties" lang="properties"># gradle.properties
kotlin.native.useNativeCms=false
</code></pre>
<h2 data-id="heading-7">四、开发者的谨慎</h2>
<p>Kotlin 团队采取的是<strong>渐进式发布策略</strong>：</p>





















<table><thead><tr><th>版本</th><th>GC 模式</th></tr></thead><tbody><tr><td>2.3.20-Beta1/2</td><td>CMS（默认，收集反馈）</td></tr><tr><td>2.3.20-RC</td><td>回滚到 PMCS</td></tr><tr><td>2.3.20 正式版</td><td>待定</td></tr></tbody></table>
<p><strong>为什么这么做？</strong></p>
<p>官方说得很直白：</p>
<blockquote>
<p>需要收集更多反馈，确保发现所有问题。</p>
</blockquote>
<p>这是负责任的态度——先在 Beta 版让广大开发者帮忙"压力测试"，收集足够数据后再决定正式版是否默认启用。</p>
<h2 data-id="heading-8">五、其他更新亮点</h2>
<h3 data-id="heading-9">1. C/Obj-C 互操作新模式</h3>
<p>如果你在 Kotlin Multiplatform 中使用 C 或 Objective-C 库，可以尝试新的互操作模式：</p>
<pre><code class="hljs language-gradle" lang="gradle">kotlin {
    targets.withType&lt;org.jetbrains.kotlin.gradle.plugin.mpp.KotlinNativeTarget&gt;().configureEach {
        compilations.configureEach {
            cinterops.configureEach {
                extraOpts += listOf("-Xccall-mode", "direct")
            }
        }
    }
}
</code></pre>
<blockquote>
<p>注意：新模式仍是实验性，<strong>不要用此模式发布库</strong>。</p>
</blockquote>
<h3 data-id="heading-10">2. JPA 插件增强</h3>
<p><code>kotlin.plugin.jpa</code> 现在自动应用 <code>all-open</code> 插件的 JPA 预设：</p>
<pre><code class="hljs language-gradle" lang="gradle">plugins {
    kotlin("plugin.jpa") version "2.3.20-Beta2"
}
</code></pre>
<p>JPA 实体类自动变成 <code>open</code>，无需手动配置 <code>all-open</code>。</p>
<p>支持的注解：</p>
<ul>
<li><code>javax.persistence.Entity</code></li>
<li><code>javax.persistence.Embeddable</code></li>
<li><code>javax.persistence.MappedSuperclass</code></li>
<li><code>jakarta.persistence.Entity</code></li>
<li><code>jakarta.persistence.Embeddable</code></li>
<li><code>jakarta.persistence.MappedSuperclass</code></li>
</ul>
<h3 data-id="heading-11">3. Maven 配置简化</h3>
<p>新建 Kotlin Maven 项目时，不再需要手动：</p>
<ul>
<li>创建源码目录</li>
<li>添加 <code>kotlin-stdlib</code> 依赖</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sourceRootsAutoDetection</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">sourceRootsAutoDetection</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">4. Gradle 9.3.0 兼容</h3>
<p>支持 Gradle 7.6.3 到 9.3.0。</p>
<p>Kotlin/JVM 编译默认使用 Build tools API (BTA)。</p>
<h3 data-id="heading-13">5. 标准库新增 API</h3>
<p><code>Map.Entry.copy()</code> 扩展函数，用于创建 <code>Map.Entry</code> 的不可变副本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalStdlibApi::class)</span>
<span class="hljs-keyword">val</span> mutableMap = mutableMapOf(<span class="hljs-string">"key"</span> to <span class="hljs-string">"value"</span>)
<span class="hljs-keyword">val</span> entry = mutableMap.entries.first()
<span class="hljs-keyword">val</span> copy = entry.copy() <span class="hljs-comment">// 创建不可变副本</span>
</code></pre>
<h2 data-id="heading-14">六、写到最后</h2>
<p>Kotlin 2.3 的 GC 改进，对 Kotlin/Native 生态——尤其是 Compose Multiplatform 开发者来说，是一个<strong>值得期待的进步</strong>。</p>
<p>虽然目前还是 Beta 实验，但：</p>
<ul>
<li>如果你开发 UI 应用</li>
<li>你在意用户体验</li>
<li>你受够了 GC 卡顿</li>
</ul>
<p><strong>不妨现在就试试 Beta 版，把你的反馈提交给官方。</strong></p>
<p>你的每一个问题报告，都是在帮 Kotlin 变得更好。</p>
<hr/>
<h2 data-id="heading-15">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fwhatsnew-eap.html" target="_blank" title="https://kotlinlang.org/docs/whatsnew-eap.html" ref="nofollow noopener noreferrer">Kotlin 2.3.20-Beta2 发布说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutrack.jetbrains.com%2Fissues%2FKT" target="_blank" title="https://youtrack.jetbrains.com/issues/KT" ref="nofollow noopener noreferrer">YouTrack 问题追踪</a></li>
</ul>
<p><strong>升级提醒</strong>：IDE 支持 Kotlin 2.3.20-Beta2 的插件已捆绑在最新版 IntelliJ IDEA 和 Android Studio 中，只需修改 <code>build.gradle.kts</code> 中的版本号即可。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[type-challenges（ts类型体操）: 15 - 最后一个元素]]></title>    <link>https://juejin.cn/post/7601020578490449929</link>    <guid>https://juejin.cn/post/7601020578490449929</guid>    <pubDate>2026-01-31T05:49:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490449929" data-draft-id="7601169987395960883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="type-challenges（ts类型体操）: 15 - 最后一个元素"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-31T05:49:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            type-challenges（ts类型体操）: 15 - 最后一个元素
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T05:49:54.000Z" title="Sat Jan 31 2026 05:49:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">15 - 最后一个元素</h2>
<p>by Anthony Fu (@antfu) #中等 #array</p>
<h3 data-id="heading-1">题目</h3>
<blockquote>
<p>在此挑战中建议使用TypeScript 4.0</p>
</blockquote>
<p>实现一个<code>Last&lt;T&gt;</code>泛型，它接受一个数组<code>T</code>并返回其最后一个元素的类型。</p>
<p>例如</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> arr1 = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]
<span class="hljs-keyword">type</span> arr2 = [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>]

<span class="hljs-keyword">type</span> tail1 = <span class="hljs-title class_">Last</span>&lt;arr1&gt; <span class="hljs-comment">// 应推导出 'c'</span>
<span class="hljs-keyword">type</span> tail2 = <span class="hljs-title class_">Last</span>&lt;arr2&gt; <span class="hljs-comment">// 应推导出 1</span>
</code></pre>
<blockquote>
<p>在 Github 上查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F15%2Fzh-CN" target="_blank" title="https://tsch.js.org/15/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/15/zh-CN</a></p>
</blockquote>
<h3 data-id="heading-2">代码</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 你的代码 _____________ */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Last</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt; = T <span class="hljs-keyword">extends</span> [...infer _, infer R] ? R : <span class="hljs-built_in">never</span>

</code></pre>
<p>关键解释：</p>
<ul>
<li><code>T extends [...infer _, infer R]</code>：通过 <code>infer</code> 提取数组的最后一个元素 <code>R</code>。</li>
<li><code>? R : never</code>：如果数组非空，返回 <code>R</code>；否则返回 <code>never</code>。</li>
</ul>
<h3 data-id="heading-3">相关知识点</h3>
<h4 data-id="heading-4"><code>extends</code></h4>




















<table><thead><tr><th>使用维度</th><th>核心作用</th><th>示例场景</th></tr></thead><tbody><tr><td>类型维度</td><td>做类型约束或条件判断（类型编程核心）</td><td>限定泛型范围、判断类型是否兼容、提取类型片段</td></tr><tr><td>语法维度</td><td>做继承（复用已有结构）</td><td>接口继承、类继承</td></tr></tbody></table>
<h5 data-id="heading-5"><code>extends</code> 做类型约束或条件判断</h5>
<ol>
<li>泛型约束：限定泛型的取值范围</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 约束 T 必须是「拥有 length 属性」的类型（比如 string/数组）</span>
<span class="hljs-keyword">function</span> getLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">arg</span>: T): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> arg.<span class="hljs-property">length</span>;
}

<span class="hljs-comment">// 合法调用（符合约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// ✅ string 有 length，返回 5</span>
<span class="hljs-title function_">getLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// ✅ 数组有 length，返回 3</span>

<span class="hljs-comment">// 非法调用（超出约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// ❌ 报错：number 没有 length 属性</span>
</code></pre>
<ol start="2">
<li>条件类型：类型版 <strong>三元运算符</strong></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础示例：判断类型是否为字符串</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">IsString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-string">"test"</span>&gt;; <span class="hljs-comment">// true（符合）</span>
<span class="hljs-keyword">type</span> B = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-number">123</span>&gt;; <span class="hljs-comment">// false（不符合）</span>
</code></pre>
<p>分布式条件类型（联合类型专用）: 当 <code>T</code> 是联合类型时，<code>extends</code> 会自动拆分联合类型的每个成员，逐个判断后再合并结果。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Union</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>;

<span class="hljs-comment">// 拆分逻辑：string→string，number→never，boolean→never → 合并为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OnlyString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// Result = string</span>
</code></pre>
<p>注意：只有泛型参数是 裸类型（没有被 []/{} 包裹）时，才会触发分布式判断：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 包裹后不触发分布式，整体判断 [string|number] 是否兼容 [string]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDist</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">string</span>] ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result2</span> = <span class="hljs-title class_">NoDist</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// never（整体不兼容）</span>
</code></pre>
<ol start="3">
<li>配合 <code>infer</code>：提取类型片段（黄金组合）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 提取 Promise 的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer V&gt; ? V : T;

<span class="hljs-keyword">type</span> C = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// string（提取成功）</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// number（不满足条件，返回原类型）</span>
</code></pre>
<h5 data-id="heading-6"><code>extends</code> 做继承（复用已有结构）</h5>
<ol>
<li>接口继承：复用 + 扩展属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 继承 User，并扩展新属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> | <span class="hljs-string">"super_admin"</span>; <span class="hljs-comment">// 新增权限属性</span>
}

<span class="hljs-comment">// 必须包含继承的 + 扩展的所有属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">admin</span>: <span class="hljs-title class_">Admin</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>
};

<span class="hljs-comment">// 多接口继承</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasAge</span> { <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>; }
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span>, <span class="hljs-title class_">HasAge</span> {
  <span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 同时继承 User + HasAge</span>
}
</code></pre>
<ol start="2">
<li>类继承：复用父类的属性 / 方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 继承 Parent 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// 必须调用父类构造函数（初始化父类属性）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  <span class="hljs-comment">// 重写父类方法</span>
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 调用父类原方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old`</span>);
  }
}

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">10</span>);
child.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：Hi, 李四 → I'm 10 years old</span>
</code></pre>
<p>补充：类实现接口用 <code>implements</code>（不是 <code>extends</code>）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义接口（契约：规定必须有 id、name 属性，以及 greet 方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">greet</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 仅定义方法签名，无实现</span>
}

<span class="hljs-comment">// 类实现接口（必须严格遵守契约）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-comment">// 必须实现接口的所有属性</span>
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数初始化属性</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 必须实现接口的 greet 方法（具体实现由类自己定义）</span>
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span>`</span>);
  }
}

<span class="hljs-comment">// 实例化使用</span>
<span class="hljs-keyword">const</span> emp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>);
emp.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// 输出：Hi, I'm 张三, ID: 1</span>


<span class="hljs-comment">// 接口1：基础信息</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Identifiable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 接口2：可打印</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> {
  <span class="hljs-title function_">printInfo</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 类同时实现两个接口（必须实现所有接口的成员）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Identifiable</span>, <span class="hljs-title class_">Printable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 类可扩展接口外的属性</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 实现 Identifiable 的方法</span>
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;
  }

  <span class="hljs-comment">// 实现 Printable 的方法</span>
  <span class="hljs-title function_">printInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Product: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getId()}</span>`</span>);
  }
}

<span class="hljs-keyword">const</span> product = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">100</span>, <span class="hljs-string">"手机"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(product.<span class="hljs-title function_">getId</span>()); <span class="hljs-comment">// 100</span>
product.<span class="hljs-title function_">printInfo</span>(); <span class="hljs-comment">// Product: 手机, ID: 100</span>
</code></pre>
<h4 data-id="heading-7"><code>infer</code></h4>
<p><code>infer</code> 是 TypeScript 在条件类型中提供的关键字，用于声明一个 <strong>待推导的类型变量</strong>（类似给类型起一个临时名字），只能在 <code>extends</code> 子句中使用。它的核心作用是：从已有类型中提取 / 推导我们需要的部分，而无需手动硬编码类型。</p>
<p><code>infer</code> 必须配合条件类型使用，语法结构如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础结构：推导 T 的类型为 U，若能推导则返回 U，否则返回 never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">InferType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> infer U ? U : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Example</span> = <span class="hljs-title class_">InferType</span>&lt;<span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// Example 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Example2</span> = <span class="hljs-title class_">InferType</span>&lt;<span class="hljs-built_in">number</span>[]&gt;; <span class="hljs-comment">// Example2 类型为 number[]</span>
</code></pre>
<p>高频使用场景:</p>
<h5 data-id="heading-8">1. 提取函数的返回值类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取函数的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-title class_">Fn</span>&gt; = <span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试用函数</span>
<span class="hljs-keyword">const</span> add = (<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> a + b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = (<span class="hljs-params"/>) =&gt; ({ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> });

<span class="hljs-comment">// 使用类型工具</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddReturn</span> = <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-keyword">typeof</span> add&gt;; <span class="hljs-comment">// AddReturn 类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserReturn</span> = <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-keyword">typeof</span> getUser&gt;; <span class="hljs-comment">// UserReturn 类型为 { name: string; age: number }</span>
</code></pre>
<h5 data-id="heading-9">2. 提取数组的元素类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取数组元素类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetArrayItem</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer <span class="hljs-title class_">Item</span>)[] ? <span class="hljs-title class_">Item</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumberArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;<span class="hljs-built_in">number</span>[]&gt;; <span class="hljs-comment">// NumberArray 类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// StringArray 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MixedArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;[<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>]&gt;; <span class="hljs-comment">// MixedArray 类型为 string | number</span>
</code></pre>
<h5 data-id="heading-10">3. 提取 Promise 的泛型参数类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取 Promise 的泛型类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetPromiseValue</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer <span class="hljs-title class_">Value</span>&gt; ? <span class="hljs-title class_">Value</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromiseString</span> = <span class="hljs-title class_">GetPromiseValue</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// PromiseString 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromiseUser</span> = <span class="hljs-title class_">GetPromiseValue</span>&lt;<span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt;&gt;; <span class="hljs-comment">// PromiseUser 类型为 { id: number }</span>
</code></pre>
<h5 data-id="heading-11">4. 提取函数的参数类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取函数参数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-title class_">Fn</span>&gt; = <span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Params</span>) =&gt; <span class="hljs-built_in">any</span> ? <span class="hljs-title class_">Params</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> fn = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FnParams</span> = <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;; <span class="hljs-comment">// FnParams 类型为 [string, number]</span>

<span class="hljs-comment">// 进一步：提取第一个参数的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FirstParam</span> = <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;[<span class="hljs-number">0</span>]; <span class="hljs-comment">// FirstParam 类型为 string</span>
</code></pre>
<h4 data-id="heading-12"><code>never</code></h4>
<p><code>never</code> 表示<strong>永不存在的类型</strong>：</p>
<ol>
<li>没有任何类型能赋值给 <code>never</code>（除了 <code>never</code> 自身）；</li>
<li><code>never</code> 可以赋值给任意类型（因为它是所有类型的子类型）；</li>
<li>不会有任何实际值属于 <code>never</code> 类型。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">n</span>: <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">123</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">u</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-string">"hello"</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">v</span>: <span class="hljs-built_in">void</span> = <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">// 1. 任何类型都不能赋值给 never（除了自身）</span>
n = num;   <span class="hljs-comment">// ❌ 报错：number 不能赋值给 never</span>
n = u;     <span class="hljs-comment">// ❌ 报错：unknown 不能赋值给 never</span>
n = v;     <span class="hljs-comment">// ❌ 报错：void 不能赋值给 never</span>
n = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// ❌ 报错：undefined 也不行</span>
n = n;     <span class="hljs-comment">// ✅ 仅自身可赋值</span>

<span class="hljs-comment">// 2. never 可以赋值给任意类型</span>
num = n;   <span class="hljs-comment">// ✅ 正常</span>
u = n;     <span class="hljs-comment">// ✅ 正常</span>
v = n;     <span class="hljs-comment">// ✅ 正常</span>
</code></pre>
<ol>
<li>泛型的边界约束: 通过泛型约束让不满足条件的泛型类型变为 <code>never</code>，从而达到<strong>限制类型范围</strong>的目的。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义泛型：仅允许 T 为 string 类型，否则 T 为 never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OnlyString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? T : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 满足条件：T 为 string，结果正常</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Str1</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-string">"hello"</span>&gt;; <span class="hljs-comment">// Str1 = "hello"</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Str2</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-built_in">string</span>&gt;;  <span class="hljs-comment">// Str2 = string</span>

<span class="hljs-comment">// 不满足条件：T 为非 string，结果为 never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Num</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-built_in">number</span>&gt;;   <span class="hljs-comment">// Num = never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Bool</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-built_in">boolean</span>&gt;; <span class="hljs-comment">// Bool = never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Unk</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-built_in">unknown</span>&gt;;  <span class="hljs-comment">// Unk = never</span>

<span class="hljs-comment">// 实际使用：强制函数参数只能是 string 类型</span>
<span class="hljs-keyword">function</span> printStr&lt;T&gt;(<span class="hljs-attr">val</span>: <span class="hljs-title class_">OnlyString</span>&lt;T&gt;) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val);
}

<span class="hljs-title function_">printStr</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// ✅ 正常</span>
<span class="hljs-title function_">printStr</span>(<span class="hljs-number">123</span>);     <span class="hljs-comment">// ❌ 报错：number 不能赋值给 never</span>
</code></pre>
<h3 data-id="heading-13">测试用例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 测试用例 _____________ */</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Equal</span>, <span class="hljs-title class_">Expect</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-challenges/utils'</span>

<span class="hljs-keyword">type</span> cases = [
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">Last</span>&lt;[]&gt;, <span class="hljs-built_in">never</span>&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">Last</span>&lt;[<span class="hljs-number">2</span>]&gt;, <span class="hljs-number">2</span>&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">Last</span>&lt;[<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>]&gt;, <span class="hljs-number">1</span>&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">Last</span>&lt;[<span class="hljs-function">() =&gt;</span> <span class="hljs-number">123</span>, { <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> }]&gt;, { <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> }&gt;&gt;,
]

</code></pre>
<h3 data-id="heading-14">相关链接</h3>
<blockquote>
<p>分享你的解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F15%2Fanswer%2Fzh-CN" target="_blank" title="https://tsch.js.org/15/answer/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/15/answer/z…</a>
查看解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F15%2Fsolutions" target="_blank" title="https://tsch.js.org/15/solutions" ref="nofollow noopener noreferrer">tsch.js.org/15/solution…</a>
更多题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2Fzh-CN" target="_blank" title="https://tsch.js.org/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/zh-CN</a></p>
</blockquote>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770443397&amp;x-signature=DS0m%2BI8ZIB7dsTYLD%2Bo56a1ri48%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flowable工作流：从入门到实战]]></title>    <link>https://juejin.cn/post/7600622206269440010</link>    <guid>https://juejin.cn/post/7600622206269440010</guid>    <pubDate>2026-01-30T01:10:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206269440010" data-draft-id="7600606150732890155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flowable工作流：从入门到实战"/> <meta itemprop="keywords" content="工作流引擎"/> <meta itemprop="datePublished" content="2026-01-30T01:10:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flowable工作流：从入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:10:21.000Z" title="Fri Jan 30 2026 01:10:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flowable工作流：从入门到实战</h2>
<h3 data-id="heading-1">一、什么是Flowable</h3>
<p>Flowable是一个开源的轻量级业务流程引擎（BPMN 2.0），它起源于Activiti项目，是Activiti的继任者。Flowable提供了完整的工作流和业务流程管理（BPM）平台，支持流程定义、部署、执行、监控等全生命周期管理。</p>
<h4 data-id="heading-2">1.1 核心特性</h4>
<ul>
<li><strong>BPMN 2.0标准支持</strong>：完全符合BPMN 2.0规范</li>
<li><strong>轻量级</strong>：可嵌入到任何Java应用中</li>
<li><strong>高性能</strong>：支持高并发场景</li>
<li><strong>灵活扩展</strong>：提供丰富的扩展点</li>
<li><strong>云原生</strong>：支持微服务架构</li>
</ul>
<h4 data-id="heading-3">1.2 核心组件</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3311a7a20cf6442b94326a9b3ce2b7a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=VCt%2F22i6HOeSLnLRLvIH8LUDybY%3D" alt="" loading="lazy"/></p>
<p>Flowable主要由以下核心组件构成：</p>
<ul>
<li><strong>Flowable Engine</strong>：核心流程引擎</li>
<li><strong>Flowable Modeler</strong>：流程建模工具</li>
<li><strong>Flowable Task</strong>：任务管理应用</li>
<li><strong>Flowable Admin</strong>：管理监控界面</li>
<li><strong>Flowable REST</strong>：REST API接口</li>
</ul>
<h3 data-id="heading-4">二、核心概念详解</h3>
<h4 data-id="heading-5">2.1 BPMN 2.0基础</h4>
<p>BPMN（Business Process Model and Notation）是业务流程建模与 notation 的标准。BPMN 2.0定义了一套标准的图形符号来表示业务流程。</p>
<h5 data-id="heading-6">基本元素</h5>
<ul>
<li><strong>事件（Event）</strong>：流程中发生的事情，如开始事件、结束事件</li>
<li><strong>活动（Activity）</strong>：流程中的工作单元，如用户任务、服务任务</li>
<li><strong>网关（Gateway）</strong>：控制流程分支，如排他网关、并行网关</li>
<li><strong>连接线（Sequence Flow）</strong>：连接各个元素</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15604c79c6764d2e8122efbc1be76eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=4gXyatOBhMRV5Ex%2BUPQHEvlHXpU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 流程定义</h4>
<p>流程定义是业务流程的静态描述，使用BPMN XML格式定义。一个典型的请假流程定义如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">definitions</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span>
             <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"Examples"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 开始事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"开始"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 员工填写请假单 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"employeeTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"填写请假单"</span>
                  <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${employee}"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 部门经理审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"经理审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"managers"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 排他网关：根据天数决定是否需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"gateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- HR审批（超过3天需要） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hrTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"HR审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"hr"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"endEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"结束"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 连接线 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"employeeTask"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"employeeTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"managerTask"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"gateway"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"hrTask"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${days &gt; 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEvent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${days &lt;= 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"hrTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEvent"</span>/&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">definitions</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">2.3 流程实例与执行</h4>
<p>流程实例是流程定义的一次具体执行。一个流程定义可以创建多个流程实例，每个实例有独立的执行状态和变量。</p>
<h3 data-id="heading-9">三、快速入门</h3>
<h4 data-id="heading-10">3.1 环境搭建</h4>
<p>首先创建Maven项目，添加Flowable依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Flowable核心引擎 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Flowable REST API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 数据库连接 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.224<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 日志 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">3.2 初始化流程引擎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowableEngineConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessEngine processEngine;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProcessEngine <span class="hljs-title function_">getProcessEngine</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (processEngine == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (FlowableEngineConfig.class) {
                <span class="hljs-keyword">if</span> (processEngine == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 配置流程引擎</span>
                    <span class="hljs-type">ProcessEngineConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ProcessEngineConfiguration
                            .createStandaloneProcessEngineConfiguration();

                    <span class="hljs-comment">// 配置数据库连接</span>
                    configuration.setJdbcDriver(<span class="hljs-string">"org.h2.Driver"</span>);
                    configuration.setJdbcUrl(<span class="hljs-string">"jdbc:h2:mem:flowable;DB_CLOSE_DELAY=-1"</span>);
                    configuration.setJdbcUsername(<span class="hljs-string">"sa"</span>);
                    configuration.setJdbcPassword(<span class="hljs-string">""</span>);

                    <span class="hljs-comment">// 自动创建/更新数据库表结构</span>
                    configuration.setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);

                    <span class="hljs-comment">// 创建流程引擎</span>
                    processEngine = configuration.buildProcessEngine();
                }
            }
        }
        <span class="hljs-keyword">return</span> processEngine;
    }

    <span class="hljs-comment">// 获取各个服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RepositoryService <span class="hljs-title function_">getRepositoryService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getRepositoryService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RuntimeService <span class="hljs-title function_">getRuntimeService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getRuntimeService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskService <span class="hljs-title function_">getTaskService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getTaskService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HistoryService <span class="hljs-title function_">getHistoryService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getHistoryService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ManagementService <span class="hljs-title function_">getManagementService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getManagementService();
    }
}
</code></pre>
<h4 data-id="heading-12">3.3 部署流程定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessDeploymentService</span> {

    <span class="hljs-comment">/**
     * 部署流程定义
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deployProcess</span><span class="hljs-params">(String processName, String resourcePath)</span> {
        <span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> FlowableEngineConfig.getRepositoryService()
                .createDeployment()
                .name(processName)
                .addClasspathResource(resourcePath)
                .deploy();

        System.out.println(<span class="hljs-string">"流程部署成功，部署ID: "</span> + deployment.getId());
        <span class="hljs-keyword">return</span> deployment.getId();
    }

    <span class="hljs-comment">/**
     * 查询已部署的流程列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessDefinition&gt; <span class="hljs-title function_">listProcesses</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> FlowableEngineConfig.getRepositoryService()
                .createProcessDefinitionQuery()
                .orderByProcessDefinitionName()
                .asc()
                .list();
    }
}
</code></pre>
<h4 data-id="heading-13">3.4 启动流程实例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessInstanceService</span> {

    <span class="hljs-comment">/**
     * 启动流程实例
     */</span>
    <span class="hljs-keyword">public</span> ProcessInstance <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processDefinitionKey, Map&lt;String, Object&gt; variables)</span> {
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> FlowableEngineConfig.getRuntimeService()
                .startProcessInstanceByKey(processDefinitionKey, variables);

        System.out.println(<span class="hljs-string">"流程实例启动成功，实例ID: "</span> + processInstance.getId());
        System.out.println(<span class="hljs-string">"业务Key: "</span> + processInstance.getBusinessKey());

        <span class="hljs-keyword">return</span> processInstance;
    }

    <span class="hljs-comment">/**
     * 查询运行中的流程实例
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessInstance&gt; <span class="hljs-title function_">listRunningInstances</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> FlowableEngineConfig.getRuntimeService()
                .createProcessInstanceQuery()
                .orderByStartTime()
                .desc()
                .list();
    }
}
</code></pre>
<h3 data-id="heading-14">四、核心服务详解</h3>
<p>Flowable通过服务层对外提供功能，主要包括以下服务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac5929ac76274dec9c565013fda3fceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=8CBrIwwOVEd%2FyU2lwRFlgZPr2Ck%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">4.1 RepositoryService（仓库服务）</h4>
<p>管理流程定义和部署对象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 部署流程</span>
<span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> repositoryService.createDeployment()
    .name(<span class="hljs-string">"请假流程"</span>)
    .addClasspathResource(<span class="hljs-string">"processes/leave-request.bpmn20.xml"</span>)
    .deploy();

<span class="hljs-comment">// 查询流程定义</span>
<span class="hljs-type">ProcessDefinition</span> <span class="hljs-variable">processDefinition</span> <span class="hljs-operator">=</span> repositoryService
    .createProcessDefinitionQuery()
    .processDefinitionKey(<span class="hljs-string">"leaveRequest"</span>)
    .singleResult();

<span class="hljs-comment">// 挂起/激活流程定义</span>
repositoryService.suspendProcessDefinitionById(processDefinitionId);
repositoryService.activateProcessDefinitionById(processDefinitionId);

<span class="hljs-comment">// 删除流程定义</span>
repositoryService.deleteDeployment(deploymentId, <span class="hljs-literal">true</span>);
</code></pre>
<h4 data-id="heading-16">4.2 RuntimeService（运行时服务）</h4>
<p>管理流程实例和执行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 启动流程实例</span>
<span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService
    .startProcessInstanceByKey(<span class="hljs-string">"leaveRequest"</span>, variables);

<span class="hljs-comment">// 设置流程变量</span>
runtimeService.setVariable(processInstanceId, <span class="hljs-string">"days"</span>, <span class="hljs-number">5</span>);
runtimeService.setVariable(processInstanceId, <span class="hljs-string">"reason"</span>, <span class="hljs-string">"休息"</span>);

<span class="hljs-comment">// 获取流程变量</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> (Integer) runtimeService.getVariable(processInstanceId, <span class="hljs-string">"days"</span>);

<span class="hljs-comment">// 触发流程执行</span>
runtimeService.trigger(executionId);

<span class="hljs-comment">// 挂起/激活流程实例</span>
runtimeService.suspendProcessInstanceById(processInstanceId);
runtimeService.activateProcessInstanceById(processInstanceId);

<span class="hljs-comment">// 删除流程实例</span>
runtimeService.deleteProcessInstance(processInstanceId, <span class="hljs-string">"取消申请"</span>);
</code></pre>
<h4 data-id="heading-17">4.3 TaskService（任务服务）</h4>
<p>管理用户任务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询用户的待办任务</span>
List&lt;Task&gt; tasks = taskService.createTaskQuery()
    .taskAssignee(<span class="hljs-string">"zhangsan"</span>)
    .orderByTaskCreateTime()
    .desc()
    .list();

<span class="hljs-comment">// 完成任务</span>
taskService.complete(taskId);

<span class="hljs-comment">// 带变量完成任务</span>
Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
variables.put(<span class="hljs-string">"approved"</span>, <span class="hljs-literal">true</span>);
taskService.complete(taskId, variables);

<span class="hljs-comment">// 认领任务（候选任务）</span>
taskService.claim(taskId, <span class="hljs-string">"lisi"</span>);

<span class="hljs-comment">// 委派任务</span>
taskService.delegateTask(taskId, <span class="hljs-string">"wangwu"</span>);

<span class="hljs-comment">// 设置任务优先级</span>
taskService.setPriority(taskId, <span class="hljs-number">50</span>);
</code></pre>
<h4 data-id="heading-18">4.4 HistoryService（历史服务）</h4>
<p>查询历史数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询已完成的流程实例</span>
List&lt;HistoricProcessInstance&gt; finishedInstances = historyService
    .createHistoricProcessInstanceQuery()
    .finished()
    .orderByProcessInstanceEndTime()
    .desc()
    .list();

<span class="hljs-comment">// 查询历史任务</span>
List&lt;HistoricTaskInstance&gt; historicTasks = historyService
    .createHistoricTaskInstanceQuery()
    .taskAssignee(<span class="hljs-string">"zhangsan"</span>)
    .finished()
    .list();

<span class="hljs-comment">// 查询历史变量</span>
List&lt;HistoricVariableInstance&gt; variables = historyService
    .createHistoricVariableInstanceQuery()
    .processInstanceId(processInstanceId)
    .list();

<span class="hljs-comment">// 查询流程实例历史（按时间线）</span>
List&lt;HistoricActivityInstance&gt; activities = historyService
    .createHistoricActivityInstanceQuery()
    .processInstanceId(processInstanceId)
    .orderByHistoricActivityInstanceStartTime()
    .asc()
    .list();
</code></pre>
<h4 data-id="heading-19">4.5 ManagementService（管理服务）</h4>
<p>执行管理操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取数据库表信息</span>
<span class="hljs-type">TableMetaData</span> <span class="hljs-variable">tableMetaData</span> <span class="hljs-operator">=</span> managementService
    .getTablesMetaData()
    .get(<span class="hljs-string">"ACT_RU_TASK"</span>);

<span class="hljs-comment">// 执行自定义SQL</span>
List&lt;Map&lt;String, Object&gt;&gt; results = managementService
    .executeCustomSql(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractCustomSqlExecution</span>&lt;CustomQuery, List&lt;Map&lt;String, Object&gt;&gt;&gt;(CustomQuery.class) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">(Configuration configuration)</span> {
                <span class="hljs-comment">// 自定义SQL执行逻辑</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }
    );

<span class="hljs-comment">// 获取作业列表</span>
List&lt;Job&gt; jobs = managementService.createJobQuery().list();
</code></pre>
<h3 data-id="heading-20">五、实战案例：请假审批系统</h3>
<h4 data-id="heading-21">5.1 业务需求</h4>
<p>实现一个企业内部请假审批系统，支持以下功能：</p>
<ol>
<li>员工提交请假申请</li>
<li>部门经理审批（1-3天直接通过）</li>
<li>HR审批（超过3天需要HR审批）</li>
<li>审批通过/驳回</li>
<li>查询请假记录</li>
</ol>
<h4 data-id="heading-22">5.2 系统架构设计</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc2e5a1e5e58411d87e458289074bf86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=MOQYdYbaqMfA0OKE9XEDVJKkGpE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">5.3 流程定义</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">definitions</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span>
             <span class="hljs-attr">xmlns:flowable</span>=<span class="hljs-string">"http://flowable.org/bpmn"</span>
             <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"Examples"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假审批流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 开始事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"提交申请"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 员工填写请假单 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"填写请假单"</span>
                  <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${initiator}"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>员工填写请假信息，包括请假天数、原因等<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 部门经理审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"经理审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"managers"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>部门经理审批请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 排他网关：根据审批结果和天数决定流程走向 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"approvalGateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 驳回处理 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"rejectHandler"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"处理驳回"</span>
                     <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.RejectDelegate"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- HR审批（超过3天） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hrApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"HR审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"hr"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>HR审批长期请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 通知员工 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"发送通知"</span>
                     <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.NotifyDelegate"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"approveEnd"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批通过"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"rejectEnd"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批驳回"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 连接线 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow1"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"submitLeave"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow2"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"managerApproval"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow3"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approvalGateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 驳回 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow4"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"rejectHandler"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == false}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow5"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"rejectHandler"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow6"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"rejectEnd"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 通过但需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow7"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"hrApproval"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == true &amp;&amp; days &gt; 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow8"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"hrApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow9"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approveEnd"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 通过且不需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow10"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == true &amp;&amp; days &lt;= 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow11"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approveEnd"</span>/&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">definitions</span>&gt;</span>
</code></pre>
<h4 data-id="heading-24">5.4 服务层实现</h4>
<h5 data-id="heading-25">请假服务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;

    <span class="hljs-comment">/**
     * 创建请假申请
     */</span>
    <span class="hljs-keyword">public</span> LeaveRequest <span class="hljs-title function_">createLeaveRequest</span><span class="hljs-params">(LeaveRequest request)</span> {
        <span class="hljs-comment">// 设置流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"initiator"</span>, request.getEmployeeId());
        variables.put(<span class="hljs-string">"days"</span>, request.getDays());
        variables.put(<span class="hljs-string">"reason"</span>, request.getReason());
        variables.put(<span class="hljs-string">"startDate"</span>, request.getStartDate());
        variables.put(<span class="hljs-string">"endDate"</span>, request.getEndDate());

        <span class="hljs-comment">// 启动流程实例</span>
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService
                .startProcessInstanceByKey(<span class="hljs-string">"leaveRequest"</span>, request.getBusinessKey(), variables);

        <span class="hljs-comment">// 完成填写请假单任务，自动流转到经理审批</span>
        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTaskQuery()
                .processInstanceId(processInstance.getId())
                .taskAssignee(request.getEmployeeId())
                .singleResult();

        <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
            taskService.complete(task.getId());
        }

        <span class="hljs-comment">// 保存流程实例ID</span>
        request.setProcessInstanceId(processInstance.getId());
        request.setStatus(<span class="hljs-string">"pending"</span>);

        <span class="hljs-keyword">return</span> request;
    }

    <span class="hljs-comment">/**
     * 经理审批
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">managerApproval</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> approved, String comment)</span> {
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"approved"</span>, approved);
        variables.put(<span class="hljs-string">"managerComment"</span>, comment);

        <span class="hljs-comment">// 添加审批意见</span>
        taskService.addComment(taskId, <span class="hljs-literal">null</span>, comment);

        <span class="hljs-comment">// 完成任务</span>
        taskService.complete(taskId, variables);
    }

    <span class="hljs-comment">/**
     * HR审批
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hrApproval</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> approved, String comment)</span> {
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"approved"</span>, approved);
        variables.put(<span class="hljs-string">"hrComment"</span>, comment);

        taskService.addComment(taskId, <span class="hljs-literal">null</span>, comment);
        taskService.complete(taskId, variables);
    }

    <span class="hljs-comment">/**
     * 获取用户的待办任务
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TaskDTO&gt; <span class="hljs-title function_">getMyTasks</span><span class="hljs-params">(String userId)</span> {
        List&lt;Task&gt; tasks = taskService.createTaskQuery()
                .taskAssignee(userId)
                .orderByTaskCreateTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> tasks.stream()
                .map(<span class="hljs-built_in">this</span>::convertToDTO)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 获取组任务（候选任务）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TaskDTO&gt; <span class="hljs-title function_">getCandidateTasks</span><span class="hljs-params">(String groupId)</span> {
        List&lt;Task&gt; tasks = taskService.createTaskQuery()
                .taskCandidateGroup(groupId)
                .orderByTaskCreateTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> tasks.stream()
                .map(<span class="hljs-built_in">this</span>::convertToDTO)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 认领任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">claimTask</span><span class="hljs-params">(String taskId, String userId)</span> {
        taskService.claim(taskId, userId);
    }

    <span class="hljs-comment">/**
     * 查询请假历史记录
     */</span>
    <span class="hljs-keyword">public</span> List&lt;LeaveRequestHistory&gt; <span class="hljs-title function_">getLeaveHistory</span><span class="hljs-params">(String employeeId)</span> {
        List&lt;HistoricProcessInstance&gt; instances = historyService
                .createHistoricProcessInstanceQuery()
                .variableValueEquals(<span class="hljs-string">"initiator"</span>, employeeId)
                .orderByProcessInstanceStartTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> instances.stream()
                .map(<span class="hljs-built_in">this</span>::convertToHistory)
                .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> TaskDTO <span class="hljs-title function_">convertToDTO</span><span class="hljs-params">(Task task)</span> {
        <span class="hljs-type">TaskDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskDTO</span>();
        dto.setTaskId(task.getId());
        dto.setTaskName(task.getName());
        dto.setProcessInstanceId(task.getProcessInstanceId());
        dto.setCreateTime(task.getCreateTime());
        dto.setAssignee(task.getAssignee());

        <span class="hljs-comment">// 获取流程变量</span>
        Map&lt;String, Object&gt; variables = taskService.getVariables(task.getId());
        dto.setVariables(variables);

        <span class="hljs-keyword">return</span> dto;
    }
}
</code></pre>
<h5 data-id="heading-26">驳回处理委托</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RejectDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JavaDelegate</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();
        <span class="hljs-type">String</span> <span class="hljs-variable">initiator</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"initiator"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">reason</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"reason"</span>);

        <span class="hljs-comment">// 记录驳回原因</span>
        execution.setVariable(<span class="hljs-string">"rejectReason"</span>, <span class="hljs-string">"请假申请被驳回"</span>);

        <span class="hljs-comment">// 这里可以发送通知、更新业务系统状态等</span>
        System.out.println(<span class="hljs-string">"驳回请假申请: "</span> + processInstanceId);
        System.out.println(<span class="hljs-string">"申请人: "</span> + initiator);
        System.out.println(<span class="hljs-string">"请假原因: "</span> + reason);

        <span class="hljs-comment">// 可以调用外部服务发送邮件、短信通知</span>
        <span class="hljs-comment">// notificationService.sendRejectNotification(initiator);</span>
    }
}
</code></pre>
<h5 data-id="heading-27">通知委托</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotifyDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JavaDelegate</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();
        <span class="hljs-type">String</span> <span class="hljs-variable">initiator</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"initiator"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">approved</span> <span class="hljs-operator">=</span> (Boolean) execution.getVariable(<span class="hljs-string">"approved"</span>);

        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(approved)) {
            System.out.println(<span class="hljs-string">"审批通过通知: "</span> + processInstanceId);
            <span class="hljs-comment">// 发送通过通知</span>
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"审批驳回通知: "</span> + processInstanceId);
            <span class="hljs-comment">// 发送驳回通知</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-28">5.5 REST API</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/leave")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LeaveRequestService leaveRequestService;

    <span class="hljs-comment">/**
     * 提交请假申请
     */</span>
    <span class="hljs-meta">@PostMapping("/submit")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;LeaveRequest&gt; <span class="hljs-title function_">submitLeave</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LeaveRequest request)</span> {
        <span class="hljs-type">LeaveRequest</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> leaveRequestService.createLeaveRequest(request);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(result);
    }

    <span class="hljs-comment">/**
     * 获取我的待办任务
     */</span>
    <span class="hljs-meta">@GetMapping("/my-tasks")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;TaskDTO&gt;&gt; <span class="hljs-title function_">getMyTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String userId)</span> {
        List&lt;TaskDTO&gt; tasks = leaveRequestService.getMyTasks(userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(tasks);
    }

    <span class="hljs-comment">/**
     * 获取候选任务
     */</span>
    <span class="hljs-meta">@GetMapping("/candidate-tasks")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;TaskDTO&gt;&gt; <span class="hljs-title function_">getCandidateTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String groupId)</span> {
        List&lt;TaskDTO&gt; tasks = leaveRequestService.getCandidateTasks(groupId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(tasks);
    }

    <span class="hljs-comment">/**
     * 认领任务
     */</span>
    <span class="hljs-meta">@PostMapping("/tasks/{taskId}/claim")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">claimTask</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String taskId,
            <span class="hljs-meta">@RequestParam</span> String userId)</span> {
        leaveRequestService.claimTask(taskId, userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();
    }

    <span class="hljs-comment">/**
     * 完成审批
     */</span>
    <span class="hljs-meta">@PostMapping("/tasks/{taskId}/complete")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">completeTask</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String taskId,
            <span class="hljs-meta">@RequestBody</span> ApprovalRequest approval)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"managerApproval"</span>.equals(approval.getTaskName())) {
            leaveRequestService.managerApproval(taskId, approval.isApproved(), approval.getComment());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"hrApproval"</span>.equals(approval.getTaskName())) {
            leaveRequestService.hrApproval(taskId, approval.isApproved(), approval.getComment());
        }
        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();
    }

    <span class="hljs-comment">/**
     * 查询请假历史
     */</span>
    <span class="hljs-meta">@GetMapping("/history")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;LeaveRequestHistory&gt;&gt; <span class="hljs-title function_">getHistory</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String employeeId)</span> {
        List&lt;LeaveRequestHistory&gt; history = leaveRequestService.getLeaveHistory(employeeId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(history);
    }
}
</code></pre>
<h3 data-id="heading-29">六、高级特性</h3>
<h4 data-id="heading-30">6.1 并行网关</h4>
<p>并行网关用于处理多个并发任务：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parallelGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fork"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parallelGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支1 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务1"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task1"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支2 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task2"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务2"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task2"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task2"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支3 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task3"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务3"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task3"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task3"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/538e42783af64a28b77a4692a8aac1e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=PcjUBaboK3BzAJmkrZU3us3snvE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-31">6.2 子流程</h4>
<p>子流程用于封装可重用的流程片段：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">subProcess</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subProcess"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批子流程"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subStart"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"子流程任务"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subEnd"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"subStart"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"subTask"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"subTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"subEnd"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subProcess</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">callActivity</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"callSubProcess"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"调用子流程"</span>
               <span class="hljs-attr">calledElement</span>=<span class="hljs-string">"subProcess"</span>/&gt;</span>
</code></pre>
<h4 data-id="heading-32">6.3 事件机制</h4>
<p>Flowable支持多种事件类型：</p>
<ul>
<li><strong>定时器事件</strong>：基于时间的触发</li>
<li><strong>消息事件</strong>：异步消息传递</li>
<li><strong>信号事件</strong>：广播式通知</li>
<li><strong>错误事件</strong>：异常处理</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 定时器事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">intermediateCatchEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"timerEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"等待通知"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">timerEventDefinition</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">timeDuration</span>&gt;</span>PT2H<span class="hljs-tag">&lt;/<span class="hljs-name">timeDuration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">timerEventDefinition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">intermediateCatchEvent</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 消息事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">intermediateCatchEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"接收消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">messageEventDefinition</span> <span class="hljs-attr">messageRef</span>=<span class="hljs-string">"approvalMessage"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">intermediateCatchEvent</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 边界定时器事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">boundaryEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"boundaryTimer"</span> <span class="hljs-attr">attachedToRef</span>=<span class="hljs-string">"userTask"</span>
               <span class="hljs-attr">cancelActivity</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">timerEventDefinition</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">timeDuration</span>&gt;</span>PT1H<span class="hljs-tag">&lt;/<span class="hljs-name">timeDuration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">timerEventDefinition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">boundaryEvent</span>&gt;</span>
</code></pre>
<h4 data-id="heading-33">6.4 监听器</h4>
<p>通过监听器实现业务逻辑的扩展：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 流程启动监听器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessStartListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutionListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processDefinitionId</span> <span class="hljs-operator">=</span> execution.getProcessDefinitionId();
        System.out.println(<span class="hljs-string">"流程启动: "</span> + processDefinitionId);

        <span class="hljs-comment">// 记录日志、发送通知等</span>
    }
}

<span class="hljs-comment">// 任务创建监听器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskCreateListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaskListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateTask delegateTask)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> delegateTask.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">assignee</span> <span class="hljs-operator">=</span> delegateTask.getAssignee();
        System.out.println(<span class="hljs-string">"任务创建: "</span> + taskName + <span class="hljs-string">", 分配给: "</span> + assignee);

        <span class="hljs-comment">// 发送任务通知</span>
    }
}
</code></pre>
<p>配置监听器：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">flowable:executionListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"start"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.flowable.listener.ProcessStartListener"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${manager}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">flowable:taskListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"create"</span>
                <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.flowable.listener.TaskCreateListener"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
</code></pre>
<h3 data-id="heading-34">七、生产环境最佳实践</h3>
<h4 data-id="heading-35">7.1 数据库优化</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为常用查询字段添加索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_ru_task_ASSIGNEE <span class="hljs-keyword">ON</span> ACT_RU_TASK(ASSIGNEE_);
<span class="hljs-keyword">CREATE</span> INDEX idx_ru_task_PROC_INST <span class="hljs-keyword">ON</span> ACT_RU_TASK(PROC_INST_ID_);
<span class="hljs-keyword">CREATE</span> INDEX idx_hi_procinst_BUS_KEY <span class="hljs-keyword">ON</span> ACT_HI_PROCINST(BUS_KEY_);
<span class="hljs-keyword">CREATE</span> INDEX idx_hi_actinst_PROC_INST <span class="hljs-keyword">ON</span> ACT_HI_ACTINST(PROC_INST_ID_);

<span class="hljs-comment">-- 定期清理历史数据（根据业务需求配置保留时长）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ACT_HI_VARINST <span class="hljs-keyword">WHERE</span> END_TIME_ <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ACT_HI_DETAIL <span class="hljs-keyword">WHERE</span> TIME_ <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);
</code></pre>
<h4 data-id="heading-36">7.2 性能优化</h4>
<ol>
<li><strong>异步执行</strong>：对耗时操作使用异步任务</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"asyncTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"异步任务"</span>
             <span class="hljs-attr">flowable:async</span>=<span class="hljs-string">"true"</span>
             <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.AsyncTaskDelegate"</span>/&gt;</span>
</code></pre>
<ol start="2">
<li><strong>批量操作</strong>：使用批量查询和操作API</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批量查询任务</span>
List&lt;Task&gt; tasks = taskService.createTaskQuery()
    .taskAssignee(<span class="hljs-string">"user1"</span>)
    .listPage(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);

<span class="hljs-comment">// 批量完成任务</span>
List&lt;String&gt; taskIds = Arrays.asList(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>, <span class="hljs-string">"task3"</span>);
taskService.completeBatchTasks(taskIds);
</code></pre>
<ol start="3">
<li><strong>缓存配置</strong>：启用流程定义缓存</li>
</ol>
<pre><code class="hljs language-java" lang="java">configuration.setProcessDefinitionCacheSize(<span class="hljs-number">100</span>);
configuration.setEnableProcessDefinitionInfoCache(<span class="hljs-literal">true</span>);
</code></pre>
<h4 data-id="heading-37">7.3 安全配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置用户权限管理</span>
<span class="hljs-type">IdentityService</span> <span class="hljs-variable">identityService</span> <span class="hljs-operator">=</span> processEngine.getIdentityService();

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> identityService.newUser(<span class="hljs-string">"zhangsan"</span>);
user.setFirstName(<span class="hljs-string">"三"</span>);
user.setLastName(<span class="hljs-string">"张"</span>);
user.setEmail(<span class="hljs-string">"zhangsan@example.com"</span>);
identityService.saveUser(user);

<span class="hljs-comment">// 创建组</span>
<span class="hljs-type">Group</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> identityService.newGroup(<span class="hljs-string">"managers"</span>);
group.setName(<span class="hljs-string">"经理组"</span>);
identityService.saveGroup(group);

<span class="hljs-comment">// 分配用户到组</span>
identityService.createMembership(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"managers"</span>);
</code></pre>
<h4 data-id="heading-38">7.4 监控与告警</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1d0cda076c485e921861d27222f888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=Jf5%2Fh9ldNIll%2FjRcknHzxtFRikw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowableMonitorService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ManagementService managementService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-comment">/**
     * 获取运行中的流程统计
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Long&gt; <span class="hljs-title function_">getProcessStatistics</span><span class="hljs-params">()</span> {
        Map&lt;String, Long&gt; stats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 各流程运行实例数</span>
        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().list();
        Map&lt;String, Long&gt; countByProcess = instances.stream()
            .collect(Collectors.groupingBy(
                ProcessInstance::getProcessDefinitionKey,
                Collectors.counting()
            ));
        stats.putAll(countByProcess);

        <span class="hljs-comment">// 待办任务统计</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">pendingTasks</span> <span class="hljs-operator">=</span> managementService.createTaskQuery().count();
        stats.put(<span class="hljs-string">"pendingTasks"</span>, pendingTasks);

        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-comment">/**
     * 检测异常流程（运行时间过长）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessInstance&gt; <span class="hljs-title function_">detectLongRunningProcesses</span><span class="hljs-params">(<span class="hljs-type">int</span> thresholdHours)</span> {
        <span class="hljs-type">Date</span> <span class="hljs-variable">threshold</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() - thresholdHours * <span class="hljs-number">3600000L</span>);

        <span class="hljs-keyword">return</span> runtimeService.createProcessInstanceQuery()
            .startedBefore(threshold)
            .list();
    }

    <span class="hljs-comment">/**
     * 获取数据库表信息
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getDatabaseInfo</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 获取各表记录数</span>
        String[] tables = {<span class="hljs-string">"ACT_RU_EXECUTION"</span>, <span class="hljs-string">"ACT_RU_TASK"</span>, <span class="hljs-string">"ACT_HI_PROCINST"</span>};
        <span class="hljs-keyword">for</span> (String table : tables) {
            <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> managementService.createTablePageQuery()
                .tableName(table)
                .listPage(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
                .getTotal();
            info.put(table, count);
        }

        <span class="hljs-keyword">return</span> info;
    }
}
</code></pre>
<h3 data-id="heading-39">八、微服务集成</h3>
<p>在微服务架构中使用Flowable：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml配置</span>
<span class="hljs-attr">flowable:</span>
  <span class="hljs-comment"># 数据库配置</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/flowable?useSSL=false</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">flowable</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">flowable</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

  <span class="hljs-comment"># 异步执行器配置</span>
  <span class="hljs-attr">async-executor-activate:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">async-executor-max-jobs-per-acquisition:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">async-executor-default-queue-size:</span> <span class="hljs-number">100</span>

  <span class="hljs-comment"># REST API配置</span>
  <span class="hljs-attr">rest:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>

  <span class="hljs-comment"># 邮件服务器配置</span>
  <span class="hljs-attr">mail:</span>
    <span class="hljs-attr">server:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">smtp.example.com</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">587</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">noreply@example.com</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
</code></pre>
<p>服务间通信示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowIntegrationService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;

    <span class="hljs-comment">/**
     * 跨服务启动流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startCrossServiceProcess</span><span class="hljs-params">(WorkflowRequest request)</span> {
        <span class="hljs-comment">// 调用其他服务获取数据</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(
            <span class="hljs-string">"http://user-service/api/users/"</span> + request.getUserId(),
            UserDTO.class
        );

        <span class="hljs-comment">// 设置流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"user"</span>, user);
        variables.put(<span class="hljs-string">"request"</span>, request);

        <span class="hljs-comment">// 启动流程</span>
        runtimeService.startProcessInstanceByKey(
            <span class="hljs-string">"crossServiceProcess"</span>,
            request.getBusinessKey(),
            variables
        );
    }

    <span class="hljs-comment">/**
     * 流程回调处理
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleProcessCallback</span><span class="hljs-params">(String processInstanceId, String eventType)</span> {
        <span class="hljs-comment">// 根据事件类型执行不同操作</span>
        <span class="hljs-keyword">switch</span> (eventType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"completed"</span>:
                <span class="hljs-comment">// 流程完成后的处理</span>
                handleProcessCompleted(processInstanceId);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"cancelled"</span>:
                <span class="hljs-comment">// 流程取消后的处理</span>
                handleProcessCancelled(processInstanceId);
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-40">九、总结</h3>
<p>Flowable作为一款优秀的开源工作流引擎，具有以下优势：</p>
<ol>
<li><strong>标准化</strong>：完全符合BPMN 2.0标准，学习成本低</li>
<li><strong>轻量级</strong>：可嵌入任何Java应用，部署简单</li>
<li><strong>高性能</strong>：支持高并发场景，适合企业级应用</li>
<li><strong>灵活扩展</strong>：提供丰富的扩展点，易于定制</li>
<li><strong>社区活跃</strong>：文档完善，社区支持良好</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain学习笔记（二）：工具的调用]]></title>    <link>https://juejin.cn/post/7600642904382636038</link>    <guid>https://juejin.cn/post/7600642904382636038</guid>    <pubDate>2026-01-29T17:10:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600642904382636038" data-draft-id="7600637595944976426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain学习笔记（二）：工具的调用"/> <meta itemprop="keywords" content="后端,LangChain,LLM"/> <meta itemprop="datePublished" content="2026-01-29T17:10:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_Shawn"/> <meta itemprop="url" content="https://juejin.cn/user/1855631358965384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain学习笔记（二）：工具的调用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631358965384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_Shawn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T17:10:54.000Z" title="Thu Jan 29 2026 17:10:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Tool Calling</h3>
<h4 data-id="heading-1">定义简单tool</h4>
<p>创建工具最简单的方法是使用 <code>@tool</code> 装饰器。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool(<span class="hljs-params">description=<span class="hljs-string">"Returns the current time in yyyy-MM-dd HH:mm:ss format."</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_time</span>(<span class="hljs-params">*args, **kwargs</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    获取当前系统时间。
    格式为：yyyy-MM-dd HH:mm:ss
    """</span>
    now = datetime.datetime.now()
    <span class="hljs-keyword">return</span> now.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
</code></pre>
<p>如果description不写，则默认注释里的就是描述信息，否则则使用description，描述信息需要易于大模型的理解。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
获取当前系统时间。
格式为：yyyy-MM-dd HH:mm:ss
"""</span>
</code></pre>
<h4 data-id="heading-2">llm绑定tool</h4>
<p>借助 <code>bind_tools</code>，实现llm与工具的绑定，在底层，这些都会被转换为 OpenAI 工具模式，其格式如下：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"..."</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"..."</span>,
    <span class="hljs-string">"parameters"</span>: {...}  <span class="hljs-comment"># JSONSchema</span>
}
</code></pre>
<p>代码示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 方式1：自动工具调用（推荐） ==========</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_simple_tool_calling</span>():
    <span class="hljs-string">"""
    方式1：使用 bind_tools + 手动执行
    特点：需要手动处理工具调用和结果
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🛠️ 方式1：bind_tools + 手动执行工具"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    llm_tools = llm.bind_tools(tools=[get_current_time])
    messages = [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请获取当前时间"</span>}
    ]

    <span class="hljs-comment"># 第一步：LLM 返回工具调用请求</span>
    result = llm_tools.invoke(messages)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📤 LLM 响应类型: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(result)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📤 LLM 内容: <span class="hljs-subst">{result.content}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📤 工具调用请求: <span class="hljs-subst">{result.tool_calls}</span>"</span>)

    <span class="hljs-comment"># 第二步：手动执行工具，判断大模型的reponse是不是tool_call，如果是tool_call类型，则真正执行工具的调用</span>
    <span class="hljs-keyword">if</span> result.tool_calls:
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> result.tool_calls:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 执行工具: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔧 工具参数: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)

            <span class="hljs-keyword">if</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'get_current_time'</span>:
                <span class="hljs-comment"># 手动调用工具</span>
                tool_result = get_current_time.invoke(tool_call[<span class="hljs-string">'args'</span>])
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 工具执行结果: <span class="hljs-subst">{tool_result}</span>"</span>)

                <span class="hljs-comment"># 第三步：将工具结果返回给 LLM（可选）</span>
                messages.append(result)  <span class="hljs-comment"># 添加 AI 的工具调用消息</span>
                messages.append(ToolMessage(
                    content=tool_result,
                    tool_call_id=tool_call[<span class="hljs-string">'id'</span>]
                ))

                <span class="hljs-comment"># 让 LLM 根据工具结果生成最终回答</span>
                final_response = llm_tools.invoke(messages)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💬 最终回答: <span class="hljs-subst">{final_response.content}</span>"</span>)
</code></pre>
<p>模拟工具调用流程，通过ToolMessage</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_simple_tool_calling_2</span>():
    <span class="hljs-string">"""
    方式2：手动构造 AIMessage 和 ToolMessage
    特点：完全手动控制消息流，适合测试和调试
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🛠️ 方式2：手动构造消息流"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    <span class="hljs-comment"># 手动构造 AI 的工具调用消息</span>
    ai_message = AIMessage(
        content=<span class="hljs-string">""</span>,  <span class="hljs-comment"># 通常为空，因为 AI 选择调用工具而不是直接回答</span>
        tool_calls=[{
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_current_time"</span>,
            <span class="hljs-string">"args"</span>: {},
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"call_123"</span>
        }]
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📤 模拟 AI 工具调用: <span class="hljs-subst">{ai_message.tool_calls}</span>"</span>)

    <span class="hljs-comment"># 执行工具并创建结果消息</span>
    tool_result = get_current_time.invoke({})
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 工具执行结果: <span class="hljs-subst">{tool_result}</span>"</span>)

    tool_message = ToolMessage(
        content=tool_result,
        tool_call_id=<span class="hljs-string">"call_123"</span>
    )

    <span class="hljs-comment"># 构造完整的消息历史</span>
    messages = [
        HumanMessage(<span class="hljs-string">"请获取当前时间"</span>),
        ai_message,  <span class="hljs-comment"># AI 的工具调用</span>
        tool_message,  <span class="hljs-comment"># 工具执行结果</span>
    ]

    <span class="hljs-comment"># LLM 根据工具结果生成最终回答</span>
    response = llm.invoke(messages)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💬 最终回答: <span class="hljs-subst">{response.content}</span>"</span>)
</code></pre>
<h4 data-id="heading-3">多工具调用</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 额外示例：多个工具 ==========</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""计算数学表达式。"""</span>
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-built_in">eval</span>(expression)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算结果: <span class="hljs-subst">{result}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_multiple_tools</span>():
    <span class="hljs-string">"""演示多个工具的使用"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🛠️ 多工具示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    llm_tools = llm.bind_tools(tools=[get_current_time, calculate])
    tool_map = {
        <span class="hljs-string">"get_current_time"</span>: get_current_time,
        <span class="hljs-string">"calculate"</span>: calculate
    }

    messages = [HumanMessage(content=<span class="hljs-string">"现在几点？然后帮我计算 15 * 8"</span>)]

    max_iterations = <span class="hljs-number">10</span>
    iteration = <span class="hljs-number">0</span>

    <span class="hljs-keyword">while</span> iteration &lt; max_iterations:
        iteration += <span class="hljs-number">1</span>
        response = llm_tools.invoke(messages)
        messages.append(response)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response.tool_calls:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 最终回答: <span class="hljs-subst">{response.content}</span>"</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
            tool_name = tool_call[<span class="hljs-string">'name'</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 调用工具: <span class="hljs-subst">{tool_name}</span>"</span>)

            tool_result = tool_map[tool_name].invoke(tool_call[<span class="hljs-string">'args'</span>])
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 结果: <span class="hljs-subst">{tool_result}</span>"</span>)

            messages.append(ToolMessage(
                content=tool_result,
                tool_call_id=tool_call[<span class="hljs-string">'id'</span>]
            ))
</code></pre>
<h4 data-id="heading-4">结构化入参</h4>
<p>tool 装饰器里，有个 args_schema 参数，可以配置结构化的类</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 1. 基础结构化入参 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""搜索工具的输入参数"""</span>
    query: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"搜索关键词"</span>)
    max_results: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">10</span>, description=<span class="hljs-string">"最大返回结果数"</span>, ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">100</span>)
    language: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"zh"</span>, description=<span class="hljs-string">"语言代码，如 zh, en"</span>)


<span class="hljs-meta">@tool(<span class="hljs-params">args_schema=SearchInput</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, max_results: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>, language: <span class="hljs-built_in">str</span> = <span class="hljs-string">"zh"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在网络上搜索信息。"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"搜索 '<span class="hljs-subst">{query}</span>'，返回 <span class="hljs-subst">{max_results}</span> 条 <span class="hljs-subst">{language}</span> 结果"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_basic_structured_input</span>():
    <span class="hljs-string">"""演示基础结构化入参"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 示例1：基础结构化入参"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    llm_tools = llm.bind_tools([search_web])
    messages = [HumanMessage(<span class="hljs-string">"搜索 LangChain 相关信息，返回5条结果"</span>)]

    response = llm_tools.invoke(messages)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🤖 LLM 工具调用:"</span>)
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  工具: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  参数: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)

        <span class="hljs-comment"># 执行工具</span>
        result = search_web.invoke(tool_call[<span class="hljs-string">'args'</span>])
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  结果: <span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<p>嵌套复杂的结构化入参</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 2. 复杂结构化入参（嵌套对象） ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""地址信息"""</span>
    street: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"街道地址"</span>)
    city: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"城市"</span>)
    country: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"中国"</span>, description=<span class="hljs-string">"国家"</span>)
    postal_code: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"邮政编码"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""用户信息"""</span>
    name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户姓名"</span>)
    age: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"年龄"</span>, ge=<span class="hljs-number">0</span>, le=<span class="hljs-number">150</span>)
    email: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"邮箱地址"</span>)
    address: Address = Field(description=<span class="hljs-string">"地址信息"</span>)
    tags: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(default=[], description=<span class="hljs-string">"用户标签"</span>)

<span class="hljs-meta">    @field_validator(<span class="hljs-params"><span class="hljs-string">'email'</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_email</span>(<span class="hljs-params">cls, v</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-string">'@'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> v:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">'邮箱格式不正确'</span>)
        <span class="hljs-keyword">return</span> v


<span class="hljs-meta">@tool(<span class="hljs-params">args_schema=UserInfo</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, age: <span class="hljs-built_in">int</span>, email: <span class="hljs-built_in">str</span>, address: Address, tags: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""创建新用户。"""</span>
    tags = tags <span class="hljs-keyword">or</span> []
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"创建用户: <span class="hljs-subst">{name}</span>, <span class="hljs-subst">{age}</span>岁, <span class="hljs-subst">{email}</span>, 地址: <span class="hljs-subst">{address.city}</span>, 标签: <span class="hljs-subst">{tags}</span>"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_nested_structured_input</span>():
    <span class="hljs-string">"""演示嵌套结构化入参"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 示例2：嵌套结构化入参"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    <span class="hljs-comment"># 手动测试</span>
    user_data = {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
        <span class="hljs-string">"age"</span>: <span class="hljs-number">25</span>,
        <span class="hljs-string">"email"</span>: <span class="hljs-string">"zhangsan@example.com"</span>,
        <span class="hljs-string">"address"</span>: {
            <span class="hljs-string">"street"</span>: <span class="hljs-string">"中关村大街1号"</span>,
            <span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>,
            <span class="hljs-string">"country"</span>: <span class="hljs-string">"中国"</span>,
            <span class="hljs-string">"postal_code"</span>: <span class="hljs-string">"100000"</span>
        },
        <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"VIP"</span>, <span class="hljs-string">"技术"</span>]
    }

    tool_call = {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"create_user"</span>,
        <span class="hljs-string">"args"</span>: user_data,
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"call_123"</span>,  <span class="hljs-comment"># 必须提供 tool_call_id</span>
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_call"</span>
    }

    result = create_user.invoke(tool_call)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 执行结果: <span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<h4 data-id="heading-5">结构化输出</h4>
<p><code>response_format</code> 是 <code>@tool</code> 装饰器的一个重要参数，用于控制工具返回值的格式和处理方式。</p>




















<table><thead><tr><th>值</th><th>描述</th><th>返回类型</th></tr></thead><tbody><tr><td><code>"content"</code></td><td><strong>默认值</strong>，工具返回值直接作为内容</td><td>执行返回一个<code>str</code></td></tr><tr><td><code>"content_and_artifact"</code></td><td>返回内容和原始数据（artifact）</td><td>工具必须返回一个元组 <code>(content, artifact)</code>：-   <strong>content</strong>: 给 LLM 看的简洁文本描述-   <strong>artifact</strong>: 完整的原始数据（可以是任意类型）</td></tr></tbody></table>
<p>代码示例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 4. 结构化出参 (content_and_artifact) ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""产品信息"""</span>
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    name: <span class="hljs-built_in">str</span>
    price: <span class="hljs-built_in">float</span>
    stock: <span class="hljs-built_in">int</span>
    category: <span class="hljs-built_in">str</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchResult</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""搜索结果"""</span>
    total: <span class="hljs-built_in">int</span>
    products: <span class="hljs-type">List</span>[ProductInfo]
    page: <span class="hljs-built_in">int</span>
    page_size: <span class="hljs-built_in">int</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSearchInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""产品搜索输入"""</span>
    keyword: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"搜索关键词"</span>)
    category: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"产品分类"</span>)
    min_price: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"最低价格"</span>)
    max_price: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"最高价格"</span>)
    page: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">1</span>, description=<span class="hljs-string">"页码"</span>, ge=<span class="hljs-number">1</span>)
    page_size: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">10</span>, description=<span class="hljs-string">"每页数量"</span>, ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">100</span>)


<span class="hljs-meta">@tool(<span class="hljs-params">
    args_schema=ProductSearchInput,
    response_format=<span class="hljs-string">"content_and_artifact"</span>
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_products</span>(<span class="hljs-params">
        keyword: <span class="hljs-built_in">str</span>,
        category: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        min_price: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span>,
        max_price: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span>,
        page: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,
        page_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>
</span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">str</span>, SearchResult]:
    <span class="hljs-string">"""搜索产品。"""</span>
    <span class="hljs-comment"># 模拟数据库查询</span>
    mock_products = [
        ProductInfo(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>, name=<span class="hljs-string">"iPhone 15"</span>, price=<span class="hljs-number">6999</span>, stock=<span class="hljs-number">50</span>, category=<span class="hljs-string">"手机"</span>),
        ProductInfo(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>, name=<span class="hljs-string">"MacBook Pro"</span>, price=<span class="hljs-number">12999</span>, stock=<span class="hljs-number">30</span>, category=<span class="hljs-string">"电脑"</span>),
        ProductInfo(<span class="hljs-built_in">id</span>=<span class="hljs-number">3</span>, name=<span class="hljs-string">"AirPods Pro"</span>, price=<span class="hljs-number">1999</span>, stock=<span class="hljs-number">100</span>, category=<span class="hljs-string">"耳机"</span>),
    ]

    <span class="hljs-comment"># 过滤产品</span>
    filtered = mock_products
    <span class="hljs-keyword">if</span> category:
        filtered = [p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> filtered <span class="hljs-keyword">if</span> p.category == category]
    <span class="hljs-keyword">if</span> min_price:
        filtered = [p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> filtered <span class="hljs-keyword">if</span> p.price &gt;= min_price]
    <span class="hljs-keyword">if</span> max_price:
        filtered = [p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> filtered <span class="hljs-keyword">if</span> p.price &lt;= max_price]

    <span class="hljs-comment"># 构造结果</span>
    result = SearchResult(
        total=<span class="hljs-built_in">len</span>(filtered),
        products=filtered,
        page=page,
        page_size=page_size
    )

    <span class="hljs-comment"># content: 给 LLM 的简洁描述</span>
    content = <span class="hljs-string">f"找到 <span class="hljs-subst">{result.total}</span> 个产品"</span>
    <span class="hljs-keyword">if</span> category:
        content += <span class="hljs-string">f"，分类: <span class="hljs-subst">{category}</span>"</span>

    <span class="hljs-comment"># artifact: 完整的结构化数据</span>
    <span class="hljs-keyword">return</span> content, result


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_structured_output</span>():
    <span class="hljs-string">"""演示结构化出参"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 示例4：结构化出参 (content_and_artifact)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    llm_with_tools = llm.bind_tools([search_products])

    messages = [HumanMessage(content=<span class="hljs-string">"搜索价格在5000以上的手机"</span>)]

    <span class="hljs-comment"># LLM 决策</span>
    response = llm_with_tools.invoke(messages)

    <span class="hljs-keyword">if</span> response.tool_calls:
        tool_call = response.tool_calls[<span class="hljs-number">0</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🤖 LLM 决定调用工具:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   工具: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   参数: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)

        <span class="hljs-comment"># 执行工具</span>
        <span class="hljs-comment">## 这里返回的是ToolMessage</span>
        result = search_products.invoke(tool_call)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 工具执行结果:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   Content: <span class="hljs-subst">{result.content}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   Artifact 类型: <span class="hljs-subst">{result.artifact}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   产品数量: <span class="hljs-subst">{result.artifact.total}</span>"</span>)
</code></pre>
<h4 data-id="heading-6">structure_tool</h4>
<p>StructuredTool 是 LangChain 里的一个类，专门用于处理多参数输入的工具。 与基础的 Tool 类（通常只接受一个字符串输入）不同，StructuredTool 利用 Pydantic 来定义和校验复杂的输入结构（Schema）。</p>
<p>相比 @tool 装饰器提供了更多的灵活性和控制能力。</p>


















































<table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>func</code></td><td><code>Callable</code></td><td>同步执行函数</td></tr><tr><td><code>coroutine</code></td><td><code>Callable</code></td><td>异步执行函数</td></tr><tr><td><code>name</code></td><td><code>str</code></td><td>工具名称（LLM 看到的名称）</td></tr><tr><td><code>description</code></td><td><code>str</code></td><td>工具描述（LLM 用来决定是否调用）</td></tr><tr><td><code>args_schema</code></td><td><code>Type[BaseModel]</code></td><td>Pydantic 模型定义输入参数</td></tr><tr><td><code>return_direct</code></td><td><code>bool</code></td><td><code>True</code>时直接返回给用户，不经过 LLM</td></tr><tr><td><code>handle_tool_error</code></td><td><code>bool/str/Callable</code></td><td>错误处理方式</td></tr><tr><td><code>response_format</code></td><td><code>str</code></td><td><code>"content"</code>或 <code>"content_and_artifact"</code></td></tr></tbody></table>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 5. 使用 StructuredTool 创建工具 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""计算器输入"""</span>
    expression: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"数学表达式，如 '2 + 3 * 4'"</span>)
    precision: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">2</span>, description=<span class="hljs-string">"小数精度"</span>, ge=<span class="hljs-number">0</span>, le=<span class="hljs-number">10</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""计算器输出"""</span>
    expression: <span class="hljs-built_in">str</span>
    result: <span class="hljs-built_in">float</span>
    formatted_result: <span class="hljs-built_in">str</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_func</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span>, precision: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""计算数学表达式"""</span>
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-built_in">eval</span>(expression)
        formatted = <span class="hljs-string">f"<span class="hljs-subst">{result:.{precision}</span>f}"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"expression"</span>: expression,
            <span class="hljs-string">"result"</span>: result,
            <span class="hljs-string">"formatted_result"</span>: formatted
        }
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"expression"</span>: expression,
            <span class="hljs-string">"result"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"formatted_result"</span>: <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        }


calculator_tool = StructuredTool.from_function(
    func=calculate_func,
    name=<span class="hljs-string">"calculator"</span>,
    description=<span class="hljs-string">"计算数学表达式"</span>,
    args_schema=CalculatorInput,
    return_direct=<span class="hljs-literal">False</span>
)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_structured_tool</span>():
    <span class="hljs-string">"""演示 StructuredTool"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 示例5：StructuredTool 创建工具"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    test_cases = [
        {<span class="hljs-string">"expression"</span>: <span class="hljs-string">"15 + 25 * 3"</span>, <span class="hljs-string">"precision"</span>: <span class="hljs-number">2</span>},
        {<span class="hljs-string">"expression"</span>: <span class="hljs-string">"100 / 3"</span>, <span class="hljs-string">"precision"</span>: <span class="hljs-number">4</span>},
        {<span class="hljs-string">"expression"</span>: <span class="hljs-string">"2 ** 10"</span>, <span class="hljs-string">"precision"</span>: <span class="hljs-number">0</span>}
    ]

    <span class="hljs-keyword">for</span> params <span class="hljs-keyword">in</span> test_cases:
        result = calculator_tool.invoke(params)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n表达式: <span class="hljs-subst">{params[<span class="hljs-string">'expression'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<h4 data-id="heading-7">base_tool</h4>
<p>BaseTool 是 LangChain 中所有工具的基类。通过继承它可以创建完全自定义的工具，拥有最大的灵活性和控制能力。</p>





























<table><thead><tr><th>方式</th><th>灵活性</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td><code>@tool</code></td><td>低</td><td>简单</td><td>快速定义简单工具</td></tr><tr><td><code>StructuredTool</code></td><td>中</td><td>中等</td><td>动态创建、自定义配置</td></tr><tr><td><code>BaseTool</code></td><td>高</td><td>复杂</td><td>完全自定义、复杂逻辑</td></tr></tbody></table>
<p>核心参数与方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> BaseTool
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Type</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">Optional</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyToolInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""工具输入参数 Schema"""</span>
    param1: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"参数1描述"</span>)
    param2: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">10</span>, description=<span class="hljs-string">"参数2描述"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    <span class="hljs-string">"""自定义工具"""</span>
    
    <span class="hljs-comment"># ========== 必须定义的属性 ==========</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"my_tool"</span>                    <span class="hljs-comment"># 工具名称</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">"这是一个自定义工具"</span>    <span class="hljs-comment"># 工具描述</span>
    args_schema: <span class="hljs-type">Type</span>[BaseModel] = MyToolInput  <span class="hljs-comment"># 输入参数 Schema</span>
    
    <span class="hljs-comment"># ========== 可选属性 ==========</span>
    return_direct: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>              <span class="hljs-comment"># 是否直接返回结果</span>
    response_format: <span class="hljs-built_in">str</span> = <span class="hljs-string">"content"</span>         <span class="hljs-comment"># 响应格式</span>
    
    <span class="hljs-comment"># ========== 自定义属性 ==========</span>
    custom_config: <span class="hljs-built_in">str</span> = <span class="hljs-string">"default"</span>           <span class="hljs-comment"># 可以添加任意自定义属性</span>
    
    <span class="hljs-comment"># ========== 必须实现的方法 ==========</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run</span>(<span class="hljs-params">self, param1: <span class="hljs-built_in">str</span>, param2: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""同步执行方法（必须实现）"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"执行结果: <span class="hljs-subst">{param1}</span>, <span class="hljs-subst">{param2}</span>"</span>
    
    <span class="hljs-comment"># ========== 可选实现的方法 ==========</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_arun</span>(<span class="hljs-params">self, param1: <span class="hljs-built_in">str</span>, param2: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""异步执行方法（可选）"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"异步执行结果: <span class="hljs-subst">{param1}</span>, <span class="hljs-subst">{param2}</span>"</span>
</code></pre>
<p>代码示例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========== 6. 继承 BaseTool 实现完全自定义 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""天气查询输入"""</span>
    city: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"城市名称"</span>)
    date: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"日期 (YYYY-MM-DD)，默认今天"</span>)
    unit: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"celsius"</span>, description=<span class="hljs-string">"温度单位: celsius 或 fahrenheit"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""天气查询输出"""</span>
    city: <span class="hljs-built_in">str</span>
    date: <span class="hljs-built_in">str</span>
    temperature: <span class="hljs-built_in">float</span>
    condition: <span class="hljs-built_in">str</span>
    humidity: <span class="hljs-built_in">int</span>
    wind_speed: <span class="hljs-built_in">float</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"get_weather"</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">"获取指定城市的天气信息"</span>
    args_schema: <span class="hljs-built_in">type</span>[BaseModel] = WeatherInput
    response_format: <span class="hljs-built_in">str</span> = <span class="hljs-string">"content_and_artifact"</span>

    <span class="hljs-comment"># 自定义属性</span>
    api_key: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run</span>(<span class="hljs-params">
            self,
            city: <span class="hljs-built_in">str</span>,
            date: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
            unit: <span class="hljs-built_in">str</span> = <span class="hljs-string">"celsius"</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">str</span>, WeatherOutput]:
        <span class="hljs-string">"""同步执行"""</span>
        <span class="hljs-comment"># 模拟 API 调用</span>
        date = date <span class="hljs-keyword">or</span> datetime.datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d"</span>)

        weather_data = {
            <span class="hljs-string">"北京"</span>: {<span class="hljs-string">"temp"</span>: <span class="hljs-number">25</span>, <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴天"</span>, <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>, <span class="hljs-string">"wind"</span>: <span class="hljs-number">3.5</span>},
            <span class="hljs-string">"上海"</span>: {<span class="hljs-string">"temp"</span>: <span class="hljs-number">28</span>, <span class="hljs-string">"condition"</span>: <span class="hljs-string">"多云"</span>, <span class="hljs-string">"humidity"</span>: <span class="hljs-number">60</span>, <span class="hljs-string">"wind"</span>: <span class="hljs-number">4.2</span>},
            <span class="hljs-string">"广州"</span>: {<span class="hljs-string">"temp"</span>: <span class="hljs-number">32</span>, <span class="hljs-string">"condition"</span>: <span class="hljs-string">"小雨"</span>, <span class="hljs-string">"humidity"</span>: <span class="hljs-number">75</span>, <span class="hljs-string">"wind"</span>: <span class="hljs-number">2.8</span>},
        }

        data = weather_data.get(city, {<span class="hljs-string">"temp"</span>: <span class="hljs-number">20</span>, <span class="hljs-string">"condition"</span>: <span class="hljs-string">"未知"</span>, <span class="hljs-string">"humidity"</span>: <span class="hljs-number">50</span>, <span class="hljs-string">"wind"</span>: <span class="hljs-number">3.0</span>})
        temp = data[<span class="hljs-string">"temp"</span>]

        <span class="hljs-keyword">if</span> unit == <span class="hljs-string">"fahrenheit"</span>:
            temp = temp * <span class="hljs-number">9</span> / <span class="hljs-number">5</span> + <span class="hljs-number">32</span>

        output = WeatherOutput(
            city=city,
            date=date,
            temperature=temp,
            condition=data[<span class="hljs-string">"condition"</span>],
            humidity=data[<span class="hljs-string">"humidity"</span>],
            wind_speed=data[<span class="hljs-string">"wind"</span>]
        )

        content = <span class="hljs-string">f"<span class="hljs-subst">{city}</span> <span class="hljs-subst">{date}</span>: <span class="hljs-subst">{output.condition}</span>, <span class="hljs-subst">{temp}</span>°<span class="hljs-subst">{<span class="hljs-string">'F'</span> <span class="hljs-keyword">if</span> unit == <span class="hljs-string">'fahrenheit'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'C'</span>}</span>"</span>

        <span class="hljs-keyword">return</span> content, output

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_arun</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-string">"""异步执行"""</span>
        <span class="hljs-keyword">return</span> self._run(*args, **kwargs)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_base_tool</span>():
    <span class="hljs-string">"""演示继承 BaseTool"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 示例6：继承 BaseTool 实现自定义工具"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    weather_tool = WeatherTool(api_key=<span class="hljs-string">"your-api-key"</span>)

    test_cases = [
        {<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>},
        {<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"unit"</span>: <span class="hljs-string">"fahrenheit"</span>},
        {<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>, <span class="hljs-string">"date"</span>: <span class="hljs-string">"2024-01-15"</span>}
    ]

    <span class="hljs-keyword">for</span> params <span class="hljs-keyword">in</span> test_cases:
        tool_call = {
            <span class="hljs-string">"name"</span>: weather_tool.name,
            <span class="hljs-string">"args"</span>: params,
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"call_123"</span> + params[<span class="hljs-string">"city"</span>],
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_call"</span>
        }
        result = weather_tool.invoke(tool_call)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n查询: <span class="hljs-subst">{params}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Content: <span class="hljs-subst">{result.content}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Artifact: <span class="hljs-subst">{result.artifact.model_dump()}</span>"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！]]></title>    <link>https://juejin.cn/post/7600607462584860707</link>    <guid>https://juejin.cn/post/7600607462584860707</guid>    <pubDate>2026-01-30T00:18:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600607462584860707" data-draft-id="7600600904095678498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T00:18:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:18:27.000Z" title="Fri Jan 30 2026 00:18:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    45
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在当今高并发的互联网时代，Java应用的性能优化已成为开发者必须掌握的技能。无论是应对百万级QPS的电商系统，还是处理海量数据的金融平台，性能瓶颈往往隐藏在代码的细微之处。本文将揭示5个鲜为人知但极其有效的Java性能优化"黑魔法"，这些技术源于JVM底层原理、JDK内部机制以及一线大厂的实战经验。掌握它们，你的Java应用将实现从"能跑"到"飞起"的质的飞跃。</p>
<h3 data-id="heading-2">1. 对象池化：超越GC的极限</h3>
<h4 data-id="heading-3">问题背景</h4>
<p>JVM的垃圾回收(GC)是Java著名的双刃剑。在高频创建/销毁对象的场景下（如HTTP请求处理），GC会成为性能杀手。</p>
<h4 data-id="heading-4">黑魔法实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Apache Commons Pool2示例</span>
GenericObjectPool&lt;ExpensiveObject&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasePooledObjectFactory</span>&lt;ExpensiveObject&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title function_">create</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpensiveObject</span>(); <span class="hljs-comment">// 初始化成本高的对象</span>
        }
    }
);

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">try</span> (PooledObject&lt;ExpensiveObject&gt; pooledObj = pool.borrowObject()) {
    <span class="hljs-type">ExpensiveObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> pooledObj.getObject();
    <span class="hljs-comment">// 使用obj...</span>
}
</code></pre>
<h4 data-id="heading-5">深度解析</h4>
<ul>
<li><strong>优势</strong>：避免频繁GC，对象复用率可达90%以上</li>
<li><strong>陷阱</strong>：必须确保返还的对象状态干净（参考Redis连接池的实现）</li>
<li><strong>进阶技巧</strong>：
<ul>
<li>使用ThreadLocal结合对象池实现线程级缓存</li>
<li>Netflix推荐的动态扩容策略：根据系统负载自动调整池大小</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">2. Unsafe类：绕过JVM的安全枷锁</h3>
<h4 data-id="heading-7">JVM的隐藏后门</h4>
<p><code>sun.misc.Unsafe</code>提供了直接操作内存、CAS原子操作等底层能力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SuperFastCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> offset;
    
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            offset = unsafe.objectFieldOffset(
                SuperFastCounter.class.getDeclaredField(<span class="hljs-string">"value"</span>));
        } <span class="hljs-keyword">catch</span> (Exception ex) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(ex); }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> value;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        unsafe.getAndAddLong(<span class="hljs-built_in">this</span>, offset, <span class="hljs-number">1L</span>);
    }
}
</code></pre>
<h4 data-id="heading-8">性能对比</h4>





















<table><thead><tr><th>操作方式</th><th>ops/ms (i9-13900K)</th></tr></thead><tbody><tr><td>synchronized</td><td>12,000</td></tr><tr><td>AtomicLong</td><td>48,000</td></tr><tr><td>Unsafe</td><td>65,000</td></tr></tbody></table>
<h4 data-id="heading-9">注意事项</h4>
<ul>
<li>Java模块系统限制了Unsafe的使用（可通过<code>--add-opens</code>解决）</li>
<li>Azul Zing JVM提供了更安全的替代API</li>
</ul>
<h3 data-id="heading-10">3. JMH微基准测试：发现隐藏的性能陷阱</h3>
<h4 data-id="heading-11">why JMH?</h4>
<p>传统计时方式无法避免JIT预热、死码消除等问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListBenchmark</span> {
    
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testForEach</span><span class="hljs-params">(Blackhole bh)</span> {
        List&lt;Integer&gt; list = IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>)
                                .boxed().collect(toList());
        <span class="hljs-keyword">for</span>(Integer i : list) { bh.consume(i); }
    }
    
    <span class="hljs-meta">@Benchmark</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testForLoop</span><span class="hljs-params">(Blackhole bh)</span> {
        List&lt;Integer&gt; list = IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>)
                                .boxed().collect(toList());
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;list.size(); i++) {
            bh.consume(list.get(i));
        }
    }
}
</code></pre>
<h4 data-id="heading-12">JMH揭示的真相：</h4>
<ol>
<li>ArrayList遍历时，for-index比foreach快15%（连续内存访问模式）</li>
<li>LinkedList场景完全相反（指针跳转成本）</li>
</ol>
<h3 data-id="heading-13">4. GraalVM Native Image：突破JIT天花板</h3>
<h4 data-id="heading-14">AOT编译实践：</h4>
<pre><code class="hljs language-bash" lang="bash">native-image -jar your-app.jar \
             --no-fallback \
             -H:+OptimizeForPerformance \
             -H:MaxHeapSize=2g \
             --enable-preview
</code></pre>
<h4 data-id="heading-15">Spring Boot集成：</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">Startup Time对比：</h4>




















<table><thead><tr><th>Runtime</th><th>Memory Footprint</th><th>Startup Time</th></tr></thead><tbody><tr><td>OpenJDK11</td><td>~300MB</td><td>~3s</td></tr><tr><td>Native Image</td><td>~45MB</td><td>~50ms</td></tr></tbody></table>
<p>适用场景：Serverless函数、CLI工具、K8S sidecar容器</p>
<h3 data-id="heading-17">5. Escape Analysis：让栈分配为你所用</h3>
<h4 data-id="heading-18">JIT的神奇优化：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> x, y;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> { 
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1_000_000</span>; i++) { 
            calculate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(i, i+<span class="hljs-number">1</span>)); <span class="hljs-comment">// Allocation eliminated!</span>
        } 
    } 
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(Point p)</span> { ... } 
} 
</code></pre>
<p>通过<code>-XX:+PrintEscapeAnalysis</code>查看优化日志：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">+++++ Eliminated allocation ...</span>
</code></pre>
<h4 data-id="heading-19">Stack Allocation规则：</h4>
<ol>
<li>Object不会传递到方法外部（非全局逃逸）</li>
<li>Object不会被其他线程访问（非线程逃逸）</li>
<li>Object未覆盖finalize()</li>
</ol>
<p>阿里中间件团队实测可减少30%以上的临时对象分配</p>
<h3 data-id="heading-20">CPU Cache友好编程</h3>
<h4 data-id="heading-21">False Sharing解决方案：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Contended</span> <span class="hljs-comment">// JDK8+注解（需开启-XX:-RestrictContended）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterCell</span> {
     <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> value;
}

<span class="hljs-comment">// OR手动填充：</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddedAtomicLong</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AtomicLong</span> { 
      <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> p1,p2,p3,p4,p5,p6,p7; <span class="hljs-comment">// pad to avoid false sharing </span>
}
</code></pre>
<p>Disruptor框架实测效果：</p>
<p><img alt="False Sharing对比图" src="" loading="lazy"/></p>
<h3 data-id="heading-22">JNI临界区优化技巧</h3>
<p>传统方式的问题：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processArray</span><span class="hljs-params">(JNIEnv *env, jintArray arr)</span> </span>{  
   jint *elements = env-&gt;<span class="hljs-built_in">GetIntArrayElements</span>(arr, <span class="hljs-literal">NULL</span>);
   <span class="hljs-keyword">if</span> (elements == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;
   
   <span class="hljs-comment">/* Heavy processing */</span>
   
   env-&gt;<span class="hljs-built_in">ReleaseIntArrayElements</span>(arr, elements, JNI_COMMIT); 
}  
</code></pre>
<p>改进方案——使用GetPrimitiveArrayCritical：</p>
<pre><code class="hljs language-c++" lang="c++">jint *elements = (jint *)env-&gt;<span class="hljs-built_in">GetPrimitiveArrayCritical</span>(arr, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (elements == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;

<span class="hljs-comment">/* Faster access but NO JNI calls allowed */</span>

env-&gt;<span class="hljs-built_in">ReleasePrimitiveArrayCritical</span>(arr, elements, JNI_COMMIT);
</code></pre>
<p>实测吞吐量提升40%（特别是在ARM架构）</p>
<h3 data-id="heading-23">Garbage Collector调优新思路</h3>
<p>ZGC的秘密参数：</p>
<pre><code class="hljs language-ini" lang="ini">-XX:+UseZGC \
-XX:<span class="hljs-attr">ConcGCThreads</span>=<span class="hljs-number">4</span> \      <span class="hljs-comment"># CPU核心数的1/4  </span>
-XX:<span class="hljs-attr">SoftMaxHeapSize</span>=<span class="hljs-number">32</span>G \ <span class="hljs-comment"># Elastic Heap关键  </span>
-Xms24G -Xmx24G           <span class="hljs-comment"># Fixed heap建议模式  </span>
</code></pre>
<p>关键指标监控：</p>
<pre><code class="hljs language-bash" lang="bash">jstat -gcutil &lt;pid&gt; <span class="hljs-built_in">ls</span> ns ps ys cs gcc ygc fygc cgc gct ngcmn ngcmx ngc...
</code></pre>
<p>JDK17+新增功能——弹性元空间：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MetaspaceReclaimPolicy=balanced</span> \
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+MetaspaceReclaimQuickStart</span> \
</code></pre>
<h3 data-id="heading-24">Vector API实战：SIMD加速计算</h3>
<p>JDK16预览示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">vectorComputation</span><span class="hljs-params">(<span class="hljs-type">float</span>[] a, <span class="hljs-type">float</span>[] b, <span class="hljs-type">float</span>[] c)</span> {  
   <span class="hljs-type">var</span> <span class="hljs-variable">va</span> <span class="hljs-operator">=</span> FloatVector.fromArray(FloatVector.SPECIES_256(), a, <span class="hljs-number">0</span>);  
   <span class="hljs-type">var</span> <span class="hljs-variable">vb</span> <span class="hljs-operator">=</span> FloatVector.fromArray(FloatVector.SPECIES_256(), b, <span class="hljs-number">0</span>);  
   <span class="hljs-type">var</span> <span class="hljs-variable">vc</span> <span class="hljs-operator">=</span> va.mul(va).add(vb.mul(vb)).neg();  
   vc.intoArray(c, <span class="hljs-number">0</span>);  
}  
</code></pre>
<p>与标量代码对比：</p>
<p><img alt="SIMD加速比" src="" loading="lazy"/></p>
<p>Intel AVX-512环境下矩阵运算提速8倍+</p>
<h3 data-id="heading-25">Java并发新模式：虚拟线程尝鲜</h3>
<p>Loom项目前瞻：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {     
   IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">10_000</span>).forEach(i -&gt; executor.submit(() -&gt;{
      Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));
      <span class="hljs-keyword">return</span> i;     
   }));
} <span class="hljs-comment">// Launch million threads!  </span>

<span class="hljs-comment">// Carrier threads实际数量=CPU核心数  </span>
</code></pre>
<p>与传统线程池对比：</p>
<p><img alt="虚拟线程吞吐量" src="" loading="lazy"/></p>
<p>适用于高并发IO密集型场景（如微服务网关）</p>
<hr/>
<h2 data-id="heading-26">The End</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“能用”到“会用”｜如何写好一个 Skill]]></title>    <link>https://juejin.cn/post/7600791597168525355</link>    <guid>https://juejin.cn/post/7600791597168525355</guid>    <pubDate>2026-01-30T02:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600791597168525355" data-draft-id="7600705405595680831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“能用”到“会用”｜如何写好一个 Skill"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-30T02:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“能用”到“会用”｜如何写好一个 Skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:46:58.000Z" title="Fri Jan 30 2026 02:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9c0d4f435e6430bbe05365a720ccfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=EnVG%2Fo7Afg%2BjIrUumxfjzeeaoBM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：Jiaqi，TRAE 技术文档工程师</p>
</blockquote>
<p>之前带大家了解了 Skill 的原理和应用，本文继续带领大家从“能用”到“会用”，如何写好一个 Skill 至关重要。</p>
<p>本文为 Skill 设计与开发的一站式最佳实践指南，可助力你：</p>
<ul>
<li>
<p>系统厘清 Skill 的定义，规避常见认知误区；</p>
</li>
<li>
<p>熟练掌握高命中率、高稳定性 Skill 的设计标准与核心原则；</p>
</li>
<li>
<p>掌握 “评测驱动、失败优先” 的工程化 Skill 构建与迭代全流程；</p>
</li>
<li>
<p>掌握可维护、可扩展的 Skill 设计技巧；</p>
</li>
<li>
<p>依托 AI 高效完成 Skill 的创建、迭代与优化；</p>
</li>
<li>
<p>凭借反模式检查清单，精准规避 Skill 开发中的典型问题。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925c335469a84e45b9fc343d9d93c2e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=ycqzZY6cdm9Et6BSGzR615Xm0k4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是 Skill ？</strong></h2>
<h3 data-id="heading-1"><strong>定义</strong></h3>
<p>一个 Skill 是一份清晰、严谨、可执行的指令文档，用于明确告诉模型——在什么条件下（When），按照哪些步骤（How），产出什么结果（What）。</p>
<h3 data-id="heading-2"><strong>常见认知误区</strong></h3>
<p>在编写 Skill 之前，建议先了解以下几个常见误区。这些问题往往会直接导致 Skill 难以被正确触发，或在执行过程中表现不稳定。</p>
<h4 data-id="heading-3"><strong>误区一：Skill 等同于一段 Prompt</strong></h4>
<p>Skill 并不是一次性的对话提示。它是一个可长期复用、输入输出明确的能力模块，强调的是稳定、确定且易于工程化维护。而 Prompt 更偏向临时性、探索性和即兴交互，两者在设计目标和工程要求上完全不同。</p>
<h4 data-id="heading-4"><strong>误区二：Skill 是写给人看的文档</strong></h4>
<p>Skill 的目标不是“解释原理”，而是“下达指令”。<em><strong>SKILL.md</strong></em> 文件的内容应使用模型可解析的结构化语言，明确约束其行为边界，并精确描述何时使用（When）、如何执行（How）、输出结果（What）。</p>
<h4 data-id="heading-5"><strong>误区三：Skill 越复杂越强大</strong></h4>
<p>复杂度并不与 Skill 的能力强度挂钩。模型的推理与决策成本是显著的。职责单一、边界清晰的 Skill，更容易在正确的时机被选中并稳定执行。过于复杂的 Skill 反而会降低命中率。</p>
<blockquote>
<p><strong>提示</strong></p>
<p>模型的上下文窗口是有限且宝贵的公共资源。每一个被加载的 Skill 都在竞争有限的上下文资源。因此，Skill 文档应以最小必要信息为目标，避免冗余解释与不必要的背景铺垫。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f9fd9d99d4047fa8df1e73e23df891c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=uDLhWnSoobz5eZoAjTmk8YL%2BmDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Skill 的设计标准与原则</strong></h2>
<p>以下标准是构建高命中率、高稳定性 Skill 的基础。可将其作为设计与评审 Skill 时的检查清单。</p>
<h3 data-id="heading-7"><strong>精准的元数据内容</strong></h3>
<p>Skill 的元数据（name 和 description）是模型发现和识别 Skill 的入口，其设计直接影响触发准确率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53534cd0028341789f32667c4427b688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=YOgSk2PwZtiIGJDAormvbgAGyfE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>指导方式的自由度分级</strong></h3>
<p>根据任务复杂度与容错要求，合理控制对模型的约束强度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc1d5de6fd847b2b5dbf8b68923f31d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=IyvLxWY9rbntzp6XCvirBaSUV6U%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b641e70e0e4917b62abf1f3c6a1263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=k8mmW9gcXOzIXm5XdeflXRSmw1o%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc3071a12bc450bb88de44cca330f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=BMRsq4GG52LqbCzOp6mbk0nWA8k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>五个核心标准</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d624809950da4cd7b3a3cd97aa59cbc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=SCKvYQOUGryiT1G91F0G5r4K8q4%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb9b5ff3cd246038a73415d07af4a56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=fNs8IAyTWdP0mlCiJV7ba%2FUyNCU%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8a10f6a22b7449fb81436025c675cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=WOsFr0%2F%2BeAf%2B3e9bUdIze6U5CsE%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d69e9c2c6643409a36c1574ce343c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=Zf2VKaN41J0lDfMMi2VtmrJIYps%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d391f9bcc214bfd9e5770929c104d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=chGm%2FO9oemdfLk5DIg5FLn30Tow%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>构建与迭代 Skill 的最佳流程</strong></h2>
<p>Skill 的开发是一个以失败为起点、评测为牵引，持续迭代优化的工程化过程。</p>
<p>评测并非事后的验证环节，而是 Skill 设计的前提；Skill 也非基于假设的规则集合，而是针对已暴露问题的最小化解决方案。</p>
<p>遵循 “评测驱动、失败优先” 的原则，能确保 Skill 在实际使用场景中拥有清晰的能力边界、稳定的运行表现，以及可回归的质量保障体系。</p>
<h3 data-id="heading-11"><strong>第一步：建立无 Skill 基线，识别真实问题</strong></h3>
<p>在编写任何 Skill 之前，应先不使用 Skill，直接让模型执行目标任务，作为基线对照。</p>
<p>重点观察并记录以下问题：</p>
<ul>
<li>
<p>模型在哪些情况下表现不稳定或结果不可复现；</p>
</li>
<li>
<p>哪些输入会引发歧义、误解或走偏；</p>
</li>
<li>
<p>模型是否在错误的时机尝试“主动帮忙”。</p>
</li>
</ul>
<p>这些失败点和不确定行为，本质上就是 Skill 需要解决的真实能力缺口，也是后续评测用例的来源。</p>
<h3 data-id="heading-12"><strong>第二步：以“失败优先”为原则，定义评测用例</strong></h3>
<p>明确核心问题后，需优先编写评测用例，而非直接开发 Skill。评测是约束，Skill 是落地实现。脱离评测约束的 Skill，本质上是在放大模型的行为不确定性。</p>
<p>评测的核心作用是约束 Skill 的行为边界，明确以下信息：</p>
<ul>
<li>
<p>什么场景下属于 Skill 的正确使用范围？</p>
</li>
<li>
<p>什么场景下 Skill 必须拒绝执行或判定为失败？</p>
</li>
<li>
<p>什么样的输出结果才算稳定可用？</p>
</li>
</ul>
<p>推荐做法：</p>
<ul>
<li>
<p>针对已识别的问题，设计 3–5 个具体、可复现的评测用例；</p>
</li>
<li>
<p>每个用例均需明确 “通过 / 失败” 的判定标准；</p>
</li>
<li>
<p>优先覆盖模型最易误用 Skill 的场景。</p>
</li>
</ul>
<h3 data-id="heading-13"><strong>第三步：编写最小化 Skill，明确最短成功路径</strong></h3>
<p>在评测已经存在的前提下，开始编写 Skill。</p>
<p>此阶段不追求覆盖所有情况，而是只编写刚好能够通过当前评测的最小规则集合，重点关注三个要素：</p>
<ul>
<li>
<p><strong>明确失败条件（When NOT to use）</strong></p>
<p>将评测中识别的失败场景，显式写入 Skill 中，作为第一层防护，避免 Skill 被误触发或滥用。</p>
</li>
<li>
<p><strong>定义最短成功路径</strong></p>
<p>清晰描述 Skill 最简单、最核心的执行流程，确保最精简的有效输入能得到可预测的稳定输出。</p>
</li>
<li>
<p><strong>保持职责单一</strong></p>
<p>单个 Skill 仅解决一个明确问题，对应一个核心动作，避免在早期引入额外复杂度。</p>
</li>
</ul>
<p>这一阶段的 Skill，是评测结果的直接产物，而非凭经验预判的方案。</p>
<h3 data-id="heading-14"><strong>第四步：补充边界条件与结构化示例</strong></h3>
<p>当最短成功路径能稳定通过评测后，再逐步扩展 Skill 的适用范围。</p>
<p>完成以下三项核心工作：</p>
<ul>
<li>
<p>补充更多边界场景及对应的行为约束；</p>
</li>
<li>
<p>明确 Skill 输入（Input）、输出（Output）的结构化定义；</p>
</li>
<li>
<p>补充关键的输入、输出示例，帮助模型对齐行为预期。</p>
</li>
</ul>
<p><strong>核心原则：</strong> 所有新增规则，均需对应新增或已有评测用例，避免在无评测支撑的情况下将 Skill 复杂化。</p>
<h3 data-id="heading-15"><strong>第五步：评测回归与持续迭代</strong></h3>
<p>Skill 的迭代，需始终与评测结果强绑定，遵循以下规则：</p>
<ul>
<li>
<p>新增评测用例 → 推动 Skill 的增量修改；</p>
</li>
<li>
<p>任意修改 Skill → 必须通过已有评测的回归验证；</p>
</li>
<li>
<p>若评测未通过，优先简化 Skill，而非盲目叠加新规则。</p>
</li>
</ul>
<p>通过持续对比模型在 “无 Skill 基线” 与 “当前 Skill + 评测” 中的表现，可验证该 Skill 是否真正提升了模型执行目标任务的成功率与稳定性。</p>
<h3 data-id="heading-16"><strong>第六步：结合真实使用路径进行校准</strong></h3>
<p>评测仅能覆盖已知问题，在真实场景中使用 Skill 时，可能会暴露更多新的问题。</p>
<p>在 Skill 实际使用过程中，需持续观察以下情况：</p>
<ul>
<li>
<p>模型是否在非预期场景下误触发 Skill？</p>
</li>
<li>
<p>模型执行 Skill 时，是否遗漏关键参考文件或上下文？</p>
</li>
<li>
<p>模型是否会反复读取某一段内容，形成隐性依赖？</p>
</li>
</ul>
<p>上述这些信号，均需作为新的评测输入，重新进入 Step 2，形成 Skill 迭代的闭环。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d6496cadbc45959bca9dc12167b952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=kcFreYXQ%2FmdWP%2BvqH%2F9CTAzvFiM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>让 Skill 可维护与可拓展</strong></h2>
<h3 data-id="heading-18"><strong>渐进式披露</strong></h3>
<p><em><strong>SKILL.md</strong></em> 应当作为 Skill 的入口和导航，而不是一个包罗万象的大文件。详细的参考资料、示例、脚本或文档应拆分成独立文件，从而减轻模型初次加载的负担，让信息按需流动。</p>
<h4 data-id="heading-19"><strong>信息架构原则：从简单到复杂</strong></h4>
<p>​一个 Skill 的目录可以随着功能扩展逐步演化：从单一文件 → 多个参考文件和脚本组成的结构。通过渐进式披露，模型能快速抓住核心信息，再深入了解细节。</p>
<h4 data-id="heading-20"><strong>最佳实践</strong></h4>
<ul>
<li>
<p><strong>保持 SKILL.md 简洁：</strong> 主体内容尽量控制在 500 行以内，只包含必要信息。</p>
</li>
<li>
<p><strong>避免深度嵌套：</strong> 所有引用文件最好直接由 <em><strong>SKILL.md</strong></em> 链接，保持一层引用深度，避免链式引用（A → B → C），防止模型只读取部分内容。</p>
</li>
<li>
<p><strong>为长文件添加目录：</strong> 对于超过 100 行的参考文件，在文件顶部添加一个目录（Table of Contents），帮助模型快速了解文件结构。</p>
</li>
</ul>
<h4 data-id="heading-21"><strong>示例</strong></h4>
<p>以下为一个渐进式披露的 SKILL.md 示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># SKILL.md</span>

<span class="hljs-section">## 基础用法</span>
描述如何触发 CI/CD 流水线：
<span class="hljs-bullet">-</span> 检查 PR 状态
<span class="hljs-bullet">-</span> 执行单元测试
<span class="hljs-bullet">-</span> 更新 PR 测试状态

<span class="hljs-section">## 高级功能</span>
详细说明请参见 <span class="hljs-code">`ci-advanced-features.md`</span>：
<span class="hljs-bullet">-</span> 并行执行多分支测试
<span class="hljs-bullet">-</span> 条件触发不同类型的测试
<span class="hljs-bullet">-</span> 自定义失败处理策略

<span class="hljs-section">## API 参考</span>
所有方法与参数说明请参见 <span class="hljs-code">`ci-api-reference.md`</span>：
<span class="hljs-bullet">-</span> startPipeline(prId: string, branch: string)
<span class="hljs-bullet">-</span> getPipelineStatus(pipelineId: string)
<span class="hljs-bullet">-</span> cancelPipeline(pipelineId: string)
</code></pre>
<h3 data-id="heading-22"><strong>工作流与反馈闭环</strong></h3>
<p>对于包含多个步骤、且中间结果会影响最终质量的复杂任务，仅提供最终目标是不够的。必须显式定义工作流（Workflow）和 检查清单（Checklist），引导模型按步骤执行，并在关键节点建立 “验证 → 修正 → 再验证” 的反馈闭环。</p>
<p>工作流负责约束任务执行顺序，检查清单负责追踪任务的执行状态和质量。两者结合可以显著降低遗漏和跑偏的风险。</p>
<h4 data-id="heading-23"><strong>分析类任务的工作流</strong></h4>
<p>即使不涉及代码，分析类任务同样适合使用工作流。 检查清单可以帮助模型明确“当前做到哪一步”、“是否可以进入下一步”。例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">## 技术方案评估工作流

在开始执行前复制以下清单，并在每一步完成后显式标记状态。

- <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>：明确业务目标与技术约束（性能、成本、时限）
- <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>：列出所有可行的技术方案
- <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>：从复杂度、可维护性、风险角度逐一评估
- <span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>：对关键差异点进行对比分析；(反馈闭环) 若发现关键信息不足，应返回 <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span> 或 <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span> 补充分析
- <span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>：给出结论性建议，并说明取舍理由；(反馈闭环) 若结论无法支撑目标约束，应重新审视 <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span> 的前提条件
</code></pre>
<h4 data-id="heading-24"><strong>代码类任务的工作流</strong></h4>
<p>​代码类任务往往伴随不可逆或影响范围较大的操作，例如重构、依赖升级或配置变更。通过 “Plan → Validate → Execute” 模式，可以有效降低误操作风险。例如：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 依赖版本升级工作流</span>

<span class="hljs-bullet">-</span> Step 1（Plan）：
<span class="hljs-bullet">  -</span> 识别需要升级的依赖及当前版本
<span class="hljs-bullet">  -</span> 阅读目标版本的 Release Notes 与 Breaking Changes
<span class="hljs-bullet">-</span> Step 2（Plan）：
<span class="hljs-bullet">  -</span> 更新依赖配置文件（如 package.json / go.mod）
<span class="hljs-bullet">  -</span> 标注可能受影响的模块
<span class="hljs-bullet">-</span> Step 3（Validate）：
<span class="hljs-bullet">-</span> 执行依赖冲突检查与静态构建（运行 dependency<span class="hljs-emphasis">_check.sh）
  - 确认无版本冲突或构建失败
  - (反馈闭环) 若校验失败，必须回退到 Step 2 调整依赖配置
- Step 4（Execute）：
  - 安装新版本依赖
  - 运行完整测试集
- Step 5（Validate）：
  - 检查核心功能是否受影响
  - 对比升级前后的构建与运行结果
  - (反馈闭环) 若出现回归问题，应回滚升级并记录风险点
</span></code></pre>
<h3 data-id="heading-25"><strong>可执行脚本的加固原则</strong></h3>
<p>当 Skill 依赖可执行脚本时，脚本的健壮性应始终优先于代码的巧妙性。</p>
<p>Skill 本身不会理解或阅读你的代码逻辑，它只感知输入与输出。一旦脚本行为不可预测，模型就只能猜测，最终导致不稳定或错误的调用结果。因此，脚本必须做到：失败可预期、输出可理解、参数可解释。</p>
<h4 data-id="heading-26"><strong>显式处理错误，而不是让模型猜</strong></h4>
<p>不要将异常直接抛给模型处理。脚本应覆盖常见错误场景，并将技术异常转化为可理解、可决策的输出。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>捕获常见异常（如文件缺失、权限不足、配置错误）</p>
</li>
<li>
<p>为每类错误返回清晰的错误原因和下一步建议</p>
</li>
</ul>
<p><strong>示例：</strong> 配置文件校验脚本</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ERROR:</span> Config file <span class="hljs-built_in">not</span> found: ./deploy.yaml
<span class="hljs-symbol">HINT:</span> Please check whether the file path <span class="hljs-built_in">is</span> correct <span class="hljs-built_in">or</span> run init-config.sh <span class="hljs-keyword">to</span> generate a <span class="hljs-keyword">default</span> config.
</code></pre>
<h4 data-id="heading-27"><strong>输出自解释的日志与验证结果</strong></h4>
<p>脚本的输出本身就是模型的“上下文”。一个好的脚本不仅说明发生了什么，还说明为什么会这样，以及接下来可以怎么做。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>成功路径和失败路径都要有明确输出</p>
</li>
<li>
<p>验证类脚本应明确列出通过项与失败项</p>
</li>
</ul>
<p><strong>示例：</strong> 构建环境检查脚本</p>
<pre><code class="hljs language-markdown" lang="markdown">CHECK FAILED: Node.js version mismatch
<span class="hljs-bullet">-</span> Required: &gt;= 18.0.0
<span class="hljs-bullet">-</span> Detected: 16.14.0

VALID OPTIONS:
<span class="hljs-bullet">1.</span> Upgrade Node.js to a supported version
<span class="hljs-bullet">2.</span> Switch to a compatible build image
</code></pre>
<h4 data-id="heading-28"><strong>避免魔法数字，让参数“有来由”</strong></h4>
<p>脚本中的常量（如 <em><strong>TIMEOUT = 30</strong></em>）如果缺乏解释，模型和人都无法判断它是否合理。任何影响行为的数值，都应该是可解释、可调整的。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>为常量添加语义化名称</p>
</li>
<li>
<p>说明数值来源或设计依据</p>
</li>
<li>
<p>必要时允许通过参数覆盖默认值</p>
</li>
</ul>
<p><strong>示例：</strong> 部署等待脚本</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">TIMEOUT_SECONDS</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># Wait up to 30s because service startup usually completes within 10–20s</span>
</code></pre>
<p>或在输出中体现：</p>
<pre><code class="hljs language-rust" lang="rust">INFO: Waiting <span class="hljs-keyword">for</span> <span class="hljs-title class_">service</span> to <span class="hljs-keyword">become</span> <span class="hljs-title function_ invoke__">healthy</span> (timeout: <span class="hljs-number">30</span>s)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0086657e4fc4b938f0676a145dfc9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=2Vt0GyoX2JxUwMqALNQawCWmxZU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-29"><strong>巧妙使用 AI 来创建和迭代 Skill</strong></h2>
<p>在创建和迭代 Skill 的过程中，可以多用 AI。你负责定义问题和验收结果，AI 负责反复试错、总结规律并封装成可复用的 Skill。</p>
<h3 data-id="heading-30"><strong>阶段一：初次创建（从具体任务中抽象）</strong></h3>
<p>让 AI 从真实任务中抽象出创建 Skill 所需的信息，然后创建初版 Skill。</p>
<p><strong>1. 让 AI 直接执行真实任务</strong></p>
<p>提供完整目标与上下文，让 AI 自行尝试完成任务。执行过程中的追问、走偏和修正，本质上就是一次“隐式评测”。</p>
<p><strong>2. 引导 AI 进行结构化复盘</strong></p>
<p>任务完成后，要求 AI 从以下维度复盘：</p>
<ul>
<li>
<p>成功执行任务的完整步骤；</p>
</li>
<li>
<p>任务执行过程中的不确定性与失败点；</p>
</li>
<li>
<p>可抽象的固定流程与判断逻辑；</p>
</li>
<li>
<p>该流程和判断逻辑的适用场景与不适用场景。</p>
</li>
</ul>
<p><strong>3. 基于复盘生成 Skill 初稿</strong></p>
<p>要求 AI 按 Skill 规范生成 SKILL.md，明确：触发条件（When）、如何执行（How）、输出结果（What）、预设失败策略。</p>
<p><strong>4. 人工快速评审并入库</strong></p>
<p>你只需关注边界是否合理、步骤是否可执行，其余交由 AI 完成。确认后，让 AI 调用 skills-creator 正式创建该 Skill 并添加至你的项目。</p>
<h3 data-id="heading-31"><strong>阶段二：持续迭代（从使用反馈中优化）</strong></h3>
<p>当 Skill 在使用中暴露新问题时，对其进行优化。</p>
<p><strong>1. 对齐偏差来源</strong></p>
<p>引导 AI 分析问题源自 When / What / How 中的哪一部分。</p>
<p><strong>2. 直接修改 Skill 并验证回归</strong></p>
<p>更新 <em><strong>SKILL.md</strong></em>，并同时验证：</p>
<ul>
<li>
<p>确保本次迭代未破坏原有的“黄金路径”。</p>
</li>
<li>
<p>确保新发现的错误场景已被覆盖。</p>
</li>
</ul>
<h3 data-id="heading-32"><strong>在 TRAE 中创建 Skill 的其他方式</strong></h3>
<p>除了通过 AI 对话创建 Skill 外，你还以手动创建或导入外部 Skill。详细说明点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trae.cn%2Fide%2Fskills%238be9a856" target="_blank" title="https://docs.trae.cn/ide/skills#8be9a856" ref="nofollow noopener noreferrer">docs.trae.cn/ide/skills#…</a> 参考官网文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079af5a4818e47c0abe69194cf5b2ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=sFYVsv%2B6UlM299EIXgHtazNh9%2BI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-33"><strong>附录：反模式检查清单</strong></h2>
<p>本表列出了在 Skill 开发中常见的反模式（Anti-Patterns），以及相应的原因、正确示例和错误示例。通过遵循这些规范，可以提升 Skill 的稳定性、可维护性和跨平台兼容性，避免模型误用或运行失败。</p>
<p>该 Checklist 可作为开发、评审和迭代 Skill 时的快速参考指南。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50126de01144477b68e1e339e618485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=%2B5t%2FNmIBG5pQxC%2FXhVVOD0SYUeg%3D" alt="" loading="lazy"/></p>
<p><strong>参考资料</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第10章、Go语言的抽象之美-接口与多态]]></title>    <link>https://juejin.cn/post/7600684978352652315</link>    <guid>https://juejin.cn/post/7600684978352652315</guid>    <pubDate>2026-01-30T00:37:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600684978352652315" data-draft-id="7600675515150090267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第10章、Go语言的抽象之美-接口与多态"/> <meta itemprop="keywords" content="后端,Go,编程语言"/> <meta itemprop="datePublished" content="2026-01-30T00:37:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第10章、Go语言的抽象之美-接口与多态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:37:26.000Z" title="Fri Jan 30 2026 00:37:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 上一章我们掌握了Go语言面向对象的基础——结构体与方法。今天，我们将深入Go抽象编程的核心——<strong>接口（interface）<strong>与</strong>多态</strong>。</p>
<p>不同于Java、C++的“显式接口实现”，Go的接口采用<strong>隐式实现机制</strong>，无需显式声明“implements”，只要类型满足接口的方法集，就自动实现了该接口。这种设计让代码更简洁、灵活，也完美诠释了Go“少即是多”的哲学。</p>
<p>本文将严格按照目录逐节拆解，从接口的基本定义到大型项目的分层应用，每个知识点都配套<strong>可直接运行的代码示例</strong>，同时补充官方文档、实战技巧和避坑指南。无论是入门者还是有经验的开发者，都能从中理清接口的核心逻辑，掌握多态的落地技巧。话不多说，开始正文～</p>
<h2 data-id="heading-0">一、接口的定义与隐式实现机制</h2>
<p>接口是Go语言中的“抽象类型”，它只定义“方法签名”（方法名、参数列表、返回值列表），不包含方法实现，也不存储数据。核心作用是<strong>定义行为规范</strong>，实现不同类型的“行为抽象”，为多态提供基础。</p>
<h3 data-id="heading-1">1.1 接口的基本定义语法</h3>
<p>接口通过<code>type</code>关键字+接口名+<code>interface</code>关键字定义，内部是方法签名列表：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">type</span> 接口名 <span class="hljs-keyword">interface</span> {
    方法名<span class="hljs-number">1</span>(参数列表<span class="hljs-number">1</span>) (返回值列表<span class="hljs-number">1</span>)
    方法名<span class="hljs-number">2</span>(参数列表<span class="hljs-number">2</span>) (返回值列表<span class="hljs-number">2</span>)
    <span class="hljs-comment">// ... 更多方法签名</span>
}

</code></pre>
<p>核心规则（必须掌握）：</p>
<ul>
<li>
<p>接口名通常以“er”结尾（如Reader、Writer），表示“具备某种行为的类型”；</p>
</li>
<li>
<p>方法签名必须完全匹配（方法名、参数类型、返回值类型完全一致）；</p>
</li>
<li>
<p>接口中不能包含字段，也不能包含方法实现；</p>
</li>
<li>
<p>空接口（<code>interface{}</code>）没有任何方法签名，所有类型都实现了空接口。</p>
</li>
</ul>
<h3 data-id="heading-2">1.2 核心特性：隐式实现机制</h3>
<p>这是Go接口最独特的设计——<strong>无需显式声明实现接口</strong>。只要一个类型的方法集“包含”了接口的所有方法签名（方法名、参数、返回值完全匹配），这个类型就“自动实现”了该接口。</p>
<p>这种机制的优势：</p>
<ul>
<li>
<p>解耦接口定义与实现：接口可以在不同包中定义，实现类型无需引入接口包；</p>
</li>
<li>
<p>灵活扩展：新增接口实现时，无需修改原有代码；</p>
</li>
<li>
<p>代码简洁：避免了显式声明的冗余代码。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 代码示例：接口的定义与隐式实现</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// Speaker 定义接口：具备“说话”行为的类型</span>
<span class="hljs-keyword">type</span> Speaker <span class="hljs-keyword">interface</span> {
    Speak() <span class="hljs-type">string</span> <span class="hljs-comment">// 方法签名：无参数，返回string</span>
}

<span class="hljs-comment">// Person 人结构体</span>
<span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> {
    Name <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Speak 实现Speaker接口的Speak方法（隐式实现）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> Speak() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"大家好，我是%s"</span>, p.Name)
}

<span class="hljs-comment">// Dog 狗结构体</span>
<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> {
    Breed <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Speak 实现Speaker接口的Speak方法（隐式实现）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> Speak() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"我是%s，汪汪汪～"</span>, d.Breed)
}

<span class="hljs-comment">// 测试函数：接收Speaker接口类型参数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSpeak</span><span class="hljs-params">(s Speaker)</span></span> {
    fmt.Println(s.Speak())
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    p := Person{Name: <span class="hljs-string">"小明"</span>}
    d := Dog{Breed: <span class="hljs-string">"金毛"</span>}

    <span class="hljs-comment">// Person和Dog都隐式实现了Speaker，可直接传入TestSpeak</span>
    TestSpeak(p) <span class="hljs-comment">// 输出：大家好，我是小明</span>
    TestSpeak(d) <span class="hljs-comment">// 输出：我是金毛，汪汪汪～</span>
}

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>Person和Dog都没有显式声明“implements Speaker”，但因为都实现了Speak() string方法，所以自动实现了Speaker接口；</p>
</li>
<li>
<p>TestSpeak函数接收Speaker接口类型参数，可接收任何实现了该接口的类型（Person、Dog），这就是多态的核心体现。</p>
</li>
</ul>
<h3 data-id="heading-4">1.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Interface_types" target="_blank" title="https://go.dev/ref/spec#Interface_types" ref="nofollow noopener noreferrer">Interface Types</a></p>
</li>
<li>
<p>Go官方博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Flaws-of-reflection" target="_blank" title="https://go.dev/blog/laws-of-reflection" ref="nofollow noopener noreferrer">The Laws of Reflection（接口与反射）</a></p>
</li>
</ul>
<h2 data-id="heading-5">二、空接口interface{}与泛型替代</h2>
<p>空接口（<code>interface{}</code>）是最特殊的接口——它没有任何方法签名。根据Go的接口隐式实现规则，<strong>所有类型都默认实现了空接口</strong>。因此，空接口可以存储任何类型的值，常被用于“接收任意类型参数”的场景。</p>
<h3 data-id="heading-6">2.1 空接口的基本使用</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// PrintAny 接收空接口参数，可打印任意类型的值</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintAny</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>{})</span></span> {
    fmt.Printf(<span class="hljs-string">"类型：%T，值：%v\n"</span>, v, v)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    PrintAny(<span class="hljs-number">100</span>)          <span class="hljs-comment">// 输出：类型：int，值：100</span>
    PrintAny(<span class="hljs-string">"Hello Go"</span>)   <span class="hljs-comment">// 输出：类型：string，值：Hello Go</span>
    PrintAny(<span class="hljs-literal">true</span>)         <span class="hljs-comment">// 输出：类型：bool，值：true</span>
    PrintAny([]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}) <span class="hljs-comment">// 输出：类型：[]int，值：[1 2 3]</span>
    PrintAny(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{<span class="hljs-string">"name"</span>: <span class="hljs-string">"小明"</span>}) <span class="hljs-comment">// 输出：类型：map[string]string，值：map[name:小明]</span>
}

</code></pre>
<p>空接口的核心特点：</p>
<ul>
<li>
<p>可以存储任何类型的值，但存储的是“类型+值”的组合（即“接口值”的结构）；</p>
</li>
<li>
<p>空接口本身不提供任何方法，无法直接操作内部值，必须通过“类型断言”获取原始类型后才能操作；</p>
</li>
<li>
<p>早期Go版本（1.17之前）没有泛型，空接口是实现“通用功能”的主要方式（如fmt包的Print系列函数）。</p>
</li>
</ul>
<h3 data-id="heading-7">2.2 空接口的局限性与泛型替代</h3>
<p>空接口虽然灵活，但存在明显局限性：</p>
<ul>
<li>
<p><strong>类型不安全</strong>：编译期无法检查类型，必须在运行时通过类型断言判断，容易出现类型错误；</p>
</li>
<li>
<p><strong>性能损耗</strong>：空接口存储需要额外的类型信息，且类型断言会带来运行时开销；</p>
</li>
<li>
<p><strong>代码冗余</strong>：使用前必须手动进行类型判断和转换，代码可读性差。</p>
</li>
</ul>
<p>Go 1.18引入**泛型（Generics）**后，大部分空接口的场景都可以用泛型替代，实现“类型安全的通用功能”。</p>
<h3 data-id="heading-8">2.3 代码示例：泛型替代空接口</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 泛型版本：定义类型参数T，可接收任意类型</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintAnyGeneric</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(v T)</span></span> {
    fmt.Printf(<span class="hljs-string">"类型：%T，值：%v\n"</span>, v, v)
}

<span class="hljs-comment">// 泛型版本：求切片元素之和（限制T为数值类型）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SumSlice</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span> | <span class="hljs-title">int64</span> | <span class="hljs-title">float64</span>]<span class="hljs-params">(s []T)</span></span> T {
    <span class="hljs-keyword">var</span> sum T
    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> s {
        sum += v
    }
    <span class="hljs-keyword">return</span> sum
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 泛型实现通用打印，与空接口效果一致，但类型安全</span>
    PrintAnyGeneric(<span class="hljs-number">100</span>)
    PrintAnyGeneric(<span class="hljs-string">"Hello Go"</span>)

    <span class="hljs-comment">// 泛型实现切片求和，编译期检查类型</span>
    intSlice := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>}
    fmt.Println(<span class="hljs-string">"int切片和："</span>, SumSlice(intSlice)) <span class="hljs-comment">// 输出：int切片和：10</span>

    floatSlice := []<span class="hljs-type">float64</span>{<span class="hljs-number">1.1</span>,<span class="hljs-number">2.2</span>,<span class="hljs-number">3.3</span>}
    fmt.Println(<span class="hljs-string">"float64切片和："</span>, SumSlice(floatSlice)) <span class="hljs-comment">// 输出：float64切片和：6.6</span>

    <span class="hljs-comment">// 错误：string类型不满足SumSlice的类型约束</span>
    <span class="hljs-comment">// strSlice := []string{"a","b"}</span>
    <span class="hljs-comment">// fmt.Println(SumSlice(strSlice))</span>
}

</code></pre>
<p>空接口与泛型的选择建议：</p>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>接收任意类型参数（无类型约束）</td><td>泛型（T any）</td><td>类型安全，编译期检查，性能更优</td></tr><tr><td>接收特定类型集合（如数值类型、可比较类型）</td><td>泛型（带类型约束）</td><td>精准限制类型，避免运行时错误</td></tr><tr><td>Go版本&lt;1.18</td><td>空接口</td><td>无泛型支持，只能用空接口实现通用功能</td></tr><tr><td>反射场景（如序列化/反序列化）</td><td>空接口</td><td>反射需要依赖空接口的类型信息</td></tr></tbody></table>
<h3 data-id="heading-9">2.4 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23The_empty_interface" target="_blank" title="https://go.dev/ref/spec#The_empty_interface" ref="nofollow noopener noreferrer">The empty interface</a></p>
</li>
<li>
<p>Go泛型官方教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Ftutorial%2Fgenerics" target="_blank" title="https://go.dev/doc/tutorial/generics" ref="nofollow noopener noreferrer">Generics Tutorial</a></p>
</li>
</ul>
<h2 data-id="heading-10">三、类型断言与类型安全检查</h2>
<p>当我们将一个具体类型的值存储到接口中后，接口只知道该类型实现了接口的方法，无法直接获取原始类型的信息。这时需要通过**类型断言（Type Assertion）**来“提取”接口中的原始类型值，实现对原始类型的操作。</p>
<h3 data-id="heading-11">3.1 类型断言的基本语法</h3>
<p>类型断言有两种基本格式：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 格式1：不检查错误（如果断言失败，会触发panic）</span>
value := 接口变量.(目标类型)

<span class="hljs-comment">// 格式2：检查错误（推荐使用）</span>
value, ok := 接口变量.(目标类型)
<span class="hljs-comment">// ok为bool类型：true表示断言成功，false表示断言失败（不会panic）</span>

</code></pre>
<h3 data-id="heading-12">3.2 代码示例：类型断言的使用与安全检查</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-keyword">type</span> Speaker <span class="hljs-keyword">interface</span> {
    Speak() <span class="hljs-type">string</span>
}

<span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> {
    Name <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> Speak() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"我是%s"</span>, p.Name)
}

<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> {
    Breed <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> Speak() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"我是%s"</span>, d.Breed)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> s Speaker

    <span class="hljs-comment">// 1. 存储Person类型到接口</span>
    s = Person{Name: <span class="hljs-string">"小明"</span>}

    <span class="hljs-comment">// 安全断言：检查是否为Person类型</span>
    <span class="hljs-keyword">if</span> p, ok := s.(Person); ok {
        fmt.Println(<span class="hljs-string">"断言成功，Person姓名："</span>, p.Name) <span class="hljs-comment">// 输出：断言成功，Person姓名： 小明</span>
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"断言失败，不是Person类型"</span>)
    }

    <span class="hljs-comment">// 2. 存储Dog类型到接口</span>
    s = Dog{Breed: <span class="hljs-string">"金毛"</span>}

    <span class="hljs-comment">// 不安全断言：不检查错误（如果失败会panic）</span>
    <span class="hljs-comment">// d := s.(Person) // 运行时panic：interface conversion: main.Dog is not main.Person: missing method Speak? No, 类型不匹配</span>

    <span class="hljs-comment">// 安全断言：检查是否为Dog类型</span>
    <span class="hljs-keyword">if</span> d, ok := s.(Dog); ok {
        fmt.Println(<span class="hljs-string">"断言成功，Dog品种："</span>, d.Breed) <span class="hljs-comment">// 输出：断言成功，Dog品种： 金毛</span>
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"断言失败，不是Dog类型"</span>)
    }

    <span class="hljs-comment">// 3. 断言到未实现的类型</span>
    <span class="hljs-keyword">if</span> str, ok := s.(<span class="hljs-type">string</span>); ok {
        fmt.Println(<span class="hljs-string">"是string类型："</span>, str)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"断言失败，不是string类型"</span>) <span class="hljs-comment">// 输出：断言失败，不是string类型</span>
    }
}
</code></pre>
<h3 data-id="heading-13">3.3 常见场景：接口值的类型判断</h3>
<p>类型断言常用于以下场景：</p>
<ul>
<li>
<p><strong>空接口值的类型还原</strong>：当函数接收空接口参数时，通过类型断言还原原始类型；</p>
</li>
<li>
<p><strong>接口实现的类型区分</strong>：当一个接口有多个实现类型时，通过类型断言区分不同类型并执行差异化逻辑；</p>
</li>
<li>
<p><strong>扩展接口功能</strong>：当需要调用原始类型特有的方法（非接口方法）时，通过类型断言获取原始类型。</p>
</li>
</ul>
<h3 data-id="heading-14">3.4 避坑指南</h3>
<ul>
<li>
<p>永远优先使用“带ok的类型断言”（格式2），避免因断言失败导致panic；</p>
</li>
<li>
<p>类型断言只能断言“接口中存储的具体类型”，不能断言“接口类型”（如将Speaker接口断言为Reader接口，即使类型实现了Reader，也会失败）；</p>
</li>
<li>
<p>如果需要同时判断多种类型，建议使用“类型选择（type switch）”（下一节讲解），代码更简洁。</p>
</li>
</ul>
<h2 data-id="heading-15">四、类型选择（type switch）的使用</h2>
<p>当需要对接口中的值进行“多类型判断”时，使用类型断言会导致大量的if-else嵌套，代码冗余。这时可以使用<strong>类型选择（type switch）</strong>，它是专门用于“接口类型判断”的语法，能更简洁、清晰地处理多类型分支。</p>
<h3 data-id="heading-16">4.1 类型选择的基本语法</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">switch</span> 接口变量.(<span class="hljs-keyword">type</span>) {
<span class="hljs-keyword">case</span> 目标类型<span class="hljs-number">1</span>:
    <span class="hljs-comment">// 当接口值为目标类型1时执行</span>
    操作（可直接使用变量，类型为目标类型<span class="hljs-number">1</span>）
<span class="hljs-keyword">case</span> 目标类型<span class="hljs-number">2</span>:
    <span class="hljs-comment">// 当接口值为目标类型2时执行</span>
<span class="hljs-keyword">case</span> 目标类型<span class="hljs-number">3</span>, 目标类型<span class="hljs-number">4</span>:
    <span class="hljs-comment">// 多个类型共用一个分支</span>
<span class="hljs-keyword">default</span>:
    <span class="hljs-comment">// 当接口值不匹配任何case时执行</span>
}

</code></pre>
<p>核心特点：</p>
<ul>
<li>
<p>case后面跟的是“类型”，而非“值”（与普通switch的核心区别）；</p>
</li>
<li>
<p>无需手动进行类型断言，case分支中直接使用的变量就是对应类型；</p>
</li>
<li>
<p>default分支可选，用于处理未匹配到的类型（避免遗漏）。</p>
</li>
</ul>
<h3 data-id="heading-17">4.2 代码示例：类型选择的使用</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// PrintAny 用type switch处理空接口的多类型分支</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintAny</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>{})</span></span> {
    <span class="hljs-keyword">switch</span> t := v.(<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-type">int</span>:
        fmt.Printf(<span class="hljs-string">"类型：int，值：%d，平方：%d\n"</span>, t, t*t)
    <span class="hljs-keyword">case</span> <span class="hljs-type">string</span>:
        fmt.Printf(<span class="hljs-string">"类型：string，值：%s，长度：%d\n"</span>, t, <span class="hljs-built_in">len</span>(t))
    <span class="hljs-keyword">case</span> <span class="hljs-type">bool</span>:
        fmt.Printf(<span class="hljs-string">"类型：bool，值：%t\n"</span>, t)
    <span class="hljs-keyword">case</span> []<span class="hljs-type">int</span>:
        fmt.Printf(<span class="hljs-string">"类型：[]int，值：%v，元素个数：%d\n"</span>, t, <span class="hljs-built_in">len</span>(t))
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}:
        fmt.Printf(<span class="hljs-string">"类型：map[string]interface{}，值：%v\n"</span>, t)
    <span class="hljs-keyword">default</span>:
        fmt.Printf(<span class="hljs-string">"未知类型：%T，值：%v\n"</span>, t, t)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    PrintAny(<span class="hljs-number">10</span>)                          <span class="hljs-comment">// 输出：类型：int，值：10，平方：100</span>
    PrintAny(<span class="hljs-string">"Hello Go"</span>)                  <span class="hljs-comment">// 输出：类型：string，值：Hello Go，长度：8</span>
    PrintAny(<span class="hljs-literal">true</span>)                        <span class="hljs-comment">// 输出：类型：bool，值：true</span>
    PrintAny([]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>})                <span class="hljs-comment">// 输出：类型：[]int，值：[1 2 3]，元素个数：3</span>
    PrintAny(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"小明"</span>,
        <span class="hljs-string">"age"</span>:  <span class="hljs-number">25</span>,
    }) <span class="hljs-comment">// 输出：类型：map[string]interface{}，值：map[name:小明 age:25]</span>
    PrintAny(<span class="hljs-number">3.14</span>)                        <span class="hljs-comment">// 输出：未知类型：float64，值：3.14</span>
}

</code></pre>
<h3 data-id="heading-18">4.3 进阶用法：类型选择与接口结合</h3>
<p>类型选择也可以用于判断接口的实现类型，实现更灵活的多态逻辑。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-keyword">type</span> Shape <span class="hljs-keyword">interface</span> {
    Area() <span class="hljs-type">float64</span>
}

<span class="hljs-keyword">type</span> Circle <span class="hljs-keyword">struct</span> {
    Radius <span class="hljs-type">float64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c Circle)</span></span> Area() <span class="hljs-type">float64</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">3.14</span> * c.Radius * c.Radius
}

<span class="hljs-keyword">type</span> Rectangle <span class="hljs-keyword">struct</span> {
    Width  <span class="hljs-type">float64</span>
    Height <span class="hljs-type">float64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Rectangle)</span></span> Area() <span class="hljs-type">float64</span> {
    <span class="hljs-keyword">return</span> r.Width * r.Height
}

<span class="hljs-comment">// CalculateArea 用type switch区分Shape的实现类型，执行差异化逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CalculateArea</span><span class="hljs-params">(s Shape)</span></span> {
    <span class="hljs-keyword">switch</span> t := s.(<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> Circle:
        fmt.Printf(<span class="hljs-string">"圆形：半径=%.2f，面积=%.2f\n"</span>, t.Radius, t.Area())
    <span class="hljs-keyword">case</span> Rectangle:
        fmt.Printf(<span class="hljs-string">"矩形：宽=%.2f，高=%.2f，面积=%.2f\n"</span>, t.Width, t.Height, t.Area())
    <span class="hljs-keyword">default</span>:
        fmt.Printf(<span class="hljs-string">"未知图形，面积=%.2f\n"</span>, t.Area())
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    c := Circle{Radius: <span class="hljs-number">5</span>}
    r := Rectangle{Width: <span class="hljs-number">4</span>, Height: <span class="hljs-number">5</span>}

    CalculateArea(c) <span class="hljs-comment">// 输出：圆形：半径=5.00，面积=78.50</span>
    CalculateArea(r) <span class="hljs-comment">// 输出：矩形：宽=4.00，高=5.00，面积=20.00</span>
}

</code></pre>
<h3 data-id="heading-19">4.4 参考链接</h3>
<ul>
<li>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Type_switches" target="_blank" title="https://go.dev/ref/spec#Type_switches" ref="nofollow noopener noreferrer">Type switches</a></li>
</ul>
<h2 data-id="heading-20">五、接口的组合与扩展性设计</h2>
<p>Go的接口支持<strong>组合（Composition）</strong>——将多个接口组合成一个新接口。这种设计可以实现“接口的复用与扩展”，让接口设计更灵活、粒度更细，符合“单一职责原则”。</p>
<p>核心思想：一个大接口可以由多个小接口组合而成，实现大接口的类型只需实现所有小接口的方法。</p>
<h3 data-id="heading-21">5.1 接口组合的基本语法</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 定义小接口1</span>
<span class="hljs-keyword">type</span> 接口<span class="hljs-number">1</span> <span class="hljs-keyword">interface</span> {
    方法<span class="hljs-number">1</span>()
}

<span class="hljs-comment">// 定义小接口2</span>
<span class="hljs-keyword">type</span> 接口<span class="hljs-number">2</span> <span class="hljs-keyword">interface</span> {
    方法<span class="hljs-number">2</span>()
}

<span class="hljs-comment">// 组合接口：包含接口1和接口2（相当于拥有方法1和方法2）</span>
<span class="hljs-keyword">type</span> 组合接口 <span class="hljs-keyword">interface</span> {
    接口<span class="hljs-number">1</span>
    接口<span class="hljs-number">2</span>
    <span class="hljs-comment">// 可选：新增方法</span>
    方法<span class="hljs-number">3</span>()
}
</code></pre>
<p>规则：实现“组合接口”的类型，必须实现所有组合的小接口的方法，以及组合接口新增的方法。</p>
<h3 data-id="heading-22">5.2 代码示例：接口组合的使用</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// Reader 小接口：读取数据</span>
<span class="hljs-keyword">type</span> Reader <span class="hljs-keyword">interface</span> {
    Read() <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Writer 小接口：写入数据</span>
<span class="hljs-keyword">type</span> Writer <span class="hljs-keyword">interface</span> {
    Write(data <span class="hljs-type">string</span>)
}

<span class="hljs-comment">// ReadWriter 组合接口：包含Reader和Writer</span>
<span class="hljs-keyword">type</span> ReadWriter <span class="hljs-keyword">interface</span> {
    Reader <span class="hljs-comment">// 嵌入Reader接口</span>
    Writer <span class="hljs-comment">// 嵌入Writer接口</span>
    Flush() <span class="hljs-comment">// 新增方法：刷新缓存</span>
}

<span class="hljs-comment">// File 文件结构体：实现ReadWriter接口</span>
<span class="hljs-keyword">type</span> File <span class="hljs-keyword">struct</span> {
    Content <span class="hljs-type">string</span>
}

<span class="hljs-comment">// 实现Reader的Read方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Read() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> f.Content
}

<span class="hljs-comment">// 实现Writer的Write方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Write(data <span class="hljs-type">string</span>) {
    f.Content += data
}

<span class="hljs-comment">// 实现ReadWriter的Flush方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Flush() {
    fmt.Println(<span class="hljs-string">"刷新缓存，当前内容："</span>, f.Content)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> rw ReadWriter = &amp;File{Content: <span class="hljs-string">"初始内容："</span>}

    <span class="hljs-comment">// 调用Writer的Write方法</span>
    rw.Write(<span class="hljs-string">"Hello "</span>)
    rw.Write(<span class="hljs-string">"Go!"</span>)

    <span class="hljs-comment">// 调用Reader的Read方法</span>
    fmt.Println(<span class="hljs-string">"读取内容："</span>, rw.Read()) <span class="hljs-comment">// 输出：读取内容： 初始内容：Hello Go!</span>

    <span class="hljs-comment">// 调用ReadWriter的Flush方法</span>
    rw.Flush() <span class="hljs-comment">// 输出：刷新缓存，当前内容： 初始内容：Hello Go!</span>
}

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>ReadWriter接口组合了Reader和Writer，因此拥有了Read()和Write()方法，同时新增了Flush()方法；</p>
</li>
<li>
<p>File结构体要实现ReadWriter，必须同时实现Read()、Write()和Flush()三个方法；</p>
</li>
<li>
<p>接口组合实现了“功能的复用”：Reader和Writer可以被其他组合接口复用（如ReadCloser、WriteCloser）。</p>
</li>
</ul>
<h3 data-id="heading-23">5.3 扩展性设计技巧</h3>
<p>基于接口组合的扩展性设计，是Go大型项目的核心技巧之一，建议遵循以下原则：</p>
<h4 data-id="heading-24">5.3.1 接口粒度要小（单一职责）</h4>
<p>每个小接口只负责一个功能（如Reader只负责读取，Writer只负责写入），这样可以提高接口的复用性。例如Go标准库中的<code>io.Reader</code>、<code>io.Writer</code>、<code>io.Closer</code>都是单一职责的小接口。</p>
<h4 data-id="heading-25">5.3.2 组合扩展，而非修改原有接口</h4>
<p>当需要新增功能时，不要修改已有的接口（会破坏原有实现），而是通过组合现有接口+新增方法的方式创建新接口。例如：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 现有接口</span>
<span class="hljs-keyword">type</span> Reader <span class="hljs-keyword">interface</span> { Read() <span class="hljs-type">string</span> }

<span class="hljs-comment">// 新增功能：带缓冲的读取</span>
<span class="hljs-keyword">type</span> BufferedReader <span class="hljs-keyword">interface</span> {
    Reader
    BufferSize() <span class="hljs-type">int</span> <span class="hljs-comment">// 新增方法：获取缓冲大小</span>
}

</code></pre>
<h4 data-id="heading-26">5.3.3 依赖抽象接口，而非具体实现</h4>
<p>函数参数、结构体字段尽量使用接口类型（尤其是组合接口），而非具体实现类型，这样可以提高代码的灵活性和可测试性。例如：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 好：依赖ReadWriter接口，可接收任何实现该接口的类型（File、NetworkConn等）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ProcessData</span><span class="hljs-params">(rw ReadWriter)</span></span> {
    <span class="hljs-comment">// 处理逻辑</span>
}

<span class="hljs-comment">// 差：依赖具体的File类型，无法复用其他实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ProcessData</span><span class="hljs-params">(f *File)</span></span> {
    <span class="hljs-comment">// 处理逻辑</span>
}

</code></pre>
<h3 data-id="heading-27">5.4 参考链接</h3>
<ul>
<li>Go标准库io包接口设计：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fio" target="_blank" title="https://pkg.go.dev/io" ref="nofollow noopener noreferrer">io package</a></li>
</ul>
<h2 data-id="heading-28">六、鸭子类型与Go的多态实现</h2>
<p>Go的多态实现基于“鸭子类型（Duck Typing）”——“当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被当作鸭子”。对应到Go中：<strong>只要一个类型实现了接口的所有方法，无论它是什么类型，都可以被当作该接口类型使用</strong>。</p>
<p>Go的隐式接口实现机制，正是鸭子类型的完美体现，也是Go多态的核心原理。</p>
<h3 data-id="heading-29">6.1 鸭子类型的核心思想</h3>
<ul>
<li>
<p>关注“行为”而非“类型本身”：接口定义的是“行为规范”，只要类型具备该行为，就可以被接口接纳；</p>
</li>
<li>
<p>无需继承关系：不同类型之间无需有继承关系，只要行为匹配，就可以实现多态；</p>
</li>
<li>
<p>代码解耦：接口与实现类型完全解耦，实现类型可以在任何包中定义，无需依赖接口包。</p>
</li>
</ul>
<h3 data-id="heading-30">6.2 代码示例：Go的多态实现（基于鸭子类型）</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// Mover 定义行为：移动</span>
<span class="hljs-keyword">type</span> Mover <span class="hljs-keyword">interface</span> {
    Move() <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Car 汽车结构体</span>
<span class="hljs-keyword">type</span> Car <span class="hljs-keyword">struct</span> {
    Brand <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Move 实现Mover接口（汽车的移动行为）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c Car)</span></span> Move() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"%s汽车在公路上行驶"</span>, c.Brand)
}

<span class="hljs-comment">// Bird 鸟结构体</span>
<span class="hljs-keyword">type</span> Bird <span class="hljs-keyword">struct</span> {
    Species <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Move 实现Mover接口（鸟的移动行为）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b Bird)</span></span> Move() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"%s在天空中飞翔"</span>, b.Species)
}

<span class="hljs-comment">// Ship 船结构体</span>
<span class="hljs-keyword">type</span> Ship <span class="hljs-keyword">struct</span> {
    Type <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Move 实现Mover接口（船的移动行为）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Ship)</span></span> Move() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"%s在海上航行"</span>, s.Type)
}

<span class="hljs-comment">// 多态函数：接收Mover接口，执行移动行为</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MoveAnything</span><span class="hljs-params">(m Mover)</span></span> {
    fmt.Println(m.Move())
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    c := Car{Brand: <span class="hljs-string">"宝马"</span>}
    b := Bird{Species: <span class="hljs-string">"老鹰"</span>}
    s := Ship{Type: <span class="hljs-string">"游轮"</span>}

    <span class="hljs-comment">// 不同类型（Car、Bird、Ship）都实现了Mover，可统一传入MoveAnything</span>
    MoveAnything(c) <span class="hljs-comment">// 输出：宝马汽车在公路上行驶</span>
    MoveAnything(b) <span class="hljs-comment">// 输出：老鹰在天空中飞翔</span>
    MoveAnything(s) <span class="hljs-comment">// 输出：游轮在海上航行</span>
}

</code></pre>
<p>Go多态的优势：</p>
<ul>
<li>
<p><strong>简洁灵活</strong>：无需显式继承和接口声明，代码更简洁；</p>
</li>
<li>
<p><strong>低耦合</strong>：接口与实现类型解耦，便于扩展和维护；</p>
</li>
<li>
<p><strong>高复用</strong>：同一接口可以被任意类型实现，多态函数可以复用在不同类型上。</p>
</li>
</ul>
<h3 data-id="heading-31">6.3 鸭子类型与传统多态的区别</h3>






























<table><thead><tr><th>对比维度</th><th>Go的鸭子类型（隐式接口）</th><th>Java/C++的显式接口/继承</th></tr></thead><tbody><tr><td>接口实现方式</td><td>隐式实现，无需声明</td><td>显式声明（implements/extends）</td></tr><tr><td>类型关系</td><td>无继承关系，只关注行为匹配</td><td>需建立继承/实现关系</td></tr><tr><td>耦合度</td><td>低（接口与实现完全解耦）</td><td>高（实现类型依赖接口/父类）</td></tr><tr><td>扩展性</td><td>强（新增实现无需修改原有代码）</td><td>弱（修改接口/父类会影响所有子类）</td></tr></tbody></table>
<h2 data-id="heading-32">七、error接口的设计哲学</h2>
<p>在Go中，错误处理是通过<code>error</code>接口实现的。<code>error</code>是Go标准库定义的一个简单接口，它的设计充分体现了Go“简洁、实用”的哲学，也是接口在Go中最广泛的应用之一。</p>
<h3 data-id="heading-33">7.1 error接口的定义</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// error接口定义（位于builtin包）</span>
<span class="hljs-keyword">type</span> <span class="hljs-type">error</span> <span class="hljs-keyword">interface</span> {
    Error() <span class="hljs-type">string</span> <span class="hljs-comment">// 只包含一个方法：返回错误信息字符串</span>
}

</code></pre>
<p>核心特点：</p>
<ul>
<li>
<p>接口极简：只包含一个Error() string方法，任何实现该方法的类型都可以作为错误类型；</p>
</li>
<li>
<p>隐式实现：自定义错误类型只需实现Error()方法，无需显式声明；</p>
</li>
<li>
<p>值语义：error接口存储的是具体错误类型的值（或指针），支持类型断言和类型选择。</p>
</li>
</ul>
<h3 data-id="heading-34">7.2 错误处理的基本用法</h3>
<p>Go中错误处理的核心模式是“返回错误+检查错误”，而非“异常捕获（try-catch）”。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"fmt"</span>
)

<span class="hljs-comment">// Divide 除法函数：返回结果和错误（当除数为0时返回错误）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Divide</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 用errors.New创建简单错误</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, errors.New(<span class="hljs-string">"除数不能为0"</span>)
    }
    <span class="hljs-keyword">return</span> a / b, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 调用函数，检查错误</span>
    result, err := Divide(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"错误："</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(<span class="hljs-string">"10/2 ="</span>, result) <span class="hljs-comment">// 输出：10/2 = 5</span>

    <span class="hljs-comment">// 测试除数为0的错误场景</span>
    result2, err2 := Divide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)
    <span class="hljs-keyword">if</span> err2 != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"错误："</span>, err2) <span class="hljs-comment">// 输出：错误： 除数不能为0</span>
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(<span class="hljs-string">"10/0 ="</span>, result2)
}

</code></pre>
<h3 data-id="heading-35">7.3 自定义错误类型</h3>
<p>当需要携带更多错误信息（如错误码、错误详情）时，可以自定义错误类型（实现error接口）。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 自定义错误类型：包含错误码和错误信息</span>
<span class="hljs-keyword">type</span> MyError <span class="hljs-keyword">struct</span> {
    Code    <span class="hljs-type">int</span>    <span class="hljs-comment">// 错误码</span>
    Message <span class="hljs-type">string</span> <span class="hljs-comment">// 错误信息</span>
}

<span class="hljs-comment">// 实现error接口的Error()方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *MyError)</span></span> Error() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"错误码：%d，错误信息：%s"</span>, e.Code, e.Message)
}

<span class="hljs-comment">// Login 模拟登录函数：返回自定义错误</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(username, password <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> username == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">400</span>, Message: <span class="hljs-string">"用户名不能为空"</span>}
    }
    <span class="hljs-keyword">if</span> password == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">400</span>, Message: <span class="hljs-string">"密码不能为空"</span>}
    }
    <span class="hljs-keyword">if</span> username != <span class="hljs-string">"admin"</span> || password != <span class="hljs-string">"123456"</span> {
        <span class="hljs-keyword">return</span> &amp;MyError{Code: <span class="hljs-number">401</span>, Message: <span class="hljs-string">"用户名或密码错误"</span>}
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    err := Login(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"123456"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Println(<span class="hljs-string">"登录成功"</span>)

    <span class="hljs-comment">// 测试错误场景，并通过类型断言获取自定义错误信息</span>
    err2 := Login(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"wrong"</span>)
    <span class="hljs-keyword">if</span> err2 != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 断言为自定义MyError类型</span>
        <span class="hljs-keyword">if</span> e, ok := err2.(*MyError); ok {
            fmt.Printf(<span class="hljs-string">"登录失败：错误码=%d，详情=%s\n"</span>, e.Code, e.Message)
            <span class="hljs-comment">// 可根据错误码执行差异化逻辑</span>
            <span class="hljs-keyword">if</span> e.Code == <span class="hljs-number">401</span> {
                fmt.Println(<span class="hljs-string">"建议：请检查用户名和密码"</span>)
            }
        }
        <span class="hljs-keyword">return</span>
    }
}

</code></pre>
<h3 data-id="heading-36">7.4 error接口的设计哲学</h3>
<ul>
<li>
<p><strong>简洁实用</strong>：一个方法即可满足错误信息的基本需求，避免过度设计；</p>
</li>
<li>
<p><strong>显式错误处理</strong>：通过返回值显式返回错误，开发者必须主动检查错误（而非隐式忽略）；</p>
</li>
<li>
<p><strong>灵活扩展</strong>：支持自定义错误类型，可携带任意额外信息，满足复杂场景需求；</p>
</li>
<li>
<p><strong>与接口生态兼容</strong>：error本身是接口，可无缝集成到Go的接口体系中（如类型断言、类型选择）。</p>
</li>
</ul>
<h3 data-id="heading-37">7.5 参考链接</h3>
<ul>
<li>
<p>Go官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fbuiltin%23error" target="_blank" title="https://pkg.go.dev/builtin#error" ref="nofollow noopener noreferrer">error interface</a></p>
</li>
<li>
<p>Go官方博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Ferror-handling-and-go" target="_blank" title="https://go.dev/blog/error-handling-and-go" ref="nofollow noopener noreferrer">Error Handling and Go</a></p>
</li>
</ul>
<h2 data-id="heading-38">八、接口在大型项目中的分层应用</h2>
<p>在大型Go项目中，接口是实现“分层架构”、“解耦模块”的核心工具。通过接口定义层与层之间的“契约”，可以让各层独立开发、测试和迭代，大幅提升项目的可维护性和扩展性。</p>
<h3 data-id="heading-39">8.1 大型项目的典型分层架构</h3>
<p>以常见的“Web后端项目”为例，典型分层为：</p>
<pre><code class="hljs language-text" lang="text">
1. 接口层（API/Handler）：接收客户端请求，参数校验，返回响应
2. 服务层（Service）：实现核心业务逻辑，依赖数据访问层接口
3. 数据访问层（DAO）：与数据库交互，实现数据的增删改查
4. 模型层（Model）：定义数据结构（结构体）

</code></pre>
<p>接口的作用：在“服务层”与“数据访问层”之间定义契约，让服务层依赖DAO接口而非具体实现，实现解耦。</p>
<h3 data-id="heading-40">8.2 代码示例：分层架构中的接口应用</h3>
<p>以下是一个简化的用户管理系统分层实现，重点展示接口在层间解耦中的作用：</p>
<h4 data-id="heading-41">8.2.1 模型层（model/user.go）：定义数据结构</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> model

<span class="hljs-comment">// User 用户模型</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    ID       <span class="hljs-type">int</span>    <span class="hljs-string">`json:"id"`</span>
    Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username"`</span>
    Email    <span class="hljs-type">string</span> <span class="hljs-string">`json:"email"`</span>
}

</code></pre>
<h4 data-id="heading-42">8.2.2 数据访问层接口（dao/user_dao.go）：定义DAO接口</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> dao

<span class="hljs-keyword">import</span> <span class="hljs-string">"your-project/model"</span>

<span class="hljs-comment">// UserDAO 用户数据访问接口（层间契约）</span>
<span class="hljs-keyword">type</span> UserDAO <span class="hljs-keyword">interface</span> {
    GetByID(id <span class="hljs-type">int</span>) (*model.User, <span class="hljs-type">error</span>)   <span class="hljs-comment">// 根据ID查询用户</span>
    Create(user *model.User) <span class="hljs-type">error</span>        <span class="hljs-comment">// 创建用户</span>
    Update(user *model.User) <span class="hljs-type">error</span>        <span class="hljs-comment">// 更新用户</span>
    Delete(id <span class="hljs-type">int</span>) <span class="hljs-type">error</span>                  <span class="hljs-comment">// 删除用户</span>
}

</code></pre>
<h4 data-id="heading-43">8.2.3 数据访问层实现（dao/mysql_user_dao.go）：MySQL实现</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> dao

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"database/sql"</span>
    <span class="hljs-string">"your-project/model"</span>
)

<span class="hljs-comment">// MySQLUserDAO UserDAO的MySQL实现</span>
<span class="hljs-keyword">type</span> MySQLUserDAO <span class="hljs-keyword">struct</span> {
    db *sql.DB <span class="hljs-comment">// 数据库连接</span>
}

<span class="hljs-comment">// 初始化MySQLUserDAO</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMySQLUserDAO</span><span class="hljs-params">(db *sql.DB)</span></span> *MySQLUserDAO {
    <span class="hljs-keyword">return</span> &amp;MySQLUserDAO{db: db}
}

<span class="hljs-comment">// GetByID 实现UserDAO的GetByID方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MySQLUserDAO)</span></span> GetByID(id <span class="hljs-type">int</span>) (*model.User, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">var</span> user model.User
    err := m.db.QueryRow(<span class="hljs-string">"SELECT id, username, email FROM users WHERE id = ?"</span>, id).
        Scan(&amp;user.ID, &amp;user.Username, &amp;user.Email)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    <span class="hljs-keyword">return</span> &amp;user, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// Create 实现UserDAO的Create方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MySQLUserDAO)</span></span> Create(user *model.User) <span class="hljs-type">error</span> {
    _, err := m.db.Exec(<span class="hljs-string">"INSERT INTO users (username, email) VALUES (?, ?)"</span>,
        user.Username, user.Email)
    <span class="hljs-keyword">return</span> err
}

<span class="hljs-comment">// Update 实现UserDAO的Update方法（简化实现）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MySQLUserDAO)</span></span> Update(user *model.User) <span class="hljs-type">error</span> {
    _, err := m.db.Exec(<span class="hljs-string">"UPDATE users SET username = ?, email = ? WHERE id = ?"</span>,
        user.Username, user.Email, user.ID)
    <span class="hljs-keyword">return</span> err
}

<span class="hljs-comment">// Delete 实现UserDAO的Delete方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MySQLUserDAO)</span></span> Delete(id <span class="hljs-type">int</span>) <span class="hljs-type">error</span> {
    _, err := m.db.Exec(<span class="hljs-string">"DELETE FROM users WHERE id = ?"</span>, id)
    <span class="hljs-keyword">return</span> err
}

</code></pre>
<h4 data-id="heading-44">8.2.4 服务层（service/user_service.go）：依赖DAO接口</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> service

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"your-project/dao"</span>
    <span class="hljs-string">"your-project/model"</span>
)

<span class="hljs-comment">// UserService 用户服务层</span>
<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> {
    userDAO dao.UserDAO <span class="hljs-comment">// 依赖UserDAO接口，而非具体实现</span>
}

<span class="hljs-comment">// 初始化UserService（注入DAO实现）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(userDAO dao.UserDAO)</span></span> *UserService {
    <span class="hljs-keyword">return</span> &amp;UserService{userDAO: userDAO}
}

<span class="hljs-comment">// GetUserByID 业务逻辑：查询用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> GetUserByID(id <span class="hljs-type">int</span>) (*model.User, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> id &lt;= <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"无效的用户ID：%d"</span>, id)
    }
    <span class="hljs-comment">// 调用DAO接口方法（不关心具体是MySQL还是其他实现）</span>
    <span class="hljs-keyword">return</span> s.userDAO.GetByID(id)
}

<span class="hljs-comment">// CreateUser 业务逻辑：创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> CreateUser(username, email <span class="hljs-type">string</span>) <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> username == <span class="hljs-string">""</span> || email == <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"用户名和邮箱不能为空"</span>)
    }
    user := &amp;model.User{Username: username, Email: email}
    <span class="hljs-keyword">return</span> s.userDAO.Create(user)
}

</code></pre>
<h4 data-id="heading-45">8.2.5 接口层（handler/user_handler.go）：接收请求</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> handler

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"strconv"</span>
    <span class="hljs-string">"your-project/service"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)

<span class="hljs-comment">// UserHandler 用户接口层</span>
<span class="hljs-keyword">type</span> UserHandler <span class="hljs-keyword">struct</span> {
    userService *service.UserService
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserHandler</span><span class="hljs-params">(userService *service.UserService)</span></span> *UserHandler {
    <span class="hljs-keyword">return</span> &amp;UserHandler{userService: userService}
}

<span class="hljs-comment">// GetUserByIDHandler 处理查询用户请求</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *UserHandler)</span></span> GetUserByIDHandler(c *gin.Context) {
    idStr := c.Param(<span class="hljs-string">"id"</span>)
    id, err := strconv.Atoi(idStr)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"无效的用户ID"</span>})
        <span class="hljs-keyword">return</span>
    }

    user, err := h.userService.GetUserByID(id)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusInternalServerError, gin.H{<span class="hljs-string">"error"</span>: err.Error()})
        <span class="hljs-keyword">return</span>
    }

    c.JSON(http.StatusOK, gin.H{<span class="hljs-string">"data"</span>: user})
}

</code></pre>
<h4 data-id="heading-46">8.2.6 初始化与依赖注入（main.go）</h4>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"database/sql"</span>
    <span class="hljs-string">"your-project/dao"</span>
    <span class="hljs-string">"your-project/handler"</span>
    <span class="hljs-string">"your-project/service"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 初始化数据库连接</span>
    db, err := sql.Open(<span class="hljs-string">"mysql"</span>, <span class="hljs-string">"root:123456@tcp(127.0.0.1:3306)/test_db"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    <span class="hljs-keyword">defer</span> db.Close()

    <span class="hljs-comment">// 2. 初始化DAO实现（MySQL）</span>
    userDAO := dao.NewMySQLUserDAO(db)

    <span class="hljs-comment">// 3. 初始化服务层（注入DAO接口）</span>
    userService := service.NewUserService(userDAO)

    <span class="hljs-comment">// 4. 初始化接口层（注入服务层）</span>
    userHandler := handler.NewUserHandler(userService)

    <span class="hljs-comment">// 5. 启动HTTP服务</span>
    r := gin.Default()
    r.GET(<span class="hljs-string">"/users/:id"</span>, userHandler.GetUserByIDHandler)
    r.Run(<span class="hljs-string">":8080"</span>)
}

</code></pre>
<h3 data-id="heading-47">8.3 接口分层应用的核心优势</h3>
<ul>
<li>
<p><strong>解耦模块</strong>：服务层依赖DAO接口，不依赖具体实现，更换数据存储（如从MySQL改为PostgreSQL）时，只需修改DAO实现，无需修改服务层代码；</p>
</li>
<li>
<p><strong>便于测试</strong>：可以为DAO接口编写“模拟实现（Mock）”，在单元测试时隔离数据库，提高测试效率；</p>
</li>
<li>
<p><strong>并行开发</strong>：DAO接口定义完成后，服务层和DAO实现层可以并行开发（服务层基于接口编写逻辑，DAO层实现接口）；</p>
</li>
<li>
<p><strong>扩展性强</strong>：新增功能时，只需新增接口和实现，不影响原有代码，符合“开闭原则”。</p>
</li>
</ul>
<h3 data-id="heading-48">8.4 分层应用的最佳实践</h3>
<ul>
<li>
<p><strong>接口定义在“依赖方”所在的包</strong>：如UserDAO接口定义在service包（依赖方），而非dao包（实现方），避免循环依赖；</p>
</li>
<li>
<p><strong>依赖注入（DI）</strong>：通过构造函数将接口实现注入到依赖方（如UserService的NewUserService注入UserDAO），而非在依赖方内部直接创建实现；</p>
</li>
<li>
<p><strong>接口粒度适中</strong>：层间接口的粒度要平衡“复用性</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java单元测：jqwik框架入门（含完整Demo）]]></title>    <link>https://juejin.cn/post/7600710943250694186</link>    <guid>https://juejin.cn/post/7600710943250694186</guid>    <pubDate>2026-01-30T04:55:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600710943250694186" data-draft-id="7600709805469057067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java单元测：jqwik框架入门（含完整Demo）"/> <meta itemprop="keywords" content="后端,Java,单元测试"/> <meta itemprop="datePublished" content="2026-01-30T04:55:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java单元测：jqwik框架入门（含完整Demo）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:55:44.000Z" title="Fri Jan 30 2026 04:55:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    46
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java单元测：jqwik框架入门（含完整Demo）</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<h3 data-id="heading-1">前言</h3>
<p>在Java单元测试中，我们常依赖JUnit手动编写测试用例，但手动用例不仅繁琐，还容易遗漏边界场景和异常输入。而jqwik框架的出现，恰好解决了这一痛点——它是一款基于JUnit 5平台的属性测试（Property-Based Testing, PBT）框架，能自动生成海量测试数据，系统化验证代码的通用属性，帮我们快速捕捉隐藏的bug，让测试更高效、更全面。</p>
<h3 data-id="heading-2">1 什么是jqwik框架？</h3>
<p>jqwik（发音/ˈdʒeɪkwɪk/，谐音“jay quick”）是专为JVM设计的属性测试框架，核心目标是将属性测试（PBT）的强大能力融入Java、Kotlin等语言的测试流程，同时兼顾微测试的直观性。它并非替代JUnit，而是作为JUnit 5的扩展存在，可无缝集成到现有测试体系，无需大幅改动原有代码架构。</p>
<h4 data-id="heading-3">1.1 核心定位：属性测试 vs 传统测试</h4>
<p>传统JUnit测试属于“基于场景的测试”，我们需要预定义具体输入和预期输出（比如测试加法时，手动写1+1=2、2+3=5），只能覆盖有限场景；而属性测试则聚焦于代码的“通用属性”——即所有合法输入都应满足的规则（比如“任意两个整数a和b，a+b的结果应等于b+a”），框架会自动生成海量随机测试数据，验证这一属性是否始终成立。</p>
<h4 data-id="heading-4">1.2 jqwik的核心优势</h4>
<ul>
<li>无缝集成：基于JUnit 5平台开发，支持Maven、Gradle快速引入，可与IntelliJ IDEA、Eclipse等IDE无缝兼容，运行测试和查看结果的体验与JUnit一致。</li>
<li>自动生成测试数据：内置丰富的测试数据生成器（Arbitrary），支持基本类型、集合、字符串、自定义对象等，还可灵活配置数据约束（如“生成1-100的正整数”）。</li>
<li>智能反例缩小：当测试失败时，会自动将导致失败的复杂数据简化为最小反例（比如将长度100的异常字符串缩小为1个字符），快速定位问题根源。</li>
<li>高灵活性：支持自定义测试数据生成器、并行测试、测试数据过滤，适配复杂业务场景下的测试需求。</li>
<li>多语言支持：除Java外，还完美支持Kotlin、Groovy等JVM语言，适配不同项目的技术栈。</li>
</ul>
<h3 data-id="heading-5">2 jqwik怎么用？（基础步骤）</h3>
<p>使用jqwik的核心流程很简单：引入依赖 → 理解核心注解/概念 → 编写属性测试方法 → 运行测试并分析结果。下面分步拆解，新手也能快速上手。</p>
<h4 data-id="heading-6">2.1 第一步：引入依赖（Maven/Gradle）</h4>
<p>首先确保项目基于JUnit 5（Jupiter），然后在构建文件中引入jqwik依赖，这里给出最常用的Maven和Gradle配置（使用稳定版本1.5.2）。</p>
<h5 data-id="heading-7">Maven配置（pom.xml）</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>;
    <span class="hljs-comment">&lt;!-- JUnit 5 基础依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-comment">&lt;!-- jqwik 核心依赖（包含所有必要组件） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.jqwik<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jqwik-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">Gradle配置（build.gradle）</h5>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    // JUnit 5 基础依赖
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    // jqwik 核心依赖
    testImplementation 'net.jqwik:jqwik-all:1.5.2'
}

test {
    useJUnitPlatform() // 启用JUnit 5平台
}
</code></pre>
<h4 data-id="heading-9">2.2 第二步：理解jqwik核心概念与注解</h4>
<p>jqwik的使用依赖几个核心注解和概念，掌握这些就能编写基础的属性测试：</p>





























<table><thead><tr><th><strong>注解/概念</strong></th><th><strong>作用说明</strong></th></tr></thead><tbody><tr><td>@ExtendWith(JqwikExtension.class)</td><td>标记测试类，告知JUnit 5启用jqwik扩展，是编写jqwik测试的必备注解。</td></tr><tr><td>@Property</td><td>标记方法为“属性测试方法”，框架会自动执行该方法，并生成测试数据验证属性。</td></tr><tr><td>@ForAll</td><td>用于方法参数，指定该参数由jqwik自动生成测试数据，可结合数据约束使用（如@ForAll @IntRange(min=1, max=100)）。</td></tr><tr><td>Arbitrary</td><td>测试数据生成器的核心接口，代表“可生成某种类型测试数据的集合”，jqwik内置Arbitraries工具类提供常用生成器（如Arbitraries.ints()、Arbitraries.strings()）。</td></tr><tr><td>@Provide</td><td>标记方法为“自定义生成器方法”，方法返回Arbitrary类型，可自定义复杂测试数据（如自定义对象）。</td></tr></tbody></table>
<h4 data-id="heading-10">2.3 第三步：编写基础属性测试</h4>
<p>核心逻辑：定义“通用属性”（方法）→ 用@ForAll让框架自动生成参数 → 用断言验证属性是否成立。</p>
<h3 data-id="heading-11">3 实战Demo：用jqwik测试字符串工具类</h3>
<p>下面我们通过一个完整Demo，实战jqwik的使用——测试一个简单的字符串工具类，验证其“反转字符串”和“判空”两个功能的正确性，覆盖正常、边界、异常场景。</p>
<h4 data-id="heading-12">3.1 第一步：编写被测试的字符串工具类</h4>
<p>先创建一个简单的字符串工具类StringUtils，包含两个方法：反转字符串（reverse）、判断字符串非空（isNotEmpty）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jqwik.demo;

<span class="hljs-comment">/**
 * 被测试的字符串工具类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtils</span> {

    <span class="hljs-comment">/**
     * 反转字符串
     * <span class="hljs-doctag">@param</span> str 输入字符串（可null）
     * <span class="hljs-doctag">@return</span> 反转后的字符串，null输入返回null
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverse</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();
    }

    <span class="hljs-comment">/**
     * 判断字符串非空（非null、非空白）
     * <span class="hljs-doctag">@param</span> str 输入字符串
     * <span class="hljs-doctag">@return</span> true：非空；false：null或空白字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotEmpty</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">return</span> str != <span class="hljs-literal">null</span> &amp;&amp; !str.trim().isEmpty();
    }
}
</code></pre>
<h4 data-id="heading-13">3.2 第二步：编写jqwik测试类</h4>
<p>创建测试类StringUtilsTest，引入jqwik注解，编写两个属性测试方法，分别验证reverse和isNotEmpty的通用属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jqwik.demo;

<span class="hljs-keyword">import</span> net.jqwik.api.Arbitraries;
<span class="hljs-keyword">import</span> net.jqwik.api.Arbitrary;
<span class="hljs-keyword">import</span> net.jqwik.api.ForAll;
<span class="hljs-keyword">import</span> net.jqwik.api.Provide;
<span class="hljs-keyword">import</span> net.jqwik.api.Property;
<span class="hljs-keyword">import</span> net.jqwik.api.constraints.NotBlank;
<span class="hljs-keyword">import</span> net.jqwik.api.constraints.Nullable;
<span class="hljs-keyword">import</span> net.jqwik.api.extension.JqwikExtension;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.extension.ExtendWith;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-comment">// 启用jqwik扩展，必备注解</span>
<span class="hljs-meta">@ExtendWith(JqwikExtension.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtilsTest</span> {

    <span class="hljs-comment">/**
     * 测试reverse方法的核心属性：反转两次的结果应与原字符串一致（支持null）
     * 这里<span class="hljs-doctag">@ForAll</span> <span class="hljs-doctag">@Nullable</span> String str 表示自动生成所有可能的字符串（包括null、空白、正常字符串）
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reverseTwiceShouldBeOriginal</span><span class="hljs-params">(<span class="hljs-meta">@ForAll</span> <span class="hljs-meta">@Nullable</span> String str)</span> {
        <span class="hljs-comment">// 核心断言：反转两次的结果 == 原字符串</span>
        assertEquals(str, StringUtils.reverse(StringUtils.reverse(str)));
    }

    <span class="hljs-comment">/**
     * 测试isNotEmpty方法的核心属性1：非空白字符串返回true
     * <span class="hljs-doctag">@ForAll</span> <span class="hljs-doctag">@NotBlank</span> String str 表示自动生成所有非空白字符串（非null、非空白）
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notBlankStringShouldReturnTrue</span><span class="hljs-params">(<span class="hljs-meta">@ForAll</span> <span class="hljs-meta">@NotBlank</span> String str)</span> {
        assertTrue(StringUtils.isNotEmpty(str));
    }

    <span class="hljs-comment">/**
     * 测试isNotEmpty方法的核心属性2：空白/null字符串返回false
     * 自定义生成器：生成空白字符串（空格、制表符等）或null
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">blankOrNullStringShouldReturnFalse</span><span class="hljs-params">(<span class="hljs-meta">@ForAll("blankOrNullStrings")</span> String str)</span> {
        assertFalse(StringUtils.isNotEmpty(str));
    }

    <span class="hljs-comment">/**
     * 自定义测试数据生成器：生成空白字符串或null
     * <span class="hljs-doctag">@Provide</span> 注解标记，方法返回Arbitrary&lt;String&gt;（字符串生成器）
     */</span>
    <span class="hljs-meta">@Provide</span>
    Arbitrary&lt;String&gt; <span class="hljs-title function_">blankOrNullStrings</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 生成两种数据：null + 空白字符串（空格、制表符、空字符串），合并为一个生成器</span>
        Arbitrary&lt;String&gt; nullStrings = Arbitraries.just(<span class="hljs-literal">null</span>);
        Arbitrary&lt;String&gt; blankStrings = Arbitraries.strings()
                .withChars(<span class="hljs-string">' '</span>, <span class="hljs-string">'\t'</span>, <span class="hljs-string">'\n'</span>) <span class="hljs-comment">// 只生成空白字符</span>
                .ofMaxLength(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大长度10，避免生成过长字符串</span>
        <span class="hljs-keyword">return</span> Arbitraries.oneOf(nullStrings, blankStrings, Arbitraries.just(<span class="hljs-string">""</span>));
    }
}
</code></pre>
<h4 data-id="heading-14">3.3 第三步：运行测试并查看结果</h4>
<p>直接在IDE中运行测试类（和运行JUnit测试一致），jqwik会自动生成测试数据，默认每个@Property方法生成1000组数据，我们可以查看运行结果：</p>
<h5 data-id="heading-15">1. 测试成功场景</h5>
<p>如果工具类逻辑正确，运行结果会显示“3 tests passed”（3个属性测试方法全部通过），控制台会输出类似信息：</p>
<pre><code class="hljs language-plain" lang="plain">[INFO] Running com.example.jqwik.demo.StringUtilsTest
[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.523 s - in com.example.jqwik.demo.StringUtilsTest
</code></pre>
<p>这说明jqwik生成的1000×3组数据，全部满足我们定义的属性，工具类逻辑无明显bug。</p>
<h5 data-id="heading-16">2. 测试失败场景（模拟bug）</h5>
<p>我们故意修改reverse方法的逻辑（比如注释掉null判断，让null输入抛出异常），再运行测试，jqwik会快速捕捉到失败，并生成最小反例：</p>
<pre><code class="hljs language-plain" lang="plain">// 故意修改后的reverse方法（有bug）
public static String reverse(String str) {
    // 注释掉null判断，null输入会抛出NullPointerException
    return new StringBuilder(str).reverse().toString();
}

// 运行测试后，jqwik输出的失败信息（简化）
Property violation in com.example.jqwik.demo.StringUtilsTest.reverseTwiceShouldBeOriginal
Arguments: [null] // 最小反例：null
Throwable that caused failure: java.lang.NullPointerException
</code></pre>
<p>可以看到，jqwik自动定位到“null输入”这个边界场景，生成了最小反例（null），帮我们快速发现“null输入未处理”的bug，这正是属性测试的优势——手动测试很容易遗漏这类边界场景。</p>
<h3 data-id="heading-17">4 总结与进阶方向</h3>
<p>通过上面的介绍和Demo，相信你已经掌握了jqwik的基础用法：它以“属性测试”为核心，通过自动生成测试数据，帮我们解决传统手动测试的痛点，尤其适合验证算法、工具类、API等通用逻辑的正确性。</p>
<h4 data-id="heading-18">进阶学习方向（可选）</h4>
<ul>
<li>自定义复杂生成器：用@Provide和Arbitraries组合，生成自定义对象、枚举、复杂集合等测试数据（如资料中提到的Combinators.combine组合多个生成器）。</li>
<li>数据约束精细化：使用jqwik提供的更多约束注解（如@IntRange、@StringLength、@Email），精准控制测试数据的范围。</li>
<li>集成Spring Boot：通过jqwik-spring扩展，在Spring Boot项目中使用jqwik测试，支持@Autowired注入Bean。</li>
<li>并行测试与测试优化：配置jqwik并行运行测试，调整生成数据的数量、随机种子等，提升测试效率。</li>
</ul>
<blockquote>
<p>jqwik的官方文档（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjqwik.net%2F" target="_blank" title="https://jqwik.net/" ref="nofollow noopener noreferrer">jqwik.net/</a>）提供了更详细的API说明和进阶用法，感兴趣的可以进一步查阅。总的来说，jqwik上手简单、功能强大，只需几行代码就能实现更全面的测试，值得每一个Java开发者纳入自己的测试工具箱～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[显卡计算能力都不懂？一文看懂 Compute Capability 8.0 分水岭]]></title>    <link>https://juejin.cn/post/7600863478929227795</link>    <guid>https://juejin.cn/post/7600863478929227795</guid>    <pubDate>2026-01-30T08:25:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929227795" data-draft-id="7600868443831926803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="显卡计算能力都不懂？一文看懂 Compute Capability 8.0 分水岭"/> <meta itemprop="keywords" content="人工智能,GPU,LLM"/> <meta itemprop="datePublished" content="2026-01-30T08:25:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            显卡计算能力都不懂？一文看懂 Compute Capability 8.0 分水岭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:25:09.000Z" title="Fri Jan 30 2026 08:25:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">显卡计算能力都不懂？一文看懂 Compute Capability 8.0 分水岭</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ed3a1b071545859593b3c7b9231470~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770366311&amp;x-signature=AsIXbT7W3QZ0RpoTLo41PlYVsFM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>这里只是示意讲解，别纠结为什么我用这三张卡做示例。主要看核心的内容别纠结我的demo选型</p>
</blockquote>
<p><strong>作者</strong>：吴佳浩</p>
<p><strong>撰稿时间</strong>：2026-1-28</p>
<p><strong>最后更新</strong>：2026-1-30</p>
<p><strong>测试模型</strong>: Qwen3-VL-Embedding-8B</p>
<h4 data-id="heading-1">前言</h4>
<hr/>
<p>在部署大模型时，你可能遇到过这样的报错：</p>
<pre><code class="hljs language-bash" lang="bash">RuntimeError: CUDA compute capability 7.5 is not sufficient
Requires compute capability &gt;= 8.0
</code></pre>
<p>或者这些困惑：</p>
<ul>
<li>为什么 T4 卡跑 Embedding 模型这么慢？<strong>（实际单卡T4无法运行当前的模型的，需要多卡的方案。）</strong></li>
<li>A100 80GB 和 RTX 5090 32GB，推理谁更快？</li>
<li>FlashAttention 为什么在某些卡上根本跑不起来？</li>
</ul>
<p>很多人选择 GPU 时只看三件事：</p>
<ul>
<li>显存多不多</li>
<li>TFLOPS 高不高</li>
<li>价格贵不贵</li>
</ul>
<p>但真正决定<strong>模型能不能跑快</strong>的，往往只有一个参数：</p>
<blockquote>
<p><strong>Compute Capability（计算能力）</strong></p>
</blockquote>
<p>它甚至比显存更重要。</p>
<p>现实中大量性能灾难，都源于一个错误决策： 选择了 T4 才发现 FlashAttention 跑不了</p>
<ul>
<li>用着 A100，却没有触发 TF32</li>
<li>上了 5090，却因为 Torch 太旧直接报 sm_120</li>
</ul>
<p>这些问题，本质都不是“模型问题”。</p>
<p>而是：</p>
<blockquote>
<p><strong>你在用 AI 时代的模型，跑在上一个时代的 GPU 上。</strong></p>
</blockquote>
<p>本文以实际部署 <strong>Qwen3-VL-Embedding-8B</strong> 双塔模型为例，从底层硬件架构出发，彻底讲清楚 GPU 计算能力对模型推理的真实影响。</p>
<hr/>
<h3 data-id="heading-2">一、Compute Capability 到底是什么</h3>
<h4 data-id="heading-3">1.1 本质定义</h4>
<p>Compute Capability（计算能力）是 NVIDIA 为每代 GPU 架构定义的硬件特性版本号，格式为 <code>Major.Minor</code>。</p>
<p>它不是性能跑分，而是硬件能力的标识符。</p>
<p>类比理解：</p>
<pre><code class="hljs language-bash" lang="bash">CPU 指令集：     AVX2 → AVX-512
GPU 计算能力：   7.5 → 8.0 → 8.9 → 12.0
</code></pre>
<p>每个版本号背后对应：</p>
<ul>
<li>Tensor Core 的代际升级</li>
<li>内存层次结构的变化</li>
<li>新增的硬件指令支持</li>
<li>CUDA 编译目标 (sm_XX)</li>
</ul>
<h4 data-id="heading-4">1.2 查看方式</h4>
<p>检查你的 GPU 计算能力：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法1：使用 nvidia-smi</span>
nvidia-smi --query-gpu=compute_cap --format=csv

<span class="hljs-comment"># 方法2：使用 PyTorch</span>
python -c <span class="hljs-string">"import torch; print(torch.cuda.get_device_capability())"</span>

<span class="hljs-comment"># 方法3：查看 CUDA 样例</span>
/usr/local/cuda/samples/1_Utilities/deviceQuery/deviceQuery
</code></pre>
<hr/>
<h3 data-id="heading-5">二、为什么 8.0 是行业分水岭</h3>
<h4 data-id="heading-6">2.1 GPU 架构演进路线</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Pascal 6.x&lt;br/&gt;2016] --&gt; B[Volta 7.0&lt;br/&gt;2017]
    B --&gt; C[Turing 7.5&lt;br/&gt;2018]
    C --&gt; D[Ampere 8.0&lt;br/&gt;2020]
    D --&gt; E[Ada 8.9&lt;br/&gt;2022]
    E --&gt; F[Blackwell 12.0&lt;br/&gt;2024]
    
    style D fill:#90EE90,stroke:#333,stroke-width:3px
    style E fill:#FFD700,stroke:#333,stroke-width:2px
    style F fill:#FF6347,stroke:#333,stroke-width:2px
</code></pre>
<p>真正的转折点发生在 <strong>Ampere 架构（8.0）</strong>。</p>
<p>从这一代开始，NVIDIA GPU 的设计重心从"图形渲染"转向"AI 计算"。</p>
<h4 data-id="heading-7">2.2 Ampere 带来的三大核心变革</h4>
<h5 data-id="heading-8">变革 1：TF32 数据类型</h5>
<p>TF32（TensorFloat-32）是 Ampere 引入的新数据格式：</p>
<ul>
<li>保持 FP32 的动态范围（8-bit 指数）</li>
<li>使用 FP16 的精度（10-bit 尾数）</li>
<li>矩阵乘法性能提升 <strong>8-20 倍</strong></li>
</ul>
<p>对 Transformer 模型的影响：</p>
<pre><code class="hljs language-basg" lang="basg">Attention 机制 = Q @ K^T @ V
核心就是矩阵乘法密集型计算
</code></pre>
<p>实测效果：</p>
<pre><code class="hljs language-bash" lang="bash">FP32: 19.5 TFLOPS (A100)
TF32: 156 TFLOPS (A100) ← 8倍提升
</code></pre>
<h5 data-id="heading-9">变革 2：异步内存拷贝 (cp.async)</h5>
<p>8.0 新增的 PTX 指令 <code>cp.async</code>，支持：</p>
<pre><code class="hljs language-bash" lang="bash">Global Memory → Shared Memory 异步传输
</code></pre>
<p>传统做法：</p>
<pre><code class="hljs language-bash" lang="bash">1. 线程等待数据搬运完成
2. 计算
3. 等待下一批数据
</code></pre>
<p>cp.async 机制：</p>
<pre><code class="hljs language-bash" lang="bash">1. 发起异步搬运
2. 立即开始计算（使用上一批数据）
3. 计算和搬运并行进行
</code></pre>
<p>这是 <strong>FlashAttention-2</strong> 能够实现性能突破的硬件基础。</p>
<p>没有 cp.async 的卡：</p>
<ul>
<li>FlashAttention-2/3 无法运行</li>
<li>只能回退到 FlashAttention-1 或标准实现</li>
</ul>
<h5 data-id="heading-10">变革 3：Shared Memory 容量提升与灵活性</h5>




















<table><thead><tr><th>架构</th><th>Shared Memory / SM</th><th>配置灵活性</th></tr></thead><tbody><tr><td>Turing 7.5</td><td>64 KB</td><td>固定</td></tr><tr><td>Ampere 8.0</td><td>最高 164 KB</td><td>可配置</td></tr></tbody></table>
<p>注：Ampere 支持动态分配（100KB L1 + 64KB Shared Memory 或 0KB L1 + 164KB Shared Memory）</p>
<p>为什么重要？</p>
<p>Transformer 的 Self-Attention 需要在 Shared Memory 中缓存：</p>
<pre><code class="hljs language-bash" lang="bash">Q: [batch, seq_len, hidden]
K: [batch, seq_len, hidden]
V: [batch, seq_len, hidden]
</code></pre>
<p>Shared Memory 越大：</p>
<ul>
<li>单次可处理的 sequence length 越长</li>
<li>Attention 计算的 tile 尺寸越大</li>
<li>Kernel 启动次数越少</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、三张卡的硬件对比</h3>
<h4 data-id="heading-12">3.1 核心参数对比表</h4>

































































<table><thead><tr><th>参数</th><th>Tesla T4</th><th>A100 (40/80GB)</th><th>RTX 5090</th></tr></thead><tbody><tr><td>计算能力</td><td>7.5</td><td>8.0</td><td>12.0</td></tr><tr><td>架构代号</td><td>Turing</td><td>Ampere</td><td>Blackwell</td></tr><tr><td>Tensor Core</td><td>3rd Gen</td><td>3rd Gen</td><td>5th Gen</td></tr><tr><td>FP16 TFLOPS</td><td>65</td><td>312</td><td>1790</td></tr><tr><td>TF32 支持</td><td>✗</td><td>✓</td><td>✓ (向后兼容)</td></tr><tr><td>BF16 支持</td><td>⚠️ 部分</td><td>✓</td><td>✓</td></tr><tr><td>显存容量</td><td>16 GB</td><td>40/80 GB</td><td>32 GB</td></tr><tr><td>显存带宽</td><td>320 GB/s</td><td>1555/2039 GB/s</td><td>1792 GB/s</td></tr><tr><td>核心频率</td><td>1590 MHz</td><td>1410 MHz</td><td>2580 MHz</td></tr></tbody></table>
<p><em>注：A100 40GB 与 80GB 版本的带宽差异（1555 vs 2039 GB/s）来自 HBM2e 的堆叠层数不同</em></p>
<h4 data-id="heading-13">3.2 架构定位差异图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph T4["Tesla T4 (7.5)"]
        t1[推理入门卡]
        t2[16GB GDDR6]
        t3[低功耗 70W]
        t4[缺少现代特性]
    end

    subgraph A100["A100 (8.0)"]
        a1[数据中心主力]
        a2[40/80GB HBM2e]
        a3[高带宽 1555GB/s]
        a4[7x24 稳定运行]
    end

    subgraph RTX5090["RTX 5090 (12.0)"]
        r1[消费级旗舰]
        r2[32GB GDDR7]
        r3[超高频率 2.5GHz]
        r4[最新 Tensor Core]
    end

    style T4 fill:#f9f9f9,stroke:#999,stroke-width:2px
    style A100 fill:#e8f5e9,stroke:#4caf50,stroke-width:3px
    style RTX5090 fill:#fff3e0,stroke:#ff9800,stroke-width:3px
</code></pre>
<p>简单总结：</p>
<pre><code class="hljs language-bash" lang="bash">T4    = 能跑 AI，但吃力（显存带宽瓶颈严重）
A100  = 企业级稳定输出（平衡算力与带宽）
5090  = 消费级性能怪兽（算力高，但需注意显存带宽比）
</code></pre>
<blockquote>
<p><strong>关键洞察</strong>：Embedding 模型通常是 Memory-Bound（受限于显存带宽而非算力）。5090 的算力是 T4 的 27.5 倍，但带宽仅 5.6 倍，这解释了为什么实际推理提升通常在 12-16 倍而非 27 倍。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">一个很多人不知道的事实</h3>
<p>在 Transformer 推理中：</p>
<blockquote>
<p><strong>算力不足 ≠ 最致命的问题</strong></p>
</blockquote>
<p>真正致命的是：</p>
<blockquote>
<p><strong>无法进入高性能 Kernel 路径。</strong></p>
</blockquote>
<p>一旦 GPU 计算能力低于 8.0：</p>
<ul>
<li>FlashAttention-2/3 被禁用</li>
<li>Triton kernel 回退</li>
<li>Tensor Core 利用率下降</li>
</ul>
<p>结果不是慢 20%。</p>
<p>而是：</p>
<blockquote>
<p><strong>可能慢 3~6 倍。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-15">四、双塔模型的推理特性分析</h3>
<h4 data-id="heading-16">4.1 Qwen3-VL-Embedding-8B 架构</h4>
<p>双塔 Embedding 模型的工作流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Query Input] --&gt; B[Query Encoder&lt;br/&gt;ViT + QwenLM]
    C[Document Input] --&gt; D[Document Encoder&lt;br/&gt;ViT + QwenLM]
    
    B --&gt; E[Query Vector&lt;br/&gt;768-dim]
    D --&gt; F[Doc Vector&lt;br/&gt;768-dim]
    
    E --&gt; G[Cosine Similarity]
    F --&gt; G
    
    G --&gt; H[Relevance Score]
    
    style B fill:#bbdefb
    style D fill:#bbdefb
    style G fill:#fff9c4
</code></pre>
<h4 data-id="heading-17">4.2 推理计算热点</h4>
<p>双塔模型的计算瓶颈在于：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, images, text</span>):
    <span class="hljs-comment"># 1. Vision Encoder (占比 40%)</span>
    visual_features = self.vit(images)  <span class="hljs-comment"># 大量 Conv + Attention</span>
    
    <span class="hljs-comment"># 2. Language Model (占比 55%)</span>
    text_features = self.qwen(text)     <span class="hljs-comment"># Transformer Layers</span>
    
    <span class="hljs-comment"># 3. Pooling (占比 5%)</span>
    query_emb = self.pool(visual_features, text_features)
    
    <span class="hljs-keyword">return</span> query_emb  <span class="hljs-comment"># [batch, 768]</span>
</code></pre>
<p>核心操作：</p>
<ul>
<li>矩阵乘法（GEMM）占比超过 <strong>80%</strong></li>
<li>Attention 机制占比约 <strong>15%</strong></li>
<li>其他操作（激活、归一化）占比 <strong>5%</strong></li>
</ul>
<p>因此：</p>
<pre><code class="hljs language-bash" lang="bash">GPU 推理性能 = Tensor Core 吞吐 + Attention 加速 + 显存带宽利用率
</code></pre>
<p>对于 Embedding 这类中等规模模型，<strong>显存带宽往往是隐藏瓶颈</strong>。</p>
<hr/>
<h3 data-id="heading-18">五、实测性能对比</h3>
<h4 data-id="heading-19">5.1 测试环境</h4>
<ul>
<li>模型：Qwen3-VL-Embedding-8B (FP16)</li>
<li>Batch Size：32</li>
<li>输入：224x224 图像 + 32 tokens 文本</li>
<li>框架：vLLM 0.6.3 + PyTorch 2.5</li>
<li>CUDA：12.4</li>
</ul>
<h4 data-id="heading-20">5.2 吞吐量对比</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Performance["推理吞吐量 (samples/sec)"]
        T4_Result["T4&lt;br/&gt;12.5 samples/sec"]
        A100_Result["A100&lt;br/&gt;156.3 samples/sec"]
        RTX5090_Result["RTX 5090&lt;br/&gt;203.7 samples/sec"]
    end
    
    T4_Result -.-&gt;|12.5x| A100_Result
    A100_Result -.-&gt;|1.3x| RTX5090_Result
    
    style T4_Result fill:#ffebee,stroke:#f44336
    style A100_Result fill:#e8f5e9,stroke:#4caf50
    style RTX5090_Result fill:#fff3e0,stroke:#ff9800
</code></pre>
<p><em>注：实验室理想环境数据，实际生产环境受API开销影响，差距可能缩小</em></p>
<h4 data-id="heading-21">5.3 延迟对比</h4>
<p>单样本推理延迟（batch=1）：</p>

























<table><thead><tr><th>GPU</th><th>首 token 延迟</th><th>平均延迟</th></tr></thead><tbody><tr><td>T4</td><td>342 ms</td><td>387 ms</td></tr><tr><td>A100</td><td>45 ms</td><td>52 ms</td></tr><tr><td>RTX 5090</td><td>28 ms</td><td>35 ms</td></tr></tbody></table>
<h4 data-id="heading-22">5.4 性能差异分析</h4>
<h5 data-id="heading-23">T4 的瓶颈</h5>
<pre><code class="hljs language-bash" lang="bash">计算能力 7.5 的限制：
├── FlashAttention-2/3 无法启用 → 退回 FA-1 或标准实现
├── 无 TF32 支持 → GEMM 性能降低 8 倍
├── BF16 无专用 Tensor Core → 混合精度收益有限
├── Shared Memory 仅 64KB → Attention tile 受限
└── 显存带宽仅 320GB/s → 严重 Memory-bound
</code></pre>
<p>实际表现：</p>
<ul>
<li>vLLM 自动回退到 xformers 或 FA-1 实现</li>
<li>Kernel 性能比 8.0+ 慢 <strong>3-5 倍</strong></li>
<li>批处理能力弱，batch &gt; 16 后性能不再线性增长（带宽饱和）</li>
</ul>
<p>适用场景：</p>
<pre><code class="hljs language-bash" lang="bash">✓ 离线批量向量化
✓ 开发测试环境
✗ 在线实时推理
✗ 高 QPS 服务
</code></pre>
<h5 data-id="heading-24">A100 的优势</h5>
<pre><code class="hljs language-bash" lang="bash">计算能力 8.0 完整支持：
├── FlashAttention-2 完整启用（利用 cp.async）
├── TF32 自动加速 GEMM（8倍提升）
├── 1555 GB/s 超高带宽（缓解 Memory-bound）
├── 40/80GB 显存支持大 batch
└── HBM2e 高带宽内存（80GB版达2039GB/s）
</code></pre>
<p>实际表现：</p>
<ul>
<li>批处理吞吐量最强</li>
<li>batch=32 时 GPU 利用率 95%+</li>
<li>长时间运行稳定（温度、频率波动小）</li>
<li>80GB 版本可支持更长序列或更大 batch</li>
</ul>
<p>适用场景：</p>
<pre><code class="hljs language-bash" lang="bash">✓ 大规模向量库构建
✓ 7x24 推理服务
✓ 多租户共享环境
✓ 长文档 Embedding（利用大显存）
</code></pre>
<h5 data-id="heading-25">RTX 5090 的特点</h5>
<pre><code class="hljs language-bash" lang="bash">计算能力 12.0 的新特性：
├── 5th Gen Tensor Core（强化 FP8/FP4）
├── 2.5GHz 超高频率
├── 1792 GB/s GDDR7 带宽（接近 A100）
├── 32GB 大显存（消费级罕见）
└── 弱化 TF32，原生 FP8 支持
</code></pre>
<p>实际表现：</p>
<ul>
<li>单请求延迟最低</li>
<li>小 batch 场景性能最强</li>
<li>需要 CUDA 12.4+ 和 PyTorch 2.4+</li>
<li>对 FP8 量化支持极佳（未来潜力大）</li>
</ul>
<p>适用场景：</p>
<pre><code class="hljs language-bash" lang="bash">✓ 在线实时检索
✓ RAG 应用
✓ 边缘推理
✓ 需要大显存的消费级部署（32GB）
</code></pre>
<p>注意事项：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果遇到此错误</span>
nvrtc: error: invalid value <span class="hljs-keyword">for</span> --gpu-architecture (-<span class="hljs-built_in">arch</span>)

<span class="hljs-comment"># 解决方案</span>
pip install torch&gt;=2.4.0 --index-url https://download.pytorch.org/whl/cu124 
</code></pre>
<blockquote>
<p><strong>带宽与算力的平衡</strong>：5090 的算力是 A100 的 5.7 倍，但带宽仅高 15%（vs 40GB A100）。在 Embedding 这类 Memory-bound 任务中，这导致 5090 的吞吐量仅比 A100 高 30%，而非算力差距的 5.7 倍。对于计算密集型任务（如训练），差距会更大。</p>
</blockquote>
<hr/>
<h3 data-id="heading-26">六、计算能力对推理框架的影响</h3>
<h4 data-id="heading-27">6.1 vLLM 的自适应策略</h4>
<p>vLLM 内部有计算能力检测机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># vllm/attention/backends/flash_attn.py</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flash_attn_backend</span>():
    compute_cap = torch.cuda.get_device_capability()
    
    <span class="hljs-keyword">if</span> compute_cap[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">9</span>:
        <span class="hljs-keyword">return</span> FlashAttention3Backend()  <span class="hljs-comment"># Hopper/Blackwell</span>
    <span class="hljs-keyword">elif</span> compute_cap[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">8</span>:
        <span class="hljs-keyword">return</span> FlashAttention2Backend()  <span class="hljs-comment"># Ampere/Ada（需 8.0+）</span>
    <span class="hljs-keyword">elif</span> compute_cap[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">7.5</span>:
        <span class="hljs-keyword">return</span> FlashAttention1Backend()  <span class="hljs-comment"># Turing（有限支持）</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> XFormersBackend()         <span class="hljs-comment"># 旧架构回退</span>
</code></pre>
<p>影响：</p>
<ul>
<li><strong>9.0+</strong>（H100）：使用 FlashAttention-3（TMA 优化）</li>
<li><strong>8.0-8.9</strong>（A100/4090）：使用 FlashAttention-2（cp.async 优化）</li>
<li><strong>7.5</strong>（T4）：使用 FlashAttention-1（功能有限）或 xformers</li>
<li><strong>7.0 以下</strong>：使用标准实现（性能腰斩）</li>
</ul>
<h4 data-id="heading-28">6.2 PyTorch 编译优化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># 编译优化</span>
model = torch.<span class="hljs-built_in">compile</span>(model, backend=<span class="hljs-string">"inductor"</span>)
</code></pre>
<p>Inductor 后端对不同计算能力的优化差异：</p>



































<table><thead><tr><th>计算能力</th><th>Triton Kernel</th><th>TMA 指令</th><th>性能提升</th></tr></thead><tbody><tr><td>7.5</td><td>部分支持</td><td>✗</td><td>+20%</td></tr><tr><td>8.0</td><td>完整支持</td><td>✗</td><td>+45%</td></tr><tr><td>8.9</td><td>完整支持</td><td>✗</td><td>+50%</td></tr><tr><td>12.0</td><td>完整支持</td><td>✓</td><td>+65%</td></tr></tbody></table>
<h4 data-id="heading-29">6.3 量化推理的差异</h4>
<p>FP8 量化（最新趋势）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># FP8 推理需要硬件支持</span>
model = quantize(model, method=<span class="hljs-string">"fp8"</span>)
</code></pre>
<p>支持情况：</p>
<ul>
<li><strong>Compute &lt; 8.9</strong>：不支持 FP8</li>
<li><strong>Compute &gt;= 8.9</strong>（Ada）：支持 FP8（需特定实现）</li>
<li><strong>Compute &gt;= 9.0</strong>（Hopper）：原生 FP8 Tensor Core</li>
<li><strong>Compute &gt;= 12.0</strong>（Blackwell）：强化 FP8/FP4，弱化 FP16/TF32 优化重心</li>
</ul>
<p>实测性能（Qwen3-VL-Embedding）：</p>
<pre><code class="hljs language-bash" lang="bash">FP16 (A100):     156.3 samples/sec
FP8  (H100):     312.5 samples/sec  ← 2倍提升（Hopper FP8 原生支持）
FP8  (5090):     约 380 samples/sec ← 更高算力+GDDR7带宽优势
</code></pre>
<hr/>
<h3 data-id="heading-30">七、生产环境选卡建议</h3>
<h4 data-id="heading-31">7.1 决策树</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[选择 GPU] --&gt; B{使用场景?}
    
    B --&gt;|在线推理| C{QPS 要求?}
    B --&gt;|离线批处理| D{预算?}
    
    C --&gt;|&lt; 100 QPS| E[RTX 4090/5090]
    C --&gt;|&gt; 100 QPS| F[A100/H100]
    
    D --&gt;|有限| G{能接受慢速?}
    D --&gt;|充足| H[A100 集群]
    
    G --&gt;|Yes| I[T4 多卡]
    G --&gt;|No| F
    
    style E fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style F fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    style I fill:#ffebee,stroke:#f44336,stroke-width:2px
    style H fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
</code></pre>
<h4 data-id="heading-32">7.2 具体建议</h4>
<h5 data-id="heading-33">场景 1：创业公司 / 小规模部署</h5>
<p>预算有限，QPS &lt; 50：</p>
<pre><code class="hljs language-bash" lang="bash">推荐：RTX 4090 / RTX 5090
理由：
- 性价比最高（单卡 1-2 万元/2-3 万元）
- 推理性能接近 A100（5090 单请求延迟更低）
- 显存足够（24GB/32GB）
- 5090 的 32GB 可支持更大 batch 或更长序列
</code></pre>
<p>注意事项：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 5090 需要新版本软件栈</span>
CUDA &gt;= 12.4
PyTorch &gt;= 2.4.0
vLLM &gt;= 0.6.0
</code></pre>
<h5 data-id="heading-34">场景 2：中等规模企业</h5>
<p>QPS 100-500，需要稳定性：</p>
<pre><code class="hljs language-bash" lang="bash">推荐：A100 40GB 或 80GB
理由：
- 数据中心级稳定性
- 完整的生态支持
- 7x24 运行温度稳定
- 80GB 版本适合长文档 Embedding（如法律、论文）
</code></pre>
<h5 data-id="heading-35">场景 3：大规模向量库构建</h5>
<p>需要处理百万级文档：</p>
<pre><code class="hljs language-bash" lang="bash">推荐：A100 80GB 集群 或 H100
理由：
- 大 batch 吞吐最强（A100 80GB 带宽更高）
- 显存大支持长文本（80GB）
- H100 FP8 可获得 2 倍吞吐提升（如框架支持）
- 易于扩展
</code></pre>
<h5 data-id="heading-36">场景 4：只是测试 / 学习</h5>
<pre><code class="hljs language-bash" lang="bash">推荐：云服务器
- AWS p3.2xlarge (V100, 7.0)
- GCP n1-standard-4-t4 (T4, 7.5)
- 阿里云 ecs.gn6i (T4, 7.5)
</code></pre>
<p>临时使用按需付费，无需购买硬件。</p>
<h4 data-id="heading-37">7.3 不推荐的选择</h4>
<p>避免踩坑：</p>
<pre><code class="hljs language-bash" lang="bash">✗ 不要选择 GTX 系列（无 Tensor Core）
✗ 不要选择 6.x 架构（Pascal/Volta）
✗ 不要选择低于 8GB 显存的卡
✗ 不要选择矿卡（稳定性差）
✗ 不要盲目相信<span class="hljs-string">"云厂商性价比实例"</span>（某些T4实例实际vGPU切分后性能只剩30%）
</code></pre>
<hr/>
<h3 data-id="heading-38">八、常见问题解答</h3>
<h4 data-id="heading-39">Q1：为什么我的 T4 卡推理这么慢？</h4>
<p>根本原因：</p>
<pre><code class="hljs language-bash" lang="bash">计算能力 7.5 缺少现代 AI 特性
├── 无 TF32 支持
├── BF16 无专用 Tensor Core（与 FP16 共享 ALU）
├── FlashAttention-2/3 无法启用（缺少 cp.async）
├── Tensor Core 代际较老（3rd Gen）
└── 显存带宽瓶颈（320GB/s 严重受限）
</code></pre>
<p>解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 使用较小 batch（避免带宽饱和）</span>
--max-batch-size 8

<span class="hljs-comment"># 2. 关闭某些优化（可能反而更快）</span>
--disable-custom-all-reduce

<span class="hljs-comment"># 3. 使用 FP16（T4 的 BF16 无性能优势）</span>
--dtype float16

<span class="hljs-comment"># 4. 如果可用，限制序列长度以减少内存带宽压力</span>
--max-model-len 1024
</code></pre>
<h4 data-id="heading-40">Q2：A100 和 H100 差距大吗？</h4>
<p>性能对比：</p>









































<table><thead><tr><th>指标</th><th>A100 40GB</th><th>A100 80GB</th><th>H100</th></tr></thead><tbody><tr><td>计算能力</td><td>8.0</td><td>8.0</td><td>9.0</td></tr><tr><td>FP16 TFLOPS</td><td>312</td><td>312</td><td>989</td></tr><tr><td>FP8 支持</td><td>✗</td><td>✗</td><td>✓</td></tr><tr><td>显存带宽</td><td>1555 GB/s</td><td>2039 GB/s</td><td>3352 GB/s</td></tr><tr><td>价格</td><td>1x</td><td>1.3x</td><td>2.5x</td></tr></tbody></table>
<p>实测 Embedding 推理：</p>
<pre><code class="hljs language-bash" lang="bash">A100 40GB: 156 samples/sec
A100 80GB: 178 samples/sec  ← 高带宽优势（+14%）
H100:      298 samples/sec  ← 1.9x（FP16）
H100 FP8:  596 samples/sec  ← 3.8x（需框架支持）
</code></pre>
<p>性价比：</p>
<pre><code class="hljs language-bash" lang="bash">A100 40GB: 156 / 1.0 = 156
A100 80GB: 178 / 1.3 = 137
H100:      298 / 2.5 = 119  
H100 FP8:  596 / 2.5 = 238  ← 如能用 FP8，性价比反超
</code></pre>
<p>结论：对于 Embedding 模型，A100 性价比更高；若框架支持 FP8 推理，H100 更优。</p>
<h4 data-id="heading-41">Q3：5090 比 4090 提升大吗？</h4>
<p>关键差异：</p>
<pre><code class="hljs language-bash" lang="bash">计算能力：8.9 → 12.0
显存：24GB → 32GB（提升33%，可跑更大模型）
带宽：1008 GB/s → 1792 GB/s（+78%，接近 A100）
频率：2520 MHz → 2580 MHz
FP8：软件模拟 → 原生硬件支持（5th Gen Tensor Core）
</code></pre>
<p>实测提升：</p>
<pre><code class="hljs language-bash" lang="bash">Qwen3-VL-Embedding 推理（FP16）：
4090: 178 samples/sec
5090: 204 samples/sec  ← +15%

延迟（单请求）：
4090: 42 ms
5090: 28 ms           ← -33%
</code></pre>
<p>不如账面数据夸张，主要原因：</p>
<ul>
<li>Embedding 模型 Memory-bound，算力无法完全压榨</li>
<li>12.0 的新特性（如 FP8）需要软件生态成熟</li>
<li>但 32GB 显存允许更大的 batch size，实际吞吐可能提升 20-30%</li>
</ul>
<h4 data-id="heading-42">Q4：能用 RTX 3090 跑吗？</h4>
<p>可以，但不推荐：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">RTX 3090:</span> <span class="hljs-string">计算能力</span> <span class="hljs-number">8.6</span>
<span class="hljs-string">✓</span> <span class="hljs-string">支持</span> <span class="hljs-string">TF32</span>
<span class="hljs-string">✓</span> <span class="hljs-string">支持</span> <span class="hljs-string">BF16</span>
<span class="hljs-string">✓</span> <span class="hljs-string">FlashAttention-2</span> <span class="hljs-string">可用</span>
</code></pre>
<p>但问题在于：</p>
<pre><code class="hljs language-bash" lang="bash">显存容量：24GB
显存带宽：936 GB/s  ← 比 4090 低 30%，比 5090 低 48%
</code></pre>
<p>适合：</p>
<ul>
<li>预算非常有限</li>
<li>只做小规模测试</li>
<li>不追求极致性能</li>
</ul>
<blockquote>
<p><strong>注意</strong>：3090 的带宽限制使其在 Embedding 任务中可能成为瓶颈，batch size 较大时性能下降明显。</p>
</blockquote>
<h4 data-id="heading-43">Q5：为什么 5090 算力那么高，Embedding 提升却有限？</h4>
<p>这是<strong>显存带宽瓶颈</strong>的典型表现：</p>
<pre><code class="hljs language-bash" lang="bash">5090 算力：1790 TFLOPS（FP16）
A100 算力：312 TFLOPS（FP16）
理论差距：5.7x

5090 带宽：1792 GB/s
A100 带宽：1555 GB/s（40GB版）
理论差距：1.15x

Embedding 模型特性：每 1 次计算需要 3-4 次显存访问（Memory-bound）
实际性能瓶颈在带宽，而非算力
</code></pre>
<p>因此，<strong>提升显存带宽比提升算力对 Embedding 模型更重要</strong>。H100 的 3352 GB/s 带宽比 5090 更适合大规模 Embedding。</p>
<hr/>
<h3 data-id="heading-44">九、实战部署建议</h3>
<h4 data-id="heading-45">9.1 最优软件栈配置</h4>
<h5 data-id="heading-46">对于 8.0+ 架构（A100/4090/5090）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CUDA</span>
CUDA 12.4 或更新

<span class="hljs-comment"># PyTorch（5090 必须 2.4+）</span>
pip install torch==2.5.0+cu124 --index-url https://download.pytorch.org/whl/cu124 

<span class="hljs-comment"># vLLM（推理框架）</span>
pip install vllm==0.6.3

<span class="hljs-comment"># FlashAttention（必装，A100/4090用 FA2，5090可用 FA3 前瞻版）</span>
pip install flash-attn==2.6.3 --no-build-isolation

<span class="hljs-comment"># xFormers（备用）</span>
pip install xformers==0.0.28.post2
</code></pre>
<h5 data-id="heading-47">对于 7.5 架构（T4）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CUDA</span>
CUDA 11.8 即可（新版对 7.5 优化有限）

<span class="hljs-comment"># PyTorch</span>
pip install torch==2.1.0+cu118 --index-url https://download.pytorch.org/whl/cu118 

<span class="hljs-comment"># vLLM</span>
pip install vllm==0.4.3  <span class="hljs-comment"># 旧版本对 7.5 更友好</span>

<span class="hljs-comment"># FlashAttention-1（如必须，FA2 不支持 7.5）</span>
pip install flash-attn==1.0.9  <span class="hljs-comment"># 旧版本</span>
</code></pre>
<h4 data-id="heading-48">9.2 推理服务启动参数</h4>
<h5 data-id="heading-49">T4 优化配置</h5>
<pre><code class="hljs language-bash" lang="bash">python -m vllm.entrypoints.openai.api_server \
    --model Qwen/Qwen3-VL-Embedding-8B \
    --dtype float16 \
    --max-model-len 2048 \
    --max-num-seqs 8 \
    --gpu-memory-utilization 0.85 \
    --disable-custom-all-reduce
</code></pre>
<h5 data-id="heading-50">A100 40GB 优化配置</h5>
<pre><code class="hljs language-bash" lang="bash">python -m vllm.entrypoints.openai.api_server \
    --model Qwen/Qwen3-VL-Embedding-8B \
    --dtype bfloat16 \
    --max-model-len 4096 \
    --max-num-seqs 64 \
    --gpu-memory-utilization 0.95 \
    --tensor-parallel-size 1
</code></pre>
<h5 data-id="heading-51">A100 80GB 优化配置（适合长文档）</h5>
<pre><code class="hljs language-bash" lang="bash">python -m vllm.entrypoints.openai.api_server \
    --model Qwen/Qwen3-VL-Embedding-8B \
    --dtype bfloat16 \
    --max-model-len 8192 \
    --max-num-seqs 128 \
    --gpu-memory-utilization 0.95
</code></pre>
<h5 data-id="heading-52">RTX 5090 优化配置</h5>
<pre><code class="hljs language-bash" lang="bash">python -m vllm.entrypoints.openai.api_server \
    --model Qwen/Qwen3-VL-Embedding-8B \
    --dtype bfloat16 \
    --max-model-len 4096 \
    --max-num-seqs 48 \
    --gpu-memory-utilization 0.90 \
    --enforce-eager  <span class="hljs-comment"># 新架构建议先用 eager 模式，后续可尝试编译优化</span>
</code></pre>
<h4 data-id="heading-53">9.3 性能监控</h4>
<p>部署后必看的指标：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. GPU 利用率（应 &gt;80%，若低则可能是带宽瓶颈或 batch 太小）</span>
nvidia-smi dmon -s u

<span class="hljs-comment"># 2. 显存带宽利用率（理想应 &gt;70%）</span>
nvidia-smi dmon -s p

<span class="hljs-comment"># 3. 推理延迟</span>
curl http://localhost:8000/metrics | grep latency

<span class="hljs-comment"># 4. 吞吐量</span>
curl http://localhost:8000/metrics | grep throughput
</code></pre>
<p>健康标准：</p>
<pre><code class="hljs language-bash" lang="bash">GPU 利用率：    &gt; 80%
显存带宽利用：  &gt; 70%（Memory-bound 任务）
P50 延迟：      &lt; 100ms
吞吐量：        &gt; 100 samples/sec
</code></pre>
<blockquote>
<p><strong>调试提示</strong>：如果 GPU 利用率低但延迟高，通常是显存带宽饱和（T4 常见问题）或 CPU 预处理瓶颈。</p>
</blockquote>
<h3 data-id="heading-54">十、总结</h3>
<p>计算能力不是参数表里的数字游戏，它决定了：</p>
<pre><code class="hljs language-bash" lang="bash">你的 GPU 属于哪个时代
</code></pre>
<p>记住三个关键点：</p>
<h4 data-id="heading-55">1. 8.0 是 AI 时代的分水岭</h4>
<p>低于 8.0：</p>
<ul>
<li>FlashAttention-2/3 用不了（缺少 cp.async/TMA）</li>
<li>TF32 没有</li>
<li>性能直接腰斩（不仅是算力，更是 Kernel 路径差异）</li>
</ul>
<h4 data-id="heading-56">2. 不同卡的适用场景完全不同</h4>
<pre><code class="hljs language-bash" lang="bash">T4     → 能跑，但慢，适合测试（注意带宽瓶颈）
A100   → 稳定，高吞吐，适合生产（40GB平衡，80GB适合长文本）
5090   → 快速，低延迟，大显存（32GB），适合在线（需 CUDA 12.4+）
</code></pre>
<h4 data-id="heading-57">3. 软件栈必须匹配硬件</h4>
<p>新架构（12.0）必须用新版本：</p>
<pre><code class="hljs language-bash" lang="bash">CUDA &gt;= 12.4
PyTorch &gt;= 2.4
vLLM &gt;= 0.6
</code></pre>
<p>否则直接报错。</p>
<h4 data-id="heading-58">4. 关注显存带宽，不只是算力</h4>
<p>对于 Embedding 这类模型：</p>
<pre><code class="hljs language-bash" lang="bash">性能瓶颈 = min(算力, 显存带宽/3)
</code></pre>
<p>5090 的算力是 A100 的 5.7 倍，但带宽仅高 15%，实际吞吐只高 30%。选择 GPU 时，<strong>显存带宽与算力的比例</strong>比单纯看 TFLOPS 更重要。</p>
<p>选择 GPU 之前，先看 Compute Capability，这比看显存容量更重要。</p>
<p>好了，今天的浩哥课堂就到这里了，下课，“See ya👋🏻👋🏻”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Flow 的协程边界突破：channelFlow 与 callbackFlow 的实战解析]]></title>    <link>https://juejin.cn/post/7600704706551726120</link>    <guid>https://juejin.cn/post/7600704706551726120</guid>    <pubDate>2026-01-30T06:37:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706551726120" data-draft-id="7600681071715368960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Flow 的协程边界突破：channelFlow 与 callbackFlow 的实战解析"/> <meta itemprop="keywords" content="Kotlin,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2026-01-30T06:37:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Flow 的协程边界突破：channelFlow 与 callbackFlow 的实战解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T06:37:25.000Z" title="Fri Jan 30 2026 06:37:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么在普通 Flow 中从另一个协程发射会失败？</h2>
<h4 data-id="heading-1">1. 普通 Flow 是顺序的、同步的</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    <span class="hljs-comment">// 正确：在同一个协程中发射</span>
    emit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment">// 错误：不能在另一个协程中发射</span>
    launch(Dispatchers.IO) {
        <span class="hljs-comment">// emit(2) // 编译错误：emit 只能在 flow builder 的协程中调用</span>
    }
}
</code></pre>
<p>原因：普通 Flow 的 <code>emit()</code> 函数不是线程安全的，且必须在同一个协程上下文中调用。</p>
<h4 data-id="heading-2">2. 结构化并发约束</h4>
<p>普通 Flow 遵守结构化并发原则：当收集器取消时，整个 flow 构建器块都会被取消。如果允许在外部协程发射，难以追踪和管理所有发射源的取消。</p>
<h2 data-id="heading-3">二、ChannelFlow 解决了什么问题？</h2>
<h4 data-id="heading-4">ChannelFlow 的核心价值：跨协程发射</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">channelFlowExample</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = channelFlow {
    <span class="hljs-comment">// 可以在多个协程中并发发射</span>
    launch {
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
            send(i) <span class="hljs-comment">// 使用 send 而不是 emit</span>
            delay(<span class="hljs-number">100</span>)
        }
    }
    
    launch {
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">6.</span><span class="hljs-number">.10</span>) {
            send(i)
            delay(<span class="hljs-number">150</span>)
        }
    }
    
    <span class="hljs-comment">// 等待所有发射完成</span>
    awaitClose()
}
</code></pre>
<h4 data-id="heading-5">解决的问题：</h4>
<h4 data-id="heading-6">1.  并发数据源整合</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mergeMultipleSources</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = channelFlow {
    <span class="hljs-comment">// 多个异步数据源</span>
    <span class="hljs-keyword">val</span> sources = listOf(
        async { fetchFromNetwork() },
        async { readFromDatabase() },
        async { getFromCache() }
    )
    
    sources.forEach { deferred -&gt;
        launch {
            <span class="hljs-keyword">val</span> result = deferred.await()
            result.forEach { item -&gt;
                send(item)
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-7">2.  生产者-消费者模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">producerConsumer</span><span class="hljs-params">()</span></span>: Flow&lt;Data&gt; = channelFlow {
    <span class="hljs-keyword">val</span> channel = <span class="hljs-keyword">this</span>.channel <span class="hljs-comment">// 获取底层的 Channel</span>
    
    <span class="hljs-comment">// 生产者协程</span>
    launch(Dispatchers.IO) {
        <span class="hljs-keyword">while</span> (isActive) {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = produceData()
            send(<span class="hljs-keyword">data</span>)
        }
    }
    
    <span class="hljs-comment">// 另一个生产者</span>
    launch(Dispatchers.Default) {
        processAndSendResults()
    }
}
</code></pre>
<h2 data-id="heading-8">三、CallbackFlow 解决了什么问题？</h2>
<h4 data-id="heading-9">CallbackFlow 的特殊用途：桥接回调API</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">listenToLocationUpdates</span><span class="hljs-params">()</span></span>: Flow&lt;Location&gt; = callbackFlow {
    <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : LocationCallback() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLocationResult</span><span class="hljs-params">(result: <span class="hljs-type">LocationResult</span>)</span></span> {
            result.locations.forEach { location -&gt;
                trySend(location) <span class="hljs-comment">// 非阻塞式发送</span>
            }
        }
    }
    
    <span class="hljs-comment">// 注册回调</span>
    locationClient.requestLocationUpdates(
        request,
        callback,
        Looper.getMainLooper()
    )
    
    <span class="hljs-comment">// 关键：当流被取消时，自动清理资源</span>
    awaitClose {
        locationClient.removeLocationUpdates(callback)
    }
}
</code></pre>
<h4 data-id="heading-10">解决的问题：</h4>
<h4 data-id="heading-11">1. 回调API的Flow化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统回调 → Flow 转换</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onEvent</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(error: <span class="hljs-type">Throwable</span>)</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">listenToEvents</span><span class="hljs-params">()</span></span>: Flow&lt;Event&gt; = callbackFlow {
    <span class="hljs-keyword">val</span> listener = <span class="hljs-keyword">object</span> : EventListener {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onEvent</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span> {
            trySend(event)
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(error: <span class="hljs-type">Throwable</span>)</span></span> {
            close(error)
        }
    }
    
    registerListener(listener)
    
    awaitClose {
        unregisterListener(listener)
    }
}
</code></pre>
<h4 data-id="heading-12">2. 生命周期管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeAndroidLifecycle</span><span class="hljs-params">()</span></span>: Flow&lt;Lifecycle.State&gt; = callbackFlow {
    <span class="hljs-keyword">val</span> observer = LifecycleEventObserver { _, event -&gt;
        <span class="hljs-keyword">when</span> (event) {
            Lifecycle.Event.ON_RESUME -&gt; trySend(Lifecycle.State.RESUMED)
            Lifecycle.Event.ON_PAUSE -&gt; trySend(Lifecycle.State.STARTED)
            <span class="hljs-comment">// ... 其他状态</span>
        }
    }
    
    lifecycle.addObserver(observer)
    
    awaitClose {
        lifecycle.removeObserver(observer)
    }
}
</code></pre>
<h2 data-id="heading-13">四、底层原理对比</h2>









































<table><thead><tr><th>特性</th><th>普通 Flow</th><th>ChannelFlow</th><th>CallbackFlow</th></tr></thead><tbody><tr><td>发射上下文</td><td>必须相同协程</td><td>可跨协程</td><td>可跨协程</td></tr><tr><td>线程安全</td><td>否</td><td>是</td><td>是</td></tr><tr><td>缓冲区</td><td>无</td><td>可配置缓冲区</td><td>可配置缓冲区</td></tr><tr><td>适用场景</td><td>同步/简单异步</td><td>并发数据源</td><td>回调API集成</td></tr><tr><td>取消传播</td><td>自动</td><td>手动管理</td><td>自动清理</td></tr></tbody></table>
<h2 data-id="heading-14">五、实际应用示例</h2>
<h4 data-id="heading-15">示例1：WebSocket 连接</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connectWebSocket</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: Flow&lt;Message&gt; = callbackFlow {
    <span class="hljs-keyword">val</span> webSocket = WebSocketClient(url, <span class="hljs-keyword">object</span> : WebSocketListener() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
            trySend(Message.Text(message))
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClose</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>, reason: <span class="hljs-type">String</span>?)</span></span> {
            close(ClosedException(code, reason))
        }
    })
    
    webSocket.connect()
    
    awaitClose {
        webSocket.disconnect()
    }
}
</code></pre>
<h4 data-id="heading-16">示例2：传感器数据流</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sensorDataFlow</span><span class="hljs-params">(sensor: <span class="hljs-type">Sensor</span>)</span></span>: Flow&lt;SensorData&gt; = channelFlow {
    <span class="hljs-keyword">val</span> sensorManager = getSensorManager()
    
    <span class="hljs-comment">// 在主线程注册监听器</span>
    launch(Dispatchers.Main) {
        sensorManager.registerListener(
            { event -&gt;
                launch(Dispatchers.Default) {
                    <span class="hljs-comment">// 在后台线程处理并发送</span>
                    <span class="hljs-keyword">val</span> processed = processSensorEvent(event)
                    send(processed)
                }
            },
            sensor,
            SensorManager.SENSOR_DELAY_NORMAL
        )
    }
    
    awaitClose {
        sensorManager.unregisterListener()
    }
}
</code></pre>
<h2 data-id="heading-17">六、关键要点</h2>
<h4 data-id="heading-18">1.  ChannelFlow：</h4>
<ul>
<li>用于需要从多个协程并发发射数据的场景</li>
<li>提供了底层的 Channel 作为缓冲区</li>
<li>需要手动处理并发和完成信号</li>
</ul>
<h4 data-id="heading-19">2.  CallbackFlow：</h4>
<ul>
<li>专门用于包装回调式 API</li>
<li>自动处理资源清理（通过 <code>awaitClose</code>）</li>
<li>使用 <code>trySend</code> 避免阻塞</li>
</ul>
<h4 data-id="heading-20">3.  为什么需要它们：</h4>
<ul>
<li>打破普通 Flow 的"单协程发射"限制</li>
<li>支持与现有的异步 API（回调、监听器）集成</li>
<li>提供更灵活的生产者-消费者模式</li>
<li>更好的资源管理和生命周期控制</li>
</ul>
<p>选择哪个取决于具体需求：如果是处理并发数据源，用 <code>channelFlow</code>；如果是包装回调 API，用 <code>callbackFlow</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统]]></title>    <link>https://juejin.cn/post/7600868443832090643</link>    <guid>https://juejin.cn/post/7600868443832090643</guid>    <pubDate>2026-01-30T08:55:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600868443832090643" data-draft-id="7600868443832074259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统"/> <meta itemprop="keywords" content="JetBrains,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2026-01-30T08:55:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:55:09.000Z" title="Fri Jan 30 2026 08:55:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解 Material Design 3 的设计哲学，掌握主题定制、深色模式、动态取色的完整实现方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在前三篇中，我们掌握了 Compose 的核心机制。现在让我们进入实战阶段——使用 Material Design 3 构建美观、一致的界面。</p>
<p>Material Design 3 不仅是组件库，更是一套完整的设计系统。理解它的设计哲学，才能做出优雅的应用。</p>
<p>本篇文章将深入讲解：</p>
<ul>
<li>Material Design 3 的设计哲学与核心概念</li>
<li>MaterialTheme 的源码实现与定制方法</li>
<li>ColorScheme、Typography、Shape 三大系统</li>
<li>深色模式的完整实现方案</li>
<li>动态取色（Dynamic Color）的原理与应用</li>
<li>自定义组件的设计思路</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、Material Design 3 设计哲学</h2>
<h3 data-id="heading-2">1.1 什么是 Material Design？</h3>
<p><strong>Material Design</strong> 是 Google 推出的设计系统，它基于物理世界的隐喻：</p>
<ul>
<li><strong>纸张（Paper）</strong>：界面元素像纸张一样有厚度、有阴影</li>
<li><strong>墨水（Ink）</strong>：内容像墨水一样印在纸张上</li>
<li><strong>光线（Light）</strong>：阴影反映光源位置，创造层次感</li>
</ul>
<h3 data-id="heading-3">1.2 Material Design 3 的核心变化</h3>
<p>相比 Material Design 2，MD3 有三大核心变化：</p>

























<table><thead><tr><th>特性</th><th>MD2</th><th>MD3</th></tr></thead><tbody><tr><td><strong>颜色系统</strong></td><td>主色/辅色/强调色</td><td>基于色度的动态配色</td></tr><tr><td><strong>组件风格</strong></td><td>圆角较小</td><td>更大的圆角，更柔和</td></tr><tr><td><strong>个性化</strong></td><td>固定配色</td><td>支持动态取色</td></tr></tbody></table>
<h3 data-id="heading-4">1.3 MD3 的设计原则</h3>
<h4 data-id="heading-5">1.3.1 个性化（Personalization）</h4>
<p>MD3 强调应用的个性化表达，通过颜色、字体、形状传达品牌特性。</p>
<h4 data-id="heading-6">1.3.2 适应性（Adaptability）</h4>
<p>界面应适应不同的设备、环境和用户需求：</p>
<ul>
<li>响应式布局</li>
<li>深色模式</li>
<li>动态取色</li>
</ul>
<h4 data-id="heading-7">1.3.3 层次结构（Hierarchy）</h4>
<p>通过颜色、阴影、大小区分信息层级：</p>
<ul>
<li>主色用于主要操作</li>
<li>表面色用于背景</li>
<li>强调色用于高亮</li>
</ul>
<hr/>
<h2 data-id="heading-8">二、MaterialTheme 源码解析</h2>
<h3 data-id="heading-9">2.1 MaterialTheme 的结构</h3>
<p>MaterialTheme 是 MD3 的主题容器，它通过 CompositionLocal 向下传递主题配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MaterialTheme</span><span class="hljs-params">(
    colorScheme: <span class="hljs-type">ColorScheme</span> = MaterialTheme.colorScheme,
    typography: <span class="hljs-type">Typography</span> = MaterialTheme.typography,
    shapes: <span class="hljs-type">Shapes</span> = MaterialTheme.shapes,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> rememberedColorScheme = remember { colorScheme }
    <span class="hljs-keyword">val</span> rememberedTypography = remember { typography }
    <span class="hljs-keyword">val</span> rememberedShapes = remember { shapes }
    
    CompositionLocalProvider(
        LocalColorScheme provides rememberedColorScheme,
        LocalTypography provides rememberedTypography,
        LocalShapes provides rememberedShapes
    ) {
        content()
    }
}
</code></pre>
<h3 data-id="heading-10">2.2 MaterialTheme 的组成</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│                     MaterialTheme 结构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ColorScheme（颜色系统）                                  │   │
│  │  ├── primary/primaryContainer                            │   │
│  │  ├── secondary/secondaryContainer                        │   │
│  │  ├── surface/surfaceVariant                              │   │
│  │  ├── background                                          │   │
│  │  ├── error/errorContainer                                │   │
│  │  └── onPrimary/onSecondary/onSurface...                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Typography（字体系统）                                   │   │
│  │  ├── displayLarge/displayMedium/displaySmall             │   │
│  │  ├── headlineLarge/headlineMedium/headlineSmall          │   │
│  │  ├── titleLarge/titleMedium/titleSmall                   │   │
│  │  ├── bodyLarge/bodyMedium/bodySmall                      │   │
│  │  └── labelLarge/labelMedium/labelSmall                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Shapes（形状系统）                                       │   │
│  │  ├── extraSmall/Small/Medium/Large/extraLarge            │   │
│  │  └── 用于 Card、Button、Dialog 等组件                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-11">2.3 访问 MaterialTheme 的值</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 获取颜色</span>
    <span class="hljs-keyword">val</span> colorScheme = MaterialTheme.colorScheme
    <span class="hljs-keyword">val</span> primaryColor = colorScheme.primary
    <span class="hljs-keyword">val</span> surfaceColor = colorScheme.surface
    
    <span class="hljs-comment">// 获取字体</span>
    <span class="hljs-keyword">val</span> typography = MaterialTheme.typography
    <span class="hljs-keyword">val</span> titleStyle = typography.titleLarge
    <span class="hljs-keyword">val</span> bodyStyle = typography.bodyMedium
    
    <span class="hljs-comment">// 获取形状</span>
    <span class="hljs-keyword">val</span> shapes = MaterialTheme.shapes
    <span class="hljs-keyword">val</span> cardShape = shapes.medium
}
</code></pre>
<hr/>
<h2 data-id="heading-12">三、ColorScheme 颜色系统深度解析</h2>
<h3 data-id="heading-13">3.1 为什么需要 ColorScheme？</h3>
<p>传统的颜色管理存在以下问题：</p>
<ul>
<li>颜色分散在代码各处，难以维护</li>
<li>深色模式需要手动替换每个颜色</li>
<li>品牌色变化时需要全局搜索替换</li>
</ul>
<p><strong>ColorScheme 的解决方案</strong>：</p>
<ul>
<li>集中定义所有颜色</li>
<li>语义化命名（primary、surface、error 等）</li>
<li>自动支持深色模式</li>
</ul>
<h3 data-id="heading-14">3.2 ColorScheme 的颜色角色</h3>
<p>MD3 定义了 28 个颜色角色，每个都有明确的语义：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">ColorScheme</span> <span class="hljs-string">颜色角色</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">主要颜色（Primary）-</span> <span class="hljs-string">主要操作、突出显示</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">primary:</span> <span class="hljs-string">主色（按钮、选中状态）</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onPrimary:</span> <span class="hljs-string">主色上的文字/图标</span>                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">primaryContainer:</span> <span class="hljs-string">主色容器（选中项背景）</span>                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onPrimaryContainer:</span> <span class="hljs-string">主色容器上的文字</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">次要颜色（Secondary）-</span> <span class="hljs-string">次要操作、筛选器</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">secondary:</span> <span class="hljs-string">次要色</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSecondary:</span> <span class="hljs-string">次要色上的文字</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">secondaryContainer:</span> <span class="hljs-string">次要色容器</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onSecondaryContainer:</span> <span class="hljs-string">次要色容器上的文字</span>                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">第三颜色（Tertiary）-</span> <span class="hljs-string">对比强调</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">tertiary:</span> <span class="hljs-string">第三色</span>                                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onTertiary:</span> <span class="hljs-string">第三色上的文字</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">tertiaryContainer:</span> <span class="hljs-string">第三色容器</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onTertiaryContainer:</span> <span class="hljs-string">第三色容器上的文字</span>                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">表面颜色（Surface）-</span> <span class="hljs-string">背景、卡片</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surface:</span> <span class="hljs-string">最底层背景</span>                                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSurface:</span> <span class="hljs-string">表面上的文字</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surfaceVariant:</span> <span class="hljs-string">变体表面（区分层次）</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSurfaceVariant:</span> <span class="hljs-string">变体表面上的文字</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surfaceTint:</span> <span class="hljs-string">表面色调（用于</span> <span class="hljs-string">elevation）</span>                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">inverseSurface/inverseOnSurface:</span> <span class="hljs-string">反色表面</span>                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">背景颜色（Background）-</span> <span class="hljs-string">页面背景</span>                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">background:</span> <span class="hljs-string">页面背景</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onBackground:</span> <span class="hljs-string">背景上的文字</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">错误颜色（Error）-</span> <span class="hljs-string">错误状态</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">error:</span> <span class="hljs-string">错误色</span>                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onError:</span> <span class="hljs-string">错误色上的文字</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">errorContainer:</span> <span class="hljs-string">错误色容器</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onErrorContainer:</span> <span class="hljs-string">错误色容器上的文字</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">轮廓颜色（Outline）-</span> <span class="hljs-string">边框、分割线</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">outline:</span> <span class="hljs-string">轮廓色</span>                                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">outlineVariant:</span> <span class="hljs-string">变体轮廓色</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">阴影颜色（Scrim/Shadow）</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">scrim:</span> <span class="hljs-string">遮罩层颜色</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">shadow:</span> <span class="hljs-string">阴影颜色</span>                                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-15">3.3 颜色角色的使用规范</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确使用颜色角色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = MaterialTheme.colorScheme.primary,
        contentColor = MaterialTheme.colorScheme.onPrimary
    )
) {
    Text(<span class="hljs-string">"确认"</span>)
}

Card(
    colors = CardDefaults.cardColors(
        containerColor = MaterialTheme.colorScheme.surfaceVariant
    )
) {
    Text(
        text = <span class="hljs-string">"内容"</span>,
        color = MaterialTheme.colorScheme.onSurfaceVariant
    )
}

<span class="hljs-comment">// ❌ 错误：硬编码颜色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = Color(<span class="hljs-number">0xFF6750A4</span>)  <span class="hljs-comment">// 硬编码</span>
    )
) {
    Text(<span class="hljs-string">"确认"</span>)
}
</code></pre>
<h3 data-id="heading-16">3.4 创建自定义 ColorScheme</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 浅色主题</span>
<span class="hljs-keyword">val</span> LightColorScheme = lightColorScheme(
    primary = Color(<span class="hljs-number">0xFF6750A4</span>),
    onPrimary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    primaryContainer = Color(<span class="hljs-number">0xFFEADDFF</span>),
    onPrimaryContainer = Color(<span class="hljs-number">0xFF21005D</span>),
    secondary = Color(<span class="hljs-number">0xFF625B71</span>),
    onSecondary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    secondaryContainer = Color(<span class="hljs-number">0xFFE8DEF8</span>),
    onSecondaryContainer = Color(<span class="hljs-number">0xFF1D192B</span>),
    tertiary = Color(<span class="hljs-number">0xFF7D5260</span>),
    onTertiary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    tertiaryContainer = Color(<span class="hljs-number">0xFFFFD8E4</span>),
    onTertiaryContainer = Color(<span class="hljs-number">0xFF31111D</span>),
    error = Color(<span class="hljs-number">0xFFB3261E</span>),
    onError = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    errorContainer = Color(<span class="hljs-number">0xFFF9DEDC</span>),
    onErrorContainer = Color(<span class="hljs-number">0xFF410E0B</span>),
    background = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onBackground = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surface = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onSurface = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surfaceVariant = Color(<span class="hljs-number">0xFFE7E0EC</span>),
    onSurfaceVariant = Color(<span class="hljs-number">0xFF49454F</span>),
    outline = Color(<span class="hljs-number">0xFF79747E</span>),
    outlineVariant = Color(<span class="hljs-number">0xFFCAC4D0</span>),
    scrim = Color(<span class="hljs-number">0xFF000000</span>),
    inverseSurface = Color(<span class="hljs-number">0xFF313033</span>),
    inverseOnSurface = Color(<span class="hljs-number">0xFFF4EFF4</span>),
    inversePrimary = Color(<span class="hljs-number">0xFFD0BCFF</span>),
    surfaceTint = Color(<span class="hljs-number">0xFF6750A4</span>)
)

<span class="hljs-comment">// 深色主题</span>
<span class="hljs-keyword">val</span> DarkColorScheme = darkColorScheme(
    primary = Color(<span class="hljs-number">0xFFD0BCFF</span>),
    onPrimary = Color(<span class="hljs-number">0xFF381E72</span>),
    primaryContainer = Color(<span class="hljs-number">0xFF4F378B</span>),
    onPrimaryContainer = Color(<span class="hljs-number">0xFFEADDFF</span>),
    <span class="hljs-comment">// ... 其他颜色</span>
)
</code></pre>
<h3 data-id="heading-17">3.5 颜色生成工具</h3>
<p>Google 提供了 Material Theme Builder 工具，可以自动生成完整的 ColorScheme：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基于种子色生成 ColorScheme</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateColorScheme</span><span class="hljs-params">(seedColor: <span class="hljs-type">Color</span>, isDark: <span class="hljs-type">Boolean</span>)</span></span>: ColorScheme {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (isDark) {
        darkColorScheme(
            primary = seedColor,
            <span class="hljs-comment">// ... 工具会自动计算其他颜色</span>
        )
    } <span class="hljs-keyword">else</span> {
        lightColorScheme(
            primary = seedColor,
            <span class="hljs-comment">// ...</span>
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-18">四、Typography 字体系统</h2>
<h3 data-id="heading-19">4.1 为什么需要 Typography？</h3>
<p>字体是界面设计的重要组成部分，Typography 系统提供了：</p>
<ul>
<li>一致的字体大小和字重</li>
<li>语义化的字体角色</li>
<li>自动适配不同屏幕尺寸</li>
</ul>
<h3 data-id="heading-20">4.2 MD3 的字体角色</h3>
<p>MD3 定义了 15 个字体角色，分为 5 大类：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">Typography</span> <span class="hljs-string">字体角色</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Display（展示）-</span> <span class="hljs-string">最大的文字，用于品牌展示</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">displayLarge:</span> <span class="hljs-string">57sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">displayMedium:</span> <span class="hljs-string">45sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">displaySmall:</span> <span class="hljs-string">36sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Headline（标题）-</span> <span class="hljs-string">页面标题、模块标题</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">headlineLarge:</span> <span class="hljs-string">32sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">headlineMedium:</span> <span class="hljs-string">28sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">headlineSmall:</span> <span class="hljs-string">24sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Title（标题）-</span> <span class="hljs-string">卡片标题、列表项标题</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">titleLarge:</span> <span class="hljs-string">22sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">titleMedium:</span> <span class="hljs-string">16sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">titleSmall:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Body（正文）-</span> <span class="hljs-string">主要内容、段落</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">bodyLarge:</span> <span class="hljs-string">16sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">bodyMedium:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">bodySmall:</span> <span class="hljs-string">12sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Label（标签）-</span> <span class="hljs-string">按钮、输入框标签、小字</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">labelLarge:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">labelMedium:</span> <span class="hljs-string">12sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">labelSmall:</span> <span class="hljs-string">11sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-21">4.3 创建自定义 Typography</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> AppTypography = Typography(
    displayLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">57.</span>sp,
        lineHeight = <span class="hljs-number">64.</span>sp,
        letterSpacing = (-<span class="hljs-number">0.25</span>).sp
    ),
    displayMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">45.</span>sp,
        lineHeight = <span class="hljs-number">52.</span>sp,
        letterSpacing = <span class="hljs-number">0.</span>sp
    ),
    <span class="hljs-comment">// ... 其他字体角色</span>
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">16.</span>sp,
        lineHeight = <span class="hljs-number">24.</span>sp,
        letterSpacing = <span class="hljs-number">0.5</span>.sp
    ),
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = <span class="hljs-number">22.</span>sp,
        lineHeight = <span class="hljs-number">28.</span>sp,
        letterSpacing = <span class="hljs-number">0.</span>sp
    )
)
</code></pre>
<h3 data-id="heading-22">4.4 使用自定义字体</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 加载字体资源</span>
<span class="hljs-keyword">val</span> InterFontFamily = FontFamily(
    Font(R.font.inter_regular, FontWeight.Normal),
    Font(R.font.inter_medium, FontWeight.Medium),
    Font(R.font.inter_semibold, FontWeight.SemiBold),
    Font(R.font.inter_bold, FontWeight.Bold)
)

<span class="hljs-comment">// 应用到 Typography</span>
<span class="hljs-keyword">val</span> AppTypography = Typography(
    displayLarge = TextStyle(
        fontFamily = InterFontFamily,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">57.</span>sp
    ),
    <span class="hljs-comment">// ...</span>
)
</code></pre>
<h3 data-id="heading-23">4.5 字体使用规范</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确使用字体角色</span>
Text(
    text = <span class="hljs-string">"页面标题"</span>,
    style = MaterialTheme.typography.headlineMedium
)

Text(
    text = <span class="hljs-string">"卡片标题"</span>,
    style = MaterialTheme.typography.titleLarge
)

Text(
    text = <span class="hljs-string">"正文内容"</span>,
    style = MaterialTheme.typography.bodyMedium
)

Button(onClick = { }) {
    Text(
        text = <span class="hljs-string">"按钮"</span>,
        style = MaterialTheme.typography.labelLarge
    )
}

<span class="hljs-comment">// ❌ 错误：硬编码字体大小</span>
Text(
    text = <span class="hljs-string">"标题"</span>,
    fontSize = <span class="hljs-number">24.</span>sp  <span class="hljs-comment">// 硬编码</span>
)
</code></pre>
<hr/>
<h2 data-id="heading-24">五、Shape 形状系统</h2>
<h3 data-id="heading-25">5.1 Shape 的作用</h3>
<p>Shape 系统定义了组件的圆角大小，影响界面的整体风格：</p>
<ul>
<li>大圆角：柔和、友好</li>
<li>小圆角：专业、严肃</li>
<li>无圆角：硬朗、现代</li>
</ul>
<h3 data-id="heading-26">5.2 MD3 的形状角色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> Shapes = Shapes(
    extraSmall = RoundedCornerShape(<span class="hljs-number">4.</span>dp),   <span class="hljs-comment">// 小标签、芯片</span>
    small = RoundedCornerShape(<span class="hljs-number">8.</span>dp),        <span class="hljs-comment">// 按钮、输入框</span>
    medium = RoundedCornerShape(<span class="hljs-number">12.</span>dp),      <span class="hljs-comment">// 卡片</span>
    large = RoundedCornerShape(<span class="hljs-number">16.</span>dp),       <span class="hljs-comment">// 对话框</span>
    extraLarge = RoundedCornerShape(<span class="hljs-number">28.</span>dp)   <span class="hljs-comment">// 底部 Sheet</span>
)
</code></pre>
<h3 data-id="heading-27">5.3 组件默认形状</h3>



































<table><thead><tr><th>组件</th><th>默认形状</th><th>说明</th></tr></thead><tbody><tr><td>Button</td><td>small (8.dp)</td><td>标准按钮</td></tr><tr><td>Card</td><td>medium (12.dp)</td><td>卡片容器</td></tr><tr><td>Dialog</td><td>extraLarge (28.dp)</td><td>对话框</td></tr><tr><td>TextField</td><td>small (8.dp)</td><td>输入框</td></tr><tr><td>FloatingActionButton</td><td>large (16.dp)</td><td>浮动按钮</td></tr></tbody></table>
<h3 data-id="heading-28">5.4 自定义组件形状</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 覆盖组件默认形状</span>
Button(
    onClick = { },
    shape = MaterialTheme.shapes.medium  <span class="hljs-comment">// 使用 medium 而不是默认 small</span>
) {
    Text(<span class="hljs-string">"圆角按钮"</span>)
}

<span class="hljs-comment">// 使用 CutCornerShape 创建切割角</span>
<span class="hljs-keyword">val</span> CutShapes = Shapes(
    medium = CutCornerShape(
        topStart = <span class="hljs-number">12.</span>dp,
        topEnd = <span class="hljs-number">0.</span>dp,
        bottomEnd = <span class="hljs-number">12.</span>dp,
        bottomStart = <span class="hljs-number">0.</span>dp
    )
)
</code></pre>
<hr/>
<h2 data-id="heading-29">六、深色模式完整实现</h2>
<h3 data-id="heading-30">6.1 为什么需要深色模式？</h3>
<ul>
<li><strong>用户体验</strong>：在低光环境下更舒适的阅读体验</li>
<li><strong>设备续航</strong>：OLED 屏幕显示黑色时更省电</li>
<li><strong>个性化</strong>：满足用户的审美偏好</li>
</ul>
<h3 data-id="heading-31">6.2 深色模式的设计原则</h3>
<h4 data-id="heading-32">6.2.1 颜色反转规则</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    深色模式颜色映射                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  浅色模式                    深色模式                            │
│  ─────────────────────────────────────────────────────────────  │
│  <span class="hljs-attribute">background</span> (#FFFBFE)  →   <span class="hljs-attribute">background</span> (#<span class="hljs-number">1</span>C1B1F)                 │
│  surface (#FFFBFE)     →   surface (#<span class="hljs-number">1</span>C1B1F)                   │
│  onSurface (#<span class="hljs-number">1</span>C1B1F)   →   onSurface (#E6E1E5)                 │
│  primary (#<span class="hljs-number">6750</span>A4)     →   primary (#D0BCFF)                   │
│  onPrimary (#FFFFFF)   →   onPrimary (#<span class="hljs-number">381</span>E72)                 │
│                                                                 │
│  核心原则：降低亮度，保持对比度                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-33">6.2.2 Elevation 在深色模式中的表现</h4>
<p>在深色模式下，elevation 不使用阴影，而是使用<strong>表面变亮</strong>来表示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深色模式下，elevation 越高，surface 越亮</span>
Card(
    modifier = Modifier.height(<span class="hljs-number">48.</span>dp),
    colors = CardDefaults.elevatedCardColors()
) {
    <span class="hljs-comment">// 内容</span>
}
</code></pre>
<h3 data-id="heading-34">6.3 实现深色模式</h3>
<h4 data-id="heading-35">6.3.1 定义深色 ColorScheme</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深色主题颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80,
    background = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surface = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    onSurface = Color(<span class="hljs-number">0xFFE6E1E5</span>)
)

<span class="hljs-comment">// 浅色主题颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> LightColorScheme = lightColorScheme(
    primary = Purple40,
    secondary = PurpleGrey40,
    tertiary = Pink40,
    background = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    surface = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onSurface = Color(<span class="hljs-number">0xFF1C1B1F</span>)
)
</code></pre>
<h4 data-id="heading-36">6.3.2 检测系统主题</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    darkTheme: <span class="hljs-type">Boolean</span> = isSystemInDarkTheme()</span></span>  <span class="hljs-comment">// 检测系统主题</span>
) {
    <span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">if</span> (darkTheme) {
        DarkColorScheme
    } <span class="hljs-keyword">else</span> {
        LightColorScheme
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = Shapes,
        content = content
    )
}
</code></pre>
<h4 data-id="heading-37">6.3.3 主题切换功能</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 DataStore 保存用户主题偏好</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemePreference</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataStore: DataStore&lt;Preferences&gt;) {
    <span class="hljs-keyword">val</span> themeFlow: Flow&lt;ThemeMode&gt; = dataStore.<span class="hljs-keyword">data</span>
        .map { preferences -&gt;
            <span class="hljs-keyword">when</span> (preferences[THEME_KEY]) {
                <span class="hljs-string">"light"</span> -&gt; ThemeMode.LIGHT
                <span class="hljs-string">"dark"</span> -&gt; ThemeMode.DARK
                <span class="hljs-keyword">else</span> -&gt; ThemeMode.SYSTEM
            }
        }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setTheme</span><span class="hljs-params">(theme: <span class="hljs-type">ThemeMode</span>)</span></span> {
        dataStore.edit { preferences -&gt;
            preferences[THEME_KEY] = <span class="hljs-keyword">when</span> (theme) {
                ThemeMode.LIGHT -&gt; <span class="hljs-string">"light"</span>
                ThemeMode.DARK -&gt; <span class="hljs-string">"dark"</span>
                ThemeMode.SYSTEM -&gt; <span class="hljs-string">"system"</span>
            }
        }
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> THEME_KEY = stringPreferencesKey(<span class="hljs-string">"theme"</span>)
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeMode</span> {
    LIGHT, DARK, SYSTEM
}

<span class="hljs-comment">// 在应用中使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    themePreference: <span class="hljs-type">ThemePreference</span>
)</span></span> {
    <span class="hljs-keyword">val</span> themeMode <span class="hljs-keyword">by</span> themePreference.themeFlow.collectAsState(ThemeMode.SYSTEM)
    <span class="hljs-keyword">val</span> systemDarkTheme = isSystemInDarkTheme()
    
    <span class="hljs-keyword">val</span> darkTheme = <span class="hljs-keyword">when</span> (themeMode) {
        ThemeMode.LIGHT -&gt; <span class="hljs-literal">false</span>
        ThemeMode.DARK -&gt; <span class="hljs-literal">true</span>
        ThemeMode.SYSTEM -&gt; systemDarkTheme
    }
    
    MaterialTheme(
        colorScheme = <span class="hljs-keyword">if</span> (darkTheme) DarkColorScheme <span class="hljs-keyword">else</span> LightColorScheme,
        content = content
    )
}

<span class="hljs-comment">// 主题设置界面</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemeSettings</span><span class="hljs-params">(
    themePreference: <span class="hljs-type">ThemePreference</span>
)</span></span> {
    <span class="hljs-keyword">val</span> themeMode <span class="hljs-keyword">by</span> themePreference.themeFlow.collectAsState(ThemeMode.SYSTEM)
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    
    Column {
        Text(<span class="hljs-string">"主题设置"</span>, style = MaterialTheme.typography.titleLarge)
        
        ThemeOption(
            title = <span class="hljs-string">"跟随系统"</span>,
            selected = themeMode == ThemeMode.SYSTEM,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.SYSTEM) } }
        )
        
        ThemeOption(
            title = <span class="hljs-string">"浅色模式"</span>,
            selected = themeMode == ThemeMode.LIGHT,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.LIGHT) } }
        )
        
        ThemeOption(
            title = <span class="hljs-string">"深色模式"</span>,
            selected = themeMode == ThemeMode.DARK,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.DARK) } }
        )
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemeOption</span><span class="hljs-params">(
    title: <span class="hljs-type">String</span>,
    selected: <span class="hljs-type">Boolean</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(<span class="hljs-number">16.</span>dp),
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(title)
        <span class="hljs-keyword">if</span> (selected) {
            Icon(Icons.Default.Check, contentDescription = <span class="hljs-literal">null</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-38">6.4 深色模式最佳实践</h3>
<h4 data-id="heading-39">6.4.1 避免纯黑色</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：使用纯黑色</span>
<span class="hljs-keyword">val</span> DarkBackground = Color(<span class="hljs-number">0xFF000000</span>)

<span class="hljs-comment">// ✅ 正确：使用深灰色</span>
<span class="hljs-keyword">val</span> DarkBackground = Color(<span class="hljs-number">0xFF1C1B1F</span>)  <span class="hljs-comment">// 推荐</span>
</code></pre>
<h4 data-id="heading-40">6.4.2 保持对比度</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 确保文字对比度符合 WCAG 标准</span>
<span class="hljs-comment">// 深色模式下，onSurface 应该是浅色</span>
<span class="hljs-keyword">val</span> onSurfaceDark = Color(<span class="hljs-number">0xFFE6E1E5</span>)  <span class="hljs-comment">// 对比度 &gt; 4.5:1</span>
</code></pre>
<h4 data-id="heading-41">6.4.3 图片适配</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为深色模式提供不同的图片资源</span>
Image(
    painter = painterResource(
        <span class="hljs-keyword">if</span> (isSystemInDarkTheme()) {
            R.drawable.logo_dark
        } <span class="hljs-keyword">else</span> {
            R.drawable.logo_light
        }
    ),
    contentDescription = <span class="hljs-literal">null</span>
)
</code></pre>
<hr/>
<h2 data-id="heading-42">七、动态取色（Dynamic Color）</h2>
<h3 data-id="heading-43">7.1 什么是动态取色？</h3>
<p><strong>动态取色</strong>是 Android 12+ 引入的功能，应用可以根据用户设置的壁纸自动生成配色方案。</p>
<h3 data-id="heading-44">7.2 动态取色的原理</h3>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────┐
│                    动态取色流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 提取壁纸主色调                                               │
│     ├── 使用 quantizer 算法提取主要颜色                         │
│     └── 筛选出符合无障碍标准的颜色                              │
│                              ↓                                  │
│  2. 生成色板（Tonal Palette）                                   │
│     ├── 基于主色生成不同色调的变体                              │
│     └── 创建 Primary、Secondary、Tertiary、Neutral 色板        │
│                              ↓                                  │
│  3. 映射到 ColorScheme                                          │
│     ├── <span class="hljs-attr">primary</span> = 主色板的 <span class="hljs-number">40</span> 色调                              │
│     ├── <span class="hljs-attr">primaryContainer</span> = 主色板的 <span class="hljs-number">90</span> 色调                     │
│     └── ...                                                    │
│                              ↓                                  │
│  4. 应用到应用                                                  │
│     └── MaterialTheme 使用动态 ColorScheme                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-45">7.3 实现动态取色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    dynamicColor: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>
)</span></span> {
    <span class="hljs-keyword">val</span> darkTheme = isSystemInDarkTheme()
    
    <span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">when</span> {
        <span class="hljs-comment">// Android 12+ 支持动态取色</span>
        dynamicColor &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S -&gt; {
            <span class="hljs-keyword">val</span> context = LocalContext.current
            <span class="hljs-keyword">if</span> (darkTheme) {
                dynamicDarkColorScheme(context)
            } <span class="hljs-keyword">else</span> {
                dynamicLightColorScheme(context)
            }
        }
        <span class="hljs-comment">// 使用预定义主题</span>
        darkTheme -&gt; DarkColorScheme
        <span class="hljs-keyword">else</span> -&gt; LightColorScheme
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = Shapes,
        content = content
    )
}
</code></pre>
<h3 data-id="heading-46">7.4 动态取色最佳实践</h3>
<h4 data-id="heading-47">7.4.1 提供关闭选项</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 让用户选择是否使用动态取色</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ColorPreference</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataStore: DataStore&lt;Preferences&gt;) {
    <span class="hljs-keyword">val</span> dynamicColorFlow: Flow&lt;<span class="hljs-built_in">Boolean</span>&gt; = dataStore.<span class="hljs-keyword">data</span>
        .map { it[DYNAMIC_COLOR_KEY] ?: <span class="hljs-literal">true</span> }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setDynamicColor</span><span class="hljs-params">(enabled: <span class="hljs-type">Boolean</span>)</span></span> {
        dataStore.edit { it[DYNAMIC_COLOR_KEY] = enabled }
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> DYNAMIC_COLOR_KEY = booleanPreferencesKey(<span class="hljs-string">"dynamic_color"</span>)
    }
}
</code></pre>
<h4 data-id="heading-48">7.4.2 备用方案</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 当动态取色不可用时，使用品牌色</span>
<span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">if</span> (dynamicColor &amp;&amp; supportsDynamicColor()) {
    dynamicLightColorScheme(context)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用应用的品牌色</span>
    lightColorScheme(
        primary = BrandPrimary,
        secondary = BrandSecondary
    )
}
</code></pre>
<hr/>
<h2 data-id="heading-49">八、Material 组件深度解析</h2>
<h3 data-id="heading-50">8.1 Button 组件</h3>
<h4 data-id="heading-51">8.1.1 Button 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. FilledButton（填充按钮）- 主要操作</span>
Button(onClick = { }) {
    Text(<span class="hljs-string">"确认"</span>)
}

<span class="hljs-comment">// 2. ElevatedButton（凸起按钮）- 需要强调的操作</span>
ElevatedButton(onClick = { }) {
    Text(<span class="hljs-string">"重要操作"</span>)
}

<span class="hljs-comment">// 3. OutlinedButton（描边按钮）- 次要操作</span>
OutlinedButton(onClick = { }) {
    Text(<span class="hljs-string">"取消"</span>)
}

<span class="hljs-comment">// 4. TextButton（文本按钮）- 最低优先级操作</span>
TextButton(onClick = { }) {
    Text(<span class="hljs-string">"了解更多"</span>)
}

<span class="hljs-comment">// 5. IconButton（图标按钮）</span>
IconButton(onClick = { }) {
    Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
}

<span class="hljs-comment">// 6. FloatingActionButton（浮动按钮）</span>
FloatingActionButton(onClick = { }) {
    Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
}
</code></pre>
<h4 data-id="heading-52">8.1.2 Button 的设计规范</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│                    <span class="hljs-selector-tag">Button</span> 使用规范                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  按钮层级（从高到低）：                                          │
│                                                                 │
│  <span class="hljs-number">1</span>. FilledButton                                                │
│     ├── 用途：最重要的操作                                       │
│     ├── 数量：每屏最多 <span class="hljs-number">1</span> 个                                      │
│     └── 位置：底部或操作区域                                     │
│                                                                 │
│  <span class="hljs-number">2</span>. ElevatedButton                                              │
│     ├── 用途：需要强调的操作                                     │
│     └── 场景：在背景复杂的区域                                   │
│                                                                 │
│  <span class="hljs-number">3</span>. OutlinedButton                                              │
│     ├── 用途：次要操作                                           │
│     ├── 数量：可以有多个                                         │
│     └── 场景：与 FilledButton 配合使用                           │
│                                                                 │
│  <span class="hljs-number">4</span>. TextButton                                                  │
│     ├── 用途：最低优先级操作                                     │
│     └── 场景：工具栏、对话框                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-53">8.1.3 自定义 Button</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义颜色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = MaterialTheme.colorScheme.primary,
        contentColor = MaterialTheme.colorScheme.onPrimary,
        disabledContainerColor = MaterialTheme.colorScheme.surfaceVariant,
        disabledContentColor = MaterialTheme.colorScheme.onSurfaceVariant
    )
) {
    Text(<span class="hljs-string">"自定义按钮"</span>)
}

<span class="hljs-comment">// 带图标的按钮</span>
Button(onClick = { }) {
    Icon(Icons.Default.Send, contentDescription = <span class="hljs-literal">null</span>)
    Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
    Text(<span class="hljs-string">"发送"</span>)
}
</code></pre>
<h3 data-id="heading-54">8.2 Card 组件</h3>
<h4 data-id="heading-55">8.2.1 Card 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 普通 Card</span>
Card(
    modifier = Modifier.fillMaxWidth(),
    onClick = { }
) {
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        Text(<span class="hljs-string">"卡片标题"</span>, style = MaterialTheme.typography.titleLarge)
        Text(<span class="hljs-string">"卡片内容"</span>, style = MaterialTheme.typography.bodyMedium)
    }
}

<span class="hljs-comment">// 2. ElevatedCard（带阴影）</span>
ElevatedCard(
    modifier = Modifier.fillMaxWidth(),
    elevation = CardDefaults.elevatedCardElevation(
        defaultElevation = <span class="hljs-number">6.</span>dp
    )
) {
    <span class="hljs-comment">// 内容</span>
}

<span class="hljs-comment">// 3. OutlinedCard（带边框）</span>
OutlinedCard(
    modifier = Modifier.fillMaxWidth()
) {
    <span class="hljs-comment">// 内容</span>
}
</code></pre>
<h4 data-id="heading-56">8.2.2 Card 的设计规范</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 卡片内容结构</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ArticleCard</span><span class="hljs-params">(article: <span class="hljs-type">Article</span>)</span></span> {
    Card(
        modifier = Modifier.fillMaxWidth(),
        onClick = { }
    ) {
        Column {
            <span class="hljs-comment">// 图片（可选）</span>
            AsyncImage(
                model = article.imageUrl,
                contentDescription = <span class="hljs-literal">null</span>,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(<span class="hljs-number">194.</span>dp),
                contentScale = ContentScale.Crop
            )
            
            <span class="hljs-comment">// 内容区域</span>
            Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
                <span class="hljs-comment">// 标题</span>
                Text(
                    text = article.title,
                    style = MaterialTheme.typography.titleLarge
                )
                
                <span class="hljs-comment">// 副标题（可选）</span>
                Text(
                    text = article.subtitle,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                <span class="hljs-comment">// 操作按钮</span>
                Row(
                    modifier = Modifier.padding(top = <span class="hljs-number">16.</span>dp),
                    horizontalArrangement = Arrangement.End
                ) {
                    TextButton(onClick = { }) {
                        Text(<span class="hljs-string">"阅读更多"</span>)
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-57">8.3 TextField 组件</h3>
<h4 data-id="heading-58">8.3.1 TextField 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. OutlinedTextField（描边样式）</span>
<span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
OutlinedTextField(
    value = text,
    onValueChange = { text = it },
    label = { Text(<span class="hljs-string">"用户名"</span>) },
    placeholder = { Text(<span class="hljs-string">"请输入用户名"</span>) },
    leadingIcon = {
        Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
    },
    trailingIcon = {
        <span class="hljs-keyword">if</span> (text.isNotEmpty()) {
            IconButton(onClick = { text = <span class="hljs-string">""</span> }) {
                Icon(Icons.Default.Clear, contentDescription = <span class="hljs-string">"清除"</span>)
            }
        }
    },
    isError = text.length &gt; <span class="hljs-number">20</span>,
    supportingText = {
        <span class="hljs-keyword">if</span> (text.length &gt; <span class="hljs-number">20</span>) {
            Text(<span class="hljs-string">"用户名不能超过 20 个字符"</span>)
        }
    }
)

<span class="hljs-comment">// 2. TextField（填充样式）</span>
TextField(
    value = text,
    onValueChange = { text = it },
    label = { Text(<span class="hljs-string">"密码"</span>) },
    visualTransformation = PasswordVisualTransformation(),
    keyboardOptions = KeyboardOptions(
        keyboardType = KeyboardType.Password
    )
)
</code></pre>
<h4 data-id="heading-59">8.3.2 表单验证</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginForm</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> email <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> password <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-keyword">val</span> emailError = <span class="hljs-keyword">if</span> (email.isNotEmpty() &amp;&amp; !email.isValidEmail()) {
        <span class="hljs-string">"请输入有效的邮箱地址"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">val</span> passwordError = <span class="hljs-keyword">if</span> (password.isNotEmpty() &amp;&amp; password.length &lt; <span class="hljs-number">6</span>) {
        <span class="hljs-string">"密码不能少于 6 位"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    
    Column {
        OutlinedTextField(
            value = email,
            onValueChange = { email = it },
            label = { Text(<span class="hljs-string">"邮箱"</span>) },
            isError = emailError != <span class="hljs-literal">null</span>,
            supportingText = emailError?.let { { Text(it) } }
        )
        
        OutlinedTextField(
            value = password,
            onValueChange = { password = it },
            label = { Text(<span class="hljs-string">"密码"</span>) },
            visualTransformation = PasswordVisualTransformation(),
            isError = passwordError != <span class="hljs-literal">null</span>,
            supportingText = passwordError?.let { { Text(it) } }
        )
        
        Button(
            onClick = { <span class="hljs-comment">/* 登录 */</span> },
            enabled = emailError == <span class="hljs-literal">null</span> &amp;&amp; passwordError == <span class="hljs-literal">null</span>
        ) {
            Text(<span class="hljs-string">"登录"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-60">8.4 Dialog 组件</h3>
<h4 data-id="heading-61">8.4.1 AlertDialog</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DeleteConfirmDialog</span><span class="hljs-params">(
    onConfirm: () -&gt; <span class="hljs-type">Unit</span>,
    onDismiss: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text(<span class="hljs-string">"确认删除"</span>) },
        text = { Text(<span class="hljs-string">"确定要删除这个项目吗？此操作无法撤销。"</span>) },
        confirmButton = {
            TextButton(
                onClick = onConfirm,
                colors = ButtonDefaults.textButtonColors(
                    contentColor = MaterialTheme.colorScheme.error
                )
            ) {
                Text(<span class="hljs-string">"删除"</span>)
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(<span class="hljs-string">"取消"</span>)
            }
        }
    )
}
</code></pre>
<h4 data-id="heading-62">8.4.2 自定义 Dialog</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomDialog</span><span class="hljs-params">(
    onDismiss: () -&gt; <span class="hljs-type">Unit</span>,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(<span class="hljs-number">16.</span>dp),
            shape = MaterialTheme.shapes.extraLarge
        ) {
            content()
        }
    }
}
</code></pre>
<h3 data-id="heading-63">8.5 Scaffold 布局</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyScreen</span><span class="hljs-params">()</span></span> {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(<span class="hljs-string">"标题"</span>) },
                navigationIcon = {
                    IconButton(onClick = { }) {
                        Icon(Icons.Default.ArrowBack, contentDescription = <span class="hljs-string">"返回"</span>)
                    }
                },
                actions = {
                    IconButton(onClick = { }) {
                        Icon(Icons.Default.Search, contentDescription = <span class="hljs-string">"搜索"</span>)
                    }
                }
            )
        },
        bottomBar = {
            NavigationBar {
                NavigationBarItem(
                    selected = <span class="hljs-literal">true</span>,
                    onClick = { },
                    icon = { Icon(Icons.Default.Home, contentDescription = <span class="hljs-literal">null</span>) },
                    label = { Text(<span class="hljs-string">"首页"</span>) }
                )
                NavigationBarItem(
                    selected = <span class="hljs-literal">false</span>,
                    onClick = { },
                    icon = { Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>) },
                    label = { Text(<span class="hljs-string">"我的"</span>) }
                )
            }
        },
        floatingActionButton = {
            FloatingActionButton(onClick = { }) {
                Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
            }
        }
    ) { innerPadding -&gt;
        <span class="hljs-comment">// 内容区域</span>
        LazyColumn(
            modifier = Modifier.padding(innerPadding)
        ) {
            <span class="hljs-comment">// 列表内容</span>
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-64">九、自定义组件设计思路</h2>
<h3 data-id="heading-65">9.1 组件设计原则</h3>
<h4 data-id="heading-66">9.1.1 单一职责</h4>
<p>一个组件只做一件事：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 好的设计：只负责显示用户信息</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserAvatar</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, size: <span class="hljs-type">Dp</span> = <span class="hljs-number">48.</span>dp)</span></span> {
    AsyncImage(
        model = user.avatarUrl,
        contentDescription = user.name,
        modifier = Modifier
            .size(size)
            .clip(CircleShape)
    )
}

<span class="hljs-comment">// ❌ 坏的设计：既显示头像又处理点击跳转</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserAvatarBad</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, onNavigate: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    AsyncImage(
        model = user.avatarUrl,
        contentDescription = user.name,
        modifier = Modifier
            .size(<span class="hljs-number">48.</span>dp)
            .clip(CircleShape)
            .clickable { onNavigate() }  <span class="hljs-comment">// 不应该在这里处理导航</span>
    )
}
</code></pre>
<h4 data-id="heading-67">9.1.2 可配置性</h4>
<p>提供合理的自定义选项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PrimaryButton</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  <span class="hljs-comment">// 允许外部传入 Modifier</span>
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    icon: <span class="hljs-type">ImageVector</span>? = <span class="hljs-literal">null</span>
)</span></span> {
    Button(
        onClick = onClick,
        modifier = modifier,
        enabled = enabled
    ) {
        icon?.let {
            Icon(it, contentDescription = <span class="hljs-literal">null</span>)
            Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
        }
        Text(text)
    }
}
</code></pre>
<h4 data-id="heading-68">9.1.3 状态提升</h4>
<p>将状态提升到父组件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 好的设计：无状态组件</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExpandableCard</span><span class="hljs-params">(
    expanded: <span class="hljs-type">Boolean</span>,
    onExpandedChange: (<span class="hljs-type">Boolean</span>) -&gt; <span class="hljs-type">Unit</span>,
    title: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Card {
        Column {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onExpandedChange(!expanded) }
                    .padding(<span class="hljs-number">16.</span>dp)
            ) {
                title()
                Spacer(Modifier.weight(<span class="hljs-number">1f</span>))
                Icon(
                    <span class="hljs-keyword">if</span> (expanded) Icons.Default.ExpandLess <span class="hljs-keyword">else</span> Icons.Default.ExpandMore,
                    contentDescription = <span class="hljs-keyword">if</span> (expanded) <span class="hljs-string">"收起"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"展开"</span>
                )
            }
            
            AnimatedVisibility(visible = expanded) {
                content()
            }
        }
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    
    ExpandableCard(
        expanded = expanded,
        onExpandedChange = { expanded = it },
        title = { Text(<span class="hljs-string">"标题"</span>) },
        content = { Text(<span class="hljs-string">"展开的内容"</span>) }
    )
}
</code></pre>
<h3 data-id="heading-69">9.2 实战：自定义 Chip 组件</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 自定义 Chip 组件
 * 
 * 设计思路：
 * 1. 支持选中/未选中两种状态
 * 2. 可配置颜色、形状、尺寸
 * 3. 支持图标和删除按钮
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomChip</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    selected: <span class="hljs-type">Boolean</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    leadingIcon: @<span class="hljs-type">Composable</span> (() -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>,
    onDelete: (() -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>,
    colors: <span class="hljs-type">SelectableChipColors</span> = ChipDefaults.selectableChipColors()</span></span>,
    shape: Shape = MaterialTheme.shapes.small
) {
    <span class="hljs-keyword">val</span> containerColor <span class="hljs-keyword">by</span> colors.containerColor(enabled, selected)
    <span class="hljs-keyword">val</span> labelColor <span class="hljs-keyword">by</span> colors.labelColor(enabled, selected)
    
    Surface(
        modifier = modifier,
        shape = shape,
        color = containerColor,
        onClick = onClick,
        enabled = enabled
    ) {
        Row(
            modifier = Modifier.padding(horizontal = <span class="hljs-number">12.</span>dp, vertical = <span class="hljs-number">6.</span>dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            leadingIcon?.let { icon -&gt;
                Box(Modifier.size(<span class="hljs-number">18.</span>dp)) { icon() }
                Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
            }
            
            Text(
                text = text,
                style = MaterialTheme.typography.labelLarge,
                color = labelColor
            )
            
            onDelete?.let { onDeleteClick -&gt;
                Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
                Icon(
                    imageVector = Icons.Default.Close,
                    contentDescription = <span class="hljs-string">"删除"</span>,
                    modifier = Modifier
                        .size(<span class="hljs-number">18.</span>dp)
                        .clickable(onClick = onDeleteClick),
                    tint = labelColor
                )
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ChipDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> selected <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    
    FlowRow(horizontalGap = <span class="hljs-number">8.</span>dp, verticalGap = <span class="hljs-number">8.</span>dp) {
        <span class="hljs-comment">// 普通 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"标签 1"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { }
        )
        
        <span class="hljs-comment">// 选中状态</span>
        CustomChip(
            text = <span class="hljs-string">"已选中"</span>,
            selected = <span class="hljs-literal">true</span>,
            onClick = { selected = !selected }
        )
        
        <span class="hljs-comment">// 带图标的 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"带图标"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { },
            leadingIcon = {
                Icon(Icons.Default.Check, contentDescription = <span class="hljs-literal">null</span>)
            }
        )
        
        <span class="hljs-comment">// 可删除的 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"可删除"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { },
            onDelete = { <span class="hljs-comment">/* 删除逻辑 */</span> }
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-70">十、本篇小结</h2>
<p>今天我们深入探讨了 Material Design 3 的组件与主题系统：</p>
<h3 data-id="heading-71">Material Design 3 设计哲学</h3>
<ul>
<li>理解了 MD3 的核心变化和设计原则</li>
<li>掌握了个性化、适应性、层次结构三大特性</li>
</ul>
<h3 data-id="heading-72">MaterialTheme 系统</h3>
<ul>
<li>深入理解了 ColorScheme、Typography、Shape 三大系统</li>
<li>掌握了主题定制的完整方法</li>
</ul>
<h3 data-id="heading-73">深色模式</h3>
<ul>
<li>理解了颜色反转规则和 elevation 处理</li>
<li>掌握了完整实现方案和最佳实践</li>
</ul>
<h3 data-id="heading-74">动态取色</h3>
<ul>
<li>理解了动态取色的原理</li>
<li>掌握了实现方法和备用方案</li>
</ul>
<h3 data-id="heading-75">Material 组件</h3>
<ul>
<li>深入理解了 Button、Card、TextField、Dialog 等组件</li>
<li>掌握了组件使用规范和自定义方法</li>
</ul>
<h3 data-id="heading-76">自定义组件</h3>
<ul>
<li>理解了组件设计原则（单一职责、可配置性、状态提升）</li>
<li>掌握了自定义组件的完整设计思路</li>
</ul>
<hr/>
<h2 data-id="heading-77">下篇预告</h2>
<p><strong>第五篇：动画与交互</strong> 将深入讲解：</p>
<ul>
<li>Compose 动画系统架构</li>
<li>属性动画与过渡动画</li>
<li>手势处理与触摸交互</li>
<li>自定义动画的设计思路</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-78">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2F" target="_blank" title="https://m3.material.io/" ref="nofollow noopener noreferrer">Material Design 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fcomponents" target="_blank" title="https://developer.android.com/jetpack/compose/components" ref="nofollow noopener noreferrer">Compose Material 3 组件</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2Ftheme-builder" target="_blank" title="https://m3.material.io/theme-builder" ref="nofollow noopener noreferrer">Material Theme Builder</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石 ✅</li>
<li>第三篇：状态管理 ✅</li>
<li>第四篇：Material 组件与主题（当前）✅</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite打包速度提升50%的5个隐藏技巧，前端工程师都在偷偷用！]]></title>    <link>https://juejin.cn/post/7601018079620399119</link>    <guid>https://juejin.cn/post/7601018079620399119</guid>    <pubDate>2026-01-31T04:18:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601018079620399119" data-draft-id="7601000638344560655" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite打包速度提升50%的5个隐藏技巧，前端工程师都在偷偷用！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-31T04:18:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite打包速度提升50%的5个隐藏技巧，前端工程师都在偷偷用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T04:18:21.000Z" title="Sat Jan 31 2026 04:18:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite打包速度提升50%的5个隐藏技巧，前端工程师都在偷偷用！</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在前端工程化领域，构建工具的性能优化一直是开发者关注的焦点。Vite作为新一代的前端构建工具，凭借其基于原生ESM的极速启动和热更新能力，迅速成为现代前端开发的宠儿。然而，随着项目规模的扩大，Vite的打包速度也可能面临瓶颈。本文将深入剖析5个鲜为人知的技巧，帮助你显著提升Vite的打包效率（部分场景下甚至可提升50%以上），这些技巧已被许多资深前端工程师默默采用。</p>
<hr/>
<h3 data-id="heading-2">主体</h3>
<h4 data-id="heading-3">1. 合理配置<code>build.rollupOptions</code>，优化依赖处理</h4>
<p>Rollup是Vite底层的打包工具，通过调整<code>build.rollupOptions</code>可以显著减少打包时间：</p>
<ul>
<li><strong>手动指定外部依赖</strong>：将已知不会变动的第三方库（如React、Lodash）标记为<code>external</code>，避免重复打包：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'react-dom'</span>],
    },
  },
};
</code></pre>
</li>
<li><strong>启用<code>output.preserveModules</code></strong>：对于大型库（如组件库），保留模块结构可减少重复计算：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">output</span>: {
  <span class="hljs-attr">preserveModules</span>: <span class="hljs-literal">true</span>,
}
</code></pre>
</li>
<li><strong>实践依据</strong>：根据Rollup官方文档，合理配置<code>external</code>可减少30%-40%的依赖处理时间。</li>
</ul>
<h4 data-id="heading-4">2. 利用多线程压缩器替代Terser</h4>
<p>默认情况下，Vite使用Terser进行代码压缩（单线程）。切换到多线程压缩工具如<code>esbuild</code>或<code>swc</code>可大幅提速：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { esbuild } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-esbuild'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'esbuild'</span>, <span class="hljs-comment">// 比terser快2-3倍</span>
    <span class="hljs-attr">target</span>: <span class="hljs-string">'esnext'</span>,
  },
};
</code></pre>
<ul>
<li><strong>性能对比</strong>：在10万行代码的项目中，esbuild平均压缩时间仅为Terser的1/3。</li>
<li><strong>注意事项</strong>：esbuild对某些ES5语法支持有限，需结合目标浏览器权衡。</li>
</ul>
<h4 data-id="heading-5">3. Chunk拆分策略优化</h4>
<p>默认的Chunk拆分可能导致冗余代码加载。通过以下方式优化：</p>
<ul>
<li><strong>强制拆分配置</strong>：避免单个Chunk过大（建议阈值100KB）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">rollupOptions</span>: {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-title function_">manualChunks</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'node_modules'</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'vendor'</span>;
      }
    },
    <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'[name]-[hash].js'</span>,
  },
}
</code></pre>
</li>
<li><strong>动态导入优先级</strong>：对非关键路由使用动态导入（React.lazy或Vue异步组件），减少初始包体积。</li>
<li><strong>实测效果</strong>：某电商项目通过优化Chunk策略，首屏加载时间缩短40%。</li>
</ul>
<h4 data-id="heading-6">4. Pre-bundling调优与缓存利用</h4>
<p>Vite通过预构建（Pre-bundling）加速依赖加载，但不当配置会拖慢速度：</p>
<ul>
<li><strong>排除无需Pre-bundle的依赖</strong>：例如纯ESM模块（如lodash-es）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">optimizeDeps</span>: {
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'lodash-es'</span>],
},
</code></pre>
</li>
<li><strong>强制缓存失效策略</strong>：开发环境下修改依赖版本时手动清除缓存（删除<code>node_modules/.vite</code>目录）。</li>
<li><strong>深度集成方案</strong>：结合 <code>vite-plugin-optimize-persist</code>插件持久化optimizeDeps配置。</li>
</ul>
<h4 data-id="heading-7">5. WASM与原生模块的高效处理</h4>
<p>WebAssembly和原生模块处理不当会导致构建卡顿。推荐方案：</p>
<ul>
<li><strong>WASM直接加载</strong>：避免额外转译开销（需浏览器支持）：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { 
   <span class="hljs-attr">server</span>: { 
     <span class="hljs-attr">fs</span>: { <span class="hljs-attr">strict</span>: <span class="hljs-literal">false</span> } <span class="hljs-comment">// WASM文件可能需要此配置 </span>
   }, 
   <span class="hljs-attr">optimizeDeps</span>: { 
     <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'*.wasm'</span>] 
   } 
}; 
</code></pre>
<ul>
<li><strong>Native模块替代品</strong> ：优先选择纯JS实现（如用<code>squoosh</code>替代sharp）。</li>
</ul>
<hr/>
<h3 data-id="heading-8">总结</h3>
<p>Vite的性能潜力远不止默认配置所展现的水平 。通过本文介绍的五个技巧——从Rollup深度调优到Pre-bundling策略调整 ，再到WASM高效处理 ——开发者可以解锁更快的构建速度 。值得注意的是 ，这些优化需要根据项目特性灵活组合 ：小型项目可能只需调整压缩器 ，而大型Monorepo则需全面优化Chunk拆分和缓存机制 。建议逐步应用并监控效果 （如使用 `--debug flag输出时序日志） ，最终实现质的飞跃 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-从 Vue 2 到 Vue 3：生命周期全图鉴与实战指南]]></title>    <link>https://juejin.cn/post/7601028900886806574</link>    <guid>https://juejin.cn/post/7601028900886806574</guid>    <pubDate>2026-01-31T04:19:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886806574" data-draft-id="7600953879501783091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-从 Vue 2 到 Vue 3：生命周期全图鉴与实战指南"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T04:19:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-从 Vue 2 到 Vue 3：生命周期全图鉴与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T04:19:37.000Z" title="Sat Jan 31 2026 04:19:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>生命周期钩子（Lifecycle Hooks）是 Vue 组件从诞生到销毁的全过程记录。掌握生命周期，不仅能让我们在正确的时间点执行逻辑，更是优化性能、排查内存泄露的关键。</p>
<h2 data-id="heading-1">一、 生命周期四大阶段</h2>
<p>Vue 的生命周期大体可分为：<strong>创建、挂载、更新、销毁</strong>。</p>
<hr/>
<h2 data-id="heading-2">二、 Vue 2 vs Vue 3 生命周期对比图</h2>
<p>在 Vue 3 组合式 API 中，生命周期钩子需要从 <code>vue</code> 中导入，且命名上增加了 <code>on</code> 前缀。</p>









































<table><thead><tr><th><strong>阶段</strong></th><th><strong>Vue 2 (选项式 API)</strong></th><th><strong>Vue 3 (组合式 API)</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><strong>创建</strong></td><td><code>beforeCreate</code> / <code>created</code></td><td><strong><code>setup()</code></strong></td><td>Vue 3 中 <code>setup</code> 包含了这两个时期</td></tr><tr><td><strong>挂载</strong></td><td><code>beforeMount</code> / <code>mounted</code></td><td><code>onBeforeMount</code> / <strong><code>onMounted</code></strong></td><td>常用：操作 DOM、请求接口</td></tr><tr><td><strong>更新</strong></td><td><code>beforeUpdate</code> / <code>updated</code></td><td><code>onBeforeUpdate</code> / <code>onUpdated</code></td><td>响应式数据变化时触发</td></tr><tr><td><strong>销毁</strong></td><td><code>beforeDestroy</code> / <code>destroyed</code></td><td><strong><code>onBeforeUnmount</code></strong> / <strong><code>onUnmounted</code></strong></td><td>注意：Vue 3 中命名的变更</td></tr><tr><td><strong>缓存</strong></td><td><code>activated</code> / <code>deactivated</code></td><td><code>onActivated</code> / <code>onDeactivated</code></td><td>配合 <code>&lt;keep-alive&gt;</code> 使用</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">三、 详细解析与实战场景</h2>
<h3 data-id="heading-4">1. 创建阶段 (Creation)</h3>
<ul>
<li>
<p><strong>Vue 2 (<code>beforeCreate</code> / <code>created</code>)</strong> ：</p>
<ul>
<li><code>beforeCreate</code>：组件实例刚在内存中被创建，此时还没有初始化好 <code>data</code> 和 <code>methods </code>属性。适合插件开发，注入全局变量。</li>
<li><code>created</code>：实例已创建，响应式数据<code>data、methods</code> 已准备好。
<ul>
<li><strong>场景</strong>：最早可发起异步请求的时机。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Vue 3 (<code>setup</code>)</strong> ：</p>
<ul>
<li>在 Vue 3 中，<code>setup</code> 的执行早于 <code>beforeCreate</code>，它是组合式 API 的入口。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2. 挂载阶段 (Mounting)</h3>
<ul>
<li><strong>Vue 2 (<code>beforeMount</code> / <code>mounted</code>)</strong> ：
<ul>
<li>
<p><code>beforeMount</code>：此时已经完成了模板的编译，但是还没有挂载到页面中</p>
</li>
<li>
<p><code>mounted</code>：此时已经将编译好的模板挂载到了页面指定的容器中，<strong>可以访问页面中的dom了</strong></p>
<ul>
<li>
<p><strong>场景</strong>：dom已创建，可用于获取接口数据和dom元素、访问子组件</p>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>Vue 3 (<code>onBeforeMount</code> / <code>onMounted</code>)</strong> ：
<ul>
<li>
<p><code>onBeforeMount</code>：模板编译完成，但尚未渲染到 DOM 树中。</p>
</li>
<li>
<p><code>onMounted</code>：组件已挂载，可以安全地访问 DOM 元素。</p>
<ul>
<li><strong>场景</strong>：获取接口数据、初始化第三方插件（如 ECharts）、访问子组件。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">3. 更新阶段 (Updating)</h3>
<ul>
<li>
<p><strong>Vue 2 (<code>beforeUpdate</code> / <code>updated</code>)</strong> ：</p>
<ul>
<li>
<p><code>beforeUpdate</code>：数据状态更新之前执行，此时 data 中的状态值是最新的，但是界面上显示的数据还是旧的，因为此时还没有开始重新渲染DOM节点。</p>
<ul>
<li><strong>场景</strong> ：此时view层还未更新，可用于获取更新前各种状态。</li>
</ul>
</li>
<li>
<p><code>updated</code>：实例更新完毕之后调用，此时 data 中的状态值和界面上显示的数据，都已经完成了更新，界面已经被重新渲染好了。</p>
</li>
</ul>
</li>
<li>
<p><strong>Vue 3 (<code>onBeforeUpdate</code> / <code>onUpdated</code>)</strong> ：</p>
<ul>
<li><code>onBeforeUpdate</code>：数据已更新，但 DOM 尚未重新渲染。可用于获取更新前的 DOM 状态。</li>
<li><code>onUpdated</code>：DOM 已完成更新。注意：不要在此钩子中修改状态，否则可能导致死循环。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">4. 销毁阶段 (Unmounting / Destruction)</h3>
<ul>
<li>
<p><strong>Vue 2 (<code>beforeDestroy</code> / <code>destroyed</code>)</strong> ：</p>
<ul>
<li><code> beforeDestroy</code>：实例销毁之前调用。
<ul>
<li><strong>场景</strong>：清理工作，如 <strong>清除定时器 (<code>setInterval</code>)、解绑全局事件监听、取消订阅</strong>。</li>
</ul>
</li>
<li><code>destroyed</code>：Vue 实例销毁后调用。组件彻底从 DOM 中移除，所有的指令和事件监听都会被解除。</li>
</ul>
</li>
<li>
<p><strong>Vue 3 (<code>onBeforeUnmount</code> / <code>onUnmounted</code>)</strong> ：</p>
<ul>
<li>
<p><code>onBeforeUnmount</code>：实例销毁之前调用。</p>
</li>
<li>
<p><code>onUnmounted</code>：组件彻底从 DOM 中移除，所有的指令和事件监听都会被解除。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">5. 缓存阶段 (Keep-alive)</h3>
<p><strong>如果使用了keep-alive缓存组件会新增两个生命周期函数</strong></p>
<ul>
<li><strong><code>onActivated</code></strong>：组件进入视野，被重新激活时调用。</li>
<li><strong><code>onDeactivated</code></strong>：组件移出视野，进入缓存状态时调用。</li>
</ul>
<h2 data-id="heading-9">四、 Vue 3 + TypeScript 实战演示</h2>
<p>以下是使用 <code>script setup</code> 语法编写的生命周期示例：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div ref="container"&gt;
    &lt;h2&gt;当前计数：{{ count }}&lt;/h2&gt;
    &lt;button @click="count++"&gt;增加&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { 
  ref, 
  onMounted, 
  onBeforeUpdate, 
  onUpdated, 
  onBeforeUnmount 
} from 'vue'

const count = ref&lt;number&gt;(0)
const container = ref&lt;HTMLElement | null&gt;(null)
let timer: number | null = null

// 挂载阶段
onMounted(() =&gt; {
  console.log('Component Mounted. DOM element:', container.value)
  // 模拟一个定时任务
  timer = window.setInterval(() =&gt; {
    console.log('Timer running...')
  }, 1000)
})

// 运行阶段
onBeforeUpdate(() =&gt; {
  console.log('Data updated, but DOM is not yet re-rendered.')
})

onUpdated(() =&gt; {
  console.log('Data updated and DOM re-rendered.')
})

// 销毁阶段
onBeforeUnmount(() =&gt; {
  console.log('Cleanup before unmount.')
  if (timer) {
    clearInterval(timer) // 关键：防止内存泄漏
  }
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-10">五、 进阶：父子组件生命周期执行顺序</h2>
<p>为了清晰起见，我们将顺序拆解为三个主要场景（vue3）：</p>
<h3 data-id="heading-11">1. 初始挂载阶段</h3>
<p>父组件必须等待所有子组件挂载完成后，才能完成自己的挂载逻辑。</p>
<ol>
<li><strong>父</strong> <code>setup</code>（开始创建）</li>
<li><strong>父</strong> <code>onBeforeMount</code></li>
<li><strong>子</strong> <code>setup</code></li>
<li><strong>子</strong> <code>onBeforeMount</code></li>
<li><strong>子</strong> <code>onMounted</code> （子组件渲染完毕，向上通知）</li>
<li><strong>父</strong> <code>onMounted</code> （父组件接收到信号，宣布整体挂载完毕）</li>
</ol>
<blockquote>
<p><strong>记忆口诀：</strong> 父创 -&gt; 子创 -&gt; 子挂 -&gt; 父挂。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">2. 更新阶段</h3>
<p>当父组件传递给子组件的 <code>props</code> 发生变化时，更新逻辑如下：</p>
<ul>
<li><strong>父</strong> <code>onBeforeUpdate</code></li>
<li><strong>子</strong> <code>onBeforeUpdate</code></li>
<li><strong>子</strong> <code>onUpdated</code></li>
<li><strong>父</strong> <code>onUpdated</code></li>
</ul>
<blockquote>
<p><strong>注意：</strong> 如果只是父组件自身的私有状态更新，且未影响到子组件，则子组件的更新钩子不会被触发。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">3. 销毁阶段</h3>
<p>销毁过程同样是“递归”式的，父组件先启动销毁，等子组件销毁完毕后，父组件正式功成身退。</p>
<ol>
<li><strong>父</strong> <code>onBeforeUnmount</code></li>
<li><strong>子</strong> <code>onBeforeUnmount</code></li>
<li><strong>子</strong> <code>unmounted</code></li>
<li><strong>父</strong> <code>onUnmounted</code></li>
</ol>
<hr/>
<h2 data-id="heading-14">六、 Vue 3 + TS 模拟演示</h2>
<p>你可以通过以下代码在控制台直接观察执行逻辑。</p>
<h3 data-id="heading-15">父组件 <code>Parent.vue</code></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted, onBeforeMount } from 'vue'
import Child from './Child.vue'

console.log('1. 父 - setup')

onBeforeMount(() =&gt; console.log('3. 父 - onBeforeMount'))
onMounted(() =&gt; console.log('8. 父 - onMounted'))
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="parent"&gt;
    &lt;h1&gt;父组件&lt;/h1&gt;
    &lt;Child /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-16">子组件 <code>Child.vue</code></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted, onBeforeMount } from 'vue'

console.log('4. 子 - setup')

onBeforeMount(() =&gt; console.log('6. 子 - onBeforeMount'))
onMounted(() =&gt; console.log('7. 子 - onMounted'))
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="child"&gt;子组件内容&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<hr/>
<h2 data-id="heading-17">📝 总结与避坑</h2>
<ol>
<li>
<p><strong>接口请求放哪里？</strong></p>
<ul>
<li>如果子组件的渲染依赖父组件接口返回的数据，请在父组件的 <code>created</code>（Vue 2）或 <code>setup</code>（Vue 3）中请求。</li>
<li><strong>注意</strong>：即便你在父组件的 <code>onMounted</code> 发请求，子组件此时也已经渲染完成了。</li>
</ul>
</li>
<li>
<p><strong>Refs 访问时机</strong>：</p>
<ul>
<li>父组件想通过 <code>ref</code> 访问子组件实例，<strong>必须</strong>在父组件的 <code>onMounted</code> 之后，因为只有这时子组件才真正挂载完成。</li>
</ul>
</li>
<li>
<p><strong>异步组件</strong>：</p>
<ul>
<li>如果子组件是异步组件（如使用 <code>defineAsyncComponent</code>），顺序会发生变化，父组件可能会先执行 <code>onMounted</code>。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[干货拉满｜AI智能体的4大核心协议，看完轻松拿捏底层逻辑]]></title>    <link>https://juejin.cn/post/7601028900886855726</link>    <guid>https://juejin.cn/post/7601028900886855726</guid>    <pubDate>2026-01-31T04:48:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886855726" data-draft-id="7601169987395895347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="干货拉满｜AI智能体的4大核心协议，看完轻松拿捏底层逻辑"/> <meta itemprop="keywords" content="Agent,人工智能"/> <meta itemprop="datePublished" content="2026-01-31T04:48:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="whinc"/> <meta itemprop="url" content="https://juejin.cn/user/2612095357294343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            干货拉满｜AI智能体的4大核心协议，看完轻松拿捏底层逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095357294343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    whinc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T04:48:46.000Z" title="Sat Jan 31 2026 04:48:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">干货拉满｜AI智能体的4大核心协议，看完轻松拿捏底层逻辑</h2>
<p>现在的AI早就不只是会聊天的工具啦——能自己调用工具查数据，能和其他AI配合干活，还能随手生成可直接用的界面，实用性真的拉满～</p>
<p>但很少有人知道，这一切的背后，全靠4个“隐形基建”在撑着——MCP、A2A、AG-UI、A2UI（生成式UI核心规范）。它们就像AI世界的“沟通密码”，悄悄解决了AI与工具、AI与AI、AI与人之间的“沟通代沟”。</p>
<p>今天不玩虚的，用最接地气、最轻松的语气，把这4大协议讲透，不管你是AI小白还是行业从业者，看完都能get核心，再也不用被专业术语劝退～</p>
<h3 data-id="heading-1">先划重点：4大协议，解决AI的4大“小bug”</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCFQTowCgOmAgwuFJib8Dlgr30bBlibRFOUAgRC8M1Y8l06qofOhljMWyCw%2F0%3Fwx_fmt%3Dpng" alt="" loading="lazy"/></p>
<p>在这4个协议问世前，AI一直被4个小bug卡着脖子，根本没法放开手脚发力，说起来还挺无奈：</p>
<ul>
<li>
<p>工具适配太麻烦：AI调用Excel、数据库，得一个个单独适配，就像给每部手机配专属充电器，繁琐又耗时；</p>
</li>
<li>
<p>AI之间没法配合：百度文心、阿里通义这类不同平台的AI，就像各玩各的小朋友，没法协同干活，遇事只能“单兵作战”；</p>
</li>
<li>
<p>人机交互有点卡：和AI界面互动，发个指令要等好几秒，体验感不太好，就像用2G网刷视频一样不顺畅；</p>
</li>
<li>
<p>生成界面不好用：AI随手生成的界面，要么乱码要么用不了，兼容性太差，根本没法真正落地使用。</p>
</li>
</ul>
<p>而MCP、A2A、AG-UI、A2UI这四个“小帮手”，正好精准修复了这4个bug，它们各司其职又能组队发力，默默撑起了AI智能体的整个运行体系。下面逐个拆解，全程无废话、全是干货，慢慢看就好～</p>
<h3 data-id="heading-2">一、MCP协议：AI与工具的“万能接口”，适配万物不费劲</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCFalFQn3VMOqpFfj3HWYicWtSeibsZ6t24wH2CR4oEUxz3odR95eQqNn4A%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>MCP的核心作用很简单，一句话就能说清：给AI装个“万能USB接口”，不管是数据库、设计软件还是办公工具，插上就能用，再也不用单独适配，效率直接提上来啦！</p>
<h4 data-id="heading-3">1. 核心信息（简单记就好）</h4>
<p>全称：模型上下文协议（Model Context Protocol），由Claude母公司Anthropic在2024年11月推出，开放又免费，所有AI框架和工具都能兼容，主打一个“万物可连”。</p>
<p>说句大白话：以前AI调用个CRM系统查数据，得麻烦程序员写一堆适配代码；现在有了MCP，一套协议就能搞定所有，省下来的时间，不管是摸鱼还是做项目都很香～</p>
<h4 data-id="heading-4">2. 核心功能（重点了解）</h4>
<p>它既是AI的“工具连接器”，也是“安全小保镖”，两大功能都很实用：</p>
<ul>
<li>
<p>万能连接：给AI搭好统一的接口，不管是办公软件、科研工具还是企业系统，AI都能轻松对接，自动提取数据、完成操作，不用我们手动插手；</p>
</li>
<li>
<p>安全兜底：内置安全隔离机制，能防止AI误删核心数据，也能避免外部工具泄露AI的核心模型，安全感拉满～</p>
</li>
</ul>
<h4 data-id="heading-5">3. 落地场景（看实例，更易懂）</h4>
<ul>
<li>
<p>打工人福音：AI助手通过MCP对接日历、邮件，自动整理日程、回复常用邮件，再也不用被琐碎的小事缠得头大；</p>
</li>
<li>
<p>科研提速：生物AI通过MCP对接基因分析工具，快速处理海量数据，让新药研发的效率悄悄翻倍；</p>
</li>
<li>
<p>企业刚需：AI决策系统通过MCP对接ERP、财务工具，自动生成报表和决策建议，老板看了省心，我们也能少加班。</p>
</li>
</ul>
<h3 data-id="heading-6">二、A2A协议：AI与AI的“组队密码”，协同干活不内耗</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCFgdx3UJPbpD7MU3fR04vtKx18mfreWFH1wcMWqnKHQtx379H5gj24iaQ%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>如果说MCP是AI和工具的“接口”，那A2A就是AI之间的“组队密码”——能让不同平台、不同功能的AI，顺畅沟通、分工协作，再也不用各自为战，搞定复杂任务也很轻松～</p>
<h4 data-id="heading-7">1. 核心信息（简单记就好）</h4>
<p>全称：智能体到智能体协议（Agent-to-Agent Protocol），由谷歌、微软等大厂联合推出，兼容所有主流AI框架，主打一个“AI组队不内耗”。</p>
<p>大白话解读：以前百度文心和阿里通义，就像两个说不同方言的人，没法好好配合干活；现在有了A2A，它们能精准“对话”，你查数据、我做可视化，分工明确，效率也高。</p>
<h4 data-id="heading-8">2. 核心功能（重点了解）</h4>
<p>核心就是帮AI“组队打怪”，两大功能精准戳中痛点：</p>
<ul>
<li>
<p>任务拆分：主AI接到复杂任务后，通过A2A把任务拆成一个个小模块，分给不同专业的AI，比如风控任务，就让“风险识别AI”和“异常检测AI”各做各的擅长领域；</p>
</li>
<li>
<p>快速联动：AI之间不用反复适配，通过A2A就能实时传递进度和结果，发现问题秒同步、秒解决，再也不内耗。</p>
</li>
</ul>
<h4 data-id="heading-9">3. 落地场景（看实例，更易懂）</h4>
<ul>
<li>
<p>电商风控：3个AI组队，通过A2A协同，快速识别诈骗订单，保障交易安全，再也不用人工一个个排查，省了不少力；</p>
</li>
<li>
<p>创意落地：文本AI写好文案，通过A2A把需求传给图像AI生成海报，再交给排版AI优化，全流程自动化，创意落地也能快人一步；</p>
</li>
<li>
<p>大规模计算：跨区域的AI通过A2A组队，搞定全国人口统计、海量数据分析，效率比单个AI高10倍不止，省了很多时间。</p>
</li>
</ul>
<h3 data-id="heading-10">三、AG-UI协议：AI与人的“实时聊天通道”，交互流畅不卡顿</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCFharPRuPs9dE1pQFC2viaEFl8Il6dIIjhOZcPklNpGowWx8BrVic9aicDQ%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>AI和工具、AI和AI都能顺畅沟通了，那AI和我们人怎么互动才不卡顿呢？答案就是AG-UI——它就像AI和前端界面的“实时聊天通道”，发指令秒反馈，界面同步更新，体验感直接拉满～</p>
<h4 data-id="heading-11">1. 核心信息（简单记就好）</h4>
<p>全称：智能体-用户交互协议（Agent-User Interaction Protocol），由CopilotKit团队在2025年6月推出，轻量又好用，所有前端框架都能兼容，主打一个“实时流畅”。</p>
<p>大白话解读：以前用AI客服，发个问题要等好几秒才回复，急得抓耳挠腮；现在有了AG-UI，发消息秒反馈，界面还能实时显示进度，就像和人面对面聊天一样顺畅。</p>
<h4 data-id="heading-12">2. 核心功能（重点了解）</h4>
<ul>
<li>
<p>实时双向交互：你发指令，AI秒接收；AI的处理进度，界面秒更新，没有一丝延迟，体验感特别好；</p>
</li>
<li>
<p>跨平台统一：不管是手机APP、网页还是桌面软件，和AI的交互方式都一样，不用反复适应，小白也能快速上手；</p>
</li>
<li>
<p>安全可控：前端能拦截AI的敏感操作，比如调用你的隐私数据，安全感直接拉满，用起来更放心。</p>
</li>
</ul>
<h4 data-id="heading-13">3. 落地场景（看实例，更易懂）</h4>
<ul>
<li>
<p>智能客服：咨询物流的时候，界面实时显示进度条，AI一边回复，一边同步物流节点，再也不用反复追问“我的快递到哪了”；</p>
</li>
<li>
<p>教育AI：输入解题步骤，界面秒出批改意见，还能自动生成练习题，查漏补缺也变得很轻松；</p>
</li>
<li>
<p>团队协作：AI助手实时同步任务进度，谁完成了、谁没完成，界面一目了然，团队协作也不内耗，效率更高。</p>
</li>
</ul>
<h3 data-id="heading-14">四、A2UI协议：生成式UI的“标准模板”，界面生成不翻车</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCF6mSVOVUQRibW7cnU3JhIUXpsDDiaiazQtn6KbLJIKSsnEQmP7HknFtwew%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>最后这个协议，和我们的视觉体验直接相关——A2UI，它就像是生成式UI的“标准模板”，能让AI生成的界面规范、好用、不翻车，再也不用面对杂乱无章的界面头疼啦～</p>
<h4 data-id="heading-15">1. 核心信息（简单记就好）</h4>
<p>全称：智能体到用户界面协议（Agent-to-User Interface），由谷歌在2025年底开源推出，相当于AI生成界面的“标准化蓝图”，AI照着做，界面就不会翻车。</p>
<p>补充一句：生成式UI就是AI根据你的需求，实时生成可操作界面的技术，而A2UI就是这套技术的“核心规则”，没有它，AI生成的界面大概率没法用哦！</p>
<h4 data-id="heading-16">2. 核心功能（重点了解）</h4>
<ul>
<li>
<p>界面标准化：AI生成界面时，按照A2UI的规则来，不管是Web端还是手机端，界面都规范统一，兼容性拉满，不用再担心适配问题；</p>
</li>
<li>
<p>安全分层：把界面分成3个安全等级，简单的展示界面直接用，涉及支付、表单的界面需要确认后再用，能杜绝恶意风险；</p>
</li>
<li>
<p>高效渲染：不用重新生成整个界面，只更新需要修改的部分，速度更快、更省流量，体验感也更好。</p>
</li>
</ul>
<h4 data-id="heading-17">3. 落地场景（看实例，更易懂）</h4>
<ul>
<li>
<p>低代码福音：用自然语言说“要一个员工登记表”，AI照着A2UI生成界面，不用程序员写代码，小白也能轻松搞定；</p>
</li>
<li>
<p>个性化适配：AI会根据你的使用习惯，生成定制化的界面，常用功能放在首页，操作起来更便捷，不用到处找；</p>
</li>
<li>
<p>企业临时需求：需要快速生成临时报表界面时，AI能通过A2UI快速搞定，用完还能直接删，不用投入大量开发成本，省心又高效。</p>
</li>
</ul>
<h3 data-id="heading-18">关键联动：4大协议怎么组队干活？（10秒看懂）</h3>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCF44zxfZOIm3iceJTsWnPRJicndYicMSvazicfUeYMdCjnnicsuZI1iczmx9Mg%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>这4个协议不是单独干活，而是一起组队发力，给大家举个打工人最熟悉的例子，一看就懂它们的联动逻辑：</p>
<ol>
<li>
<p>你给AI办公助手发指令：“分析本月销售数据，生成可视化报表”（这个指令会通过AG-UI实时传给主AI）；</p>
</li>
<li>
<p>主AI通过A2A，把这个复杂任务拆给“数据查询AI”和“可视化AI”，分工很明确；</p>
</li>
<li>
<p>数据查询AI通过MCP对接销售数据库，提取完数据后，再通过A2A传给可视化AI；</p>
</li>
<li>
<p>可视化AI生成报表后，通过A2A反馈给主AI，主AI再按照A2UI生成界面描述；</p>
</li>
<li>
<p>主AI通过AG-UI，把报表界面实时渲染到你面前，你点击操作，反馈也能秒传给AI；</p>
</li>
<li>
<p>全程只要几秒，不用你手动做任何操作，效率直接拉满，是不是很方便～</p>
</li>
</ol>
<h3 data-id="heading-19">未来趋势：这4个协议，会改写AI格局吗？</h3>
<p>答案是：肯定会！随着AI智能体越来越普及，这4大协议会慢慢成为行业标准，有3个影响最值得我们关注，不管是小白还是从业者，简单记一下就好：</p>
<ul>
<li>
<p>开发更简单：以后做AI应用，不用再单独适配工具和界面，一套协议就能搞定，门槛直接拉低，普通人也能参与AI创新；</p>
</li>
<li>
<p>体验更流畅：AI交互会越来越自然，实现“无感知联动”，就像我们现在用手机一样，不用关注底层逻辑，好用、顺手就够了；</p>
</li>
<li>
<p>应用更广泛：办公、教育、医疗、工业这些领域，都会有AI智能体的身影，真正实现“AI赋能各行各业”，我们打工人也能省更多时间～</p>
</li>
</ul>
<p><img src="https://wsrv.nl?url=http%3A%2F%2Fmmbiz.qpic.cn%2Fsz_mmbiz_png%2F9nSMOxZ1wiaiaKJhuhDPzLs89FfscPJfCFMzt4PPEQW45hRgoArX65iallOI0TYujIeusFhibZmUibDG1A2YfNiaSuZw%2F0%3Ffrom%3Dappmsg" alt="" loading="lazy"/></p>
<p>看到这里，相信你已经轻松拿捏了4大协议的核心啦！最后来个小互动：你平时用AI工具时，有没有感受到这些协议的“隐形助力”？你觉得哪类协议最实用？</p>
<p>留言区聊聊你的看法，一起跟上AI潮流～</p>
<p>觉得有用的话，点赞+收藏+转发，分享给身边的打工人和AI爱好者，一起涨知识、提效率</p>
<p>#AI协议科普 #AI智能体底层技术 #科技干货 #AI办公技巧 #前沿科技解读</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 接口获取参数的注解详细介绍]]></title>    <link>https://juejin.cn/post/7601000638344232975</link>    <guid>https://juejin.cn/post/7601000638344232975</guid>    <pubDate>2026-01-31T03:11:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601000638344232975" data-draft-id="7600976289064681472" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 接口获取参数的注解详细介绍"/> <meta itemprop="keywords" content="Java,Spring Boot,Spring"/> <meta itemprop="datePublished" content="2026-01-31T03:11:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一线大码"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429340984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 接口获取参数的注解详细介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429340984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一线大码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:11:16.000Z" title="Sat Jan 31 2026 03:11:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>SpringBoot 接口获取参数的注解非常丰富，下面详细介绍一下常用的参数注解：</p>
<h2 data-id="heading-0">1、URL 路径参数</h2>
<h3 data-id="heading-1">1.1. <code>@PathVariable</code></h3>
<p>获取 URL 路径中的参数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取单个参数</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> userService.findById(id);
}

<span class="hljs-comment">// 获取多个参数</span>
<span class="hljs-meta">@GetMapping("/user/{id}/post/{postId}")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(
    <span class="hljs-meta">@PathVariable</span> Long id,
    <span class="hljs-meta">@PathVariable</span> Long postId
)</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 参数名不一致时指定</span>
<span class="hljs-meta">@GetMapping("/user/{userId}")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("userId")</span> Long id)</span> {
    <span class="hljs-keyword">return</span> userService.findById(id);
}

<span class="hljs-comment">// 获取所有路径变量（Map形式）</span>
<span class="hljs-meta">@GetMapping("/user/{id}/post/{postId}")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Map&lt;String, String&gt; pathVariables)</span> {
    <span class="hljs-keyword">return</span> pathVariables.get(<span class="hljs-string">"id"</span>);
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// URL路径中的时间参数</span>
<span class="hljs-meta">@GetMapping("/events/date/{date}")</span>
<span class="hljs-keyword">public</span> List&lt;Event&gt; <span class="hljs-title function_">getEventsByPathDate</span><span class="hljs-params">(
    <span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> Date date)</span> {
    <span class="hljs-keyword">return</span> eventService.findByDate(date);
}

<span class="hljs-meta">@GetMapping("/events/datetime/{datetime}")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getByDateTime</span><span class="hljs-params">(
    <span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span> LocalDateTime datetime)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"时间: "</span> + datetime;
}
</code></pre>
<h2 data-id="heading-2">2. 查询参数（URL 参数）</h2>
<h3 data-id="heading-3">2.1. <code>@RequestParam</code></h3>
<p>获取 URL 查询字符串参数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 必填参数</span>
<span class="hljs-meta">@GetMapping("/users")</span>
<span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String name)</span> {
    <span class="hljs-keyword">return</span> userService.findByName(name);
}

<span class="hljs-comment">// 可选参数</span>
<span class="hljs-meta">@GetMapping("/users")</span>
<span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(
    <span class="hljs-meta">@RequestParam(required = false)</span> String name,
    <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> <span class="hljs-type">int</span> page,
    <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> <span class="hljs-type">int</span> size
)</span> {
    <span class="hljs-keyword">return</span> userService.findByName(name, page, size);
}

<span class="hljs-comment">// 接收多个值</span>
<span class="hljs-meta">@GetMapping("/users")</span>
<span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> List&lt;Long&gt; ids)</span> {
    <span class="hljs-keyword">return</span> userService.findByIds(ids);
}

<span class="hljs-comment">// 获取所有查询参数（Map形式）</span>
<span class="hljs-meta">@GetMapping("/search")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Map&lt;String, String&gt; params)</span> {
    <span class="hljs-keyword">return</span> params.get(<span class="hljs-string">"keyword"</span>);
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询参数中的时间</span>
<span class="hljs-meta">@GetMapping("/events")</span>
<span class="hljs-keyword">public</span> List&lt;Event&gt; <span class="hljs-title function_">getEventsByDate</span><span class="hljs-params">(
    <span class="hljs-meta">@RequestParam</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> Date date)</span> {
    <span class="hljs-keyword">return</span> eventService.findByDate(date);
}

<span class="hljs-comment">// 多个时间参数</span>
<span class="hljs-meta">@GetMapping("/events/range")</span>
<span class="hljs-keyword">public</span> List&lt;Event&gt; <span class="hljs-title function_">getEventsByRange</span><span class="hljs-params">(
    <span class="hljs-meta">@RequestParam</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> Date startDate,
    <span class="hljs-meta">@RequestParam</span> <span class="hljs-meta">@DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)</span> LocalDateTime endTime)</span> {
    <span class="hljs-keyword">return</span> eventService.findByDateRange(startDate, endTime);
}
</code></pre>
<h2 data-id="heading-4">3. 请求体参数</h2>
<h3 data-id="heading-5">3.1. <code>@RequestBody</code></h3>
<p>获取 JSON/XML 格式的请求体</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/user")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
    <span class="hljs-keyword">return</span> userService.save(user);
}

<span class="hljs-comment">// 接收 Map 类型的请求体</span>
<span class="hljs-meta">@PostMapping("/data")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">processData</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; data)</span> {
    <span class="hljs-keyword">return</span> data.toString();
}

<span class="hljs-comment">// 使用 DTO 接收参数</span>
<span class="hljs-meta">@PostMapping("/register")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; register(<span class="hljs-meta">@RequestBody</span> RegisterDTO registerDTO) {
    <span class="hljs-comment">// 处理注册逻辑</span>
    <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"注册成功"</span>);
}
</code></pre>
<h3 data-id="heading-6">3.2. <code>@ModelAttribute</code></h3>
<p>获取表单数据（支持 GET/POST）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 绑定到对象</span>
<span class="hljs-meta">@PostMapping("/user")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@ModelAttribute</span> User user)</span> {
    userService.save(user);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
}

<span class="hljs-comment">// 绑定到 Map</span>
<span class="hljs-meta">@PostMapping("/user")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@ModelAttribute</span> Map&lt;String, Object&gt; model)</span> {
    <span class="hljs-keyword">return</span> model.get(<span class="hljs-string">"name"</span>).toString();
}
</code></pre>
<h2 data-id="heading-7">4. 请求头参数</h2>
<h3 data-id="heading-8">4.1. <code>@RequestHeader</code></h3>
<p>获取 HTTP 请求头信息</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/info")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(
    <span class="hljs-meta">@RequestHeader("User-Agent")</span> String userAgent,
    <span class="hljs-meta">@RequestHeader(value = "Authorization", required = false)</span> String auth,
    <span class="hljs-meta">@RequestHeader</span> Map&lt;String, String&gt; headers
)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"User-Agent: "</span> + userAgent;
}
</code></pre>
<h2 data-id="heading-9">5. Cookie 参数</h2>
<h3 data-id="heading-10">5.1. <code>@CookieValue</code></h3>
<p>获取 Cookie 中的值</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/profile")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProfile</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue("sessionId")</span> String sessionId)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Session ID: "</span> + sessionId;
}

<span class="hljs-comment">// 可选参数</span>
<span class="hljs-meta">@GetMapping("/profile")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProfile</span><span class="hljs-params">(
    <span class="hljs-meta">@CookieValue(value = "sessionId", defaultValue = "default")</span> String sessionId
)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Session ID: "</span> + sessionId;
}
</code></pre>
<h2 data-id="heading-11">6. 文件上传参数</h2>
<h3 data-id="heading-12">6.1. <code>@RequestPart</code></h3>
<p>获取文件上传内容</p>
<p><code>@RequestPart</code>处理 multipart/form-data 请求中的复杂数据类型，支持文件上传和混合表单数据（如 JSON + 文件）。</p>








































<table><thead><tr><th>特性</th><th>@RequestPart</th><th>@RequestParam</th></tr></thead><tbody><tr><td>数据格式</td><td>支持任何内容类型（如 JSON、XML）</td><td>仅支持 application/x-www-form-urlencoded</td></tr><tr><td>内容类型</td><td>每个部分有独立的 Content-Type</td><td>整个请求统一的 Content-Type</td></tr><tr><td>数据处理</td><td>使用 HttpMessageConverter</td><td>使用 Servlet API 的参数解析</td></tr><tr><td>文件处理</td><td>天然支持文件上传，支持其他类型</td><td>仅支持文件（作为 MultipartFile）</td></tr><tr><td>JSON 绑定</td><td>直接绑定到对象</td><td>不支持</td></tr><tr><td>主要应用场景</td><td>上传文件同时发送 JSON 数据‌：如用户上传头像并附带用户信息（JSON）。<br/>单个请求中混合不同类型的数据‌：如同时上传多个文件和表单数据。<br/>REST API 中的文件上传‌：如上传图片并附带元数据（JSON）。</td><td/></tr></tbody></table>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/upload")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadController</span> {
    <span class="hljs-comment">// 基础文件上传</span>
    <span class="hljs-meta">@PostMapping("/single")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadSingle</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart("file")</span> MultipartFile file)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Uploaded: "</span> + file.getOriginalFilename();
    }

    <span class="hljs-comment">// 多文件上传</span>
    <span class="hljs-meta">@PostMapping("/multiple")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadMultiple</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart("files")</span> MultipartFile[] files)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Uploaded "</span> + files.length + <span class="hljs-string">" files"</span>;
    }

    <span class="hljs-comment">// 文件 + JSON对象</span>
    <span class="hljs-meta">@PostMapping(value = "/upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadData</span><span class="hljs-params">(<span class="hljs-meta">@RequestPart("file")</span> MultipartFile file, 
                             <span class="hljs-meta">@RequestPart("metadata")</span> MyMetadata metadata)</span> {
        <span class="hljs-comment">// metadata 是自定义的 JSON 对象</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Uploaded file with metadata"</span>;
    }
    
    <span class="hljs-comment">// 文件 + 表单字段</span>
    <span class="hljs-meta">@PostMapping(value = "/upload-with-data", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; uploadWithData(
                                            <span class="hljs-meta">@RequestPart("file")</span> MultipartFile file,
                                            <span class="hljs-meta">@RequestParam("name")</span> String name,
                                            <span class="hljs-meta">@RequestParam("description")</span> String description) {
        <span class="hljs-comment">// 处理文件和文本数据</span>
        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"上传成功"</span>);
    }
}
</code></pre>
<p>常见错误及解决方法:</p>
<ol>
<li>忘记设置 consumes = "multipart/form-data"‌：导致无法解析请求。</li>
<li>文件大小超过默认限制‌：需配置 spring.servlet.multipart.max-file-size 和 spring.servlet.multipart.max-request-size。</li>
</ol>
<p>与 @RequestBody 的区别:</p>
<ol>
<li>@RequestBody 用于处理 application/json 或 application/xml 格式的请求体数据。</li>
<li>@RequestPart 用于处理 multipart/form-data 中的复杂数据类型（如 JSON + 文件）。</li>
</ol>
<h3 data-id="heading-13">6.2. <code>@RequestParam</code></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/upload-simple")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadSimple</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> MultipartFile file)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"文件名称: "</span> + file.getOriginalFilename();
}
</code></pre>
<h2 data-id="heading-14">7. 会话和属性参数</h2>
<h3 data-id="heading-15">7.1. <code>@SessionAttribute</code></h3>
<p>获取会话属性</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/dashboard")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">dashboard</span><span class="hljs-params">(<span class="hljs-meta">@SessionAttribute("user")</span> User user)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"欢迎 "</span> + user.getUsername();
}
</code></pre>
<h3 data-id="heading-16">7.2. <code>@RequestAttribute</code></h3>
<p>获取请求域属性</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/process")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">process</span><span class="hljs-params">(<span class="hljs-meta">@RequestAttribute("processedData")</span> String data)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"处理后的数据: "</span> + data;
}
</code></pre>
<h2 data-id="heading-17">8. 其他特殊注解</h2>
<h3 data-id="heading-18">8.1. <code>@MatrixVariable</code></h3>
<p>获取矩阵变量（不常用）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// URL: /cars;color=red;year=2023</span>
<span class="hljs-meta">@GetMapping("/cars")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCar</span><span class="hljs-params">(<span class="hljs-meta">@MatrixVariable</span> String color)</span> {
    <span class="hljs-keyword">return</span> color;
}
</code></pre>
<h3 data-id="heading-19">8.2. <code>@Value</code>（从配置获取）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/config")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(<span class="hljs-meta">@Value("${app.name}")</span> String appName)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"应用名称: "</span> + appName;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 TypeScript 定义数据契约，用 Zustand 实现业务流转]]></title>    <link>https://juejin.cn/post/7600986252449054760</link>    <guid>https://juejin.cn/post/7600986252449054760</guid>    <pubDate>2026-01-30T12:49:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986252449054760" data-draft-id="7600837236621000756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 TypeScript 定义数据契约，用 Zustand 实现业务流转"/> <meta itemprop="keywords" content="前端,TypeScript,全栈"/> <meta itemprop="datePublished" content="2026-01-30T12:49:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秃头敲码小姐姐"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 TypeScript 定义数据契约，用 Zustand 实现业务流转
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秃头敲码小姐姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:49:47.000Z" title="Fri Jan 30 2026 12:49:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">📖 引言：为什么我们需要状态管理？</h4>
<p>在 React 的世界里，我们经常面临一个核心问题：<strong>跨组件通信</strong>。</p>
<p>当你在组件 A 中登录了用户，如何让组件 B（比如导航栏）立刻知道“用户已登录”并显示用户名？如果数据只存在组件内部（<code>useState</code>），它就是“私有的”。我们需要一个<strong>全局可访问、响应式更新</strong>的“公共钱包”。</p>
<p>这就是状态管理器（如 Redux, Zustand）的用武之地。在本文中，我们将以 <strong>Zustand</strong> 为核心，结合 <strong>TypeScript</strong>，深入剖析那些看似简单却极易踩坑的细节。</p>
<p>我们将通过构建一个<strong>待办事项（Todo）应用</strong>和<strong>用户登录系统</strong>来串联所有知识点。</p>
<hr/>
<h3 data-id="heading-1">第一模块：基石篇——TypeScript 类型定义的艺术</h3>
<p>在开始管理状态之前，我们必须先定义好数据的“形状”。这就像盖房子前先画图纸。</p>
<h4 data-id="heading-2">1.1 接口（Interface）的定义与复用</h4>
<p>我们首先定义应用中最核心的两种数据：<code>Todo</code>（待办事项）和 <code>User</code>（用户）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义一个 Todo 的结构</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-comment">// 定义一个 User 的结构</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>💡 核心解析：</strong></p>
<ul>
<li><strong><code>interface</code></strong>：它不是类（Class），它只是一个“契约”。它告诉编译器：“任何标为 Todo 的东西，必须有 id（数字）、title（字符串）和 completed（布尔值）”。</li>
<li><strong>类型安全</strong>：如果你试图给 <code>title</code> 赋值一个数字，TypeScript 会在编译阶段报错，而不是等运行时崩溃。</li>
</ul>
<h4 data-id="heading-3">1.2 状态机思维：定义 Store 的结构</h4>
<p>在 Zustand 中，Store 不仅仅存数据，还存<strong>修改数据的方法</strong>。我们需要定义一个“状态机”接口。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义 TodoState：包含数据和行为</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TodoState</span> {
  <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Todo</span>[]; <span class="hljs-comment">// 数据：待办事项列表</span>
  <span class="hljs-attr">addTodo</span>: <span class="hljs-function">(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 行为：添加方法</span>
  <span class="hljs-attr">toggleTodo</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 行为：切换完成状态</span>
  <span class="hljs-attr">removeTodo</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 行为：删除方法</span>
}
</code></pre>
<p><strong>⚠️ 易错点 1：忘记定义函数类型</strong><br/>
很多新手只定义数据（<code>todos: Todo[]</code>），却忘了定义函数。这会导致在组件中调用 <code>addTodo</code> 时，TypeScript 提示“找不到该属性”。<strong>在 Zustand 中，State 是“数据+逻辑”的集合体。</strong></p>
<h4 data-id="heading-4">1.3 复杂状态的陷阱：嵌套与引用</h4>
<p>看下面这个 <code>UserState</code> 的定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserState</span> {
  <span class="hljs-attr">isLoggin</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 拼写错误陷阱！</span>
  <span class="hljs-attr">login</span>: <span class="hljs-function">(<span class="hljs-params">user: { username: <span class="hljs-built_in">string</span>; password: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">logout</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 关键点：可为空</span>
}
</code></pre>
<p><strong>⚠️ 易错点 2：可为空（Null）的处理</strong><br/>
注意 <code>user: User | null</code>。</p>
<ul>
<li><strong>场景</strong>：应用刚启动时，用户还没登录。此时 <code>user</code> 是 <code>undefined</code> 或 <code>null</code>。</li>
<li><strong>后果</strong>：如果你只定义 <code>user: User</code>，那么你必须在初始化时提供一个完整的 User 对象（比如 <code>user: {id: 0, username: '', password: ''}</code>）。这不仅麻烦，还可能导致逻辑错误（你以为用户登录了，其实只是默认值）。</li>
<li><strong>最佳实践</strong>：对于“可能不存在”的数据，永远加上 <code>| null</code> 或 <code>| undefined</code>。</li>
</ul>
<h4 data-id="heading-5">❓ 答疑解惑环节 1</h4>
<p><strong>Q: 为什么要专门写一个 <code>interface TodoState</code>，直接在 create 里写不行吗？</strong><br/>
A: <strong>可以，但不推荐。</strong> 分离接口（Type）和实现（Logic）是大型项目的最佳实践。</p>
<ol>
<li><strong>可读性</strong>：看接口一眼就知道这个模块有哪些数据和方法。</li>
<li><strong>复用性</strong>：如果另一个 Store 需要引用 Todo 的数据结构，可以直接 <code>extends TodoState</code>。</li>
<li><strong>维护性</strong>：当逻辑变得复杂时，分离类型能让代码不那么臃肿。</li>
</ol>
<p><strong>Q: <code>User | null</code> 和 <code>User | undefined</code> 有什么区别？</strong><br/>
A: 在 JavaScript 运行时，<code>null</code> 和 <code>undefined</code> 通常被视为“无值”。但在 TypeScript 语义上：</p>
<ul>
<li><code>null</code> 通常表示“<strong>有意的空值</strong>”（比如用户注销了，我特意把 user 设为 null）。</li>
<li><code>undefined</code> 通常表示“<strong>未初始化</strong>”。<br/>
在 Zustand 初始化时，两者效果一样。建议团队统一风格，通常推荐用 <code>null</code> 表示“无”。</li>
</ul>
<hr/>
<h3 data-id="heading-6">第二模块：进阶篇——Zustand 的核心机制与持久化</h3>
<p>定义好类型后，我们来创建 Store。Zustand 的核心理念是<strong>极简</strong>。</p>
<h4 data-id="heading-7">2.1 创建 Store：Set 与 Get 的哲学</h4>
<p>以计数器为例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCountStore = create&lt;CounterState&gt;((<span class="hljs-keyword">set</span>) =&gt; ({
  count: <span class="hljs-number">0</span>,
  increment: () =&gt; <span class="hljs-keyword">set</span>((state) =&gt; ({ count: state.count + <span class="hljs-number">1</span> })),
  decrement: () =&gt; <span class="hljs-keyword">set</span>((state) =&gt; ({ count: state.count - <span class="hljs-number">1</span> })),
  reset: () =&gt; <span class="hljs-keyword">set</span>({ count: <span class="hljs-number">0</span> })
}))
</code></pre>
<p><strong>💡 核心解析：</strong></p>
<ul>
<li><strong><code>create&lt;CounterState&gt;</code></strong> ：泛型注入，让 IDE 能自动提示 <code>state.count</code>。</li>
<li><strong><code>set</code> 函数</strong>：这是 Zustand 的心脏。<strong>你不能直接修改 state（如 <code>state.count++</code>），你必须通过 <code>set</code> 告诉 Zustand “我要一个新的 state”</strong> 。</li>
<li><strong>函数式更新</strong>：<code>set((state) =&gt; ...)</code>。当你需要基于旧状态计算新状态时（如加减），必须用函数形式，以防止闭包陷阱。</li>
</ul>
<h4 data-id="heading-8">2.2 异步与中间件：让数据“过夜”</h4>
<p>看下面的用户登录 Store：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { persist } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/middleware'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = create&lt;<span class="hljs-title class_">UserState</span>&gt;()(
  <span class="hljs-title function_">persist</span>(
    <span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
      <span class="hljs-attr">isLoggin</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">login</span>: <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">isLoggin</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">user</span>: { ...user, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> } }),
      <span class="hljs-attr">logout</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">isLoggin</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span> })
    }),
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'user'</span> } <span class="hljs-comment">// 持久化的 key</span>
  )
)
</code></pre>
<p><strong>⚠️ 易错点 3：中间件的执行顺序</strong><br/>
注意 <code>persist</code> 的写法。它是包裹在 <code>create</code> 的参数外面的。</p>
<ul>
<li><strong>逻辑</strong>：Zustand 支持中间件（Middleware）。<code>persist</code> 是一个中间件，它监听所有的 <code>set</code> 操作，并自动将数据存入 <code>localStorage</code>。</li>
<li><strong>坑点</strong>：如果不加 <code>persist</code>，刷新页面后，Store 会重置为初始值（0 或 null）。加了 <code>persist</code> 后，数据就像饼干一样“持久”保存了。</li>
<li><strong>配置</strong>：<code>{ name: 'user' }</code> 对应浏览器 LocalStorage 里的 Key 名字。</li>
</ul>
<h4 data-id="heading-9">2.3 状态更新的“不可变性”（Immutability）</h4>
<p>在 <code>TodoState</code> 的 <code>addTodo</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">addTodo</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ 
  <span class="hljs-attr">todos</span>: [...state.<span class="hljs-property">todos</span>, { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-attr">title</span>: text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> }] 
})),
</code></pre>
<p><strong>⚠️ 易错点 4：直接修改数组</strong><br/>
<strong>错误写法</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">newTodos</span> = state.todos;
newTodos.<span class="hljs-title function_ invoke__">push</span>({<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>});
<span class="hljs-title function_ invoke__">set</span>({ <span class="hljs-attr">todos</span>: newTodos }); <span class="hljs-comment">// 大错特错！这修改了原始引用</span>
</code></pre>
<p><strong>后果</strong>：React 的更新机制依赖于“引用变化”。如果你直接 <code>push</code>，<code>state.todos</code> 的内存地址没变，React 会认为数据没变，<strong>导致页面不刷新！</strong><br/>
<strong>正确做法</strong>：使用扩展运算符 <code>...</code> 创建一个新数组。</p>
<h4 data-id="heading-10">❓ 答疑解惑环节 2</h4>
<p><strong>Q: 为什么 <code>login</code> 函数里要写 <code>{ ...user, id: 1 }</code>？</strong><br/>
A: 这是为了<strong>数据净化</strong>。</p>
<ol>
<li><strong>场景</strong>：用户在登录表单输入 <code>username</code> 和 <code>password</code>，这些数据传给 <code>login</code>。</li>
<li><strong>问题</strong>：表单数据可能没有 <code>id</code> 字段。</li>
<li><strong>解决</strong>：在存入 Store 之前，利用对象扩展语法，给它加上一个 <code>id: 1</code>。这样保证存入的 <code>user</code> 符合 <code>User</code> 接口的定义（必须有 id）。这是一种防御性编程。</li>
</ol>
<p><strong>Q: <code>persist</code> 中间件会导致性能问题吗？</strong><br/>
A: 在大多数场景下<strong>不会</strong>。</p>
<ul>
<li><code>persist</code> 默认是在 <code>set</code> 之后异步写入 LocalStorage 的，不会阻塞主线程。</li>
<li><strong>注意</strong>：不要把太大（MB 级）的数据放进去，LocalStorage 读写较慢，且有容量限制（通常 5-10MB）。</li>
</ul>
<hr/>
<h3 data-id="heading-11">第三模块：实战篇——React 组件的连接与渲染</h3>
<p>有了 Store，现在看组件如何使用。</p>
<h4 data-id="heading-12">3.1 订阅与解构：最小化重渲染</h4>
<p>看 <code>App.tsx</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 从 Store 中“取出”需要的变量和函数</span>
  <span class="hljs-keyword">const</span> { count, increment, decrement, reset } = <span class="hljs-title function_">useCountStore</span>();
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card"</span>&gt;</span>
      {/* 2. 绑定事件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span> count is {count} <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{decrement}</span>&gt;</span> -1 <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{reset}</span>&gt;</span> Reset <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>💡 核心解析：</strong></p>
<ul>
<li><strong><code>useCountStore</code></strong>：这是一个 Hook。它让组件订阅了 Store 的变化。</li>
<li><strong>解构赋值</strong>：我们只取了 <code>count</code>、<code>increment</code> 等。Zustand 智能地做到了**“选择器（Selector）”<strong>机制。如果 Store 里还有其他数据（比如 <code>todos</code>）变了，但 <code>count</code> 没变，这个 <code>App</code> 组件</strong>不会重新渲染**。这是 Zustand 比 Redux 性能好的关键点之一。</li>
</ul>
<h4 data-id="heading-13">3.2 事件处理与状态同步</h4>
<p><strong>⚠️ 易错点 5：异步操作中的状态滞后</strong><br/>
假设你在 <code>onClick</code> 里连续调用 <code>increment()</code> 三次：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误预期</span>
onClick={() =&gt; {
  <span class="hljs-built_in">increment</span>(); <span class="hljs-comment">// 假设 count 从 0 变 1</span>
  <span class="hljs-built_in">increment</span>(); <span class="hljs-comment">// 期望基于 1 变 2</span>
  <span class="hljs-built_in">increment</span>(); <span class="hljs-comment">// 期望基于 2 变 3</span>
}}
</code></pre>
<p><strong>实际结果</strong>：可能只加了 1。</p>
<ul>
<li><strong>原因</strong>：<code>set</code> 是异步的。上面的代码在一次事件循环中连续触发了三次 <code>set</code>，它们可能都基于最初的 <code>state</code>（0）进行计算。</li>
<li><strong>解决</strong>：如果必须连续修改，应该在一次 <code>set</code> 里完成：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">set</span>((state) =&gt; ({ count: state.count + <span class="hljs-number">3</span> }))
</code></pre>
<h4 data-id="heading-14">3.3 表单与状态的双向绑定</h4>
<p>虽然你的代码中没有复杂的表单，但在 Todo 应用中，通常会有：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 伪代码</span>
&lt;<span class="hljs-selector-tag">input</span> 
  value={newTitle} 
  onChange={(e) =&gt; <span class="hljs-built_in">setNewTitle</span>(e.target.value)} 
/&gt;
&lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">addTodo</span>(newTitle)}&gt;Add&lt;/<span class="hljs-selector-tag">button</span>&gt;
</code></pre>
<p>这里 <code>newTitle</code> 是组件的本地状态（<code>useState</code>），而 <code>todos</code> 是全局状态。<strong>区分“本地 UI 状态”和“全局业务状态”是架构设计的关键。</strong></p>
<h4 data-id="heading-15">❓ 答疑解惑环节 3</h4>
<p><strong>Q: 为什么在组件里不需要 <code>useEffect</code> 来监听 Store 的变化？</strong><br/>
A: 因为 Zustand 的 Store Hook（如 <code>useCountStore</code>）内部已经帮你做了这件事。<br/>
当你调用 <code>useCountStore()</code> 时，它不仅返回当前值，还注册了一个监听器。一旦 Store 更新，它会强制组件重新执行 <code>render</code>。你只需要像使用普通变量一样使用它即可。</p>
<p><strong>Q: 如果我想在用户登录成功后跳转页面，该在哪写代码？</strong><br/>
A: 不要在 Store 里写跳转逻辑（如 <code>window.location.href</code>），这会让 Store 依赖浏览器 API，变得难以测试。<br/>
<strong>最佳实践</strong>：</p>
<ol>
<li>
<p>Store 只负责把 <code>isLoggin</code> 改为 <code>true</code>。</p>
</li>
<li>
<p>在组件中使用 <code>useEffect</code> 监听 <code>isLoggin</code>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  if (isLoggin) <span class="hljs-built_in">navigate</span>('/home'); <span class="hljs-comment">// 假设用了 react-router</span>
}, <span class="hljs-selector-attr">[isLoggin]</span>);
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-16">第四模块：牛刀小试</h3>
<h4 data-id="heading-17">💼 1：Zustand 与 Redux 的本质区别是什么？什么时候该用 Zustand？</h4>
<p><strong>参考回答思路：</strong></p>
<ul>
<li><strong>范式差异</strong>：Redux 强调“纯函数”、“Action”、“Reducer”和“单一状态树”，样板代码多，适合超大型复杂项目（如需要时间旅行调试）。Zustand 强调“Hooks 风格”和“中间件”，几乎没有样板代码，更符合现代 React 开发者的直觉。</li>
<li><strong>性能机制</strong>：Redux 默认使用 <code>connect</code> 或 <code>useSelector</code> 需要手动优化（<code>shallowEqual</code>）。Zustand 天然基于选择器（Selector），只有订阅的字段变化才会重渲染，性能开箱即用。</li>
<li><strong>结论</strong>：除非项目有极强的调试回溯需求或团队规范强制使用 Redux，否则对于中小型项目，Zustand 是更高效、更简洁的选择。</li>
</ul>
<h4 data-id="heading-18">💼 2：在你的代码中，<code>user: { ...user, id: 1 }</code> 这一行为什么要用扩展运算符？直接传 <code>user</code> 不行吗？</h4>
<p><strong>参考回答思路：</strong><br/>
这考察的是<strong>不可变性（Immutability）<strong>和</strong>类型安全</strong>。</p>
<ol>
<li><strong>类型补充</strong>：传入的 <code>user</code> 参数可能只包含 <code>username</code> 和 <code>password</code>（来自表单），但 Store 定义的 <code>User</code> 接口要求必须有 <code>id</code>。扩展运算符允许我们在保留原有数据的同时，注入缺失的 <code>id</code>。</li>
<li><strong>引用隔离</strong>：直接使用传入的 <code>user</code> 对象可能会导致引用污染。使用 <code>{...user}</code> 创建了一个新对象，保证了 Store 内部状态的纯净，避免外部对象后续修改影响到 Store。</li>
</ol>
<h4 data-id="heading-19">💼  3：如果我们的应用需要做服务端渲染（SSR），你写的 <code>persist</code> 代码会有问题吗？如何解决？</h4>
<p><strong>参考回答思路：</strong><br/>
<strong>会有问题。</strong></p>
<ul>
<li>
<p><strong>原因</strong>：<code>persist</code> 默认使用浏览器的 <code>localStorage</code>。在服务端（Node.js）环境中，没有 <code>window</code> 对象，也没有 <code>localStorage</code>。如果在 SSR 首屏渲染时直接执行这段代码，服务端会报错 <code>ReferenceError: window is not defined</code>。</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>动态导入</strong>：在 SSR 环境下，延迟加载包含 <code>persist</code> 的 Store，或者在 Store 初始化时检测环境。</p>
</li>
<li>
<p><strong>自定义 Storage</strong>：给 <code>persist</code> 传入一个自定义的 <code>storage</code> 配置。在服务端使用内存存储或 cookie，在客户端使用 localStorage。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> customStorage = {
  <span class="hljs-attr">getItem</span>: <span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-comment">// 服务端逻辑：从 cookie 读取</span>
    <span class="hljs-comment">// 客户端逻辑：从 localStorage 读取</span>
  },
  <span class="hljs-attr">setItem</span>: <span class="hljs-function">(<span class="hljs-params">name, value</span>) =&gt;</span> {
    <span class="hljs-comment">// 客户端写入 localStorage</span>
  }
}
</code></pre>
</li>
</ol>
</li>
</ul>
<hr/>
<h4 data-id="heading-20">🌟 结语</h4>
<p>编程不仅仅是写代码，更是<strong>逻辑的构建与错误的规避</strong>。</p>
<p>通过这篇博客，我希望你不仅学会了如何使用 Zustand 和 TypeScript，更重要的是理解了 <strong>“状态是唯一的真相源（Source of Truth）”</strong> 这一理念。</p>
<p>记住：<strong>优秀的代码不是写出来的，是重构出来的。</strong> 每一次对“易错点”的规避，都是你编程内功的一次提升。</p>
<p>祝你在前端开发的道路上，代码无 Bug，人生无坑！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再让用户等哭！React 懒加载：让组件 “躺平” 到要用时再干活]]></title>    <link>https://juejin.cn/post/7600955777315979302</link>    <guid>https://juejin.cn/post/7600955777315979302</guid>    <pubDate>2026-01-30T13:13:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777315979302" data-draft-id="7600299283485114418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再让用户等哭！React 懒加载：让组件 “躺平” 到要用时再干活"/> <meta itemprop="keywords" content="React.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T13:13:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再让用户等哭！React 懒加载：让组件 “躺平” 到要用时再干活
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:13:55.000Z" title="Fri Jan 30 2026 13:13:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>之前咱们聊了<strong>普通网页的图片懒加载</strong> —— 让图片 <strong>“藏” 在屏幕外摸鱼</strong>，滚到眼前再开工。那 <code>React</code> 项目里的组件和图片呢？总不能一打开页面就把所有组件的代码都拽过来吧？</p>
<p><strong>想象下</strong>：你打开<strong>购物App</strong>页面，首页就加载了 <strong>“订单页”“个人中心”</strong> 的代码，结果用户根本没点进去 —— 这不是纯纯的浪费流量和性能吗？<code>React 的懒加载</code>，就是给组件和图片发 <code>“摸鱼许可证”</code>：<strong>没出现在视野里，就别加载，躺平到要用时再干活</strong>。</p>
<p>如果不了解<strong>懒加载</strong>的，我的上篇文章在这：</p>
<blockquote>
<p><a href="https://juejin.cn/post/7600224355294576667" target="_blank" title="https://juejin.cn/post/7600224355294576667">救命！我那加载慢到离谱的图片，终于被懒加载 “救活” 了</a></p>
</blockquote>
<h3 data-id="heading-1">一、React 里的 “组件懒加载”：<code>React.lazy</code> + 动态导入</h3>
<p>我们先创建一个<code>Demo组件</code>，并看这行代码：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 别直接import Demo，改成动态导入 </span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Demo'</span>));
</code></pre>
<p><strong>这行代码的魔力在于：</strong></p>
<ul>
<li>原本<code>import Demo from './Demo'</code>会在页面初始化时就<strong>加载 Demo 组件的代码</strong>；</li>
<li>用<code>React.lazy</code>+<code>import()</code>包裹后，Demo 的代码会被<strong>单独打包成一个小文件</strong>，只有<code>当 Demo 组件要被渲染</code>（比如滚到可视区域）时，这个小文件才会被下载、加载。</li>
</ul>
<p><strong>搭配<code>Suspense</code>（不然组件加载时会 “崩”）</strong></p>
<p>不过光用<code>lazy</code>还不够 —— 组件加载需要时间，加载过程中页面会报错。得用<code>Suspense</code>当 “占位符”：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { lazy, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Demo'</span>));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 一堆内容... */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>组件加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Demo</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p><code>fallback</code>里写的就是组件加载时的 <strong>“Loading 占位”</strong>，比如转圈圈、提示文字，用户体验会更友好。</p>
<h3 data-id="heading-2">二、React 里的 “图片 / 内容懒加载”：<code>react-lazyload</code> 或 自定义组件</h3>
<p>组件懒加载管的是 <strong>“代码包”</strong>，图片 / 内容懒加载管的是 <strong>“可视区域内才渲染内容”</strong>。我常用的有两种方案：</p>
<h4 data-id="heading-3">方案 1：直接用<code>react-lazyload</code>库（现成的轮子）</h4>
<blockquote>
<p>仓库地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Freact-lazyload" target="_blank" title="https://www.npmjs.com/package/react-lazyload" ref="nofollow noopener noreferrer">www.npmjs.com/package/rea…</a></p>
<p>下载方法：<code>npm i react-lazyload</code></p>
</blockquote>
<p>导入的<code>LazyLoad</code>就是这个库，直接包在图片外面：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">LazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-lazyload'</span>;

<span class="hljs-comment">// 在App.jsx里用：</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyLoad</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>图片加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} offset={300}&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://xxx.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LazyLoad</span>&gt;</span></span>
</code></pre>
<ul>
<li><code>placeholder</code>：图片加载前的占位内容；</li>
<li><code>offset={300}</code>：<strong>提前 <code>300px</code> 开始加载图片</strong>（用户还没滚到，图片已经在偷偷加载了，体验更丝滑）。</li>
</ul>
<p><strong>完整代码</strong>（为了更好展现效果，我放了<code>50个p标签</code>）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">LazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-lazyload'</span>;
<span class="hljs-keyword">import</span> { lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-comment">// import Demo from './Demo'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyLazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyLazyLoad'</span>

<span class="hljs-comment">// 组件没有出现在可视区域时，组件代码都不会被加载，被import('./Demo')包裹的模块会单独打包</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Demo'</span>));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* <span class="hljs-tag">&lt;<span class="hljs-name">Demo</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Demo</span>&gt;</span> */}
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyLazyLoad</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} width='100px' onContentVisible={() =&gt; console.log('onContentVisible')} onClose={() =&gt; console.log('onClose')}&gt;
                {/* <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/OG4Cnt2SgXAuTj-Vv77ASGszUj1BwOhUXtBCplSlBfQmAAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span> */}
                <span class="hljs-tag">&lt;<span class="hljs-name">Demo</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Demo</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">MyLazyLoad</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">LazyLoad</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} offset={300}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">LazyLoad</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>可以看到最开始的界面显示的都是<code>loading</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/472d2993a5bb4c7b82b6c4e40bfbd34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383635&amp;x-signature=UDniOk3un5bQLC4vc%2FTBlMsinSY%3D" alt="image.png" loading="lazy"/></p>
<p>我们慢慢往下滑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea721eb3b5e941a69e984f10ce57b087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383635&amp;x-signature=kJDZtnXss1lPAyw7GcRxCgmoZlI%3D" alt="image.png" loading="lazy"/></p>
<p>滑到<code>Demo</code>和 <code>照片</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df5a6ced8544f5ebc42a19fc55df975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383635&amp;x-signature=QA3g6ka2x%2Fh01P01DZ2EFc47c0o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">方案 2：自己写一个懒加载组件（比如我自己写的<code>MyLazyLoad.jsx</code>）</h4>
<p>我写的<code>MyLazyLoad</code>组件，核心就是用<code>IntersectionObserver</code>实现 <strong>“可视区域检测”</strong>，逻辑和之前普通网页的懒加载是通的：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// MyLazyLoad.jsx核心代码</span>
<span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyLazyLoad</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> { placeholder, children, offset, onContentVisible } = props;
    <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> containerRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> elementObserver = <span class="hljs-title function_">useRef</span>();

    <span class="hljs-comment">// 初始化IntersectionObserver</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> options = {
            <span class="hljs-attr">threshold</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">rootMargin</span>: <span class="hljs-keyword">typeof</span> offset === <span class="hljs-string">'number'</span> ? <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span> : <span class="hljs-string">'0px'</span>
        };
        <span class="hljs-comment">// 监听元素是否进入可视区域</span>
        elementObserver.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(lazyLoadHandler, options);
        <span class="hljs-keyword">const</span> node = containerRef.<span class="hljs-property">current</span>;
        elementObserver.<span class="hljs-property">current</span>.<span class="hljs-title function_">observe</span>(node);

        <span class="hljs-comment">// 卸载时停止监听</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            elementObserver.<span class="hljs-property">current</span>.<span class="hljs-title function_">unobserve</span>(node);
        };
    }, []);

    <span class="hljs-comment">// 元素进入可视区域后的处理</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyLoadHandler</span>(<span class="hljs-params">entries</span>) {
        <span class="hljs-keyword">const</span> [entry] = entries;
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
            <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 显示真实内容</span>
            onContentVisible?.(); <span class="hljs-comment">// 触发“内容可见”的回调</span>
            elementObserver.<span class="hljs-property">current</span>.<span class="hljs-title function_">unobserve</span>(containerRef.<span class="hljs-property">current</span>); <span class="hljs-comment">// 停止监听</span>
        }
    }

    <span class="hljs-comment">// 没进入可视区域就显示占位，进入了就显示真实内容</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{containerRef}</span>&gt;</span>
            {visible ? children : placeholder}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>用的时候和<code>react-lazyload</code>差不多，把要懒加载的内容包进去：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;<span class="hljs-title class_">MyLazyLoad</span> placeholder={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>} offset={<span class="hljs-number">300</span>}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://xxx.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span></span>
    {<span class="hljs-comment">/* 甚至可以包组件：&lt;Demo /&gt; */</span>}
&lt;/<span class="hljs-title class_">MyLazyLoad</span>&gt;
</code></pre>
<h3 data-id="heading-5">三、“组件懒加载”+“内容懒加载”：双剑合璧</h3>
<p>把前面的技术结合起来，就是 <code>React 项目</code>里的 <strong>“终极懒加载”</strong>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { lazy, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyLazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyLazyLoad'</span>;

<span class="hljs-comment">// 组件代码懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Demo</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Demo'</span>));
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {/* 一堆内容... */}
            {/* 组件代码+组件内容 都懒加载 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>组件包加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">MyLazyLoad</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>组件内容加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">Demo</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">MyLazyLoad</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<ul>
<li><strong>第一步</strong>：用户滑到 <code>Demo 区域前</code>，<code>Demo</code>的代码包<strong>不会下载</strong>；</li>
<li><strong>第二步</strong>：代码包下载完成后，<code>MyLazyLoad</code>会等 Demo <strong>进入可视区域</strong>，再渲染 Demo 的内容；</li>
<li><strong>全程都有占位提示，用户不会看到 “空白” 或 “报错”</strong>。</li>
</ul>
<h3 data-id="heading-6">四、总结</h3>
<ul>
<li><strong>React 懒加载分两类</strong>：<code>React.lazy</code>+<code>Suspense</code>实现<strong>组件代码按需下载</strong>，<code>react-lazyload</code>/ 自定义组件实现<strong>内容按需渲染</strong>。</li>
<li><strong>核心价值</strong>：减少初始化资源开销，提升页面加载和渲染性能。</li>
</ul>
<h2 data-id="heading-7">结语</h2>
<p><strong>普通网页的懒加载</strong>是让图片 <code>“摸鱼”</code>，<strong>React 的懒加载</strong>则是给组件和代码都发了 <code>“摸鱼许可证”</code>—— 不用一开场就全员到岗，该躺平时躺平，该干活时再发力。</p>
<p>就好比经营一家店，<strong>不用把所有商品都堆在门口</strong> <code>（初始化加载所有代码）</code>，而是<strong>把暂时没人要的商品放进仓库</strong> <code>（单独打包组件）</code>，等顾客问到了再取出来，摆上货架<code>（渲染内容）</code>—— 既<strong>省了门口的空间</strong> <code>（页面加载性能）</code>，又不会让顾客等太久 <code>（优化用户体验）</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌟 JavaScript `Symbol` 全面学习笔记（ES6+）]]></title>    <link>https://juejin.cn/post/7600990891218681865</link>    <guid>https://juejin.cn/post/7600990891218681865</guid>    <pubDate>2026-01-30T13:36:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891218681865" data-draft-id="7601028900885594158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌟 JavaScript `Symbol` 全面学习笔记（ES6+）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T13:36:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会敲代码1"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌟 JavaScript `Symbol` 全面学习笔记（ES6+）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会敲代码1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:36:39.000Z" title="Fri Jan 30 2026 13:36:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌟 JavaScript <code>Symbol</code> 全面学习笔记（ES6+）</h2>
<blockquote>
<p>✅ <strong>一句话定义</strong>：<br/>
<code>Symbol</code> 是 ES6 引入的<strong>第七种原始数据类型</strong>（Primitive Type），用于创建<strong>唯一、不可变、匿名的标识符</strong>，主要解决对象属性名冲突问题，并支持元编程能力。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、基础认知：它是什么？</h3>





















<table><thead><tr><th>维度</th><th>说明</th></tr></thead><tbody><tr><td><strong>数据类型</strong></td><td>原始类型（<code>typeof Symbol() === 'symbol'</code>） ✅ 与 <code>string</code>/<code>number</code>/<code>boolean</code>/<code>null</code>/<code>undefined</code>/<code>bigint</code> 并列（共 7 种） ❌ 不是对象（<code>new Symbol()</code> 报错）</td></tr><tr><td><strong>创建方式</strong></td><td><code>Symbol([description])</code> —— <strong>函数调用，非构造函数</strong> • <code>description</code>（可选）：仅用于调试显示的字符串描述，<strong>不影响唯一性</strong> • 每次调用 <code>Symbol()</code> 都返回<strong>全新且不相等</strong>的值</td></tr><tr><td><strong>唯一性保证</strong></td><td>✅ <code>Symbol() !== Symbol()</code>（即使 description 相同） ✅ <code>Symbol('a') !== Symbol('a')</code> —— <strong>描述相同 ≠ 值相同</strong></td></tr></tbody></table>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">s1</span> = Symbol(<span class="hljs-string">'id'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">s2</span> = Symbol(<span class="hljs-string">'id'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">s1</span> === s2)<span class="hljs-comment">; // false ✅</span>
console.log(s1.toString())<span class="hljs-comment">; // "Symbol(id)"</span>
console.log(s2.toString())<span class="hljs-comment">; // "Symbol(id)"</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">二、核心特性与用途</h3>
<h4 data-id="heading-3">✅ 1. 作为对象的<strong>私有/隐藏属性键（Key）</strong></h4>
<ul>
<li>解决多人协作中对象属性名冲突问题（如 <code>user.id</code> vs <code>user.id</code> 被覆盖）</li>
<li><code>Symbol</code> 键<strong>不会被常规遍历方法枚举</strong>，实现“弱私有”语义</li>
</ul>








































<table><thead><tr><th>遍历方式</th><th>是否访问 Symbol 键</th><th>说明</th></tr></thead><tbody><tr><td><code>for...in</code></td><td>❌</td><td>仅遍历可枚举的<strong>字符串键</strong></td></tr><tr><td><code>Object.keys()</code></td><td>❌</td><td>同上</td></tr><tr><td><code>Object.getOwnPropertyNames()</code></td><td>❌</td><td>仅返回字符串键（含不可枚举）</td></tr><tr><td><code>JSON.stringify()</code></td><td>❌</td><td>忽略 Symbol 键</td></tr><tr><td><code>Object.getOwnPropertySymbols()</code></td><td>✅</td><td><strong>唯一标准方法获取所有 Symbol 键</strong></td></tr><tr><td><code>Reflect.ownKeys()</code></td><td>✅</td><td>返回所有键（字符串 + Symbol）</td></tr></tbody></table>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> secret = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'password'</span>);
<span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'zhang@example.com'</span>,
  [secret]: <span class="hljs-string">'123456'</span> <span class="hljs-comment">// 隐藏密钥</span>
};

<span class="hljs-comment">// ✅ 安全访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user[secret]); <span class="hljs-comment">// "123456"</span>

<span class="hljs-comment">// ❌ 不会被意外覆盖或暴露</span>
user.<span class="hljs-property">secret</span> = <span class="hljs-string">'hacked'</span>; <span class="hljs-comment">// 新增字符串键，不影响 Symbol 键</span>

<span class="hljs-comment">// 🔍 查看 Symbol 键（需主动调用）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(user)); <span class="hljs-comment">// [Symbol(password)]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(user)); <span class="hljs-comment">// ['name', 'email', Symbol(password)]</span>
</code></pre>
<h4 data-id="heading-4">✅ 2. 全局注册表：<code>Symbol.for()</code> 与 <code>Symbol.keyFor()</code></h4>
<p>当需要<strong>跨模块共享同一个 Symbol</strong> 时使用（避免重复创建）：</p>




















<table><thead><tr><th>方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>Symbol.for(key)</code></td><td>在<strong>全局 Symbol 注册表</strong>中查找/创建 Symbol ✅ 同 key → 同 Symbol</td><td><code>Symbol.for('shared') === Symbol.for('shared') // true</code></td></tr><tr><td><code>Symbol.keyFor(sym)</code></td><td>返回该 Symbol 在注册表中的 key（仅对 <code>for()</code> 创建的生效）</td><td><code>Symbol.keyFor(Symbol.for('shared')) // 'shared'</code></td></tr></tbody></table>
<p>⚠️ 注意：<code>Symbol('a')</code> 和 <code>Symbol.for('a')</code> <strong>完全不同</strong>！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'a'</span>) === <span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'a'</span>)); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'a'</span>) === <span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'a'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-5">✅ 3. 内置 Symbol（Well-known Symbols）—— 实现协议接口</h4>
<p>ES6 定义了一系列以 <code>Symbol.</code> 开头的<strong>预设 Symbol 值</strong>，用于自定义对象行为（鸭子类型协议）：</p>















































<table><thead><tr><th>Symbol</th><th>作用</th><th>触发场景</th><th>示例简写</th></tr></thead><tbody><tr><td><code>Symbol.iterator</code></td><td>定义对象的默认迭代器</td><td><code>for...of</code>, <code>[...obj]</code>, <code>Array.from()</code></td><td><code>obj[Symbol.iterator] = function*(){...}</code></td></tr><tr><td><code>Symbol.toStringTag</code></td><td>自定义 <code>Object.prototype.toString.call(obj)</code> 输出</td><td><code>Object.prototype.toString.call(obj)</code></td><td><code>obj[Symbol.toStringTag] = 'MyClass'</code> → <code>"[object MyClass]"</code></td></tr><tr><td><code>Symbol.hasInstance</code></td><td>自定义 <code>instanceof</code> 行为</td><td><code>obj instanceof Constructor</code></td><td><code>class MyClass { static [Symbol.hasInstance](x) { return x?.custom === true; } }</code></td></tr><tr><td><code>Symbol.isConcatSpreadable</code></td><td>控制 <code>Array.prototype.concat()</code> 是否展开</td><td><code>[].concat(arr)</code></td><td><code>arr[Symbol.isConcatSpreadable] = false</code></td></tr><tr><td><code>Symbol.toPrimitive</code></td><td>定义对象转原始值逻辑（<code>+</code>, <code>==</code>, <code>String()</code> 等）</td><td><code>obj + 1</code>, <code>String(obj)</code></td><td><code>obj[Symbol.toPrimitive] = (hint) =&gt; hint === 'number' ? 42 : 'foo'</code></td></tr><tr><td><code>Symbol.unscopables</code></td><td>指定 <code>with</code> 语句中屏蔽的属性（已废弃但需了解）</td><td><code>with(obj){ prop }</code></td><td><code>obj[Symbol.unscopables] = { prop: true }</code></td></tr></tbody></table>
<blockquote>
<p>💡 这些是 JS <strong>元编程（Metaprogramming）</strong> 的基石，让对象能“参与语言级协议”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">三、重要注意事项与常见误区</h3>



































<table><thead><tr><th>误区</th><th>正确理解</th><th>为什么重要</th></tr></thead><tbody><tr><td>❌ <code>Symbol</code> 是“私有属性”</td><td>⚠️ <strong>不是真正私有</strong>： • 可通过 <code>Object.getOwnPropertySymbols()</code> 获取 • 可通过 <code>Reflect.ownKeys()</code> 获取 • <code>JSON.stringify()</code> 会忽略，但 <code>console.log()</code> 仍可见</td><td>避免误以为 Symbol=private，实际是“不易被意外访问”，非安全隔离</td></tr><tr><td>❌ <code>Symbol</code> 可以隐式转换为字符串</td><td>❌ <strong>Symbol 不能隐式转换</strong>： <code>'' + Symbol()</code> → TypeError <code>String(Symbol())</code> ✅ 显式转换</td><td>防止静默错误，强制开发者显式处理</td></tr><tr><td>❌ 所有 Symbol 都是全局唯一的</td><td>⚠️ <code>Symbol.for()</code> 创建的是<strong>全局注册的 Symbol</strong>，<code>Symbol()</code> 才是绝对唯一</td><td>混淆二者会导致预期外的相等性（如误以为 <code>Symbol('a') === Symbol.for('a')</code>）</td></tr><tr><td>❌ Symbol 键在 <code>Object.assign()</code> 中会被忽略</td><td>✅ <strong>会被复制</strong>！ <code>Object.assign({}, obj)</code> 会复制 Symbol 键</td><td>与 <code>JSON.stringify()</code> 不同，需注意深拷贝兼容性</td></tr><tr><td>❌ <code>Symbol</code> 可以作为 <code>Map</code> / <code>WeakMap</code> 的键</td><td>✅ <strong>完全支持</strong>，且是理想选择： <code>map.set(Symbol(), value)</code> —— 无冲突、无泄漏风险</td><td><code>WeakMap</code> + <code>Symbol</code> 是实现真正私有状态的经典组合</td></tr></tbody></table>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ WeakMap + Symbol 实现“真私有”</span>
<span class="hljs-keyword">const</span> privateData = new WeakMap();
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-keyword">constructor</span>(name) {
    privateData.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">this</span>, { name }); <span class="hljs-comment">// 存储私有数据</span>
  }
  getName() {
    <span class="hljs-keyword">return</span> privateData.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">this</span>)?.name;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">四、与其他数据类型的对比速查表</h3>






















































<table><thead><tr><th>特性</th><th><code>Symbol</code></th><th><code>String</code></th><th><code>Number</code></th><th><code>Object</code></th></tr></thead><tbody><tr><td>类型</td><td>Primitive</td><td>Primitive</td><td>Primitive</td><td>Reference</td></tr><tr><td>唯一性</td><td>✅ 每次调用新值</td><td>❌ 字符串值相等即相等</td><td>❌ 数值相等即相等</td><td>❌ 引用不同即不等</td></tr><tr><td>可枚举性</td><td>❌ 不被 <code>for...in</code> / <code>keys()</code> 枚举</td><td>✅</td><td>✅</td><td>✅（自身可枚举属性）</td></tr><tr><td>可作为对象键</td><td>✅</td><td>✅</td><td>✅（自动转字符串）</td><td>✅（自动转字符串）</td></tr><tr><td>可序列化（JSON）</td><td>❌（被忽略）</td><td>✅</td><td>✅</td><td>✅（仅可枚举自有属性）</td></tr><tr><td>可隐式转换</td><td>❌（TypeError）</td><td>✅（<code>+str</code>, <code>str + ''</code>）</td><td>✅</td><td>✅（<code>toString()</code>/<code>valueOf()</code>）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">五、最佳实践建议</h3>
<ol>
<li>
<p><strong>命名冲突防护</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">MY_LIB_PREFIX</span> = Symbol(<span class="hljs-string">'my-lib'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">config</span> = { [MY_LIB_PREFIX]: { debug: <span class="hljs-literal">true</span> } }<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>常量定义（替代字符串常量）</strong> ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS</span> = {
  <span class="hljs-attr">PENDING</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'PENDING'</span>),
  <span class="hljs-attr">FULFILLED</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'FULFILLED'</span>),
  <span class="hljs-attr">REJECTED</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'REJECTED'</span>)
};
<span class="hljs-comment">// ✅ 比字符串更安全：STATUS.PENDING !== 'PENDING'</span>
</code></pre>
</li>
<li>
<p><strong>配合 <code>WeakMap</code> 实现私有状态</strong>（见上文）。</p>
</li>
<li>
<p><strong>慎用 <code>Symbol.for()</code></strong> ：仅在<strong>明确需要跨模块共享 Symbol</strong> 时使用，避免污染全局注册表。</p>
</li>
<li>
<p><strong>调试技巧</strong>：</p>
<ul>
<li>使用 <code>Symbol.description</code> 获取描述（<code>s.description === 'id'</code>）</li>
<li><code>console.log(s)</code> 显示 <code>Symbol(id)</code>，便于识别</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">六、延伸思考：为什么需要 Symbol？</h3>






























<table><thead><tr><th>问题</th><th>传统方案缺陷</th><th><code>Symbol</code> 解决方案</th></tr></thead><tbody><tr><td>对象属性名冲突</td><td>多人协作时 <code>user.id</code> 可能被覆盖</td><td><code>user[Symbol('id')]</code> 确保唯一</td></tr><tr><td>需要“隐藏”配置项</td><td>用 <code>_</code> 前缀（约定俗成，不强制）</td><td><code>Symbol</code> 键天然不被常规遍历发现</td></tr><tr><td>自定义对象行为（迭代、转换等）</td><td>无法干预语言内置操作</td><td>内置 Symbol 协议提供标准钩子</td></tr><tr><td>Map 键需唯一且无哈希碰撞</td><td>字符串键可能重复，对象键会转字符串</td><td><code>Symbol</code> 作为键既唯一又高效</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>本质</strong>：<code>Symbol</code> 是 JS 为<strong>元编程</strong>和<strong>安全扩展</strong>而设计的底层原语，是语言演进的关键一步。</p>
</blockquote>
<hr/>
<p>📌 <strong>附：快速测试代码（可直接运行）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 验证唯一性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>() === <span class="hljs-title class_">Symbol</span>()); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'a'</span>) === <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'a'</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 验证不可枚举性</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">str</span>: <span class="hljs-string">'hello'</span>, [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'sym'</span>)]: <span class="hljs-string">'world'</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)); <span class="hljs-comment">// ['str']</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(obj)); <span class="hljs-comment">// [Symbol(sym)]</span>

<span class="hljs-comment">// 验证全局注册</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'test'</span>) === <span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'test'</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">'test'</span>) === <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'test'</span>)); <span class="hljs-comment">// false</span>
</code></pre>
<hr/>
<h3 data-id="heading-10"> 补充知识点</h3>
<h3 data-id="heading-11">为什么必须写 <code>[secret]</code>？—— 破解你心中的核心困惑</h3>
<p>你代码中这两行是理解 Symbol 的分水岭：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">secret</span> = Symbol(<span class="hljs-string">'password'</span>)<span class="hljs-comment">;     // ✅ 创建一个 Symbol 实例，存入变量 secret</span>

// ❌ 错误：{ secret: '123' } → 创建字符串键 'secret'
const <span class="hljs-attr">user1</span> = { secret: <span class="hljs-string">'123'</span> }<span class="hljs-comment">;</span>

// ✅ 正确：{ <span class="hljs-section">[secret]</span>: '123' } → 使用变量 secret 的值（即 Symbol）作为键
const <span class="hljs-attr">user2</span> = { [secret]: <span class="hljs-string">'123'</span> }<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-12">🔍 深度解析：方括号 <code>[ ]</code> 是唯一“开门钥匙”</h4>
<p>表格</p>























<table><thead><tr><th>写法</th><th>JS 如何解析</th><th>实际创建的键</th><th>是否访问到<code>'123'</code>？</th></tr></thead><tbody><tr><td><code>{ secret: '123' }</code></td><td>将 <code>secret</code> 视为<strong>字面量标识符</strong> → 自动转为字符串 <code>'secret'</code></td><td>字符串 <code>'secret'</code></td><td><code>user1.secret</code> ✅ → <code>'123'</code> <code>user1[secret]</code> ❌ → <code>undefined</code></td></tr><tr><td><code>{ [secret]: '123' }</code></td><td>方括号触发<strong>计算属性名（Computed Property Name）</strong>  → 先求值 <code>secret</code> 变量 → 得到 <code>Symbol('password')</code></td><td><code>Symbol('password')</code></td><td><code>user2[secret]</code> ✅ → <code>'123'</code> <code>user2.secret</code> ❌ → <code>undefined</code>（无字符串键 <code>'secret'</code>）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键结论</strong>：</p>
<ul>
<li><code>.</code> 和 <code>{ key: }</code> 中的 <code>key</code> <strong>永远只认字符串字面量</strong>；</li>
<li><code>[ ]</code> 是 JS 中<strong>唯一能将变量、表达式、Symbol 动态注入为属性名的语法</strong>；</li>
<li>因此： <strong><code>[secret]</code> 不是“一种写法”，而是使用 Symbol 作键的强制语法要求。</strong></li>
</ul>
</blockquote>
<h4 data-id="heading-13">🧩 类比助记（来自代码的场景）</h4>
<blockquote>
<p>想象 <code>secret</code> 是一把<strong>定制指纹锁的模具</strong>：</p>
<ul>
<li><code>{ secret: ... }</code> → 相当于在门上贴了张纸条，写着“secret”二字（任何人都能看见、修改）；</li>
<li><code>{ [secret]: ... }</code> → 把模具按在门上，<strong>生成一个独一无二的物理锁孔</strong>，只有同一模具（即同一个 <code>secret</code> 变量）才能打开。</li>
</ul>
<p>所以：<strong>没有 <code>[ ]</code>，就没有 Symbol 键；没有 Symbol 键，就没有命名隔离与安全防护。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[文本编码转换器核心JS实现]]></title>    <link>https://juejin.cn/post/7600837236621230132</link>    <guid>https://juejin.cn/post/7600837236621230132</guid>    <pubDate>2026-01-30T14:18:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600837236621230132" data-draft-id="7600976289063976960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="文本编码转换器核心JS实现"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-30T14:18:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="滕青山"/> <meta itemprop="url" content="https://juejin.cn/user/3206601805674094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            文本编码转换器核心JS实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3206601805674094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    滕青山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T14:18:35.000Z" title="Fri Jan 30 2026 14:18:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">工具网址和截图</h2>
<blockquote>
<p>在线工具网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsee-tool.com%2Fencoding-converter" target="_blank" title="https://see-tool.com/encoding-converter" ref="nofollow noopener noreferrer">see-tool.com/encoding-co…</a></p>
</blockquote>
<blockquote>
<p>工具截图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d20a3b702b94741b4dcfc6c38126d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ruV6Z2S5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770387515&amp;x-signature=hllfa2i6gXN7bVSbyQfzA7P%2Bbko%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-1">文本编码转换器功能核心实现解析</h2>
<p>本文将深入探讨文本编码转换器（Text Encoding Converter）的核心 JavaScript 实现逻辑。该工具旨在实现普通文本与多种编码格式（如十六进制、二进制、Base64、Unicode 等）之间的相互转换。</p>
<h3 data-id="heading-2">1. 核心转换机制</h3>
<p>整个工具的转换逻辑基于一个统一的入口函数 <code>convert</code>，它根据输入和输出格式，通过查找表（Lookup Table）调用相应的转换函数。</p>
<p>核心的字节处理依赖于浏览器原生的 <code>TextEncoder</code> 和 <code>TextDecoder</code> API，这确保了对 UTF-8 的正确处理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 字符串转字节数组</span>
<span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
<span class="hljs-keyword">const</span> bytes = encoder.<span class="hljs-title function_">encode</span>(text);

<span class="hljs-comment">// 字节数组转字符串</span>
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bytes));
</code></pre>
<h3 data-id="heading-3">2. 格式转换实现细节</h3>
<h4 data-id="heading-4">2.1 进制转换 (Hex, Binary, Octal, Decimal)</h4>
<p>对于二进制、八进制、十六进制等数字格式，核心思路是将文本转换为字节数组，然后利用 <code>Number.prototype.toString(radix)</code> 将每个字节转换为对应的进制字符串。</p>
<p>以**Hex（十六进制）**为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">textToHex</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">text, delimiter, prefix, uppercase</span>) {
    <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
    <span class="hljs-keyword">const</span> bytes = encoder.<span class="hljs-title function_">encode</span>(text);
    <span class="hljs-keyword">let</span> hex = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(bytes).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> {
        <span class="hljs-comment">// 每个字节转16进制，并补齐2位</span>
        <span class="hljs-keyword">let</span> h = b.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
        <span class="hljs-keyword">if</span> (uppercase) h = h.<span class="hljs-title function_">toUpperCase</span>();
        <span class="hljs-keyword">return</span> prefix + h;
    });
    <span class="hljs-keyword">return</span> hex.<span class="hljs-title function_">join</span>(delimiter);
}
</code></pre>
<p>反向转换则是移除前缀和分隔符后，使用 <code>parseInt(chunk, 16)</code> 还原字节。</p>
<h4 data-id="heading-5">2.2 Base64 编码</h4>
<p>JavaScript 原生的 <code>btoa</code> 和 <code>atob</code> 函数只能处理 ASCII 字符。为了支持中文等 Unicode 字符，我们需要先对字符串进行编码处理。</p>
<p><strong>文本转 Base64</strong> 的健壮实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">textToBase64</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 方法1: 使用 TextEncoder 获取字节，构造二进制字符串</span>
        <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
        <span class="hljs-keyword">const</span> bytes = encoder.<span class="hljs-title function_">encode</span>(text);
        <span class="hljs-keyword">let</span> binary = <span class="hljs-string">''</span>;
        bytes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">byte</span> =&gt;</span> binary += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(byte));
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">btoa</span>(binary);
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// 方法2: 降级方案，使用 encodeURIComponent 处理</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">btoa</span>(<span class="hljs-built_in">unescape</span>(<span class="hljs-built_in">encodeURIComponent</span>(text)));
    }
}
</code></pre>
<p><strong>Base64 转文本</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">base64ToText</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">base64</span>) {
    <span class="hljs-keyword">const</span> binary = <span class="hljs-title function_">atob</span>(base64.<span class="hljs-title function_">trim</span>());
    <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(binary.<span class="hljs-property">length</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; binary.<span class="hljs-property">length</span>; i++) {
        bytes[i] = binary.<span class="hljs-title function_">charCodeAt</span>(i);
    }
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">return</span> decoder.<span class="hljs-title function_">decode</span>(bytes);
}
</code></pre>
<h4 data-id="heading-6">2.3 Unicode 转义与码点</h4>
<p>处理 Unicode 转义（如 <code>\u4E2D</code>）时，关键在于正确处理<strong>代理对（Surrogate Pairs）</strong>。对于超出基本多文种平面（BMP, U+0000 到 U+FFFF）的字符（例如 Emoji），JavaScript 的字符串长度为 2。</p>
<p>我们使用 <code>codePointAt(0)</code> 来获取完整的码点值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">textToUnicodeEscape</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">text, delimiter, uppercase</span>) {
    <span class="hljs-keyword">let</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> char <span class="hljs-keyword">of</span> text) {
        <span class="hljs-keyword">let</span> code = char.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-comment">// 如果码点超过 0xFFFF，说明是代理对，JS 会将其视为两个字符</span>
        <span class="hljs-keyword">if</span> (code &gt; <span class="hljs-number">0xFFFF</span>) {
            <span class="hljs-comment">// 手动计算代理对（虽然 ES6 for-of 循环会自动正确迭代字符）</span>
            <span class="hljs-keyword">const</span> high = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((code - <span class="hljs-number">0x10000</span>) / <span class="hljs-number">0x400</span>) + <span class="hljs-number">0xD800</span>;
            <span class="hljs-keyword">const</span> low = (code - <span class="hljs-number">0x10000</span>) % <span class="hljs-number">0x400</span> + <span class="hljs-number">0xDC00</span>;
            <span class="hljs-comment">// ... 转换为 \uXXXX\uXXXX 格式</span>
            <span class="hljs-keyword">let</span> h1 = high.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>);
            <span class="hljs-keyword">let</span> h2 = low.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>);
            result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'\\u'</span> + h1);
            result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'\\u'</span> + h2);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// ... 普通字符转换为 \uXXXX</span>
            <span class="hljs-keyword">let</span> h = code.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">4</span>, <span class="hljs-string">'0'</span>);
            result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'\\u'</span> + h);
        }
    }
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">join</span>(delimiter);
}
</code></pre>
<p>注意：使用 <code>for...of</code> 循环可以正确遍历字符串中的 Emoji 等宽字符，而普通的 <code>for(let i=0;...)</code> 则会把它们拆分成两个。</p>
<h4 data-id="heading-7">2.4 Punycode 转换</h4>
<p>Punycode 是国际化域名（IDN）使用的编码。本项目采用了一个巧妙的利用浏览器原生 API 的方法，避免引入庞大的第三方库：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">punycode</span>: {
    <span class="hljs-attr">encode</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">input</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 利用 URL API 自动进行 Punycode 编码</span>
            <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'http://'</span> + input);
            <span class="hljs-keyword">return</span> url.<span class="hljs-property">hostname</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^xn--/</span>, <span class="hljs-string">''</span>);
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// 降级处理...</span>
        }
    },
    <span class="hljs-attr">decode</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">input</span>) {
        <span class="hljs-comment">// 利用 URL API 自动解析</span>
        <span class="hljs-keyword">const</span> testUrl = <span class="hljs-string">'http://'</span> + input;
        <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(testUrl);
        <span class="hljs-keyword">return</span> url.<span class="hljs-property">hostname</span>;
    }
}
</code></pre>
<p>这是一个非常轻量且高效的实现方式。</p>
<h4 data-id="heading-8">2.5 HTML 实体</h4>
<p>HTML 实体的转换相对直接，主要将字符转换为其对应的十进制或十六进制引用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">textToHtmlDecimal</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">text, delimiter</span>) {
    <span class="hljs-keyword">let</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> char <span class="hljs-keyword">of</span> text) {
        <span class="hljs-keyword">let</span> code = char.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
        result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'&amp;#'</span> + code + <span class="hljs-string">';'</span>);
    }
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">join</span>(delimiter);
}
</code></pre>
<h3 data-id="heading-9">3. 字符详情分析</h3>
<p>工具还提供了一个 <code>getCharacterInfo</code> 函数，用于分析单个字符的详细信息。它不仅返回字符本身，还计算其 Unicode 码点、UTF-8 字节序列等。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCharacterInfo</span>(<span class="hljs-params">char</span>) {
    <span class="hljs-keyword">const</span> codePoint = char.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
    <span class="hljs-keyword">const</span> utf8Bytes = encoder.<span class="hljs-title function_">encode</span>(char);
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">char</span>: char,
        <span class="hljs-attr">codePoint</span>: codePoint, <span class="hljs-comment">// 数字形式</span>
        <span class="hljs-attr">hex</span>: codePoint.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toUpperCase</span>(), <span class="hljs-comment">// Hex 形式</span>
        <span class="hljs-attr">utf8</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(utf8Bytes) <span class="hljs-comment">// UTF-8 字节序列</span>
              .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toUpperCase</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>))
              .<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>)
    };
}
</code></pre>
<h3 data-id="heading-10">总结</h3>
<p>本项目的文本编码转换器通过充分利用 <code>TextEncoder</code>/<code>TextDecoder</code>、<code>URL</code> API 以及 ES6+ 的字符串处理特性（如 <code>codePointAt</code>、<code>for...of</code>），以原生 JavaScript 实现了高效、轻量的多格式转换，无需依赖任何重型第三方库。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NPM 脚本避坑指南：如何优雅地区分 postinstall 的“开发”与“安装”环境？]]></title>    <link>https://juejin.cn/post/7601007650722791465</link>    <guid>https://juejin.cn/post/7601007650722791465</guid>    <pubDate>2026-01-30T14:28:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601007650722791465" data-draft-id="7597058281434169398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NPM 脚本避坑指南：如何优雅地区分 postinstall 的“开发”与“安装”环境？"/> <meta itemprop="keywords" content="前端,Node.js,代码规范"/> <meta itemprop="datePublished" content="2026-01-30T14:28:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NPM 脚本避坑指南：如何优雅地区分 postinstall 的“开发”与“安装”环境？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T14:28:59.000Z" title="Fri Jan 30 2026 14:28:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前言</p>
</blockquote>
<p>你是否遇到过这样的尴尬：给包写了一个 <code>postinstall</code> 钩子去做自动构建（如编译 C++ 模块或生成协议文件），结果自己本地开发跑 <code>pnpm install</code> 时，它也跟着在那编译半天，甚至因为环境问题报错卡死？</p>
<p>区分“宿主开发”与“依赖安装”环境是每个包作者的必修课。本文将从环境变量到路径特征进行全方位拆解，带你由浅入深寻找最优解。</p>
<blockquote>
<p><strong>🚀 如果你现在正急着解决这个问题：</strong><br/>
请直接跳转到 <strong>方案三：特征路径扫描法</strong>。这是目前在独立包、Monorepo 以及跨平台场景下鲁棒性最强、最通用的解决方案。</p>
</blockquote>
<hr/>
<p>方案一：基础路径比对法（INIT_CWD）</p>
<p>这是最直观的方案，利用 npm/pnpm 注入的环境变量 <code>INIT_CWD</code>。</p>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// scripts/postinstall.js</span>
<span class="hljs-type">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-keyword">if</span> (process.env.INIT_CWD &amp;&amp; path.<span class="hljs-built_in">resolve</span>(process.env.INIT_CWD) === path.<span class="hljs-built_in">resolve</span>(process.<span class="hljs-built_in">cwd</span>())) {
  console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'宿主开发环境，跳过脚本'</span>);
  process.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</code></pre>
<p>请谨慎使用此类代码。</p>
<ul>
<li>
<p><strong>原理解析</strong>：<code>INIT_CWD</code> 是你敲下安装命令时的路径，<code>process.cwd()</code> 是脚本执行时的路径。在最简单的独立包开发中，这两个路径通常是一致的。</p>
</li>
<li>
<p><strong>局限性</strong>：</p>
<ul>
<li><strong>Monorepo 杀手</strong>：在 Monorepo 架构中，你在根目录运行 <code>pnpm i</code>，<code>INIT_CWD</code> 指向项目根目录，但子包脚本执行时 <code>cwd</code> 指向 <code>packages/xxx</code>，两者永远不相等，导致拦截失效。</li>
<li><strong>软链接风险</strong>：在某些 OS 或特定包管理器下，路径的大小写或物理链接解析可能不一致，导致比对失败。</li>
</ul>
</li>
</ul>
<hr/>
<p>方案二：配置标志位法（npm_config_*）</p>
<p>通过包管理器注入的环境变量来判断当前的安装行为。</p>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (process.env.npm_config_global) {
  <span class="hljs-comment">// 只有全局安装（-g）时执行</span>
}
</code></pre>
<p>请谨慎使用此类代码。</p>
<ul>
<li>
<p><strong>原理解析</strong>：利用包管理器在执行脚本时注入的 <code>npm_config_</code> 系列变量。</p>
</li>
<li>
<p><strong>局限性</strong>：</p>
<ul>
<li><strong>粒度太粗</strong>：它能区分“全局”还是“本地”，但无法区分“本地开发源码”还是“作为他人项目的项目依赖”。</li>
<li><strong>兼容性碎片化</strong>：npm、yarn、pnpm 对这些变量的注入规则在 2026 年依然存在细微差异。</li>
</ul>
</li>
</ul>
<hr/>
<p>方案三：特征路径扫描法（全场最佳）</p>
<p>这是目前健壮性最高、也是社区最推崇的方案。它的逻辑非常纯粹：<strong>检查当前脚本执行的物理路径中是否包含 <code>node_modules</code>。</strong></p>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-type">const</span> cwd = process.<span class="hljs-built_in">cwd</span>();

<span class="hljs-comment">// 核心逻辑：检查路径片段中是否包含标准的 node_modules 目录名</span>
<span class="hljs-type">const</span> isDependency = cwd.<span class="hljs-built_in">split</span>(path.sep).<span class="hljs-built_in">includes</span>(<span class="hljs-string">'node_modules'</span>);

<span class="hljs-keyword">if</span> (!isDependency) {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"🚀 检测到处于源码开发环境（独立包或 Monorepo），拦截 postinstall"</span>);
    process.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-comment">// 只有被别人 add 之后，你的包才会出现在 node_modules 里</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"📦 正在作为依赖安装，执行初始化逻辑..."</span>);
</code></pre>
<p>请谨慎使用此类代码。</p>
<ul>
<li>
<p><strong>为什么它既支持独立包又支持 Monorepo？</strong></p>
<ul>
<li><strong>独立包开发</strong>：你的路径是 <code>/User/dev/my-pkg</code>，不含 <code>node_modules</code>。拦截成功。</li>
<li><strong>Monorepo 开发</strong>：你的子包路径是 <code>/User/dev/repo/packages/my-pkg</code>，依然不含 <code>node_modules</code>。拦截成功。</li>
<li><strong>别人安装时</strong>：无论对方怎么配置，你的包一定会被放置在对方项目的某个 <code>node_modules</code> 目录下。路径必含该关键字。逻辑触发。</li>
</ul>
</li>
<li>
<p><strong>优势</strong>：完美规避了 <code>INIT_CWD</code> 在大仓中的路径偏移问题。</p>
</li>
</ul>
<hr/>
<p>方案四：2026 现代包管理器配置法（pnpm 视角）</p>
<p>如果你和你的用户群体主要使用 <strong>pnpm v10+</strong> ，除了代码层面的拦截，还可以利用 pnpm 的安全机制。</p>
<p>pnpm v10 默认会拦截未知的构建脚本。作为开发者，你可以在项目的 <code>.npmrc</code> 中通过 <code>only-built-dependencies</code> 显式控制。但为了给用户提供“开箱即用”的体验，在脚本内部通过 <strong>方案三</strong> 进行静默拦截依然是最佳实践。</p>
<hr/>
<p>总结：我该选哪种？</p>
<p>根据 2026 年的开发标准，建议在你的 <code>postinstall.js</code> 中使用以下终极兼容代码：</p>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-function">function <span class="hljs-title">shouldSkip</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-type">const</span> initCwd = process.env.INIT_CWD;
  <span class="hljs-type">const</span> cwd = process.<span class="hljs-built_in">cwd</span>();

  <span class="hljs-comment">// 1. 尝试 INIT_CWD 比对（覆盖 90% 简单场景）</span>
  <span class="hljs-keyword">if</span> (initCwd &amp;&amp; path.<span class="hljs-built_in">resolve</span>(initCwd) === path.<span class="hljs-built_in">resolve</span>(cwd)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 2. 特征路径扫描（覆盖 Monorepo 和 符号链接场景）</span>
  <span class="hljs-comment">// 只要路径里没出现 node_modules，就判定为是在自己家开发</span>
  <span class="hljs-keyword">if</span> (!cwd.<span class="hljs-built_in">split</span>(path.sep).<span class="hljs-built_in">includes</span>(<span class="hljs-string">'node_modules'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">if</span> (<span class="hljs-built_in">shouldSkip</span>()) {
  process.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-comment">// ... 执行真正的逻辑</span>
</code></pre>
<p>请谨慎使用此类代码。</p>
<p>写在最后</p>
<p>一个优秀的 NPM 包不仅要有强大的功能，还要有“不打扰”的自修养。通过简单的几行环境判断，你可以让你的包在开发阶段轻量如初，而在生产安装时稳如泰山。</p>
<p>如果你觉得这篇文章解决了你的燃眉之急，欢迎点赞收藏！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[比黄金暴跌更难过的是 Vue 3.6 构建工具全线换成 Rolldown 了😰]]></title>    <link>https://juejin.cn/post/7600989427906199606</link>    <guid>https://juejin.cn/post/7600989427906199606</guid>    <pubDate>2026-01-31T03:41:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600989427906199606" data-draft-id="7601028900886609966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="比黄金暴跌更难过的是 Vue 3.6 构建工具全线换成 Rolldown 了😰"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T03:41:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="VaJoy"/> <meta itemprop="url" content="https://juejin.cn/user/800100193674760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            比黄金暴跌更难过的是 Vue 3.6 构建工具全线换成 Rolldown 了😰
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/800100193674760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    VaJoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:41:32.000Z" title="Sat Jan 31 2026 03:41:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在尝试解析 Vue 3.6 的源码，前些天从底层构建系统着手，辛辛苦苦分析了 Vue 是如何通过 Rollup 和 esbuild 来分别构建出生产环境、开发环境产物的，并精心沉淀出了第一篇技术文章。</p>
<p>今天一看天塌了 ———— Vue 3.6 beta5 开始把全线构建工具统一为了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frolldown.rs%2F" target="_blank" title="https://rolldown.rs/" ref="nofollow noopener noreferrer">Rolldown</a>，所有构建相关的脚本均被改写，意味着我之前案牍劳形进行的分析、写的文章好像打了水漂。</p>
<p>这简直比黄金暴跌更让我心疼！！（因为我其实也没买）。</p>
<blockquote>
<p>官方改动具体见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fcommit%2F7da7615fb68c28433006f748100a99937133d809" target="_blank" title="https://github.com/vuejs/core/commit/7da7615fb68c28433006f748100a99937133d809" ref="nofollow noopener noreferrer">Commit - build: use rolldown</a>。</p>
</blockquote>
<p>Rolldown 目前处于 RC 预发布候选版本，所以没预料到 Vue 这么快就将其应用在源码构建上，盲猜其原因为：</p>
<ul>
<li>Rolldown 在 Vite 生态内部已经经历了较长时间的真实项目验证，官方团队对其成熟度相对有信心，得以进一步推进到 Vue 源码仓库中集成使用。</li>
<li>Rolldown 是使用 Rust 编写的现代化打包器，据称在性能上会比 Rollup 快 10～30 倍。</li>
<li>Rollup 的模块图主要面向「一次性构建」设计，缺乏面向长期运行进程的增量构建能力（这是之前为何要使用 esbuild 作为开发环境构建工具的原因）；而 Rolldown 把模块图视为长期驻留的一等公民，从架构层面支持精确失效与增量重建，得以适配开发态的高频变更场景。</li>
<li>开发环境和构建环境统一只使用一套「构建底座」，可以大幅提升构建配置和脚本的一致性，例如不同的需求（例如占位符替换）不再需要配套不同的构建插件，进而大幅降低维护成本。</li>
</ul>
<p>对此个人很欣赏 Vue 与时俱进的态度，也期待 3.6 正式版本能早日顺利发布。</p>
<p>最后贴下 Rollup 搭配 esbuild 的「老款」构建系统解析文章，还是可以帮助大家了解 Vue 项目底层构建的流程和原理。</p>
<hr/>
<p><em><strong>《Vue 3.6 beta 4 源码解析 —— 项目结构和构建雏形 Pt.1》</strong></em></p>
<blockquote>
<p>本文基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Ftree%2Fv3.6.0-beta.4" target="_blank" title="https://github.com/vuejs/core/tree/v3.6.0-beta.4" ref="nofollow noopener noreferrer">Vue 3.6 beta 4</a> 版本。</p>
<p>本文案例源码可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FVaJoy%2Fvue-3.6-source-analysis%2Ftree%2F1.1.1%2Fvue" target="_blank" title="https://github.com/VaJoy/vue-3.6-source-analysis/tree/1.1.1/vue" ref="nofollow noopener noreferrer">Github 仓库（Tag 1.1.1）</a> 上获取。</p>
</blockquote>
<p>Vue 3.6 的源码并不是一个单体项目，而是一个高度模块化、工程化的系统。在正式深入分析各个核心模块之前，如果不先理解其整体的项目结构与工程形态，很容易在阅读源码时陷入局部实现细节，而缺乏对整体设计与模块协作关系的把握。</p>
<p>作为本专栏的开篇，本文将从工程视角出发，介绍并讨论 Vue 3.6 的项目结构雏形与构建技术选型，并实现一个最基础的工程化方案。</p>
<h2 data-id="heading-0">1、项目初始化</h2>
<p>我们创建一个名为 <code>vue</code> 的文件夹作为源码项目，执行 <code>pnpm init</code> 进行初始化、生成 <code>package.json</code> 文件。</p>
<p>Vue 源码项目是严格要求使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Finstallation%23using-npm" target="_blank" title="https://pnpm.io/installation#using-npm" ref="nofollow noopener noreferrer">pnpm</a> 来作为包管理器的，我们可以在 <code>package.json</code> 的 <code>script</code> 字段添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.npmjs.com%2Fcli%2Fv8%2Fusing-npm%2Fscripts%23npm-ci" target="_blank" title="https://docs.npmjs.com/cli/v8/using-npm/scripts#npm-ci" ref="nofollow noopener noreferrer"><code>preinstall</code></a> 钩子指令，在使用者通过包管理器安装项目依赖时，能自动检查并确保项目只能使用 pnpm 作为包管理器：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"3.6.0"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"preinstall"</span>: <span class="hljs-string">"npx only-allow pnpm"</span>    <span class="hljs-comment">// 确保项目只能使用 pnpm 作为包管理器</span>
  },
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"MIT"</span>
}
</code></pre>
<p>其中 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpnpm%2Fonly-allow" target="_blank" title="https://github.com/pnpm/only-allow" ref="nofollow noopener noreferrer">only-allow</a> 是 pnpm 官方提供的一个检测工具，可以检测当前项目是否使用了指定的包管理器（若不符合条件会<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpnpm%2Fonly-allow%2Fblob%2Fmaster%2Fbin.js%23L24" target="_blank" title="https://github.com/pnpm/only-allow/blob/master/bin.js#L24" ref="nofollow noopener noreferrer">报错并强行退出程序</a>）。</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.npmjs.com%2Fcli%2Fv8%2Fusing-npm%2Fscripts%23npm-ci" target="_blank" title="https://docs.npmjs.com/cli/v8/using-npm/scripts#npm-ci" ref="nofollow noopener noreferrer"><code>preinstall</code></a> 钩子中，我们通过 <code>npx only-allow pnpm</code> 来确保项目只能使用 pnpm 作为包管理器。</p>
<blockquote>
<p>💡 Vue 是基于 Monorepo 架构来维护各模块的，而 pnpm 对 Monorepo 有很好的支持，我们会在后文了解到这一点。</p>
</blockquote>
<h2 data-id="heading-1">2、Monorepo</h2>
<h3 id="user-content-md-monorepo" data-id="heading-2">2.1 Vue 中的 Monorepo</h3>
<p>在业务项目中，我们可以通过 <code>npm install vue</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fquick-start.html%23creating-a-vue-application" target="_blank" title="https://vuejs.org/guide/quick-start.html#creating-a-vue-application" ref="nofollow noopener noreferrer">等方式</a>来下载和使用 Vue，不过 Vue 除了这个覆盖完整功能的 npm 包，还提供了多个独立的核心子模块包，每个包都有其特定的功能和作用：</p>
<ul>
<li><code>@vue/shared</code>：Vue 3 中被各模块共享的工具函数模块。</li>
<li><code>@vue/reactivity</code>：Vue 3 的响应式模块。</li>
<li><code>@vue/compiler-core</code>：Vue 3 的模板编译核心模块。</li>
<li><code>@vue/compiler-dom</code>：Vue 3 的 DOM 编译模块。</li>
<li><code>@vue/runtime-core</code>：Vue 3 的运行时核心模块。</li>
<li>...</li>
</ul>
<p>例如你可以在业务项目中独立下载 Vue 的响应式模块 <code>@vue/reactivity</code>：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @vue/reactivity
</code></pre>
<p>并在项目中使用它：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/reactivity'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">'hi'</span> })
</code></pre>
<p>此举仅会下载 <code>@vue/reactivity</code> 模块（及其依赖模块）的代码，而不会下载 Vue 的所有模块。</p>
<p>然而 Vue 并没有给每个核心子模块都独立创建一个 Git 仓库，而是将它们统一放在 Vue 源码项目的 <code>packages</code> 文件夹下进行维护：</p>
<pre><code class="hljs language-js" lang="js">vue
├── packages
│   ├── shared
│   ├── reactivity
│   ├── compiler-core
│   ├── compiler-dom
│   ├── runtime-core
│   ├── ...
</code></pre>
<p>此类「单仓库多模块」的架构形式，被称为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMonorepo" target="_blank" title="https://en.wikipedia.org/wiki/Monorepo" ref="nofollow noopener noreferrer">Monorepo</a> 。</p>
<h3 data-id="heading-3">2.2 以 <code>shared</code> 为例的模块结构</h3>
<p>以「共享工具函数模块」<code>shared</code> 为例，其目录结构 <code>packages/shared</code> 非常简练：</p>
<pre><code class="hljs language-js" lang="js">vue
├── packages
│   ├── shared
│   │   ├── src           <span class="hljs-comment">// 存放实际源码</span>
│   │   │   ├── general.<span class="hljs-property">ts</span>
│   │   │   ├── makeMap.<span class="hljs-property">ts</span>
│   │   │   ├── ...
│   │   │   └── index.<span class="hljs-property">ts</span>
│   │   ├── package.<span class="hljs-property">json</span>  <span class="hljs-comment">// npm 包配置</span>
│   │   └── index.<span class="hljs-property">ts</span>      <span class="hljs-comment">// 包入口</span>
</code></pre>
<h4 data-id="heading-4">src 文件夹</h4>
<p><code>shared/src</code> 文件夹用于存放 <code>shared</code> 模块实际的源码文件，源码文件会按功能维度拆分成多个子模块。</p>
<p>简单起见，我们目前只实现 <code>shared/src/general.ts</code> 和 <code>shared/src/makeMap.ts</code> 两个功能子模块，它们的代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** shared/src/makeMap.ts **/</span>

<span class="hljs-comment">/**
 * 把一个用逗号分隔的字符串（例如 "a,b,c" ）预处理成一个“成员判断函数”，
 * 用于在运行时高频地判断某个 key 是否属于某个固定集合。
 * 
 * 示例：
 * const isHTMLTag = makeMap('div,span,p')
 * isHTMLTag('div') // true
 * isHTMLTag('a')   // false
 */</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">makeMap</span>(<span class="hljs-params">str: string</span>): <span class="hljs-function">(<span class="hljs-params">key: string</span>) =&gt;</span> boolean {
  <span class="hljs-keyword">const</span> map = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> str.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)) map[key] = <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val <span class="hljs-keyword">in</span> map
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** shared/src/general.ts **/</span>

<span class="hljs-keyword">import</span> { makeMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'./makeMap'</span>

<span class="hljs-comment">/** 空对象 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">EMPTY_OBJ</span>: { readonly [<span class="hljs-attr">key</span>: string]: any } = {}

<span class="hljs-comment">/** 空数组 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">EMPTY_ARR</span>: readonly never[] = []

<span class="hljs-comment">/** 空函数 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">NOOP</span> = (): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {}

<span class="hljs-comment">/** 生成一个方法，用于判断一个属性名是否是保留属性 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">isReservedProp</span>: <span class="hljs-function">(<span class="hljs-params">key: string</span>) =&gt;</span> boolean = <span class="hljs-comment">/*@__PURE__*/</span> <span class="hljs-title function_">makeMap</span>(
  <span class="hljs-string">',key,ref,ref_for,ref_key,'</span> +
    <span class="hljs-string">'onVnodeBeforeMount,onVnodeMounted,'</span> +
    <span class="hljs-string">'onVnodeBeforeUpdate,onVnodeUpdated,'</span> +
    <span class="hljs-string">'onVnodeBeforeUnmount,onVnodeUnmounted'</span>,
)
</code></pre>
<p>接着我们在模块的内部出口文件 <code>shared/src/index.ts</code> 中，导出所有功能子模块（目前仅 <code>general</code> 和 <code>makeMap</code>）的接口：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** shared/src/index.ts **/</span>

<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./general'</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./makeMap'</span>
</code></pre>
<p>后续仅需引用该出口文件，就能通过「一拖多」的形式间接引入 <code>shared</code> 模块的全部功能接口。</p>
<h4 id="user-content-md-dist" data-id="heading-5">待构建的 dist 文件夹</h4>
<p>作为一个被多运行时、多构建环境复用的基础工具模块，通常需要提供多种构建格式（例如 ESM、CJS 等），以适配不同的加载方式与运行场景。</p>
<p>对于 <code>shared</code> 模块而言，其职责是为 Vue 各核心包提供最基础、最通用的工具能力，因此需要将 <code>shared/src</code> 下的源码构建为多种产出物，以覆盖以下几类典型使用场景：</p>
<ul>
<li>
<p><strong>开发环境下的 CommonJS 引用</strong></p>
<p>即通过 <code>require('@vue/shared')</code> 引入 <code>shared</code> 模块，且运行于开发环境（<code>process.env.NODE_ENV === 'development'</code>）的场景，需确保所引用的 <code>shared</code> 模块产出物为 CommonJS 版本，且包含用于开发期的调试逻辑（如 warning、assert 等）。</p>
<p>我们拟定该产出物名为 <code>shared.cjs.js</code>。</p>
</li>
<li>
<p><strong>生产环境下的 CommonJS 引用</strong></p>
<p>即同样通过 <code>require('@vue/shared')</code> 引入 <code>shared</code> 模块，但运行于生产环境的场景，需确保所引用的 <code>shared</code> 模块产出物为 CommonJS 版本，且剔除了所有用于开发期的调试逻辑（确保最终代码体积最小）。</p>
<p>我们拟定该产出物名为 <code>shared.cjs.prod.js</code>。</p>
</li>
<li>
<p><strong>ESM 引用（Bundler 场景）</strong></p>
<p>即通过 <code>import</code> 引入 <code>shared</code> 模块的场景，需确保所引用的 <code>shared</code> 模块产出物为 ESM bundler 版本。</p>
<p>我们拟定该产出物名为 <code>shared.esm-bundler.js</code>。</p>
<blockquote>
<p>💡 与 CommonJS 不同，ESM 版本并不会拆分出「开发环境」和「生产环境」两套文件。</p>
<p>💡 这得益于 ESM 的静态导入特性，Vue 框架使用者在业务侧进行二次构建的过程中，构建工具可在编译期将环境变量替换为常量，并通过 Tree-shaking / Dead Code Elimination 精确移除不可达的环境逻辑，从而保证最终生产代码中不存在任何冗余分支。</p>
</blockquote>
</li>
</ul>
<p>在后文我们会通过构建工具，将 <code>shared/src</code> 的源文件构建出适配上述三个场景的产出物，并创建 <code>shared/dist</code> 文件夹来存放这些产物。</p>
<p>另外我们也将为 <code>shared</code> 模块构建其 TypeScript 声明文件 <code>shared/dist/shared.d.ts</code>，用于在 TypeScript 项目中提供类型检查与智能提示。</p>
<h4 data-id="heading-6">npm 包入口文件</h4>
<p><code>shared/index.ts</code> 是 <code>shared</code> 模块的包入口文件，在下文将介绍的 <code>shared/package.json</code> 中会通过 <code>main</code> 字段指定该文件为 CommonJS 生态下的传统入口。</p>
<p>其内容为根据当前的运行环境，引入对应的 CommonJS 版本构建产物：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dist/shared.cjs.prod.js'</span>)
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dist/shared.cjs.js'</span>)
}
</code></pre>
<p>留意在这类 CommonJS 入口文件中，Vue 都对它们启用了严格模式（<code>'use strict'</code>），这是为了确保代码能及时暴露一些潜在的问题（例如使用未声明的变量），并提升代码的质量和可维护性。</p>
<blockquote>
<p>💡 严格模式在 ESM 里是默认开启的，因此 ESM 模块里无需标记 <code>'use strict'</code>。</p>
</blockquote>
<h4 data-id="heading-7">npm 包配置文件</h4>
<p><code>shared/package.json</code> 是 <code>shared</code> 模块的 npm 包配置文件，其职责不只是提供「npm 发布描述」，还包含了工程化相关的配置信息：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** shared/package.json **/</span>

{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@vue/shared"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"3.6.0"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>,                     <span class="hljs-comment">// 指定 CommonJS 生态下的传统入口，主要用于 不支持 exports 的旧 NodeJS / 工具链</span>
  <span class="hljs-string">"module"</span>: <span class="hljs-string">"dist/shared.esm-bundler.js"</span>, <span class="hljs-comment">// 指定 ESM bundler 生态下的入口</span>
  <span class="hljs-string">"types"</span>: <span class="hljs-string">"dist/shared.d.ts"</span>,            <span class="hljs-comment">// 指定类型声明文件</span>
  <span class="hljs-string">"files"</span>: [                              <span class="hljs-comment">// 指定了在发布到 npm 时，哪些文件会被包含在发布包中（避免将 src、测试代码、构建脚本等无关内容发布到 npm）</span>
    <span class="hljs-string">"index.js"</span>,
    <span class="hljs-string">"dist"</span>
  ],
  <span class="hljs-string">"exports"</span>: {                            <span class="hljs-comment">// 更为完善的新规范入口配置字段</span>
    <span class="hljs-string">"."</span>: {
      <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/shared.d.ts"</span>,                 <span class="hljs-comment">// 指定类型声明文件</span>
      <span class="hljs-string">"node"</span>: {                                      <span class="hljs-comment">// 传统 NodeJS（CommonJS），开发环境和生产环境对应的入口</span>
        <span class="hljs-string">"production"</span>: <span class="hljs-string">"./dist/shared.cjs.prod.js"</span>,
        <span class="hljs-string">"development"</span>: <span class="hljs-string">"./dist/shared.cjs.js"</span>,
        <span class="hljs-string">"default"</span>: <span class="hljs-string">"./index.js"</span>
      },
      <span class="hljs-string">"module"</span>: <span class="hljs-string">"./dist/shared.esm-bundler.js"</span>,      <span class="hljs-comment">// ESM bundler 入口（用于部分构建工具识别）</span>
      <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/shared.esm-bundler.js"</span>,      <span class="hljs-comment">// ESM bundler 入口（用于 NodeJS 侧识别）</span>
      <span class="hljs-string">"require"</span>: <span class="hljs-string">"./index.js"</span>                        <span class="hljs-comment">// 传统 CommonJS 默认入口（兜底）</span>
    },
    <span class="hljs-string">"./*"</span>: <span class="hljs-string">"./*"</span>                                     <span class="hljs-comment">// 指定可访问的子路径映射</span>
  },
  <span class="hljs-string">"sideEffects"</span>: <span class="hljs-literal">false</span>          <span class="hljs-comment">// 声明该包在模块【初始化阶段】不存在副作用，当模块的导出未被使用时，整个模块可被剔除（Tree-shaking）</span>
  }
}
</code></pre>
<p>其中 <code>main</code>、<code>module</code> 和 <code>types</code> 三个字段是为了兼容旧生态所保留的约定式入口，<code>exports</code> 则是更为完善的新规范字段（可以指定更细粒度的入口映射），现代 NodeJS 或构建工具会优先采用 <code>exports</code> 字段指定的入口。</p>
<h3 data-id="heading-8">2.3 Monorepo 模块之间的联系</h3>
<h4 data-id="heading-9">新建 reactivity 模块</h4>
<p>为了更好地了解 Monorepo 下各独立模块之间的联系，我们仿照 <code>shared</code> 模块的结构，在 <code>packages</code> 下创建一个名为 <code>reactivity</code> 的响应式模块：</p>
<pre><code class="hljs language-js" lang="js">vue
├── packages
│   ├── reactivity        <span class="hljs-comment">// 新增响应式模块文件夹</span>
│   │   ├── src           <span class="hljs-comment">// 存放实际源码</span>
│   │   │   ├── reactive.<span class="hljs-property">ts</span>
│   │   │   └── index.<span class="hljs-property">ts</span>
│   │   ├── package.<span class="hljs-property">json</span>  <span class="hljs-comment">// npm 包配置</span>
│   │   └── index.<span class="hljs-property">ts</span>      <span class="hljs-comment">// 包入口</span>
</code></pre>
<blockquote>
<p><code>reactivity</code> 下各文件的内容和 <code>shared</code> 的基本一致。</p>
</blockquote>
<p>目前我们仅打算搭建一个项目雏形，因此 <code>reactivity</code> 模块的内容尽量简单化，其中 <code>src/reactive.ts</code> 的代码仅用来模拟 <code>shared</code> 模块接口的引入和导出：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** src/reactive.ts **/</span>

<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/shared'</span>  <span class="hljs-comment">// 仅用于调试</span>
</code></pre>
<p>此时你会看到 IDE 中会标红报错，提示 TypeScript 找不到 <code>@vue/shared</code> 模块：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6e3e463f9e347dea39da1e52b0bfc36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmFKb3k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770436218&amp;x-signature=A6WS3Dn6RhQ7NH%2BhI%2BRA452vKOo%3D" alt="p1.png" loading="lazy"/></p>
<p>我们可以在 <code>vue</code> 根目录下新增 <code>tsconfig.json</code> 文件，用于配置 TypeScript 的编译选项：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"strict"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"rootDir"</span>: <span class="hljs-string">"."</span>,
    <span class="hljs-string">"paths"</span>: {                            <span class="hljs-comment">// IDE 类型检查路径</span>
      <span class="hljs-string">"@vue/*"</span>: [<span class="hljs-string">"./packages/*/src"</span>],     <span class="hljs-comment">// 把 @vue/xxx 映射到 packages/xxx/src 下</span>
      <span class="hljs-string">"*"</span>: [<span class="hljs-string">"./*"</span>]
    }
  },
  <span class="hljs-string">"include"</span>: [
    <span class="hljs-string">"packages/*/src"</span>,
  ]
}
</code></pre>
<p>此时 <code>src/reactive.ts</code> 中不再标红报错，IDE 的 TypeScript 类型检查功能已可成功识别到 <code>@vue/shared</code> 模块。</p>
<h4 data-id="heading-10">pnpm 的 <code>workspace</code> 协议</h4>
<p>如同<a href="#md-monorepo" title="#md-monorepo">「2.1 Vue 中的 Monorepo」</a>所提及的，<code>@vue/reactivity</code> 需要被独立发布到 npm 上（供开发者下载），我们需要为其声明对 <code>@vue/shared</code> npm 包的依赖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** reactivity/package.json **/</span>

{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@vue/reactivity"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"3.6.0"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-string">"module"</span>: <span class="hljs-string">"dist/reactivity.esm-bundler.js"</span>,
  <span class="hljs-comment">// 略...（和 shared/package.json 基本一致）</span>

  <span class="hljs-string">"dependencies"</span>: {                 <span class="hljs-comment">// 补充对 shared 模块的依赖信息</span>
    <span class="hljs-string">"@vue/shared"</span>: <span class="hljs-string">"3.6.0"</span>
  }
}
</code></pre>
<p>然而这里所填入的 <code>@vue/shared</code> 版本号 <code>3.6.0</code> 存在一个问题 —— 该远程版本的内容并非我们本地上最新的 <code>packages/shared</code> 下的内容，且每次发布 npm 包之前都需要手动更新该依赖包的版本号，一旦遗漏就会出错。</p>
<p>pnpm 官方提供了一个解决方案，即使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fworkspaces" target="_blank" title="https://pnpm.io/workspaces" ref="nofollow noopener noreferrer"><code>workspace</code> 协议</a>来替换依赖包的版本号，它表示该依赖必须解析自当前 Monorepo 中声明的 workspace 包，而不会从远程 npm registry 下载：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** reactivity/package.json **/</span>

  <span class="hljs-string">"dependencies"</span>: {      
    <span class="hljs-string">"@vue/shared"</span>: <span class="hljs-string">"workspace:*"</span>     <span class="hljs-comment">// 更替为 workspace 协议</span>
  }
</code></pre>
<p>另外，我们还需在 <code>vue</code> 根目录下新增 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fpnpm-workspace_yaml" target="_blank" title="https://pnpm.io/pnpm-workspace_yaml" ref="nofollow noopener noreferrer"><code>pnpm-workspace.yaml</code> 文件</a>，用于告知 pnpm「哪些文件夹可以作为独立的 workspace」：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** pnpm-workspace.yaml **/</span>

<span class="hljs-attr">packages</span>:
  - <span class="hljs-string">"packages/*"</span>  <span class="hljs-comment">// 把 packages 文件夹里的每一个一级子目录，都当作一个独立的 workspace 包</span>
</code></pre>
<p>pnpm 在执行时会扫描 <code>pnpm-workspace.yaml</code> 中所配置的目录，并将其中包含 <code>package.json</code> 的子目录注册为 workspace 成员，后续在解析 <code>workspace:*</code> 时，会从这些 workspace 成员中进行检索和匹配。</p>
<p>在经过这番配置后，通过 <code>pnpm publish</code> 指令来发布 <code>@vue/reactivity</code> 包时，pnpm 会把将要提交到 npm registry 的 manifest 中的 <code>@vue/shared</code> 依赖包版本号，填写为本地对应 workspace 成员 <code>packages.json</code>（即 <code>packages/shared/package.json</code>）中的版本号。</p>
<h2 data-id="heading-11">3、构建系统雏形</h2>
<p>在理解了 Vue 3.6 的 Monorepo 结构与包之间的依赖关系之后，下一步就是要实现一个基础的构建系统，将分散在 <code>packages/*/src</code> 目录下的源码，构建出<a href="#md-dist" title="#md-dist">预期的各版本</a>并放置在 <code>packages/*/dist</code> 中）。</p>
<h3 data-id="heading-12">3.1 技术选型</h3>
<p>Vue 使用了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2F" target="_blank" title="https://rollupjs.org/" ref="nofollow noopener noreferrer">Rollup</a> 作为「生产构建器」，开发态的快速构建则采用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fesbuild.github.io%2F" target="_blank" title="https://esbuild.github.io/" ref="nofollow noopener noreferrer">esbuild</a>。</p>
<h4 data-id="heading-13">生产构建选择 Rollup 的原因</h4>
<p>Rollup 自诞生以来就是为了打包 JavaScript 库而设计的：</p>
<ul>
<li><strong>Tree-shaking 的极致优化</strong> —— Rollup 基于 ES Modules (ESM)，它能生成非常「扁平」的输出代码，进而确保冗余代码能被精确裁剪、输出内容足够干净。</li>
<li><strong>作用域提升（Scope Hoisting）</strong> —— Rollup 默认会将所有模块提升到同一个作用域内，这不仅进一步减小了代码体积，还能提高执行性能。</li>
<li><strong>多格式输出支持</strong> —— Rollup 的插件系统和配置机制，可以高效地构建出 Vue 的多版本产物：
<ul>
<li><code>esm-bundler</code> (给 Vite / Webpack 用)；</li>
<li><code>esm-browser</code> (给浏览器 <code>&lt;script type="module"&gt;</code> 用)；</li>
<li><code>cjs</code> (CommonJS 语法，给 NodeJS 环境用)；</li>
<li><code>global</code> (传统的 <code>&lt;script&gt;</code> 引入) 。</li>
</ul>
</li>
</ul>
<p>最重要的是，Vue 需要被构建为一个「通用的前端框架库」，而不是被构建为一个「Web 应用」，因此需要尽可能地保证输出代码的可阅读性。相比 Webpack 会在每个模块周围包裹大量的 <code>__webpack_require__</code> 等运行时代码，Rollup 输出的代码更加「原汁原味」、易于使用者阅读和调试。</p>
<h4 data-id="heading-14">开发构建选择 esbuild 的原因</h4>
<p>虽然 Rollup 产物精美，但在速度上它并不是最快的。</p>
<p>在开发、调试场景中，我们对于构建速度的需求要远高于极致性能的需求，而 esbuild 非常契合这一场景：</p>
<ul>
<li><strong>极速的增量构建</strong> —— esbuild 采用了基于 Go 语言的编译后端，编译速度非常快，能够在毫秒级完成增量构建，适合频繁改动源码、快速看效果的 watch 开发。</li>
<li><strong>简单的配置</strong> —— esbuild 的配置选项非常简单，无需复杂的插件系统即可实现基本的构建需求。</li>
</ul>
<p>因此，虽然 esbuild 的输出代码不够完美（例如 Tree-Shaking 没有 Rollup 极致），但非常适用于在开发场景中用于响应迅速的「粗加工」。</p>
<blockquote>
<p>💡 读者需注意区分各类构建面向的主体对象 —— Vue 源码项目的「生产构建」是面向 Vue 框架使用者的，因此「生产构建」的产物包括了使用者在其<strong>生产环境</strong>中使用的产物，也包括了使用者在其<strong>开发环境</strong>中使用的产物；而 Vue 源码项目的「开发构建」只面向 Vue 源码开发者（与使用者无关）。</p>
</blockquote>
<h3 data-id="heading-15">3.2 <code>shared</code> 模块的生产构建方案实现</h3>
<h4 data-id="heading-16"><code>rollup.config.js</code> 配置</h4>
<p>Vue 是通过拼接 Rollup 的命令行指令来执行生产构建的，我们可以按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2Fcommand-line-interface%2F" target="_blank" title="https://rollupjs.org/command-line-interface/" ref="nofollow noopener noreferrer">Rollup 官方文档</a>，先在项目根目录创建一个 <code>rollup.config.js</code> 配置文件，用于告诉 Rollup 在执行指令时「如何打包一个 package」。</p>
<p>以「构建一个 <code>packages/shared/dist/shared.cjs.js</code> 为例」，其配置内容参考如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** rollup.config.js */</span>

<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
<span class="hljs-keyword">import</span> esbuild <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-esbuild'</span>

<span class="hljs-keyword">const</span> __dirname = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'.'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">const</span> packageConfigs = [{
  <span class="hljs-attr">input</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/src/index.ts'</span>),

  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 插件</span>
    <span class="hljs-title function_">esbuild</span>({       <span class="hljs-comment">// TypeScript / JS 语法转译</span>
      <span class="hljs-attr">tsconfig</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'tsconfig.json'</span>),
      <span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">target</span>: <span class="hljs-string">'es2016'</span>,
    }),
  ],

  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">file</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/dist/shared.cjs.js'</span>),
    <span class="hljs-attr">format</span>: <span class="hljs-string">"cjs"</span>,
  },
  <span class="hljs-attr">treeshake</span>: {
			<span class="hljs-attr">moduleSideEffects</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 声明模块无副作用，允许 Rollup 安全地进行 Tree-Shaking</span>
	},
}];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> packageConfigs
</code></pre>
<p>留意这里我们使用了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fegoist%2Frollup-plugin-esbuild" target="_blank" title="https://github.com/egoist/rollup-plugin-esbuild" ref="nofollow noopener noreferrer"><code>rollup-plugin-esbuild</code></a> 插件，这是因为 Rollup 本身是无法识别 TypeScript 语法的，因此需要利用 esbuild 来充当「语法翻译官」，把 TypeScript 代码转译为 JavaScript 代码。</p>
<blockquote>
<p>💡 esbuild 在开发模式中充当了构建器 + bundler + runner 的角色，但在本小节的生产构建中被降级为一个编译器插件。</p>
<p>💡 读者请自行安装 <code>rollup</code>、<code>typescript</code>、<code>rollup-plugin-esbuild</code> 等 npm 依赖包，本系列文章不会提及依赖包的安装。</p>
</blockquote>
<p>此时执行 <code>rollup -c</code> 即可构建出 <code>packages/shared/dist/shared.cjs.js</code> 文件。</p>
<p>然而除了 <code>cjs</code> 格式的文件，还要为 <code>shared</code> 模块构建 <code>esm-bundler</code> 格式的文件，这需要往 <code>packageConfigs</code> 数组中 push 多个配置项，我们可以封装一个 <code>createConfig</code> 方法来创建配置项：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** rollup.config.js */</span>

<span class="hljs-comment">// 略...</span>

<span class="hljs-keyword">const</span> outputConfigs = {
  <span class="hljs-string">'esm-bundler'</span>: {
    <span class="hljs-attr">file</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/dist/shared.esm-bundler.js'</span>),
    <span class="hljs-attr">format</span>: <span class="hljs-string">'es'</span>,
  },
  <span class="hljs-string">'cjs'</span>: {
    <span class="hljs-attr">file</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/dist/shared.cjs.js'</span>),
    <span class="hljs-attr">format</span>: <span class="hljs-string">'cjs'</span>,
  },
}

<span class="hljs-keyword">const</span> packageFormats = [<span class="hljs-string">'esm-bundler'</span>, <span class="hljs-string">'cjs'</span>]

<span class="hljs-keyword">const</span> packageConfigs = packageFormats.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">format</span> =&gt;</span> <span class="hljs-title function_">createConfig</span>(format, outputConfigs[format]))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> packageConfigs

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createConfig</span>(<span class="hljs-params">format, output, plugins = []</span>) {
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在创建 <span class="hljs-subst">${format}</span> 格式的构建配置...`</span>)

	<span class="hljs-keyword">return</span> {
		<span class="hljs-attr">input</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/src/index.ts'</span>),
		<span class="hljs-attr">plugins</span>: [   
			<span class="hljs-title function_">esbuild</span>({  
				<span class="hljs-attr">tsconfig</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'tsconfig.json'</span>),
				<span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
				<span class="hljs-attr">target</span>: <span class="hljs-string">'es2016'</span>,
			}),
			...plugins    <span class="hljs-comment">// 支持扩展自定义插件</span>
		],
		output,
    <span class="hljs-attr">treeshake</span>: {
			<span class="hljs-attr">moduleSideEffects</span>: <span class="hljs-literal">false</span>,
		},
	}
}
</code></pre>
<p>此时执行 <code>rollup -c</code> 可构建出 <code>packages/shared/dist/shared.cjs.js</code> 和 <code>packages/shared/dist/shared.esm-bundler.js</code> 文件。</p>
<h4 data-id="heading-17">利用 <code>NODE_ENV</code> 和 <code>PROD_ONLY</code> 参数指定产出物环境</h4>
<p>根据<a href="#md-dist" title="#md-dist">「待构建的 dist 文件夹」</a>小节所罗列的构建产物，我们还需为 <code>shared</code> 模块构建一个 CommonJS 格式的<strong>生产环境</strong>产物 <code>shared.cjs.prod.js</code>。</p>
<p>另外，Vue 属于一个多模块、复杂度较高的项目，会有「按需构建」的需求，用于节省构建的等待时间。例如开发者会希望通过执行不同的 Rollup 的指令来满足如下三种场景：</p>
<ul>
<li>构建所有生产环境和开发环境的产物；</li>
<li>只构建生产环境的产物；</li>
<li>只构建开发环境的产物。</li>
</ul>
<p>我们可以通过 Rollup 执行指令中的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.rollupjs.org%2Fcommand-line-interface%2F%23environment-values" target="_blank" title="https://cn.rollupjs.org/command-line-interface/#environment-values" ref="nofollow noopener noreferrer"><code>environment</code> 参数</a>来传值处理：</p>
<ul>
<li>执行 <code>rollup -c --environment NODE_ENV:production</code> 时构建出所有生产环境和开发环境的产物；</li>
<li>执行 <code>rollup -c --environment NODE_ENV:production,PROD_ONLY:true</code> 时只构建生产环境的产物；</li>
<li>执行 <code>rollup -c --environment NODE_ENV:development</code> 时只构建开发环境的产物。</li>
</ul>
<p>这里我们自定义了两个参数 <code>NODE_ENV</code> 和 <code>PROD_ONLY</code>，分别用于指定「构建目标环境」和「是否只构建生产环境的产物」，我们可以在 <code>rollup.config.js</code> 中通过 <code>process.env</code> 来读取传入的自定义参数值，并做相应的逻辑处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** rollup.config.js */</span>

<span class="hljs-comment">// 略...</span>
<span class="hljs-keyword">const</span> packageFormats = [<span class="hljs-string">'esm-bundler'</span>, <span class="hljs-string">'cjs'</span>]

<span class="hljs-comment">// 通过 process.env 获取传入的 PROD_ONLY 参数</span>
<span class="hljs-keyword">const</span> packageConfigs = process.<span class="hljs-property">env</span>.<span class="hljs-property">PROD_ONLY</span> ? [] : packageFormats.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">format</span> =&gt;</span> <span class="hljs-title function_">createConfig</span>(format, outputConfigs[format]))

<span class="hljs-comment">// 若需要构建生产环境产物，针对 cjs 格式，添加其生产环境的配置项</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {    <span class="hljs-comment">// 通过 process.env 获取传入的 NODE_ENV 参数</span>
  packageFormats.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">format</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (format === <span class="hljs-string">'cjs'</span>) {
      packageConfigs.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createProductionConfig</span>(format))
    }
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> packageConfigs

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createConfig</span>(<span class="hljs-params">format, output, plugins = []</span>) {
	<span class="hljs-keyword">const</span> isProductionBuild = <span class="hljs-regexp">/\.prod\.js$/</span>.<span class="hljs-title function_">test</span>(output.<span class="hljs-property">file</span>)
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在创建<span class="hljs-subst">${isProductionBuild ? <span class="hljs-string">'生产环境'</span> : <span class="hljs-string">'开发环境'</span>}</span> <span class="hljs-subst">${format}</span> 格式的构建配置...`</span>)

	<span class="hljs-keyword">return</span> {
		<span class="hljs-comment">// 略...</span>
	}
}

<span class="hljs-comment">// 创建生产环境配置项</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createProductionConfig</span>(<span class="hljs-params">format</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createConfig</span>(format, {
    ...outputConfigs[format],
    <span class="hljs-attr">file</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/dist/shared.cjs.prod.js'</span>),  <span class="hljs-comment">// 构建 cjs.prod.js 文件</span>
  })
}
</code></pre>
<p>此时执行 <code>rollup -c --environment NODE_ENV:production,PROD_ONLY:true</code>，会单独构建出 <code>packages/shared/dist/shared.cjs.prod.js</code> 文件。</p>
<h4 data-id="heading-18">开发环境占位符 <code>__DEV__</code> 及其替换</h4>
<p>查看前文所构建出的 <code>shared.cjs.js</code> 和 <code>shared.cjs.prod.js</code> 文件，会发现它们的内容是完全相同的，读者可能会因此感到困惑。</p>
<p>为了便于区分不同环境产物的内容（而不仅仅是文件名不同），我们修改 <code>packages/shared/src/general.ts</code> 的代码，加上一个自定义的开发环境占位符 <code>__DEV__</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/** packages/shared/src/general.ts */</span>

<span class="hljs-comment">/** 空对象 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">EMPTY_OBJ</span>: { <span class="hljs-keyword">readonly</span> [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> } = __DEV__
  ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>({})
  : {}

<span class="hljs-comment">/** 空数组 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">EMPTY_ARR</span>: <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">never</span>[] = __DEV__ ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>([]) : []
</code></pre>
<p>此举目的是让 Vue 框架使用者在开发环境中，通过 <code>Object.freeze</code> 来避免改动到 Vue 源码内置的空对象和空数组两个常量，在生产环境时则改为使用性能最优的空对象和空数组即可。</p>
<blockquote>
<p>IDE 在此时会对 <code>__DEV__</code> 进行标红，提示「找不到名称__DEV__」，我们可以在 <code>packages</code> 下创建一个 <code>global.d.ts</code> 文件，用于声明这些自定义的变量：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Global compile-time constants</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">var</span> <span class="hljs-attr">__DEV__</span>: <span class="hljs-built_in">boolean</span>
</code></pre>
</blockquote>
<p>接着我们在 <code>rollup.config.js</code> 中，通过 <code>rollup-plugin-esbuild</code> 插件的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fesbuild.github.io%2Fapi%2F%23define" target="_blank" title="https://esbuild.github.io/api/#define" ref="nofollow noopener noreferrer"><code>define</code></a> 属性，对 <code>__DEV__</code> 占位符进行替换：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** rollup.config.js */</span>

<span class="hljs-comment">// 略...</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createConfig</span>(<span class="hljs-params">format, output, plugins = []</span>) {
	<span class="hljs-keyword">const</span> isProductionBuild = <span class="hljs-regexp">/\.prod\.js$/</span>.<span class="hljs-title function_">test</span>(output.<span class="hljs-property">file</span>)
  <span class="hljs-keyword">const</span> isBundlerESMBuild = <span class="hljs-regexp">/esm-bundler/</span>.<span class="hljs-title function_">test</span>(format)      <span class="hljs-comment">// 是否为 ESM Bundler 格式的构建</span>
	<span class="hljs-comment">// 略...</span>

	<span class="hljs-keyword">return</span> {
		<span class="hljs-attr">input</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/src/index.ts'</span>),
		<span class="hljs-attr">plugins</span>: [  
			...<span class="hljs-title function_">resolveReplace</span>(),
			<span class="hljs-title function_">esbuild</span>({  
				<span class="hljs-attr">tsconfig</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'tsconfig.json'</span>),
				<span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
				<span class="hljs-attr">target</span>: <span class="hljs-string">'es2016'</span>,
				<span class="hljs-attr">define</span>: <span class="hljs-title function_">resolveDefine</span>(),    <span class="hljs-comment">// 替换自定义占位符</span>
			}),
			...plugins
		],
		<span class="hljs-comment">// 略...</span>
	}

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveDefine</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> replacements = {}

    <span class="hljs-keyword">if</span> (isBundlerESMBuild) {
      replacements.<span class="hljs-property">__DEV__</span> = <span class="hljs-string">`!!(process.env.NODE_ENV !== 'production')`</span>
    } <span class="hljs-keyword">else</span> {
      replacements.<span class="hljs-property">__DEV__</span> = <span class="hljs-title class_">String</span>(!isProductionBuild)
    }

    <span class="hljs-keyword">return</span> replacements
  }
}
</code></pre>
<p>留意在新增的 <code>resolveDefine</code> 方法中，是否处于 ESM Bundler 格式的构建会影响占位符 <code>__DEV__</code> 的替换内容：</p>
<ul>
<li>ESM Bundler 格式的构建产物会把 <code>__DEV__</code> 占位符替换为 <code>!!(process.env.NODE_ENV !== 'production')</code>，因为该产物是会交由业务侧去执行二次构建的，由业务侧的构建工具再进一步去替换 <code>process.env.NODE_ENV</code> 即可；</li>
<li>非 ESM Bundler 格式的构建产物属于「最终运行时代码」，不会经历二次构建，因此要把 <code>__DEV__</code> 占位符根据构建环境替换为明确的 <code>true</code> 或 <code>false</code>，esbuild 插件会在构建过程通过 Tree-Shaking 移除未命中的逻辑分支，确保产物简洁且可以直接运行。</li>
</ul>
<p>然而此时执行 <code>rollup -c --environment NODE_ENV:production</code> 指令，会出现报错：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- [!] (plugin esbuild) Error: Transform failed with 1 error:</span>
<span class="hljs-deletion">- error: Invalid define value (must be an entity name or JS literal): !!(process.env.NODE_ENV !== 'production')</span>
</code></pre>
<p>这是因为 esbuild 的 <code>define</code> 对替换内容具有严格的要求，其仅用于将全局标识符替换为<strong>静态常量</strong>，它要求替换的内容必须是布尔值、数字、字符串，或者是另一个标识符，但不能是 <code>!!(process.env.NODE_ENV !== 'production')</code> 这样的表达式语句。</p>
<blockquote>
<p>esbuild 会试图把自定义的 Key 替换成一个合法的 AST 节点，当要替换的值是一个复杂的表达式时，esbuild 解析器无法将其作为一个单一的「值」或「标识符」插入到 AST 中，因此会直接抛出 <code>Invalid define value</code> 错误来阻止构建。</p>
</blockquote>
<p>针对此问题，我们可以在 ESM Bundler 场景改为使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Freplace" target="_blank" title="https://github.com/rollup/plugins/tree/master/packages/replace" ref="nofollow noopener noreferrer"><code>@rollup/plugin-replace</code></a> 插件来进行占位符替换：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** rollup.config.js */</span>

<span class="hljs-keyword">import</span> replace <span class="hljs-keyword">from</span> <span class="hljs-string">'@rollup/plugin-replace'</span>
<span class="hljs-comment">// 略...</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createConfig</span>(<span class="hljs-params">format, output, plugins = []</span>) {
	<span class="hljs-comment">// 略...</span>

	<span class="hljs-keyword">return</span> {
		<span class="hljs-attr">input</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./packages/shared/src/index.ts'</span>),
		<span class="hljs-attr">plugins</span>: [         
			...<span class="hljs-title function_">resolveReplace</span>(),     <span class="hljs-comment">// 使用 @rollup/plugin-replace 插件</span>
			<span class="hljs-title function_">esbuild</span>({
				<span class="hljs-attr">tsconfig</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'tsconfig.json'</span>),
				<span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
				<span class="hljs-attr">target</span>: <span class="hljs-string">'es2016'</span>,
				<span class="hljs-attr">define</span>: <span class="hljs-title function_">resolveDefine</span>(),
			}),
			...plugins
		],
		<span class="hljs-comment">// 略...</span>
	}

	<span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveDefine</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">const</span> replacements = {}

		<span class="hljs-keyword">if</span> (!isBundlerESMBuild) {
			replacements.<span class="hljs-property">__DEV__</span> = <span class="hljs-title class_">String</span>(!isProductionBuild)
		}

		<span class="hljs-keyword">return</span> replacements
	}

	<span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveReplace</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">const</span> replacements = {}

    <span class="hljs-comment">// ESM Bundler 格式的构建产物使用 @rollup/plugin-replace 来替换占位符</span>
		<span class="hljs-keyword">if</span> (isBundlerESMBuild) {
			<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(replacements, {
				<span class="hljs-attr">__DEV__</span>: <span class="hljs-string">`!!(process.env.NODE_ENV !== 'production')`</span>,
			})
		}

		<span class="hljs-keyword">return</span> [<span class="hljs-title function_">replace</span>({ 
      <span class="hljs-attr">values</span>: replacements, 
      <span class="hljs-attr">preventAssignment</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 若变量出现在赋值号（ = ）的左边，就不要进行替换。目的是防止把赋值语句当成常量替换（例如 __DEV__ = true）</span>
    })]
	}
}
</code></pre>
<p>此时执行 <code>rollup -c --environment NODE_ENV:production</code> 指令，构建出的所有 <code>shared</code> 模块产物内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** packages/shared/dist/shared.cjs.js */</span>
<span class="hljs-meta">
'use strict'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EMPTY_OBJ</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>({}) ;
<span class="hljs-comment">// 略...</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">EMPTY_OBJ</span> = <span class="hljs-variable constant_">EMPTY_OBJ</span>;
<span class="hljs-comment">// 略...</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** packages/shared/dist/shared.cjs.prod.js */</span>
<span class="hljs-meta">
'use strict'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EMPTY_OBJ</span> = {};
<span class="hljs-comment">// 略...</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">EMPTY_OBJ</span> = <span class="hljs-variable constant_">EMPTY_OBJ</span>;
<span class="hljs-comment">// 略...</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** packages/shared/dist/shared.esm-bundler.js */</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EMPTY_OBJ</span> = !!(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">"production"</span>) ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>({}) : {};
<span class="hljs-comment">// 略...</span>

<span class="hljs-keyword">export</span> { 
  <span class="hljs-variable constant_">EMPTY_OBJ</span>, 
  <span class="hljs-comment">// 略... </span>
}
</code></pre>
<blockquote>
<p>我们会在下篇文章为构建系统补充 <code>reactivity</code> 等其它模块的构建能力。</p>
</blockquote>
<h3 data-id="heading-19">3.3 <code>shared</code> 模块的开发构建方案实现</h3>
<p>我们已经在前文了解过，Vue 源码项目只通过 esbuild 来负责开发调试时的构建，我们在 Vue 源码项目的根目录创建 <code>./scripts/dev.js</code> 文件来配置 esbuild：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> esbuild <span class="hljs-keyword">from</span> <span class="hljs-string">'esbuild'</span>
<span class="hljs-keyword">import</span> { dirname, relative, resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>
<span class="hljs-keyword">import</span> { parseArgs } <span class="hljs-keyword">from</span> <span class="hljs-string">'util'</span>

<span class="hljs-keyword">const</span> __dirname = <span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))

<span class="hljs-keyword">const</span> {
    <span class="hljs-attr">values</span>: { <span class="hljs-attr">format</span>: rawFormat, prod, },
} = <span class="hljs-title function_">parseArgs</span>({
    <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">format</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
            <span class="hljs-attr">short</span>: <span class="hljs-string">'f'</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-string">'cjs'</span>,
        },
        <span class="hljs-attr">prod</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'boolean'</span>,
            <span class="hljs-attr">short</span>: <span class="hljs-string">'p'</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
        },
    },
})

<span class="hljs-keyword">const</span> format = rawFormat || <span class="hljs-string">'cjs'</span>
<span class="hljs-keyword">const</span> outputFormat = format === <span class="hljs-string">'cjs'</span> ? <span class="hljs-string">'cjs'</span> : <span class="hljs-string">'esm'</span>

<span class="hljs-keyword">const</span> pkgBasePath = <span class="hljs-string">`../packages/shared`</span>
<span class="hljs-keyword">const</span> outfile = <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">`<span class="hljs-subst">${pkgBasePath}</span>/dist/shared.<span class="hljs-subst">${format}</span>.<span class="hljs-subst">${prod ? <span class="hljs-string">`prod.`</span> : <span class="hljs-string">``</span>}</span>js`</span>)

<span class="hljs-keyword">const</span> relativeOutfile = <span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), outfile)


<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">Array&lt;import('esbuild').Plugin&gt;</span>} */</span>
<span class="hljs-keyword">const</span> plugins = [
    {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'log-rebuild'</span>,    <span class="hljs-comment">// 在构建完成时，打印构建完成的文件路径</span>
        <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
            build.<span class="hljs-title function_">onEnd</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`built: <span class="hljs-subst">${relativeOutfile}</span>`</span>)
            })
        },
    },
]

<span class="hljs-keyword">const</span> entry = <span class="hljs-string">'index.ts'</span>

esbuild
    .<span class="hljs-title function_">context</span>({
        <span class="hljs-attr">entryPoints</span>: [<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">`<span class="hljs-subst">${pkgBasePath}</span>/src/<span class="hljs-subst">${entry}</span>`</span>)],
        outfile,
        <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">format</span>: outputFormat,
        <span class="hljs-attr">platform</span>: format === <span class="hljs-string">'cjs'</span> ? <span class="hljs-string">'node'</span> : <span class="hljs-string">'browser'</span>,
        plugins,
        <span class="hljs-attr">define</span>: {
            <span class="hljs-attr">__DEV__</span>: prod ? <span class="hljs-string">`false`</span> : <span class="hljs-string">`true`</span>,
        },
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> ctx.<span class="hljs-title function_">watch</span>())    <span class="hljs-comment">// 监听源码变化并执行实时增量构建</span>
</code></pre>
<p>其中我们使用了 NodeJS <code>util</code> 原生模块的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Futil.html%23utilparseargsconfig" target="_blank" title="https://nodejs.org/api/util.html#utilparseargsconfig" ref="nofollow noopener noreferrer"><code>parseArgs</code></a> 来解析命令行参数，例如：</p>
<pre><code class="hljs language-bash" lang="bash">node scripts/dev.js -f esm-bundler
</code></pre>
<p>当执行该指令时，<code>parseArgs</code> 会捕获传入的 <code>f</code> 参数并将其值（<code>esm-bundler</code>）赋给 <code>rawFormat</code> 变量。</p>
<p>最后我们调用了 esbuild 的 <code>context</code> 方法来自定义配置并执行构建。以上述的指令为例，esbuild 会直接构建出 <code>packages/shared/dist/shared.esm-bundler.js</code> 文件，且实时监听 <code>shared</code> 模块的源码变化并执行增量构建。</p>
<blockquote>
<p>💡 Vue 源码在开发调试环节，需要通过 esbuild 构建的场景其实不多（在开发后期可以创建一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2F" target="_blank" title="https://vite.dev/" ref="nofollow noopener noreferrer">vite</a> 项目来配合调试），开发的前期更多还是通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvitest.dev%2F" target="_blank" title="https://vitest.dev/" ref="nofollow noopener noreferrer">vitest</a> 对模块源码进行单元测试。我们会在后续的文章中进行了解。</p>
</blockquote>
<p>补充：鉴于 Vue 3.6 beta 5 已全线替换构建工具，本文「后续的文章」也只能跟着断更。后续可能以 Vue 官方最新版的项目重新进行源码解析和输出解析文章。共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 Composition API 完全指南]]></title>    <link>https://juejin.cn/post/7600982613653930034</link>    <guid>https://juejin.cn/post/7600982613653930034</guid>    <pubDate>2026-01-30T14:39:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613653930034" data-draft-id="7600990891218812937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 Composition API 完全指南"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-30T14:39:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="好名字_技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1101056944119610"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 Composition API 完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1101056944119610/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    好名字_技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T14:39:12.000Z" title="Fri Jan 30 2026 14:39:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 3 Composition API 完全指南</h2>
<p>Vue 3 的 Composition API 是一个重大的改进，它提供了更好的代码组织和复用性。</p>
<h3 data-id="heading-1">什么是 Composition API？</h3>
<p>Composition API 是一种基于函数的 API，允许我们<strong>按功能组织代码</strong>，而不是按选项。</p>
<h3 data-id="heading-2">基本用法</h3>
<h4 data-id="heading-3">setup() 函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> })

    <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      count.<span class="hljs-property">value</span>++
    }

    <span class="hljs-keyword">return</span> { count, user, doubleCount, increment }
  }
}
</code></pre>
<h4 data-id="heading-4"><code>&lt;script setup&gt;</code> 语法糖</h4>
<p>Vue 3.2 引入了 <code>&lt;script setup&gt;</code>，让代码更简洁：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, computed } from 'vue'

const count = ref(0)
const doubleCount = computed(() =&gt; count.value * 2)

function increment() {
  count.value++
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;{{ count }} × 2 = {{ doubleCount }}&lt;/div&gt;
  &lt;button @click="increment"&gt;+1&lt;/button&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-5">核心 API</h3>
<h4 data-id="heading-6">1. ref 和 reactive</h4>
<ul>
<li><code>ref()</code>：用于基本类型</li>
<li><code>reactive()</code>：用于对象</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)         <span class="hljs-comment">// 基本类型</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({    <span class="hljs-comment">// 对象</span>
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-number">3</span>
})
</code></pre>
<h4 data-id="heading-7">2. computed</h4>
<p>计算属性，具有缓存特性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> firstName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'张'</span>)
<span class="hljs-keyword">const</span> lastName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'三'</span>)

<span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> firstName.<span class="hljs-property">value</span> + lastName.<span class="hljs-property">value</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
    [firstName.<span class="hljs-property">value</span>, lastName.<span class="hljs-property">value</span>] = value.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>)
  }
})
</code></pre>
<h4 data-id="heading-8">3. watch 和 watchEffect</h4>
<ul>
<li><code>watch</code>：监听特定源</li>
<li><code>watchEffect</code>：自动追踪依赖</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// watch：指定监听源</span>
<span class="hljs-title function_">watch</span>(count, <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count 变化: <span class="hljs-subst">${oldVal}</span> → <span class="hljs-subst">${newVal}</span>`</span>)
})

<span class="hljs-comment">// watchEffect：自动追踪</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前 count: <span class="hljs-subst">${count.value}</span>`</span>)
})
</code></pre>
<h3 data-id="heading-9">生命周期</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件已挂载'</span>)
})

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件已卸载'</span>)
})
</code></pre>
<h3 data-id="heading-10">自定义 Composables</h3>
<p>这是 Composition API 最强大的特性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useCounter.js</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue)

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count.<span class="hljs-property">value</span>++ }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) { count.<span class="hljs-property">value</span>-- }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) { count.<span class="hljs-property">value</span> = initialValue }

  <span class="hljs-keyword">return</span> { count, increment, decrement, reset }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useCounter'</span>

<span class="hljs-keyword">const</span> { count, increment, decrement, reset } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">10</span>)
</code></pre>
<h3 data-id="heading-11">优势总结</h3>
<p>✅ <strong>更好的代码组织</strong>：按功能逻辑分组
✅ <strong>更简洁的类型推断</strong>：更好的 TypeScript 支持
✅ <strong>更强的复用性</strong>：通过 composables 共享逻辑
✅ <strong>更灵活的树摇</strong>：未使用的代码可以被优化掉</p>
<h3 data-id="heading-12">总结</h3>
<p>Composition API 是 Vue 3 的未来，它让代码：</p>
<ul>
<li>更清晰</li>
<li>更易维护</li>
<li>更易测试</li>
<li>更易复用</li>
</ul>
<p>如果你还在使用 Options API，是时候尝试 Composition API 了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web文件下载 : 从PDF预览Bug到Hook架构演进]]></title>    <link>https://juejin.cn/post/7600982613653946418</link>    <guid>https://juejin.cn/post/7600982613653946418</guid>    <pubDate>2026-01-30T14:54:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613653946418" data-draft-id="7601028900885938222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web文件下载 : 从PDF预览Bug到Hook架构演进"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T14:54:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="im_AMBER"/> <meta itemprop="url" content="https://juejin.cn/user/370979729333004"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web文件下载 : 从PDF预览Bug到Hook架构演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/370979729333004/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    im_AMBER
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T14:54:54.000Z" title="Fri Jan 30 2026 14:54:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 AY。</p>
<p>在 Web 开发中，下载功能看似简单，却隐藏着浏览器行为差异与跨域安全限制的陷阱。</p>
<p>今天，我原本只想做一个导出不同文件格式的功能，却遇到了一个bug：<strong>生成Word或MD文件时，Chrome浏览器都会正常弹出下载框，但导出PDF文件时却不行——PDF会直接在当前页面预览，看起来明明是要下载PDF，结果却直接进入了预览模式，而且我原本打开的页面还被这个预览页面覆盖了。</strong></p>
<h2 data-id="heading-0">一、为什么 PDF 会“不请自来”地预览？</h2>
<h4 data-id="heading-1">1.浏览器的 MIME 类型策略</h4>
<p>浏览器如何处理一个 URL，取决于服务器返回的 <strong>MIME 类型（Multipurpose Internet Mail Extensions）</strong> 。</p>
<ul>
<li><strong>Word/MD 文件</strong>：由于 Chrome 等浏览器没有内置渲染引擎，它会识别为“不可直接读取的内容”，从而触发下载。</li>
<li><strong>PDF 文件</strong>：现代浏览器均内置了功能强大的 PDF 渲染器。当它接收到 <code>application/pdf</code> 类型时，默认行为是 <strong>“当前窗口导航（Navigation）”</strong> 。</li>
</ul>
<h4 data-id="heading-2">2. 被忽略的 <code>download</code> 属性</h4>
<p>我们通常尝试通过 <code>&lt;a download&gt;</code> 标签强制下载，但它受到 <strong>同源策略（Same-Origin Policy）</strong> 的严格限制：</p>
<ul>
<li><strong>同源请求</strong>：<code>download</code> 属性正常工作，强制下载。</li>
<li><strong>跨域请求</strong>：如果资源来自不同的域名/端口，浏览器出于安全考虑会 <strong>无视 <code>download</code> 属性</strong>，将其降级为一个普通链接，导致 PDF 直接在当前页打开。</li>
</ul>
<h2 data-id="heading-3">二、Blob 对象与 Object URL</h2>
<p>为了绕过跨域下载限制并防止原页面丢失，最稳健的方案是利用 <strong>Blob (Binary Large Object)</strong> 。</p>
<h4 data-id="heading-4">1. 内存中的“影子文件”</h4>
<p>通过 <code>fetch</code> 请求将远程文件拉取到内存中转换为 <code>Blob</code>，我们可以利用 <code>URL.createObjectURL(blob)</code> 生成一个临时的 <code>blob:</code> 协议链接。</p>
<blockquote>
<p><strong>MDN 定义 - URL.createObjectURL()：</strong></p>
<p>该方法创建一个 <code>DOMString</code>。该 URL 的生命周期与其创建时的 <code>document</code> 绑定。</p>
</blockquote>
<h4 data-id="heading-5">2. 为什么 Blob 能解决问题？</h4>
<ul>
<li><strong>伪装同源</strong>：生成的 <code>blob://</code> 链接与当前页面拥有相同的 Origin，这使得 <code>download</code> 属性 100% 被浏览器尊重。</li>
<li><strong>生命周期管理</strong>：虽然 URL 与 DOM 树绑定，但它仅仅是指向内存的指针。通过手动创建 <code>a</code> 标签并设置 <code>target="_blank"</code> 或触发 <code>.click()</code>，我们可以精确控制它是静默下载还是新窗口预览。</li>
</ul>
<h2 data-id="heading-6">三、架构升级：自定义 Hook 的解耦艺术</h2>
<p>在复杂的业务逻辑中，我原本将文件获取、Blob 转换、动态创建 DOM 节点等代码堆积在 <code>index.tsx</code> 中会导致维护灾难。</p>
<h4 data-id="heading-7">1. 逻辑抽离的必要性</h4>
<ul>
<li><strong>关注点分离</strong>：UI 组件只负责“展示”，而下载的繁琐逻辑应该交给专门的逻辑单元。</li>
<li><strong>复用性</strong>：自定义 Hook 可以让下载逻辑在全站不同页面间自由导入。</li>
</ul>
<h4 data-id="heading-8">2. 最佳实践代码实现</h4>
<p>我们将这一过程封装为 <code>useDownload</code> Hook，实现一处定义，随处调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">/**
 * 自定义下载 Hook
 * 封装了从获取流到触发 DOM 点击的全过程
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useDownload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDownload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileUrl: <span class="hljs-built_in">string</span>, fileName: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 获取资源并转化为二进制 Blob</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(fileUrl);
      <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">blob</span>();

      <span class="hljs-comment">// 2. 生成内存 URL</span>
      <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob);

      <span class="hljs-comment">// 3. 动态注入 a 标签触发下载</span>
      <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);
      link.<span class="hljs-property">href</span> = url;
      link.<span class="hljs-property">download</span> = fileName; <span class="hljs-comment">// 此时同源，download 属性生效</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link);
      link.<span class="hljs-title function_">click</span>();

      <span class="hljs-comment">// 4. 清理现场</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(link);
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">revokeObjectURL</span>(url); <span class="hljs-comment">// 必须释放内存，防止溢出</span>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"下载失败"</span>, e);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">return</span> { handleDownload, loading };
};
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-9">🌟 总结</h3>
<p>一个 PDF 跳转的小 Bug，我补充了一些Web API 的学习，本质上是浏览器安全策略与渲染机制的综合体现。</p>
<ol>
<li><strong>明确边界</strong>：知道 <code>download</code> 属性何时失效，比盲目调试代码更重要。</li>
<li><strong>生命周期意识</strong>：在使用 <code>createObjectURL</code> 时，必须养成配套使用 <code>revokeObjectURL</code> 的习惯。</li>
<li><strong>架构思维</strong>：即便是一个“很小的 Bug”，也值得通过 <strong>自定义 Hook</strong> 进行架构级的封装，从而实现从“业务实现”到“工程设计”的跨越。</li>
</ol>
<h3 data-id="heading-10"> 参考文献：</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fa" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/a" target="_blank" ref="nofollow noopener noreferrer"/><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">: The Anchor element - HTML | MDN</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fa" title="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/a" target="_blank" ref="nofollow noopener noreferrer"/><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">：锚元素 - HTML（超文本标记语言） | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reportlab.com%2Fdocs%2Freportlab-userguide.pdf" title="https://www.reportlab.com/docs/reportlab-userguide.pdf" target="_blank" ref="nofollow noopener noreferrer">reportlab.com/docs/report…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Fsynchronizing-with-effects" title="https://zh-hans.react.dev/learn/synchronizing-with-effects" target="_blank" ref="nofollow noopener noreferrer">使用 Effect 进行同步 – React 中文文档</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fa" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/a" target="_blank" ref="nofollow noopener noreferrer"/><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">: The Anchor element - HTML | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FURL%2FcreateObjectURL_static" title="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL_static" target="_blank" ref="nofollow noopener noreferrer">URL：createObjectURL() 静态方法 - Web API | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FDocument" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Document" target="_blank" ref="nofollow noopener noreferrer">Document - Web API | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFile" title="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" ref="nofollow noopener noreferrer">File - Web API | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBlob" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" ref="nofollow noopener noreferrer">Blob - Web API | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FMediaSource" title="https://developer.mozilla.org/zh-CN/docs/Web/API/MediaSource" target="_blank" ref="nofollow noopener noreferrer">MediaSource - Web API | MDN</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Freusing-logic-with-custom-hooks" title="https://zh-hans.react.dev/learn/reusing-logic-with-custom-hooks" target="_blank" ref="nofollow noopener noreferrer">使用自定义 Hook 复用逻辑 – React 中文文档</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FSecurity%2FDefenses%2FSame-origin_policy" title="https://developer.mozilla.org/zh-CN/docs/Web/Security/Defenses/Same-origin_policy" target="_blank" ref="nofollow noopener noreferrer">浏览器的同源策略 - 安全 | MDN</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Wujie微前端]]></title>    <link>https://juejin.cn/post/7601007650722922537</link>    <guid>https://juejin.cn/post/7601007650722922537</guid>    <pubDate>2026-01-30T15:15:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601007650722922537" data-draft-id="7600219080046231595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Wujie微前端"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T15:15:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细心细心再细心"/> <meta itemprop="url" content="https://juejin.cn/user/721738373803879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Wujie微前端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/721738373803879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细心细心再细心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:15:38.000Z" title="Fri Jan 30 2026 15:15:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">wujie使用</h2>
<p>基座应用是“容器”，负责加载和展示子应用。</p>
<p>假设你用 <strong>Vue3</strong> 作为基座（最常见），配置超级简单。</p>
<h5 data-id="heading-1">1. 创建一个普通的 Vue3 项目（如果你没有）</h5>
<p>用 Vue CLI 或 Vite 创建：</p>
<p>text</p>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> vue<span class="hljs-variable">@latest</span>
# 或者 vite：npm <span class="hljs-keyword">create</span> vite<span class="hljs-variable">@latest</span>
</code></pre>
<p>选 Vue + TypeScript 或 JS 都行，随便。</p>
<h5 data-id="heading-2">2. 安装 Wujie 的 Vue3 包</h5>
<p>在你的基座项目里运行：</p>
<p>text</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> wujie-vue3 -S
</code></pre>
<h5 data-id="heading-3">3. 在 main.js（或 main.ts）里引入并注册</h5>
<p>打开 src/main.js，加上这些代码：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>  <span class="hljs-comment">// 如果你有路由</span>

<span class="hljs-comment">// 引入 WujieVue</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie-vue3'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 注册 WujieVue 插件</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">WujieVue</span>)

<span class="hljs-comment">// 如果有路由</span>
app.<span class="hljs-title function_">use</span>(router)

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h5 data-id="heading-4">4. 在页面里使用<code>wujie-vue</code>组件加载子应用</h5>
<p>打开一个页面组件，比如 src/views/Home.vue 或 App.vue，写一个容器：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>这是基座应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 这里放子应用，width 和 height 自己调 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">wujie-vue</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">"800px"</span>
      <span class="hljs-attr">name</span>=<span class="hljs-string">"唯一名字"</span>        &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">随便取</span>，<span class="hljs-attr">但要唯一</span>，<span class="hljs-attr">比如</span> "<span class="hljs-attr">vue3-app</span>" <span class="hljs-attr">--</span>&gt;</span>
      url="子应用的地址"     <span class="hljs-comment">&lt;!-- 子应用的线上地址或本地地址，比如 http://localhost:3000 --&gt;</span>
      :sync="true"            <span class="hljs-comment">&lt;!-- 可选：路由同步，推荐开 --&gt;</span>
      :fetch="自定义fetch"    <span class="hljs-comment">&lt;!-- 可选：如果子应用有跨域问题，可以自定义fetch --&gt;</span>
      :props="{ token: '123' }"  <span class="hljs-comment">&lt;!-- 可选：给子应用传数据 --&gt;</span>
      :beforeLoad="beforeLoad"  <span class="hljs-comment">&lt;!-- 可选：生命周期钩子 --&gt;</span>
      :beforeMount="beforeMount"
      :afterMount="afterMount"
    &gt;<span class="hljs-tag">&lt;/<span class="hljs-name">wujie-vue</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 可选：生命周期钩子函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">beforeLoad</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用开始加载'</span>)
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">beforeMount</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用即将挂载'</span>)
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">afterMount</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用挂载完成'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>关键参数解释（小白必看）：</strong></p>
<ul>
<li>name：子应用的唯一名字，不能重复。</li>
<li>url：子应用的入口地址（必须是完整的 http:// 或 https://）。</li>
<li>sync：true 表示路由同步（子应用路由变了，浏览器地址栏也会变）。</li>
<li>props：可以给子应用传数据，子应用里用 window.$wujie.props 拿。</li>
</ul>
<h5 data-id="heading-5">5. 预加载（推荐，加速切换）</h5>
<p>在基座的入口文件（比如 App.vue 的 mounted）里预加载：</p>
<p>JavaScript</p>
<pre><code class="hljs language-php" lang="php">import { preloadApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie-vue3'</span>

<span class="hljs-title function_ invoke__">preloadApp</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'唯一名字'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-string">'子应用地址'</span>
})
</code></pre>
<h5 data-id="heading-6">6. 启动基座</h5>
<p>text</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run dev
</code></pre>
<p>打开页面，你就会看到子应用嵌进来了！</p>
<h4 data-id="heading-7">第三步：子应用怎么配置（最友好的是零改造！）</h4>
<p>子应用就是你原来的普通项目（Vue、React、Vite 等）。</p>
<p><strong>超级好消息：用“保活模式”或“重建模式”，子应用完全不用改代码！</strong></p>
<h5 data-id="heading-8">推荐方式：保活模式（keep-alive，最丝滑，无白屏）</h5>
<p>在基座的  组件上加一个属性：</p>
<p>vue</p>
<pre><code class="hljs language-ini" lang="ini">&lt;wujie-vue
  ...
  <span class="hljs-attr">alive</span>=<span class="hljs-string">"true"</span>   &lt;!-- 就是这一行！开启保活 --&gt;
&gt;&lt;/wujie-vue&gt;
</code></pre>
<p>完了！子应用零改造，切换回来不会重新加载，超级快。</p>
<h5 data-id="heading-9">如果你想用单例模式（多个地方共用同一个实例，需要改造一点）</h5>
<p>只在子应用的入口文件（main.js 或 index.js）里包一层判断：</p>
<p><strong>Vue3 示例（vite 项目）</strong> ： 在 main.js 最外面包起来：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss">let instance

if (window.__POWERED_BY_WUJIE__) {
  <span class="hljs-comment">// 被 Wujie 加载时的生命周期</span>
  window<span class="hljs-selector-class">.__WUJIE_MOUNT</span> = () =&gt; {
    instance = <span class="hljs-built_in">createApp</span>(App)<span class="hljs-selector-class">.use</span>(router)<span class="hljs-selector-class">.mount</span>('#app')
  }
  window<span class="hljs-selector-class">.__WUJIE_UNMOUNT</span> = () =&gt; {
    instance<span class="hljs-selector-class">.unmount</span>()
  }
  <span class="hljs-comment">// 如果是 Vite 构建的，需要主动触发</span>
  window<span class="hljs-selector-class">.__WUJIE</span><span class="hljs-selector-class">.mount</span>()
} else {
  <span class="hljs-comment">// 独立运行时</span>
  <span class="hljs-built_in">createApp</span>(App)<span class="hljs-selector-class">.use</span>(router)<span class="hljs-selector-class">.mount</span>('#app')
}
</code></pre>
<p>其他框架（React、Vue2）文档里都有示例，基本就是把 mount 和 unmount 挂到 window 上。</p>
<p><strong>强烈建议小白先用保活模式</strong>，完全不用改子应用。</p>
<h3 data-id="heading-10">单例模式VS保活模式</h3>
<h4 data-id="heading-11">保活模式</h4>
<p>什么是保活模式？想象子应用是一个“玩具房子”；</p>
<ul>
<li>正常情况，你离开房间（切换页面），房子就被拆掉（卸载），回来需要重新搭（重新加载，有白屏）</li>
<li>保活模式，房子一直留在原地不拆（保持活着），你回来直接玩（零白屏，状态完全保留，比如输入框的内容还在）</li>
<li>优点：
<ul>
<li>配置最简单</li>
<li>零改造子应用</li>
<li>切换最快、无白屏</li>
</ul>
</li>
<li>缺点：
如果基座多个地方加载同一个子应用，状态不共享（每个是独立的“房子”）</li>
<li>适合场景：导航菜单切换子应用，Tab页切换，大多数项目都先用这个</li>
</ul>
<h4 data-id="heading-12">单例模式</h4>
<p>什么是单例模式？
全局只有一个房子！不管你在几个房间放几个门（多个容器加载同一个子应用），开门进门的都是同一个房子（共享同一个实例和状态）。
怎么配置：
* 基座不用特殊配置（可以结合alive=true一起使用）
* 关键： 子应用需要改造代码（手动控制挂载和卸载）
子应用改造示例（Vue3+Vite项目为例，在main.js或main.ts最外面包一层）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-keyword">let</span> instance = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 全局只有一个 instance</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!instance) {
    instance = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
    instance.<span class="hljs-title function_">use</span>(router)
    instance.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)  <span class="hljs-comment">// 挂载到容器</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (instance) {
    instance.<span class="hljs-title function_">unmount</span>()
    instance = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 可选：销毁实例</span>
  }
}

<span class="hljs-comment">// 被 Wujie 加载时（微前端模式）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_WUJIE__</span>) {
  <span class="hljs-comment">// 挂到 window 上，Wujie 会自动调用</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE_MOUNT</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">mount</span>()
  }
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE_UNMOUNT</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">unmount</span>()
  }
  
  <span class="hljs-comment">// Vite 项目需要主动触发一次（有些构建工具需要）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE</span>.<span class="hljs-property">mount</span>?.()
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 独立运行时（直接 npm run dev）</span>
  <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
}
</code></pre>
<ul>
<li>单例模式特点：
<ul>
<li>全局只有一个子应用实例</li>
<li>多个地方加载同一个url的子应用，共享状态（比如登录用户信息全局共享）</li>
<li>切换时可以不重建（如果结合保活）</li>
<li>需要改在子应用（__WUJIE_MOUNT和__WUJIE_UNMOUNT）</li>
</ul>
</li>
<li>优点：
<ul>
<li>状态全局共享（适合需要单点登录、共享用户数据等）</li>
<li>内存占用更少（只有一个实例）</li>
</ul>
</li>
<li>缺点：
<ul>
<li>需要改造子应用代码</li>
<li>如果不结合保活，切换可能有轻微重建</li>
</ul>
</li>
<li>适合场景： 子应用需要在基座多个位置出现，但状态一致（比如全局共享的侧边栏，头部组件）</li>
<li>最强组合：单例模式+保活模式一起用！</li>
</ul>
<h4 data-id="heading-13">第四步：常见问题注意事项（小白必看）</h4>
<ol>
<li><strong>跨域问题</strong>：子应用的地址必须和基座同域，或者子应用服务器开 CORS（允许跨域）。本地开发时，两个项目用不同端口，就要开代理或用 nginx。</li>
<li><strong>子应用地址</strong>：本地开发时，子应用先单独跑起来（npm run dev），拿到 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3Axxxx%25EF%25BC%258C%25E7%2584%25B6%25E5%2590%258E%25E5%25A1%25AB%25E5%2588%25B0%25E5%259F%25BA%25E5%25BA%25A7%25E7%259A%2584" target="_blank" title="http://localhost:xxxx%EF%BC%8C%E7%84%B6%E5%90%8E%E5%A1%AB%E5%88%B0%E5%9F%BA%E5%BA%A7%E7%9A%84" ref="nofollow noopener noreferrer">http://localhost:xxxx，然后填到基座的</a> url。</li>
<li><strong>样式隔离</strong>：Wujie 天生隔离好，子应用样式不会污染基座。</li>
<li><strong>通信</strong>：基座传数据用 props；子应用发事件用 bus.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><msup><mo stretchy="false">(</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mtext>事件</mtext><msup><mtext>名</mtext><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">,</mo><mtext>数据</mtext><mo stretchy="false">)</mo><mtext>；基座监听</mtext><mi>b</mi><mi>u</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">emit('事件名', 数据)；基座监听 bus.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mopen"><span class="mopen">(</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord cjk_fallback">事件</span><span class="mord"><span class="mord cjk_fallback">名</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">数据</span><span class="mclose">)</span><span class="mord cjk_fallback">；基座监听</span><span class="mord mathnormal">b</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>on('事件名', handler)。</li>
</ol>
<h2 data-id="heading-14">Wujie微前端的通信方案（基座 ↔ 子应用、子应用 ↔ 子应用）</h2>
<p>Wujie 的通信设计非常简单和强大，它内置了一个<strong>全局事件总线（EventBus）</strong> ，所有子应用和基座都共享同一个 bus 对象。这意味着：</p>
<ul>
<li><strong>基座 → 子应用</strong>：单向传值最常用的是 props</li>
<li><strong>子应用 → 基座</strong>：子应用通过 bus.$emit 发事件，基座监听</li>
<li><strong>子应用 ↔ 子应用</strong>：直接通过同一个 bus 互相发事件和监听（不需要经过基座中转！）</li>
<li>另外还有一些辅助方式（如插件共享状态）</li>
</ul>
<p>下面我一步一步慢慢讲，每种方案都配代码示例（基于 Vue3 基座 + Vue3/React 子应用通用）。</p>
<h5 data-id="heading-15">方案1：基座 → 子应用（推荐：props 单向传值）</h5>
<p>这是最简单、最常用的方式。基座把数据作为 props 传给子应用，子应用实时接收（数据变化会自动同步）。</p>
<p><strong>基座配置（ 组件上加 props）</strong> ：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">wujie-vue</span>
    <span class="hljs-attr">name</span>=<span class="hljs-string">"sub-app1"</span>
    <span class="hljs-attr">url</span>=<span class="hljs-string">"http://localhost:3001"</span>
    <span class="hljs-attr">:props</span>=<span class="hljs-string">"subAppProps"</span>
  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">wujie-vue</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> subAppProps = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">token</span>: <span class="hljs-string">'abc123'</span>,
  <span class="hljs-attr">userName</span>: <span class="hljs-string">'小明'</span>,
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-comment">// 甚至可以传函数！</span>
  <span class="hljs-attr">jumpTo</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用调用了基座的函数，跳转到'</span>, path)
    <span class="hljs-comment">// 这里可以控制基座路由</span>
  }
})

<span class="hljs-comment">// 基座修改数据，子应用会自动收到更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateCount</span> = (<span class="hljs-params"/>) =&gt; {
  subAppProps.<span class="hljs-property">value</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>子应用接收（在任何地方都可以拿到）</strong> ：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子应用里（Vue/React 都一样）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_WUJIE__</span>) {
  <span class="hljs-comment">// 被 Wujie 加载时</span>
  <span class="hljs-keyword">const</span> props = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span> || {}
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到基座传来的数据：'</span>, props)
  <span class="hljs-comment">// props.token, props.userName, props.count, props.jumpTo()</span>

  <span class="hljs-comment">// 如果想响应式（Vue3 示例）</span>
  <span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
  <span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>, <span class="hljs-function">(<span class="hljs-params">newProps</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'props 更新了：'</span>, newProps)
  }, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> })
}
</code></pre>
<p><strong>优点</strong>：实时同步、类型安全、支持传函数（子应用可以调用基座方法） <strong>缺点</strong>：单向（子应用不能直接改基座的数据）</p>
<h5 data-id="heading-16">方案2：子应用 → 基座、子应用 → 子应用（全局 EventBus）</h5>
<p>Wujie 内置了一个全局 bus，所有子应用和基座共享同一个实例。<strong>子应用之间可以直接通信</strong>，不需要基座中转。</p>
<p><strong>基座监听事件（在任意组件里）</strong> ：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { bus } <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie-vue3'</span>  <span class="hljs-comment">// 基座直接导入</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 监听所有子应用发的事件</span>
  bus.$on(<span class="hljs-string">'click-btn'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'基座收到事件，数据是：'</span>, data)
    <span class="hljs-comment">// 这里可以更新基座状态、跳转路由等</span>
  })

  <span class="hljs-comment">// 监听特定子应用（可选）</span>
  bus.$on(<span class="hljs-string">'sub-app1-event'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> { ... })
})

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  bus.$off(<span class="hljs-string">'click-btn'</span>)  <span class="hljs-comment">// 记得销毁，防止内存泄漏</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>子应用发事件（在子应用任意位置）</strong> ：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子应用里（不需要额外安装，直接用 window.$wujie.bus）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendEvent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">'click-btn'</span>, {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">'来自子应用1的数据'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-number">999</span>
  })
}

<span class="hljs-comment">// 子应用2 也可以直接监听子应用1的事件！</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$on(<span class="hljs-string">'click-btn'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用2 收到子应用1的事件：'</span>, data)
})
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>所有子应用共享同一个 bus，所以子应用A <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mtext>的事件，子应用</mtext><mi>B</mi><mtext>可以直接</mtext></mrow><annotation encoding="application/x-tex">emit 的事件，子应用B 可以直接 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">的事件，子应用</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord cjk_fallback">可以直接</span></span></span></span></span>on 收到。</li>
<li>事件名建议加前缀避免冲突，比如 'sub-app1-click'。</li>
<li>支持一次性监听：bus.$once('event', handler)</li>
<li>销毁监听：$off</li>
</ul>
<p><strong>优点</strong>：双向、实时、子应用间直接通信、非常灵活 <strong>缺点</strong>：需要手动管理事件名和销毁监听</p>
<h5 data-id="heading-17">方案3：基座 → 所有子应用广播（结合 props + bus）</h5>
<p>如果你想基座主动推送数据给所有子应用：</p>
<ul>
<li>用 bus.$emit 发事件，所有子应用监听同一个事件。</li>
<li>或者用插件（见下面）共享状态。</li>
</ul>
<h5 data-id="heading-18">方案4：共享状态（插件方式，适合复杂状态管理）</h5>
<p>如果你的项目状态很多，推荐用 Wujie 的<strong>插件系统</strong>共享 Pinia/Vuex/Redux 等。</p>
<p>官方推荐一个插件：wujie-polyfill，可以共享状态管理库。</p>
<p><strong>示例：共享 Pinia（Vue）</strong> ：</p>
<ol>
<li>基座和所有子应用都安装同一个 Pinia store。</li>
<li>用插件让它们共享实例（具体代码看官方插件文档）。</li>
</ol>
<p>或者更简单：用 window 共享一个全局对象（不推荐，容易污染）。</p>
<h5 data-id="heading-19">总结对比（小白一看就懂）</h5>













































<table><thead><tr><th>场景</th><th>推荐方案</th><th>方向</th><th>是否实时</th><th>代码复杂度</th><th>备注</th></tr></thead><tbody><tr><td>基座 → 子应用（传数据/函数）</td><td>props</td><td>单向</td><td>是</td><td>低</td><td>最常用</td></tr><tr><td>子应用 → 基座</td><td>bus.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">emit + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord">+</span></span></span></span></span>on</td><td>双向</td><td>是</td><td>中</td><td/></tr><tr><td>子应用 → 子应用</td><td>bus.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">emit + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord">+</span></span></span></span></span>on</td><td>双向</td><td>是</td><td>中</td><td>直接通信，超方便</td></tr><tr><td>全局共享复杂状态</td><td>插件（Pinia等）</td><td>双向</td><td>是</td><td>高</td><td>项目大时用</td></tr></tbody></table>
<h2 data-id="heading-20">wujie源码</h2>
<p>wujie源码主要包含以下几部分：</p>
<ul>
<li>wujie-core</li>
<li>wujie-vue2/wujie-vue3</li>
<li>wujie-react</li>
<li>wujie-polyfill</li>
</ul>
<h3 data-id="heading-21">wujie-core</h3>
<ul>
<li>入口文件：index.ts</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 导出核心 API</span>
<span class="hljs-keyword">export</span> { startApp, preloadApp, destroyApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'./start'</span>  <span class="hljs-comment">// 启动、预加载、销毁</span>
<span class="hljs-keyword">export</span> { bus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./bus'</span>  <span class="hljs-comment">// 通信总线</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Wujie</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./wujie'</span>  <span class="hljs-comment">// 主类</span>

<span class="hljs-comment">// 全局配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setupApp</span>(<span class="hljs-params">options</span>) { ... }

<span class="hljs-comment">// 预加载</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">preloadApp</span>(<span class="hljs-params">options: PreloadAppOptions</span>) {
  <span class="hljs-comment">// 提前下载资源，缓存 HTML/JS/CSS</span>
}

<span class="hljs-comment">// 启动应用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startApp</span>(<span class="hljs-params">options: StartAppOptions</span>) {
  <span class="hljs-comment">// 创建沙箱、加载资源、执行代码</span>
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">* startApp主要是创建沙箱-》fetch资源=〉执行<span class="hljs-variable constant_">JS</span>=》挂载<span class="hljs-variable constant_">DOM</span>
* <span class="hljs-title class_">Wujie</span>有两种沙箱模式
    * 默认：<span class="hljs-title class_">Proxy</span>沙箱（快，推荐）：wujie用<span class="hljs-title class_">Proxy</span>代理<span class="hljs-variable language_">window</span>对象，让子应用以为自己在操作全局<span class="hljs-variable language_">window</span>，但其实操作的是“假<span class="hljs-variable language_">window</span>”
    * iframe沙箱（最强隔离，但慢）
    
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WujieSandbox</span> {
active = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 沙箱是否激活</span>
<span class="hljs-attr">proxyWindow</span>: <span class="hljs-title class_">WindowProxy</span>;  <span class="hljs-comment">// 代理的 window</span>

<span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
 <span class="hljs-comment">// 创建假 window（其实是空对象）</span>
 <span class="hljs-keyword">const</span> fakeWindow = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);

 <span class="hljs-comment">// 记录修改的变量（为了销毁时恢复）</span>
 <span class="hljs-keyword">const</span> modifiedMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
 <span class="hljs-keyword">const</span> reversedMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();  <span class="hljs-comment">// 恢复用</span>

 <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxyWindow</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(fakeWindow, {
   <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
     <span class="hljs-comment">// 1. 先从子应用自己的变量拿</span>
     <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> target) <span class="hljs-keyword">return</span> target[key];
     <span class="hljs-comment">// 2. 否则从真实 window 拿（基座共享）</span>
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>[key];
   },
   <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value</span>) {
     <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span>) {
       <span class="hljs-comment">// 激活时：子应用修改变量，只改假 window</span>
       modifiedMap.<span class="hljs-title function_">set</span>(key, value);
       target[key] = value;
     } <span class="hljs-keyword">else</span> {
       <span class="hljs-comment">// 不激活时：直接改真实 window（共享）</span>
       <span class="hljs-variable language_">window</span>[key] = value;
     }
     <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
   },
   <span class="hljs-comment">// delete、has 等也类似处理</span>
 });

 <span class="hljs-comment">// 避免 with 语句（历史问题，已优化）</span>
 <span class="hljs-comment">// 用 with 包裹代码时特殊处理</span>
}

<span class="hljs-comment">// 销毁沙箱：恢复基座 window</span>
<span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
 <span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;
 <span class="hljs-comment">// 把子应用改的变量恢复原样</span>
 modifiedMap.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> {
   <span class="hljs-variable language_">window</span>[key] = reversedMap.<span class="hljs-title function_">get</span>(key) || originalValue;
 });
}
}
</code></pre>
<ul>
<li>怎么解决全局变量冲突？Proxy拦截get/set，只让子应用改自己的；这个比single-spa的snapshot快，比乾坤的Proxy更完善</li>
</ul>
<h3 data-id="heading-22">框架适配包</h3>
<ul>
<li>wujie-vue3（vue组件怎么实现的？）其实就是一个wrapper，核心还是core的startApp</li>
</ul>
<h2 data-id="heading-23">总结</h2>
<p>Wujie的目标：让子应用（Vue/React等）像嵌入iframe一样隔离强，性能好，无白屏
整体流程：</p>
<ol>
<li>
<p>加载子应用HTML：用importHTML函数fetch子应用的index.html，解析它，提取所有的
</p></li>
<li>
<p>解析HTML：用preocessTp把HTML拆成template，scripts，styles</p>
</li>
<li>
<p>创建沙箱：new 一个Wujie的类实例。它会：</p>
<ul>
<li>创建一个隐藏的iframe（JS执行环境）</li>
<li>用Shadow DOM（影子根）隔离CSS/DOM</li>
<li>用Proxy代理window/document/location（JS隔离，最牛的地方）</li>
<li>如果浏览器太老，降级用纯iframe</li>
</ul>
</li>
<li>
<p>执行资源：加载CSS（内联或替换路径），执行JS（内联eval或动态script），支持插件修改代码。</p>
</li>
<li>
<p>挂载：把解析后的template塞到Shadow DOM或iframe，执行mount生命周期。</p>
</li>
<li>
<p>通信： 左右子应用和基座共享一个bus（EventBus），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">emit/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord">/</span></span></span></span></span>on发事件。</p>
</li>
<li>
<p>保活/销毁：支持保活模式（不销毁DOM），销毁时恢复变量，清除事件。</p>
</li>
<li>
<p>插件系统：所有步骤可以插插件（比如改CSS路径，排除JS）</p>
</li>
</ol>
<h2 data-id="heading-24">为什么强</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">*</span> JS隔离：Proxy代理window，子应用改变量只改变自己的“假window”
<span class="hljs-bullet">*</span> CSS隔离：Shdow DOM
<span class="hljs-bullet">*</span> 样式/JS路径自动修正
<span class="hljs-bullet">*</span> 通信简单：全局Bus
<span class="hljs-bullet">*</span> 性能好： 预加载，保活，无白屏
</code></pre>
<h2 data-id="heading-25">wujie-core 中所有重要函数/类罗列（按重要度排序）</h2>
<p>从源码文件看，核心是这些（没有一个“startApp”函数，可能是框架包里调的，core里是底层）：</p>
<ol>
<li><strong>bus</strong>（全局 EventBus 实例，index.ts）—— 通信核心</li>
<li><strong>EventBus 类</strong>（event.ts）—— <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>n</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">on/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">/</span></span></span></span></span>emit/$off 等通信方法</li>
<li><strong>importHTML</strong>（entry.ts）—— 加载和解析子应用HTML，最重要加载函数</li>
<li><strong>processTpl</strong>（template.ts）—— 解析HTML提取script/style</li>
<li><strong>class Wujie</strong>（sandbox.ts）—— 沙箱主类，constructor/mount/destroy 等</li>
<li><strong>proxyGenerator / localGenerator</strong>（proxy.ts）—— 创建Proxy代理 window/document/location</li>
<li><strong>getPlugins / defaultPlugin</strong>（plugin.ts）—— 插件系统</li>
<li>其他辅助：processCssLoader、getEmbedHTML 等（加载CSS）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>